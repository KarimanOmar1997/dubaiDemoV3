/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as t}from"./chunks/tslib.es6.js";import{version as e}from"./kernel.js";import r from"./Map.js";import i from"./Viewpoint.js";import{i as o}from"./core/lang.js";import s from"./core/Collection.js";import n from"./core/Error.js";import a from"./core/Loadable.js";import{l as p}from"./chunks/loadAll.js";import{L as l}from"./chunks/Logger.js";import{d as m}from"./chunks/maybe.js";import{M as u}from"./chunks/MultiOriginJSONSupport.js";import c from"./core/Promise.js";import{debounce as h}from"./core/promiseUtils.js";import{whenOnce as g}from"./core/reactiveUtils.js";import{addQueryParameter as j,isDataProtocol as d,dataComponents as y}from"./core/urlUtils.js";import{property as f}from"./core/accessorSupport/decorators/property.js";import{r as b}from"./chunks/reader.js";import{subclass as w}from"./core/accessorSupport/decorators/subclass.js";import{w as k}from"./chunks/writer.js";import{r as A}from"./core/JSONSupport.js";import S from"./geometry/SpatialReference.js";import v from"./portal/PortalItem.js";import{t as U}from"./chunks/portalItemUtils.js";import P from"./support/MapFloorInfo.js";import V from"./time/TimeExtent.js";import{S as _}from"./chunks/interfaces.js";import I,{R as x}from"./webmap/InitialViewProperties.js";import{a as L}from"./chunks/Widgets.js";import{g as O}from"./chunks/thumbnailUtils.js";import{geographicToWebMercator as T}from"./geometry/support/webMercatorUtils.js";import F from"./portal/Portal.js";import{a as R}from"./chunks/jsonContext.js";import{p as E}from"./chunks/project.js";import B from"./rest/support/ProjectParameters.js";import{g as M}from"./chunks/writeUtils.js";import N from"./webmap/ApplicationProperties.js";import C from"./webmap/Bookmark.js";import{V as J}from"./chunks/Version2.js";import G from"./webmap/background/ColorBackground.js";import"./config.js";import"./chunks/jsonUtils.js";import"./Basemap.js";import"./request.js";import"./chunks/MapUtils.js";import"./chunks/persistableUrlUtils.js";import"./chunks/collectionUtils.js";import"./chunks/basemapDefinitions.js";import"./chunks/assets.js";import"./chunks/messages.js";import"./chunks/handleUtils.js";import"./chunks/locale.js";import"./support/BasemapStyle.js";import"./intl.js";import"./chunks/date.js";import"./chunks/jsonMap.js";import"./chunks/constants.js";import"./chunks/datetime.js";import"./chunks/number2.js";import"./chunks/substitute.js";import"./chunks/events.js";import"./core/Accessor.js";import"./core/Handles.js";import"./chunks/get.js";import"./chunks/utils.js";import"./chunks/Lifecycle.js";import"./chunks/metadata.js";import"./chunks/ObjectPool.js";import"./chunks/ObservableBase.js";import"./chunks/tracking.js";import"./chunks/watch.js";import"./core/scheduling.js";import"./chunks/nextTick.js";import"./chunks/PooledArray.js";import"./chunks/SetUtils.js";import"./chunks/SimpleTrackingTarget.js";import"./chunks/ensureType.js";import"./chunks/Warning.js";import"./core/Evented.js";import"./chunks/shared.js";import"./chunks/SimpleObservable.js";import"./chunks/asyncUtils.js";import"./chunks/unitUtils.js";import"./chunks/pe.js";import"./geometry/Extent.js";import"./geometry/Geometry.js";import"./geometry/Point.js";import"./core/accessorSupport/decorators/cast.js";import"./portal/PortalGroup.js";import"./portal/PortalQueryParams.js";import"./portal/PortalQueryResult.js";import"./portal/PortalUser.js";import"./portal/PortalFolder.js";import"./portal/PortalItemResource.js";import"./portal/PortalRating.js";import"./chunks/layerUtils.js";import"./layers/catalog/catalogUtils.js";import"./Ground.js";import"./Color.js";import"./chunks/colorUtils2.js";import"./chunks/mathUtils.js";import"./chunks/enumeration.js";import"./chunks/groundInstanceUtils.js";import"./chunks/opacityUtils.js";import"./chunks/CollectionFlattener.js";import"./effects/FocusAreas.js";import"./core/Clonable.js";import"./effects/FocusArea.js";import"./chunks/uuid.js";import"./chunks/persistable.js";import"./chunks/MD5.js";import"./chunks/multiOriginJSONSupportUtils.js";import"./chunks/resourceExtension.js";import"./effects/FocusAreaOutline.js";import"./chunks/PolygonCollection.js";import"./geometry/Polygon.js";import"./chunks/coordsUtils.js";import"./chunks/Axis.js";import"./chunks/extentUtils.js";import"./chunks/boundsUtils.js";import"./chunks/aaBoundingRect.js";import"./chunks/zmUtils.js";import"./chunks/projectionUtils.js";import"./chunks/vec3f64.js";import"./geometry/Multipoint.js";import"./geometry/Polyline.js";import"./chunks/projectBuffer.js";import"./chunks/geodesicConstants.js";import"./chunks/projectXYZToVector.js";import"./geometry/support/GeographicTransformation.js";import"./geometry/support/GeographicTransformationStep.js";import"./chunks/zscale.js";import"./chunks/editableLayers.js";import"./chunks/basemapEnsureType.js";import"./chunks/basemapUtils.js";import"./chunks/utils2.js";import"./chunks/screenUtils.js";import"./chunks/mat4.js";import"./chunks/common.js";import"./chunks/collectionUtils2.js";import"./support/LayersMixin.js";import"./layers/Layer.js";import"./core/Identifiable.js";import"./chunks/timeUtils.js";import"./support/TablesMixin.js";import"./Camera.js";import"./CameraLayout.js";import"./chunks/Cyclical.js";import"./geometry/support/jsonUtils.js";import"./chunks/typeUtils2.js";import"./layers/support/FacilityLayerInfo.js";import"./layers/support/LevelLayerInfo.js";import"./layers/support/SiteLayerInfo.js";import"./webdoc/widgets/TimeSlider.js";import"./time/TimeInterval.js";import"./chunks/utils10.js";import"./chunks/utils11.js";import"./webdoc/applicationProperties/Viewing.js";import"./webdoc/applicationProperties/Search.js";import"./webdoc/applicationProperties/SearchLayer.js";import"./webdoc/applicationProperties/SearchLayerField.js";import"./chunks/fieldType.js";import"./webdoc/applicationProperties/SearchTable.js";import"./webdoc/applicationProperties/SearchTableField.js";import"./chunks/SlideThumbnail.js";import"./chunks/timeProperties.js";import"./chunks/Version.js";function $(t,e,r){const i={context:{...r,layerContainerType:"operational-layers"}};return t.portalItem&&(i.context.portal=t.portalItem.portal||F.getDefault()),import("./chunks/layersCreator.js").then((({populateOperationalLayers:r})=>{const o=[],s=e.operationalLayers;s?.length&&o.push(r(t.layers,s,i));const n={...i,context:{...i.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"},a=e.tables;return a?.length&&o.push(r(t.tables,a,n)),Promise.allSettled(o).then((()=>{}))}))}const D=s.ofType(C),W=new Map([["image/jpeg","jpeg"],["image/jpg","jpg"],["image/png","png"],["image/gif","gif"]]),Z=U.JSAPI;let z=class extends(u(a.LoadableMixin(c.EsriPromiseMixin(r)))){constructor(t){super(t),this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1,this._thumbnailFilename=null,this._updateFromPromise=null,this.resourceReferences={portalItem:null,paths:[]},this.applicationProperties=null,this.bookmarks=new D,this.floorInfo=null,this.initialViewProperties=new I,this.portalItem=null,this.sourceVersion=null,this.widgets=null,this._debouncedSaveOperations=h((async(t,e,r)=>{const{save:i,saveAs:o}=await import("./chunks/webdocSaveUtils.js");switch(t){case _.SAVE:return i(this.context,this,e);case _.SAVE_AS:return o(this.context,this,r,e)}})),this.authoringApp=this.authoringAppVersion=null,this._isAuthoringAppSetByUser=this._isAuthoringAppVersionSetByUser=!1}destroy(){this.portalItem=m(this.portalItem)}initialize(){if(this.when().catch((t=>{l.getLogger(this).error("#load()","Failed to load web map",t)})),this.resourceInfo){let t;try{t=this._validateJSON(this.resourceInfo)}catch(t){return void this.addResolvingPromise(Promise.reject(t))}this.read(t)}}set authoringApp(t){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",t)}writeAuthoringApp(t,e){t&&this._isAuthoringAppSetByUser?e.authoringApp=t:e.authoringApp=Z}set authoringAppVersion(t){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",t)}writeAuthoringAppVersion(t,r){t&&this._isAuthoringAppVersionSetByUser?r.authoringAppVersion=t:r.authoringAppVersion=e}readInitialViewProperties(t,e){const r=new I;e.background&&(r.background=G.fromJSON(e.background));const o=e.initialState?.timeExtent;o&&(r.timeExtent=V.fromArray(o));const s=e.initialState?.viewpoint;return s&&(s.rotation&&J.parse(e.version||"","webmap").lessThan(2,20)&&"ArcGIS Pro"===e.authoringApp&&(s.rotation*=-1),r.viewpoint=i.fromJSON(s)),e.mapRangeInfo&&(r.rangeInfo=x.fromJSON(e.mapRangeInfo)),e.spatialReference&&(r.spatialReference=S.fromJSON(e.spatialReference)),e.timeZone&&(r.timeZone=e.timeZone),r}writeInitialViewProperties(t,e,r,i){if(!t)return;t.background?.color&&(e.background=t.background.write({},i));const{timeExtent:o,viewpoint:s}=t;if(s||o){const t={};s&&(t.viewpoint=s.write({},i)),o&&(t.timeExtent=o.toArray()),e.initialState=t}t.rangeInfo&&(e.mapRangeInfo=t.rangeInfo.toJSON(i)),t.spatialReference&&(e.spatialReference=t.spatialReference.write({},i)),e.timeZone=t.timeZone}writeLayers(t,e,r,i){e[r]=this._writeLayers(t,i,"operational-layers")}readSourceVersion(t,e){const[r,i]=e.version.split(".");return new J(parseInt(r,10),parseInt(i,10))}writeSourceVersion(t,e,r){e[r]=`${this.context.currentVersion.major}.${this.context.currentVersion.minor}`}writeTables(t,e,r,i){const o=this._writeLayers(t,i,"tables");o.length&&(e[r]=o)}get thumbnailUrl(){return this.portalItem?.thumbnailUrl||null}set thumbnailUrl(t){t?(this._override("thumbnailUrl",t),this._thumbnailFilename=this._generateCustomThumbnailFilename(t)):this._clearThumbnailOverride()}get updatingFromView(){return!!this._updateFromPromise}load(t){return this.addResolvingPromise((e=this.context,(r=this).resourceInfo?$(r,r.resourceInfo,{origin:e.origin}):r.portalItem?.id?async function(t,e,r){if(await r.load().catch((e=>{throw new n(`${t.name}:load-portal-item`,"Failed to load portal item",{error:e})})),r.type!==t.itemType)throw new n(`${t.name}:invalid-portal-item`,`Invalid portal item type '${r.type}', expected '${t.itemType}'`,{type:r.type});const o=await r.fetchData();e.resourceInfo=o;const s=R(r,t.origin);await function(t,e,r,i){const o=function(t,e){const r=t.parseVersion(e.version||"",t.name);return t.currentVersion.validate(r),e.version=`${r.major}.${r.minor}`,e}(t,r);return e.read(o,i),$(e,o,i)}(t,e,o,s),e.resourceReferences={portalItem:r,paths:s.readResourcePaths};const a=await async function(t,e,r){const o=t?.viewpoint?.targetGeometry;if(o)return null;const s=await async function(t,e,r){const i=t?.spatialReference,o=e?.extent;if(!i||!o)return null;if(i.isWGS84)return o.clone();if(i.isWebMercator)return T(o);const{getGeometryServiceURL:s}=await import("./chunks/geometryServiceUtils.js");try{const t=await s(e),r=new B({geometries:[o],outSpatialReference:i});return(await E(t,r))[0]}catch(t){r.error("Error projecting item's extent:",t)}return null}(t,e,r);return s?new i({targetGeometry:s}):null}(e.initialViewProperties,r,l.getLogger(e));if(a){const r=e.initialViewProperties?.clone()??t.createInitialViewProperties();r.viewpoint=a,e.initialViewProperties=r}}(e,r,r.portalItem):Promise.resolve())),Promise.resolve(this);var e,r}loadAll(){return p(this,(t=>{t(this.ground,this.basemap,this.layers,this.tables)}))}read(t,e){e={...e,origin:this.context.origin};const r=this._getAuthoringPropsState();A(this,t,(e=>super.read(t,e)),e),this._restoreAuthoringPropsFromState(r)}write(t,e){if("loaded"!==this.loadStatus){const t=new n("webmap:not-loaded","Web map must be loaded before it can be serialized");throw l.getLogger(this).error("#toJSON()","Web map must be loaded before it can be serialized",this.loadError||this.loadStatus),t}return this._removeDanglingLayerRefs(),e={...e,origin:this.context.origin,restrictedWebMapWriting:!0,webmap:this},super.write(t,e)}async save(t){return this._debouncedSaveOperations(_.SAVE,t)}async saveAs(t,e){return this._debouncedSaveOperations(_.SAVE_AS,e,t)}async updateFrom(t,e){const r=this._updateFromInternal(t,e);this._updateFromPromise=r,await r,r===this._updateFromPromise&&(this._updateFromPromise=null)}getLayerJSONFromResourceInfo(t){const e=this.resourceInfo;return this._collectAllLayersJSON([...e?.baseMap?.baseMapLayers||[],...e?.operationalLayers||[],...this.basemap?.resourceInfo?.data?.baseMapLayers||[]]).find((e=>e.id===t.id))}async updateItemThumbnail(){this.thumbnailUrl&&this._isOverridden("thumbnailUrl")&&(await(this.portalItem?.updateThumbnail({thumbnail:this.thumbnailUrl,filename:this._thumbnailFilename})),this._clearThumbnailOverride())}getThumbnailState(){let t=this.thumbnailUrl;return t&&(t=this._isOverridden("thumbnailUrl")?t:j(t,"w","8192")),{thumbnailUrl:t,filename:this._thumbnailFilename}}restoreThumbnailFromState(t){this.thumbnailUrl=t.thumbnailUrl,this._thumbnailFilename=t.filename}_collectAllLayersJSON(t){return t.reduce(((t,e)=>(t.push(e),"GroupLayer"===e.layerType&&(t=t.concat(this._collectAllLayersJSON(e.layers||[]))),t)),[])}_writeLayers(t,e,r){return e={...e,layerContainerType:r},t.map((t=>M(t,"tables"===r?null:this.getLayerJSONFromResourceInfo(t),e))).filter(o).toArray()}_validateJSON(t){const e=J.parse(t.version||"","webmap");return this.context.currentVersion.validate(e),t.version=`${e.major}.${e.minor}`,t}_removeDanglingLayerRefs(){const t=this.applicationProperties,e=t?.viewing?.search,r=t=>this.allLayers.some((e=>e.id===t));if(e?.layers&&(e.layers=e.layers.filter((t=>r(t.id)))),e?.tables&&(e.tables=e.tables.filter((t=>this.tables.some((e=>e.id===t.id))))),t){const e=t.editing?.locationTracking;e?.info&&!r(e.info.layerId)&&(t.editing=null)}const i="presentation"in this?this.presentation:null,o=i?.slides;o&&o.forEach((t=>{t.visibleLayers&&(t.visibleLayers=t.visibleLayers.filter((t=>r(t.id))))}))}async _updateFromInternal(t,e){if(e??={},await g((()=>t.ready)),this._updateInitialViewProperties(t,e),t.map===this)for(const e of t.allLayerViews)"visible"in e&&"visible"in e.layer&&e._isOverridden("visible")&&(e.layer.visible=e.visible),"featureEffect"in e&&"featureEffect"in e.layer&&e._isOverridden("featureEffect")&&(e.layer.featureEffect=e.featureEffect);await this._updateThumbnailUrl(t,e)}_updateInitialViewProperties(t,e){if(e.backgroundExcluded||(this.initialViewProperties.background=t.background?.clone()),this.initialViewProperties.spatialReference=t.spatialReference?.clone(),this.initialViewProperties.timeZone=t.timeZone,e.viewpointExcluded||(this.initialViewProperties.viewpoint=new i({rotation:t.rotation,scale:e.scalePreserved?t.scale:null,targetGeometry:this._getViewExtent(t)})),!e.widgetsExcluded)for(const e of t.persistableViewModels)e.updateWebDocument(this)}_getViewExtent(t){const e=t.center.clone().normalize(),r=t.extent.clone(),i=r.width/2;return r.xmin=e.x-i,r.xmax=e.x+i,r}async _updateThumbnailUrl(t,e){if(e.thumbnailExcluded)return;const r=O(t,e.thumbnailSize),i=await t.takeScreenshot({format:"png",width:r.width,height:r.height});this._setAutoGeneratedThumbnail(i.dataUrl)}_setAutoGeneratedThumbnail(t){this.thumbnailUrl=t,this._thumbnailFilename=null}_clearThumbnailOverride(){this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"),this._thumbnailFilename=null}_generateCustomThumbnailFilename(t){if(d(t)){const e=y(t),r=e?.mediaType,i=r&&W.get(r.toLowerCase())||null,o=`thumbnail${Date.now()}`;return i?`${o}.${i}`:o}return null}_getAuthoringPropsState(){return{authoringApp:this.authoringApp,authoringAppVersion:this.authoringAppVersion,isAuthoringAppSetByUser:this._isAuthoringAppSetByUser,isAuthoringAppVersionSetByUser:this._isAuthoringAppVersionSetByUser}}_restoreAuthoringPropsFromState(t){t.isAuthoringAppSetByUser?this.authoringApp=t.authoringApp:this._isAuthoringAppSetByUser=!1,t.isAuthoringAppVersionSetByUser?this.authoringAppVersion=t.authoringAppVersion:this._isAuthoringAppVersionSetByUser=!1}};t([f()],z.prototype,"_updateFromPromise",void 0),t([f({type:N,json:{write:!0}})],z.prototype,"applicationProperties",void 0),t([f({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],z.prototype,"authoringApp",null),t([k("authoringApp")],z.prototype,"writeAuthoringApp",null),t([f({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],z.prototype,"authoringAppVersion",null),t([k("authoringAppVersion")],z.prototype,"writeAuthoringAppVersion",null),t([f({type:D,json:{write:{overridePolicy:t=>({enabled:!!(t&&t.length>0),ignoreOrigin:!0})}}})],z.prototype,"bookmarks",void 0),t([f({type:P,json:{name:"mapFloorInfo",write:!0}})],z.prototype,"floorInfo",void 0),t([f({type:I,nonNullable:!0,json:{read:{source:["background","initialState.timeExtent","initialState.viewpoint","mapRangeInfo","spatialReference","timeZone"]},write:{ignoreOrigin:!0,target:{background:{type:G},"initialState.timeExtent":{type:V},"initialState.viewpoint":{type:i},mapRangeInfo:{type:x},spatialReference:{type:S},"timeZone:":{type:String}}}}})],z.prototype,"initialViewProperties",void 0),t([b("initialViewProperties")],z.prototype,"readInitialViewProperties",null),t([k("initialViewProperties")],z.prototype,"writeInitialViewProperties",null),t([f({json:{read:!1,write:{target:"operationalLayers",ignoreOrigin:!0}}})],z.prototype,"layers",void 0),t([k("layers")],z.prototype,"writeLayers",null),t([f({type:v})],z.prototype,"portalItem",void 0),t([f()],z.prototype,"resourceInfo",void 0),t([f({readOnly:!0,type:J,json:{read:{source:"version"},write:{allowNull:!0,ignoreOrigin:!0,target:"version",isRequired:!0}}})],z.prototype,"sourceVersion",void 0),t([b("sourceVersion")],z.prototype,"readSourceVersion",null),t([k("sourceVersion")],z.prototype,"writeSourceVersion",null),t([f({json:{read:!1,write:{ignoreOrigin:!0}}})],z.prototype,"tables",void 0),t([k("tables")],z.prototype,"writeTables",null),t([f()],z.prototype,"thumbnailUrl",null),t([f()],z.prototype,"updatingFromView",null),t([f({type:L,json:{write:!0}})],z.prototype,"widgets",void 0),z=t([w("esri.WebDocument2D")],z);const q=z;export{q as default};
