/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Error.js";import{m as r}from"./handleUtils.js";import{d as s}from"./maybe.js";import i from"../core/Promise.js";import{on as o,watch as n}from"../core/reactiveUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import{h as p}from"../core/lang.js";import"./Logger.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import{a as m}from"./FeatureLayerViewBase3D.js";import{W as d}from"./WorkerHandle.js";import u from"../geometry/Extent.js";import{s as c}from"./aaBoundingRect.js";import j from"../rest/support/FeatureSet.js";import{E as y}from"./ElevationContext.js";import{a as h}from"./utils28.js";import g from"../core/Accessor.js";import{throwIfAborted as f,createAbortError as w}from"../core/promiseUtils.js";import{V as b}from"./ViewingMode.js";import{n as v}from"./watch.js";import{g as R}from"./glUtil.js";import{S as _}from"./ShaderOutput.js";import{S as U}from"./RenderGeometry.js";import{G as S}from"./NormalUtils.glsl.js";import{I}from"./IntersectorResult.js";import{B as x,U as C}from"./RibbonLineMaterial.js";import{E as V,T as F}from"./Matrix4PassUniform.js";import{D as M}from"../views/SceneView.js";import{H as T}from"./HUDMaterial.js";import{V as D}from"./VertexAttribute.js";import{L}from"./LodRenderer.js";import{L as O,a as k,b as P,c as E}from"./primitiveObjectSymbolUtils.js";import{C as B}from"./basicInterfaces.js";import{D as G}from"./DefaultMaterial.js";import{e as A}from"./highlightUtils2.js";import{L as H}from"./LayerViewPerformanceInfo.js";import"../config.js";import"../core/Handles.js";import"./get.js";import"./utils.js";import"./Lifecycle.js";import"./metadata.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./tracking.js";import"./ensureType.js";import"./MapUtils.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./events.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./Warning.js";import"./dehydratedFeatures.js";import"./memoryEstimations.js";import"../geometry/SpatialReference.js";import"../core/JSONSupport.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"./writer.js";import"./aaBoundingBox.js";import"./quantizationUtils.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"./mathUtils.js";import"../geometry/Polyline.js";import"./typeUtils2.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./Graphics3DGraphicsPipeline.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./guards.js";import"./datetime.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./locale.js";import"./constants.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"./colorUtils2.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../geometry/support/jsonUtils.js";import"./createFeatureId.js";import"./typeUtils.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils5.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils6.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./vec3f64.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./hydratedFeatures.js";import"./dehydratedPoint.js";import"./timeSupport2.js";import"../support/timeUtils.js";import"./timeUtils.js";import"../time/TimeExtent.js";import"./utils8.js";import"./Version2.js";import"./Version.js";import"./tagSymbols.js";import"../rest/support/Query.js";import"./DataLayerSource.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"./HighlightDefaults.js";import"./layerViewUtils.js";import"./projectionUtils2.js";import"./projectionUtils.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./UpdatingHandles.js";import"./asyncUtils.js";import"./featureLayerUtils.js";import"./uuid.js";import"./featureQueryAll.js";import"./layerUtils.js";import"../layers/catalog/catalogUtils.js";import"../renderers/SimpleRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./visualVariableUtils.js";import"./lengthUtils.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./defaults.js";import"./defaultsJSON.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"./RendererLegendOptions.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils.js";import"../rest/support/AttachmentQuery.js";import"../rest/support/NormalizationBinParametersMixin.js";import"../rest/support/RelationshipQuery.js";import"./ReactiveMap.js";import"./signal.js";import"./common.js";import"./dehydratedFeatureComparison.js";import"./graphicUtils.js";import"./mat4.js";import"./mat4f64.js";import"./vec4.js";import"./vec4f64.js";import"./meshVertexSpaceUtils.js";import"./vec3.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"./Scheduler.js";import"./debugFlags.js";import"./TerrainConst.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"./TileKey.js";import"./debugFlags2.js";import"./utils4.js";import"./jsonUtils2.js";import"./parser.js";import"./utils2.js";import"../symbols/support/cimSymbolUtils.js";import"./utils3.js";import"./defaultCIMValues.js";import"./enums2.js";import"./gfxUtils.js";import"./LRUCache.js";import"./MemCache.js";import"./queryForSymbologySnapping.js";import"./projectPointToVector.js";import"./elevationInfoUtils.js";import"./unitConversionUtils.js";import"./Graphics3DFeatureProcessor.js";import"./hash.js";import"./renderingInfoUtils.js";import"./TextureCompressionTracker.js";import"./vec2f64.js";import"./plane.js";import"./vector.js";import"./mat3f64.js";import"./quatf64.js";import"./mathUtils2.js";import"./computeTranslationToOriginAndRotation.js";import"./Intersector2.js";import"./dehydratedFeatureUtils.js";import"./ray.js";import"./mat3.js";import"../views/3d/webgl/RenderCamera.js";import"./vec2.js";import"./frustum.js";import"./HUDIntersectorResult.js";import"./verticalOffsetUtils.js";import"./sphere.js";import"./orientedBoundingBox.js";import"./quat.js";import"./spatialReferenceEllipsoidUtils.js";import"./Indices.js";import"./triangle.js";import"./lineSegment.js";import"./Texture.js";import"./enums.js";import"./FBOAttachmentType.js";import"./getDataTypeBytes.js";import"./vec2f32.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./types.js";import"./Material.js";import"./ShaderTechniqueConfiguration.js";import"./BindType.js";import"./boundedPlane.js";import"./HUDVisibility.glsl.js";import"./VerticalOffset.glsl.js";import"./Matrix4BindUniform.js";import"./glsl.js";import"./BooleanBindUniform.js";import"./HUDRenderStyle.js";import"./ShaderBuilder.js";import"./renderState.js";import"./AlphaCutoff.js";import"./projectBoundingRect.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./edgeUtils.js";import"./floatRGBA.js";import"./NormalAttribute.glsl.js";import"./Float4DrawUniform.js";import"./Matrix3DrawUniform.js";import"./GridLocalOriginFactory.js";import"./ExtentSet.js";import"./projectVectorToVector.js";import"../layers/Layer.js";import"./rendererConversion.js";import"./basemapUtils.js";import"./basemapDefinitions.js";import"./messages.js";import"./optimizedFeatureQueryEngineAdapter.js";import"./PooledRBush.js";import"./quickselect.js";import"./popupUtils.js";import"./InputManager.js";import"./Queue.js";import"./Graphics3DObjectStates.js";import"./attributeUtils.js";import"../layers/support/FeatureFilter.js";import"./floorFilterUtils.js";import"./QueryEngine.js";import"./WhereClauseCache.js";import"../core/sql/WhereClause.js";import"./TimeOnly.js";import"./enum.js";import"./UnknownTimeZone.js";import"./timeSupport.js";import"./projectionSupport.js";import"./json.js";import"./QueryEngineCapabilities.js";import"./utils13.js";import"./heatmapUtils.js";import"./utils14.js";import"./timeZoneUtils.js";import"./utils12.js";import"./generateRendererUtils.js";import"./queryUtils.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./simplify.js";import"./utils10.js";import"./utils11.js";import"./SnappingCandidate.js";import"../rest/support/AutoIntervalBinParameters.js";import"../rest/support/BinParametersBase.js";import"../rest/support/AttributeBinsGrouping.js";import"../rest/support/DateBinParameters.js";import"../rest/support/DateBinTimeInterval.js";import"../rest/support/FixedBoundariesBinParameters.js";import"../rest/support/FixedIntervalBinParameters.js";import"../layers/support/FieldsIndex.js";import"./featureServiceUtils.js";import"./scaleUtils.js";import"./FeatureStore.js";import"./BoundsStore.js";import"./FramebufferObject.js";import"./VertexArrayObject.js";import"./heatmapTextureUtils.js";import"./LayerView3D.js";import"./heightModelInfoUtils.js";import"../geometry/HeightModelInfo.js";import"./query.js";import"./pbfQueryUtils.js";import"./pbf.js";import"./queryZScale.js";import"./EventedSet.js";import"./FeatureLayerView.js";import"./FeatureIdInfo.js";import"./constants2.js";import"./displayFilterUtils.js";import"../layers/support/FeatureEffect.js";import"./featurePopupQueryUtils.js";import"./networkFieldUtils.js";import"../views/layers/LayerView.js";import"./RefreshableLayerView.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./number2.js";import"./substitute.js";import"./VertexElementDescriptor.js";import"./SceneLighting.js";import"./axisAngleDegrees.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"../views/3d/webgl.js";import"../views/3d/webgl/RenderNode.js";import"./VertexArrayObject2.js";import"./NestedMap.js";import"./fontUtils.js";import"./Octree.js";import"./GeometryUtil.js";import"./vec3f32.js";import"./videoUtils.js";import"./requestImageUtils.js";import"./TextureFormat.js";import"../Camera.js";import"../CameraLayout.js";import"./Cyclical.js";import"../Viewpoint.js";import"./domUtils.js";import"./GraphicsCollection.js";import"./RenderCoordsHelper.js";import"./projectVectorToPoint.js";import"../views/View.js";import"../Map.js";import"../Basemap.js";import"./loadAll.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../support/BasemapStyle.js";import"./writeUtils.js";import"../Ground.js";import"./groundInstanceUtils.js";import"./CollectionFlattener.js";import"../effects/FocusAreas.js";import"../effects/FocusArea.js";import"./persistable.js";import"./MD5.js";import"./multiOriginJSONSupportUtils.js";import"./resourceExtension.js";import"../effects/FocusAreaOutline.js";import"./PolygonCollection.js";import"./editableLayers.js";import"./basemapEnsureType.js";import"./collectionUtils2.js";import"../support/LayersMixin.js";import"../support/TablesMixin.js";import"../views/BasemapView.js";import"../views/Magnifier.js";import"./SelectionManager.js";import"./selectionUtils.js";import"../views/Theme.js";import"./ViewEvents.js";import"./IViewEvents.js";import"./interfaces2.js";import"./keybindings.js";import"./screenUtils2.js";import"../views/support/HighlightOptions.js";import"../views/input/Input.js";import"../views/input/gamepad/GamepadSettings.js";import"../views/input/gamepad/GamepadInputDevice.js";import"../views/navigation/Navigation.js";import"./a11yUtils.js";import"../views/navigation/NavigationActionMap.js";import"../views/navigation/gamepad/GamepadSettings.js";import"../views/BreakpointsOwner.js";import"../views/DOMContainer.js";import"./projector.js";import"./sanitizerUtils.js";import"../views/GroundView.js";import"./cameraUtils.js";import"./DepthRange.js";import"./earthUtils.js";import"./spatialReferenceSupport.js";import"../layers/support/ElevationSampler.js";import"../views/PopupView.js";import"../views/ViewAnimation.js";import"./ShadowCastVisualizeTechniqueConfiguration.js";import"./SunCalc.js";import"../views/3d/environment/SunLighting.js";import"../webscene/SunLighting.js";import"../views/3d/environment/VirtualLighting.js";import"../webscene/VirtualLighting.js";import"../webscene/Environment.js";import"./lightingTypes.js";import"../webscene/background/Background.js";import"../webscene/background/ColorBackground.js";import"./easing.js";import"./unitBezier.js";import"./Animation.js";import"./ray2.js";import"./viewpointUtils2.js";import"./RenderFeature.js";import"../views/ui/UI.js";import"./modeUtils.js";import"./widgetUtils.js";import"./unitFormatUtils.js";import"./ByteSizeUnit.js";import"./quantityUtils.js";import"../widgets/Widget.js";import"./componentsUtils.js";import"./jsxWidgetSupport.js";import"./messageBundle.js";import"./jsxFactory.js";import"./ZoomMomentumEstimator.js";import"./labelFormatUtils.js";import"./labelUtils.js";import"./ArcadeExpression.js";import"./placementUtils.js";import"./hitTest.js";import"./LayerConstants.js";import"./intersectorUtilsConversions.js";import"./Intersector.js";import"./ElevationRange.js";import"./hitTestSelectUtils.js";import"./terrainUtils.js";import"../views/3d/support/SceneViewPerformanceInfo.js";import"../views/3d/support/LayerPerformanceInfo.js";import"./DefaultLoadingContext.js";import"./wosrLoader.js";import"./mapCollectionUtils.js";import"./ElevationQueryTileCache.js";import"./ElevationSamplerData.js";import"./Normals.js";import"./VertexColor.glsl.js";import"./TileStrategy.js";import"./TileKey2.js";import"./ScheduledQueueProcessor.js";import"./enums5.js";import"./mat3f32.js";import"./SymbolRepository.js";import"./config.js";import"./StyleDefinition.js";import"./TiledDisplayObject.js";import"./DisplayObject.js";import"./definitions.js";import"./GeometryUtils.js";import"./RenderableTile.js";import"./resources.js";import"./colorUtils.js";import"./vec32.js";import"./vec33.js";import"./BlendColorsPremultiplied.glsl.js";import"./vec4f32.js";import"../views/3d/webgl/ManagedFBO.js";import"./testSVGPremultipliedAlpha.js";import"./RenderingContext.js";import"./ProgramCache.js";import"./Program.js";import"./capabilities2.js";import"./ITexture.js";import"./screenshotUtils.js";import"./imageUtils.js";import"./makeScheduleFunction.js";import"./WebGLRequirements.js";import"../views/ui/DefaultUI.js";import"../widgets/Attribution.js";import"../widgets/Attribution/AttributionViewModel.js";import"./ILyr3DWasmPerSceneView.js";import"./globalCss.js";import"./accessibleHandler.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"./utils24.js";import"../widgets/support/GoTo.js";import"./goToUtils.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";import"./Matrix4sPassUniform.js";let N=class extends i{constructor(e){super(e),this.schedule=null,this._workerUpdating=!0}get updating(){return this._workerUpdating}initialize(){const{layer:e,layerView:t,viewSpatialReference:r,renderSpatialReference:s}=this,i=e.elevationInfo;this._elevationContext=y.fromElevationInfo(i),this._workerHandle=new Q(this.schedule,{createTexture:async({data:e,parameters:t})=>({result:await this.renderer.createTexture(e,t),transferList:[]}),releaseTexture:async({uid:e})=>(await this.renderer.releaseTexture(e),z),createMaterial:async({materialJSON:e})=>(await this.renderer.createMaterial(e),z),destroyMaterial:async({materialId:e})=>(await this.renderer.destroyMaterial(e),z),createDirectRenderer:async({materialId:e})=>(await this.renderer.createDirectRenderer(e),z),destroyDirectRenderer:async({materialId:e})=>(await this.renderer.destroyDirectRenderer(e),z),createLoDRenderer:async({rendererId:e,lodRenderGeometry:t},r)=>(await this.renderer.createLoDRenderer(e,t,r?.signal??void 0),z),destroyLoDRenderer:async({rendererId:e},t)=>(await this.renderer.destroyLoDRenderer(e,t?.signal??void 0),z),dispatchRenderCommands:async({commands:e})=>(await this.renderer.executeRenderCommands(e),z),applyElevationAlignment:async({mapPoints:e})=>{const{viewSpatialReference:t,elevationProvider:r,renderCoordsHelper:s}=this,i=h(e,t,this._elevationContext,r,s);return{result:i,transferList:[i.buffer]}}}),this.addResolvingPromise((async()=>{await e.load();const o={url:e.parsedUrl?.path??"",baseQuery:e.createQuery().toJSON(),objectIdField:e.objectIdField,capabilities:e.capabilities,fieldIndex:e.fieldsIndex.toJSON(),timeInfo:e.timeInfo?.toJSON(),elevationInfo:i?.toJSON(),fullExtent:e.fullExtent?.toJSON(),renderer:e.renderer?.toJSON()},n={fullOpacity:t.fullOpacity};await this._workerHandle.invokeMethod("setup",{viewSpatialReference:r.toJSON(),renderSpatialReference:s.toJSON(),viewingMode:this.viewingMode,layerInfo:o,layerViewInfo:n})})()),this.addHandles(this._workerHandle.on("notify-updating",(({updating:e})=>{this._workerUpdating=e})))}onTileTreeChange(e){this._workerHandle.invokeMethod("onTileTreeChange",{tiles:e.items.map(q)})}onElevationChange(e){this._workerHandle.invokeMethod("onElevationChange",{context:e.context,spatialReference:e.spatialReference?.toJSON(),extent:c(e.extent)})}onLayerViewOpacityChange(e){this._workerHandle.invokeMethod("onLayerViewOpacityChange",e)}onRendererChange(e){const t=e?.toJSON();this._workerHandle.invokeMethod("onRendererChange",t)}async executeQuery(e,t){const r=await this._workerHandle.invokeMethod("executeQuery",e?.toJSON(),t),s=j.fromJSON(r);return this._ensureLayerOnFeatures(s),s}async executeQueryForIds(e,t){return await this._workerHandle.invokeMethod("executeQueryForIds",e?.toJSON(),t)}async executeQueryForCount(e,t){return await this._workerHandle.invokeMethod("executeQueryForCount",e?.toJSON(),t)}async executeQueryForExtent(e,t){const{count:r,extent:s}=await this._workerHandle.invokeMethod("executeQueryForExtent",e?.toJSON(),t);return{count:r,extent:u.fromJSON(s)}}async executeQueryForLatestObservations(e,t){const r=await this._workerHandle.invokeMethod("executeQueryForLatestObservations",e?.toJSON(),t),s=j.fromJSON(r);return this._ensureLayerOnFeatures(s),s}_ensureLayerOnFeatures(e){const{layer:t}=this;for(const r of e.features)r.layer=t,r.sourceLayer=t}};e([a()],N.prototype,"updating",null),e([a({constructOnly:!0})],N.prototype,"schedule",void 0),e([a({constructOnly:!0})],N.prototype,"layer",void 0),e([a({constructOnly:!0})],N.prototype,"layerView",void 0),e([a({constructOnly:!0})],N.prototype,"viewSpatialReference",void 0),e([a({constructOnly:!0})],N.prototype,"renderSpatialReference",void 0),e([a({constructOnly:!0})],N.prototype,"viewingMode",void 0),e([a({constructOnly:!0})],N.prototype,"renderer",void 0),e([a({constructOnly:!0})],N.prototype,"elevationProvider",void 0),e([a({constructOnly:!0})],N.prototype,"renderCoordsHelper",void 0),e([a()],N.prototype,"_workerUpdating",void 0),N=e([l("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorkerHandle")],N);class Q extends d{constructor(e,t){super("Feature3DPipelineWorker","setup",{},e,{strategy:"dedicated",client:t})}}function q({id:e,lij:t,extent:r}){return{id:e,lij:t,extent:r}}const z={result:void 0};let W=class extends U{constructor(e){super(e),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new M,this._bufferWriter=null,this.slicePlaneEnabled=!1,this.isGround=!1,this.type=e.material instanceof T?I.HUD:I.OBJECT,this.layerViewUid=e.layerViewUid}get produces(){return this._produces}get numFeatures(){let e=0;return this._renderGeometries.forEach((t=>e+=t.numElements/6)),e}get usedMemory(){let e=0;return this._renderGeometries.forEach((t=>{e+=t.vao.usedMemory})),e}intersect(e,t,r,s){const{material:i,_bufferWriter:o,layerViewUid:n,_renderGeometries:a}=this;null!=o.intersect&&a.forEach((({buffer:t,localOrigin:a,items:p})=>o.intersect(t.data,i.parameters,a,e,r,s,((t,r,s,o)=>{if(!p.visibilities[s])return;const a=p.objectIds[s];e.handleObjectIntersection({object:{id:v,graphicUid:a,layerViewUid:n,boundingVolumeWorldSpace:new x,geometries:[{material:i}]},geometryId:0,primitiveIndex:s},t,r,null,o)}))))}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>t!==_.Highlight&&t!==_.ShadowHighlight&&e(t)))}))}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const t of e)this.removeRenderGeometryBuffer(t)}acquireTechniques(e){const t=this.material;if(!t.shouldRender(e))return null;const{output:r,bind:s}=e,i=t.produces.get(s.slot);if(!i?.(r))return null;if(r===_.Highlight||r===_.ShadowHighlight)return null;const o=this._glMaterials.load(e.rctx,s.slot,r);return o?.beginSlot(s)}render(e,t){const r=this._renderGeometries;if(0===r.size)return;const{bind:s}=e,i=s.slot===V.OCCLUDER_MATERIAL||s.slot===V.TRANSPARENT_OCCLUDER_MATERIAL?s.slot:null,o=e.rctx;o.runAppleAmdDriverHelper(),o.bindTechnique(t,s,this.material.parameters);const n=t.program;for(const[e,a]of r){const{vao:e,localOrigin:r,drawCalls:p}=a;this._drawParameters.origin=r,n.bindDraw(s,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(e),o.bindVAO(e),o.setPipelineState(t.getPipeline(!1,i));for(const e of p)o.drawArrays(t.primitiveType,e.start,e.count)}}initializeRenderContext(e){this._glMaterials=new S(this.material,e.materials),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,R(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}addRenderGeometryBuffer(e,t,r,s){this.removeRenderGeometryBuffer(e);const{data:i,elementCount:o}=t,n=this._vaoCache.newVao(i.byteLength);n.vertexBuffers.get("geometry").setSubData(new Uint8Array(i),0,0,i.byteLength);const a={localOrigin:s,numElements:o,buffer:t,items:r,vao:n,drawCalls:this._produceDrawCalls(r)};this._renderGeometries.set(e,a)}updateRenderGeometryBuffer(e,t,r,s){const{data:i,elementCount:o}=t,n=this._renderGeometries.get(e);if(null==n)return;this._vaoCache.deleteVao(n.vao);const a=this._vaoCache.newVao(i.byteLength);a.vertexBuffers.get("geometry").setSubData(new Uint8Array(i),0,0,i.byteLength),n.localOrigin=s,n.numElements=o,n.buffer=t,n.items=r,n.vao=a,n.drawCalls=this._produceDrawCalls(r)}removeRenderGeometryBuffer(e){const t=this._renderGeometries.get(e);null!=t&&(this._vaoCache.deleteVao(t.vao),this._renderGeometries.delete(e))}updateVisibility(e,t){const r=this._renderGeometries.get(e);if(null==r)return;const{items:s}=r;if(s.visibilities.length!==t.length)throw new Error("Unexpected mismatch between old and new visibility flag buffer length.");s.visibilities=t,r.drawCalls=this._produceDrawCalls(s)}hasHighlight(){return!1}_produceDrawCalls(e){const{visibilities:t,ranges:r}=e,s=[];if(function(e){return"numItems"in e}(r)){if(0===r.numItems)return[];const e=r.numVertices;let i=null;for(let o=0;o<r.numItems;++o)t[o]?null==i?(i={start:o*e,count:e},s.push(i)):i.count+=e:i=null}else{const e=r.counts,i=e.length;if(0===i)return[];let o=null,n=0;for(let r=0;r<i;++r){const i=t[r],a=e[r];i?null==o?(o={start:n,count:a},s.push(o)):o.count+=a:o=null,n+=a}}return s}};e([a({constructOnly:!0})],W.prototype,"material",void 0),W=e([l("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],W);let J=class{constructor(e){this._optionalFields=new Array,this._instanceGroupToIndices=new Map,this._instanceIndexToFeatureId=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this._numFeatures=0,this.layerViewUid=e.layerViewUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._numFeatures}get usedMemory(){const e=this._lodRendererResources?.lodRenderer,t=e?.symbol;return(t?.computeUsedMemory()??0)+16*this._instanceIndexToFeatureId.size}destroy(){this._disposeResourceHandles.forEach((e=>e()))}async doLoad(e,t,r){p("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(D.OLIDCOLOR);const s=function(e,t){const r=t.levels.map((t=>{const r=t.components.map((t=>{const r=e(t.materialId);if(!function(e){return null!=e&&"materialType"in e&&"default"===e.materialType}(r))throw new Error("LodRenderer only supports DefaultMaterial");const s=new O(r,t.renderGeometryBuffer.data,t.renderGeometryBuffer.elementCount,t.boundingInfo);return new k(s)}));return new P(r,t.minScreenSpaceRadius)}));return new E(r)}((e=>t(e)),e),i=this.view.stage,o=s.getMaterials(),n=s.getTextures();i.addTextures(n),this._addDisposeResource((()=>{n.forEach((e=>e.unload())),i.removeTextures(n)})),await Promise.all(n.map((e=>this.view.stage.schedule((()=>e.load(i.renderView.renderingContext)),r)))),f(r);const a=await this._createLodRenderer(s,r);this._lodRendererResources={lodRenderer:a,materials:o,textures:n}}addInstances(e,t){const r=this._lodRendererResources;if(null==r)return;const s=r.lodRenderer;if(null==s)return;const{featureIds:i,localTransforms:o,globalTransforms:n,visibility:a}=t,p=new Array,l=s.instanceData,m=i.length,d=this._instanceIndexToFeatureId;for(let e=0;e<m;++e){const t=i[e],r=l.addInstance(),s=l.view,m=16*e;s.localTransform.copyFromTypedBuffer(r,o,m),s.globalTransform.copyFromTypedBuffer(r,n,m),l.updateModelTransform(r),l.setVisible(r,Boolean(a[e])),p.push(r),d.set(r,t)}this._instanceGroupToIndices.set(e,p),this._numFeatures+=m}removeInstances(e){const t=this._instanceGroupToIndices.get(e);if(null==t)return;const r=this._lodRendererResources;if(null==r)return;const s=r.lodRenderer.instanceData,i=this._instanceIndexToFeatureId;for(const e of t)s.removeInstance(e),i.delete(e);this._numFeatures-=t.length,this._instanceGroupToIndices.delete(e)}updateVisibility(e,t){const r=this._instanceGroupToIndices.get(e);if(null==r)return;const s=this._lodRendererResources;if(null==s)return;const i=r.length;if(i!==t.length)throw new Error("Unexpected mismatch instance count and visibility flag buffer length.");const o=s.lodRenderer.instanceData;for(let e=0;e<i;++e)o.setVisible(r[e],Boolean(t[e]))}updateGlobalTransforms(e,t){const r=this._instanceGroupToIndices.get(e);if(null==r)return;const s=this._lodRendererResources;if(null==s)return;const i=r.length;if(16*i!==t.length)throw new Error("Unexpected mismatch instance count and visibility flag buffer length.");const o=s.lodRenderer.instanceData,n=o.view;for(let e=0;e<i;++e){const s=r[e],i=16*e;n.globalTransform.copyFromTypedBuffer(s,t,i),o.updateModelTransform(s)}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createLodRenderer(e,t){const r=this.view.stage,s={layerViewUid:this.layerViewUid,graphicUid:e=>this._instanceIndexToFeatureId.get(e)??-1,notifyGraphicGeometryChanged:e=>1,notifyGraphicVisibilityChanged:e=>1},i=new L({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:null},this.scheduler);return i.slicePlaneEnabled=!1,this._addDisposeResource((()=>{r.removeRenderPlugin(i),i.destroy()})),await r.addRenderPlugin(i,t),i}};J=e([l("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],J);let Z=class extends g{constructor(e){super(),this.view=null,this.layerViewUid=null,this._stage=null,this._materials=new Map,this._textures=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=e.view,this.layerViewUid=e.layerViewUid}initialize(){this._stage=this.view.stage}destroy(){this.removeAllHandles(),this._lodRenderers.forEach((e=>e.destroy()))}async createTexture(e,t){const{_textures:r,_stage:s}=this,i=new F(e,t);return r.set(i.id,i),s&&(i.load(s.renderView.renderingContext),s.addTexture(i)),i.id}async releaseTexture(e){const{_textures:t,_stage:r}=this,s=t.get(e);s&&(r&&(s.unload(),r.removeTexture(s)),t.delete(e))}_destroyTexture(e){const{_textures:t,_stage:r}=this,s=t.get(e);s&&(r&&(s.unload(),r.removeTexture(s)),t.delete(e))}async createMaterial(e){const{view:t}=this,r=t.state.viewingMode===b.Global;let s=null;switch(e.type){case"default":{const t=e.parameters,i=new G(t,{spherical:r});i.setParameters({cullFace:i.transparent?B.None:B.Back}),s=i;break}case"hud":{const t=e.parameters;s=new T(t,r)}}this._materials.set(e.materialId,s)}async destroyMaterial(e){this._materials.delete(e)}async updateMaterial(e){}async createDirectRenderer(e){if(this._directRenderers.has(e))return;const t=this._materials.get(e);if(null==t)throw new Error(`material not found ${e}`);const{view:r}=this,s=new W({material:t,layerViewUid:this.layerViewUid});this._directRenderers.set(e,s),r.stage.addRenderPlugin(s),r.stage.renderView.renderer.updateHasFlags()}async destroyDirectRenderer(e){const t=this._directRenderers.get(e);if(null==t)return;const r=this.view;r.stage.removeRenderPlugin(t),this._directRenderers.delete(e),r.stage.renderView.renderer.updateHasFlags()}async createLoDRenderer(e,t,r){const s=new J({view:this.view,layerViewUid:this.layerViewUid});if(await s.doLoad(t,(e=>this._materials.get(e)),r),r?.aborted)throw s.destroy(),w();this._lodRenderers.set(e,s)}async destroyLoDRenderer(e,t){const r=this._lodRenderers.get(e);null!=r&&(r.destroy(),this._lodRenderers.delete(e))}_destroyLodRenderer({rendererId:e}){const t=this._lodRenderers.get(e);null!=t&&(t.destroy(),this._lodRenderers.delete(e))}async executeRenderCommands(e){for(const t of e)switch(t.id){case"destroy-texture":this._destroyTexture(t.textureId);break;case"update-material":this._updateMaterial(t);break;case"destroy-material":this._destroyMaterial(t);break;case"add-direct-renderer-geometry-buffer":this._addDirectRendererGeometryBuffer(t);break;case"update-direct-renderer-geometry-buffer":this._updateDirectRendererGeometryBuffer(t);break;case"remove-direct-renderer-geometry-buffer":this._removeDirectRendererGeometryBuffer(t);break;case"destroy-lod-renderer":this._destroyLodRenderer(t);break;case"add-lod-instances":this._addLodInstances(t);break;case"remove-lod-instances":this._removeLodInstances(t);break;case"update-lod-instance-data":this._updateLodInstanceData(t);break;case"update-visibility":this._updateVisibility(t)}e.length>0&&this._updateFeatureCount()}_updateFeatureCount(){let e=0;for(const t of this._directRenderers.values())e+=t.numFeatures;for(const t of this._lodRenderers.values())e+=t.numFeatures;this._set("totalFeatures",e)}get usedMemory(){let e=0;for(const t of this._directRenderers.values())e+=t.usedMemory;for(const t of this._lodRenderers.values())e+=t.usedMemory;return e}_updateMaterial({materialId:e,parameters:t}){const r=this._materials.get(e);null!=r?r.setParameters(t):console.error("material not found")}_destroyMaterial({materialId:e}){null!=this._materials.get(e)?this._materials.delete(e):console.error("material not found")}_addDirectRendererGeometryBuffer({groupId:e,rendererId:t,renderGeometryBuffer:r,renderGeometryBufferItems:s,localOrigin:i}){const o=this._directRenderers.get(t);null!=o?(o.addRenderGeometryBuffer(e,r,s,i),this.view.stage.renderView.requestRender()):console.error("no renderer assigned to provided material")}_updateDirectRendererGeometryBuffer({groupId:e,rendererId:t,renderGeometryBuffer:r,renderGeometryBufferItems:s,localOrigin:i}){const o=this._directRenderers.get(t);null!=o?(o.updateRenderGeometryBuffer(e,r,s,i),this.view.stage.renderView.requestRender()):console.error("no renderer assigned to provided material")}_removeDirectRendererGeometryBuffer({groupId:e,rendererId:t}){const r=this._directRenderers.get(t);null!=r?(r.removeRenderGeometryBuffer(e),this.view.stage.renderView.requestRender()):console.error("no renderer assigned to provided material")}_addLodInstances({rendererId:e,groupId:t,data:r}){const s=this._lodRenderers.get(e);if(null==s)throw new Error("no lod renderer assigned to provided lod renderer Id");s.addInstances(t,r),this.view.stage.renderView.requestRender()}_removeLodInstances({rendererId:e,groupId:t}){const r=this._lodRenderers.get(e);if(null==r)throw new Error("no lod renderer assigned to provided lod renderer Id");r.removeInstances(t),this.view.stage.renderView.requestRender()}_updateLodInstanceData({rendererId:e,groupId:t,globalTransforms:r}){const s=this._lodRenderers.get(e);if(null==s)throw new Error("No renderer found with the provided id");null!=r&&s.updateGlobalTransforms(t,r),this.view.stage.renderView.requestRender()}_updateVisibility({rendererId:e,groupId:t,visibility:r}){const s=this._directRenderers.get(e)??this._lodRenderers.get(e);if(null==s)throw new Error("No renderer found with the provided id");s.updateVisibility(t,r),this.view.stage.renderView.requestRender()}};e([a({readOnly:!0})],Z.prototype,"totalFeatures",void 0),Z=e([l("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],Z);let K=class extends i{constructor(e){super(e),this._renderer=null,this.graphicsQuery={queryForSymbologySnapping:(e,r)=>{throw new t("featurelayer:unsupported-symbology-snapping","Symbology snapping not supported")},executeQuery:async(e,t)=>await this._workerHandle.executeQuery(e,t),executeQueryForIds:async(e,t)=>await this._workerHandle.executeQueryForIds(e,t),executeQueryForCount:async(e,t)=>await this._workerHandle.executeQueryForCount(e,t),executeQueryForExtent:async(e,t)=>await this._workerHandle.executeQueryForExtent(e,t),executeQueryForLatestObservations:async(e,t)=>await this._workerHandle.executeQueryForLatestObservations(e,t)},this.maximumNumberOfFeatures=1e3}initialize(){if("point"!==this.layerView.layer.geometryType)throw new t("featurelayer:unsupported-geometry-type",`${this.layerView.layer.geometryType} is not supported`);this.addResolvingPromise(this.setup())}destroy(){this.removeAllHandles(),this._workerHandle.destroy(),s(this._renderer)}async setup(){const e=this.layerView,{layer:r,view:s,uid:i}=e,{spatialReference:a,renderSpatialReference:p,resourceController:l,renderCoordsHelper:m,elevationProvider:d}=s,u=s.state.viewingMode;if(this._renderer=new Z({view:s,layerViewUid:i}),"feature"!==r.type)throw new t("featurelayer:unsupported-layertype","Only FeatureLayer is supported");const c=new N({schedule:e=>l.immediate.schedule(e),layer:r,layerView:e,viewSpatialReference:a,renderSpatialReference:p,viewingMode:u,renderer:this._renderer,elevationProvider:d,renderCoordsHelper:m});this._workerHandle=await c.when(),this.addHandles([this.layerView.view.featureTiles.addClient(),o((()=>this.layerView.view.featureTiles.tiles),"change",(e=>{this._workerHandle.onTileTreeChange(e.target)}),{onListenerAdd:e=>this._workerHandle.onTileTreeChange(e),onListenerRemove:e=>this._workerHandle.onTileTreeChange(e)}),s.elevationProvider.on("elevation-change",(e=>this._workerHandle.onElevationChange(e))),n((()=>this.layerView.fullOpacity),(e=>this._workerHandle.onLayerViewOpacityChange(e)),{sync:!1}),n((()=>r.renderer),(e=>this._workerHandle.onRendererChange(e)),{sync:!1})])}get legendEnabled(){return!1}get hasAllFeatures(){return!1}get hasAllFeaturesInView(){return!1}get hasFullGeometries(){return!1}get symbologySnappingSupported(){return!1}get scaleVisibilitySuspended(){return!1}get suspendInfo(){return{}}get updating(){return this._workerHandle.updating}get dataUpdating(){return!1}get updatePolicy(){return C.ASYNC}get maximumNumberOfFeaturesExceeded(){return!1}get updatingProgressValue(){return 1}get usedMemory(){return this._renderer?.usedMemory??0}get unloadedMemory(){return 0}get ignoresMemoryFactor(){return!0}get totalFeatures(){return this._renderer?.totalFeatures??0}get performanceInfo(){const e=this.totalFeatures;return new m(new H(this.usedMemory,e,e,this.maximumNumberOfFeatures,0,null),e,e,this.maximumNumberOfFeaturesExceeded,"tiles","n/a")}get suspendResumeExtentMode(){return"computed"}forEachGraphic(e){}findGraphic(e){return null}highlight(e){return A}maskOccludee(e){return r()}async whenGraphicBounds(e,t){return null}computeAttachmentOrigin(e,t){return null}elevationAlignPointsInFeatures(e,r){throw new t("featurelayer:unsupported-elevation-alignment","Elevation alignment not supported")}async doRefresh(e){}setVisibility(e,t){}getMissingAttributesForFeature(e){return null}getHydratedGeometry(e){return null}};e([a()],K.prototype,"layerView",void 0),e([a()],K.prototype,"updating",null),e([a()],K.prototype,"totalFeatures",null),K=e([l("esri.views.3d.layers.graphics.pipeline.Feature3DPipeline")],K);export{K as Feature3DPipeline};
