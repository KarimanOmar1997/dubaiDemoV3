/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{C as e}from"./CIMSymbolHelper.js";import{d as t}from"./defaultCIMValues.js";import{T as i,d as s}from"./enums2.js";import{b as o,W as a,V as r}from"./enums4.js";import{T as n}from"./TechniqueType.js";import{_ as l,c as u}from"./tslib.es6.js";import{u as p,F as c,V as d,S as m,M as h,U as y,t as f,Z as v,b as g,d as b,am as x,G as w,B as S,n as V,a as z,x as P,g as A,o as T,l as M,w as _,$ as C,q as R,at as O,r as D,f as I,a0 as F,C as L,m as E,a3 as k,D as B,a5 as U,s as N,L as H,au as j,j as q,y as W,Y as G,as as K,a1 as Z,av as $,z as X,K as Y,aw as Q,a6 as J,E as ee,ax as te,h as ie,ay as se,A as oe,p as ae,az as re,i as ne,c as le,T as ue,N as pe,H as ce,e as de,O as me,a9 as he,ac as ye,J as fe,aA as ve}from"./GraphShaderModule.js";import{h as ge,R as be,i as xe}from"../core/lang.js";import{f as we,M as Se,a as Ve,b as ze,e as Pe,U as Ae}from"./UpdateTracking2D.js";import{m as Te,p as Me,Z as _e,_ as Ce,y as Re,z as Oe,$ as De}from"./definitions.js";import{b as Ie,g as Fe,c as Le,d as Ee,u as ke,i as Be,r as Ue,e as Ne,f as He,h as je,j as qe,o as We}from"./utils26.js";import{j as Ge,k as Ke,R as Ze,c as $e,l as Xe,o as Ye,a as Qe,b as Je,t as et,q as tt,r as it,d as st,e as ot,s as at,p as rt,u as nt,v as lt,f as ut,g as pt,h as ct,i as dt}from"./constants3.js";import{i as mt,m as ht}from"./mat3.js";import{c as yt}from"./mat3f32.js";import{g as ft,f as vt,h as gt,j as bt,k as xt,l as wt,i as St,m as Vt}from"./util.js";import{D as zt,U as Pt,e as At,b as Tt,T as Mt,l as _t,P as Ct,p as Rt,q as Ot,r as Dt}from"./enums.js";import{B as It,V as Ft}from"./VertexArrayObject.js";import{R as Lt,a as Et,F as kt}from"./FramebufferObject.js";import{a as Bt,T as Ut}from"./Texture.js";import"./FBOAttachmentType.js";import{V as Nt}from"./VertexElementDescriptor.js";import{L as Ht,n as jt}from"./Logger.js";import{f as qt}from"./maybe.js";import{l as Wt}from"./heatmapTextureUtils.js";import{p as Gt,t as Kt}from"./screenUtils.js";import{f as Zt,g as $t}from"./rasterizingUtils.js";import{r as Xt}from"./WGLContainer.js";import{g as Yt}from"./unitUtils.js";import{m as Qt}from"./lengthUtils.js";import{a as Jt,T as ei}from"./streamLayerUtils.js";import ti from"../core/Error.js";import{g as ii}from"./capabilities2.js";import{ignoreAbortErrors as si,createResolver as oi}from"../core/promiseUtils.js";import{QueueProcessor as ai}from"./QueueProcessor.js";const ri=new class{get forceStaticPath(){return"disabled"===ge("esri-cim-animations-enable-status")}get forceAnimatedPath(){return"forced"===ge("esri-cim-animations-enable-status")}get freezeGlobalTime(){return ge("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!ge("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return!1!==ge("esri-cim-animations-freeze-time")}},ni={[zt.BYTE]:1,[zt.UNSIGNED_BYTE]:1,[zt.SHORT]:2,[zt.UNSIGNED_SHORT]:2,[zt.HALF_FLOAT]:2,[zt.INT]:4,[zt.UNSIGNED_INT]:4,[zt.FLOAT]:4};class li{constructor(e,t){this._boundPart=null,this.vertexBuffers=new Map,this.indexBuffers=new Map,this.groups=[];for(const i in t.vertex){const{data:s,attributes:o}=t.vertex[i],a=It.createVertex(e,Pt.STATIC_DRAW,s);this.vertexBuffers.set(i,{buffer:a,attributes:o})}for(const i in t.index){const{data:s}=t.index[i],o=It.createIndex(e,Pt.STATIC_DRAW,s);this.indexBuffers.set(i,{buffer:o})}for(const e of t.groups)this.groups.push({...e,vertexArrays:new Map});this.parts=t.parts}bind(e,t,i){this._boundPart=i;const{group:s}=this.parts[this._boundPart],o=this.groups[s];if(!o)throw new Error(`Missing group ${s}.`);let a=o.vertexArrays.get(t.stringHash);if(!a){const i=new Set(t.locations.keys()),s=o.index?this.indexBuffers.get(o.index)?.buffer:null,r=new Map,n=new Map;for(const[e,{buffer:t,attributes:s}]of this.vertexBuffers){const o=s.filter((e=>i.has(e.name)));o.length>0&&(r.set(e,o),n.set(e,t))}a=new Ft(e,t.locations,r,n,s),o.vertexArrays.set(t.stringHash,a)}e.bindVAO(a)}draw(e){if(null==this._boundPart)throw new Error("Mesh.bind() has not been called.");const{start:t,count:i}=this.parts[this._boundPart],{group:s}=this.parts[this._boundPart],{primitive:o,index:a}=this.groups[s];if(a){const s=this.indexBuffers.get(a);if(!s)throw new Error(`Missing index buffer "${a}".`);const{indexType:r}=s.buffer;if(!r)throw new Error("Buffer type error.");e.drawElements(o,i,r,t*ni[r])}else e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArrays:e}of this.groups)for(const[t,i]of e)i.disposeVAOOnly();for(const{buffer:e}of this.vertexBuffers.values())e.dispose();for(const{buffer:e}of this.indexBuffers.values())e.dispose()}}const ui={position:{type:zt.SHORT,count:2}};class pi extends li{static create(e,t){const i=[];let{stride:s}=t;if(null==s){s=0;for(const[e,{count:i,type:o,offset:a}]of Object.entries(t.layout)){if(null!=a)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");s+=i*ni[o]}}let o=0;for(const[e,{count:a,offset:r,type:n,normalized:l}]of Object.entries(t.layout)){null!=r&&(o=r);const t=new Nt(e,a,n,o,s,null!=l&&l,0);i.push(t),o+=a*ni[n]}const a={primitive:t.primitive};null!=t.index&&(a.index="indexData");let{count:r}=t;if(null==r&&(r=t.index?t.index.length:t.vertex.byteLength/s,Math.floor(r)!==r))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${s}.`);const n={start:0,count:r,group:0,primitive:t.primitive},l={vertex:{vertexData:{data:t.vertex,attributes:i}},parts:[n],groups:[a]};return null!=t.index&&(l.index={indexData:{data:t.index}}),new pi(e,l,t.layout)}static fromVertexStream(e,t){return pi.create(e,{primitive:At.TRIANGLE_STRIP,vertex:new Uint16Array(t),layout:ui})}constructor(e,t,i){super(e,t),this._spec=i}bind(e,t,i=0){super.bind(e,t,i)}}class ci extends y{}var di;l([p(c)],ci.prototype,"globalTime",void 0),l([p(d)],ci.prototype,"animationTextureSize",void 0),l([p(m)],ci.prototype,"animationTexture",void 0),l([p(h)],ci.prototype,"toScreen",void 0),l([p(h)],ci.prototype,"toNdc",void 0),l([p(c)],ci.prototype,"mapRotation",void 0),l([p(c)],ci.prototype,"pixelRatio",void 0),function(e){e[e.transform=0]="transform",e[e.fromColor=1]="fromColor",e[e.toColor=2]="toColor",e[e.colorMix=3]="colorMix",e[e.toOpacity=4]="toOpacity",e[e.opacityMix=5]="opacityMix",e[e.shift=6]="shift"}(di||(di={}));class mi extends y{getVisualVariableData(e){if(!this._vvData){const t=this.getAttributeDataCoords(e);this._vvData=f(this.visualVariableData,t).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(e){if(!this._uv){const t=Ie(e),i=this.size,s=v(t.x),o=v(t.y).multiply(v(256)),a=v(t.z).multiply(v(256)).multiply(v(256)),r=g(s.add(o).add(a)),n=b(r,i),l=r.subtract(n).divide(i);this._uv=new d(n,l).add(.5).divide(i)}return this._uv}getFilterData(e){const t=this.getAttributeDataCoords(e);return f(this.filterFlags,t).setDebugName("storage0")}getAnimationData(e){const t=this.getAttributeDataCoords(e);return f(this.animation,t).setDebugName("storage1")}getVVData(e){return this.getVisualVariableData(e)}getDataDrivenData0(e){const t=this.getAttributeDataCoords(e);return f(this.dataDriven0,t).setDebugName("storage30")}getDataDrivenData1(e){const t=this.getAttributeDataCoords(e);return f(this.dataDriven1,t).setDebugName("storage31")}getDataDrivenData2(e){const t=this.getAttributeDataCoords(e);return f(this.dataDriven2,t).setDebugName("storage32")}getGPGPUData(e){const t=this.getAttributeDataCoords(e);return f(this.gpgpu,t).setDebugName("storage4")}getLocalTimeOrigin(e){const t=this.getAttributeDataCoords(e);return f(this.localTimeOrigin,t).x.setDebugName("storage5")}getFilterFlags(e){return ge("webgl-ignores-sampler-precision")?x(this.getFilterData(e).x.multiply(g(255))):this.getFilterData(e).x.multiply(g(255))}getLabelVisibility(e){const t=this.getFilterData(e).y.multiply(255);return new c(1).subtract(t)}getAnimationValue(e){return this.getAnimationData(e).x}getSizeValue(e){return this.getVisualVariableData(e).x}getColorValue(e){return this.getVisualVariableData(e).y}getOpacityValue(e){return this.getVisualVariableData(e).z}getRotationValue(e){return this.getVisualVariableData(e).w}}l([p(m)],mi.prototype,"filterFlags",void 0),l([p(m)],mi.prototype,"animation",void 0),l([p(m)],mi.prototype,"gpgpu",void 0),l([p(m)],mi.prototype,"localTimeOrigin",void 0),l([p(m)],mi.prototype,"visualVariableData",void 0),l([p(m)],mi.prototype,"dataDriven0",void 0),l([p(m)],mi.prototype,"dataDriven1",void 0),l([p(m)],mi.prototype,"dataDriven2",void 0),l([p(c)],mi.prototype,"size",void 0);class hi extends y{}l([p(c)],hi.prototype,"activeReasons",void 0),l([p(c)],hi.prototype,"highlightAll",void 0);class yi extends y{}l([p(d)],yi.prototype,"position",void 0),l([p(c)],yi.prototype,"distance",void 0),l([p(c)],yi.prototype,"smallSymbolDistance",void 0),l([p(c)],yi.prototype,"smallSymbolSizeThreshold",void 0);class fi extends y{}l([p(h)],fi.prototype,"displayViewScreenMat3",void 0),l([p(h)],fi.prototype,"displayViewMat3",void 0),l([p(h)],fi.prototype,"displayMat3",void 0),l([p(h)],fi.prototype,"viewMat3",void 0),l([p(h)],fi.prototype,"tileMat3",void 0),l([p(c)],fi.prototype,"displayZoomFactor",void 0),l([p(c)],fi.prototype,"requiredZoomFactor",void 0),l([p(d)],fi.prototype,"tileOffset",void 0),l([p(c)],fi.prototype,"currentScale",void 0),l([p(c)],fi.prototype,"currentZoom",void 0),l([p(c)],fi.prototype,"metersPerSRUnit",void 0),l([p(c)],fi.prototype,"rotation",void 0),l([p(c)],fi.prototype,"pixelRatio",void 0);class vi extends R{}l([T(0,M)],vi.prototype,"id",void 0),l([T(1,c)],vi.prototype,"bitset",void 0),l([T(2,d)],vi.prototype,"pos",void 0);class gi extends O{}l([T(14,d)],gi.prototype,"nextPos1",void 0),l([T(15,d)],gi.prototype,"nextPos2",void 0);class bi extends D{}class xi extends w{clip(e,t){let i=new c(0);const s=this.storage.getFilterFlags(e);if(i=i.add(g(2).multiply(g(1).subtract(Fe(s,0)))),this.inside?i=i.add(g(2).multiply(g(1).subtract(Fe(s,1)))):this.outside?i=i.add(g(2).multiply(Fe(s,1))):this.highlight&&(i=i.add(g(2).multiply(g(1).subtract(this._checkHighlight(s))))),null!=t){const e=new c(1).subtract(S(t.x,this.view.currentZoom)),s=S(t.y,this.view.currentZoom);i=i.add(new c(2).multiply(e.add(s)))}return i}getFragmentOutput(e,t,i=new c(1/255)){const s=new V;return s.fragColor=this._maybeWriteHittest(t)??this._maybeHighlight(e,i)??e,s}_maybeHighlight(e,t){return this.highlight?new z(e.rgb,S(t,e.a)):null}_checkHighlight(e){let t=this._checkHighlightBit(e,0);for(let i=1;i<Te;i++)t=t.add(this._checkHighlightBit(e,i));return S(new c(.1),t.add(this.highlight.highlightAll))}_checkHighlightBit(e,t){return Le(e,t).multiply(Ee(this.highlight.activeReasons,t))}maybeRunHittest(e,t,i){if(null==this.hittestRequest)return null;const s=this.hittest(e,t,i);let o=P(A(s,this.hittestRequest.distance),new c(2),new c(0));const a=this.storage.getAttributeDataCoords(e.id),r=ke(a);o=o.add(this.clip(e.id,e.zoomRange));const n=new z(new c(1/255),0,0,0);return{glPointSize:new c(1),glPosition:new z(r,o,1),color:n}}_maybeWriteHittest(e){return null!=this.hittestRequest?e.color:null}}l([_],xi.prototype,"inside",void 0),l([_],xi.prototype,"outside",void 0),l([C(hi)],xi.prototype,"highlight",void 0),l([p(mi)],xi.prototype,"storage",void 0),l([p(fi)],xi.prototype,"view",void 0),l([C(yi)],xi.prototype,"hittestRequest",void 0);class wi extends y{getPatternOffsetAtTileOrigin(e,t=new c(0),i=new c(1)){const s=new d(Ge).divide(e);let o=e.multiply(I(this.maxIntsToLocalOrigin.multiply(s))).add(this.tileOffsetFromLocalOrigin).subtract(new c(.5).multiply(e));return o=new d(o.x.multiply(i).subtract(o.y.multiply(t)),o.x.multiply(t).add(o.y.multiply(i))),b(o,e)}}l([p(d)],wi.prototype,"tileOffsetFromLocalOrigin",void 0),l([p(d)],wi.prototype,"maxIntsToLocalOrigin",void 0);class Si extends y{}l([p(d)],Si.prototype,"size",void 0),l([p(m)],Si.prototype,"texture",void 0);class Vi extends y{getColor(e,t,i){return L([U(Be(e),i),t],[B(e,this.values.first()),this.colors.first()],[k(e,this.values.last()),this.colors.last()],[!0,()=>{const t=this.values.findIndex((t=>A(t,e))),i=this.values.get(t),s=t.subtract(1),o=this.values.get(s),a=e.subtract(o).divide(i.subtract(o));return E(this.colors.get(s),this.colors.get(t),a)}])}}l([p(F.ofType(z,8))],Vi.prototype,"colors",void 0),l([p(F.ofType(c,8))],Vi.prototype,"values",void 0);class zi extends y{getOpacity(e){return L([Be(e),new c(1)],[B(e,this.opacityValues.first()),this.opacities.first()],[k(e,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const t=this.opacityValues.findIndex((t=>A(t,e))),i=this.opacityValues.get(t),s=t.subtract(1),o=this.opacityValues.get(s),a=e.subtract(o).divide(i.subtract(o));return E(this.opacities.get(s),this.opacities.get(t),a)}])}}l([p(F.ofType(c,8))],zi.prototype,"opacities",void 0),l([p(F.ofType(c,8))],zi.prototype,"opacityValues",void 0);class Pi extends y{getVVRotationMat4(e){return P(Be(e),j.identity(),(()=>{const t=this.getNormalizedAngle(e).multiply(Ke),i=N(t),s=H(t);return new j(s,i,0,0,i.multiply(new c(-1)),s,0,0,0,0,1,0,0,0,0,1)}))}getVVRotationMat3(e){return P(Be(e),h.identity(),(()=>{const t=this.getNormalizedAngle(e).multiply(Ke),i=N(t),s=H(t);return new h(s,i,0,i.multiply(new c(-1)),s,0,0,0,1)}))}getNormalizedAngle(e){const t=q(this.rotationType,new c(Ze.Arithmatic));return P(t,new c(90).subtract(e),e)}}l([p(c)],Pi.prototype,"rotationType",void 0);class Ai extends y{getSize(e,t){const i=this.minMaxValueAndSize.xy,s=this.minMaxValueAndSize.zw;return P(Be(e),t,(()=>{const t=e.subtract(i.x).divide(i.y.subtract(i.x)),o=W(t,new c(0),new c(1));return s.x.add(o.multiply(s.y.subtract(s.x)))}))}}l([p(z)],Ai.prototype,"minMaxValueAndSize",void 0);class Ti extends y{getSizeForViewScale(e){return L([B(e,this.values.first()),this.sizes.first()],[k(e,this.values.last()),this.sizes.last()],[!0,()=>{const t=this.values.findIndex((t=>A(t,e))),i=this.values.get(t),s=t.subtract(1),o=this.values.get(s),a=e.subtract(o).divide(i.subtract(o));return E(this.sizes.get(s),this.sizes.get(t),a)}])}}l([p(F.ofType(c,8))],Ti.prototype,"sizes",void 0),l([p(F.ofType(c,8))],Ti.prototype,"values",void 0);class Mi extends y{getSize(e,t){const i=L([Be(e),t],[B(e,this.values.first()),this.sizes.first()],[k(e,this.values.last()),this.sizes.last()],[!0,()=>{const t=this.values.findIndex((t=>A(t,e))),i=this.values.get(t),s=t.subtract(1),o=this.values.get(s),a=e.subtract(o).divide(i.subtract(o));return E(this.sizes.get(s),this.sizes.get(t),a)}]);return P(Be(i),t,i)}}l([p(F.ofType(c,8))],Mi.prototype,"sizes",void 0),l([p(F.ofType(c,8))],Mi.prototype,"values",void 0);class _i extends y{getSize(e,t){return P(Be(e),t,e.multiply(this.unitValueToPixelsRatio))}}function Ci(e){return null!=e.visualVariableSizeMinMaxValue||null!=e.visualVariableSizeScaleStops||null!=e.visualVariableSizeStops||null!=e.visualVariableSizeUnitValue}function Ri(e,t,i){if(Ci(e)){const s=e.storage.getSizeValue(t);return e.visualVariableSizeMinMaxValue?.getSize(s,i)??e.visualVariableSizeScaleStops?.getSizeForViewScale(e.view.currentScale)??e.visualVariableSizeStops?.getSize(s,i)??e.visualVariableSizeUnitValue?.getSize(s,i)}return i}function Oi(e,t,i,s=new G(!1)){if(null==e.visualVariableColor)return i;const o=e.storage.getColorValue(t);return e.visualVariableColor.getColor(o,i,s)}function Di(e,t){if(null==e.visualVariableOpacity)return new c(1);const i=e.storage.getOpacityValue(t);return e.visualVariableOpacity.getOpacity(i)}function Ii(e,t){if(null==e.visualVariableRotation)return h.identity();const i=e.storage.getRotationValue(t);return e.visualVariableRotation.getVVRotationMat3(i)}l([p(c)],_i.prototype,"unitValueToPixelsRatio",void 0);class Fi extends vi{}l([T(3,d)],Fi.prototype,"offset",void 0),l([T(4,z)],Fi.prototype,"sizing",void 0),l([T(5,z)],Fi.prototype,"value1Position2Value2",void 0),l([T(6,z)],Fi.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),l([T(7,d)],Fi.prototype,"zoomRange",void 0),l([T(8,c)],Fi.prototype,"lineLength",void 0);class Li extends bi{}class Ei extends xi{_vertexPreamble(e,t,i){const{id:s,offset:o,animationPointerAndBaseSizeAndReferenceSize:a,sizing:r}=e,n=a.xy,l=a.z,u=a.w,p=r.xy,d=this._getEvalParams(e,p,i);let m,h;if(e.value1Position2Value2){const t=ki(n,di.shift,d).a,i=e.pos,s=e.value1Position2Value2.yz,o=e.value1Position2Value2.x,a=e.value1Position2Value2.w,r=t.subtract(o).divide(a.subtract(o));h=i.add(s.subtract(i).multiply(r)),m=S(new c(1),r).add(S(new c(0),Z(r)))}else h=e.pos,m=new c(0);const y=r.z,f=Ee(e.bitset,Se.bitset.isStroke),v=r.w,g=Ee(e.bitset,Se.bitset.scaleSymbolsProportionally),b=ki(n,di.transform,d),x=L([q(Ee(e.bitset,Se.bitset.isMapAligned),new c(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new c(0)]),w=new $(H(x),N(x.multiply(-1)),N(x),H(x)).multiply(b.xy),V=b.z.subtract(x).subtract(t.multiply($e)),z=b.w,P=Ee(e.bitset,Se.bitset.isSDF),A=Ri(this,s,new c(u)).divide(new c(u));return{baseSize:l,animationPointer:n,strokeWidth:y,isOutline:f,unscaledDistanceToPx:v,scaleSymbolsProportionally:g,isSDF:P,position:this._getScreenPosition({id:s,pos:h,offset:o,referenceSize:u,translation:w,rotation:V,scale:z,vvScale:A}),evalParams:d,vvScale:A,scale:z,clip:m}}_getScreenPosition(e){const{pos:t,translation:i,rotation:s,scale:o,offset:a,id:r,vvScale:n}=e,l=function(e,t){if(null==e.visualVariableRotation)return new c(0);const i=e.storage.getRotationValue(t);return e.visualVariableRotation.getNormalizedAngle(i)}(this,r).multiply(Math.PI/180),u=i.x.multiply(4/3),p=i.y.multiply(-1).multiply(4/3),d=N(l),m=H(l),y=m.multiply(u).add(Z(d).multiply(p)),f=d.multiply(u).add(m.multiply(p)),v=N(s.subtract(l)),g=H(s.subtract(l)),b=new c(0),x=new c(1),{pixelRatio:w}=this.animationInfo,S=new h(x,b,b,b,x,b,y.multiply(w),f.multiply(w),x),V=new h(g,v.multiply(-1),b,v,g,b,0,0,x),z=o.multiply(n).multiply(w).multiply(4/3),P=V.multiply(z),A=this.animationInfo.toScreen.multiply(new M(t,1)),T=S.multiply(A).xy,_=P.multiply(new M(a,0)).xy;return T.add(_)}_clip(e,t){let i=super.clip(e,t);const s=B(this._getLocalTimeOrigin(e),new c(0));return ri.forceGlobalTimeOrigin||(i=i.add(L([s,()=>new c(2)],[!0,()=>new c(0)]))),i}_getLocalTimeOrigin(e){return this.storage.getLocalTimeOrigin(e)}_toNdc(e){return this.animationInfo.toNdc.multiply(new M(e,1)).xy}_getEvalParams(e,t,i){const{globalTime:s,animationTextureSize:o,animationTexture:a}=this.animationInfo;return{globalTime:s,localTimeOrigin:this._getLocalTimeOrigin(e.id),animationTextureSize:o,animationTexture:a,pixelDimensions:t,lineLength:i}}_getColor(e,t){return P(q(t.isSDF,new c(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return f(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=f(this.mosaicInfo.texture,e),s=new c(.5).subtract(Ue(i)).multiply(t.distanceToPx).multiply(Xe),o=W(new c(.5).subtract(s),new c(0),new c(1)),a=t.color.multiply(o),r=t.outlineSize.multiply(.5),n=X(s).subtract(r),l=W(new c(.5).subtract(n),new c(0),new c(1)),u=t.outlineColor.multiply(l);return new c(1).subtract(u.a).multiply(a).add(u)}}function ki(e,t,i){const s=e.add(new d(t,0)),o=f(i.animationTexture,s.add(.5).divide(i.animationTextureSize)).xy;return e=e.add(o),K({animationPointer:e,...i},z,null,(e=>{const{out:t}=e;if(!t)throw new Error("out is null");return we({...e,out:t})}))}l([p(Si)],Ei.prototype,"mosaicInfo",void 0),l([p(ci)],Ei.prototype,"animationInfo",void 0),l([p(wi)],Ei.prototype,"localTileOffset",void 0),l([C(Vi)],Ei.prototype,"visualVariableColor",void 0),l([C(zi)],Ei.prototype,"visualVariableOpacity",void 0),l([C(Ai)],Ei.prototype,"visualVariableSizeMinMaxValue",void 0),l([C(Ti)],Ei.prototype,"visualVariableSizeScaleStops",void 0),l([C(Mi)],Ei.prototype,"visualVariableSizeStops",void 0),l([C(_i)],Ei.prototype,"visualVariableSizeUnitValue",void 0),l([C(Pi)],Ei.prototype,"visualVariableRotation",void 0);class Bi extends Fi{}l([T(9,z)],Bi.prototype,"tlbr",void 0);class Ui extends O{}l([T(13,d)],Ui.prototype,"nextPos1",void 0),l([T(14,d)],Ui.prototype,"nextPos2",void 0);class Ni extends Li{}class Hi extends Ei{_fragmentPoly(e){const t=b(e.uv,new c(1)),i=E(e.tlbr.xy,e.tlbr.zw,t);return this._getColor(i,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth})}_vertexPoly(e){const{position:t,animationPointer:i,evalParams:s,isOutline:o,unscaledDistanceToPx:a,vvScale:r,strokeWidth:n,scaleSymbolsProportionally:l,scale:u,isSDF:p,baseSize:d,clip:m}=this._vertexPreamble(e,new c(0),e.lineLength||new c(0)),h=this._toNdc(t);let y=ki(i,di.fromColor,s);y=new z(y.rgb.multiply(y.a),y.a);let f=ki(i,di.toColor,s);f=new z(f.rgb.multiply(f.a),f.a);let v=ki(i,di.colorMix,s);v=new z(v.rgb.multiply(v.a),v.a);const g=ki(i,di.toOpacity,s).a,b=ki(i,di.opacityMix,s).a,x=Oi(this,e.id,y,U(Ne(e.bitset,Se.bitset.colorLocked),new G(o))),w=E(x,f,v),S=Di(this,e.id),V=E(S,g,b),P=w.multiply(V),A=this.clip(e.id,e.zoomRange).add(m.multiply(2)),T=a.multiply(r);return{unscaledDistanceToPx:a,vvScale:r,strokeWidth:n,scaleSymbolsProportionally:l,scale:u,isSDF:p,baseSize:d,ndc:h,color:P,z:A,isOutline:o,evalParams:s,distanceToPx:T}}}function ji(e,t,i){const s=i.subtract(t),o=e.subtract(t),a=ie(o,se(s)),r=W(a.divide(Y(s)),new c(0),new c(1));return Q(e,t.add(r.multiply(i.subtract(t))))}function qi(e){const t=X(e);return S(t.x.add(t.y).add(t.z),new c(1.05))}function Wi(e,t,i,s){const o=new h(i.x.multiply(s.y).subtract(s.x.multiply(i.y)),s.x.multiply(t.y).subtract(t.x.multiply(s.y)),t.x.multiply(i.y).subtract(i.x.multiply(t.y)),i.y.subtract(s.y),s.y.subtract(t.y),t.y.subtract(i.y),s.x.subtract(i.x),t.x.subtract(s.x),i.x.subtract(t.x)),a=t.x.multiply(i.y.subtract(s.y)),r=i.x.multiply(s.y.subtract(t.y)),n=s.x.multiply(t.y.subtract(i.y)),l=a.add(r).add(n);return new c(1).divide(l).multiply(o.multiply(new M(1,e)))}function Gi(e,t,i,s){return q(qi(Wi(e,t,i,s)),new c(1))}function Ki(e,t,i,s){const o=i.subtract(t),a=s.subtract(t),r=He(o,a),n=J(ee(r,new c(Ye)),A(r,new c(-.05)));return L([J(te(n),Gi(e.xy,t,i,s)),new c(-1)],[!0,()=>{const o=ji(e,t,i),a=ji(e,i,s),r=ji(e,s,t);return oe(oe(o,a),r)}])}function Zi(e){return e.distance.add(1)}function $i(e,t,i){const{viewMat3:s,tileMat3:o}=e.view,a=s.multiply(o),r=a.multiply(new M(t.pos,1)),n=a.multiply(new M(i.nextPos1,1)),l=a.multiply(new M(i.nextPos2,1));return Ki(e.hittestRequest.position,r.xy,n.xy,l.xy)}class Xi extends vi{}l([T(3,z)],Xi.prototype,"color",void 0),l([T(4,d)],Xi.prototype,"zoomRange",void 0);class Yi extends xi{constructor(){super(...arguments),this.type="FillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const i=Di(this,e.id),s=Oi(this,e.id,e.color).multiply(i),o=this.view.displayViewScreenMat3.multiply(new M(e.pos.xy,1)),a=this.clip(e.id,e.zoomRange);return{glPosition:new z(o.xy,a,1),color:s,...this.maybeRunHittest(e,t,null)}}fragment(e){return this.getFragmentOutput(e.color,e,new c(0))}hittest(e,t){return $i(this,e,t)}}l([C(Vi)],Yi.prototype,"visualVariableColor",void 0),l([C(zi)],Yi.prototype,"visualVariableOpacity",void 0),l([u(0,ae(Xi)),u(1,ae(gi))],Yi.prototype,"vertex",null),l([u(0,ae(bi))],Yi.prototype,"fragment",null);class Qi extends Xi{}function Ji(e,t,i,s,o){const a=q(Ee(o,Je),g(1)),r=Ue(new z(e,0));return P(a,re(s.divide(t.x),i.divide(t.y),0,Z(i.divide(t.x)),s.divide(t.y),0,je(ne(r,0)),je(ne(0,r)),1),re(s.divide(t.x),i.divide(t.y),0,Z(i.divide(t.x)),s.divide(t.y),0,0,0,1))}function es(e,t){const i=e.view.requiredZoomFactor,s=new d(t.width,t.height),o=s.multiply(t.scale).multiply(i),a=t.angle.multiply($e),r=N(a),n=H(a),l=Ji(t.id,o,r,n,t.bitset),u=e.localTileOffset.getPatternOffsetAtTileOrigin(s,r,n),p=i.multiply(t.scale).multiply(t.offset.subtract(u)).divide(o),m=new M(t.pos,1),h=l.multiply(m).xy.subtract(p),y=t.tlbr.divide(e.mosaicInfo.size.xyxy);let f=Ee(t.bitset,Qe);return null!=e.visualVariableColor&&(f=P(Be(e.storage.getColorValue(t.id)),new c(0),f)),{tileTextureCoord:h,tlbr:y,sampleAlphaOnly:f}}function ts(e,t){const i=b(t.tileTextureCoord,new c(1)),s=E(t.tlbr.xy,t.tlbr.zw,i);let o=f(e.mosaicInfo.texture,s);return o=P(A(t.sampleAlphaOnly,new c(.5)),o.aaaa,o),t.color.multiply(o)}l([T(5,z)],Qi.prototype,"tlbr",void 0),l([T(6,c)],Qi.prototype,"width",void 0),l([T(7,c)],Qi.prototype,"height",void 0),l([T(8,d)],Qi.prototype,"offset",void 0),l([T(9,d)],Qi.prototype,"scale",void 0),l([T(10,c)],Qi.prototype,"angle",void 0);class is extends Yi{constructor(){super(...arguments),this.type="ComplexFillShader"}vertex(e,t){return{...super.vertex(e,t),...es(this,e)}}fragment(e){const t=ts(this,e);return this.getFragmentOutput(t,e,new c(0))}}l([p(Si)],is.prototype,"mosaicInfo",void 0),l([p(wi)],is.prototype,"localTileOffset",void 0),l([u(0,ae(Qi)),u(1,ae(gi))],is.prototype,"vertex",null),l([u(0,ae(class extends bi{}))],is.prototype,"fragment",null);class ss extends Hi{constructor(){super(...arguments),this.type="AnimatedFillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const{distanceToPx:i,ndc:s,z:o,color:a,isOutline:r,strokeWidth:n,isSDF:l,baseSize:u,scale:p,scaleSymbolsProportionally:d}=this._vertexPoly(e),m=this.view.requiredZoomFactor,y=e.sizing.xy,f=y.multiply(m),v=new c(0),g=N(v),b=H(v),x=Ji(e.id,f,g,b,e.bitset),w=this.localTileOffset.getPatternOffsetAtTileOrigin(y,g,b),S=m.multiply(e.offset.subtract(w)).divide(f),V=new M(e.pos,1),P=x.multiply(V).xy.subtract(S),A=e.tlbr.divide(this.mosaicInfo.size.xyxy);return{glPosition:new z(s,o,1),tlbr:A,uv:P,color:a.multiply(new c(1).subtract(r)),outlineColor:a.multiply(r),distanceToPx:i,strokeWidth:n.multiply(E(new c(1),p,d)),isOutline:r,isSDF:l,...this.maybeRunHittest(e,t,{pos:e.pos,size:u,sizeCorrection:new c(1),isMapAligned:new c(1),vvRotationMat3:new h(1,0,0,0,1,0,0,0,1),placementMat3:new h(1,0,0,0,1,0,0,0,1),outlineSize:new c(1),distanceToPx:i,isSDF:l})}}fragment(e){const t=this._fragmentPoly(e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return $i(this,e,t)}}l([u(0,ae(Bi)),u(1,ae(Ui))],ss.prototype,"vertex",null),l([u(0,ae(Ni))],ss.prototype,"fragment",null);let os=class extends vi{};l([T(3,z)],os.prototype,"color",void 0),l([T(4,d)],os.prototype,"offset",void 0),l([T(5,d)],os.prototype,"normal",void 0),l([T(6,c)],os.prototype,"halfWidth",void 0),l([T(7,c)],os.prototype,"referenceHalfWidth",void 0),l([T(8,d)],os.prototype,"zoomRange",void 0);let as=class extends bi{};class rs extends y{}function ns(e){return le(new c(et).multiply(S(e,new c(tt))),new c(1))}function ls(e,t){const{halfWidth:i,normal:s}=e,o=ns(i),a=Y(s).multiply(i);return W(o.multiply(i.subtract(a)).divide(t.add(o).subtract(new c(1))),new c(0),new c(1))}function us(e,t){const{id:i,offset:s,pos:o,normal:a,zoomRange:r}=t,{displayViewScreenMat3:n,displayViewMat3:l}=e.view,u=Oi(e,i,t.color),p=Di(e,i),d=function(e,t){const{id:i,halfWidth:s,referenceHalfWidth:o}=t;if(Ci(e)){const t=Ri(e,i,new c(2).multiply(o));return new c(.5).multiply(s.divide(le(o,new c(it)))).multiply(t)}return s}(e,t),m=new c(.5).multiply(e.antialiasingControls.antialiasing),h=le(d.add(m),new c(.45)).add(new c(.1).multiply(m)),y=ns(h).multiply(h).multiply(s),f=l.multiply(new M(y,new c(0))),v=n.multiply(new M(o,new c(1))).add(f),g=new c(2).multiply(S(d,new c(0))).add(e.clip(i,r)),b=new z(v.xy,g,1);return{color:u,opacity:p,halfWidth:h,normal:a,scaledOffset:y,scaledHalfWidth:d,glPosition:new z(b.xy,g,1)}}function ps(e,t){const{opacity:i,color:s}=e,o=ls(e,t);return i.multiply(s).multiply(o)}l([p(c)],rs.prototype,"antialiasing",void 0),l([p(c)],rs.prototype,"blur",void 0);class cs extends xi{constructor(){super(...arguments),this.type="LineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const i=us(this,e);return{...i,...this.maybeRunHittest(e,t,i.halfWidth)}}fragment(e){const t=ps(e,this.antialiasingControls.blur);return this.getFragmentOutput(t,e)}hittest(e,t,i){const{viewMat3:s,tileMat3:o}=this.view,a=s.multiply(o),r=a.multiply(new M(e.pos,1)),n=a.multiply(new M(t.nextPos1,1)),l=a.multiply(new M(t.nextPos2,1)),{distance:u,smallSymbolDistance:p,smallSymbolSizeThreshold:c}=this.hittestRequest,d=S(i,c.multiply(.5)).multiply(u.subtract(p)),m=this.hittestRequest.position;return oe(ji(m,r.xy,n.xy),ji(m,r.xy,l.xy)).subtract(i).add(d)}}l([p(rs)],cs.prototype,"antialiasingControls",void 0),l([C(Vi)],cs.prototype,"visualVariableColor",void 0),l([C(zi)],cs.prototype,"visualVariableOpacity",void 0),l([C(Ai)],cs.prototype,"visualVariableSizeMinMaxValue",void 0),l([C(Ti)],cs.prototype,"visualVariableSizeScaleStops",void 0),l([C(Mi)],cs.prototype,"visualVariableSizeStops",void 0),l([C(_i)],cs.prototype,"visualVariableSizeUnitValue",void 0),l([u(0,ae(os)),u(1,ae(gi))],cs.prototype,"vertex",null),l([u(0,ae(as))],cs.prototype,"fragment",null);class ds extends Bi{}l([T(10,c)],ds.prototype,"accumulatedDistance",void 0),l([T(11,d)],ds.prototype,"normal",void 0),l([T(12,d)],ds.prototype,"segmentDirection",void 0);class ms extends Hi{constructor(){super(...arguments),this.type="AnimatedLineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const{animationPointerAndBaseSizeAndReferenceSize:i}=e,s=i.xy,{distanceToPx:o,ndc:a,z:r,color:n,isOutline:l,strokeWidth:u,isSDF:p,baseSize:m,scale:y,scaleSymbolsProportionally:f,evalParams:v}=this._vertexPoly(e),g=e.sizing.xy,b=g.x.multiply(m).divide(g.y),x=ki(s,di.shift,v).a,w=e.accumulatedDistance.subtract(x),{normal:S}=e,V=e.normal.y,P=w.divide(this.view.displayZoomFactor).add(ie(e.segmentDirection,e.offset)).divide(b),A=V.add(1).divide(2),T=new d(P,A),M=e.tlbr.divide(this.mosaicInfo.size.xyxy);return{glPosition:new z(a,r,1),tlbr:M,uv:T,color:n.multiply(new c(1).subtract(l)),outlineColor:n.multiply(l),distanceToPx:o,strokeWidth:u.multiply(E(new c(1),y,f)),isOutline:l,isSDF:p,halfWidth:m.divide(2),normal:S,...this.maybeRunHittest(e,t,{pos:e.pos,size:m,sizeCorrection:new c(1),isMapAligned:new c(1),vvRotationMat3:new h(1,0,0,0,1,0,0,0,1),placementMat3:new h(1,0,0,0,1,0,0,0,1),outlineSize:new c(1),distanceToPx:o,isSDF:p})}}fragment(e){const t=this._fragmentPoly(e),{halfWidth:i,normal:s}=e,o=ns(i),a=Y(s).multiply(i),r=W(o.multiply(i.subtract(a)).divide(o.subtract(new c(1))),new c(0),new c(1));return this.getFragmentOutput(t.multiply(r),e)}hittest(e,t,i){const{viewMat3:s,tileMat3:o}=this.view,a=s.multiply(o),r=a.multiply(new M(e.pos,1)),n=a.multiply(new M(t.nextPos1,1)),l=a.multiply(new M(t.nextPos2,1)),{distance:u,smallSymbolDistance:p,smallSymbolSizeThreshold:c}=this.hittestRequest,d=S(i,c.multiply(.5)).multiply(u.subtract(p)),m=this.hittestRequest.position;return oe(ji(m,r.xy,n.xy),ji(m,r.xy,l.xy)).subtract(i).add(d)}}l([u(0,ae(ds)),u(1,ae(Ui))],ms.prototype,"vertex",null),l([u(0,ae(class extends Ni{}))],ms.prototype,"fragment",null);class hs extends Fi{}l([T(9,d)],hs.prototype,"uv",void 0),l([T(10,c)],hs.prototype,"angle",void 0);class ys extends O{}function fs(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}l([T(11,d)],ys.prototype,"offsetNextVertex1",void 0),l([T(12,d)],ys.prototype,"offsetNextVertex2",void 0),l([T(13,d)],ys.prototype,"textureUVNextVertex1",void 0),l([T(14,d)],ys.prototype,"textureUVNextVertex2",void 0);class vs extends Ei{constructor(){super(...arguments),this.type="AnimatedMarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=e.uv.divide(this.mosaicInfo.size),{position:s,animationPointer:o,evalParams:a,isOutline:r,unscaledDistanceToPx:n,vvScale:l,strokeWidth:u,scaleSymbolsProportionally:p,scale:d,isSDF:m,baseSize:y,clip:f}=this._vertexPreamble(e,e.angle,e.lineLength||new c(0)),v=this._toNdc(s);let g=ki(o,di.fromColor,a);g=new z(g.rgb.multiply(g.a),g.a);let b=ki(o,di.toColor,a);b=new z(b.rgb.multiply(b.a),b.a);let x=ki(o,di.colorMix,a);x=new z(x.rgb.multiply(x.a),x.a);const w=ki(o,di.toOpacity,a).a,S=ki(o,di.opacityMix,a).a,V=Oi(this,e.id,g,U(Ne(e.bitset,Se.bitset.colorLocked),new G(r))),P=E(V,b,x),A=Di(this,e.id),T=E(A,w,S),M=P.multiply(T),_=this.clip(e.id,e.zoomRange).add(f.multiply(2)),C=n.multiply(l);return{glPosition:new z(v,_,1),uv:i,color:M.multiply(new c(1).subtract(r)),outlineColor:M.multiply(r),distanceToPx:C,strokeWidth:u.multiply(E(new c(1),d,p)),isOutline:r,isSDF:m,...this.maybeRunHittest(e,t,{pos:e.pos,size:y,sizeCorrection:new c(1),isMapAligned:new c(1),vvRotationMat3:new h(1,0,0,0,1,0,0,0,1),placementMat3:new h(1,0,0,0,1,0,0,0,1),outlineSize:new c(1),distanceToPx:C,isSDF:m})}}fragment(e){let t=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return ri.spotlightAnimatedSymbols&&(t=t.add(new z(0,.3,0,.3))),this.getFragmentOutput(t,e)}hittest(e,t,i){return P(ee(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_hittestSmallMarker(e,t,i){const{position:s,distance:o,smallSymbolDistance:a}=this.hittestRequest,r=o.subtract(a),{viewMat3:n,tileMat3:l}=this.view,u=n.multiply(l).multiply(new M(i.pos,1)).xy,p=i.size.multiply(.5);return Q(u,s).subtract(p).add(r)}_hittestMarker(e,t,i){const s=this._vertexPreamble({...e},e.angle,new c(0)).position,o=this._vertexPreamble({...e,offset:t.offsetNextVertex1},e.angle,new c(0)).position,a=this._vertexPreamble({...e,offset:t.offsetNextVertex2},e.angle,new c(0)).position,r=this.hittestRequest.position,n=this.hittestRequest.distance,l=Ki(r,s,o,a);return P(A(l,n),l,this._hittestSamples(s,o,a,e,t,i))}_hittestSamples(e,t,i,s,o,a){const{outlineSize:r,isSDF:n,distanceToPx:l}=a,u=this.hittestRequest.position,p=this.hittestRequest.distance,m=Wi(u.add(new d(Z(p),Z(p))),e,t,i),h=Wi(u.add(new d(0,Z(p))),e,t,i),y=Wi(u.add(new d(p,Z(p))),e,t,i),f=Wi(u.add(new d(Z(p),0)),e,t,i),v=Wi(u,e,t,i),g=Wi(u.add(new d(p,0)),e,t,i),b=Wi(u.add(new d(Z(p),p)),e,t,i),x=Wi(u.add(new d(0,p)),e,t,i),w=Wi(u.add(new d(p,p)),e,t,i),V=s.uv.divide(this.mosaicInfo.size),P=o.textureUVNextVertex1.divide(this.mosaicInfo.size),A=o.textureUVNextVertex2.divide(this.mosaicInfo.size),T={color:new z(1,1,1,1),outlineSize:r,outlineColor:new z(1,1,1,1),isSDF:n,distanceToPx:l};let M=new c(0);return M=M.add(qi(m).multiply(this._getColor(fs(m,V,P,A),T).a)),M=M.add(qi(h).multiply(this._getColor(fs(h,V,P,A),T).a)),M=M.add(qi(y).multiply(this._getColor(fs(y,V,P,A),T).a)),M=M.add(qi(f).multiply(this._getColor(fs(f,V,P,A),T).a)),M=M.add(qi(v).multiply(this._getColor(fs(v,V,P,A),T).a)),M=M.add(qi(g).multiply(this._getColor(fs(g,V,P,A),T).a)),M=M.add(qi(b).multiply(this._getColor(fs(b,V,P,A),T).a)),M=M.add(qi(x).multiply(this._getColor(fs(x,V,P,A),T).a)),M=M.add(qi(w).multiply(this._getColor(fs(w,V,P,A),T).a)),S(M,new c(.05)).multiply(Zi(this.hittestRequest))}}l([u(0,ae(hs)),u(1,ae(ys))],vs.prototype,"vertex",null),l([u(0,ae(class extends Li{}))],vs.prototype,"fragment",null);class gs extends ue{constructor(){super(...arguments),this.symbologyPlane=o.FILL,this._input=null}}class bs extends gs{render(e,t){const{context:i,painter:s}=e,{target:o}=t,{freezeGlobalTime:a}=ri,r=s.textureManager.animationStore.getTexture(i,0),n=[2/e.state.size[0],0,0,0,-2/e.state.size[1],0,-1,1,1],l=Array.from(mt(yt(),n)),u=Array.from(ht(yt(),l,o.transforms.displayViewScreenMat3)),p=t.instance.getInput(),c=s.textureManager.getMosaicInfo(i,t.textureKey,!1),{optionalAttributes:d}=p,m=d.zoomRange,h=d.value1Position2Value2,y="accumulatedDistance"in d&&d.accumulatedDistance,f="segmentDirection"in d&&d.segmentDirection,v="normal"in d&&d.normal;s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,p.uniforms),...gt(e,t.target),mosaicInfo:c,animationInfo:{globalTime:!1===a?e.time/1e3:a,animationTextureSize:[r.descriptor.width,r.descriptor.height],animationTexture:{unit:6,texture:r},toScreen:u,toNdc:n,mapRotation:e.state.rotation,pixelRatio:e.state.pixelRatio},localTileOffset:vt(t.target)},defines:{...ft(e)},optionalAttributes:{zoomRange:m,value1Position2Value2:h,accumulatedDistance:y,segmentDirection:f,normal:v},useComputeBuffer:!0}),s.setPipelineState({...xt(e)}),s.submitDraw(e,t),!1===a&&o.requestRender()}}class xs extends R{}l([T(0,d)],xs.prototype,"pos",void 0);class ws extends y{}l([p(c)],ws.prototype,"dotSize",void 0);class Ss extends y{}l([p(m)],Ss.prototype,"locations",void 0),l([p(c)],Ss.prototype,"pixelRatio",void 0),l([p(c)],Ss.prototype,"tileZoomFactor",void 0);class Vs extends w{constructor(){super(...arguments),this.type="DotDensityPointShader"}vertex(e){const t=new h(1,0,0,0,-1,0,0,1,1).multiply(new M(e.pos.xy.divide(Me),1)),i=f(this.draw.locations,t.xy),s=le(this.instance.dotSize.divide(2),new c(1));let o=new c(0);o=o.add(S(i.a,new c(1e-6)).multiply(2));let a=s.add(this.instance.dotSize);const r=this.view.displayViewScreenMat3.multiply(new M(e.pos.add(.5),1)),n=new z(r.xy,o,1),l=this.instance.dotSize.divide(a),u=new c(-1).divide(s.divide(a));return a=a.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:n,glPointSize:a,color:i,ratio:l,invEdgeRatio:u}}fragment(e){const t=Y(e.glPointCoord.subtract(.5)).multiply(2),i=pe(new c(0),new c(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),s=new V;return s.fragColor=e.color.multiply(i),s}}l([p(ws)],Vs.prototype,"instance",void 0),l([p(Ss)],Vs.prototype,"draw",void 0),l([p(fi)],Vs.prototype,"view",void 0),l([u(0,ae(xs))],Vs.prototype,"vertex",null),l([u(0,ae(class extends bi{}))],Vs.prototype,"fragment",null);class zs extends vi{}l([T(3,c)],zs.prototype,"inverseArea",void 0);class Ps extends y{}l([p(F.ofType(z,2))],Ps.prototype,"isActive",void 0),l([p(F.ofType(z,8))],Ps.prototype,"colors",void 0),l([p(c)],Ps.prototype,"dotValue",void 0);class As extends y{}l([p(m)],As.prototype,"dotTexture0",void 0),l([p(m)],As.prototype,"dotTexture1",void 0),l([p(c)],As.prototype,"tileZoomFactor",void 0),l([p(c)],As.prototype,"pixelRatio",void 0),l([p(c)],As.prototype,"tileDotsOverArea",void 0);class Ts extends xi{constructor(){super(...arguments),this.type="DotDensityPolygonShader"}_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new h(2/Me,0,0,0,-2/Me,0,-1,1,1).multiply(new M(e.pos,1)),i=this.clip(e.id),s=new z(t.xy,i,1),o=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),a=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),r=this.draw.tileZoomFactor.multiply(Me).divide(this.draw.pixelRatio),n=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),l=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),u=e.pos.add(.5).divide(r);return{glPosition:s,color:new z(0,0,0,0),textureCoords:u,thresholds0:n,thresholds1:l}}fragment(e){const t=new V,i=f(this.draw.dotTexture0,e.textureCoords),s=f(this.draw.dotTexture1,e.textureCoords),o=e.thresholds0.subtract(i),a=e.thresholds1.subtract(s);let r;const n=j.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),l=j.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const e=S(new c(0),o),t=S(new c(0),a),i=ie(e,o).add(ie(t,a)),s=S(i,new c(0)),u=new c(1).subtract(s),p=i.add(s),d=o.multiply(e).divide(p),m=a.multiply(t).divide(p),h=n.multiply(d).add(l.multiply(m));r=u.multiply(h)}else{const e=le(qe(o),qe(a)),t=S(e,new c(0)),i=new c(1).subtract(t),s=S(e,o),u=S(e,a),p=n.multiply(s).add(l.multiply(u));r=i.multiply(p)}return t.fragColor=r,t}hittest(e){return Zi(this.hittestRequest)}}l([_],Ts.prototype,"blending",void 0),l([p(Ps)],Ts.prototype,"instance",void 0),l([p(As)],Ts.prototype,"draw",void 0),l([u(0,ae(zs))],Ts.prototype,"vertex",null),l([u(0,ae(bi))],Ts.prototype,"fragment",null);const Ms={pos:{count:2,type:zt.UNSIGNED_SHORT}};class _s{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(null==this._dotFBO){const t=Me,i=Me,s=new Bt(t,i);s.samplingMode=Tt.NEAREST,s.wrapMode=Mt.CLAMP_TO_EDGE;const o=new Lt(e,new Et(_t.DEPTH24_STENCIL8,t,i));this._dotFBO=new kt(e,s,o)}return this._dotFBO}getDotDensityMesh(e){if(null==this._dotMesh){const t=Me,i=t*t,s=2,o=new Int16Array(i*s);for(let e=0;e<t;e++)for(let i=0;i<t;i++)o[s*(i+e*t)]=i,o[s*(i+e*t)+1]=e;this._dotMesh=pi.create(e,{primitive:At.POINTS,vertex:o,count:i,layout:Ms})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),null===this._dotTextures){const s=new be(i);this._dotTextures=[this._allocDotDensityTexture(e,t,s),this._allocDotDensityTexture(e,t,s)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const s=new Float32Array(t*t*4);for(let e=0;e<s.length;e++)s[e]=i.getFloat();const o=new Bt;return o.dataType=Ct.FLOAT,o.samplingMode=Tt.NEAREST,o.width=t,o.height=t,new Ut(e,o,s)}}function Cs(e){const t=1/e;return{antialiasing:t,blur:0+t}}class Rs extends vi{}l([T(3,d)],Rs.prototype,"offset",void 0),l([T(4,z)],Rs.prototype,"color",void 0),l([T(5,d)],Rs.prototype,"normal",void 0),l([T(6,c)],Rs.prototype,"halfWidth",void 0),l([T(7,c)],Rs.prototype,"referenceHalfWidth",void 0),l([T(8,d)],Rs.prototype,"zoomRange",void 0);class Os extends as{}function Ds(e,t,i){const{id:s,bitset:o}=t,a=Ee(o,st),r=A(a,new c(.5)),n=us(e,t),l=P(r,n.halfWidth,new c(0)),u=Di(e,s),p=Oi(e,s,t.color),d=P(r,P(Ne(o,ot),p,t.color),p.multiply(u)),m=e.view.displayViewScreenMat3.multiply(new M(t.pos.xy,1)),h=e.clip(t.id),y=new z(m.xy,h,1),f=P(r,n.glPosition,y),v=i&&e.maybeRunHittest(t,i,r);return{isOutline:a,color:d,opacity:new c(1),halfWidth:l,normal:n.normal,glPosition:f,...v}}class Is extends xi{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}}l([p(rs)],Is.prototype,"antialiasingControls",void 0),l([C(Vi)],Is.prototype,"visualVariableColor",void 0),l([C(zi)],Is.prototype,"visualVariableOpacity",void 0),l([C(Ai)],Is.prototype,"visualVariableSizeMinMaxValue",void 0),l([C(Ti)],Is.prototype,"visualVariableSizeScaleStops",void 0),l([C(Mi)],Is.prototype,"visualVariableSizeStops",void 0),l([C(_i)],Is.prototype,"visualVariableSizeUnitValue",void 0);class Fs extends Is{constructor(){super(...arguments),this.type="OutlineFillShader"}vertex(e,t){return Ds(this,e,t)}fragment(e){const{color:t,isOutline:i}=e,s=A(i,new c(.5)),o=ps(e,this.antialiasingControls.blur),a=P(s,o,t),r=P(s,new c(1/255),new c(0));return this.getFragmentOutput(a,e,r)}hittest(e,t,i){return P(i,Zi(this.hittestRequest),$i(this,e,t))}}l([u(0,ae(Rs)),u(1,ae(gi))],Fs.prototype,"vertex",null),l([u(0,ae(Os))],Fs.prototype,"fragment",null);class Ls extends Xi{}function Es(e,t){const i=t.tlbr.xy,s=t.tlbr.zw,o=s.x.subtract(i.x),a=i.y.subtract(s.y),r=new d(o,a).multiply(t.inverseRasterizationScale),n=r.multiply(e.view.requiredZoomFactor),l=function(e){const t=new c(1),i=new c(0);return new h(t.divide(e.x),i.divide(e.y),0,Z(i.divide(e.x)),t.divide(e.y),0,0,0,1)}(n),u=e.localTileOffset.getPatternOffsetAtTileOrigin(r).divide(n),p=new M(t.pos,1);return{tileTextureCoord:l.multiply(p).xy.subtract(u),tlbr:t.tlbr.divide(e.mosaicInfo.size.xyxy)}}function ks(e,t){const i=b(e.tileTextureCoord,new c(1)),s=E(e.tlbr.xy,e.tlbr.zw,i),o=f(t.texture,s);return e.color.multiply(o)}l([T(5,z)],Ls.prototype,"tlbr",void 0),l([T(6,c)],Ls.prototype,"inverseRasterizationScale",void 0);class Bs extends Yi{constructor(){super(...arguments),this.type="PatternFillShader"}vertex(e,t){return{...super.vertex(e,t),...Es(this,e)}}fragment(e){const t=ks(e,this.mosaicInfo);return this.getFragmentOutput(t,e,new c(0))}}l([p(Si)],Bs.prototype,"mosaicInfo",void 0),l([p(wi)],Bs.prototype,"localTileOffset",void 0),l([u(0,ae(Ls)),u(1,ae(gi))],Bs.prototype,"vertex",null),l([u(0,ae(class extends bi{}))],Bs.prototype,"fragment",null);class Us extends Rs{}l([T(9,z)],Us.prototype,"tlbr",void 0),l([T(10,c)],Us.prototype,"inverseRasterizationScale",void 0);class Ns extends Os{}class Hs extends Fs{constructor(){super(...arguments),this.type="PatternOutlineFillShader"}vertex(e,t){return{...Ds(this,e,t),...Es(this,e)}}fragment(e){const{isOutline:t}=e,i=A(t,new c(.5)),s=ps(e,this.antialiasingControls.blur),o=ks(e,this.mosaicInfo),a=P(i,s,o),r=P(i,new c(1/255),new c(0));return this.getFragmentOutput(a,e,r)}}l([p(Si)],Hs.prototype,"mosaicInfo",void 0),l([p(wi)],Hs.prototype,"localTileOffset",void 0),l([u(0,ae(Us)),u(1,ae(gi))],Hs.prototype,"vertex",null),l([u(0,ae(Ns))],Hs.prototype,"fragment",null);const js=1/rt;class qs extends vi{}l([T(3,z)],qs.prototype,"color",void 0),l([T(4,z)],qs.prototype,"tlbr",void 0),l([T(5,c)],qs.prototype,"angle",void 0),l([T(6,c)],qs.prototype,"aux1",void 0),l([T(7,c)],qs.prototype,"aux2",void 0),l([T(8,d)],qs.prototype,"aux3",void 0),l([T(9,d)],qs.prototype,"aux4",void 0),l([T(10,d)],qs.prototype,"zoomRange",void 0);class Ws extends Is{constructor(){super(...arguments),this.type="ComplexOutlineFillShader"}vertex(e,t){const{aux1:i,aux2:s,aux3:o,aux4:a}=e,r={...e,width:i,height:s,offset:o,scale:a.multiply(js)},n=Ds(this,{...e,halfWidth:i,referenceHalfWidth:s,offset:o,normal:a.subtract(at).multiply(js)}),l=es(this,r),u=A(n.isOutline,new c(.5));return{...n,...l,...this.maybeRunHittest(e,t,u)}}fragment(e){const{isOutline:t}=e,i=A(t,new c(.5)),s=ps(e,this.antialiasingControls.blur),o=ts(this,e),a=P(i,s,o),r=P(i,new c(1/255),new c(0));return this.getFragmentOutput(a,e,r)}hittest(e,t,i){return P(i,Zi(this.hittestRequest),$i(this,e,t))}}l([p(Si)],Ws.prototype,"mosaicInfo",void 0),l([p(wi)],Ws.prototype,"localTileOffset",void 0),l([u(0,ae(qs)),u(1,ae(gi))],Ws.prototype,"vertex",null),l([u(0,ae(class extends Ns{}))],Ws.prototype,"fragment",null);class Gs extends Xi{}l([T(5,z)],Gs.prototype,"tlbr",void 0),l([T(6,d)],Gs.prototype,"relativePosition",void 0),l([T(7,c)],Gs.prototype,"gradientMethod",void 0),l([T(8,d)],Gs.prototype,"relativeGradientSize",void 0);class Ks extends Yi{constructor(){super(...arguments),this.type="GradientFillShader"}vertex(e,t){const{tlbr:i,relativePosition:s,gradientMethod:o,relativeGradientSize:a}=e,r=P(Ne(e.bitset,ze.isAbsolute),this.view.displayZoomFactor,new c(1));return{...super.vertex(e,t),tlbr:i,relativePosition:s,gradientMethod:o,gradientSize:a.multiply(r),isDiscrete:Ee(e.bitset,ze.isDiscrete)}}fragment(e){const{tlbr:t,relativePosition:i,gradientMethod:s,gradientSize:o,isDiscrete:a}=e,r=P(A(a,new c(.5)),o.subtract(1),new d(0)),n=L([q(s,new c(Ve.rectangular)),()=>{const e=X(i).add(r).divide(o);return We(le(e.x,e.y))}],[q(s,new c(Ve.circular)),We(ce(ie(i,i)).add(r.x).divide(o.x))],[!0,We(i.x.add(r.x).divide(o.x))]),l=new d(W(n,new c(0),new c(1)),.5),u=E(t.xy,t.zw,l).divide(this.mosaicInfo.size),p=f(this.mosaicInfo.texture,u),m=e.color.a;return this.getFragmentOutput(p.multiply(m),e,new c(0))}}l([p(Si)],Ks.prototype,"mosaicInfo",void 0),l([u(0,ae(Gs)),u(1,ae(gi))],Ks.prototype,"vertex",null),l([u(0,ae(class extends bi{}))],Ks.prototype,"fragment",null);class Zs{destroy(){this._accumulateFramebuffer=qt(this._accumulateFramebuffer),this._resolveGradientTexture=qt(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return null!=this._accumulateFramebuffer&&null!=this._resolveGradientTexture}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(null==this._qualityProfile){const t=Wt(e,Ht.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"));this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==Ct.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(null==this._accumulateFramebuffer){const{dataType:s,samplingMode:o,pixelFormat:a,internalFormat:r}=this.loadQualityProfile(e),n=new Bt(t,i);n.pixelFormat=a,n.internalFormat=r,n.dataType=s,n.samplingMode=o,n.wrapMode=Mt.CLAMP_TO_EDGE;const l=new Et(_t.DEPTH24_STENCIL8,t,i);this._accumulateFramebuffer=new kt(e,n,l)}else{const{width:e,height:s}=this._accumulateFramebuffer;e===t&&s===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(null==this._resolveGradientTexture){const t=new Bt;t.wrapMode=Mt.CLAMP_TO_EDGE,this._resolveGradientTexture=new Ut(e,t),this._prevGradientHash=null}return this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t),this._resolveGradientTexture}}function $s(e){return e?.25:1}class Xs extends vi{}l([T(5,d)],Xs.prototype,"offset",void 0);class Ys extends y{}l([p(c)],Ys.prototype,"radius",void 0),l([p(c)],Ys.prototype,"isFieldActive",void 0);class Qs extends xi{constructor(){super(...arguments),this.type="HeatmapAccumulateShader",this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,s=e.offset,o=i.multiply(this.storage.getVVData(e.id).x).add(new c(1).subtract(i)),a=this.view.displayViewScreenMat3.multiply(new M(e.pos,1)).add(this.view.displayViewMat3.multiply(new M(s,0)).multiply(t)),r=this.clip(e.id);return{glPosition:new z(a.xy,r,1),offset:s,fieldValue:o,color:new z(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,s=Y(t),o=S(s,new c(1)),a=new c(1).subtract(s.multiply(s)),r=a.multiply(a),n=o.multiply(r).multiply(i).multiply(new c($s(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new z(n),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view;return s=t.multiply(i).multiply(new M(e.pos,1)).xy,o=this.kernelControls.radius,a=this.hittestRequest.position,Q(s,a).subtract(o);var s,o,a}}l([_],Qs.prototype,"usesHalfFloatPrecision",void 0),l([p(Ys)],Qs.prototype,"kernelControls",void 0),l([u(0,ae(Xs))],Qs.prototype,"vertex",null),l([u(0,ae(class extends bi{}))],Qs.prototype,"fragment",null);class Js extends R{}l([T(0,d)],Js.prototype,"position",void 0);class eo extends y{}l([p(m)],eo.prototype,"texture",void 0),l([p(d)],eo.prototype,"minAndInvRange",void 0),l([p(c)],eo.prototype,"normalization",void 0);class to extends y{}l([p(m)],to.prototype,"texture",void 0);class io extends w{constructor(){super(...arguments),this.type="HeatmapResolveShader",this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new z(e.position.multiply(2).subtract(1),1,1),uv:e.position}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let s=f(t.texture,e.uv).r.divide(new c($s(this.usesHalfFloatPrecision)));s=s.multiply(t.normalization),s=s.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const o=f(i.texture,new d(s,.5)),a=new V;return a.fragColor=new z(o.rgb.multiply(o.a),o.a),a}}function so(e){return e.key.level+1}l([_],io.prototype,"usesHalfFloatPrecision",void 0),l([p(eo)],io.prototype,"accumulatedDensity",void 0),l([p(to)],io.prototype,"gradient",void 0),l([u(0,ae(Js))],io.prototype,"vertex",null),l([u(0,ae(class extends D{}))],io.prototype,"fragment",null);const oo={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:so,compare:Dt.GEQUAL,mask:255,op:{fail:Ot.KEEP,zFail:Ot.KEEP,zPass:Ot.REPLACE}}}},ao={...oo,stencil:!1},ro={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function no(e,t){const{referenceScale:i,radius:s}=e.uniforms;return s*(0!==i?i/t.scale:1)}const lo=360/254;var uo;!function(e){e[e.Color=0]="Color",e[e.Outline=1]="Outline",e[e.Halo=2]="Halo"}(uo||(uo={}));class po extends vi{}l([T(3,z)],po.prototype,"color",void 0),l([T(4,d)],po.prototype,"offset",void 0),l([T(5,d)],po.prototype,"textureUV",void 0),l([T(6,d)],po.prototype,"fontAndReferenceSize",void 0),l([T(7,z)],po.prototype,"outlineColor",void 0),l([T(8,z)],po.prototype,"haloColor",void 0),l([T(9,d)],po.prototype,"outlineAndHaloSize",void 0),l([T(10,d)],po.prototype,"zoomRange",void 0),l([T(11,c)],po.prototype,"clipAngle",void 0),l([T(12,z)],po.prototype,"referenceSymbol",void 0),l([T(15,c)],po.prototype,"visibility",void 0);class co extends O{}l([T(13,d)],co.prototype,"offsetNextVertex1",void 0),l([T(14,d)],co.prototype,"offsetNextVertex2",void 0);class mo extends xi{constructor(){super(...arguments),this.type="TextShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=uo.Color,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t){const{clipAngle:i,zoomRange:s,visibility:o}=e,a=i.multiply(lo),r=X(this.view.rotation.subtract(a)),n=oe(new c(360).subtract(r),r);let l=new c(0);const u=de(this.view.currentZoom.multiply(Re)).divide(Re),p=s.x,d=s.y,m=new c(1).subtract(S(p,u)).multiply(2),h=S(new c(90),n).multiply(2),y=new c(2).multiply(new c(1).subtract(S(u,d)));return l=l.add(t.multiply(m)),l=l.add(t.multiply(h)),l=l.add(y),o&&(l=l.add(o)),l}vertex(e,t){const i=Ee(e.bitset,ut),s=new c(1).subtract(i);let o=e.fontAndReferenceSize[0];const a=e.fontAndReferenceSize[1];let r=o.divide(nt);const n=this.textRenderPassType===uo.Outline?e.outlineColor:this.textRenderPassType===uo.Halo?e.haloColor:this._getVertexColor(e),l=this.view.displayViewScreenMat3.multiply(new M(e.pos,1));let u=e.offset,p=new c(1),m=h.identity(),y=new d(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const t=e.referenceSymbol,i=t.xy,s=t.z,o=this._unpackDirection(t.w),a=Ri(this,e.id,s).divide(2),r=o.multiply(a.add(Oe));y=i.add(r),u=u.add(y)}else p=Ri(this,e.id,a).divide(a),o=o.multiply(p),r=r.multiply(p),u=u.multiply(p),m=Ii(this,e.id),u=m.multiply(new M(u,0)).xy;const f=Ee(e.bitset,pt),v=this._getViewRotationMatrix(f).multiply(new M(u,0));let g=this.isLabel?this.clipLabel(e,f):this.clip(e.id,e.zoomRange);g=this.isBackgroundPass?g.add(s.multiply(2)):g.add(i.multiply(2));let b=new c(0);if(this.textRenderPassType===uo.Outline&&(g=g.add(P(q(e.outlineAndHaloSize.x,new c(0)),new c(2),new c(0))),b=new c(e.outlineAndHaloSize.x).divide(r).divide(lt)),this.textRenderPassType===uo.Halo){const t=e.outlineAndHaloSize.x,i=new c(e.outlineAndHaloSize.y);g=g.add(P(q(i,new c(0)),new c(2),new c(0))),b=i.add(t).divide(r).divide(lt)}const x=this.isLabel?A(g,new c(1)):new G(!1);return{glPosition:new z(l.xy.add(v.xy),g,1),color:n,size:r,textureUV:e.textureUV.divide(this.mosaicInfo.size),antialiasingWidth:new c(.105*nt).divide(o).divide(this.view.pixelRatio),outlineDistanceOffset:b,...this.maybeRunHittest(e,t,{vvSizeAdjustment:p,vvRotation:m,labelOffset:y,labelClipped:x})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new c(1).subtract(e);return t.multiply(e).add(i.multiply(s))}fragment(e){const t=new c(2/8),i=new c(1).subtract(t),s=f(this.mosaicInfo.texture,e.textureUV).a;let o=i.subtract(e.outlineDistanceOffset);this.highlight&&(o=o.divide(2));const a=e.antialiasingWidth,r=pe(o.subtract(a),o.add(a),s);return this.getFragmentOutput(e.color.multiply(r),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:s,labelOffset:o,labelClipped:a}){let r,n,l;this.isLabel?(r=new M(e.offset.add(o),0),n=new M(t.offsetNextVertex1.add(o),0),l=new M(t.offsetNextVertex2.add(o),0)):(r=s.multiply(new M(e.offset.multiply(i),0)),n=s.multiply(new M(t.offsetNextVertex1.multiply(i),0)),l=s.multiply(new M(t.offsetNextVertex2.multiply(i),0)));const{viewMat3:u,tileMat3:p}=this.view,c=u.multiply(p).multiply(new M(e.pos,1)),d=c.add(p.multiply(r)).xy,m=c.add(p.multiply(n)).xy,h=c.add(p.multiply(l)).xy,y=Ki(this.hittestRequest.position,d.xy,m.xy,h.xy);return this.isLabel?P(a,Zi(this.hittestRequest),y):y}_unpackDirection(e){const t=new me(e),i=he(t,new me(2)),s=ye(t,new me(3));return new d(new c(i).subtract(1),new c(s).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new G(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),s=this.visualVariableOpacity.getOpacity(i);t=t.multiply(s)}return t}}l([C(Vi)],mo.prototype,"visualVariableColor",void 0),l([C(zi)],mo.prototype,"visualVariableOpacity",void 0),l([C(Pi)],mo.prototype,"visualVariableRotation",void 0),l([C(Ai)],mo.prototype,"visualVariableSizeMinMaxValue",void 0),l([C(Ti)],mo.prototype,"visualVariableSizeScaleStops",void 0),l([C(Mi)],mo.prototype,"visualVariableSizeStops",void 0),l([C(_i)],mo.prototype,"visualVariableSizeUnitValue",void 0),l([p(Si)],mo.prototype,"mosaicInfo",void 0),l([_],mo.prototype,"textRenderPassType",void 0),l([_],mo.prototype,"isBackgroundPass",void 0),l([_],mo.prototype,"isLabel",void 0),l([u(0,ae(po)),u(1,ae(co))],mo.prototype,"vertex",null),l([u(0,ae(class extends bi{}))],mo.prototype,"fragment",null);class ho extends os{}l([T(9,c)],ho.prototype,"accumulatedDistance",void 0),l([T(10,c)],ho.prototype,"totalLength",void 0),l([T(11,c)],ho.prototype,"gradientSize",void 0),l([T(12,d)],ho.prototype,"segmentDirection",void 0),l([T(13,z)],ho.prototype,"tlbr",void 0);class yo extends y{}l([p(c)],yo.prototype,"isColorPass",void 0);class fo extends cs{constructor(){super(...arguments),this.type="GradientStrokeShader"}vertex(e,t){const{totalLength:i,gradientSize:s,segmentDirection:o,tlbr:a}=e,r=us(this,e),n=Ee(e.bitset,Pe.isAlongLine),l=i.divide(this.view.displayZoomFactor),u=P(Ne(e.bitset,Pe.isAbsoluteSize),(()=>{const e=P(A(n,new c(.5)),l,r.halfWidth);return s.divide(e)}),s),p=e.accumulatedDistance.add(ie(o,r.scaledOffset).divide(l)),d=a.divide(this.mosaicInfo.size.xyxy);return{...r,tlbr:d,relativePositionAlongLine:p,relativeGradientSize:u,isAlongLine:Ee(e.bitset,Pe.isAlongLine),isDiscrete:Ee(e.bitset,Pe.isDiscrete),...this.maybeRunHittest(e,t,r.halfWidth)}}fragment(e){const{isAlongLine:t,isDiscrete:i,relativePositionAlongLine:s,relativeGradientSize:o,normal:a,tlbr:r}=e,n=ls(e,this.antialiasingControls.blur),l=(u=a.y,S(new c(0),u).multiply(2).subtract(1)).multiply(oe(Y(a),new c(1)));var u;const p=new c(.5).multiply(l).add(new c(.5)),m=P(A(t,new c(.5)),s,p),h=P(A(i,new c(.5)),o.subtract(1),new c(0)),y=We(m.add(h).divide(o)),v=E(r.xy,r.zw,new d(W(y,new c(0),new c(1)),.5)),g=f(this.mosaicInfo.texture,v),b=e.opacity.multiply(n),x=this.getFragmentOutput(g.multiply(b),e),w=S(new c(.5),this.technique.isColorPass).multiply(ge("gradient-depth-epsilon")),V=S(new c(0),a.y).multiply(new c(ge("gradient-depth-bias")).subtract(w));return x.glFragDepth=W(Y(a).add(V),new c(0),new c(1)),x}}l([p(Si)],fo.prototype,"mosaicInfo",void 0),l([p(yo)],fo.prototype,"technique",void 0),l([u(0,ae(ho)),u(1,ae(gi))],fo.prototype,"vertex",null);class vo extends os{}l([T(9,c)],vo.prototype,"accumulatedDistance",void 0),l([T(10,d)],vo.prototype,"segmentDirection",void 0),l([T(11,c)],vo.prototype,"offsetAlongLine",void 0),l([T(12,c)],vo.prototype,"capType",void 0),l([T(13,z)],vo.prototype,"tlbr",void 0);class go extends cs{constructor(){super(...arguments),this.type="TexturedLineShader"}_getDistanceRatio(e,t){const i=Ee(e.bitset,ct);return i.multiply(le(t,new c(.25)).multiply(new c(2))).add(new c(1).subtract(i).multiply(Gt(1)))}_getSDFAlpha(e){const{halfWidth:t,normal:i,tlbr:s,patternSize:o,accumulatedDistance:a,offsetAlongLine:r,dashToPx:n,capType:l}=e,u=o.x.divide(Zt).multiply(n),p=I(a.add(r).divide(u)),m=E(s.xy,s.zw,new d(p,.5)),h=Ue(f(this.mosaicInfo.texture,m)).multiply(2).subtract(1).multiply($t).multiply(n),y=i.y.multiply(t),v=L([q(l,new c(1)),h.subtract(t)],[q(l,new c(2)),ce(fe(le(h,new c(0)),new c(2)).add(y.multiply(y))).subtract(t)],[!0,h]),g=W(new c(.25).subtract(v),new c(0),new c(1));return new z(g)}_getPatternColor(e){const{halfWidth:t,normal:i,color:s,accumulatedDistance:o,patternSize:a,sampleAlphaOnly:r,tlbr:n}=e,l=a.y.multiply(new c(2).multiply(t).divide(a.x)),u=I(o.divide(l)),p=new c(.5).multiply(i.y).add(new c(.5)),m=E(n.xy,n.zw,new d(p,u));let h=f(this.mosaicInfo.texture,m);return null!=this.visualVariableColor&&(h=P(A(r,new c(.5)),new z(s.a),s)),h}vertex(e,t){const{segmentDirection:i,tlbr:s,bitset:o}=e,a=us(this,e),r=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(ie(i,a.scaledOffset)),n=new d(s.z.subtract(s.x),s.w.subtract(s.y)),l=s.divide(this.mosaicInfo.size.xyxy),u=Ee(o,dt),p=Ee(o,Qe),m=P(A(u,new c(.5)),this._getDistanceRatio(e,a.scaledHalfWidth),new c(1));return{...a,tlbr:l,patternSize:n,accumulatedDistance:r,isSDF:u,sampleAlphaOnly:p,dashToPx:m,offsetAlongLine:e.offsetAlongLine,capType:e.capType,...this.maybeRunHittest(e,t,a.halfWidth)}}fragment(e){const{color:t,opacity:i,isSDF:s}=e,o=ls(e,this.antialiasingControls.blur),a=P(A(s,new c(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),r=t.multiply(i).multiply(o).multiply(a);return this.getFragmentOutput(r,e)}}l([p(Si)],go.prototype,"mosaicInfo",void 0),l([u(0,ae(vo)),u(1,ae(gi))],go.prototype,"vertex",null);class bo extends vi{}l([T(3,z)],bo.prototype,"color",void 0),l([T(4,z)],bo.prototype,"outlineColor",void 0),l([T(5,d)],bo.prototype,"offset",void 0),l([T(6,d)],bo.prototype,"textureUV",void 0),l([T(7,z)],bo.prototype,"sizing",void 0),l([T(8,c)],bo.prototype,"placementAngle",void 0),l([T(9,c)],bo.prototype,"sdfDecodeCoeff",void 0),l([T(10,d)],bo.prototype,"zoomRange",void 0);class xo extends O{}function wo(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}function So(e){return e.multiply(e).divide(128)}l([T(11,d)],xo.prototype,"offsetNextVertex1",void 0),l([T(12,d)],xo.prototype,"offsetNextVertex2",void 0),l([T(13,d)],xo.prototype,"textureUVNextVertex1",void 0),l([T(14,d)],xo.prototype,"textureUVNextVertex2",void 0);class Vo extends xi{constructor(){super(...arguments),this.type="MarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=So(e.sizing.x),s=So(e.sizing.y),o=So(e.sizing.z),a=e.placementAngle,r=Ee(e.bitset,Se.bitset.isSDF),n=Ee(e.bitset,Se.bitset.isMapAligned),l=Ee(e.bitset,Se.bitset.scaleSymbolsProportionally),u=Ne(e.bitset,Se.bitset.colorLocked),p=Di(this,e.id),d=Oi(this,e.id,e.color,u).multiply(p),m=this.view.displayViewScreenMat3.multiply(new M(e.pos.xy,1)),y=Ri(this,e.id,o).divide(o),f=i.multiply(y),v=e.offset.xy.multiply(y);let g=s.multiply(l.multiply(y.subtract(1)).add(1));g=oe(g,le(f.subtract(.99),new c(0)));const b=le(g,new c(1)),x=oe(g,new c(1)),w=h.fromRotation(a.multiply($e)),S=Ii(this,e.id),V=this._getViewRotationMatrix(n).multiply(S).multiply(w).multiply(new M(v.xy,0)),P=this.clip(e.id,e.zoomRange),A=new z(m.xy.add(V.xy),P,1),T=e.textureUV.divide(this.mosaicInfo.size),_=e.outlineColor.multiply(x),C=Ee(e.bitset,Se.bitset.overrideOutlineColor),R=e.sdfDecodeCoeff.multiply(f);return{glPosition:A,color:d,textureUV:T,outlineColor:_,outlineSize:b,distanceToPx:R,isSDF:r,overrideOutlineColor:C,...this.maybeRunHittest(e,t,{pos:e.pos,size:f,sizeCorrection:y,isMapAligned:n,vvRotationMat3:S,placementMat3:w,outlineSize:b,distanceToPx:R,isSDF:r})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return P(ee(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new c(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,s=new c(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getColor(e,t){return P(q(t.isSDF,new c(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return f(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=f(this.mosaicInfo.texture,e),s=new c(.5).subtract(Ue(i)).multiply(t.distanceToPx).multiply(Xe),o=W(new c(.5).subtract(s),new c(0),new c(1)),a=t.color.multiply(o);let r=t.outlineSize;this.highlight&&(r=le(r,t.overrideOutlineColor.multiply(4)));const n=r.multiply(.5),l=X(s).subtract(n),u=W(new c(.5).subtract(l),new c(0),new c(1)),p=E(t.outlineColor,t.color,t.overrideOutlineColor).multiply(u);return new c(1).subtract(p.a).multiply(a).add(p)}_hittestSmallMarker(e,t,i){const{position:s,distance:o,smallSymbolDistance:a}=this.hittestRequest,r=o.subtract(a),{viewMat3:n,tileMat3:l}=this.view,u=n.multiply(l).multiply(new M(i.pos,1)).xy,p=i.size.multiply(.5);return Q(u,s).subtract(p).add(r)}_hittestMarker(e,t,i){const{pos:s,sizeCorrection:o,isMapAligned:a}=i,r=new M(e.offset.multiply(o),0),n=new M(t.offsetNextVertex1.multiply(o),0),l=new M(t.offsetNextVertex2.multiply(o),0),{viewMat3:u,tileMat3:p}=this.view,c=u.multiply(p).multiply(new M(s,1)),d=this._getViewScreenMatrix(a).multiply(i.vvRotationMat3).multiply(i.placementMat3),m=c.add(d.multiply(r)).xy,h=c.add(d.multiply(n)).xy,y=c.add(d.multiply(l)).xy,f=this.hittestRequest.position,v=this.hittestRequest.distance,g=Ki(f,m,h,y);return P(A(g,v),g,this._hittestSamples(m,h,y,e,t,i))}_hittestSamples(e,t,i,s,o,a){const{outlineSize:r,isSDF:n,distanceToPx:l}=a,u=this.hittestRequest.position,p=this.hittestRequest.distance,m=Wi(u.add(new d(Z(p),Z(p))),e,t,i),h=Wi(u.add(new d(0,Z(p))),e,t,i),y=Wi(u.add(new d(p,Z(p))),e,t,i),f=Wi(u.add(new d(Z(p),0)),e,t,i),v=Wi(u,e,t,i),g=Wi(u.add(new d(p,0)),e,t,i),b=Wi(u.add(new d(Z(p),p)),e,t,i),x=Wi(u.add(new d(0,p)),e,t,i),w=Wi(u.add(new d(p,p)),e,t,i),V=s.textureUV.divide(this.mosaicInfo.size),P=o.textureUVNextVertex1.divide(this.mosaicInfo.size),A=o.textureUVNextVertex2.divide(this.mosaicInfo.size),T={color:new z(1),outlineColor:new z(1),overrideOutlineColor:new c(1),outlineSize:r,distanceToPx:l,isSDF:n};let M=new c(0);return M=M.add(qi(m).multiply(this._getColor(wo(m,V,P,A),T).a)),M=M.add(qi(h).multiply(this._getColor(wo(h,V,P,A),T).a)),M=M.add(qi(y).multiply(this._getColor(wo(y,V,P,A),T).a)),M=M.add(qi(f).multiply(this._getColor(wo(f,V,P,A),T).a)),M=M.add(qi(v).multiply(this._getColor(wo(v,V,P,A),T).a)),M=M.add(qi(g).multiply(this._getColor(wo(g,V,P,A),T).a)),M=M.add(qi(b).multiply(this._getColor(wo(b,V,P,A),T).a)),M=M.add(qi(x).multiply(this._getColor(wo(x,V,P,A),T).a)),M=M.add(qi(w).multiply(this._getColor(wo(w,V,P,A),T).a)),S(M,new c(.05)).multiply(Zi(this.hittestRequest))}}l([C(Vi)],Vo.prototype,"visualVariableColor",void 0),l([C(zi)],Vo.prototype,"visualVariableOpacity",void 0),l([C(Pi)],Vo.prototype,"visualVariableRotation",void 0),l([C(Ai)],Vo.prototype,"visualVariableSizeMinMaxValue",void 0),l([C(Ti)],Vo.prototype,"visualVariableSizeScaleStops",void 0),l([C(Mi)],Vo.prototype,"visualVariableSizeStops",void 0),l([C(_i)],Vo.prototype,"visualVariableSizeUnitValue",void 0),l([p(Si)],Vo.prototype,"mosaicInfo",void 0),l([u(0,ae(bo)),u(1,ae(xo))],Vo.prototype,"vertex",null),l([u(0,ae(class extends bi{}))],Vo.prototype,"fragment",null);class zo{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map((([e,t])=>`${e}.${t}`)).join("."),i=jt(t);this._locationInfo={hash:i,stringHash:t,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map((t=>`${t}.${e[t]}`)).join(".")}.${Object.keys(i).filter((e=>i[e])).map((e=>`${e}_${i[e].toString()}`)).join(".")}.${Object.keys(t).filter((e=>this.optionPropertyKeys.has(e))).join(".")}`}getProgram(e,t,i,s){let o="",a="";for(const e in i)if(i[e]){const t="boolean"==typeof i[e]?`#define ${e}\n`:`#define ${e} ${i[e]}\n`;o+=t,a+=t}return o+=this.vertexShader,a+=this.fragmentShader,new ve(o,a,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const e in this.required){const i=this.required[e];t.push({uniformHydrated:null,shaderModulePath:e,uniformName:e,uniformType:i.type,uniformArrayElementType:Po(i),uniformArrayLength:Ao(i)})}for(const i in e){const s=this.options[i];if(e[i])for(const e in s){const o=s[e];t.push({uniformHydrated:null,shaderModulePath:`${i}.${e}`,uniformName:e,uniformType:o.type,uniformArrayElementType:Po(o),uniformArrayLength:Ao(o)})}}return t}}const Po=e=>"array"===e.type?e.elementType?.type:void 0,Ao=e=>"array"===e.type?e.size:void 0,To={hittestDist:c,hittestPos:d},Mo={filterFlags:m,animation:m,visualVariableData:m,dataDriven0:m,dataDriven1:m,dataDriven2:m,gpgpu:m,size:c},_o={displayViewScreenMat3:h,displayViewMat3:h,displayMat3:h,viewMat3:h,tileMat3:h,displayZoomFactor:c,requiredZoomFactor:c,tileOffset:d,currentScale:c,currentZoom:c,metersPerSRUnit:c};class Co extends zo{constructor(){super(...arguments),this.vertexShader=Xt("materials/pie/pie.vert"),this.fragmentShader=Xt("materials/pie/pie.frag"),this.required={...Mo,..._o,outlineWidth:c,colors:F,defaultColor:z,othersColor:z,outlineColor:z,donutRatio:c,sectorThreshold:c},this.options={hittestUniforms:To,visualVariableSizeMinMaxValue:{minMaxValueAndSize:z},visualVariableSizeScaleStops:{sizes:{...F.ofType(c,8),type:"array",elementType:c,size:8},values:{...F.ofType(c,8),type:"array",elementType:c,size:8}},visualVariableSizeStops:{sizes:{...F.ofType(c,8),type:"array",elementType:c,size:8},values:{...F.ofType(c,8),type:"array",elementType:c,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:c},visualVariableOpacity:{opacities:{...F.ofType(c,8),type:"array",elementType:c,size:8},opacityValues:{...F.ofType(c,8),type:"array",elementType:c,size:8}},highlightUniforms:{highlightAll:c,activeReasons:c}},this.locations={pos:{index:0,type:d},id:{index:1,type:M},bitset:{index:2,type:c},offset:{index:3,type:d},texCoords:{index:4,type:d},size:{index:5,type:d},referenceSize:{index:6,type:c},zoomRange:{index:7,type:d}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...F.ofType(z,e),type:"array",elementType:z,size:e}}}const Ro={fill:new class extends gs{constructor(){super(...arguments),this.type=n.Fill,this.shaders={geometry:new Yi}}render(e,t){const{painter:i}=e,s=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,s.uniforms),...gt(e,t.target)},defines:ft(e),optionalAttributes:s.optionalAttributes,useComputeBuffer:St(e)}),i.setPipelineState(xt(e)),i.submitDraw(e,t)}},patternFill:new class extends gs{constructor(){super(...arguments),this.type=n.PatternFill,this.shaders={geometry:new Bs}}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,o.uniforms),...gt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)},defines:{...ft(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:St(e)}),s.setPipelineState(xt(e)),s.submitDraw(e,t)}},complexFill:new class extends gs{constructor(){super(...arguments),this.type=n.ComplexFill,this.shaders={geometry:new is}}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,o.uniforms),...gt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)},defines:{...ft(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:St(e)}),s.setPipelineState(xt(e)),s.submitDraw(e,t)}},gradientFill:new class extends gs{constructor(){super(...arguments),this.type=n.GradientFill,this.shaders={geometry:new Ks},this.symbologyPlane=o.FILL}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,o.uniforms),...gt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...ft(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:St(e)}),s.setPipelineState(xt(e)),s.submitDraw(e,t)}},outlineFill:new class extends gs{constructor(){super(...arguments),this.type=n.OutlineFill,this.shaders={geometry:new Fs}}render(e,t){const{painter:i,pixelRatio:s}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,o.uniforms),...gt(e,t.target),antialiasingControls:Cs(s)},defines:{...ft(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:St(e)}),i.setPipelineState(xt(e)),i.submitDraw(e,t)}},patternOutlineFill:new class extends gs{constructor(){super(...arguments),this.type=n.PatternOutlineFill,this.shaders={geometry:new Hs}}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,a.uniforms),...gt(e,t.target),antialiasingControls:Cs(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)},defines:{...ft(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:St(e)}),s.setPipelineState(xt(e)),s.submitDraw(e,t)}},complexOutlineFill:new class extends gs{constructor(){super(...arguments),this.type=n.ComplexOutlineFill,this.shaders={geometry:new Ws}}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,a.uniforms),...gt(e,t.target),antialiasingControls:Cs(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)},defines:{...ft(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:St(e)}),s.setPipelineState(xt(e)),s.submitDraw(e,t)}},marker:new class extends gs{constructor(){super(...arguments),this.type=n.Marker,this.shaders={geometry:new Vo},this.symbologyPlane=o.MARKER}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,o.uniforms),...gt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...ft(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:St(e)}),s.setPipelineState(xt(e)),s.submitDraw(e,t)}},pieChart:new class extends gs{constructor(){super(...arguments),this.type=n.PieChart,this.shaders={geometry:new Co},this.symbologyPlane=o.MARKER}render(e,t){const{painter:i}=e,{instance:s,target:o}=t,a=this.shaders.geometry,r=s.getInput(),n=r.uniforms.numberOfFields,l=St(e),u=gt(e,o),p=ft(e);a.setNumberOfFields(n),i.setShader({shader:a,uniforms:{...bt(e,t.target,r.uniforms.shader),...u.storage,...u.view,...u.highlight,highlightUniforms:u.highlight,hittestUniforms:u.hittestRequest?{hittestDist:u.hittestRequest?.distance,hittestPos:u.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!r.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!r.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!r.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!r.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!r.uniforms.shader.visualVariableOpacity,HITTEST:l,highlight:u.highlight?1:0,...p,numberOfFields:n},optionalAttributes:{},useComputeBuffer:l}),i.setPipelineState(xt(e)),i.submitDraw(e,t)}},line:new class extends gs{constructor(){super(...arguments),this.type=n.Line,this.shaders={geometry:new cs},this.symbologyPlane=o.LINE}render(e,t){const{painter:i,pixelRatio:s}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,o.uniforms),...gt(e,t.target),antialiasingControls:Cs(s)},defines:{...ft(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:St(e)}),i.setPipelineState(xt(e)),i.submitDraw(e,t)}},texturedLine:new class extends gs{constructor(){super(...arguments),this.type=n.TexturedLine,this.shaders={geometry:new go},this.symbologyPlane=o.LINE}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...bt(e,t.target,a.uniforms),...gt(e,t.target),antialiasingControls:Cs(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...ft(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:St(e)}),s.setPipelineState(xt(e)),s.submitDraw(e,t)}},gradientStroke:new class extends gs{constructor(){super(...arguments),this.type=n.GradientStroke,this.shaders={geometry:new fo},this.symbologyPlane=o.LINE}_getShaderOptions(e,t,i){const{context:s,painter:o,pixelRatio:a}=e,r=t.instance.getInput();return{shader:this.shaders.geometry,uniforms:{...bt(e,t.target,r.uniforms),...gt(e,t.target),antialiasingControls:Cs(a),mosaicInfo:o.textureManager.getMosaicInfo(s,t.textureKey),technique:{isColorPass:i}},defines:{...ft(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:St(e)}}render(e,t){const{painter:i}=e;if(St(e)||wt(e)){const s=xt(e);return i.setPipelineState(s),i.setShader(this._getShaderOptions(e,t,1)),void i.submitDraw(e,t)}e.context.setClearDepth(1),e.context.clear(Rt.DEPTH);const s={color:!1,depth:{write:{zNear:0,zFar:1},test:Dt.LESS},stencil:{write:!1,test:{ref:e=>e.stencilRef,compare:Dt.EQUAL,mask:255,op:{fail:Ot.KEEP,zFail:Ot.KEEP,zPass:Ot.KEEP}}}};i.setShader(this._getShaderOptions(e,t,0)),i.setPipelineState(s),i.submitDraw(e,t);const o={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:{write:!1,test:Dt.LEQUAL},stencil:{write:!1,test:{ref:e=>e.stencilRef,compare:Dt.EQUAL,mask:255,op:{fail:Ot.KEEP,zFail:Ot.KEEP,zPass:Ot.KEEP}}}};i.setShader(this._getShaderOptions(e,t,1)),i.setPipelineState(o),i.submitDraw(e,t)}},text:new class extends gs{constructor(){super(...arguments),this.type=n.Text,this.shaders={geometry:new mo},this.symbologyPlane=o.TEXT}render(e,t){const{context:i,painter:s}=e,o=ft(e),a=t.instance.getInput(),r={shader:this.shaders.geometry,uniforms:{...bt(e,t.target,a.uniforms),...gt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...o,isBackgroundPass:!0,isLabel:!1,textRenderPassType:uo.Color},optionalAttributes:a.optionalAttributes,useComputeBuffer:St(e)};s.setShader(r),s.setPipelineState(xt(e)),s.submitDraw(e,t),s.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:uo.Halo}}),s.submitDraw(e,t),s.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:uo.Outline}}),s.submitDraw(e,t),s.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:uo.Color}}),s.submitDraw(e,t)}},label:new class extends gs{constructor(){super(...arguments),this.type=n.Label,this.shaders={geometry:new mo},this.drawPhase=a.LABEL|a.LABEL_ALPHA|a.HITTEST,this.symbologyPlane=o.TEXT}render(e,t){const{context:i,painter:s}=e,o=ft(e),a={...xt(e),stencil:{write:!1,test:{ref:()=>255,compare:Dt.GREATER,mask:255,op:{fail:Ot.KEEP,zFail:Ot.KEEP,zPass:Ot.KEEP}}}},r=t.instance.getInput(),n={shader:this.shaders.geometry,uniforms:{...bt(e,t.target,r.uniforms),...gt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...o,textRenderPassType:uo.Color,isBackgroundPass:!0,isLabel:!0},optionalAttributes:r.optionalAttributes,useComputeBuffer:St(e)};s.setPipelineState(a),s.setShader(n),s.submitDraw(e,t),s.setShader({...n,defines:{...o,textRenderPassType:uo.Halo,isBackgroundPass:!1,isLabel:!0}}),s.submitDraw(e,t),s.setShader({...n,defines:{...o,textRenderPassType:uo.Color,isBackgroundPass:!1,isLabel:!0}}),s.submitDraw(e,t)}},heatmap:new class extends gs{constructor(){super(...arguments),this.type=n.Heatmap,this.drawPhase=a.MAP|a.HITTEST|a.DEBUG,this.shaders={accumulate:new Qs,resolve:new io},this._isBound=!1,this._resources=new Map}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:i,painter:s,state:o}=e,a=t.instance.getInput(),{isFieldActive:r}=a.uniforms,n=this._getOrCreateResourcesRecord(i),l=n.loadQualityProfile(i);St(e)||this._bind(e,n,a),s.setShader({shader:this.shaders.accumulate,uniforms:{...gt(e,t.target),kernelControls:{radius:no(a,o),isFieldActive:r?1:0}},defines:{...ft(e),...l.defines},optionalAttributes:{},useComputeBuffer:St(e)});const u=St(e)?ao:oo;s.setPipelineState(u),s.submitDraw(e,t)}getStencilReference(e){return so(e)}renderResolvePass(e,t){if(St(e))return;const{context:i,painter:s}=e,o=this._resources.get(i);if(null==this._prevFBO||null==this._prevViewport||!o?.initialized)return;const{defines:a}=o.loadQualityProfile(i),{minDensity:r,maxDensity:n,radius:l}=t.getInput().uniforms,u=o.accumulateFramebuffer,p=o.resolveGradientTexture,c={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:8,texture:u.colorTexture},minAndInvRange:[r,1/(n-r)],normalization:3/(l*l*Math.PI)},gradient:{texture:{unit:9,texture:p}}},defines:a,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(u.colorTexture,8),i.bindTexture(p,9),s.setPipelineState(ro),s.submitDrawMesh(i,c,s.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new Zs,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:s,state:o,pixelRatio:a}=e,r=s.getBoundFramebufferObject(),n=s.getViewport();this._prevFBO=r,this._prevViewport=n;const{gradient:l,gradientHash:u}=i.uniforms;t.ensureResolveGradientTexture(s,u,l);const{width:p,height:c}=n,d=function(e,t){const i=t>1.5?.25:.5;return e<1/(2*i)?1:i}(no(i,o),a),m=p*d,h=c*d,y=t.ensureAccumulateFBO(s,m,h);s.blitFramebuffer(r,y,Rt.STENCIL),s.bindFramebuffer(y),s.setViewport(0,0,y.width,y.height),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(Rt.COLOR),this._isBound=!0}},dotDensity:new class extends gs{constructor(){super(...arguments),this.type=n.DotDensity,this.shaders={polygon:new Ts,point:new Vs,fill:new Yi},this._resources=new Map}render(e,t){wt(e)||St(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:{...gt(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...ft(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:St(e)}),i.setPipelineState(xt(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){const{context:i,painter:s,requiredLevel:o}=e,a=t.instance.getInput().uniforms,r=this._getOrCreateResourcesRecord(i),n=r.getDotDensityTextures(i,Me,a.seed),l=1/2**(o-t.target.key.level),u=Me,p=u*window.devicePixelRatio*u*window.devicePixelRatio,c=1/l*(1/l),d=a.dotScale?e.state.scale/a.dotScale:1,m=a.dotValue*d*c;s.setShader({shader:this.shaders.polygon,uniforms:{...gt(e,t.target),instance:{isActive:a.isActive,colors:a.colors,dotValue:Math.max(1,m)},draw:{dotTexture0:{unit:Ce,texture:n[0]},dotTexture1:{unit:_e,texture:n[1]},tileZoomFactor:l,pixelRatio:window.devicePixelRatio,tileDotsOverArea:p/(Me*window.devicePixelRatio*Me*window.devicePixelRatio)}},defines:{...ft(e),blending:a.blending},optionalAttributes:{},useComputeBuffer:!1});const h=i.getViewport();i.setViewport(0,0,Me,Me);const y=i.getBoundFramebufferObject(),f=r.getFBO(i);i.bindFramebuffer(f),i.setClearColor(0,0,0,0),i.clear(Rt.COLOR),s.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),s.updatePipelineState(i),s.submitDraw(e,t),i.bindFramebuffer(y),i.setViewport(h.x,h.y,h.width,h.height);const v=r.getFBO(i).colorTexture,g={shader:this.shaders.point,uniforms:{view:Vt(e,t.target),instance:{dotSize:a.dotSize},draw:{locations:{unit:Ce,texture:v},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...ft(e)},optionalAttributes:{},useComputeBuffer:!1};s.setPipelineState(xt(e)),s.submitDrawMesh(i,g,r.getDotDensityMesh(i))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new _s,this._resources.set(e,t)),t}},animatedMarker:new class extends bs{constructor(){super(...arguments),this.type=n.AnimatedMarker,this.symbologyPlane=o.MARKER,this.shaders={geometry:new vs}}},animatedMarkerShift:new class extends bs{constructor(){super(...arguments),this.type=n.AnimatedMarkerShift,this.symbologyPlane=o.MARKER,this.shaders={geometry:new vs}}},animatedFill:new class extends bs{constructor(){super(...arguments),this.type=n.AnimatedFill,this.symbologyPlane=o.FILL,this.shaders={geometry:new ss}}},animatedLine:new class extends bs{constructor(){super(...arguments),this.type=n.AnimatedLine,this.symbologyPlane=o.LINE,this.shaders={geometry:new ms}}}};function Oo(){for(const e in Ro)Ro[e].startup()}function Do(e){for(const t in Ro)Ro[t].shutdown(e)}function Io(e,t){const i=e.slice(0,t),s=t-i.length;for(let e=0;e<s;e++){const e=i[i.length-1];i.push(e)}return i}function Fo(e){if(!e)return[0,0,0,0];const{r:t,g:i,b:s,a:o}=e;return[t*(o/255),i*(o/255),s*(o/255),o]}const Lo=()=>Ht.getLogger("esri.views.2d.layers.features.support.rendererUtils");function Eo(e){return e.map((e=>function(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}(e)?function(e){return e.stops=(t=e.type,(i=e.stops??[]).length<=8?i:(Lo().warn(`Found ${i.length} Visual Variable stops, but MapView only supports 8. Displayed stops will be simplified.`),i.length>16?function(e,t){const[i,...s]=t,o=s.pop(),a=s[0].value,r=s[s.length-1].value,n=(r-a)/6,l=[];for(let i=a;i<r;i+=n){let o=0;for(;i>=s[o].value;)o++;const a=s[o],r=t[o-1],n=i-r.value,u=a.value===r.value?1:n/(a.value-r.value);if("color"===e){const e=s[o],a=t[o-1],r=e.color.clone();r.r=ko(a.color.r,r.r,u),r.g=ko(a.color.g,r.g,u),r.b=ko(a.color.b,r.b,u),r.a=ko(a.color.a,r.a,u),l.push({value:i,color:r,label:e.label})}else if("size"===e){const e=s[o],a=t[o-1],r=Kt(e.size),n=ko(Kt(a.size),r,u);l.push({value:i,size:n,label:e.label})}else{const e=s[o],a=ko(t[o-1].opacity,e.opacity,u);l.push({value:i,opacity:a,label:e.label})}}return[i,...l,o]}(t,i):function(e){const[t,...i]=e,s=i.pop();for(;i.length>6;){let e=0,t=0;for(let s=1;s<i.length;s++){const o=i[s-1],a=i[s],r=Math.abs(a.value-o.value);r>t&&(t=r,e=s)}i.splice(e,1)}return[t,...i,s]}(i))),e;var t,i}(e.clone()):e))}function ko(e,t,i){return(1-i)*e+i*t}function Bo(e){if(!e)return!0;switch(e.type){case"dot-density":break;case"heatmap":if(!function(){const{supportsColorBufferFloat:e,supportsColorBufferFloatBlend:t,supportsColorBufferHalfFloat:i}=ii();return e&&t||i}()){const e=ii(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter((t=>!e[t])).join(", ");return Lo().errorOnce(new ti("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}function Uo(e){if(!e.stops?.length)return null;const t=Io(e.stops.sort(((e,t)=>e.value-t.value)),8),i=t.map((({value:e})=>e)),s=t.map((({color:e})=>Fo(e)));return{values:i,colors:s}}function No(e){if(!e.stops?.length)return null;const t=Io(e.stops.sort(((e,t)=>e.value-t.value)),8);return{opacityValues:t.map((({value:e})=>e)),opacities:t.map((({opacity:e})=>e))}}function Ho(e){return{rotationType:"geographic"===e.rotationType?Ze.Geographic:Ze.Arithmatic}}function jo(e){if(!e.stops?.length)return null;if(e.stops.some((e=>e.useMaxValue||e.useMinValue)))return(t,i)=>{const s=t.statisticsByLevel.get(i.key.level),o=Io(e.stops.map((t=>({value:t.useMaxValue?s?.get(e.field)?.maxValue??0:t.useMinValue?s?.get(e.field)?.minValue??0:t.value,size:t.size?Gt(t.size):De}))).sort(((e,t)=>e.value-t.value)),8);return{values:o.map((({value:e})=>e)),sizes:o.map((({size:e})=>e))}};const t=Io(e.stops.sort(((e,t)=>e.value-t.value)),8);return{values:t.map((({value:e})=>e)),sizes:t.map((({size:e})=>Gt(e)))}}function qo(e){return t=>{const{state:i}=t;return{unitValueToPixelsRatio:Yt(i.spatialReference)/Qt[e.valueUnit??"meters"]/i.resolution}}}function Wo(e,t){const i=t.length;if(e<t[0].value||1===i)return t[0].size;for(let s=1;s<i;s++)if(e<t[s].value){const i=(e-t[s-1].value)/(t[s].value-t[s-1].value);return t[s-1].size+i*(t[s].size-t[s-1].size)}return t[i-1].size}function Go(e){const{minDataValue:t,maxDataValue:i,minSize:s,maxSize:o}=e;if("object"==typeof s&&"object"==typeof o)return(e,a)=>{const r=e.state.scale,n=Gt(Wo(r,s.stops)),l=Gt(Wo(r,o.stops));return{minMaxValueAndSize:[t,i,n,l]}};if("object"==typeof s||"object"==typeof o)throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[t,i,Gt(s),Gt(o)]}}const Ko={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function Zo(e,t=128,i=1.25){if(e.visualVariableSizeMinMaxValue)return"function"==typeof e.visualVariableSizeMinMaxValue?128:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,t);if(e.visualVariableSizeScaleStops){if("function"==typeof e.visualVariableSizeScaleStops)return 128;const s=e.visualVariableSizeScaleStops.sizes;return Math.max(s[s.length-1]*i,t)}if(e.visualVariableSizeStops){if("function"==typeof e.visualVariableSizeStops)return 128;const s=e.visualVariableSizeStops.sizes;return Math.max(s[s.length-1]*i,t)}return e.visualVariableSizeUnitValue?256:0}function $o(e){const t={...Ko};if(!e||!("visualVariables"in e)||!e.visualVariables)return t;for(const s of Eo(e.visualVariables))switch(s.type){case"color":t.visualVariableColor=Uo(s);break;case"opacity":t.visualVariableOpacity=No(s);break;case"rotation":t.visualVariableRotation=Ho(s);break;case"size":switch("number"==typeof(i=s).minDataValue&&"number"==typeof i.maxDataValue&&null!=i.minSize&&null!=i.maxSize?"min-max":"$view.scale"===i?.valueExpression&&Array.isArray(i.stops)?"scale-stops":null==i.field&&"$view.scale"===i?.valueExpression||!(Array.isArray(i.stops)||"levels"in i&&i.levels)?null!=i.field||"$view.scale"!==i?.valueExpression?"unit-value":null:"field-stops"){case"field-stops":t.visualVariableSizeStops=jo(s);break;case"scale-stops":"outline"===s.target?t.visualVariableSizeOutlineScaleStops=jo(s):t.visualVariableSizeScaleStops=jo(s);break;case"min-max":t.visualVariableSizeMinMaxValue=Go(s);break;case"unit-value":t.visualVariableSizeUnitValue=qo(s)}}var i;return t}function Xo(e){return!!(e.visualVariableSizeMinMaxValue||e.visualVariableSizeScaleStops||e.visualVariableSizeStops||e.visualVariableSizeUnitValue||e.visualVariableSizeOutlineScaleStops)}function Yo(e){return!!e.visualVariableRotation}function Qo(e){return e.spriteRasterizationParam?e.spriteRasterizationParam:{type:"sprite-rasterization-param",resource:{type:"CIMPictureMarker",url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAJOgAACToAYJjBRwAAAAsSURBVEhL7c0xAQAwDASh+jf9lcCU7TDA27ECKqACKqACKqACKqACKqDjYPuLVfSmMPfafQAAAABJRU5ErkJggg==",size:16,invertBackfaceTexture:!1,scaleX:1,textureFilter:i.Picture},overrides:[]}}function Jo(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function ea(e){if(null==e)return null;if(Array.isArray(e)){const[t,i,s,o]=e;return[t,i,s,255*o]}return"string"==typeof e?e:{...e,defaultValue:ea(e?.defaultValue)}}async function ta(t,i){const{cimResourceManager:s,cimAnalyzer:o,scaleExpression:a}=i.schemaOptions;await Promise.all(e.fetchResources(t.symbol,s,[]));const r=o.analyzeSymbolReference(t,!1),n={scaleInfo:Jo(t),scaleExpression:a},l=[];for(const e of r)switch(e.type){case"marker":l.push(...ia(e,i,n));break;case"fill":l.push(...ua(e,i,n));break;case"outlineFill":l.push(...ra(e,i,n));break;case"gradientFill":l.push(...ca(e,i,n));break;case"line":l.push(...ma(e,i,n));break;case"gradientStroke":l.push(...va(e,i,n));break;case"text":l.push(...ba(e,i,n))}return l}function ia(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r=e.isOutline?{...Ko,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation};if(e.animationParams){const{hasShiftAnimation:t}=e.animationParams.params,s=t?Ro.animatedMarkerShift:Ro.animatedMarker;return sa(a.ensureInstance(s,{uniforms:r,optionalAttributes:{zoomRange:!0,value1Position2Value2:e.animationParams.params.hasShiftAnimation,lineLength:t}}),e,0,i)}return aa(a.ensureInstance(Ro.marker,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,s,i)}function sa(e,t,i,o){return t.animationParams?[e.createMeshInfo({pixelDimensions:t.pixelDimensions,texelDimensions:t.texelDimensions,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,sprite:Qo(t),animations:t.animationParams,scaleInfo:o.scaleInfo,scaleSymbolsProportionally:t.scaleSymbolsProportionally,strokeWidth:t.outlineWidth,isMapAligned:t.alignment===s.MAP,colorLocked:t.colorLocked,isStroke:t.isStroke,baseSize:t.baseSize,placement:t.markerPlacement,referenceSize:t.referenceSize,angleToLine:!!t.markerPlacement&&t.markerPlacement.placement&&"angleToLine"in t.markerPlacement.placement&&t.markerPlacement.placement.angleToLine,sizeRatio:t.sizeRatio,patternHeight:null})]:[]}function oa(e,t,i,s){return t.animationParams?[e.createMeshInfo({effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,sprite:Qo(t),animations:t.animationParams,scaleInfo:s.scaleInfo,scaleSymbolsProportionally:!1,strokeWidth:1,isMapAligned:!0,colorLocked:t.colorLocked||!1,isStroke:!1,baseSize:"width"in t?t.width:-1,placement:null,referenceSize:2,angleToLine:!1,sizeRatio:1,patternHeight:"fill"===t.type&&t.spriteRasterizationParam?t.height:null,joinType:"join"in t?t.join:"round",capType:"cap"in t?t.cap:"round",miterLimit:"miterLimit"in t&&t.miterLimit||2})]:[]}function aa(e,i,s,{scaleInfo:o,scaleExpression:a}){const r=Xo(s);return[e.createMeshInfo({size:i.size,scaleX:i.scaleX,anchorX:i.anchorPoint.x,anchorY:i.anchorPoint.y,angle:i.rotation,color:ea(i.color)??[0,0,0,0],colorLocked:i.colorLocked,frameHeight:i.frameHeight,widthRatio:i.widthRatio,scaleInfo:o,offsetX:i.offsetX,offsetY:i.offsetY,outlineColor:ea(i.outlineColor)??[0,0,0,0],outlineSize:i.outlineWidth,referenceSize:i.referenceSize||t.CIMVectorMarker.size,rotateClockwise:i.rotateClockwise,scaleFactor:a??1,sizeRatio:i.sizeRatio,alignment:i.alignment,isAbsoluteAnchorPoint:i.isAbsoluteAnchorPoint,scaleSymbolsProportionally:i.scaleSymbolsProportionally,sprite:i.spriteRasterizationParam,hasSizeVV:r,placement:i.markerPlacement,effects:i.effects?{type:"cim-effect-infos",effectInfos:i.effects}:null,transforms:i.transform,minPixelBuffer:Zo(s)})]}function ra(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return na(a.ensureInstance(Ro.outlineFill,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:null,visualVariableSizeScaleStops:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function na(e,t,i){const s=ea(t.color)??[0,0,0,0],o=ea(t.outlineColor)??[0,0,0,0];return[e.createMeshInfo({color:s,outlineColor:o,width:t.outlineWidth,referenceWidth:t.referenceWidth,capType:t.cap,joinType:t.join,miterLimit:t.miterLimit,outlineUsesColorVV:!t.outlineColorLocked,hasSizeVV:!1,scaleInfo:i.scaleInfo,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,outlineEffects:t.outlineEffects?{type:"cim-effect-infos",effectInfos:t.outlineEffects}:null})]}function la(e,t,{scaleInfo:i}){return[e.createMeshInfo({color:ea(t.color)??[0,0,0,0],scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function ua(e,t,i){if(!e.spriteRasterizationParam)return function(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r={visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity};if(e.animationParams){const t=Ro.animatedFill;return oa(a.ensureInstance(t,{uniforms:{...r,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),e,0,i)}return la(a.ensureInstance(Ro.fill,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}(e,t,i);const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r={visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity};if(e.animationParams){const t=Ro.animatedFill;return oa(a.ensureInstance(t,{uniforms:{...r,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),e,0,i)}return pa(a.ensureInstance(Ro.complexFill,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,null!=s.visualVariableColor,i)}function pa(e,t,i,{scaleInfo:s}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=!!t.hasUnresolvedReplacementColor&&(!i||t.colorLocked),a=t.sampleAlphaOnly&&!o,r=t.spriteRasterizationParam;return[e.createMeshInfo({color:ea(t.color)??[0,0,0,0],height:t.height,aspectRatio:t.scaleX,offsetX:t.offsetX,offsetY:t.offsetY,scaleX:1,scaleY:1,angle:t.angle,applyRandomOffset:t.applyRandomOffset,sampleAlphaOnly:a,scaleProportionally:"CIMHatchFill"===r.resource.type,sprite:r,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function ca(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return da(a.ensureInstance(Ro.gradientFill,{uniforms:{visualVariableColor:null,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function da(e,t,{scaleInfo:i}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const s=t.spriteRasterizationParam;return[e.createMeshInfo({color:ea(t.color)??[0,0,0,0],angle:t.angle,gradientMethod:t.gradientMethod,gradientSize:t.gradientSize,gradientSizeUnits:t.gradientSizeUnits,gradientType:t.gradientType,sprite:s,scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function ma(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r=e.isOutline?{...Ko,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue};if(e.animationParams){const{hasShiftAnimation:t}=e.animationParams.params,s=Ro.animatedLine;return oa(a.ensureInstance(s,{uniforms:{...r,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,accumulatedDistance:!0,segmentDirection:!0,normal:!0,lineLength:t}}),e,0,i)}const n={uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}},l=!!(r.visualVariableSizeMinMaxValue||r.visualVariableSizeScaleStops||r.visualVariableSizeStops||r.visualVariableSizeUnitValue);return e.spriteRasterizationParam?fa(a.ensureInstance(Ro.texturedLine,n),e,l,i):ya(a.ensureInstance(Ro.line,n),e,l,i)}function ha(e,t,{scaleInfo:i}){return{color:ea(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:i,hasSizeVV:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}function ya(e,t,i,s){if(t.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const o=ha(t,i,s);return[e.createMeshInfo(o)]}function fa(e,t,i,s){const{spriteRasterizationParam:o,scaleDash:a,sampleAlphaOnly:r}=t;if(!o)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({...ha(t,i,s),offsetAlongLine:t.offsetAlongLine??0,shouldScaleDash:a??!1,shouldSampleAlphaOnly:r,isSDF:"CIMPictureStroke"!==o.resource.type&&"CIMGradientStroke"!==o.resource.type,sprite:o})]}function va(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return ga(a.ensureInstance(Ro.gradientStroke,{uniforms:e.isOutline?{...Ko,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:null,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function ga(e,t,i){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const s=t.spriteRasterizationParam;return[e.createMeshInfo({...ha(t,!1,i),gradientMethod:t.gradientMethod,gradientSize:t.gradientSize,gradientSizeUnits:t.gradientSizeUnits,gradientType:t.gradientType,sprite:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function ba(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return xa(a.ensureInstance(Ro.text,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1,visibility:!1}}),e,s,i)}function xa(e,t,i,{scaleInfo:s,scaleExpression:o}){return[e.createMeshInfo({boxBackgroundColor:ea(t.backgroundColor),boxBorderLineColor:ea(t.borderLineColor),boxBorderLineSize:t.borderLineWidth??0,color:ea(t.color)??[0,0,0,0],offsetX:t.offsetX,offsetY:t.offsetY,postAngle:t.angle,fontSize:t.size,referenceSize:t.referenceSize,decoration:t.decoration,haloColor:ea(t.haloColor)??[0,0,0,0],haloSize:t.haloSize??0,outlineColor:ea(t.outlineColor)??[0,0,0,0],outlineSize:t.outlineSize,lineWidth:t.lineWidth||512,lineHeightRatio:1,horizontalAlignment:t.horizontalAlignment??"center",verticalAlignment:t.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:t.textRasterizationParam,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,placement:t.markerPlacement,transforms:t.transform,scaleFactor:o??1,minPixelBuffer:Zo(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,labelClassId:-1})]}function wa(e,t){return{type:"simple",filters:t,capabilities:{maxTextureSize:ii().maxTextureSize},bindings:za(e)}}function Sa(e,t){const i=ii();return{type:"multi",target:"feature",keyField:Jt,filters:t,capabilities:{maxTextureSize:i.maxTextureSize},bindings:{[ei.TrackLine]:za(e.trackLines.renderer),[ei.LatestObservation]:za(e.latestObservations.renderer),[ei.PreviousObservation]:za(e.previousObservations.renderer)}}}function Va(e){switch(e){case"opacity":return r.OPACITY;case"color":return r.COLOR;case"rotation":return r.ROTATION;case"size":return r.SIZE;default:return null}}function za(e){if(!e)return[];switch(e.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return Pa(e);case"dot-density":return function(e){const t=[];for(const i of e.attributes)t.push({binding:t.length,expression:i.valueExpression,field:i.field});return t}(e);case"pie-chart":return function(e){const t=Pa(e);let i=4;for(const s of e.attributes)t.push({binding:i++,expression:s.valueExpression,field:s.field});return t}(e);case"heatmap":return function({valueExpression:e,field:t}){return e||t?[{binding:0,expression:e,field:t}]:[]}(e)}}function Pa(e){return"visualVariables"in e&&e.visualVariables?.length?Eo(e.visualVariables).map((e=>function(e){switch(e.type){case"size":return function(e){return"$view.scale"===e.valueExpression?null:{binding:Va(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression,valueRepresentation:e.valueRepresentation}}(e);case"color":case"opacity":return function(e){return{binding:Va(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}(e);case"rotation":return function(e){return{binding:Va(e.type),expression:e.valueExpression,field:e.field}}(e)}}(e))).filter(xe):[]}class Aa{constructor(){this.type="override-batch",this.messages=[],this._resovler=oi()}get promise(){return this._resovler.promise}resolve(){this._resovler.resolve()}add(e){this.messages.push(e)}}class Ta{constructor(e){this.updateTracking=new Ae({debugName:"FeatureCommandQueue"}),this.process=e.process,this._queueProcessor=new ai({concurrency:1,process:async e=>{if("override-batch"===e.type){const e=this._nextOverrideBatch;if(null==e)throw new Error("InternalError: Override should be defined");return this._nextOverrideBatch=null,await this.process(e),void e.resolve()}return this.process(e)}})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return si(this.updateTracking.addPromise(this._doPush(e)))}async _doPush(e){const t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"highlight":if(i?.type===e.type)return;return t.push(e);case"override":case"edit":return this._pushOverride(e)}}_pushOverride(e){return null==this._nextOverrideBatch&&(this._nextOverrideBatch=new Aa,this._queueProcessor.push(this._nextOverrideBatch)),this._nextOverrideBatch.add(e),this._nextOverrideBatch.promise}}export{Ta as F,li as M,pi as S,Ro as T,ga as a,da as b,na as c,xa as d,oa as e,fa as f,Jo as g,ya as h,la as i,pa as j,sa as k,aa as l,wa as m,Ko as n,$o as o,Fo as p,Zo as q,ta as r,Xo as s,Yo as t,Sa as u,Bo as v,Pa as w,ri as x,Oo as y,Do as z};
