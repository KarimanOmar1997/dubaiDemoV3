/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"../core/lang.js";import{L as t}from"./Logger.js";import{throwIfAborted as i}from"../core/promiseUtils.js";import{watch as r,on as s,syncAndInitial as l}from"../core/reactiveUtils.js";import{parseWhereClause as n,sqlAnd as a}from"../core/sql.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import{subclass as u}from"../core/accessorSupport/decorators/subclass.js";import{g as d}from"./FeatureIdInfo.js";import{c as f}from"./constants2.js";import{g as p}from"./displayFilterUtils.js";import h from"../layers/support/FeatureEffect.js";import m from"../layers/support/FeatureFilter.js";import{B as y}from"./featureLayerUtils.js";import{f as c,l as F}from"./featurePopupQueryUtils.js";import{fixFields as g,unpackFieldNames as I,collectLabelingFields as b,collectElevationFields as v,collectFilterFields as w,collectFeatureReductionFields as E,collectOrderByInfos as x,collectFields as q,collectTrackInfoFields as R,collectDisplayFilterFields as _,collectField as C,featureHasFields as j}from"../layers/support/fieldUtils.js";import{a as O}from"./floorFilterUtils.js";import{a as L}from"./networkFieldUtils.js";import U from"../rest/support/Query.js";import{c as k}from"./featureServiceUtils.js";import{g as P,a as T}from"./popupUtils.js";class S{constructor(e){this._fieldsIndex=e,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some((e=>e.currentUserRequired))}}visitClientWhereClause(e){e&&this._clauses.push(n(e,this._fieldsIndex))}visitFeatureReduction(e){if(e)switch(e.type){case"binning":case"cluster":this.visitLabelingInfo(e.labelsVisible,e.labelingInfo)}}visitLabelingInfo(e,t){if(e&&null!=t)for(const e of t)this.visitClientWhereClause(e.where)}visitDisplayFilter(e,t){if(e)for(const e of t?.filters??[])this.visitClientWhereClause(e.where)}visitFilter(e){this.visitClientWhereClause(e?.where)}visitTrackInfo(e){null!=e&&(this.visitLabelingInfo(e?.latestObservations.labelsVisible,e?.latestObservations.labelingInfo),this.visitLabelingInfo(e?.previousObservations.labelsVisible,e?.previousObservations.labelingInfo),this.visitLabelingInfo(e?.trackLines.labelsVisible,e?.trackLines.labelingInfo))}}const D=n=>{let D=class extends n{constructor(...e){super(...e),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([r((()=>{const e=this.layer,t=this.view;return[e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,t?.requiredFieldsOptions?.featureTitleFields&&e&&"featureTitleFields"in e&&e.featureTitleFields,t?.requiredFieldsOptions?.utilityNetworkFields&&L(t,e),e.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,"knowledge-graph-sublayer"===e?.type&&"link-chart"===e.parentCompositeLayer.type&&e.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode,"parquet"===e?.type&&e.popupTemplate]}),(()=>this._handleChange()),l),s((()=>this.view?.floors),"change",(()=>this._handleChange())),s((()=>this.layer.displayFilterInfo?.filters),"change",(()=>this._handleChange())),s((()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null),"change",(()=>this._handleChange()))])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:i}=this;return"outFields"in e&&e.outFields?g(t,[...I(t,e.outFields),...i]):g(t,i)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const e=this.layer;return this.displayFilterEnabled&&e.displayFilterInfo?p(e.displayFilterInfo,this.view):null}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){t.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?y(this.layer.url):Promise.resolve(null)}highlight(e,t){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new U(e);return"floorInfo"in this.layer&&this.layer.floorInfo&&(t.where=a(t.where,O(this))),this.displayFilterEnabled&&(t.where=a(t.where,this.effectiveDisplayFilter?.where)),null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new U(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){const i=await this._createPopupQuery(e.map((e=>e.origin?.layer??e.layer)),t);return await c(this.layer,e,i,{getPopupTemplate:e=>e&&"popupEnabled"in e&&e.popupEnabled?T(e,t):null,hasRequiredFields:(e,t)=>this._popupFeatureHasRequiredFields(e,t),...t})}_handleChange(){const e=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then((()=>{}));return this._set("_updatingRequiredPromise",e),e.then((()=>{this._updatingRequiredPromise===e&&this._set("_updatingRequiredPromise",null)})),e}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:e}=this,i=new S(e.fieldsIndex);if(i.visitFilter(this.filter),"featureReduction"in e&&i.visitFeatureReduction(e.featureReduction),"labelingInfo"in e&&i.visitLabelingInfo(e.labelsVisible,e.labelingInfo),"trackInfo"in e&&i.visitTrackInfo(e.trackInfo),"2d"===this.view.type&&(i.visitFilter(this.featureEffect?.filter),i.visitDisplayFilter(this.displayFilterEnabled,e.displayFilterInfo),"featureReduction"in e&&i.visitFeatureReduction(e.featureReduction)),"subtype-group"===e.type)for(const t of e.sublayers)i.visitLabelingInfo(t.labelsVisible,t.labelingInfo);try{const e=await i.finish();this._set("requiresCurrentUser",e.requiresCurrentUser)}catch(e){t.getLogger(this).error(e)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:i,layer:{fieldsIndex:r}}=this,s="renderer"in i&&i.renderer,l="orderBy"in i&&i.orderBy,n="featureReduction"in i?i.featureReduction:null,a=new Set,o=[s?s.collectRequiredFields(a,r):null,b(a,i),e&&"elevationInfo"in i?v(a,i):null,null!=this.filter?w(a,i,this.filter):null,e||null==this.featureEffect?null:w(a,i,this.featureEffect.filter),!e&&n?E(a,i,n):null,!e&&l?x(a,i,l):null];if("timeInfo"in i&&i.timeInfo&&this.timeExtent&&q(a,i.fieldsIndex,[i.timeInfo.startField,i.timeInfo.endField]),"timeInfo"in i&&i.timeInfo&&"trackInfo"in i&&i.trackInfo){const{trackInfo:e}=i;q(a,i.fieldsIndex,[i.timeInfo.trackIdField]),"feature"!==i.type&&"startTimeField"!==e.timeField||q(a,i.fieldsIndex,[i.timeInfo.startField]),"endTimeField"===e.timeField&&q(a,i.fieldsIndex,[i.timeInfo.endField]),await R(a,i)}if("floorInfo"in i&&i.floorInfo&&q(a,i.fieldsIndex,[i.floorInfo.floorField]),"featureTitleFields"in i&&this.view?.requiredFieldsOptions?.featureTitleFields&&i.featureTitleFields&&q(a,i.fieldsIndex,i.featureTitleFields),"feature"===i.type&&i.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&q(a,i.fieldsIndex,[i.globalIdField]),this.displayFilterEnabled&&o.push(_(a,i,i.displayFilterInfo)),"feature"===i.type&&e&&null!=i.infoFor3D&&(null==i.globalIdField&&t.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),q(a,i.fieldsIndex,[i.globalIdField])),"subtype-group"===i.type){C(a,r,i.subtypeField);const e=i.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(a,r),b(a,e)])));o.push(Promise.all(e))}if("catalog-footprint"===i.type&&i.parent){const e=i.parent;q(a,r,[e.itemNameField,e.itemSourceField,e.itemTypeField,e.maxScaleField,e.minScaleField])}"knowledge-graph-sublayer"===i.type&&"link-chart"===i.parentCompositeLayer.type&&C(a,r,f),"parquet"===i.type&&o.push(P(i,i.popupTemplate).then((e=>{for(const t of e)a.add(t)})));const u=await Promise.allSettled(o);if(e)C(a,r,i.objectIdField);else for(const e of d(k(i)))C(a,r,e);e&&"displayField"in i&&i.displayField&&C(a,r,i.displayField);for(const e of u)"rejected"===e.status&&t.getLogger(this).error(e.reason);const p=Array.from(a).sort();this._set("requiredFields",p)}_popupFeatureHasRequiredFields(e,t){return j(e,t)}async _createPopupQuery(e,t){const r=this.layer.createQuery(),s=new Set;let l=!1;const n=e??[this.layer];for(const e of n){if(!("popupEnabled"in e))continue;const r=T(e,t);if(null==r)continue;const n=await F(r);i(t);const a=n&&n.arcadeUtils.hasGeometryOperations(r);l=!("point"!==this.layer.geometryType&&!a);const o=await P(this.layer,r);i(t);for(const e of o)s.add(e)}return r.returnGeometry=l,r.returnZ=l,r.returnM=l,r.outFields=Array.from(s),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(r.where=a(r.where,O(this))),r}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}getTest(){}get test(){}};return e([o()],D.prototype,"_updatingRequiredPromise",void 0),e([o({readOnly:!0})],D.prototype,"availableFields",null),e([o({readOnly:!0})],D.prototype,"displayFilterEnabled",null),e([o({readOnly:!0})],D.prototype,"effectiveDisplayFilter",null),e([o({type:h})],D.prototype,"featureEffect",null),e([o({type:m})],D.prototype,"filter",void 0),e([o()],D.prototype,"layer",void 0),e([o({type:Number})],D.prototype,"maximumNumberOfFeatures",null),e([o({readOnly:!0,type:Boolean})],D.prototype,"maximumNumberOfFeaturesExceeded",null),e([o()],D.prototype,"requiresCurrentUser",void 0),e([o({readOnly:!0})],D.prototype,"requiredFields",void 0),e([o({readOnly:!0})],D.prototype,"signedInUser",null),e([o()],D.prototype,"suspended",void 0),e([o()],D.prototype,"view",void 0),D=e([u("esri.views.layers.FeatureLayerView")],D),D};export{D as F};
