/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import"../core/lang.js";import{d as e,f as r,a as s}from"./maybe.js";import{debounce as i,throwIfAborted as o,ignoreAbortErrors as n}from"../core/promiseUtils.js";import{when as l,sync as a}from"../core/reactiveUtils.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{projectOrLoad as h}from"./projectionUtils.js";import{k as m,c as d,d as p,q as y,t as f}from"./aaBoundingRect.js";import{E as g}from"./ElevationInfo.js";import{a as _,g as w,l as b}from"./dataUtils.js";import{g as S,s as j}from"./utils31.js";import{S as v}from"./SubView3D.js";import{f as x}from"./vec3f64.js";import{f as R}from"./vec4f64.js";import{z as I}from"./elevationInfoUtils.js";import{l as L,c as C}from"./line.js";import{R as D,C as E,W as F,U as z,O as U}from"./RibbonLineMaterial.js";import q from"../core/Accessor.js";import{I as G}from"../views/SceneView.js";function H(t,e){return null==e?t:Math.max(t,e)}function M(t,e){return null==e?t:Math.min(t,e)}class W{constructor(t,e){this.streamlines=t,this._geometries=e,this._object3D=null,this._engineLayer=null}get attached(){return null!=this._object3D&&null!=this._engineLayer}attach(t){const{_geometries:e}=this;if(null==e)return;this.detach();const r=new F(t,{pickable:!1,updatePolicy:z.SYNC}),s=new U({geometries:e});s.visible=!0,r.add(s),this._object3D=s,this._engineLayer=r}detach(){this.attached&&(this._engineLayer=e(this._engineLayer),this._object3D=r(this._object3D))}}let B=class extends q{constructor(t){super(t),this.simulationSettings=null,this.loadImagery=null,this.createGeometry=null}async load(t,e){const r=await this.loadImagery(t,e);if(null==r)return null;const s=this._createFlowFieldFromData(r),i=this._getStreamlines(t,s),o=this.createGeometry(t,i);return new W(i,o)}_createFlowFieldFromData(t){return _(this.simulationSettings,t)}_getStreamlines(t,e){const{size:[r,s]}=t;return w(this.simulationSettings,e,r,s)}};t([u()],B.prototype,"simulationSettings",void 0),t([u()],B.prototype,"loadImagery",void 0),t([u()],B.prototype,"createGeometry",void 0),B=t([c("esri.views.3d.support.flow.StreamlinesStyle3D")],B);let T=class extends v{constructor(t){super(t),this.type="flow",this._preorderIterator=new G,this._abortController=null,this._debouncedLoad=i((async()=>{const{view:t,_style:e}=this;if(null==e)return;const r=this._computeExtent();if(null==r)return;const s={extent:r,timeExtent:this.layer.timeExtent,size:this._viewSizeWithEqualRatio(r),pixelRatio:t.state.contentPixelRatio};null==this._abortController&&(this._abortController=new AbortController);const i=this._abortController,n=await e.load(s,i.signal);o(i.signal),null!=n&&(this._resources?.detach(),n.attach(t.stage),this._resources=n)})),this._loadImagery=(t,e)=>{const{extent:r,size:[s,i],timeExtent:o}=t;return b(this.layer,r,s,i,o,e)},this._createFlowGeometry=(t,e)=>function(t,e,r,s){const{spatialReference:i}=t,o=r.map((r=>r.map((r=>{const[o,n]=function({x:t,y:e},r){const{extent:s,size:[i,o]}=r;return[t/i*s.width+s.xmin,(o-e)/o*s.height+s.ymin]}(r,e),{absoluteZ:l}=I(o,n,0,i,t,s),a=x(o,n,l);return t.renderCoordsHelper.toRenderCoords(a,i,a),a}))));return function(t){const e=L(t),r=new D({width:2,color:R(.1,.2,1,1),innerWidth:1,innerColor:R(.2,.4,1,1),cap:E.ROUND});return e.map((t=>C(r,t)))}(o)}(this.view,t,e,this.elevationInfo)}initialize(){this.addHandles([l((()=>this.newStyleRequired),(()=>this._updateStyle()),a)]),this.updatingHandles.add((()=>this._style),(()=>this._triggerLoad())),this._updateStyle(),this.updatingHandles.addWhen((()=>!this.view.basemapTerrain?.updating),(()=>this._triggerLoad()))}destroy(){this._abortController=s(this._abortController),this.clear()}get layer(){return this.layerView.layer}get flowRenderer(){const t=this.layer.renderer;return"flow"!==t?.type?null:t}get elevationInfo(){return new g({mode:"absolute-height",offset:1e3})}get dataBounds(){const{fullExtent:t}=this.layer,{spatialReference:e}=this.view.basemapTerrain,r=h(t,e).geometry;return null==r?null:p(r)}get simulationSettings(){const{flowRenderer:t}=this;return null==t?null:S(t)}get newStyleRequired(){const t=this._style?.simulationSettings,e=this.simulationSettings;return null!=t&&null!=e&&!j(t,e)}doRefresh(){return this._triggerLoad()}clear(){this._resources?.detach(),this._resources=null}_triggerLoad(){return n(this.updatingHandles.addPromise(this._debouncedLoad()))}_updateStyle(){const{simulationSettings:t}=this;null!=t&&(this._style?.destroy(),this._style=new B({simulationSettings:t,loadImagery:this._loadImagery,createGeometry:this._createFlowGeometry}))}_computeExtent(){const t=this.view.basemapTerrain,e=t?.rootTiles;if(null==e||0===e.length)return null;const{spatialReference:r}=t,{dataBounds:s}=this;if(!r||null==s)return null;const i=function(t,e,r){let[s,i,o,n]=[null,null,null,null];for(e.reset(t);!e.done;){const t=e.next();if(null==t)continue;if(!t.visible){e.skipSubtree();continue}const l=t.extent;t.leaf&&t.rendered&&m(l,r)&&(s=M(l[0],s),i=M(l[1],i),o=H(l[2],o),n=H(l[3],n))}return null==s||null==i||null==o||null==n?null:d([s,i,o,n])}(e,this._preorderIterator,s);return null==i?null:(y(i,s,i),f(i,r))}_viewSizeWithEqualRatio(t){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin),[r,s]=this.view.size;return r<s?[r,Math.floor(r/e)]:[Math.floor(s*e),s]}get test(){}};t([u()],T.prototype,"type",void 0),t([u()],T.prototype,"_style",void 0),t([u()],T.prototype,"layer",null),t([u()],T.prototype,"flowRenderer",null),t([u()],T.prototype,"elevationInfo",null),t([u()],T.prototype,"dataBounds",null),t([u()],T.prototype,"simulationSettings",null),t([u()],T.prototype,"newStyleRequired",null),T=t([c("esri.views.3d.layers.FlowSubView3D")],T);export{T as F};
