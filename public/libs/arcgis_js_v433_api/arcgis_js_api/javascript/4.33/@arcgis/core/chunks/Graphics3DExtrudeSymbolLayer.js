/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import t from"../Color.js";import{clone as e}from"../core/lang.js";import s from"../core/Error.js";import{F as o}from"./unitUtils.js";import{e as n}from"./earcut.js";import{b as i}from"./mat3.js";import{c as r}from"./mat3f64.js";import{i as a,n as c}from"./mat4.js";import{c as l}from"./mat4f64.js";import{s as p,t as h,a as u,f as m,n as d,c as f,k as g}from"./vec3.js";import{a as y,c as b}from"./vec3f64.js";import{Z as x}from"./vec4f64.js";import{c as _}from"./computeTranslationToOriginAndRotation.js";import{h as S,r as P,c as C,x as O,y as j}from"./aaBoundingBox.js";import{g as w,n as E}from"./Indices.js";import{b as I}from"./vec32.js";import{m as A,a as v}from"./SnappingCandidate.js";import{b as M}from"./renderingInfoUtils.js";import{E as R}from"./materialUtils.js";import{V as D}from"./ViewingMode.js";import{a as L,n as B,S as U}from"./ElevationContext.js";import{G as T,A as V,O as z,a as N,i as G}from"./TextureCompressionTracker.js";import{v as F,c as k}from"./graphicUtils.js";import H from"../geometry/Extent.js";import W from"../geometry/Polygon.js";import{A as Z}from"./Axis.js";import{l as q,r as J,C as K}from"./triangulationUtils.js";import{A as Q}from"./orientedBoundingBox.js";import{G as X,a as Y}from"./Matrix4PassUniform.js";import{V as $}from"./VertexAttribute.js";import{b as tt}from"./edgeUtils.js";import{d as et}from"./debugFlags2.js";import{S as st}from"./Intersector2.js";import{p as ot}from"./projectBuffer.js";import{d as nt}from"./RenderGeometry.js";import{N as it}from"./NormalAttribute.glsl.js";import{C as rt}from"./basicInterfaces.js";import{c as at,a as ct}from"./Normals.js";import{O as lt}from"./RibbonLineMaterial.js";import{D as pt}from"./DefaultMaterial.js";function ht(t,e,s){const o=(e.length>0?e[0]:t.length/3)-1,i=q(t,o,s);if(i!==Z.Z){t=t.slice();for(let e=0;e<t.length;e+=3)t[e+i]=t[e+2]}return n(t,e,3)}function ut(t){const e=[[$.POSITION,new Q(t.attributeData.position,t.indices,3,!0)]],s=w(t.indices.length);return null!=t.attributeData.colorFeature?e.push([$.COLORFEATUREATTRIBUTE,new Q([t.attributeData.colorFeature],s,1,!0)]):t.attributeData.color&&e.push([$.COLOR,new Q(t.attributeData.color,s,4,!0)]),t.attributeData.uvMapSpace&&e.push([$.UVMAPSPACE,new Q(t.attributeData.uvMapSpace,t.indices,4,!0)]),t.attributeData.boundingRect&&e.push([$.BOUNDINGRECT,new Q(t.attributeData.boundingRect,t.indices,9,!0)]),new X(t.material,e,t.mapPositions,Y.Mesh,t.attributeData.objectAndLayerIdColor)}function mt(t,e=null){const s=[[$.POSITION,new Q(t.attributeData.position,t.indices,3,!0)],[$.UV0,new Q(t.attributeData.uv0,t.indices,2,!0)]];return new X(t.material,s,t.mapPositions,Y.Mesh,e)}function dt(t){switch(t.type){case"extent":if(t instanceof H)return W.fromExtent(t);break;case"polygon":return t}return null}class ft{constructor(t,e,s){this.renderData=t,this.layerViewUid=e,this.graphicUid=s,this.outGeometries=new Array}}function gt(t,e,s,o){const n=J(t.rings,!!t.hasZ&&"on-the-ground"!==o.mode,K.CCW_IS_HOLE,t.spatialReference),i=S(n.position.length),r=L(n.position,t.spatialReference,0,i,0,n.position,0,n.position.length/3,e,s,o),a=null!=r;return new Ot(n.position,i,xt(n.polygons,n.position,i),bt(n.outlines,n.position,i),a,r)}function yt(t,e){const s=J(t.rings,!1,K.CCW_IS_HOLE),o=ot(s.position,t.spatialReference,0,s.position,e,0);for(let t=2;t<s.position.length;t+=3)s.position[t]=nt;return{position:s.position,polygons:xt(s.polygons,s.position),outlines:bt(s.outlines,s.position),projectionSuccess:o}}function bt(t,e,s=null){return t.filter((({count:t})=>t>1)).map((({index:t,count:o})=>{const n=3*t,i=3*o;return null!=s?new St(t,o,P(e,n,i),P(s,n,i)):new _t(t,o,P(e,n,i))}))}function xt(t,e,s=null){const o=new Array;for(const{index:n,count:i,holeIndices:r,pathLengths:a}of t){if(i<=1)continue;const t=3*n,c=3*i,l=r.map((t=>t-n)),p=null!=s?new Pt(n,i,P(e,3*n,3*i),P(s,t,c),l,a):new Ct(n,i,P(e,3*n,3*i),l,a);o.push(p)}return o}class _t{constructor(t,e,s){this.index=t,this.count=e,this.position=s}}class St extends _t{constructor(t,e,s,o){super(t,e,s),this.mapPositions=o}}class Pt extends St{constructor(t,e,s,o,n,i){super(t,e,s,o),this.holeIndices=n,this.pathLengths=i}}class Ct extends _t{constructor(t,e,s,o,n){super(t,e,s),this.holeIndices=o,this.pathLengths=n}}class Ot{constructor(t,e,s,o,n,i){this.position=t,this.mapPositions=e,this.polygons=s,this.outlines=o,this.projectionSuccess=n,this.sampledElevation=i}}const jt=["polygon","extent"];class wt extends T{constructor(t,e,s,o){super(t,e,s,o,function(t){return 1===(t.material?.color?.a??1)}(e)),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const t=F(this._getSymbolSize());if(t)throw new s("graphics3dextrudesymbollayer:invalid-size",t)}const t=this.symbolLayer,e=t?.material,o=e?.color,n=this._getCombinedOpacityAndColor(o),i=y(n),r=n[3],a=this.needsDrivenTransparentPass,c=e?.emissive,l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:r,drivenOpacity:a,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:c?.strength??0,emissiveSource:R.Color,offsetTransparentBackfaces:!0,normalType:it.Compressed},p=new pt(l,this._context);p.setParameters({cullFace:p.transparent?rt.None:rt.Back});const h=new pt({...l,cullFace:rt.Back},this._context);this._materials[Qt.Main]=p,this._materials[Qt.Bottom]=h}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,jt,this.symbolLayer.type))return null;const s=this._getVertexOpacityAndColor(t.renderingInfo,this._getFallbackOpacityAndColor(),255),o=this.setGraphicElevationContext(e);return this._createAs3DShape(e,t.renderingInfo,s,o,e.uid)}layerOpacityChanged(t,e){const s=this.symbolLayer?.material?.color,o=this._getCombinedOpacity(s);this._materials[Qt.Main]?.setParameters({opacity:o}),this._materials[Qt.Bottom]?.setParameters({opacity:o});const n=this._getLayerOpacity();t?.forEach((t=>e(t)?.layerOpacityChanged(n,this._context.isAsync)))}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,B)}slicePlaneEnabledChanged(t,e){return this._materials[Qt.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[Qt.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t?.forEach((t=>{const s=e(t);null!=s&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[Qt.Main]?.setParameters(t),this._materials[Qt.Bottom]?.setParameters(t),!0}_getExtrusionSize(t){let e;return e=t.size&&this._drivenProperties.size?M(t.size,2)??0:this._getSymbolSize(),e/=this._context.renderCoordsHelper.unitInMeters,e}applyRendererDiff(t,e){return this._drivenPropertiesChanged(e)?V.RecreateSymbol:V.RecreateGraphics}async queryForSnapping(t,s,n,i){const r=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/o(s),{objectId:a,target:c}=t,l=e(c);switch(l.z=(l.z??0)+r,t.type){case"edge":{const{start:s,end:o}=t,n=e(s),i=e(o);return n.z=(n.z??0)+r,i.z=(i.z??0)+r,[v(a,l,1/0,n,i)]}case"vertex":return[A(a,l,1/0),v(a,c,1/0,c,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,e,s,o,u){const m=dt(t.geometry);if(null==m)return null;if(0===m.rings.length||!m.rings.some((t=>t.length>0)))return this._logGeometryValidationWarnings(m.rings,"rings","ExtrudeSymbol3DLayer"),null;const d=gt(m,this._context.elevationProvider,this._context.renderCoordsHelper,o);this._logGeometryCreationWarnings(d,m.rings,"rings","ExtrudeSymbol3DLayer");const f=k(m);if(null==f)return null;const g=new Array,y=new Array,x=C(),P=l(),w=b(),A=this._context.renderCoordsHelper.viewingMode===D.Global;A||this._context.renderCoordsHelper.worldUpAtPosition(null,w),_(m.spatialReference,[f.x,f.y,0],P,this._context.renderCoordsHelper.spatialReference);const v=l();a(v,P);const M=r();i(M,v);const{polygons:R,mapPositions:L,position:U}=d,T=new Map,V=this._materials[Qt.Main];for(const t of R){const o=t.count;if(this._context.clippingExtent&&(O(t.mapPositions,x),!j(x,this._context.clippingExtent)))continue;const i=n(t.mapPositions,t.holeIndices,3);if(0===i.length)continue;const r=i.length,a=6*o,c=E(a+r),l=E(r),p=S(3*a),h=S(3*a),m=S(3*a),d=S(a);It(U,L,i,t,p,m,h,d,c,l,this._getExtrusionSize(e),w,A),I(p,p,v);const f=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:u,layerViewUid:this._context.layerViewUid}),b=new Xt(p,m,at(h),d),_=Et(V,c,c.length-l.length,b,s,f),C=o,M=o,R=2*t.count,D=new Yt(C,M,R,r/3);zt(_,D,P),T.set(_,D),g.push(_,Et(this._materials[Qt.Bottom],l,0,b,s,f)),y.push(b.heights)}if(0===g.length)return null;const F=new lt({geometries:g,layerViewUid:this._context.layerViewUid,graphicUid:u,isElevationSource:!0});F.transformation=P;const H=tt(this.symbolLayer,{opacity:this._getLayerOpacity()}),W=H?new z(this._materials[Qt.Main],H,this._context.slicePlaneEnabled):null,Z=new N(this,F,null,((t,e,s,o,n)=>function(t,e,s,o,n,i,r){const a=t.stageObject,u=a.geometries,m=u.length,d="absolute-height"!==e.mode;let f=0;const g=a.transformation,y=c(l(),g);for(let t=0;t<m;t+=2){const e=u[t];if(!G(e))continue;const c=e.getMutableAttribute($.POSITION).data,l=i[t/2],m=new st(e.mapPositions),b=c.length/3;let x=!1,_=0;{let t=0;for(let e=0;e<b;e++){Vt[0]=c[t],Vt[1]=c[t+1],Vt[2]=c[t+2],o(m,Ft),d&&(_+=Ft.sampledElevation),et.TESTS_DISABLE_OPTIMIZATIONS?(p(Nt,m.array[m.offset],m.array[m.offset+1],Ft.z+l[t/3]),null!=s&&n.toRenderCoords(Nt,s,Nt),h(Nt,Nt,y)):(p(Nt,c[t],c[t+1],c[t+2]),h(Nt,Nt,g),n.setAltitude(Nt,Ft.z+l[t/3]),h(Nt,Nt,y)),c[t]=Nt[0],c[t+1]=Nt[1],c[t+2]=Nt[2];const e=Wt/n.unitInMeters;(Math.abs(Vt[0]-c[t])>=e||Math.abs(Vt[1]-c[t+1])>=e||Math.abs(Vt[2]-c[t+2])>=e)&&(x=!0),m.offset+=3,t+=3}}if(x){const s=r.get(e);s&&zt(e,s,g),a.geometryVertexAttributeUpdated(u[t],$.NORMALCOMPRESSED),e.invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(u[t],$.POSITION),u[t+1].invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(u[t+1],$.POSITION)}f+=_/b}return f/m}(t,e,s,o,n,y,T)),o,W);return Z.alignedSampledElevation=d.sampledElevation,Z.needsElevationUpdates=B(o.mode),Z}_getFallbackOpacityAndColor(){const e=this.symbolLayer?.material?.color;return t.toUnitRGBA(e)??x}}function Et(t,e,s,o,n,i){const r=w(e.length),a=[[$.POSITION,new Q(o.positions,e,3,!0)],[$.NORMALCOMPRESSED,new Q(o.normals,e,2,!0)],[$.COLOR,new Q(n,r,4,!0)]];return new X(t,a,o.elevation,Y.Mesh,i,s)}function It(t,e,s,o,n,i,r,a,c,l,p,h,u){const m=s.length/3;let g=2*o.count;!function(t,e,s,o,n,i,r,a,c,l,p,h,u,m,g,y,b){f(Gt,y),c??=[],l??=[],p??=[];const x=g>0?1:-1;let _=3*s,S=0,P=3*S,C=o,O=3*C;for(let s=0;s<o;++s){const s=t[_],o=t[_+1],n=t[_+2];b&&(Gt[0]=s,Gt[1]=o,Gt[2]=n,d(Gt,Gt)),a[P+0]=s,a[P+1]=o,a[P+2]=n;const i=e[_+0],r=e[_+1],h=e[_+2];c[P+0]=i,c[P+1]=r,c[P+2]=h,l[P+0]=-x*Gt[0],l[P+1]=-x*Gt[1],l[P+2]=-x*Gt[2],p[S]=0,a[O+0]=s+g*Gt[0],a[O+1]=o+g*Gt[1],a[O+2]=n+g*Gt[2],c[O+0]=i,c[O+1]=r,c[O+2]=h,p[C]=g,P+=3,O+=3,_+=3,S+=1,C+=1}_=0,P=0,O=3*m;const j=g<0?Ht:kt,w=g<0?kt:Ht;for(let t=0;t<r;++t)u[P]=n[_+j[0]],u[P+1]=n[_+j[1]],u[P+2]=n[_+j[2]],h[O]=n[_+w[0]]+o,h[O+1]=n[_+w[1]]+o,h[O+2]=n[_+w[2]]+o,P+=3,O+=3,_+=3}(t,e,o.index,o.count,s,0,m,n,i,r,a,c,l,g,p,h,u);let y=0,b=2*o.count;g=0;const x=o.pathLengths[0];Mt(n,i,a,r,y,x,o.count,b,c,g,p),b+=4*x,g+=2*x,y+=x;for(let t=1;t<o.pathLengths.length;++t){const e=o.pathLengths[t];Mt(n,i,a,r,y,e,o.count,b,c,g,p),b+=4*e,g+=2*e,y+=e}}function At(t,e,s,o,n,i,r){o[i]=o[r],r*=3,t[i*=3]=t[r],t[i+1]=t[r+1],t[i+2]=t[r+2],e[i]=e[r],e[i+1]=e[r+1],e[i+2]=e[r+2],s[i]=n[0],s[i+1]=n[1],s[i+2]=n[2]}const vt=b();function Mt(t,e,s,o,n,i,r,a,c,l,p){e??=[],s??=[],o??=[];let h=n,u=n+1,m=n+r,d=n+r+1,f=a,g=a+1,y=a+2*i,b=a+2*i+1;p<0&&(h=n+r+1,d=n);let x=3*l;for(let a=0;a<i;++a)a===i-1&&(u=n,p>0?d=n+r:h=n+r),Tt(t,h,u,m,vt),At(t,e,o,s,vt,f,h),At(t,e,o,s,vt,g,u),At(t,e,o,s,vt,y,m),At(t,e,o,s,vt,b,d),c[x]=f,c[x+1]=y,c[x+2]=b,c[x+3]=f,c[x+4]=b,c[x+5]=g,x+=6,h++,u++,m++,d++,f+=2,g+=2,y+=2,b+=2}const Rt=b(),Dt=b(),Lt=b(),Bt=b(),Ut=b();function Tt(t,e,s,o,n){e*=3,s*=3,o*=3,p(Rt,t[e++],t[e++],t[e++]),p(Dt,t[s++],t[s++],t[s++]),p(Lt,t[o++],t[o++],t[o++]),g(Bt,Dt,Rt),g(Ut,Lt,Rt),m(n,Ut,Bt),d(n,n)}const Vt=b();function zt(t,e,s){const o=t.getMutableAttribute($.POSITION),n=t.getMutableAttribute($.NORMALCOMPRESSED).data,{topVertexStart:i,topVertexCount:r,topFaceStart:a,topFaceCount:c}=e,l=o.data,f=r,g=t.attributes.get($.POSITION).indices,y=a+c,b=i+r,x=S(3*f);for(let t=0;t<f;++t){const e=3*t;x[e+0]=0,x[e+1]=0,x[e+2]=0}const _=Zt,P=qt,C=Jt,O=Kt,j=Gt;for(let t=a;t<y;++t){const e=3*t;for(let t=0;t<3;++t){const o=g[e+t];O[t]=o;const n=3*o;p(Nt,l[n+0],l[n+1],l[n+2]),h(_[t],Nt,s)}u(P,_[1],_[0]),u(C,_[2],_[0]),m(j,P,C),d(j,j);for(let t=0;t<3;++t){const e=3*(O[t]-i);x[e+0]+=j[0],x[e+1]+=j[1],x[e+2]+=j[2]}}for(let t=i;t<b;++t){const e=3*(t-i),s=x[e+0],o=x[e+1],r=x[e+2],a=Math.sqrt(s*s+o*o+r*r);ct(n,t,s/a,o/a,r/a)}}const Nt=b(),Gt=b(),Ft=new U,kt=[0,2,1],Ht=[0,1,2],Wt=.01,Zt=[b(),b(),b()],qt=b(),Jt=b(),Kt=[0,0,0];var Qt;!function(t){t[t.Main=0]="Main",t[t.Bottom=1]="Bottom"}(Qt||(Qt={}));class Xt{constructor(t,e,s,o){this.positions=t,this.elevation=e,this.normals=s,this.heights=o}}class Yt{constructor(t,e,s,o){this.topVertexStart=t,this.topVertexCount=e,this.topFaceStart=s,this.topFaceCount=o}}export{wt as G,ft as P,dt as a,ut as b,ht as c,yt as d,It as e,mt as f,gt as g};
