/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../request.js";import{w as t,h as r}from"../core/lang.js";import o from"../core/Error.js";import{i as n}from"./mat4.js";import{c as a}from"./mat4f64.js";import{s,t as i,c as l}from"./vec3.js";import{b as c,c as u}from"./vec3f64.js";import{canProjectWithoutEngine as f}from"./projectionUtils.js";import p from"../geometry/SpatialReference.js";import{p as d}from"./projectVectorToVector.js";import{c as m,e as h,l as y,k as g}from"./aaBoundingRect.js";import{g as S}from"./sphere.js";import{f as b}from"./featurePopupQueryUtils.js";import w from"../rest/support/Query.js";import{r as I,g as M}from"./I3SBinaryReader.js";import{U as T}from"./unitUtils.js";import{c as v}from"./computeTranslationToOriginAndRotation.js";import{c as E,a as R}from"./edgeUtils.js";import{p as x,C as j}from"./NormalAttribute.glsl.js";import{O as C,a as N}from"./orientedBoundingBox.js";import{s as U}from"./layerViewUtils.js";function k(e,t,r,o,n){const s="east-north-up"===r?c(e):function(e,t,r){const o=u(),n=e[3],a=2**(Math.ceil(Math.log(n)*Math.LOG2E/D)*D+O);if(r.isGeographic){const t=a/T(r).radius*180/Math.PI,n=Math.round(e[1]/t),s=Math.max(-90,Math.min(90,n*t)),i=t/Math.cos((Math.abs(s)-t/2)/180*Math.PI),l=Math.round(e[0]/i)*i;o[0]=l,o[1]=s}else{const t=Math.round(e[0]/a),r=Math.round(e[1]/a);o[0]=t*a,o[1]=r*a}const s=e[2]+t,i=Math.round(s/a);return o[2]=i*a,o}(e,t,o),i=a();return v(o,s,i,n),i}const O=1,D=5-O;function W(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}function _(e){if(r("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1}function A(e,t,r,o){r.traverse(t,(t=>{const r=t.serviceMbsInIndexSR;return(null!=r&&F(e,r))!==P.OUTSIDE&&(o(t),!0)}))}function G(e,t,r){let o=0,n=0;for(let a=0;a<t.length&&o<e.length;a++)e[o]===t[a]&&(r(a)&&(e[n]=e[o],n++),o++);e.length=n}function K(e,r,o){let n=0,a=0;for(;n<o.length;)t(e,o[n])>=0===r&&(o[a]=o[n],a++),n++;o.length=a}function L(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return q[0]=(e[0]-t.position[0])/t.rotationScale[0],q[1]=(e[1]-t.position[1])/t.rotationScale[4],q[2]=(e[2]-t.position[0])/t.rotationScale[0],q[3]=(e[3]-t.position[1])/t.rotationScale[4],q}const q=m();var P;function F(e,t){const r=t[0],o=t[1],n=t[3],a=e[0]-r,s=r-e[2],i=e[1]-o,l=o-e[3],c=Math.max(a,s,0),u=Math.max(i,l,0),f=c*c+u*u;return f>n*n?P.OUTSIDE:f>0?P.INTERSECTS_CENTER_OUTSIDE:-Math.max(a,s,i,l)>n?P.INSIDE:P.INTERSECTS_CENTER_INSIDE}function B(e,t,r){const o=[],n=r?.missingFields,a=r?.originalFields;let s=!1;for(const r of e){const e=t.get(r);e?(a?.push(r),o.push(e.name),r!==e.name&&(s=!0)):n?.push(r)}return r&&"hasMismatchedCasing"in r&&(r.hasMismatchedCasing=s),o}async function z(e,t,r,n,a,s){if(0===t.length)return[];const i=e.attributeStorageInfo;if(null!=e.associatedLayer)try{return await async function(e,t,r,o){const n=[],a={hasMismatchedCasing:!1,originalFields:n},s=B(r,e.fieldsIndex,a),i=new w({outFields:[...s]});if(await b(e,t,i,{updateSourceAttributes:!0,...o}),!a.hasMismatchedCasing)return t;for(let e=0;e<t.length;e++){const r=t[e];if(r.attributes)for(let e=0;e<n.length;e++){const t=n[e],o=s[e];o in r.attributes&&(r.attributes[t]=r.attributes[o],delete r.attributes[o])}}return t}(e.associatedLayer,t,n,s)}catch(t){if(e.associatedLayer.loaded)throw t}if(i){const o=function({globalIdField:e},t,r,o){const n=new Map,a=[],s=o();for(const o of t){const t=o.attributes?.[r],i=null==t?o.getGlobalId():void 0;for(let r=0;r<s.length;r++){const l=s[r],c=V(l,t,e,i);if(c<0)continue;let u=n.get(l.node);u||(u={node:l.node,indices:[],graphics:[]},a.push(u),n.set(l.node,u)),u.indices.push(c),u.graphics.push(o);for(let e=r;e>0;e--)s[e]=s[e-1];s[0]=l;break}}return a}(e,t,r,a),l=e.parsedUrl.path;return await Promise.allSettled(o.map((t=>function(e,t,r,o,n,a,s,i){return $(e,t,r.resources.attributes,o,n,a,s,i)}(l,i,t.node,t.indices,n,e.apiKey,e.customParameters,s).then((e=>{for(let r=0;r<t.graphics.length;r++){const o=t.graphics[r],n=e[r];if(o.attributes)for(const e in o.attributes)e in n||(n[e]=o.attributes[e]);o.attributes=n}}))))),t}throw new o("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function V(e,t,r,o){if(null!=t&&"number"==typeof t)return e.featureIds.indexOf(t);if(null==o||null==r)return-1;const n=e.attributeInfo?.attributeData?.[r];return n?n.indexOf(o):-1}async function $(t,r,o,n,a,s,i,l){const c=[];for(const e of r)if(e&&a.includes(e.name)){const r=`${t}/nodes/${o}/attributes/${e.key}/0`;c.push({url:r,storageInfo:e})}const u=await Promise.allSettled(c.map((t=>e(t.url,{responseType:"array-buffer",query:{...i,token:s},signal:l?.signal}).then((e=>I(t.storageInfo,e.data)))))),f=[];for(const e of n){const t={};for(let r=0;r<u.length;r++){const o=u[r];if("fulfilled"===o.status){const n=o.value;t[c[r].storageInfo.name]=M(n,e)}}f.push(t)}return f}function Q(e){const t=e.store,r=t.indexCRS||t.geographicCRS,n=void 0===r?t.indexWKT:void 0;if(n){if(!e.spatialReference)throw new o("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new o("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=r?new p(W(r)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function Z(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,n=void 0===r?t.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new o("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new o("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=r?new p(W(r)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function H(e,t,r){if(!f(e,t))throw U("scene layer",e?.wkid,t?.wkid);if("local"===r&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}(e,t))throw U("scene layer",e?.wkid,t?.wkid)}function J(e,t,r){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new o("layerview:recycle-failed","Could not recycle layerview")}function X(e,t,r){const o=Q(e),n=Z(e);H(o,t,r),H(n,t,r)}function Y(e){if(null==e.store?.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes?.position)throw new o("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function ee(e,t){X(e,t.spatialReference,t.viewingMode)}function te(e){if(null==e.store?.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes?.position)throw new o("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function re(e,t){H(e.spatialReference,t.spatialReference,t.viewingMode)}function oe(e){return"mesh-3d"===e.type}function ne(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.symbols;if(0===t.length)return!0;for(const e of t){if(!oe(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||null==t.material?.color||"replace"!==t.material.colorMixMode)return!0}return!1}!function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"}(P||(P={}));const ae=E({color:[0,0,0,0],opacity:0});class se{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function ie(e){const t=new se;let r=!1,o=!1;for(const n of e.symbolLayers.items)if("fill"===n.type&&n.enabled){const e=n.material,a=n.edges;if(null!=e&&!r){const o=e.color,a=x(e.colorMixMode);t.material=null!=o?{color:[o.r/255,o.g/255,o.b/255],alpha:o.a,colorMixMode:a}:{color:[1,1,1],alpha:1,colorMixMode:j.Multiply},t.castShadows=n.castShadows,r=!0}null==a||o||(t.edgeMaterial=R(a,{}),o=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:j.Multiply}),t}function le(e,t){return(0|e)+(0|t)|0}function ce(e,t,r,o,a,c,u){if(!c||0===c.length||null==t||!e.serviceMbsInIndexSR)return null;const f=k(e.serviceMbsInIndexSR,a,"none",r,t);n(Se,f);let p=null,m=1/0,b=-1/0;if(c.forEach((n=>(n=>{if("replace"!==n.type)return;const c=n.geometry;if(!c?.hasZ)return;h(de);const f=c.spatialReference||o,w=c.rings.reduce(((e,r)=>r.reduce(((e,r)=>(s(ye,r[0],r[1],r[2]),d(ye,f,ye,t),i(ye,ye,Se),y(de,ye),Math.min(ye[2],e))),e)),1/0);(()=>{if(!p)if(p=pe,h(me),null!=e.serviceObbInIndexSR){e.serviceObbInIndexSR.transform(he,r,t,a,u),he.getCorners(p);for(const e of p)i(e,e,Se),y(me,e)}else{const o=e.serviceMbsInIndexSR;if(!o)return;const n=o[3];d(S(o),r,ye,t),i(ye,ye,Se),ye[2]+=a;for(let e=0;e<8;++e){const t=1&e?n:-n,r=2&e?n:-n,o=4&e?n:-n,a=p[e];l(a,[ye[0]+t,ye[1]+r,ye[2]+o]),y(me,a)}}})(),g(me,de)&&(m=Math.min(m,w),b=Math.max(b,w))})(n))),m===1/0)return null;for(let e=0;e<8;++e)w=ge.data,I=3*e,M=p[e],i(ye,M,f),w[I]=ye[0],w[I+1]=ye[1],w[I+2]=ye[2],I+=24,M[2]=m,i(ye,M,f),w[I]=ye[0],w[I+1]=ye[1],w[I+2]=ye[2],I+=24,M[2]=b,i(ye,M,f),w[I]=ye[0],w[I+1]=ye[1],w[I+2]=ye[2];var w,I,M;return N(ge)}function ue(e){return e[3]>=0}function fe(e){null!=e&&(e[3]=-1)}const pe=[u(),u(),u(),u(),u(),u(),u(),u()],de=m(),me=m(),he=new C,ye=u(),ge={data:new Array(72),size:3,exclusive:!0,stride:3},Se=a();export{P as M,B as a,X as b,J as c,_ as d,H as e,G as f,Q as g,te as h,fe as i,re as j,ue as k,Y as l,ee as m,ce as n,K as o,k as p,$ as q,ne as r,F as s,le as t,ie as u,ae as v,z as w,L as x,Z as y,A as z};
