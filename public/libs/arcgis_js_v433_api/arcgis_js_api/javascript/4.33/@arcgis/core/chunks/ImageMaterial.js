/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{A as e,p as t}from"./BufferView.js";import{S as s,i as r,f as i,a}from"./ShaderOutput.js";import{C as o}from"./basicInterfaces.js";import{b as n,t as l,S as p,K as c,o as u,C as d,d as h,l as f,m,R as v,L as g,s as T,p as P,q as I,x,u as _,v as D,Q as E,M as b,N as S,E as w,P as y,i as A,U as C,W as O}from"./Matrix4PassUniform.js";import{i as j}from"./ITexture.js";import{O as N,D as V,a as R}from"./Material.js";import{V as M}from"./VertexAttribute.js";import{T as L,D as F}from"./VertexColor.glsl.js";import{P as B}from"./DefaultLayouts.js";import{T as U}from"./TriangleMaterial.js";import{I as W,g as z}from"./glsl.js";import{N as q,p as H}from"./ShaderTechniqueConfiguration.js";import{S as Q}from"./ShaderBuilder.js";import{m as $,d as k,c as G,p as K}from"./renderState.js";import{_ as J}from"./tslib.es6.js";const X=Object.freeze(Object.defineProperty({__proto__:null,ImageMaterialPassParameters:class extends q{},build:function(e){const t=new Q,{vertex:r,fragment:i,varyings:a}=t,{output:o,perspectiveInterpolation:m}=e;return n(r,e),t.include(L,e),t.include(l,e),t.fragment.include(p,e),t.include(c,e),t.include(u,e),t.attributes.add(M.POSITION,"vec3"),t.attributes.add(M.UV0,"vec2"),m&&t.attributes.add(M.PERSPECTIVEDIVIDE,"float"),r.main.add(z`
    vpos = position;
    forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
    vTexCoord = uv0;
    gl_Position = transformPosition(proj, view, vpos);
    ${W(m,"gl_Position *= perspectiveDivide;")}`),a.add("vpos","vec3",{invariant:!0}),a.add("vTexCoord","vec2"),i.include(d),i.uniforms.add(new h("opacity",(e=>e.opacity)),new f("tex",(e=>e.glTexture))).main.add(z`
    discardBySlice(vpos);
    discardByTerrainDepth();
    ${W(o===s.ObjectAndLayerIdColor,"fragColor = vec4(0, 0, 0, 1); return;")}
    vec4 finalColor = texture(tex, vTexCoord) * opacity;
    outputColorHighlightOID(finalColor, vpos, finalColor.rgb);`),t}},Symbol.toStringTag,{value:"Module"}));class Y extends m{constructor(e,t){super(e,t,new v(X,(()=>Promise.resolve().then((()=>X)))),Z)}_getPipelineState(e,t){const{oitPass:s,output:i,hasOccludees:a,cullFace:o}=e,n=s===N.NONE;return $({blending:r(i)?n?K:E(s):null,culling:G(o),depthTest:{func:D(s)},depthWrite:_(e),drawBuffers:x(s,i),colorWrite:k,stencilWrite:a?I:null,stencilTest:a?t?T:P:null,polygonOffset:g(e)})}initializePipeline(e){return this._occludeePipeline=this._getPipelineState(e,!0),this._getPipelineState(e,!1)}getPipeline(e){return e?this._occludeePipeline:super.getPipeline()}}const Z=new Map([[M.POSITION,0],[M.UV0,2],[M.PERSPECTIVEDIVIDE,3]]);class ee extends V{constructor(e){super(),this.draped=e,this.cullFace=o.None,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.perspectiveInterpolation=!0,this.textureCoordinateType=b.None,this.emissionSource=S.None,this.discardInvisibleFragments=!0,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1,this.snowCover=!1}}J([H({count:o.COUNT})],ee.prototype,"cullFace",void 0),J([H()],ee.prototype,"enableOffset",void 0),J([H()],ee.prototype,"writeDepth",void 0),J([H()],ee.prototype,"hasOccludees",void 0),J([H()],ee.prototype,"terrainDepthTest",void 0),J([H()],ee.prototype,"cullAboveTerrain",void 0),J([H()],ee.prototype,"perspectiveInterpolation",void 0);class te extends U{constructor(e){super(e,ie),this.vertexAttributeLocations=Z,this.supportsEdges=!0,this.produces=new Map([[w.OPAQUE_MATERIAL,e=>i(e)],[w.TRANSPARENT_MATERIAL,e=>a(e)&&this.parameters.writeDepth],[w.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,e=>a(e)&&!this.parameters.writeDepth],[w.DRAPED_MATERIAL,e=>a(e)||i(e)]]),this._configuration=new ee(e.draped)}dispose(){this.setParameters({texture:void 0})}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=t.hasOccludees,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<y,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.perspectiveInterpolation=this.parameters.perspectiveInterpolation,this._configuration}get visible(){return!0}createGLMaterial(e){return new se(e)}createBufferWriter(){let e=B;return this.parameters.perspectiveInterpolation&&(e=e.clone().f32(M.PERSPECTIVEDIVIDE)),new re(e)}}class se extends A{constructor(e){super({...e,...e.material.parameters}),this.parameters=e;const t=this._material.parameters.texture;j(t)&&e.textures.updater.add(t)}dispose(){this.parameters.textures.updater.remove(this._material.parameters.texture)}beginSlot(e){return this.getTechnique(Y,e)}}class re extends F{write(s,r,i,a,o,n){for(const a of this.vertexBufferLayout.fields.keys()){const l=i.get(a);if(l)if(a===M.PERSPECTIVEDIVIDE){e(1===l.size);const s=o.getField(a,t);s&&C(l,s,n)}else O(a,l,s,r,o,n)}return null}}class ie extends R{constructor(e,t){super(),this.texture=e,this.draped=t,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=o.None,this.opacity=1,this.perspectiveInterpolation=!1}get glTexture(){return this.texture.glTexture}}export{te as I};
