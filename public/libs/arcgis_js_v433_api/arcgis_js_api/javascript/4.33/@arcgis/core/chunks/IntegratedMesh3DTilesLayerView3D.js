/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Error.js";import{h as s}from"../core/lang.js";import{L as i}from"./Logger.js";import{d as o}from"./maybe.js";import{initial as r,watch as a}from"../core/reactiveUtils.js";import{schedule as n}from"../core/scheduling.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{f as l,i as c}from"./mat3.js";import{c as d,I as j}from"./mat3f64.js";import{v as u,w as h}from"./mat4.js";import{c as y}from"./mat4f64.js";import{f as g}from"./quatf64.js";import{i as f,q as b}from"./vec3.js";import{a as w,c as v}from"./vec3f64.js";import{f as _}from"./vec4f64.js";import{A as U}from"./unitUtils.js";import{c as C}from"./computeTranslationToOriginAndRotation.js";import{L as T,l as M,O as S,T as x}from"./Transform.js";import{p as P}from"./projectVectorToVector.js";import{c as O}from"./aaBoundingRect.js";import{a as E,g as I,n as D,y as A,d as V,C as L,D as R,J as F,z as B,s as k}from"./BufferView.js";import{a as H,b as G,c as N,d as W,e as z,f as q,g as Z,h as J,j as Q}from"./ILyr3DWasmPerSceneView.js";import $ from"../layers/support/SceneModification.js";import{p as X}from"./elevationInfoUtils.js";import{V as K}from"./ViewingMode.js";import{t as Y}from"./I3SMeshWorkerHandle.js";import{L as ee}from"./LayerViewPerformanceInfo.js";import{a as te}from"./GridLocalOriginFactory.js";import{L as se}from"./LayerView3D.js";import{a as ie,r as oe,g as re}from"../widgets/Attribution/AttributionViewModel.js";import{A as ae,C as ne,T as pe}from"./basicInterfaces.js";import{e as me,T as le}from"./enums.js";import ce from"../Graphic.js";import{T as de}from"./intersectorUtilsConversions.js";import{I as je,S as ue,a as he}from"./IntersectorResult.js";import{M as ye}from"./VertexColor.glsl.js";import{E as ge}from"./ElevationRange.js";import{T as fe,t as be}from"./TextureCompressionTracker.js";import{O as we,a as ve,A as _e}from"./orientedBoundingBox.js";import{G as Ue,c as Ce,d as Te,e as Me}from"../views/SceneView.js";import{R as Se}from"./RenderTexture.js";import{M as xe,W as Pe,X as Oe,T as Ee}from"./Matrix4PassUniform.js";import{b as Ie}from"./Normals.js";import{V as De}from"./VertexAttribute.js";import Ae from"../views/layers/LayerView.js";import{c as Ve}from"./layerViewUtils.js";import{a as Le}from"./AlphaCutoff.js";import"../config.js";import"./events.js";import"./handleUtils.js";import"../core/promiseUtils.js";import"./watch.js";import"./ObjectPool.js";import"./SetUtils.js";import"./get.js";import"./utils.js";import"./Lifecycle.js";import"./tracking.js";import"./SimpleTrackingTarget.js";import"./nextTick.js";import"./PooledArray.js";import"./ensureType.js";import"./MapUtils.js";import"./metadata.js";import"./Warning.js";import"./common.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"./mathUtils.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ObservableBase.js";import"../core/Evented.js";import"./projectBoundingSphere.js";import"./sphere.js";import"./vec4.js";import"./Axis.js";import"./ray.js";import"./vector.js";import"./vec2f64.js";import"./Intersector2.js";import"./dehydratedFeatureUtils.js";import"../views/3d/webgl/RenderCamera.js";import"./screenUtils.js";import"./vec2.js";import"./frustum.js";import"./plane.js";import"./mathUtils2.js";import"./HUDIntersectorResult.js";import"./verticalOffsetUtils.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./boundsUtils.js";import"../geometry/Polyline.js";import"./projectPointToVector.js";import"./projectionUtils.js";import"./SimpleObservable.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./dehydratedPoint.js";import"./persistable.js";import"./MD5.js";import"./multiOriginJSONSupportUtils.js";import"./uuid.js";import"./resourceExtension.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./WorkerHandle.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./date.js";import"./locale.js";import"./constants.js";import"./datetime.js";import"./number2.js";import"./substitute.js";import"./messages.js";import"./RibbonLineMaterial.js";import"./Octree.js";import"./lineSegment.js";import"./InterleavedLayout.js";import"./types.js";import"./ShaderOutput.js";import"./Matrix4BindUniform.js";import"./BindType.js";import"./Material.js";import"./ShaderTechniqueConfiguration.js";import"./boundedPlane.js";import"./glsl.js";import"./Float4DrawUniform.js";import"./floatRGBA.js";import"./Texture.js";import"./FBOAttachmentType.js";import"./getDataTypeBytes.js";import"./GeometryUtil.js";import"./vec3f32.js";import"./aaBoundingBox.js";import"./Indices.js";import"./ShaderBuilder.js";import"./renderState.js";import"./heightModelInfoUtils.js";import"../geometry/HeightModelInfo.js";import"./asyncUtils.js";import"../core/Collection.js";import"./shared.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./guards.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"./colorUtils2.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../geometry/support/jsonUtils.js";import"./typeUtils2.js";import"./createFeatureId.js";import"./typeUtils.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils5.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils6.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./Intersector.js";import"./Matrix3DrawUniform.js";import"./ElevationContext.js";import"./hydratedFeatures.js";import"./debugFlags2.js";import"./triangle.js";import"./graphicUtils.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"./vec2f32.js";import"./HUDVisibility.glsl.js";import"./VerticalOffset.glsl.js";import"./BooleanBindUniform.js";import"./HUDRenderStyle.js";import"./memoryEstimations.js";import"./projectBoundingRect.js";import"./dehydratedFeatures.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./edgeUtils.js";import"./NormalAttribute.glsl.js";import"./primitiveObjectSymbolUtils.js";import"./DefaultMaterial.js";import"./SceneLighting.js";import"../views/3d/webgl.js";import"../views/3d/webgl/RenderNode.js";import"./Matrix4sPassUniform.js";import"./Scheduler.js";import"./signal.js";import"./debugFlags.js";import"./quat.js";import"./spatialReferenceEllipsoidUtils.js";import"../Camera.js";import"../CameraLayout.js";import"./Cyclical.js";import"../Viewpoint.js";import"./domUtils.js";import"./GraphicsCollection.js";import"./RenderCoordsHelper.js";import"./projectVectorToPoint.js";import"./scaleUtils.js";import"./layerUtils.js";import"../layers/catalog/catalogUtils.js";import"../views/View.js";import"../Map.js";import"../Basemap.js";import"./loadAll.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./basemapDefinitions.js";import"../support/BasemapStyle.js";import"./writeUtils.js";import"../Ground.js";import"./groundInstanceUtils.js";import"./CollectionFlattener.js";import"../effects/FocusAreas.js";import"../effects/FocusArea.js";import"../effects/FocusAreaOutline.js";import"./PolygonCollection.js";import"./editableLayers.js";import"./basemapEnsureType.js";import"./basemapUtils.js";import"./utils2.js";import"./collectionUtils2.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../time/TimeExtent.js";import"./timeUtils.js";import"../support/TablesMixin.js";import"./UpdatingHandles.js";import"./timeZoneUtils.js";import"../views/BasemapView.js";import"../views/Magnifier.js";import"./SelectionManager.js";import"./ReactiveMap.js";import"../rest/support/Query.js";import"./DataLayerSource.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"./selectionUtils.js";import"../views/Theme.js";import"./InputManager.js";import"./ViewEvents.js";import"./IViewEvents.js";import"./interfaces2.js";import"./keybindings.js";import"./screenUtils2.js";import"./HighlightDefaults.js";import"../views/support/HighlightOptions.js";import"../views/input/Input.js";import"../views/input/gamepad/GamepadSettings.js";import"../views/input/gamepad/GamepadInputDevice.js";import"../views/navigation/Navigation.js";import"./a11yUtils.js";import"../views/navigation/NavigationActionMap.js";import"../views/navigation/gamepad/GamepadSettings.js";import"./projectionUtils2.js";import"./tagSymbols.js";import"../views/BreakpointsOwner.js";import"../views/DOMContainer.js";import"./projector.js";import"./sanitizerUtils.js";import"../views/GroundView.js";import"./cameraUtils.js";import"./DepthRange.js";import"./earthUtils.js";import"./spatialReferenceSupport.js";import"../layers/support/ElevationSampler.js";import"./TerrainConst.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"./TileKey.js";import"../views/PopupView.js";import"../views/ViewAnimation.js";import"./RenderGeometry.js";import"./axisAngleDegrees.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./VertexElementDescriptor.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./NestedMap.js";import"./FramebufferObject.js";import"./glUtil.js";import"./ShadowCastVisualizeTechniqueConfiguration.js";import"./SunCalc.js";import"../views/3d/environment/SunLighting.js";import"../webscene/SunLighting.js";import"../views/3d/environment/VirtualLighting.js";import"../webscene/VirtualLighting.js";import"../webscene/Environment.js";import"./lightingTypes.js";import"../webscene/background/Background.js";import"../webscene/background/ColorBackground.js";import"./easing.js";import"./unitBezier.js";import"./Animation.js";import"./ray2.js";import"./viewpointUtils2.js";import"./RenderFeature.js";import"../views/ui/UI.js";import"./modeUtils.js";import"./widgetUtils.js";import"./unitFormatUtils.js";import"./ByteSizeUnit.js";import"./quantityUtils.js";import"../widgets/Widget.js";import"./componentsUtils.js";import"./jsxWidgetSupport.js";import"./messageBundle.js";import"./jsxFactory.js";import"./ZoomMomentumEstimator.js";import"./HUDMaterial.js";import"./labelFormatUtils.js";import"./labelUtils.js";import"./ArcadeExpression.js";import"./TimeOnly.js";import"./enum.js";import"./UnknownTimeZone.js";import"../layers/support/FieldsIndex.js";import"./NormalUtils.glsl.js";import"./fontUtils.js";import"./placementUtils.js";import"./hitTest.js";import"./LayerConstants.js";import"./hitTestSelectUtils.js";import"./MemCache.js";import"./terrainUtils.js";import"../views/3d/support/SceneViewPerformanceInfo.js";import"../views/3d/support/LayerPerformanceInfo.js";import"./DefaultLoadingContext.js";import"./wosrLoader.js";import"./Version.js";import"./requestImageUtils.js";import"./mapCollectionUtils.js";import"./ElevationQueryTileCache.js";import"./ElevationSamplerData.js";import"./TileStrategy.js";import"./TileKey2.js";import"./ScheduledQueueProcessor.js";import"./enums5.js";import"./mat3f32.js";import"./SymbolRepository.js";import"./config.js";import"./StyleDefinition.js";import"./enums2.js";import"./TiledDisplayObject.js";import"./DisplayObject.js";import"./definitions.js";import"./GeometryUtils.js";import"./RenderableTile.js";import"./resources.js";import"./colorUtils.js";import"./vec32.js";import"./vec33.js";import"./BlendColorsPremultiplied.glsl.js";import"./vec4f32.js";import"../views/3d/webgl/ManagedFBO.js";import"./testSVGPremultipliedAlpha.js";import"./RenderingContext.js";import"./ProgramCache.js";import"./Program.js";import"./capabilities2.js";import"./ITexture.js";import"./screenshotUtils.js";import"./imageUtils.js";import"./makeScheduleFunction.js";import"./WebGLRequirements.js";import"../views/ui/DefaultUI.js";import"../widgets/Attribution.js";import"./globalCss.js";import"./accessibleHandler.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"./utils24.js";import"../widgets/support/GoTo.js";import"./goToUtils.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";import"./videoUtils.js";import"./TextureFormat.js";class Re extends ee{constructor(e,t,s,i,o,r,a){super(e,0,0,0,t),this.nodesCached=s,this.vboMB=i,this.textureMB=o,this.vboMBCached=r,this.textureMBCached=a}}const Fe={[H.Points]:null,[H.Lines]:null,[H.LineStrip]:null,[H.Triangles]:me.TRIANGLES,[H.TriangleStrip]:me.TRIANGLE_STRIP,[H.NotSet]:null},Be={[G.Opaque]:ae.Opaque,[G.Mask]:ae.Mask,[G.Blend]:ae.Blend},ke={[N.Back]:ne.Back,[N.Front]:ne.Front,[N.None]:ne.None,[N.NotSet]:ne.Back},He={[W.WrapYBit]:{s:le.CLAMP_TO_EDGE,t:le.REPEAT},[W.WrapXBit]:{s:le.REPEAT,t:le.CLAMP_TO_EDGE},[W.WrapXy]:{s:le.REPEAT,t:le.REPEAT},[W.None]:{s:le.CLAMP_TO_EDGE,t:le.CLAMP_TO_EDGE},[W.NotSet]:{s:le.CLAMP_TO_EDGE,t:le.CLAMP_TO_EDGE}},Ge={[z.U8]:1,[z.I8]:1,[z.U16]:2,[z.I16]:2,[z.U32]:4,[z.I32]:4,[z.F32]:4,[z.F64]:8,[z.Utf8String]:1,[z.NotSet]:1};class Ne{constructor(e){this.type=je.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerViewUid=e.uid}intersect(e,t,s,i,o,r){if(e.options.filteredLayerViewUids.includes(this.layerView.uid))return;const a=e.results,n=e.options.store===ue.ALL,p=this.layerView.view.stage.renderView.componentObjectCollection,m=new ye(r,e.options.normalRequired);this.layerView.objects.forEach((o=>{o.visible&&o.intersectionGeometry&&p.intersect(o,s,i,e.tolerance,null,m,((o,r,p,m)=>{if(r>=0){if(null!=t&&!t(s,i,r))return;const o=e=>{const t=new de(this.layerView.layer.uid,(()=>this._createTiles3DGraphic(this.layerView.layer,{})));e.set(this.type,t,r,p)};if(this.isGround&&(null==a.ground.distance||r<a.ground.distance)&&o(a.ground),e.options.isFiltered)return;if((null==a.min.distance||r<a.min.distance)&&o(a.min),(null==a.max.distance||r>a.max.distance)&&o(a.max),n){const t=new he(e.ray);o(t),e.results.all.push(t)}}}))}))}_createTiles3DGraphic(e,t){return new ce({layer:e,sourceLayer:e,attributes:t})}}var We;!function(e){e[e.API=1]="API",e[e.VerboseAPI=2]="VerboseAPI",e[e.Error=3]="Error"}(We||(We={}));class ze{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.textureMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.textureMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}}function qe(e){return Math.round(e/1048.576)/1e3}let Ze=class extends(se(Ae)){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._compressionTracker=new fe,this._modifications=new Array,this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=te.WithoutRasterImage,this._applySSAO=!s("disable-feature:im-ssao"),this._shadeNormals=!!s("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}get hasModifications(){return this._modifications&&this._modifications.length>0}initialize(){if(this._dbgFlags.add(We.Error),this._dbg(We.VerboseAPI,"Tiles3DLayerView3D initialize() called"),this._updatingHandles.add((()=>this.layer.modifications),(()=>this._loadModifications()),r),!this._canProjectWithoutEngine())throw new t("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const e=ie(this).then((e=>{this._wasmLayerId=e,this._intersectionHandler=new Ne(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(e))),this._updatingHandles.add((()=>this._modifications),(()=>this._modificationsChanged()),r),this._updatingHandles.add((()=>this.view.clippingArea),(()=>this._clippingAreaChanged()),r),this._elevationProvider=new T({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this);const t=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,(e=>this._onRemoveFromCache(e)));this._memCache=t,this.addHandles([a((()=>this.layer.elevationInfo),(e=>this._elevationInfoChanged(e)))]),this._suspendedHandle=a((()=>this.suspended),(e=>this._wasm?.setEnabled(this,!e)),r)}));this.addResolvingPromise(e)}destroy(){this._dbg(We.VerboseAPI,"Tiles3DLayerView3D destroy() called"),oe(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach((e=>this.freeObject(e))),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=o(this._memCache),this._updatingHandles=o(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_modificationsChanged(){const e=this.layer.spatialReference,t=Y(this._layerClippingArea,this._modifications,e);this._wasm?.setMeshModifications(this,t,e.wkid)}_clippingAreaChanged(){const e=this.layer.spatialReference,t=O();this._layerClippingArea=be(this.view.clippingArea,t,e)?t:null,this._modificationsChanged()}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=n((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.objects.forEach((t=>{const s=this._collection.getMaterial(t);s.commonMaterialParameters.hasSlicePlane=e,s.commonMaterialParameters.cullFace=e?ne.None:this._initialCullFace.get(t)}))}_elevationInfoChanged(e){this._wasm?.setLayerOffset(this,X(e))}get _obbs(){return this.objects.map((e=>this._collection.getComponentObb(e)))}get _wasm(){return re(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible&&(e+=t.usedMemory)})),e}get unloadedMemory(){return 0}get cachedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible||(e+=t.usedMemory)})),e}get visibleAtCurrentScale(){return Ve(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let e=0,t=0,s=0,i=0,o=0,r=0;return this._lyrHandleToObjects.forEach((a=>{a.isVisible?(e+=a.textureMemoryUsage,t+=a.vboMemoryUsage,o++):(s+=a.textureMemoryUsage,i+=a.vboMemoryUsage,r++)})),new Re(this.usedMemory,o,r,qe(t),qe(e),qe(i),qe(s))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===K.Local){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==e&&32662!==e)return!1}return!0}get _stage(){return this.view.stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return X(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new ge(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce(((e,t)=>e.concat(t.components)),new Array)}isUpdating(){const e=this._wasm;return!(this._wasmLayerId<0||null==e)&&(e.isUpdating(this._wasmLayerId)||this._compressionTracker.compressing)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(null==t.data)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),null==t.desc)throw new Error("meshData.desc undefined");const s=w(t.desc.origin),i=new Array,o=new Map,r=new ze;r.handle=e.handle,this._lyrHandleToObjects.set(e.handle,r);const a=this.view.basemapTerrain.spatialReference;let n,p;if("global"===this.view.viewingMode){const e=y();C(U,s,e,a),n=l(d(),e),p=c(d(),n)}else n=j,p=j;const m=y();u(m,m,s);const T=h(v(),m);let O=null;const I=v();if(t.desc.obb){const e=t.desc.obb.quaternion;O=new we(t.desc.obb.center,t.desc.obb.halfSize,g(e[0],e[1],e[2],e[3]))}for(let e=0;e<t.desc.prims.length;e++){const m=t.desc.prims[e];if(this._dbg(We.VerboseAPI,JSON.stringify(m)),null==Fe[m.ptype]||null==t.data){this._dbg(We.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+m.ptype+"). Skipping primitive.");continue}const l=t.desc?.materials&&null!=m.materialId?t.desc.materials[m.materialId]:null,c=null!=l?l.lightingModel:q.Unlit,{positionView:d,positionAttr:u,normalsView:h,normalsAttr:y,colorAttr:g,texCoord0Attr:w,indicesView:U}=this.getBufferViews(m,t.data.buffer,n);if(null==u||null==d||null==U)continue;const C=new Ue(null!=g,w?xe.Default:xe.None,null!=h,this._shadeNormals,this._applySSAO),D=u.data.length/u.size,A=(e,t)=>!e||e.data.length/e.size===D||(this._dbg(We.Error,`${t} !== numPos. Skipping primitive.`),!1);if(!A(w,"numTexcoord")||!A(g,"numColors")||!A(y,"normals"))continue;const V=Ce(C);if(null!=O?O=O.clone():(O=ve(u),f(I,O.center,s),O.center=I),n!==j)for(let e=0;e<d.count;e++)d.getVec(e,I),b(I,I,n),d.setVec(e,I);const L=V.createBuffer(u.data.length);if(Pe(De.POSITION,u,null,null,L,0),null!=w){const e=L.getField(De.UV0,E);Oe(w,e,0)}null!=g&&Pe(De.COLOR,u,null,null,L,0),null!=y&&Pe(De.NORMALCOMPRESSED,y,null,null,L,0);const R=new Uint32Array([0,U.typedBuffer.length]),F={vertices:{data:L.buffer,count:L.byteLength/V.stride,layoutParameters:C},positionData:{positions:d.typedBuffer,indices:U.typedBuffer},indices:U.typedBuffer,componentOffsets:R};r.cpuMemoryUsage+=d.count,r.cpuMemoryUsage+=U.count;const B=this.view.renderSpatialReference,k=v(),H=[1,1,1];M(T,B,H,a)||this._dbg(We.Error,"Unsupported coordinate system for IM overlay"),P(T,B,k,a);const G=this._collection.createObject(new S(_(k[0],k[1],H[0],H[1]),new x(T,p),O,F));l&&this._collection.updateMaterial(G,(e=>{e.baseColor=l.baseColorFactor,e.usePBR=c===q.Pbr,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(l.baseColorTex,t,o,r),e.usePBR&&(e.mrrFactors=[l.metallicFactor,l.roughnessFactor,0],e.emissiveBaseColor=l.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(l.metalTex,t,o,r),e.emissionTexture=this._getTexture(l.emissiveTex,t,o,r),e.occlusionTexture=this._getTexture(l.occlusionTex,t,o,r),e.normalTexture=this._getTexture(l.normalTex,t,o,r)),e.objectOpacity=0,e.alphaDiscardMode=ae.Mask;const s=[];e.baseColorTexture&&s.push(e.baseColorTexture.loadPromise),e.usePBR&&e.metallicRoughnessTexture&&s.push(e.metallicRoughnessTexture.loadPromise),e.usePBR&&e.emissionTexture&&s.push(e.emissionTexture.loadPromise),e.usePBR&&e.occlusionTexture&&s.push(e.occlusionTexture.loadPromise),e.usePBR&&e.normalTexture&&s.push(e.normalTexture.loadPromise);const a=Promise.all(s);i.push(a),a.then((()=>{e.alphaDiscardMode=Be[l.alphaMode],e.objectOpacity=1,r.textureMemoryUsage+=e.baseColorTexture?.glTexture?.usedMemory||0,e.usePBR&&(r.textureMemoryUsage+=e.metallicRoughnessTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=e.emissionTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=e.occlusionTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=e.normalTexture?.glTexture?.usedMemory||0)})),e.commonMaterialParameters.doubleSided=l.isDoubleSided,e.commonMaterialParameters.cullFace=l.faceCulling?ke[l.faceCulling]:ne.Back,this._initialCullFace.set(G,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=Te.All,e.textureAlphaCutoff=l.alphaCutoff??Le,e.alphaDiscardMode=Be[l.alphaMode],e.isIntegratedMesh=!0,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=Me(this.view.spatialReference)})),r.components.push(G),r.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(G)}if(await Promise.all(i),o.forEach((e=>{r.textures.push(e)})),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${r.handle}`,r),{memUsageBytes:r.usedMemory}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache&&this._memCache.pop(`${e.handle}`),e.components.forEach((t=>{e.textures.forEach((e=>{this._stage.removeTexture(e)})),this._collection.destroyObject(t),this._initialCullFace.delete(t)}))}setRenderableVisibility(e,t,s){if(this._memCache){for(let i=0;i<s;++i){const s=e[i],o=t[i];if(!o)continue;const r=this._lyrHandleToObjects.get(s);r&&(this._visibleGeometryChanged(),r.isVisible=o,r.components.forEach((e=>{this._collection.setObjectVisibility(e,o),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.pop(`${s}`))}for(let i=0;i<s;++i){const s=e[i],o=t[i];if(o)continue;const r=this._lyrHandleToObjects.get(s);r&&(this._visibleGeometryChanged(),r.isVisible=o,r.components.forEach((e=>{this._collection.setObjectVisibility(e,o),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.put(`${s}`,r))}}}_getTexture(e,t,i,o){let r=null;if(e&&t.desc?.images&&t.data?.buffer){const a=t.desc.images[e?.imageId];if(r=i.get(a),!r&&a){const n=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,p=!!a.mipCount||n>1,m=He[e.wrapMode??W.None];let l=a.alpha?4:3;const c=new Uint8Array(t.data.buffer,a.data.byteOffset,a.data.byteCount);let d=null,j=null,u=null;switch(a.format){case Z.Raw:a.pixelFormat===J.R8?(d=c,l=1,j=""):a.pixelFormat===J.Rgb8?(d=c,l=3,j=""):a.pixelFormat===J.Rgba8&&(d=c,l=4,j="");break;case Z.Dxt1:d=c,l=3,j=pe.DDS_ENCODING;break;case Z.Dxt5:d=c,l=4,j=pe.DDS_ENCODING;break;case Z.Basis:d=c,l=3,j=pe.KTX2_ENCODING;break;case Z.Png:j="image/png",u=document.createElement("img");break;case Z.Jpeg:j="image/jpeg",u=document.createElement("img");break;case Z.Etc2:j="image/ktx",u=document.createElement("img");break;case Z.Astc:this._dbg(We.Error,"Astc texture not supported");break;case Z.Pvrtc:this._dbg(We.Error,"Pvrtc texture not supported")}if(u&&j){const e=new Blob([c],{type:j});u.src=URL.createObjectURL(e),d=u}if(d&&null!=j){const e=s("enable-feature:esri-compress-IM-textures")?{compressionTracker:this._compressionTracker,compressionCallback:e=>{e&&e>0&&(o.textureMemoryUsage-=e)}}:void 0;r=new Ee(d,{mipmap:p,maxAnisotropy:n,encoding:j,wrap:m,components:l,compressionOptions:e,noUnpackFlip:!0,width:a.mip0Width,height:a.mip0Height}),this._stage.addTexture(r),i.set(a,r)}}}return r?new Se(this.view.stage.renderView.textures,r.id):null}getBufferViews(e,t,s){let i,o,r,a,n,p,m,l=null;for(let m=0;m<e.atrbs.length;m++){const c=e.atrbs[m],d=c.view,j=void 0,u=d.byteOffset+d.byteCount,h=d.byteCount/Ge[d.type],y=[...Array(h).keys()].map((e=>e));try{switch(c.sem){case Q.Position:3!==d.ncomp||d.type!==z.F32?this._dbg(We.Error,"[Unsupported Feature] Unsupported view for Position ("+d+")"):(i=new V(t,d.byteOffset,j,u),o=new _e(i.typedBuffer,y,3));break;case Q.Normal:if(3!==d.ncomp||d.type!==z.F32)this._dbg(We.Error,"[Unsupported Feature] Unsupported view for Normal ("+d+")");else{const e=new V(t,d.byteOffset,j,u),i=Ie(e.typedBuffer,s);n=new F(i),p=new _e(n.typedBuffer,y,2)}break;case Q.TexCoord:2!==d.ncomp||d.type!==z.F32?this._dbg(We.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+d+")"):void 0===a&&(a=new _e(new E(t,d.byteOffset,j,u).typedBuffer,y,2));break;case Q.Color:4===d.ncomp?(d.type===z.F32&&(l=new I(t,d.byteOffset,j,u)),d.type===z.U8&&(l=new D(t,d.byteOffset,j,u)),d.type===z.U16&&(l=new A(t,d.byteOffset,j,u))):3===d.ncomp&&(d.type===z.F32&&(l=new V(t,d.byteOffset,j,u)),d.type===z.U8&&(l=new L(t,d.byteOffset,j,u)),d.type===z.U16&&(l=new R(t,d.byteOffset,j,u))),null==l?this._dbg(We.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+d+")"):r=new _e(l.typedBuffer,y,d.ncomp);break;case Q.FeatureIndex:break;default:this._dbg(We.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+c.sem+"). Skipping vertex attribute.")}}catch(e){this._dbg(We.VerboseAPI,"Error Creating buffer ("+e+"). Skipping vertex attribute.")}}if(e.index){const s=e.index.view,i=void 0,o=s.byteOffset+s.byteCount;switch(e.index.view.type){case z.U16:m=new k(t,s.byteOffset,i,o);break;case z.U32:m=new B(t,s.byteOffset,i,o);break;case z.U8:default:this._dbg(We.Error,"[Unsupported Feature] index type not supported ("+s.type+").")}}if(null==m&&null!=i){const e=i.count;if(e<65535){const t=new Uint16Array(e);m=new k(t)}else{const t=new Uint32Array(e);m=new B(t)}for(let t=0;t<e;t++)m.set(t,t)}return{positionView:i,positionAttr:o,colorAttr:r,texCoord0Attr:a,indicesView:m,normalsView:n,normalsAttr:p}}_loadModifications(){if(this.removeHandles("modifications"),null==this.layer.modifications)return void(this._modifications=[]);const e=this.layer.modifications;this.addHandles(this._updatingHandles.addOnCollectionChange((()=>e),(()=>this._modifications=e.toArray()),r),"modifications")}_onRemoveFromCache(e){this._wasm?.onRenderableEvicted(this,e.handle,e.usedMemory),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(e===We.Error?i.getLogger(this).error(t):i.getLogger(this).warn(t))}};e([p({type:[$]})],Ze.prototype,"_modifications",void 0),e([p()],Ze.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),e([p()],Ze.prototype,"layer",void 0),e([p({readOnly:!0})],Ze.prototype,"visibleAtCurrentScale",null),e([p()],Ze.prototype,"elevationOffset",null),Ze=e([m("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],Ze);const Je=Ze;export{Je as default};
