/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{i as t}from"./dehydratedFeatureUtils.js";import{i as s,t as i}from"./vec3.js";import{c as r}from"./vec3f64.js";import{c as e,f as n,g as a}from"./ray.js";import{V as o}from"./ViewingMode.js";import h from"../views/3d/webgl/RenderCamera.js";import{H as l,a as c}from"./HUDIntersectorResult.js";import{b as f,S as d,a as m,I as u}from"./IntersectorResult.js";import{I as y,g}from"./verticalOffsetUtils.js";class _{constructor(t,s=null,i=0){this.array=t,this.spatialReference=s,this.offset=i}}function p(t){return"array"in t}function v(s,i,r="ground"){if(t(i))return s.getElevation(i.x,i.y,i.z||0,i.spatialReference,r);if(p(i)){let t=i.offset;return s.getElevation(i.array[t++],i.array[t++],i.array[t]||0,i.spatialReference??s.spatialReference,r)}return s.getElevation(i[0],i[1],i[2]||0,s.spatialReference,r)}const O=1e-5;class E{constructor(t){this.options=new f,this._results=new w,this.transform=new y,this.camera=new h,this.tolerance=O,this.verticalOffset=null,this._ray=e(),this._rayEnd=r(),this._rayBeginTransformed=r(),this._rayEndTransformed=r(),this.viewingMode=t??o.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,s,i){this.resetWithRay(n(t,s,this._ray),i)}resetWithRay(t,i){this.camera=i,t!==this._ray&&a(t,this._ray),0!==this.options.verticalOffset?this.viewingMode===o.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,s(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,s,i,r,e){this.point=s,this.filterPredicate=r,this.tolerance=i??O;const n=g(this.verticalOffset);if(t&&t.length>0){const s=e?t=>{e(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const i of t){const t=i.getSpatialQueryAccelerator?.();null!=t?(null!=n?t.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,s,n):t.forEachAlongRay(this._ray.origin,this._ray.direction,s),this.options.selectionMode&&this.options.hud&&t.forEachDegenerateObject(s)):i.objects.forEach((t=>s(t)))}}this.sortResults()}intersectObject(t){const s=t.geometries;if(!s)return;const r=t.effectiveTransformation,e=g(this.verticalOffset);for(const n of s){if(!n.visible)continue;const{material:s,id:a}=n;if(!s.visible)continue;this.transform.setAndInvalidateLazyTransforms(r,n.transformation),i(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),i(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const o=this.transform.transform;null!=e&&(e.objectTransform=this.transform),s.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((s,i,r,e)=>this.handleObjectIntersection({object:t,geometryId:a,primitiveIndex:r},s,i,o,e)))}}handleObjectIntersection(t,s,i,r,e){if(s<0||null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,s))return;const n=e?this._results.hud:this._results;t=e?new l(t,e):t;const a=e?r=>r.set(u.HUD,t,s,i):e=>e.set(u.OBJECT,t,s,i,r);if((null==n.min.distance||s<n.min.distance)&&a(n.min),this.options.store!==d.MIN&&(null==n.max.distance||s>n.max.distance)&&a(n.max),this.options.store===d.ALL)if(e){const t=new c(this._ray);a(t),this._results.hud.all.push(t)}else{const t=new m(this._ray);a(t),this._results.all.push(t)}}sortResults(t=this._results.all){t.sort(((t,s)=>t.distance!==s.distance?(t.distance??0)-(s.distance??0):t.drapedLayerOrder!==s.drapedLayerOrder?j(t.drapedLayerOrder,s.drapedLayerOrder):j(t.renderPriority,s.renderPriority)))}}function j(t,s){return(s??-Number.MAX_VALUE)-(t??-Number.MAX_VALUE)}class w{constructor(){this.min=new m(e()),this.max=new m(e()),this.hud={min:new c(e()),max:new c(e()),all:new Array},this.ground=new m(e()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}export{E as I,_ as S,O as d,v as g,p as i};
