/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Evented.js";import{d as o}from"./handleUtils.js";import{initial as r,watch as i,sync as s,on as n,syncAndInitial as p}from"../core/reactiveUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import{i as m}from"../core/lang.js";import"./Logger.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import d from"../core/Accessor.js";import{U as c}from"./UpdatingHandles.js";import j from"../geometry/Point.js";import u from"../geometry/Polygon.js";import{initializeProjection as g,project as y,projectWithZConversion as h}from"./projectionUtils.js";import{C as f}from"./MediaLayerView3D.js";import{a as v,E as _}from"./EditGeometryOperations.js";import{x as w}from"./vec3.js";import{c as U}from"./vec3f64.js";import{p as b}from"./projectPointToVector.js";import C from"../layers/support/ImageElement.js";import M from"../layers/support/VideoElement.js";import"../core/Handles.js";import"../config.js";import"./maybe.js";import"./get.js";import"./utils.js";import"./Lifecycle.js";import"./metadata.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./tracking.js";import"./ensureType.js";import"./MapUtils.js";import"../core/Error.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./events.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./Warning.js";import"../core/accessorSupport/decorators/cast.js";import"./reader.js";import"./writer.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Extent.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./zmUtils.js";import"./SimpleObservable.js";import"../geometry/Multipoint.js";import"../geometry/Polyline.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./perspectiveUtils.js";import"./mat3.js";import"./mat3f64.js";import"./vec2.js";import"./common.js";import"./MediaElementView.js";import"./normalizeUtilsSync.js";import"../geometry/support/jsonUtils.js";import"./normalizeUtilsCommon.js";import"./GridLocalOriginFactory.js";import"./vec4f64.js";import"./orientedBoundingBox.js";import"./mat4f64.js";import"./quat.js";import"./vec4.js";import"./quatf64.js";import"./spatialReferenceEllipsoidUtils.js";import"./computeTranslationToOriginAndRotation.js";import"./mat4.js";import"./plane.js";import"./vector.js";import"./vec2f64.js";import"./mathUtils2.js";import"./ViewingMode.js";import"./Matrix4PassUniform.js";import"./Indices.js";import"./BufferView.js";import"./triangle.js";import"./ray.js";import"./lineSegment.js";import"./basicInterfaces.js";import"./VertexAttribute.js";import"./Texture.js";import"./enums.js";import"./FBOAttachmentType.js";import"./getDataTypeBytes.js";import"./Matrix4BindUniform.js";import"./BindType.js";import"./glsl.js";import"./ShaderTechniqueConfiguration.js";import"./ShaderOutput.js";import"./lengthUtils.js";import"./guards.js";import"./debugFlags2.js";import"./Material.js";import"./boundedPlane.js";import"./sphere.js";import"./videoUtils.js";import"./requestImageUtils.js";import"./TextureFormat.js";import"./AlphaCutoff.js";import"./renderState.js";import"./RibbonLineMaterial.js";import"./Octree.js";import"./frustum.js";import"./screenUtils.js";import"./InterleavedLayout.js";import"./types.js";import"./Float4DrawUniform.js";import"./floatRGBA.js";import"./GeometryUtil.js";import"./vec3f32.js";import"./aaBoundingBox.js";import"./ShaderBuilder.js";import"./LayerView3D.js";import"./heightModelInfoUtils.js";import"../geometry/HeightModelInfo.js";import"./mat2d.js";import"./mat2df64.js";import"./InputManager.js";import"./Queue.js";import"./signal.js";import"./keybindings.js";import"./SnappingManagerPool.js";import"../core/Collection.js";import"./shared.js";import"./mapCollectionUtils.js";import"./asyncUtils.js";import"../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./Settings.js";import"../Color.js";import"./colorUtils2.js";import"../views/interactive/snapping/SnappingOptions.js";import"./SnappingManager.js";import"./elevationInfoUtils.js";import"./unitConversionUtils.js";import"./normalizedPoint.js";import"./dehydratedPoint.js";import"./RightAngleSnappingHint.js";import"./constraints.js";import"../core/sql.js";import"./timeUtils.js";import"./date.js";import"./locale.js";import"./constants.js";import"./datetime.js";import"../rest/support/Query.js";import"./enumeration.js";import"./typeUtils2.js";import"./DataLayerSource.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./FullTextSearch.js";import"../core/Clonable.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"./utils8.js";import"./Version2.js";import"./Version.js";import"../geometry/support/geodesicUtils.js";import"./geometry2dUtils.js";import"./geodesicLengthMeasurementUtils.js";import"./quantityUtils.js";import"./projectVectorToVector.js";import"../geometry/operators/geodeticLengthOperator.js";import"./geodeticCurveType.js";import"./geodesicMeasurementUtils.js";import"./automaticAreaMeasurementUtils.js";import"./geodesicAreaMeasurementUtils.js";import"./earcut.js";import"./automaticLengthMeasurementUtils.js";import"./RenderGeometry.js";import"./SceneLighting.js";import"../views/3d/webgl/RenderCamera.js";import"./axisAngleDegrees.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./BooleanBindUniform.js";import"../views/3d/webgl.js";import"../views/3d/webgl/RenderNode.js";import"./HighlightDefaults.js";import"./VertexElementDescriptor.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./memoryEstimations.js";import"./NestedMap.js";import"./HUDRenderStyle.js";import"./Scheduler.js";import"./debugFlags.js";import"./ImageMaterial.js";import"./ITexture.js";import"./VertexColor.glsl.js";import"./Matrix3DrawUniform.js";import"./DefaultLayouts.js";import"./TriangleMaterial.js";import"../views/layers/LayerView.js";import"../core/Identifiable.js";import"../core/Promise.js";import"./layerViewUtils.js";import"./MediaLayerView.js";import"./imageUtils.js";import"./uuid.js";import"../layers/support/MediaElementBase.js";import"../core/Loadable.js";import"./MultiOriginJSONSupport.js";import"../layers/support/ControlPointsGeoreference.js";import"./GeoreferenceBase.js";import"../layers/support/CornersGeoreference.js";import"../layers/support/ExtentAndRotationGeoreference.js";import"./resourceExtension.js";import"./mediaLayerUtils2.js";import"./sanitizerUtils.js";let E=class extends d{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new c}initialize(){this.addHandles([o(this._updatingHandles),this._updatingHandles.add((()=>{const e=this.element.georeference;return"control-points"===e?.type?e.controlPoints:null}),(e=>this._elementControlPointsChanged(e)),r)])}_elementControlPointsChanged(e){const t=e?.map((({mapPoint:e})=>e)).filter(m),o=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(t,o,(e=>{if(!e)return void this._replaceOperations(null);const{_operations:t}=this,r=e.map((({x:e,y:t})=>[e,t]));r.push(r[0].slice());const i=new u({rings:[r],spatialReference:o});if(t?.trySetGeometry(i))return void this.onModifiedExternally();const s=this.view.state.viewingMode;this._replaceOperations(new f(v.fromGeometry(i,s),s,(e=>this._operationsGeometryChanged(e))))})))}_operationsGeometryChanged(e){const{element:{georeference:t},_operations:o}=this;if(!o||!t||"control-points"!==t.type||!t.controlPoints)return;const r=o.data.geometry,i=t.controlPoints.map((({mapPoint:e})=>e)).filter(m),s=o.data.components[0].isClosed()?1:0;if(r.rings[0]?.length-s!==i.length)return;const n=r.rings[0].map((([e,t])=>new j({x:e,y:t,spatialReference:r.spatialReference})));n.length-=s;const p=i.map((({spatialReference:e})=>e));this._updatingHandles.addPromise(this._whenProjected(n,p,(t=>this._updateElementControlPoints(t,e))))}_updateElementControlPoints(e,t){const{georeference:o}=this.element;if(!o||!e||"control-points"!==o.type||o.controlPoints?.length!==e?.length)return;const r=o.controlPoints;if(r?.length===e.length)for(let i=0;i<r.length;i++)t&&(r[i].sourcePoint=o.toSource(e[i])),r[i].mapPoint=e[i]}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:r,element:{georeference:i}}=this,s=e.map((({spatialReference:e})=>e)),n=Array.isArray(t)?t:new Array(s.length).fill(t);await g(Array.from(s).map(((e,t)=>({source:e,dest:n[t]}))));const p=e.map(((e,t)=>y(e,n[t])));r===this._operations&&i===this.element.georeference&&o(p)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e}};e([a({constructOnly:!0})],E.prototype,"view",void 0),e([a({constructOnly:!0})],E.prototype,"layer",void 0),e([a({constructOnly:!0})],E.prototype,"element",void 0),e([a({constructOnly:!0})],E.prototype,"onModifiedExternally",void 0),e([a()],E.prototype,"_operations",void 0),e([a()],E.prototype,"operations",null),e([a()],E.prototype,"updating",null),E=e([l("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],E);let S=class extends d{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new c}initialize(){this.addHandles([o(this._updatingHandles),this._updatingHandles.add((()=>this.element.georeference?.coords),(e=>this._elementCoordinatesChanged(e)),r)])}_elementCoordinatesChanged(e){this._updatedElementCoordinates!==e&&this._updatingHandles.addPromise(this._whenProjected(e,this.view.spatialReference,(e=>{if(!e)return void this._replaceOperations(null);const{_operations:t}=this;t?.trySetGeometry(e)?this.onModifiedExternally():this._replaceOperations(_.fromGeometry(e,this.view.state.viewingMode))})))}_operationsGeometryChanged(){const{element:{georeference:e},_operations:t}=this;if(!t||!e)return;const o=t.data.geometry;if(!e.coords)return void this._updateElementCoordinates(o);const r=e.coords.spatialReference;this._updatingHandles.addPromise(this._whenProjected(o,r,(e=>this._updateElementCoordinates(e))))}_updateElementCoordinates(e){const{georeference:t}=this.element;t&&(t.coords=e,this._updatedElementCoordinates=t.coords)}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:r,element:{georeference:i}}=this,s=await h(e,t);r===this._operations&&i===this.element.georeference&&o(s)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",(()=>this._operationsGeometryChanged())),e),this.onModifiedExternally()}};function x(e,t){if(!e||"media-3d"!==e.type||e.suspended)return!1;const o=e.layer.source;return!!o&&(o instanceof C||o instanceof M?o===t:"hasElement"in o&&o.hasElement(t))}e([a({constructOnly:!0})],S.prototype,"view",void 0),e([a({constructOnly:!0})],S.prototype,"layer",void 0),e([a({constructOnly:!0})],S.prototype,"element",void 0),e([a({constructOnly:!0})],S.prototype,"onModifiedExternally",void 0),e([a()],S.prototype,"_operations",void 0),e([a()],S.prototype,"operations",null),e([a()],S.prototype,"updating",null),S=e([l("esri.views.3d.interactive.editingTools.media.MediaElementControllerShape")],S);let O=class extends d{grabbableForEvent(){return!0}constructor(e){super(e),this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.grabbing=!1,this.dragging=!1,this.hovering=!0,this.selected=!1,this.cursor=null,this.consumesClicks=!0,this.events=new t.EventEmitter,this.addHandles(i((()=>this.selected),(e=>this.events.emit("select-changed",{action:e?"select":"deselect"})),s))}destroy(){this._set("view",null)}intersectionDistance(e){const{view:t,layer:o,element:r}=this;if(!function(e,t,o){return x(e.allLayerViews.find((e=>e.layer===t)),o)}(t,o,r))return null;const i=t.toMap(e,{include:{layer:o,element:r}});return i&&b(i,P,t.renderSpatialReference)?w(P,t.state.camera.eye):null}onElevationChange(){}onViewChange(){}};e([a({constructOnly:!0,nonNullable:!0})],O.prototype,"element",void 0),e([a({constructOnly:!0,nonNullable:!0})],O.prototype,"layer",void 0),e([a({constructOnly:!0,nonNullable:!0})],O.prototype,"view",void 0),e([a()],O.prototype,"interactive",void 0),e([a()],O.prototype,"selectable",void 0),e([a()],O.prototype,"grabbable",void 0),e([a()],O.prototype,"grabbing",void 0),e([a()],O.prototype,"dragging",void 0),e([a()],O.prototype,"hovering",void 0),e([a()],O.prototype,"selected",void 0),e([a()],O.prototype,"cursor",void 0),O=e([l("esri.views.3d.interactive.editingTools.media.MediaElementManipulator3D")],O);const P=U(),V=Symbol();let H=class extends t.EventedAccessor{get operations(){return this._controller?.operations}get elevationInfo(){return{mode:"on-the-ground",offset:0}}get _layerView(){const e=this.view.allLayerViews.find((e=>e.layer===this.layer));return"media-3d"===e?.type?e:null}get visible(){return x(this._layerView,this.element)}get isDraped(){return!0}get origin(){return null}get updating(){return!!this._controller?.updating}get _controllerClass(){return"transform"===this.tool||"control-points"!==this.element.georeference?.type?S:E}constructor(e){super(e),this.tool="transform"}initialize(){this.addHandles([i((()=>this._controllerClass),(e=>this._updateController(e)),p),n((()=>this._layerView),"element-render-changed",(({element:e})=>{this.element===e&&this.emit("committed")}))])}toMap(e){const{layer:t,element:o}=this;return this.view.toMap(e,{include:{layer:t,element:o}})}createManipulator(e){const{view:t,layer:o,element:r}=this;return new O({view:t,layer:o,element:r,...e})}_updateController(e){if(this._controller&&this._controller instanceof e)return;this.removeHandles(V);const{view:t,layer:r,element:i}=this,s=()=>{this.emit("modified-externally")};this._controller=new e({view:t,layer:r,element:i,onModifiedExternally:s}),s(),this.addHandles(o(this._controller),V)}};e([a({constructOnly:!0})],H.prototype,"view",void 0),e([a({constructOnly:!0})],H.prototype,"layer",void 0),e([a({constructOnly:!0})],H.prototype,"element",void 0),e([a()],H.prototype,"tool",void 0),e([a()],H.prototype,"_controller",void 0),e([a()],H.prototype,"elevationInfo",null),e([a()],H.prototype,"_layerView",null),e([a()],H.prototype,"visible",null),e([a()],H.prototype,"updating",null),e([a()],H.prototype,"_controllerClass",null),H=e([l("esri.views.3d.interactive.editingTools.ManipulatedObject3DMediaElement")],H);export{H as ManipulatedObject3DMediaElement};
