/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{g as e}from"./watch.js";import{S as t}from"./ShaderOutput.js";import{V as a}from"./VertexAttribute.js";import{_ as r}from"./tslib.es6.js";import{S as s,p as i,N as n}from"./ShaderTechniqueConfiguration.js";import{B as o}from"./BindType.js";import{e as c}from"../core/lang.js";import{l,e as u,c as h}from"./mathUtils.js";import{d}from"./boundedPlane.js";import{k as m,c as p,l as f}from"./sphere.js";import{V as O}from"./ViewingMode.js";const g=new Map([[a.POSITION,0],[a.NORMAL,1],[a.NORMALCOMPRESSED,1],[a.UV0,2],[a.UVI,2],[a.COLOR,3],[a.COLORFEATUREATTRIBUTE,3],[a.SIZE,4],[a.TANGENT,4],[a.CENTEROFFSETANDDISTANCE,5],[a.SYMBOLCOLOR,5],[a.FEATUREATTRIBUTE,6],[a.INSTANCEFEATUREATTRIBUTE,6],[a.OLIDCOLOR,6],[a.INSTANCEOBJECTANDLAYERIDCOLOR,6],[a.INSTANCECOLOR,7],[a.ROTATION,8],[a.INSTANCEMODEL,8],[a.INSTANCEMODELNORMAL,12],[a.INSTANCEMODELORIGINHI,11],[a.INSTANCEMODELORIGINLO,15]]);class v extends s{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}}var F;!function(e){e[e.NONE=0]="NONE",e[e.ColorAlpha=1]="ColorAlpha",e[e.FrontFace=2]="FrontFace",e[e.COUNT=3]="COUNT"}(F||(F={}));class A extends v{constructor(){super(...arguments),this.output=t.Color,this.oitPass=F.NONE,this.hasSlicePlane=!1,this.hasHighlightMixTexture=!1,this.bindType=o.Pass,this.writeDepth=!0}}function C(e,t){return new P(e,M,t)}function _(e,t){const{curvatureDependent:a,scaleStart:r,scaleFallOffRange:s}=M;return new P(e,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:x.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:x.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:s,minPixelSize:x.minPixelSize},t)}function T(e,t,a){const r=a.parameters;return D.scale=Math.min(r.divisor/(t-r.offset),1),D.factor=function(e){return Math.abs(e*e*e)}(e),D}function N(e,t){return l(e*Math.max(t.scale,t.minScaleFactor),e,t.factor)}function S(e,t,a,r){r.scale=function(e,t,a){const r=T(e,t,a);return r.minScaleFactor=0,N(1,r)}(e,t,a),r.factor=0,r.minScaleFactor=a.minScaleFactor}function E(e,t,a=[0,0]){const r=Math.min(Math.max(t.scale,t.minScaleFactor),1);return a[0]=e[0]*r,a[1]=e[1]*r,a}r([i({count:t.COUNT})],A.prototype,"output",void 0),r([i({count:F.COUNT})],A.prototype,"oitPass",void 0),r([i()],A.prototype,"hasSlicePlane",void 0),r([i()],A.prototype,"hasHighlightMixTexture",void 0);class P{get minScaleFactor(){return null!=this._fontHeight?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(e,t,a,r={camera:{distance:0,fovY:0},divisor:0,offset:0},s){this._viewingMode=e,this._description=t,this._ellipsoidRadius=a,this.parameters=r,this._fontHeight=s,this._viewingMode===O.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return!(this.parameters&&this.parameters.camera.fovY===e.fovY&&this.parameters.camera.distance===e.distance||(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),0))}overrideFontHeight(e){return e!==this._fontHeight?new P(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,a){const{scaleStart:r,scaleFallOffRange:s}=this._description,{fovY:i,distance:n}=e,o=this._calculateCurvatureDependentParameters(e,t),c=this._coverageCompensation(e,t,o),{tiltAngle:l,scaleFallOffFactor:u}=o,h=Math.sin(l)*n,d=.5*Math.PI-l-i*(.5-r*c),m=h/Math.cos(d),p=d+i*s*c,f=(m-u*(h/Math.cos(p)))/(1-u);return a.camera.fovY=e.fovY,a.camera.distance=e.distance,a.offset=f,a.divisor=m-f,a}_calculateCurvatureDependentParametersLocal(e,t,a=R){return a.tiltAngle=this._description.curvatureDependent.min.tiltAngle,a.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,a}_calculateCurvatureDependentParametersGlobal(e,t,a=R){const r=this._description.curvatureDependent,s=1+e.distance/t,i=Math.sqrt(s*s-1),[n,o]=[r.min.curvature,r.max.curvature],c=h((i-n)/(o-n),0,1),[u,d]=[r.min,r.max];return a.tiltAngle=l(u.tiltAngle,d.tiltAngle,c),a.scaleFallOffFactor=l(u.scaleFallOffFactor,d.scaleFallOffFactor,c),a}_surfaceCoverageCompensationLocal(e,t,a){return d(a.tiltAngle,e.fovY)}_surfaceCoverageCompensationGlobal(e,t,a){return m(L,t),f(L,a.tiltAngle,e.distance,e.fovY)}}const M={curvatureDependent:{min:{curvature:u(10),tiltAngle:u(12),scaleFallOffFactor:.5},max:{curvature:u(70),tiltAngle:u(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},x={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14},D={scale:0,factor:0,minScaleFactor:0},R={tiltAngle:0,scaleFallOffFactor:0},L=p();function I(e,t,a,r,s){let i=(a.screenLength||0)*e.pixelRatio;null!=s&&(i=function(e,t,a,r){return N(e,T(t,a,r))}(i,r,t,s));const n=i*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return h(n*t,a.minWorldLength||0,null!=a.maxWorldLength?a.maxWorldLength:1/0)}function y(e,t){let a=!1;for(const r in t){const s=t[r];void 0!==s&&(Array.isArray(s)?Array.isArray(e[r])&&c(s,e[r])||(e[r]=s.slice(),a=!0):e[r]!==s&&(a=!0,e[r]=s))}return a}const b={multiply:1,ignore:2,replace:3,tint:4};class U{constructor(t,a){this.id=e(),this.supportsEdges=!1,this.vertexAttributeLocations=g,this._renderPriority=0,this._parameters=new a,y(this._parameters,t),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(e){return!1}setParameters(e,t=!0){y(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this._parametersChanged())}validateParameters(e){}shouldRender(e){return this.visible&&this.isVisibleForOutput(e.output)&&(!this.parameters.isDecoration||e.bind.decorations)&&0!==(this.parameters.renderOccluded&e.renderOccludedMask)}isVisibleForOutput(e){return!0}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this._parametersChanged())}_parametersChanged(){this.repository?.materialChanged(this)}get renderOccludedFlags(){return this.visible?this.parameters.renderOccluded:w.None}get hasEmissions(){return!1}getConfiguration(e,a,r=new A){return r.output=e,r.hasHighlightMixTexture=e===t.Highlight&&null!=a.highlightMixTexture,r}}var w;!function(e){e[e.None=0]="None",e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"}(w||(w={}));class j extends n{constructor(){super(...arguments),this.renderOccluded=w.Occlude,this.isDecoration=!1}}export{A as D,v as I,U as M,F as O,w as R,j as a,N as b,E as c,g as d,b as e,_ as f,C as g,S as p,y as u,I as v};
