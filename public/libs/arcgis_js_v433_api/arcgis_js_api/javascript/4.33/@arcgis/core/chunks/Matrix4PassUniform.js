/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{n as e,U as t,y as i,l as s,x as r,o as n}from"../core/lang.js";import{g as a}from"./watch.js";import{I as o,a as l,c}from"./mat4f64.js";import{m as u,w as d,s as f,i as h,j as m,I as p,t as g,c as v,k as _,l as A}from"./vec3.js";import{b as x,a as T}from"./Indices.js";import{W as E,A as b,n as y,c as S,d as P,f as C,g as w,p as I,v as M,B as O,a as L}from"./BufferView.js";import{P as R}from"./PooledArray.js";import{f as z,b as D,c as N,o as U,z as F,Z as B}from"./vec3f64.js";import{b as V}from"./triangle.js";import{O as k,a as H,T as j,S as G}from"./basicInterfaces.js";import{V as $}from"./VertexAttribute.js";import{w as q,T as K,g as X,a as W}from"./Texture.js";import{k as Y,c as Q,l as Z,m as J,s as ee,v as te,r as ie,a as se,b as re,D as ne,G as ae}from"./mat4.js";import{o as oe,U as le,T as ce,a as ue,c as de,b as fe,F as he,M as me}from"./Matrix4BindUniform.js";import{g as pe,I as ge}from"./glsl.js";import{N as ve}from"./ShaderTechniqueConfiguration.js";import{i as _e,S as Ae,n as xe,o as Te}from"./ShaderOutput.js";import{B as Ee}from"./BindType.js";import{c as be}from"./mathUtils.js";import{f as ye}from"./mat3.js";import{c as Se}from"./mat3f64.js";import{c as Pe}from"./vec4.js";import{o as Ce}from"./vec4f64.js";import{m as we}from"./lengthUtils.js";import{b as Ie,g as Me,i as Oe}from"./guards.js";import{d as Le}from"./debugFlags2.js";import{R as Re,O as ze,d as De}from"./Material.js";import Ne from"../core/Error.js";import Ue from"../core/Evented.js";import{f as Fe,r as Be}from"./maybe.js";import{throwIfAborted as Ve,onAbort as ke,createAbortError as He}from"../core/promiseUtils.js";import{isBlobProtocol as je,isDataProtocol as Ge}from"../core/urlUtils.js";import{w as $e}from"./videoUtils.js";import{r as qe}from"./requestImageUtils.js";import{l as Ke}from"../request.js";import{g as Xe}from"./assets.js";import{T as We}from"./TextureFormat.js";import{s as Ye,c as Qe,b as Ze,T as Je,e as et,w as tt,r as it,f as st,G as rt,H as nt,a as at,q as ot}from"./enums.js";import{L as lt}from"./Logger.js";import{s as ct}from"./vec2.js";import{c as ut}from"./vec2f64.js";import{a as dt}from"./AlphaCutoff.js";import{m as ft,d as ht,p as mt,s as pt,a as gt,u as vt}from"./renderState.js";class _t{constructor(){this.uid=a()}}class At extends _t{constructor(e){super(),this.highlightName=e,this.channel=k.Highlight}}class xt extends _t{constructor(){super(...arguments),this.channel=k.MaskOccludee}}function Tt(e,t,i){for(let s=0;s<i;++s)t[2*s]=e[s],t[2*s+1]=e[s]-t[2*s]}function Et(e,t){const i=e.length;for(let s=0;s<i;++s)yt[0]=e[s],t[s]=yt[0];return t}function bt(e,t){const i=e.length;for(let s=0;s<i;++s)yt[0]=e[s],yt[1]=e[s]-yt[0],t[s]=yt[1];return t}const yt=new Float32Array(2);function St(t,i=!1){return t<=e?i?new Array(t).fill(0):new Array(t):new Float32Array(t)}function Pt(t){return Array.isArray(t)?t.length<e?t:new Float32Array(t):t.length<e?Array.from(t):t}function Ct(t){return(Array.isArray(t)?t.length:t.byteLength/8)<=e?Array.from(t):new Float32Array(t)}function wt(e,t,i){return Array.isArray(e)?e.slice(t,t+i):e.subarray(t,t+i)}function It(s){if(s.length<e)return Array.from(s);if(Array.isArray(s))return Float64Array.from(s);if(!("BYTES_PER_ELEMENT"in s))return Array.from(s);switch(s.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(s);case 2:return t(s)?E().from(s):i(s)?Uint16Array.from(s):Int16Array.from(s);case 4:return Float32Array.from(s);default:return Float64Array.from(s)}}class Mt{constructor(e,t,i){this.primitiveIndices=e,this._numIndexPerPrimitive=t,this.position=i,this._children=void 0,b(e.length>=1),b(3===i.size||4===i.size);const{data:s,size:r,indices:n}=i;b(n.length%this._numIndexPerPrimitive===0),b(n.length>=e.length*this._numIndexPerPrimitive);const a=e.length;let o=r*n[this._numIndexPerPrimitive*e[0]];Ot.clear(),Ot.push(o);const l=z(s[o],s[o+1],s[o+2]),c=D(l);for(let t=0;t<a;++t){const i=this._numIndexPerPrimitive*e[t];for(let e=0;e<this._numIndexPerPrimitive;++e){o=r*n[i+e],Ot.push(o);let t=s[o];l[0]=Math.min(t,l[0]),c[0]=Math.max(t,c[0]),t=s[o+1],l[1]=Math.min(t,l[1]),c[1]=Math.max(t,c[1]),t=s[o+2],l[2]=Math.min(t,l[2]),c[2]=Math.max(t,c[2])}}this.bbMin=l,this.bbMax=c;const d=u(N(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(c[0]-l[0],c[1]-l[1]),c[2]-l[2]);let f=this.radius*this.radius;for(let e=0;e<Ot.length;++e){o=Ot.at(e);const t=s[o]-d[0],i=s[o+1]-d[1],r=s[o+2]-d[2],n=t*t+i*i+r*r;if(n<=f)continue;const a=Math.sqrt(n),l=.5*(a-this.radius);this.radius=this.radius+l,f=this.radius*this.radius;const c=l/a;d[0]+=t*c,d[1]+=i*c,d[2]+=r*c}this.center=d,Ot.clear()}getChildren(){if(this._children||d(this.bbMin,this.bbMax)<=1)return this._children;const e=u(N(),this.bbMin,this.bbMax,.5),t=this.primitiveIndices.length,i=new Uint8Array(t),s=new Array(8);for(let e=0;e<8;++e)s[e]=0;const{data:r,size:n,indices:a}=this.position;for(let o=0;o<t;++o){let t=0;const l=this._numIndexPerPrimitive*this.primitiveIndices[o];let c=n*a[l],u=r[c],d=r[c+1],f=r[c+2];for(let e=1;e<this._numIndexPerPrimitive;++e){c=n*a[l+e];const t=r[c],i=r[c+1],s=r[c+2];t<u&&(u=t),i<d&&(d=i),s<f&&(f=s)}u<e[0]&&(t|=1),d<e[1]&&(t|=2),f<e[2]&&(t|=4),i[o]=t,++s[t]}let o=0;for(let e=0;e<8;++e)s[e]>0&&++o;if(o<2)return;const l=new Array(8);for(let e=0;e<8;++e)l[e]=s[e]>0?new Uint32Array(s[e]):void 0;for(let e=0;e<8;++e)s[e]=0;for(let e=0;e<t;++e){const t=i[e];l[t][s[t]++]=this.primitiveIndices[e]}this._children=new Array;for(let e=0;e<8;++e)void 0!==l[e]&&this._children.push(new Mt(l[e],this._numIndexPerPrimitive,this.position));return this._children}static prune(){Ot.prune()}}const Ot=new R({deallocator:null}),Lt=N(),Rt=N(),zt=N(),Dt=N();var Nt,Ut,Ft,Bt;!function(e){e[e.Mesh=0]="Mesh",e[e.Point=1]="Point",e[e.Line=2]="Line"}(Nt||(Nt={}));class Vt{constructor(e,t,i=null,s=Nt.Mesh,r=null,n=-1){this.material=e,this.mapPositions=i,this.type=s,this.objectAndLayerIdColor=r,this.edgeIndicesLength=n,this.highlights=new Set,this._highlightOptionsCounts=new Map,this.id=a(),this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[e,i]of t)this._attributes.set(e,{...i,indices:x(i.indices)}),e===$.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(e).indices.length:this.edgeIndicesLength)}instantiate(e={}){const t=new Vt(e.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach(((e,i)=>{e.exclusive=!1,t._attributes.set(i,e)})),t._boundingInfo=this._boundingInfo,t.transformation=e.transformation||this.transformation,t}get attributes(){return this._attributes}getMutableAttribute(e){let t=this._attributes.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:It(t.data)},this._attributes.set(e,t)),t}setAttributeData(e,t){const i=this._attributes.get(e);i?this._attributes.set(e,{...i,exclusive:!0,data:t}):q()&&console.warn(`Setting undefined attribute ${e} data`)}get indexCount(){const e=this._attributes.values().next().value?.indices;return e?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??=this._calculateBoundingInfo(),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===Nt.Mesh?this._computeAttachmentOriginTriangles(e):this.type===Nt.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(null!=this._transformation&&g(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){return function(e,t){if(!e)return!1;const{size:i,data:s,indices:r}=e;f(t,0,0,0),f(Dt,0,0,0);let n=0,a=0;for(let e=0;e<r.length-2;e+=3){const o=r[e]*i,l=r[e+1]*i,c=r[e+2]*i;f(Lt,s[o],s[o+1],s[o+2]),f(Rt,s[l],s[l+1],s[l+2]),f(zt,s[c],s[c+1],s[c+2]);const u=V(Lt,Rt,zt);u?(h(Lt,Lt,Rt),h(Lt,Lt,zt),m(Lt,Lt,1/3*u),h(t,t,Lt),n+=u):(h(Dt,Dt,Lt),h(Dt,Dt,Rt),h(Dt,Dt,zt),a+=3)}return!(0===a&&0===n||(0!==n?(m(t,t,1/n),0):0===a||(m(t,Dt,1/a),0)))}(this.attributes.get($.POSITION),e)}_computeAttachmentOriginLines(e){const t=this.attributes.get($.POSITION);return function(e,t,i){if(!e)return!1;f(i,0,0,0),f(Dt,0,0,0);let s=0,r=0;const{size:n,data:a,indices:o}=e,l=o.length-1,c=l+(t?2:0);for(let e=0;e<c;e+=2){const t=e<l?e+1:0,c=o[e<l?e:l]*n,u=o[t]*n;Lt[0]=a[c],Lt[1]=a[c+1],Lt[2]=a[c+2],Rt[0]=a[u],Rt[1]=a[u+1],Rt[2]=a[u+2],m(Lt,h(Lt,Lt,Rt),.5);const d=p(Lt,Rt);d>0?(h(i,i,m(Lt,Lt,d)),s+=d):0===s&&(h(Dt,Dt,Lt),r++)}return 0!==s?(m(i,i,1/s),!0):0!==r&&(m(i,Dt,1/r),!0)}(t,function(e,t){return!(!("isClosed"in e)||!e.isClosed)&&t.indices.length>2}(this.material.parameters,t),e)}_computeAttachmentOriginPoints(e){return function(e,t){if(!e)return!1;const{size:i,data:s,indices:r}=e;f(t,0,0,0);let n=-1,a=0;for(let e=0;e<r.length;e++){const o=r[e]*i;n!==o&&(t[0]+=s[o],t[1]+=s[o+1],t[2]+=s[o+2],a++),n=o}return a>1&&m(t,t,1/a),a>0}(this.attributes.get($.POSITION),e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.attributes.get($.POSITION);if(!e||0===e.indices.length)return null;const t=this.type===Nt.Mesh?3:1;b(e.indices.length%t===0,"Indexing error: "+e.indices.length+" not divisible by "+t);const i=T(e.indices.length/t);return new Mt(i,t,e)}get transformation(){return this._transformation??o}set transformation(e){this._transformation=e&&e!==o?l(e):null}get highlightNames(){return this._highlightOptionsCounts}get hasHighlights(){return this._highlightOptionsCounts.size>0}foreachHighlightOptions(e){this._highlightOptionsCounts.forEach(((t,i)=>e(i)))}allocateIdAndHighlight(e){const t=new At(e);return this.addHighlight(t)}addHighlight(e){this.highlights.add(e);const{highlightName:t}=e,i=(this._highlightOptionsCounts.get(t)??0)+1;return this._highlightOptionsCounts.set(t,i),e}removeHighlight(e){if(this.highlights.delete(e)){const{highlightName:t}=e,i=this._highlightOptionsCounts.get(t)??0;i<=1?this._highlightOptionsCounts.delete(t):this._highlightOptionsCounts.set(t,i-1)}}}class kt{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){}get _stippleTextures(){return this._techniques.context.stippleTextures}get _markerTextures(){return this._techniques.context.markerTextures}getTechnique(e,t){return this._techniques.get(e,this._material.getConfiguration(this._output,t))}ensureResources(e){return H.LOADED}}!function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.OPAQUE_MATERIAL_WITHOUT_NORMALS=3]="OPAQUE_MATERIAL_WITHOUT_NORMALS",e[e.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_MATERIAL_WITHOUT_NORMALS=5]="TRANSPARENT_MATERIAL_WITHOUT_NORMALS",e[e.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_MATERIAL_WITHOUT_DEPTH=7]="TRANSPARENT_MATERIAL_WITHOUT_DEPTH",e[e.OCCLUDED_GROUND=8]="OCCLUDED_GROUND",e[e.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",e[e.HUD_MATERIAL=12]="HUD_MATERIAL",e[e.LABEL_MATERIAL=13]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=14]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=15]="LINE_CALLOUTS_HUD_DEPTH",e[e.OVERLAY=16]="OVERLAY",e[e.DRAPED_MATERIAL=17]="DRAPED_MATERIAL",e[e.DRAPED_WATER=18]="DRAPED_WATER",e[e.VOXEL=19]="VOXEL",e[e.MAX_SLOTS=20]="MAX_SLOTS"}(Ut||(Ut={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"}(Ft||(Ft={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}(Bt||(Bt={}));class Ht{constructor(e){this.field=e}}class jt extends Ht{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[Ft.Undefined,Ft.Undefined,Ft.Undefined],this.fallback=[0,0,0]}}class Gt extends Ht{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0],this.fallback=[0,0,0,0]}}class $t extends Ht{constructor(e,t=0){super(e),this.fallback=t,this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}}class qt{}function Kt(e){return null!=e}function Xt(e,t,i,s,r){const n=e.minSize,a=e.maxSize;if(e.useSymbolValue){const e=s.symbolSize[i];return t.minSize[i]=e,t.maxSize[i]=e,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=Ft.DefinedSize,!0}if(Kt(e.field))return Kt(e.stops)?!(2!==e.stops.length||!Oe(e.stops[0].size)||!Oe(e.stops[1].size)||(Wt(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=Ft.DefinedSize,0)):Oe(n)&&Oe(a)&&Kt(e.minDataValue)&&Kt(e.maxDataValue)?(Wt(n,a,e.minDataValue,e.maxDataValue,t,i),t.type[i]=Ft.DefinedSize,!0):"unknown"!==e.valueUnit&&null!=we[e.valueUnit]&&(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/we[e.valueUnit],t.type[i]=Ft.DefinedSize,!0);if(!Kt(e.field)){if(e.stops?.[0]&&Oe(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=Ft.DefinedSize,!0;if(Oe(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=Ft.DefinedSize,!0}return!1}function Wt(e,t,i,s,r,n){const a=Math.abs(s-i)>0?(t-e)/(s-i):0;r.minSize[n]=a>0?e:t,r.maxSize[n]=a>0?t:e,r.offset[n]=e-i*a,r.factor[n]=a}function Yt(e,t,i){e[4*t]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function Qt(e,t,i){const s=2===i&&"arithmetic"===e.rotationType;t.offset[i]=s?90:0,t.factor[i]=s?-1:1,t.type[i]=1}class Zt{constructor({supports:e,modelSize:t,symbolSize:i,unitInMeters:s,anchor:r,scale:n,rotation:a,fallbackColor:o,fallbackSize:l}){this.supports=e,this.modelSize=t??U(),this.symbolSize=i??U(),this.unitInMeters=s??1,this.anchor=r??F(),this.scale=n??U(),this.rotation=a??F(),this.fallbackColor=o??Ce(),this.fallbackSize=l??U()}}function Jt(e,t,i){if(!e)return null;const s=e.reduce(((e,i)=>{if(!e)return e;if(i.valueExpression)return null;switch(i.type){case"size":return t.supports.size?function(e,t,i){if(e.normalizationField||e.valueRepresentation)return null;if(!Me(e.field))return null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return null}else t.size.field=e.field}else t.size=new jt(e.field),v(t.size.fallback,i.fallbackSize);let s;switch(e.axis){case"width":return s=Xt(e,t.size,0,i),s?t:null;case"height":return s=Xt(e,t.size,2,i),s?t:null;case"depth":return s=Xt(e,t.size,1,i),s?t:null;case"width-and-depth":return s=Xt(e,t.size,0,i),s&&Xt(e,t.size,1,i),s?t:null;case null:case void 0:case"all":return s=Xt(e,t.size,0,i),s=s&&Xt(e,t.size,1,i),s=s&&Xt(e,t.size,2,i),s?t:null;default:return e.axis,null}}(i,e,t):e;case"color":return t.supports.color?function(e,t,i){if(e.normalizationField)return null;if(Ie(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.color=new Gt(e.field);const s=e.stops;for(let e=0;e<8;++e){const i=s[Math.min(e,s.length-1)];t.color.values[e]=i.value,Yt(t.color.colors,e,i.color)}Pe(t.color.fallback,i.fallbackColor)}}else{if(!(e.stops&&e.stops.length>=0))return null;{const s=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color=new Gt(null);for(let e=0;e<8;e++)t.color.values[e]=1/0,Yt(t.color.colors,e,s);Pe(t.color.fallback,i.fallbackColor)}}return t}(i,e,t):e;case"opacity":return t.supports.opacity?function(e,t,i){if(e.normalizationField)return null;if(Ie(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.opacity=new $t(e.field,i.fallbackColor[3]);const s=e.stops;for(let e=0;e<8;++e){const i=s[Math.min(e,s.length-1)];t.opacity.values[e]=i.value,t.opacity.opacityValues[e]=i.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const s=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0],fallback:i.fallbackColor[3]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=s}}return t}(i,e,t):null;case"rotation":return t.supports.rotation?function(e,t){if(!Ie(e.field))return null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return Qt(e,t.rotation,0),t;case"roll":return Qt(e,t.rotation,1),t;case null:case void 0:case"heading":return Qt(e,t.rotation,2),t;default:return e.axis,null}}(i,e):e;default:return null}}),new qt);return!(e.length>0&&s)||s.size||s.color||s.opacity||s.rotation?s?.size&&!function(e,t){for(let i=0;i<3;++i){let s=t.unitInMeters;e.type[i]===Ft.DefinedSize&&(s*=t.modelSize[i],e.type[i]=Ft.DefinedScale),e.minSize[i]=e.minSize[i]/s,e.maxSize[i]=e.maxSize[i]/s,e.offset[i]=e.offset[i]/s,e.factor[i]=e.factor[i]/s}let i;if(e.type[0]!==Ft.Undefined)i=0;else if(e.type[1]!==Ft.Undefined)i=1;else{if(e.type[2]===Ft.Undefined)return!1;i=2}for(let t=0;t<3;++t)e.type[t]===Ft.Undefined&&(e.minSize[t]=e.minSize[i],e.maxSize[t]=e.maxSize[i],e.offset[t]=e.offset[i],e.factor[t]=e.factor[i],e.type[t]=e.type[i]);return!0}(s.size,t)?null:s:null}class ei{constructor(e,t,i){this.visualVariables=e,this.materialParameters=t,this.requiresShaderTransformation=i}}function ti(e,t){if(!e)return null;if(oe())return null;if(Le.TESTS_DISABLE_FAST_UPDATES)return null;const i=Jt(e.visualVariables,t);return i?new ei(i,ni(i,t),!!i.size):null}function ii(e,t,i){if(!t||!e)return!1;const s=e.visualVariables,r=Jt(t.visualVariables,i);return!!r&&!!(si(s.size,r.size,"size")&&si(s.color,r.color,"color")&&si(s.rotation,r.rotation,"rotation")&&si(s.opacity,r.opacity,"opacity"))&&(e.visualVariables=r,e.materialParameters=ni(r,i),e.requiresShaderTransformation=!!r.size,!0)}function si(e,t,i){if(!!e!=!!t)return!1;if(e&&e.field!==t?.field)return!1;if(e&&"rotation"===i){const i=e,s=t;for(let e=0;e<3;e++)if(i.type[e]!==s.type[e]||i.offset[e]!==s.offset[e]||i.factor[e]!==s.factor[e])return!1}return!0}class ri extends ve{constructor(e){super(),this.vvSize=e?.size??null,this.vvColor=e?.color??null,this.vvOpacity=e?.opacity??null}}function ni(e,t){const i=new ri(e);return i.vvSize&&(i.vvSymbolAnchor=t.anchor,Y(di),function(e,t,i,s=c()){const r=e||0,n=t||0,a=i||0;0!==r&&ie(s,s,-r/180*Math.PI),0!==n&&se(s,s,n/180*Math.PI),0!==a&&re(s,s,a/180*Math.PI)}(t.rotation[2],t.rotation[0],t.rotation[1],di),i.vvSymbolRotationMatrix=i.vvSymbolRotationMatrix||Se(),ye(i.vvSymbolRotationMatrix,di)),i}function ai(e,t,i){if(!e.vvSize)return i;Q(ci,i);const s=e.vvSymbolRotationMatrix;return Z(di,s[0],s[1],s[2],0,s[3],s[4],s[5],0,s[6],s[7],s[8],0,0,0,0,1),J(ci,ci,di),oi(ui,e,t),ee(ci,ci,ui),te(ci,ci,e.vvSymbolAnchor),ci}function oi(e,t,i){if(!t.vvSize)return f(e,1,1,1),e;if(Number.isNaN(i[0]))return v(e,t.vvSize.fallback);for(let s=0;s<3;++s){const r=t.vvSize.offset[s]+i[0]*t.vvSize.factor[s];e[s]=be(r,t.vvSize.minSize[s],t.vvSize.maxSize[s])}return e}function li(e,t){const i=null==e?0:t.attributes[e];return"number"==typeof i&&isFinite(i)?i:NaN}const ci=c(),ui=N(),di=c();class fi extends ri{constructor(){super(...arguments),this.renderOccluded=Re.Occlude,this.isDecoration=!1}}const hi=8;function mi(e,t,i,s=1){const{data:r,indices:n}=e,a=t.typedBuffer,o=t.typedBufferStride,l=n.length;if(i*=o,1===s)for(let e=0;e<l;++e)a[i]=r[n[e]],i+=o;else for(let e=0;e<l;++e){const t=r[n[e]];for(let e=0;e<s;e++)a[i]=t,i+=o}}function pi(e,t,i){const{data:s,indices:r}=e,n=t.typedBuffer,a=t.typedBufferStride,o=r.length;i*=a;for(let e=0;e<o;++e){const t=2*r[e];n[i]=s[t],n[i+1]=s[t+1],i+=a}}function gi(e,t,i,s=1){const{data:r,indices:n}=e,a=t.typedBuffer,o=t.typedBufferStride,l=n.length;if(i*=o,1===s)for(let e=0;e<l;++e){const t=3*n[e];a[i]=r[t],a[i+1]=r[t+1],a[i+2]=r[t+2],i+=o}else for(let e=0;e<l;++e){const t=3*n[e];for(let e=0;e<s;++e)a[i]=r[t],a[i+1]=r[t+1],a[i+2]=r[t+2],i+=o}}function vi(e,t,i,s=1){const{data:r,indices:n}=e,a=t.typedBuffer,o=t.typedBufferStride,l=n.length;if(i*=o,1===s)for(let e=0;e<l;++e){const t=4*n[e];a[i]=r[t],a[i+1]=r[t+1],a[i+2]=r[t+2],a[i+3]=r[t+3],i+=o}else for(let e=0;e<l;++e){const t=4*n[e];for(let e=0;e<s;++e)a[i]=r[t],a[i+1]=r[t+1],a[i+2]=r[t+2],a[i+3]=r[t+3],i+=o}}function _i(e,t,i){const s=e.typedBuffer,r=e.typedBufferStride;t*=r;for(let e=0;e<i;++e)s[t]=0,s[t+1]=0,s[t+2]=0,s[t+3]=0,t+=r}function Ai(e,t,i,s,r=1){if(!t)return void gi(e,i,s,r);const{data:n,indices:a}=e,o=i.typedBuffer,l=i.typedBufferStride,c=a.length,u=t[0],d=t[1],f=t[2],h=t[4],m=t[5],p=t[6],g=t[8],v=t[9],_=t[10],A=t[12],x=t[13],T=t[14];s*=l;let E=0,b=0,y=0;const S=ne(t)?e=>{E=n[e]+A,b=n[e+1]+x,y=n[e+2]+T}:e=>{const t=n[e],i=n[e+1],s=n[e+2];E=u*t+h*i+g*s+A,b=d*t+m*i+v*s+x,y=f*t+p*i+_*s+T};if(1===r)for(let e=0;e<c;++e)S(3*a[e]),o[s]=E,o[s+1]=b,o[s+2]=y,s+=l;else for(let e=0;e<c;++e){S(3*a[e]);for(let e=0;e<r;++e)o[s]=E,o[s+1]=b,o[s+2]=y,s+=l}}function xi(e,t,i,s,r=1){if(!t)return void gi(e,i,s,r);const{data:n,indices:a}=e,o=t,l=i.typedBuffer,c=i.typedBufferStride,u=a.length,d=o[0],f=o[1],h=o[2],m=o[4],p=o[5],g=o[6],v=o[8],_=o[9],A=o[10],x=!ae(o),T=1e-6,E=.999999;s*=c;let b=0,y=0,S=0;const P=ne(o)?e=>{b=n[e],y=n[e+1],S=n[e+2]}:e=>{const t=n[e],i=n[e+1],s=n[e+2];b=d*t+m*i+v*s,y=f*t+p*i+_*s,S=h*t+g*i+A*s};if(1===r)if(x)for(let e=0;e<u;++e){P(3*a[e]);const t=b*b+y*y+S*S;if(t<E&&t>T){const e=1/Math.sqrt(t);l[s]=b*e,l[s+1]=y*e,l[s+2]=S*e}else l[s]=b,l[s+1]=y,l[s+2]=S;s+=c}else for(let e=0;e<u;++e)P(3*a[e]),l[s]=b,l[s+1]=y,l[s+2]=S,s+=c;else for(let e=0;e<u;++e){if(P(3*a[e]),x){const e=b*b+y*y+S*S;if(e<E&&e>T){const t=1/Math.sqrt(e);b*=t,y*=t,S*=t}}for(let e=0;e<r;++e)l[s]=b,l[s+1]=y,l[s+2]=S,s+=c}}function Ti(e,t,i,s,r=1){const{data:n,indices:a}=e,o=i.typedBuffer,l=i.typedBufferStride,c=a.length;if(s*=l,t!==n.length||4!==t)if(1!==r)if(4!==t)for(let e=0;e<c;++e){const t=3*a[e];for(let e=0;e<r;++e)o[s]=n[t],o[s+1]=n[t+1],o[s+2]=n[t+2],o[s+3]=255,s+=l}else for(let e=0;e<c;++e){const t=4*a[e];for(let e=0;e<r;++e)o[s]=n[t],o[s+1]=n[t+1],o[s+2]=n[t+2],o[s+3]=n[t+3],s+=l}else{if(4===t){for(let e=0;e<c;++e){const t=4*a[e];o[s]=n[t],o[s+1]=n[t+1],o[s+2]=n[t+2],o[s+3]=n[t+3],s+=l}return}for(let e=0;e<c;++e){const t=3*a[e];o[s]=n[t],o[s+1]=n[t+1],o[s+2]=n[t+2],o[s+3]=255,s+=l}}else{o[s]=n[0],o[s+1]=n[1],o[s+2]=n[2],o[s+3]=n[3];const e=new Uint32Array(i.typedBuffer.buffer,i.start),t=l/4,a=e[s/=4];s+=t;const u=c*r;for(let i=1;i<u;++i)e[s]=a,s+=t}}function Ei(e,t,i,s){_(bi,e,t);const r=Math.max(Math.sqrt(A(bi)),1e-4);m(bi,bi,1/r),i[s++]=bi[0],i[s++]=bi[1],i[s++]=bi[2],i[s++]=r}const bi=N();function yi(e,t,i,s,r=1){const n=t.typedBuffer,a=t.typedBufferStride;if(s*=a,1===r)for(let t=0;t<i;++t)n[s]=e[0],n[s+1]=e[1],n[s+2]=e[2],n[s+3]=e[3],s+=a;else for(let t=0;t<i;++t)for(let t=0;t<r;++t)n[s]=e[0],n[s+1]=e[1],n[s+2]=e[2],n[s+3]=e[3],s+=a}function Si(e,t,i,s,r,n,a){let o={numItems:0,numVerticesPerItem:0};for(const l of i.fields.keys()){const i=e.get(l),c=i?.indices;if(i&&c)l===$.POSITION&&(o={numItems:1,numVerticesPerItem:c.length}),Pi(l,i,s,r,n,a);else if(l===$.OLIDCOLOR&&null!=t){const i=e.get($.POSITION)?.indices;if(i){const e=i.length;yi(t,n.getField(l,y),e,a)}}}return o}function Pi(e,t,i,s,r,n){switch(e){case $.POSITION:{b(3===t.size);const s=r.getField(e,P);b(!!s,`No buffer view for ${e}`),Ai(t,i,s,n);break}case $.NORMAL:{b(3===t.size);const i=r.getField(e,P);b(!!i,`No buffer view for ${e}`),xi(t,s,i,n);break}case $.NORMALCOMPRESSED:case $.PROFILERIGHT:case $.PROFILEUP:{b(2===t.size);const i=r.getField(e,M);b(!!i,`No buffer view for ${e}`),pi(t,i,n);break}case $.UV0:{b(2===t.size);const i=r.getField(e,O)??r.getField(e,L);b(!!i,`No buffer view for ${e}`),pi(t,i,n);break}case $.UVI:{b(2===t.size);const i=r.getField(e,M);b(!!i,`No buffer view for ${e}`),pi(t,i,n);break}case $.COLOR:case $.SYMBOLCOLOR:{const i=r.getField(e,y);b(!!i,`No buffer view for ${e}`),b(3===t.size||4===t.size),Ti(t,t.size,i,n);break}case $.COLORFEATUREATTRIBUTE:case $.OPACITYFEATUREATTRIBUTE:case $.SIZEFEATUREATTRIBUTE:{const i=r.getField(e,I)??r.getField(e,I);b(!!i,`No buffer view for ${e}`),b(1===t.size),function(e,t,i){const{data:s,indices:r}=e,n=t.typedBuffer,a=t.typedBufferStride,o=r.length,l=s[0];i*=a;for(let e=0;e<o;++e)n[i]=l,i+=a}(t,i,n);break}case $.TANGENT:{b(4===t.size);const s=r.getField(e,w);b(!!s,`No buffer view for ${e}`),function(e,t,i,s,r=1){if(!t)return void vi(e,i,s,r);const{data:n,indices:a}=e,o=t,l=i.typedBuffer,c=i.typedBufferStride,u=a.length,d=o[0],f=o[1],h=o[2],m=o[4],p=o[5],g=o[6],v=o[8],_=o[9],A=o[10],x=!ae(o),T=1e-6,E=.999999;if(s*=c,1===r)for(let e=0;e<u;++e){const t=4*a[e],i=n[t],r=n[t+1],o=n[t+2],u=n[t+3];let b=d*i+m*r+v*o,y=f*i+p*r+_*o,S=h*i+g*r+A*o;if(x){const e=b*b+y*y+S*S;if(e<E&&e>T){const t=1/Math.sqrt(e);b*=t,y*=t,S*=t}}l[s]=b,l[s+1]=y,l[s+2]=S,l[s+3]=u,s+=c}else for(let e=0;e<u;++e){const t=4*a[e],i=n[t],o=n[t+1],u=n[t+2],b=n[t+3];let y=d*i+m*o+v*u,S=f*i+p*o+_*u,P=h*i+g*o+A*u;if(x){const e=y*y+S*S+P*P;if(e<E&&e>T){const t=1/Math.sqrt(e);y*=t,S*=t,P*=t}}for(let e=0;e<r;++e)l[s]=y,l[s+1]=S,l[s+2]=P,l[s+3]=b,s+=c}}(t,i,s,n);break}case $.PROFILEVERTEXANDNORMAL:{b(4===t.size);const i=r.getField(e,C)??r.getField(e,w);b(!!i,`No buffer view for ${e}`),vi(t,i,n);break}case $.PROFILEAUXDATA:{b(3===t.size);const i=r.getField(e,S)??r.getField(e,P);b(!!i,`No buffer view for ${e}`),gi(t,i,n);break}}}var Ci,wi;function Ii(e,t){switch(t.textureCoordinateType){case Ci.Default:return e.attributes.add($.UV0,"vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(pe`void forwardTextureCoordinates() { vuv0 = uv0; }`);case Ci.Atlas:return e.attributes.add($.UV0,"vec2"),e.attributes.add($.UVREGION,"vec4"),e.varyings.add("vuv0","vec2"),e.varyings.add("vuvRegion","vec4"),void e.vertex.code.add(pe`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:s(t.textureCoordinateType);case Ci.None:return void e.vertex.code.add(pe`void forwardTextureCoordinates() {}`);case Ci.COUNT:return}}function Mi(e){e.fragment.code.add(pe`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)}function Oi(e,t){const{textureCoordinateType:i}=t;if(i===Ci.None||i===Ci.COUNT)return;e.include(Ii,t);const s=i===Ci.Atlas;s&&e.include(Mi),e.fragment.code.add(pe`
    vec4 textureLookup(sampler2D tex, vec2 uv) {
      return ${s?"textureAtlasLookup(tex, uv, vuvRegion)":"texture(tex, uv)"};
    }
  `)}!function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Atlas=2]="Atlas",e[e.COUNT=3]="COUNT"}(Ci||(Ci={}));class Li extends le{constructor(e,t){super(e,"float",Ee.Draw,((i,s,r)=>i.setUniform1f(e,t(s,r))))}}class Ri extends le{constructor(e,t){super(e,"float",Ee.Pass,((i,s,r)=>i.setUniform1f(e,t(s,r))))}}class zi extends le{constructor(e,t){super(e,"sampler2D",Ee.Pass,((i,s,r)=>i.bindTexture(e,t(s,r))))}}function Di(e,t){if(!_e(t.output))return;const{emissionSource:i,hasEmissiveTextureTransform:s,bindType:r}=t,n=i===wi.Texture;n&&(e.include(Oi,t),e.fragment.uniforms.add(r===Ee.Pass?new zi("texEmission",(e=>e.textureEmissive)):new ce("texEmission",(e=>e.textureEmissive))));const a=i===wi.EmissiveColor||n;a&&e.fragment.uniforms.add(r===Ee.Pass?new ue("emissiveBaseColor",(e=>e.emissiveBaseColor)):new de("emissiveBaseColor",(e=>e.emissiveBaseColor)));const o=i!==wi.None;o&&e.fragment.uniforms.add(r===Ee.Pass?new Ri("emissiveStrength",(e=>e.emissiveStrength)):new Li("emissiveStrength",(e=>e.emissiveStrength)));const l=i===wi.SymbolColor;e.fragment.code.add(pe`
    vec4 getEmissions(vec3 symbolColor) {
      vec4 emissions = ${a?"vec4(emissiveBaseColor, 1.0)":l?"vec4(symbolColor, 1.0)":"vec4(0.0)"};
      ${ge(n,`emissions *= textureLookup(texEmission, ${s?"emissiveUV":"vuv0"});\n         emissions.w = emissions.rgb == vec3(0.0) ? 0.0: emissions.w;`)}
      ${ge(o,"emissions.rgb *= emissiveStrength;")}
      return emissions;
    }
  `)}!function(e){e[e.None=0]="None",e[e.SymbolColor=1]="SymbolColor",e[e.EmissiveColor=2]="EmissiveColor",e[e.Texture=3]="Texture",e[e.COUNT=4]="COUNT"}(wi||(wi={}));class Ni extends ve{constructor(e){super(),this.slicePlaneLocalOrigin=e}}function Ui(e,t){Hi(e,t,new ue("slicePlaneOrigin",((e,i)=>qi(t,e,i))),new ue("slicePlaneBasis1",((e,i)=>Ki(t,e,i,i.slicePlane?.basis1))),new ue("slicePlaneBasis2",((e,i)=>Ki(t,e,i,i.slicePlane?.basis2))))}function Fi(e,t){Hi(e,t,new de("slicePlaneOrigin",((e,i)=>qi(t,e,i))),new de("slicePlaneBasis1",((e,i)=>Ki(t,e,i,i.slicePlane?.basis1))),new de("slicePlaneBasis2",((e,i)=>Ki(t,e,i,i.slicePlane?.basis2))))}function Bi(e,t){ki(e,t,new de("slicePlaneOrigin",((e,i)=>qi(t,e,i))),new de("slicePlaneBasis1",((e,i)=>Ki(t,e,i,i.slicePlane?.basis1))),new de("slicePlaneBasis2",((e,i)=>Ki(t,e,i,i.slicePlane?.basis2))))}const Vi=pe`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function ki(e,t,...i){t.hasSlicePlane?(e.uniforms.add(...i),e.code.add(Vi)):e.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function Hi(e,t,...i){ki(e,t,...i),t.hasSlicePlane?e.code.add("\n    void discardBySlice(vec3 pos) {\n      if (sliceByPlane(pos)) {\n        discard;\n      }\n    }\n\n    vec4 applySliceOutline(vec4 color, vec3 pos) {\n      SliceFactors factors = calculateSliceFactors(pos);\n\n      factors.front /= 2.0 * fwidth(factors.front);\n      factors.side0 /= 2.0 * fwidth(factors.side0);\n      factors.side1 /= 2.0 * fwidth(factors.side1);\n      factors.side2 /= 2.0 * fwidth(factors.side2);\n      factors.side3 /= 2.0 * fwidth(factors.side3);\n\n      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth\n      if (sliceByFactors(factors)) {\n        return color;\n      }\n\n      float outlineFactor = (1.0 - step(0.5, factors.front))\n        * (1.0 - step(0.5, factors.side0))\n        * (1.0 - step(0.5, factors.side1))\n        * (1.0 - step(0.5, factors.side2))\n        * (1.0 - step(0.5, factors.side3));\n\n      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);\n    }\n\n    vec4 applySlice(vec4 color, vec3 pos) {\n      return sliceEnabled() ? applySliceOutline(color, pos) : color;\n    }\n  "):e.code.add(pe`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function ji(e,t,i){return e.instancedDoublePrecision?f(Xi,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function Gi(e,t){return null!=e?_(Wi,t.origin,e):t.origin}function $i(e,t,i){return e.hasSliceTranslatedView?null!=t?te(Qi,i.camera.viewMatrix,t):i.camera.viewMatrix:null}function qi(e,t,i){if(null==i.slicePlane)return B;const s=ji(e,t,i),r=Gi(s,i.slicePlane),n=$i(e,s,i);return null!=n?g(Wi,r,n):r}function Ki(e,t,i,s){if(null==s||null==i.slicePlane)return B;const r=ji(e,t,i),n=Gi(r,i.slicePlane),a=$i(e,r,i);return null!=a?(h(Yi,s,n),g(Wi,n,a),g(Yi,Yi,a),_(Yi,Yi,Wi)):s}const Xi=N(),Wi=N(),Yi=N(),Qi=c();function Zi(e,t){if(t.output!==Ae.ObjectAndLayerIdColor)return e.vertex.code.add(pe`void forwardObjectAndLayerIdColor() {}`),void e.fragment.code.add(pe`void outputObjectAndLayerIdColor() {}`);const i=t.objectAndLayerIdColorInstanced;e.varyings.add("objectAndLayerIdColorVarying","vec4"),e.attributes.add(i?$.INSTANCEOBJECTANDLAYERIDCOLOR:$.OLIDCOLOR,"vec4"),e.vertex.code.add(pe`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${i?"instanceObjectAndLayerIdColor":"objectAndLayerIdColor"} * 0.003921568627451;
    }`),e.fragment.code.add(pe`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)}class Ji extends le{constructor(e,t){super(e,"vec4",Ee.Pass,((i,s,r)=>i.setUniform4fv(e,t(s,r))))}}class es extends le{constructor(e,t,i){super(e,"vec4",Ee.Pass,((i,s,r)=>i.setUniform4fv(e,t(s,r))),i)}}class ts extends le{constructor(e,t,i){super(e,"float",Ee.Pass,((i,s,r)=>i.setUniform1fv(e,t(s,r))),i)}}function is(e,t){const{vertex:i,attributes:s}=e;t.hasVvInstancing&&(t.vvSize||t.vvColor)&&s.add($.INSTANCEFEATUREATTRIBUTE,"vec4"),t.vvSize?(i.uniforms.add(new ue("vvSizeMinSize",(e=>e.vvSize.minSize))),i.uniforms.add(new ue("vvSizeMaxSize",(e=>e.vvSize.maxSize))),i.uniforms.add(new ue("vvSizeOffset",(e=>e.vvSize.offset))),i.uniforms.add(new ue("vvSizeFactor",(e=>e.vvSize.factor))),i.uniforms.add(new ue("vvSizeFallback",(e=>e.vvSize.fallback))),i.uniforms.add(new fe("vvSymbolRotationMatrix",(e=>e.vvSymbolRotationMatrix))),i.uniforms.add(new ue("vvSymbolAnchor",(e=>e.vvSymbolAnchor))),i.code.add(pe`vec3 vvScale(vec4 _featureAttribute) {
if (isnan(_featureAttribute.x)) {
return vvSizeFallback;
}
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),i.code.add(pe`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 scale = max(vvScale(_featureAttribute), eps);
        return vec4(vvSymbolRotationMatrix * _normal / scale, 1.0);
      }

      ${t.hasVvInstancing?pe`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):i.code.add(pe`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vvColor?(i.constants.add("vvColorNumber","int",8),i.uniforms.add(new ts("vvColorValues",(e=>e.vvColor.values),8),new es("vvColorColors",(e=>e.vvColor.colors),8),new Ji("vvColorFallback",(e=>e.vvColor.fallback))),i.code.add(pe`
      vec4 interpolateVVColor(float value) {
        if (isnan(value)) {
          return vvColorFallback;
        }

        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${t.hasVvInstancing?pe`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }`:"vec4 vvColor() { return vec4(1.0); }"}
    `)):i.code.add(pe`vec4 vvColor() { return vec4(1.0); }`)}class ss extends le{constructor(e,t){super(e,"vec3",Ee.Bind,((i,s)=>i.setUniform3fv(e,t(s))))}}class rs extends le{constructor(e,t){super(e,"mat4",Ee.Draw,((i,s,r)=>i.setUniformMatrix4fv(e,t(s,r))))}}function ns(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",B):e.uniforms.add(new de("cameraPosition",((e,t)=>f(ls,t.camera.viewInverseTransposeMatrix[3]-e.origin[0],t.camera.viewInverseTransposeMatrix[7]-e.origin[1],t.camera.viewInverseTransposeMatrix[11]-e.origin[2]))))}function as(e,t){if(!t.instancedDoublePrecision)return void e.uniforms.add(new me("proj",(e=>e.camera.projectionMatrix)),new rs("view",((e,t)=>te(os,t.camera.viewMatrix,e.origin))),new de("localOrigin",(e=>e.origin)));const i=({camera:e})=>f(ls,e.viewInverseTransposeMatrix[3],e.viewInverseTransposeMatrix[7],e.viewInverseTransposeMatrix[11]);e.uniforms.add(new me("proj",(e=>e.camera.projectionMatrix)),new me("view",(e=>te(os,e.camera.viewMatrix,i(e)))),new ss("localOrigin",(e=>i(e))))}const os=c(),ls=N();function cs(e){e.uniforms.add(new me("viewNormal",(e=>e.camera.viewInverseTransposeMatrix)))}function us(e){e.uniforms.add(new he("pixelRatio",(e=>e.camera.pixelRatio/e.overlayStretch)))}let ds,fs=null,hs=null;async function ms(){return null==hs&&(ds??=(async()=>{const e=await import("./basis_transcoder.js"),t=await e.default({locateFile:e=>Xe(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t})(),hs=ds,fs=await hs),hs}function ps(e,t,i,s,r){const n=X(t?Ye.COMPRESSED_RGBA8_ETC2_EAC:Ye.COMPRESSED_RGB8_ETC2),a=r&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*s*n*a)}function gs(e){return e.getNumImages()>=1&&!e.isUASTC()}function vs(e){return e.getFaces()>=1&&e.isETC1S()}function _s(e,t,i,s,r,n,a,o){const{compressedTextureETC:l,compressedTextureS3TC:c}=e.capabilities,[u,d]=l?s?[We.ETC2_RGBA,Ye.COMPRESSED_RGBA8_ETC2_EAC]:[We.ETC1_RGB,Ye.COMPRESSED_RGB8_ETC2]:c?s?[We.BC3_RGBA,Ye.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[We.BC1_RGB,Ye.COMPRESSED_RGB_S3TC_DXT1_EXT]:[We.RGBA32,Qe.RGBA],f=t.hasMipmap?i:Math.min(1,i),h=[];for(let e=0;e<f;e++)h.push(new Uint8Array(a(e,u))),o(e,u,h[e]);return t.internalFormat=d,t.hasMipmap=h.length>1,t.samplingMode=t.hasMipmap?Ze.LINEAR_MIPMAP_LINEAR:Ze.LINEAR,t.width=r,t.height=n,new K(e,t,{type:"compressed",levels:h})}const As=()=>lt.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function xs(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const Ts=xs("DXT1"),Es=xs("DXT3"),bs=xs("DXT5"),ys=16;function Ss(e,t){return t=Math.floor(t/ys)*ys,Math.min(Math.round(e/ys)*ys,t)}function Ps(e,t){return t=Math.floor(t/ys)*ys,Math.min(Math.ceil(e/ys)*ys,t)}function Cs(e,t){const[i,s]=ws(e,t);return e.width===i&&e.height===s?e:Is(e,i,s)}function ws({width:e,height:t},{maxPreferredTexturePixels:i,maxTextureSize:s}){const r=Math.max(e,t),n=e*t;if(r<=s&&n<=i)return[e,t];const a=Math.min(Math.sqrt(i/n),s/r);return[Ss(Math.round(e*a),s),Ss(Math.round(t*a),s)]}function Is(e,t,i){if(e instanceof ImageData)return Is(function(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");if(null==i)throw new Ne("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return i.putImageData(e,0,0),t}(e),t,i);const s=document.createElement("canvas");return s.width=t,s.height=i,s.getContext("2d").drawImage(e,0,0,s.width,s.height),s}class Ms{constructor(e,t){this._data=e,this.id=a(),this.events=new Ue,this._parameters={...Ls,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(je(e.src)||"auto"===e.preload&&e.crossOrigin)&&(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src,e.paused&&e.autoplay)){const t=[];$e(e,(e=>t.push(e))).then((()=>{e.play()})).finally((()=>t.forEach((e=>e.remove()))))}}_startPreloadImageElement(e){Ge(e.src)||je(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new W;return t.wrapMode=this._parameters.wrap??Je.REPEAT,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?Ze.LINEAR_MIPMAP_LINEAR:Ze.LINEAR,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return null!=this._glTexture}get usedMemory(){return this._glTexture?.usedMemory||function(e,t){if(null==e)return 0;if(n(e)||r(e))return t.encoding===j.KTX2_ENCODING?function(e,t){if(null==fs)return e.byteLength;const i=new fs.KTX2File(new Uint8Array(e)),s=vs(i)?ps(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),t):0;return i.close(),i.delete(),s}(e,!!t.mipmap):t.encoding===j.BASIS_ENCODING?function(e,t){if(null==fs)return e.byteLength;const i=new fs.BasisFile(new Uint8Array(e)),s=gs(i)?ps(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),t):0;return i.close(),i.delete(),s}(e,!!t.mipmap):e.byteLength;const{width:i,height:s}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?Os(e):t;return(t.mipmap?4/3:1)*i*s*(t.components||4)||0}(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const t=this._data;return null==t?(this._glTexture=new K(e,this._createDescriptor(e),null),this._glTexture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),"string"==typeof t?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):r(t)&&this._parameters.encoding===j.DDS_ENCODING?this._loadFromDDSData(e,t):n(t)&&this._parameters.encoding===j.DDS_ENCODING?this._loadFromDDSData(e,new Uint8Array(t)):(n(t)||r(t))&&this._parameters.encoding===j.KTX2_ENCODING?this._loadFromKTX2(e,t):(n(t)||r(t))&&this._parameters.encoding===j.BASIS_ENCODING?this._loadFromBasis(e,t):r(t)?this._loadFromPixelData(e,t):n(t)?this._loadFromPixelData(e,new Uint8Array(t)):null)}_update(e,t){return null==this._glTexture||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=function(e,t,i){const s=function(e,t){const i=new Int32Array(e.buffer,e.byteOffset,31);if(542327876!==i[0])return As().error("Invalid magic number in DDS header"),null;if(!(4&i[20]))return As().error("Unsupported format, must contain a FourCC code"),null;const s=i[21];let r,n;switch(s){case Ts:r=8,n=Ye.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Es:r=16,n=Ye.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case bs:r=16,n=Ye.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return As().error("Unsupported FourCC code:",(a=s,String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255))),null}var a;let o=1,l=i[4],c=i[3];(3&l||3&c)&&(As().warn("Rounding up compressed texture size to nearest multiple of 4."),l=l+3&-4,c=c+3&-4);const u=l,d=c;131072&i[2]&&!1!==t&&(o=Math.max(1,i[7]));let f,h,m=e.byteOffset+i[1]+4;const p=[];for(let t=0;t<o;++t)h=(l+3>>2)*(c+3>>2)*r,f=new Uint8Array(e.buffer,m,h),p.push(f),m+=h,l=Math.max(1,l>>1),c=Math.max(1,c>>1);return{textureData:{type:"compressed",levels:p},internalFormat:n,width:u,height:d}}(i,t.hasMipmap??!1);if(null==s)throw new Error("DDS texture data is null");const{textureData:r,internalFormat:n,width:a,height:o}=s;return t.samplingMode=r.levels.length>1?Ze.LINEAR_MIPMAP_LINEAR:Ze.LINEAR,t.hasMipmap=r.levels.length>1,t.internalFormat=n,t.width=a,t.height=o,new K(e,t,r)}(e,this._createDescriptor(e),t),this._emptyTexture=null,this._glTexture}_loadFromKTX2(e,t){return this._loadAsync((()=>async function(e,t,i){null==fs&&(fs=await ms());const s=new fs.KTX2File(new Uint8Array(i));if(!vs(s))return null;s.startTranscoding();const r=_s(e,t,s.getLevels(),s.getHasAlpha(),s.getWidth(),s.getHeight(),((e,t)=>s.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,i)=>s.transcodeImage(i,e,0,0,t,0,-1,-1)));return s.close(),s.delete(),r}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromBasis(e,t){return this._loadAsync((()=>async function(e,t,i){null==fs&&(fs=await ms());const s=new fs.BasisFile(new Uint8Array(i));if(!gs(s))return null;s.startTranscoding();const r=_s(e,t,s.getNumLevels(0),s.getHasAlpha(),s.getImageWidth(0,0),s.getImageHeight(0,0),((e,t)=>s.getImageTranscodedSizeInBytes(0,e,t)),((e,t,i)=>s.transcodeImage(i,0,e,t,0,0)));return s.close(),s.delete(),r}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromPixelData(e,t){b(this._parameters.width>0&&this._parameters.height>0);const i=this._createDescriptor(e);return i.pixelFormat=1===this._parameters.components?Qe.LUMINANCE:3===this._parameters.components?Qe.RGB:Qe.RGBA,i.pixelFormat!==Qe.RGB&&i.pixelFormat!==Qe.RGBA||(i.compress=this._parameters.compressionOptions),i.width=this._parameters.width??0,i.height=this._parameters.height??0,this._glTexture=new K(e,i,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync((async i=>{const s=await qe(t,{signal:i});return Ve(i),this._loadFromImage(e,s)}))}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync((async i=>{const s=await Ke(t,t.src,!1,i);return Ve(i),this._loadFromImage(e,s)}))}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync((i=>new Promise(((s,r)=>{const n=()=>{t.removeEventListener("loadeddata",a),t.removeEventListener("error",o),Be(l)},a=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(n(),s(this._loadFromImage(e,t)))},o=e=>{n(),r(e||new Ne("texture:load-error","Failed to load video"))};t.addEventListener("loadeddata",a),t.addEventListener("error",o);const l=ke(i,(()=>o(He())))}))))}_loadFromImage(e,t){let i=t;i instanceof HTMLVideoElement||(i=Cs(i,e.parameters));const s=Os(i);this._parameters.width=s.width,this._parameters.height=s.height;const r=this._createDescriptor(e);return r.pixelFormat=3===this._parameters.components?Qe.RGB:Qe.RGBA,r.width=s.width,r.height=s.height,r.compress=this._parameters.compressionOptions,this._glTexture=new K(e,r,i),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const i=e(t.signal);this._loadingPromise=i;const s=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===i&&(this._loadingPromise=null),this._emptyTexture=null};return i.then(s,s),i}unload(){if(this._glTexture=Fe(this._glTexture),this._emptyTexture=null,null!=this._loadingController){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}}function Os(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}const Ls={wrap:{s:Je.REPEAT,t:Je.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};function Rs(e){const t=.3183098861837907;e.constants.add("PI","float",3.141592653589793),e.constants.add("LIGHT_NORMALIZATION","float",t),e.constants.add("INV_PI","float",t),e.constants.add("HALF_PI","float",1.570796326794897),e.constants.add("TWO_PI","float",6.28318530717958)}class zs extends le{constructor(e,t){super(e,"vec2",Ee.Bind,((i,s)=>i.setUniform2fv(e,t(s))))}}function Ds(e){e.uniforms.add(new zs("zProjectionMap",(e=>function(e){const t=e.projectionMatrix;return ct(Ns,t[14],t[10])}(e.camera)))),e.code.add(pe`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),e.code.add(pe`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),e.code.add(pe`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}const Ns=ut();class Us extends le{constructor(e,t){super(e,"sampler2D",Ee.Bind,((i,s)=>i.bindTexture(e,t(s))))}}function Fs(e,{occlusionPass:t,terrainDepthTest:i,cullAboveTerrain:s}){const{vertex:r,fragment:n,varyings:a}=e;if(!i)return r.code.add("void forwardViewPosDepth(vec3 pos) {}"),void n.code.add(`${t?"bool":"void"} discardByTerrainDepth() { ${ge(t,"return false;")}}`);a.add("viewPosDepth","float",{invariant:!0}),r.code.add("void forwardViewPosDepth(vec3 pos) {\n    viewPosDepth = pos.z;\n  }"),n.include(Ds),n.uniforms.add(new Us("terrainDepthTexture",(e=>e.terrainDepth?.attachment))).code.add(pe`
    ${t?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${t?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${s?">":"<="} linearDepth) discard;`}
    }`)}function Bs(e){e.code.add(pe`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}class Vs extends le{constructor(e,t){super(e,"vec4",Ee.Bind,((i,s)=>i.setUniform4fv(e,t(s))))}}function ks(e){const{fragment:t}=e;t.code.add(pe`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(uvec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return texel[lic];
}
uint readLevelBits(uvec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)}class Hs extends le{constructor(e,t){super(e,"ivec2",Ee.Bind,((i,s)=>i.setUniform2iv(e,t(s))))}}class js extends le{constructor(e,t){super(e,"int",Ee.Bind,((i,s)=>i.setUniform1i(e,t(s))))}}class Gs extends le{constructor(e,t){super(e,"usampler2D",Ee.Bind,((i,s)=>i.bindTexture(e,t(s))))}}function $s(e,t){const{fragment:i}=e,{output:s,draped:r,hasHighlightMixTexture:n}=t;s===Ae.Highlight?(i.uniforms.add(new js("highlightLevel",(e=>e.highlightLevel??0)),new Hs("highlightMixOrigin",(e=>e.highlightMixOrigin))),e.outputs.add("fragHighlight","uvec2",0),e.include(ks),n?i.uniforms.add(new Gs("highlightMixTexture",(e=>e.highlightMixTexture))).code.add(pe`uvec2 getAccumulatedHighlight() {
return texelFetch(highlightMixTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
uvec2 combinedHighlight = getAccumulatedHighlight();
combinedHighlight[li] |= bits;
fragHighlight = combinedHighlight;
}
}`):i.code.add(pe`void outputHighlight(bool occluded) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
}`),r?i.code.add(pe`bool isHighlightOccluded() {
return false;
}`):i.uniforms.add(new Us("depthTexture",(e=>e.mainDepth))).code.add(pe`bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}`),i.code.add(pe`void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`)):i.code.add(pe`void calculateOcclusionAndOutputHighlight() {}`)}function qs(e,t){e.include($s,t),e.include(Di,t),e.fragment.include(Bs);const{output:i,oitPass:s,discardInvisibleFragments:r,snowCover:n}=t,a=i===Ae.ObjectAndLayerIdColor,o=xe(i),l=_e(i)&&s===ze.ColorAlpha,c=_e(i)&&s!==ze.ColorAlpha;let u=0;(c||o||l)&&e.outputs.add("fragColor","vec4",u++),o&&e.outputs.add("fragEmission","vec4",u++),l&&e.outputs.add("fragAlpha","float",u++),e.fragment.code.add(pe`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition, vec3 emissiveBaseColor ${ge(n,", float snow")}) {
      ${ge(a,"finalColor.a = 1.0;")}

      ${ge(r,`if (finalColor.a < ${pe.float(dt)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${ge(l,pe`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${ge(c,"fragColor = finalColor;")}
      ${ge(o,`fragEmission = ${ge(n,"mix(finalColor.a * getEmissions(emissiveBaseColor), vec4(0.0), snow);","finalColor.a * getEmissions(emissiveBaseColor);")}`)}
      calculateOcclusionAndOutputHighlight();
      ${ge(a,"outputObjectAndLayerIdColor();")}
    }
  `)}class Ks{constructor(e,t){this._module=e,this._load=t}get(){return this._module}async reload(){return this._module=await this._load(),this._module}}class Xs{constructor(e,t,i){this._context=e,this._locations=i,this._textures=new Map,this._glProgram=e.programCache.acquire(t.generate("vertex",!0),t.generate("fragment",!0),i),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=t.generateBind(this),this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t){this._glProgram.setUniform1f(e,t)}setUniform2fv(e,t){this._glProgram.setUniform2fv(e,t)}setUniform3fv(e,t){this._glProgram.setUniform3fv(e,t)}setUniform4fv(e,t){this._glProgram.setUniform4fv(e,t)}setUniformMatrix3fv(e,t){this._glProgram.setUniformMatrix3fv(e,t)}setUniformMatrix4fv(e,t){this._glProgram.setUniformMatrix4fv(e,t)}setUniform1fv(e,t){this._glProgram.setUniform1fv(e,t)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear()}bindTexture(e,t){t?.glName||(q()&&console.error(`Texture sampler ${e} has no given Texture in ${(new Error).stack} `),t=this._context.emptyTexture);const i=this._ensureTextureUnit(e,t);this._context.useProgram(this),this.setUniform1i(e,i.unit),this._context.bindTexture(t,i.unit)}_ensureTextureUnit(e,t){let i=this._textures.get(e);return null==i?(i={texture:t,unit:this._textures.size},this._textures.set(e,i)):i.texture=t,i}}class Ws{constructor(e,t,i,s=De){this.locations=s,this.primitiveType=et.TRIANGLES,this.key=t.key,this._program=new Xs(e.rctx,i.get().build(t),s),this._pipeline=this.initializePipeline(t),this.reload=async r=>{r&&await i.reload(),this.key.equals(t.key)||lt.getLogger("esri.views.3d.webgl.ShaderTechnique").warn("Configuration was changed after construction, cannot reload shader.",i),Fe(this._program),this._program=new Xs(e.rctx,i.get().build(t),s),this._pipeline=this.initializePipeline(t)}}destroy(){this._program=Fe(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,t){return this._pipeline}initializePipeline(e){return ft({blending:mt,colorWrite:ht})}}function Ys(e,t){return Te(e)?{buffers:[tt.NONE]}:t??null}const Qs=pt(at.ONE,at.ZERO,at.ONE,at.ONE_MINUS_SRC_ALPHA);function Zs(e){return e===ze.FrontFace?null:Qs}function Js(e){switch(e){case ze.NONE:return vt;case ze.ColorAlpha:return Qs;case ze.FrontFace:case ze.COUNT:return null}}function er(e){if(e.draped)return null;switch(e.oitPass){case ze.NONE:case ze.FrontFace:return e.writeDepth?gt:null;case ze.ColorAlpha:case ze.COUNT:return null}}const tr=5e5,ir={factor:-1,units:-2};function sr({oitPass:e,enableOffset:t}){return t&&e===ze.ColorAlpha?ir:null}function rr(e,t=it.LESS){return e===ze.NONE||e===ze.FrontFace?t:it.LEQUAL}function nr(e,t){const i=xe(t);return e===ze.ColorAlpha?i?{buffers:[st,rt,nt]}:{buffers:[st,rt]}:i?{buffers:[st,rt]}:null}const ar={func:it.LESS},or={func:it.ALWAYS},lr={mask:255},cr={mask:0},ur=e=>({function:{func:it.NOTEQUAL,ref:e,mask:e},operation:{fail:ot.KEEP,zFail:ot.KEEP,zPass:ot.KEEP}}),dr=e=>({function:{func:it.ALWAYS,ref:e,mask:e},operation:{fail:ot.KEEP,zFail:ot.KEEP,zPass:ot.REPLACE}}),fr={function:{func:it.ALWAYS,ref:G.OutlineVisualElementMask,mask:G.OutlineVisualElementMask},operation:{fail:ot.KEEP,zFail:ot.KEEP,zPass:ot.ZERO}},hr={function:{func:it.ALWAYS,ref:G.OutlineVisualElementMask,mask:G.OutlineVisualElementMask},operation:{fail:ot.KEEP,zFail:ot.KEEP,zPass:ot.REPLACE}},mr={function:{func:it.EQUAL,ref:G.OutlineVisualElementMask,mask:G.OutlineVisualElementMask},operation:{fail:ot.KEEP,zFail:ot.KEEP,zPass:ot.KEEP}},pr={function:{func:it.NOTEQUAL,ref:G.OutlineVisualElementMask,mask:G.OutlineVisualElementMask},operation:{fail:ot.KEEP,zFail:ot.KEEP,zPass:ot.KEEP}};class gr extends le{constructor(e,t){super(e,"mat4",Ee.Pass,((i,s,r)=>i.setUniformMatrix4fv(e,t(s,r))))}}export{gr as $,mr as A,cr as B,Bs as C,ar as D,Ut as E,Vs as F,Vt as G,Ei as H,At as I,is as J,Zi as K,sr as L,Ci as M,wi as N,$s as O,tr as P,Zs as Q,Ks as R,Fi as S,Ms as T,mi as U,fi as V,Pi as W,pi as X,Ds as Y,Ps as Z,Si as _,Nt as a,Bi as a0,oi as a1,Ai as a2,xi as a3,Ti as a4,vi as a5,_i as a6,yi as a7,rs as a8,ss as a9,ws as aA,ur as aB,Ui as aC,dr as aD,ir as aa,Oi as ab,Rs as ac,Ni as ad,ms as ae,Pt as af,Tt as ag,xt as ah,ts as ai,Li as aj,Ss as ak,It as al,Mt as am,li as an,Et as ao,bt as ap,Ii as aq,js as ar,ks as as,ti as at,ii as au,Zt as av,ai as aw,wt as ax,hi as ay,es as az,as as b,ns as c,Ri as d,cs as e,Ct as f,us as g,Us as h,kt as i,Ji as j,zs as k,zi as l,Ws as m,St as n,qs as o,fr as p,lr as q,Ys as r,hr as s,Fs as t,er as u,rr as v,Js as w,nr as x,pr as y,or as z};
