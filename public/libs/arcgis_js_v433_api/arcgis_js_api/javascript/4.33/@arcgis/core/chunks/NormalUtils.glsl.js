/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{c as e}from"./vec2f64.js";import{c as t}from"./vec3f64.js";import{f as s,Z as i,c as r}from"./vec4f64.js";import n from"../Color.js";import{i as a,l as o}from"./fontUtils.js";import{L as h}from"./Logger.js";import{p as l}from"./screenUtils.js";import{_ as c}from"./tslib.es6.js";import d from"../core/Accessor.js";import u from"../core/Evented.js";import"../core/lang.js";import{f as _,r as m}from"./maybe.js";import{g as f}from"./watch.js";import{property as g}from"../core/accessorSupport/decorators/property.js";import{subclass as p}from"../core/accessorSupport/decorators/subclass.js";import{a as x,s as v}from"./vec4.js";import{Z as w}from"./Matrix4PassUniform.js";import{T as y,Y as T}from"./Scheduler.js";import{T as b,b as k}from"./enums.js";import{a as R,T as A}from"./Texture.js";import{a as z}from"./basicInterfaces.js";import{g as S}from"./glsl.js";class j{constructor(i,r="center",n=!1,a=e(),o=s(0,0,0,-1),h="world",l=t(),c=0){this.verticalOffset=i,this.anchor=r,this.hasLabelVerticalOffset=n,this.screenOffset=a,this.centerOffset=o,this.centerOffsetUnits=h,this.translation=l,this.elevationOffset=c}}class E{constructor(t,s="center",i="center",r=null,n=e(),a=!0){this.placement=t,this.horizontalPlacement=s,this.verticalPlacement=i,this.text=r,this.displaySize=n,this.isFocused=a}}class C{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=O(e.color),this.haloStyle=`rgb(${e.halo.color.slice(0,3).map((e=>Math.floor(255*e))).toString()})`,this.backgroundStyle=0!==e.background.color[3]?O(e.background.color):null}fontString(e){const t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}static async fromSymbol(e,t){const s=e?.material?.color,r=n.toUnitRGBA(s)??i,c=null!=e.size?l(e.size):12,d=e.lineHeight,u=null!=e.background?n.toUnitRGBA(e.background.color):i,_={family:e.font?.family??"sans-serif",decoration:e.font?.decoration??"none",weight:e.font?.weight??"normal",style:e.font?.style??"normal"},m=e.halo,f=null!=m?.color&&m.size>0?{size:l(m.size),color:n.toUnitRGBA(m.color)}:{size:0,color:i},g=new C({color:r,size:c,background:{color:u,padding:null!=e.background?[.65*c,.5*c]:[0,0],borderRadius:null!=e.background?c*(6/16):0},lineSpacingFactor:d,font:_,halo:f,pixelRatio:t});if(e.font){let t=!1;const s=g.fontString(c);try{t=(await document.fonts.load(s)).some((e=>!a(e)))}catch(e){h.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${s}'. Some text symbology may be rendered using the default browser font.`)}if(!t&&!M.has(e.font.family))try{await o(e.font)}catch(e){}}return g}}function O(e){return`rgba(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()},${e[3]})`}const M=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),P=4096;let N=class extends d{constructor(e){super(e),this.id=f(),this.events=new u,this._glTexture=null,this._atlas=new D(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=_(this._glTexture),this._frameWorker=m(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get loaded(){return null!=this._glTexture}get glTexture(){return this._glTexture}static get maxSize(){return $=0,[P-L-$,P-L-$-U]}load(e){if(this._glTexture)return this._glTexture;const t=new R;return t.wrapMode=b.CLAMP_TO_EDGE,t.samplingMode=k.LINEAR_MIPMAP_LINEAR,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new A(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(y.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=m(this._frameWorker),this._glTexture&&(this._stage.removeTexture(this),this._glTexture=_(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){const{width:s,height:i}=this._atlas;s===e&&i===t||(this._atlas.width=e,this._atlas.height=t,this._glTexture?.resize(e,t),this._glTexture?.updateData(0,0,0,s,i,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach((e=>this._uvCallbacks.get(e.textRenderer.key)?.forEach((t=>t(e.uv))))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,s,i){const r=this._atlas;if(r.width<s||r.height<i)return!1;let n=r.cursors.get(i);if(!n){if(r.height<r.nextY+i)return!1;n=[new W(r.nextY)],r.cursors.set(i,n),r.nextY+=i}let a=n.find((e=>r.width>=e.x+s));if(null==a){if(r.height<r.nextY+i)return!1;a=new W(r.nextY),r.nextY+=i,n.push(a)}return e.setNewPosition(a),this._elements.set(t,e),this._elementsToRender.set(t,e),a.x+=s,!0}_ensureCallbacks(e){const t=this._uvCallbacks.get(e);if(t)return t;const s=new Set;return this._uvCallbacks.set(e,s),s}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){const s=this._uvCallbacks.get(e);return!(!s?.delete(t)||0!==s.size||(this._uvCallbacks.delete(e),0))}_processAddition(e){const t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);const s=this._atlas,i=e.textRenderer.renderedWidth,r=e.textRenderer.renderedHeight,n=i+L,a=r+L+U;if(!this._addAtlasElement(e,t,n,a)){if(this._canRepack)this._reset();else if(s.width<n){const e=w(Math.max(n,1.5*s.width),P);this._resizeAtlas(e,s.height)}else{const e=s.nextY+a,t=w(Math.max(e,1.5*s.height),P);if(t>s.height)this._resizeAtlas(s.width,t);else if(s.width<P){const e=w(1.5*s.width,P);this._resizeAtlas(e,s.height)}}this._elements.set(t,e)}}_renderElement(e){const t=e.commitNewPosition(),s=e.textRenderer;this._ctx.clearRect(t[0]-L,t[1]-L,s.renderedWidth+2*L,s.renderedHeight+2*L),s.render(this._ctx,t[0],t[1]),this._uvCallbacks.get(s.key)?.forEach((t=>t(e.uv)))}get running(){return this.updating}runTask(e){if(null==this._glTexture)return T;for(;this._needsRepack&&(this._canRepack||this._atlas.height<P&&this._atlas.height<P);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach((e=>this._processAddition(e))),e.madeProgress()}if(this._elementsToRender.size>0){for(const[t,s]of this._elementsToRender){if(e.done)break;this._renderElement(s),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){const s=e.key;this._addCallback(s,t);let r=this._elements.get(s);return r?x(r.uv,i)||t(r.uv):(r=new Y(e),this._processAddition(r),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){const s=e.key;this._elements.get(s)&&this._removeCallback(s,t)&&(this._elements.delete(s),this._elementsToRender.delete(s),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}};c([g({constructOnly:!0})],N.prototype,"view",void 0),c([g({type:Boolean})],N.prototype,"updating",void 0),N=c([p("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],N);const L=2,U=2;class Y{constructor(e){this.textRenderer=e,this._uv=r(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return i;const{renderedWidth:e,renderedHeight:t}=this.textRenderer;return v(this._uv,this._xOffset,this._yOffset+t,this._xOffset+e,this._yOffset)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class D{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=$}}class W{constructor(e){this.y=e,this.x=$}}let $=0;class B{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,s){const i=this._material.produces.get(t);if(!i?.(s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,t,s));const r=this._map.get(s);if(r){if(r.ensureResources(e)===z.LOADED)return r;this._repository.requestRender()}return null}}function I(e,t){t.spherical?e.vertex.code.add(S`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(S`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.spherical?e.vertex.code.add(S`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(S`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}export{B as G,j as L,I as N,N as T,C as a,E as b};
