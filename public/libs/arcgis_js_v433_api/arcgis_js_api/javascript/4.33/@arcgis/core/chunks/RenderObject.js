/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{tryProjectWithZConversion as e,canProjectWithoutEngine as t,projectPoint as s}from"./projectionUtils.js";import{g as i}from"./Intersector2.js";import{c as r,j as o,l as n,m as a,k as c,i as l}from"./mat4.js";import{c as h}from"./mat4f64.js";import{s as d,t as u,i as m,q as p,j as f,c as _,w as g,k as v,n as b,f as y}from"./vec3.js";import{c as S,Z as w,f as j}from"./vec3f64.js";import{f as O,c as L}from"./vec4f64.js";import{V as T}from"./VisualElement.js";import{W as R,U as E,O as P,R as A}from"./RibbonLineMaterial.js";import{l as C,c as F}from"./line.js";import{R as D,O as z,D as x,M,a as N}from"./Material.js";import{l as I}from"../core/lang.js";import W from"../core/Evented.js";import{m as k}from"./handleUtils.js";import{e as G}from"./mathUtils.js";import{d as B}from"./maybe.js";import{g as U,b as H,s as V,h as $}from"./screenUtils.js";import{f as q}from"./mat3.js";import{c as Q}from"./mat3f64.js";import{p as Y}from"./vec2.js";import{U as Z}from"./unitUtils.js";import J from"../geometry/Point.js";import{a as K}from"./computeTranslationToOriginAndRotation.js";import{s as X}from"./projectBuffer.js";import{x as ee}from"./aaBoundingRect.js";import{c as te,d as se,f as ie,h as re}from"./lineSegment.js";import{c as oe,f as ne,i as ae}from"./plane.js";import{c as ce}from"./ray.js";import{a as le,d as he}from"./vector.js";import{c as de,h as ue,b as me}from"./hydratedFeatures.js";import{u as pe}from"./elevationInfoUtils.js";import{f as fe}from"./ray2.js";import _e from"../views/3d/webgl/RenderCamera.js";import{M as ge,a as ve}from"./interfaces2.js";import{n as be}from"./colorUtils.js";import{c as ye}from"./graphicUtils.js";import{C as Se}from"./basicInterfaces.js";import{C as we}from"./ColorMaterial.js";import{m as je,G as Oe}from"./aaBoundingBox.js";import{A as Le,d as Te}from"./BufferView.js";import{n as Re}from"./InterleavedLayout.js";import{i as Ee,h as Pe,S as Ae}from"./ShaderOutput.js";import{c as Ce,d as Fe,S as De,o as ze,t as xe,C as Me,b as Ne,j as Ie,e as We,m as ke,R as Ge,aa as Be,x as Ue,u as He,w as Ve,M as $e,N as qe,E as Qe,i as Ye,_ as Ze,a2 as Je}from"./Matrix4PassUniform.js";import{T as Ke,i as Xe}from"./VertexColor.glsl.js";import{V as et}from"./VertexAttribute.js";import{F as tt,a as st}from"./Matrix4BindUniform.js";import{g as it}from"./glsl.js";import{S as rt}from"./ShaderBuilder.js";import{r as ot}from"./enums.js";import{m as nt,d as at,c as ct}from"./renderState.js";import{_ as lt}from"./tslib.es6.js";import{p as ht}from"./ShaderTechniqueConfiguration.js";import{a as dt}from"./AlphaCutoff.js";function ut(t,s,r,o=!1){const n=e(t,s);return null==n?null:(n.hasZ&&!o||null==r||(n.z=i(r,n)??0),n)}function mt(e,t,s){s.warnOnce(`Failed to project analysis geometry (id: '${e.id}'), projection from spatial reference (wkid: '${t.wkid}') to view spatial reference is not supported. Projection may be possible after calling projection.load().`)}class pt extends T{constructor(e){super(e),this._resources=null,this._transform=h()}get object(){return null!=this._resources?this._resources.object:null}get transform(){return this._transform}set transform(e){r(this._transform,e),null!=this._resources&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(null==this._resources)return;const e=this._resources.object;e.removeAllGeometries(),this.createGeometries(e),e.visible=this.visible}createResources(){this.destroyResources();const e=this.view.stage;if(!e)return;const t=new R(e,{pickable:!1,updatePolicy:E.SYNC}),s=new P({castShadow:!1});s.transformation=this._transform,this.createExternalResources(),this.createGeometries(s),t.add(s),s.visible=this.visible,this._resources={layer:t,object:s}}destroyResources(){const e=this.view.stage;null!=this._resources&&e&&(this._resources.layer.destroy(),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){null!=this._resources&&(this._resources.object.visible=e)}}class ft extends pt{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._hasExternalMaterial=null!=t,this._material=t??new A({width:1,color:O(1,0,1,1),stipplePreferContinuous:!0,isClosed:!1,falloff:0,innerWidth:1,hasPolygonOffset:!1,renderOccluded:D.OccludeAndTransparent,isDecoration:!!e.isDecoration,writeDepth:!0}),this.applyProperties(e)}setGeometryFromPoint(e,t=1e3){const s=S();this.view.renderCoordsHelper.toRenderCoords(e,s)&&this.setGeometryFromRenderSpacePoint(s,t)}setGeometryFromRenderSpacePoint(e,t=1e3){this.geometry=[[[e[0]-t,e[1],e[2]],[e[0]+t,e[1],e[2]]],[[e[0],e[1]-t,e[2]],[e[0],e[1]+t,e[2]]],[[e[0],e[1],e[2]-t],[e[0],e[1],e[2]+t]]]}setGeometryFromExtent(e){const t=this.view.spatialReference,s=S(),i=S(),r=100,o=[];d(s,e[0],e[1],r),this.view.renderCoordsHelper.toRenderCoords(s,t,i),o.push([i[0],i[1],i[2]]),d(s,e[2],e[1],r),this.view.renderCoordsHelper.toRenderCoords(s,t,i),o.push([i[0],i[1],i[2]]),d(s,e[2],e[3],r),this.view.renderCoordsHelper.toRenderCoords(s,t,i),o.push([i[0],i[1],i[2]]),d(s,e[0],e[3],r),this.view.renderCoordsHelper.toRenderCoords(s,t,i),o.push([i[0],i[1],i[2]]),d(s,e[0],e[1],r),this.view.renderCoordsHelper.toRenderCoords(s,t,i),o.push([i[0],i[1],i[2]]),d(s,e[0],e[1],r),this.view.renderCoordsHelper.toRenderCoords(s,t,i),o.push([i[0],i[1],i[2]]),this.geometry=[o]}setGeometryFromFrustum(e){const t=[];e.lines.forEach((e=>{t.push([e.origin[0],e.origin[1],e.origin[2]]),t.push([e.endpoint[0],e.endpoint[1],e.endpoint[2]])})),this.geometry=[t]}setGeometryFromBoundedPlane(e){const t=[],s=e.origin,i=e.basis1,r=e.basis2,o=.5,n=S(),a=S(),c=S(),l=S();n[0]=s[0]-i[0]*o-r[0]*o,n[1]=s[1]-i[1]*o-r[1]*o,n[2]=s[2]-i[2]*o-r[2]*o,a[0]=s[0]-i[0]*o+r[0]*o,a[1]=s[1]-i[1]*o+r[1]*o,a[2]=s[2]-i[2]*o+r[2]*o,c[0]=s[0]+i[0]*o+r[0]*o,c[1]=s[1]+i[1]*o+r[1]*o,c[2]=s[2]+i[2]*o+r[2]*o,l[0]=s[0]+i[0]*o-r[0]*o,l[1]=s[1]+i[1]*o-r[1]*o,l[2]=s[2]+i[2]*o-r[2]*o,t.push([n[0],n[1],n[2]]),t.push([a[0],a[1],a[2]]),t.push([c[0],c[1],c[2]]),t.push([l[0],l[1],l[2]]),t.push([n[0],n[1],n[2]]),this.geometry=[t]}setGeometryFromSegment(e){const t=e.endRenderSpace;this.transform=o(_t,t);const{points:s}=e.createRenderGeometry(t,this.view.renderCoordsHelper);this.geometry=[s]}setGeometryFromSegments(e,t=w){this.transform=o(_t,t),this.geometry=e.map((e=>e.createRenderGeometry(t,this.view.renderCoordsHelper).points))}getTransformedGeometry(){return null==this._geometry?null:this._geometry.map((e=>e.map((e=>u(S(),e,this.transform)))))}get renderOccluded(){return this._material.parameters.renderOccluded}set renderOccluded(e){this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get width(){return this._material.parameters.width}set width(e){this._material.setParameters({width:e})}get color(){return this._material.parameters.color}set color(e){const t=1===e[3];this._material.setParameters({color:e,writeDepth:t})}get innerWidth(){return this._material.parameters.innerWidth}set innerWidth(e){this._material.setParameters({innerWidth:e})}get innerColor(){return this._material.parameters.innerColor}set innerColor(e){this._material.setParameters({innerColor:e})}get stipplePattern(){return this._material.parameters.stipplePattern}set stipplePattern(e){null!=this._material&&this._material.setParameters({stipplePattern:e})}get stippleOffColor(){return this._material.parameters.stippleOffColor}set stippleOffColor(e){this._material.setParameters({stippleOffColor:e})}get stipplePreferContinuous(){return this._material.parameters.stipplePreferContinuous}set stipplePreferContinuous(e){this._material.setParameters({stipplePreferContinuous:e})}get falloff(){return this._material.parameters.falloff}set falloff(e){this._material.setParameters({falloff:e})}get polygonOffset(){return this._material.parameters.hasPolygonOffset}set polygonOffset(e){this._material.setParameters({hasPolygonOffset:e})}createExternalResources(){}destroyExternalResources(){}createGeometries(e){for(const t of C(this.geometry)){const s=F(this._material,t);e.addGeometry(s)}}forEachMaterial(e){this._hasExternalMaterial||e(this._material)}}const _t=h();class gt{constructor(e){this.metadata=void 0,this._camera=new _e,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=h(),this._worldFrame=null,this._renderLocation=S(),this._renderLocationDirty=!0,this._location=new J({x:0,y:0,z:0}),this._elevationAlignedLocation=new J,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.consumesClicks=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=ge.None,this._focused=!1,this.events=new W.EventEmitter,this._screenLocation={screenPointArray:H(),renderScreenPointArray:U(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=e.view.spatialReference,Object.assign(this,e);const t=this.view.state?.camera;t&&this._camera.copyFrom(t)}destroy(){this._applyObjectTransform=Dt,this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get _stage(){return this.view?.stage}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),k((()=>{this._noDisplayCount--,0===this._noDisplayCount&&this._updateEngineObject()}))}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){vt(e)&&(this._screenLocationDirty=!0),r(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=h()),function(e,t,s){switch(e.viewingMode){case"local":return c(s),!0;case"global":{const i=Z(e.renderCoordsHelper.spatialReference);X(t,0,Tt,0,i.radius),K(G(Tt[0]),G(Tt[1]),s)}}}(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){de(e,this._location),this._notifyLocationChanged()}_notifyLocationChanged(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){de(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){const e=null!=this._elevation.override?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=ue(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:!0===e?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;let e;if(this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1,vt(this._modelTransform)){const t=this._calculateModelTransformOffset(Ct);e=m(t,t,this.renderLocation)}else e=this.renderLocation;this._camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(e,t){if(!this.available)return null;const s=V(e,bt),i=this._getCollisionRadius(t),r=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(Y(this.screenLocation.screenPointArray,s)<i*i)return this.screenLocation.renderScreenPointArray[2]+r;break;case"line":{const e=this.collisionType.paths,t=this._getWorldToScreenObjectScale(),o=this._calculateObjectTransform(t,Ot),n=i*this.screenLocation.pixelSize,a=fe(this._camera,s,St);if(null==a)return null;for(const t of e){if(0===t.length)continue;const e=u(Tt,t[0],o);for(let s=1;s<t.length;s++){const i=u(Rt,t[s],o),c=re(ie(e,i,yt),a);if(null!=c&&c<n*n){const t=m(le.get(),e,i);f(t,t,.5);const s=$(le.get());return this._camera.projectToRenderScreen(t,s),s[2]+r}_(e,i)}}break}case"disc":{const e=this.collisionType.direction,t=this.collisionType.offset??w,o=this._getWorldToScreenObjectScale(),n=this._calculateObjectTransform(o,Ot),a=i*this.screenLocation.pixelSize,c=fe(this._camera,s,St);if(null==c)return null;const l=q(wt,n),h=p(Pt,e,l),d=u(At,t,n);ne(d,h,Lt);const m=Et;if(ae(Lt,c,m)&&g(m,d)<a*a)return this.screenLocation.renderScreenPointArray[2]+r;break}case"ribbon":{const{paths:e,direction:t}=this.collisionType,o=this._getWorldToScreenObjectScale(),n=this._calculateObjectTransform(o,Ot),a=i*this._camera.computeScreenPixelSizeAt(this.renderLocation),c=fe(this._camera,s,St);if(null==c)return null;const l=q(wt,n),h=p(Pt,t,l),d=this._calculateModelTransformPosition(At);ne(d,h,Lt);const g=Et;if(!ae(Lt,c,g))break;for(const t of e){if(0===t.length)continue;const e=u(Tt,t[0],n);for(let s=1;s<t.length;s++){const i=u(Rt,t[s],n),o=se(ie(e,i,yt),g);if(null!=o&&o<a*a){const t=m(le.get(),e,i);f(t,t,.5);const s=$(le.get());return this._camera.projectToRenderScreen(t,s),s[2]+r}_(e,i)}}break}default:I(this.collisionType)}return null}attach(e={manipulator3D:{}}){const s=this._stage;if(!s)return;const i=e.manipulator3D;null==i.engineLayerId?(this._engineLayer=new R(s,{pickable:!1,updatePolicy:E.SYNC}),i.engineLayerId=this._engineLayer.id):s?.getLayer&&(this._engineLayer=s.getLayer(i.engineLayerId)),i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),t(this._location.spatialReference,this.view.spatialReference)||(this.location=new J({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const s=0===t.engineLayerReferences;this._removeResourcesFromStage(),s&&(t.engineLayerId=null,B(this._engineLayer)),this._engineResources=null,this._engineLayer=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){s(this.location,Ft,e.spatialReference)&&ee(e.extent,Ft)&&this._notifyLocationChanged()}_evaluateElevationAlignment(){if(null==this.elevationInfo)return;let e=null,t=0;const s=pe(this.elevationInfo,this.location.spatialReference??this.view.elevationProvider.spatialReference);switch(this.elevationInfo.mode){case"on-the-ground":e=i(this.view.elevationProvider,this.location,"ground")??0;break;case"relative-to-ground":t=(i(this.view.elevationProvider,this.location,"ground")??0)+s;break;case"relative-to-scene":t=(i(this.view.elevationProvider,this.location,"scene")??0)+s;break;case"absolute-height":t=s}return t!==this._elevation.offset||e!==this._elevation.override?(this._elevation.offset=t,void(this._elevation.override=e)):void 0}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=Ot;if(!0===this.autoScaleRenderObjects){const s=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(s,t)}else this._calculateObjectTransform(e,t);const{objectsByState:s}=this._ensureEngineResources(),i=(this.focused?ve.Focused:ve.Unfocused)|(this.selected?ve.Selected:ve.Unselected),r=this._noDisplayCount>0;for(const{stateMask:e,objects:o}of s){if(r){for(const e of o)e.visible=!1;continue}const s=(e&ve.All)!==ve.None,n=(e&ge.All)!==ge.None,a=!s||(i&e)===(e&ve.All),c=!n||(this.state&e)===(e&ge.All);if(a&&c)for(const e of o)e.visible=!0,e.transformation=t;else for(const e of o)e.visible=!1}}_ensureEngineResources(){if(null==this._engineResources){const e=this._engineLayer,t=[],s=new Set;this.renderObjects.forEach((({geometry:{material:e}})=>{s.has(e)||(t.push(e),s.add(e))}));const i=new Map;this._renderObjects.forEach((e=>{const t=new P({castShadow:!1,geometries:[e.geometry]}),s=i.get(e.stateMask)||[];s.push(t),i.set(e.stateMask,s)}));const r=[];i.forEach(((e,t)=>r.push({stateMask:t,objects:e}))),this._engineResources={objectsByState:r,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){const e=this._stage;if(this._engineResourcesAddedToStage||null==this._engineResources||!e)return;const{objectsByState:t,layer:s}=this._engineResources;t.forEach((({objects:e})=>s.addMany(e))),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(){const e=this._stage;if(!this._engineResourcesAddedToStage||null==this._engineResources||!e)return;const{objectsByState:t,layer:s}=this._engineResources;t.forEach((({objects:e})=>s.removeMany(e))),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),s=this._calculateObjectTransform(t,jt);return d(e,s[12],s[13],s[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return v(e,t,this.renderLocation)}_calculateObjectTransform(e,t){return n(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&a(t,t,this._worldFrame),a(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,null!=this._applyObjectTransform&&this._applyObjectTransform(t),t}get test(){}}function vt(e){return 0!==e[12]||0!==e[13]||0!==e[14]}const bt=H(),yt=te(),St=ce(),wt=Q(),jt=h(),Ot=h(),Lt=oe(),Tt=S(),Rt=S(),Et=S(),Pt=S(),At=S(),Ct=S(),Ft=new J({x:0,y:0,z:0,spatialReference:null}),Dt=()=>{};function zt(e){return e?.operations?.data.geometry}function xt(e,t){if(!t.screenSizeEnabled)return;const s=e.vertex;Ce(s,t),s.uniforms.add(new tt("perScreenPixelRatio",(e=>e.camera.perScreenPixelRatio)),new Fe("screenSizeScale",(e=>e.screenSizeScale))).code.add(it`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}const Mt=L(),Nt=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new rt;t.include(Ke,e),t.include(xt,e),t.fragment.include(De,e),t.include(ze,e),t.include(xe,e);const{vertex:s,fragment:i}=t;return i.include(Me),Ne(s,e),i.uniforms.add(new Ie("uColor",(e=>e.color))),t.attributes.add(et.POSITION,"vec3"),t.varyings.add("vWorldPosition","vec3"),e.screenSizeEnabled&&t.attributes.add(et.OFFSET,"vec3"),e.shadingEnabled&&(We(s),t.attributes.add(et.NORMAL,"vec3"),t.varyings.add("vViewNormal","vec3"),i.uniforms.add(new st("shadingDirection",(e=>e.shadingDirection))),i.uniforms.add(new Ie("shadedColor",(e=>function(e,t){const s=1-e[3],i=e[3]+t[3]*s;return 0===i?(Mt[3]=i,Mt):(Mt[0]=(e[0]*e[3]+t[0]*t[3]*s)/i,Mt[1]=(e[1]*e[3]+t[1]*t[3]*s)/i,Mt[2]=(e[2]*e[3]+t[2]*t[3]*s)/i,Mt[3]=t[3],Mt)}(e.shadingTint,e.color))))),s.main.add(it`
      vWorldPosition = ${e.screenSizeEnabled?it`screenSizeScaling(offset, position)`:it`position`};
      ${e.shadingEnabled?it`vec3 worldNormal = normal;
                 vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`:""}
      forwardViewPosDepth((view * vec4(vWorldPosition, 1.0)).xyz);
      gl_Position = transformPosition(proj, view, vWorldPosition);
  `),i.main.add(it`
      discardBySlice(vWorldPosition);
      discardByTerrainDepth();
      ${e.shadingEnabled?it`vec3 viewNormalNorm = normalize(vViewNormal);
             float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
             vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`:it`vec4 finalColor = uColor;`}
      outputColorHighlightOID(finalColor, vWorldPosition, finalColor.rgb);`),t}},Symbol.toStringTag,{value:"Module"}));class It extends ke{constructor(e,t){super(e,t,new Ge(Nt,(()=>Promise.resolve().then((()=>Nt)))),Wt)}initializePipeline(e){const{oitPass:t,output:s,transparent:i,cullFace:r,shadingEnabled:o}=e,n=t===z.NONE,a=t===z.FrontFace;return nt({blending:Ee(s)&&i?Ve(t):null,culling:ct(r),depthTest:{func:a?ot.LESS:o?ot.LEQUAL:ot.LESS},depthWrite:He(e),drawBuffers:Ue(t,s),colorWrite:at,polygonOffset:n||a?null:Be})}}const Wt=new Map([[et.POSITION,0],[et.NORMAL,1],[et.OFFSET,2]]);class kt extends x{constructor(){super(...arguments),this.cullFace=Se.None,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=$e.None,this.emissionSource=qe.None,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1,this.draped=!1,this.overlayEnabled=!1,this.snowCover=!1}get discardInvisibleFragments(){return this.transparent}}lt([ht({count:Se.COUNT})],kt.prototype,"cullFace",void 0),lt([ht()],kt.prototype,"transparent",void 0),lt([ht()],kt.prototype,"writeDepth",void 0),lt([ht()],kt.prototype,"screenSizeEnabled",void 0),lt([ht()],kt.prototype,"shadingEnabled",void 0),lt([ht()],kt.prototype,"terrainDepthTest",void 0),lt([ht()],kt.prototype,"cullAboveTerrain",void 0);class Gt extends M{constructor(e){super(e,Ut),this._configuration=new kt,this.vertexAttributeLocations=Wt,this.supportsEdges=!0,this._pp0=j(0,0,1),this._pp1=j(0,0,0),this.produces=new Map([[Qe.OPAQUE_MATERIAL,e=>e===Ae.Highlight||Pe(e)&&!this.parameters.transparent],[Qe.TRANSPARENT_MATERIAL,e=>Pe(e)&&this.parameters.transparent&&this.parameters.writeDepth],[Qe.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,e=>Pe(e)&&this.parameters.transparent&&!this.parameters.writeDepth]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.screenSizeEnabled=this.parameters.screenSizeEnabled,this._configuration.shadingEnabled=this.parameters.shadingEnabled,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest&&Ee(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}get visible(){return this.parameters.color[3]>=dt}intersect(e,t,s,i,r,o){this._intersect(e,s,i,r,o)}intersectDraped(e,t,s,i){return this._pp0[0]=this._pp1[0]=s[0],this._pp0[1]=this._pp1[1]=s[1],this._intersect(e,t,this._pp0,this._pp1,i)}_intersect(e,t,s,i,r){if(this.parameters.screenSizeEnabled){const o=e.attributes.get(et.OFFSET),n={applyToVertex:(e,s,i,r)=>{const n=d(Vt,o.data[3*r],o.data[3*r+1],o.data[3*r+2]),a=d($t,e,s,i);return f(n,n,this.parameters.screenSizeScale*(t.camera?.computeScreenPixelSizeAt(n)??1)),m(a,a,n),[a[0],a[1],a[2]]},applyToAabb:e=>{const s=je(e,Vt);return Oe(e,this.parameters.screenSizeScale*(t.camera?.computeScreenPixelSizeAt(s)??1))}};Xe(e,t,s,i,n,r)}else Xe(e,t,s,i,void 0,r)}createGLMaterial(e){return new Bt(e)}createBufferWriter(){return new Ht(this.parameters.screenSizeEnabled)}}class Bt extends Ye{beginSlot(e){return this.getTechnique(It,e)}}class Ut extends N{constructor(){super(...arguments),this.color=O(1,1,1,1),this.shadingTint=O(0,0,0,.25),this.shadingDirection=b(S(),[.5,-.5,-.5]),this.screenSizeScale=14,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=Se.None,this.screenSizeEnabled=!1,this.shadingEnabled=!0}get transparent(){return this.color[3]<1||this.forceTransparentMode}}class Ht{constructor(e){this.screenSizeEnabled=e;const t=Re().vec3f(et.POSITION).vec3f(et.NORMAL);this.screenSizeEnabled&&t.vec3f(et.OFFSET),this.vertexBufferLayout=t}elementCount(e){return e.get(et.POSITION).indices.length}write(e,t,s,i,r,o){const n=Ze(s,i,this.vertexBufferLayout,e,t,r,o);if(this.screenSizeEnabled){if(!s.has(et.OFFSET))throw new Error(`${et.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const e=s.get(et.OFFSET);Le(3===e.size);const i=r.getField(et.OFFSET,Te);if(!i)throw new Error("unable to acquire view for "+et.OFFSET);Je(e,t,i,o)}}return n}}const Vt=S(),$t=S();function qt(e,t=D.OccludeAndTransparent,s=!0){const i=be(e),r=!(e[3]<1);return s?new Gt({color:i,writeDepth:r,cullFace:Se.Back,renderOccluded:t,isDecoration:!0}):new we({color:i,writeDepth:r,cullFace:Se.Back,renderOccluded:t,isDecoration:!0})}function Qt(e,t=D.OccludeAndTransparent){const s=be(e);return new we({color:s,writeDepth:!0,cullFace:Se.Front,renderOccluded:t,isDecoration:!0})}const Yt=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1}),Zt=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function Jt(e,t,s,i){const r=v(le.get(),e,s),o=Kt(r,y(le.get(),i,r),s,he.get());l(o,o);const n=u(le.get(),t,o);return Math.atan2(n[1],n[0])}function Kt(e,t,s,i){const r=b(le.get(),e),o=b(le.get(),t),n=y(le.get(),r,o);return i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=0,i[4]=o[0],i[5]=o[1],i[6]=o[2],i[7]=0,i[8]=n[0],i[9]=n[1],i[10]=n[2],i[11]=0,i[12]=s[0],i[13]=s[1],i[14]=s[2],i[15]=1,i}function Xt(e,t){const s=e.getViewForGraphic(t);return null!=s&&"computeAttachmentOrigin"in s?s.computeAttachmentOrigin(t,e.spatialReference):null}function es(e,t){const s=t.origin;null==s?function(e,t){if(null==t)return;const s="mesh"===t.type?t.origin:ye(t);null!=s&&(e.location=me(s))}(e,zt(t)):e.elevationAlignedLocation=s}class ts{constructor(e,t=ve.None){this.geometry=e,this.stateMask=t}}export{ft as L,gt as M,pt as O,ts as R,Gt as S,ut as a,Kt as b,Jt as c,qt as d,Qt as e,Xt as g,mt as l,zt as m,es as p,Yt as r,Zt as w};
