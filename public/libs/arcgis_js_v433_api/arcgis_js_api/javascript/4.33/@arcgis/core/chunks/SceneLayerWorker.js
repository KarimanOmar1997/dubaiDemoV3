/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{i as t}from"./mathUtils.js";import r from"../geometry/SpatialReference.js";import e from"../geometry/support/MeshGeoreferencedVertexSpace.js";import o from"../geometry/support/MeshLocalVertexSpace.js";import{t as s,n as i}from"./vec32.js";import{I as n,T as a,a as p}from"./I3SMeshWorkerHandle.js";import{g as m}from"./assets.js";import{a as l}from"./I3SNode.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/lang.js";import"../core/Handles.js";import"./Logger.js";import"../config.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"./MapUtils.js";import"./Warning.js";import"../core/Error.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./events.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"../core/JSONSupport.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./writer.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"../core/Clonable.js";import"./enumeration.js";import"./vec3f64.js";import"./colorUtils2.js";import"./WorkerHandle.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"./SimpleObservable.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./date.js";import"./locale.js";import"./constants.js";import"./datetime.js";import"./number2.js";import"./substitute.js";import"./messages.js";import"./projectionUtils.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./projectVectorToVector.js";import"./projectPointToVector.js";import"./dehydratedPoint.js";import"./vec4f64.js";import"./sphere.js";import"./mat4.js";import"./common.js";import"./vec3.js";import"./vec4.js";import"./ray.js";import"./mat3.js";import"./mat3f64.js";import"./vector.js";import"./mat4f64.js";import"./quatf64.js";import"./vec2f64.js";import"./I3SUtil.js";import"./featurePopupQueryUtils.js";import"../core/sql.js";import"../layers/support/fieldUtils.js";import"./guards.js";import"../rest/support/Query.js";import"../geometry/support/jsonUtils.js";import"./typeUtils2.js";import"./DataLayerSource.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"./timeUtils.js";import"./I3SBinaryReader.js";import"./VertexAttribute.js";import"./computeTranslationToOriginAndRotation.js";import"./edgeUtils.js";import"../Color.js";import"./screenUtils.js";import"./floatRGBA.js";import"./NormalAttribute.glsl.js";import"./glsl.js";import"./ShaderOutput.js";import"./Float4DrawUniform.js";import"./BindType.js";import"./Matrix4BindUniform.js";import"./Matrix3DrawUniform.js";import"./orientedBoundingBox.js";import"./quat.js";import"./spatialReferenceEllipsoidUtils.js";import"./plane.js";import"./mathUtils2.js";import"./ViewingMode.js";import"./layerViewUtils.js";import"./ElevationRange.js";function c(t){return m(`esri/libs/i3s/${t}`)}let f,j,u;async function y(t){u=await R();const r=[t.geometryBuffer];return{result:A(u,t,r),transferList:r}}async function d(t){u=await R();const r=[t.geometryBuffer],{geometryBuffer:e}=t,o=e.byteLength,s=u._malloc(o),i=new Uint8Array(u.HEAPU8.buffer,s,o);i.set(new Uint8Array(e));const n=u.dracoDecompressPointCloudData(s,i.byteLength);if(u._free(s),n.error.length>0)throw new Error(`i3s.wasm: ${n.error}`);const a=n.featureIds?.length>0?n.featureIds.slice():null,p=n.positions.slice();return a&&r.push(a.buffer),r.push(p.buffer),{result:{positions:p,featureIds:a},transferList:r}}async function g(t){await R(),x(t);const r={buffer:t.buffer};return{result:r,transferList:[r.buffer]}}async function h(t){await R(),S(t)}async function b(t){u=await R(),u.setLegacySchema(t.context,t.jsonSchema)}async function w(t){const{localMatrix:s,origin:i,positions:n,vertexSpace:a}=t,p=r.fromJSON(t.inSpatialReference),m=r.fromJSON(t.outSpatialReference);let l;const[{projectBuffer:c},{initializeProjection:f}]=await Promise.all([import("./projectBuffer.js").then((t=>t.e)),import("./projectionUtils.js")]);await f(p,m);const j=[0,0,0];if(!c(i,p,0,j,m,0))throw new Error("Failed to project");if("georeferenced"===a.type&&null==a.origin){if(l=new Float64Array(n.length),!c(n,p,0,l,m,0,l.length/3))throw new Error("Failed to project")}else{const t="georeferenced"===a.type?e.fromJSON(a):o.fromJSON(a),{projectMeshVertexPositions:r}=await import("./projectMeshVertexPositions.js"),i=r({vertexAttributes:{position:n},transform:s?{localMatrix:s}:void 0,vertexSpace:t,spatialReference:p},m);if(!i)throw new Error("Failed to project");l=i}const u=l.length,[y,d,g]=j;for(let t=0;t<u;t+=3)l[t]-=y,l[t+1]-=d,l[t+2]-=g;return{result:{projected:l,original:n,projectedOrigin:j},transferList:[l.buffer,n.buffer]}}async function U({normalMatrix:r,normals:e}){const o=new Float32Array(e.length);return s(o,e,r),t(r)&&i(o,o),{result:{transformed:o,original:e},transferList:[o.buffer,e.buffer]}}function E(t){P(t)}function S(t){if(!u)return;const r=t.modifications,e=u._malloc(8*r.length),o=new Float64Array(u.HEAPU8.buffer,e,r.length);for(let t=0;t<r.length;++t)o[t]=r[t];u.setModifications(t.context,e,r.length,t.isGeodetic),u._free(e)}function A(t,r,e){const{context:o,globalTrafo:s,mbs:i,obbData:m,elevationOffset:l,geometryBuffer:c,geometryDescriptor:f,indexToVertexProjector:j,vertexToRenderProjector:u}=r,y=t._malloc(c.byteLength),d=t._malloc(33*Float64Array.BYTES_PER_ELEMENT),g=new Uint8Array(t.HEAPU8.buffer,y,c.byteLength);g.set(new Uint8Array(c));const h=new Float64Array(t.HEAPU8.buffer,d,33);L(h,[NaN,NaN,NaN]);let b=h.byteOffset+3*h.BYTES_PER_ELEMENT,w=new Float64Array(h.buffer,b);L(w,s),b+=16*h.BYTES_PER_ELEMENT,w=new Float64Array(h.buffer,b),L(w,i),b+=4*h.BYTES_PER_ELEMENT,m&&(w=new Float64Array(h.buffer,b),L(w,m));const U=f,E={isDraco:!1,isLegacy:!1,color:r.layouts.some((t=>t.some((t=>"color"===t.name)))),normal:r.needNormals&&r.layouts.some((t=>t.some((t=>"normalCompressed"===t.name)))),uv0:r.layouts.some((t=>t.some((t=>"uv0"===t.name)))),uvRegion:r.layouts.some((t=>t.some((t=>"uvRegion"===t.name)))),featureIndex:U.featureIndex},S=t.process(o,!!r.obbData,y,g.byteLength,U,E,d,l,j,u,r.normalReferenceFrame);if(t._free(d),t._free(y),S.error.length>0)throw new Error(`i3s.wasm: ${S.error}`);if(S.discarded)return null;const A=S.componentOffsets.length>0?S.componentOffsets.slice():null,T=S.featureIds.length>0?S.featureIds.slice():null,x=S.anchorIds.length>0?Array.from(S.anchorIds):null,P=S.anchors.length>0?Array.from(S.anchors):null,M=S.interleavedVertedData.slice().buffer,R=S.indicesType===n.Int16?new Uint16Array(S.indices.buffer,S.indices.byteOffset,S.indices.byteLength/2).slice():new Uint32Array(S.indices.buffer,S.indices.byteOffset,S.indices.byteLength/4).slice(),v=S.positions.slice(),{buffer:B,byteOffset:I,byteLength:_}=S.positionIndices,F=S.positionIndicesType===n.Int16?new Uint16Array(B,I,_/2).slice():new Uint32Array(B,I,_/4).slice(),N=new a(r.layouts[0],M,R,S.hasColors,S.hasModifications,{data:v,indices:F});return T&&e.push(T.buffer),A&&e.push(A.buffer),e.push(M),e.push(R.buffer),e.push(v.buffer),e.push(F.buffer),new p(A,T,x,P,N,s,S.obb)}function T(t){return 0===t?l.Unmodified:1===t?l.PotentiallyModified:2===t?l.Culled:l.Unknown}function x(t){if(!u)return;const{context:r,buffer:e}=t,o=u._malloc(e.byteLength),s=e.byteLength/Float64Array.BYTES_PER_ELEMENT,i=new Float64Array(u.HEAPU8.buffer,o,s),n=new Float64Array(e);i.set(n),u.filterOBBs(r,o,s),n.set(i),u._free(o)}function P(t){u&&0===u.destroy(t)&&(u=null)}function L(t,r){for(let e=0;e<r.length;++e)t[e]=r[e]}async function M(){u||await R()}async function R(){return u||(u=await(j??=(f||(f=new Promise((t=>import("./i3s.js").then((t=>t.i)).then((({default:r})=>{const e=r({locateFile:c,onRuntimeInitialized:()=>t(e)});delete e.then})))).catch((t=>{throw t}))),f))),u}const v={transform:(t,r)=>u&&A(u,t,r),destroy:P};export{E as destroyContext,d as dracoDecompressPointCloudData,g as filterObbsForModifications,x as filterObbsForModificationsSync,M as initialize,T as interpretObbModificationResults,y as process,w as project,b as setLegacySchema,h as setModifications,S as setModificationsSync,v as test,U as transformNormals};
