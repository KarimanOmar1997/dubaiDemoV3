/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{L as t}from"./Logger.js";import{c as e,l as i}from"./mathUtils.js";import{d as o,k as n,a,b as s,r}from"./mat4.js";import{c as l}from"./mat4f64.js";import{c,l as u}from"./vec2.js";import{f as m,c as d}from"./vec2f64.js";import{s as h,m as f,n as g,j as b,t as p,i as y,c as A}from"./vec3.js";import{f as v,b as T,c as w}from"./vec3f64.js";import{V as N}from"./ViewingMode.js";import{S as M}from"./SunCalc.js";import{a as x}from"./mathUtils2.js";import{_ as O}from"./tslib.es6.js";import{p as j,S as G}from"./ShaderTechniqueConfiguration.js";const S={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class z{constructor(t,e){this.direct=t,this.ambient=e}}function P(t,o,n,a,s,r){h(r.ambient.color,1,1,1),r.ambient.intensity=S.global.ambient,h(r.direct.color,1,1,1),r.direct.intensity=S.global.direct;const l=o[2],m=e((Math.abs(l)-S.local.altitude)/(S.global.altitude-S.local.altitude),0,1);let g;if(r.globalFactor=m,null!=t&&(g=M.getTimes(t,o[1],o[0])),m<1){let e;if(null!=t)e=function(t,e,i){const o=t.valueOf();let n,a;e.polarException===M.PolarException.MIDNIGHT_SUN?(n=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=n+432e6):e.polarException===M.PolarException.POLAR_NIGHT?(n=o-2,a=o-1):(n=e.sunrise.valueOf(),a=e.sunset.valueOf());const s=a-n,r=n+s/2,l=s/4,m=r-l,h=r+l,g=.06*s,b=n-g/2,p=n+g/2,y=a-g/2,v=a+g/2,T=d(),N=w(),x=w();let O="";if(o<b||o>v)c(T,W),A(N,k),A(x,$),O="night";else if(o<p){const t=(o-b)/(p-b);u(T,W,X,t),f(N,k,q,t),f(x,$,J,t),O="sun rising"}else if(o<m){const t=(o-p)/(m-p);u(T,X,Y,t),f(N,q,B,t),f(x,J,K,t),O="early morning"}else if(o<r){const t=(o-m)/(r-m);u(T,Y,Z,t),f(N,B,V,t),f(x,K,Q,t),O="late morning"}else if(o<h){const t=(o-r)/(h-r);u(T,Z,tt,t),f(N,V,et,t),f(x,Q,it,t),O="early afternoon"}else if(o<y){const t=(o-h)/(y-h);u(T,tt,ot,t),f(N,et,nt,t),f(x,it,at,t),O="late afternoon"}else if(o<v){const t=(o-y)/(v-y);u(T,ot,W,t),f(N,nt,k,t),f(x,at,$,t),O="sun setting"}let j=0;switch(i){case"rainy":case"foggy":j=.8;break;case"snowy":j=.5}j>0&&(_(N,j),_(x,j));const G=R(i);return{direct:{intensity:T[0]*G.direct,color:N},ambient:{intensity:T[1]*G.ambient,color:x},timeOfDay:O}}(t,g,a);else{const t=R(a);e={direct:{intensity:S.local.directAtNoon*t.direct,color:v(1,1,1)},ambient:{intensity:S.local.ambientAtNoon*t.ambient,color:v(1,1,1)},timeOfDay:"early afternoon"}}f(r.ambient.color,e.ambient.color,r.ambient.color,m),r.ambient.intensity=i(e.ambient.intensity,r.ambient.intensity,m),f(r.direct.color,e.direct.color,r.direct.color,m),r.direct.intensity=i(e.direct.intensity,r.direct.intensity,m),r.specularStrength="rainy"===a||"snowy"===a||"foggy"===a?0:1,r.environmentStrength="rainy"===a?.7:"snowy"===a||"foggy"===a?.75:1}r.noonFactor=null!=t?function(t,i){const o=t.valueOf();let n,a;i.polarException===M.PolarException.MIDNIGHT_SUN?(n=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=n+432e6):i.polarException===M.PolarException.POLAR_NIGHT?(n=o-2,a=o-1):(n=i.sunrise.valueOf(),a=i.sunset.valueOf());const s=n+(a-n)/2;return 1-e(Math.abs(o-s)/432e5,0,1)}(t,g):1,null!=t?E(t,o,n,r.direct.directionToLightSource):D(s,n,r.direct.directionToLightSource)}function D(t,e,i){e===N.Global?g(lt,t.eye):h(lt,0,0,1),b(ct,t.viewForward,-1);const n=x(ct,lt),a=Math.max(n-2*mt,0),s=.85*a/(a+1),r=Math.max(mt,n-mt-s);o(rt,-r,t.viewRight),p(i,ct,rt),y(i,i,b(ut,t.viewRight,dt)),g(i,i)}function E(t,i,o,l){const c=F,u=n(H);if(o===N.Global)M.getPosition(t,0,0,c),h(l,0,0,-1),a(u,u,-c.azimuth),s(u,u,-c.altitude),p(l,l,u);else{const o=S.planarDirection,n=o.globalAngles,s=i[2];let m=(Math.abs(s)-o.localAltitude)/(o.globalAltitude-o.localAltitude);m=e(m,0,1),m<1?(M.getPosition(t,i[1],i[0],c),c.azimuth=(1-m)*c.azimuth+m*n.azimuth,c.altitude=(1-m)*c.altitude+m*n.altitude):(c.azimuth=n.azimuth,c.altitude=n.altitude),h(l,0,-1,0),r(u,u,-c.azimuth),a(u,u,-c.altitude),p(l,l,u)}}function I(t,e){if(e===N.Global)return!0;const i=S.planarDirection;return Math.abs(t)<i.localAltitude}function L(e,i,o,n,a,s){const r=e.getTime(),l=Math.max(0,i.getTime()-r),c=Math.floor(l/o)+1,u=Math.min(s,c),m=new Array(u),d=1===u?0:l/(u-1);c>u&&t.getLogger("esri.views.3d.support.sunUtils").warnOnce("computeDirectionsOverTime",`Requested interval ${o} exceeds maximum supported interval of ${Math.floor(d)} based on the provided time range.`);for(let t=0;t<u;++t)st.setTime(r+d*t),m[t]=w(),E(st,n,a,m[t]);return m}const U=v(.5773502691896258,-.5773502691896258,.5773502691896258);class C{constructor(){this.ambient={color:v(1,1,1),intensity:.55},this.direct={color:v(1,1,1),intensity:.55,directionToLightSource:T(U)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const H=l(),F={azimuth:0,altitude:0};function R(t){switch(t){case"disabled":case"sunny":case"cloudy":return new z(1,1);case"rainy":return new z(.4,1.2);case"snowy":return new z(.5,1.3);case"foggy":return new z(.2,1.6)}}function _(t,e){const i=(t[0]+t[1]+t[2])/3;t[0]+=(i-t[0])*e,t[1]+=(i-t[1])*e,t[2]+=(i-t[2])*e}const k=v(.01,.01,.01),q=v(1,.6,.5),B=v(1,.98,.98),V=v(1,1,1),$=v(.8,.8,1),J=v(.8,.8,1),K=v(.98,.98,1),Q=v(1,1,1),W=m(.01,S.local.ambientAtNight),X=m(S.local.directAtTwilight,S.local.ambientAtTwilight),Y=m(.9*S.local.directAtNoon,S.local.ambientAtNoon),Z=m(S.local.directAtNoon,S.local.ambientAtNoon),tt=Y,et=B,it=K,ot=X,nt=q,at=J,st=new Date(0),rt=l(),lt=w(),ct=w(),ut=w(),mt=.25,dt=.2;var ht;!function(t){t[t.Gradient=0]="Gradient",t[t.BandedGradient=1]="BandedGradient",t[t.Threshold=2]="Threshold",t[t.ThresholdAndGradient=3]="ThresholdAndGradient",t[t.COUNT=4]="COUNT"}(ht||(ht={}));class ft extends G{constructor(){super(...arguments),this.visualization=ht.Gradient}}O([j({count:ht.COUNT})],ft.prototype,"visualization",void 0);export{C,ht as S,P as a,D as b,L as c,I as d,ft as e};
