/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{c as e}from"./vec2f64.js";import{d as t,k as r,i as s,j as i,x as a,c as n,s as o,t as l}from"./vec3.js";import{c,O as u}from"./vec3f64.js";import{g as h,o as d}from"./plane.js";import{L as p,a as y}from"./Logger.js";import{t as m,b as f}from"./calloutUtils.js";import g from"../Color.js";import{l as b,h as v,T as _,i as S,r as P}from"../core/lang.js";import{p as L}from"./screenUtils.js";import{f as E,Z as O,c as x}from"./vec4f64.js";import{c as C}from"./mat4.js";import{c as A}from"./mat4f64.js";import{c as w}from"./computeTranslationToOriginAndRotation.js";import{p as D}from"./projectBuffer.js";import{S as F,u as T,s as j,d as I,E as R,z,g as G,h as U,i as B,j as M,k as N}from"./ElevationContext.js";import{d as V}from"./debugFlags2.js";import{S as k}from"./Intersector2.js";import"./Indices.js";import{an as q,Y as H,h as $,a0 as W,F as Z,d as Q,k as Y,j as J,m as X,R as K,E as ee,i as te,a2 as re,a3 as se,a5 as ie,G as ae,a as ne}from"./Matrix4PassUniform.js";import"./triangle.js";import{O as oe}from"./basicInterfaces.js";import{V as le}from"./VertexAttribute.js";import"./Texture.js";import{c as ce,d as ue,a as he}from"./coordsUtils.js";import{d as de,m as pe,c as ye}from"./graphicUtils.js";import{p as me}from"./projectPointToVector.js";import{c as fe,B as ge,C as be,p as ve,q as _e,m as Se,K as Pe,L as Le,A as Ee,E as Oe,b as xe,N as Ce,o as Ae}from"./aaBoundingBox.js";import{m as we}from"./dehydratedPoint.js";import{O as De}from"./RibbonLineMaterial.js";import{A as Fe}from"./orientedBoundingBox.js";import{f as Te}from"./vec2f32.js";import{n as je}from"./InterleavedLayout.js";import{i as Ie}from"./ShaderOutput.js";import{D as Re,M as ze,a as Ge}from"./Material.js";import{s as Ue,b as Be}from"./vec2.js";import{A as Me,H as Ne,a as Ve}from"./HUDVisibility.glsl.js";import{g as ke,I as qe}from"./glsl.js";import{b as He}from"./VerticalOffset.glsl.js";import{F as $e}from"./BooleanBindUniform.js";import{S as We}from"./ShaderBuilder.js";import{r as Ze,a as Qe}from"./enums.js";import{m as Ye,a as Je,d as Xe,s as Ke}from"./renderState.js";import{_ as et}from"./tslib.es6.js";import{p as tt}from"./ShaderTechniqueConfiguration.js";import{a as rt}from"./AlphaCutoff.js";import{f as st}from"./asyncUtils.js";import{isAbortError as it,onAbortOrThrow as at,throwIfAborted as nt,createAbortError as ot,createResolver as lt,onAbort as ct}from"../core/promiseUtils.js";import{b as ut}from"./memoryEstimations.js";import{O as ht}from"./ObjectPool.js";import dt from"../geometry/Polygon.js";import{p as pt}from"./projectBoundingRect.js";import{c as yt,B as mt,e as ft}from"./aaBoundingRect.js";import{e as gt}from"./unitUtils.js";import{m as bt}from"./dehydratedFeatures.js";import{b as vt}from"./featureConversionUtils.js";import{g as _t}from"./sphere.js";import{T as St,h as Pt}from"./edgeUtils.js";import{V as Lt}from"./ViewingMode.js";import{d as Et}from"../symbols/ObjectSymbol3DLayer.js";import{p as Ot}from"./primitiveObjectSymbolUtils.js";import{D as xt}from"./DefaultMaterial.js";import{a as Ct}from"./maybe.js";import At from"../geometry/Multipoint.js";import{T as wt,n as Dt}from"./Scheduler.js";import{s as Ft}from"./signal.js";function Tt(e,t,s,o){const l=function(e,t,s){const o=It;return e?(s&&(o.len=a(t,s)),n(o.dir,e)):(o.len=a(t,s),r(o.dir,s,t),i(o.dir,o.dir,1/o.len)),o}(o,t,s);return function(e,t,r,s){s.clip[0]=0,s.clip[1]=r?s.len:Number.MAX_VALUE;for(let r=0;r<e.length;r++)if(!Rt(e[r],t,s))return!1;return!0}(e,t,s,l)}function jt(e,a,n,o){const l=t(n,r(e,o,a));return s(e,a,i(e,n,l))}const It={dir:c(),len:0,clip:e()};function Rt(e,r,s){const i=t(h(e),s.dir),a=-d(e,r);if(a<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return a>0;if((a<0||i<0)&&!(a<0&&i<0))return!0;const n=a/i;return i>0?n<s.clip[1]&&(s.clip[1]=n):n>s.clip[0]&&(s.clip[0]=n),s.clip[0]<=s.clip[1]}var zt,Gt;!function(e){e[e.USER=1]="USER",e[e.SCALE_RANGE=2]="SCALE_RANGE",e[e.FILTER=4]="FILTER",e[e.DECONFLICTION=8]="DECONFLICTION",e[e.ALL_GRAPHIC=15]="ALL_GRAPHIC",e[e.ALL_LABEL=255]="ALL_LABEL"}(zt||(zt={})),function(e){e[e.GRAPHIC=1]="GRAPHIC",e[e.LABEL=16]="LABEL"}(Gt||(Gt={}));class Ut{constructor(e,t){this.renderer=e,this.symbol=t,this.color=null,this.size=null,this.opacity=null,this.outlineSize=null,this.heading=null,this.tilt=null,this.roll=null}}function Bt(e){return null!=e.mapPositions}function Mt(e,t,r,s,i){const a=e.stageObject,n=a.geometries;let o=0;for(const e of n){if(!Bt(e))continue;const{update:n,averageGeometrySampledElevation:l}=Xt(e,t,r,s,i);o+=l,n&&a.geometryVertexAttributeUpdated(e,le.POSITION)}return o/n.length}function Nt(e,t,r,s,i,a){const n=e.stageObject,l=t.centerPointInElevationSR;let c=0;n.usesVerticalDistanceToGround?(s(l,Jt),T(n,Jt.verticalDistanceToGround),c=Jt.sampledElevation):(s(l,Jt),"absolute-height"!==t.mode&&(c=Jt.sampledElevation));const u=C(Vt,a??n.transformation),h=o(Yt,u[12],u[13],u[14]);V.TESTS_DISABLE_OPTIMIZATIONS?($t[0]=l.x,$t[1]=l.y,$t[2]=Jt.z,w(l.spatialReference,$t,u,i.spatialReference)&&(a?C(a,u):n.transformation=u)):i.setAltitudeOfTransformation(Jt.z,u);const d=Ht/i.unitInMeters;return(Math.abs(u[12]-h[0])>=d||Math.abs(u[13]-h[1])>=d||Math.abs(u[14]-h[2])>=d)&&(a?C(a,u):n.transformation=u),c}const Vt=A();function kt(e,t,r,s,i){const a=e.graphics3DSymbolLayer.lodRenderer;if(null==a)return 0;const n=t.centerPointInElevationSR;s(n,Jt);const l="absolute-height"!==t.mode?Jt.sampledElevation:0,c=a.instanceData,u=e.instanceIndex,h=Qt;c.getGlobalTransform(u,h);const d=o(Yt,h[12],h[13],h[14]);V.TESTS_DISABLE_OPTIMIZATIONS?($t[0]=n.x,$t[1]=n.y,$t[2]=Jt.z,w(n.spatialReference,$t,h,i.spatialReference)&&c.setGlobalTransform(u,h)):i.setAltitudeOfTransformation(Jt.z,h);const p=Ht/i.unitInMeters;return(V.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-d[0])>=p||Math.abs(h[13]-d[1])>=p||Math.abs(h[14]-d[2])>=p)&&c.setGlobalTransform(u,h),l}function qt(e,t,r,s,i){const a=e.stageObject,n=a.geometries;if(0===n.length)return 0;let o=0,l=null,c=0,u=!1;for(const e of n){if(!Bt(e))continue;const n=e.attributes.get(le.POSITION);if(n!==l){const{update:a,averageGeometrySampledElevation:o}=Xt(e,t,r,s,i);c=o,l=n,u=a}u&&a.geometryVertexAttributeUpdated(e,le.POSITION),o+=c}return o/n.length}const Ht=.01,$t=c(),Wt=c(),Zt=c(),Qt=A(),Yt=c(),Jt=new F;function Xt(e,t,r,s,i){let a=!1;const n=e.transformation,o=t.requiresSampledElevationInfo;Wt[0]=n[12],Wt[1]=n[13],Wt[2]=n[14],e.invalidateBoundingInfo();const l=e.getMutableAttribute(le.POSITION),c=l.data,u=l.size,h=c.length/u,d=new k(e.mapPositions,r);let p=0,y=0;for(let e=0;e<h;e++){if(Zt[0]=c[p],Zt[1]=c[p+1],Zt[2]=c[p+2],s(d,Jt),o&&(y+=Jt.sampledElevation),V.TESTS_DISABLE_OPTIMIZATIONS)c[p]=d.array[d.offset],c[p+1]=d.array[d.offset+1],c[p+2]=Jt.z,D(c,r,p,c,i.spatialReference,p,1),c[p]-=Wt[0],c[p+1]-=Wt[1],c[p+2]-=Wt[2],a=!0;else{$t[0]=c[p]+Wt[0],$t[1]=c[p+1]+Wt[1],$t[2]=c[p+2]+Wt[2],i.setAltitude($t,Jt.z),c[p]=$t[0]-Wt[0],c[p+1]=$t[1]-Wt[1],c[p+2]=$t[2]-Wt[2];const e=Ht/i.unitInMeters;(Math.abs(Zt[0]-c[p])>=e||Math.abs(Zt[1]-c[p+1])>=e||Math.abs(Zt[2]-c[p+2])>=e)&&(a=!0)}p+=u,d.offset+=3}return y/=h,{update:a,averageGeometrySampledElevation:y}}class Kt{constructor(e,t,r){this.graphic=e,this.renderingInfo=t,this.layer=r}}class er{constructor(e,t,r){this.baseMaterial=e,this.edgeMaterial=t,this.hasSlicePlane=r}}class tr{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,r,s,i,a=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._sharedResource=r,this.elevationAligner=s,this.elevationContext=i,this._edgeState=a,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}layerOpacityChanged(e,t){const{stageObject:r,_edgeState:s,_stageLayer:i}=this;if(null==s)return;const a=rr(s.baseMaterial);s.edgeMaterial.objectTransparency!==a&&(s.edgeMaterial.objectTransparency=a,this.resetEdgeObject(t)),i.stage.renderer.withEdgeView((t=>t.updateAllComponentOpacities(r,[e])))}updateHighlights(e){}slicePlaneEnabledChanged(e,t){const{stageObject:r,_edgeState:s,_stageLayer:i}=this;null!=s&&i.stage.renderer.withEdgeView((i=>{i.updateAllComponentMaterials(r,s.edgeMaterial,e,!t),s.hasSlicePlane=e}))}setVisibility(e){const{_edgeState:t,stageObject:r,_stageLayer:s}=this;null!=s&&this.visible!==e&&(this._visible=e,r.visible=e,e&&!this._addedToStage&&(s.add(r),this._addedToStage=!0),null!=t&&s.stage.renderer.withEdgeView((s=>{s.hasObject(r)?s.updateObjectVisibility(r,e):e&&this._addOrUpdateEdgeObject(t,s,!1)})))}get visible(){return this._visible}alignWithElevation(e,t,r,s){null!=this.elevationAligner&&(null!=r&&j(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,((r,s)=>I(r,e,this.elevationContext,t,s)),t),this.resetEdgeObject(s))}alignWithAbsoluteElevation(e,t,r){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,((t,r)=>{r.sampledElevation=e,r.verticalDistanceToGround=0,r.z=e}),t),this.resetEdgeObject(r)}getCenterObjectSpace(e=c()){return n(e,_t(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=fe()){const t=this.stageObject.boundingVolumeObjectSpace;return ge(e,t.min),be(e,t.max),e}computeAttachmentOrigin(e){const t=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;else for(const r of this.stageObject.geometries)r.computeAttachmentOrigin(ar)&&(l(ar,ar,t),s(e.render.origin,e.render.origin,ar),e.render.num++)}async getProjectedBoundingBox(e,t,r,s,i){const a=this.getBoundingBoxObjectSpace(i),n=nr,o=ve(a)?1:n.length;for(let e=0;e<o;e++){const t=n[e];ir[0]=a[t[0]],ir[1]=a[t[1]],ir[2]=a[t[2]],l(ir,ir,this.stageObject.transformation),sr[3*e]=ir[0],sr[3*e+1]=ir[1],sr[3*e+2]=ir[2]}if(!e(sr,0,o))return null;_e(a);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let e=0;e<3*o;e+=3){for(let t=0;t<3;t++)a[t]=Math.min(a[t],sr[e+t]),a[t+3]=Math.max(a[t+3],sr[e+t]);c&&r.push({location:sr.slice(e,e+3),screenSpaceBoundingRect:c})}if(t?.service&&"absolute-height"!==this.elevationContext.mode){Se(a,ar);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let r=0;if(t.useViewElevation)r=t.service.getElevation(ar[0],ar[1],e)??0;else try{const i=de(a,t.service.spatialReference,t);r=await t.service.queryElevation(ar[0],ar[1],s,i,e)??0}catch(e){}Pe(a,0,0,-this.alignedSampledElevation+r)}return a}addObjectState(e){e.stateType===oe.Highlight&&e.addObject(this.stageObject,this.stageObject.highlight(e.highlightName)),e.stateType===oe.MaskOccludee&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeByObject(this.stageObject)}resetEdgeObject(e){const{_edgeState:t,stageObject:r,_stageLayer:s,_visible:i}=this;null!=t&&s.stage.renderer.withEdgeView((s=>{i?this._addOrUpdateEdgeObject(t,s,e):s.removeObject(r)}))}_addOrUpdateEdgeObject(e,t,r){const s=rr(e.baseMaterial);e.edgeMaterial.objectTransparency=s,t.addOrUpdateObject3D(this.stageObject,e.edgeMaterial,e.hasSlicePlane,!r).then((()=>this._stageLayer?.sync()))}}function rr(e){return e.transparent?St.TRANSPARENT:St.OPAQUE}const sr=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],ir=c(),ar=c(),nr=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class or{constructor(e,t=null){this.labelText=t,this.elevationOffset=e??0}}const lr=3,cr=3,ur=10;class hr{constructor(e){this.estimated=!1,this.verticesPerFeature=e.verticesPerFeature??0,this.verticesPerCoordinate=e.verticesPerCoordinate??0,this.drawCallsPerFeature=e.drawCallsPerFeature??0,this.memory=e.memory??new mr}}class dr extends hr{constructor(e){super(e),this.estimated=!0}}class pr extends hr{constructor(e,t){super(t),this.numComplexities=e}}class yr extends dr{constructor(e,t){super(t),this.numComplexities=e}}class mr{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}const fr=new dr({});function gr(e){return"web-style"===e.type?fr:br(e.symbolLayers.toArray().map((t=>Sr(e,t))))}function br(e){let t=0,r=0,s=0,i=!1,a=0;const n=new mr;for(const o of e)null!=o&&(t+=o.verticesPerFeature,r+=o.verticesPerCoordinate,s+=o.drawCallsPerFeature,n.bytesPerFeature+=o.memory.bytesPerFeature,n.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,n.resourceBytes+=o.memory.resourceBytes,n.draped.bytesPerFeature+=o.memory.bytesPerFeature,n.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,i=i||o.estimated,++a);return i?new yr(a,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:s,memory:n}):new pr(a,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:s,memory:n})}function vr(e){const t=br(e);return t.numComplexities>0&&(t.verticesPerFeature/=t.numComplexities,t.verticesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities),t}const _r={};function Sr(e,t){const r=Pr(e,t),s=Pt(t)?2:0;switch(t.type){case"extrude":return new hr({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:s,memory:r});case"fill":if("mesh-3d"===e.type)return new hr({drawCallsPerFeature:s,memory:r});if(null!=t.outline&&t.outline.size>0)return new hr({verticesPerFeature:-12,verticesPerCoordinate:9,memory:r});case"water":return new hr({verticesPerFeature:-6,verticesPerCoordinate:3,memory:r});case"line":return new hr({verticesPerFeature:-6,verticesPerCoordinate:6,memory:r});case"object":return t.resource?.href?new dr({verticesPerFeature:100,memory:r}):{...Lr(t.resource?.primitive??Et),memory:r};case"path":{let e=0,s=0;switch(t.profile){case"circle":e=10;break;case"quad":e=4;break;default:return void b(t.profile)}switch(t.join){case"round":s=3;break;case"miter":case"bevel":s=1;break;default:return}const i=2*e,a=e*s*2,n=a+i;let o=-2*a-i;switch(t.cap){case"none":break;case"butt":case"square":o+=2*(e-1);break;case"round":o+=2*(2*e*2+e);break;default:return}return new hr({verticesPerFeature:o,verticesPerCoordinate:n,memory:r})}case"text":{const t="label-3d"===e.type?0:2;return new hr({verticesPerFeature:6,memory:r,drawCallsPerFeature:t})}case"icon":return new hr({verticesPerFeature:6,memory:r});default:return}}function Pr(e,t){const r="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?Or.EXTRUDE_EDGES:Or.EXTRUDE;case"fill":return null!=t.outline&&t.outline.size>0?Or.FILL_OUTLINE:Or.FILL;case"water":return Or.FILL;case"line":return"round"===t.join?Or.LINE_ROUND:Or.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return Or.PATH_ROUND_CIRCLE;case"quad":return Or.PATH_ROUND_QUAD;default:return void b(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return Or.PATH_MITER_CIRCLE;case"quad":return Or.PATH_MITER_QUAD;default:return void b(t.profile)}default:return}case"object":return r?Or.OBJECT_POINT:Or.OBJECT_POLYGON;case"icon":case"text":return r?Or.ICON_POINT:Or.ICON_POLYGON;default:return}}function Lr(e){const t=_r[e];if(t)return t;const r=Er(Ot(e,new xt({},{spherical:!0})).levels);return _r[e]=new hr({verticesPerFeature:r}),_r[e]}function Er(e){return e.reduce(((e,t,r)=>e+t.numVertices*(1/10**r)),0)/e.reduce(((e,t,r)=>e+1/10**r),0)}const Or={ICON_POINT:{bytesPerFeature:3062.2534325974652,bytesPerFeatureLabel:3605.891255,resourceBytes:0,draped:{bytesPerFeature:2029.6324697040875,bytesPerFeatureLabel:3844.951315}},ICON_POLYGON:{bytesPerFeature:3379.2552364427283,bytesPerFeatureLabel:3144.1341316666667,resourceBytes:0,draped:{bytesPerFeature:2594.5439970589305,bytesPerFeatureLabel:3391.0192816666668}},OBJECT_POINT:{bytesPerFeature:755.5754513856272,bytesPerFeatureLabel:3229.7766,resourceBytes:0,draped:{bytesPerFeature:755.5754513856272,bytesPerFeatureLabel:3229.7766}},OBJECT_POLYGON:{bytesPerFeature:1235.9612556276838,bytesPerFeatureLabel:2710.5796950000004,resourceBytes:0,draped:{bytesPerFeature:1235.9612556276838,bytesPerFeatureLabel:2710.5796950000004}},LINE_MITER:{bytesPerFeature:2343.0098144295366,bytesPerFeatureLabel:2863.2415183333333,resourceBytes:0,draped:{bytesPerFeature:2118.062960542706,bytesPerFeatureLabel:2993.8707950000003}},LINE_ROUND:{bytesPerFeature:3180.281669156425,bytesPerFeatureLabel:2884.062711666667,resourceBytes:0,draped:{bytesPerFeature:2687.1048133674676,bytesPerFeatureLabel:2965.844025}},PATH_MITER_CIRCLE:{bytesPerFeature:26642.015762630304,bytesPerFeatureLabel:3147.8341749999995,resourceBytes:0,draped:{bytesPerFeature:26642.015762630304,bytesPerFeatureLabel:3147.8341749999995}},PATH_ROUND_CIRCLE:{bytesPerFeature:21137.659435445064,bytesPerFeatureLabel:2827.1294000000003,resourceBytes:0,draped:{bytesPerFeature:21137.659435445064,bytesPerFeatureLabel:2827.1294000000003}},PATH_MITER_QUAD:{bytesPerFeature:25592.283303929427,bytesPerFeatureLabel:3354.641775,resourceBytes:0,draped:{bytesPerFeature:25592.283303929427,bytesPerFeatureLabel:3354.641775}},PATH_ROUND_QUAD:{bytesPerFeature:23212.92773696872,bytesPerFeatureLabel:3173.6644499999998,resourceBytes:0,draped:{bytesPerFeature:23212.92773696872,bytesPerFeatureLabel:3173.6644499999998}},FILL:{bytesPerFeature:3069.6014181747005,bytesPerFeatureLabel:3050.617135,resourceBytes:0,draped:{bytesPerFeature:2547.9765396831167,bytesPerFeatureLabel:3166.2821483333337}},FILL_OUTLINE:{bytesPerFeature:3653.779598313774,bytesPerFeatureLabel:2787.5897050000003,resourceBytes:0,draped:{bytesPerFeature:2884.528596112384,bytesPerFeatureLabel:2907.420548333333}},EXTRUDE:{bytesPerFeature:5785.658350054202,bytesPerFeatureLabel:2787.498365,resourceBytes:0,draped:{bytesPerFeature:5785.658350054202,bytesPerFeatureLabel:2787.498365}},EXTRUDE_EDGES:{bytesPerFeature:3380.451670091342,bytesPerFeatureLabel:2245.881308333333,resourceBytes:0,draped:{bytesPerFeature:3380.451670091342,bytesPerFeatureLabel:2245.881308333333}}};var xr,Cr,Ar;!function(e){e[e.RecreateSymbol=0]="RecreateSymbol",e[e.RecreateGraphics=1]="RecreateGraphics",e[e.FastUpdate=2]="FastUpdate"}(xr||(xr={})),function(e){e[e.Slow=0]="Slow",e[e.Fast=1]="Fast",e[e.Mixed=2]="Mixed",e[e.Loading=3]="Loading",e[e.Undefined=4]="Undefined"}(Cr||(Cr={}));class wr{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=Ar.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return this._loadStatus===Ar.LOADED?(e&&e(),this._loader??Promise.resolve()):this._loadStatus===Ar.FAILED?(t&&t(this._loadError),this._loader??Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=Ar.LOADED}),(e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=Ar.FAILED,!it(e)&&this.logger&&e.message&&this.logger.warn(e.message),e}))),this._loader.then(e,t).catch((()=>{})),this._loader)}abortLoad(){null!=this._abortController?this._abortController=Ct(this._abortController):this._loadStatus===Ar.LOADING&&(this._loadStatus=Ar.FAILED),this._loader=null}}!function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.FAILED=2]="FAILED"}(Ar||(Ar={}));const Dr=()=>p.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class Fr extends wr{constructor(e,t,r,s,i=!0){super(r.schedule),this.symbol=e,this.symbolLayer=t,this._context=r,this._drivenOpacityFallbackAlwaysOpaque=i,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1},this._materials=[],this.logger=Dr(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new R,this.updateComplexity(),this.ignoreDrivers=s.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=Tr(this._context.renderer,i)),this._updateElevationContext()}get view(){return this._context.stage.view}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}get usedMemory(){const e=this.complexity;return null==e?0:(this.draped?e.memory.draped:e.memory).bytesPerFeature}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,r=Tr(e,this._drivenOpacityFallbackAlwaysOpaque);return r.color!==t.color||r.opacity!==t.opacity||r.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||r.size!==t.size||r.rotation!==t.rotation}get needsDrivenTransparentPass(){return(this._drivenProperties.color||this._drivenProperties.opacity)&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,r,s){const i=e.projectionSuccess,a="polygons"in e?e.polygons:null,n=`${s} geometry failed to be created`;i?!this._logGeometryValidationWarnings(t,r,s)&&a&&0===a.length&&"rings"===r&&t.length>0&&t[0].length>2&&Dr().warnOncePerTick(`${n} (filled rings should use clockwise winding - try reversing the order of vertices)`):Dr().warnOncePerTick(`${n} (failed to project geometry to view spatial reference)`)}updateFocus(e,t){}_logGeometryValidationWarnings(e,t,r){const s=`${r} geometry failed to be created`;return!e.length||1===e.length&&!e[0].length?(Dr().warnOncePerTick(`${s} (no ${t} were defined)`),!0):!(Array.isArray(e)&&Array.isArray(e[0])||(Dr().warnOncePerTick(`${s} (${t} should be defined as a 2D array)`),0))}_validateGeometry(e,t=null,r=null){if(null!=t&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${e.type}`),!1;switch(e.type){case"point":{const t=e;if(!isFinite(t.x)||!isFinite(t.y))return Dr().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":ce(e)}return!0}_defaultElevationInfoNoZ(){return jr}_defaultElevationInfoZ(){return Ir}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t=new R){const r=e.geometry,s=this.getDefaultElevationInfo(r);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:s.unit,t.mode=this.getGeometryElevationMode(r,s),t.offsetMeters=this._elevationContext.meterUnitOffset??s.offset??0;const i=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;i&&(t.mode="relative-to-ground",t.offsetMeters=0);const a=i?z:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(a,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}updateTransform(e,t,r,s){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=Rr){const r=this.draped?1:this._getLayerOpacity();return this._drivenProperties.opacity||this._drivenProperties.color?r:e?r*e.a:t.hasIntrinsicColor?r:0}_getCombinedOpacityAndColor(e,t=Rr){const r=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return pe(null,r);const s=null!=e?g.toUnitRGB(e):u;return pe(s,r)}_getVertexOpacityAndColor(e,t,r=null){const s=this._drivenProperties.color?e.color??t:null,i=this._drivenProperties.opacity?e.opacity??t[3]:null,a=pe(s,i);return r&&(a[0]*=r,a[1]*=r,a[2]*=r,a[3]*=r),a}isFastUpdatesEnabled(){return null!=this._fastUpdates}updateComplexity(){this.complexity=this.computeComplexity()}computeComplexity(){return Sr(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,r){switch(e){case"opacity":return this.layerOpacityChanged(t,r),!0;case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,r,e)!==G.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,r){let s=G.UPDATE;return e?.forEach((e=>{const i=t(e);if(null!=i){const t=e.graphic;this.setGraphicElevationContext(t,i.elevationContext),i.needsElevationUpdates=r(i.elevationContext.mode)}else s=G.RECREATE})),s}applyRendererDiff(e,t){return xr.RecreateSymbol}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,r=t.size?q(t.size.field,e):0,s=t.color?q(t.color.field,e):0,i=t.opacity?q(t.opacity.field,e):0;return E(r,s,i,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&Dr().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null})}}}function Tr(e,t){const r={color:!1,opacity:!1,opacityAlwaysOpaque:t,size:!1,rotation:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach((e=>{switch(e.type){case"color":if(r.color=!0,e.stops)for(let t=0;t<e.stops.length;t++){const s=e.stops[t].color;s&&s.a<1&&(r.opacityAlwaysOpaque=!1)}break;case"opacity":r.opacity=!0,r.opacityAlwaysOpaque=!1;break;case"size":r.size=!0;break;case"rotation":r.rotation=!0}})),r}const jr={mode:"on-the-ground",offset:0,unit:"meters"},Ir={mode:"absolute-height",offset:0,unit:"meters"},Rr={hasIntrinsicColor:!1};function zr(e,t,r,s,i){if(Ur(e,t))return null;r.localOrigin=Nr(e,t);const a=new De({geometries:[r],castShadow:!1,layerViewUid:e.layerViewUid,graphicUid:i,usesVerticalDistanceToGround:!0});return{object:a,sampledElevation:U(a,t,e.elevationProvider,e.renderCoordsHelper,s)}}function Gr(e,t,r,s){return Ur(t,r)?null:U(e,r,t.elevationProvider,t.renderCoordsHelper,s)}function Ur(e,t){const r=e.clippingExtent;return!!r&&(me(t,Vr,e.elevationProvider.spatialReference),!Le(r,Vr))}function Br(e,t,r){const s=e.elevationContext,i=r.spatialReference;me(t,Vr,i),s.centerPointInElevationSR=we(Vr[0],Vr[1],t.hasZ?Vr[2]:0,null!=i?i:null)}function Mr(e){switch(e.type){case"point":return e;case"polygon":case"extent":return ye(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const r=ue(t,he(t)/2);return we(r[0],r[1],r[2],e.spatialReference)}case"mesh":return e.extent.center}return null}function Nr(e,t){return me(t,Vr,e.renderCoordsHelper.spatialReference),e.localOriginFactory.getOrigin(Vr)}const Vr=c();function kr(e){e.include(H),e.uniforms.add(new $("geometryDepthTexture",(e=>e.geometryDepth?.attachment))),e.code.add(ke`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)}const qr=e(),Hr=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new We,{vertex:r,fragment:s}=t,{terrainDepthTest:i}=e;return r.include(Me),t.include(Ne,e),t.vertex.include(W,e),t.attributes.add(le.UV0,"vec2"),r.uniforms.add(new Z("viewport",(e=>e.camera.fullViewport)),new Q("lineSize",((e,t)=>e.size>0?Math.max(1,e.size)*t.camera.pixelRatio:0)),new Y("pixelToNDC",(e=>Ue(qr,2/e.camera.fullViewport[2],2/e.camera.fullViewport[3]))),new Q("borderSize",((e,t)=>e.borderColor?t.camera.pixelRatio:0)),new $e("screenOffset",((e,t)=>Ue(qr,e.horizontalScreenOffset*t.camera.pixelRatio,0)))),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),i&&t.varyings.add("depth","float"),e.occlusionTestEnabled&&t.include(Ve),e.hasScreenSizePerspective&&He(r),r.main.add(ke`
    ProjectHUDAux projectAux;
    vec4 endPoint = projectPositionHUD(projectAux);

    vec3 vpos = projectAux.posModel;
    if (rejectBySlice(vpos)) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
    ${qe(e.occlusionTestEnabled,ke`if (!testHUDVisibility(endPoint)) {
             gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
             return;
           }`)}

    ${e.hasScreenSizePerspective?ke`vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
               vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);`:"vec2 screenOffsetScaled = screenOffset;"}
    // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
    // correct depth value
    vec3 posView = (view * vec4(position, 1.0)).xyz;
    ${qe(i,"depth = posView.z;")}

    applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);
    vec4 startPoint = proj * vec4(posView, 1.0);

    // Apply screen offset to both start and end point
    vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
    startPoint.xy += screenOffsetNorm * startPoint.w;
    endPoint.xy += screenOffsetNorm * endPoint.w;

    // Align start and end to pixel origin
    vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
    vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${qe(e.hudDepth,e.hudDepthAlignStart?"endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);":"startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);")}
    vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);

    // The direction of the line in screen space
    vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
    vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.hasScreenSizePerspective?ke`float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
               float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);`:ke`float lineSizeScaled = lineSize;
               float borderSizeScaled = borderSize;`}
    float halfPixelSize = lineSizeScaled * 0.5;

    // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
    float padding = 1.0 + borderSizeScaled;
    vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

    // Offset x/y from the center of the line in screen space
    projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

    // Compute a coverage varying which we can use in the fragment shader to determine
    // how much a pixel is actually covered by the line (i.e. to anti alias the line).
    // This works by computing two coordinates that can be linearly interpolated and then
    // subtracted to find out how far away from the line edge we are.
    float edgeDirection = (uv0.x * 2.0 - 1.0);

    float halfBorderSize = 0.5 * borderSizeScaled;
    float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
    float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

    float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

    coverageSampling = vec4(
      // Edge coordinate
      outerEdgeCoverageSampler,

      // Border edge coordinate
      outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

      // Line offset
      halfPixelSize - 0.5,

      // Border offset
      halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
    );

    lineSizes = vec2(lineSizeScaled, borderSizeScaled);
    gl_Position = projectedPosition;`),s.uniforms.add(new J("uColor",(e=>e.color??O)),new J("borderColor",(e=>e.borderColor??O))),i&&(s.include(kr,e),s.uniforms.add(new Y("inverseViewport",(e=>e.inverseViewport)))),s.main.add(ke`
    ${qe(i,"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }")}

    vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

    float borderAlpha = uColor.a * borderColor.a * coverage.y;
    float colorAlpha = uColor.a * coverage.x;

    float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);
    ${qe(!e.hudDepth,ke`vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
           fragColor = vec4(finalRgb, finalAlpha);`)}`),t}},Symbol.toStringTag,{value:"Module"}));class $r extends X{constructor(e,t){super(e,t,new K(Hr,(()=>Promise.resolve().then((()=>Hr)))))}initializePipeline(e){const{hudDepth:t,terrainDepthTest:r}=e,s={func:r?Ze.ALWAYS:Ze.LESS};return Ye(t?{depthTest:s,depthWrite:Je}:{blending:Ke(Qe.ONE,Qe.SRC_ALPHA,Qe.ONE_MINUS_SRC_ALPHA,Qe.ONE_MINUS_SRC_ALPHA),depthTest:s,colorWrite:Xe})}}class Wr extends Re{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}}et([tt()],Wr.prototype,"screenCenterOffsetUnitsEnabled",void 0),et([tt()],Wr.prototype,"occlusionTestEnabled",void 0),et([tt()],Wr.prototype,"hasVerticalOffset",void 0),et([tt()],Wr.prototype,"hasScreenSizePerspective",void 0),et([tt()],Wr.prototype,"hudDepth",void 0),et([tt()],Wr.prototype,"hudDepthAlignStart",void 0),et([tt()],Wr.prototype,"terrainDepthTest",void 0);class Zr extends ze{constructor(e,t){super(e,Jr),this.intersectDraped=void 0,this.produces=new Map([[ee.LINE_CALLOUTS,e=>Ie(e)],[ee.LINE_CALLOUTS_HUD_DEPTH,e=>Ie(e)]]),this._configuration=new Wr(t),this._uniqueMaterialIdentifier=Qr(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.hudDepth=t.slot===ee.LINE_CALLOUTS_HUD_DEPTH,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=rt||(this.parameters.borderColor?.[3]??0)>=rt}intersect(){}createGLMaterial(e){return new Yr(e)}createBufferWriter(){return new es}validateParameters(e){this._uniqueMaterialIdentifier=Qr(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}}function Qr({renderOccluded:e,isDecoration:t,horizontalScreenOffset:r,color:s,size:i,occlusionTest:a,shaderPolygonOffset:n,hudDepthAlignStart:o,centerOffsetUnits:l,hasSlicePlane:c,screenSizePerspective:u,verticalOffset:h,borderColor:d}){return y`${e}:${t}:${r}:[${s}]:${i}:${a}:${n}:${o}:${l}:${c}:${null!=u}:{${h.screenLength}:${h.minWorldLength}:${h.maxWorldLength}}:[${d}]`}class Yr extends te{beginSlot(e){return this.getTechnique($r,e)}}class Jr extends Ge{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=E(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const Xr=je().vec3f(le.POSITION).vec3f(le.NORMAL).vec2f16(le.UV0).vec4f(le.CENTEROFFSETANDDISTANCE),Kr=[Te(0,0),Te(1,0),Te(0,1),Te(1,0),Te(1,1),Te(0,1)];class es{constructor(){this.vertexBufferLayout=Xr}elementCount(e){return 6*e.get(le.POSITION).indices.length}write(e,t,r,s,i,a){re(r.get(le.POSITION),e,i.position,a,6),se(r.get(le.NORMAL),t,i.normal,a,6),ie(r.get(le.CENTEROFFSETANDDISTANCE),i.centerOffsetAndDistance,a,6);for(let e=0;e<Kr.length;++e)i.uv0.setVec(a+e,Kr[e]);return null}}class ts extends Fr{static{this.elevationModeChangeTypes={definedChanged:G.UPDATE,staysOnTheGround:G.UPDATE,onTheGroundChanged:G.RECREATE}}constructor(e,t){super(e,null,t,is),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new Zr(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new Jr,t=this.symbol,r=t.callout;if(r.color){const t=g.toUnitRGBA(r.color);t[3]*=this._getLayerOpacity(),e.color=t}else e.color=O;if(e.size=L(r.size||0),t.verticalOffset){const{screenLength:r,minWorldLength:s,maxWorldLength:i}=t.verticalOffset;e.verticalOffset={screenLength:L(r),minWorldLength:s||0,maxWorldLength:null!=i?i:1/0}}e.borderColor=null!=r.border?.color?g.toUnitRGBA(r.border.color):null;const s="object"===t.symbolLayers.at(0).type,i="label-3d"===t.type;return e.occlusionTest=!s&&!v("enable-feature:non-occluded-hud"),s&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=i,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return ss}createGraphics3DGraphic(e,t){const r=e.renderingInfo,s=e.graphic,i=this.setGraphicElevationContext(s,new R,r.elevationOffset||0),a=r.symbol,n="on-the-ground"===this._elevationContext.mode&&("cim"===a.type||!a.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==a.type&&n)return null;if("point-3d"===a.type&&a.symbolLayers.every((e=>"text"===e.type&&!m(e))))return null;const o=ye(s.geometry);return null==o?null:this._createAs3DShape(o,i,r,s.uid,t)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,r){const s=this._elevationContext.mode,i=B(ts.elevationModeChangeTypes,r,s);return i!==G.UPDATE||e?.forEach((e=>{const r=t(e);null!=r&&this.updateGraphicElevationContext(e.graphic,r)})),i}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,r=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(r),t}updateGraphicElevationContext(e,t){const{elevationContext:r,metadata:s}=t;this.setGraphicElevationContext(e,r,s?.elevationOffset??0),t.needsElevationUpdates=M(r.mode)}computeComplexity(){return new hr({verticesPerFeature:6})}_getOrCreateMaterial(e,t){const r=this._perInstanceMaterialParameters(e),s=Qr(r);if(s===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let e=t.get(s);return null==e&&(e=new Zr(r,this._context.spherical),t.set(s,e)),e}return new Zr(r,this._context.spherical)}_createAs3DShape(e,t,r,s,i){const a=this._context.layerViewUid,n=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerViewUid:a}),o=this._getOrCreateMaterial(r,i),l=new ae(o,function(e){const{translation:t,centerOffset:r}=e,s=new Fe(t?[t[0],t[1],t[2]]:[0,0,0],rs,3,!0),i=new Fe(r?[r[0],r[1],r[2],r[3]]:[0,0,0,1],rs,4,!0);return[[le.POSITION,s],[le.NORMAL,new Fe([0,0,1],rs,3,!0)],[le.CENTEROFFSETANDDISTANCE,i]]}(r),null,ne.Point,n),c=zr(this._context,e,l,t,s);if(null==c)return null;const u=new tr(this,c.object,null,Nt,t);return u.metadata=new or(r.elevationOffset),u.alignedSampledElevation=c.sampledElevation,u.needsElevationUpdates=M(t.mode),Br(u,e,this._context.elevationProvider),u}}const rs=[0],ss={mode:"relative-to-ground",offset:0},is={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class as extends Ut{constructor(e,t,r=c(),s=x(),i=0,a="world",n=0){super(e,t),this.translation=r,this.centerOffset=s,this.horizontalScreenOffset=i,this.centerOffsetUnits=a,this.elevationOffset=n}}class ns extends Kt{}const os=()=>p.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function ls(e,t){if(!f(e))return os().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const r=cs[e.callout.type];return r?new r(e,t):(os().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const cs={line:ts},us=new ht(Array,(e=>Ee(e,Oe)),null,10,5),hs=yt();class ds{get labelLayers(){return this._labelLayers||_}get extent(){return this._extent}get isElevationSource(){return this.layers.some((e=>e?.isElevationSource))}constructor(e,t,r,s,i){this.graphic=e,this.graphics3DSymbol=t,this.layers=r,this._visibleFlags=zt.ALL_LABEL,++t.referenced,this._featureExpressionFeature=i?N(i,e,s):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic((t=>{t.initialize(e),t.setVisibility(this.isVisible())}))}destroy(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic((e=>e.destroy())),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(Gt.LABEL))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(e=Gt.GRAPHIC,t){const r=t?this._visibleFlags|t|Gt.LABEL*t:this._visibleFlags;return e===Gt.GRAPHIC?(r&zt.ALL_GRAPHIC)===zt.ALL_GRAPHIC:(r&zt.ALL_LABEL)===zt.ALL_LABEL}setVisibilityFlag(e,t,r){const s=this.isVisible(e);r?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const i=this.isVisible(e);if(s===i)return!1;if(e===Gt.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(i)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(i)));const e=this.isVisible(Gt.LABEL);this._forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}getVisibilityFlag(e,t){return 0!==(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(null==t)return!1;this._extent=yt(),bt(t,this._extent);const r=t.spatialReference;if(!gt(r,e)&&!pt(this._extent,r,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,r){let s=e.geometry;return"mesh"!==s.type&&"extent"!==s.type||(s=dt.fromExtent("mesh"===s.type?s.extent:s)),vt(s,t,r)}get usedMemory(){let e=ut(this.graphic.attributes);return this._forEachSymbolLayerGraphic((t=>e+=t.usedMemory)),e}computeAttachmentOrigin(){const t={render:{origin:c(),num:0},draped:{origin:e(),num:0}};for(const e of this.layers)null!=e&&e.computeAttachmentOrigin(t);return t.render.num>1&&i(t.render.origin,t.render.origin,1/t.render.num),t.draped.num>1&&Be(t.draped.origin,t.draped.origin,1/t.draped.num),t}async getProjectedBoundingBox(e,t,r,s,i){return i||(i={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),i.boundingBox?_e(i.boundingBox):i.boundingBox=_e(),i.requiresDrapedElevation=!1,await st(this.layers,(async a=>{if(null==a)return;const n="draped"===a.type?t:e,o=us.acquire(),l=await a.getProjectedBoundingBox(n,r,i.screenSpaceObjects,s,o);isFinite(l[2])&&isFinite(l[5])||(i.requiresDrapedElevation=!0),l&&xe(i.boundingBox,o),us.release(o)})),Ce(i.boundingBox)||mt(Ae(i.boundingBox,hs))?i:null}needsElevationUpdates(){for(const e of this.layers)if(null!=e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some((e=>e?.needsElevationUpdates??!1))??!1}alignWithElevation(e,t,r){this._forEachRenderedGraphic((s=>{"object3d"!==s.type&&"lod-instance"!==s.type||s.alignWithElevation(e,t,this._featureExpressionFeature,r)}))}alignWithAbsoluteElevation(e,t,r){this._forEachRenderedGraphic((s=>{"object3d"===s.type&&s.alignWithAbsoluteElevation(e,t,r)}))}addObjectStateSet(e){this._forEachSymbolLayerGraphic((t=>t.addObjectState(e)))}removeObjectState(e){this._forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}updateHighlights(e){this._forEachSymbolLayerGraphic((t=>t.updateHighlights(e)))}_forEachGraphicList(e,t){e?.forEach((e=>e&&t(e)))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}}class ps{constructor(e,t,r,s){this.scheduler=e,this.schedule=t,this.layerViewUid=r,this.compressionTracker=s,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===Lt.Global}}function ys(e){return 2216+4096*e.symbolLayers.length+e.complexity.memory.resourceBytes}class ms extends wr{set symbol(e){this._symbol=e,e.symbolLayers.forEach(((t,r)=>{const s=this.symbolLayers[r];null!=s&&(s.symbol=e,s.symbolLayer=t)}))}get symbol(){return this._symbol}constructor(e,t,r){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const r=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const s=[];if(!fs){const{make:e}=await import("./Graphics3DSymbolLayerFactory.js");fs=e}for(let i=0;i<r;i++){const a=t.at(i);if(!1===a.enabled)continue;gs.renderPriority=1-(1+i)/r,gs.renderPriorityStep=1/r,gs.ignoreDrivers=a.ignoreDrivers;const n=fs(this.symbol,a,this._context,gs),o=at(e,(()=>{this.symbolLayers[i]=null,n.destroy()}));o&&s.push(o),this.symbolLayers[i]=n}if(await st(this.symbolLayers,(async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}})),s.forEach((e=>e.remove())),nt(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((e=>e?.queryForSnapping))}updateFocus(e,t){this.symbolLayers.forEach((r=>r?.updateFocus(e,t)))}createGraphics3DGraphic(e,t){const r=e.graphic,s=this.symbolLayers.map((t=>t?.createGraphics3DGraphic(e)??null)),i=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new ds(r,t||this,s,e.layer,i)}get complexity(){return br(this.symbolLayers.map((e=>null!=e?e.complexity:null)))}globalPropertyChanged(e,t){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const r=this.symbolLayers[s],i=e=>{const t=e.layers[s];return t instanceof tr?t:null};if(null!=r&&!r.globalPropertyChanged(e,t,i))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==Ar.LOADED?xr.RecreateSymbol:this.symbolLayers.reduce(((r,s)=>r!==xr.RecreateSymbol&&null!=s?Math.min(r,s.applyRendererDiff(e,t)):r),xr.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===Ar.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const r=t.symbolLayers.diff;this.symbolLayers.forEach(((t,s)=>{if(null==t)return;const i=r[s];if(i){const r={diff:i,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(r),e.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const i=e.layers[s];null!=i&&r.graphics3DGraphicPatches.forEach((e=>e(i,t)))}))}}))}updateGeometry(e,t){return this._updateGeometryOrTransform(e,((e,r)=>e.updateGeometry(r,t)))}updateTransform(e,t,r,s){return this._updateGeometryOrTransform(e,((e,i)=>e.updateTransform(i,t,r,s)))}_updateGeometryOrTransform(e,t){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(null==s)continue;const i=e.layers[r];if(!i||!t(s,i))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const r=this.symbolLayers[t];if(null==r)continue;const s=e.layers[t];null!=s&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=!1,t=!1;for(const r of this.symbolLayers)if(null!=r){if(r.loadStatus===Ar.LOADING)return Cr.Loading;r.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?Cr.Mixed:Cr.Fast:e?Cr.Slow:Cr.Undefined}async queryForSnapping(e,t,r,s){const i=this.symbolLayers.filter(S).filter((e=>null!=e.queryForSnapping)).map((i=>i.queryForSnapping(e,t,r,s))),a=await Promise.all(i);return nt(s),a.flat()}destroy(){if(!this.destroyed){super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get cachedMemory(){return ys(this)}}let fs=null;const gs=new class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};class bs extends wr{constructor(e,t,r){super(t),this.symbol=e,this._convert=r,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),null!=this.graphics3DSymbol&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:fr}globalPropertyChanged(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(e,t):xr.RecreateSymbol}prepareSymbolPatch(e){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(e,t)}updateTransform(e,t,r,s){return this.graphics3DSymbol?.updateTransform(e,t,r,s)??!1}onRemoveGraphic(){}updateFocus(){}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??Cr.Loading}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}get cachedMemory(){return ys(this)}}const vs=1.2,_s=O,Ss=4;function Ps(e,t,r){if(null==e||null==r)return!1;let s=!0;return Es[0]=null!=e.xmin?e.xmin:0,Es[1]=null!=e.ymin?e.ymin:0,Es[2]=null!=e.zmin?e.zmin:0,s=s&&D(Es,e.spatialReference,0,t,r,0),Es[0]=null!=e.xmax?e.xmax:0,Es[1]=null!=e.ymax?e.ymax:0,Es[2]=null!=e.zmax?e.zmax:0,s=s&&D(Es,e.spatialReference,0,t,r,3),null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.zmin&&(t[2]=-1/0),null==e.xmax&&(t[3]=1/0),null==e.ymax&&(t[4]=1/0),null==e.zmax&&(t[5]=1/0),s}function Ls(e,t,r){if(null==e||null==r)return!1;let s=!0;return Es[0]=null!=e.xmin?e.xmin:0,Es[1]=null!=e.ymin?e.ymin:0,Es[2]=null!=e.zmin?e.zmin:0,s=s&&D(Es,e.spatialReference,0,Es,r,0),t[0]=Es[0],t[1]=Es[1],Es[0]=null!=e.xmax?e.xmax:0,Es[1]=null!=e.ymax?e.ymax:0,Es[2]=null!=e.zmax?e.zmax:0,s=s&&D(Es,e.spatialReference,0,Es,r,0),t[2]=Es[0],t[3]=Es[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),s}const Es=c();class Os{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,r){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}async queryElevation(e,t,r,s,i){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,i,r,s)}}class xs{constructor(e,t,r,s){this.spatialReference=t,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(wt.ELEVATION_QUERY,this)}destroy({completeTasks:e}={completeTasks:!1}){if(this._frameTask.remove(),this.running)if(e)this.runTask(Dt);else for(const e of this._queries)e.result.reject(ot())}queryElevation(e,t,r,s=0){const i=lt(),a={x:e,y:t,minDemResolution:s,result:i,signal:r};return this._queries.push(a),ct(r,(()=>{P(this._queries,a),i.reject(ot())})),i.promise}get running(){return this._queries.length>0}runTask(e){const t=this._queries;this._queries=[];const r=this._getElevationQueryProvider();if(!r)return t.forEach((e=>e.result.reject())),void e.madeProgress();const s=t.map((e=>[e.x,e.y])),i=t.reduce(((e,t)=>Math.min(e,t.minDemResolution)),1/0),a=new At({points:s,spatialReference:this.spatialReference}),n=t.length>1&&t.some((e=>!!e.signal))?new AbortController:null,o=null!=n?n.signal:t[0].signal;if(null!=n){let e=0;t.forEach((r=>ct(r.signal,(()=>{e++,r.result.reject(ot()),e===t.length&&n.abort()}))))}const l={...this._queryOptions,minDemResolution:i,signal:o};r.queryElevation(a,l).then((e=>{t.forEach(((t,r)=>{null!=t.signal&&t.signal.aborted?t.result.reject(ot()):t.result.resolve(e.geometry.points[r][2])}))})).catch((e=>{t.forEach((t=>t.result.reject(e)))})),e.madeProgress()}get test(){}}class Cs{constructor(e="scene"){this.context=e,this.extent=ft()}}class As{constructor(){this._pendingCompressionTasks=Ft(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}}export{xr as A,kt as B,ur as C,lr as D,Cs as E,Cr as F,Fr as G,cr as H,Mt as I,or as J,jt as K,as as L,Ss as M,ns as N,er as O,xs as P,Ut as R,hr as S,As as T,Gt as V,tr as a,ms as b,vr as c,gr as d,ps as e,Tt as f,zt as g,Os as h,Bt as i,Ar as j,Kt as k,bs as l,ls as m,_s as n,Mr as o,Ps as p,Nr as q,Br as r,vs as s,Ls as t,Gr as u,zr as v,Nt as w,qt as x,Pr as y,Er as z};
