/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{l as e,s as t,t as r}from"./vec3.js";import{a as s,P as i,i as o}from"./projectBuffer.js";import{e as n,j as a}from"./unitUtils.js";import{_ as c}from"./tslib.es6.js";import l from"../core/Accessor.js";import p from"../core/Evented.js";import{L as m}from"./Logger.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as f}from"../core/accessorSupport/decorators/subclass.js";import{h}from"./mat4.js";import{c as d}from"./mat4f64.js";import{c as v}from"./vec3f64.js";import{p as E}from"./projectBoundingSphere.js";import{e as R,a as _}from"./aaBoundingRect.js";import{f as g}from"./sphere.js";import{E as j}from"./ElevationRange.js";import{E as x}from"./TextureCompressionTracker.js";import{I as y}from"./Intersector2.js";import{S}from"./IntersectorResult.js";function C(t,r,c,l){const p=s(r,l);if(null==p)return!1;const m=p.source.spatialReferenceId,u=p.dest.spatialReferenceId;if(m===u&&m!==i.UNKNOWN||n(r,l))return c[0]=1,c[1]=1,c[2]=1,!0;if(m===i.SPHERICAL_ECEF){const r=e(t),s=r/Math.sqrt(t[0]*t[0]+t[1]*t[1]),n=r/a.radius;if(u===i.WEB_MERCATOR)return c[0]=s*n,c[1]=s*n,c[2]=1,!0;if(u===i.WGS84||u===i.CGCS2000){const e=o;return c[0]=e*s*n,c[1]=e*n,c[2]=1,!0}}else if(m===i.PLATE_CARREE){if(u===i.WGS84||u===i.CGCS2000)return c[0]=o,c[1]=o,c[2]=1,!0;if(u===i.WEB_MERCATOR){const e=t[1]/a.radius;return c[0]=1,c[1]=1/Math.cos(e),c[2]=1,!0}}return!1}let b=class extends(p.EventedMixin(l)){constructor(e){super(e),this._tmpEvent=new x,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=new y(this.view.state.viewingMode),this._intersector.options.store=S.MIN,this._intersector.options.normalRequired=!1,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,r,s,i){const o=this._renderCoordsHelper,n=t(N,e,r,s);if(!o.toRenderCoords(n,i,n))return m.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:c,intersectionHandler:l}=this,p=a.fullExtent,u=null!=p&&Number.isFinite(p.xmin)&&Number.isFinite(p.xmax)&&Number.isFinite(p.ymin)&&Number.isFinite(p.ymax)&&Number.isFinite(p.zmin)&&Number.isFinite(p.zmax)?new j(p.zmin,p.zmax):a.elevationRange;if(null==u)return null;const f=a.elevationOffset,h=u.elevationRangeMin+f,d=u.elevationRangeMax+f,v=o.setAltitude(O,d,n),E=o.setAltitude(A,h,n);return c.reset(v,E,this.view.state.camera),l.intersect(c,null,v,E,null,!0),c.results.min.getIntersectionPoint(n)?o.getAltitude(n):null}getSphereElevationBounds(e,t){return E(e,t,M,this._renderSR),this._layerElevationSource.getElevationRange(M)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new j(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){R(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){R(t);for(const r of e)this._expandExtent(r,t)}_expandExtent(e,t){const s=this.spatialReference;if(null==s)return;if(null==e)return;h(w,e.quaternion),w[12]=e.center[0],w[13]=e.center[1],w[14]=e.center[2];const i=e.halfSize;for(let e=0;e<8;++e)N[0]=1&e?i[0]:-i[0],N[1]=2&e?i[1]:-i[1],N[2]=4&e?i[2]:-i[2],r(N,N,w),this._renderCoordsHelper.fromRenderCoords(N,N,s),_(t,N,t)}};c([u({constructOnly:!0})],b.prototype,"layerElevationSource",void 0),c([u({constructOnly:!0})],b.prototype,"intersectionHandler",void 0),c([u({constructOnly:!0})],b.prototype,"view",void 0),c([u()],b.prototype,"spatialReference",null),b=c([f("esri.views.3d.layers.i3s.LayerElevationProvider")],b);const w=d(),M=g(0,0,0,0),N=v(),O=v(),A=v();class H{constructor(e,t,r,s){this.toMapSpace=e,this.transform=t,this.obb=r,this.geometry=s}}class L{constructor(e,t){this.position=e,this.rotationScale=t,this.origin=void 0}}export{b as L,H as O,L as T,C as l};
