/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import o from"../core/Error.js";import t from"../core/Loadable.js";import{g as s}from"./MapUtils.js";import r from"../core/Promise.js";import{throwIfAborted as u}from"../core/promiseUtils.js";import{R as i}from"./ReactiveMap.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./Logger.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import{b as p}from"./layerUtils.js";import{R as l}from"./typeUtils4.js";import"../config.js";import"./maybe.js";import"./Warning.js";import"../core/Accessor.js";import"../core/Handles.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./Lifecycle.js";import"./metadata.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./tracking.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./events.js";import"./ensureType.js";import"./SimpleObservable.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"../request.js";import"./persistableUrlUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"../layers/catalog/catalogUtils.js";import"../core/reactiveUtils.js";import"./jsonMap.js";let c=class extends(t.LoadableMixin(r)){constructor(e){super(e),this.layerIdToSourceIdLookup=new i,this.sourceIdToLayerIdLookup=new i,this.sourceIdToNetworkInfo=new i,this._rulesBySourceId=new Map,this._terminalConfigurationsBySourceId=new Map}async load(e){return this.addResolvingPromise(this._load(e)),this}agatFromRule(e,o){let t;switch(o){case"to":t={networkSource:e.toNetworkSource??null,assetGroup:e.toAssetGroup??null,assetType:e.toAssetType??null};break;case"from":t={networkSource:e.fromNetworkSource??null,assetGroup:e.fromAssetGroup??null,assetType:e.fromAssetType??null};break;case"via":t={networkSource:e.viaNetworkSource??null,assetGroup:e.viaAssetGroup??null,assetType:e.viaAssetType??null}}return null===t.networkSource?null:t}agatToFullDefinition({assetGroup:e,assetType:o,networkSourceId:t}){if(null===t||null===e||null===o)return null;const s={networkSource:null,assetGroup:null,assetType:null},r=this.sourceIdToNetworkInfo.get(t);if(!r)return null;s.networkSource=r;const u=r.assetGroupLookup.get(e);return u?(s.assetGroup=u,s.assetType=u.assetTypeLookup.get(o)??null,null===s.assetType?null:s):null}findAgat(e,t){const s=p(t)?t.parent:t;if(!s)throw new o("utility-network:missing-layer","Unable to find asset group/asset type for layer. The given layer is a `SubtypeSublayer` with no parent.");if(this.utilityNetwork.featureServiceUrl!==s.url)return null;const r=this.getNetworkSourceIdForLayer(s);if(null===r)return null;const u=s.fieldsIndex.get("assettype")?.name??"";if(""===u)return null;const i=s.fieldsIndex.get("assetgroup")?.name??"";if(""===i)return null;const a=e.attributes[u],n=e.attributes[i];return null==a||null==n?null:{assetGroup:n,assetType:a,networkSourceId:r}}findAgatFullDefinition(e,o){const t=this.findAgat(e,o);return t?this.agatToFullDefinition(t):null}findRules({networkSourceId:e,assetGroup:o,assetType:t}){const s=[];if(null===e||null===o)return s;const r=this._rulesBySourceId.get(e)?.get(o);if(!r)return s;for(const e of r.generalRules)s.push(e);if(null!=t){const e=r.typeSpecificRules.get(t);if(e)for(const o of e)s.push(o)}return s}getNetworkSourceIdForLayer(e){const o=p(e)?e.parent:e;return o&&this.utilityNetwork.featureServiceUrl===o.url?this.layerIdToSourceIdLookup.get(o.layerId)??null:null}ruleMatchesAgat(e,o,t){switch(t){case"to":return!(e.toNetworkSource?.sourceId!==o.networkSourceId||e.toAssetGroup&&e.toAssetGroup.assetGroupCode!==o.assetGroup||e.toAssetType&&e.toAssetType.assetTypeCode!==o.assetType);case"from":return!(e.fromNetworkSource?.sourceId!==o.networkSourceId||e.fromAssetGroup&&e.fromAssetGroup.assetGroupCode!==o.assetGroup||e.fromAssetType&&e.fromAssetType.assetTypeCode!==o.assetType);case"via":return!(e.viaNetworkSource?.sourceId!==o.networkSourceId||e.viaAssetGroup&&e.viaAssetGroup.assetGroupCode!==o.assetGroup||e.viaAssetType&&e.viaAssetType.assetTypeCode!==o.assetType)}}ruleMatchesFullDefinitionAgat(e,o,t){switch(t){case"to":return!(e.toNetworkSource?.sourceId!==o.networkSource?.sourceId||e.toAssetGroup&&e.toAssetGroup.assetGroupCode!==o.assetGroup?.assetGroupCode||e.toAssetType&&e.toAssetType.assetTypeCode!==o.assetType?.assetTypeCode);case"from":return!(e.fromNetworkSource?.sourceId!==o.networkSource?.sourceId||e.fromAssetGroup&&e.fromAssetGroup.assetGroupCode!==o.assetGroup?.assetGroupCode||e.fromAssetType&&e.fromAssetType.assetTypeCode!==o.assetType?.assetTypeCode);case"via":return!(e.viaNetworkSource?.sourceId!==o.networkSource?.sourceId||e.viaAssetGroup&&e.viaAssetGroup.assetGroupCode!==o.assetGroup?.assetGroupCode||e.viaAssetType&&e.viaAssetType.assetTypeCode!==o.assetType?.assetTypeCode)}}terminalConfiguration(e,o,t){const s=this._terminalConfigurationsBySourceId.get(e);if(!s)return null;const r=s.get(o);return r&&r.get(t)||null}async _load(e){await this.utilityNetwork.load(),u(e);const{dataElement:t}=this.utilityNetwork;if(!t)throw new o("utility-network:no-data-element","No data element found on utility network");for(const e of t.domainNetworks)for(const o of[...e.edgeSources??[],...e.junctionSources??[]]){this.layerIdToSourceIdLookup.set(o.layerId,o.sourceId),this.sourceIdToLayerIdLookup.set(o.sourceId,o.layerId);const e=(o.assetGroups??[]).map((e=>{const o=new i;for(const t of e.assetTypes??[])o.set(t.assetTypeCode,t);return{...e,assetTypeLookup:o}})),t=new i;for(const o of e)t.set(o.assetGroupCode,o);const s={...o,assetGroupLookup:t,assetGroups:e};this.sourceIdToNetworkInfo.set(s.sourceId,s)}const s=await this.utilityNetwork.getRulesTable();u(e);for(const e of s?.rules??[])switch(e.ruleType){case l.RTAttachment:case l.RTContainment:this._registerRule(e.fromNetworkSource.sourceId,e.fromAssetGroup.assetGroupCode,e.fromAssetType.assetTypeCode,e),this._registerRule(e.toNetworkSource.sourceId,e.toAssetGroup.assetGroupCode,e.toAssetType.assetTypeCode,e);break;case l.RTEdgeJunctionEdgeConnectivity:this._registerRule(e.fromNetworkSource.sourceId,e.fromAssetGroup.assetGroupCode,e.fromAssetType.assetTypeCode,e),this._registerRule(e.toNetworkSource.sourceId,e.toAssetGroup.assetGroupCode,e.toAssetType.assetTypeCode,e),this._registerRule(e.viaNetworkSource.sourceId,e.viaAssetGroup.assetGroupCode,e.viaAssetType.assetTypeCode,e);break;case l.RTJunctionEdgeConnectivity:case l.RTJunctionJunctionConnectivity:this._registerRule(e.fromNetworkSource.sourceId,e.fromAssetGroup.assetGroupCode,e.fromAssetType.assetTypeCode,e),this._registerRule(e.toNetworkSource.sourceId,e.toAssetGroup.assetGroupCode,e.toAssetType.assetTypeCode,e)}this._makeTerminalConfigurationLookups(t)}_makeTerminalConfigurationLookups(e){const o={};for(const t of e.terminalConfigurations??[])o[t.terminalConfigurationId]=t;for(const t of e.domainNetworks??[])for(const e of t.junctionSources)if("esriUNFCUTJunctionObject"===e.utilityNetworkFeatureClassUsageType||"esriUNFCUTDevice"===e.utilityNetworkFeatureClassUsageType)for(const t of e.assetGroups??[])for(const r of t.assetTypes??[])if(null!=r.terminalConfigurationId&&r.terminalConfigurationId>=0){const u=o[r.terminalConfigurationId];if(u){const o=s(this._terminalConfigurationsBySourceId,e.sourceId,(()=>new Map));s(o,t.assetGroupCode,(()=>new Map)).set(r.assetTypeCode,u)}}}_registerRule(e,o,t,r){const u=s(this._rulesBySourceId,e,(()=>new Map)),i=s(u,o,(()=>({generalRules:[],typeSpecificRules:new Map})));-1===t?i.generalRules.push(r):s(i.typeSpecificRules,t,(()=>[])).push(r)}};e([a()],c.prototype,"layerIdToSourceIdLookup",void 0),e([a()],c.prototype,"sourceIdToLayerIdLookup",void 0),e([a()],c.prototype,"sourceIdToNetworkInfo",void 0),e([a()],c.prototype,"utilityNetwork",void 0),c=e([n("esri.networks.support.UtilityNetworkLookupHelper")],c);export{c as UtilityNetworkLookupHelper};
