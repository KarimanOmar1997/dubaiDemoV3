/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{A as t,E as e}from"./enum.js";import{A as s}from"./TimeOnly.js";import{d as r}from"./deepClone.js";import{j as n,Y as o,Z as a,_ as i,a as l,i as c,z as u,y as p,b as h,p as d,c as f,K as m}from"./languageUtils.js";import y from"../geometry/Geometry.js";import{i as g,d as w,b as _,a as b}from"./guards.js";import S from"../core/Error.js";import{L as v}from"./Logger.js";import{g as j}from"./MapUtils.js";import x from"../portal/Portal.js";import T from"../request.js";import{g as L,p as C,a as k}from"./utils10.js";import{_ as A}from"./tslib.es6.js";import O from"../core/JSONSupport.js";import{property as z}from"../core/accessorSupport/decorators/property.js";import{subclass as q}from"../core/accessorSupport/decorators/subclass.js";import{a as J}from"./commonProperties3.js";function N(s){if("string"==typeof s)return s.toLowerCase();if("name"in s)return s.name.toLowerCase();if("string"!=typeof s.value)throw new t(null,e.InvalidIdentifier,null);return s.value.toLowerCase()}const F=Object.freeze({aborted:!1});function U(t,e,s=!1,r=!1){if(null==t)return null;if(g(t)||w(t)||_(t)||c(t)||u(t)||p(t))return t;if(b(t)){const n=[];for(const o of t)n.push(U(o,e,s,r));return n}if(r&&h(t))return t;const n=new P;n.immutable=!1;for(const[o,a]of Object.entries(t))void 0!==a&&n.setField(o,U(a,e,s,r));return n.immutable=s,n}class P{constructor(t){this.declaredClass="esri.arcade.Dictionary",this.plain=!1,this.immutable=!0,t instanceof P?this.attributes=t.attributes:null==t?this.attributes=Object.create(null):null!=Object.getPrototypeOf(t)?this.attributes={__proto__:null,...t}:this.attributes=t}static containerEntry(t,e){return new P({__proto__:null,key:t,value:e})}static textFormatting(){const t=new P({__proto__:null,newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});return t.immutable=!1,t}field(s){const r=s.toLowerCase(),n=this.attributes[s];if(void 0!==n)return n;for(const t in this.attributes)if(t.toLowerCase()===r)return this.attributes[t];throw new t(null,e.FieldNotFound,null,{key:s})}setField(r,o){if(this.immutable)throw new t(null,e.Immutable,null);if(n(o))throw new t(null,e.NoFunctionInDictionary,null);const a=r.toLowerCase();if(o instanceof Date&&(o=s.dateJSToArcadeDate(o)),void 0===this.attributes[r]){for(const t in this.attributes)if(t.toLowerCase()===a)return void(this.attributes[t]=o);this.attributes[r]=o}else this.attributes[r]=o}hasField(t){const e=t.toLowerCase();if(void 0!==this.attributes[t])return!0;for(const t in this.attributes)if(t.toLowerCase()===e)return!0;return!1}keys(){let t=[];for(const e in this.attributes)t.push(e);return t=t.sort(),t}castToText(t=!1){return o(this.attributes,{useNumbersForDates:t})}static convertObjectToArcadeDictionary(t,e,s=!0,r=!1){const n=new P;n.immutable=!1;for(const o in t){const a=t[o];void 0!==a&&n.setField(o.toString(),U(a,e,s,r))}return n.immutable=s,n}static convertJsonToArcade(t,e,s=!1,r=!1){return U(t,e,s,r)}castAsJson(t=null){const e=Object.create(null);for(let s in this.attributes){const r=this.attributes[s];void 0!==r&&(t?.keyTranslate&&(s=t.keyTranslate(s)),e[s]=a(r,t))}return e}async castDictionaryValueAsJsonAsync(t,e,s,r=null,n){const o=await i(s,r,n);return t[e]=o,o}async castAsJsonAsync(t=null,e=null){const r=Object.create(null),n=[];for(let o in this.attributes){const i=this.attributes[o];e?.keyTranslate&&(o=e.keyTranslate(o)),void 0!==i&&(l(i)||i instanceof y||i instanceof s?r[o]=a(i,e):n.push(this.castDictionaryValueAsJsonAsync(r,o,i,t,e)))}return n.length>0&&await Promise.all(n),r}deepClone(){const t=new P;t.immutable=!1;for(const e of this.keys())t.setField(e,r(this.field(e)));return t}}let D=class extends O{constructor(t){super(t),this.text=null,this.detectedLanguage="en",this.detectedLanguageScore=-1}};A([z({type:String,json:{write:!0}})],D.prototype,"key",void 0),A([z({type:String,json:{write:!0}})],D.prototype,"text",void 0),A([z({type:String,json:{read:{source:"detectedLanguage.language"},write:{target:"detectedLanguage.language"}}})],D.prototype,"detectedLanguage",void 0),A([z({type:Number,json:{read:{source:"detectedLanguage.score"},write:{target:"detectedLanguage.score"}}})],D.prototype,"detectedLanguageScore",void 0),A([z({type:Object,json:{write:!0}})],D.prototype,"translation",void 0),D=A([q("esri.rest.support.TranslateResult")],D);let I=class extends O{constructor(t){super(t)}};A([z({type:String,json:{write:!0}})],I.prototype,"key",void 0),A([z({type:String,json:{write:!0}})],I.prototype,"text",void 0),I=A([q("esri.rest.support.TranslateContent")],I);let K=class extends O{constructor(t){super(t),this.to=null,this.contents=null,this.portalUrl="https://www.arcgis.com",this.translator="esri",this.from=null,this.apiKey=null,this.requestSource=null}};A([z({type:[String],json:{write:!0}})],K.prototype,"to",void 0),A([z({type:[I],json:{write:!0}})],K.prototype,"contents",void 0),A([z({type:String,json:{write:!0}})],K.prototype,"portalUrl",void 0),A([z({type:String,json:{write:!0,default:"esri"}})],K.prototype,"translator",void 0),A([z({type:String,json:{write:!0}})],K.prototype,"from",void 0),A([z(J)],K.prototype,"apiKey",void 0),A([z({type:String,json:{name:"x-esri-request-source"}})],K.prototype,"requestSource",void 0),K=A([q("esri.rest.support.TranslateParameters")],K);class M{constructor(t,e){this.portal=t,this._debugLog=e}async translate(t){this.portal.loaded||await this.portal.load();const e=this.portal.helperServices?.aiUtilityServices;if(null==e)return{success:!1};const s=e.url+e.translateUtility;try{return t.requestSource??="arcade",{success:!0,results:(await async function(t,e,s){const r=e.toJSON();r.contents=JSON.stringify(r.contents),r.token=await L(e.portalUrl,e.apiKey,{signal:s?.signal,prompt:"no-prompt"!==s?.authMode});const n=C(t),o=k(n.query,{...s,query:r,method:"post",authMode:"anonymous"});return(await T(n.path,o)).data.results.map((t=>D.fromJSON(t)))}(s,t,{authMode:"no-prompt"})).map((t=>t.toJSON()))}}catch(t){return null!=this._debugLog&&(t instanceof Error||t instanceof S)&&this._debugLog(`TranslateText error: ${t.message}`),v.getLogger("esri.arcade.functions.aiServices").error(t),{success:!1}}}}class B{constructor(t,e,s){this._parameters=t,this._maxTotalContentSize=e,this._maxContentsLength=s,this._requests=[],this._normalizedContents=new Map,this._contentsTotalSize=0}tryAdd(t){const e=new Set(t.filter((t=>!this._normalizedContents.has(t.text))).map((t=>t.text)));if(this._requests.length+e.size>this._maxContentsLength)return null;let s=0;for(const t of e)s+=t.length;if((s+this._contentsTotalSize)*(this._parameters.to.length??1)>this._maxTotalContentSize)return null;const r=this._requests.length;for(const{key:e,text:s}of t)j(this._normalizedContents,s,(()=>[])).push({batchIdx:r,key:e});return this._requests.push(t),this._contentsTotalSize+=s,r}async send(t){const e=[],s=[];let r=0;for(const[t,n]of this._normalizedContents)e.push(new I({key:String(r++),text:t})),s.push(n);const n=new K(this._parameters);n.contents=e;const o=await t.translate(n);if(!o.success)return Array.from(this._requests,(()=>o));const a=Array.from(this._requests,(()=>({success:!0,results:[]})));for(const t of o.results){const e=Number(t.key);for(const r of s[e])a[r.batchIdx].results.push({...t,key:r.key})}return a}}function E(t){const e=[...new Set(t.to)].sort(),s=t.from??null,r=t.portalUrl,n=t.translator,o=t.apiKey??null;return JSON.stringify([e,s,r,n,o])}async function R(t,e,s){try{return(await t.yieldFor(s))[e]}catch{return{success:!1}}}const V=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:class{constructor(t,e,{maxTotalContentSize:s=5e4,maxContentsLength:r=1e3}={}){this._executor=t,this._service=e,this._openBatches=new Map,this._maxTotalContentSize=s,this._maxContentsLength=r}create(t){return{translate:async e=>{const s=E(e),{contents:r,to:n,from:o,translator:a,portalUrl:i,apiKey:l}=e;if(null==n)return{success:!1};if(null==r||r.every((t=>0===t.text.length)))return{success:!1};const c=this._openBatches.get(s);if(null!=c){const e=c.data.tryAdd(r);if(null!=e)return await R(t,e,c);c.send()}const u=new B({to:n,from:o,translator:a,portalUrl:i,apiKey:l},this._maxTotalContentSize,this._maxContentsLength),p=u.tryAdd(r);if(null!=p){const e=this._executor.openBatch(u,{open:t=>{this._openBatches.set(s,t)},execute:t=>t.send(this._service),close:t=>{this._openBatches.get(s)===t&&this._openBatches.delete(s)}});return await R(t,p,e)}return await this._service.translate(e)}}}},PortalTranslationService:M,getTranslateParametersKey:E,registerFunctions:function(s){"async"===s.mode&&(s.functions[N("TranslateText")]=function(r,n){return s.standardFunctionAsync(r,n,(async(s,r,n)=>{if(d(n,2,3,s,r),!_(n[0])&&!b(n[0])&&!f(n[0]))throw new t(s,e.InvalidParameter,r);const o=m(n[0]);if(!_(n[1])&&!b(n[1])&&!f(n[1]))throw new t(s,e.InvalidParameter,r);const a=m(n[1]);let i=null;if(n.length>=3){if(!_(n[2]))throw new t(s,e.InvalidParameter,r);i=n[2]}const l=o.map(((t,e)=>new I({key:String(e),text:t}))),c=s.services?.portal??x.getDefault(),u=new K({to:a,contents:l,from:i,portalUrl:c.restUrl.replace(/\/sharing\/rest$/,"")}),p=new Map;let h=null;if(null!=s.lrucache){const t=s.lrucache;h??=E(u),u.contents=u.contents?.filter((e=>{const s=t.getCachedTranslation(h,e.text);return null==s||(p.set(e.key,{...s,key:e.key,text:e.text}),!1)}))}if(u.contents?.length){const r=s.services?.translation??new M(c,s.console),n=await r.translate(u);if(!n.success)return new P({__proto__:null,success:!1});for(const r of n.results){const n=u.contents?.find((t=>t.key===r.key))?.text;if(null==n)throw new t(null,e.NeverReach,null);p.set(r.key,r),null!=s.lrucache&&(h??=E(u),s.lrucache.setCachedTranslation(h,n,{detectedLanguage:r.detectedLanguage,translation:r.translation}))}}const y=Array.from(l,(r=>{const n=D.fromJSON(p.get(r.key));if(null==n)throw new t(null,e.NeverReach,null);return n.text=r.text,P.convertJsonToArcade(n.toJSON(),s.timeZone??"system",!0)}));return new P({__proto__:null,success:!0,results:y})}))})}},Symbol.toStringTag,{value:"Module"}));export{V as A,P as D,F as n,N as t};
