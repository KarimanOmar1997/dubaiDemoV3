/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{m as e,h as i}from"./handleUtils.js";import o from"../core/Promise.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./Logger.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import{watch as a,syncAndInitial as n,on as l,whenOnce as c}from"../core/reactiveUtils.js";import"../core/Error.js";import{I as p}from"./InteractiveToolBase.js";import{c as u}from"./asyncUtils.js";import{r as v}from"./maybe.js";import{throwIfAborted as d,isAbortError as m,onAbort as y}from"../core/promiseUtils.js";const h=i=>{let a=class extends(o.EsriPromiseMixin(i)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(t){this._userInteractive=t}get updating(){return!1}get visible(){return null==this.parent||this.parent.visible&&!this.parent.suspended}set visible(t){this._overrideIfSome("visible",t)}forceInteractive(){return this._interactiveViewModelCount++,e((()=>this._interactiveViewModelCount--))}};return t([s({constructOnly:!0})],a.prototype,"parent",void 0),t([s({constructOnly:!0})],a.prototype,"view",void 0),t([s({type:Boolean})],a.prototype,"interactive",null),t([s()],a.prototype,"_userInteractive",void 0),t([s({readOnly:!0})],a.prototype,"updating",null),t([s()],a.prototype,"visible",null),t([s()],a.prototype,"_interactiveViewModelCount",void 0),a=t([r("esri.views.3d.analysis.AnalysisView3D")],a),a};let f=class extends p{constructor(t){super(t)}initialize(){this.addHandles(a((()=>this.analysisViewData.visible),(t=>this.visible=t),n))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};function w(t,e){return a((()=>t.interactive),(()=>function(t,e){t.interactive?function(t,e){b(t);const{view:i,analysis:o}=t,s=new e({view:i,analysis:o,analysisViewData:t});t.tool=s,i.tools.add(s)}(t,e):b(t)}(t,e)),n)}function b(t){const{view:e,tool:i}=t;null!=i&&(e.tools.remove(i),t.tool=null)}function j(t,e){const o=t.userOperation,s=u((async s=>{if(o){const t=o.promise.catch((()=>{}));o?.abort(),await t,d(s)}const r=function(t,e){t.interactive=!0;const{tool:i,view:o}=t;o.activeTool=i;let s=y(e,(()=>{o.activeTool===i&&(o.activeTool=null)}));return u((async e=>{await c((()=>!t.tool?.active),e),s=v(s)}),e)}(t,{signal:s}),a=e?.shouldRejectOnCancel??(()=>!0),n=i([l((()=>t.tool),"cancel",(()=>{a()&&r.abort()}))]),{tool:p}=t;try{p&&(p.resetCreated(),e?.onToolActivated?.(p)),await r.promise,d(s)}catch(t){if(s.aborted||!m(t)||a())throw t}finally{n?.remove()}}),{signal:e?.abortOptions?.signal});return t.userOperation=s,s.promise.finally((()=>{t.userOperation===s&&(t.userOperation=null)}))}async function O(t,e){const i=t.analysis.clone();return await j(t,{abortOptions:e?.placementOptions,onToolActivated:e?.onToolActivated,shouldRejectOnCancel:()=>{const{analysis:e}=t;return!e.valid||e.equals(i)}}),{}}f=t([r("esri.views.interactive.AnalysisToolBase")],f);export{f as A,h as a,j as b,w as c,b as r,O as s};
