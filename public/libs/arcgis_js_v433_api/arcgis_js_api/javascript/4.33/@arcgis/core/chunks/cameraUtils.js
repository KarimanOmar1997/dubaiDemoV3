/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../Camera.js";import{C as t,b as n}from"./Cyclical.js";import{L as r}from"./Logger.js";import{r as i,g as a,e as s,c as o,l as c,h as l}from"./mathUtils.js";import{throwIfAborted as u}from"../core/promiseUtils.js";import{c as f,w as m,j as p,k as h,i as d,d as T,l as R,y as M,n as _,f as g,t as y,b as E,s as v,u as I,x,m as A,C as O,I as w}from"./vec3.js";import{c as F,f as S,Z as b,b as N}from"./vec3f64.js";import{U as P,g as j}from"./unitUtils.js";import C from"../geometry/Point.js";import{project as D,projectWithZConversion as H}from"./projectionUtils.js";import L from"../geometry/SpatialReference.js";import{p as U,a as G}from"./projectPointToVector.js";import{p as z,a as B}from"./projectVectorToPoint.js";import{p as k}from"./projectVectorToVector.js";import{V as q}from"./ViewingMode.js";import{v as W}from"./aaBoundingRect.js";import J from"../views/3d/webgl/RenderCamera.js";import{D as X}from"./DepthRange.js";import{I as V,g as Y}from"./Intersector2.js";import{B as K,a as Z,d as Q,A as $}from"./mat4.js";import{c as ee}from"./mat4f64.js";import{c as te,a as ne,f as re}from"./vec2f64.js";import ie from"../geometry/Extent.js";import ae from"../geometry/Polygon.js";import{i as se}from"./coordsUtils.js";import{h as oe,l as ce,k as le,m as ue,b as fe,n as me,o as pe,d as he,p as de,P as Te,e as Re}from"./frustum.js";import{v as Me}from"./vec2.js";import{w as _e,c as ge,b as ye}from"./ray.js";import{w as Ee,c as ve,f as Ie}from"./lineSegment.js";import{e as xe,f as Ae,c as Oe,j as we,x as Fe,I as Se,y as be,g as Ne}from"./plane.js";import{s as Pe,g as je}from"./vec4.js";import{c as Ce}from"./vec4f64.js";import{g as De}from"./common.js";import{k as He,c as Le,m as Ue,l as Ge}from"./sphere.js";import{geographicToWebMercator as ze}from"../geometry/support/webMercatorUtils.js";import{g as Be,a as ke}from"./earthUtils.js";import{b as qe}from"./mathUtils2.js";import{i as We}from"./spatialReferenceSupport.js";function Je(e,t,n,r){return null!=e.renderCoordsHelper.fromRenderCoords(t.eye,Ze,r)&&W(n,Ze)}function Xe(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function Ve(e,t,n,r){const i=e.state.camera.clone();t&&n&&r&&(i.eye=t,i.center=n,i.up=r),function(e,t,n){let r=Ke[e.viewingMode];r||(r=new V(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,Ke[e.viewingMode]=r);const{isGlobal:i}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,n)||Ye(e,t.origin,n))||!(!e.renderCoordsHelper.intersectManifold(t,0,n)||Ye(e,t.origin,n))||!!i&&function(e,t,n){const r=T(e.origin,e.origin)-n*n,i=r>0?Math.sqrt(r)/3:1;return p(t,e.direction,i/R(e.direction)),d(t,t,e.origin),!0}(t,n,P(e.spatialReference).radius)}(e,i.ray,Qe)||f(Qe,i.center);const a=e.state.constraints,s=a.minimumPoiDistance;if(m(i.eye,Qe)<s){const t=a.collision.enabled;f($e,i.viewForward),p($e,$e,s),t?i.eye=h(Ze,Qe,$e):d(Qe,i.eye,$e);const n=e.renderCoordsHelper,r=n.getAltitude(i.eye),o=a.collision.elevationMargin;t&&r<o&&(h($e,Qe,i.eye),i.eye=n.setAltitude(Ze,o,i.eye),d(Qe,i.eye,$e))}return i.center=Qe,i}function Ye(e,t,n){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const r=Xe(e,t),i=e.stateManager.constraintsManager.nearFarHeuristic;let a=et.get(e);void 0===a&&(a=new J,et.set(e,a)),a.eye=t,a.center=n;const{far:s}=i.compute(a,e.renderDataExtent,X.infinite,r),o=s*s;return m(t,n)>o}const Ke={},Ze=F(),Qe=F(),$e=F(),et=new WeakMap;function tt(e,t,n,r){const i=function(e,t){const n=t===at.LEFT||t===at.RIGHT?0:1,r=e[t],i=t===at.LEFT||t===at.BOTTOM?rt.MIN:rt.MAX,a=0===n?1:0;return(e,t,s)=>{if(t[n]<r&&s[n]<r)return i===rt.MIN?it.OUTSIDE:it.INSIDE;if(t[n]>r&&s[n]>r)return i===rt.MIN?it.INSIDE:it.OUTSIDE;const o=(s[a]-t[a])/(s[n]-t[n]),c=t[a]+o*(r-t[n]);return e[n]=r,e[a]=c,(t[n]<r?1:-1)*i>0?it.OUTSIDE_IN:it.INSIDE_OUT}}(n,r);if(e.length=0,t.length){i(st,t[0],t[0])===it.INSIDE&&nt(e,t[0]);for(let n=0;n<t.length;n++){const r=t[n===t.length-1?0:n+1];switch(i(st,t[n],r)){case it.INSIDE:nt(e,r);break;case it.INSIDE_OUT:nt(e,ne(st));break;case it.OUTSIDE_IN:nt(e,ne(st)),nt(e,r);case it.OUTSIDE:}}}}function nt(e,t){0!==e.length&&Me(e.at(-1),t)||e.push(t)}var rt,it,at;!function(e){e[e.MIN=1]="MIN",e[e.MAX=-1]="MAX"}(rt||(rt={})),function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INSIDE=1]="INSIDE",e[e.OUTSIDE_IN=2]="OUTSIDE_IN",e[e.INSIDE_OUT=3]="INSIDE_OUT"}(it||(it={})),function(e){e[e.LEFT=0]="LEFT",e[e.BOTTOM=1]="BOTTOM",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP"}(at||(at={}));const st=te();class ot{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=oe(),this._points=ce(),this.lines=new Array(12),this._origin=F(),this._direction=F(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:F(),endpoint:null}}update(e){le(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),f(this._origin,e.eye),f(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)f(this._points[t],e[t]);ue(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return fe(this.frustum,e)}intersectsRay(e){return me(this.frustum,e)}intersectsLineSegment(e,t){return pe(this.frustum,e,t)}intersectsPoint(e){return he(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const n=t+4;lt(this.lines[t],e[t],e[n]),lt(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),lt(this.lines[t+8],e[n],3===t?e[4]:e[n+1])}}static{this.planePointIndices=de}static{this.nearFarLineIndices=[[Te.NEAR_BOTTOM_LEFT,Te.FAR_BOTTOM_LEFT],[Te.NEAR_BOTTOM_RIGHT,Te.FAR_BOTTOM_RIGHT],[Te.NEAR_TOP_RIGHT,Te.FAR_TOP_RIGHT],[Te.NEAR_TOP_LEFT,Te.FAR_TOP_LEFT]]}}var ct;function lt(e,t,n){e.origin=t,e.endpoint=n,M(e.direction,t,n)}!function(e){e[e.NEAR_FAR_BOTTOM_LEFT=0]="NEAR_FAR_BOTTOM_LEFT",e[e.NEAR_FAR_BOTTOM_RIGHT=1]="NEAR_FAR_BOTTOM_RIGHT",e[e.NEAR_FAR_TOP_RIGHT=2]="NEAR_FAR_TOP_RIGHT",e[e.NEAR_FAR_TOP_LEFT=3]="NEAR_FAR_TOP_LEFT",e[e.NEAR_BOTTOM=4]="NEAR_BOTTOM",e[e.NEAR_RIGHT=5]="NEAR_RIGHT",e[e.NEAR_TOP=6]="NEAR_TOP",e[e.NEAR_LEFT=7]="NEAR_LEFT",e[e.FAR_BOTTOM=8]="FAR_BOTTOM",e[e.FAR_RIGHT=9]="FAR_RIGHT",e[e.FAR_TOP=10]="FAR_TOP",e[e.FAR_LEFT=11]="FAR_LEFT"}(ct||(ct={}));const ut=F(),ft=F();function mt(){return{direction:F(),up:F()}}function pt(e,t,n,r,s){let o=_(ut,e),c=T(o,r);const l=c>0;c=Math.abs(c),c>.99&&(c=Math.abs(T(t,r)),c<.99?(f(o,t),l&&p(o,o,-1)):o=null);let u=0;if(o){p(ft,r,T(r,o)),h(o,o,ft);const e=T(o,s)/(R(o)*R(s));g(ft,o,s),u=(T(ft,r)>0?1:-1)*i(a(e))}const m=i(a(-T(r,e)/R(e)));return n?(n.heading=u,n.tilt=m,n):{heading:u,tilt:m}}function ht(e,t,n,r){h(dt,n,t),xe(r,Ee(t,dt),e)||e===n||f(e,n)}const dt=F(),Tt=S(0,1,0),Rt=S(0,0,1),Mt=ee(),_t=F(),gt=F();function yt(e,t,n,r=mt()){const{direction:i,up:a}=r;return K(Mt,-s(t)),Z(Mt,Mt,s(n)),y(i,Rt,Mt),p(i,i,-1),y(a,Tt,Mt),r}function Et(e,t,n,r,i){const a=t.lines[ct.FAR_LEFT].direction,s=(i-n.getAltitude(r))/a[2];E(e,r,a,s)}const vt=F(),It=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){return pt(t,n,r,Rt,Tt)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i=yt(0,n,r),a=F();return p(a,i.direction,-t),d(a,a,e),{up:i.up,eye:a,heading:n,tilt:r}},eyeTiltToLookAtTilt:function(e){return s(e)},headingTiltToDirectionUp:yt,lookAtTiltToEyeTilt:function(e){return i(e)},toArea:function(e,t){const n=e.frustum,{renderCoordsHelper:r}=e,i=r.getAltitude(t),a=e.spatialReference,s=e.state.camera.eye,o=[],c=n.planes[Re.FAR];for(let e=0;e<4;e++){const t=n.lines[e];r.intersectInfiniteManifold(_e(t.origin,t.direction),i,vt)||Et(vt,n,r,t.endpoint,i),ht(vt,s,vt,c),o.push(re(vt[0],vt[1]))}return function(e,t,n){const r=e.map((e=>(v(vt,e[0],e[1],0),t.fromRenderCoords(vt,vt,n),[vt[0],vt[1]])));return r.length<=2?new ae({spatialReference:n}):(r.push(r[0].slice()),se(r)||r.reverse(),new ae({rings:[r],spatialReference:n}))}(function(e,t){const n=[],r=[];return tt(n,e,t,at.LEFT),tt(r,n,t,at.BOTTOM),tt(n,r,t,at.RIGHT),tt(r,n,t,at.TOP),r}(o,r.extent),r,a)},toExtent:function(e,t,n,r,i){const a=e.renderSpatialReference,s=e.spatialReference??t.spatialReference;return U(t,_t,a),U(t,gt,a),_t[0]-=n/2,gt[0]+=n/2,_t[1]-=r/2,gt[1]+=r/2,k(_t,a,_t,s),k(gt,a,gt,s),i?(i.xmin=_t[0],i.ymin=_t[1],i.xmax=gt[0],i.ymax=gt[1],i.spatialReference=s):i=new ie(_t[0],_t[1],gt[0],gt[1],s),i}},Symbol.toStringTag,{value:"Module"}));function xt(e){return o((e-At)/(Ot-At),0,1)}const At=1e5,Ot=1e6,wt=1e4,Ft=S(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),St=S(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),bt=3996e-9,Nt=S(parseFloat(Number(Ft[0]+St[0]).toFixed(6)),parseFloat(Number(Ft[1]+St[1]).toFixed(6)),parseFloat(Number(Ft[2]+St[2]).toFixed(6)));function Pt(e,t,n){return e===q.Global?new Ct(t,n):new jt(t,n)}class jt{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=P(t),this._unitInMeters=j(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,n,r){const{eye:i,center:a}=e;let s=i[2]*this._unitInMeters;const l=s,u=s-r,f=this._elevationProvider?.visibleElevationBounds;f&&(s=u>=0?l-this._unitInMeters*f.min:this._unitInMeters*f.max-l),t??=new ie({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0});const m={x:t.xmax-t.xmin,y:t.ymax-t.ymin,z:4*Math.max(t.xmax-t.xmin,t.ymax-t.ymin)},p=Math.max(m.x,m.y,m.z);h(Wt,a,i),qt[0]=Wt[0]>0?t.xmax:t.xmin,qt[1]=Wt[1]>0?t.ymax:t.ymin,qt[2]=Wt[2]>0?p/2:-p/2,h(qt,qt,i),_(Wt,Wt);const d=1.1*T(qt,Wt)*this._unitInMeters,R=Math.sqrt(s*(s+2*this._referenceEllipsoid.radius)),M=Math.max(t.xmax-t.xmin,t.ymax-t.ymin),g=M*Bt*this._unitInMeters,y=M*kt*this._unitInMeters,E=o((s-y)/(g-y),0,1)**3,v=Math.min(c(R,d,E),R)*Math.max(Math.log(Math.abs(u)),1);return Dt(Math.min(v,Math.max(34064e4,p))/this._unitInMeters,Ut,this._unitInMeters,Jt)}}class Ct{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=P(t)}compute(e,t,n,r){const{eye:i}=e,s=R(i),l=s-this._referenceEllipsoid.radius,u=this._referenceEllipsoid.radius+Math.min(0,r),f=Math.abs(l-r),m=Math.max(f,Math.abs(l)),d=this._elevationProvider?.visibleElevationBounds.max??0,M=xt(m),g=Math.sqrt(m*(m+2*u)),y=s+this._referenceEllipsoid.radius,E=1.2*c(g,y,M),v=(Math.log(m)-Ht)/(Lt-Ht);Dt(E,o(Ut-v*(Ut-Gt),Gt,Ut),1,Jt);const I=this._referenceEllipsoid.radius+d,x=this._referenceEllipsoid.radius+this._referenceEllipsoid.atmosphereHeight,A=Math.max(I,x),O=s-A;if(M>0&&O>zt){const t=_(qt,p(qt,e.eye,-1)),r=_(Wt,e.viewForward),i=a(T(t,r)),s=.5*e.fovY,o=Math.cos(s);let l=X.infinite.near;if(i<=s)l=O*o;else{const t=_(qt,e.viewUp),n=Math.tan(s),i=p(qt,t,n),a=_(qt,h(qt,r,i)),c=ye(e.eye,a,Vt),u=He(Xt,A);if(Ue(u,c,qt)){const t=h(qt,qt,e.eye);l=R(t)*o}}const u=.99*Math.min(n.near,l);if(u<X.infinite.near&&u>Jt.near){const e=c(Jt.near,u,M);Jt.near=e}}return Jt}}function Dt(e,t,n,r){const i=zt/n,a=e/t;return a>i?(r.far=e,r.near=a):(r.near=i,r.far=r.near*t),r}const Ht=7.983,Lt=16.994,Ut=2e4,Gt=100,zt=2,Bt=.001,kt=1e-4,qt=F(),Wt=F(),Jt={near:0,far:0},Xt=Le(),Vt=ge();function Yt(e,t,n){e.worldUpAtPosition(t,Kt),h(Zt,n,t);const r=R(Zt);return 0===r?0:a(T(Zt,Kt)/r)}const Kt=F(),Zt=F(),Qt=S(0,0,1),$t=_(F(),S(1,1,1)),en=new t(-180,180),tn=ee(),nn=F(),rn=F();function an(e,t,n,r=mt()){g(nn,e,Qt),0===T(nn,nn)&&g(nn,e,$t),Q(tn,-s(t),e),$(tn,tn,-s(n),nn);const{up:i,direction:a}=r;return g(i,nn,e),_(i,i),y(i,i,tn),_(a,e),I(a,a),y(a,a,tn),r}function sn(e){const t=e[1];e[1]=-e[2],e[2]=t}function on(e,t){const n=an(t,e.heading,e.tilt);return e.up=n.up,e}function cn(e,t){const n=[],r=[],i=De();for(let a=0;a<e.length;a++){const s=e[a],o=a===e.length-1?e[0]:e[a+1],c=Ie(s,o,Tn),l=Fe(t,c.origin,c.vector,Se.NONE,hn);switch(l){case be.INSIDE:n.push(s);break;case be.OUTSIDE:r.push(s);break;case be.INTERSECTS_INSIDE_OUT:case be.INTERSECTS_OUTSIDE_IN:{const[e,a,o]=l===be.INTERSECTS_INSIDE_OUT?[1,n,r]:[-1,r,n],c=Ne(t),u=E(F(),hn,c,e*i),f=E(F(),hn,c,-1e-6*e);a.push(s),a.push(u),o.push(f)}}}const a=[];return n.length&&a.push(n),r.length&&a.push(r),a}const ln={minCurvature:s(5),maxCurvature:s(50),minSamples:1,maxSamples:6},un=S(1,0,0),fn=S(0,1,0),mn=F(),pn=F(),hn=F(),dn=Le(),Tn=ve(),Rn=Ce(),Mn=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){const i=nn,a=rn;return _(i,e),g(rn,i,Qt),0===T(rn,rn)&&g(rn,i,$t),g(a,rn,i),pt(t,n,r,i,a)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i={eye:F(),up:null,tilt:r,heading:n},a=nn;a[0]=e[0],a[1]=e[2],a[2]=-e[1];const o=t,c=s(n),u=s(r),f=Math.sin(c),m=Math.cos(c),h=Math.sin(u),d=Math.cos(u),T=R(a);let M;if(Math.abs(u)<1e-8)M=o+T;else{const e=T/h,t=l(o/e),n=Math.PI-u-t;M=e*Math.sin(n)}const _=d*o,g=o*o*(h*h),y=m*m*g,E=M-_,v=E*E,I=y*(y+v-a[1]*a[1]);if(I<0)return p(i.eye,a,M/T),i.tilt=0,on(i,e);const x=Math.sqrt(I),A=a[1]*E,O=y+v;let w;if(w=m>0?-x+A:x+A,Math.abs(O)<1e-8)return T<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=o):p(i.eye,a,M/T),i.tilt=0,sn(i.eye),on(i,e);i.eye[1]=w/O;const S=f*f*g,b=h*o,N=m*b*i.eye[1],P=i.eye[1]*i.eye[1],j=1-P,C=Math.sqrt(j),D=y*P+S-2*N*C*E+j*v;return Math.abs(D)<1e-8?(p(i.eye,a,M/T),i.tilt=0,sn(i.eye),on(i,e)):(i.eye[0]=(j*(M*a[0]-_*a[0])-b*C*(a[0]*i.eye[1]*m+a[2]*f))/D,i.eye[2]=(j*(M*a[2]-_*a[2])-b*C*(a[2]*i.eye[1]*m-a[0]*f))/D,p(i.eye,i.eye,M),sn(i.eye),on(i,e))},eyeTiltToLookAtTilt:function(e,t,n){const r=s(e),i=R(t);return l(n/(i/Math.sin(r)))+r},headingTiltToDirectionUp:an,lookAtTiltToEyeTilt:function(e,t,n){const r=R(t),a=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),s=l(n/(a/Math.sin(e)));return i(e-s)},toArea:function(e,t){const{renderCoordsHelper:n}=e,r=e.state.camera.clone(),i=new ot(n);r.near=zt,i.update(r);const a=n.getAltitude(t),s=e.spatialReference,l=n.referenceEllipsoid.radius,u=r.eye,f=1+x(u,t)/(l+a),m=Math.sqrt(f*f-1),{minCurvature:p,maxCurvature:h,minSamples:d,maxSamples:T}=ln,R=function(e){const{renderCoordsHelper:t,state:{camera:n}}=e,{center:r,eye:i}=n,a=Math.abs(t.getAltitude(r)),s=Math.abs(Math.PI/2-Yt(t,r,i));return He(dn,t.referenceEllipsoid.radius+a),Ge(dn,s,n.distance,n.fovY)}(e),M=o((m-p)/(h-p),0,1),_=Math.round(c(d,T,M)),g=r.aboveGround,y=i.planes[Re.FAR],E=[],v=Ae(b,un,Oe()),I=Ae(b,fn,Oe());Pe(Rn,0,0,0,0);for(let e=0;e<4;e++){const t=e===ct.NEAR_FAR_BOTTOM_RIGHT&&!g||e===ct.NEAR_FAR_TOP_LEFT&&g?1-R:0,r=e===ct.NEAR_FAR_BOTTOM_RIGHT&&g||e===ct.NEAR_FAR_TOP_LEFT&&!g?R:1,s=i.lines[e],o=i.lines[3===e?0:e+1];for(let i=0;i<_;i++){const l=i/_,f=e===ct.NEAR_FAR_BOTTOM_RIGHT?1-(1-l)**2:e===ct.NEAR_FAR_TOP_LEFT?l**2:l,m=0===i?0:c(t,r,f),p=A(pn,s.origin,o.origin,m),h=qe(s.direction,o.direction,m,mn);n.intersectManifoldClosestSilhouette(_e(p,h),a,hn),ht(hn,u,hn,y),E.push(N(hn)),0!==E.length&&O(E.at(-1),hn);const d=(we(v,hn)?1:0)|(we(I,hn)?2:0);Rn[d]=1}}E.length>2&&O(E[0],E.at(-1));const w=function(e,t,n){const r=2*De();return e.map((e=>{const i=[];let a=!1;for(const s of e)t.fromRenderCoords(s,hn,n),Math.abs(s[0])<r&&Math.abs(s[1])<r?(i.push([null,hn[1]]),i.push([null,hn[1]]),a=!0):i.push([hn[0],hn[1]]);if(a)for(let e=0;e<i.length;e++){const t=i[e];if(null!=t[0])continue;const n=i[e+1],r=i.at(0===e?-1:e-1);t[0]=r[0],e++;const a=i.at(e===i.length-1?0:e+1);n[0]=a[0]}return i.push(i[0]),se(i)||i.reverse(),i}))}(je(Rn)>1?function(e,t){const n=[];for(const r of e)n.push(...cn(r,t));return n}(cn(E,v),I):[E],n,s);return new ae({rings:w,spatialReference:s})},toExtent:function(e,t,r,a,o){let c,l,u,f;const m=t.latitude,p=P(e.spatialReference).radius,h=t.longitude,d=Be(m,r,p)/2;c=h-d,l=h+d;const T=s(m),R=(1+Math.sin(T))/(1-Math.sin(T)),M=(R+1)*Math.tan(a/p/2),_=M*M;function g(e){const t=Math.PI/2;return(e=n.normalize(e,-t))>t&&(e=Math.PI-e),e}if(u=1.5*Math.PI-2*Math.atan(.5*(M+Math.sqrt(4*R+_))),f=u+a/p,u=g(u),f=g(f),f<u){const e=f;f=u,u=e}if(u=Math.max(i(u),-90),f=Math.min(i(f),90),l=en.monotonic(c,l),l-c>180){const e=(l-c-180)/2;c+=e,l-=e}const y=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:L.WGS84;return o?(o.xmin=c,o.ymin=u,o.xmax=l,o.ymax=f,o.spatialReference=y):o=new ie(c,u,l,f,y),e.spatialReference&&e.spatialReference.isWebMercator&&ze(o,!1,o),o}},Symbol.toStringTag,{value:"Module"})),_n=()=>r.getLogger("esri.views.3d.support.cameraUtils"),gn=96*39.37,yn={heading:0,tilt:0},En=F(),vn=new t(-20037508.342788905,20037508.342788905),In=new t(-180,180);var xn;function An(e){return e.spatialReference??L.WGS84}function On({state:e}){return e.isGlobal?Mn:It}function wn(e,t,n,r,i){return On(e).headingTiltToDirectionUp(t,n,r,i)}function Fn(e,t){if(null==t)return null;const n=e.renderSpatialReference,r=On(e).headingTiltToDirectionUp,i=F();if(!U(t.position,i,n))return null;const a=r(i,t.heading,t.tilt);p(a.direction,a.direction,e.state.camera.distance),d(a.direction,a.direction,i);const o=Ve(e,i,a.direction,a.up);return o.fov=s(t.fov),o.row=t.layout.row,o.rows=t.layout.rows,o.column=t.layout.column,o.columns=t.layout.columns,o}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(xn||(xn={}));const Sn=F();function bn(t,n,r){const a=t.renderSpatialReference,s=Bn(t,n.eye,n.viewForward,n.up,yn);let o=An(t);return k(n.eye,a,Sn,o)||(o=L.WGS84,k(n.eye,a,Sn,o)),null==r?r=new e(new C(Sn,o),s.heading,s.tilt,i(n.fov)):(r.position.x=Sn[0],r.position.y=Sn[1],r.position.z=Sn[2],r.position.spatialReference=o,r.heading=s.heading,r.tilt=s.tilt,r.fov=i(n.fov)),r.layout.row=n.row,r.layout.rows=n.rows,r.layout.column=n.column,r.layout.columns=n.columns,r}function Nn(e,t){const{camera:n}=e.state,{unitInMeters:r}=e.renderCoordsHelper;return t/=r,n.width/2/n.pixelRatio/(gn/t)/Math.tan(n.fovX/2)}function Pn(e,t){const{camera:n}=e.state,{unitInMeters:r}=e.renderCoordsHelper,i=t*Math.tan(n.fovX/2),a=n.width/2/n.pixelRatio;return gn/(a/i)*r}function jn(e,t,n,r){const i=r.levelAtScale(t),a=Dn(Bn(e,n.eye,n.viewForward,n.up).tilt),s=Math.max(i-a,0);return r.scaleAtLevel(s)}function Cn(e,t,n){const r=n.levelAtScale(e),i=Dn(t);return n.scaleAtLevel(r+i)}function Dn(e){return 2*((e>90?180-e:e)/90)**2}function Hn(e,t,n=0){const r=Fn(e,t);return r?function(e,t,n=0){const r=e.basemapTerrain?.tilingScheme;if(!r)return 0;const i=P(e.spatialReference).radius,a=e.state.viewingMode===q.Local?t.eye[2]:R(t.eye)-i;return jn(e,Pn(e,Math.abs(a-n)),t,r)}(e,r,n):0}function Ln(e,t,n,r,a){if(0===t)return 0;const o=x(n.eye,r),c=e.basemapTerrain?.tilingScheme;if(!c)return _n().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),o;let u=o;const f=Bn(e,n.eye,n.viewForward,n.up),m=f.tilt>90;if(e.state.isLocal){const r=(Nn(e,Cn(t,f.tilt,c))-Math.abs(n.eye[2]-a[2]))/Math.cos(s(f.tilt));return u=m?u-r:u+r,u}let p=1/0,h=0,d=qn(e,f.heading,f.tilt,r,o,xn.ADJUST);if(!d)return u;const T=R(a);for(;p>1&&h<100;){const a=R(d.eye),o=m?180-d.tilt:d.tilt,M=s(o),_=Math.sin(M)*a,g=Math.cos(M)*a,y=Nn(e,Cn(t,d.tilt,c)),E=m?T-y:T+y,v=l(_/E),I=Math.cos(v)*E-g,A=x(d.eye,r);u=m?A-I:A+I,d=qn(e,f.heading,f.tilt,r,u,xn.ADJUST);const O=cr(e,d,i(n.fov));if(!d||!O)return u;const w=Hn(e,O,T-P(e.spatialReference).radius);p=Math.abs(t-w),++h}return u}async function Un(e,t,n,r,i,a){return zn(e,t,Nn(e,n),r,i,a)}function Gn(e,t,n,r,i,a){return cr(e,qn(e,r.heading,r.tilt,t,n,i),r.fov,a)}async function zn(e,t,n,r,i,a){const s=await Wn(e,r.heading,r.tilt,t,n,i,a);return u(a),lr(e,s,r.fov,a)}function Bn(e,t,n,r,i){return On(e).directionToHeadingTilt(t,n,r,i)}function kn(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,En,e.spatialReference)&&e.elevationProvider&&(Y(e.elevationProvider,En)??0)>En[2]-1)}function qn(e,t,n,r,i,a){const s=r instanceof C?r:null,o=function(e,t){const n=F();if(null==t)return f(n,e.state.camera.center);if(t instanceof C){if(!U(t,n,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:i}=e;if(null==t.z&&null!=r&&null!=i){const r=Y(i,t);null!=r&&e.renderCoordsHelper.setAltitude(n,r)}return n}return f(n,t)}(e,r);return Jn(e,t,n,s,o,i,a)}async function Wn(e,t,n,r,i,a,s){const o=r instanceof C?r:null,c=await async function(e,t,n){const r=F();if(null==t)return f(r,e.state.camera.center);if(t instanceof C){const{renderSpatialReference:i,basemapTerrain:a,elevationProvider:s}=e,o=t.spatialReference;if(await G(t,r,i,0,{signal:n}),u(n),null==t.z&&null!=a&&null!=s){const i=await s.queryElevation(t.x,t.y,t.z??0,o,"ground",n);u(n),null!=i&&e.renderCoordsHelper.setAltitude(r,i)}return r}return f(r,t)}(e,r,s);return u(s),Xn(e,t,n,o,c,i,a,s)}function Jn(e,t,n,r,i,a,s){if(null==i)return null;if(!r&&(r=new C({spatialReference:An(e)}),!z(i,e.renderSpatialReference,r)))return null;const o=Vn(e,t,n,i,a,s);if(Yn(e,n,s)&&kn(e,o.eye)){const{tilt:s,mode:o}=Kn(e,n,i,a);return Jn(e,t,s,r,i,a,o)}return Zn(o,i)}async function Xn(e,t,n,r,i,a,s,o){r||(r=new C({spatialReference:An(e)}),await B(i,e.renderSpatialReference,r,{signal:o})||(r=null)),u(o);const c=Vn(e,t,n,i,a,s);if(Yn(e,n,s)&&await async function(e,t,n){if(kn(e,t))return!0;const{elevationProvider:r,spatialReference:i,renderCoordsHelper:a}=e;if(null==r||!a.fromRenderCoords(t,En,i))return!1;const[s,o,c]=En,l=await r.queryElevation(s,o,c,i,"ground",n)??0;return u(n),l>c-1}(e,c.eye,o)){u(o);const{tilt:s,mode:c}=Kn(e,n,i,a);return Xn(e,t,s,r,i,a,c,o)}return Zn(c,i)}function Vn(e,t,n,r,i,a){const s=function(e,t,n,r,i,a){let s=0;return a===xn.ADJUST&&ir(e,r,i)?(t=0,s=function(e,t,n,r){const i=or(e,r,t,n);if(!e.state.constraints.tilt)return i;const a=e.state.constraints.tilt(t);a.max=Math.min(a.max,.5*Math.PI);const s=a.min*(1-ar)+a.max*ar;return Math.min(i,s)}(e,i,n,r)):s=or(e,r,i,n),s=e.state.constraints.clampTilt(i,s),{heading:t,tilt:n=sr(e,r,i,s)}}(e,t,n,r,i=Math.max(i,e.state.constraints.minimumPoiDistance),a);return(0,On(e).eyeForCenterWithHeadingTilt)(r,i,s.heading,s.tilt)}function Yn(e,t,n){const r=e.map.ground.navigationConstraint;return n===xn.ADJUST&&e.state.isGlobal&&t>0&&(null==r||"stay-above"===r.type)}function Kn(e,t,n,r){const i=sr(e,n,r,function(e,t,n,r){let i=or(e,r,t,n);if(!e.state.constraints.tilt)return i;const a=e.state.constraints.tilt(t);return i=Math.min(i,.5*Math.PI),a.min*(1-ar)+i*ar}(e,r,t,n));return{tilt:i,mode:t-i<1?xn.LOCKED:xn.ADJUST}}function Zn(e,t){return{...e,center:N(t)}}function Qn(e,t){const{state:n,spatialReference:r}=e,i=t.spatialReference;return n.isGlobal&&We(i,q.Global)||n.isLocal&&r.equals(i)}function $n(e,t){let n,r,i;if(e.state.isGlobal){const e=new C(t.xmin,t.ymin,t.spatialReference),a=new C(t.xmax,t.ymax,t.spatialReference),s=t.spatialReference.isGeographic?In:vn;n=new C({x:s.center(e.x,a.x),y:(a.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const o=P(t.spatialReference),c=ke(n,e,a);r=c.lon,i=c.lat,s.diff(e.x,a.x)>s.range/2&&(r+=o.halfCircumference),r=Math.min(r,o.halfCircumference),i=Math.min(i,o.halfCircumference)}else{const a=e.renderSpatialReference??t.spatialReference;a.equals(t.spatialReference)||(t=D(t,a)),r=t.xmax-t.xmin,i=t.ymax-t.ymin;const s=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;n=new C({x:t.xmin+.5*r,y:t.ymin+.5*i,z:s,spatialReference:a})}const a=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,s=e.state.camera,o=1/Math.tan(s.fovX/2),c=1/Math.tan(s.fovY/2),l=1/Math.tan(s.fov/2);return{center:n,distance:Math.max(.5*r*o,.5*i*c,.5*a*l)/1}}async function er(e,t,n,r,i,a){const s=Qn(e,t)?t:await H(t,e.spatialReference,{signal:a});u(a);const{center:o,distance:c}=$n(e,s),l=await Wn(e,n,r,o,c,i,a);return u(a),lr(e,l,e.camera.fov,a)}function tr(e,t,n,r,i,a){let s;try{s=Qn(e,t)?t:D(t,e.spatialReference)}catch(e){return null}const{center:o,distance:c}=$n(e,s),l=qn(e,n,r,o,c,i);return null==l?null:cr(e,l,e.camera.fov,a)}function nr(e,t,n){const r=e.renderSpatialReference,i=new C({spatialReference:An(e)});if(!z(n,r,i))return null;const a=Math.tan(t.fovX/2),s=Math.tan(t.fovY/2),o=w(t.eye,n),c=2*o*a*1,l=2*o*s*1;return On(e).toExtent(e,i,c,l)}function rr(e,t){return On(e).toArea(e,t)}function ir(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>8)return!0;const i=t,a=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return x(i,a)/(Math.tan(.5*e.state.camera.fov)*r)>5}const ar=.7;function sr(e,t,n,r){return On(e).lookAtTiltToEyeTilt(r,t,n)}function or(e,t,n,r){return On(e).eyeTiltToLookAtTilt(r,t,n)}function cr(t,n,r,i){if(null==n)return null;const a=t.renderSpatialReference,s=new C({spatialReference:An(t)});return z(n.eye,a,s)?(i??=new e,i.position=s,i.heading=n.heading,i.tilt=n.tilt,i.fov=r,i):null}async function lr(t,n,r,i){const a=t.renderSpatialReference,s=new C({spatialReference:An(t)});return await B(n.eye,a,s,{signal:i}),u(i),new e(s,n.heading,n.tilt,r)}function ur(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);_n().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function fr(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);_n().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}export{Nt as A,bt as B,wt as C,xt as D,At as E,ot as F,zt as G,xn as O,Gn as a,zn as b,Ve as c,Pn as d,Fn as e,tr as f,An as g,Un as h,bn as i,er as j,Bn as k,wn as l,mt as m,Xe as n,Je as o,Pt as p,rr as q,jn as r,Nn as s,nr as t,ur as u,Yt as v,qn as w,Ln as x,Ft as y,fr as z};
