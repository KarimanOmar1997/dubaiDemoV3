/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{watch as t,syncAndInitial as e}from"../core/reactiveUtils.js";import{i as s}from"./SetUtils.js";import{sqlAnd as n}from"../core/sql.js";import{a as r}from"./timeUtils.js";import{w as i,a as o,f as a,d as c,D as u,b as f,s as h,k as l,c as d,x as p,e as m,A as g,v as L,n as _}from"./vec3.js";import{m as y}from"./dehydratedPoint.js";import E from"../rest/support/Query.js";import{V as P}from"./InputManager.js";import{b as k}from"./keybindings.js";import{d as A,e as M,a as N,g as w,b as x,f as v,c as j}from"./normalizedPoint.js";import{i as T}from"./utils8.js";import{i as R,e as q}from"../core/lang.js";import{f as z,h as b}from"./mathUtils.js";import{e as I,d as D,h as S,o as O,m as H,l as F,s as Z,i as C,p as U,q as Y}from"./vec2.js";import{c as G,f as V,Z as J}from"./vec2f64.js";import{c as X,b as K,f as Q,e as B}from"./vec3f64.js";import{s as W,d as $}from"./vec4.js";import{c as tt}from"./vec4f64.js";import{t as et}from"./geodesicConstants.js";import{directGeodeticSolver as st,inverseGeodeticSolver as nt,InverseGeodeticSolverResult as rt}from"../geometry/support/geodesicUtils.js";import{f as it,c as ot,u as at,t as ct,j as ut,o as ft,p as ht,g as lt,l as dt}from"./plane.js";import{e as pt,h as mt,j as gt,p as Lt,g as _t}from"./sphere.js";import{t as yt}from"./mathUtils2.js";import{g as Et}from"./common.js";import{L as Pt,i as kt}from"./geometry2dUtils.js";const At=Symbol("grid-placement-graphic");function Mt(t,e){const s=t.x-e.x,n=t.y-e.y;return s*s+n*n}function Nt(t,e){return Math.sqrt(Mt(t,e))}function wt(t,e){e.sort(((e,s)=>i(e.targetPoint,t)-i(s.targetPoint,t)))}var xt;function vt({parameters:{point:t,distance:e,returnEdge:i,vertexMode:o,coordinateHelper:{spatialReference:a},filter:c},mode:u,returnZ:f,filter:h}){const l=h?.clone()??new E({where:"1=1"});return l.returnZ=f??"3d"===u,c&&(l.geometry=c.geometry,l.distance=c.distance,l.spatialRelationship=c.spatialRelationship,l.where=n(l.where,c.where),l.timeExtent=r(l.timeExtent,c.timeExtent),l.objectIds=(d=l.objectIds,p=c.objectIds,d||p?p?d?Array.from(s(new Set(d),new Set(p))):p:d:null)),{point:y(t[0],t[1],t[2],a.toJSON()),mode:u,distance:e,returnEdge:i,vertexMode:o,query:l.toJSON()};var d,p}function jt(t,e,s){return{left:A(t.leftVertex.pos,e,s),right:A(t.rightVertex.pos,e,s)}}!function(t){t[t.TARGET=0]="TARGET",t[t.REFERENCE=1]="REFERENCE",t[t.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"}(xt||(xt={}));const Tt=Symbol("snapping-toggle");function Rt(s,n=()=>{}){const r=t((()=>({view:s.view,snappingOptions:s.snappingOptions})),(({view:t,snappingOptions:e})=>{if(s.removeHandles(Tt),!t||!e)return;const r=P.TOOL,i=[t.on("key-down",(t=>{t.key!==k.toggle||t.repeat||(e.enabledToggled=!0,n())}),r),t.on("key-up",(t=>{t.key===k.toggle&&(e.enabledToggled=!1,n())}),r),t.on("pointer-move",(t=>{const s=t.native.ctrlKey;e.enabledToggled!==s&&(e.enabledToggled=s,n())}),r)];s.addHandles(i,Tt)}),e);s.addHandles(r)}function qt(t){return T(t)&&"utilityNetworks"in t&&!!t.utilityNetworks?.length}function zt({start:t,end:e,type:s},n,r){const i=[],o=I(Kt,e,t),a=I(Qt,t,n),c=O(o),u=2*S(o,a),f=u*u-4*c*(O(a)-r*r);if(0===f){const e=-u/(2*c);(s===Jt.PLANE||e>=0)&&i.push(H(G(),t,o,e))}else if(f>0){const e=Math.sqrt(f),n=(-u+e)/(2*c);(s===Jt.PLANE||n>=0)&&i.push(H(G(),t,o,n));const r=(-u-e)/(2*c);(s===Jt.PLANE||r>=0)&&i.push(H(G(),t,o,r))}return i}function bt(t,e){const s=t.start,n=t.end,r=I(Kt,n,s),i=h(Wt,-r[1],r[0],0),a=e.start,u=e.end,l=o($t,u,a),d=c(l,i),p=h(te,s[0],s[1],0),m=o(ee,p,a),g=c(m,i),L=Et();if(Math.abs(d)<L)return Math.abs(g),[];const _=f(se,a,l,g/d);if(e.type===Pt.RAY){const t=o(ne,_,a);if(c(t,l)<-1e-6)return[]}if(t.type===Jt.HALF_PLANE){const t=D(Qt,_,s);if(S(t,r)<-1e-6)return[]}return[K(_)]}function It(t,e){return Zt(Ut(ie,0,t),Ut(oe,0,e)).map((([t,e])=>V(t,e)))}function Dt(t,e,s){return Ot(t,Ut(ie,t[2],e),s)}function St(t,e,s,n=X()){const r=I(Kt,t,e),i=C(r);return H(n,e,r,0===i?1:s/i),n[2]=t[2],n}function Ot(t,{start:e,end:s,type:n},r=X()){const i=o(Bt,t,e),a=o(Wt,s,e),u=c(i,a)/c(a,a);return f(r,e,a,n===Pt.RAY?Math.max(u,0):u)}const Ht=(()=>{const t=X(),e=X(),s=X();return({start:n,end:r},{center:i,radius:o,normal:a,slicePlane:u})=>{const h=it(i,a,re);if(Gt(at(h,n),0)&&Gt(at(h,r),0)){yt(a,t,e);const h=(n,r)=>(l(s,r,i),Z(n,c(s,t),c(s,e)),n),p=kt({start:h(Kt,n),end:h(Qt,r),type:Pt.LINE},J,o),m=[];for(const[s,n]of p){const r=d(X(),i);f(r,r,t,s),f(r,r,e,n),u&&!Vt(u,r)||m.push(r)}return m}const m=X();return ct(h,n,r,m)?!Gt(p(m,i),o)||u&&!Vt(u,m)?[]:[m]:[]}})();function Ft({start:t,end:e,type:s},n,r){const i=[],o=l(Bt,e,t),a=I(Qt,t,n),c=O(o),u=2*S(o,a),h=u*u-4*c*(O(a)-r*r);if(0===h){const e=-u/(2*c);(s===Pt.LINE||e>=0)&&i.push(f(X(),t,o,e))}else if(h>0){const e=Math.sqrt(h),n=(-u+e)/(2*c);(s===Pt.LINE||n>=0)&&i.push(f(X(),t,o,n));const r=(-u-e)/(2*c);(s===Pt.LINE||r>=0)&&i.push(f(X(),t,o,r))}return i}function Zt(t,e){const s=t.start,n=t.end,r=e.start,i=e.end,h=o(Bt,n,s),l=o(Wt,i,r),d=o($t,r,s),p=a(te,h,l);if(!Gt(c(d,p),0))return[];const m=u(p);if(Gt(m,0))return[];const g=a(ee,d,l),L=c(g,p)/m,_=f(se,s,h,L);if(t.type===Pt.RAY){const t=o(ne,_,s);if(c(h,t)<-1e-6)return[]}if(e.type===Pt.RAY){const t=o(ne,_,r);if(c(l,t)<-1e-6)return[]}return[K(_)]}function Ct(t,e,s,n){const[r,i]=t,[o,a]=s,c=o-r,u=a-i,f=c*c+u*u,h=Math.sqrt(f);if(h>e+n)return[];if(h<Math.abs(e-n))return[];if(Gt(h,0)&&Gt(e,n))return[];const l=(e*e-n*n+f)/(2*h),d=Math.sqrt(e*e-l*l),p=d*u/h,m=d*c/h,[g,L]=F(Kt,t,s,l/h);return Gt(p,m)?[V(g,L)]:[V(g+p,L-m),V(g-p,L+m)]}function Ut(t,e,{start:s,end:n,type:r}){return h(t.start,s[0],s[1],e),h(t.end,n[0],n[1],e),t.type=Xt[r],t}function Yt(t,e){return Gt(t[2],e[2])}function Gt(t,e){return z(Math.abs(t-e),0,Et())}function Vt(t,e){return ut(t,e)}var Jt;!function(t){t[t.PLANE=0]="PLANE",t[t.HALF_PLANE=1]="HALF_PLANE"}(Jt||(Jt={}));const Xt={[Jt.PLANE]:Pt.LINE,[Jt.HALF_PLANE]:Pt.RAY},Kt=G(),Qt=G(),Bt=X(),Wt=X(),$t=X(),te=X(),ee=X(),se=X(),ne=X(),re=ot(),ie={start:X(),end:X(),type:Pt.LINE},oe={start:X(),end:X(),type:Pt.LINE};class ae{intersect(t){return be(this,t)}closestPoints(t){return[this.closestTo(t)]}}class ce extends ae{constructor(t){super(),this.point=t}equals(t){return this===t||Je(t)&&m(this.point,t.point)}closestTo(){return M(this.point)}}class ue extends ae{constructor(t,e,s){super(),this.start=t,this.end=e,this.lineLike={start:t,end:e,type:s}}equals(t){return this===t||Xe(t)&&this.lineLike.type===t.lineLike.type&&m(this.start,t.start)&&m(this.end,t.end)}closestTo(t){const e=x();return Ot(t,this.lineLike,e),e}}class fe extends ue{constructor(t,e){super(t,e,Pt.LINE)}}class he extends ue{constructor(t,e){super(t,e,Pt.RAY)}}class le extends ae{constructor(t){super(),this.constraints=t}equals(t){return this===t||Ve(t)&&q(this.constraints,t.constraints,((t,e)=>t.equals(e)))}closestTo(t){let e,s=1/0;for(const n of this.constraints){const r=n.closestTo(t),o=i(t,r);o<s&&(s=o,e=r)}return M(e??t)}closestPoints(t){return this.constraints.flatMap((e=>e===this?[]:e.closestPoints(t)))}}class de extends ae{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||Be(t)&&this.center[0]===t.center[0]&&this.center[1]===t.center[1]&&this.radius===t.radius}closestTo(t){const e=x();return St(t,this.center,this.radius,e),e}}class pe extends ae{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||We(t)&&m(this.center,t.center)&&this.radius===t.radius}closestTo(t){const e=x();return St(t,this.center,this.radius,e),e[2]=this.center[2],e}asCircle(){return new me(M(this.center),this.radius,v(0,0,1))}}class me extends ae{constructor(t,e,s,n=void 0){super(),this.center=t,this.radius=e,this.normal=s,this.slicePlane=n}equals(t){return this===t||$e(t)&&m(this.center,t.center)&&m(this.normal,t.normal)&&this.radius===t.radius}closestTo(t){const{center:e,radius:s}=this;ht(this.getPlane(Le),t,ge);const n=o(ge,ge,e),r=L(n);if(Gt(r,0))return M(t);const i=s/Math.sqrt(r),a=x();f(a,e,n,i);const{slicePlane:c}=this;if(c&&!Vt(c,a)){const e=De(c,this);return e?.closestTo(t)??M(t)}return a}getPlane(t=ot()){return it(this.center,this.normal,t)}}const ge=X(),Le=ot();class _e extends ae{constructor(t){super(),this.z=t}equals(t){return this===t||Ke(t)&&this.z===t.z}closestTo(t){return v(t[0],t[1],this.z)}getPlane(t=ot()){return h(ye,0,0,this.z),it(ye,B,t)}}const ye=X();class Ee extends ae{constructor(t,e,s){super(),this.start=t,this.end=e,this.planeLike={start:N(t),end:N(e),type:s}}equals(t){return this===t||Qe(t)&&this.planeLike.type===t.planeLike.type&&m(this.start,t.start)&&m(this.end,t.end)}closestTo(t){const e=x();return Dt(t,this.planeLike,e),e}closestEndTo(t){const{start:e,end:s}=this.planeLike;return Math.sign(S(I(Pe,s,e),I(ke,N(t),e)))>0?this.end:this.start}getPlane(t=ot()){const e=d(Ae,this.end);return e[2]+=1,dt(this.start,this.end,e,t)}getSlicePlane(t=ot()){const{start:e,end:s,type:n}=this.planeLike;if(n===Jt.PLANE)return;const r=h(Ae,e[0],e[1],0),i=h(Me,s[0],s[1],0),o=l(Me,i,r);return it(r,o,t),t}}const Pe=G(),ke=G(),Ae=X(),Me=X();class Ne extends Ee{constructor(t,e){super(t,e,Jt.HALF_PLANE)}}class we extends Ee{constructor(t,e){super(t,e,Jt.PLANE)}}class xe extends ae{constructor(t,e){super(),this.sphere=mt(t,e)}equals(t){return this===t||ts(t)&&gt(this.sphere,t.sphere)}closestTo(t){const e=x();return Lt(this.sphere,t,e),e}get center(){return _t(this.sphere)}get radius(){return this.sphere[3]}}class ve extends ae{constructor(t,e,s){super(),this.start=t,this.end=e,this.getZ=s,this.planeLike={start:N(t),end:N(e),type:Jt.PLANE}}equals(t){return this===t||es(t)&&m(this.start,t.start)&&m(this.end,t.end)&&this.getZ===t.getZ}closestTo(t){return function(t,e){const s=x();return Dt(e,t.planeLike,s),s[2]=t.getZ(s[0],s[1])??ss,s}(this,t)}addIfOnTheGround(t,e){for(const s of e){const e=this.getZ(s[0],s[1])??0;Gt(s[2],e)&&(s[2]=e,t.push(s))}}}class je extends ae{constructor(t,e,s){super(),this._x=t,this._y=e,this._z=s}equals(t){return this===t||t instanceof je&&this._x===t._x&&this._y===t._y&&this._z===t._z}closestTo([t,e,s]){return j(this._x??t,this._y??e,this._z??s)}}class Te extends ae{constructor(t,e,s,n,r){super(),this._origin=t,this._spatialReference=e,this._distanceMeters=s,this._z=n,this._directionDegrees=r}equals(t){return this===t||t instanceof Te&&Y(this._origin,t._origin)&&this._spatialReference===t._spatialReference&&this._distanceMeters===t._distanceMeters&&this._z===t._z&&this._directionDegrees===t._directionDegrees}closestTo([t,e,s]){return Z(Re,t,e),Y(Re,this._origin)||this._applyDirectionAndDistance(Re),j(Re[0],Re[1],this._z??s)}_applyDirectionAndDistance(t){if(null!=this._directionDegrees&&null!=this._distanceMeters)st(t,this._origin,this._directionDegrees,this._distanceMeters,this._spatialReference);else if(null!=this._directionDegrees)!function(t,e,s,n,r){let{azimuth:i,distance:o}=nt(ze,e,n,r);i??=0;let a=o*Math.cos((i-s)*et);a=Math.max(0,a),st(t,e,s,a,r)}(t,this._origin,this._directionDegrees,t,this._spatialReference);else if(null!=this._distanceMeters){const{azimuth:e}=nt(qe,this._origin,t,this._spatialReference);st(t,this._origin,e??0,this._distanceMeters,this._spatialReference)}}}const Re=[0,0],qe=new rt,ze=new rt;function be(t,e){if(Ve(t)){const s=[];for(const n of t.constraints){const t=n.intersect(e);t&&s.push(t)}return Ge(s)}if(Ve(e))return be(e,t);if(es(t))return Ze(t,e);if(es(e))return Ze(e,t);if(Je(t)){const{point:s}=t;if(Je(e))return m(s,e.point)?t:void 0;const n=e.closestTo(s);return g(n,s)?t:void 0}if(Xe(t)){if(Je(e))return be(e,t);if(Xe(e))return Ue(Zt(t.lineLike,e.lineLike));if(Ke(e))return Ie(t,e);if(Qe(e))return Ue(bt(e.planeLike,t.lineLike));if(Be(e))return Ue(Ft(t.lineLike,e.center,e.radius));if($e(e))return Ue(Ht(t.lineLike,e));if(We(e))return function({lineLike:t},{center:e,radius:s}){const n=e[2];return Ue(Ft(t,e,s).filter((t=>Gt(t[2],n))))}(t,e);if(ts(e))return function({lineLike:t},{sphere:e}){return Ue(pt(e,t.start,t.end))}(t,e)}else if(Ke(t)){if(Je(e)||Xe(e))return be(e,t);if(Ke(e))return function(t,e){return Gt(t.z,e.z)?t:void 0}(t,e);if(Qe(e))return function({z:t},{planeLike:e}){const[s,n]=e.start,[r,i]=e.end,o=v(s,n,t),a=v(r,i,t);return e.type===Jt.PLANE?new fe(o,a):new he(o,a)}(t,e);if(Be(e))return function(t,e){const[s,n]=e.center;return new pe(v(s,n,t.z),e.radius)}(t,e);if($e(e))return Se(t,e);if(We(e))return s=t,Gt((n=e).center[2],s.z)?n:void 0;if(ts(e))return function(t,{center:e,radius:s}){const n=Math.abs(e[2]-t.z);if(n>s&&!Gt(n,s))return;const r=v(e[0],e[1],t.z),i=Math.sqrt(s**2-n**2);return Gt(i,0)?void 0:new pe(r,i)}(t,e)}else if(Qe(t)){if(Je(e)||Xe(e)||Ke(e))return be(e,t);if(Qe(e))return Ce(It(t.planeLike,e.planeLike));if(Be(e))return Ce(zt(t.planeLike,e.center,e.radius));if($e(e))return He(t,e);if(We(e))return Oe(t,e);if(ts(e))return Fe(t,e)}else if(Be(t)){if(Je(e)||Xe(e)||Ke(e)||Qe(e))return be(e,t);if(Be(e))return Ce(Ct(N(t.center),t.radius,N(e.center),e.radius));if($e(e))return;if(We(e))return function(t,e){return Gt(U(N(t.center),N(e.center)),0)&&Gt(t.radius,e.radius)?e:Ye(Ct(N(t.center),t.radius,N(e.center),e.radius),e.center[2])}(t,e);if(ts(e))return}else if($e(t)){if(Je(e)||Xe(e)||Ke(e)||Qe(e)||Be(e))return be(e,t);if($e(e))return;if(We(e))return void e.asCircle();if(ts(e))return}else if(We(t)){if(Je(e)||Xe(e)||Ke(e)||Qe(e)||Be(e)||$e(e))return be(e,t);if(We(e))return function(t,e){if(Yt(t.center,e.center))return Gt(U(N(t.center),N(e.center)),0)&&Gt(t.radius,e.radius)?t:Ye(Ct(N(t.center),t.radius,N(e.center),e.radius),t.center[2])}(e,t);if(ts(e))return}else if(ts(t)){if(Je(e)||Xe(e)||Ke(e)||Qe(e)||Be(e)||We(e))return be(e,t);if(ts(e))return}var s,n}const Ie=(()=>{const t=ot();return(e,s)=>{const{start:n,end:r}=e;if(Yt(n,r)&&Gt(n[2],s.z))return e;const i=x();return ct(s.getPlane(t),n,r,i)?new ce(i):void 0}})(),De=(()=>{const t=tt(),e=X(),s=X();return(n,r,i)=>{const{normal:o,center:u,radius:h}=r;yt(o,e,s);const l=lt(n),d=h*c(l,e),p=h*c(l,s);W(t,u[0],u[1],u[2],1);const m=$(n,t),g=Math.hypot(d,p),L=Gt(g,0);if(Gt(at(n,u),0)){if(L)return r;if(Gt(h,0))return!i||Vt(i,u)?new ce(M(u)):void 0;a(e,l,o),_(e,e);const t=new Array,s=K(u);f(s,s,e,h),i&&!Vt(i,s)||t.push(s);const n=K(u);return f(n,n,e,-h),i&&!Vt(i,n)||t.push(n),Ue(t)}if(L)return;const y=-m/g;if(Math.abs(y)>1||Gt(y,1))return;const E=Math.atan(d/p),P=b(y)-E,k=Math.PI-P,A=new Array,N=X();f(N,u,e,h*Math.cos(P)),f(N,N,s,h*Math.sin(P)),A.push(N);const w=X();return f(w,u,e,h*Math.cos(k)),f(w,w,s,h*Math.sin(k)),A.push(w),Ue(i?function(t,e){return e.filter((e=>Vt(t,e)))}(i,A):A)}})(),Se=(()=>{const t=ot();return(e,s)=>De(e.getPlane(t),s,s.slicePlane)})(),Oe=(()=>{const t=ot();return(e,{center:s,radius:n})=>{const r=zt(e.planeLike,s,n),i=s[2];e.getSlicePlane(t);const o=new Array;for(const[e,s]of r){const n=[e,s,i];Vt(t,n)&&o.push(n)}return Ue(o)}})(),He=(()=>{const t=ot(),e=ot();return(s,n)=>De(s.getPlane(t),n,s.getSlicePlane(e))})(),Fe=(()=>{const t=ot();return(e,{center:s,radius:n})=>{const r=e.getPlane(t),i=ft(r,s),o=Math.abs(i);if(o>n&&!Gt(o,n))return;const a=Math.sqrt(n**2-i**2);if(Gt(a,0)){const t=x();return ht(r,s,t),new ce(t)}const c=x(),u=K(lt(r));return f(c,s,u,i),new me(c,a,u,e.getSlicePlane())}})();function Ze(t,e){const{planeLike:s,getZ:n}=t,r=new Array;if(Je(e))t.addIfOnTheGround(r,(i=s,f=e.point,function({start:t,end:e,type:s},n){const r=o(Bt,n,t),i=o(Wt,e,t),f=a($t,i,r);if(u(f)/u(i)<Et())switch(s){case Pt.LINE:return[K(n)];case Pt.RAY:return c(i,r)<-1e-6?[]:[K(n)]}return[]}(Ut(ie,f[2],i),f)));else if(Xe(e))t.addIfOnTheGround(r,bt(s,e.lineLike));else if(Be(e))for(const[t,i]of zt(s,e.center,e.radius)){const e=n(t,i);null!=e&&r.push(Q(t,i,e))}else if(Qe(e)||es(e))for(const[t,i]of It(s,e.planeLike)){const e=n(t,i)??ss;r.push(Q(t,i,e))}var i,f;return Ue(r)}function Ce(t){return Ge(t.map((([t,e])=>{const s=v(t,e,0),n=v(t,e,1);return new fe(s,n)})))}function Ue(t){return Ge(t.map((t=>t?new ce(w(t)):void 0)))}function Ye(t,e){return Ue(t.map((([t,s])=>[t,s,e])))}function Ge(t){if(0!==t.length)return 1===t.length?t[0]??void 0:new le(t.filter(R))}function Ve(t){return t instanceof le}function Je(t){return t instanceof ce}function Xe(t){return t instanceof ue}function Ke(t){return t instanceof _e}function Qe(t){return t instanceof Ee}function Be(t){return t instanceof de}function We(t){return t instanceof pe}function $e(t){return t instanceof me}function ts(t){return t instanceof xe}function es(t){return t instanceof ve}const ss=0;export{je as C,ve as D,Te as G,_e as H,xt as L,ce as P,Ne as V,Rt as a,Nt as b,de as c,Ge as d,Je as e,Mt as f,At as g,jt as h,qt as i,fe as j,we as k,vt as m,Ot as p,wt as s};
