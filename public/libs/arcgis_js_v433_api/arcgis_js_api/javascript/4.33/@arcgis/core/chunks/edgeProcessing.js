/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{d as t}from"./deduplicate.js";import{n as e}from"./InterleavedLayout.js";import{V as o}from"./VertexAttribute.js";import{RegularEdgeInstancesLayout as s,SilhouetteEdgeInstancesLayout as n,EdgeInputBufferLayout as a}from"./bufferLayouts.js";import{R as r}from"../core/lang.js";import{x as i,s as c,c as l,d as f,k as u,f as p,n as d,y as h,i as g}from"./vec3.js";import{c as m}from"./vec3f64.js";import{g as w}from"./glUtil.js";import{a as y}from"./Normals.js";import{g as v,e as I}from"./mathUtils.js";import{P as N}from"./PooledArray.js";function A(t,e,o){const s=t.vertices.position,n=t.vertices.componentIndex,a=j.position0,r=j.position1,g=j.faceNormal0,m=j.faceNormal1,{edges:w,normals:y}=function(t){const e=t.faces.length/3,o=t.faces,s=t.neighbors,n=t.vertices.position;L.length=b.length=0;for(let t=0;t<e;t++){const e=3*t,a=s[e],r=s[e+1],i=s[e+2],c=o[e],l=o[e+1],f=o[e+2];n.getVec(c,_),n.getVec(l,M),n.getVec(f,P),u(M,M,_),u(P,P,_),p(_,M,P),d(_,_),b.pushArray(_),(-1===a||c<l)&&(L.push(c),L.push(l),L.push(t),L.push(a)),(-1===r||l<f)&&(L.push(l),L.push(f),L.push(t),L.push(r)),(-1===i||f<c)&&(L.push(f),L.push(c),L.push(t),L.push(i))}return{edges:L,normals:b}}(t),I=w.length/4,N=e.allocate(I);let A=0;const S=I,U=o?.allocate(S);let F=0,T=0,W=0;x.length=0;for(let t=0;t<I;++t){const e=4*t;s.getVec(w.data[e],a),s.getVec(w.data[e+1],r);const o=x.pushNew();o.index=4*t,o.length=i(a,r)}x.sort(((t,e)=>e.length-t.length));const D=new Array,R=new Array;x.forAll((({length:t,index:i})=>{const u=w.data[i],d=w.data[i+1],I=w.data[i+2],S=w.data[i+3],x=-1===S;if(s.getVec(u,a),s.getVec(d,r),x){const t=3*I;c(g,y.data[t],y.data[t+1],y.data[t+2]),l(m,g),j.componentIndex=n.get(u),j.cosAngle=f(g,m)}else{let t=3*I;if(c(g,y.data[t],y.data[t+1],y.data[t+2]),t=3*S,c(m,y.data[t],y.data[t+1],y.data[t+2]),j.componentIndex=n.get(u),j.cosAngle=f(g,m),L=E,j.cosAngle>L)return;j.cosAngle<-.9999&&l(m,g)}var L,b;T+=t,W++,x||(b=C,j.cosAngle<b)?(e.write(N,A++,j),D.push(t)):function(t,e){const o=v(t.cosAngle);return h(V,t.position1,t.position0),o*(f(p(O,t.faceNormal0,t.faceNormal1),V)>0?-1:1)>e}(j,B)&&(U&&o&&o.write(U,F++,j),R.push(t))}));const k=new Float32Array(D.reverse()),H=new Float32Array(R.reverse()),q=U&&o?{instancesData:U.slice(0,F),lodInfo:{lengths:H}}:void 0;return{regular:{instancesData:N.slice(0,A),lodInfo:{lengths:k}},silhouette:q,averageEdgeLength:T/W}}class S{constructor(){this.index=0,this.length=0}}const x=new N({allocator:t=>t||new S,deallocator:null}),L=new N({deallocator:null}),b=new N({deallocator:null}),j=new class{constructor(){this.position0=m(),this.position1=m(),this.faceNormal0=m(),this.faceNormal1=m(),this.componentIndex=0,this.cosAngle=0}},O=m(),V=m(),_=m(),M=m(),P=m(),B=I(4),E=Math.cos(B),U=I(35),C=Math.cos(U);function F(t,e,o){const s=e/3,n=new Uint32Array(o+1),a=new Uint32Array(o+1),r=(t,e)=>{t<e?n[t+1]++:a[e+1]++};for(let e=0;e<s;e++){const o=t[3*e],s=t[3*e+1],n=t[3*e+2];r(o,s),r(s,n),r(n,o)}let i=0,c=0;for(let t=0;t<o;t++){const e=n[t+1],o=a[t+1];n[t+1]=i,a[t+1]=c,i+=e,c+=o}const l=new Uint32Array(6*s),f=n[o],u=(t,e,o)=>{if(t<e){const s=n[t+1]++;l[2*s]=e,l[2*s+1]=o}else{const s=a[e+1]++;l[2*f+2*s]=t,l[2*f+2*s+1]=o}};for(let e=0;e<s;e++){const o=t[3*e],s=t[3*e+1],n=t[3*e+2];u(o,s,e),u(s,n,e),u(n,o,e)}const p=(t,e)=>{const o=2*t,s=e-t;for(let t=1;t<s;t++){const e=l[o+2*t],s=l[o+2*t+1];let n=t-1;for(;n>=0&&l[o+2*n]>e;n--)l[o+2*n+2]=l[o+2*n],l[o+2*n+3]=l[o+2*n+1];l[o+2*n+2]=e,l[o+2*n+3]=s}};for(let t=0;t<o;t++)p(n[t],n[t+1]),p(f+a[t],f+a[t+1]);const d=new Int32Array(3*s),h=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,g=(t,e)=>{const o=h(t,e);d[3*e+o]=-1},m=(t,e,o,s)=>{const n=h(t,e);d[3*e+n]=s;const a=h(o,s);d[3*s+a]=e};for(let t=0;t<o;t++){let e=n[t];const o=n[t+1];let s=a[t];const r=a[t+1];for(;e<o&&s<r;){const o=l[2*e],n=l[2*f+2*s];o===n?(m(t,l[2*e+1],n,l[2*f+2*s+1]),e++,s++):o<n?(g(t,l[2*e+1]),e++):(g(n,l[2*f+2*s+1]),s++)}for(;e<o;)g(t,l[2*e+1]),e++;for(;s<r;)g(l[2*f+2*s],l[2*f+2*s+1]),s++}return d}class T{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?H:k}write(t,e,o){K.seed=this._edgeHashFunction(o);const s=K.getIntRange(0,255),n=K.getIntRange(0,this.settings.variants-1),a=K.getFloat();var r;const i=255*(.5*(r=-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7),Math.abs(r)**1.2*Math.sign(r))+.5);t.position0.setVec(e,o.position0),t.position1.setVec(e,o.position1),t.componentIndex.set(e,o.componentIndex),t.variantOffset.set(e,s),t.variantStroke.set(e,n),t.variantExtension.set(e,i)}}const W=new Float32Array(6),D=new Uint32Array(W.buffer),R=new Uint32Array(1);function k(t){return W[0]=t.position0[0],W[1]=t.position0[1],W[2]=t.position0[2],W[3]=t.position1[0],W[4]=t.position1[1],W[5]=t.position1[2],R[0]=31*(31*(31*(31*(31*(166811+D[0])+D[1])+D[2])+D[3])+D[4])+D[5],R[0]}function H(t){const e=W;e[0]=z(t.position0[0]),e[1]=z(t.position0[1]),e[2]=z(t.position0[2]),e[3]=z(t.position1[0]),e[4]=z(t.position1[1]),e[5]=z(t.position1[2]),R[0]=5381;for(let t=0;t<D.length;t++)R[0]=31*R[0]+D[t];return R[0]}const q=1e4;function z(t){return Math.round(t*q)/q}class X{constructor(){this._commonWriter=new T}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return s.createBuffer(t)}write(t,e,o){this._commonWriter.write(t,e,o),g(J,o.faceNormal0,o.faceNormal1),d(J,J);const{typedBuffer:s,typedBufferStride:n}=t.normalCompressed;y(s,e,J[0],J[1],J[2],n)}static{this.Layout=s}static{this.glLayout=w(s,1)}}class G{constructor(){this._commonWriter=new T}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return n.createBuffer(t)}write(t,e,o){this._commonWriter.write(t,e,o);{const{typedBuffer:s,typedBufferStride:n}=t.normalCompressed;y(s,e,o.faceNormal0[0],o.faceNormal0[1],o.faceNormal0[2],n)}{const{typedBuffer:s,typedBufferStride:n}=t.normal2Compressed;y(s,e,o.faceNormal1[0],o.faceNormal1[1],o.faceNormal1[2],n)}}static{this.Layout=n}static{this.glLayout=w(n,1)}}const J=m(),K=new r;function Q(t){const e=Y(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return $.updateSettings(t.writerSettings),tt.updateSettings(t.writerSettings),A(e,$,tt)}function Y(e,o,s,n){if(o){const t=F(s,n,e.count);return new Z(s,n,t,e)}const r=t(e.buffer,e.stride/4,{originalIndices:s}),i=F(r.indices,n,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:i,vertices:a.createView(r.buffer)}}class Z{constructor(t,e,o,s){this.faces=t,this.facesLength=e,this.neighbors=o,this.vertices=s}}const $=new X,tt=new G,et=e().vec3f(o.POSITION0).vec3f(o.POSITION1),ot=e().vec3f(o.POSITION0).vec3f(o.POSITION1).u16(o.COMPONENTINDEX),st=Object.freeze(Object.defineProperty({__proto__:null,extract:Q,extractComponentsEdgeLocationsLayout:ot,extractEdgeInformation:Y,extractEdgeLocationsLayout:et},Symbol.toStringTag,{value:"Module"}));export{X as R,G as S,Y as a,A as b,ot as c,et as d,Q as e,st as f};
