/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../Graphic.js";import o from"../core/Accessor.js";import i from"../core/Collection.js";import{whenOnce as s,watch as r,syncAndInitial as n,sync as a}from"../core/reactiveUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./Logger.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{U as p}from"./UpdatingHandles.js";import{c as d}from"./asyncUtils.js";import u from"../core/Evented.js";import{m as h}from"./handleUtils.js";import{d as m}from"./maybe.js";import{load as y}from"../geometry/coordinateFormatter.js";import g from"../layers/GraphicsLayer.js";import{p as f}from"./dehydratedFeatureComparison.js";import{c as v,b as w,a as O,d as _,f as k,e as x,g as U}from"./createUtils.js";import{c as b}from"./surfaceCoordinateSystems.js";import{f as I,z as T,v as M,d as V,h as P}from"./quantityUtils.js";import{F as S}from"./unitUtils.js";import{a as A}from"./ensureType.js";import G from"../geometry/Point.js";import{b as R,h as C}from"./elevationInfoUtils.js";import{g as j}from"./helpMessageUtils.js";import{getDrawMeshHelpMessage as E}from"./helpMessageUtils3d.js";import{g as L}from"./drawSurfaces.js";import{S as F,u as z,m as H,p as D,e as N}from"./SketchTooltipInfo.js";import{T as Z,b as B,c as Y,d as q,e as W,m as X,a as J}from"./TooltipInfoWithCoordinates.js";import{e as K}from"./angularMeasurementUtils.js";import{i as Q,d as $}from"./geodesicLengthMeasurementUtils.js";import{I as tt}from"./InteractiveToolBase.js";import{S as et}from"./SketchOptions.js";import{a as ot}from"./watch.js";import{s as it,h as st,w as rt,x as nt,e as at,j as lt,b as ct,y as pt}from"./vec2.js";import{s as dt,i as ut,z as ht,j as mt}from"./vec3.js";import{f as yt,Z as gt}from"./vec3f64.js";import{c as ft,u as vt}from"./boundedPlane.js";import{b as wt}from"./vector.js";import{U as Ot,M as _t,R as kt,S as xt}from"./EditGeometryOperations.js";var Ut,bt;!function(t){t[t.NeverApplied=0]="NeverApplied",t[t.Applied=1]="Applied",t[t.Undone=2]="Undone"}(Ut||(Ut={})),function(t){t.UndoRedoUpdating="UndoRedoUpdating",t.UndoInvalidError="UndoInvalidError",t.RedoInvalidError="RedoInvalidError",t.ApplyInvalidError="ApplyInvalidError"}(bt||(bt={}));const It={[bt.UndoRedoUpdating]:"Cannot perform operation whilst undo redo is updating",[bt.UndoInvalidError]:"There are no items to Undo",[bt.RedoInvalidError]:"There are no items to Redo",[bt.ApplyInvalidError]:"Cannot apply an item that is already applied"};class Tt extends Error{constructor(){super(It[bt.UndoRedoUpdating]),this.type="undo-redo-updating-error"}}class Mt extends Error{constructor(){super(It[bt.UndoInvalidError]),this.type="undo-redo-undo-error"}}class Vt extends Error{constructor(){super(It[bt.RedoInvalidError]),this.type="undo-redo-redo-error"}}class Pt extends Error{constructor(){super(It[bt.ApplyInvalidError]),this.type="undo-redo-apply-error"}}var St;!function(t){t[t.Apply=0]="Apply",t[t.Undo=1]="Undo",t[t.Redo=2]="Redo"}(St||(St={}));let At=class extends o{constructor(){super(...arguments),this.name="",this.tag=Symbol(),this.status=Ut.NeverApplied}get canUndo(){return this.status===Ut.Applied}get canRedo(){return this.status===Ut.Undone}async executeUndoRedoOperation(t){switch(t){case St.Apply:if(this.status!==Ut.NeverApplied)throw new Pt;return await this.apply(),void(this.status=Ut.Applied);case St.Undo:if(this.status!==Ut.Applied)throw new Mt;return await this.undo(),void(this.status=Ut.Undone);case St.Redo:if(this.status!==Ut.Undone)throw new Mt;return await this.redo(),void(this.status=Ut.Applied)}}};t([l()],At.prototype,"name",void 0),t([l()],At.prototype,"tag",void 0),At=t([c("esri.undoredo.UndoableOperation")],At);let Gt=class extends o{constructor(){super(...arguments),this._stack=new i,this._stackPosition=-1,this._updatingHandles=new p}get updating(){return this._updatingHandles.updating}get canUndo(){return this.hasUndo&&!this.updating}get hasUndo(){return this._stackPosition>=0}get canRedo(){return this.hasRedo&&!this.updating}get hasRedo(){return this._stackPosition<this._stack.length-1}_truncateForwardStack(){this._stack.splice(this._stackPosition+1,this._stack.length-this._stackPosition).forEach((t=>t.destroy()))}_drainStack(){this._stack.drain((t=>t.destroy())),this._stackPosition=-1}async undo(){if(!this.hasUndo)throw new Mt;if(this.updating)throw new Tt;const t=this._stack.getItemAt(this._stackPosition);t&&await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(St.Undo),--this._stackPosition,t.canRedo||this._truncateForwardStack()})())}async redo(){if(!this.hasRedo)throw new Vt;if(this.updating)throw new Tt;const t=this._stack.getItemAt(this._stackPosition+1);if(!t)throw new Vt;await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(St.Redo),++this._stackPosition})())}peekUndo(){if(this.canUndo)return this._stack.getItemAt(this._stackPosition)}peekRedo(){if(this.canRedo)return this._stack.getItemAt(this._stackPosition+1)}async inject(t){if(this.updating)throw new Tt;await this._updatingHandles.addPromise((async()=>{t.status===Ut.NeverApplied&&await t.executeUndoRedoOperation(St.Apply),t.canUndo?(this._stack.splice(this._stackPosition+1,0,t),this._stackPosition++):this._stackPosition>-1&&(this._stack.splice(0,this._stackPosition+1).forEach((t=>t.destroy())),this._stackPosition=-1)})())}async add(t){if(this.updating)throw new Tt;await this._updatingHandles.addPromise((async()=>{t.status===Ut.NeverApplied&&await t.executeUndoRedoOperation(St.Apply),this._stackPosition>=-1&&this._truncateForwardStack(),t.canUndo?(this._stack.push(t),this._stackPosition=this._stack.length-1):this._drainStack()})())}async removeTagged(t,e=!1){if(this.updating&&!e)return;await s((()=>!this.updating));const o=new i;for(let e=0;e<this._stack.length;e++){const i=this._stack.getItemAt(e);i&&(i.tag===t?(i.destroy(),e===this._stackPosition&&(this._stackPosition=o.length-1)):o.push(i))}this._stack=o,this._stackPosition>o.length-1&&(this._stackPosition=o.length-1)}async clear(t=!1){if(this.updating&&!t)throw new Tt;await s((()=>!this.updating)),this._drainStack()}};t([l()],Gt.prototype,"_stack",void 0),t([l()],Gt.prototype,"_stackPosition",void 0),t([l()],Gt.prototype,"updating",null),t([l({readOnly:!0})],Gt.prototype,"canUndo",null),t([l({readOnly:!0})],Gt.prototype,"hasUndo",null),t([l({readOnly:!0})],Gt.prototype,"canRedo",null),t([l({readOnly:!0})],Gt.prototype,"hasRedo",null),Gt=t([c("esri.UndoRedo")],Gt);class Rt{constructor(){this.committedVertices=null,this.cursorVertex=null,this.full=null,this.outline=null,this.cursorEdge=null,this.circle=null,this.rectangle=null}}let Ct=class extends F{constructor(t){super(t),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=I}get allFields(){return[]}};t([l()],Ct.prototype,"type",void 0),t([l()],Ct.prototype,"radius",void 0),t([l()],Ct.prototype,"xSize",void 0),t([l()],Ct.prototype,"ySize",void 0),t([l()],Ct.prototype,"area",void 0),t([l()],Ct.prototype,"helpMessage",void 0),t([l()],Ct.prototype,"allFields",null),Ct=t([c("esri.views.interactive.tooltip.infos.DrawCircleTooltipInfo")],Ct);let jt=class extends(Z(F)){constructor(t){super(t),this.type="draw-mesh",this.orientation=B({lockable:!1}),this.scale=Y({lockable:!1})}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.scale]}};t([l()],jt.prototype,"helpMessage",void 0),t([l()],jt.prototype,"allFields",null),jt=t([c("esri.views.interactive.tooltip.infos.DrawMeshTooltipInfo")],jt);let Et=class extends(Z(F)){constructor(t){super(t),this.type="draw-multipoint"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};t([l()],Et.prototype,"helpMessage",void 0),t([l()],Et.prototype,"allFields",null),Et=t([c("esri.views.interactive.tooltip.infos.DrawMultipointTooltipInfo")],Et);let Lt=class extends(Z(F)){constructor(t){super(t),this.type="draw-point"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};t([l()],Lt.prototype,"helpMessage",void 0),t([l()],Lt.prototype,"allFields",null),Lt=t([c("esri.views.interactive.tooltip.infos.DrawPointTooltipInfo")],Lt);let Ft=class extends(Z(F)){constructor(t){super(t),this.type="draw-polygon",this.direction=q(),this.distance=W(),this.area=X(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.area]}};t([l()],Ft.prototype,"xyMode",void 0),t([l()],Ft.prototype,"helpMessage",void 0),t([l()],Ft.prototype,"allFields",null),Ft=t([c("esri.views.interactive.tooltip.infos.DrawPolygonTooltipInfo")],Ft);let zt=class extends(Z(F)){constructor(t){super(t),this.type="draw-polyline",this.direction=q(),this.distance=W(),this.totalLength=J(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.totalLength]}};t([l()],zt.prototype,"helpMessage",void 0),t([l()],zt.prototype,"xyMode",void 0),t([l()],zt.prototype,"allFields",null),zt=t([c("esri.views.interactive.tooltip.infos.DrawPolylineTooltipInfo")],zt);let Ht=class extends F{constructor(t){super(t),this.type="draw-rectangle",this.xSize=T,this.ySize=T,this.area=I}get allFields(){return[]}};function Dt(t){const{directionOptions:e,geometryType:o,sketchOptions:i,tooltipInfos:s}=t,r=e=>{const o=$t(t).mode,i=s[e].elevation;"relative-to-ground"===o||"relative-to-scene"===o||"on-the-ground"===o?i.lock(ee(t)):i.unlock()};switch(o){case"polygon":case"polyline":r(o),(t=>{if(e){const o=s[t].direction;o.committed=e.angle,o.unlockOnVertexPlacement=!1,i.values.directionMode=e.mode}})(o);break;case"point":case"mesh":r(o)}}function Nt(t){Zt(t)?.allFields.forEach((t=>{t.unlockOnVertexPlacement&&t.unlock()}))}function Zt({geometryType:t,graphic:e,tooltipInfos:o}){return e?.geometry?.type!==Bt[t]?"circle"===t||"rectangle"===t?o[t]:null:o[t]}t([l()],Ht.prototype,"type",void 0),t([l()],Ht.prototype,"xSize",void 0),t([l()],Ht.prototype,"ySize",void 0),t([l()],Ht.prototype,"area",void 0),t([l()],Ht.prototype,"helpMessage",void 0),t([l()],Ht.prototype,"allFields",null),Ht=t([c("esri.views.interactive.tooltip.infos.DrawRectangleTooltipInfo")],Ht);const Bt={point:"point",multipoint:"multipoint",mesh:"mesh",polyline:"polyline",polygon:"polygon",circle:"polygon",rectangle:"polygon",freehandPolygon:"polygon",freehandPolyline:"polyline"};function Yt(t,e,o){const{drawOperation:i,view:s,sketchOptions:r}=o,{cursorVertex:n}=i;t.sketchOptions=r,t.viewType=s.type;const a="multipoint"===e?.type?e.getPoint(e.points.length-1):e;if(t.setLocationFromPoint(a,te(o)),Xt(t.elevation,o),!n)return void(i.constraints=void 0);const l=n;i.constraints={context:oe(l,o),x:t.x.committed,y:t.y.committed,longitude:t.longitude.committed,latitude:t.latitude.committed,elevation:t.elevation.committed,distance:null,direction:null}}const qt=A(G);function Wt(t,e){const{drawOperation:o,sketchOptions:i,view:s,automaticLengthMeasurementUtils:r}=e,{cursorVertex:n,lastVertex:a,secondToLastVertex:l}=o,c=i.values.effectiveDirectionMode;t.sketchOptions=i,t.viewType=s.type;const p=a&&n?r.autoDistanceBetweenPoints2D(qt(a),qt(n))??T:null;if(t.distance.actual=p,t.distance.readOnly=null==a,t.direction.actual=null,t.direction.readOnly=!0,a&&n&&("absolute"===c||l)){const e=K(l,a,n,c);t.direction.actual=e??P,t.direction.readOnly=!1}t.setLocationFromPoint(n,te(e)),Xt(t.elevation,e);const d=function(t,{sketchOptions:e}){const o=e.tooltips.xyMode;return"auto"===o?t?"direction-distance":"coordinates":o}(a,e);t.xyMode=d,t.direction.visible="direction-distance"===d,t.distance.visible="direction-distance"===d,t.effectiveX.visible="coordinates"===d,t.effectiveY.visible="coordinates"===d;const u=n??a;o.constraints=u?{context:oe(u,e),x:t.x.committed,y:t.y.committed,longitude:t.longitude.committed,latitude:t.latitude.committed,elevation:t.elevation.committed,distance:t.distance.committed,direction:t.direction.committed}:void 0}function Xt(t,e){const{drawOperation:o}=e,i=o?.cursorVertex??o?.lastVertex;t.actual=$(i)??ee(e),t.visible=o.hasZ,t.readOnly=!1,t.showAsZ=!0}function Jt(t){const e=t.createOperationGeometry?.full;return"polygon"!==e?.type?I:t.automaticAreaMeasurementUtils.autoArea2D(e)??I}function Kt({createOperationGeometry:t,automaticLengthMeasurementUtils:e}){const o=t?.rectangle?.midpoints;return(null!=o?e.autoDistanceBetweenPoints2D(o.left,o.right):null)??T}function Qt({createOperationGeometry:t,automaticLengthMeasurementUtils:e}){const o=t?.rectangle?.midpoints;return(null!=o?e.autoDistanceBetweenPoints2D(o.top,o.bottom):null)??T}function $t(t){return t.drawOperation.elevationInfo??R}function te(t){return t.drawOperation.coordinateHelper.spatialReference}function ee(t){const e=S(te(t));return V(t.defaultZ*e,"meters")}function oe(t,e){return L(t,e.view,te(e),$t(e),e.drawOperation.coordinateHelper.hasZ(),e.sketchOptions.values.effectiveDirectionMode)}let ie=class extends(u.EventedMixin(tt)){constructor(t){super(t),this._graphic=null,this._coordinateFormatterLoadTask=null,this._createOperationGeometry=null,this.defaultZ=0,this.directionOptions=null,this.elevationLockOnVertexAddDisabled=!1,this.geometryType=null,this.hasZ=!0,this.geometryToPlace=null,this.snappingManager=null,this.snapToScene=!1,this.sketchOptions=new et}initialize(){const{view:t}=this;this.internalGraphicsLayer=new g({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer);const e=this.drawOperation=this.makeDrawOperation();var o,i;this.tooltipInfos=(o=t.type,i=this.sketchOptions,{point:new Lt({sketchOptions:i,viewType:o}),multipoint:new Et({sketchOptions:i,viewType:o}),polyline:new zt({sketchOptions:i,viewType:o}),polygon:new Ft({sketchOptions:i,viewType:o}),mesh:new jt({sketchOptions:i,viewType:o}),rectangle:new Ht({sketchOptions:i}),circle:new Ct({sketchOptions:i})});const s=H((()=>({view:t,options:this.sketchOptions.tooltips})));this.tooltip=s,Dt(this._tooltipsContext),this._coordinateFormatterLoadTask=d((()=>y())),this.addHandles([e.on("vertex-add",(t=>this.onVertexAdd(t))),e.on("vertex-remove",(t=>this.onVertexRemove(t))),e.on("vertex-update",(t=>this.onVertexUpdate(t))),e.on("cursor-update",(t=>this.onCursorUpdate(t))),e.on("cursor-remove",(()=>this._updateGraphic())),e.on("complete",(t=>this.onComplete(t))),this._coordinateFormatterLoadTask,s.on("paste",(t=>D(t,this.activeTooltipInfo))),r((()=>this.cursor),(t=>{e.cursor=t}),n),ot((()=>{const{activeTooltipInfo:t,sketchOptions:e}=this;(function(t,e){switch(t?.type){case"draw-point":!function(t,e){const o=e.graphic?.geometry;"point"===o?.type&&(Yt(t,o,e),t.helpMessage=j("point",o,e.drawOperation.drawingMode))}(t,e);break;case"draw-multipoint":!function(t,e){const o=e.graphic?.geometry;"multipoint"===o?.type&&(Yt(t,o,e),t.helpMessage=j("multipoint",o,e.drawOperation.drawingMode))}(t,e);break;case"draw-polyline":!function(t,e){const{createOperationGeometry:o,drawOperation:i,automaticLengthMeasurementUtils:s}=e,r=null!=o?o.full:null;r&&"polyline"!==r.type||(Wt(t,e),t.totalLength.actual=i.lastVertex?(r?s.autoLength2D(r):null)??T:null,t.helpMessage=j("polyline",r,e.drawOperation.drawingMode))}(t,e);break;case"draw-polygon":!function(t,e){const{createOperationGeometry:o,drawOperation:i}=e,s=null!=o?o.full:null;s&&"polygon"!==s.type||(Wt(t,e),t.area.actual=i.lastVertex?(s?e.automaticAreaMeasurementUtils.autoArea2D(s):null)??I:null,t.helpMessage=j("polygon",s,e.drawOperation.drawingMode))}(t,e);break;case"draw-rectangle":!function(t,e){t.sketchOptions=e.sketchOptions,t.xSize=Kt(e),t.ySize=Qt(e),t.area=Jt(e),t.helpMessage=j("rectangle",e.graphic?.geometry,e.drawOperation.drawingMode)}(t,e);break;case"draw-circle":!function(t,e){const{forceUniformSize:o,sketchOptions:i}=e;t.sketchOptions=i,t.radius=o?function({createOperationGeometry:t,automaticLengthMeasurementUtils:e}){return(null!=t?.circle?.center&&null!=t.circle.edge?e.autoDistanceBetweenPoints2D(t.circle.center,t.circle.edge):null)??T}(e):null,t.xSize=o?null:Kt(e),t.ySize=o?null:Qt(e),t.area=Jt(e),t.helpMessage=j("circle",e.graphic?.geometry,e.drawOperation.drawingMode)}(t,e);break;case"draw-mesh":!function(t,e){const{graphic:o,view:i}=e,s=o?.geometry;"3d"!==i.type||s&&"mesh"!==s.type||(Yt(t,s?.origin,e),s&&z(t,s),t.helpMessage=E(o,i))}(t,e)}})(t,this._tooltipsContext),s.info=e.tooltips.effectiveEnabled?t:null})),ot((()=>{e.constraintZ=function(t){const{geometryType:e,tooltipInfos:o}=t;switch(e){case"point":case"multipoint":case"mesh":case"polyline":case"polygon":{const i=o[e].elevation.committed;if(!i)return;return M(i,"meters")/S(te(t))}default:return}}(this._tooltipsContext)}),a)]),this.finishToolCreation()}destroy(){this.drawOperation=m(this.drawOperation),this.tooltip=m(this.tooltip),this._destroyAllVisualizations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=m(this.internalGraphicsLayer),this._set("view",null)}get _drawSpatialReference(){return this.drawOperation.coordinateHelper.spatialReference}get _tooltipsContext(){const{defaultZ:t,directionOptions:e,drawOperation:o,forceUniformSize:i,geometryType:s,graphic:r,sketchOptions:n,tooltipInfos:a,view:l,automaticAreaMeasurementUtils:c,automaticLengthMeasurementUtils:p}=this;return{createOperationGeometry:this._createOperationGeometry,defaultZ:t,directionOptions:e,drawOperation:o,forceUniformSize:i,geometryType:s,graphic:r,sketchOptions:n,tooltipInfos:a,view:l,automaticAreaMeasurementUtils:c,automaticLengthMeasurementUtils:p}}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(t){this._set("cursor",t)}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),null!=this._graphic&&(this._graphic.symbol=t)}set mode(t){const e=this.drawOperation;e&&(e.drawingMode=t),this._set("mode",t)}get updating(){return this.drawOperation?.updating??!1}get undoRedo(){const{view:{type:t,map:e}}=this;return"2d"===t&&e&&"undoRedo"in e&&e.undoRedo instanceof Gt?e.undoRedo:null}set undoRedo(t){this._override("undoRedo",t)}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.destroyed||N(t,this.tooltip)||this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo(),0===this.drawOperation.numCommittedVertices&&Dt(this._tooltipsContext)}_destroyAllVisualizations(){this.removeHandles(re.outline),this.removeHandles(re.regularVertices),this.removeHandles(re.activeVertex),this.removeHandles(re.activeEdge),this.removeHandles(se)}_createOrUpdateGraphic(t){if(null!=this._graphic)return this.updateGraphicGeometry(t),this._graphic;const o=new e({...this.graphicProperties,symbol:this.graphicSymbol});return this._graphic=o,this.updateGraphicGeometry(t),this.internalGraphicsLayer.add(o),this.addHandles(this.initializeGraphic(o)),this.notifyChange("graphic"),this.addHandles(h((()=>{this.internalGraphicsLayer.remove(o),this._graphic===o&&(this._graphic=null)})),se),o}updateGraphicGeometry(t){this._graphic.geometry=t}_getCreateOperationGeometry(t={operationComplete:!1}){if(null==this.drawOperation)return;const{coordinateHelper:e,view:o,visualizationCursorVertex:i,lastVertex:s,committedVertices:r,geometryIncludingUncommittedVertices:n,numCommittedVertices:a}=this.drawOperation;if(!(a>0||null!=i))return;const l=t.operationComplete?r:n,c=l.length,p=null!=i?e.pointToArray(i):null,d=this._drawSpatialReference,u="3d"===o.type&&"global"===o.viewingMode,h=new Rt;h.committedVertices=r,h.cursorVertex=p;const{geometryType:m}=this;switch(m){case"point":case"mesh":h.full=e.arrayToPoint(l[0]);break;case"multipoint":h.full=c>0?U(l,d):null;break;case"polyline":case"polygon":c>0&&(h.full="polygon"===m?k([l],d,u,!0):x([l],d,u),h.cursorEdge=null!=p&&s&&!f(i,s)?x([[p,e.pointToArray(s)]],d,u):null,h.outline=c>1?h.full:null);break;case"circle":case"rectangle":{if(h.committedVertices=h.cursorVertex=null,!c)break;const e=b(o,l[0]),i=l[0],s=e.makeMapPoint(i[0]+ae*o.resolution,i[1]);"circle"===m?1===c&&t.operationComplete?h.circle=v([i,s],e,!0):2===c&&(this.forceUniformSize?h.circle=v(l,e,this.centered):h.rectangle=w(l,e,this.centered)):1===c&&t.operationComplete?h.rectangle=O([i,s],e,!0):2===c&&(h.rectangle=this.forceUniformSize?O(l,e,this.centered):_(l,e,this.centered)),h.full=null!=h.circle?h.circle.geometry:h.rectangle?.geometry,h.outline="polygon"===h.full?.type?h.full:null;break}default:return null}return h}initializeGraphic(t){return h()}onComplete(t){if(!this.drawOperation)return;this._updateGraphic();let e=null;if(this.drawOperation.isCompleted){const t=this._getCreateOperationGeometry({operationComplete:!0});null!=t&&(e=this._createOrUpdateGraphic(t.full))}this._createOperationGeometry=null,this.emit("complete",{graphic:e,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){const{drawOperation:t}=this;t&&(t.isCompleted||t.cancel())}onOutlineChanged(t){return h()}onCursorEdgeChanged(t){return h()}onVertexAdd(t){Nt(this._tooltipsContext),this._updateGraphic(),this.elevationLockOnVertexAddDisabled||function(t,e){const{drawOperation:o,view:i}=e,s=Zt(e),r=$t(e);if("2d"===i.type||!t||"absolute-height"!==r.mode||1!==o?.numCommittedVertices||!s||"draw-polyline"!==s.type&&"draw-polygon"!==s.type||s.elevation.locked)return;const[n,a,l]=t,c=function(t,e,o,i,s){const{view:r,drawOperation:n}=s;if("3d"!==r.type||!n)return;o??=0;const a=te(s),l=$t(s),c=C(r,t,e,o,a,l,i);return Q(c,a)??ee(s)}(n,a,l,r,e);null!=c&&s.elevation.lock(c)}(t.vertices.at(0)?.coordinates,this._tooltipsContext),this.emit("vertex-add",t)}onVertexRemove(t){Nt(this._tooltipsContext),this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();this._createOperationGeometry=t,null!=t?(null!=t.cursorEdge?this.addHandles(this.onCursorEdgeChanged(t.cursorEdge),re.activeEdge):this.removeHandles(re.activeEdge),null!=t.outline?this.addHandles(this.onOutlineChanged(t.outline),re.outline):this.removeHandles(re.outline),null!=t.committedVertices?this.addHandles(this.onRegularVerticesChanged(t.committedVertices),re.regularVertices):this.removeHandles(re.regularVertices),null!=t.cursorVertex?this.addHandles(this.onActiveVertexChanged(t.cursorVertex),re.activeVertex):this.removeHandles(re.activeVertex),null!=t.full?this._createOrUpdateGraphic(t.full):this.removeHandles(se)):this._destroyAllVisualizations()}get activeTooltipInfo(){return this._coordinateFormatterLoadTask?.finished?Zt(this._tooltipsContext):null}};t([l()],ie.prototype,"_coordinateFormatterLoadTask",void 0),t([l()],ie.prototype,"_createOperationGeometry",void 0),t([l()],ie.prototype,"_tooltipsContext",null),t([l({value:!0})],ie.prototype,"centered",null),t([l()],ie.prototype,"cursor",null),t([l({nonNullable:!0})],ie.prototype,"defaultZ",void 0),t([l({constructOnly:!0})],ie.prototype,"directionOptions",void 0),t([l()],ie.prototype,"drawOperation",void 0),t([l()],ie.prototype,"elevationLockOnVertexAddDisabled",void 0),t([l({value:!0})],ie.prototype,"enabled",null),t([l({value:!0})],ie.prototype,"forceUniformSize",null),t([l({constructOnly:!0})],ie.prototype,"geometryType",void 0),t([l()],ie.prototype,"graphic",null),t([l({constructOnly:!0})],ie.prototype,"graphicProperties",void 0),t([l()],ie.prototype,"graphicSymbol",null),t([l({constructOnly:!0})],ie.prototype,"hasZ",void 0),t([l({constructOnly:!0})],ie.prototype,"geometryToPlace",void 0),t([l()],ie.prototype,"mode",null),t([l()],ie.prototype,"snappingManager",void 0),t([l()],ie.prototype,"snapToScene",void 0),t([l()],ie.prototype,"tooltip",void 0),t([l()],ie.prototype,"tooltipInfos",void 0),t([l({constructOnly:!0,type:et})],ie.prototype,"sketchOptions",void 0),t([l()],ie.prototype,"updating",null),t([l({constructOnly:!0,nonNullable:!0})],ie.prototype,"view",void 0),t([l({constructOnly:!0})],ie.prototype,"automaticAreaMeasurementUtils",void 0),t([l({constructOnly:!0})],ie.prototype,"automaticLengthMeasurementUtils",void 0),t([l({constructOnly:!0})],ie.prototype,"undoRedo",null),t([l()],ie.prototype,"activeTooltipInfo",null),ie=t([c("esri.views.draw.DrawGraphicTool")],ie);const se=Symbol("create-operation-graphic"),re={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")};function ne(t){switch(t){case"point":case"polyline":case"polygon":case"multipoint":return t;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const ae=48;function le(t,e){return pe(t,e,!1)}function ce(t,e){return pe(t,e,!0)}function pe(t,e,o){if(t instanceof Ot){if(t.operation instanceof _t)return function(t,e,o=!1){const i=o?-1:1,s=yt(i*t.dx,i*t.dy,i*t.dz);ut(e.origin,e.origin,s),vt(e)}(t.operation,e,o),!0;if(t.operation instanceof kt)return function(t,e,o=!1){const i=o?-t.angle:t.angle;ht(e.basis1,e.basis1,gt,i),ht(e.basis2,e.basis2,gt,i),vt(e)}(t.operation,e,o),!0;if(t.operation instanceof xt)return function(t,e,o=!1){const i=o?1/t.factor1:t.factor1,s=o?1/t.factor2:t.factor2;mt(e.basis1,e.basis1,i),mt(e.basis2,e.basis2,s),pt(e.origin,e.origin,t.origin,t.axis1,i),pt(e.origin,e.origin,t.origin,t.axis2,s),vt(e)}(t.operation,e,o),!0}return!1}function de(t,e,o,i,s=!1){i||(i=ft());const r=it(wt.get(),t[1],-t[0]),n=it(wt.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),a=it(wt.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),l=wt.get(),c=e.allVertices;c.forEach((({pos:e})=>{it(l,st(t,e),st(r,e)),rt(n,n,l),nt(a,a,l)}));const p=1e-6,d=it(wt.get(),a[0]-n[0]<p?o/2:0,a[1]-n[1]<p?o/2:0);at(n,n,d),lt(a,a,d);const u=s?c.reduce(((t,e)=>t+(e.pos[2]??0)),0)/c.length:0;return ct(i.basis1,t,(a[0]-n[0])/2),ct(i.basis2,r,(a[1]-n[1])/2),dt(i.origin,n[0]*t[0]+n[1]*r[0],n[0]*t[1]+n[1]*r[1],u),ut(i.origin,i.origin,i.basis1),ut(i.origin,i.origin,i.basis2),vt(i),i}export{ie as D,le as a,ce as b,de as c,ne as g};
