/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import{A as t}from"./TimeOnly.js";import{s as r,F as i,u as s}from"./arcade.js";import{D as o}from"./aiServices.js";import{A as n,E as a,S as l,t as m}from"./enum.js";import{c as p,a as u,F as c,b as d,O as f,d as y,T as j,e as I,f as b,g,h,S as w,i as F,j as T,A as D,k as S}from"./featureSetUtils.js";import{I as x}from"./ImmutableArray.js";import{p as E,y as C,z as A,f as L,n as U,J as v,H as N,i as k,e as P,G as R,F as M,d as Z,c as $,j as O,t as V,K as z,L as B}from"./languageUtils.js";import{g as G}from"./portalUtils.js";import{E as H,i as W}from"./SpatialFilter.js";import{i as q,c as Q}from"./shared2.js";import{isPromiseLike as K}from"../core/promiseUtils.js";import _ from"../core/sql/WhereClause.js";import J from"../layers/FeatureLayer.js";import Y from"../layers/support/Field.js";import X from"../portal/Portal.js";import{queryAssociations as ee}from"../rest/networks/queryAssociations.js";import te from"../rest/networks/support/NetworkElement.js";import re from"../rest/networks/support/QueryAssociationsParameters.js";import{b as ie,a as se,e as oe}from"./guards.js";import"./tslib.es6.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Accessor.js";import"../core/lang.js";import"../core/Handles.js";import"./Logger.js";import"../config.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"./MapUtils.js";import"./Warning.js";import"../core/Error.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./events.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"./jsonUtils.js";import"../core/JSONSupport.js";import"../core/accessorSupport/decorators/cast.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./datetime.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"./jsonMap.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./locale.js";import"./constants.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"./colorUtils2.js";import"./mathUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../core/reactiveUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils2.js";import"./createFeatureId.js";import"./typeUtils.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils5.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils6.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./vec3f64.js";import"./aaBoundingBox.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"./lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./UnknownTimeZone.js";import"./deepClone.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./memoryEstimations.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"../layers/support/FieldsIndex.js";import"./timeZoneUtils.js";import"./unitConversion.js";import"./number.js";import"./hash.js";import"./uuid.js";import"./utils10.js";import"./commonProperties3.js";import"./MD5.js";import"../rest/support/AttachmentQuery.js";import"../rest/support/Query.js";import"./DataLayerSource.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"./timeUtils.js";import"../layers/support/FeatureType.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../layers/support/FeatureTemplate.js";import"../rest/support/RelationshipQuery.js";import"./fieldType.js";import"../layers/Layer.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./operatorsWorkerConnection.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./number2.js";import"./substitute.js";import"./messages.js";import"./MultiOriginJSONSupport.js";import"./layerContainerType.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/AttachmentElement.js";import"../form/elements/Element.js";import"../form/elements/inputs/attachments/AttachmentInput.js";import"./Input.js";import"../form/elements/inputs/attachments/AudioInput.js";import"./utils7.js";import"../form/elements/inputs/attachments/DocumentInput.js";import"../form/elements/inputs/attachments/ImageInput.js";import"../form/elements/inputs/attachments/SignatureInput.js";import"../form/elements/inputs/attachments/VideoInput.js";import"../form/elements/FieldElement.js";import"../form/elements/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DatePickerInput.js";import"../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../form/elements/inputs/TimePickerInput.js";import"./formUtils.js";import"../form/elements/RelationshipElement.js";import"../form/elements/TextElement.js";import"../form/elements/UtilityNetworkAssociationsElement.js";import"./editsZScale.js";import"./queryZScale.js";import"./zscale.js";import"../rest/support/FeatureSet.js";import"../layers/mixins/APIKeyMixin.js";import"./ArcGISService.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils2.js";import"./parser.js";import"./utils2.js";import"./mat4.js";import"./common.js";import"../layers/mixins/CustomParametersMixin.js";import"../layers/mixins/DisplayFilteredLayer.js";import"../layers/support/DisplayFilterInfo.js";import"./scaleUtils.js";import"../layers/support/DisplayFilter.js";import"./displayFilterUtils.js";import"./EditBusLayer.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../layers/mixins/FeatureLayerBase.js";import"../geometry/HeightModelInfo.js";import"./commonProperties.js";import"./ElevationInfo.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"../tables/AttributeTableTemplate.js";import"../tables/elements/AttributeTableGroupElement.js";import"../tables/elements/AttributeTableAttachmentElement.js";import"../tables/elements/AttributeTableElement.js";import"../tables/elements/AttributeTableFieldElement.js";import"../tables/elements/AttributeTableRelationshipElement.js";import"./featureLayerUtils.js";import"./asyncUtils.js";import"./featureQueryAll.js";import"./layerUtils.js";import"../layers/catalog/catalogUtils.js";import"../renderers/SimpleRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./visualVariableUtils.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./defaults.js";import"./defaultsJSON.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"./RendererLegendOptions.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils.js";import"../rest/support/NormalizationBinParametersMixin.js";import"../layers/support/GeometryFieldsInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"./serviceCapabilitiesUtils.js";import"./infoFor3D.js";import"../layers/support/Subtype.js";import"./portalItemUtils.js";import"./projectionUtils.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../layers/mixins/FeatureReductionLayer.js";import"../layers/support/AggregateField.js";import"../layers/support/ExpressionInfo.js";import"./FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/LabelClass.js";import"./labelUtils.js";import"../renderers/support/jsonUtils.js";import"./typeUtils3.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/support/ClassBreakInfo.js";import"../renderers/DictionaryRenderer.js";import"./LRUCache.js";import"./MemCache.js";import"./DictionaryScriptEvaluator.js";import"./Version.js";import"./ArcadeExpression.js";import"./utils3.js";import"./defaultCIMValues.js";import"./enums2.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"./heatmapUtils.js";import"./vec4.js";import"./vec4f64.js";import"../renderers/PieChartRenderer.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"./clusterUtils.js";import"../layers/mixins/OperationalLayer.js";import"../layers/mixins/OrderedLayer.js";import"../layers/support/OrderByInfo.js";import"../layers/mixins/PortalLayer.js";import"../layers/mixins/PublishableLayer.js";import"../layers/support/PublishingInfo.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../layers/support/TimeInfo.js";import"../time/TimeInterval.js";import"../layers/mixins/TrackableLayer.js";import"../layers/support/TrackInfo.js";import"../layers/support/TrackPartInfo.js";import"./fieldProperties.js";import"./labelingInfo.js";import"./TitleCreator.js";import"./versionUtils.js";import"./styleUtils2.js";import"../support/popupUtils.js";import"./interfaces.js";import"./typeUtils4.js";import"../rest/networks/support/QueryAssociationsResult.js";import"../rest/networks/support/Association.js";import"./TelecomNetworkElement.js";function ne(e,t,r){const i=e.getVariables();if(i.length>0){const s={};for(const e of i)s[e]=t.evaluateIdentifier(r,{name:e});e.parameters=s}return e}function ae(e,t,r=null){for(const r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return r}function le(e){if(null===e)return null;const t={type:ae(e,"type",""),name:ae(e,"name","")};if("range"===t.type)t.range=ae(e,"range",[]);else{t.codedValues=[];for(const r of ae(e,"codedValues",[]))t.codedValues.push({name:ae(r,"name",""),code:ae(r,"code",null)})}return t}function me(e){if(null===e)return null;const t={},r=ae(e,"wkt");null!==r&&(t.wkt=r);const i=ae(e,"wkid");return null!==i&&(t.wkid=i),t}function pe(e){if(null===e)return null;const t={hasZ:ae(e,"hasz",!1),hasM:ae(e,"hasm",!1)},r=ae(e,"spatialreference");null!=r&&(t.spatialReference=me(r));const i=ae(e,"x",null);if(null!==i)return t.x=i,t.y=ae(e,"y",null),t.hasZ&&(t.z=ae(e,"z",null)),t.hasM&&(t.m=ae(e,"m",null)),t;const s=ae(e,"rings",null);if(null!==s)return t.rings=s,t;const o=ae(e,"paths",null);if(null!==o)return t.paths=o,t;const n=ae(e,"points",null);if(null!==n)return t.points=n,t;for(const r of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const i=ae(e,r,null);null!==i&&(t[r]=i)}return t}function ue(e){return"utc"===e?.toLowerCase()?"UTC":"unknown"===e?.toLowerCase()?"Unknown":e}function ce(ce){if("async"===ce.mode){ce.functions.timezone=function(e,r){return ce.standardFunctionAsync(e,r,(async(i,s,l)=>{if(E(l,1,2,e,r),C(l[0]))return"Unknown";if(A(l[0]))return"Unknown";if(L(l[0])){if(await l[0].load(),1===l.length||null===l[1])return l[0].datesInUnknownTimezone?ue("unknown"):ue(l[0].dateFieldsTimeZone);if(!(l[1]instanceof o)||!1===l[1].hasField("type"))throw new n(e,a.InvalidParameter,r);const t=l[1].field("type");if(!1===ie(t))throw new n(e,a.InvalidParameter,r);switch(U(t).toLowerCase()){case"preferredtimezone":return ue(l[0].preferredTimeZone);case"editfieldsinfo":return ue(l[0].editFieldsInfo?.timeZone??null);case"timeinfo":return ue(l[0].timeInfo?.timeZone??null);case"field":if(l[1].hasField("fieldname")&&ie(l[1].field("fieldname")))return ue(l[0].fieldTimeZone(U(l[1].field("fieldname"))))}throw new n(e,a.InvalidParameter,r)}const m=v(l[0],N(e));if(null===m)return null;const p=m.timeZone;return"system"===p?t.systemTimeZoneCanonicalName:"utc"===p.toLowerCase()?"UTC":"unknown"===p.toLowerCase()?"Unknown":p}))},ce.functions.sqltimestamp=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{E(s,1,3,e,t);const o=s[0];if(k(o)){if(1===s.length)return o.toSQLWithKeyword();if(2===s.length)return o.changeTimeZone(U(s[1])).toSQLWithKeyword();throw new n(e,a.InvalidParameter,t)}if(A(o))return o.toSQLWithKeyword();if(L(o)){if(3!==s.length)throw new n(e,a.InvalidParameter,t);await o.load();const r=U(s[1]);if(A(s[2]))return s[2].toSQLWithKeyword();if(!1===k(s[2]))throw new n(e,a.InvalidParameter,t);const i=o.fieldTimeZone(r);return null==i?s[2].toSQLWithKeyword():s[2].changeTimeZone(i).toSQLWithKeyword()}throw new n(e,a.InvalidParameter,t)}))},ce.signatures.push({name:"sqltimestamp",min:2,max:4}),ce.functions.featuresetbyid=function(e,t){return ce.standardFunctionAsync(e,t,((r,i,s)=>{if(E(s,2,4,e,t),P(s[0])){const r=U(s[1]);let i=R(s[2],null);const o=M(R(s[3],!0));if(null===i&&(i=["*"]),!1===se(i))throw new n(e,a.InvalidParameter,t);return s[0].featureSetById(r,o,i)}throw new n(e,a.InvalidParameter,t)}))},ce.signatures.push({name:"featuresetbyid",min:2,max:4});const de=new l(["datasource","parent","root"]);ce.functions.getfeatureset=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{if(E(s,1,2,e,t),Z(s[0])){const t=null==s[1]?"datasource":de.lookup(U(s[1]));return p(s[0].fullSchema(),t,e.lrucache,e.interceptor,e.spatialReference)}throw new n(e,a.InvalidParameter,t)}))},ce.signatures.push({name:"getfeatureset",min:1,max:2}),ce.functions.featuresetbyportalitem=function(e,t){return ce.standardFunctionAsync(e,t,((i,s,o)=>{if(E(o,2,5,e,t),null===o[0])throw new n(e,a.PortalRequired,t);if(o[0]instanceof r){const r=U(o[1]),i=U(o[2]);let s=R(o[3],null);const l=M(R(o[4],!0));if(null===s&&(s=["*"]),!1===se(s))throw new n(e,a.InvalidParameter,t);let m;return m=e.services?.portal?e.services.portal:X.getDefault(),m=G(o[0],m),u(r,i,e.spatialReference,s,l,m,e.lrucache,e.interceptor)}if(!1===ie(o[0]))throw new n(e,a.PortalRequired,t);const l=U(o[0]),m=U(o[1]);let p=R(o[2],null);const c=M(R(o[3],!0));if(null===p&&(p=["*"]),!1===se(p))throw new n(e,a.InvalidParameter,t);return u(l,m,e.spatialReference,p,c,e.services?.portal??X.getDefault(),e.lrucache,e.interceptor)}))},ce.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),ce.functions.featuresetbyname=function(e,t){return ce.standardFunctionAsync(e,t,((r,i,s)=>{if(E(s,2,4,e,t),P(s[0])){const r=U(s[1]);let i=R(s[2],null);const o=M(R(s[3],!0));if(null===i&&(i=["*"]),!1===se(i))throw new n(e,a.InvalidParameter,t);return s[0].featureSetByName(r,o,i)}throw new n(e,a.InvalidParameter,t)}))},ce.signatures.push({name:"featuresetbyname",min:2,max:4}),ce.functions.featureset=function(e,t){return ce.standardFunction(e,t,((r,i,s)=>{E(s,1,1,e,t);const l={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(ie(s[0])){const e=JSON.parse(s[0]);void 0!==e.layerDefinition?(l.layerDefinition=e.layerDefinition,l.featureSet=e.featureSet,e.layerDefinition.spatialReference&&(l.layerDefinition.spatialReference=e.layerDefinition.spatialReference)):(l.featureSet.features=e.features,l.featureSet.geometryType=e.geometryType,l.layerDefinition.geometryType=l.featureSet.geometryType,l.layerDefinition.objectIdField=e.objectIdFieldName??"",l.layerDefinition.typeIdField=e.typeIdFieldName,l.layerDefinition.globalIdField=e.globalIdFieldName,l.layerDefinition.fields=e.fields,e.spatialReference&&(l.layerDefinition.spatialReference=e.spatialReference))}else{if(!(s[0]instanceof o))throw new n(e,a.InvalidParameter,t);{const r=JSON.parse(s[0].castToText(!0)),i=ae(r,"layerdefinition");if(null!==i){l.layerDefinition.geometryType=ae(i,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.globalIdField=ae(i,"globalidfield",""),l.layerDefinition.objectIdField=ae(i,"objectidfield",""),l.layerDefinition.typeIdField=ae(i,"typeidfield",""),l.layerDefinition.hasZ=!0===ae(i,"hasz",!1),l.layerDefinition.hasM=!0===ae(i,"hasm",!1);const e=ae(i,"spatialreference");e&&(l.layerDefinition.spatialReference=me(e));const t=[];for(const e of ae(i,"fields",[])){const r={name:ae(e,"name",""),alias:ae(e,"alias",""),type:ae(e,"type",""),nullable:ae(e,"nullable",!0),editable:ae(e,"editable",!0),length:ae(e,"length",null),domain:le(ae(e,"domain"))};t.push(r)}l.layerDefinition.fields=t;const s=ae(r,"featureset");if(s){const e={};for(const r of t)e[r.name.toLowerCase()]=r.name;for(const t of ae(s,"features",[])){const r={},i=ae(t,"attributes",{});for(const t in i)r[e[t.toLowerCase()]]=i[t];l.featureSet.features.push({attributes:r,geometry:pe(ae(t,"geometry"))})}}}else{l.layerDefinition.hasZ=!0===ae(r,"hasz",!1),l.layerDefinition.hasM=!0===ae(r,"hasm",!1),l.layerDefinition.geometryType=ae(r,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=ae(r,"objectidfieldname",""),l.layerDefinition.typeIdField=ae(r,"typeidfieldname","");const i=ae(r,"spatialreference");i&&(l.layerDefinition.spatialReference=me(i));const s=[],o=ae(r,"fields",null);if(!se(o))throw new n(e,a.InvalidParameter,t);for(const e of o){const t={name:ae(e,"name",""),alias:ae(e,"alias",""),type:ae(e,"type",""),nullable:ae(e,"nullable",!0),editable:ae(e,"editable",!0),length:ae(e,"length",null),domain:le(ae(e,"domain"))};s.push(t)}l.layerDefinition.fields=s;const m={};for(const e of s)m[e.name.toLowerCase()]=e.name;let p=ae(r,"features",null);if(se(p))for(const e of p){const t={},r=ae(e,"attributes",{});for(const e in r)t[m[e.toLowerCase()]]=r[e];l.featureSet.features.push({attributes:t,geometry:pe(ae(e,"geometry",null))})}else p=null,l.featureSet.features=p}}}if(0==(!!(m=l).layerDefinition&&!!m.featureSet&&!1!==function(e){for(const t of["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])if(t===e)return!0;return!1}(m.layerDefinition.geometryType)&&!1!==se(m.layerDefinition.fields)&&!1!==se(m.featureSet.features)))throw new n(e,a.InvalidParameter,t);var m;return l.layerDefinition.geometryType||(l.layerDefinition.geometryType="esriGeometryNull"),c.create(l,e.spatialReference)}))},ce.signatures.push({name:"featureset",min:1,max:1}),ce.functions.filter=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{if(E(s,2,2,e,t),se(s[0])||$(s[0])){const r=[];let i,o=s[0];if(o instanceof x&&(o=o.toArray()),!O(s[1]))throw new n(e,a.InvalidParameter,t);i=s[1].createFunction(e);for(const e of o){const t=i(e);K(t)?!0===await t&&r.push(e):!0===t&&r.push(e)}return r}if(L(s[0])){const t=await s[0].load(),r=_.create(s[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),i=r.getVariables();if(i.length>0){const t={};for(const r of i)t[r]=ce.evaluateIdentifier(e,{name:r});r.parameters=t}return new d({parentfeatureset:s[0],whereclause:r})}throw new n(e,a.InvalidParameter,t)}))},ce.signatures.push({name:"filter",min:2,max:2}),ce.functions.orderby=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{if(E(s,2,2,e,t),L(s[0])){const e=new f(s[1]);return new y({parentfeatureset:s[0],orderbyclause:e})}throw new n(e,a.InvalidParameter,t)}))},ce.signatures.push({name:"orderby",min:2,max:2}),ce.functions.top=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{if(E(s,2,2,e,t),L(s[0]))return new j({parentfeatureset:s[0],topnum:s[1]});if(se(s[0]))return V(s[1])>=s[0].length?s[0].slice():s[0].slice(0,V(s[1]));if($(s[0]))return V(s[1])>=s[0].length()?s[0].slice():s[0].slice(0,V(s[1]));throw new n(e,a.InvalidParameter,t)}))},ce.signatures.push({name:"top",min:2,max:2}),ce.functions.first=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,s,o)=>{if(E(o,1,1,e,t),L(o[0])){const t=await o[0].first(r.abortSignal);if(null!==t){const r=i.createFromGraphicLikeObject(t.geometry,t.attributes,o[0],e.timeZone);return r._underlyingGraphic=t,r}return t}return se(o[0])?0===o[0].length?null:o[0][0]:$(o[0])?0===o[0].length()?null:o[0].get(0):null}))},ce.signatures.push({name:"first",min:1,max:1}),ce.functions.attachments=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{E(s,1,2,e,t);const l={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(s.length>1)if(s[1]instanceof o){if(s[1].hasField("minsize")&&(l.minsize=V(s[1].field("minsize"))),s[1].hasField("metadata")&&(l.returnMetadata=M(s[1].field("metadata"))),s[1].hasField("maxsize")&&(l.maxsize=V(s[1].field("maxsize"))),s[1].hasField("types")){const e=z(s[1].field("types"),!1);e.length>0&&(l.types=e)}}else if(null!==s[1])throw new n(e,a.InvalidParameter,t);if(Z(s[0])){const t=s[0]._layer;let r;if(L(t))r=t;else{if(null==t||!q(t))return[];r=I(t,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)}return await r.load(),r.queryAttachments(s[0].field(r.objectIdField),l.minsize,l.maxsize,l.types,l.returnMetadata)}if(null===s[0])return[];throw new n(e,a.InvalidParameter,t)}))},ce.signatures.push({name:"attachments",min:1,max:2}),ce.functions.featuresetbyrelationshipname=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{E(s,2,4,e,t);const o=s[0],l=U(s[1]);let m=R(s[2],null);const p=M(R(s[3],!0));if(null===m&&(m=["*"]),!1===se(m))throw new n(e,a.InvalidParameter,t);if(null===s[0])return null;if(!Z(s[0]))throw new n(e,a.InvalidParameter,t);const u=o._layer;let c;if(L(u))c=u;else{if(null==u||!q(u))return null;c=I(u,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)}c=await c.load();const d=c.relationshipMetaData().filter((e=>e.name===l));if(0===d.length)return null;if(void 0!==d[0].relationshipTableId&&null!==d[0].relationshipTableId&&d[0].relationshipTableId>-1)return b(c,d[0],o.field(c.objectIdField),c.spatialReference,m,p,e.lrucache,e.interceptor);let f=c.serviceUrl();if(!f)return null;f="/"===f.charAt(f.length-1)?f+d[0].relatedTableId.toString():f+"/"+d[0].relatedTableId.toString();const y=await g(f,c.spatialReference,m,p,e.lrucache,e.interceptor);await y.load();let j=y.relationshipMetaData();if(j=j.filter((e=>e.id===d[0].id)),!1===o.hasField(d[0].keyField)||null===o.field(d[0].keyField)){const e=await c.getFeatureByObjectId(o.field(c.objectIdField),[d[0].keyField]);if(e){const t=_.create(j[0].keyField+"= @id",{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC});return t.parameters={id:e.attributes[d[0].keyField]},y.filter(t)}return new H({parentfeatureset:y})}const h=_.create(j[0].keyField+"= @id",{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC});return h.parameters={id:o.field(d[0].keyField)},y.filter(h)}))},ce.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),ce.functions.featuresetbyassociation=function(t,r){return ce.standardFunctionAsync(t,r,(async(i,s,o)=>{E(o,2,3,t,r);const l=o[0],p=m(U(R(o[1],""))),u=ie(o[2])?U(o[2]):null;if(null===o[0])return null;if(!Z(o[0]))throw new n(t,a.InvalidParameter,r);let c=l._layer;if(c instanceof J&&(c=I(c,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===c)return null;if(!1===L(c))return null;await c.load();const d=c.serviceUrl(),f=await h(d,t.spatialReference,!0);if(f.unVersion>=8)return await async function(t,r,i,s,o,l,m){const p=await t.getFeatureSetInfo();if(null===(p?.layerId??null))return null;if(!o.layerIdLookup.get(p.layerId))return null;const u=t.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),c=[];switch(i){case"connected":c.push("connectivity"),c.push("junction-edge-from-connectivity"),c.push("junction-edge-to-connectivity"),c.push("junction-edge-midspan-connectivity"),c.push("junction-junction-connectivity");break;case"container":case"content":c.push("containment");break;case"structure":case"attached":c.push("attachment");break;case"junctionedge":c.push("junction-edge-from-connectivity"),c.push("junction-edge-to-connectivity");break;case"midspan":c.push("junction-edge-midspan-connectivity");break;default:throw new n(l,a.InvalidParameter,m)}let d=null,f=!1;if(null!==s&&""!==s&&void 0!==s){for(const e of o.terminals)e.terminalName===s&&(d=e.terminalId);null===d&&(f=!0)}const y=[];if(!f){const s=new te({globalId:r.field(t.globalIdField),networkSourceId:o.layerIdLookup.get(p.layerId).sourceId,...d?{terminalId:d}:""}),n=await ee(u,new re({types:c,elements:[s]}));let a=0;for(const t of n.associations){let r=null,n="",l="";if(t.fromNetworkElement?.globalId===s.globalId?(r=t.toNetworkElement,l="to"):t.toNetworkElement?.globalId===s.globalId&&(r=t.fromNetworkElement,l="from"),!r)continue;switch(i){case"attached":if("attachment"!==t.associationType)continue;if("to"!==l)continue;break;case"structure":if("attachment"!==t.associationType)continue;if("from"!==l)continue;break;case"container":if("containment"!==t.associationType)continue;if("from"!==l)continue;break;case"content":if("containment"!==t.associationType)continue;if("to"!==l)continue;break;case"connected":break;case"junctionedge":"junction-edge-to-connectivity"===t.associationType?n="to":"junction-edge-from-connectivity"===t.associationType&&(n="from");break;case"midspan":if("junction-edge-midspan-connectivity"!==t.associationType)continue}const m=o.sourceIdLookup.get(r.networkSourceId)?.className??"";y.push(new e({geometry:null,attributes:{objectId:a++,globalId:r.globalId,percentAlong:t.percentAlong??0,isContentVisible:t.isContentVisible?0:1,className:m,side:n}}))}}const j=new J({source:y,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new Y({name:"objectId",alias:"objectId",type:"oid"}),new Y({name:"globalId",alias:"globalId",type:"global-id"}),new Y({name:"percentAlong",alias:"percentAlong",type:"double"}),new Y({name:"side",alias:"side",type:"string"}),new Y({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new Y({name:"className",alias:"className",type:"string"})]});return I(j)}(c,l,p,u,f,t,r);const y=f.associations;let j=null,b=null,g=!1;if(null!==u&&""!==u&&void 0!==u){for(const e of f.terminals)e.terminalName===u&&(b=e.terminalId);null===b&&(g=!0)}const x=y.getFieldsIndex(),C=x.get("TOGLOBALID").name,A=x.get("FROMGLOBALID").name,v=x.get("TOTERMINALID").name,N=x.get("FROMTERMINALID").name,k=x.get("FROMNETWORKSOURCEID").name,P=x.get("TONETWORKSOURCEID").name,M=x.get("ASSOCIATIONTYPE").name,$=x.get("ISCONTENTVISIBLE").name,O=x.get("OBJECTID").name;for(const e of c.fields)if("global-id"===e.type){j=l.field(e.name);break}let V=null,z=new w(new Y({name:"percentalong",alias:"percentalong",type:"double"}),_.create("0",{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC})),G=new w(new Y({name:"side",alias:"side",type:"string"}),_.create("''",{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC}));const H="globalid",W="globalId",q={};for(const e in f.lkp)q[e]=f.lkp[e].sourceId;const K=new F(new Y({name:"classname",alias:"classname",type:"string"}),null,q);let X="";switch(p){case"midspan":{X=`((${C}='${j}') OR ( ${A}='${j}')) AND (${M} IN (5))`,K.codefield=_.create(`CASE WHEN (${C}='${j}') THEN ${k} ELSE ${P} END`,{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC});const e=Q(D.findField(y.fields,A));e.name=H,e.alias=H,V=new w(e,_.create(`CASE WHEN (${A}='${j}') THEN ${C} ELSE ${A} END`,{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC})),z=f.unVersion>=4?new S(D.findField(y.fields,x.get("PERCENTALONG").name)):new w(new Y({name:"percentalong",alias:"percentalong",type:"double"}),_.create("0",{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{X=`((${C}='${j}') OR ( ${A}='${j}')) AND (${M} IN (4,6))`,K.codefield=_.create(`CASE WHEN (${C}='${j}') THEN ${k} ELSE ${P} END`,{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC});const e=Q(D.findField(y.fields,A));e.name=H,e.alias=H,V=new w(e,_.create(`CASE WHEN (${A}='${j}') THEN ${C} ELSE ${A} END`,{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC})),G=new w(new Y({name:"side",alias:"side",type:"string"}),_.create(`CASE WHEN (${M}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let e=`${C}='@T'`,t=`${A}='@T'`;null!==b&&(e+=` AND ${v}=@A`,t+=` AND ${N}=@A`),X="(("+e+") OR ("+t+"))",X=B(X,"@T",j??""),e=B(e,"@T",j??""),null!==b&&(e=B(e,"@A",b.toString()),X=B(X,"@A",b.toString())),K.codefield=_.create("CASE WHEN "+e+` THEN ${k} ELSE ${P} END`,{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC});const r=Q(D.findField(y.fields,A));r.name=H,r.alias=H,V=new w(r,_.create("CASE WHEN "+e+` THEN ${A} ELSE ${C} END`,{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC}));break}case"container":X=`${C}='${j}' AND ${M} = 2`,null!==b&&(X+=` AND ${v} = `+b.toString()),K.codefield=k,X="( "+X+" )",V=new T(D.findField(y.fields,A),H,H);break;case"content":X=`(${A}='${j}' AND ${M} = 2)`,null!==b&&(X+=` AND ${N} = `+b.toString()),K.codefield=P,X="( "+X+" )",V=new T(D.findField(y.fields,C),H,H);break;case"structure":X=`(${C}='${j}' AND ${M} = 3)`,null!==b&&(X+=` AND ${v} = `+b.toString()),K.codefield=k,X="( "+X+" )",V=new T(D.findField(y.fields,A),H,W);break;case"attached":X=`(${A}='${j}' AND ${M} = 3)`,null!==b&&(X+=` AND ${N} = `+b.toString()),K.codefield=P,X="( "+X+" )",V=new T(D.findField(y.fields,C),H,W);break;default:throw new n(t,a.InvalidParameter,r)}return g&&(X="1 <> 1"),new D({parentfeatureset:y,adaptedFields:[new S(D.findField(y.fields,O)),new S(D.findField(y.fields,$)),V,G,K,z],extraFilter:X?_.create(X,{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC}):null})}))},ce.signatures.push({name:"featuresetbyassociation",min:2,max:6}),ce.functions.groupby=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{if(E(s,3,3,e,t),!L(s[0]))throw new n(e,a.InvalidParameter,t);const l=await s[0].load(),m=[],p=[];let u=!1,c=[];if(ie(s[1]))c.push(s[1]);else if(s[1]instanceof o)c.push(s[1]);else if(se(s[1]))c=s[1];else{if(!$(s[1]))throw new n(e,a.InvalidParameter,t);c=s[1].toArray()}for(const r of c)if(ie(r)){const e=_.create(U(r),{fieldsIndex:l.getFieldsIndex(),timeZone:l.dateFieldsTimeZoneDefaultUTC}),t=!0===W(e)?U(r):"%%%%FIELDNAME";m.push({name:t,expression:e}),"%%%%FIELDNAME"===t&&(u=!0)}else{if(!(r instanceof o))throw new n(e,a.InvalidParameter,t);{const i=r.hasField("name")?r.field("name"):"%%%%FIELDNAME",s=r.hasField("expression")?r.field("expression"):"";if("%%%%FIELDNAME"===i&&(u=!0),!i)throw new n(e,a.InvalidParameter,t);m.push({name:i,expression:_.create(s||i,{fieldsIndex:l.getFieldsIndex(),timeZone:l.dateFieldsTimeZoneDefaultUTC})})}}if(c=[],ie(s[2]))c.push(s[2]);else if(se(s[2]))c=s[2];else if($(s[2]))c=s[2].toArray();else{if(!(s[2]instanceof o))throw new n(e,a.InvalidParameter,t);c.push(s[2])}for(const r of c){if(!(r instanceof o))throw new n(e,a.InvalidParameter,t);{const i=r.hasField("name")?r.field("name"):"",s=r.hasField("statistic")?r.field("statistic"):"",o=r.hasField("expression")?r.field("expression"):"";if(!(i&&s&&ie(s)&&o))throw new n(e,a.InvalidParameter,t);p.push({name:i,statistic:s,expression:_.create(o,{fieldsIndex:l.getFieldsIndex(),timeZone:l.dateFieldsTimeZoneDefaultUTC})})}}if(u){const e={};for(const t of l.fields)e[t.name.toLowerCase()]=1;for(const t of m)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);for(const t of p)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of m)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const t of m)ne(t.expression,ce,e);for(const t of p)ne(t.expression,ce,e);return s[0].groupby(m,p)}))},ce.signatures.push({name:"groupby",min:3,max:3}),ce.functions.distinct=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,l)=>{if(L(l[0])){E(l,2,2,e,t);const r=await l[0].load(),i=[];let s=[];if(ie(l[1]))s.push(l[1]);else if(l[1]instanceof o)s.push(l[1]);else if(se(l[1]))s=l[1];else{if(!$(l[1]))throw new n(e,a.InvalidParameter,t);s=l[1].toArray()}let m=!1;for(const l of s)if(ie(l)){const e=_.create(U(l),{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}),t=!0===W(e)?U(l):"%%%%FIELDNAME";i.push({name:t,expression:e}),"%%%%FIELDNAME"===t&&(m=!0)}else{if(!(l instanceof o))throw new n(e,a.InvalidParameter,t);{const s=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",o=l.hasField("expression")?l.field("expression"):"";if("%%%%FIELDNAME"===s&&(m=!0),!s)throw new n(e,a.InvalidParameter,t);i.push({name:s,expression:_.create(o||s,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})})}}if(m){const e={};for(const t of r.fields)e[t.name.toLowerCase()]=1;for(const t of i)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of i)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const t of i)ne(t.expression,ce,e);return l[0].groupby(i,[])}return function(e){if(1===e.length){if(se(e[0]))return s("distinct",e[0],-1);if($(e[0]))return s("distinct",e[0].toArray(),-1)}return s("distinct",e,-1)}(l)}))},ce.functions.getfeaturesetinfo=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{if(E(s,1,1,e,t),!L(s[0]))return null;const n=await s[0].getFeatureSetInfo();return n?o.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},N(e),!1,!1):null}))},ce.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),ce.functions.filterbysubtypecode=function(e,t){return ce.standardFunctionAsync(e,t,(async(r,i,s)=>{if(E(s,2,2,e,t),L(s[0])){const r=await s[0].load(),i=s[1];if(!oe(i))throw new n(e,a.InvalidParameter,t);if(r.subtypeField){const e=_.create(`${r.subtypeField}= ${s[1]}`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});return new d({parentfeatureset:s[0],whereclause:e})}if(null===r.typeIdField||""===r.typeIdField)throw new n(e,a.FeatureSetDoesNotHaveSubtypes,t);const o=_.create(`${r.typeIdField}= ${s[1]}`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});return new d({parentfeatureset:s[0],whereclause:o})}throw new n(e,a.InvalidParameter,t)}))},ce.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{ce as registerFunctions};
