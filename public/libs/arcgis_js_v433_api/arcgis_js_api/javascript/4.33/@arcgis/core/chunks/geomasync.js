/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{k as t,t as n,p as e,l as r,m as i,n as o,o as a,q as s,s as l}from"./arcade.js";import{D as c}from"./aiServices.js";import{A as u,E as f}from"./enum.js";import{c as m}from"./TimeOnly.js";import{x as d,p,i as w,y as j,z as y,n as h,c as g,B as S,f as N,C as O,b as v,D as P,E as J,t as A,F as I,G as F,H as b}from"./languageUtils.js";import{g as R}from"./portalUtils.js";import{i as U}from"./operatorsWorkerConnection.js";import{e as x}from"../core/lang.js";import D from"../geometry/Extent.js";import C from"../geometry/Geometry.js";import L from"../geometry/Multipoint.js";import k from"../geometry/Point.js";import T from"../geometry/Polygon.js";import E from"../geometry/Polyline.js";import{fromJSON as M}from"../geometry/support/jsonUtils.js";import q from"../portal/Portal.js";import{l as z}from"./utils9.js";import{a as Z}from"./guards.js";import"../core/Accessor.js";import"../core/Handles.js";import"./Logger.js";import"../config.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"./MapUtils.js";import"./Warning.js";import"../core/Error.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./events.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./deepClone.js";import"./featureConversionUtils.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./OptimizedFeature.js";import"./memoryEstimations.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./createFeatureId.js";import"../layers/support/FieldsIndex.js";import"./UnknownTimeZone.js";import"./datetime.js";import"./jsonUtils.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./constants.js";import"./timeZoneUtils.js";import"./ImmutableArray.js";import"./locale.js";import"./shared2.js";import"../layers/support/Field.js";import"./tslib.es6.js";import"./jsonMap.js";import"../core/JSONSupport.js";import"./enumeration.js";import"./reader.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../core/sql/WhereClause.js";import"./coordsUtils.js";import"./Axis.js";import"./unitUtils.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"./unitConversion.js";import"./number.js";import"./hash.js";import"./uuid.js";import"../geometry/SpatialReference.js";import"./writer.js";import"./utils10.js";import"./commonProperties3.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"./SimpleObservable.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./date.js";import"./number2.js";import"./substitute.js";import"./messages.js";import"../geometry/support/webMercatorUtils.js";import"./zmUtils.js";import"../core/accessorSupport/decorators/cast.js";import"./extentUtils.js";import"./boundsUtils.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";function B(t){if(null==t)return t;switch(typeof t){case"string":case"number":return t;default:throw new u(null,f.InvalidParameter,null)}}function G(G){"async"===G.mode&&(G.functions.disjoint=function(n,e){return G.standardFunctionAsync(n,e,((r,i,o)=>(o=d(o),t(o,n,e),null===o[0]||null===o[1]||U("disjoint",[o[0].toJSON(),o[1].toJSON()]))))},G.functions.intersects=function(n,e){return G.standardFunctionAsync(n,e,((r,i,o)=>(o=d(o),t(o,n,e),null!==o[0]&&null!==o[1]&&U("intersects",[o[0].toJSON(),o[1].toJSON()]))))},G.functions.touches=function(n,e){return G.standardFunctionAsync(n,e,((r,i,o)=>(o=d(o),t(o,n,e),null!==o[0]&&null!==o[1]&&U("touches",[o[0].toJSON(),o[1].toJSON()]))))},G.functions.crosses=function(n,e){return G.standardFunctionAsync(n,e,((r,i,o)=>(o=d(o),t(o,n,e),null!==o[0]&&null!==o[1]&&U("crosses",[o[0].toJSON(),o[1].toJSON()]))))},G.functions.within=function(n,e){return G.standardFunctionAsync(n,e,((r,i,o)=>(o=d(o),t(o,n,e),null!==o[0]&&null!==o[1]&&U("within",[o[0].toJSON(),o[1].toJSON()]))))},G.functions.contains=function(n,e){return G.standardFunctionAsync(n,e,((r,i,o)=>(o=d(o),t(o,n,e),null!==o[0]&&null!==o[1]&&U("contains",[o[0].toJSON(),o[1].toJSON()]))))},G.functions.overlaps=function(n,e){return G.standardFunctionAsync(n,e,((r,i,o)=>(o=d(o),t(o,n,e),null!==o[0]&&null!==o[1]&&U("overlaps",[o[0].toJSON(),o[1].toJSON()]))))},G.functions.equals=function(t,n){return G.standardFunctionAsync(t,n,((e,r,i)=>(p(i,2,2,t,n),i[0]===i[1]||(i[0]instanceof C&&i[1]instanceof C?U("equals",[i[0].toJSON(),i[1].toJSON()]):(w(i[0])&&w(i[1])||!!(j(i[0])&&j(i[1])||y(i[0])&&y(i[1])))&&i[0].equals(i[1])))))},G.functions.relate=function(t,n){return G.standardFunctionAsync(t,n,((e,r,i)=>{if(i=d(i),p(i,3,3,t,n),i[0]instanceof C&&i[1]instanceof C)return U("relate",[i[0].toJSON(),i[1].toJSON(),h(i[2])]);if(i[0]instanceof C&&null===i[1])return!1;if(i[1]instanceof C&&null===i[0])return!1;if(null===i[0]&&null===i[1])return!1;throw new u(t,f.InvalidParameter,n)}))},G.functions.intersection=function(n,e){return G.standardFunctionAsync(n,e,(async(r,i,o)=>(o=d(o),t(o,n,e),null===o[0]||null===o[1]?null:M(await U("intersection",[o[0].toJSON(),o[1].toJSON()])))))},G.functions.union=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(0===(i=d(i)).length)throw new u(t,f.WrongNumberOfParameters,n);const o=[];if(1===i.length)if(Z(i[0])){for(const e of d(i[0]))if(null!==e){if(!(e instanceof C))throw new u(t,f.InvalidParameter,n);o.push(e.toJSON())}}else{if(!g(i[0])){if(i[0]instanceof C)return S(m(i[0]),t.spatialReference);if(null===i[0])return null;throw new u(t,f.InvalidParameter,n)}for(const e of d(i[0].toArray()))if(null!==e){if(!(e instanceof C))throw new u(t,f.InvalidParameter,n);o.push(e.toJSON())}}else for(const e of i)if(null!==e){if(!(e instanceof C))throw new u(t,f.InvalidParameter,n);o.push(e.toJSON())}return 0===o.length?null:M(await U("union",[o]))}))},G.functions.difference=function(n,e){return G.standardFunctionAsync(n,e,(async(r,i,o)=>(o=d(o),t(o,n,e),null===o[0]?null:null===o[1]?m(o[0]):M(await U("difference",[o[0].toJSON(),o[1].toJSON()])))))},G.functions.symmetricdifference=function(n,e){return G.standardFunctionAsync(n,e,(async(r,i,o)=>(o=d(o),t(o,n,e),null===o[0]&&null===o[1]?null:null===o[0]?m(o[1]):null===o[1]?m(o[0]):M(await U("symmetricDifference",[o[0].toJSON(),o[1].toJSON()])))))},G.functions.clip=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,2,2,t,n),!(i[1]instanceof D)&&null!==i[1])throw new u(t,f.InvalidParameter,n);if(null===i[0])return null;if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);return null===i[1]?null:M(await U("clip",[i[0].toJSON(),i[1].toJSON()]))}))},G.functions.cut=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,2,2,t,n),!(i[1]instanceof E)&&null!==i[1])throw new u(t,f.InvalidParameter,n);if(null===i[0])return[];if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);return null===i[1]?[m(i[0])]:(await U("cut",[i[0].toJSON(),i[1].toJSON()])).map((t=>M(t)))}))},G.functions.area=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(p(i,1,2,t,n),i=d(i),N(i[0])){const e=await i[0].sumArea(B(i[1]),null,t.abortSignal);if(t.abortSignal.aborted)throw new u(t,f.Cancelled,n);return e}let o=i[0];if((Z(o)||g(o))&&(o=O(i[0],t.spatialReference)),null===o)return 0;if(!(o instanceof C))throw new u(t,f.InvalidParameter,n);return U("area",[o.toJSON(),B(i[1])])}))},G.functions.areageodetic=function(t,e){return G.standardFunctionAsync(t,e,(async(r,i,o)=>{p(o,1,3,t,e);let a=(o=d(o))[0];(Z(a)||g(a))&&(a=O(a,t.spatialReference));const s=B(o[1]),l=n(o[2]);if(N(a)){const n=await a.sumArea(s,l,t.abortSignal);if(t.abortSignal.aborted)throw new u(t,f.Cancelled,e);return n}if(null==a)return 0;if(!v(a))throw new u(t,f.InvalidParameter,e);return U("geodeticArea",[a.toJSON(),s,l])}))},G.functions.length=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(p(i,1,2,t,n),i=d(i),N(i[0])){const e=await i[0].sumLength(B(i[1]),null,t.abortSignal);if(t.abortSignal.aborted)throw new u(t,f.Cancelled,n);return e}let o=i[0];if((Z(i[0])||g(i[0]))&&(o=P(i[0],t.spatialReference)),null===o)return 0;if(!(o instanceof C))throw new u(t,f.InvalidParameter,n);return U("length",[o.toJSON(),B(i[1])])}))},G.functions.length3d=function(t,n){return G.standardFunctionAsync(t,n,(async(r,i,o)=>{if(p(o,1,2,t,n),null===(o=d(o))[0])return 0;let a=o[0];if((Z(o[0])||g(o[0]))&&(a=P(o[0],t.spatialReference)),null===a)return 0;if(!(a instanceof C))throw new u(t,f.InvalidParameter,n);if(!0===a.hasZ){const{convertFromSpatialReferenceUnit:t,toLengthUnit:n}=await import("./unitConversion.js"),r=e(a);return t(a.spatialReference,n(o[1]),r)}return U("length",[a.toJSON(),B(o[1])])}))},G.functions.lengthgeodetic=function(t,e){return G.standardFunctionAsync(t,e,(async(r,i,o)=>{p(o,1,3,t,e);let a=(o=d(o))[0];(Z(o[0])||g(o[0]))&&(a=P(o[0],t.spatialReference));const s=B(o[1]),l=n(o[2]);if(N(a)){const n=await a.sumLength(s,l,t.abortSignal);if(t.abortSignal.aborted)throw new u(t,f.Cancelled,e);return n}if(null===a)return 0;if(!v(a))throw new u(t,f.InvalidParameter,e);return U("geodeticLength",[a.toJSON(),s,l])}))},G.functions.distance=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{i=d(i),p(i,2,3,t,n);let o=i[0];if((Z(i[0])||g(i[0]))&&(o=J(i[0],t.spatialReference)),!(o instanceof C))throw new u(t,f.InvalidParameter,n);let a=i[1];if((Z(i[1])||g(i[1]))&&(a=J(i[1],t.spatialReference)),!(a instanceof C))throw new u(t,f.InvalidParameter,n);return U("distance",[o.toJSON(),a.toJSON(),B(i[2])])}))},G.functions.distancegeodetic=function(t,e){return G.standardFunctionAsync(t,e,(async(r,i,o)=>{o=d(o),p(o,2,4,t,e);const a=o[0];if(!(a instanceof k))throw new u(t,f.InvalidParameter,e);const s=o[1];if(!(s instanceof k))throw new u(t,f.InvalidParameter,e);const l=new E({paths:[],spatialReference:a.spatialReference});return l.addPath([a,s]),U("geodeticLength",[l.toJSON(),B(o[2]),n(o[3])])}))},G.functions.densify=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,2,3,t,n),null===i[0])return null;if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);const o=A(i[1]);if(isNaN(o))throw new u(t,f.InvalidParameter,n);if(o<=0)throw new u(t,f.InvalidParameter,n);switch(i[0].type){case"polygon":case"polyline":case"extent":return M(await U("densify",[i[0].toJSON(),o,B(i[2])]));default:return i[0]}}))},G.functions.densifygeodetic=function(t,e){return G.standardFunctionAsync(t,e,(async(r,i,o)=>{o=d(o),p(o,2,4,t,e);const a=o[0];if(null==a)return null;if(!v(a))throw new u(t,f.InvalidParameter,e);const s=A(o[1]);if(isNaN(s))throw new u(t,f.InvalidParameter,e);if(s<=0)throw new u(t,f.InvalidParameter,e);const l=B(o[2]),c=n(o[3]);switch(a.type){case"polygon":case"polyline":case"extent":return M(await U("geodeticDensify",[a.toJSON(),s,l,c]));default:return a}}))},G.functions.generalize=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,2,4,t,n),null===i[0])return null;if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);const o=A(i[1]);if(isNaN(o))throw new u(t,f.InvalidParameter,n);const a=I(F(i[2],!0));return M(await U("generalize",[i[0].toJSON(),o,B(i[3]),{removeDegenerateParts:a}]))}))},G.functions.buffer=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,2,3,t,n),null===i[0])return null;if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);const o=A(i[1]);if(isNaN(o))throw new u(t,f.InvalidParameter,n);return 0===o?m(i[0]):M(await U("buffer",[i[0].toJSON(),o,B(i[2])]))}))},G.functions.buffergeodetic=function(t,e){return G.standardFunctionAsync(t,e,(async(r,i,o)=>{o=d(o),p(o,2,4,t,e);const a=o[0];if(null==a)return null;if(!v(a))throw new u(t,f.InvalidParameter,e);const s=A(o[1]);if(isNaN(s))throw new u(t,f.InvalidParameter,e);if(0===s)return m(a);const l=B(o[2]),c=n(o[3]);return M(await U("geodesicBuffer",[a.toJSON(),s,l,c]))}))},G.functions.offset=function(t,n){return G.standardFunctionAsync(t,n,(async(e,i,o)=>{if(o=d(o),p(o,2,6,t,n),null===o[0])return null;if(!(o[0]instanceof T||o[0]instanceof E))throw new u(t,f.InvalidParameter,n);const a=A(o[1]);if(isNaN(a))throw new u(t,f.InvalidParameter,n);const s=r(o[3]),l=A(F(o[4],10));if(isNaN(l))throw new u(t,f.InvalidParameter,n);const c=A(F(o[5],0));if(isNaN(c))throw new u(t,f.InvalidParameter,n);return M(await U("offset",[o[0].toJSON(),a,B(o[2]),{joins:s,miterLimit:l,flattenError:c}]))}))},G.functions.rotate=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,2,3,t,n),null===i[0])return null;if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);const o=i[0]instanceof D?T.fromExtent(i[0]):i[0],a=A(i[1]);if(isNaN(a))throw new u(t,f.InvalidParameter,n);const s=F(i[2],null);if(null===s){const t="point"===o.type?o:o.extent?.center;return M(await U("rotate",[o.toJSON(),a,t?.x,t?.y]))}if(s instanceof k)return M(await U("rotate",[o.toJSON(),a,s.x,s.y]));throw new u(t,f.InvalidParameter,n)}))},G.functions.centroid=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,o)=>{if(o=d(o),p(o,1,2,t,n),null===o[0])return null;const a=i(o[1]);let s=o[0];if((Z(o[0])||g(o[0]))&&(s="geometric"===a?J(o[0],t.spatialReference):O(o[0],t.spatialReference),null===s))return null;if(!(s instanceof C))throw new u(t,f.InvalidParameter,n);return M("geometric"===a?await U("centroid",[s.toJSON()]):await U("labelPoint",[s.toJSON()]))}))},G.functions.measuretocoordinate=function(t,n){return G.standardFunctionAsync(t,n,o)},G.functions.pointtocoordinate=function(t,n){return G.standardFunctionAsync(t,n,a)},G.functions.distancetocoordinate=function(t,n){return G.standardFunctionAsync(t,n,s)},G.functions.multiparttosinglepart=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,1,1,t,n),null===i[0])return null;if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);if(i[0]instanceof k)return[S(m(i[0]),t.spatialReference)];if(i[0]instanceof D)return[S(m(i[0]),t.spatialReference)];const o=M(await U("simplify",[i[0].toJSON()]));if(o instanceof T){const t=[],n=[];for(let e=0;e<o.rings.length;e++)if(o.isClockwise(o.rings[e])){const n=M({rings:[o.rings[e]],hasZ:!0===o.hasZ,hasM:!0===o.hasM,spatialReference:o.spatialReference.toJSON()});t.push(n)}else n.push({ring:o.rings[e],pt:o.getPoint(e,0)});for(let e=0;e<n.length;e++)for(let r=0;r<t.length;r++)if(t[r].contains(n[e].pt)){t[r].addRing(n[e].ring);break}return t}if(o instanceof E){const t=[];for(let n=0;n<o.paths.length;n++){const e=M({paths:[o.paths[n]],hasZ:!0===o.hasZ,hasM:!0===o.hasM,spatialReference:o.spatialReference.toJSON()});t.push(e)}return t}if(i[0]instanceof L){const n=[],e=S(m(i[0]),t.spatialReference);for(let t=0;t<e.points.length;t++)n.push(e.getPoint(t));return n}return null}))},G.functions.isselfintersecting=function(t,n){return G.standardFunctionAsync(t,n,(async(t,n,e)=>{p(e,1,1,t,n);let r=(e=d(e))[0];if((Z(e[0])||g(e[0]))&&(r=P(e[0],t.spatialReference)),r instanceof L){const t=r.points;for(let n=0;n<t.length;n++)for(let e=n+1;e<t.length;e++)if(x(t[n],t[e]))return!0;return!1}return(r instanceof E||r instanceof T)&&await U("isSelfIntersecting",[r.toJSON()])}))},G.functions.issimple=function(t,n){return G.standardFunctionAsync(t,n,((e,r,i)=>{if(i=d(i),p(i,1,1,t,n),null===i[0])return!0;if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);return U("isSimple",[i[0].toJSON()])}))},G.functions.simplify=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,1,1,t,n),null===i[0])return null;if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);return M(await U("simplify",[i[0].toJSON()]))}))},G.functions.convexhull=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,1,1,t,n),null===i[0])return null;if(!(i[0]instanceof C))throw new u(t,f.InvalidParameter,n);return M(await U("convexHull",[i[0].toJSON()]))}))},G.functions.getuser=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{p(i,0,2,t,n);let o=F(i[1],""),a=!0===o;if(o=!0===o||!1===o?"":h(o),0===i.length||i[0]instanceof l){let n;n=t.services?.portal?t.services.portal:q.getDefault(),i.length>0&&(n=R(i[0],n));const e=await z(n,o,a);if(e){const n=JSON.parse(JSON.stringify(e));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return c.convertObjectToArcadeDictionary(n,b(t))}return null}let s=null;if(N(i[0])&&(s=i[0]),s){if(a=!1,o)return null;await s.load();const n=await s.getOwningSystemUrl();if(!n){if(!o){const n=await s.getIdentityUser();return n?c.convertObjectToArcadeDictionary({username:n},b(t)):null}return null}let e;e=t.services?.portal?t.services.portal:q.getDefault(),e=R(new l(n),e);const r=await z(e,o,a);if(r){const n=JSON.parse(JSON.stringify(r));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return c.convertObjectToArcadeDictionary(n,b(t))}return null}throw new u(t,f.InvalidParameter,n)}))},G.functions.nearestcoordinate=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,2,2,t,n),!(i[0]instanceof C||null===i[0]))throw new u(t,f.InvalidParameter,n);if(!(i[1]instanceof k||null===i[1]))throw new u(t,f.InvalidParameter,n);if(null===i[0]||null===i[1])return null;const o=i[0]instanceof D?T.fromExtent(i[0]):i[0],a=await U("getNearestCoordinate",[o.toJSON(),i[1].toJSON(),{calculateLeftRightSide:!0}]);return null===a?null:c.convertObjectToArcadeDictionary({coordinate:M(a.coordinate),distance:a.distance,sideOfLine:0===a.distance?"straddle":a.isRightSide?"right":"left"},b(t),!1,!0)}))},G.functions.nearestvertex=function(t,n){return G.standardFunctionAsync(t,n,(async(e,r,i)=>{if(i=d(i),p(i,2,2,t,n),!(i[0]instanceof C||null===i[0]))throw new u(t,f.InvalidParameter,n);if(!(i[1]instanceof k||null===i[1]))throw new u(t,f.InvalidParameter,n);if(null===i[0]||null===i[1])return null;const o=i[0]instanceof D?T.fromExtent(i[0]):i[0],a=await U("getNearestVertex",[o.toJSON(),i[1].toJSON()]);return null===a?null:c.convertObjectToArcadeDictionary({coordinate:M(a.coordinate),distance:a.distance,sideOfLine:0===a.distance?"straddle":a.isRightSide?"right":"left"},b(t),!1,!0)}))})}export{G as registerFunctions};
