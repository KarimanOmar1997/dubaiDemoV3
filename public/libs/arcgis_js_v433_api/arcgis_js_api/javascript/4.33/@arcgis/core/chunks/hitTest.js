/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import{i as n}from"../core/Handles.js";import{s as i,b as t}from"./screenUtils.js";import{c as r}from"./vec3f64.js";import s from"../geometry/Point.js";import a from"../geometry/SpatialReference.js";import{p as o}from"./projectVectorToVector.js";import{f as c}from"./LayerConstants.js";import{t as l}from"./layerUtils.js";import{d as u}from"./debugFlags2.js";import{I as d,g as p}from"./Intersector2.js";import{S as m,i as f,I as g}from"./IntersectorResult.js";import{a as y,b as h}from"./intersectorUtilsConversions.js";import{t as E}from"./verticalOffsetUtils.js";async function U(e,n,i,r){const s=i?x(e,i):r,a=t(n.x,n.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const o=new d(e.state.viewingMode);o.options.selectionMode=!0,o.options.store=m.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(a,o,s);const c=await async function(e,n,i){const t=new Array;let r,s=null;const a={defer(e){r=e()}};for(let o=0;o<n.length;o++){const c=n[o],u=h(c,e);if(null!=u&&(u===e.map.ground||"type"in u&&l(u.type)))break;const d=y(c,e,a)??await r;if(r=null,null==d)continue;if("graphic"===d.type){if(null==s&&o!==n.length-1&&(s=new Set),null!=s){const e=j(d.graphic);if(s.has(e))continue;s.add(e)}if(!S(i,d.graphic))continue}const p=w(e,c),m=c.distanceInRenderSpace;if("media"===d.type){const e=d.element.toSource(p);t.push({...d,mapPoint:p,distance:m,sourcePoint:e})}else t.push({...d,mapPoint:p,distance:m})}return t}(e,o.results.all,s.graphics),p=o.results.ground,g=h(p,e),E=null!=g&&"type"in g&&l(g.type)?g:null,U={screenPoint:n,results:c,ground:{mapPoint:w(e,p),distance:f(p)?p.distanceInRenderSpace:0,layer:E}};return u.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(U.intersector=o),U}function I(e,n,t,r){const s=t?x(e,t):r,a=!(!s.graphics?.include&&!s.graphics?.exclude),o=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),c=i(n);s.enableDraped=s.include&&!s.include.has(E)||s.exclude?.has(E);const l=e.sceneIntersectionHelper,u=new d(e.state.viewingMode);if(u.options.selectionMode=!0,u.options.store=a||o?m.ALL:m.MIN,u.options.excludeLabels=t?.excludeLabels??!1,l.intersectIntersectorScreen(c,u,s),a||o){for(const n of u.results.all){const i=y(n,e);if(null==i)return w(e,n);if(a&&("graphic"!==i.type||S(s.graphics,i.graphic)))return w(e,n);if(o&&("media"!==i.type||L(s.mediaElements,i.element)))return w(e,n)}return null}return w(e,u.results.min)}function w(e,n,i){return n.getIntersectionPoint(D)?(i=b(e,D,i),n.intersector===g.TERRAIN&&e.basemapTerrain&&(i.z=p(e.basemapTerrain,i)??0),i):null}function j(e){const n=e.sourceLayer,i=e.layer,t=n&&"objectIdField"in n?n:i&&"objectIdField"in i?i:n;if(t){const n=t.objectIdField??c,i=e.attributes?.[n];if(i)return`o-${t.id}-${i}`}return`u-${e.uid}`}function S(e,n){return L(e,j(n))}function L(e,n){return null==e||(null==e.include||e.include.has(n))&&(null==e.exclude||!e.exclude.has(n))}function b(e,n,i){let t=e.spatialReference||a.WGS84;return o(n,e.renderSpatialReference,D,t)?n=D:(t=a.WGS84,o(n,e.renderSpatialReference,D,t)&&(n=D)),i?(i.x=n[0],i.y=n[1],i.z=n[2],i.spatialReference=t):i=new s(n,t),i}function x(e,n){const i=R(e,n.include,N.INCLUDE),t=R(e,n.exclude,N.EXCLUDE);return{include:i.layerViewUids,exclude:t.layerViewUids,graphics:{include:i.graphicUids,exclude:t.graphicUids},mediaElements:{include:i.mediaElements,exclude:t.mediaElements}}}function R(i,t,r,s={layerViewUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!t)return s;if(t instanceof e)!function(e,n){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(n)}(s,j(t)),r===N.INCLUDE&&(null!=i.graphicsView&&t.layer===i?C(s,i.graphicsView.uid):t.layer&&V(s,i,t.layer.uid));else if("layer"in t&&"element"in t)!function(e,n){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(n)}(s,t.element),r===N.INCLUDE&&V(s,i,t.layer.uid);else if(n(t))for(const e of t)e===i.graphics&&null!=i.graphicsView?C(s,i.graphicsView.uid):e===i.map.ground?C(s,E):R(i,e,r,s);else"uid"in t&&V(s,i,t.uid);return s}function V(e,n,i){const t=n.allLayerViews.find((e=>e.layer.uid===i));t&&C(e,t.uid)}function C(e,n){e.layerViewUids||(e.layerViewUids=new Set),e.layerViewUids.add(n)}const D=r();var N;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(N||(N={}));export{b as c,x as e,U as h,I as t};
