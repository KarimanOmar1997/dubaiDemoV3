/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{d as e}from"./colorUtils2.js";import{a as t}from"./devEnvironmentUtils.js";import{i as r}from"./mathUtils.js";import{m as s,b as o,f as n}from"./mat3.js";import{f as a,c as i}from"./mat3f64.js";import{i as l}from"./mat4.js";import{c as u}from"./mat4f64.js";import{O as c}from"./vec2f64.js";import{t as m,k as f,G as d,l as p,n as x,m as h}from"./vec3.js";import{c as T}from"./vec3f64.js";import{q as g,e as b}from"./aaBoundingBox.js";import{n as y,G as w,T as v}from"./Matrix4PassUniform.js";import{d as B,g as R,n as M,y as j,C as S,D as A}from"./BufferView.js";import{b as O,t as C,n as E,f as I}from"./vec32.js";import{t as F,b as L}from"./vec42.js";import{c as P,a as U}from"./indexUtils.js";import{D}from"./DefaultLoadingContext.js";import{i as V}from"./resourceUtils3.js";import{Z as _,O as N}from"./vec2f32.js";import{l as k,p as q}from"./wosrLoader.js";import{N as G}from"./NormalAttribute.glsl.js";import{A as W}from"./orientedBoundingBox.js";import{A as z,C as H,D as Q}from"./basicInterfaces.js";import{V as $}from"./VertexAttribute.js";import{D as K,u as Z,s as J,e as X,a as Y}from"./DefaultMaterial.js";function ee(e){if(null==e)return null;const t=null!=e.offset?e.offset:_,r=null!=e.rotation?e.rotation:0,o=null!=e.scale?e.scale:N,n=a(1,0,0,0,1,0,t[0],t[1],1),l=a(Math.cos(r),-Math.sin(r),0,Math.sin(r),Math.cos(r),0,0,0,1),u=a(o[0],0,0,0,o[1],0,0,0,1),c=i();return s(c,l,u),s(c,n,c),c}class te{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class re{constructor(e,t,r){this.name=e,this.lodThreshold=t,this.pivotOffset=r,this.stageResources=new te,this.numberOfVertices=0}}async function se(s,a){const i=oe(t(s));if("wosr"===i.fileType){const e=await(a.cache?a.cache.loadWOSR(i.url,a):k(i.url,a)),{engineResources:t,referenceBoundingBox:r}=q(e,a);return{lods:t,referenceBoundingBox:r,isEsriSymbolResource:!1,isWosr:!0}}let _;if(a.cache)_=await a.cache.loadGLTF(i.url,a,!!a.usePBR);else{const{loadGLTF:e}=await import("./loader.js");_=await e(new D(a.streamDataRequester),i.url,a,a.usePBR)}const N=_.model.meta?.ESRI_proxyEllipsoid,te=_.meta.isEsriSymbolResource&&null!=N&&"EsriRealisticTreesStyle"===_.meta.ESRI_webstyle;te&&!_.customMeta.esriTreeRendering&&(_.customMeta.esriTreeRendering=!0,function(t,r){for(let s=0;s<t.model.lods.length;++s){const o=t.model.lods[s];for(const n of o.parts){const o=n.attributes.normal;if(null==o)return;const a=n.attributes.position,i=a.count,c=T(),g=T(),b=T(),y=new Float32Array(4*i),w=new Float32Array(3*i),v=l(u(),n.transform);let M=0,j=0;for(let l=0;l<i;l++){a.getVec(l,g),o.getVec(l,c),m(g,g,n.transform),f(b,g,r.center),d(b,b,r.radius);const i=b[2],u=p(b),T=Math.min(.45+.55*u*u,1)**e;d(b,b,r.radius),null!==v&&m(b,b,v),x(b,b),s+1!==t.model.lods.length&&t.model.lods.length>1&&h(b,b,c,i>-1?.2:Math.min(-4*i-3.8,1)),w[M]=b[0],w[M+1]=b[1],w[M+2]=b[2],M+=3,y[j]=T,y[j+1]=T,y[j+2]=T,y[j+3]=1,j+=4}n.attributes.normal=new B(w),n.attributes.color=new R(y)}}}(_,N));const se=!!a.usePBR,ae=_.meta.isEsriSymbolResource?{usePBR:se,isSchematic:!1,treeRendering:te,mrrFactors:X}:{usePBR:se,isSchematic:!1,treeRendering:!1,mrrFactors:Y},ie={...a.materialParameters,treeRendering:te},{engineResources:le,referenceBoundingBox:ue}=function(t,s,a,i,l,u){const m=t.model,f=new Array,d=new Map,p=new Map,x=m.lods.length,h=g();return m.lods.forEach(((t,T)=>{const g=!0===i.skipHighLods&&(x>1&&0===T||x>3&&1===T)||!1===i.skipHighLods&&null!=l&&T!==l;if(g&&0!==T)return;const D=new re(t.name,t.lodThreshold,[0,0,0]);t.parts.forEach((t=>{const l=g?new K({},i):function(t,r,s,o,n,a,i,l,u){const m=t.materials.get(r.material);if(null==m)return null;const{normal:f,color:d,texCoord0:p,tangent:x}=r.attributes,h=r.material+(f?"_normal":"")+(d?"_color":"")+(p?"_texCoord0":"")+(x?"_tangent":""),T=null!=r.attributes.texCoord0,g=null!=r.attributes.normal,b=function(e){switch(e){case"BLEND":return z.Blend;case"MASK":return z.Mask;case"OPAQUE":case null:case void 0:return z.Opaque}}(m.alphaMode);if(!a.has(h)){if(T){const e=(e,r=!1,s=!1)=>{if(null!=e&&!i.has(e)){const o=t.textures.get(e);if(o){const t=o.data,n=r&&!V(t)?l.compressionOptions:void 0;i.set(e,new v(V(t)?t.data:t,{...o.parameters,preMultiplyAlpha:!V(t)&&s,encoding:V(t)?t.encoding:void 0,compressionOptions:n}))}}},r=b!==z.Opaque&&!u;e(m.colorTexture,r,b!==z.Opaque),e(m.normalTexture),e(m.occlusionTexture,!0),e(m.emissiveTexture),e(m.metallicRoughnessTexture,!0)}const s=1/e,f=m.color[0]**s,d=m.color[1]**s,p=m.color[2]**s,x=m.emissiveFactor[0]**s,y=m.emissiveFactor[1]**s,w=m.emissiveFactor[2]**s,B=null!=m.colorTexture&&T?i.get(m.colorTexture):null,R=Z(m),M=null!=m.normalTextureTransform?.scale?m.normalTextureTransform?.scale:c;a.set(h,new K({...o,customDepthTest:Q.Lequal,textureAlphaMode:b,textureAlphaCutoff:m.alphaCutoff,diffuse:[f,d,p],ambient:[f,d,p],opacity:"OPAQUE"===m.alphaMode?1:m.opacity,doubleSided:m.doubleSided,doubleSidedType:"winding-order",cullFace:m.doubleSided?H.None:H.Back,hasVertexColors:!!r.attributes.color,hasVertexTangents:!!r.attributes.tangent,normalType:g?G.Attribute:G.ScreenDerivative,castShadows:!0,receiveShadows:m.receiveShadows,receiveAmbientOcclusion:m.receiveAmbientOcclusion,textureId:null!=B?B.id:void 0,colorMixMode:m.colorMixMode,normalTextureId:null!=m.normalTexture&&T?i.get(m.normalTexture).id:void 0,textureAlphaPremultiplied:null!=B&&!!B.parameters.preMultiplyAlpha,occlusionTextureId:null!=m.occlusionTexture&&T?i.get(m.occlusionTexture).id:void 0,emissiveTextureId:null!=m.emissiveTexture&&T?i.get(m.emissiveTexture).id:void 0,metallicRoughnessTextureId:null!=m.metallicRoughnessTexture&&T?i.get(m.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[x,y,w],mrrFactors:R?J:[m.metallicFactor,m.roughnessFactor,o.mrrFactors[2]],isSchematic:R,colorTextureTransformMatrix:ee(m.colorTextureTransform),normalTextureTransformMatrix:ee(m.normalTextureTransform),scale:[M[0],M[1]],occlusionTextureTransformMatrix:ee(m.occlusionTextureTransform),emissiveTextureTransformMatrix:ee(m.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:ee(m.metallicRoughnessTextureTransform),...n},l))}const y=a.get(h);if(s.stageResources.materials.push(y),T){const e=e=>{null!=e&&s.stageResources.textures.push(i.get(e))};e(m.colorTexture),e(m.normalTexture),e(m.occlusionTexture),e(m.emissiveTexture),e(m.metallicRoughnessTexture)}return y}(m,t,D,s,a,d,p,i,u),{geometry:f,vertexCount:x}=function(e,t){const s=e.attributes.position.count,a=P(e.indices||s,e.primitiveType),i=y(3*s),{typedBuffer:l,typedBufferStride:u}=e.attributes.position;O(i,l,e.transform,3,u);const c=[[$.POSITION,new W(i,a,3,!0)]];if(null!=e.attributes.normal){const t=y(3*s),{typedBuffer:n,typedBufferStride:i}=e.attributes.normal;o(ne,e.transform),C(t,n,ne,3,i),r(ne)&&E(t,t),c.push([$.NORMAL,new W(t,a,3,!0)])}if(null!=e.attributes.tangent){const t=y(4*s),{typedBuffer:o,typedBufferStride:i}=e.attributes.tangent;n(ne,e.transform),F(t,o,ne,4,i),r(ne)&&E(t,t,4),c.push([$.TANGENT,new W(t,a,4,!0)])}if(null!=e.attributes.texCoord0){const t=y(2*s),{typedBuffer:r,typedBufferStride:o}=e.attributes.texCoord0;U(t,r,2,o),c.push([$.UV0,new W(t,a,2,!0)])}const m=e.attributes.color;if(null!=m){const t=new Uint8Array(4*s);4===m.elementCount?m instanceof R?L(t,m,1,255):(m instanceof M||m instanceof j)&&L(t,m,1/255,255):(t.fill(255),m instanceof B?I(t,m.typedBuffer,1,255,4,m.typedBufferStride):(e.attributes.color instanceof S||e.attributes.color instanceof A)&&I(t,m.typedBuffer,1/255,255,4,e.attributes.color.typedBufferStride)),c.push([$.COLOR,new W(t,a,4,!0)])}return{geometry:new w(t,c),vertexCount:s}}(t,l??new K({},i)),_=f.boundingInfo;null!=_&&0===T&&(b(h,_.bbMin),b(h,_.bbMax)),null!=l&&(D.stageResources.geometries.push(f),D.numberOfVertices+=x)})),g||f.push(D)})),{engineResources:f,referenceBoundingBox:h}}(_,ae,ie,a,i.specifiedLodIndex,te);return{lods:le,referenceBoundingBox:ue,isEsriSymbolResource:_.meta.isEsriSymbolResource,isWosr:!1}}function oe(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}const ne=i(),ae=Object.freeze(Object.defineProperty({__proto__:null,fetch:se,parseUrl:oe},Symbol.toStringTag,{value:"Module"}));export{se as f,ee as g,ae as o};
