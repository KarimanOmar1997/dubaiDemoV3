/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{c as r}from"./MD5.js";import{i as t}from"./multiOriginJSONSupportUtils.js";import{isAbsolute as o,isBlobProtocol as s,join as n,blobUrlToBlob as i,getPathExtension as c}from"../core/urlUtils.js";import{g as p}from"./uuid.js";import{g as a}from"./metadata.js";import{n as u}from"../core/Accessor.js";import{propertyJSONMeta as l}from"../core/accessorSupport/decorators/property.js";import{g as m}from"./resourceExtension.js";import{p as d,t as f,M as y,i as g,r as h,b as v}from"./persistableUrlUtils.js";function j(e){const r=e?.origins??[void 0];return(n,i)=>{const p=function(e,r,n){if("resource"===e?.type)return function(e,r,n){const i=a(r,n);return{type:String,read:(e,r,t)=>{const o=h(e,r,t);return i.type===String?o:"function"==typeof i.type?new i.type({url:o}):void 0},write:{isRequired:i.json?.write?.isRequired,writer(r,p,a,l){if(!l?.resources)return"string"==typeof r?void(p[a]=f(r,l)):void(p[a]=r.write({},l));const d=null==(N=r)?null:"string"==typeof N?N:N.url,h=f(d,{...l,verifyItemRelativeUrls:l?.verifyItemRelativeUrls?{writtenUrls:l.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},y.NO),v=i.type!==String&&(!t(this)||l?.origin&&this.originIdOf(n)>u(l.origin)),j={object:this,propertyName:n,value:r,targetUrl:h,dest:p,targetPropertyName:a,context:l,params:e};var N;l?.portalItem&&h&&!o(h)?v&&e?.contentAddressed?U(j):v?function(e){const{context:r,targetUrl:t,params:o,value:s,dest:n,targetPropertyName:i}=e;if(!r.portalItem)return;const p=r.portalItem.resourceFromPath(t),a=I(s,t,r),u=m(a),l=c(p.path),d=o?.compress??!1;u===l?(r.resources&&w({...e,resource:p,content:a,compress:d,updates:r.resources.toUpdate}),n[i]=t):U(e)}(j):function({context:e,targetUrl:r,dest:t,targetPropertyName:o}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(r),compress:!1}),t[o]=r)}(j):l?.portalItem&&(null==h||null!=g(h)||s(h)||v)?U(j):p[a]=h}}}}(e,r,n);switch(e?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:r}=d;return{read:e,write:r}}}}(e,n,i);for(const e of r){const r=l(n,e,i);for(const e in p)r[e]=p[e]}}}function U(t){const{targetUrl:o,params:c,value:a,context:u,dest:l,targetPropertyName:d}=t;if(!u.portalItem)return;const f=v(o),y=I(a,o,u);if(c?.contentAddressed&&"json"!==y.type)return void u.messages?.push(new e("persistable:contentAddressingUnsupported",`Property "${d}" is trying to serializing a resource with content of type ${y.type} with content addressing. Content addressing is only supported for json resources.`,{content:y}));const g=c?.contentAddressed&&"json"===y.type?r(y.jsonString):f?.filename??p(),h=n(c?.prefix??f?.prefix,g),j=`${h}.${m(y)}`;if(c?.contentAddressed&&u.resources&&"json"===y.type){const e=u.resources.toKeep.find((({resource:e})=>e.path===j))??u.resources.toAdd.find((({resource:e})=>e.path===j));if(e)return void(l[d]=e.resource.itemRelativeUrl)}const U=u.portalItem.resourceFromPath(j);s(o)&&u.resources&&u.resources.pendingOperations.push(i(o).then((e=>{U.path=`${h}.${m({type:"blob",blob:e})}`,l[d]=U.itemRelativeUrl})).catch((()=>{})));const N=c?.compress??!1;u.resources&&w({...t,resource:U,content:y,compress:N,updates:u.resources.toAdd}),l[d]=U.itemRelativeUrl}function w({object:e,propertyName:r,updates:t,resource:o,content:s,compress:n}){t.push({resource:o,content:s,compress:n,finish:t=>{!function(e,r,t){"string"==typeof e[r]?e[r]=t.url:e[r].url=t.url}(e,r,t)}})}function I(e,r,t){return"string"==typeof e?{type:"url",url:r}:{type:"json",jsonString:JSON.stringify(e.toJSON(t))}}export{j as p};
