/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{c as t,s as e}from"./vec2.js";import{f as i,Z as n}from"./vec2f64.js";import{c as s}from"./mathUtils.js";import{d as r}from"./debugFlags2.js";function a(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}function h(t){const{size:e}=t.definition,i=t.fontString(e);let n=o.get(i);if(!n){const s=a(d,0,0).getContext("2d");t.setFontProperties(s,e);const r=s.measureText(c);n=new l(r.actualBoundingBoxAscent,r.actualBoundingBoxDescent),o.set(i,n)}return n}const o=new Map;class l{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(t,e){this.maxAscent=t,this.maxDescent=e}}const d={canvas:null},c=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})(),_=1;class g{constructor(t,e,i,n){this.text=t,this._alignment=e,this._parameters=i,this._maxSize=n,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${t}--${this._parameters.key}-${this._alignment}`,this._lines=t.replaceAll(" ","Â ").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let t=this._metrics.firstLineAscent;for(let e=0;e<this._lines.length-1;e++)t+=this._lineSpacing;return t+=this._metrics.lastLineDescent,Math.ceil(t+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const t=a(u,x,x).getContext("2d"),e=this._parameters.definition.pixelRatio,i=this._fontSize*e;this._parameters.setFontProperties(t,i);let n=2*this._haloSize;const s=this._parameters.definition.font;"italic"!==s.style&&"oblique"!==s.style&&"bold"!==s.weight&&"bolder"!==s.weight||(n+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let r=0,o=0,l=0,d=0,c=0;this._lines.forEach(((i,s)=>{const a=t.measureText(i),h=a.width/e,_=h+n;this._textWidths.push(h),this._lineWidths.push(_),r=Math.max(r,_),d=Math.max(d,a.actualBoundingBoxAscent/e),c=Math.max(c,a.actualBoundingBoxDescent/e),0===s&&(o=a.actualBoundingBoxAscent/e),s===this._lines.length-1&&(l=a.actualBoundingBoxDescent/e)}));const _=h(this._parameters),g=Math.max(d,_.maxAscent),f=Math.max(c,_.maxDescent),m=o,p="underline"===this._parameters.definition.font.decoration?f:l,R=r;this._metricsCached=new S(m,p,g,f,R)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*p}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,1)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const t=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(t,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case m.Left:return this._horizontalPadding;case m.Center:return(this.displayWidth-this._lineWidths[t])/2;case m.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[t]}}render(t,e,i){t.save();const n=e/=this.renderPixelRatio,s=i/=this.renderPixelRatio,a=this._haloSize,h=this._firstLineYOffset+this._metrics.firstLineAscent;e+=a,i+=h;const o=this._haloSize>0;o&&this._renderHalo(t,n,s,a,h),this._parameters.setFontProperties(t,this._renderedFontSize);for(let n=0;n<this._lines.length;++n){const s=this._lines[n],r=this._getLineXOffset(n);o&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,s,e+r,i),this._renderLineDecoration(t,e+r,i,this._textWidths[n])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,s,e+this._getLineXOffset(n),i),this._renderLineDecoration(t,e+r,i,this._textWidths[n]),i+=this._lineSpacing}if(r.TEXT_SHOW_BASELINE){t.strokeStyle=R,t.setLineDash([2,2]),t.lineWidth=1;let e=s+h;for(let i=0;i<this._lines.length;++i)this._drawLine(t,[n,e],[n+this.displayWidth,e]),e+=this._lineSpacing}if(r.TEXT_SHOW_BORDER&&(t.strokeStyle=R,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[n,s],[this.displayWidth,this.displayHeight])),this._hasBackground){const e=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,n,s,e),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,e,i,n,s=!1){if("none"===this._parameters.definition.font.decoration||0===n)return;const r=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":i+=2*r;break;case"line-through":i-=.33*this._midLineAscent}const a=s?this._haloSize:0;t.strokeStyle=s?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(r+2*a),t.beginPath(),t.moveTo(this._toRenderUnit(e-a),this._toRenderUnit(i)),t.lineTo(this._toRenderUnit(e+n+a),this._toRenderUnit(i)),t.stroke()}_roundedRect(t,e,i,n){e=this._toRenderUnit(e),i=this._toRenderUnit(i);const r=this.renderedWidth,a=this.renderedHeight;0!==n?(n=s(n,0,Math.floor(a/2)),t.beginPath(),t.moveTo(e,i+n),t.arcTo(e,i,e+n,i,n),t.lineTo(e+r-n,i),t.arcTo(e+r,i,e+r,i+n,n),t.lineTo(e+r,i+a-n),t.arcTo(e+r,i+a,e+r-n,i+a,n),t.lineTo(e+n,i+a),t.arcTo(e,i+a,e,i+a-n,n),t.closePath()):t.rect(e,i,r,a)}_renderHalo(t,e,i,n,s){const r=this.renderedWidth,h=this.renderedHeight,o=a(u,Math.max(r,x),Math.max(h,x)),l=o.getContext("2d");l.clearRect(0,0,r,h),this._parameters.setFontProperties(l,this._renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;const d=this._renderedHaloSize<3;l.lineJoin=d?"miter":"round",d?this._renderHaloEmulated(l,n,s):this._renderHaloNative(l,n,s);let c=s;for(let t=0;t<this._lines.length;++t){const e=this._getLineXOffset(t);this._renderLineDecoration(l,n+e,c,this._textWidths[t],!0),c+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(o,0,0,r,h,this._toRenderUnit(e),this._toRenderUnit(i),r,h),t.globalAlpha=1}_renderHaloEmulated(t,e,i){for(let n=0;n<this._lines.length;++n){const s=this._lines[n],r=this._getLineXOffset(n);for(const[n,a]of f)this._fillText(t,s,e+r+this._haloSize*n,i+this._haloSize*a);i+=this._lineSpacing}}_renderHaloNative(t,e,i){const n=2*this._haloSize;for(let s=0;s<this._lines.length;++s){const r=this._lines[s],a=this._getLineXOffset(s),h=5,o=.1;for(let s=0;s<h;s++){const l=1-(h-1)*o+s*o;t.lineWidth=this._toRenderUnit(l*n),this._strokeText(t,r,e+a,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,e,i,n){t.fillText(e,this._toRenderUnit(i),this._toRenderUnit(n))}_strokeText(t,e,i,n){t.strokeText(e,this._toRenderUnit(i),this._toRenderUnit(n))}_drawLine(t,e,i){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.stroke()}_drawBox(t,e,i){const n=this._toRenderUnit(e[0]),s=this._toRenderUnit(e[1]),r=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),h=Math.floor(n)+.5,o=Math.ceil(n+r)-.5,l=Math.floor(s)+.5,d=Math.ceil(s+a)-.5;t.beginPath(),t.moveTo(h,l),t.lineTo(o,l),t.lineTo(o,d),t.lineTo(h,d),t.lineTo(h,l),t.stroke()}}const f=[];{const t=16;for(let e=0;e<360;e+=360/t)f.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}var m;!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(m||(m={}));const u={canvas:null},p=.2,x=512,R="rgb(255, 0, 255, 0.5)";class S{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(t,e,i,n,s){this.firstLineAscent=t,this.lastLineDescent=e,this.maxLineAscent=i,this.maxLineDescent=n,this.displayWidth=s}}const L=Object.freeze({left:0,center:.5,right:1}),b=Object.freeze({"bottom-left":i(0,0),bottom:i(.5,0),"bottom-right":i(1,0),left:i(0,.5),center:i(.5,.5),right:i(1,.5),"top-left":i(0,1),top:i(.5,1),"top-right":i(1,1)});function y(t){switch(t){case"left":return m.Left;case"right":return m.Right;default:return m.Center}}function T(t){switch(t){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function z(t){switch(t){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function P(t,e){switch(e){case"bottom":return"left"===t?"bottom-left":"right"===t?"bottom-right":"bottom";case"center":return t;case"top":return"left"===t?"top-left":"right"===t?"top-right":"top"}}function W(t){return"middle"===t?"center":t}function U(i,s){switch(i){case"top":return e(s,0,1);case"bottom":return e(s,0,-1);default:return t(s,n)}}export{g as T,W as a,h as b,P as c,_ as d,T as e,z as f,a as g,L as h,b as n,y as t,U as v};
