/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import t from"../Color.js";import{g as o}from"./colorUtils.js";import e from"../core/Error.js";import{l as s}from"./fontUtils.js";import{p as i}from"./screenUtils.js";import{q as r,a as l}from"./quantizationUtils.js";import{g as m,a,b as n,c as p}from"./gfxUtils.js";import{S as c,a as h,r as y,s as u}from"./renderUtils.js";import{b as j}from"../symbols/Font.js";import"./colorUtils2.js";import"./mathUtils.js";import"./ensureType.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./MapUtils.js";import"./vec4.js";import"./common.js";import"./vec4f64.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./metadata.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./tracking.js";import"./Warning.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./events.js";import"./SetUtils.js";import"./SimpleTrackingTarget.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./LRUCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils3.js";import"./defaultCIMValues.js";import"./enums2.js";import"./projector.js";import"./sanitizerUtils.js";import"./svgUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./widgetUtils.js";import"../core/reactiveUtils.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"./utils4.js";import"./asyncUtils.js";import"./vec3f64.js";import"./jsonUtils2.js";import"./parser.js";import"./utils2.js";import"./mat4.js";import"./Symbol3DMaterial.js";import"./materialUtils.js";import"./opacityUtils.js";import"./typeUtils.js";import"../symbols/CIMSymbol.js";import"./enumeration.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./guards.js";import"./datetime.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"./locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils5.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils6.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"./lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";const d="picture-fill",g=c.size,b=c.maxSize,f=c.maxOutlineSize,S=c.lineWidth,w=document.createElement("canvas");function x(t,o,e){if("polygon"===t.type){const s=t.extent,i=0===s.width?1:s.width,l=0===s.height?1:s.height;t=r({originPosition:"upperLeft",scale:[i/o,l/e],translate:[s.xmin,s.ymax]},{},t);let m="";for(let o=0;o<t.rings.length;o++){const e=t.rings[o];for(let t=0;t<e.length;t++){const o=e[t][0],s=e[t][1];let i="";0===t?(i=`M${o.toString()} ${s.toString()}`,""!==m&&(i=` ${i}`),m+=i):t===e.length-1?(i=`l${o.toString()} ${s.toString()} Z`,""!==m&&(i=` ${i}`),m+=i):(i=`l${o.toString()} ${s.toString()}`,""!==m&&(i=` ${i}`),m+=i)}}return m}if("polyline"===t.type){const s=t.extent,i=0===s.width?1:s.width,r=0===s.height?1:s.height;t=l({originPosition:"upperLeft",scale:[i/o,r/e],translate:[s.xmin,s.ymax]},{},t);let m="";for(let o=0;o<t.paths.length;o++){const e=t.paths[o];for(let t=0;t<e.length;t++){const o=e[t][0],s=e[t][1];let i="";0===t?(i=`M${o.toString()} ${s.toString()}`,""!==m&&(i=` ${i}`),m+=i):(i=`l${o.toString()} ${s.toString()}`,""!==m&&(i=` ${i}`),m+=i)}}return m}return""}function M(t,o){const e=w.getContext("2d"),s=[];o&&(o.weight&&s.push(o.weight),o.size&&s.push(o.size+"px"),o.family&&s.push(o.family)),e.font=s.join(" ");const{width:i,actualBoundingBoxLeft:r,actualBoundingBoxRight:l,actualBoundingBoxAscent:m,actualBoundingBoxDescent:a}=e.measureText(t);return{width:Math.ceil(Math.max(i,r+l)),height:Math.ceil(m+a),x:Math.floor(r),y:Math.floor((m-a)/2)}}function L(t){const o=t?.size;return{width:null!=o&&"object"==typeof o&&"width"in o?i(o.width):null,height:null!=o&&"object"==typeof o&&"height"in o?i(o.height):null}}function v(t,o){return t>o?"dark":"light"}function k(t,o){const e="number"==typeof o?.size?o?.size:null,s=null!=e?i(e):null,r=null!=o?.maxSize?i(o.maxSize):null;let l="angle"in t?t.angle:null;null!=o?.rotation&&(l=(l??0)+o.rotation);const p=m(t);let c=a(t);"dark"!==z(t,245)||o?.ignoreWhiteSymbols||(c={width:.75,...c,color:"#bdc3c7"});let h=null;const y={shape:null,fill:p,stroke:c,offset:[0,0]};c?.width&&(c.width=Math.min(c.width,f));const j=c?.width||0;let w=null!=o?.size&&(null==o?.scale||o?.scale),v=0,k=0,U=!1;switch(t.type){case"simple-marker":{const e=t.style,{width:m,height:a}=L(o);let n=m===a&&null!=m?m:null!=s?s:Math.min(i(t.size),r||b);if(!0===o?.useMarkerSymbolSize&&null!==m&&null!==a){const o=Math.min(i(t.size),r||b);n=o>m&&o>a?Math.min(m,a):o}switch(v=n,k=n,e){case"circle":y.shape={type:"circle",cx:0,cy:0,r:.5*n},w||(v+=j,k+=j);break;case"cross":y.shape={type:"path",path:[{command:"M",values:[0,.5*k]},{command:"L",values:[v,.5*k]},{command:"M",values:[.5*v,0]},{command:"L",values:[.5*v,k]}]};break;case"diamond":y.shape={type:"path",path:[{command:"M",values:[0,.5*k]},{command:"L",values:[.5*v,0]},{command:"L",values:[v,.5*k]},{command:"L",values:[.5*v,k]},{command:"Z",values:[]}]},w||(v+=j,k+=j);break;case"square":y.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[v,0]},{command:"L",values:[v,k]},{command:"L",values:[0,k]},{command:"Z",values:[]}]},w||(v+=j,k+=j),l&&(U=!0);break;case"triangle":y.shape={type:"path",path:[{command:"M",values:[.5*v,0]},{command:"L",values:[v,k]},{command:"L",values:[0,k]},{command:"Z",values:[]}]},w||(v+=j,k+=j),l&&(U=!0);break;case"x":y.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[v,k]},{command:"M",values:[v,0]},{command:"L",values:[0,k]}]},l&&(U=!0);break;case"path":y.shape={type:"path",path:t.path||""},w||(v+=j,k+=j),l&&(U=!0),w=!0}break}case"simple-line":{const{width:t,height:e}=L(o),i=n(c).reduce(((t,o)=>t+o),0),r=i&&Math.ceil(S/i),l=e??s??j,m=t??(i*r||S);if(w=!0,"polyline"===o?.geometry?.type&&o?.geometry?.extent){v=m,k=e??v;const t=1e3,s=.15*t;h=[v,k],k=h[0]>h[1]?t*h[1]/h[0]:t,v=h[0]>h[1]?t:t*h[0]/h[1],c?.width&&(c.width=c.width*t/(h[1]>h[0]?h[1]:h[0]),c.width>s&&(c.width=s)),y.shape={type:"path",path:x(o.geometry,v,k)}}else v=null!=o?.maxSize?Math.min(m,o.maxSize):m,k=l,c&&(c.width=l),y.shape={type:"path",path:[{command:"M",values:[l/2,k/2]},{command:"L",values:[v-l/2,k/2]}]};break}case d:case"simple-fill":{const t="object"==typeof o?.symbolConfig&&!!o?.symbolConfig?.isSquareFill,{width:e,height:i}=L(o);v=!t&&e!==i||null==e?null!=s?s:g:e,k=!t&&e!==i||null==i?v:i,w||(v+=j,k+=j),w=!0,o?.geometry?.extent&&"polygon"===o?.geometry?.type?(h=[v,k],k=h[0]>h[1]?1e3*h[1]/h[0]:1e3,v=h[0]>h[1]?1e3:1e3*h[0]/h[1],y.shape={type:"path",path:x(o.geometry,v,k)}):y.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[v,0]},{command:"L",values:[v,k]},{command:"L",values:[0,k]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:u.fill[0];break}case"picture-marker":{const e=Math.min(i(t.width),r||b),m=Math.min(i(t.height),r||b),{width:a,height:n}=L(o),p=a===n&&null!=a?a:null!=s?s:Math.max(e,m),c=t.width/t.height;v=c<=1?Math.ceil(p*c):p,k=c<=1?p:Math.ceil(p/c),y.shape={type:"image",x:-Math.round(v/2),y:-Math.round(k/2),width:v,height:k,src:t.url||""},l&&(U=!0);break}case"text":{const e=t,l=o?.overrideText||e.text||"Aa",m=e.font,{width:a,height:n}=L(o),p=null!=n?n:null!=s?s:Math.min(i(m.size),r||b),{width:c,height:h}=M(l,{weight:m.weight,size:p,family:m.family}),u=/[\uE600-\uE6FF]/.test(l);v=a??(u?p:c),k=u?p:h;let j=.5*(u?p:h);u&&(j+=5),y.shape={type:"text",text:l,x:e.xoffset||0,y:e.yoffset||j,align:"middle",alignBaseline:e.verticalAlignment,decoration:m&&m.decoration,rotated:e.rotated,kerning:e.kerning},y.font=m&&{size:p,style:m.style,decoration:m.decoration,weight:m.weight,family:m.family};break}}return{shapeDescriptor:y,size:[v,k],outputSize:h,renderOptions:{node:o?.node,scale:w,opacity:o?.opacity,rotations:[l],useRotationSize:U,effectView:o?.effectView,ariaLabel:o?.ariaLabel,clipBloomEffect:o?.clipBloomEffect}}}async function U(t,o){const{shapeDescriptor:r,size:l,renderOptions:m,outputSize:a}=k(t,o);if(!r.shape)throw new e("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,o){const e=o.fill,s=t.color;if("pattern"===e?.type&&s&&t.type!==d){const t=await p(e.src,s.toCss(!0));e.src=t,o.fill=e}}(t,r),await async function(t,o,e,i){if(!("font"in t)||!t.font||"text"!==o.shape.type)return;try{await s(t.font)}catch{}const{width:r,height:l}=L(i);if(!/[\uE600-\uE6FF]/.test(o.shape.text)){const{width:s,height:m,x:a,y:n}=M(o.shape.text,{weight:o.font?.weight,size:o.font?.size,family:o.font?.family});e[0]=r??s,e[1]=l??m,o.shape.x=a,o.shape.y=n;let p="angle"in t?t.angle:null;if(null!=i?.rotation&&(p=(p??0)+i.rotation),p){const t=p*(Math.PI/180),o=Math.abs(Math.sin(t)),s=Math.abs(Math.cos(t));e[1]=e[0]*o+e[1]*s}}}(t,r,l,o);const n=[[r]];if("object"==typeof o?.symbolConfig&&o?.symbolConfig?.applyColorModulation){const t=.6*l[0];n.unshift([{...r,offset:[-t,0],fill:h(r.fill,-.3)}]),n.push([{...r,offset:[t,0],fill:h(r.fill,.3)}]),l[0]+=2*t,m.scale=!1}"text"===t.type&&function(t,o,e,s,r){if(null!=t.haloColor&&null!=t.haloSize){r.masking??=e.map((()=>[]));const l=i(t.haloSize);s[0]+=l,s[1]+=l,e.unshift([{...o,fill:null,stroke:{color:t.haloColor,width:2*l,join:"round",cap:"round"}}]),r.masking.unshift([{shape:{type:"rect",x:0,y:0,width:s[0]+2*j,height:s[1]+2*j},fill:[255,255,255],stroke:null},{...o,fill:[0,0,0,0],stroke:null}])}null==t.backgroundColor&&null==t.borderLineColor||(s[0]+=2*j,s[1]+=2*j,e.unshift([{shape:{type:"rect",x:0,y:0,width:s[0],height:s[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:i(t.borderLineSize)}}]),r.masking?.unshift([]))}(t,r,n,l,m);const c=y(n,l,m);if(a&&c){const t="img"===c.nodeName.toLowerCase()?c:c.firstChild;"svg"===t.nodeName.toLowerCase()&&t.setAttribute("viewBox",`0 0 ${l[0].toString()} ${l[1].toString()}`),t.setAttribute("width",a[0].toString()),t.setAttribute("height",a[1].toString()),a.length>2&&(t.style.setProperty("padding-left",a[2]?.toString()+"px"),t.style.setProperty("padding-right",a[2]?.toString()+"px"),t.style.setProperty("padding-top",a[3]?.toString()+"px"),t.style.setProperty("padding-bottom",a[3]?.toString()+"px"),t.style.setProperty("box-sizing","border-box"))}return c}function z(e,s=225){const i=m(e),r=a(e),l=!i||"type"in i?null:new t(i),n=r?.color?new t(r?.color):null,p=l?v(o(l),s):null,c=n?v(o(n),s):null;return c?p?p===c?p:s>=225?"light":"dark":c:p}export{z as getContrastingBackgroundTheme,k as getRenderSymbolParameters,U as previewSymbol2D};
