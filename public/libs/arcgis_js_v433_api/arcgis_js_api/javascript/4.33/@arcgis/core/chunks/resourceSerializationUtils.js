/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../request.js";import t from"../core/Error.js";import{g as s}from"./MapUtils.js";import{b as r}from"./featureConversionUtils.js";import{O as a}from"./OptimizedGeometry.js";import i from"../geometry/SpatialReference.js";import{E as n,a as o,g as l}from"../rest/knowledgeGraphService.js";class c{constructor(){this.version="",this.queryResult=new d}}class d{constructor(){this.featureResult=new y}}class y{constructor(){this.objectIdFieldName="",this.uniqueIdField=new u,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new p,this.geometryType=null,this.spatialReference=new i,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new f,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}}class u{constructor(){this.name="",this.isSystemMaintained=!1}}class p{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}}class f{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new m,this.translate=new T}}class m{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}class T{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}}class h{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}}class _{constructor(){this.attributes=[],this.compressedGeometry=new g,this.centroid=new g,this.aggregateGeometries=[]}}class g{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}}var w;!function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"}(w||(w={}));const E=[w.ELEMENTUID,w.TYPENAME];var q,b,I,N,A,R;function F(e){const t=new g;t.geometryType=n[e.geometry_type.value];const s=[],r=[];for(let t=0;t<e.lengths.length;t++)s.push(e.lengths[t]);for(let t=0;t<e.coords.length;t++)r.push(e.coords[t]);return t.lengths=s,t.coords=r,t}function D(e){const t=new h;return t.name=e.name,t.alias=e.alias,t.fieldType=o[e.field_type.value],t.sqlType=A[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function M(e){const t=D(e);return t.geometryType=n[e.geometry_type.value],t}async function S(r,a){a??=!1;const i={generateAllSublayers:a,namedTypeDefinitions:new Map};return await async function(s){const r=await e(s,{responseType:"array-buffer"}),a=await r.data;return async function(e){const s=new((await l()).MapOfObjectIdentifierSetsDecoder),r=s.decode(new Uint8Array(e)),a=new Map;if(0!==r.error_code)throw new t("knowledge-graph:layer-support-utils",r.error_message);const i=s.get_map_of_identifier_sets(),n=i.keys,o=n.size();for(let e=0;e<o;e++){const s=n.get(e),r=i.query_identifier_set(s),o=[];if(r.id_array_type.value===R.GLOBALID_ARRAY){const e=r.get_globalid_array(),t=e.count();for(let s=0;s<t;s++)o.push(e.get_globalid_at(s))}else if(r.id_array_type.value===R.IDENTIFIER_ARRAY){const e=r.get_identifier_array(),t=e.count();for(let s=0;s<t;s++)o.push(e.get_identifier_at(s).toString())}else if(r.id_array_type.value===R.STRING_ARRAY){const e=r.get_string_array(),t=e.count();for(let s=0;s<t;s++)o.push(e.get_string_at(s))}else{if(r.id_array_type.value!==R.OID_ARRAY)throw new t("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const e=r.get_oid_array(),t=e.count();for(let s=0;s<t;s++)o.push(e.get_objectid_at(s).toString())}}a.set(s,o)}return s.delete(),a}(new Uint8Array(a))}(r).then((e=>{!function(e,t){for(const[r,a]of e){const e=s(t.namedTypeDefinitions,r,(()=>({useAllData:!1,members:new Map})));for(const t of a)e.members.has(t)||e.members.set(t,{id:t})}}(e,i)})),i}async function L(e,t,s){const r=await l(),a=new r.FeatureCollection;try{U(a,r,e,"entities",t,s);const i=new r.FeatureCollectionEncoder,n=C(a,i),o=structuredClone(n);return i.delete(),o}finally{a.delete()}}async function k(e,t,s){const r=await l(),a=new r.FeatureCollection;try{U(a,r,e,"relationships",t,s);const i=new r.FeatureCollectionEncoder,n=C(a,i),o=structuredClone(n);return i.delete(),o}finally{a.delete()}}async function v(e){const s=await l(),r=new s.MapOfObjectIdentifierSets;!function(e,t,s){for(const[r,a]of s.namedTypeDefinitions){if(!a.members||a.useAllData)continue;const s=a.members.keys();let i=!1,n=!0;const o=new t.ObjectIdArray,l=new t.StringArray,c=new t.GlobalIdArray,d=new t.IdentifierArray,y=new t.ObjectIdentifierSet;for(const e of s)n&&(i=!isNaN(Number(e)),n=!1),i?o.add_objectid(Number(e)):(l.add_string(e),c.add_globalid(e)),d.add_identifier(e);y.set_oid_array(o),y.set_string_array(l),y.set_globalid_array(c),y.set_identifier_array(d),o.delete(),l.delete(),c.delete(),d.delete(),e.put_identifier_set(r,y),y.delete()}}(r,s,e);const a=new s.MapOfObjectIdentifierSetsEncoder;try{a.set_map_of_identifier_sets(r),a.encode();const e=a.get_encoding_result();if(0!==e.error.error_code)throw new t("knowledge-graph:layer-support-utils",e.error.error_message);const s=structuredClone(e.get_byte_buffer());return a.delete(),s}finally{r.delete()}}function U(e,t,s,a,i,n){e.version="";const l=new t.QueryResult,c=new t.FeatureResult,d="entities"===a?q:b;c.unique_id_field={name:d[d.ELEMENTUID],isSystemMaintained:!1},c.globalid_field_name=d[d.ELEMENTUID],c.geohash_field_name="",c.geometry_properties={shapeAreaFieldName:"",shapeLengthFieldName:"",units:""},c.spatial_reference={wkid:4326,latestWkid:4326,vcsWkid:0,latestVcsWkid:0,wkt:""},c.exceeded_transfer_limit=!1,c.has_z=!1,c.has_m=!1,c.transform={quantizeOriginPosition:{value:N.upperLeft},scale:{xScale:1e-9,yScale:1e-9,mScale:1e-4,zScale:1e-4},translate:{xTranslate:-400,yTranslate:-400,mTranslate:-1e5,zTranslate:-1e5}};for(const e of Object.keys(d).filter((e=>isNaN(Number(e))))){const s=new t.Field;if(s.name=e,s.alias=e,s.sql_type={value:A.sqlTypeBigInt},"entities"===a)switch(e){case d[d.ELEMENTUID]:case d[d.TYPENAME]:s.field_type={value:o.esriFieldTypeString}}else switch(e){case d[d.ELEMENTUID]:case d[d.TYPENAME]:case b[b.FROMUID]:case b[b.TOUID]:s.field_type={value:o.esriFieldTypeString}}s.domain="",c.add_field(s),s.delete()}const y=new Map;for(const e of i.dataModel.entityTypes)y.set(e.name,"entities");for(const e of i.dataModel.relationshipTypes)y.set(e.name,"relationships");for(const[e,i]of s.namedTypeDefinitions)if(a===y.get(e))for(const s of i.members.values()){const i=new t.Feature;for(const r of Object.keys(d).filter((e=>isNaN(Number(e)))))if("entities"===a)switch(r){case d[d.ELEMENTUID]:i.add_attribute(s.id,t.esriFieldType.esriFieldTypeString);break;case d[d.TYPENAME]:i.add_attribute(e,t.esriFieldType.esriFieldTypeString)}else switch(r){case d[d.ELEMENTUID]:i.add_attribute(s.id,t.esriFieldType.esriFieldTypeString);break;case b[b.FROMUID]:i.add_attribute(n.has(s.id)?n.get(s.id)[0]:"",t.esriFieldType.esriFieldTypeString);break;case b[b.TOUID]:i.add_attribute(n.has(s.id)?n.get(s.id)[1]:"",t.esriFieldType.esriFieldTypeString);break;case d[d.TYPENAME]:i.add_attribute(e,t.esriFieldType.esriFieldTypeString)}let o;if(s.linkChartLocation&&"x"in s.linkChartLocation?o=r(s.linkChartLocation):s.linkChartLocation&&(o=s.linkChartLocation),s.linkChartLocation&&o){const e=new t.FeatureCollectionGeometry;let s=!1;switch(a){case"entities":e.geometry_type=t.esriGeometryType.esriGeometryPoint,s=!0;break;case"relationships":e.geometry_type=t.esriGeometryType.esriGeometryPolyline}e.coords=new Float64Array(o.coords),e.lengths=new Uint32Array(s?[1]:o.lengths),i.set_compressed_geometry(e),e.delete()}c.add_feature(i),i.delete()}switch(a){case"entities":c.geometry_type=t.esriGeometryType.esriGeometryPoint;break;case"relationships":c.geometry_type=t.esriGeometryType.esriGeometryPolyline}return l.set_feature_result(c),e.set_query_result(l),c.delete(),l.delete(),e}async function G(s){const r=await e(s,{responseType:"array-buffer"});return async function(e){const s=new((await l()).FeatureCollectionDecoder),r=s.decode(new Uint8Array(e));if(0!==r.error_code)throw new t("knowledge-graph:layer-support-utils",r.error_message);const a=function(e){const t=new c;t.version=e.version;const s=e.get_query_result();if(0!==s.results_type.value)throw new Error("Got a non-feature collection type");const r=s.get_feature_result(),a=t.queryResult.featureResult;a.objectIdFieldName=r.objectid_field_name,a.exceededTransferLimit=r.exceeded_transfer_limit,a.hasM=r.has_m,a.hasZ=r.has_z,a.geometryType=n[r.geometry_type.value],a.globalIdFieldName=r.globalid_field_name,a.geohashFieldName=r.geohash_field_name;const i=a.uniqueIdField,o=r.unique_id_field;i.name=o.name,i.isSystemMaintained=o.isSystemMaintained;const l=a.geometryProperties,d=r.geometry_properties;l.shapeAreaFieldName=d.shapeAreaFieldName,l.shapeLengthFieldName=d.shapeLengthFieldName,l.units=d.units;const y=a.spatialReference,u=r.spatial_reference;y.wkid=u.wkid,y.latestWkid=u.latestWkid,y.vcsWkid=u.vcsWkid,y.latestVcsWkid=u.latestVcsWkid,y.wkt=u.wkt,a.transform=function(e){const t=new f;t.quantizeOriginPosition=N[e.quantizeOriginPosition.value];const s=t.scale,r=e.scale;s.xScale=r.xScale,s.yScale=r.yScale,s.mScale=r.mScale,s.zScale=r.zScale;const a=t.translate,i=e.translate;return a.xTranslate=i.xTranslate,a.yTranslate=i.yTranslate,a.mTranslate=i.mTranslate,a.zTranslate=i.zTranslate,t}(r.transform);const p=a.fields,m=a.fieldNameToAttributeIndexMap,T=r.fields,h=T.size();for(let e=0;e<h;e++){const t=T.get(e),s=D(t);p.push(s),m[s.name]=e,t.delete()}T.delete();const g=a.values,w=r.values_count();for(let e=0;e<w;e++)g.push(r.get_value_at(e));const q=a.features,b=r.features,I=b.size();if(I>0)for(const e of E)if(void 0===m[e])throw new Error(`Feature collection missing required attribute: ${e}`);for(let e=0;e<I;e++){const t=new _,s=b.get(e),r=t.attributes,a=s.attributes_count();for(let e=0;e<a;e++)r.push(s.get_attribute_at(e));const i=s.get_compressed_geometry();i&&(t.compressedGeometry=F(i),t.centroid=F(s.get_centroid()));const n=t.aggregateGeometries,o=s.aggregate_geometries,l=o.size();for(let e=0;e<l;e++){const t=o.get(e),s=F(t);n.push(s),t.delete()}o.delete(),q.push(t),s.delete()}b.delete();const A=a.geometryFields,R=r.geometry_fields,S=R.size();for(let e=0;e<S;e++){const t=R.get(e),s=M(t);A.push(s),t.delete()}return R.delete(),t}(s.get_feature_collection());return s.delete(),a}(await r.data)}function O(e,t){if(!e?.queryResult?.featureResult)return t;const r=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const i of e.queryResult.featureResult.features){const e=i.attributes[r[w.TYPENAME]],n=s(t.namedTypeDefinitions,e,(()=>({useAllData:!1,members:new Map}))),o=i.attributes[r[w.ELEMENTUID]];if(i.compressedGeometry?.coords?.length>0){let e=i.compressedGeometry.lengths;"esriGeometryPoint"===i.compressedGeometry.geometryType&&(e=[]),n.members.set(o,{id:o,linkChartLocation:new a(e,i.compressedGeometry.coords)})}else n.members.set(o,{id:o})}return t}!function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"}(q||(q={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(b||(b={})),function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"}(I||(I={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(N||(N={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(A||(A={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(R||(R={}));const C=(e,s)=>{s.set_feature_collection(e),s.encode();const r=s.get_encoding_result();if(0!==r.error.error_code)throw new t("knowledge-graph:layer-support-utils",r.error.error_message);return r.get_byte_buffer()},P={fetchAndConvertSerializedLinkChart:e=>async function(e){const t=[],s={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(G(e.entitiesUrl).then((e=>{O(e,s)}))),e.relationshipsUrl&&t.push(G(e.relationshipsUrl).then((e=>{O(e,s)}))),await Promise.all(t),s}(e)};export{L as a,k as b,P as c,S as f,v as s};
