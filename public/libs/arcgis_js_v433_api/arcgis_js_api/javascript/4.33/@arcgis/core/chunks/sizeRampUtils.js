/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import t from"../Color.js";import{g as s}from"./colorUtils.js";import{r as o,n as e,p as i}from"./numberUtils.js";import{u as r}from"./referenceSizeUtils.js";import{updateSpikeSymbol as l}from"../smartMapping/renderers/support/spikeUtils.js";import m from"../symbols/SimpleLineSymbol.js";import p from"../symbols/SimpleMarkerSymbol.js";import{applyCIMSymbolColor as a}from"../symbols/support/cimSymbolUtils.js";import{getCIMSymbolPreviewSize as n}from"./previewCIMSymbol.js";import{i as j}from"./typeUtils.js";import{i as y,d as c}from"./utils4.js";import{getAuthoringInfoVisualVariableByTheme as u,getSymbolForFlowRenderer as b,createStopLabel as f}from"./utils17.js";import"./widgetUtils.js";import{i as d}from"./modeUtils.js";import"./colorUtils2.js";import"./mathUtils.js";import"./ensureType.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./MapUtils.js";import"./vec4.js";import"./common.js";import"./vec4f64.js";import"../intl.js";import"./date.js";import"./jsonMap.js";import"./locale.js";import"./handleUtils.js";import"./constants.js";import"./datetime.js";import"./number2.js";import"./substitute.js";import"./messages.js";import"../core/Error.js";import"../core/promiseUtils.js";import"./events.js";import"./maybe.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./jsonUtils.js";import"./persistableUrlUtils.js";import"./assets.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./metadata.js";import"./enumeration.js";import"./reader.js";import"../core/accessorSupport/decorators/subclass.js";import"./Lifecycle.js";import"./tracking.js";import"./Warning.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./SetUtils.js";import"../core/sql.js";import"./guards.js";import"../symbols/Symbol.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./SimpleTrackingTarget.js";import"./enums2.js";import"./screenUtils.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/MarkerSymbol.js";import"./utils3.js";import"./defaultCIMValues.js";import"./CIMSymbolHelper.js";import"./BidiEngine.js";import"./aaBoundingRect.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./pe.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./boundsUtils.js";import"../symbols/Font.js";import"./fontUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./zmUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polyline.js";import"./OptimizedGeometry.js";import"./memoryEstimations.js";import"./GeometryUtils.js";import"./definitions.js";import"./rasterizingUtils.js";import"./floatRGBA.js";import"./shapingUtils.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2.js";import"./vec2f32.js";import"./Rect.js";import"./BoundingBox.js";import"./defaults.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/TextSymbol.js";import"./defaultsJSON.js";import"./CIMSymbolRasterizer.js";import"./CIMResourceManager.js";import"./imageUtils.js";import"./OverrideHelper.js";import"../layers/support/FieldsIndex.js";import"./UnknownTimeZone.js";import"./timeZoneUtils.js";import"./ArcadeExpression.js";import"./TimeOnly.js";import"./enum.js";import"./callExpressionWithFeature.js";import"./quantizationUtils.js";import"./renderUtils.js";import"./projector.js";import"./sanitizerUtils.js";import"./svgUtils.js";import"./gfxUtils.js";import"./LRUCache.js";import"./MemCache.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils5.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils6.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./vec3f64.js";import"./aaBoundingBox.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./jsonUtils2.js";import"./parser.js";import"./utils2.js";import"./mat4.js";import"./timeUtils.js";import"./utils14.js";import"./basemapUtils.js";import"./basemapDefinitions.js";const S=30,g=12,U=[255,255,255],h=[200,200,200],v=[128,128,128];async function w(e,i,a,S,g,U,w){const x=i.legendOptions,P=x?.customValues,C=w||await async function(o,e){if("flow"===o.type)return b(o,e);if("pie-chart"===o.type)return new p({color:null,outline:o.outline?.width?o.outline:new m});let i=null,a=null;if("simple"===o.type)i=o.symbol;else if("class-breaks"===o.type){const t=o.classBreakInfos;i=t&&t[0]&&t[0].symbol,a=t.length>1}else if("unique-value"===o.type){const t=o.uniqueValueInfos;i=t?.[0]?.symbol,a=null!=t&&t.length>1}if(!i||function(t){return j(t)?t.symbolLayers?.some((t=>"fill"===t?.type))??!1:t?.type.includes("fill")??!1}(i))return null;if(i=i.clone(),e||a)if(i.type.includes("3d"))z(i);else if(u(o,"reference-size")&&"cim"===i.type)r(i,{color:e??("class-breaks"!==o.type?new t(h):null)});else if(u(o,"spike")&&"cim"===i.type){const o=new t(h),r=new t(v),m="CIMPointSymbol"===i.data.symbol?.type?i.data.symbol:null,p=!!m?.symbolLayers?.find((({type:t})=>"CIMSolidStroke"===t))?.colorLocked;let a,n=e??void 0;if(n){const t=s(n),e=d();(!e&&t>225||e&&t<25)&&(n=o,a=p?r:o)}else n=o,a=p?r:o;l(i,{color:n,strokeColor:a})}else D(i);return i}(e,a),I=i.stops,E=!!C,O=!!P,T=null!=i.minSize&&null!=i.maxSize,V=I&&I.length>1,B=!!i.target;if(!E||!O&&!(T||V&&!B))return;const R=y(C);let F=!1,A=null,q=null;A=R&&!V?o([i.minDataValue,i.maxDataValue]):P??await async function(t,s,e,i){const r=(await import("./visualVariableUtils.js").then((t=>t.l))).getSizeRangeAtScale(t,e,i),l=r&&L(r);if(!r||!l)return;let m=l.map((s=>function(t,s,o){const e=o.minSize,i=o.maxSize,r=s.minDataValue,l=s.maxDataValue;let m;return m=t<=e?r:t>=i?l:(t-e)/(i-e)*(l-r)+r,m}(s,t,r)));m=o(m);for(let o=1;o<m.length-1;o++){const r=await k(t,s,m[o],m[o-1],e,i);r&&(m[o]=r[0],l[o]=r[1])}return m}(i,C,S,g?.type);const G=e?.authoringInfo,H="univariate-color-size"===G?.type,W=H&&"above-and-below"===G?.univariateTheme,J=!!u(e,"reference-size"),N=!!u(e,"spike");if(!A&&V&&(A=I.map((t=>t.value)),F=I.some((t=>!!t.label)),"flow"===e.type&&(A=o(A)),F&&(q=I.map((t=>t.label)))),R&&null!=A&&A?.length>2&&!W&&(A=[A[0],A[A.length-1]]),!A)return null;H&&5!==A?.length&&(A=L({minSize:A[0],maxSize:A[A.length-1]}));const Q=R?function(t,s){const o=t?.authoringInfo,e="univariate-color-size"===o?.type;let i=[12,30];if(e){const t=s[0],o=s[s.length-1],e=12,r=30;i=s.map((s=>e+(s-t)/(o-t)*(r-e)))}return e&&"below"===o?.univariateTheme&&i.reverse(),i}(e,A):null,Z=c(C),K=F?null:function(t,s){const o=t.length-1;return t.map(((t,e)=>f(t,e,o,s)))}(A,U),X=await Promise.all(A.map((async(t,s)=>{let o=R?Q[s]:await M(i,C,t,S,g?.type),m=o;J&&(o*=24/i.maxSize||1,m=24);const p=function(t,s,o,e){"univariate-color-size"===o?.authoringInfo?.type&&"above-and-below"===o?.authoringInfo?.univariateTheme&&"class-breaks"===o.type&&(t=function(t,s){const o=t.classBreakInfos,e=o.length,i=e<2||!(s>=2)?o[0].symbol.clone():o[e-1].symbol.clone(),r=t.visualVariables?.some((t=>"color"===t.type));return r&&(i.type.includes("3d")?z(i):D(i)),i}(o,e));const i=t.clone();if(j(i))y(i)||i.symbolLayers.forEach((t=>{"fill"!==t.type&&(t.size=s)}));else if("esri.symbols.SimpleMarkerSymbol"===i.declaredClass)i.size=s;else if("esri.symbols.PictureMarkerSymbol"===i.declaredClass){const t=i.width,o=i.height;i.height=s,i.width=s*(t/o)}else"esri.symbols.SimpleLineSymbol"!==i.declaredClass?function(t){return"esri.symbols.TextSymbol"===t.declaredClass}(i)?i.font&&(i.font.size=s):"cim"===i.type&&u(o,"reference-size")?r(i,{innerDotSize:s,outerRingSize:24}):"cim"===i.type&&u(o,"spike")&&l(i,{defaultHeight:s,primitiveOverrides:null}):i.width=s;return i}(C,o,e,s);return N&&"cim"===p.type&&(m=await n(p)),{value:t,symbol:p,label:F?q[s]:K[s],size:m,outlineSize:Z}})));return X.reverse()}function z(t){"line-3d"===t.type?t.symbolLayers.forEach((t=>{t.material={color:v}})):t.symbolLayers.forEach((t=>{"icon"!==t.type||t.resource?.href?t.material={color:h}:(t.material={color:U},t.outline={color:v,size:1.5})}))}function D(s){const o=d();if("cim"===s.type)a(s,new t(h));else if(s.type.includes("line"))s.color=v;else if(s.color=o?v:U,"simple-marker"===s.type)if(s.outline){const t=s.outline?.color?.toHex();"#ffffff"===t&&(s.outline.color=v)}else s.outline={color:v,width:1.5}}function L(t){const s=t.minSize,o=(t.maxSize-s)/4,e=[];for(let t=0;t<5;t++)e.push(s+o*t);return e}async function k(t,s,r,l,m,p){const a=await M(t,s,r,m,p),n=await M(t,s,l,m,p),j=e(r),y=j.fractional;let c=j.integer,u=null,b=null;r>0&&r<1&&(u=10**y,c=e(r*=u).integer);for(let e=c-1;e>=0;e--){const l=10**e;let j=Math.floor(r/l)*l,y=Math.ceil(r/l)*l;null!=u&&(j/=u,y/=u);let c=(j+y)/2;[,c]=o([j,c,y],{indexes:[1]});const f=await M(t,s,j,m,p),d=await M(t,s,y,m,p),S=await M(t,s,c,m,p),g=i(a,f,n,null),U=i(a,d,n,null),h=i(a,S,n,null);let v=g.previous<=20,w=U.previous<=20;if(v&&w&&(g.previous<=U.previous?(v=!0,w=!1):(w=!0,v=!1)),v?b=[j,f]:w?b=[y,d]:h.previous<=20&&(b=[c,S]),b)break}return b}async function M(t,s,o,e,i){const{getSize:r}=await import("./visualVariableUtils.js").then((t=>t.l));return r(t,o,{scale:e,view:i,shape:"simple-marker"===s.type?s.style:null})}export{w as getRampStops,S as realWorldMaxSize,g as realWorldMinSize};
