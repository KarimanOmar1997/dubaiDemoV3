/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import t from"../core/Error.js";import r from"../geometry/Point.js";import o from"../geometry/Polygon.js";import n from"../geometry/Polyline.js";import a from"../layers/GraphicsLayer.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Multipoint.js";import"./Logger.js";import"./aaBoundingBox.js";import"../core/lang.js";import"./mathUtils.js";import{g as i}from"./assets.js";import{a as s}from"./enums3.js";import{executeQueryStreaming as l}from"../rest/knowledgeGraphService.js";import c from"../rest/knowledgeGraph/GraphQueryStreaming.js";import u from"../symbols/CIMSymbol.js";import y from"../symbols/SimpleFillSymbol.js";import m from"../symbols/TextSymbol.js";let p,f=null;function d(){return p||(p=import("./lclayout.js").then((e=>e.l)).then((({default:e})=>e({locateFile:e=>i(`esri/libs/linkchartlayout/${e}`)}))).then((e=>{f=e})),p)}var h,g,E,b;!function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot",e[e.IsOld=8]="IsOld"}(h||(h={})),function(e){e[e.Success=0]="Success",e[e.Error=1]="Error",e[e.Canceled=2]="Canceled"}(g||(g={})),function(e){e[e.Regular=0]="Regular",e[e.Curved=1]="Curved",e[e.Recursive=2]="Recursive"}(E||(E={})),function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom"}(b||(b={}));const C={none:0,"start-only":1,"start-and-end":2};function v(e,t,r,o,n,a){const i=r.length,s=n.length,l=Float64Array.BYTES_PER_ELEMENT,c=Uint32Array.BYTES_PER_ELEMENT,u=Uint8Array.BYTES_PER_ELEMENT,y=16+i*(u+2*l)+s*(2*c),m=f._malloc(y);try{const u=m+16-m%16,y=u+i*l,p=y+i*l,d=p+s*c,h=d+s*c,E=()=>[f.HEAPF64.subarray(u>>3,(u>>3)+i),f.HEAPF64.subarray(y>>3,(y>>3)+i),f.HEAPU32.subarray(p>>2,(p>>2)+s),f.HEAPU32.subarray(d>>2,(d>>2)+s),f.HEAPU8.subarray(h,h+i)],[b,C,v,w,L]=E();b.set(r),C.set(o),v.set(n),w.set(a),L.set(t);const M=e(i,h,u,y,s,p,d);let R=null,x=null;if(M.value===g.Success){const e=f.getLayoutLinksTypes(),t=f.getLayoutLinksVerticesEndIndices(),r=f.getLayoutLinksVertices(),o=f.countLayoutLinksVertices();!s||e&&t?o&&!r?M.value=g.Error:(R={types:new Uint8Array(f.HEAPU8.subarray(e,e+s)),vertexEndIndex:new Uint32Array(f.HEAPU32.subarray(t>>2,(t>>2)+s)),vertices:new Float64Array(f.HEAPF64.subarray(r>>3,(r>>3)+2*o))},x=f.getAuxiliaryGraphicElements()):M.value=g.Error}const[S,T,A,I,_]=E();return r.set(S),o.set(T),n.set(A),a.set(I),t.set(_),{status:M.value,links:R,graphics:x}}finally{f._free(m),f.cleanupLayout()}}var w,L,M,R,x,S,T,A,I;function _(e,t){const r=new Map;if(t.dataModel?.relationshipTypes)for(const e of t.dataModel.relationshipTypes)e.name&&r.set(e.name,[]);for(const t of e)r.has(t.typeName)&&r.get(t.typeName)?.push(t.id);return r}async function P(e,t,r){const o=[],n=_(e,t),a={},i=[];for(const[e,t]of n){if(t.length<1)continue;const r=`${e}_ids`;a[r]=t,i.push(`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $${r} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(0===i.length)return[];const s=i.join(" UNION "),u=new c({openCypherQuery:s,bindParameters:a}),y=(await l(t,u,r?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:e,value:t}=await y.read();if(e)break;for(const e of t)o.push({id:e[0],typeName:e[1]}),o.push({id:e[2],typeName:e[3]})}return o}async function k(e,t,r){const o=new Map,n=_(e,t),a={},i=[];for(const[e,t]of n){if(t.length<1)continue;const r=`${e}_ids`;a[r]=t,i.push(`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $${r} RETURN id(r), id(n), id(m)`)}if(0===i.length)return o;const s=i.join(" UNION "),u=new c({openCypherQuery:s,bindParameters:a}),y=(await l(t,u,r?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:e,value:t}=await y.read();if(e)break;for(const e of t)o.set(e[0],[e[1],e[2]])}return o}!function(e){e.getMinIdealEdgeLength=function(){return f.getMinIdealEdgeLength()},e.apply=function(e,t,r,o,n,a,i=2,s=1,l=-1){return v(((t,r,o,n,a,c,u)=>f.applyForceDirectedLayout(e,t,r,o,n,a,c,u,i,s,l)),t,r,o,n,a)}}(w||(w={})),function(e){e.apply=function(e,t,r,o,n,a,i=2,s=1,l=-1){return v(((t,r,o,n,a,c,u)=>f.applyCommunityLayout(e,t,r,o,n,a,c,u,i,s,l)),t,r,o,n,a)}}(L||(L={})),function(e){e.apply=function(e,t,r,o,n,a){return v(((t,r,o,n,a,i,s)=>f.applySimpleLayout(e,t,r,o,n,a,i,s)),t,r,o,n,a)}}(M||(M={})),function(e){e.apply=function(e,t,r,o,n,a){return v(((t,r,o,n,a,i,s)=>f.applyHierarchicalLayout(e,t,r,o,n,a,i,s)),t,r,o,n,a)}}(R||(R={})),function(e){e.apply=function(e,t,r,o,n,a){return v(((t,r,o,n,a,i,s)=>f.applyRadialTreeLayout(e,t,r,o,n,a,i,s)),t,r,o,n,a)}}(x||(x={})),function(e){e.apply=function(e,t,r,o,n,a){return v(((t,r,o,n,a,i,s)=>f.applySmartTreeLayout(e,t,r,o,n,a,i,s)),t,r,o,n,a)}}(S||(S={})),function(e){e.apply=function(e,t,r,o,n,a,i,s,l,c,u,y){return v(((t,r,o,i,s,m,p)=>{if(n.length!==t)return{value:g.Error};if(a.length!==t)return{value:g.Error};if(l.length!==s)return{value:g.Error};if(c.length!==s)return{value:g.Error};const d=Float64Array.BYTES_PER_ELEMENT,h=16,E=f._malloc(h+t*d),v=f._malloc(h+t*d),w=f._malloc(h+s*d),L=f._malloc(h+s*d),M=E+h-E%h,R=v+h-v%h,x=w+h-w%h,S=L+h-L%h;try{return f.HEAPF64.subarray(M>>3,(M>>3)+t).set(n),f.HEAPF64.subarray(R>>3,(R>>3)+t).set(a),f.HEAPF64.subarray(x>>3,(x>>3)+s).set(l),f.HEAPF64.subarray(S>>3,(S>>3)+s).set(c),f.applyChronologicalLayout(e,t,r,o,i,M,R,s,m,p,x,S,u,function(e){const t={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...e?.toJSON()??{},eventsTicksVisualization:e?.eventsTicksVisualization??"start-and-end"};return{...t,timeDirection:{value:b[t.timeDirection]??b.right},eventsTicksVisualization:{value:C[t.eventsTicksVisualization]??C["start-and-end"]}}}(y))}finally{f._free(E),f._free(v),f._free(w),f._free(L)}}),t,r,o,i,s)}}(T||(T={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(A||(A={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(I||(I={}));const N="ESRI__ChronologicalLayoutOverlay",j=()=>N,B=t=>{const i=[],s={type:"CIMGeometricEffectCut",beginCut:3,endCut:3};for(const r of t.chronologicalAuxiliaryGraphics?.lines??[]){const t={type:"CIMSolidStroke",enable:!0,width:r.width,color:[r.color.r,r.color.g,r.color.b,Math.round(r.color.a/100*255)],effects:r.dashPattern.length>0?[{type:"CIMGeometricEffectDashes",dashTemplate:r.dashPattern,lineDashEnding:"NoConstraint"},s]:void 0},o={type:"CIMVectorMarker",enable:!0,size:10,frame:{xmin:-5,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[-2.06,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:[r.color.r,r.color.g,r.color.b,Math.round(r.color.a/100*255)]}]}}],markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineEnd",offsetAlongLine:0}},a=new u({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:r.arrowheadSizeAtEnd?[t,o]:[t]}}});for(const t of r.elements){const r=new n({paths:[[[t.origin.x,t.origin.y],[t.destination.x,t.destination.y]]]});i.push(new e({geometry:r,symbol:a}))}}for(const r of t.chronologicalAuxiliaryGraphics?.polygons??[]){const t=new y({color:[r.color.r,r.color.g,r.color.b,r.color.a/100],style:"solid",outline:null});for(const n of r.elements){const r=new o({rings:[n.points.map((e=>[e.x,e.y]))]});i.push(new e({geometry:r,symbol:t}))}}for(const o of t.chronologicalAuxiliaryGraphics?.texts??[]){let t="middle",n="center";switch(o.direction?.value){case b.left:n="right";break;case b.right:n="left";break;case b.bottom:t="bottom"}for(const a of o.elements){const s=new m({color:[o.color.r,o.color.g,o.color.b,o.color.a/100],text:a.str,font:{size:o.height,weight:"bold"},verticalAlignment:t,horizontalAlignment:n}),l=new r({x:a.anchor.x,y:a.anchor.y});i.push(new e({geometry:l,symbol:s}))}}return new a({graphics:i,listMode:"hide",title:N,id:N})},G=e=>s.get(e)??"radial-root-centric";function H(e){if(!e.spatialReference.isWGS84)throw new t("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map((e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]))}export{g as C,T as L,h as N,j as a,B as b,G as c,P as d,M as e,S as f,k as g,x as h,R as i,L as j,w as k,d as l,E as m,H as u};
