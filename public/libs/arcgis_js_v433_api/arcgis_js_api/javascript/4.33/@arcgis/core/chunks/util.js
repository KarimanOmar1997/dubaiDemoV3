/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{J as t}from"./jsonMap.js";import{L as i}from"./Logger.js";import{n as e,m as o,o as s,p as l}from"./definitions.js";import n from"../views/support/HighlightOptions.js";import{T as r,q as a,r as h}from"./enums.js";import{a as u,T as c}from"./Texture.js";import{g as d}from"./unitUtils.js";import{F as p}from"./enums4.js";const g=1,f=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],y=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],m=()=>i.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient"),C=[0,0,0,0];class v{constructor(){this.type="single",this._highlightOptions=new n,this._convertedHighlightOptions={fillColor:[0,0,0,0],outlineColor:[0,0,0,0],outlinePosition:0,outlineWidth:0,innerHaloWidth:0,outerHaloWidth:0},this._optionsShadeTexKey="",this._texelData=new Uint8Array(1024),this._minMaxDistance=[0,0]}setHighlightOptions(t){this._highlightOptions=t}applyHighlightOptions(t,i){this._updateGradientTexture(t),t.bindTexture(this._shadeTex,e),i.setUniform2fv("u_minMaxDistance",this._minMaxDistance)}destroy(){this._shadeTex?.dispose(),this._shadeTex=null}getReasonsWithGradients(){return[{activeReasons:(1<<o)-1,activeGradient:this}]}_updateGradientTexture(t){const i=`${(e=this._highlightOptions).color};${e.haloColor};${e.haloOpacity};${e.fillOpacity};${e.haloWidth};${e.haloBlur}`;var e;if(i===this._optionsShadeTexKey)return;this._optionsShadeTexKey=i,function(t,i){i.fillColor[0]=t.color.r/255,i.fillColor[1]=t.color.g/255,i.fillColor[2]=t.color.b/255,i.fillColor[3]=t.color.a,t.haloColor?(i.outlineColor[0]=t.haloColor.r/255,i.outlineColor[1]=t.haloColor.g/255,i.outlineColor[2]=t.haloColor.b/255,i.outlineColor[3]=t.haloColor.a):(i.outlineColor[0]=i.fillColor[0],i.outlineColor[1]=i.fillColor[1],i.outlineColor[2]=i.fillColor[2],i.outlineColor[3]=i.fillColor[3]),i.fillColor[3]*=t.fillOpacity,i.outlineColor[3]*=t.haloOpacity,i.fillColor[0]*=i.fillColor[3],i.fillColor[1]*=i.fillColor[3],i.fillColor[2]*=i.fillColor[3],i.outlineColor[0]*=i.outlineColor[3],i.outlineColor[1]*=i.outlineColor[3],i.outlineColor[2]*=i.outlineColor[3],i.outlineWidth=(1-t.haloBlur)*t.haloWidth,i.outerHaloWidth=t.haloBlur*t.haloWidth/2,i.innerHaloWidth=t.haloBlur*t.haloWidth/2,i.outlinePosition=0}(this._highlightOptions,this._convertedHighlightOptions);const o=this._convertedHighlightOptions,s=o.outlinePosition-o.outlineWidth/2-o.outerHaloWidth,l=o.outlinePosition-o.outlineWidth/2,n=o.outlinePosition+o.outlineWidth/2,a=o.outlinePosition+o.outlineWidth/2+o.innerHaloWidth,h=1*Math.sqrt(Math.PI/2),d=Math.abs(s)>h?Math.round(10*(Math.abs(s)-h))/10:0,p=Math.abs(a)>h?Math.round(10*(Math.abs(a)-h))/10:0;let g;d&&!p?m().error("The outer rim of the highlight is "+d+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!d&&p?m().error("The inner rim of the highlight is "+p+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):d&&p&&m().error("The highlight is "+Math.max(d,p)+"px away from the edge of the feature; consider reducing some width values.");const f=[void 0,void 0,void 0,void 0];function y(t,i,e){f[0]=(1-e)*t[0]+e*i[0],f[1]=(1-e)*t[1]+e*i[1],f[2]=(1-e)*t[2]+e*i[2],f[3]=(1-e)*t[3]+e*i[3]}const{_texelData:v}=this;for(let t=0;t<256;++t)g=s+t/255*(a-s),g<s?(f[0]=0,f[1]=0,f[2]=0,f[3]=0):g<l?y(C,o.outlineColor,(g-s)/(l-s)):g<n?[f[0],f[1],f[2],f[3]]=o.outlineColor:g<a?y(o.outlineColor,o.fillColor,(g-n)/(a-n)):[f[0],f[1],f[2],f[3]]=o.fillColor,v[4*t]=255*f[0],v[4*t+1]=255*f[1],v[4*t+2]=255*f[2],v[4*t+3]=255*f[3];if(this._minMaxDistance[0]=s,this._minMaxDistance[1]=a,!this._shadeTex){const i=new u;i.wrapMode=r.CLAMP_TO_EDGE,i.width=256,i.height=1,this._shadeTex=new c(t,i)}this._shadeTex.updateData(0,0,0,256,1,this._texelData)}}class w{constructor(){this.type="multi",this.gradients=[]}setHighlightOptions(t){for(let i=0;i<t.length;i++)this.gradients[i]||(this.gradients[i]=new v),this.gradients[i].setHighlightOptions(t[i]);for(let i=t.length+1;i<this.gradients.length;i++)this.gradients[i].destroy();this.gradients.length=t.length}destroy(){for(const t of this.gradients)t.destroy()}getReasonsWithGradients(){let t=1;const i=[];for(let e=0;e<this.gradients.length;e++){const o=this.gradients[e];i.push({activeReasons:t,activeGradient:o}),t<<=1}return i}}const O={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:{write:!1,test:{ref:t=>t.stencilRef,compare:h.EQUAL,mask:255,op:{fail:a.KEEP,zFail:a.KEEP,zPass:a.REPLACE}}}},M={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:!1},x={...O,color:{write:[!0,!0,!0,!0],blendMode:"delete"}};function T({pixelRatio:t,state:i,displayLevel:e,requiredLevel:o},s){const l=1/2**(e-s.key.level),n=1/2**(o-s.key.level);return{displayMat3:i.displayMat3,displayViewMat3:i.displayViewMat3,displayViewScreenMat3:s.transforms.displayViewScreenMat3,viewMat3:i.viewMat3,tileMat3:s.transforms.tileMat3,displayZoomFactor:l,requiredZoomFactor:n,tileOffset:[s.x,s.y],currentScale:i.scale,currentZoom:e,metersPerSRUnit:d(i.spatialReference),rotation:i.rotation,pixelRatio:t}}function _(t){return"highlight"===t.passOptions?.type}function b(t){return"hittest"===t.passOptions?.type}function G(t){if(!b(t))return null;const{position:i,distance:e,smallSymbolDistance:o,smallSymbolSizeThreshold:s}=t.passOptions;return{position:i,distance:e,smallSymbolDistance:o,smallSymbolSizeThreshold:s}}function R(t){if(!_(t))return null;const{activeReasons:i,highlightAll:e}=t.passOptions;return{activeReasons:i,highlightAll:e?1:0}}function P(t,i,e){const o={};for(const s in e)"function"!=typeof e[s]?o[s]=e[s]:o[s]=e[s](t,i);return o}function W(t,i){const{attributeView:e,context:o}=t;return{storage:e.getUniforms(o),view:T(t,i),hittestRequest:G(t),highlight:R(t)}}function A(t){return{inside:t.selection===p.InsideEffect,outside:t.selection===p.OutsideEffect}}function H(t){return b(t)?M:_(t)&&"clear"===t.passOptions.stepType?x:O}function S(t){const{row:i,col:e}=t.key,o=e*l,n=i*l;return{tileOffsetFromLocalOrigin:[o%s,n%s],maxIntsToLocalOrigin:[Math.floor(o/s),Math.floor(n/s)]}}const D=new t({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch",mesh:"mesh"});function E(t){return D.toJSON(t)}function j(t,i,e){const o=[],s=[];let l=0,n=0;for(const r of t){const t=n;let a=r[0][0],h=r[0][1];o[n++]=a,o[n++]=h;let u=0;for(let t=1;t<r.length;++t){const i=a,e=h;a=r[t][0],h=r[t][1],u+=h*i-a*e,o[n++]=a,o[n++]=h}i(u/2),u>0?(t-l>0&&(e(l,t,o,s),l=t),s.length=0):u<0&&t-l>0?s.push(.5*(t-l)):n=t}n-l>0&&e(l,n,o,s)}function L(t){const{bandCount:i,attributeTable:e,colormap:o,pixelType:s}=t.raster.rasterInfo;return 1===i&&(null!=e||null!=o||"u8"===s||"s8"===s)}function U(t,i){return null==i?(t?.destroy(),null):("single"===t?.type&&Array.isArray(i)&&(t.destroy(),t=null),"multi"!==t?.type||Array.isArray(i)||(t.destroy(),t=null),t||(t=Array.isArray(i)?new w:new v),Array.isArray(i)?"multi"===t.type&&t.setHighlightOptions(i):"single"===t.type&&t.setHighlightOptions(i),t)}function $(t,i,e,o){const{painter:s,highlightGradient:l}=t,{highlight:n}=s.effects;if(!l)return;const r=t.passOptions,a=l.getReasonsWithGradients();for(let o=0;o<a.length;o++){const l={...t,passOptions:{type:"highlight",activeGradient:a[o].activeGradient,activeReasons:a[o].activeReasons,stepType:"burn",highlightAll:i}};if(n.bind(l),e(l),o<a.length-1){let s=0;for(let t=o+1;t<a.length;t++)s|=a[t].activeReasons;e({...t,passOptions:{type:"highlight",activeGradient:a[o].activeGradient,activeReasons:s,stepType:"clear",highlightAll:i}})}const r={...t,passOptions:{type:"highlight",activeGradient:a[o].activeGradient,activeReasons:a[o].activeReasons,stepType:"draw",highlightAll:i}};s.setPipelineState(H(t)),s.updatePipelineState(t.context),n.draw(r),n.unbind()}t.passOptions=r}export{j as a,f as b,U as c,y as d,L as e,S as f,A as g,W as h,b as i,P as j,H as k,_ as l,T as m,$ as r,g as s,E as t};
