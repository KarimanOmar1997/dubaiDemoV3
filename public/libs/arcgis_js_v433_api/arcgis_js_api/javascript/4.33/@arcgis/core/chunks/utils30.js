/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import t from"../core/Error.js";import{L as e,n as r}from"./Logger.js";import{P as s,D as n}from"./enums.js";import{g as i}from"./getDataTypeBytes.js";import{V as o}from"./VertexElementDescriptor.js";import{z as a}from"./definitions.js";import{V as c}from"./enums4.js";import{B as u}from"./BoundingBox.js";const l=()=>e.getLogger("esri.views.2d.engine.webgl.Utils");function f(e){switch(e){case s.UNSIGNED_BYTE:return 1;case s.UNSIGNED_SHORT_4_4_4_4:return 2;case s.FLOAT:return 4;default:return void l().error(new t("webgl-utils",`Unable to handle type ${e}`))}}function h(e){switch(e){case s.UNSIGNED_BYTE:return Uint8Array;case s.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case s.FLOAT:return Float32Array;default:return void l().error(new t("webgl-utils",`Unable to handle type ${e}`))}}const d=new Map,E=(t,e)=>{if(!d.has(t)){const r=function(t){const e=new Map;for(const r in t){const s=t[r];let n=0;e.set(r,s.map((t=>{const e=new o(t.name,t.count,t.type,n,0,t.normalized||!1);return n+=t.count*i(t.type),e}))),e.get(r).forEach((t=>t.stride=n))}return e}(e),s=(t=>{const e={};return t.forEach(((t,r)=>e[r]=t?.length?t[0].stride:0)),e})(r),n=(t=>{const e=new Map;for(const r in t)for(const s of t[r])e.set(s.name,s.location);return e})(e),a={strides:s,bufferLayouts:r,attributes:n};d.set(t,a)}return d.get(t)},p=t=>t.includes("data:image/svg+xml");function m(t){const e=[];for(let r=0;r<t.length;r++)e.push(t.charCodeAt(r));return e}function y(t){if(null==t)return"";const{type:e}=t;switch(e){case"CIMMarkerPlacementAlongLineRandomSize":return`${e}-${t.seed}-${t.randomization}`;case"CIMMarkerPlacementAlongLineVariableSize":return`${e}-${t.maxRandomOffset}-${t.numberOfSizes}-${t.seed}-${t.variationMethod}`;case"CIMMarkerPlacementAtExtremities":return`${e}-${t.extremityPlacement}-${t.offsetAlongLine}`;case"CIMMarkerPlacementAtRatioPositions":return`${e}-${t.beginPosition}-${t.endPosition}-${t.flipFirst}-${JSON.stringify(t.positionArray)}`;case"CIMMarkerPlacementAtMeasuredUnits":return`${e}-${t.interval}-${t.skipMarkerRate}-${t.placeAtExtremities}`;case"CIMMarkerPlacementInsidePolygon":return`${e}-${t.stepX}-${t.stepY}-${t.randomness}-${t.gridType}-${t.seed}-${t.shiftOddRows}`;case"CIMMarkerPlacementOnLine":return`${e}-${t.relativeTo}-${t.startPointOffset}`;case"CIMMarkerPlacementOnVertices":return`${e}-${t.placeOnControlPoints}-${t.placeOnEndPoints}-${t.placeOnRegularVertices}`;case"CIMMarkerPlacementPolygonCenter":return`${e}-${t.method}`;default:return`${e}`}}class I{static{this.byteSizeHint=7*Uint32Array.BYTES_PER_ELEMENT}constructor(t,e,r,s,n,i,o){this.instanceId=t,this.textureKey=e,this.indexStart=r,this.indexCount=s,this.vertexStart=n,this.vertexCount=i,this.overlaps=o}updateBaseOffsets(t){this.vertexStart+=t.vertexFrom,this.indexStart+=t.indexFrom}clone(){return new I(this.instanceId,this.textureKey,this.indexStart,this.indexCount,this.vertexStart,this.vertexCount,this.overlaps)}static write(t,e,r,s,n,i,o,a){t.push(e),t.push(r),t.push(s),t.push(n),t.push(i),t.push(o),t.push(a)}serialize(t){return t.push(this.instanceId),t.push(this.textureKey),t.push(this.indexStart),t.push(this.indexCount),t.push(this.vertexStart),t.push(this.vertexCount),t.push(this.overlaps),t}static deserialize(t){const e=t.readInt32(),r=t.readInt32(),s=t.readInt32(),n=t.readInt32(),i=t.readInt32(),o=t.readInt32(),a=t.readInt32();return new I(e,r,s,n,i,o,a)}}function S(t,e){if(null!==e){t.push(e.length);for(const r of e)r.serialize(t);return t}t.push(0)}function T(t,e,r){const s=t.readInt32(),n=new Array(s);for(let s=0;s<n.length;s++)n[s]=e.deserialize(t,r);return n}class g{static{this.byteSizeHint=2*Uint32Array.BYTES_PER_ELEMENT+I.byteSizeHint}constructor(t,e){this.id=t,this.sortKey=e,this.records=[]}serialize(t){return t.push(this.id),t.writeF32(this.sortKey),S(t,this.records),t}static deserialize(t){const e=t.readInt32(),r=t.readF32(),s=new g(e,r);return s.records=T(t,I)??[],s}}class _{constructor(t,e,r,s,n,i,o,a,c,u,l,f=[],h=0,d=0){this.displayId=t,this.labelClassId=e,this.labelIdHash=r,this.hash=s,this.anchorX=n,this.anchorY=i,this.directionX=o,this.directionY=a,this.maxScale=c,this.minScale=u,this.referenceBounds=l,this.bounds=f,this.recordStart=h,this.recordCount=d,this.priority=0,this._colliders=null,this.uniqueSymbol=null,this.selectedForRendering=!1}get xTile(){return this.anchorX}get yTile(){return this.anchorY}colliders(t){if(!this._colliders){const e=t.attributeView,r=a;let s=this.referenceBounds?.size??0;const n=t.layerView.labelingCollisionInfos[0].vvEvaluators[0];if(null!=n){const t=n(e.getVisualVariableData(this.displayId,c.SIZE));s=isNaN(t)||null==t||t===1/0?s:t}const i=this.minScale?t.layerView.view.featuresTilingScheme.scaleToZoom(this.minScale):0,o=this.maxScale?t.layerView.view.featuresTilingScheme.scaleToZoom(this.maxScale):25,u=this.directionX*(r+s/2),l=this.directionY*(r+s/2);this._colliders=this.bounds.map((t=>({labelId:this.labelIdHash,xTile:this.anchorX,yTile:this.anchorY,dxPixels:t.x-t.halfWidth+u,dyPixels:t.y-t.halfHeight+l,hard:!0,partIndex:1,width:t.width+2,height:t.height+2,angle:0,xScreen:0,yScreen:0,dxScreen:0,dyScreen:0,enabled:!0,minLod:i,maxLod:o})))}return this._colliders}get id(){return this.displayId}serialize(t){t.push(this.displayId),t.push(this.labelClassId),t.push(this.labelIdHash),t.push(this.hash),t.push(this.recordStart),t.push(this.recordCount),t.writeF32(this.anchorX),t.writeF32(this.anchorY),t.writeF32(this.directionX),t.writeF32(this.directionY),t.writeF32(this.maxScale),t.writeF32(this.minScale),this.referenceBounds?(t.writeF32(this.referenceBounds.size),t.writeF32(this.referenceBounds.offsetX),t.writeF32(this.referenceBounds.offsetY)):(t.writeF32(0),t.writeF32(0),t.writeF32(0)),S(t,this.bounds)}static deserialize(t){const e=t.readInt32(),r=t.readInt32(),s=t.readInt32(),n=t.readInt32(),i=t.readInt32(),o=t.readInt32(),a=t.readF32(),c=t.readF32(),l=t.readF32(),f=t.readF32(),h=t.readF32(),d=t.readF32(),E=t.readF32(),p=t.readF32(),m=t.readF32(),y=T(t,u)??[];return new _(e,r,s,n,a,c,l,f,h,d,{size:E,offsetX:p,offsetY:m},y,i,o)}}const M=new Float32Array(1),b=new Uint32Array(M.buffer);function w(t){return M[0]=t,b[0]}function N(t){return b[0]=t,M[0]}function F(t,e){return 65535&t|e<<16}function P(t){const e=w(t),r=e>>>31;let s=e>>>23&255,n=8388607&e;return s-=127,s>15?r<<15|31744:s<-25?0:(s<-14&&(n+=8388608,n/=2**(-14-s),s=-15),s+=15,n/=8192,n=function(t){const e=Math.floor(t),r=t-e;return e<1023&&(r>.5||.5===r&&e%2==1)?e+1:e}(n),r<<15|s<<10|n)}function x(t){let e=t>>>15,r=t>>10&31,s=1023&t;return e=e?-1:1,r-=15,s/=1024,r>-15?s+=1:r=-14,e*2**r*s}function U(t,e,r,s){const i=r.packPrecisionFactor??1;switch(r.type){case n.BYTE:if(1===r.count)t.setInt8(s+r.offset,e*i);else for(let n=0;n<r.count;n++){const o=n*Int8Array.BYTES_PER_ELEMENT;t.setInt8(s+r.offset+o,e[n]*i)}break;case n.UNSIGNED_BYTE:if(1===r.count)t.setUint8(s+r.offset,e*i);else for(let n=0;n<r.count;n++){const o=n*Uint8Array.BYTES_PER_ELEMENT;t.setUint8(s+r.offset+o,e[n]*i)}break;case n.SHORT:if(1===r.count)t.setInt16(s+r.offset,e*i,!0);else for(let n=0;n<r.count;n++){const o=n*Int16Array.BYTES_PER_ELEMENT;t.setInt16(s+r.offset+o,e[n]*i,!0)}break;case n.UNSIGNED_SHORT:if(1===r.count)t.setUint16(s+r.offset,e*i,!0);else for(let n=0;n<r.count;n++){const o=n*Uint16Array.BYTES_PER_ELEMENT;t.setUint16(s+r.offset+o,e[n]*i,!0)}break;case n.INT:if(1===r.count)t.setInt32(s+r.offset,e*i,!0);else for(let n=0;n<r.count;n++){const o=n*Int32Array.BYTES_PER_ELEMENT;t.setInt32(s+r.offset+o,e[n]*i,!0)}break;case n.UNSIGNED_INT:if(1===r.count)t.setUint32(s+r.offset,e*i,!0);else for(let n=0;n<r.count;n++){const o=n*Uint32Array.BYTES_PER_ELEMENT;t.setUint32(s+r.offset+o,e[n]*i,!0)}break;case n.FLOAT:if(1===r.count)t.setFloat32(s+r.offset,e*i,!0);else for(let n=0;n<r.count;n++){const o=n*Float32Array.BYTES_PER_ELEMENT;t.setFloat32(s+r.offset+o,e[n]*i,!0)}break;case n.HALF_FLOAT:if(1===r.count)t.setUint16(s+r.offset,P(e*i),!0);else for(let n=0;n<r.count;n++){const o=n*Uint16Array.BYTES_PER_ELEMENT;t.setUint16(s+r.offset+o,P(e[n]*i),!0)}}}function $(t,e,r){switch(e.type){case n.BYTE:{if(1===e.count)return t.getInt8(r+e.offset);const s=[];for(let n=0;n<e.count;n++){const i=n*Int8Array.BYTES_PER_ELEMENT;s.push(t.getInt8(r+e.offset+i))}return s}case n.UNSIGNED_BYTE:{if(1===e.count)return t.getUint8(r+e.offset);const s=[];for(let n=0;n<e.count;n++){const i=n*Uint8Array.BYTES_PER_ELEMENT;s.push(t.getUint8(r+e.offset+i))}return s}case n.SHORT:{if(1===e.count)return t.getInt16(r+e.offset,!0);const s=[];for(let n=0;n<e.count;n++){const i=n*Int16Array.BYTES_PER_ELEMENT;s.push(t.getInt16(r+e.offset+i,!0))}return s}case n.UNSIGNED_SHORT:{if(1===e.count)return t.getUint16(r+e.offset,!0);const s=[];for(let n=0;n<e.count;n++){const i=n*Uint16Array.BYTES_PER_ELEMENT;s.push(t.getUint16(r+e.offset+i,!0))}return s}case n.INT:{if(1===e.count)return t.getInt32(r+e.offset,!0);const s=[];for(let n=0;n<e.count;n++){const i=n*Int32Array.BYTES_PER_ELEMENT;s.push(t.getInt32(r+e.offset+i,!0))}return s}case n.UNSIGNED_INT:{if(1===e.count)return t.getUint32(r+e.offset,!0);const s=[];for(let n=0;n<e.count;n++){const i=n*Uint32Array.BYTES_PER_ELEMENT;s.push(t.getUint32(r+e.offset+i,!0))}return s}case n.FLOAT:{if(1===e.count)return t.getFloat32(r+e.offset,!0);const s=[];for(let n=0;n<e.count;n++){const i=n*Float32Array.BYTES_PER_ELEMENT;s.push(t.getFloat32(r+e.offset+i,!0))}return s}case n.HALF_FLOAT:{if(1===e.count)return x(t.getUint16(r+e.offset,!0));const s=[];for(let n=0;n<e.count;n++){const i=n*Uint16Array.BYTES_PER_ELEMENT;s.push(x(t.getUint16(r+e.offset+i,!0)))}return s}}}function A(t){const e=t.map((({name:t,count:e,type:r})=>`${t}.${e}.${r}`)).join(",");return r(e)}function L(t,e,r,s,n,i,o){if(t.primitiveName===e){let e=s?.readWithDefault(n,i,t[r]&&o);return"text"===t.type&&(e=e.toString()),void(t[r]=e)}if("type"in t&&null!=t.type){if(t.effects)for(const a of t.effects)L(a,e,r,s,n,i,o);switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(t.symbolLayers)for(const a of t.symbolLayers)L(a,e,r,s,n,i,o);break;case"CIMTextSymbol":t.symbol&&L(t.symbol,e,r,s,n,i,o);break;case"CIMHatchFill":t.lineSymbol&&L(t.lineSymbol,e,r,s,n,i,o);break;case"CIMPictureMarker":case"CIMCharacterMarker":case"CIMVectorMarker":if(t.markerPlacement&&L(t.markerPlacement,e,r,s,n,i,o),"CIMVectorMarker"===t.type&&t.markerGraphics)for(const a of t.markerGraphics)L(a,e,r,s,n,i,o),L(a.symbol,e,r,s,n,i,o)}}}function B(t){const e=Math.max(1.25*t.width,20);return null!=t.effects&&t.effects.length>0?400:e}export{g as D,_ as L,f as a,L as b,E as c,N as d,T as e,I as f,h as g,B as h,F as i,m as j,y as k,p as l,U as p,w as t,$ as u,A as v};
