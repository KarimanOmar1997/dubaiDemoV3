/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../Color.js";import{f as t}from"./asyncUtils.js";import"../core/lang.js";import{a as n}from"./screenUtils.js";import{O as o}from"./vec3f64.js";import{e as r}from"./jsonUtils2.js";import{getCIMSymbolColor as l}from"../symbols/support/cimSymbolUtils.js";import{a as i}from"./gfxUtils.js";import{S as s}from"./Symbol3DMaterial.js";import{i as c,a as u}from"./typeUtils.js";const a=new e("white");function f(e){if(!e)return 0;if(c(e)){const t=function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.size}(e);return null!=t?t:0}return n(i(e)?.width)}function m(t){if(!t)return null;if(c(t))return function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.color}(t);const n=i(t)?.color;return n?new e(n):null}function y(e){if(null==e||!("symbolLayers"in e)||null==e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}}function p(e){return e.resource?.href??""}function h(t,n){if(!t)return null;let o=null;return c(t)?o=function(t){const n=t.symbolLayers;if(!n)return null;let o=null;return n.forEach((e=>{"object"===e.type&&e.resource?.href||(o="water"===e.type?e.color:e.material?e.material.color:null)})),o?new e(o):null}(t):u(t)&&(o="cim"===t.type?l(t):t.color?new e(t.color):null),o?b(o,n):null}function b(t,n){if(null==n||null==t)return t;const o=t.toRgba();return o[3]=o[3]*n,new e(o)}function w(t,n,o){t&&(n||null!=o)&&(n&&(n=new e(n)),c(t)?function(e,t,n){const o=e.symbolLayers;if(!o)return;const r=e=>b(t??e??(null!=n?a:null),n);o.forEach((e=>{if("object"!==e.type||!e.resource?.href||t)if("water"===e.type)e.color=r(e.color);else{const t=null!=e.material?e.material.color:null,o=r(t);if(null==e.material?e.material=new s({color:o}):e.material.color=o,null!=n&&"outline"in e&&null!=e.outline?.color&&(e.outline.color=b(e.outline.color,n)),"marker"in e&&null!=e.marker){const t=r(e.marker.color);e.marker.color=t}}}))}(t,n,o):u(t)&&function(e,t,n){(t=t??e.color)&&(e.color=b(t,n)),null!=n&&"outline"in e&&e.outline?.color&&(e.outline.color=b(e.outline.color,n))}(t,n,o))}function d(e){for(const t of e)if("number"==typeof t)return t;return null}function j(e,t,n){for(let o=0;o<3;o++){const r=e[o];switch(r){case"symbol-value":{const e=n[o];return null!=e?e/t[o]:1}case"proportional":break;default:if(r&&t[o])return r/t[o]}}return null}function g(e,t,n,o){switch(e){case"proportional":return n*o;case"symbol-value":return null!=t?t:n;default:return e}}async function k(e,n){if(e&&n)return c(e)?async function(e,n){const r=e.symbolLayers;r&&await t(r,(async e=>async function(e,t){switch(e.type){case"extrude":!function(e,t){const n=t[2];"number"==typeof n&&(e.size=n)}(e,t);break;case"icon":case"line":case"text":!function(e,t){const n=d(t);null!=n&&(e.size=n)}(e,t);break;case"path":!function(e,t){const n=j(t,o,[e.width,void 0,e.height]);null!=n&&(e.width=g(t[0],e.width,1,n),e.height=g(t[2],e.height,1,n))}(e,t);break;case"object":await async function(e,t){const{resourceSize:n,symbolSize:o}=await async function(e){const{computeObjectLayerResourceSize:t}=await import("./symbolLayerUtils.js"),n=await t(e,10),{width:o,height:r,depth:l}=e,i=[o,l,r];let s=1;for(let e=0;e<3;e++){const t=i[e];if(null!=t){s=t/n[e];break}}for(let e=0;e<3;e++)null==i[e]&&(i[e]=n[e]*s);return{resourceSize:n,symbolSize:i}}(e),r=j(t,n,o);null!=r&&(e.width=g(t[0],o[0],n[0],r),e.depth=g(t[1],o[1],n[1],r),e.height=g(t[2],o[2],n[2],r))}(e,t)}}(e,n)))}(e,n):void(u(e)&&function(e,t){const n=d(t);if(null!=n)switch(e.type){case"simple-marker":e.size=n;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=n,e.height=n*t):(e.width=n*t,e.height=n);break}case"simple-line":e.width=n;break;case"text":e.font.size=n}}(e,n))}function L(e,t,n){if(e&&null!=t)if(c(e)){const o=e.symbolLayers;o&&o.forEach((e=>{if("object"===e.type)switch(n){case"tilt":e.tilt=(e.tilt??0)+t;break;case"roll":e.roll=(e.roll??0)+t;break;default:e.heading=(e.heading??0)+t}"icon"===e.type&&(e.angle+=t)}))}else u(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle+=t))}function z(e){if(!e)return null;const t=e.effects.filter((e=>"bloom"!==e.type)).map((e=>e.toJSON()));return r(t)}function S(e){return null!=e&&"polygon-3d"===e.type&&e.symbolLayers.some((e=>"extrude"===e.type))}export{k as a,L as b,w as c,f as d,h as e,z as f,m as g,p as h,y as i,b as j,S as s};
