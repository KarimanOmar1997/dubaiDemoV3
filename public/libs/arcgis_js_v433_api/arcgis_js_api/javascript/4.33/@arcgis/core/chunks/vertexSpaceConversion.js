/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{L as t}from"./Logger.js";import{i as n,e as r,j as e}from"./mathUtils.js";import{E as o,a4 as a,a5 as i,j as s,P as l,c as u,a6 as c}from"./unitUtils.js";import{b as f,f as p}from"./mat3.js";import{c as m}from"./mat3f64.js";import{i as A,e as g,s as T,c as y,m as R}from"./mat4.js";import{c as E,I as d}from"./mat4f64.js";import{q as F,n as N,u as O,k as h,t as P}from"./vec3.js";import{c as _}from"./vec3f64.js";import{g as j,W as w}from"./spatialReferenceEllipsoidUtils.js";import{c as M}from"./computeTranslationToOriginAndRotation.js";import{p as v}from"./projectPointToVector.js";import{i as C,b as S}from"./meshVertexSpaceUtils.js";import{t as x,n as U,a as G,b as L}from"./vec32.js";import{p as b}from"./projectBuffer.js";import{y2lat as V}from"../geometry/support/webMercatorUtils.js";import{d as k,e as B}from"./BufferView.js";import{t as D}from"./vec42.js";const $="Projection may be possible after calling projection.load().";function q(t,n,r,e){t.error(`Failed to project from (wkid:${n.wkid}) to (wkid:${r.wkid}).${e?" ":""}${e}`)}function W(t,n,r,e,o,a){return ot(rt.TO_PCPF,k.fromTypedArray(t),nt.NORMAL,B.fromTypedArray(n),r,B.fromTypedArray(e),o,k.fromTypedArray(a))?a:null}function Y(t,n,r,e,o,a){return ot(rt.FROM_PCPF,k.fromTypedArray(t),nt.NORMAL,B.fromTypedArray(n),r,B.fromTypedArray(e),o,k.fromTypedArray(a))?a:null}function I(t,n,r,e){return b(t,n,0,r,e,0)?r:null}function z(t,n,r,e){return b(t,n,0,r,e,0)?r:null}function H(t,r,e){return f(lt,e),x(r,t,lt),n(lt)&&U(r,r),r}function J(t,r,e){return p(lt,e),D(r,t,lt),n(lt)&&U(r,r,4),r}function K(t,n,e,o){const a=n===nt.NORMAL;return X(t,n,e,((t,n)=>{const e=Math.cos(r(t));n[0]=a?e:1/e,n[1]=1}),o)}function Q(t,n,r,e){const o=n===nt.NORMAL;return X(t,n,r,((t,n)=>{const r=Math.cosh(-t/s.radius);n[0]=1,n[1]=o?r:1/r}),e)}function X(t,n,r,e,o){const a=n===nt.NORMAL?3:4,i=[0,0];for(let n=0,s=1;n<t.length;n+=a,s+=3){e(r[s],i);const l=t[n]*i[0],u=t[n+1]*i[1],c=t[n+2],f=1/Math.sqrt(l*l+u*u+c*c);o[n]=l*f,o[n+1]=u*f,o[n+2]=c*f,4===a&&(o[n+3]=t[n+3])}return o}function Z(t,n,r,e,o,a){if(!ot(rt.TO_PCPF,k.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),nt.TANGENT,B.fromTypedArray(n),r,B.fromTypedArray(e),o,k.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT)))return null;for(let n=3;n<t.length;n+=4)a[n]=t[n];return a}function tt(t,n,r,e,o,a){if(!ot(rt.FROM_PCPF,k.fromTypedArray(t,16),nt.TANGENT,B.fromTypedArray(n),r,B.fromTypedArray(e),o,k.fromTypedArray(a,16)))return null;for(let n=3;n<t.length;n+=4)a[n]=t[n];return a}var nt,rt;function et(t,n,r,e,o){switch(M(e,r,st,e),t===rt.FROM_PCPF&&A(st,st),n){case nt.NORMAL:return f(o,st);case nt.TANGENT:return p(o,st)}}function ot(t,n,r,e,s,l,u,c){if(!n)return;const f=e.count;if(function(t){return t.isWGS84||o(t)||a(t)||i(t)}(s))for(let e=0;e<f;e++)l.getVec(e,at),n.getVec(e,it),F(it,it,et(t,r,at,u,lt)),c.setVec(e,it);else for(let o=0;o<f;o++){l.getVec(o,at),n.getVec(o,it);const a=V(e.get(o,1));let i=Math.cos(a);r===nt.TANGENT!=(t===rt.TO_PCPF)&&(i=1/i),et(t,r,at,u,lt),t===rt.TO_PCPF?(lt[0]*=i,lt[1]*=i,lt[2]*=i,lt[3]*=i,lt[4]*=i,lt[5]*=i):(lt[0]*=i,lt[3]*=i,lt[6]*=i,lt[1]*=i,lt[4]*=i,lt[7]*=i),F(it,it,lt),N(it,it),c.setVec(o,it)}return c}!function(t){t[t.NORMAL=0]="NORMAL",t[t.TANGENT=1]="TANGENT"}(nt||(nt={})),function(t){t[t.TO_PCPF=0]="TO_PCPF",t[t.FROM_PCPF=1]="FROM_PCPF"}(rt||(rt={}));const at=_(),it=_(),st=E(),lt=m(),ut=()=>t.getLogger("esri.geometry.support.meshUtils.vertexSpaceConversion");function ct(t,n,{vertexSpace:r,spatialReference:e}){if("georeferenced"===r.type){const o=t;if(!v(n,o,e))return!1;const{origin:a}=r;return h(t,o,a),!0}const o=j(e),a=t;if(!v(n,a,o))return!1;const{origin:i}=r,s=Ot;if(!M(e,i,s,o))return!1;const l=A(Ot,s);return null!=l&&(P(t,a,l),!0)}function ft(t,n,r){const{vertexSpace:e,transform:o,vertexAttributes:a}=t,i=C(e)?o:null,s=Tt(t.spatialReference,r,ht.SOURCE_AND_TARGET);if(S(e,n)&&(!i||g(i.localMatrix,d))&&yt(s)){const{position:t,normal:n,tangent:e}=a,o=r?.allowBufferReuse;return{position:o?t:t.slice(),normal:o?n:n?.slice(),tangent:o?e:e?.slice()}}switch(t.vertexSpace.type){case"local":return"local"===n.type?function({vertexAttributes:t,spatialReference:n,transform:r},{origin:e},o,a){const i=pt(n,a);if(!M(n,e,Et,i))return q(ut(),n,i),null;if(r&&R(Et,Et,r.localMatrix),!M(n,o,dt,i))return q(ut(),i,n),null;A(dt,dt);const s=R(Et,dt,Et);return gt(s,n,a,ht.SOURCE_AND_TARGET),At(t,s)}(t,t.vertexSpace,n.origin,r):function({spatialReference:t,vertexAttributes:n,transform:r},{origin:e},o,a){const i=pt(t,a);if(!M(t,e,Et,i))return q(ut(),t,i),null;r&&R(Et,Et,r.localMatrix),gt(Et,t,a,ht.SOURCE);const s=new Float64Array(n.position.length),l=function(t,n,r,e,o){L(e,t,Et);const a=new Float64Array(t.length);return z(e,o,a,r)?a:(q(ut(),o,r),null)}(n.position,0,t,s,i);if(!l)return null;const u=function(t,n,r,e,o,a){if(null==o)return null;const i=new Float32Array(o.length);return H(o,i,a),Y(i,t,n,r,e,i)?i:(q(ut(),e,n),null)}(l,t,s,i,n.normal,Et);if(n.normal&&!u)return null;const c=function(t,n,r,e,o,a){if(null==o)return null;const i=new Float32Array(o.length);return J(o,i,a),tt(i,t,n,r,e,i)?i:(q(ut(),e,n),null)}(l,t,s,i,n.tangent,Et);if(n.tangent&&!c)return null;if(o){const t=O(Nt,o);G(l,l,t)}return{position:l,normal:u,tangent:c}}(t,t.vertexSpace,n.origin,r);case"georeferenced":return"local"===n.type?mt(t,t.vertexSpace,n.origin,r):function({vertexAttributes:t,transform:n,spatialReference:r},{origin:e},o,a){const i=Tt(r,a,ht.SOURCE_AND_TARGET),s=e||!yt(i)?y(Et,n?.localMatrix??d):null;s&&gt(s,r,a,ht.SOURCE_AND_TARGET);const{position:l,normal:u,tangent:c}=s?At(t,s):t,f=a?.allowBufferReuse,p=f?l:new Float64Array(l.length);let m=l;if(e&&(m=G(p,m,e)),o){const t=O(Nt,o);m=G(p,m,t)}return{position:m!==t.position||f?m:m.slice(),normal:u!==t.normal||f?u:u?.slice(),tangent:c!==t.tangent||f?c:c?.slice()}}(t,t.vertexSpace,n.origin,r)}}function pt(t,n){return n?.useEllipsoid&&c(t)?w:j(t)}function mt({vertexAttributes:t,spatialReference:n,transform:r},{origin:e},o,a){const i=pt(n,a);if(!M(n,o,Et,i))return q(ut(),n,i),null;const s=1/Tt(n,a,ht.TARGET);T(Et,Et,[s,s,s]);const l=A(dt,Et),{position:u,normal:c,tangent:p}=function(t,n,r){if(!n)return t;if(!r){const{position:r,normal:e,tangent:o}=t;return{position:G(new Float64Array(r.length),r,n),tangent:o,normal:e}}const e=At(t,r.localMatrix);return G(e.position,e.position,n),e}(t,e,r),m=new Float64Array(u.length),g=function(t,n,r,e,o){const a=I(t,n,e,o);if(!a)return q(ut(),n,o),null;const i=new Float64Array(a.length);return L(i,a,r),i}(u,n,l,m,i);if(!g)return null;const y=f(Ft,l),R=function(t,n,r,e,o,a,i){if(null==t)return null;const s=i??new Float32Array(t.length);return W(t,n,r,e,o,s)?(x(s,s,a),s):(q(ut(),r,o),null)}(c,u,n,m,i,y,c!==t.normal?c:void 0);if(!R&&c)return null;const E=function(t,n,r,e,o,a,i){if(null==t)return null;const s=i??new Float32Array(t.length);return Z(t,n,r,e,o,s)?(x(s,s,a,4),s):(q(ut(),r,o),null)}(p,u,n,m,i,y,p!==t.tangent?p:void 0);return!E&&p?null:{position:g,normal:R,tangent:E}}function At(t,n){const r=new Float64Array(t.position.length);L(r,t.position,n);const e=t.normal?new Float32Array(t.normal.length):null,o=t.tangent?new Float32Array(t.tangent.length):null;return e&&t.normal&&H(t.normal,e,n),o&&t.tangent&&J(t.tangent,o,n),{position:r,normal:e,tangent:o}}function gt(t,n,r,e){const o=Tt(n,r,e);yt(o)||T(t,t,[o,o,o])}function Tt(t,n,r){const e=!!(r&ht.SOURCE),o=!!(r&ht.TARGET),a=n?.sourceUnit,i=n?.targetUnit;if(!a&&!i)return 1;let s=Rt(a,t);e||!a||yt(s)||(ut().warn("source unit conversion not supported"),s=1);let l=1/Rt(i,t);return o||!i||yt(l)||(ut().warn("target unit conversion not supported"),l=1),s*l}function yt(t){return e(t,1)}function Rt(t,n){if(null==t)return 1;const r=l(n);return 1/u(r,"meters",t)}const Et=E(),dt=E(),Ft=m(),Nt=_(),Ot=E();var ht;!function(t){t[t.NONE=0]="NONE",t[t.SOURCE=1]="SOURCE",t[t.TARGET=2]="TARGET",t[t.SOURCE_AND_TARGET=3]="SOURCE_AND_TARGET"}(ht||(ht={}));export{nt as V,$ as a,I as b,ft as c,W as d,Z as e,z as f,Rt as g,Y as h,tt as i,K as j,Q as k,q as l,J as m,ct as p,H as t};
