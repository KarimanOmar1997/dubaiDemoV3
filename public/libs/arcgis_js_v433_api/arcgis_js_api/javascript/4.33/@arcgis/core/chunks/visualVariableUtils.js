/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../Color.js";import n from"../Graphic.js";import{l as a}from"../core/lang.js";import{L as i}from"./Logger.js";import{m as t}from"./lengthUtils.js";var l,r;function s(e){return e&&"esri.renderers.visualVariables.SizeVariable"===e.declaredClass}function o(e){return null!=e&&!isNaN(e)&&isFinite(e)}function u(e){return e.valueExpression?l.Expression:e.field&&"string"==typeof e.field?l.Field:l.Unknown}function c(e,n){const a=n||u(e),i=e.valueUnit||"unknown";return a===l.Unknown?r.Constant:e.stops?r.Stops:null!=e.minSize&&null!=e.maxSize&&null!=e.minDataValue&&null!=e.maxDataValue?r.ClampedLinear:"unknown"===i?null!=e.minSize&&null!=e.minDataValue?e.minSize&&e.minDataValue?r.Proportional:r.Additive:r.Identity:r.RealWorldSize}!function(e){e.Unknown="unknown",e.Expression="expression",e.Field="field"}(l||(l={})),function(e){e.Unknown="unknown",e.Stops="stops",e.ClampedLinear="clamped-linear",e.Proportional="proportional",e.Additive="additive",e.Constant="constant",e.Identity="identity",e.RealWorldSize="real-world-size"}(r||(r={}));const f=()=>i.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),d=e=>f().warn(`The visualVariable should be an instance of esri.renderers.visualVariables.${e}`),p=()=>f().error("Use of arcade expressions requires an arcade context"),v=new n,m=Math.PI,b=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function h(n,a,i){const t="visualVariables"in n&&n.visualVariables?n.visualVariables.find((e=>"color"===e.type)):n;if(!t)return;if("esri.renderers.visualVariables.ColorVariable"!==t.declaredClass)return void d("ColorVariable");const l="number"==typeof a,r=l?null:a,s=r?.attributes;let u=l?a:null;const c=t.field,{ipData:f,hasExpression:v}=t.cache;let m=t.cache.compiledFunc;if(!c&&!v){const e=t.stops;return e&&e[0]&&e[0].color}if("number"!=typeof u)if(v){if(null==i?.arcade)return void p();const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},n=i.arcade.arcadeUtils,a=n.getViewInfo(e),l=n.createExecContext(r,a,i.timeZone);if(!m){const e=n.createSyntaxTree(t.valueExpression);m=n.createFunction(e),t.cache.compiledFunc=m}u=n.executeFunction(m,l)}else s&&(u=s[c]);const b=t.normalizationField,h=null!=s&&null!=b?parseFloat(s[b]):void 0;if(null!=u&&(!b||l||!isNaN(h)&&0!==h)){o(h)&&!l&&(u/=h);const n=k(u,f);if(n){const a=n[0],l=n[1],r=a===l?t.stops[a].color:e.blendColors(t.stops[a].color,t.stops[l].color,n[2],null!=i?i.color:void 0);return new e(r)}}}function V(e,n,a){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"opacity"===e.type)):e;if(!i)return;if("esri.renderers.visualVariables.OpacityVariable"!==i.declaredClass)return void d("OpacityVariable");const t="number"==typeof n,l=t?null:n,r=l?.attributes;let s=t?n:null;const u=i.field,{ipData:c,hasExpression:f}=i.cache;let v=i.cache.compiledFunc;if(!u&&!f){const e=i.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof s)if(f){if(null==a?.arcade)return void p();const e={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},n=a.arcade.arcadeUtils,t=n.getViewInfo(e),r=n.createExecContext(l,t,a.timeZone);if(!v){const e=n.createSyntaxTree(i.valueExpression);v=n.createFunction(e),i.cache.compiledFunc=v}s=n.executeFunction(v,r)}else r&&(s=r[u]);const m=i.normalizationField,b=null!=r&&null!=m?parseFloat(r[m]):void 0;if(null!=s&&(!m||t||!isNaN(b)&&0!==b)){o(b)&&!t&&(s/=b);const e=k(s,c);if(e){const n=e[0],a=e[1];if(n===a)return i.stops[n].opacity;{const t=i.stops[n].opacity;return t+(i.stops[a].opacity-t)*e[2]}}}}function x(e,n,a){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"rotation"===e.type)):e;if(!i)return;if("esri.renderers.visualVariables.RotationVariable"!==i.declaredClass)return void d("RotationVariable");const t=i.axis||"heading",l="heading"===t&&"arithmetic"===i.rotationType?90:0,r="heading"===t&&"arithmetic"===i.rotationType?-1:1,s="number"==typeof n?null:n,o=s?.attributes,u=i.field,{hasExpression:c}=i.cache;let f=i.cache.compiledFunc,v=null;if(!u&&!c)return v;if(c){if(null==a?.arcade)return void p();const e={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},n=a.arcade.arcadeUtils,t=n.getViewInfo(e),l=n.createExecContext(s,t,a.timeZone);if(!f){const e=n.createSyntaxTree(i.valueExpression);f=n.createFunction(e),i.cache.compiledFunc=f}v=n.executeFunction(f,l)}else o&&(v=o[u]);return v="number"!=typeof v||isNaN(v)?null:l+r*v,v}function g(e,n,a){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"size"===e.type)):e;if(!i)return;if("esri.renderers.visualVariables.SizeVariable"!==i.declaredClass)return void d("SizeVariable");const t=function(e,n,a){const i="number"==typeof n,t=i?null:n,r=t?.attributes;let s=i?n:null;const{isScaleDriven:u}=e.cache;let c=e.cache.compiledFunc;if(u){const n=null!=a?a.scale:void 0,i=null!=a?a.view:void 0;s=null==n||"3d"===i?function(e){let n=null,a=null;const i=e.stops;return i?(n=i[0].value,a=i[i.length-1].value):(n=e.minDataValue||0,a=e.maxDataValue||0),(n+a)/2}(e):n}else if(!i)switch(e.inputValueType){case l.Expression:{if(null==a?.arcade)return void p();const n={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},i=a.arcade.arcadeUtils,l=i.getViewInfo(n),r=i.createExecContext(t,l,a.timeZone);if(!c){const n=i.createSyntaxTree(e.valueExpression);c=i.createFunction(n),e.cache.compiledFunc=c}s=i.executeFunction(c,r);break}case l.Field:r&&(s=r[e.field]);break;case l.Unknown:s=null}if(!o(s))return null;if(i||!e.normalizationField)return s;const f=r?parseFloat(r[e.normalizationField]):null;return o(f)&&0!==f?s/f:null}(i,n,a),r=z(t,i,n,a,i.cache.ipData);return null==r||isNaN(r)?void 0:r}function S(e,n,a){return null==e?null:s(e)?g(e,n,a):o(e)?e:null}function y(e,n,a){return o(a)&&e>a?a:o(n)&&e<n?n:e}function z(e,n,a,i,l){switch(n.transformationType){case r.Additive:return function(e,n,a,i){const t=S(n.minSize,a,i)||n.minDataValue;return null==e&&null==t?null:(e??0)+(t??0)}(e,n,a,i);case r.Constant:return function(e,n,a){const i=e.stops;let t=i?.length&&i[0].size;return null==t&&(t=e.minSize),S(t,n,a)}(n,a,i);case r.ClampedLinear:return function(e,n,a,i){const t=S(n.minSize,a,i);if(null==e)return t;const{minDataValue:l,maxDataValue:r}=n;if(null==l||null==r)return null;const s=(e-l)/(r-l),o=S(n.maxSize,a,i),u=null!=i?i.shape:void 0;if(e<=l)return t;if(e>=r)return o;if(null==t||null==o)return null;if("area"===n.scaleBy&&u){const e="circle"===u,n=e?m*(t/2)**2:t*t,a=n+s*((e?m*(o/2)**2:o*o)-n);return e?2*Math.sqrt(a/m):Math.sqrt(a)}return t+s*(o-t)}(e,n,a,i);case r.Proportional:return function(e,n,a,i){const t=S(n.minSize,a,i);if(null==e||null==t)return t;const l=null!=i?i.shape:void 0,{minDataValue:r}=n;if(null==r)return null;const s=e/r,o=S(n.maxSize,a,i);let u=null;return u="circle"===l?2*Math.sqrt(s*(t/2)**2):"square"===l||"diamond"===l||"image"===l?Math.sqrt(s*t**2):s*t,y(u,t,o)}(e,n,a,i);case r.Stops:return function(e,n,a,i,t){if(null==e)return null;const[l,r,s]=k(e,t);if(l===r)return S(n.stops?.[l].size,a,i);{const e=S(n.stops?.[l].size,a,i),t=S(n.stops?.[r].size,a,i);return null==e||null==t?null:e+(t-e)*s}}(e,n,a,i,l);case r.RealWorldSize:return function(e,n,a,i){const l=(i?.resolution??1)*t[n.valueUnit],r=S(n.minSize,a,i),s=S(n.maxSize,a,i),{valueRepresentation:o}=n;if(null==e)return r;let u=null;return u="area"===o?2*Math.sqrt(e/m)/l:"radius"===o||"distance"===o?2*e/l:e/l,y(u,r,s)}(e,n,a,i);case r.Identity:return e;case r.Unknown:return null}}function w(e,n,a){const{isScaleDriven:i}=e.cache;if(!(i&&"3d"===a||n))return null;const t={scale:n,view:a};let l=S(e.minSize,v,t),r=S(e.maxSize,v,t);if(null!=l||null!=r){if(l>r){const e=r;r=l,l=e}return{minSize:l,maxSize:r}}}function F(e,n,a){if(!e.visualVariables)return;const i=[],t=[],l=[],r=[],s=[];for(const n of e.visualVariables)switch(n.type){case"color":t.push(n);break;case"opacity":l.push(n);break;case"rotation":s.push(n);break;case"size":r.push(n)}return t.forEach((e=>{const t=h(e,n,a);i.push({variable:e,value:t})})),l.forEach((e=>{const t=V(e,n,a);i.push({variable:e,value:t})})),s.forEach((e=>{const t=x(e,n,a);i.push({variable:e,value:t})})),r.forEach((e=>{const t=g(e,n,a);i.push({variable:e,value:t})})),i}function k(e,n){if(!n)return;let a=0,i=n.length-1;return n.some(((n,t)=>e<n?(i=t,!0):(a=t,!1))),[a,i,(e-n[a])/(n[i]-n[a])]}function C(e,n,i){const t=["proportional","proportional","proportional"];for(const l of e){const e=l.useSymbolValue?"symbol-value":g(l,n,i)??"proportional";switch(l.axis){case"width":t[0]=e;break;case"depth":t[1]=e;break;case"height":t[2]=e;break;case"width-and-depth":t[0]=e,t[1]=e;break;case"all":case void 0:case null:t[0]=e,t[1]=e,t[2]=e;break;default:a(l.axis)}}return t}const E=Object.freeze(Object.defineProperty({__proto__:null,getAllSizes:C,getColor:h,getOpacity:V,getRotationAngle:x,getSize:g,getSizeForValue:z,getSizeFromNumberOrVariable:S,getSizeRangeAtScale:w,getVisualVariableValues:F,viewScaleRE:b},Symbol.toStringTag,{value:"Module"}));export{r as T,x as a,F as b,g as c,c as d,s as e,u as f,C as g,w as h,o as i,h as j,V as k,E as l,b as v};
