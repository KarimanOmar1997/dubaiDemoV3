/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{O as e}from"./ObjectPool.js";import{m as t}from"./handleUtils.js";import{equals as r,equalsShallow as n}from"../core/lang.js";import{schedule as s}from"../core/scheduling.js";import{c as l}from"./SetUtils.js";import{v as o}from"./get.js";import{L as i}from"./Lifecycle.js";import{r as u}from"./tracking.js";import{S as c}from"./SimpleTrackingTarget.js";import{a}from"./utils.js";function d(e){e.length=0}class f{constructor(t=50,r=50){this._pool=new e(Array,void 0,d,r,t)}acquire(){return this._pool.acquire()}release(e){this._pool.release(e)}prune(){this._pool.prune(0)}static acquire(){return h.acquire()}static release(e){return h.release(e)}static prune(){h.prune()}}const h=new f(100);class p extends e{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=null}acquire(...e){const t=super.acquire(...e);return this._set.delete(t),t}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}}let m=0;const _=0;function v(){return++m}let g=!1;const k=[];function q(e,r){let n=new c((function t(){if(!n||l)return;if(g)return void w(t);const o=s;n.clear(),g=!0,l=!0,s=u(n,e),l=!1,g=!1,r(s,o),T()})),s=null,l=!1;return l=!0,s=u(n,e),l=!1,t((function(){n&&(n.destroy(),n=null,s=null)}))}function y(e,r){let n=new c((function(){r(s,l)})),s=null;function l(){return n?(n.clear(),s=u(n,e),s):null}return l(),t((function(){n&&(n.destroy(),n=null),s=null}))}function j(e,r){let n=!1,s=!1;const l=!!r?.sync;let o=new c((()=>{n||s||(s=!0,l?i():queueMicrotask(i))}));function i(){s=!1,o&&!n&&(g?w(i):(o.clear(),g=!0,n=!0,u(o,e),n=!1,g=!1,T()))}return n=!0,u(o,e),n=!1,t((function(){o&&(o.destroy(),o=null)}))}function w(e){k.includes(e)||k.unshift(e)}function T(){for(;k.length;)k.pop()()}var V;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(V||(V={}));class S{constructor(){this.uid=v(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static{this.pool=new p(S)}static acquireUntracked(e,t,n,s,l){return this.pool.acquire(V.Untracked,e,t,n,s,l,r)}static acquireTracked(e,t,r,n){return this.pool.acquire(V.Tracked,e,t,r,null,null,n)}notify(e,t){this.type===V.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t,void 0,void 0)}acquire(e,t,r,n,s,l,o){this.uid=v(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=n,this.target=s,this.path=l,this.equals=o}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=v(),this.removed=!0}}const U=new f,b=new Set;let E;function D(e){b.delete(e),b.add(e),E||(E=s(Y))}function O(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();e.equals(t,r)||(e.oldValue=r,e.notify(r,t))}function R(e){for(const t of b.values())t.target===e&&(t.removed=!0)}function Y(){let e=10;for(;E&&e--;){E=null;const e=x(),t=U.acquire();for(const r of e){const e=r.uid;O(r),e===r.uid&&r.removed&&t.push(r)}for(const e of b)e.removed&&(t.push(e),b.delete(e));for(const e of t)S.pool.release(e);U.release(t),U.release(e),A.forEach((e=>e()))}}function x(){const e=U.acquire();e.length=b.size;let t=0;for(const r of b)e[t]=r,++t;return b.clear(),e}const A=new Set;function L(e){return A.add(e),t((()=>A.delete(e)))}function z(e,n,s,l=!1){return e.__accessor__&&e.__accessor__.lifecycle!==i.DESTROYED?l?function(e,t,n){const s=a(e,t,n,((e,t,n)=>{let l=!1;return q((()=>o(e,t)),((o,u)=>{e.__accessor__.lifecycle!==i.DESTROYED?l||(l=!0,r(u,o)||n.call(e,o,u,t,e),l=!1):s.remove()}))}));return s}(e,n,s):function(e,r,n){let s=a(e,r,n,((e,r,n)=>{let l,u,c=y((()=>o(e,r)),((t,o)=>{e.__accessor__?.lifecycle===i.DESTROYED||l&&l.uid!==u?s.remove():(l||(l=S.acquireUntracked(t,n,o,e,r),u=l.uid),D(l))}));return t((()=>{c.remove(),l&&(l.uid!==u||l.removed||(l.removed=!0,D(l)),l=null),s=c=null}))}));return s}(e,n,s):t()}function M(e,r,s=!1,l=n){return s?function(e,t,r){let n=!1;return q(e,((e,s)=>{n||(n=!0,r(s,e)||t(e,s),n=!1)}))}(e,r,l):function(e,r,n){let s,l,o=y(e,((e,t)=>{s&&s.uid!==l?o.remove():(s||(s=S.acquireTracked(e,r,t,n),l=s.uid),D(s))}));return t((()=>{o.remove(),s&&(s.uid!==l||s.removed||(s.removed=!0,D(s)),s=null),o=null}))}(e,r,l)}function P(e){return l(b,(t=>t.oldValue===e))}export{f as A,p as R,j as a,z as b,L as c,Y as d,v as g,P as i,_ as n,R as r,M as w};
