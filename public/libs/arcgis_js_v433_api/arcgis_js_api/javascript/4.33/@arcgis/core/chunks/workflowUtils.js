/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../Color.js";import t from"../Graphic.js";import{i as a,e as r,clone as n,a as o}from"../core/lang.js";import{c as i}from"./asyncUtils.js";import s from"../core/Error.js";import{h as l,m as c,a as u}from"./handleUtils.js";import{L as d}from"./Logger.js";import{g as p}from"./MapUtils.js";import{debounce as f,isPromiseLike as y,throwIfAborted as m,whenOrAbort as h}from"../core/promiseUtils.js";import{watch as b,on as g,whenOnce as w}from"../core/reactiveUtils.js";import{a as I}from"./screenUtils.js";import{d as v}from"./diffUtils.js";import{b as T,f as S,g as F,h as j,e as k,a as A,d as L}from"./templateUtils2.js";import{g as U}from"./SharedTemplateProvider.js";import V from"../layers/GraphicsLayer.js";import{featureHasFields as O,fixFields as M,getDisplayFieldName as x}from"../layers/support/fieldUtils.js";import{b as E}from"./layerUtils.js";import{a as z,c as q}from"./drapedUtils.js";import{m as P}from"./lengthUtils.js";import{i as C}from"./typeUtils3.js";import{d as D,T as R}from"./visualVariableUtils.js";import G from"../symbols/SimpleFillSymbol.js";import B from"../symbols/SimpleLineSymbol.js";import N from"../symbols/SimpleMarkerSymbol.js";import{t as Z}from"../symbols/support/jsonUtils.js";import{getDisplayedSymbol as W}from"../symbols/support/symbolUtils.js";import{G as J}from"./GraphicState.js";import{a as Q}from"./DrawingMode.js";import{f as $,h as H}from"./hitTestSelectUtils.js";import{i as K}from"./sketchUtils.js";class X{constructor(e){this.id=e,this.afters=[]}}function Y(e,t){return e<t?1:e>t?-1:0}function _(e){return!!e&&"features"in e}function ee(e){return null!=e&&"create-features"===e.type}function te(e){return null!=e&&"update-features"===e.type}function ae(e){return null!=e&&/update-/.test(e.type)&&"fullFeature"in e}function re(e){return null!=e&&"update"===e.type}function ne(e){if(!(e&&"renderer"in e&&ce(e.renderer)))return{rotation:null,size:null};const t=e.renderer.getVisualVariablesForType("rotation").filter((e=>(!e.axis||"heading"===e.axis)&&e.field&&!e.valueExpression)),a=e.renderer.getVisualVariablesForType("size").filter((e=>e.field&&!e.useSymbolValue&&!e.valueExpression&&D(e)===R.RealWorldSize));return{rotation:1===t.length?t[0]:null,size:1===a.length?a[0]:null}}function oe(e){const t=e.sourceLayer;if(!(t&&"renderer"in t&&ce(t.renderer)))return{rotation:null,size:null};const{rotation:a,size:r}=ne(t);let n=null,o=null;if(a){const e=t.fields?.filter((e=>e.name===a.field)),r=1===e?.length?e[0]:null;n=ie(a,r)}if(r){const e=t.fields?.filter((e=>e.name===r.field)),a=1===e?.length?e[0]:null;o=se(r,a)}return{rotation:n,size:o}}function ie(e,t){const a="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,r=t?.type??"double",n={initial:0,current:0};return{field:e.field,fieldType:r,getDefaultValue:()=>Promise.resolve(0),getValue:e=>(n.current=n.initial-a*e,le((n.current+360)%360,r)),setInitialValue:e=>{n.initial=e,n.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}function se(e,t){const a=e.axis,r=t?.type??"double",n={initial:0,current:0},o=P[e.valueUnit]??1;let i;return i="area"===e.valueRepresentation?e=>(e*o/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*o/2:e=>e*o,{field:e.field,fieldType:r,getDefaultValue:async(e,t)=>le(i(await async function(e,t,a){if(null==t)return 0;const{symbol:r}=Z(t);if(null==r||"web-style"===r.type||"cim"===r.type)return 0;const n=r.symbolLayers.at(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("./symbolLayerUtils.js");return Math.min(Ce.icon,(await e(n,Ce.icon))[0])||Ce.icon}case"text":return Ce.text;case"line":return Ce.line;case"object":{const{computeObjectLayerResourceSize:t}=await import("./symbolLayerUtils.js");return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await t(n,e.scale/Ce.viewScaleSizeFactor),a)}case"path":case"extrude":return e.scale/Ce.viewScaleSizeFactor;default:return 0}}(t,e,a)),r),getValue:(e,t)=>(n.initial||(n.initial=t.pixelSizeAt(t.center)),n.current=n.initial*e,le(n.current,r)),setInitialValue:e=>{n.initial=e,n.current=0},isUpdatingInteractively:!1,displayUnit:(s=e.valueUnit,"unknown"===s?null:s),axis:e.axis};var s}function le(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function ce(e){if(!C(e))return!1;switch(e?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}async function ue(e,t,a){const r=await W(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t,scale:a});null!=v(e.symbol,r)&&(e.symbol=r)}function de(e,t){if(!e||!t)throw new Error("no geometry type");if("multipatch"===e)return{tool:"mesh",createOptions:{mode:"hybrid"}};const a=new Map;a.set("circle",{mode:"freehand"}),a.set("rectangle",{mode:"freehand"});const r={mode:Q,optionsPerTool:a};if(T(t)){const n=t.defaultTool,o=S(t)?t.definition?.inputGeometryType??e:e;switch(n){case"freehand":case"stream-line":return{tool:"polyline"===o?"freehandPolyline":"freehandPolygon",createOptions:r};case"autocomplete-freehand-polygons":case"stream-polygon":return{tool:"freehandPolygon",createOptions:r};case"autocomplete-polygons":case"difference-polygon":case"create-structures":case"polygon":case"trace":return{tool:"polygon"===o?"polygon":"polyline",createOptions:r};case"circle":return a.get("circle").preserveAspectRatio=!0,{tool:"circle",createOptions:r};case"ellipse":return a.get("circle").preserveAspectRatio=!1,{tool:"circle",createOptions:r};case"create-points-along-line":case"multipoint":return{tool:"multipoint",createOptions:r};case"line":case"radial-line":case"right-angle-line":case"split":case"two-point-line":return{tool:"polyline",createOptions:r};case"rectangle":case"regular-polygon":case"right-angle-polygon":return{tool:"rectangle",createOptions:r};case"elevation-point-from-contour":case"elevation-point-from-dem":case"parcel-seed":case"point":case"point-and-rotation":case"point-at-end-of-line":return{tool:"point",createOptions:r}}}else{const n=t.drawingTool;if("circle"===n||"ellipse"===n)return a.get("circle").preserveAspectRatio="circle"===n,{tool:"circle",createOptions:r};if("rectangle"===n)return{tool:"rectangle",createOptions:r};if("freehand"===n)return{tool:"polygon"===e?"freehandPolygon":"freehandPolyline",createOptions:r}}return{tool:e,createOptions:r}}async function pe(e,t,a){const{creationInfo:r,fullTemplate:n}=t;if(!r)throw new s("featureworkflow","No creation info provided.");const o=r.layer,i=Fe(n,r.attributeOverrides),{view:l}=e,c="2d"===l?.type;S(n)||k(n)||await je(e,o,i,a,c?l.scale:null);const{capabilities:u}=o;e.layer.elevationInfo=o.elevationInfo;const d=de(o.geometryType,n);e.defaultCreateOptions={graphicProperties:{attributes:i,sourceLayer:o},mode:d.createOptions.mode,optionsPerTool:d.createOptions.optionsPerTool,preserveAspectRatio:d.createOptions.preserveAspectRatio,hasZ:u.data.supportsZ,defaultZ:(c?u.editing.zDefault:null)??e.defaultCreateOptions.defaultZ},null==r.geometryToPlace?await e.create(d.tool):await e.place(r.geometryToPlace,{graphicProperties:{attributes:i,sourceLayer:o}})}async function fe(e){return l([await ye(e),await me(e)])}async function ye({creationAttributes:e,data:t,sketchViewModel:a,view:r,webStyleCache:n}){const{creationInfo:o}=t,{fullTemplate:i}=t;if(!o||"2d"!==r?.type||S(i)||k(i))return null;const s=f((t=>je(a,o.layer,e,n,t)));return b((()=>r.scale),(e=>s(e)))}async function me({data:t,sketchViewModel:a,view:n}){const{templateExecutorInfo:o}=t;if(!o)return null;const i=a.activeComponent;if(!n||!K(i))return d.getLogger("esri.widgets.Editor.workflowUtils").error(new s("featureworkflow","Failed to set up template feedback.")),null;const u=new V({effect:"saturate(0.6) opacity(0.8)",listMode:"hide",title:"Shared Template Feedback Graphics"});n.map?.add(u);const{executor:p,serviceLayersById:f}=o,m=n.theme?.accentColor??new e([255,165,0,1]);return l([g((()=>i),["cursor-update","vertex-add"],(()=>{u.removeAll();const e=i.graphic?.geometry;if(!e||!function(e){switch(e.type){case"point":case"multipoint":return!0;case"polyline":return e.paths[0].length>1;case"polygon":{const t=e.rings[0];return r(t.at(0),t.at(-1))?t.length>2:t.length>1}default:return!1}}(e))return;const t=p(e,"digitizing");if(!y(t))for(const e of t.edits){const t=f.get(e.id);if(t&&e.addFeatures&&0!==e.addFeatures.length)for(const a of t)if(!a.isTable)for(const t of e.addFeatures){const e=he(t,m);e&&u.add(e)}}})),c((()=>{n.map.remove(u),u.destroy()}))])}function he(e,a){let r=null;switch(e.geometry?.type){case"point":case"multipoint":r=new N({angle:0,color:a,outline:new B({cap:"round",color:a,join:"round",miterLimit:1,style:"solid",width:1}),path:"undefined",size:8,style:"circle",xoffset:0,yoffset:0});break;case"polygon":r=new G({color:a,outline:new B({cap:"round",color:a,join:"round",miterLimit:1,style:"solid",width:3}),style:"none"});break;case"polyline":r=new B({cap:"round",color:a,join:"round",miterLimit:1,style:"solid",width:2});break;default:return null}return new t({geometry:e.geometry,symbol:r,attributes:{...e.attributes}})}async function be(e,t){const a=await F(t).load(),r=E(e)?e.parent:e;return a.tablesAndLayersLookup.get(r)}async function ge(e,t){const a=await be(e,t);if(!a)return new Map;const r=new Map;for(const e of a.layersAndTables)p(r,e.layerId,(()=>[])).push(e);return r}function we(e){const t=e.objectIdField,a=e.globalIdField??"";return{id:e.layerId,identifierFields:{objectIdField:t,globalIdField:a},addFeatures:[],deleteAttachments:[],addAttachments:[],deleteFeatures:[],updateFeatures:[]}}function Ie(e){const{edits:t,serviceInfo:r,view:n,findOriginalFeature:o}=e,i=function(e){const t=new Map;for(const a of e)t.set(a.layerId,a);return t}(r.layersAndTables),l=r.layersAndTables.toArray(),{allEditData:c,editDataByLayerIdMap:u,editDataByIdMap:d}=function(e,t,a){const r=new Map,n=[],o=new Map;let i=1;for(const l of e){const e=[],c=t.get(l.id);if(!c)throw new s("featureworkflow",`Failed to prepare applyEdits payload. Layer with id ${l.id} not found.`);for(const t of l.addFeatures??[])e.push({uniqueId:"T"+i++,operationType:"add",layer:c,after:t});for(const t of l.deleteFeatures??[])e.push({uniqueId:"T"+i++,operationType:"delete",before:t,layer:c});for(const t of l.deleteAttachments??[])e.push({uniqueId:"T"+i++,operationType:"deleteAttachment",attachmentId:t,layer:c});for(const t of l.addAttachments??[])e.push({uniqueId:"T"+i++,operationType:"addAttachment",attachment:t,layer:c});for(const t of l.updateFeatures??[])e.push({uniqueId:"T"+i++,operationType:"modify",before:a(t),after:t,layer:c});r.set(c.layerId,e);for(const t of e)n.push(t),o.set(t.uniqueId,t)}return{allEditData:n,editDataByIdMap:o,editDataByLayerIdMap:r}}(t,i,o),p=function(e,t){const a=new Map;for(const r of e)for(const e of r.relationships??[])if(a.set(ve(r,e),""),t.has(e.relatedTableId)){const n=t.get(e.relatedTableId);if(n.length>0)for(const t of n[0].layer.relationships??[])if(t.id===e.id){a.set(ve(r,e),t.keyField);break}}return a}(l,u),f=function(e,t,a){const r=[];for(const n of e){const e=n.layer.relationships??[],{uniqueId:o}=n;for(const i of e){const e=i.keyField;if("origin"===i.role){const s=a.get(i.relatedTableId);if(!s||0===s.length)continue;const l=ve(n.layer,i),c=t.get(l);if(void 0===c||""===c)continue;switch(n.operationType){case"add":for(const t of s)t!==n&&("add"!==t.operationType&&"modify"!==t.operationType||t.after.attributes[c]===n.after.attributes[e]&&r.push([o,t.uniqueId]));break;case"modify":if(n.before.attributes[e]!==n.after.attributes[e])for(const t of s){const a=t.uniqueId;t!==n&&("delete"===t.operationType?t.before.attributes[c]===n.before.attributes[e]?r.push([a,o]):t.before.attributes[c]===n.after.attributes[e]&&r.push([o,a]):"add"===t.operationType?t.after.attributes[c]===n.after.attributes[e]?r.push([o,a]):t.after.attributes[c]===n.before.attributes[e]&&r.push([a,o]):"modify"===t.operationType&&(t.before.attributes[c]!==t.after.attributes[c]?t.after.attributes[c]===n.after.attributes[e]?r.push([o,a]):r.push([a,o]):r.push([o,a])))}break;case"delete":for(const t of s)t!==n&&("delete"!==t.operationType&&"modify"!==t.operationType||t.before.attributes[c]===n.before.attributes[e]&&r.push([t.uniqueId,o]))}}}}return r}(c,p,u);if(n&&function(e,t,a){const r=[];for(const t of e)Te(t.layer,a)&&r.push(t);if(0===r.length)return;let n=[];for(const a of r){const r=a.layer;switch(a.operationType){case"delete":n=[...Se(a.before.attributes[r.fieldsIndex.get("fromglobalid").name],e),...Se(a.before.attributes[r.fieldsIndex.get("toglobalid").name],e)];for(const e of n)t.push([a.uniqueId,e.uniqueId]);break;case"add":n=[...Se(a.after.attributes[r.fieldsIndex.get("fromglobalid").name],e),...Se(a.after.attributes[r.fieldsIndex.get("toglobalid").name],e)];for(const e of n)t.push([e.uniqueId,a.uniqueId])}}}(c,f,n),0===f.length)return t;const y=function(e,t){const a={};t=t||{continueOnCircularDependency:!1};const r=[],n={};e.forEach((e=>{const t=e[0];let r;(r=a[t])||(r=a[t]=new X(t)),e.forEach((e=>{e!==t&&(a[e]||(a[e]=new X(e)),r.afters.push(e))}))}));const o=Object.keys(a);return o.sort(Y),o.forEach((function e(o,i){const s=a[o],l=s.id;if(n[o])return;const c=Array.isArray(i)?i:[];c.push(l),n[o]=!0,s.afters.sort(Y),s.afters.forEach((a=>{if(c.includes(a)){if(t?.continueOnCircularDependency)return;throw new Error("Circular chain found: "+l+" must be before "+a+" due to a direct order specification, but "+a+" must be before "+l+" based on other specifications.")}e(a,c.slice())})),r.push(l)})),r.reverse()}(f,{continueOnCircularDependency:!0}),m=y.map((e=>d.get(e))).filter(a),h=new Map;for(const e of m)h.set(e.uniqueId,e);const b=[];for(const e of c)h.has(e.uniqueId)||b.push(e);const g=[];let w=null;for(const e of m){const{layer:t}=e;switch(null==w?w=we(t):w.id!==t.layerId&&(g.push(w),w=we(t)),e.operationType){case"add":case"modify":w.addFeatures.push(e.after);break;case"delete":w.deleteFeatures.push(e.before)}}null!==w&&g.push(w);for(const e of b){const t=e.layer.layerId,a=g.find((e=>e.id===t))??we(e.layer);switch(g.includes(a)||g.push(a),e.operationType){case"add":a.addFeatures.push(e.after);break;case"modify":a.updateFeatures.push(e.after);break;case"delete":a.deleteFeatures.push(e.before);break;case"deleteAttachment":a.deleteAttachments.push(e.attachmentId);break;case"addAttachment":a.addAttachments.push(e.attachment)}}for(const e of g)void 0!==e.deleteAttachments&&0===e.deleteAttachments.length&&delete e.deleteAttachments,void 0!==e.addAttachments&&0===e.addAttachments.length&&delete e.addAttachments;return g}function ve(e,t){return`${e.layerId}:${t.id}`}function Te(e,t){return!!(t?.map&&"utilityNetworks"in t.map&&t.map.utilityNetworks?.length&&t.map.utilityNetworks.some((t=>!(!t.loaded||!e.url?.startsWith(t.featureServiceUrl)||e.layerId!==t.networkSystemLayers.associationsTableId))))}function Se(e,t){const a=[],r=t.filter((({layer:e})=>""!==e.globalIdField&&null!=e.globalIdField));for(const t of r){const r=t.layer.globalIdField;("before"in t&&t.before?.attributes[r]===e||"after"in t&&t.after?.attributes[r]===e)&&a.push(t)}return a}function Fe(e,t={}){return S(e)||k(e)?{}:A(e)?{...e.prototype.attributes,...t}:L(e)?{...e.definition?.defaultValues,...t}:{...t}}async function je(e,a,r,n,o){const i=new t({sourceLayer:a,attributes:r}),{rotation:s,size:l}=oe(i);let c=await W(i,{useSourceLayer:!0,webStyleCache:n,scale:o}),u=!1;for(const t of[l,s])null!=t&&null==r[t.field]&&(r[t.field]=await t.getDefaultValue(c,e.view),u=!0);switch(u&&(c=await W(i,{useSourceLayer:!0,webStyleCache:n,scale:o})),c?.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=c;break;case"simple-line":case"line-3d":e.polylineSymbol=c;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":e.pointSymbol=c;break;case"mesh-3d":e.meshSymbol=c}ke(e.tooltipOptions,l,s)}function ke(e,t,a){e.visualVariables=null!=t||null!=a?{size:null!=t?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:null!=a?{valueType:a.fieldType,rotationType:a.rotationType??"geographic"}:null}:null}function Ae(e,t){return e?.find((e=>e.layer===t))}async function Le(e,t,a,r){switch(t.type){case"3d":return async function(e,t,a,r){if(0===e.length)return[];const{updatable:n,graphicsByLayer:i}=await a.defer((async()=>{const{results:n}=await h(H(t,a),r),o=new Map;$(n).forEach((({graphic:e})=>(e=>{const t=e.layer,a=o.get(t);if(!a){const e=new Array;return o.set(t,e),e}return a})(e).push(e)));const i=e.filter((({capabilities:e,layer:t})=>e.update.enabled&&o.has(t)));return 0!==i.length&&a.stopPropagation(),{updatable:i,graphicsByLayer:o}}));return h(Promise.allSettled(n.map((async({layer:e})=>{const t=i.get(e),a=Ue(e);if(t.every((e=>O(e,a))))return t;const n=[];for(const e of t){n.push(e.getObjectId());const t=Object.keys(e.attributes);o(a,t)}const s=e.createQuery();return s.returnGeometry=!1,s.objectIds=n,s.outFields=M(e.fieldsIndex,a),e.queryFeatures(s,{signal:r}).then((({features:e})=>e))}))),r)}(e,t,a,r);case"2d":return async function(e,t,a,r){if(0===e.length)return[];const{mapPoint:n}=a;if(null==n)return[];let o=null;const i=await a.defer((async()=>{const{results:n}=await h(t.hitTest(a),r);if(0===n.length)return[];const i=new Set;o=$(n),o.forEach((({graphic:e})=>e&&i.add(e.layer)));const s=e.filter((e=>i.has(e.layer)&&e.supportsUpdateWorkflow));return s.length>0&&a.stopPropagation(),s}));return h(Promise.allSettled(i.map((async({layer:e})=>{const i=e.createQuery();i.returnGeometry=!0,i.outFields=Ue(e);const s="renderer"in e?z({renderer:e.renderer,pointerType:a.pointerType}):0;i.geometry=q(n,s,t),i.outSpatialReference=t.spatialReference;const{features:l}=await e.queryFeatures(i,{signal:r});return o?.forEach((({graphic:t})=>{t.layer!==e||l.some((e=>e.getObjectId()===t.getObjectId()))||l.push(t)})),l}))),r)}(e,t,a,r)}}function Ue(e){return M(e.fieldsIndex,[e.objectIdField,x({displayField:"displayField"in e?e.displayField:null,fields:e.fields})])}async function Ve(e,t,r,n){const o=t.createQuery();o.objectIds=e.map((e=>e.getObjectId())).filter(a),o.outFields=["*"],o.returnM=t.capabilities.data.supportsM,o.returnZ=t.capabilities.data.supportsZ,"scene"===t.type&&null!=t.infoFor3D||(o.outSpatialReference=r);const i=await t.queryFeatures(o,{signal:n});return m(n),i.features}function Oe(e){const t=new Map;for(const a of e){const e=a.sourceLayer,r=E(e)?e.parent:e;p(t,r,(()=>[])).push(a)}return t}async function Me(e){const{graphic:t,sketchViewModel:a,sourceLayer:r,visualVariables:n}=e;await xe(e);const o={multipleSelectionEnabled:!1};return"point"===r.geometryType&&(o.enableRotation=null!=n.rotation,o.enableScaling=null!=n.size),a.update(t,o)}async function xe(e){const{graphic:t,sketchViewModel:a,sourceLayer:r,visualVariables:n,webStyleCache:o}=e;let i=!1;const{rotation:s,size:l}=n;for(const e of[s,l]){if(null==e)continue;const r=t.getAttribute(e.field);if(null!=r)e.setInitialValue(r);else{const r=await e.getDefaultValue(t.symbol,a.view);e.setInitialValue(r),t.setAttribute(e.field,r),i=!0}}if(i){const e="2d"===a.view?.type?a.view.scale:null;await ue(t,o,e)}ke(a.tooltipOptions,l,s),a.layer.elevationInfo=r.elevationInfo}function Ee(e,t,a,r){if(null==t.geometry||"point"!==t.geometry?.type)return!1;const n=t.attributes;let o=!1;const i=r.rotation,s=null==(l=a.toolEventInfo)||"rotate-start"!==l.type&&"rotate"!==l.type&&"rotate-stop"!==l.type?null:l;var l;if(null!=i&&null!=s){const{field:a,getValue:r}=i;if("rotate-stop"===s.type)i.isUpdatingInteractively=!1,i.setInitialValue(t.getAttribute(a));else{i.isUpdatingInteractively=!0;const l=r(s.angle,e);l!==n[a]&&t.setAttribute(a,l),o=!0}}const c=r.size,u=function(e){return null==e||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}(a.toolEventInfo);if(null!=c&&null!=u){const{field:a,getValue:r}=c;if("scale-stop"===u.type)c.isUpdatingInteractively=!1,c.setInitialValue(t.getAttribute(a));else{c.isUpdatingInteractively=!0;const i=r(u.xScale,e);i!==n[a]&&t.setAttribute(a,i),o=!0}}return o}async function ze({feature:e,featureClone:t,visualVariableAttributes:a,sketchViewModel:r,view:n,onUpdate:o,webStyleCache:i,addUpdatingPromise:s,addHandle:d}){await ue(t,i,"2d"===n.type?n.scale:null);let p=null;if("2d"===r?.view?.type){const e=f((e=>ue(t,i,e)));p=b((()=>r?.view?.scale),(t=>e(t)))}const y=t.sourceLayer,m=Ne(n,y);await Me({graphic:t,sketchViewModel:r,sourceLayer:y,visualVariables:a,webStyleCache:i});let h=null;m.then((e=>h=e)).catch((()=>{}));const g=a.size,I=a.rotation,v=b((()=>e.attributes),(async e=>{let a=!1;for(const r in e){const n=e[r];n!==t.getAttribute(r)&&(t.setAttribute(r,n),null==g||g.isUpdatingInteractively||g.field!==r||g.setInitialValue(n),null==I||I.isUpdatingInteractively||I.field!==r||I.setInitialValue(n),(null==h||h.requiredFields.includes(r))&&(a=!0))}a&&await ue(t,i,"2d"===n.type?n.scale:null)})),T=r.on("update",(async e=>{const t=e.graphics[0],l={graphic:t,sketchViewModel:r,sourceLayer:y,visualVariables:a,webStyleCache:i};if("complete"===e.state){if(null===n.activeTool)return Me(l);const e=new AbortController,t=u(e);return d(t),s(w((()=>null===n.activeTool),e.signal).then((async()=>{if(!e.signal.aborted)return e.abort(),Me(l)})))}Ee(n,t,e,a)&&await ue(t,i,"2d"===n.type?n.scale:null),o(We(t),e)})),S=r.on(["undo","redo"],(async e=>{o(We(e.graphics[0]),e)}));return l([S,T,c((()=>r.cancel())),v,p])}async function qe(e,t,a){const r=e.view;e.layer.add(a);const n=t.sourceLayer,o=t.layer,s=t.getAttribute(o.objectIdField);let u=null;function d(e){u?.abort(),u=i((async t=>{const a=await Ne(r,n);m(t),a.setVisibility?.(s,e)}))}return await async function(e,t){if("3d"===e.type){const a=new J({graphic:t}),r=e.trackGraphicState(a);await w((()=>a.displaying||a.error)),r.remove()}else await w((()=>t.visible))}(r,a),d(!1),l([Pe(r,a,(e=>d(!e))),c((async()=>{d(!0);try{if(!r.destroyed){const e=await Ne(r,n).catch((()=>{}));e&&!e.destroyed&&await w((()=>!e.updating))}}finally{e.layer.remove(a)}}))])}function Pe(e,t,a){if("3d"===e.type){const r=new J({graphic:t});return l([e.trackGraphicState(r),b((()=>r.displaying),a)])}return b((()=>t.visible),a)}const Ce={icon:I(24),text:I(12),line:I(1),viewScaleSizeFactor:100};function De(e,t,a){let r=!1;return e.filter((e=>!!r||(r=e===t,r))).map((e=>a[e]()))}function Re(e,t){e.viewModel.syncFeatureTemplates();const a=e.creationInfo;if("awaiting-feature-creation-info"===t[0].id&&a){const r=a.layer,n=e.viewModel.getTemplatesForLayer(r);1===n.length&&"scene"!==r.type&&(a.template=n[0],t.shift())}return t}function Ge(e){e.filesEnabled=!0,e.mode="view",e.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}const Be=e=>/-stop/.test(e)||/vertex-/.test(e),Ne=(e,t)=>{const a="subtype-sublayer"===t.type?t.parent:t;return e.whenLayerView(a)};function Ze(e){return"createInteractiveEditSession"in e}function We(e){const t=e.geometry;if("mesh"===t?.type){const a=e.cloneShallow();return a.attributes=n(e.attributes),a.geometry=t.cloneShallow(),a.geometry.transform=t.transform?.clone()??null,a}return e.clone()}function Je(e){const t=e.cursor;return e.cursor="progress",c((()=>e.cursor=t))}async function Qe(e,t){const{template:a}=e;if(null==a)return null;if(j(a))return a.load();if(T(a)){const e=(await import("../editing/sharedTemplates/SharedTemplate.js")).default,r=U(t,{makeSharedTemplateFromJSON:t=>e.fromJSON(t)}),n=await r.getTemplates({templateIds:[a.templateId],featureService:a.featureService});if(0===n.length)throw new s("editor:failed-to-load-template","Unable to load the provided template");return n[0].load()}return a}function $e(e){for(const t of e){const{destinationGraphic:e,destinationField:a,sourceGraphic:r,sourceField:n}=t;e.setAttribute(a,r.getAttribute(n))}}function He(e){const t=e.templateExecutorInfo?.completionResults;return t?.length?(t.forEach((e=>$e(e.relationships))),t.flatMap((e=>e.edits))):null}function Ke(e){if(null==e)return[];if(te(e))return e.data.layers;const t=re(e)?e.activeWorkflow:e,a=t?.layer;return a?[a]:[]}function Xe(){return new s("editing:multiple-layers-not-supported","UpdateFeaturesWorkflow does not support updating features from multiple layers.")}export{ie as A,Ne as B,Xe as C,ze as D,We as E,Ze as F,ae as G,Le as H,Ke as I,ee as J,te as K,re as L,_ as M,He as a,be as b,de as c,Qe as d,ge as e,Ve as f,Oe as g,pe as h,Ae as i,Be as j,oe as k,Me as l,De as m,Re as n,Ie as o,Fe as p,fe as q,$e as r,Je as s,Ge as t,ue as u,xe as v,Ee as w,ne as x,qe as y,se as z};
