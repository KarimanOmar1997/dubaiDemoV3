/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import r,{O as t,h as s,n as i}from"./Accessor.js";import{clone as n,e as o}from"./lang.js";import{v as a,e as u,g as l}from"../chunks/get.js";import{g as c,m as f}from"../chunks/utils.js";import{o as p,a as g,b as h,subclass as d}from"./accessorSupport/decorators/subclass.js";import m from"./Error.js";import{L as O}from"../chunks/Logger.js";import"./Handles.js";import"../chunks/maybe.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/handleUtils.js";import"../chunks/tracking.js";import"./accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import"../chunks/MapUtils.js";import"../config.js";import"../chunks/watch.js";import"./scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"./promiseUtils.js";import"../chunks/events.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../chunks/Warning.js";class y{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new y;return this._values.forEach(((t,s)=>{e&&e.has(s)||r.set(s,n(t.value),t.origin)})),r}get(e,r){r=this._normalizeOrigin(r);const t=this._values.get(e);return null==r||t?.origin===r?t?.value:void 0}originOf(e){return this._values.get(e)?.origin??t.USER}keys(e){e=this._normalizeOrigin(e);const r=[...this._values.keys()];return null==e?r:r.filter((r=>this._values.get(r)?.origin===e))}set(e,r,s){if((s=this._normalizeOrigin(s))===t.DEFAULTS){const r=this._values.get(e);if(null!=r?.origin&&r.origin>s)return}this._values.set(e,new w(r,s))}delete(e,r){null!=(r=this._normalizeOrigin(r))&&this._values.get(e)?.origin!==r||this._values.delete(e)}has(e,r){return null!=(r=this._normalizeOrigin(r))?this._values.get(e)?.origin===r:this._values.has(e)}isAtOrigin(e,r){return r=this._normalizeOrigin(r),this.has(e,r)&&this.originOf(e)===r}isBelowOrigin(e,r){return r=this._normalizeOrigin(r),!this.has(e)||this.originOf(e)<r}forEach(e){this._values.forEach((({value:r},t)=>e(r,t)))}_normalizeOrigin(e){if(null!=e)return e===t.DEFAULTS?e:t.USER}}class w{constructor(e,r){this.value=e,this.origin=r}}function j(e,r,s){r.keys().forEach((e=>{s.set(e,r.get(e),t.DEFAULTS)}));const i=e.metadata;Object.keys(i).forEach((r=>{e.internalGet(r)&&s.set(r,e.internalGet(r),t.DEFAULTS)}))}function v(e,r,t){if(!e?.read||!1===e.read.enabled||!e.read.source)return!1;const s=e.read.source;if("string"==typeof s){if(s===r)return!0;if(s.includes(".")&&0===s.indexOf(r)&&u(s,t))return!0}else for(const e of s){if(e===r)return!0;if(e.includes(".")&&0===e.indexOf(r)&&u(e,t))return!0}return!1}function S(e,r,t,s,i){let n=p(r[t],i);(function(e){return e&&(!e.read||!1!==e.read.enabled&&!e.read.source)})(n)&&(e[t]=!0);for(const o of Object.getOwnPropertyNames(r))n=p(r[o],i),v(n,t,s)&&(e[o]=!0)}function k(e,r,t,s){const i=t.metadata,n=g(i[r],s),o=n?.default;if(void 0===o)return;const a="function"==typeof o?o.call(e,r,s):o;void 0!==a&&t.set(r,a)}const N={origin:"service"};function _(e,r,t=N){if(!r||"object"!=typeof r)return;const s=c(e),i=s.metadata,n={};for(const e of Object.getOwnPropertyNames(r))S(n,i,e,r,t);s.setDefaultOrigin(t.origin);for(const o of Object.getOwnPropertyNames(n)){const n=p(i[o],t).read,u=n?.source;let l;l=u&&"string"==typeof u?a(r,u):r[o],n?.reader&&(l=n.reader.call(e,l,r,t)),void 0!==l&&s.set(o,l)}if(!t||!t.ignoreDefaults){s.setDefaultOrigin("defaults");for(const r of Object.getOwnPropertyNames(i))n[r]||k(e,r,s,t)}s.setDefaultOrigin("user")}function b(e,r,t,s=N){const i={...s,messages:[]};t(i),i.messages?.forEach((r=>{"warning"!==r.type||e.loaded?s?.messages&&s.messages.push(r):e.loadWarnings.push(r)}))}function E(e,r,t,s,i){const n={};return r.write?.writer?.call(e,s,n,t,i),n}function T(e,r,s,n,a,u){if(!n?.write)return!1;const c=l(e,s);if(!a&&n.write.overridePolicy){const r=n.write.overridePolicy.call(e,c,s,u??void 0);void 0!==r&&(a=r)}if(a||(a=n.write),!a||!1===a.enabled)return!1;if(a.layerContainerTypes&&u?.layerContainerType&&!a.layerContainerTypes.includes(u.layerContainerType))return!1;if((null===c&&!a.allowNull&&!a.writerEnsuresNonNull||void 0===c)&&a.isRequired){const r=new m("web-document-write:property-required",`Missing value for required property '${s}' on '${e.declaredClass}'`,{propertyName:s,target:e});return r&&u?.messages?u.messages.push(r):r&&!u&&O.getLogger("esri.core.accessorSupport.write").error(r.name,r.message),!1}return!(void 0===c||null===c&&!a.allowNull&&!a.writerEnsuresNonNull||!(a.alwaysWriteDefaults||r.store.multipleOriginsSupported&&r.store.originOf(s)!==t.DEFAULTS)&&function(e,r,t,s,i){const n=s.default;if(void 0===n)return!1;if(null!=s.defaultEquals)return s.defaultEquals(i);if("function"==typeof n){if(Array.isArray(i)){const s=n.call(e,r,t??void 0);return o(s,i)}return!1}return n===i}(e,s,u,n,c)||!a.ignoreOrigin&&u?.origin&&r.store.multipleOriginsSupported&&r.store.originOf(s)<i(u.origin))}function D(e,r,t,s){const i=c(e),n=i.metadata,o=h(n[r],s);return!!o&&T(e,i,r,o,t,s)}function J(e,r,t){if(e&&"function"==typeof e.toJSON&&(!e.toJSON.isDefaultToJSON||!e.write))return f(r,e.toJSON(t));const i=c(e),n=i.metadata;for(const o in n){const a=h(n[o],t);if(!T(e,i,o,a,void 0,t))continue;const u=l(e,o),c=E(e,a,a.write&&"string"==typeof a.write.target?a.write.target:o,u,t);Object.keys(c).length>0&&(r=f(r,c),t?.resources?.pendingOperations?.length&&t.resources.pendingOperations.push(Promise.all(t.resources.pendingOperations).then((()=>f(r,c,(()=>"replace-arrays"))))),t?.writtenProperties&&t.writtenProperties.push({target:e,propName:o,oldOrigin:s(i.store.originOf(o)),newOrigin:t.origin}))}return r}const P=r=>{let t=class extends r{constructor(...e){super(...e);const r=c(this),t=r.store,s=new y;r.store=s,j(r,t,s)}read(e,r){_(this,e,r)}write(e,r){return J(this,e??{},r)}toJSON(e){return this.write({},e)}static fromJSON(e,r){return U.call(this,e,r)}};return t=e([d("esri.core.JSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function U(e,r){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const t=new this;return t.read(e,r),t}let A=class extends(P(r)){};A=e([d("esri.core.JSONSupport")],A),function(e){e.JSONSupportMixin=P}(A||(A={}));const L=A;export{_ as a,J as b,L as default,b as r,j as s,D as w};
