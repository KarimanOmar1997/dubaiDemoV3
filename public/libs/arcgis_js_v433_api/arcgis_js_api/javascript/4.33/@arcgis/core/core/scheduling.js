/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{n as e}from"../chunks/nextTick.js";import{P as s}from"../chunks/PooledArray.js";import{createResolver as t,isAborted as n,createAbortError as r}from"./promiseUtils.js";import"./lang.js";import"../chunks/handleUtils.js";import"./Error.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/events.js";import"../chunks/maybe.js";class a{constructor(e,s=30){this.name=e,this._counter=0,this._samples=new Array(s)}push(e){null!=e&&(this._samples[++this._counter%this._samples.length]=e)}set(e){null!=e&&(this._samples[this._counter%this._samples.length]=e)}get median(){return this._samples.slice().sort(((e,s)=>e-s))[Math.floor(this._samples.length/2)]}get average(){return this._samples.reduce(((e,s)=>e+s),0)/this._samples.length}get last(){return this._samples[this._counter%this._samples.length]}}function o(e){return e}function i(e){return 1e3*e}function c(e){return e}function l(e){return.001*e}class m{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}}class u{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}}let h=0,p=0;const f={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},d=["prepare","preRender","render","postRender","update","finish"],w=[],k=new s;class _{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1,g()}}function g(){null==F&&(h=performance.now(),F=requestAnimationFrame(x))}const v={frameTasks:k,willDispatch:!1,clearFrameTasks:function(e=!1){k.forAll((e=>{e.removed=!0})),e&&y()},dispatch:M,executeFrameTasks:function(e){const s=e-h;h=e;const t=p>0?p:1e3/60,n=Math.max(0,s-t);f.time=e,f.frameDuration=t-n;for(let t=0;t<d.length;t++){const n=performance.now(),r=d[t];k.forAll((n=>{n.paused||n.removed||(0===t&&n.ticks++,n.phases[r]&&(f.elapsedFrameTime=performance.now()-e,f.deltaTime=0===n.ticks?0:s,n.phases[r]?.call(n,f)))})),U[t].push(performance.now()-n)}y(),E.push(performance.now()-e)},reschedule:function(){null!=F&&(cancelAnimationFrame(F),F=requestAnimationFrame(x))}};function A(s){const t=new u(s);return w.push(t),v.willDispatch||(v.willDispatch=!0,e(M)),t}function j(e){const s=new m(e);return k.push(s),g(),new _(s)}let F=null;function T(e){p=Math.max(0,e)}function x(){const e=performance.now();F=null;const s=k.some((e=>!e.paused&&!e.removed));F=s?requestAnimationFrame(x):null,v.executeFrameTasks(e)}const D=new s;function y(){k.forAll((e=>{e.removed&&D.push(e)})),k.removeUnorderedMany(D.data,D.length),D.clear()}function M(){for(;w.length;){const e=w.shift();e.isActive&&e.callback()}v.willDispatch=!1}function b(s=1,a){const o=t(),i=()=>{n(a)?o.reject(r()):0===s?o():(--s,e((()=>i())))};return i(),o.promise}function q(e){return b(1,e)}function P(){const e=t(),s=j({postRender:()=>{s.remove(),A(e)}});return e.promise}async function R(e){await q(e),await new Promise((s=>requestAnimationFrame((()=>{e?.aborted||s()}))))}const U=d.map((e=>new a(e))),E=new a("total");export{_ as FrameTaskHandle,o as M,a as P,c as S,j as addFrameTask,v as debug,i as m,U as performanceInfo,E as performanceTotal,l as s,A as schedule,T as setFrameDuration,R as waitAnimationFrame,P as waitRender,q as waitTick,b as waitTicks};
