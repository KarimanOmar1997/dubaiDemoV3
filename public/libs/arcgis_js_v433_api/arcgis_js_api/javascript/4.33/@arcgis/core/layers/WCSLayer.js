/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../PopupTemplate.js";import s from"../core/Clonable.js";import o from"../core/Error.js";import{M as r}from"../chunks/MultiOriginJSONSupport.js";import{debounce as i,throwIfAbortError as n}from"../core/promiseUtils.js";import{watch as a}from"../core/reactiveUtils.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{L as l}from"../chunks/Logger.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import c from"./Layer.js";import{BlendLayer as u}from"./mixins/BlendLayer.js";import{CustomParametersMixin as h}from"./mixins/CustomParametersMixin.js";import{B as d,ImageryTileMixin as j}from"./mixins/ImageryTileMixin.js";import{OperationalLayer as f}from"./mixins/OperationalLayer.js";import{PortalLayer as g}from"./mixins/PortalLayer.js";import{R as y}from"../chunks/RasterJobHandlerMixin.js";import{RefreshableLayer as b}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as v}from"./mixins/ScaleRangeLayer.js";import{TemporalLayer as k}from"./mixins/TemporalLayer.js";import{a as w,p as I}from"../chunks/commonProperties.js";import C from"./support/Field.js";import{g as S,d as x}from"../chunks/rasterFieldUtils.js";import U from"../geometry/Extent.js";import{i as T}from"../chunks/crsUtils.js";import{getCapabilities as R,describeCoverage as L,s as P}from"./ogc/wcsUtils.js";import D from"./support/DimensionalDefinition.js";import{e as A}from"../chunks/multidimensionalUtils.js";import{g as $}from"../chunks/RasterSymbolizer.js";import{h as M}from"../chunks/vectorFieldUtils.js";import{createPopupTemplate as V}from"../support/popupUtils.js";import{S as E}from"../chunks/interfaces.js";import"../core/Collection.js";import"../chunks/watch.js";import"../chunks/ObjectPool.js";import"../chunks/handleUtils.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../config.js";import"../chunks/events.js";import"../chunks/maybe.js";import"../chunks/SetUtils.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/Lifecycle.js";import"../chunks/tracking.js";import"../chunks/SimpleTrackingTarget.js";import"../core/Evented.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/metadata.js";import"../chunks/ObservableBase.js";import"../chunks/ensureType.js";import"../chunks/MapUtils.js";import"../chunks/Warning.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/jsonUtils.js";import"../core/JSONSupport.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/reader.js";import"../chunks/writer.js";import"./support/fieldUtils.js";import"../core/sql.js";import"../chunks/guards.js";import"../chunks/datetime.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/support/AttachmentsOrderByInfo.js";import"../chunks/jsonMap.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../chunks/enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/constants.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"../chunks/colorUtils2.js";import"../chunks/mathUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/persistableUrlUtils.js";import"../core/Loadable.js";import"../core/Promise.js";import"../geometry/SpatialReference.js";import"../chunks/unitUtils.js";import"../chunks/pe.js";import"../chunks/assets.js";import"../time/TimeExtent.js";import"../chunks/timeUtils.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/layerContainerType.js";import"../chunks/jsonUtils2.js";import"../chunks/parser.js";import"../chunks/utils2.js";import"../chunks/screenUtils.js";import"../chunks/mat4.js";import"../chunks/common.js";import"./support/MultidimensionalSubset.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/zmUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polyline.js";import"../chunks/rasterEnums.js";import"./support/RasterFunction.js";import"./support/TileInfo.js";import"./support/LOD.js";import"../chunks/TileKey.js";import"../chunks/datasetUtils.js";import"../chunks/QueueProcessor.js";import"../chunks/Queue.js";import"../chunks/ReactiveMap.js";import"../chunks/signal.js";import"./support/RasterInfo.js";import"./support/RasterBandInfo.js";import"./support/RasterSensorInfo.js";import"../chunks/RawBlockCache.js";import"../chunks/rasterProjectionHelper.js";import"../chunks/projectionUtils.js";import"../chunks/vec3f64.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../chunks/projectXYZToVector.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/pixelRangeUtils.js";import"../chunks/clipUtils.js";import"./support/PixelBlock.js";import"../rest/support/FeatureSet.js";import"../Graphic.js";import"../chunks/typeUtils2.js";import"../chunks/createFeatureId.js";import"../chunks/typeUtils.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils5.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils6.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../chunks/lineMarkers.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/Font.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/domains.js";import"./support/CodedValueDomain.js";import"./support/Domain.js";import"./support/InheritedDomain.js";import"./support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/rasterFunctionHelper.js";import"../chunks/colorUtils.js";import"../chunks/vec4.js";import"../chunks/vec4f64.js";import"./support/rasterFunctionConstants.js";import"../chunks/colorRampUtils.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../chunks/stretchUtils.js";import"../chunks/stretchRendererUtils.js";import"../chunks/focalStatUtils.js";import"../chunks/rasterRendererHelper.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/visualVariableUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties2.js";import"../symbols/support/jsonUtils.js";import"../chunks/layerUtils.js";import"./catalog/catalogUtils.js";import"../chunks/defaults.js";import"../chunks/defaultsJSON.js";import"../chunks/RendererLegendOptions.js";import"../renderers/FlowRenderer.js";import"../renderers/RasterColormapRenderer.js";import"../renderers/support/ColormapInfo.js";import"../renderers/RasterShadedReliefRenderer.js";import"../renderers/RasterStretchRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils.js";import"../renderers/VectorFieldRenderer.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/simplify.js";import"../chunks/utils10.js";import"../chunks/utils11.js";import"../chunks/utils4.js";import"../chunks/asyncUtils.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils3.js";import"../chunks/defaultCIMValues.js";import"../chunks/enums2.js";import"../chunks/gfxUtils.js";import"../chunks/LRUCache.js";import"../chunks/MemCache.js";import"../chunks/generateRendererUtils.js";import"../chunks/rasterTypeUtils.js";import"../rest/support/ImageHistogramParameters.js";import"./support/MosaicRule.js";import"../rest/support/ImageSample.js";import"../rest/support/ImageSampleParameters.js";import"../rest/support/ImageSampleResult.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../tables/AttributeTableTemplate.js";import"../tables/elements/AttributeTableGroupElement.js";import"../tables/elements/AttributeTableAttachmentElement.js";import"../tables/elements/AttributeTableElement.js";import"../tables/elements/AttributeTableFieldElement.js";import"../tables/elements/AttributeTableRelationshipElement.js";import"../chunks/_commonjsHelpers.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"../chunks/number2.js";import"../chunks/substitute.js";import"../chunks/messages.js";import"../chunks/dataUtils.js";import"./support/TimeInfo.js";import"../time/TimeInterval.js";import"../chunks/timeZoneUtils.js";import"../chunks/xmlUtilities.js";function O(e,t,s=0){const o="--"+t.boundary,r=[];for(let e=0;e<o.length;e++)r.push(o.charCodeAt(e));const i=[],n="\n--"+t.boundary+"--";for(let e=0;e<n.length;e++)i.push(n.charCodeAt(e));const a=[10],p=[13,10],l=[],m=r.length,c=new Uint8Array(e,s),u=c.length-m;let h=0,d=0;for(let e=0;e<u;e++){for(d=0;d<m&&c[e+d]===r[d];d++);if(d!==m)continue;let s=!1;if(h){const o=F(c.subarray(h,e),t);l.push(o),s=!!o.isValidImage}if(e+=m-1,c[e+1]===a[0]?e+=1:c[e+1]===p[0]&&c[e+2]===p[1]&&(e+=2),h=e+1,s)break}const j=i.length;for(let e=c.length-j-10;e<c.length-j;e++){for(d=0;d<j&&c[e+d]===i[d];d++);if(d===j){l.push(F(c.subarray(h,e),t));break}}return l}function F(e,t){const s=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split("\n"),o=Math.min(s.length,7),r={contentDisposition:"inline"};let i=0;for(let n=0;n<o;n++)if(s[n].length<4)i=i+s[n].length+1;else if("content"===s[n].slice(0,7).toLowerCase()){i=i+s[n].length+1;const e=s[n].indexOf(":");if(-1===e)continue;const t=s[n].slice(0,e).trim(),o=s[n].slice(e+1).trim();switch(t.toLowerCase()){case"content-type":r.contentType=o;break;case"content-description":r.contentDescription=o;break;case"content-transfer-encoding":r.contentTransferEncoding=o;break;case"content-id":r.contentID=o;break;case"content-disposition":r.contentDisposition=o;break;case"content-location":r.contentLocation=o}}else{if(r.contentDisposition.toLowerCase().includes("inline")&&s[n].length>=4&&r.contentType?.toLowerCase().indexOf("image")>-1){let t=!0,s=e.subarray(i,e.length);if(r.contentType.toLowerCase().indexOf("tif")>0){if("base64"===r.contentTransferEncoding){let e="";const t=s;for(let s=0;s<t.length;s+=65535){const o=t.subarray(s,s+65535>t.length-1?t.length-1:s+65535);e+=String.fromCharCode.apply(null,o)}const o=atob(e);s=new Uint8Array(o.length);for(let e=0;e<s.length;e++)s[e]=o.charCodeAt(e)}t=73===s[0]&&73===s[1]||77===s[0]&&77===s[1]}if(t){let t=s.buffer;"base64"!==r.contentTransferEncoding&&(t=new ArrayBuffer(e.length-i),s=new Uint8Array(t),s.set(e.subarray(i,e.length))),r.contentData=t,r.isValidImage=!0}break}if((""===t.start||r.contentID===t.start)&&r.contentType){if(r.contentType.includes("text")||r.contentType.includes("xml")){r.contentData=String.fromCharCode.apply(null,e.subarray(i,e.length));break}r.contentData=e.subarray(i,e.length)}}return r}const _=["nearest neighbor","bilinear","bicubic"],B=["nearest","linear","cubic"],G="response is not a supported multipart/related mediaType with inline tiff,  switching to compatibility mode",W=new Set(["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"]);let N=class extends d{constructor(){super(...arguments),this.datasetFormat="WCSServer",this.tileType="Raster"}get rasterId(){return`${this.url}-${this.coverageId}-${this.version}`}async fetchRawTile(e,t,s,r={}){if(this.isBlockOutside(e,t,s))return null;const{nativePixelSize:i,spatialReference:n}=this.rasterInfo,a=2**e,p=i.x*a,l=i.y*a,{blockWidth:m,blockHeight:c}=this.getBlockWidthHeight(e),{origin:u}=this.rasterInfo.storageInfo.tileInfo,h=this.getTileExtent({x:p,y:l},t,s,u,n,[m,c]),d=this.rasterInfo.extent,j=h.xmax>d.xmax,f=h.ymin<d.ymin,g=j||f;let y=h,b=m,v=c;if(g&&(y=h.clone().intersection(d),null!=y&&(j&&(b=Math.floor((y.xmax-y.xmin)/p),y.xmax=y.xmin+p*b),f&&(v=Math.floor((y.ymax-y.ymin)/l),y.ymin=y.ymax-l*v))),null==y||b<=1||v<=1)return null;const k=await this._getCoverage(y,b,v,a,r);if(!k)return null;const{coverageDescription:w}=this.coverageInfo,{noDataValue:I,multidimensionalInfo:C}=this.rasterInfo,{multidimensionalDefinition:S}=r;let x;if(null!=C&&null!=S&&S.length){const e=S[0].variableName;if("2.0"===w.version){const t=w.rangeType[0].find((t=>t.name===e));x=t?.nilValue}else if("1.1"===w.version){const t=w.range.find((t=>t.identifier===e));x=t?.nullValues}}const U=x??I,T=await this.decodePixelBlock(k,{width:b,height:v,planes:null,pixelType:null,tiffNoDataValue:Array.isArray(U)?U[0]:U,matchAllNoData:!0});if(null==T)return null;if(T&&(T.width!==b||T.height!==v))throw new o("wcsraster-fetch",`the response has unexpected dimension width: ${T.width}, height: {pixelBlock.height}`);return g?M(T,{x:0,y:0},{width:c,height:c}):T}async _open(e){const{customFetchParameters:t}=this.ioConfig,s=e?.signal,r=await R(this.url,{version:t?.version??this.version,customParameters:t,signal:s});if(this.capabilities=r,!this.version){let e=r.version.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=r.version:(e=r.supportedVersions.find((e=>"2.0.1"===e))||r.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||r.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||r.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}const{version:i}=this;if(!W.has(i))throw new o("wcsraster-open",`unsupported WCS version ${i}`);const{gridCoverages:n}=r;if(!n.length)throw new o("wcsraster-open","cannot find rectified grid coverages");this.coverageId??=n[0].id;const{coverageId:a}=this,p=n.find((e=>e.id===a));if(null==p)throw new o("wcsraster-open",`the coverageId ${a} does not exist in capabilities`);const l=await L(this.url,{coverageIds:[a],version:i,customParameters:t,signal:s});if(this.coverageInfo=l[0],"2.0"===i.slice(0,3)){const{coverageInfo:e}=this;e.lonLatEnvelope=p.lonLatEnvelope,e.supportedInterpolations=P(r.supportedInterpolations),this._patchDimensionValues201(a,s)}this.datasetName=this.coverageInfo.title;const{rasterInfo:m}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(m,512,512),this._set("rasterInfo",m),null==m.spatialReference)throw new o("wcsraster-open",`coverage without spatial reference is not supported: ${a}`);const{pixelType:c,bandCount:u}=await this._getPixelTypeAndBandCount(s);m.pixelType=c,1===m.bandCount&&u>1&&(m.bandCount=u),this.updateTileInfo()}async _patchDimensionValues201(e,t){const{coverageInfo:s}=this,o=s.rasterInfo.multidimensionalInfo?.variables,r=W.has("1.1.2")?"1.1.2":W.has("1.1.1")?"1.1.1":W.has("1.1.0")?"1.1.0":null,{customFetchParameters:i}=this.ioConfig;if(o&&r)try{const s=this.url.includes("/ImageServer/"),n=e.length>8&&e.startsWith("Coverage")&&s?e.slice(8):e,a=await L(this.url,{coverageIds:[n??e],version:r,customParameters:i,signal:t}).catch((()=>{if(n)return L(this.url,{coverageIds:[e],version:r,customParameters:i,signal:t})})),p=a?.[0].rasterInfo.multidimensionalInfo?.variables;if(p)for(const e of o){const t=p.find((({name:t})=>t===e.name));if(t?.dimensions?.length)for(let o=e.dimensions.length-1;o>=0;o--){const r=e.dimensions[o],i=t.dimensions.find((({name:e})=>e===r.name));i?i.values&&i.extent?.join(",")===r.extent?.join(",")&&(e.dimensions[o]={...r,values:i.values}):s&&e.dimensions.splice(o,1)}}}catch{}}async _getPixelTypeAndBandCount(e){const{pixelSize:t,extent:s,multidimensionalInfo:r}=this.rasterInfo,i=s.center,n=new U({xmin:i.x-t.x,xmax:i.x+t.x,ymin:i.y-t.y,ymax:i.y+t.y,spatialReference:s.spatialReference});let a=[];if(null!=r){const e=r.variables[0];a=[],e.dimensions.forEach((t=>{a.push(new D({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent?.[0]:t.values?.[0],isSlice:!0}))}))}const{coverageDescription:p}=this.coverageInfo,m={interpolation:"nearest",multidimensionalDefinition:a,signal:e},{version:c}=p,{ioConfig:u}=this,h="2.0"===c&&null==u.allowAnyMediaType||"1.1"===c&&null==u.use2GridOffsets;let d;try{d=await this._getCoverage(n,2,2,1,m,!0)}catch(e){if(!h)throw e;if("1.1"===c){if(!e.details?.isResolutionMismatch)throw e;u.use2GridOffsets=!0}}if(!d&&h&&("2.0"===c&&(u.allowAnyMediaType=!0),d=await this._getCoverage(n,2,2,1,m),d&&l.getLogger(this).warn("wcsraster:getcoverage",G)),!d)throw new o("wcsraster-open","unable to determine pixel type");const j=await this.decodePixelBlock(d,{width:2,height:2,planes:null,pixelType:null});if(null==j)throw new o("wcsraster-open","unable to determine pixel type");return{pixelType:j.pixelType,bandCount:j.getPlaneCount()??0}}async _getCoverage(e,t,s,r,i,n=!1){const{coverageDescription:a}=this.coverageInfo,{version:p}=a,m="2.0"===p?this._getCoverage201Parameters(e,t,s,r,i,a):"1.1"===p?this._getCoverage110Parameters(e,t,s,i,a):this._getCoverage100Parameters(e,t,s,i),c="2.0"===p?await this.request(this._constructWCS201Url(m),{signal:i.signal,responseType:"array-buffer"}):await this.request(this.url,{query:m,signal:i.signal,responseType:"array-buffer"});if("1.0"===p)return c.data;if("2.0"===p&&!1!==this.ioConfig.allowAnyMediaType&&"tiff"===$(c.data))return n&&(this.ioConfig.allowAnyMediaType=!0,l.getLogger(this).warn("wcsraster:getcoverage",G)),c.data;const u=function(e){const t=function(e){const t=e.getHeader?.("Content-Type")?.split(";");if(!t)return null;if(!(t[0].trim()??"").startsWith("multipart/"))return null;const s={boundary:"",start:"",type:""};for(let e=1;e<t.length;e++){const o=t[e].indexOf("=");if(o>0){const r=t[e].slice(0,o).trim(),i=t[e].slice(o+1).trim();s[r]=i.startsWith('"')?i.slice(1,-1):i}}return s}(e);return t?{isMultipart:!0,data:t.boundary?O(e.data,t,0):null}:{isMultipart:!1,data:null}}(c);if(u.isMultipart&&u.data){const e=u.data.find((e=>e.isValidImage));return n&&"base64"===e?.contentTransferEncoding&&l.getLogger(this).warn("wcsraster:getcoverage","response is base64 encoded which may impact layer display performance"),e?.contentData}const h=new Uint8Array(c.data,0,Math.min(c.data.byteLength,2e3)),d=String.fromCharCode.apply(null,h).toLowerCase().includes("exception"),j=d&&String.fromCharCode.apply(null,h).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");if(d)throw new o("wcsraster:getcoverage","server returns an exception",{isResolutionMismatch:j});throw new o("wcsraster:getcoverage","response is not a supported multipart mediaType with inline tiff")}_getInterpolationIndex(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0:0}_getCoverage100Parameters(e,t,s,o){const r=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,i=e.spatialReference.wkid,n=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"GEOTIFF",{bandIds:a,interpolation:p}=o,l=this._getInterpolationIndex(p),m=a?a.map((e=>this.coverageInfo.bandNames[e])):null,c=_[l],{multidimensionalDefinition:u}=o;let h;if(null!=u&&null!=this.rasterInfo.multidimensionalInfo){const e=u.find((e=>"StdTime"===e.dimensionName));let t=e?.values;t&&t.length>0&&(Array.isArray(t[0])&&(t=t[0]),h=t.map((e=>q(e))).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:n,crs:`EPSG:${i}`,bbox:r,width:t,height:s,time:h,interpolation:c,band:m?.join(",")}}_getCoverage110Parameters(e,t,s,o,r){const{multidimensionalDefinition:i,bandIds:n,interpolation:a}=o,p=e.spatialReference.wkid,l=`urn:ogc:def:crs:EPSG::${p}`,m=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",c=this._getInterpolationIndex(a),u=B[c],h=null==a||0===this.coverageInfo.supportedInterpolations?.indexOf(a),d=r.domain.spatialDomain,j=d.origin.x<=d.envelope.xmin&&d.origin.y<=d.envelope.ymin,f=e.width/t,g=e.height/s*(j?1:-1),y=j?[e.xmin,e.ymin]:[e.xmin,e.ymax],b=d.useEPSGAxis&&T(p),v=b?`${y[1]},${y[0]}`:`${y[0]},${y[1]}`,k=this.ioConfig.use2GridOffsets,w=b?k?`${g},${f}`:`${g},0,0,${f}`:k?`${f},${g}`:`${f},0,0,${g}`,I=f/2,C=e.xmin+I,S=e.xmax-I,x=Math.abs(g)/2,U=e.ymin+x,R=e.ymax-x,L=b?`${U},${C},${R},${S},${l}`:`${C},${U},${S},${R},${l}`,P=r.range.find((e=>e.axis.some((e=>e.identifier.toLowerCase().includes("band")))));let D,A=P&&u&&n?h?`${P.identifier}[${P.axis[0].identifier}[${n.join(",")}]]`:`${P.identifier}:${u}[${P.axis[0].identifier}[${n.join(",")}]]`:null;if(null!=i&&i.length)for(let e=0;e<i.length;e++){let t=i[e].values;const s=i[e].dimensionName?.toLowerCase(),o=i[e].variableName?.toLowerCase(),n=r.range.find((e=>e.identifier.toLowerCase()===o));if(t.length>0)if(Array.isArray(t[0])&&(t=t[0]),"stdtime"===s)D=t.map((e=>q(e))).join(",");else if(n){const e=n.axis.find((e=>e.identifier.toLowerCase()===s));e&&(A=h?n.identifier+"["+e.identifier+"["+t.join(",")+"]]":n.identifier+":"+u+"["+e.identifier+"["+t.join(",")+"]]")}e===i.length-1&&n&&!A&&(A=h?n.identifier:n.identifier+":"+u)}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:m,crs:`EPSG:${p}`,boundingbox:L,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:v,gridOffsets:w,gridBaseCRS:l,timeSequence:D,rangeSubset:A}}_getCoverage201Parameters(e,t,s,o,r,i){const{multidimensionalDefinition:n,interpolation:a}=r,p=this._getInterpolationIndex(a);let l=null;const{supportedInterpolations:m}=this.capabilities;if(m?.length)switch(p){case 0:l=m.find((e=>e.toLowerCase().includes("nearest")));break;case 1:l=m.find((e=>e.toLowerCase().includes("linear")));break;case 2:l=m.find((e=>e.toLowerCase().includes("cubic")||e.toLowerCase().includes("quadratic")))}const c=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",{bandNames:u}=this.coverageInfo,{boundedBy:h,domainSet:d,rangeType:j}=i,f=h.isEastFirst?0:1,g=1-f,{axisLabels:y}=h,b=y[f],v=y[g],k=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,w=k,I=[];I.push(`${b}(${e.xmin},${e.xmax})`),I.push(`${v}(${e.ymin},${e.ymax})`);const C=[];if(y.length>2)for(let e=2;e<y.length;e++){const t=d.origin[e];if(y[e].toLowerCase().includes("time")){let s=t.toString();h.uomLabels?.[e].toLowerCase().includes("ole")&&(C.push(y[e]),s=q(t,!0)),I.push(y[e]+",http://www.opengis.net("+s+")")}else I.push(y[e]+",http://www.opengis.net("+t+")")}let S=null;if(null!=n&&n.length){const e=[];j.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let s=0;s<n.length;s++){const o=y.find((e=>e===n[s].dimensionName)),r=e.find((e=>e===n[s].variableName));if(t.includes(r)||t.push(r),o){let e=n[s].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=o.toLowerCase().includes("time")?e.map((e=>q(e))).join(","):e.join(",");const s=I.findIndex((e=>0===e.indexOf(o+",http://www.opengis.net")));-1===s&&I.push(o+",http://www.opengis.net("+t+")"),-1===s||I[s].includes("("+t+")")||I.splice(s,1,o+",http://www.opengis.net("+t+")")}}}t.length&&(S=t.join(","))}else u?.length>=2&&(S=(r.bandIds?r.bandIds.map((e=>u[e])):u).join(","));const x=I.join("&subset="),U=!i.domainSet.hasSameAxisLabelsAsBoundedBy&&!1!==this.ioConfig.allowScaleFactor,T=U?null:`${b}(${t}),${v}(${s})`,R=U?1/o:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:S,interpolation:l,scaleSize:T,scaleFactor:R,subset:x,format:c,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:k,subsettingcrs:w}}_constructWCS201Url(e){const t={...this.ioConfig.customFetchParameters,...e},s=[];return Object.keys(t).forEach((e=>{const o=t[e];null!=o&&("subset"===e?"string"==typeof o&&o.split("&subset=").forEach((e=>{e&&s.push(`subset=${encodeURIComponent(e)}`)})):s.push(`${e}=${encodeURIComponent(o)}`))})),`${encodeURI(this.url)}?${s.join("&")}`}};function q(e,t=!1){return(t?new Date(A(e)):new Date(e)).toISOString()}e([p({type:String,json:{write:!0}})],N.prototype,"datasetFormat",void 0),e([p({readOnly:!0})],N.prototype,"tileType",void 0),e([p({type:String,json:{write:!0}})],N.prototype,"version",void 0),e([p({type:String,json:{write:!0}})],N.prototype,"coverageId",void 0),e([p({readOnly:!0})],N.prototype,"rasterId",null),N=e([m("esri.layers.support.rasterDatasets.WCSRaster")],N);const H=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]);let z=class extends(u(v(f(g(h(j(y(k(b(r(s.ClonableMixin(c)))))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.legendEnabled=!0,this.noData=0,this.operationalLayerType="WCS",this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this._debouncedSaveOperations=i((async(e,t,s)=>{const{save:o,saveAs:r}=await import("../chunks/imageryUtils.js");switch(e){case E.SAVE:return o(this,t);case E.SAVE_AS:return r(this,s,t)}}))}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=null!=e?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WCS"]},e).catch(n).then((()=>this._openRaster(t)))),Promise.resolve(this)}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){const e=[S("Pixel Value")],t=this.raster?.rasterInfo??this.serviceRasterInfo,s=t?.multidimensionalInfo;if(s){const t=x(s);e.push(...t)}return e}createPopupTemplate(e){return V({fields:this.rasterFields,title:this.title},e)}async save(e){return this._debouncedSaveOperations(E.SAVE,e)}async saveAs(e,t){return this._debouncedSaveOperations(E.SAVE_AS,t,e)}async _openRaster(e){const t=new N({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters}});if(await t.open({signal:e}),!t.rasterInfo)throw t.destroy(),new o("wcs-layer:load","cannot load resources on "+this.url);const{rasterInfo:s}=t;null==s.noDataValue&&(s.noDataValue=this.noData),this._set("serviceRasterInfo",s),this._set("spatialReference",s.spatialReference),null==this.title&&this.setAtOrigin("title",t.datasetName,"service"),null==this.coverageId&&this.setAtOrigin("coverageId",t.coverageInfo.id,"service"),null==this.version&&t.version&&this.setAtOrigin("version",t.version,"service"),this.setAtOrigin("tileInfo",t.rasterInfo.storageInfo.tileInfo,"service");const{multidimensionalInfo:r}=s;if(null!=r){const e=r.variables[0].dimensions.find((({name:e})=>"StdTime"===e));if(e){let t=e.extent?.[0]??e.values[0];Array.isArray(t)&&(t=t[0]);let s=e.extent?.[1]??e.values[e.values.length-1];Array.isArray(s)&&(s=s[1]);const o=H.has(e.intervalUnit?.toLowerCase())?e.intervalUnit?.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:t,end:s},timeZone:null,interval:o?{value:e.interval,unit:o}:null})}}this.raster=t,this._configDefaultSettings(),this.addHandles(a((()=>this.customParameters),(e=>this.raster.ioConfig.customFetchParameters=e)))}};e([p({type:String,nonNullable:!0,json:{name:"wcsInfo.coverageId",write:{isRequired:!0,ignoreOrigin:!0}}})],z.prototype,"coverageId",void 0),e([p()],z.prototype,"coverageInfo",null),e([p({type:["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"],nonNullable:!0,json:{name:"wcsInfo.version",write:{isRequired:!0,ignoreOrigin:!0}}})],z.prototype,"version",void 0),e([p({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],z.prototype,"isReference",void 0),e([p({json:{read:!0,write:!0}})],z.prototype,"blendMode",void 0),e([p(w)],z.prototype,"legendEnabled",void 0),e([p({type:["show","hide"]})],z.prototype,"listMode",void 0),e([p()],z.prototype,"noData",void 0),e([p({type:["WCS"]})],z.prototype,"operationalLayerType",void 0),e([p()],z.prototype,"raster",void 0),e([p({readOnly:!0})],z.prototype,"type",void 0),e([p(I)],z.prototype,"popupEnabled",void 0),e([p({type:t,json:{name:"popupInfo",write:!0}})],z.prototype,"popupTemplate",void 0),e([p({readOnly:!0})],z.prototype,"defaultPopupTemplate",null),e([p({readOnly:!0,type:[C]})],z.prototype,"fields",void 0),e([p({readOnly:!0,type:[C]})],z.prototype,"rasterFields",null),z=e([m("esri.layers.WCSLayer")],z);const J=z;export{J as default};
