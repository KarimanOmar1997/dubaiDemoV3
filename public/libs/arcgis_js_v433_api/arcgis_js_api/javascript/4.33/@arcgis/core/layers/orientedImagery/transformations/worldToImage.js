/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{r as t,e as r}from"../../../chunks/mathUtils.js";import{z as e,c as s}from"../../../chunks/vec3f64.js";import{a as o,i,x as a}from"../../../chunks/vec3.js";import{webMercatorToGeographic as n}from"../../../geometry/support/webMercatorUtils.js";import p from"../../../core/Error.js";import{c as m}from"../../../chunks/mat3f64.js";import{c,f as l}from"../../../chunks/mat4f64.js";import{b as u}from"../../../chunks/vec4f64.js";import{m as j,t as h}from"../../../chunks/mat3.js";import{n as f,y as d}from"../../../chunks/mat4.js";import{i as y}from"../../../chunks/jsonUtils.js";import g from"../../../geometry/Point.js";import{projectWithZConversion as k}from"../../../chunks/projectionUtils.js";import{i as b,j as I}from"../../../chunks/unitUtils.js";import{a as S}from"../../../chunks/vec32.js";import{b as R,c as M,C as v,a as w}from"../../../chunks/utils15.js";import{L as x}from"../../../chunks/Logger.js";import{isAbortError as U,waitTick as T}from"../../../core/promiseUtils.js";import L from"../../../geometry/Extent.js";import{load as E,execute as C}from"../../../geometry/operators/projectOperator.js";import{d as A}from"../../../chunks/aaBoundingRect.js";import P from"../../ElevationLayer.js";import O from"../../ImageryLayer.js";import"../../ImageryTileLayer.js";import{TileElevationSampler as F}from"../../support/ElevationSampler.js";import{E as D}from"../../../chunks/ElevationTile.js";import{E as V}from"../../../chunks/LercDecoder.js";import N from"../../support/RasterFunction.js";import z from"../../support/TileInfo.js";import{T as H}from"../../../chunks/TileKey.js";import G from"../../../request.js";import"../../../core/lang.js";import B from"../../../geometry/SpatialReference.js";import"../../../geometry/Geometry.js";import"../../../geometry/Multipoint.js";import"../../../geometry/Polygon.js";import"../../../geometry/Polyline.js";import"../../../config.js";import"../../../chunks/normalizeUtilsCommon.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../rest/support/FindImagesParameters.js";import"../../../rest/support/FindImagesResult.js";import"../../../rest/support/ImageAngleParameters.js";import"../../../rest/support/ImageAngleResult.js";import"../../../rest/support/ImageAreaParameters.js";import"../../../rest/support/ImageAreaResult.js";import"../../../rest/support/ImageBoundaryParameters.js";import"../../../rest/support/ImageBoundaryResult.js";import"../../../rest/support/ImageDistanceParameters.js";import"../../../rest/support/ImageDistanceResult.js";import"../../../rest/support/ImageGPSInfoParameters.js";import"../../../rest/support/ImageGPSInfoResult.js";import"../../../rest/support/ImageHeightParameters.js";import"../../../rest/support/ImageHeightResult.js";import"../../../rest/support/ImageHistogramParameters.js";import"../../../rest/support/ImageIdentifyParameters.js";import"../../../rest/support/ImageIdentifyResult.js";import"../../../rest/support/ImagePixelLocationParameters.js";import"../../../rest/support/ImagePixelLocationResult.js";import"../../../rest/support/ImagePointParameters.js";import"../../../rest/support/ImagePointResult.js";import"../../../rest/support/ImageSampleParameters.js";import"../../../rest/support/ImageSampleResult.js";import"../../../rest/support/ImageToMapMultirayParameters.js";import"../../../rest/support/ImageToMapParameters.js";import"../../../rest/support/ImageUrlParameters.js";import"../../../rest/support/ImageUrlResult.js";import"../../../rest/support/ImageVolumeParameters.js";import"../../../rest/support/ImageVolumeResult.js";import"../../../rest/support/MapToImageParameters.js";import"../../../rest/support/MeasureAreaFromImageResult.js";import"../../../rest/support/MeasureFromImageParameters.js";import"../../../rest/support/MeasureLengthFromImageResult.js";import{f as q}from"../../../chunks/requestPresets.js";import{i as W}from"../../../chunks/guards.js";import"../../../chunks/common.js";import"../../../chunks/tslib.es6.js";import"../../../core/Accessor.js";import"../../../core/Handles.js";import"../../../chunks/maybe.js";import"../../../core/accessorSupport/decorators/subclass.js";import"../../../chunks/Lifecycle.js";import"../../../chunks/metadata.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/tracking.js";import"../../../chunks/ensureType.js";import"../../../chunks/MapUtils.js";import"../../../chunks/Warning.js";import"../../../chunks/get.js";import"../../../chunks/ObjectPool.js";import"../../../chunks/ObservableBase.js";import"../../../core/accessorSupport/decorators/property.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/PooledArray.js";import"../../../chunks/events.js";import"../../../chunks/SetUtils.js";import"../../../chunks/SimpleTrackingTarget.js";import"../../../core/JSONSupport.js";import"../../../chunks/writer.js";import"../../../chunks/jsonMap.js";import"../../../chunks/pe.js";import"../../../chunks/assets.js";import"../../../chunks/persistableUrlUtils.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../chunks/reader.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/geodesicConstants.js";import"../../../chunks/projectXYZToVector.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../chunks/zmUtils.js";import"../../../chunks/coordsUtils.js";import"../../../chunks/Axis.js";import"../../../chunks/extentUtils.js";import"../../../chunks/boundsUtils.js";import"../../../chunks/colorUtils2.js";import"../../../core/Clonable.js";import"../../../chunks/SimpleGeometryCursor.js";import"../../../chunks/MultiOriginJSONSupport.js";import"../../../geometry/HeightModelInfo.js";import"../../Layer.js";import"../../../core/Evented.js";import"../../../core/Identifiable.js";import"../../../core/Loadable.js";import"../../../core/Promise.js";import"../../../time/TimeExtent.js";import"../../../chunks/timeUtils.js";import"../../../chunks/date.js";import"../../../chunks/locale.js";import"../../../chunks/constants.js";import"../../../chunks/datetime.js";import"../../mixins/ArcGISCachedService.js";import"../../../chunks/TileInfoTilemapCache.js";import"../../../chunks/TilemapCache.js";import"../../../chunks/ByteSizeUnit.js";import"../../../chunks/LRUCache.js";import"../../../chunks/MemCache.js";import"../../../core/reactiveUtils.js";import"../../../chunks/memoryEstimations.js";import"../../support/LOD.js";import"../../../chunks/ArcGISService.js";import"../../mixins/OperationalLayer.js";import"../../../chunks/layerContainerType.js";import"../../../chunks/commonProperties.js";import"../../../chunks/ElevationInfo.js";import"../../support/fieldUtils.js";import"../../../core/sql.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../tables/AttributeTableTemplate.js";import"../../../tables/elements/AttributeTableGroupElement.js";import"../../../tables/elements/AttributeTableAttachmentElement.js";import"../../../tables/elements/AttributeTableElement.js";import"../../../tables/elements/AttributeTableFieldElement.js";import"../../../tables/elements/AttributeTableRelationshipElement.js";import"../../../chunks/opacityUtils.js";import"../../mixins/PortalLayer.js";import"../../../chunks/asyncUtils.js";import"../../../chunks/layerUtils.js";import"../../../core/Collection.js";import"../../../chunks/shared.js";import"../../catalog/catalogUtils.js";import"../../../portal/Portal.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../portal/PortalItem.js";import"../../../portal/PortalItemResource.js";import"../../../portal/PortalRating.js";import"../../../chunks/portalItemUtils.js";import"../../../chunks/WorkerHandle.js";import"../../../core/workers/workers.js";import"../../../core/workers/Connection.js";import"../../../chunks/Queue.js";import"../../../core/workers/RemoteClient.js";import"../../../intl.js";import"../../../chunks/number2.js";import"../../../chunks/substitute.js";import"../../../chunks/messages.js";import"../../../PopupTemplate.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/support/AttachmentsOrderByInfo.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../chunks/enumeration.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../Color.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../mixins/ArcGISImageService.js";import"../../../Graphic.js";import"../../../geometry/support/jsonUtils.js";import"../../../chunks/typeUtils2.js";import"../../../chunks/createFeatureId.js";import"../../../chunks/typeUtils.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils5.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/screenUtils.js";import"../../../chunks/materialUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils6.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../chunks/aaBoundingBox.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/Font.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/SimpleMarkerSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../support/DimensionalDefinition.js";import"../../../chunks/pixelRangeUtils.js";import"../../../chunks/colorRampUtils.js";import"../../../chunks/colorUtils.js";import"../../../chunks/vec4.js";import"../../../chunks/stretchRendererUtils.js";import"../../../renderers/visualVariables/SizeVariable.js";import"../../../renderers/visualVariables/VisualVariable.js";import"../../../renderers/visualVariables/support/SizeStop.js";import"../../../chunks/visualVariableUtils.js";import"../../support/MosaicRule.js";import"../../../chunks/rasterEnums.js";import"../../support/Field.js";import"../../../chunks/domains.js";import"../../support/CodedValueDomain.js";import"../../support/Domain.js";import"../../support/InheritedDomain.js";import"../../support/RangeDomain.js";import"../../../chunks/fieldType.js";import"../../support/FieldsIndex.js";import"../../../chunks/UnknownTimeZone.js";import"../../../chunks/timeZoneUtils.js";import"../../../chunks/imageBitmapUtils.js";import"../../support/MultidimensionalSubset.js";import"../../support/PixelBlock.js";import"../../../chunks/rasterFieldUtils.js";import"../../support/RasterInfo.js";import"../../support/RasterBandInfo.js";import"../../support/RasterSensorInfo.js";import"../../../chunks/multidimensionalUtils.js";import"../../../chunks/RasterSymbolizer.js";import"../../../chunks/_commonjsHelpers.js";import"../../../chunks/vectorFieldUtils.js";import"../../../chunks/stretchUtils.js";import"../../../chunks/rasterRendererHelper.js";import"../../../chunks/datasetUtils.js";import"../../../renderers/ClassBreaksRenderer.js";import"../../../renderers/Renderer.js";import"../../../renderers/support/AuthoringInfo.js";import"../../../renderers/support/AuthoringInfoVisualVariable.js";import"../../../chunks/colorRamps.js";import"../../../rest/support/AlgorithmicColorRamp.js";import"../../../rest/support/ColorRamp.js";import"../../../rest/support/MultipartColorRamp.js";import"../../../renderers/mixins/VisualVariablesMixin.js";import"../../../renderers/visualVariables/ColorVariable.js";import"../../../renderers/visualVariables/support/ColorStop.js";import"../../../renderers/visualVariables/OpacityVariable.js";import"../../../renderers/visualVariables/support/OpacityStop.js";import"../../../renderers/visualVariables/RotationVariable.js";import"../../../renderers/support/ClassBreakInfo.js";import"../../../chunks/commonProperties2.js";import"../../../symbols/support/jsonUtils.js";import"../../../chunks/defaults.js";import"../../../chunks/defaultsJSON.js";import"../../../chunks/RendererLegendOptions.js";import"../../../renderers/FlowRenderer.js";import"../../../renderers/RasterColormapRenderer.js";import"../../../renderers/support/ColormapInfo.js";import"../../../renderers/RasterShadedReliefRenderer.js";import"../../../renderers/RasterStretchRenderer.js";import"../../../renderers/UniqueValueRenderer.js";import"../../../chunks/diffUtils.js";import"../../../renderers/support/UniqueValue.js";import"../../../renderers/support/UniqueValueClass.js";import"../../../renderers/support/UniqueValueGroup.js";import"../../../renderers/support/UniqueValueInfo.js";import"../../../chunks/styleUtils.js";import"../../../renderers/VectorFieldRenderer.js";import"../../../geometry/support/normalizeUtils.js";import"../../../chunks/simplify.js";import"../../../chunks/utils10.js";import"../../../chunks/utils11.js";import"../../../chunks/utils4.js";import"../../../chunks/jsonUtils2.js";import"../../../chunks/parser.js";import"../../../chunks/utils2.js";import"../../../symbols/support/cimSymbolUtils.js";import"../../../chunks/utils3.js";import"../../../chunks/defaultCIMValues.js";import"../../../chunks/enums2.js";import"../../../chunks/gfxUtils.js";import"../../../chunks/generateRendererUtils.js";import"../../../chunks/rasterTypeUtils.js";import"../../../rest/imageService.js";import"../../../rest/support/ImageInspectionInfo.js";import"../../../rest/support/CameraInfoMixin.js";import"../../../rest/support/BaseImageMeasureParameters.js";import"../../../chunks/imageMeasureUtils.js";import"../../../rest/support/BaseImageMeasureResult.js";import"../../../chunks/spatialRelationships.js";import"../../../rest/support/CameraInfo.js";import"../../../rest/support/ImageGPSInfo.js";import"../../../rest/support/FeatureSet.js";import"../../../rest/support/ImageSample.js";import"../../../rest/support/ImageVolume.js";import"../../../chunks/fetchRasterInfo.js";import"../../../chunks/executeForIds.js";import"../../../chunks/query.js";import"../../../chunks/pbfQueryUtils.js";import"../../../chunks/pbf.js";import"../../../chunks/OptimizedGeometry.js";import"../../../chunks/OptimizedFeature.js";import"../../../chunks/OptimizedFeatureSet.js";import"../../../chunks/queryZScale.js";import"../../../rest/support/Query.js";import"../../../chunks/DataLayerSource.js";import"../../../chunks/FullTextSearch.js";import"../../../rest/support/StatisticDefinition.js";import"../../../chunks/executeQueryJSON.js";import"../../mixins/BlendLayer.js";import"../../mixins/CustomParametersMixin.js";import"../../../chunks/RasterJobHandlerMixin.js";import"../../../chunks/dataUtils.js";import"../../mixins/RasterPresetRendererMixin.js";import"../../../renderers/support/RasterPresetRenderer.js";import"../../mixins/RefreshableLayer.js";import"../../mixins/ScaleRangeLayer.js";import"../../mixins/TemporalLayer.js";import"../../support/TimeInfo.js";import"../../../time/TimeInterval.js";import"../../../chunks/versionUtils.js";import"../../../support/popupUtils.js";import"../../../chunks/interfaces.js";import"../../mixins/ImageryTileMixin.js";import"../../../chunks/QueueProcessor.js";import"../../../chunks/ReactiveMap.js";import"../../../chunks/signal.js";import"../../../chunks/RawBlockCache.js";import"../../../chunks/rasterProjectionHelper.js";import"../../../chunks/clipUtils.js";import"../../../chunks/rasterFunctionHelper.js";import"../../support/rasterFunctionConstants.js";import"../../../chunks/focalStatUtils.js";import"../../../chunks/xmlUtilities.js";import"../../../chunks/GCSShiftTransform.js";import"../../../chunks/ElevationSamplerData.js";const Y=120,_=[21,36,51,60],Q=3.5,X=["FAR_WEST","FAR_NORTH","FAR_EAST","FAR_SOUTH","WEST","NORTH","EAST","SOUTH","NEAR_WEST","NEAR_NORTH","NEAR_EAST","NEAR_SOUTH"],$=23.937554159486076,J=96.06244584051393,Z={EAST:[$,$,J,$,60,$],NORTH:[$,J,$,$,$,60],SOUTH:[J,$,J,J,J,60],WEST:[J,J,$,J,60,J]},K=-999,tt=100,rt=()=>["after-data-capture-complete","deselect-data-capture-features","select-data-capture-features"],et="ImageGeometry",st="OIObjectId",ot=[1920,1080],it=[{x:-2886579864025407e-30,y:1080},{x:0,y:0},{x:1920,y:54511950509095186e-30},{x:1920,y:1080},{x:-2886579864025407e-30,y:1080}],at={xmin:-150,ymin:1,xmax:20,ymax:80,spatialReference:{wkid:4326}},nt=5,pt=t(Math.acos(.05));function mt(t){return"3d"===t?.type}function ct(t){return"esri.Graphic"===t?.declaredClass}function lt(t){return/(tiff|tif|mrf)$/i.test(t??"")}function ut(t){if(!t)return!1;if(!URL.canParse(t))return!1;const{pathname:r}=new URL(t);return/.*\.(tiff|tif|mrf)$/i.test(r??"")}function jt(t){return Math.abs(t)>=135?"WEST":t<-45&&t>-135?"SOUTH":t<=45?"EAST":"NORTH"}function ht(t,r){const e=t/r*_[2];return e<=_[0]?"NEAR":e<=_[1]?"":"FAR"}function ft(t){return"string"==typeof t&&t.length?t:function(t){return t&&t.url&&t.datasetFormat?t:null}(t)}const dt=t=>r=>r.layer===t;function yt(t){return"NoAttachmentError"===t?.name}const gt=t=>`${t}:missing-property`,kt=(t,r)=>`Property ${r} is missing in ${t}`,bt=(t="esri.widgets.OrientedImageryViewer",r)=>{throw x.getLogger(t).error(r),r},It=async(t,r)=>{const e=await G(t,{...r,method:"head"}),s=e?.getHeader?.("Content-Type");if(s)return s.split("/")[1]};function St(t,r){r&&t.forEach((t=>{t.elevationSample=r}))}async function Rt(t,r,e){if(!r.extent||!r.url)throw bt("esri.layer.orientedImagery.transformations",new p("update-elevation:missing-property","both extent and url are required to create a sampler",r));const s=await wt(r);if(!s)throw bt("esri.layers.orientedImagery.transformations",new p("update-elevation:elevation-source","could not create a sampler using provided elevation source",r));return Mt(t,s,e)}async function Mt(t,r,e){await T(e);const s=function(t,r){return async e=>{let s=e.clone();const o=e.spatialReference.equals(t.spatialReference)?s:await k(e,t.spatialReference,r),i=t.queryElevation(o);return i&&(s=e.spatialReference.equals(t.spatialReference)?i.clone():await k(i,e.spatialReference,r)),s.z=s.z??1,s}}(r,e),o=Array.isArray(t)?t:[t];return await Promise.all(o.map(s))}var vt;!function(t){t[t.DYNAMIC=0]="DYNAMIC",t[t.ELEVATION=1]="ELEVATION",t[t.IMAGE=2]="IMAGE"}(vt||(vt={}));const wt=async(t,r)=>{let e;const{extent:s,rasterFunction:o,url:i,lod:a}=t;try{e=await async function(t){await T(void 0);const r=await q(t),{tileInfo:e,cacheType:s}=r;if(!r.hasOwnProperty("bandCount")||!r.hasOwnProperty("pixelSizeX"))throw new p("elevation-source:invalid-service-url",`ElevationSource URL expects an elevation 3D image service but given ${t}`);return e?"LERC"!==e?.format?.toUpperCase()||s&&"elevation"!==s.toLowerCase()?vt.IMAGE:vt.ELEVATION:vt.DYNAMIC}(i)}catch(t){if(U(t))return;x.getLogger("esri.layers.orientedImagery.transformations").error("updateElevationUsingElevationSource",t)}switch(e){case vt.DYNAMIC:return await async function(t,r,e,s){const o=e?new N({functionName:e}):void 0,i=new O({url:t,rasterFunction:o,format:"lerc"});await i.load(s);const a=512,n=r.center,p=Math.max(r.width,r.height);let m=new L({xmin:n.x-p/2,ymin:n.y-p/2,xmax:n.x+p/2,ymax:n.y+p/2,spatialReference:r.spatialReference});i.spatialReference.equals(m.spatialReference)||(await E(),m=C(m,i.spatialReference));const c=await i.fetchPixels(m,a,a,s),l=z.create({scales:[p/a],size:a,spatialReference:m.spatialReference}),u=new H(null,0,0,0,A(m)),j=new V(c.pixelBlock.pixels[0],a,a,0),h=new D(u,j);return new F(h,l,void 0)}(i,s,o,r);case vt.ELEVATION:return await async function(t,r,e,s){const o=new P(t);let i;try{const{tileInfo:t}=await o.load(),a=(e&&t.lodAt(Math.min(t.lods.length-1,e))?.resolution)??"finest-contiguous";i=await o.createElevationSampler(r,{...s,demResolution:a})}catch(t){if(U(t))return;x.getLogger(o).error(t)}finally{o.destroy()}return i}(i,s,a,r);default:return}};async function xt(t,r,e){return await T(e),t.map((t=>(t.z=r,t)))}function Ut(t,r){const{averageGroundElevation:e,spatialReference:s}=r,o=R(s);return t.map((t=>{const r=t.clone();return r.z=e*o/t.spatialReference.metersPerUnit,r}))}const Tt=new g({x:0,y:0,z:0,spatialReference:B.WebMercator}),Lt=1e3,Et=114,Ct=120,At=50;function Pt(t,r,e){const[s,o,i,a]=r,[n,p,m,l]=e;Ot(s,o,i,a);const u=Ot(n,p,m,l),j=Ft(s,o,i,a),h=Ft(n,p,m,l),y=f(c(),j),g=d(c(),y,h),[k,b,I,S]=function(t,r){const[e,s,o]=t,i=[0,0,0,0];return i[0]=e*r[0]+s*r[1]+o*r[2]+r[3],i[1]=e*r[4]+s*r[5]+o*r[6]+r[7],i[2]=e*r[8]+s*r[9]+o*r[10]+r[11],i[3]=0===(a=e*r[12]+s*r[13]+o*r[14]+r[15])?1:a,i;var a}(t,g);return[k/S,b/S,u?0:I/S]}function Ot(t,r,e,s){return 0===t[2]&&0===r[2]&&0===e[2]&&0===s[2]&&(t[2]=r[2]=e[2]=s[2]=1,!0)}function Ft(t,r,e,s){const o=function(t,r){const[e,s,o,i]=t,a=new Array(4);return a[0]=e*r[0]+s*r[1]+o*r[2]+i*r[3],a[1]=e*r[4]+s*r[5]+o*r[6]+i*r[7],a[2]=e*r[8]+s*r[9]+o*r[10]+i*r[11],a[3]=e*r[12]+s*r[13]+o*r[14]+i*r[15],a}(u([...s,1]),f(new Array(16),l(t[0],r[0],e[0],0,t[1],r[1],e[1],0,t[2],r[2],e[2],0,1,1,1,1))),i=o[0],a=o[1],n=o[2],p=c();return p[0]=i*t[0],p[1]=a*r[0],p[2]=n*e[0],p[3]=0,p[4]=i*t[1],p[5]=a*r[1],p[6]=n*e[1],p[7]=0,p[8]=i*t[2],p[9]=a*r[2],p[10]=n*e[2],p[11]=0,p[12]=i,p[13]=a,p[14]=n,p[15]=1,p}function Dt(t,r,s,o,i=e()){return i[0]=t[0]+r[0]*s,i[1]=t[1]+r[1]*s,i[2]=t[2]+r[2]*(s/o),i}function Vt(t,r,s){const o=e();return o[0]=t[0]*r,o[1]=t[1]*r,o[2]=t[2]*(r/s),o}function Nt(t,r){const[s,o,i]=t,a=e();return a[0]=s*r[0]+o*r[3]+i*r[6],a[1]=s*r[1]+o*r[4]+i*r[7],a[2]=s*r[2]+o*r[5]+i*r[8],a}function zt(t,e,s,o=!0){if(!Number.isFinite(t))throw new p("InvalidRotationAngle","Please specify a valid angle for rotation");const i=s*(o?r(t):t),a=Math.cos(i),n=Math.sin(i),c=m();switch(e){case 0:c[4]=a,c[5]=-n,c[7]=n,c[8]=a;break;case 1:c[0]=a,c[2]=n,c[6]=-n,c[8]=a;break;case 2:c[0]=a,c[1]=-n,c[3]=n,c[4]=a;break;default:throw new p("InvalidRotationAxis","Please specify either 0, 1 or 2 for X, Y or Z axis respectively")}return c}const Ht=[[2,-1],[0,1],[2,-1]],Gt=[[0,1],[1,1],[2,1]];function Bt(t,r,e=!0){if(3!==t?.length||3!==r?.length)throw new p("InvalidRotationAngles","Please specify three angles with config for rotation");const s=m();for(let o=0;o<3;o++){const[i,a]=r[o],n=zt(t[o],i,a,e);j(s,n,s)}return s}function qt(t,r=!0){return Bt(t,Ht,r)}function Wt(t,e,s){const o=Math.sin(r(s)),i=Math.cos(r(s)),a=[[t,0],[t,e],[0,e]];a.forEach(((t,r)=>{a[r]=[i*t[0]-o*t[1],o*t[0]+i*t[1]]}));const n=Math.min(0,a[0][0],a[1][0],a[2][0]),p=Math.max(0,a[0][0],a[1][0],a[2][0]),m=Math.min(0,a[0][1],a[1][1],a[2][1]),c=Math.max(0,a[0][1],a[1][1],a[2][1]);return{hfov:Math.abs(p-n),vfov:Math.abs(c-m)}}function Yt(e,s){const o=Number(e[0]),i=Number(e[1]),a=Number(e[2]),[n,p,m,c]=s,l=r(n),u=r(p),j=m/Math.sqrt(1-c*Math.sin(l)**2),h=o/j,f=i/j,d=a/j,y=Math.cos(l)-Math.sin(l)*f+Math.cos(l)*d,g=Math.sin(l)+Math.cos(l)*f+Math.sin(l)*d,k=Math.sqrt(y**2+h**2),b=c*j*Math.sin(l),I=(t,r=5)=>{if(0===r)return t;const e=I(t,r-1);return Math.atan(g/k-(b-c*(m/Math.sqrt(1-c*Math.sin(e)**2))*Math.sin(e))/(j*k))},S=I(l),R=Math.atan(o/(j*y))+u,M=t(S);return[t(R),M,o/(Math.cos(S)*Math.sin(R-u))-m/Math.sqrt(1-c*Math.sin(S)**2)]}function _t(t,r,e){const s=360/r,o=180/e;return{heading:(t.x-r/2)*s,pitch:90-(t.y-e/2)*o}}function Qt(r,e,s,o=500){const{heading:i,pitch:a}=function(r,e){const s=t(Math.acos(-r.z/e));return{heading:t(Math.atan2(r.x,r.y)),pitch:s}}(r,o);return Xt(i,a,e,s)}function Xt(t,r,e,s){const o=t%360;return{x:e/2+(o<-180?o+360:o>180?o-360:o)/(360/e),y:s-r/(180/s),heading:t,pitch:r}}function $t(t,e,s=500){return[s*(Math.sin(r(t))*Math.sin(r(e))),s*(Math.cos(r(t))*Math.sin(r(e))),s*Math.cos(r(180-e))]}function Jt(t,r,e,s=500){const{heading:o,pitch:i}=_t(t,r,e);return $t(o,i,s)}async function Zt(r,e,s){const o=await k(e,r.spatialReference,s);let i=t(Math.atan2(o.y-r.y,o.x-r.x));return i=i>=0&&i<=90?90-i:i>90&&i<=180?360-i+90:90+Math.abs(i),i}function Kt(t,r,e){const s=Math.cos(e),o=Math.sin(e),i=[1,0,0,1,0,0],a=i[0]*s+i[2]*o,n=i[1]*s+i[3]*o,p=-i[0]*o+i[2]*s,m=-i[1]*o+i[3]*s;return i[0]=a,i[1]=n,i[2]=p,i[3]=m,[t*i[0]+r*i[2]+i[4],t*i[1]+r*i[3]+i[5]]}const tr=t=>t.toArray(),rr=(...t)=>t.some((t=>t));function er(t,r){if(rr(0===t.length,t.some((({x:t,y:r})=>rr(null==t,null==r))),!r.hasZ))throw new Error("Input pixels must have x, y and camera location must have z value")}function sr(t,r){if(t.some((t=>null==t.z))||null==r.z)throw new Error("Input points and camera location must have z value")}function or(t){if(9!==t?.length)throw new Error("Rotation matrix is not provided or is not a valid 3x3 matrix")}function ir(t,r){return b(r)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*t/I.radius))):1}const ar=t=>r=>new g(r,t),nr=t=>null!=t&&"queryExtent"in t;function pr(t,r,s,o){return[[-r,-r],[+r,-r],[+r,+r],[-r,+r]].map((([r,i])=>Pt(S(e(),s,[r,i,0]),o,t)))}function mr(t,r){if(null==t)return null;const e=parseFloat(`${t}`);return isNaN(e)?null:e}function cr(t,r,e){const{cameraHeight:s,cameraPitch:o,cameraRoll:i,elevation:a,farDistance:n,horizontalFieldOfView:p,location:m,verticalFieldOfView:c}=Rr(t,t.location.spatialReference),l=a??(m.z??0)-s;return{...ur(t,r,e),averageElevation:l,cameraPitch:o,cameraRoll:i??0,farDistance:n,horizontalFieldOfView:p,verticalFieldOfView:c}}function lr(t,r,e){const{cameraHeading:s,cameraHeight:o,farDistance:i,horizontalFieldOfView:a,location:n,verticalFieldOfView:p}=Rr(t,t.location.spatialReference);return{averageElevation:(n.z??0)-o,cameraLocation:n,cameraHeading:s,farDistance:i,horizontalFieldOfView:a,imageHeight:e,imageWidth:r,verticalFieldOfView:p}}function ur(t,r,e){const{a0:s,a1:o,a2:i,b0:a,b1:n,b2:p,cameraHeading:m,cameraOrientation:c,cameraPitch:l,cameraRoll:u,focalLength:j,horizontalFieldOfView:h,location:f,matrix:d,principalX:y,principalY:g,radial:k,tangential:b,verticalFieldOfView:I}=t,{affines:S,focalLength:R}=function({a0:t,a1:r,a2:e,b0:s,b1:o,b2:i},a,n,p){const m=[t??a/2-.5,r,e??0,s??n/2-.5,o??0,i].map(mr);var c;return null!=p&&null!=(c=m)[1]&&null!=c[5]?{affines:m,focalLength:p}:{affines:[a/2-.5,1,0,n/2-.5,0,-1]}}({a0:s,a1:o,a2:i,b0:a,b1:n,b2:p},r,e,j),M=d??function(t,r,e,s){return kr(s)?function(t,r=!0){return Bt(t,Gt,r)}([s.omega,s.phi,s.kappa]):br(s)?qt([s.heading,s.pitch,s.roll]):qt([t,r,e??0])}(m,l,u,c),v=null!=y&&null!=g?[y,g]:void 0;return{affineTransformations:c?.affineTransformations??S,cameraLocation:f.clone(),focalLength:c?.focalLength??R,horizontalFieldOfView:h,imageHeight:e,imageWidth:r,principalOffsetPoint:c?.principalOffsetPoint??v,radialDistortionCoefficients:c?.radialDistortionCoefficients??k,rotationMatrix:M,tangentialDistortionCoefficients:c?.tangentialDistortionCoefficients??b,verticalFieldOfView:I}}const jr=t=>null!=t&&"elevationSample"in t&&null!=t.elevationSample,hr=t=>w(t?.elevationSource)&&null!=t?.extent,fr=async(t,r,e,s,o)=>{const i=R(t),a=r-e/i;return(t=>M(t?.elevationSource))(s)?(s.elevationSource=new v({constantElevation:s.elevationSource.constantElevation/i}),s):jr(s)?s:hr(s)?{elevationSample:await wt({...y(s.elevationSource)?s.elevationSource.toJSON():s.elevationSource,extent:s.extent},o),elevationSource:new v({constantElevation:a})}:{averageGroundElevation:a,spatialReference:t}},dr=t=>W(t?.heading)&&W(t?.pitch),yr=(t,r)=>[[-t,-r],[t,-r],[t,r],[-t,r]];function gr(t){const{cameraLocation:s,farDistance:a,horizontalFieldOfView:n,rotationMatrix:p,scalingFactor:c,verticalFieldOfView:l}=t,u=m();h(u,p);const j=2*Math.tan(r(l)/2)*a*c,f=2*Math.tan(r(n)/2)*a*c,d=Nt([0,0,-1],u),y=Dt([s.x,s.y,s.z],d,t.farDistance*c,c),g=Nt([0,1,0],u),k=Nt([1,0,0],u),b=Vt(g,j/2,c),I=Vt(k,f/2,c),S=o(e(),b,I),R=i(e(),b,I);return[i(e(),y,S),i(e(),y,R),o(e(),y,S),o(e(),y,R)]}const kr=t=>2===t?.type,br=t=>1===t?.type;function Ir(t,r,e){if("panoramic"===t){const[t,s]=e;return Qt({x:r.x,y:r.y,z:r.z},t,s)}return{x:r.x+.5,y:.5-r.y}}var Sr;function Rr(t,r,e=!0){const s=R(r),o=e?t.clone():t;return o.cameraHeight/=s,o.farDistance/=s,o.nearDistance/=s,M(o.elevationSource)&&(o.elevationSource.constantElevation/=s),o}function Mr(r,e,s,o){const i=s-r,a=o-e;return t(Math.atan2(a,i))}function vr(t){let r=t%360;return r<0&&(r+=360),r}function wr(t,r){const e={towards:{distance:1/0,node:null},backwards:{distance:1/0,node:null},left:{distance:1/0,node:null},right:{distance:1/0,node:null}};r.forEach((r=>{if(t===r)return;const s=t.getDistanceTo(r),o=t.getDirectionTo(r);s>=e[o].distance||(e[o].node=r,e[o].distance=s,e[o].heading=vr(r.heading),e[o].pitch=vr(r.pitch))})),t.reset(),t.towards=e.towards.node,t.backwards=e.backwards.node,t.left=e.left.node,t.right=e.right.node}function xr(t,r,e,s){const o={towards:{distance:1/0,node:null},backwards:{distance:1/0,node:null},left:{distance:1/0,node:null},right:{distance:1/0,node:null}};r.forEach((r=>{if(t===r)return;const i=t.getDistanceTo(r),a=t.getDirectionTo(r),n=vr(t.heading)-vr(vr(r.heading)),p=vr(t.pitch)-vr(r.pitch);i>=o[a].distance||null!=e&&!Ur(n,e)||null!=s&&!Ur(p,s)||(o[a].node=r,o[a].distance=i,o[a].heading=vr(r.heading),o[a].pitch=vr(r.pitch))})),t.reset(),t.towards=o.towards.node,t.backwards=o.backwards.node,t.left=o.left.node,t.right=o.right.node}function Ur(t,r){return Math.abs(t)<=r}function Tr(t,r){const{cameraLocation:e,pointsToTransform:i,scalingFactor:a}=function(t,r,e){const s=Array.isArray(t)||"items"in t?t:[t];sr(s,r),Cr(s,r),or(e);const o=ir(r.y,r.spatialReference);return{pointsToTransform:s.map((t=>t.toArray())),scalingFactor:o,cameraLocation:r.toArray()}}(t,r.cameraLocation,r.rotationMatrix),n=new Array;return function(t,r,e){const{affineTransformations:i,cameraLocation:a,focalLengthX:n,focalLengthY:p,principalOffsetPoint:m,radialDistortionCoefficients:c,rotationMatrix:l,scalingFactor:u,tangentialDistortionCoefficients:j}=e;for(const e of t){const t=s();o(t,e,a),t[0]=t[0]/u,t[1]=t[1]/u;const h=-n*((l[0]*t[0]+l[3]*t[1]+l[6]*t[2])/(l[2]*t[0]+l[5]*t[1]+l[8]*t[2])),f=-p*((l[1]*t[0]+l[4]*t[1]+l[7]*t[2])/(l[2]*t[0]+l[5]*t[1]+l[8]*t[2])),d=h*h+f*f;let y=0,g=0,k=0,b=0,I=0,S=0,R=0;c&&(y=c[0]??0,g=c[1]??0,k=c[2]??0),j&&(b=j[0],I=j[1]),m&&(S=m[0]??0,R=m[1]??0);const M=1+y*d+g*d*d+k*d*d*d;let v=h*M+b*(d+2*h**2)+2*I*h*f,w=f*M+I*(d+2*f**2)+2*b*h*f;v+=S,w+=R;const x=Number(i[0])+Number(i[1])*v+Number(i[2])*w,U=Number(i[3])+Number(i[4])*v+Number(i[5])*w;r.push({x,y:U})}}(i,n,{...r,cameraLocation:e,scalingFactor:a,...Ar(r)}),Array.isArray(t)?n:n[0]}function Lr(t,r,e){return Tr(t?r.map((t=>n(t))):r,e).map((t=>({...t,z:1})))}function Er(r,e){const{cameraHeading:s,imageHeight:o,imageWidth:i}=e,{cameraLocation:n,pointsToTransform:p}=function(t,r){const e=Array.isArray(t)||"items"in t?t:[t];return sr(e,r),Cr(e,r),{pointsToTransform:e.map((t=>t.toArray())),cameraLocation:r.toArray()}}(r,e.cameraLocation),m=new Array,c=ir(n[1],e.cameraLocation.spatialReference);for(const r of p){const e=a([n[0],n[1],n[2]*c],[r[0],r[1],r[2]*c]),p=[(r[0]-n[0])/e,(r[1]-n[1])/e,(r[2]-n[2])*c/e],l=0!==p[0]&&0!==p[1]?vr(t(Math.atan2(p[0],p[1]))-s):0,u=t(Math.acos(-p[2]));m.push(Xt(l,u,i,o))}return Array.isArray(r)?m:m[0]}function Cr(t,r){if(t.some((t=>!t.spatialReference.equals(r.spatialReference))))throw new Error("Input points and camera location must have the same spatial reference")}function Ar(t){if(function(t){return null!=t?.focalLength}(t))return{focalLengthX:t.focalLength,focalLengthY:t.focalLength};const{imageWidth:e,imageHeight:s,horizontalFieldOfView:o,verticalFieldOfView:i}=t;return{focalLengthX:e/(2*Math.tan(r(o)/2)),focalLengthY:s/(2*Math.tan(r(i)/2))}}!function(t){t[t.CLOCKWISE=-1]="CLOCKWISE",t[t.COUNTERCLOCKWISE=1]="COUNTERCLOCKWISE"}(Sr||(Sr={}));export{xr as $,Pt as A,rt as B,et as C,st as D,Z as E,Q as F,Y as G,_ as H,wr as I,Tt as J,Lt as K,Ct as L,At as M,bt as N,gt as O,kt as P,Et as Q,lt as R,tt as S,It as T,Kt as U,Yt as V,Rr as W,qt as X,Nt as Y,Jt as Z,ft as _,Qt as a,Mr as a0,it as a1,nt as a2,yt as a3,Zt as a4,$t as a5,ut as a6,K as a7,dt as a8,X as a9,cr as aa,fr as ab,lr as ac,St as ad,Ir as ae,jt as af,ht as ag,at as ah,wt as ai,mt as aj,ur as ak,ct as al,hr as b,Xt as c,Rt as d,Ut as e,ot as f,xt as g,ir as h,jr as i,dr as j,_t as k,nr as l,or as m,vr as n,rr as o,tr as p,gr as q,yr as r,Wt as s,ar as t,Mt as u,er as v,Vt as w,Tr as worldToImage,Er as worldToImagePanoramic,Lr as worldToImageWithLTPFlag,Dt as x,pr as y,pt as z};
