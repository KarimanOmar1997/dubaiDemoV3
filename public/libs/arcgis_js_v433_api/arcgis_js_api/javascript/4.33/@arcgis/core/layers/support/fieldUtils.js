/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{g as n,s as i}from"../../config.js";import{u as t}from"../../chunks/SetUtils.js";import{parseWhereClause as r}from"../../core/sql.js";import{m as l}from"../../chunks/maybe.js";import{b as o,g as s}from"../../chunks/guards.js";import{D as a}from"../../chunks/datetime.js";import"../../core/lang.js";import"../../chunks/Logger.js";const u="HH:mm:ss",c="HH:mm:ss.SSS",f={HMS_MS:c},d=[c,u,"HH:mm","TT"],m="yyyy-MM-dd",p=u;function y(e){if(!e||!o(e))return null;const n=a.fromFormat(e,m);return n.isValid?n:null}function g(e){return e&&o(e)?l(d,(n=>{const i=a.fromFormat(e,n);return i.isValid?i:null}))??null:null}function F(e){if(!e||!o(e))return null;const n=a.fromISO(e);return n.isValid?n:null}var I;!function(e){e.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",e.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"}(I||(I={}));const b=new Set(["integer","small-integer","long","big-integer","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeLong","esriFieldTypeBigInteger"]);function T(e){return null!=e&&("date-only"===e.type||"esriFieldTypeDateOnly"===e.type)}function w(e){return null!=e&&("timestamp-offset"===e.type||"esriFieldTypeTimestampOffset"===e.type)}function x(e){return null!=e&&("time-only"===e.type||"esriFieldTypeTimeOnly"===e.type)}const h=new Set(["single","double","esriFieldTypeSingle","esriFieldTypeDouble"]),_=t(b,h);function A(e,n,i){const t=i??e?.domain;if(!t)return null;switch(t.type){case"range":{const{min:i,max:r}=E(e,t);if(null!=i&&+n<i||null!=r&&+n>r)return I.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(null==t.codedValues||t.codedValues.every((e=>null==e||e.code!==n)))return I.INVALID_CODED_VALUE}return null}function E(e,n){const i=n??e?.domain;if(!i||"range"!==i.type)return;const t="range"in i?i.range[0]:i.minValue,r="range"in i?i.range[1]:i.maxValue,l=function(e){return null!=e&&b.has(e.type)}(e);return T(e)||x(e)||w(e)?{...S(e,r,t),isInteger:l}:{min:null!=t&&"number"==typeof t?t:null,max:null!=r&&"number"==typeof r?r:null,rawMin:t,rawMax:r,isInteger:l}}function v(e,n){switch(n.type){case"range":{const{min:i,max:t}=E(e,n);return T(e)||x(e)||w(e)?!!i&&!!t:"number"==typeof i&&Number.isFinite(i)&&"number"==typeof t&&Number.isFinite(t)}case"codedValue":case"coded-value":{const i=typeof n.codedValues[0].code;if("string"===i&&function(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}(e)||"number"===i&&function(e){return null!=e&&_.has(e.type)}(e))return!0}}return!1}function S(e,n,i){return T(e)?{min:y(i)?.toMillis(),max:y(n)?.toMillis(),rawMin:i,rawMax:n}:x(e)?{min:g(i)?.toMillis(),max:g(n)?.toMillis(),rawMin:i,rawMax:n}:w(e)?{min:F(i)?.toMillis(),max:F(n)?.toMillis(),rawMin:i,rawMax:n}:{max:null,min:null}}function N(e){if(!e)return;const n=e.match(M);return n?.groups?n.groups.doubleQuoted??n.groups.singleQuoted??n.groups.dotNotation:void 0}const M=/^(\$feature\[(?:"(?<doubleQuoted>[^"]+)"|'(?<singleQuoted>[^']+)')\]|\$feature\.(?<dotNotation>[a-zA-Z_][a-zA-Z0-9_]*))$/i;function V(e){return e.match(L)?.[1]?.replace(/\\'/g,"'")??null}const L=/^hash\(\$feature\['((\\'|[^'])+)'\]\) \* 8\.381e-8$/;let $;function D(){return $||($=(async()=>{const[e,n,i]=await Promise.all([import("../../chunks/arcadeUtils.js"),import("../../chunks/batchExec.js"),import("../../chunks/aiServices.js").then((e=>e.A))]);return{arcade:e.arcade,arcadeUtils:e,batchExec:n,aiServices:i,Dictionary:e.Dictionary,Feature:e.arcadeFeature,Voxel:e.Voxel}})()),$}const O=/^([0-9_])/,U=/[^a-z0-9_\u0080-\uffff]+/gi;function k(e){return null==e?null:e.trim().replaceAll(U,"_").replace(O,"F$1")||null}const j=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],R=["field","normalizationField"];function C(e,n){if(null!=e&&null!=n)for(const i of Array.isArray(e)?e:[e])if(G(j,i,n),"visualVariables"in i&&i.visualVariables)for(const e of i.visualVariables)G(R,e,n)}function G(e,t,r){if(e)for(const l of e){const e=n(l,t),o=e&&"function"!=typeof e&&r.get(e);o&&i(l,o.name,t)}}function P(e,n){if(null!=e&&n?.fields?.length)if("startField"in e){const i=n.get(e.startField),t=n.get(e.endField);e.startField=i?.name??null,e.endField=t?.name??null}else{const i=n.get(e.startTimeField),t=n.get(e.endTimeField);e.startTimeField=i?.name??null,e.endTimeField=t?.name??null}}const z=new Set;function q(e,n){return e&&n?(z.clear(),X(z,e,n),Array.from(z).sort()):[]}function X(e,n,i){if(i)if(n?.fields?.length)if(i.includes("*"))for(const{name:i}of n.fields)e.add(i);else for(const t of i)H(e,n,t);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const n of i)null!=n&&e.add(n)}}function H(e,n,i){if("string"==typeof i)if(n){const t=n.get(i);t&&e.add(t.name)}else e.add(i)}function B(e,n){return null==n||null==e?[]:n.includes("*")?(e.fields??[]).map((e=>e.name)):n}function Q(e,n,i=1){if(!n||!e)return[];if(n.includes("*"))return["*"];const t=q(e,n);return t.length/e.fields.length>=i?["*"]:t}async function Y(e,n,i){if(!i)return;let t;const r=N(i);if(r)t=[r];else{const{arcadeUtils:e}=await D();t=e.extractFieldNames(i,n?.fields?.map((e=>e.name)))}for(const i of t)H(e,n,i)}async function J(n,i,t){if(t&&"1=1"!==t){const l=await r(t,i);if(!l.isStandardized)throw new e("fieldUtils:collectFilterFields","Where clause is not standardized",{where:t});X(n,i,l.fieldNames)}}function W({displayField:e,fields:n}){return e||(n?.length?Z(n,"name-or-title")||Z(n,"unique-identifier")||Z(n,"type-or-category")||function(e){for(const n of e){if(!n?.name)continue;const e=n.name.toLowerCase();if(e.includes("name")||e.includes("title"))return n.name}return null}(n):null)}function Z(e,n){for(const i of e)if(i?.valueType&&i.valueType===n)return i.name;return null}async function K(e){if(!e)return[];const n=new Set;return await ee(n,e),Array.from(n).sort()}async function ee(e,n){if(!n)return;const i=n.elevationInfo?.featureExpressionInfo;return i?i.collectRequiredFields(e,n.fieldsIndex):void 0}async function ne(e,n,i){if(!n||!i||!("fields"in i))return;const t=[],r=i.popupTemplate;t.push(te(e,n,r)),i.fields&&t.push(...i.fields.map((async i=>function(e,n,i){i.onStatisticExpression?Y(e,n,i.onStatisticExpression.expression):e.add(i.onStatisticField)}(e,n.fieldsIndex,i)))),await Promise.all(t)}async function ie(e,n){const{fieldsIndex:i,trackInfo:t}=n;if(!n||!t||!i)return;const r=[t.latestObservations.renderer?.collectRequiredFields(e,i),t.previousObservations.renderer?.collectRequiredFields(e,i),t.trackLines.renderer?.collectRequiredFields(e,i)];t.popupTemplate&&r.push(te(e,n,t.popupTemplate));for(const n of[t.latestObservations.labelingInfo,t.previousObservations.labelingInfo,t.trackLines.labelingInfo])if(n)for(const t of n)r.push(Te(e,i,t));await Promise.all(r)}async function te(e,n,i){const t=[];i?.expressionInfos&&t.push(...i.expressionInfos.map((i=>Y(e,n.fieldsIndex,i.expression))));const r=i?.content;if(Array.isArray(r))for(const i of r)"expression"===i.type&&i.expressionInfo&&t.push(Y(e,n.fieldsIndex,i.expressionInfo.expression));await Promise.all(t)}async function re(e,n,i){n&&(n.timeInfo&&i?.timeExtent&&X(e,n.fieldsIndex,[n.timeInfo.startField,n.timeInfo.endField]),n.floorInfo&&X(e,n.fieldsIndex,[n.floorInfo.floorField]),null!=i?.where&&await J(e,n.fieldsIndex,i.where))}async function le(e,n,i){n&&i&&await Promise.all(i.map((i=>async function(e,n,i){n&&i&&(i.valueExpression?await Y(e,n.fieldsIndex,i.valueExpression):i.field&&H(e,n.fieldsIndex,i.field))}(e,n,i))))}async function oe(e){if(!e)return[];const n="timeInfo"in e&&e.timeInfo;return n?q(e.fieldsIndex,[e.trackIdField,n.startField,n.endField]):[]}function se(e){return e?q(e.fieldsIndex,pe(e)):[]}function ae(e){if(!e)return[];const n=e.geometryFieldsInfo;return n?q(e.fieldsIndex,[n.shapeAreaField,n.shapeLengthField]):[]}async function ue(e,n,i){if(!n||!i)return;const t=n.fieldsIndex;await Promise.all(i.filters.map((n=>J(e,t,n.where))))}const ce=new Set(["oid","global-id","guid"]),fe=new Set(["oid","global-id"]),de=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^shape$/i,/^shape_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/objectid/i,/^perimeter_/i,/_perimeter$/i,/_i$/i];function me(e){const n=new Set;ye(e).forEach((e=>n.add(e))),ae(e).forEach((e=>n.add(e.toLowerCase())));const i=e&&"infoFor3D"in e?e.infoFor3D:void 0;return i&&(Object.values(i.assetMapFieldRoles).forEach((e=>n.add(e.toLowerCase()))),Object.values(i.transformFieldRoles).forEach((e=>n.add(e.toLowerCase())))),Array.from(n)}function pe(e){if(!e)return[];const n="editFieldsInfo"in e&&e.editFieldsInfo;if(!n)return[];const{creationDateField:i,creatorField:t,editDateField:r,editorField:l}=n;return[i,t,r,l].filter(Boolean)}function ye(e){return pe(e).map((e=>e.toLowerCase()))}function ge(e,n){return e.editable&&!ce.has(e.type)&&!ye(n).includes(e.name?.toLowerCase()??"")}function Fe(e,n){const i=e.name?.toLowerCase()??"";return!(null!=n?.objectIdField&&i===n.objectIdField.toLowerCase()||null!=n?.globalIdField&&i===n.globalIdField.toLowerCase()||me(n).includes(i)||fe.has(e.type)||de.some((e=>e.test(i))))}async function Ie(e){if(!e)return[];const n=new Set;return await be(n,e),Array.from(n).sort()}async function be(e,n){const{labelingInfo:i,fieldsIndex:t}=n;i?.length&&await Promise.all(i.map((n=>Te(e,t,n))))}async function Te(e,n,i){if(!i)return;const t=i.getLabelExpression(),r=i.where;if("arcade"===t.type)await Y(e,n,t.expression);else{const i=t.expression.match(/{[^}]*}/g);i&&i.forEach((i=>{H(e,n,i.slice(1,-1))}))}await J(e,n,r)}function we(e){const n=e.defaultValue;return void 0!==n&&ve(e,n)?n:e.nullable?null:void 0}function xe(e){const n="string"==typeof e?{type:e}:e;return je(n)?255:"esriFieldTypeDate"===n.type||"date"===n.type?8:void 0}function he(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function _e(e){return null===e||he(e)}function Ae(e){return null===e||Number.isInteger(e)}function Ee(){return!0}function ve(e,n){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"big-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":case"esriFieldTypeBigInteger":i=e.nullable?Ae:Number.isInteger;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?_e:he;break;case"string":case"esriFieldTypeString":i=e.nullable?s:o;break;default:i=Ee}return 1===arguments.length?i:i(n)}const Se=["integer","small-integer","big-integer","long"],Ne=["single","double"],Me=[...Se,...Ne],Ve=["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeLong","esriFieldTypeBigInteger"],Le=["esriFieldTypeSingle","esriFieldTypeDouble"],$e=new Set([...Se,...Ve]),De=new Set([...Ne,...Le]),Oe=t($e,De);function Ue(e){return null!=e&&$e.has(e.type)}function ke(e){return null!=e&&Oe.has(e.type)}function je(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function Re(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)}function Ce(e){return null!=e&&("date-only"===e.type||"esriFieldTypeDateOnly"===e.type)}function Ge(e){return null!=e&&("timestamp-offset"===e.type||"esriFieldTypeTimestampOffset"===e.type)}function Pe(e){return null!=e&&("time-only"===e.type||"esriFieldTypeTimeOnly"===e.type)}function ze(e){return null!=e&&("oid"===e.type||"esriFieldTypeOID"===e.type)}function qe(e){return null!=e&&("global-id"===e.type||"esriFieldTypeGlobalID"===e.type)}function Xe(e,n){return null===Ye(e,n)}var He,Be;function Qe(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function Ye(e,n){return null==e||e.nullable&&null===n?null:ve(e,n)?ke(e)&&!Je(e.type,Number(n))?He.OUT_OF_RANGE:null:Be.INVALID_TYPE}function Je(e,n){const i="string"==typeof e?Ze(e):e;if(!i)return!1;const t=i.min,r=i.max;return i.isInteger?Number.isInteger(n)&&n>=t&&n<=r:n>=t&&n<=r}function We(e,n){return E(e,n)||(ke(e)?Ze(e.type):void 0)}function Ze(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return en;case"esriFieldTypeInteger":case"esriFieldTypeLong":case"integer":case"long":return nn;case"esriFieldTypeBigInteger":case"big-integer":return tn;case"esriFieldTypeSingle":case"single":return rn;case"esriFieldTypeDouble":case"double":return ln}}function Ke(e){if(!he(e))return null;if(Number.isInteger(e)){if(e>=en.min&&e<=en.max)return"esriFieldTypeSmallInteger";if(e>=nn.min&&e<=nn.max)return"esriFieldTypeInteger";if(e>=tn.min&&e<=tn.max)return"esriFieldTypeBigInteger"}return e>=rn.min&&e<=rn.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}!function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"}(He||(He={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(Be||(Be={}));const en={min:-32768,max:32767,isInteger:!0,rawMin:-32768,rawMax:32767},nn={min:-2147483648,max:2147483647,isInteger:!0,rawMin:-2147483648,rawMax:2147483647},tn={min:-Number.MAX_SAFE_INTEGER,max:Number.MAX_SAFE_INTEGER,isInteger:!0,rawMin:-Number.MAX_SAFE_INTEGER,rawMax:Number.MAX_SAFE_INTEGER},rn={min:-34e37,max:12e37,isInteger:!1,rawMin:-34e37,rawMax:12e37},ln={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1,rawMin:-Number.MAX_VALUE,rawMax:Number.MAX_VALUE};function on(e,n,i){switch(e){case I.INVALID_CODED_VALUE:return`Value ${i} is not in the coded domain - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case I.VALUE_OUT_OF_RANGE:return`Value ${i} is out of the range of valid values - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case Be.INVALID_TYPE:return`Value ${i} is not a valid value for the field type - field: ${n.name}, type: ${n.type}, nullable: ${n.nullable}`;case He.OUT_OF_RANGE:{const{min:e,max:t}=Ze(n.type);return`Value ${i} is out of range for the number type - field: ${n.name}, type: ${n.type}, value range is ${e} to ${t}`}}}function sn(e,n){return!an(e,n,null)}function an(e,n,i){if(!e?.attributes||!n){if(null!=i)for(const e of n??[])i.add(e);return!0}const t=new Set(Object.keys(e.attributes));let r=!1;for(const e of n)if(!t.has(e)){if(r=!0,null==i)break;i.add(e)}return r}async function un(e,n){const i=new Set;for(const t of n)await Y(i,e.fieldsIndex,t);return Array.from(i).sort()}function cn(e){return!!e&&["raster.itempixelvalue","raster.servicepixelvalue"].some((n=>e.toLowerCase().startsWith(n)))}async function fn(e,n){const i=new Set;return e?.collectRequiredFields&&await e.collectRequiredFields(i,n),Array.from(i).sort()}function dn(e){const n=e?.match(/{[^}]+}/g);return n?n.map((e=>e.slice(1,-1).split(":")[0].trim())):[]}export{I as D,He as NumericRangeValidationError,f as T,Be as TypeValidationError,N as a,g as b,tn as bigIntegerRange,m as c,Y as collectArcadeFieldNames,ue as collectDisplayFilterFields,ee as collectElevationFields,ne as collectFeatureReductionFields,H as collectField,X as collectFields,re as collectFilterFields,be as collectLabelingFields,le as collectOrderByInfos,te as collectPopupTemplateFields,ie as collectTrackInfoFields,y as d,ln as doubleRange,p as e,dn as extractSubstitutionTemplatesFromString,S as f,sn as featureHasFields,q as fixFields,C as fixRendererFields,P as fixTimeInfoFields,Le as floatJSONTypes,Ne as floatTypes,E as g,W as getDisplayFieldName,pe as getEditTrackingFields,K as getElevationFields,un as getExpressionFields,se as getFeatureEditFields,ae as getFeatureGeometryFields,xe as getFieldDefaultLength,we as getFieldDefaultValue,We as getFieldRange,Ie as getLabelingFields,me as getLowerCaseDefaultHiddenFields,ye as getLowerCaseEditTrackingFields,Ke as getNumericTypeForValue,fn as getRendererFields,oe as getTimeFields,v as i,Ve as integerJSONTypes,nn as integerRange,Se as integerTypes,Re as isDateField,Ce as isDateOnlyField,ge as isFieldEditable,Fe as isFieldVisibleByDefault,qe as isGlobalIDField,Ue as isIntegerField,Je as isNumberInRange,ke as isNumericField,ze as isObjectIDField,cn as isRasterPixelValueField,je as isStringField,Pe as isTimeOnlyField,Ge as isTimestampOffsetField,Xe as isValidFieldValue,ve as isValueMatchingFieldType,D as l,V as m,k as normalizeFieldName,Me as numericTypes,Q as packFields,an as populateMissingFields,j as rendererFields,Qe as sanitizeNullFieldValue,rn as singleRange,en as smallIntegerRange,F as t,B as unpackFieldNames,A as v,Ye as validateFieldValue,on as validationErrorToString,R as visualVariableFields};
