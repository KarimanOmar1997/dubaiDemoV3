/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import{g as t,u as i}from"../../../chunks/featureReferenceUtils.js";import s from"../../../core/Accessor.js";import{i as r,equals as o,h as a}from"../../../core/lang.js";import{L as n}from"../../../chunks/Logger.js";import{m as l}from"../../../chunks/mapCollectionUtils.js";import{d as c,a as h,c as d,f as p}from"../../../chunks/maybe.js";import{watch as u,initial as m,syncAndInitial as v,when as f,sync as w}from"../../../core/reactiveUtils.js";import{property as g}from"../../../core/accessorSupport/decorators/property.js";import{subclass as _}from"../../../core/accessorSupport/decorators/subclass.js";import{n as b,c as V,h as y,d as j,a as M,i as S,j as D,t as k,s as O,g as T,b as C,u as x,f as R,x as P,e as A}from"../../../chunks/vec3.js";import{c as F,f as E,b as U,a as H,z}from"../../../chunks/vec3f64.js";import{tryProjectWithZConversion as L,canProjectWithoutEngine as I,isLoaded as B,projectOrLoad as W}from"../../../chunks/projectionUtils.js";import{p as N}from"../../../chunks/projectBoundingRect.js";import{e as G,v as q}from"../../../chunks/aaBoundingRect.js";import{A as Q,a as X,c as K,r as Y,s as J}from"../../../chunks/analysisViewUtils.js";import{c as Z,b as $,R as ee,M as te,d as ie,O as se,L as re,l as oe}from"../../../chunks/RenderObject.js";import{h as ae,m as ne,d as le}from"../../../chunks/handleUtils.js";import ce from"../../../Color.js";import{e as he,r as de,c as pe}from"../../../chunks/mathUtils.js";import{d as ue,E as me,z as ve,x as fe,B as we,m as ge,j as _e,y as be,v as Ve,n as ye,s as je}from"../../../chunks/mat4.js";import{c as Me,I as Se}from"../../../chunks/mat4f64.js";import{C as De,R as ke}from"../../../chunks/basicInterfaces.js";import{R as Oe}from"../../../chunks/Material.js";import Te from"../../../analysis/Viewshed.js";import Ce from"../../../geometry/Point.js";import{g as xe,f as Re,c as Pe,p as Ae}from"../../../chunks/plane.js";import{c as Fe}from"../../../chunks/asyncUtils.js";import{c as Ee,C as Ue}from"../../../chunks/Cyclical.js";import{after as He,throwIfAborted as ze}from"../../../core/promiseUtils.js";import{v as Le}from"../../../chunks/ViewingMode.js";import Ie from"../../../core/Handles.js";import{f as Be}from"../../../chunks/boundedPlane.js";import{s as We,d as Ne}from"../../../chunks/dragEventPipeline3D.js";import{l as Ge,m as qe}from"../../../chunks/cameraUtils.js";import{I as Qe,M as Xe,d as Ke,a as Ye,b as Je}from"../../../chunks/MoveManipulation.js";import{c as Ze,q as $e,p as et,f as tt}from"../../../chunks/GeometryUtil.js";import{A as it}from"../../../chunks/BufferView.js";import{R as st}from"../../../chunks/RibbonLineMaterial.js";import{c as rt,b as ot,g as at,d as nt}from"../../../chunks/dragEventPipeline.js";import{a as lt}from"../../../chunks/interfaces2.js";import{b as ct}from"../../../chunks/ray.js";import{m as ht}from"../../../chunks/sliceToolConfig.js";import{C as dt}from"../../../chunks/ColorMaterial.js";import"../../../chunks/Warning.js";import"../../../core/Error.js";import{E as pt}from"../../../chunks/EditGeometryOperations.js";import{S as ut}from"../../../chunks/settings2.js";import{a as mt}from"../../../chunks/ExtendedLineVisualElement.js";import{L as vt}from"../../../chunks/LaserlineVisualElement.js";import{t as ft}from"../../../chunks/intersectorUtilsConversions.js";import{s as wt}from"../../../chunks/keybindings.js";import{n as gt}from"../../../chunks/ToolIntersector.js";import{b as _t}from"../../../chunks/screenUtils2.js";import{P as bt}from"../../../chunks/PointVisualElement.js";import{A as Vt}from"../../../chunks/orientedBoundingBox.js";import{G as yt,ak as jt,$ as Mt,Y as St,ac as Dt,h as kt,d as Ot,l as Tt,ai as Ct,m as xt,R as Rt}from"../../../chunks/Matrix4PassUniform.js";import{V as Pt}from"../../../chunks/VertexAttribute.js";import{c as At}from"../../../chunks/lineStippleUtils.js";import{I as Ft}from"../../../chunks/Intersector2.js";import{S as Et}from"../../../chunks/IntersectorResult.js";import Ut from"../../../core/Collection.js";import{h as Ht}from"../../../chunks/sphere.js";import{InternalRenderCategory as zt}from"../webgl.js";import Lt from"../webgl/RenderNode.js";import{R as It}from"../../../chunks/RenderFeature.js";import{D as Bt,I as Wt}from"../../../chunks/SceneLighting.js";import{c as Nt,b as Gt}from"../../../chunks/vec4f64.js";import qt from"../webgl/RenderCamera.js";import{m as Qt,n as Xt,p as Kt}from"../../../chunks/enums.js";import{f as Yt}from"../../../chunks/Texture.js";import{C as Jt,S as Zt,F as $t}from"../../../chunks/BooleanBindUniform.js";import{g as ei}from"../../../chunks/glsl.js";import{N as ti}from"../../../chunks/ShaderTechniqueConfiguration.js";import{M as ii,a as si}from"../../../chunks/Matrix4BindUniform.js";import{M as ri}from"../../../chunks/Matrix4sPassUniform.js";import{S as oi}from"../../../chunks/ShaderBuilder.js";import{m as ai,u as ni,d as li}from"../../../chunks/renderState.js";import"../../../chunks/get.js";import"../../../chunks/utils.js";import"../../../chunks/Lifecycle.js";import"../../../chunks/metadata.js";import"../../../chunks/ObjectPool.js";import"../../../chunks/ObservableBase.js";import"../../../chunks/tracking.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/PooledArray.js";import"../../../config.js";import"../../../chunks/events.js";import"../../../chunks/SetUtils.js";import"../../../chunks/SimpleTrackingTarget.js";import"../../../chunks/ensureType.js";import"../../../chunks/MapUtils.js";import"../../../chunks/common.js";import"../../../chunks/SimpleObservable.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../geometry/SpatialReference.js";import"../../../core/JSONSupport.js";import"../../../chunks/unitUtils.js";import"../../../chunks/jsonMap.js";import"../../../chunks/pe.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../chunks/jsonUtils.js";import"../../../chunks/persistableUrlUtils.js";import"../../../chunks/writer.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../chunks/reader.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/coordsUtils.js";import"../../../chunks/Axis.js";import"../../../chunks/extentUtils.js";import"../../../chunks/boundsUtils.js";import"../../../geometry/Polyline.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/geodesicConstants.js";import"../../../chunks/projectXYZToVector.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../core/Promise.js";import"../../../chunks/InteractiveToolBase.js";import"../../../core/Evented.js";import"../../../chunks/VisualElement.js";import"../../../chunks/line.js";import"../../../chunks/vec2.js";import"../../../chunks/vec2f64.js";import"../../../chunks/aaBoundingBox.js";import"../../../chunks/Indices.js";import"../../../chunks/screenUtils.js";import"../../../chunks/mat3.js";import"../../../chunks/mat3f64.js";import"../../../chunks/computeTranslationToOriginAndRotation.js";import"../../../chunks/lineSegment.js";import"../../../chunks/vector.js";import"../../../chunks/quatf64.js";import"../../../chunks/hydratedFeatures.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../core/Clonable.js";import"../../../layers/support/fieldUtils.js";import"../../../core/sql.js";import"../../../chunks/guards.js";import"../../../chunks/datetime.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/support/AttachmentsOrderByInfo.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../chunks/enumeration.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../chunks/date.js";import"../../../chunks/locale.js";import"../../../chunks/constants.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../core/Identifiable.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../chunks/shared.js";import"../../../geometry/support/jsonUtils.js";import"../../../chunks/typeUtils2.js";import"../../../chunks/createFeatureId.js";import"../../../chunks/typeUtils.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../portal/Portal.js";import"../../../core/Loadable.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils5.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../chunks/opacityUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils6.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/Font.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/SimpleMarkerSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/dehydratedPoint.js";import"../../../chunks/elevationInfoUtils.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../chunks/ray2.js";import"../../../chunks/colorUtils.js";import"../../../chunks/vec4.js";import"../../../chunks/graphicUtils.js";import"../../../chunks/meshVertexSpaceUtils.js";import"../../../geometry/support/MeshGeoreferencedVertexSpace.js";import"../../../geometry/support/MeshLocalVertexSpace.js";import"../../../chunks/InterleavedLayout.js";import"../../../chunks/types.js";import"../../../chunks/ShaderOutput.js";import"../../../chunks/VertexColor.glsl.js";import"../../../chunks/Matrix3DrawUniform.js";import"../../../chunks/BindType.js";import"../../../chunks/AlphaCutoff.js";import"../../../chunks/Intersector.js";import"../../../chunks/HUDIntersectorResult.js";import"../../../chunks/mathUtils2.js";import"../../../chunks/verticalOffsetUtils.js";import"../../../Camera.js";import"../../../CameraLayout.js";import"../../../chunks/projectPointToVector.js";import"../../../chunks/projectVectorToPoint.js";import"../../../chunks/projectVectorToVector.js";import"../../../chunks/DepthRange.js";import"../../../chunks/frustum.js";import"../../../chunks/earthUtils.js";import"../../../chunks/spatialReferenceSupport.js";import"../../../chunks/floatRGBA.js";import"../../../chunks/vec3f32.js";import"../../../chunks/Octree.js";import"../../../chunks/Float4DrawUniform.js";import"../../../chunks/TriangleMaterial.js";import"../../../chunks/geometry2dUtils.js";import"../../../chunks/EngineVisualElement.js";import"../../../chunks/GridLocalOriginFactory.js";import"../../../chunks/RenderGeometry.js";import"../../../chunks/debugFlags2.js";import"../../../chunks/signal.js";import"../../../chunks/axisAngleDegrees.js";import"../../../chunks/quat.js";import"../../../chunks/weather.js";import"../environment/CloudyWeather.js";import"../environment/FoggyWeather.js";import"../environment/RainyWeather.js";import"../environment/SnowyWeather.js";import"../environment/SunnyWeather.js";import"../../../chunks/HighlightDefaults.js";import"../../../chunks/VertexElementDescriptor.js";import"../../../chunks/VertexArrayObject2.js";import"../../../chunks/VertexArrayObject.js";import"../../../chunks/memoryEstimations.js";import"../../../chunks/NestedMap.js";import"../../../chunks/HUDRenderStyle.js";import"../../../chunks/Scheduler.js";import"../../../chunks/debugFlags.js";import"../../../chunks/BlendColorsPremultiplied.glsl.js";import"../../../chunks/glUtil.js";import"../../../chunks/InputManager.js";import"../../../chunks/Queue.js";import"../../../chunks/ElevationContext.js";import"../../../chunks/dehydratedFeatureUtils.js";import"../../../chunks/HUDMaterial.js";import"../../../chunks/HUDVisibility.glsl.js";import"../../../chunks/VerticalOffset.glsl.js";import"../../../chunks/spatialReferenceEllipsoidUtils.js";import"../../../chunks/triangle.js";import"../../../chunks/videoUtils.js";import"../../../chunks/requestImageUtils.js";import"../../../chunks/TextureFormat.js";import"../../../chunks/FBOAttachmentType.js";import"../../../chunks/getDataTypeBytes.js";const ci=he(2),hi=new class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=4,this.fovFocusedArcWidth=2*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=2/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}},di=new class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new ce([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:ce.toUnitRGBA(new ce([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:Oe.Occlude,cullFace:De.Back,writeDepth:!1}}};function pi({tiltedUpVector:e,rightVector:t,observerRenderSpace:i},s){const r=$(e,t,i,s);return r[12]=0,r[13]=0,r[14]=0,r}function ui(e,t,i,s){const r=F(),o=xe(i.plane),a=function(e,t){const i=vi;e.renderCoordsHelper.toRenderCoords(e.camera.position,i);const s=Ge(e,i,e.camera.heading,e.camera.tilt,qe()).direction;return de(y(s,t))-90}(t,o);let n;if(Math.abs(a)>hi.viewAngleThreshold)n=e.next(We(t,i.plane));else{const r=Re(s.targetRenderSpace,i.basis1,Pe()),o=b(vi,i.basis1),a=b(fi,i.basis2);n=e.next(We(t,r)).next((e=>{const t=e=>{const t=j(M(wi,e,i.origin),a),r=Math.acos(pe(t/s.farDistanceRenderSpace,-1,1)),n=Math.sin(r)*s.farDistanceRenderSpace;return S(F(),i.origin,S(F(),D(wi,o,n),D(gi,a,t)))},r=t(e.renderStart),n=t(e.renderEnd);return{...e,renderStart:r,renderEnd:n}}))}return n.next((e=>{"start"===e.action&&V(r,e.renderStart);const t=de(Z(r,e.renderEnd,i.origin,o));return{...e,deltaAngle:t}}))}function mi(e,t,i,s){return ue(_i,i,s),k(e,t,_i)}const vi=F(),fi=F(),wi=F(),gi=F(),_i=Me();class bi extends Qe{constructor(e){super(),this._handles=new Ie,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles=c(this._handles),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const i=Object.values(this._manipulators);return ae(i.map((({manipulator:i,side:s})=>rt(i,((i,r,o,a,n)=>{const l=function(e,{observerRenderSpace:t,targetRenderSpace:i,tiltedUpVector:s,rightVector:r,farDistanceRenderSpace:o}){const a=M(Mi,i,t),n=Vi(e)?r:s,l=D(Si,n,o);return Be(t,a,l)}(s,t),c=ui(r.next((e=>({...e,manipulatorType:Xe.SCALE,side:s}))),this._view,l,t);e(i,c,o)})))))}updateManipulatorsTransform(e){e.arcCentersPoints(Di),this._forEachManipulatorInfo((t=>this._updateArcManipulatorTransform(t,e,Di[t.side])))}updateManipulatorVisuals(e){this._forEachManipulatorInfo((t=>this._updateArcManipulatorVisuals(t,e)))}_updateArcManipulatorVisuals({manipulator:e,side:t},i){const s=[];if(null!=i){const[r,o]=function(e,t,i){const{horizontalFieldOfView:s,verticalFieldOfView:r}=t,o=Vi(e),a=he(pe((o?r:s)/2,0,15)),n=function(e,t,i,s=10){it(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const r=t-e;if(r<=0||i<=0)return[E(0,0,.01),E(0,0,-.01)];const o=[],a=r/s;for(let r=0;r<s;r++){let n=e+r*a;r===s-1&&(n=t);const l=Math.cos(n)*i,c=Math.sin(n)*i,h=E(l-i,0,c);o.push(h)}return o}(-a/2,a/2,o?1:Math.max(Math.sin(he(90-r/2)),.1));return[Ze(i,n),n]}(t,i,this._unfocusedArcMaterial);s.push(new ee(r,lt.Unfocused),new ee(r.instantiate({material:this._focusedArcMaterial}),lt.Focused)),e.collisionType={type:"line",paths:[o]}}e.renderObjects=s,e.radius=hi.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:t},i,s){const r=i.horizontalFieldOfView,o=he(i.verticalFieldOfView/2),a=he(r/2),n=Vi(t);e.renderLocation=s;const l=Me(),c=e=>{ge(l,e,l)};c(me(ji,he(-90))),n||c(ve(ji,o));const h=i.farDistanceRenderSpace;let d,p;c(fe(ji,O(Mi,h,h,h))),c(we(ji,function(e){return function(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}(e)*yi}(t))),c(pi(i,ji)),n?(d=a,p=i.tiltedUpVector):(p=i.rightVector,d=o),d*="right"===t||"bottom"===t?-1:1;const u=ue(ji,d,p);null!=u&&c(u),e.modelTransform=l}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:s},[[s.manipulator,i.manipulator],[e.manipulator,t.manipulator]].forEach((([e,t])=>{e.metadata={pairedManipulator:t},t.metadata={pairedManipulator:e}}))}_createArcManipulator(e){const t=new te({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:t,side:e};return this._updateArcManipulatorVisuals(i),this._handles.add(t.events.on("focus-changed",(e=>{const i=t.metadata?.pairedManipulator;null!=i&&(i.hovering!==t.hovering&&(i.hovering=t.hovering),i.grabbing!==t.grabbing&&(i.grabbing=t.grabbing))}))),i}_createArcMaterial(e){const t=hi.getFovArcWidth(e),i=new st({renderOccluded:Oe.OccludeAndTransparent,isDecoration:!0,width:t});return this._handles.add(u((()=>ce.toUnitRGBA(this._view.effectiveTheme.accentColor)),(e=>i.setParameters({color:e})),m)),i}forEachManipulator(e){Object.values(this._manipulators).forEach((({manipulator:t})=>e(t,Xe.SCALE)))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach((t=>e(t)))}get test(){return{manipulators:this._manipulators}}}function Vi(e){return"left"===e||"right"===e}const yi=Math.PI/2,ji=Me(),Mi=F(),Si=F(),Di={top:F(),bottom:F(),left:F(),right:F()};class ki extends te{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:hi.collisionRadius}),this._handles=new Ie,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),i=[E(0,0,0),E(0,0,1)],s=$e(t,i,e,16,!1),r=$e(t,i,e*ht,16,!1),o=Oi(!1,t,e),a=Oi(!0,t,e),n=Me();_e(n,i[i.length-1]),be(n,n,ve(Ti,Math.PI/2)),be(n,n,me(Ti,Math.PI/2)),o.transformation=n,a.transformation=n,this.renderObjects=[new ee(s,lt.Unfocused),new ee(r,lt.Focused),new ee(o,lt.Unfocused),new ee(a,lt.Focused)];const l=E(0,hi.getScaleOrientArrowTipLength(!0),0),c=k(l,l,n),h=[...i,c];this.collisionType={type:"line",paths:[h]}}_createMaterial(){const e=new dt({cullFace:De.Back,renderOccluded:Oe.OccludeAndTransparent,isDecoration:!0});return this._handles.add(u((()=>ce.toUnitRGBA(this.view.effectiveTheme.accentColor)),(t=>e.setParameters({color:t})),m)),e}}function Oi(e,t,i){const s=hi.getScaleOrientArrowTipLength(e);let r=2*i;e&&(r*=ht);const o=s/2;return et(t,s,o,o,r,0)}const Ti=Me();class Ci extends Qe{constructor(e){super(),this._handles=new Ie,this._tool=e.tool,this._view=e.view;const t=hi.scaleOrientHandleRadius;this._manipulatorHeading=new ki(this._view,t),this._manipulatorTilt=new ki(this._view,t),this._manipulatorDistance=new ki(this._view,t),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return rt(this._manipulatorHeading,((i,s,r,o,a)=>{const n=this._view,{tiltParallelToSurface:l,farDistanceRenderSpace:c,upVector:h,observerRenderSpace:d,targetRenderSpace:p,rightVector:u}=t,m=Math.sin(he(l))*c,v=S(Pi,d,D(Ai,h,m)),f=M(Ai,p,v),w=D(Fi,u,T(f)),g=ui(s,n,Be(v,f,w),t).next((e=>({...e,manipulatorType:Xe.ROTATE})));e(i,g,r)}))}createTiltDragPipeline(e,t){return rt(this._manipulatorTilt,((i,s,r,o,a)=>{const{observerRenderSpace:n,farDistanceRenderSpace:l,upVector:c,targetDirection:h}=t,d=j(h,c),p=C(Pi,h,c,-d);D(p,b(p,p),l);const u=D(Ai,c,l),m=Be(n,p,u),v=ui(s,this._view,m,t).next((e=>({...e,manipulatorType:Xe.ROTATE})));e(i,v,r)}))}createDistanceDragPipeline(e,t){return rt(this._manipulatorDistance,((i,s,r,o,a)=>{const n=ct(t.observerRenderSpace,t.targetDirection),l=s.next(ot(this._view,i.location)).next(Ne(this._view,n)).next((e=>({...e,manipulatorType:Xe.SCALE})));e(i,l,r)}))}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=Me(),s=e=>{ge(i,e,i)},r=hi.scaleOrientSize*(Ke/Ye);s(fe(xi,O(Pi,r,r,r))),s(pi(e,xi));const o=hi.scaleOrientHandleRadius*ht*r,a=D(Pi,e.targetDirection,o);s(_e(xi,a));const n=we(xi,-Ei);be(n,n,me(Ri,-Ei)),this._manipulatorHeading.modelTransform=be(Me(),i,n);const l=me(xi,Ei);be(l,l,we(Ri,Math.PI)),this._manipulatorTilt.modelTransform=ge(Me(),i,l),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,Xe.ROTATE),e(this._manipulatorTilt,Xe.ROTATE),e(this._manipulatorDistance,Xe.SCALE)}}const xi=Me(),Ri=Me(),Pi=F(),Ai=F(),Fi=F(),Ei=Math.PI/2;class Ui extends te{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:hi.observerSize,interactive:!1}),this._handles=new Ie;const i=ie(this._color);this.renderObjects=[new ee(tt(i,hi.observerSize,32,32))],t.manipulators.add(this),this._handles.add([u((()=>this._color),(e=>{i.setParameters({color:e})}),m)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return ce.toUnitRGBA(this.view.effectiveTheme.accentColor)}}e([g()],Ui.prototype,"_color",null);const Hi=Symbol("dragHandles"),zi=Symbol("hideManipulators"),Li=Symbol("hideFoVManipulators"),Ii=Symbol("hideObserverManipulator");let Bi=class extends s{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new bi({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Ci({view:this.view,tool:this.parentTool}),this._observerManipulator=new Ui(this.view,this.parentTool),this.addHandles([u((()=>this.viewshedComputedData?.observerRenderSpace),(e=>{null!=e&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)}),v),u((()=>this.viewshedComputedData?.heading),(e=>{e&&(this._moveManipulation.angle=he(90-e))}),m),u((()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}}),(({viewshedComputedData:e,observer:t},i)=>{this._grabbing&&t!==i?.observer||(this.removeHandles(Hi),e?.valid&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(r),Hi))}),m),u((()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)}),m),u((()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)}),m),u((()=>{const e=this.analysisViewData.visible&&(this.viewshedComputedData?.valid??!1),t=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||t)}}),(({fovManipulationAvailable:e,nonFOVManipulationAvailable:t})=>{this._moveManipulation.available=t,this._scaleOrientManipulation.available=t,this._observerManipulator.available=t,this._fieldOfViewManipulation.available=e}),m),u((()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const{observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}=e;return{viewshedCompData:e,observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}}),(e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)}),m)]),this._forEachManipulator((e=>{const t=this.analysisViewData;this.addHandles([e.events.on("focus-changed",(()=>{const e=this._someManipulatorHovering();e&&this.parentTool.subToolHandles.forEach((({subTool:e})=>{e._resetHoveringTask()})),this._someManipulatorSelected()||e||(this._forceHoveringTask=Fe((async e=>{await(this._forceHoveringTestPromise??He(hi.hoverTimeoutMilliseconds,e)),ze(e),this._forceHoveringTask=null,this._updateManipulatorVisibility()})))})),e.events.on("grab-changed",(i=>{this._grabbing="start"===i.action,"end"===i.action&&t.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach((({subTool:e})=>{e!==this&&e._setInteractive(!this._grabbing)})),this._setInteractive((t=>t.hasManipulator(e)||!this._grabbing))})),e.events.on("drag",(e=>{"start"===e.action&&t.tool?.updateInteractionVisualsVisibility()}))])}))}destroy(){this._forceHoveringTask=h(this._forceHoveringTask),this._moveManipulation=c(this._moveManipulation),this._fieldOfViewManipulation=c(this._fieldOfViewManipulation),this._scaleOrientManipulation=c(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=c(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;null!=t&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t="boolean"==typeof e;this._forEachManipulation((i=>i.interactive=t?e:e(i)))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),this._someManipulatorSelected()||(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator((i=>{t=t||i===e})),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Je({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Ke})}_buildObserverDragPipeline(e){const t=e.observer;if(null==t)return null;const i=this.view.spatialReference;return this._moveManipulation.createDragPipeline(((e,s,r,o,a)=>{o=o.next(at(this,["observer"]));const n=L(t,i);if(null==n)return{steps:r,cancel:o};const l=pt.fromGeometry(n,Le(this.view.viewingMode));return{steps:r.next(nt({operations:l})).next((e=>(this.observer=l.data.geometry,e))),cancel:o}}),{mode:"absolute-height",offset:0},i,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline(((s,r,o)=>{if(null==e)return{steps:r,cancel:o};const a=e.viewshed;let n=null;o=o.next(at(a,["horizontalFieldOfView","verticalFieldOfView"]));const l=r.next((s=>{"start"===s.action&&(n=null,t=e.horizontalFieldOfView,i=e.verticalFieldOfView);const r=s.deltaAngle;if(null==n&&0!==r){const e="bottom"===s.side||"left"===s.side?r>0:r<0;n=Vi(s.side)?0===t&&e||360===t&&!e:0===i&&e}const o=n?function(e){return"left"===e?"right":"right"===e?"left":"top"===e?"bottom":"top"}(s.side):s.side;let l=0;switch(o){case"left":l=t/2-r;break;case"right":l=t/2+r;break;case"top":l=i+2*r;break;case"bottom":l=i-2*r}return Vi(o)?(l=Ee.normalize(l),l=l>270?0:l>180?180:l,a.horizontalFieldOfView=2*l):a.verticalFieldOfView=l,s}));return{steps:l,cancel:o}}),e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const s=(t,i)=>(s,r,o)=>{if(null==e)return{steps:r,cancel:o};const a=e.viewshed;return o=o.next(at(a,[t])),{steps:r=r.next(i(a,e)),cancel:o}};return ae([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",((t,s)=>s=>("start"===s.action&&(i=e.heading),t.heading=Ee.normalize(i+s.deltaAngle),s))),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",((i,s)=>s=>{"start"===s.action&&(t=e.tilt);let r=t+s.deltaAngle;return r<-90?r=180:r>270&&(r=0),i.tilt=Ni.clamp(r),s})),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",((e,t)=>i=>{const s=M(Wi,i.renderEnd,t.observerRenderSpace),r=T(s)*t.metersPerUnit,o=j(s,t.targetDirection)<0?hi.scaleOrientMinDistance:r;return e.farDistance=o,i})),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=null!=this._forceHoveringTask||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating;let r=[];const o=e=>{r.push(e.disableDisplay())};e||!s&&t?this.removeHandles(zi):(this._scaleOrientManipulation.forEachManipulator(o),this._moveManipulation.forEachManipulator(o),this.addHandles(r,zi),r=[]),e||!s&&t||s&&i?this.removeHandles(Li):(this._fieldOfViewManipulation.forEachManipulator(o),this.addHandles(r,Li)),e||!s?this.removeHandles(Ii):this.addHandles(this._observerManipulator.disableDisplay(),Ii)}_resetHoveringTask(){this._forceHoveringTask=h(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation((t=>{t.forEachManipulator(e)})),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};e([g({constructOnly:!0})],Bi.prototype,"analysis",void 0),e([g({constructOnly:!0})],Bi.prototype,"analysisViewData",void 0),e([g({constructOnly:!0})],Bi.prototype,"parentTool",void 0),e([g({constructOnly:!0,nonNullable:!0})],Bi.prototype,"view",void 0),e([g()],Bi.prototype,"viewshed",null),e([g()],Bi.prototype,"_grabbing",void 0),e([g()],Bi.prototype,"grabbing",null),e([g()],Bi.prototype,"viewshedComputedData",void 0),e([g()],Bi.prototype,"observer",null),Bi=e([_("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],Bi);const Wi=F(),Ni=new Ue(0,180),Gi=Symbol("interactionVisuals");let qi=class extends Q{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=es,this._creationState=!1,this._interactionVisualElements=null,this._settings=new ut({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=gt(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=l((()=>e),(({viewshedComputedData:e})=>{const t=new Bi({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:t,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),t.destroy()}}})),this.addHandles([f((()=>this._valid),(()=>this.finishToolCreation()),v),u((()=>this._stagedViewshed),(e=>{const t=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null!=e&&null!=t?this._findSubTool(e)?.viewshedComputedData:null}),v),this.analysis.viewsheds.on("after-remove",(e=>{const t=this._stagedViewshed;null!=t&&e.item===t&&this.analysis.viewsheds.add(t)})),u((()=>this.firstGrabbedManipulator),(e=>{if(null!=e){const t=this._findSubTool(e)?.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()}),w),u((()=>this.view.activeTool),(e=>{e!==this&&null!=e&&(this.selectedViewshed=null)})),f((()=>{const e=this.selectedViewshedComputedData;return null==e?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}}),(e=>{const{subTool:t,observer:i,target:s}=e;t?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(i,!0):t?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(s,!1)}),m),u((()=>this.creating),(()=>this.updateInteractionVisualsVisibility())),u((()=>this.selectedViewshed),(e=>{const t=this._selectedManipulator,i=this._selectedSubTool;null==e?this._selectManipulator(null):null!=t&&i.hasManipulator(t)||this._selectManipulator(i.discManipulator)}),m)])}destroy(){this.subToolHandles=c(this.subToolHandles),this.removeHandles(Gi)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){return this.analysisViewData.viewshedComputedDataHandles?.some((e=>e.viewshedComputedData.valid))??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){const t=this._selectedManipulator;t!==e&&(this._selectedManipulator=e,null!=t&&(t.selected=!1),null!=e&&(e.selected=!0),this._findSubTool(t)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some((({subTool:e})=>e.grabbing))}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}place(e){this.selectedViewshed=null,this._placementMode=e,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach((e=>e.subTool.onManipulatorSelectionChanged()))}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":wt.cancel===e.key?this._cancelKeyHandler(e):wt.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}onActivate(){this._placementMode=es}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,$i);if(null!=t){if("placing-observer"===this._creationState){t.mapPoint.z=(t.mapPoint.z??0)+1.5;const e=new Te({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if("placing-target"===this._creationState){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,"multiple"===this._placementMode?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=e}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,$i);null!=t&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){this.creating?this._onCancelWhileCreating(e):this.grabbing||(this.selectedViewshed=null,e.stopPropagation())}_onCancelWhileCreating(e){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,"multiple"===this._placementMode&&e.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:s,tilt:r,farDistance:o}=function(e,t,i){const s=t.observerRenderSpace,r=M(Qi,i,s),o=T(r)*t.metersPerUnit,a=e.renderCoordsHelper.basisMatrixAtPosition(s,Ji),n=O(Xi,a[8],a[9],a[10]),l=Re(s,n,Zi),c=Ae(l,i,Ki),h=M(c,c,s),d=(T(h)<1e-4?90:de(y(r,h)))*(j(n,r)<0?-1:1)+90,p=O(Yi,a[4],a[5],a[6]),u=de(y(p,h)),m=O(Yi,a[0],a[1],a[2]);return{heading:j(h,m)<0?360-u:u,tilt:d,farDistance:o}}(this.view,i,e);t.farDistance=o,t.tilt=r,t.heading=s}removeStaged(){const e=this._stagedViewshed;return null!=e&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(e),!0)}_intersectScreen(e,t){const i=_t(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,r=t.scenePoint;if(!s.getIntersectionPoint(r))return null;const o=t.mapPoint;return o.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,o),null==o?null:(t.feature=ft(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(Gi);const e=this._settings.visualElements,t=new vt({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new mt({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:Oe.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([u((()=>e.zVerticalLine),(e=>e.apply(i)),v),u((()=>e.heightPlane),(e=>e.apply(t)),v),ne((()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null}))],Gi)}updateInteractionVisualsVisibility(e=!1){const t=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,r=this.selectedViewshedComputedData,o=(e,t)=>{const i=this._interactionVisualElements;null!=i&&(i.verticalLine.attached=t,i.laserline.attached=e)};if(t)return void o(i,!1);if(null==s||null==r)return void o(!1,!1);const a=s.moveInteractionState,n=e?a.grabbing:a.dragging,l=s.scaleOrientInteractionState,c=e?l.grabbing:l.dragging,h=i&&(n||c);if(o(h,n),h){const e=n?r.observerRenderSpace:r.targetRenderSpace;this._updateInteractionVisualsLocation(e,n)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(null==i)return;const{laserline:s,verticalLine:r}=i;s.heightManifoldTarget=e,s.intersectsWorldUpAtLocation=t?e:null,null!=e&&r.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){if(null==e)return null;const t=e instanceof te?t=>t.subTool.hasManipulator(e):t=>t.subTool.viewshed===e;return this.subToolHandles?.find(t)?.subTool}get test(){}};e([g({constructOnly:!0})],qi.prototype,"view",void 0),e([g()],qi.prototype,"analysisViewData",void 0),e([g()],qi.prototype,"removeIncompleteOnCancel",void 0),e([g()],qi.prototype,"automaticManipulatorSelection",void 0),e([g({constructOnly:!0})],qi.prototype,"analysis",void 0),e([g()],qi.prototype,"subToolHandles",void 0),e([g()],qi.prototype,"_stagedViewshed",void 0),e([g()],qi.prototype,"_stagedViewshedComputedData",void 0),e([g()],qi.prototype,"_placementMode",void 0),e([g()],qi.prototype,"_creationState",void 0),e([g()],qi.prototype,"_valid",null),e([g({readOnly:!0})],qi.prototype,"cursor",null),e([g()],qi.prototype,"_selectedManipulator",void 0),e([g()],qi.prototype,"_selectedSubTool",null),e([g()],qi.prototype,"selectedViewshed",null),e([g()],qi.prototype,"selectedViewshedComputedData",null),e([g()],qi.prototype,"stagedViewshed",null),e([g()],qi.prototype,"grabbing",null),e([g()],qi.prototype,"creating",null),e([g()],qi.prototype,"isPlacingTarget",null),qi=e([_("esri.views.3d.analysis.Viewshed.ViewshedTool")],qi);const Qi=F(),Xi=F(),Ki=F(),Yi=F(),Ji=Me(),Zi=Pe(),$i={mapPoint:new Ce,scenePoint:F(),feature:null},es="multiple",ts=qi;class is extends se{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new dt({...di.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(null==e)return;const t=Me(),i=e.farDistanceRenderSpace;fe(t,E(i,i,i)),pi(e,ls),be(t,ls,t),_e(ls,this._viewshedComputedData.observerRenderSpace),be(t,ls,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachMaterial(e){e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:i}=this;if(null==i||null==t||!i.valid)return;const s=function(e,t){const{horizontalFieldOfView:i,verticalFieldOfView:s}=t,r=O(rs,0,0,1),o=O(os,0,1,0),a=O(as,1,0,0);mi(r,r,he(s/2),o),mi(r,r,he(i/2),a);const n=e=>Math.ceil(Math.abs(e)/ci)+1,l=he(i),c=V(ns,a),h=n(l),d=ss(-l/(h-1)),p=ue(ls,d,c),u=he(-s),m=n(u),v=ss(u/(m-1)),f=V(os,o),w=ue(cs,he(i)/2,a);k(f,f,w);const g=cs,_=[],b=V(as,r);for(let e=0;e<h;e++){ue(g,v,f);for(let t=0;t<m;t++){const i=3*(t*h+e);_[i]=b[0],_[i+1]=b[1],_[i+2]=b[2],k(b,b,g)}k(f,f,p),k(r,r,p),V(b,r)}const y=h*m;_[3*y]=0,_[3*y+1]=0,_[3*y+2]=0;const j=[];for(let e=0;e<h-1;e++)for(let t=0;t<m-1;t++){const i=6*(t*(h-1)+e);j[i]=t*h+e,j[i+1]=(t+1)*h+e,j[i+2]=t*h+e+1,j[i+3]=t*h+e+1,j[i+4]=(t+1)*h+e,j[i+5]=(t+1)*h+e+1}const M=[j];if(360!==i&&0!==s){const e=[],t=[];for(let i=0;i<m-1;i++){const s=3*i;e[s]=y,e[s+1]=(i+1)*h,e[s+2]=i*h,t[s]=y,t[s+1]=i*h+h-1,t[s+2]=(i+1)*h+h-1}M.push(e,t)}if(180!==s&&0!==i){const e=[],t=[];for(let i=0;i<h-1;i++){const s=3*i;e[s]=y,e[s+1]=i,e[s+2]=i+1,t[s]=y,t[s+1]=i+(m-1)*h+1,t[s+2]=i+(m-1)*h}M.push(e,t)}return M.map((t=>{const i=[[Pt.POSITION,new Vt(_,t,3,!0)]];return new yt(e,i)}))}(t,i);s.forEach((t=>e.addGeometry(t)))}}function ss(e){return isNaN(e)?1:e}const rs=F(),os=F(),as=F(),ns=F(),ls=Me(),cs=Me();let hs=class extends s{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:F(),topRight:F(),bottomLeft:F(),bottomRight:F()},this._arcCenterPoints={top:F(),bottom:F(),left:F(),right:F()},this._parallelCenters={top:F(),bottom:F()}}initialize(){const e={view:this.view,isDecoration:!0},t={...e,color:this._color,renderOccluded:Oe.OccludeAndTransparent},i={...t,stipplePattern:At(2)};this._observerVisualElement=new bt({...e,...di.observerPointConfiguration}),this._shapeVisualElement=new is({...e,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new re(t),this._leftArcVisualElement=new re(t),this._rightArcVisualElement=new re(t),this._topArcVisualElement=new re(t),this._bottomArcVisualElement=new re(t),this._centralLongitude=new re(i),this._centralLatitude=new re(i),this.addHandles([u((()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const t=this._viewshedCorners,i=this._arcCenterPoints,s=this._parallelCenters;return e.cornerPoints(t),e.arcCentersPoints(i),e.parallelCenterPoints(s),{viewshedComputedData:e,corners:t,arcCenters:i,parallelCenters:s,interactive:this.analysisViewData.interactive,selected:this._selected}}),(e=>{const t=null!=e;this._forEachVisualElement((e=>e.attached=t)),t&&this._updateVisualElements(e)}),{initial:!0,equals:o}),u((()=>{const{viewshedComputedData:e}=this,{horizontalFieldOfView:t,verticalFieldOfView:i}=e??{};return{viewshedComputedData:e,horizontalFieldOfView:t,verticalFieldOfView:i}}),(({viewshedComputedData:e})=>{const{_shapeVisualElement:t}=this;e!==t.viewshedComputedData&&(t.viewshedComputedData=e),this._shapeVisualElement.recreateGeometry()}),m),u((()=>{const{interactive:e}=this.analysisViewData;return{visible:this.visible,selected:e&&this._selected,staged:e&&this._staged,horFovNot360:360!==this.viewshedComputedData?.horizontalFieldOfView}}),(({visible:e,selected:t,staged:i,horFovNot360:s})=>{const r=t||i;this._shapeVisualElement.visible=e,this._topArcVisualElement.visible=e,this._bottomArcVisualElement.visible=e,this._frameLinesVisualElement.visible=e&&s;const o=e&&(t||s);this._leftArcVisualElement.visible=o,this._rightArcVisualElement.visible=o,this._forEachLineVisualElement((e=>{e.width=r?di.frameWidthSelected:di.frameWidthNotSelected,e.renderOccluded=t?Oe.OccludeAndTransparent:Oe.Occlude})),[this._centralLatitude,this._centralLongitude].forEach((i=>{i.width=2*(r?di.frameWidthSelected:di.frameWidthNotSelected),i.visible=e&&t}))}),m),u((()=>{const{analysisViewData:{interactive:e,tool:t},_selected:i,visible:s}=this,r=this.view.activeTool,o=!t?.active&&r instanceof ts&&r.creating;return{observerVisible:s&&!i&&(!e||(t?.creating??!1)||o),color:this._color}}),(({observerVisible:e,color:t})=>{this._observerVisualElement.visible=e,this._forEachLineVisualElement((e=>e.color=t))}),m)])}get _color(){const{viewshedComputedData:e,_selected:t,analysisViewData:i}=this;if(null==e)return ce.toUnitRGBA(di.frameColor);const s=i.tool?.active||i.interactive,r=e.viewshed===i.tool?.stagedViewshed,o=s&&(t||r)?this.view.effectiveTheme.accentColor:di.frameColor;return ce.toUnitRGBA(o)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return null!=e&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return null!=e&&e.creating&&e.stagedViewshed===t?.viewshed}destroy(){this._observerVisualElement=c(this._observerVisualElement),this._shapeVisualElement=c(this._shapeVisualElement),this._frameLinesVisualElement=c(this._frameLinesVisualElement),this._leftArcVisualElement=c(this._leftArcVisualElement),this._rightArcVisualElement=c(this._rightArcVisualElement),this._topArcVisualElement=c(this._topArcVisualElement),this._bottomArcVisualElement=c(this._bottomArcVisualElement),this._centralLongitude=c(this._centralLongitude),this._centralLatitude=c(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:r}=e,o=U(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(o,i),this._updateFrameArcs(t,i,r),this._updateCentralHelperArcs(t,s)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:s,rightVector:r,horizontalFieldOfView:o,tiltedUpVector:a}=e,n=he(o),l=F(),c=Me();ue(c,n/2,a),k(l,r,c),ds(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",l),ue(c,-n/2,a),O(l,0,0,0),k(l,r,c),ds(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",l);const h=o>180?"backward":"forward";ds(this._topArcVisualElement,i.top,t.topRight,t.topLeft,h,a),ds(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,h,a)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";ds(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),ds(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}};function ds(e,t,i,s,r,o,a=ci){const n=F();M(n,i,t);const l=T(n),c=F();M(c,s,t),b(c,c),D(c,c,l);let h=y(n,c);const d=U(o);"backward"===r&&(x(d,d),h=-(2*Math.PI-h));const p=[],u=Math.ceil(Math.abs(h)/a),m=Me();ue(m,h/u,d);const v=F();V(v,n);const f=F();V(f,i);for(let e=0;e<u;e++){const e=F();V(e,f),k(v,v,m),S(f,t,v);const i=F();V(i,f),p.push([e,i])}e.geometry=p}e([g()],hs.prototype,"view",void 0),e([g({constructOnly:!0})],hs.prototype,"isDecoration",void 0),e([g()],hs.prototype,"analysisViewData",void 0),e([g()],hs.prototype,"viewshedComputedData",void 0),e([g()],hs.prototype,"visible",void 0),e([g()],hs.prototype,"_color",null),e([g()],hs.prototype,"_selected",null),e([g()],hs.prototype,"_staged",null),hs=e([_("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],hs);const ps=hs;let us=class extends s{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=l((()=>this.analysisViewData.viewshedComputedDataHandles),(({viewshedComputedData:t})=>{const i=new ps({view:this.view,viewshedComputedData:t,analysisViewData:e,isDecoration:this.isDecoration});return{visualization:i,remove:()=>i.destroy()}}));this._viewshedVisualizations=t,this.addHandles([le(t),u((()=>this.visible),(e=>this._viewshedVisualizations.forEach((({visualization:t})=>t.visible=e))),m)])}get test(){}};var ms;e([g({constructOnly:!0})],us.prototype,"analysisViewData",void 0),e([g({constructOnly:!0,nonNullable:!0})],us.prototype,"view",void 0),e([g({constructOnly:!0})],us.prototype,"isDecoration",void 0),e([g()],us.prototype,"visible",null),us=e([_("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],us);let vs=ms=class extends s{constructor(e){super(e),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new Ce}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,F())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const e=M(F(),this.targetRenderSpace,this.observerRenderSpace);return b(e,e)}get tiltedUpVector(){const e=mi(F(),this.upVector,-he(this.tiltParallelToSurface),this.leftVector);return b(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,Me())}get upVector(){const e=this._basis;return E(e[8],e[9],e[10])}get northVector(){const e=this._basis;return E(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=mi(F(),this.northVector,-he(this.heading),e);return R(t,e,t)}get rightVector(){return x(F(),this.leftVector)}clone(){return new ms({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:s,targetRenderSpace:r}=this,o=M(fs,r,s);return mi(o,o,-he(t),this.leftVector),mi(o,o,-he(e),this.tiltedUpVector),S(i,o,s)}cornerPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-t,i,e.topLeft),this.pointOnSphere(t,i,e.topRight),this.pointOnSphere(-t,-i,e.bottomLeft),this.pointOnSphere(t,-i,e.bottomRight)}arcCentersPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,e.top),this.pointOnSphere(0,-i,e.bottom),this.pointOnSphere(-t,0,e.left),this.pointOnSphere(t,0,e.right)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(he(this.verticalFieldOfView/2)),s=D(fs,this.tiltedUpVector,i);S(e.top,t,s),M(e.bottom,t,s)}renderSpaceToPoint(e,t){const i=fs;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new Ce(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=H(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}_computeTargetRenderSpace(e){const{leftVector:t,northVector:i,upVector:s}=this,r=this.farDistanceRenderSpace,o=F();return D(o,i,r),mi(o,o,-he(this.heading),s),mi(o,o,-he(this.tiltParallelToSurface),t),S(o,e,o),o}};e([g()],vs.prototype,"renderCoordsHelper",void 0),e([g()],vs.prototype,"viewshed",void 0),e([g()],vs.prototype,"observerRenderSpaceOverride",void 0),e([g()],vs.prototype,"needUpdateByFeature",void 0),e([g()],vs.prototype,"observer",null),e([g()],vs.prototype,"effectiveObserverRenderSpace",null),e([g()],vs.prototype,"effectiveObserver",null),e([g()],vs.prototype,"effectiveTargetRenderSpace",null),e([g()],vs.prototype,"farDistance",null),e([g()],vs.prototype,"farDistanceRenderSpace",null),e([g()],vs.prototype,"heading",null),e([g()],vs.prototype,"tilt",null),e([g()],vs.prototype,"feature",null),e([g()],vs.prototype,"tiltParallelToSurface",null),e([g()],vs.prototype,"horizontalFieldOfView",null),e([g()],vs.prototype,"verticalFieldOfView",null),e([g()],vs.prototype,"observerRenderSpace",null),e([g()],vs.prototype,"target",null),e([g()],vs.prototype,"targetRenderSpace",null),e([g()],vs.prototype,"targetDirection",null),e([g()],vs.prototype,"tiltedUpVector",null),e([g()],vs.prototype,"_basis",null),e([g()],vs.prototype,"upVector",null),e([g()],vs.prototype,"northVector",null),e([g()],vs.prototype,"leftVector",null),e([g()],vs.prototype,"rightVector",null),e([g()],vs.prototype,"valid",null),e([g()],vs.prototype,"metersPerUnit",null),vs=ms=e([_("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],vs);const fs=F();let ws=class extends qt{constructor(){super(...arguments),this.sectionAngles=Nt()}get sectionAnglesDeg(){return Gt(this.sectionAngles.map((e=>de(e))))}set sectionAnglesDeg(e){this.sectionAngles=Gt(e.map((e=>he(e))))}get projectionMatrix(){return be(Me(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];it(e<=t),it(i<=s);const r=2*Math.tan(this.fovX/2),o=2*Math.tan(this.fovY/2),a=Math.tan(e),n=Math.tan(t),l=Math.tan(i),c=n-a,h=Math.tan(s)-l,d=r/c,p=o/h,u=-(a+c/2)/r*2,m=-(l+h/2)/o*2,v=Me();_e(v,[u,m,0]);const f=Me();fe(f,[d,p,1]);const w=Me();return be(w,f,v)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};e([g()],ws.prototype,"sectionAngles",void 0),e([g()],ws.prototype,"sectionAnglesDeg",null),e([g()],ws.prototype,"projectionMatrix",null),e([g()],ws.prototype,"sectionMatrix",null),e([g()],ws.prototype,"_sectionRatioX",null),ws=e([_("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],ws);class gs{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const _s=["front","left","right","back","top","bottom"];class bs{constructor(e){this._fbos=e,this._faces={},this._width=0,this._height=0,this.settings=new gs,this._maxTextureSize=Math.min(a("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture(Qt)}get ready(){return null!=this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const e=this.faces;return 0===e.length?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach((i=>{e[i]&&(t+=1)})),t}get faces(){const e=this._faces,t=[];for(const i of _s){const s=e[i];s&&t.push(s)}return t}get atlasRegions(){return this.faces.map((e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height]))}get viewshedProjectionMatrices(){return this.faces.map((e=>e.projectionMatrix))}get viewshedViewMatrices(){return this.faces.map((e=>e.viewMatrix))}_setupFaceCamera(e,t,i,s){const{effectiveObserverRenderSpace:r,tiltedUpVector:o,targetRenderSpace:a,farDistanceRenderSpace:n,horizontalFieldOfView:l,verticalFieldOfView:c}=t,h=F();M(h,a,r);const d=F(),p=F(),u=(e,t)=>{const i=F(),s=Me();return ue(s,e,t),k(i,h,s),S(i,r,i),i};let m,v=o;const f=Math.min(90,l),w=Math.min(90,Math.max(0,(l-90)/2));let g=-45,_=45,b=-45,V=45;if(!["top","bottom"].includes(e)){const e=e=>pe(e,-45,45);b=e(-c/2)-this.settings.toleranceBottomTop,V=e(+c/2)+this.settings.toleranceBottomTop}switch(e){case"front":m=a,g=-f/2,_=f/2;break;case"left":m=u(Math.PI/2,o),g=45-w;break;case"right":m=u(-Math.PI/2,o),_=-45+w;break;case"top":m=S(d,r,o),v=x(p,h);break;case"bottom":m=M(d,r,o),v=h;break;case"back":m=u(Math.PI,o)}const y=new ws({center:m,eye:r,up:v,far:n});y.sectionAnglesDeg=[g-this.settings.toleranceSides,_+this.settings.toleranceSides,b,V],y.fovY=Math.PI/2;const j=y.setViewport(i,s);return this._faces[e]=y,j}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:i,verticalFieldOfView:s}=e,r=-s/2,o=s/2;return 0===i||0===s||(r<=45&&o>=-45&&t.add("front"),i>90&&(t.add("left"),t.add("right")),i>270&&t.add("back"),o>45-this.settings.toleranceBottomTop&&t.add("top"),r<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize({pixelRatio:e,fullWidth:t,fullHeight:i},s,r,o){const a=s/e,n=this.settings.textureSizeModifier(r);return jt(Math.max(t,i)*a*n,this._maxTextureSize/o)}_ensureFBO(e){const t=this._width,i=this._height,s=this._handle?.fbo;s&&s.width===t&&s.height===i&&e===Yt(s.depthStencilTexture?.descriptor?.internalFormat??Xt.DEPTH_COMPONENT16)||(this._handle?.release(),this._handle=this._allocateFBO(e))}_allocateFBO(e){const{_width:t,_height:i}=this,s=e?Bt.DEPTH24_STENCIL8:Bt.DEPTH16,r=this._fbos.acquire(t,i,"viewshed shadow map",s);return r.getTexture(Qt)?.setShadowFiltering(!1),r}clearFBO(e){const t=this._fbos.rctx;this._ensureFBO(e),t.bindFramebuffer(this._handle?.fbo),t.setClearColor(1,1,1,1),t.clear(Kt.COLOR|Kt.DEPTH)}dispose(){this._debugFBO||(this._handle=d(this._handle))}start(e,t,i,s,r=!1){this._faces={};const o=this._computeActiveFaces(t),a=o.size;if(0===a)return!1;const n=this._computeBaseTextureSize(e,s,i,a);let l=0,c=0,h=0;return _s.filter((e=>o.has(e))).forEach((e=>{const i=function(e,t){if(t<4)return 0;const i="front"===e||"left"===e;return 4===t?i?0:1:i||"right"===e?0:1}(e,a);i>c&&(h=Math.max(h,l),l=0),c=i;const s=i*n;l+=this._setupFaceCamera(e,t,[l,s],n)})),h=Math.max(h,l),this._width=this.settings.textureResizeModulo(h),this._height=(a<4?1:2)*n,this.clearFBO(r),!0}finish(){}get test(){}}class Vs extends ti{constructor(){super(...arguments),this.localOrigin=z()}}function ys(e){e.include(Jt),e.fragment.uniforms.add(new Mt("inverseViewMatrix",((e,t)=>{const i=Ve(Me(),t.camera.viewMatrix,e.localOrigin);return ye(i,i)}))).code.add(ei`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}class js extends Vs{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=Se.flat(),this.viewMatrices=Se.flat(),this.volumeOffset=0}}const Ms=Me(),Ss=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:js,build:function(){const e=new oi,t=e.fragment;return e.include(Zt),e.include(ys),t.include(St),t.include(Dt),t.uniforms.add(new kt("depthTexture",(e=>e.depth?.attachment)),new ii("inverseProjectionMatrix",(e=>e.camera.inverseProjectionMatrix)),new ii("inverseViewNormalMatrix",(({camera:e})=>ye(Ms,e.viewInverseTransposeMatrix))),new si("viewshedObserverOffset",(e=>e.observerOffset)),new si("viewshedTargetVector",(e=>e.targetVector)),new si("viewshedUpVector",(e=>e.upVector)),new $t("viewshedFOVs",(e=>e.fovs)),new $t("viewshedHeadingAndTilt",(e=>e.headingAndTilt)),new $t("viewshedNearFar",(e=>e.shadowMap.nearFar??[1,100])),new Ot("viewshedVolumeOffset",(e=>e.volumeOffset)),new Tt("viewshedShadowMap",(e=>e.shadowMap.depthTexture)),new ri("viewshedProjectionMatrices",(e=>e.projectionMatrices),6),new ri("viewshedViewMatrices",(e=>e.viewMatrices),6),new Wt("viewshedNumFaces",(e=>e.shadowMap.numActiveFaces)),new Ct("viewshedAtlasRegions",(e=>e.shadowMap.atlasRegions.flat()),24),new Tt("normalMap",(e=>e.normals))),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(ei`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(ei`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),e}},Symbol.toStringTag,{value:"Module"}));class Ds extends xt{constructor(e,t){super(e,t,new Rt(Ss,(()=>Promise.resolve().then((()=>Ss)))))}initializePipeline(){return ai({colorWrite:li,blending:ni})}}let ks=class extends Lt{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter((e=>function(e,t){const i=Ht(t.observerRenderSpace,t.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(i)}(this.view,e)))}constructor(e){super(e),this.isDecoration=!1,this._passParameters=new js,this._viewsheds=new Ut,this._shadowMap=null,this.consumes={required:[zt.VIEWSHED,"normals"]},this.produces=zt.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new bs(this.fboCache),this.addHandles([u((()=>this.view.resolutionScale),(e=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=e)}),m),f((()=>!this.hasViewsheds),(()=>this._shadowMap?.dispose())),u((()=>this._viewshedsInView.map((e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]))),(()=>this.requestRender(ke.UPDATE)),w)])}destroy(){this._shadowMap=p(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(Ds);for(const e of this._viewshedsInView)if(this._shadowMap?.isActive(e))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(e){const t=this.bindParameters,i=this.renderingContext,s=e.find((({name:e})=>e===zt.VIEWSHED));if(!this.hasViewsheds||!t.depth||this.isDecoration&&!t.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=e.find((({name:e})=>"normals"===e))?.getTexture();const r=this.techniques.get(Ds);if(!r?.compiled)return this.requestRender(ke.UPDATE),s;const o=this.view.stage.renderer.isFeatureEnabled(It.HighResolutionViewshed);for(const e of this._viewshedsInView){if(!this._renderShadowCubeMap(t,e,o)||!this._shadowMap?.ready)continue;const a=this._setupViewshedParameters(e,t.camera);i.bindTechnique(r,t,a),i.bindFramebuffer(s.fbo),i.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(e){const t=this._viewsheds,{removes:i,adds:s}=e;if(i&&(Array.isArray(i)?t.removeMany(i):t.remove(i)),s)if(Array.isArray(s)){const e=s.filter((e=>!t.includes(e)));t.addMany(e)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(e,t,i){const s=this._shadowMap;if(!s)return!1;const r=this.view.basemapTerrain.hasStencilEnabledExtents,o=s.start(e.camera,t,i,this._contentPixelRatio,r);return o&&s.faces.forEach((e=>this.view.stage.renderer.renderViewshedShadowMap(e))),s.finish(),o}_setupViewshedParameters(e,t){const i=this._shadowMap;if(!i)return this._passParameters;const s=this._passParameters,r=e.effectiveObserverRenderSpace;s.localOrigin=r,s.observerOffset=M(Ts,e.observerRenderSpace,e.effectiveObserverRenderSpace),s.fovs=[he(e.horizontalFieldOfView),he(e.verticalFieldOfView)],s.headingAndTilt=[he(e.heading),he(e.tiltParallelToSurface)],s.upVector=e.tiltedUpVector;const o=function(e,t){const i=F();return M(i,e,t)}(e.targetRenderSpace,r);s.targetVector=o;const a=new Array,n=new Array;for(let e=0;e<i.numActiveFaces;e++)Ve(Cs,i.viewshedViewMatrices[e],r),a.push(...Cs),Os(i.viewshedProjectionMatrices[e],Cs,xs),n.push(...xs);return s.viewMatrices=a,s.projectionMatrices=n,s.volumeOffset=this.selectedViewshed?.()===e.viewshed?function(e,t,i){if(null==e)return 0;const{observerRenderSpace:s,targetRenderSpace:r}=e,o=P(i,s)>P(i,r)?e.observer:e.target;return t.pixelSizeAt(o)}(e,this.view,t.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Os(e,t,i){const s=E(.5,.5,.5);return _e(i,s),je(i,i,s),be(i,i,e),be(i,i,t),i}e([g()],ks.prototype,"selectedViewshed",void 0),e([g()],ks.prototype,"isDecoration",void 0),e([g()],ks.prototype,"shadowMap",null),e([g()],ks.prototype,"hasViewsheds",null),e([g()],ks.prototype,"_contentPixelRatio",null),e([g()],ks.prototype,"_viewshedsInView",null),e([g()],ks.prototype,"consumes",void 0),e([g()],ks.prototype,"produces",void 0),ks=e([_("esri.views.3d.webgl-engine.lib.Viewshed")],ks);const Ts=F(),Cs=Me(),xs=Me();let Rs=class extends(X(s)){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const e=this.view;this._viewshedRenderer=new ks({view:e,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed,isDecoration:this._isDecoration}),this._intersector=new Ft(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=Et.MIN,this.viewshedComputedDataHandles=l((()=>this.analysis.viewsheds),(t=>{const i=new vs({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([u((()=>({valid:i.valid,canProject:I(i.observer?.spatialReference,this.view.spatialReference)||B()})),(({valid:e,canProject:t},s)=>{this.visible&&(e&&t?this._addViewshedsToRenderer(i):s?.valid&&s?.canProject&&this._removeViewshedsFromRenderer(i),t||oe(this.analysis,i.observer.spatialReference,n.getLogger(this)))}),m),...this._createFeatureReferenceHandles(i)],s),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}})),this._analysisVisualization=new us({view:e,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([u((()=>this.visible),(e=>{const t=this.viewshedComputedDataHandles;if(null==t)return;e||(this.selectedViewshed=null);const i=t.map((e=>e.viewshedComputedData)).filter((e=>e.valid)).toArray();e?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)})),u((()=>e.renderCoordsHelper),(e=>{this.viewshedComputedDataHandles?.forEach((({viewshedComputedData:t})=>t.renderCoordsHelper=e))})),K(this,ts),f((()=>this.interactive),(()=>{this._unselectOtherViewsheds(this.selectedViewshed)}),v)])}destroy(){this.userOperation=h(this.userOperation),Y(this),this._analysisVisualization=c(this._analysisVisualization);const e=this.viewshedComputedDataHandles;null!=e&&this._removeViewshedsFromRenderer(e.map((e=>e.viewshedComputedData)).toArray())}_createFeatureReferenceHandles(e){const{view:t}=this;return[u((()=>[t.state.camera,t.slice.plane,e.viewshed.observer,e.targetRenderSpace,e.verticalFieldOfView,e.horizontalFieldOfView,e.feature]),(()=>{this._updateObserverFromFeature(t,e)}),m),this._createElevationUpdateHandle(e),f((()=>e.needUpdateByFeature),(()=>{this._updateObserverFromFeature(t,e),e.needUpdateByFeature=!1}))]}_createElevationUpdateHandle(e){const t=(i,s)=>{const{view:r}=this,{observer:o}=e;if(null==o)return;const a=W(o,r.spatialReference);if(null!=a.pending)return void a.pending.finally((()=>t(i,s)));const n=a.geometry;null!=n&&(N(i,s,As,r.spatialReference),q(As,[n.x,n.y])&&(e.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",(({extent:e,spatialReference:i})=>t(e,i)))}async createViewsheds(e){await J(this,{placementOptions:e,onToolActivated:e=>e.place("multiple")})}place(e){return J(this,{placementOptions:e,onToolActivated:e=>e.place("single")})}_addViewshedsToRenderer(e){this._viewshedRenderer.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderer.updateViewsheds({removes:e})}_updateObserverFromFeature(e,s){const r=s.observerRenderSpace,o=s.targetRenderSpace,a=V(F(),r),n={observer:r,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:t(s.feature),target:o,targetSurfaceNormal:null,targetAdjusted:V(F(),o),targetFeatureId:null};i(e,this._intersector,n,(e=>Math.min(e,.05*s.farDistanceRenderSpace))),s.observerRenderSpaceOverride=A(a,r)?null:a}_unselectOtherViewsheds(e){if(null!=e)for(const e of this.view.tools.items)e!==this.tool&&e instanceof ts&&(e.analysisViewData.selectedViewshed=null)}get test(){}};e([g({readOnly:!0})],Rs.prototype,"type",void 0),e([g({constructOnly:!0,nonNullable:!0})],Rs.prototype,"analysis",void 0),e([g()],Rs.prototype,"tool",void 0),e([g()],Rs.prototype,"_selectedViewshed",void 0),e([g()],Rs.prototype,"selectedViewshed",null),e([g()],Rs.prototype,"selectedViewshedComputedData",null),e([g()],Rs.prototype,"viewshedComputedDataHandles",void 0),e([g()],Rs.prototype,"userOperation",void 0),e([g()],Rs.prototype,"_analysisVisualization",void 0),e([g()],Rs.prototype,"_viewshedRenderer",void 0),Rs=e([_("esri.views.3d.analysis.ViewshedAnalysisView3D")],Rs);const Ps=Rs,As=G();export{Ps as default};
