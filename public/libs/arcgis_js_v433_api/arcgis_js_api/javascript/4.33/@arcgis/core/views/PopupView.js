/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as p}from"../chunks/tslib.es6.js";import{c as s}from"../chunks/asyncUtils.js";import e from"../core/Error.js";import{h as t}from"../core/lang.js";import{L as i}from"../chunks/Logger.js";import{throwIfAborted as o,wrapAbortWithTimeout as r,allSettledValues as u,createResolver as n}from"../core/promiseUtils.js";import{watch as a,syncAndInitial as c,whenOnce as h}from"../core/reactiveUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{V as d}from"../chunks/InputManager.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../chunks/SetUtils.js";import"../chunks/SimpleTrackingTarget.js";import"../config.js";import"../chunks/events.js";import"../chunks/ensureType.js";import"../chunks/MapUtils.js";import"../chunks/Warning.js";import"../chunks/Queue.js";import"../chunks/SimpleObservable.js";import"../chunks/signal.js";function y(p){return null!=p&&"open"in p&&"declaredClass"in p}function f(p){return null!=p&&"declaredClass"in p&&"dockOptions"in p}const j=n=>{let j=class extends n{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([a((()=>[this.ui,this.popup]),(([p,s],e)=>{const t="popup";if(e){const[p,i]=e;p&&y(i)&&(i.view=null,f(i)&&(p.remove(i,t),i!==s&&s&&i.destroy()))}p&&y(s)&&(s.view=this,f(s)&&p.add(s,{key:t,position:"manual",internal:!0}))}),c),this.on("click",(p=>{this.popup&&this.popupEnabled&&("mouse"!==p.pointerType||0===p.button)&&(y(this.popup)?this.popup.viewModel.handleViewClick(p):p.defer((async()=>{await this.setupPopup(),y(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(p)})))}),d.WIDGET)]),h((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{import("../widgets/Popup.js")}))}destroy(){this.destroyed||this.closePopup()}async openPopup(p){if(y(this.popup))return this.popup.open(p);try{if(await this.setupPopup(),!this.popup)return void i.getLogger(this).error(new e("view:null-popup","Popup is null and can't be opened"));this.popup.open(p)}catch{}}closePopup(){this._popupSetupTask?.abort(),y(this.popup)&&this.popup.close()}async fetchPopupFeatures(p,s){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(p,s),s)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!y(this.popup))return this._popupSetupTask=s((async p=>{const{default:s}=await import("../widgets/Popup.js");if(o(p),!this.popup||y(this.popup))return;const e=this.popup;delete e.open,delete e.close,this.popup=new s(e)})),this._popupSetupTask.promise}async _popupHitsToFeatures({location:p,hits:s},e){const i=[],o=[];let n=!1;const a=r(e,t("popup-view-fetch-timeout")??w),c=p=>{const s=o.at(-1);return s&&s.layerView===p&&!n?s:(p=>{const s=new k(p);return o.push(s),i.push(s.promise),s})(p)};for(const p of s)"graphic"in p?(c(p.layerView).graphics.push(p.graphic),n=!1):(i.push(p.layerView.fetchPopupFeaturesAtLocation(p.mapPoint,a)),n=!0);o.map((p=>p.resolve(a)));const h=u(i).then((p=>p.filter((p=>!!p)).flat()));return{pendingFeatures:i,allGraphicsPromise:h,location:p}}async _getPopupHits(p,s){const{hits:e,location:t}=await this.popupHitTest(p);o(s);const i=[];for(const p of e)if("graphic"in p){if(this._isValidPopupGraphic(p.graphic,s)){const s=this._isValidPopupGraphicsLayerView(p.layerView)?p.layerView:void 0;i.push({graphic:p.graphic,layerView:s})}}else this._isValidPopupLocationLayerView(p.layerView)&&i.push({mapPoint:p.mapPoint,layerView:p.layerView});return{hits:i,location:t}}_isValidPopupGraphic(p,s){return p&&!!p.getEffectivePopupTemplate(s?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(p){return!p||(!("layer"in p)||!p.suspended)&&"fetchPopupFeaturesFromGraphics"in p}_isValidPopupLocationLayerView(p){return(!("layer"in p)||!p.suspended)&&"fetchPopupFeaturesAtLocation"in p}};return p([l()],j.prototype,"popup",void 0),p([l()],j.prototype,"popupEnabled",void 0),j=p([m("esri.views.PopupView")],j),j};class k{constructor(p){this.layerView=p,this._resolver=n(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(p){const{layerView:s,graphics:e,_resolver:t}=this;if(!s)return t.resolve(e),t.promise;let i;return s.fetchPopupFeaturesFromGraphics(e,p).catch((p=>(i=p,null))).then((p=>{p?t.resolve(p):t.reject(i)})),t.promise}}const w=5e3;export{j as PopupView};
