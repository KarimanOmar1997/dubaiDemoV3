/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Graphic.js";import s from"../../core/Accessor.js";import{u as i,i as r}from"../../core/lang.js";import{c as o}from"../../chunks/asyncUtils.js";import n from"../../core/Collection.js";import a from"../../core/Identifiable.js";import{L as l}from"../../chunks/Logger.js";import{a as p}from"../../chunks/maybe.js";import{whenOrAbort as u,eachAlways as c,throwIfAborted as m,isAbortError as d}from"../../core/promiseUtils.js";import{watch as h,initial as f,when as y,on as j}from"../../core/reactiveUtils.js";import{t as b}from"../../chunks/throttle.js";import{property as g}from"../../core/accessorSupport/decorators/property.js";import{cast as v}from"../../core/accessorSupport/decorators/cast.js";import{subclass as k}from"../../core/accessorSupport/decorators/subclass.js";import I from"../../geometry/Point.js";import _ from"../../geometry/SpatialReference.js";import w from"../../popup/content/TextContent.js";import{s as x}from"../../chunks/constants.js";import T from"../Attachments/AttachmentsViewModel.js";import{graphicCallback as A,getFieldInfoLabel as M,isRelatedField as F,substituteFieldsInLinksAndAttributes as C,fixTokens as E,substituteAttributes as S,getFixedFieldNames as V,getFixedFieldName as R,isExpressionField as U,getFieldInfo as L,applyTextFormattingHTML as P,htmlEntities as O,preLayerQueryCallback as D,preRequestCallback as N,createFieldInfoMap as $,getAllFieldInfos as B,getSourceLayer as Z,querySourceLayer as q,queryUpdatedFeature as G,isRelatableFeatureSupportedLayer as z,isAssociatedFeatureSupportedLayer as Q,formatEditInfo as H,formatAttributes as J}from"../../chunks/featureUtils.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import W from"../../popup/content/FieldsContent.js";import K from"../../popup/content/MediaContent.js";import"../../popup/content/RelationshipContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import X from"../../popup/ElementExpressionInfo.js";import Y from"../../popup/ExpressionInfo.js";import tt from"../../popup/FieldInfo.js";import et from"../../popup/content/support/ChartMediaInfoValueSeries.js";import st from"../../request.js";import it from"../../core/Error.js";import{isNumericField as rt}from"../../layers/support/fieldUtils.js";import{e as ot}from"../../chunks/executeQueryJSON.js";import nt from"../../rest/support/Query.js";import at from"../../rest/support/RelationshipQuery.js";import lt from"../../rest/support/StatisticDefinition.js";import{i as pt}from"../../chunks/shared2.js";import ut from"../../layers/FeatureLayer.js";import{g as ct}from"../../chunks/globalCss.js";import{F as mt}from"../../chunks/FeatureRelationshipViewModel.js";import{F as dt}from"../../chunks/FeatureUtilityNetworkAssociationsViewModel.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/Lifecycle.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../config.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/events.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/Warning.js";import"../../core/JSONSupport.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../popup/content.js";import"../../popup/support/AttachmentsOrderByInfo.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils2.js";import"../../chunks/mathUtils.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/jsonUtils.js";import"../../core/sql.js";import"../../chunks/guards.js";import"../../geometry/support/jsonUtils.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/unitUtils.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../core/urlUtils.js";import"../../kernel.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils2.js";import"../../chunks/createFeatureId.js";import"../../chunks/typeUtils.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils5.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils6.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/vec3f64.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../chunks/lineMarkers.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/Font.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../rest/query/support/AttachmentInfo.js";import"../../rest/support/AttachmentQuery.js";import"../../chunks/number2.js";import"../../chunks/layerUtils.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/utils14.js";import"../../chunks/basemapUtils.js";import"../../chunks/utils2.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../chunks/basemapDefinitions.js";import"../../chunks/messages.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/utils10.js";import"../../chunks/query.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils11.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/memoryEstimations.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/TimeOnly.js";import"../../chunks/enum.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/Element.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../chunks/Input.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils7.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/formUtils.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../form/elements/UtilityNetworkAssociationsElement.js";import"../../layers/Layer.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../intl.js";import"../../chunks/substitute.js";import"../../chunks/editsZScale.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils2.js";import"../../chunks/parser.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../layers/mixins/DisplayFilteredLayer.js";import"../../layers/support/DisplayFilterInfo.js";import"../../chunks/scaleUtils.js";import"../../layers/support/DisplayFilter.js";import"../../chunks/uuid.js";import"../../chunks/displayFilterUtils.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/commonProperties2.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../rest/support/NormalizationBinParametersMixin.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../chunks/infoFor3D.js";import"../../layers/support/Subtype.js";import"../../chunks/portalItemUtils.js";import"../../chunks/projectionUtils.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectXYZToVector.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/typeUtils3.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/support/ClassBreakInfo.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/DictionaryScriptEvaluator.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/ArcadeExpression.js";import"../../chunks/utils3.js";import"../../chunks/defaultCIMValues.js";import"../../chunks/enums2.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../renderers/PieChartRenderer.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/support/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/mixins/TrackableLayer.js";import"../../layers/support/TrackInfo.js";import"../../layers/support/TrackPartInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/TitleCreator.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/interfaces.js";import"../../chunks/featureFormUtils.js";import"../../chunks/dateUtils.js";import"../../chunks/formUtils2.js";import"../../chunks/ReactiveMap.js";import"../../rest/networks/support/NetworkElement.js";import"../../chunks/getFeatureTitle.js";let ht=class extends T{constructor(t){super(t),this.description=null,this.title=null}};t([g()],ht.prototype,"description",void 0),t([g()],ht.prototype,"title",void 0),ht=t([k("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],ht);let ft=class extends s{constructor(t){super(t),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.addHandles(h((()=>this.creator),(t=>{this._destroyContent(),this._createContent(t)}),f))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:t,graphic:e,destroyer:s}=this;t&&e&&(A({type:"content",value:s,event:{graphic:e}}),this._set("created",null))}async _createContent(t){const e=this.graphic;if(!e||!t)return;const s=A({type:"content",value:t,event:{graphic:e}});this._loadingPromise=s,this.notifyChange("state");const i=await s;s===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",i))}};t([g({readOnly:!0})],ft.prototype,"created",void 0),t([g()],ft.prototype,"creator",void 0),t([g()],ft.prototype,"destroyer",void 0),t([g({type:e})],ft.prototype,"graphic",void 0),t([g({readOnly:!0})],ft.prototype,"state",null),ft=t([k("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],ft);let yt=class extends s{constructor(t){super(t),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:t,fieldInfos:e}=this,s=[];return e?.forEach((e=>{if(e.hasOwnProperty("visible")&&!e.visible)return;const i=e.clone();i.label=M(i,t),s.push(i)})),s}};t([g()],yt.prototype,"attributes",void 0),t([g({type:[Y]})],yt.prototype,"expressionInfos",void 0),t([g()],yt.prototype,"description",void 0),t([g({type:[tt]})],yt.prototype,"fieldInfos",void 0),t([g({readOnly:!0})],yt.prototype,"formattedFieldInfos",null),t([g()],yt.prototype,"title",void 0),yt=t([k("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],yt);const jt=()=>l.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),bt=new Map;function gt(t){if(!F(t))return null;const[e,s]=t.split("/").slice(1);return{layerId:e,fieldName:s}}const vt={chartAnimation:!0};let kt=class extends s{constructor(t){super(t),this.abilities={...vt},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(t){return{...vt,...t}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,s=(t+e)%e;this.activeMediaInfoIndex=s}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,s=e+t;this._setContentElementMedia(s)}_formatMediaInfos(){const{mediaInfos:t,layer:e}=this,s=this.attributes??{},i=this.formattedAttributes??{},o=this.expressionAttributes??{},n=this.fieldInfoMap??new Map;return t?.map((t=>{const r=t?.clone();if(!r)return null;if(r.title=C({attributes:s,fieldInfoMap:n,globalAttributes:i,expressionAttributes:o,layer:e,text:r.title}),r.caption=C({attributes:s,fieldInfoMap:n,globalAttributes:i,expressionAttributes:o,layer:e,text:r.caption}),r.altText=C({attributes:s,fieldInfoMap:n,globalAttributes:i,expressionAttributes:o,layer:e,text:r.altText}),"image"===r.type){if(!r.value)return;return this._setImageValue({value:r.value,formattedAttributes:i,layer:e}),r.value.sourceURL?r:void 0}if("pie-chart"===r.type||"line-chart"===r.type||"column-chart"===r.type||"bar-chart"===r.type){if(!r.value)return;return this._setChartValue({value:r.value,chartType:r.type,attributes:s,formattedAttributes:i,layer:e,expressionAttributes:o}),r}return null})).filter(r)??[]}_setImageValue(t){const e=this.fieldInfoMap??new Map,{value:s,formattedAttributes:i,layer:r}=t,{linkURL:o,sourceURL:n}=s;if(n){const t=E(n,r);s.sourceURL=S({formattedAttributes:i,template:t,fieldInfoMap:e})}if(o){const t=E(o,r);s.linkURL=S({formattedAttributes:i,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:s,formattedAttributes:i,chartType:r,layer:o,expressionAttributes:n}=t,{popupTemplate:a,relatedInfos:l}=this,{fields:p,normalizeField:u}=e,c=o;if(e.fields=V(p,c),u&&(e.normalizeField=R(u,c)),!p.some((t=>!!(null!=i[t]||F(t)&&l?.size))))return;const m=a?.fieldInfos??[];p.forEach(((t,o)=>{const a=e.colors?.[o];if(F(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:m,fieldName:t,formattedAttributes:i,chartType:r,value:e,color:a})]);const l=this._getChartOption({value:e,attributes:s,chartType:r,formattedAttributes:i,expressionAttributes:n,fieldName:t,fieldInfos:m,color:a});e.series.push(l)}))}_getRelatedChartInfos(t){const{fieldInfos:e,fieldName:s,formattedAttributes:i,chartType:r,value:o,color:n}=t,a=[],l=gt(s),p=l&&this.relatedInfos?.get(l.layerId.toString());if(!p)return a;const{relatedFeatures:u,relation:c}=p;if(!c||!u)return a;const{cardinality:m}=c;return u.forEach((t=>{const{attributes:p}=t;p&&Object.keys(p).forEach((t=>{t===l.fieldName&&a.push(this._getChartOption({value:o,attributes:p,formattedAttributes:i,fieldName:s,chartType:r,relatedFieldName:t,hasMultipleRelatedFeatures:u?.length>1,fieldInfos:e,color:n}))}))})),"one-to-many"===m||"many-to-many"===m?a:[a[0]]}_getTooltip({label:t,value:e,chartType:s}){return"pie-chart"===s?`${t}`:`${t}: ${e}`}_getChartOption(t){const{value:e,attributes:s,formattedAttributes:i,expressionAttributes:r,fieldName:o,relatedFieldName:n,fieldInfos:a,chartType:l,hasMultipleRelatedFeatures:p,color:u}=t,c=this.layer,m=this.fieldInfoMap??new Map,{normalizeField:d,tooltipField:h}=e,f=d?F(d)?s[gt(d).fieldName]:s[d]:null,y=U(o)&&r&&void 0!==r[o]?r[o]:n&&void 0!==s[n]?s[n]:void 0!==s[o]?s[o]:i[o],j=void 0===y?null:y&&f?y/f:y,b=new et({fieldName:o,color:u,value:"number"==typeof j?j:Number(j)});if(F(o)){const t=m.get(o.toLowerCase()),e=h&&m.get(h.toLowerCase()),r=t?.fieldName??o,a=p&&h?gt(h).fieldName:e?.fieldName??h,u=p&&a?s[a]:i[a]??t?.label??t?.fieldName??n,c=p&&n?s[n]:i[r];return b.tooltip=this._getTooltip({label:u,value:c,chartType:l}),b}const g=L(a,o),v=R(o,c),k=h&&void 0!==i[h]?i[h]:M(g||new tt({fieldName:v}),this.popupTemplate?.expressionInfos),I=i[v];return b.tooltip=this._getTooltip({label:k,value:I,chartType:l}),b}};t([g()],kt.prototype,"abilities",void 0),t([v("abilities")],kt.prototype,"castAbilities",null),t([g()],kt.prototype,"activeMediaInfoIndex",void 0),t([g({readOnly:!0})],kt.prototype,"activeMediaInfo",null),t([g()],kt.prototype,"attributes",void 0),t([g()],kt.prototype,"description",void 0),t([g()],kt.prototype,"fieldInfoMap",void 0),t([g()],kt.prototype,"formattedAttributes",void 0),t([g()],kt.prototype,"expressionAttributes",void 0),t([g({readOnly:!0})],kt.prototype,"formattedMediaInfos",null),t([g()],kt.prototype,"isAggregate",void 0),t([g()],kt.prototype,"layer",void 0),t([g({readOnly:!0})],kt.prototype,"formattedMediaInfoCount",null),t([g()],kt.prototype,"mediaInfos",void 0),t([g()],kt.prototype,"popupTemplate",void 0),t([g()],kt.prototype,"relatedInfos",void 0),t([g()],kt.prototype,"title",void 0),kt=t([k("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],kt);const It=()=>l.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");async function _t(){const[t,e]=await Promise.all([import("../../arcade.js"),import("../../chunks/arcade.js").then((t=>t.I))]);return{executor:t,syntaxUtils:e}}function wt(t){return{scale:t?.scale,timeProperties:{currentStart:t?.timeExtent?.start,currentEnd:t?.timeExtent?.end,startIncluded:!0,endIncluded:!0}}}function xt(t){return{$voxel:t}}function Tt(t,e,s,i){const r=(t.sourceLayer||t.layer)??void 0;return{$feature:t,$layer:null!=r&&pt(r)?r:"scene"===r?.type&&null!=r.associatedLayer?r.associatedLayer:void 0,$map:e,$datastore:r?.url,$userInput:s,$graph:"knowledge-graph-sublayer"===r?.type?r?.parentCompositeLayer?.knowledgeGraph:void 0,$view:wt(i)}}async function At({expressionInfo:t,arcade:{executor:e,syntaxUtils:s},graphic:i}){const r=t?.expression;if(!r)return null;const o=function(t){const e="esri.views.3d.layers.VoxelGraphic"===t.declaredClass;return t.isAggregate?"popup-feature-reduction":e?"popup-voxel":"popup"}(i),n=e.createArcadeProfile(o);let a;try{a=await e.createArcadeExecutor(r,n)}catch(e){return It().error("arcade-executor-error",{error:e,expressionInfo:t}),null}const l=new Set;return a.variablesUsed.includes("$view")&&(s.scriptUsesViewProperties(a.syntaxTree,["scale"])&&l.add("view-scale"),s.scriptUsesViewProperties(a.syntaxTree,["timeProperties"])&&l.add("view-time-extent")),{dependencies:l,async evaluate({graphic:e,interceptor:s,location:i,map:r,options:n,spatialReference:l,view:p}){const u=await async function(t,{graphic:e,map:s,location:i,view:r,options:o,interceptor:n,arcadeExecutor:a}){switch(t){case"popup":return{vars:Tt(e,s,i,r),[Symbol.dispose](){}};case"popup-feature-reduction":{const t=new Set(a.variablesUsed);return await async function(t,e,s,i,r){let o=null;if(r.has("$aggregatedfeatures")){const r=await async function({graphic:t,view:e,options:s}){const{isAggregate:i}=t,r=t.layer??t.sourceLayer;if(!i||!r||"2d"!==e?.type)return[];const o=await e.whenLayerView(r);if(!function(t){return"createQuery"in t&&"queryFeatures"in t}(o))return[];const n=o.createQuery(),a=t.getObjectId();n.aggregateIds=null!=a?[a]:[];const{features:l}=await o.queryFeatures(n,s);return l}({graphic:t,view:e,options:s}),n=t.sourceLayer||t.layer;o=function({layer:t,aggregatedFeatures:e,interceptor:s}){const{fields:i,objectIdField:r,geometryType:o,spatialReference:n,displayField:a}=t;return new ut({fields:i,objectIdField:r,geometryType:o,spatialReference:n,displayField:a,interceptor:s,..."feature"===t.type?{templates:t.templates,typeIdField:t.typeIdField,types:t.types}:null,source:e})}({layer:n,aggregatedFeatures:r,interceptor:i})}return{vars:{$feature:t,$aggregatedFeatures:o,$view:wt(e)},[Symbol.dispose]:()=>o?.[Symbol.dispose]()}}(e,r,o,n,t)}case"popup-voxel":return{vars:xt(e),[Symbol.dispose](){}};default:throw new Error(`Unexpected profile name ${t}`)}}(o,{graphic:e,map:r,location:i,view:p,options:n,interceptor:s,arcadeExecutor:a}),c={abortSignal:n?.signal??void 0,interceptor:s??void 0,rawOutput:!0,spatialReference:l??void 0,timeZone:p?.timeZone,console(...t){It().info(...t)}};try{return await a.executeAsync(u.vars,c)}catch(s){if(n?.signal?.aborted)return;return void It().error("arcade-execution-error",{error:s,graphic:e,expressionInfo:t})}finally{u[Symbol.dispose]()}}}}async function Mt(t,e){if(!t?.length)return{dependencies:new Set,expressions:new Map};const s=await _t(),i=new Set,r=new Map;for(const o of t){const t=await At({expressionInfo:o,arcade:s,graphic:e});r.set(`expression/${o.name}`,t),t?.dependencies.forEach((t=>i.add(t)))}return{dependencies:i,expressions:r}}let Ft=class extends s{constructor(t){super(t),this._compileTask=null,this._evaluateTask=null,this.expressionInfo=null,this.graphic=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._createVM=()=>{const t=this.contentElement?.type;this.contentElementViewModel?.destroy();const e="fields"===t?new yt:"media"===t?new kt:"text"===t?new ft:null;this._set("contentElementViewModel",e)},this._compileThrottled=b(this._startCompile,(()=>this.notifyChange("state")),1,this),this._evaluateThrottled=b(this._startEvaluate,(()=>this.notifyChange("state")),1,this),this.addHandles([h((()=>[this.expressionInfo,this.graphic]),(()=>this._compileThrottled()),f),h((()=>[this.contentElement]),(()=>this._createVM()),f),y((()=>{if(!this._compileTask?.finished)return null;const t=this._compileTask.value,e=t?.dependencies;return[t,this.spatialReference,this.map,this.view,e?.has("view-scale")?this.view?.scale:null,e?.has("view-time-extent")?this.view?.timeExtent?.start:null,e?.has("view-time-extent")?this.view?.timeExtent?.end:null]}),(([t])=>this._evaluateThrottled(t)))])}initialize(){this.addHandles([this._compileThrottled,this._evaluateThrottled])}destroy(){this._compileTask=p(this._compileTask),this._evaluateTask=p(this._evaluateTask),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null)}get contentElement(){return this._evaluateTask?.value}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get state(){const{contentElement:t,contentElementViewModel:e}=this;return this._compileThrottled.hasPendingUpdates()||this._evaluateThrottled.hasPendingUpdates()||!this._compileTask?.finished||!this._evaluateTask?.finished?"loading":t||e?"ready":"disabled"}get map(){return this.view?.map??null}set map(t){this._override("map",t)}_startCompile(){this._evaluateTask=p(this._evaluateTask),this._compileTask=p(this._compileTask),this._compileTask=o((async t=>{const{expressionInfo:e,graphic:s}=this;if(!e||!s)return null;const i=await _t();m(t);const r=await At({expressionInfo:e,arcade:i,graphic:s});return m(t),r}))}_startEvaluate(t){this._evaluateTask=p(this._evaluateTask),this._evaluateTask=o((async e=>{const{graphic:s}=this;if(!t||!s)return null;const{interceptor:i,spatialReference:r,map:o,location:n,view:a}=this,l=await t.evaluate({graphic:s,interceptor:i,location:n,map:o,options:{signal:e},spatialReference:r,view:a});m(e);const p=l;if(!p||"esri.arcade.Dictionary"!==p.declaredClass)return null;const u=await p.castAsJsonAsync(e);m(e);const c=u?.type,d="media"===c?K.fromJSON(u):"text"===c?w.fromJSON(u):"fields"===c?W.fromJSON(u):null;return"media"===d.type&&!d.mediaInfos||"fields"===d.type&&!d.fieldInfos||"text"===d.type&&!d.text?null:d}))}};t([g()],Ft.prototype,"_compileTask",void 0),t([g()],Ft.prototype,"_evaluateTask",void 0),t([g({type:X})],Ft.prototype,"expressionInfo",void 0),t([g({type:e})],Ft.prototype,"graphic",void 0),t([g({readOnly:!0})],Ft.prototype,"contentElement",null),t([g({readOnly:!0})],Ft.prototype,"contentElementViewModel",void 0),t([g()],Ft.prototype,"interceptor",void 0),t([g({type:I})],Ft.prototype,"location",void 0),t([g()],Ft.prototype,"spatialReference",null),t([g({readOnly:!0})],Ft.prototype,"state",null),t([g()],Ft.prototype,"map",null),t([g()],Ft.prototype,"view",void 0),Ft=t([k("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],Ft);class Ct{constructor(t,e){this.preLayerQueryCallback=t,this.preRequestCallback=e,this.preLayerQueryCallback||(this.preLayerQueryCallback=t=>{}),this.preRequestCallback||(this.preLayerQueryCallback=t=>{})}}var Et;const St="content-view-models",Vt="relationship-view-models",Rt={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0,utilityNetworkAssociationsContent:!0};let Ut=class extends(a.IdentifiableMixin(s)){static{Et=this}constructor(t){super(t),this._error=null,this._graphicChangedTask=null,this._evaluateExpressionAttributesTask=null,this._associationVMAbortController=null,this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...Rt},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.location=null,this.relatedInfos=new Map,this.title="",this.view=null,this._graphicChangedThrottled=b(this._graphicChanged,(()=>this.notifyChange("waitingForContent")),1,this),this._isAllowedContentType=t=>{const{abilities:e}=this;return"attachments"===t.type&&!!e.attachmentsContent||"custom"===t.type&&!!e.customContent||"fields"===t.type&&!!e.fieldsContent||"media"===t.type&&!!e.mediaContent||"text"===t.type&&!!e.textContent||"expression"===t.type&&!!e.expressionContent||"relationship"===t.type&&!!e.relationshipContent||"utility-network-associations"===t.type&&!!e.utilityNetworkAssociationsContent},this._evaluateExpressionAttributesThrottled=b(this._evaluateExpressionAttributes,(()=>this.notifyChange("waitingForContent")),1,this),this.addHandles([h((()=>[this.graphic,this._effectivePopupTemplate,this.abilities,this.timeZone]),(()=>this._graphicChangedThrottled()),f),y((()=>{if(!this._graphicChangedTask?.finished||null==this._graphicChangedTask.value)return null;const t=this._graphicChangedTask.value,e=t?.expressionInfos?.dependencies;return[t,e?.has("view-scale")?this.view?.scale:null,e?.has("view-time-extent")?this.view?.timeExtent?.start:null,e?.has("view-time-extent")?this.view?.timeExtent?.end:null]}),(([t])=>this._evaluateExpressionAttributesThrottled(t)))])}initialize(){this.addHandles([this._graphicChangedThrottled,this._evaluateExpressionAttributesThrottled])}destroy(){this._clear(),this._graphicChangedTask=p(this._graphicChangedTask),this._evaluateExpressionAttributesTask=p(this._evaluateExpressionAttributesTask),this._error=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}static{this.interceptor=new Ct(D,N)}get _effectivePopupTemplate(){return null!=this.graphic?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return $(B(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return Z(this.graphic)}castAbilities(t){return{...Rt,...t}}get isFeatureFromTable(){return this._sourceLayer?.isTable||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(t){this._set("graphic",t?.clone()??null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get timeZone(){return this.view?.timeZone??x}set timeZone(t){this._overrideIfSome("timeZone",t)}get map(){return this.view?.map||null}set map(t){this._override("map",t)}get waitingForContent(){const{_graphicChangedThrottled:t,_evaluateExpressionAttributesThrottled:e,_graphicChangedTask:s,_evaluateExpressionAttributesTask:i,_associationVMAbortController:r}=this;return t.hasPendingUpdates()||e.hasPendingUpdates()||null!=s&&!s.finished||null!=i&&!i.finished||!!r}setActiveMedia(t,e){const s=this.contentViewModels[t];s instanceof kt&&s.setActiveMedia(e)}nextMedia(t){const e=this.contentViewModels[t];e instanceof kt&&e.next()}previousMedia(t){const e=this.contentViewModels[t];e instanceof kt&&e.previous()}async updateGeometry(){const{graphic:t,spatialReference:e,_sourceLayer:s}=this;await(s?.load());const i=s?.objectIdField;if(!i||!t||!s)return;const r=t?.attributes?.[i];if(null==r)return;const o=[r];if(!t.geometry){const i=await q({layer:s,graphic:t,outFields:[],objectIds:o,returnGeometry:!0,spatialReference:e}),r=i?.geometry;r&&(t.geometry=r)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}_graphicChanged(){this._evaluateExpressionAttributesTask=p(this._evaluateExpressionAttributesTask),this._graphicChangedTask=p(this._graphicChangedTask),this._graphicChangedTask=o((async t=>{this._error=null,this._clear();const{graphic:e}=this;try{if(!e)return null;const{_sourceLayer:s,_effectivePopupTemplate:i}=this,r=this.spatialReference;await G({graphic:e,popupTemplate:i,layer:s,spatialReference:r},{signal:t});const[{value:o},{value:n}]=await c([this._getContent(),this._getTitle()]),[,{value:a}]=await c([this._checkForRelatedFeatures({signal:t}),Mt(i?.expressionInfos,e)]);return{expressionInfos:a,content:o,title:n}}catch(t){throw d(t)||(this._error=t,l.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:t,graphic:e,popupTemplate:this._effectivePopupTemplate})),t}}))}_compileContentElement(t,e){return"attachments"===t.type?this._compileAttachments(t,e):"custom"===t.type?this._compileCustom(t,e):"fields"===t.type?this._compileFields(t,e):"media"===t.type?this._compileMedia(t,e):"text"===t.type?this._compileText(t,e):"expression"===t.type?this._compileExpression(t,e):"relationship"===t.type?this._compileRelationship(t,e):"utility-network-associations"===t.type?this._compileUtilityNetworkAssociation(t,e):void 0}_compileContent(t){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(t)?t.filter(this._isAllowedContentType).map(((t,e)=>this._compileContentElement(t,e))).filter(r):"string"==typeof t?this._compileText(new w({text:t}),0).text:t}_destroyContentViewModels(){this.removeHandles(Vt),this.removeHandles(St),this.contentViewModels.forEach((t=>t&&!t.destroyed&&t.destroy())),this._set("contentViewModels",[])}_matchesFeature(t,e){const s=t?.graphic?.getObjectId(),i=e?.getObjectId();return null!=s&&null!=i&&s===i}_setRelatedFeaturesViewModels({relatedFeatureViewModels:t,relatedFeatures:e,map:s}){const{view:i,spatialReference:r,timeZone:o}=this;e?.filter(Boolean).forEach((e=>{t.some((t=>this._matchesFeature(t,e)))||t.add(new Et({abilities:{relationshipContent:!1},map:s,view:i,spatialReference:r,timeZone:o,graphic:e}))})),t.forEach((s=>{const i=e?.find((t=>this._matchesFeature(s,t)));i||t.remove(s)}))}_setExpressionContentVM(t,e){const s=this.formattedAttributes,{contentElement:i,contentElementViewModel:r}=t,o=i?.type;r&&o&&("fields"===o&&(this._createFieldsFormattedAttributes({contentElement:i,contentElementIndex:e,formattedAttributes:s}),r.set(this._createFieldsVMParams(i,e))),"media"===o&&(this._createMediaFormattedAttributes({contentElement:i,contentElementIndex:e,formattedAttributes:s}),r.set(this._createMediaVMParams(i,e))),"text"===o&&r.set(this._createTextVMParams(i)))}_compileRelationship(t,e){const{displayCount:s,orderByFields:i,relationshipId:r,title:o,description:n}=t,{_sourceLayer:a,graphic:l,map:p}=this;if(!z(a))return;const u=new mt({displayCount:s,graphic:l,orderByFields:i,relationshipId:r,layer:a,map:p,...this._compileTitleAndDesc({title:o,description:n})});return this.contentViewModels[e]=u,this.addHandles(j((()=>u.relatedFeatures),"change",(()=>this._setRelatedFeaturesViewModels(u))),Vt),t}_matchesGlobalFeature(t,e){const s=t?.association.globalId,i=e?.association.globalId;return null!=s&&null!=i&&s===i}async _setUpUtilityNetworkAssociationsViewModels(t,e,s){const{view:i,spatialReference:r,timeZone:o}=this;t.forEach(((s,i)=>{const r=e.get(i);r?s.forEach((e=>{r.find((t=>this._matchesGlobalFeature(e,t)))||(s.remove(e),0===s.length&&t.delete(i))})):(s.removeAll(),t.delete(i))})),e.forEach(((e,a)=>{const l=t.get(a)||new n;e?.filter(Boolean).forEach((t=>{if(!l.some((e=>this._matchesGlobalFeature(e,t)))){const{association:e,feature:n,terminalName:a,title:p}=t;l.add({title:p,association:e,featureViewModel:new Et({abilities:{utilityNetworkAssociationsContent:!1},map:s,view:i,spatialReference:r,timeZone:o,graphic:n}),terminalName:a})}})),t.set(a,l)})),this._sortListObjectsByTitle(t)}async _sortListObjectsByTitle(t){for(const e of t.values())e.sort(this._compareByFeatureTitle)}_compareByFeatureTitle(t,e){return t.title.localeCompare(e.title,void 0,{numeric:!0})}_compileUtilityNetworkAssociation(t,e){const{displayCount:s,title:i,description:r,associationTypes:o}=t,{_sourceLayer:n,graphic:a,map:l}=this;if(!Q(n))return;const p=new dt({graphic:a,displayCount:s,associationTypes:o,layer:n,map:l,...this._compileTitleAndDesc({title:i,description:r})});return this.contentViewModels[e]=p,this.addHandles([h((()=>p.associationFeatures.values()),(()=>this._setUpUtilityNetworkAssociationsViewModels(p.associationViewModels,p.associationFeatures,p.map)))],"association-view-models"),t}_compileExpression(t,e){const{expressionInfo:s}=t,{graphic:i,map:r,spatialReference:o,view:n,location:a}=this,l=new Ft({expressionInfo:s,graphic:i,interceptor:Et.interceptor,map:r,spatialReference:o,view:n,location:a});return this.contentViewModels[e]=l,this.addHandles(h((()=>l.contentElementViewModel),(()=>this._setExpressionContentVM(l,e)),f),St),t}_compileAttachments(t,e){const{graphic:s}=this,{description:i,title:r,orderByFields:o}=t;return this.contentViewModels[e]=new ht({graphic:s,orderByFields:o,...this._compileTitleAndDesc({title:r,description:i})}),t}_compileCustom(t,e){const{graphic:s}=this,{creator:i,destroyer:r}=t;return this.contentViewModels[e]=new ft({graphic:s,creator:i,destroyer:r}),t}_compileTitleAndDesc({title:t,description:e}){const{_fieldInfoMap:s,_sourceLayer:i,graphic:r,formattedAttributes:o}=this,n=r?.attributes,a=this._expressionAttributes,l=o.global;return{title:C({attributes:n,fieldInfoMap:s,globalAttributes:l,expressionAttributes:a,layer:i,text:t}),description:C({attributes:n,fieldInfoMap:s,globalAttributes:l,expressionAttributes:a,layer:i,text:e})}}_createFieldsVMParams(t,e){const s=this._effectivePopupTemplate,i=this.formattedAttributes,r={...i?.global,...i?.content[e]},o=t?.fieldInfos||s?.fieldInfos,n=o?.filter((({fieldName:t})=>!!t&&(U(t)||F(t)||r.hasOwnProperty(t)))),a=s?.expressionInfos,{description:l,title:p}=t;return{attributes:r,expressionInfos:a,fieldInfos:n,...this._compileTitleAndDesc({title:p,description:l})}}_compileFields(t,e){const s=t.clone(),i=new yt(this._createFieldsVMParams(t,e));return this.contentViewModels[e]=i,s.fieldInfos=i.formattedFieldInfos.slice(),s}_createMediaVMParams(t,e){const{abilities:s,graphic:i,_fieldInfoMap:r,_effectivePopupTemplate:o,relatedInfos:n,_sourceLayer:a,_expressionAttributes:l}=this,p=this.formattedAttributes,u=i?.attributes??{},{description:c,mediaInfos:m,title:d}=t;return{abilities:{chartAnimation:s.chartAnimation},activeMediaInfoIndex:t.activeMediaInfoIndex||0,attributes:u,isAggregate:i?.isAggregate,layer:a,fieldInfoMap:r,formattedAttributes:{...p?.global,...p?.content[e]},expressionAttributes:l,mediaInfos:m,popupTemplate:o,relatedInfos:n,...this._compileTitleAndDesc({title:d,description:c})}}_compileMedia(t,e){const s=t.clone(),i=new kt(this._createMediaVMParams(t,e));return s.mediaInfos=i.formattedMediaInfos.slice(),this.contentViewModels[e]=i,s}_createTextVMParams(t){const{graphic:e,_fieldInfoMap:s,_sourceLayer:i,_expressionAttributes:r}=this;if(t&&t.text){const o=e?.attributes??{},n=this.formattedAttributes?.global??{};t.text=C({attributes:o,fieldInfoMap:s,globalAttributes:n,expressionAttributes:r,layer:i,text:t.text})}return{graphic:e,creator:t.text}}_compileText(t,e){const s=t.clone();return this.contentViewModels[e]=new ft(this._createTextVMParams(s)),s}_compileLastEditInfo(){const{_effectivePopupTemplate:t,_sourceLayer:e,graphic:s,timeZone:i}=this;if(!t)return;const{lastEditInfoEnabled:r}=t,o=e?.editFieldsInfo;return r&&o?H(o,s?.attributes,i,e):void 0}_compileTitle(t){const{_fieldInfoMap:e,_sourceLayer:s,graphic:i,_expressionAttributes:r}=this,o=i?.attributes??{},n=this.formattedAttributes?.global??{};return C({attributes:o,fieldInfoMap:e,globalAttributes:n,expressionAttributes:r,layer:s,text:t})}async _getTitle(){const{_effectivePopupTemplate:t,graphic:e}=this;return e?A({type:"title",value:t?.title,event:{graphic:e}}):null}async _getContent(){const{_effectivePopupTemplate:t,graphic:e}=this;return e?A({type:"content",value:t?.content,event:{graphic:e}}):null}_evaluateExpressionAttributes({title:t,content:e,expressionInfos:s}){this._evaluateExpressionAttributesTask=p(this._evaluateExpressionAttributesTask),this._evaluateExpressionAttributesTask=o((async i=>{const{graphic:r,map:o,view:n,spatialReference:a,location:p}=this;try{if(!r)return;let l;if(null!=s){const t=[];for(const[e,l]of s.expressions.entries())null!=l?t.push(l.evaluate({graphic:r,interceptor:Et.interceptor,location:p,map:o,options:{signal:i},spatialReference:a,view:n}).then((t=>{return[e,(s=t,"string"==typeof s?P(O(s)):Array.isArray(s)?function(t){return`<ul class="esri-widget__list">${t.map((t=>`<li>${"string"==typeof t?P(O(t)):t}</li>`)).join("")}</ul>`}(s):"esri.arcade.Dictionary"===s?.declaredClass?function(t){const e=t.keys().map((e=>{const s=t.field(e);return`<tr><th>${e}</th><td>${"string"==typeof s?P(O(s)):s}</td></tr>`})).join("");return`<table class="${ct.table}">${e}</table>`}(s):s)];var s})).catch((()=>[e,void 0]))):t.push(Promise.resolve([e,void 0]));l=Object.fromEntries(await Promise.all(t)),m(i)}this._expressionAttributes=l,this._graphicExpressionAttributes={...r.attributes,...l},this._set("formattedAttributes",this._createFormattedAttributes(e)),this._set("title",this._compileTitle(t)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(e)||null)}catch(t){d(t)||(this._error=t,l.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:t,graphic:r,popupTemplate:this._effectivePopupTemplate}))}}))}_createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:s}){const{_effectivePopupTemplate:i,graphic:r,relatedInfos:o,_sourceLayer:n,_fieldInfoMap:a,_graphicExpressionAttributes:l,timeZone:p}=this;s.content[e]=J({fieldInfos:i?.fieldInfos,graphic:r,attributes:{...l,...t.attributes},layer:n,fieldInfoMap:a,relatedInfos:o,timeZone:p})}_createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:s}){if(t.fieldInfos){const{graphic:i,relatedInfos:r,_sourceLayer:o,_fieldInfoMap:n,_graphicExpressionAttributes:a,timeZone:l}=this;s.content[e]=J({fieldInfos:t.fieldInfos,graphic:i,attributes:{...a,...t.attributes},layer:o,fieldInfoMap:n,relatedInfos:r,timeZone:l})}}_createFormattedAttributes(t){const{_effectivePopupTemplate:e,graphic:s,relatedInfos:i,_sourceLayer:r,_fieldInfoMap:o,_graphicExpressionAttributes:n,timeZone:a}=this,l=e?.fieldInfos,p={global:J({fieldInfos:l,graphic:s,attributes:n,layer:r,fieldInfoMap:o,relatedInfos:i,timeZone:a}),content:[]};return Array.isArray(t)&&t.forEach(((t,e)=>{"fields"===t.type&&this._createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:p}),"media"===t.type&&this._createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:p})})),p}_checkForRelatedFeatures(t){const{graphic:e,_effectivePopupTemplate:s}=this;return this._queryRelatedInfos(e,B(s),t)}async _queryRelatedInfos(t,e,s){const{relatedInfos:r,_sourceLayer:o}=this;r.clear();const n=null!=o?.associatedLayer?await(o?.associatedLayer.load(s)):o;if(!n||!t)return;const a=e.filter((t=>!!t.fieldName&&F(t.fieldName)));if(!a?.length)return;e.forEach((t=>this._configureRelatedInfo(t,n)));const l=await function({relatedInfos:t,layer:e},s){const i={};return t.forEach(((t,s)=>{const{relation:r}=t;if(!r){const t=new it("editor:relation-required","A relation is required on a layer to retrieve related records.");throw jt().error(t),t}const{relatedTableId:o}=r;if("number"!=typeof o){const t=new it("editor:related-table","A related table ID is required on a layer to retrieve related records.");throw jt().error(t),t}const n=`${e.url}/${o}`,a=bt.get(n),l=a??function(t){return st(t,{query:{f:"json"},signal:void 0})}(n);a||bt.set(n,l),i[s]=l})),u(c(i),s)}({relatedInfos:r,layer:n},s);Object.keys(l).forEach((t=>{const e=r.get(t.toString()),s=l[t]?.value;e&&s&&(e.layerInfo=s.data)}));const p=await function({graphic:t,relatedInfos:e,layer:s},r){const o={};return e.forEach(((e,n)=>{e.layerInfo&&(o[n]=async function(t,e,s,r){const o=s.layerId.toString(),{layerInfo:n,relation:a,relatedFields:l,outStatistics:p,url:u,sourceSpatialReference:m}=e,d=(h=l)?i(h):void 0;var h;const f=function(t){return t?i(t,((t,e)=>JSON.stringify(t.toJSON())===JSON.stringify(e.toJSON()))):void 0}(p);if(!n||!a)return null;const y=function({originRelationship:t,relationships:e,layerId:s}){return e.find((({relatedTableId:e,id:i})=>`${e}`===s&&i===t?.id))??null}({originRelationship:a,relationships:n.relationships,layerId:o});if(y?.relationshipTableId&&y.keyFieldInRelationshipTable){const e=await function(t,e,s,i){const r=new at;return r.outFields=["*"],r.relationshipId="number"==typeof e.id?e.id:parseInt(e.id,10),r.objectIds=[t.attributes[s.objectIdField]],r.gdbVersion=s.gdbVersion??null,r.historicMoment=s.historicMoment??null,s.queryRelatedFeatures?.(r,i)??Promise.resolve({})}(t,y,s,r),i=e[t.attributes[s.objectIdField]];if(!i)return null;const o=i.features.map((t=>t.attributes[n.objectIdField]));if(f?.length&&n.supportsStatistics){const t=new nt;t.where=function(t,e){let s=0;const i=[];for(;s<e.length;)i.push(`${t} IN (${e.slice(s,1e3+s)})`),s+=1e3;return i.join(" OR ")}(n.objectIdField,o),t.outFields=d,t.outStatistics=f,t.sourceSpatialReference=m;const e={features:Promise.resolve(i),statsFeatures:ot(u,t)};return c(e)}}const j=y?.keyField;if(j){const e=rt(function(t,e){if(null!=t){e=e.toLowerCase();for(const s of t)if(s&&s.name.toLowerCase()===e)return s}return null}(n.fields,j)),i=function(t,e){const s=e.toLowerCase();for(const e in t)if(e.toLowerCase()===s)return t[e];return null}(t.attributes,a.keyField),o=e?`${j}=${i}`:`${j}='${i}'`,l=s.historicMoment,p=s.gdbVersion,h=ot(u,new nt({where:o,outFields:d,sourceSpatialReference:m,historicMoment:l,gdbVersion:p}),r),y=f?.length&&n.supportsStatistics?ot(u,new nt({where:o,outFields:d,outStatistics:f,sourceSpatialReference:m}),r):null,b={features:h};return y&&(b.statsFeatures=y),c(b)}return null}(t,e,s,r))})),c(o)}({graphic:t,relatedInfos:r,layer:n},s);Object.keys(p).forEach((t=>{!function(t,e){if(!e)return;if(!t)return;const{features:s,statsFeatures:i}=t,r=s?.value;e.relatedFeatures=r?r.features:[];const o=i?.value;e.relatedStatsFeatures=o?o.features:[]}(p[t]?.value,r.get(t.toString()))}))}_configureRelatedInfo(t,e){const{relatedInfos:s}=this,i=gt(t.fieldName||"");if(!i)return;const{layerId:r,fieldName:o}=i;if(!r)return;const n=s.get(r.toString())||function(t,e){const s=function(t,e){if(!e.relationships)return null;let s=null;const{relationships:i}=e;return i.some((e=>e.id===parseInt(t,10)&&(s=e,!0))),s}(t,e);if(s)return{url:`${e.url}/${s.relatedTableId}`,sourceSpatialReference:e.spatialReference,relation:s,relatedFields:[],outStatistics:[]}}(r,e);n&&(function({relatedInfo:t,fieldName:e,fieldInfo:s}){if(t.relatedFields?.push(e),s.statisticType){const i=new lt({statisticType:s.statisticType,onStatisticField:e,outStatisticFieldName:e});t.outStatistics?.push(i)}}({relatedInfo:n,fieldName:o,fieldInfo:t}),this.relatedInfos.set(r,n))}};t([g()],Ut.prototype,"_error",void 0),t([g()],Ut.prototype,"_graphicChangedTask",void 0),t([g()],Ut.prototype,"_evaluateExpressionAttributesTask",void 0),t([g()],Ut.prototype,"_associationVMAbortController",void 0),t([g({readOnly:!0})],Ut.prototype,"_effectivePopupTemplate",null),t([g({readOnly:!0})],Ut.prototype,"_fieldInfoMap",null),t([g({readOnly:!0})],Ut.prototype,"_sourceLayer",null),t([g()],Ut.prototype,"abilities",void 0),t([v("abilities")],Ut.prototype,"castAbilities",null),t([g({readOnly:!0})],Ut.prototype,"content",void 0),t([g({readOnly:!0})],Ut.prototype,"contentViewModels",void 0),t([g()],Ut.prototype,"description",void 0),t([g({type:Boolean})],Ut.prototype,"defaultPopupTemplateEnabled",void 0),t([g({readOnly:!0})],Ut.prototype,"isFeatureFromTable",null),t([g({readOnly:!0})],Ut.prototype,"state",null),t([g({readOnly:!0})],Ut.prototype,"formattedAttributes",void 0),t([g({type:e,value:null})],Ut.prototype,"graphic",null),t([g({readOnly:!0})],Ut.prototype,"lastEditInfo",void 0),t([g({type:I})],Ut.prototype,"location",void 0),t([g({readOnly:!0})],Ut.prototype,"relatedInfos",void 0),t([g({type:_})],Ut.prototype,"spatialReference",null),t([g()],Ut.prototype,"timeZone",null),t([g({readOnly:!0})],Ut.prototype,"title",void 0),t([g()],Ut.prototype,"map",null),t([g({readOnly:!0})],Ut.prototype,"waitingForContent",null),t([g()],Ut.prototype,"view",void 0),Ut=Et=t([k("esri.widgets.Feature.FeatureViewModel")],Ut);export{ht as F,ft as a,yt as b,kt as c,Ft as d,Ut as default};
