/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Color.js";import i from"../../core/Accessor.js";import{i as s}from"../../core/lang.js";import{c as r}from"../../chunks/asyncUtils.js";import{a as o,d as n}from"../../chunks/maybe.js";import{throwIfAborted as a,after as l}from"../../core/promiseUtils.js";import{watch as u,syncAndInitial as c}from"../../core/reactiveUtils.js";import{c as h,b as p,f as d}from"../../chunks/screenUtils.js";import{c as m,f as _}from"../../chunks/timeUtils.js";import{property as g}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/Logger.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import{c as v}from"../../chunks/vec3f64.js";import{l as y}from"../../chunks/earthUtils.js";import{c as w,S as T}from"../../chunks/ShadowCastVisualizeTechniqueConfiguration.js";import j from"./DiscreteOptions.js";import k,{D}from"./DurationOptions.js";import{m as P}from"../../chunks/handleUtils.js";import{t as b}from"../../chunks/throttle.js";import O from"./ThresholdOptions.js";import{b as C}from"../../chunks/traversalUtils.js";import"../../chunks/colorUtils2.js";import"../../chunks/mathUtils.js";import"../../chunks/ensureType.js";import"../../chunks/MapUtils.js";import"../../config.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/Lifecycle.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/Error.js";import"../../chunks/events.js";import"../../chunks/SetUtils.js";import"../../chunks/SimpleTrackingTarget.js";import"../../chunks/date.js";import"../../chunks/jsonMap.js";import"../../chunks/locale.js";import"../../chunks/constants.js";import"../../chunks/datetime.js";import"../../chunks/Warning.js";import"../../chunks/unitUtils.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/jsonUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../geometry/SpatialReference.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../chunks/mat4f64.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../chunks/vec3.js";import"../../chunks/ViewingMode.js";import"../../chunks/SunCalc.js";import"../../chunks/mathUtils2.js";import"../../chunks/ShaderTechniqueConfiguration.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/collectionUtils.js";var U,S;!function(t){t.Disabled="disabled",t.Ready="ready"}(U||(U={})),function(t){t.PointerMove="pointer-move",t.Main="main"}(S||(S={}));let z=class extends i{constructor(t){super(t),this._screenPoint=null,this._accumulatedShadowTime=null,this._shadowTimeTask=null,this._updateAccumulatedShadowTime=(t,e)=>{this._shadowTimeTask=o(this._shadowTimeTask),this._shadowTimeTask=r((async i=>{const{results:s,ground:r}=await t.hitTest(e);if(a(i),0===s.length&&!r.mapPoint)return void(this._accumulatedShadowTime=null);const o=await this.getDuration(e,i);this._accumulatedShadowTime=o}))},this._throttledUpdateAccumulatedShadowTime=b(this._updateAccumulatedShadowTime,300)}initialize(){this.addHandles(u((()=>({enabled:this.enabled,view:this.view})),(({enabled:t,view:e})=>{t&&null!=e?this._startTracking(e):this._stopTracking()}),c))}get screenPoint(){return this.enabled?this._screenPoint:null}get accumulatedShadowTime(){return this.enabled?this._accumulatedShadowTime:null}get testData(){}_startTracking(t){if(this.hasHandles(S.Main))return;const e=()=>{this.hasHandles(S.PointerMove)||this.addHandles(t.on("pointer-move",(e=>{const i=h(e.x,e.y);this._screenPoint=i,this._throttledUpdateAccumulatedShadowTime(t,i)})),S.PointerMove)},i=()=>{this.removeHandles(S.PointerMove),this._screenPoint=null,this._accumulatedShadowTime=null};this.addHandles([this._throttledUpdateAccumulatedShadowTime,t.on("pointer-enter",e),t.on("pointer-leave",i),t.on("pointer-down",i),t.on("pointer-drag",i),t.on("pointer-up",e),t.on("click",(e=>{const i=h(e.x,e.y);this._screenPoint=i,this._updateAccumulatedShadowTime(t,i)})),P((()=>{this._shadowTimeTask=o(this._shadowTimeTask)}))],S.Main),e()}_stopTracking(){this.removeHandles(S.Main)}};var V;t([g()],z.prototype,"getDuration",void 0),t([g()],z.prototype,"view",void 0),t([g()],z.prototype,"enabled",void 0),t([g()],z.prototype,"screenPoint",null),t([g()],z.prototype,"accumulatedShadowTime",null),t([g()],z.prototype,"_screenPoint",void 0),t([g()],z.prototype,"_accumulatedShadowTime",void 0),t([g()],z.prototype,"_shadowTimeTask",void 0),z=t([f("esri.widgets.ShadowCast.ShadowTooltipViewModel")],z),function(t){t.Threshold="threshold",t.Duration="duration",t.Discrete="discrete"}(V||(V={})),V.Threshold,V.Duration,V.Discrete;const x=[],A=v(),M=[],E=m(1,"hours","milliseconds");let R=class extends i{constructor(t){super(t),this.view=null,this.tooltip=new z({getDuration:(t,e)=>this.getDuration(t,e)}),this.startTimeOfDay=m(10,"hours","milliseconds"),this.endTimeOfDay=m(16,"hours","milliseconds"),this.visualizationType=V.Threshold,this.thresholdOptions=new O,this.durationOptions=new k,this.discreteOptions=new j,this._running=!0,this._stopPreviewingTask=null,this._forcePreview=!1,this._autoRestoreForcePreviewEnabled=!0,this._utcOffset=null,this.date=new Date}initialize(){this.addHandles([u((()=>({view:this.view,tooltipEnabled:this._tooltipEnabled})),(({view:t,tooltipEnabled:e})=>{this.tooltip.view=t,this.tooltip.enabled=e}),c),u((()=>this._forcePreviewDependencies),(()=>{o(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=r((async t=>{await l(500,t),a(t),this._forcePreview=!1})))}),c),u((()=>({renderer:this.renderer,parameters:this._visualizationParameters})),(t=>N(t.renderer,t.parameters)),c),u((()=>({renderer:this.renderer,lightDirections:this._lightDirections,lightDirectionsContext:this._lightDirectionsContext})),(t=>N(t.renderer,{lightDirections:t.lightDirections,lightDirectionsContext:t.lightDirectionsContext})),c),u((()=>({renderer:this.renderer,parameters:{enabled:this._running}})),(t=>N(t.renderer,t.parameters)),c),u((()=>({renderer:this.renderer,parameters:{previewing:this._previewing}})),(t=>N(t.renderer,t.parameters)),c)])}destroy(){this.stop(),N(this.renderer,{enabled:!1}),n(this.tooltip)}get state(){return null!=this.view&&this.view.ready&&null!=this._referencePosition?U.Ready:U.Disabled}set date(t){const e=new Date(t);e.setHours(0,0,0,0),this._set("date",e)}get utcOffset(){return this._utcOffset??this._utcOffsetAuto}set utcOffset(t){this._utcOffset=t}get testData(){}get _previewing(){const{view:t}=this;if(null==t?.allLayerViews)return!0;const{stationary:e,allLayerViews:i,graphicsView:s}=t;return this._forcePreview||!e||i.some((t=>H(t)&&t.updating))||!s?.suspended&&!!s?.updating}get _utcOffsetAuto(){const t=this._referencePosition;return null!=t?y(t[0],!1):0}get _dateUTCOffset(){let t=this.date;return t=_(t,-t.getTimezoneOffset(),"minutes"),t=_(t,-this.utcOffset,"hours"),t}get _startDateTimeUTC(){return _(this._dateUTCOffset,this.startTimeOfDay)}get _endDateTimeUTC(){return _(this._dateUTCOffset,this.endTimeOfDay)}get _referencePosition(){return this.view?.environmentManager?.referencePositionGeographic}get _durationInterval(){return this._duration>0?Math.floor(this._duration/254):255}get _interval(){const t=this._durationInterval;switch(this.visualizationType){case V.Threshold:case V.Duration:return t;case V.Discrete:return this.discreteOptions.interval||t}}get _intervalContext(){const{contextEnabled:t,contextOptions:{interval:e}}=this.thresholdOptions;return this.visualizationType===V.Threshold&&t?e||this._durationInterval:-1}get _durationSampleCount(){return this._lightDirections.length}get _duration(){return this.endTimeOfDay-this.startTimeOfDay}get _lightDirections(){return this._calculateLightDirections(this._interval)}get _lightDirectionsContext(){return this._calculateLightDirections(this._intervalContext)}_calculateLightDirections(t){const{view:e}=this;if(null==e||t<=0)return x;const i="global"===e.viewingMode?A:this._referencePosition;if(null==i)return x;const s=w(this._startDateTimeUTC,this._endDateTimeUTC,t,i,e.state.viewingMode,255),r=s.length;M.length=0;const o=C(0,r,M),n=new Array(r);for(let t=0;t<r;++t)n[t]=s[o[t]];return n}get _tooltipEnabled(){return this.state===U.Ready&&this.visualizationType!==V.Discrete&&this._running&&!this._previewing}get _visualizationParameters(){if(!this._running)return null;switch(this.visualizationType){case V.Threshold:return this._thresholdVisualizationParameters;case V.Duration:return this._durationVisualizationParameters;case V.Discrete:return this._discreteVisualizationParameters}}get _thresholdVisualizationParameters(){const{value:t,color:i}=this.thresholdOptions,s=this._duration;return{visualization:T.Threshold,thresholdColor:e.toUnitRGBA(i),threshold:s>0?t/this._duration:0,...this._thresholdDiscreteVisualizationParameters}}get _thresholdDiscreteVisualizationParameters(){const{contextOptions:{color:t},contextEnabled:i}=this.thresholdOptions;return i?{visualization:T.ThresholdAndGradient,gradientColor:e.toUnitRGBA(t)}:{}}get _durationVisualizationParameters(){const{color:t,mode:i}=this.durationOptions,s=this._duration,r=s>0&&i===D.Hourly?E/s:0,o=e.toUnitRGBA(t);return 0===r?{...this._discreteVisualizationParameters,gradientColor:o}:{bandedGradientColor:o,visualization:T.BandedGradient,bandSize:r}}get _discreteVisualizationParameters(){return{gradientColor:e.toUnitRGBA(this.discreteOptions.color),visualization:T.Gradient}}get _forcePreviewDependencies(){const{view:t}=this;if(null==t)return null;const e=t.slice.plane,i=t.allLayerViews.toArray().filter(H),r=i.map((t=>t.layer)).filter(s),o=i.map((t=>t.suspended)),n=r.map((t=>t.visible)),a=r.map((t=>t.opacity)),l=!!t.graphicsView?.suspended,u=r.filter((t=>"definitionExpression"in t)).map((t=>t.definitionExpression)),c=i.filter((t=>"filter"in t)).map((t=>t.filter));return{slicePlane:e,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewSuspended:o,graphicsViewSuspended:l,layerVisibilities:n,layerOpacities:a,filters:c,definitionExpressions:u}}get renderer(){const{view:t}=this;if(null==t)return null;const e=t.stage;return null==e?null:e.renderer}start(){this.setRunning(!0)}stop(){this.setRunning(!1)}setRunning(t){this._running=t}async getDuration(t,e){const{view:i,renderer:s,_durationSampleCount:r}=this;if(null==i||null==s||0===r)return 0;const o=i.state.camera.screenToRender(p(t.x,t.y),d());return s.readAccumulatedShadow(o)*this._duration}};function N(t,e){null!=t&&null!=e&&t.setParameters({shadowCast:e})}function H(t){if(t.suspended)return!1;switch(t.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"integrated-mesh-3dtiles":case"ogc-feature-3d":case"route-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"stream-3d":case"wms-3d":case"catalog-footprint-3d":return!0;default:return!1}}t([g()],R.prototype,"state",null),t([g()],R.prototype,"view",void 0),t([g()],R.prototype,"tooltip",void 0),t([g({type:Date,nonNullable:!0})],R.prototype,"date",null),t([g({type:Number,nonNullable:!0})],R.prototype,"utcOffset",null),t([g({type:Number,nonNullable:!0})],R.prototype,"startTimeOfDay",void 0),t([g({type:Number,nonNullable:!0})],R.prototype,"endTimeOfDay",void 0),t([g({type:["threshold","duration","discrete"],nonNullable:!0})],R.prototype,"visualizationType",void 0),t([g({type:O,nonNullable:!0})],R.prototype,"thresholdOptions",void 0),t([g({type:k,nonNullable:!0})],R.prototype,"durationOptions",void 0),t([g({type:j,nonNullable:!0})],R.prototype,"discreteOptions",void 0),t([g()],R.prototype,"_running",void 0),t([g()],R.prototype,"_stopPreviewingTask",void 0),t([g()],R.prototype,"_forcePreview",void 0),t([g()],R.prototype,"_autoRestoreForcePreviewEnabled",void 0),t([g()],R.prototype,"_previewing",null),t([g()],R.prototype,"_utcOffset",void 0),t([g()],R.prototype,"_utcOffsetAuto",null),t([g()],R.prototype,"_dateUTCOffset",null),t([g()],R.prototype,"_startDateTimeUTC",null),t([g()],R.prototype,"_endDateTimeUTC",null),t([g()],R.prototype,"_referencePosition",null),t([g()],R.prototype,"_interval",null),t([g()],R.prototype,"_intervalContext",null),t([g()],R.prototype,"_durationSampleCount",null),t([g()],R.prototype,"_duration",null),t([g()],R.prototype,"_lightDirections",null),t([g()],R.prototype,"_lightDirectionsContext",null),t([g()],R.prototype,"_tooltipEnabled",null),t([g()],R.prototype,"_visualizationParameters",null),t([g()],R.prototype,"_thresholdVisualizationParameters",null),t([g()],R.prototype,"_thresholdDiscreteVisualizationParameters",null),t([g()],R.prototype,"_durationVisualizationParameters",null),t([g()],R.prototype,"_discreteVisualizationParameters",null),t([g()],R.prototype,"_forcePreviewDependencies",null),t([g()],R.prototype,"renderer",null),R=t([f("esri.widgets.ShadowCast.ShadowCastViewModel")],R);const G=R;export{U as S,V as a,G as default};
