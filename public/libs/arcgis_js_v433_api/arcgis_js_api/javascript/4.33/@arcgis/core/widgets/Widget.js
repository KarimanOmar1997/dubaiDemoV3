/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.33/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{b as t}from"../chunks/domUtils.js";import r from"../core/Evented.js";import{i as s,a as o}from"../chunks/events.js";import{clone as i}from"../core/lang.js";import{L as n}from"../chunks/Logger.js";import{d as a}from"../chunks/maybe.js";import c from"../core/Promise.js";import{debounce as d,throwIfNotAbortError as l}from"../core/promiseUtils.js";import{watch as h,syncAndInitial as p,when as u}from"../core/reactiveUtils.js";import{g as m}from"../chunks/uuid.js";import{property as g}from"../core/accessorSupport/decorators/property.js";import{cast as v}from"../core/accessorSupport/decorators/cast.js";import{subclass as f}from"../core/accessorSupport/decorators/subclass.js";import{r as j}from"../chunks/tracking.js";import{S as y}from"../chunks/SimpleTrackingTarget.js";import{d as _}from"../chunks/projector.js";import{I as k}from"../chunks/componentsUtils.js";import{w as b,a as w,i as R,p as P}from"../chunks/jsxWidgetSupport.js";import{m as E}from"../chunks/handleUtils.js";import{g as S,f as I,h as L,c as N,j as F}from"../chunks/widgetUtils.js";import{f as T}from"../chunks/messages.js";import{o as U}from"../chunks/locale.js";import"../chunks/date.js";import"../chunks/jsonMap.js";import"../config.js";import"../chunks/constants.js";import"../chunks/datetime.js";import"../chunks/number2.js";import"../chunks/substitute.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"../chunks/jsonUtils.js";import"../chunks/MapUtils.js";import"../chunks/persistableUrlUtils.js";import"../chunks/assets.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/Lifecycle.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../chunks/SetUtils.js";import"../chunks/ensureType.js";import"../chunks/Warning.js";import"../chunks/sanitizerUtils.js";const C={handleInterceptedEvent:(e,t,r,s)=>(e.scheduleRender(),t.properties[`on${s.type}`].apply(t.properties.bind||r,[s]))},H={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(e,t,r)=>{"-"===t.charAt(0)?e.style.setProperty(t,r):e.style[t]=r}},A=(e,t,r=!1)=>{let s=e;return t.forEach(((e,o)=>{const i=s?.children?(n=t=>t.domNode===e,s.children.find(n)):void 0;var n;r&&!i&&o!==t.length-1||(s=i)})),s},$=new Set;var O;let x=0;function z(e,t){const r=Object.prototype.hasOwnProperty;for(const s in t)r.call(t,s)&&r.call(e,s)&&(null!=e[s]&&null!=t[s]&&"object"==typeof e[s]&&"object"==typeof t[s]?z(e[s],t[s]):e[s]=t[s]);return e}const B=(e=>{let t;const r={...C,...e},s=(e=>({...H,...e}))(r),o=s.performanceLogger;let i,n=!0,a=!1;const c=[],d=[],l=(e,i,n)=>{let a;s.eventHandlerInterceptor=(e,s,i,n)=>function(e){let s;o("domEvent",e);const i=((e,t)=>{const r=[];for(;e&&e!==t;)r.push(e),e=e.parentNode;return r})(e.currentTarget,a.domNode),n=i.some((e=>customElements.get(e?.tagName?.toLowerCase())));if(e.eventPhase!==Event.CAPTURING_PHASE&&n){const t=e.composedPath(),r=t.slice(t.indexOf(e.currentTarget),t.indexOf(a.domNode)).reverse();s=A(a.getLastRender(),r,!0)}else i.reverse(),s=A(a.getLastRender(),i);let c;return s&&(c=r.handleInterceptedEvent(t,s,this,e)),o("domEventProcessed",e),c},r.postProcessProjectionOptions?.(s);const l=n();a=e(i,l,s),s.eventHandlerInterceptor=void 0,c.push(a),d.push(n),r.afterFirstVNodeRendered&&r.afterFirstVNodeRendered(a,l)};let h=()=>{if(i=void 0,n){n=!1,o("renderStart",void 0);for(let e=0;e<c.length;e++){const t=d[e]();o("rendered",void 0);try{c[e].update(t)}catch(e){console.error(e)}o("patched",void 0)}o("renderDone",void 0),n=!0}};return r.modifyDoRenderImplementation&&(h=r.modifyDoRenderImplementation(h,c,d)),t={renderNow:h,scheduleRender:()=>{i||a||(i=requestAnimationFrame(h))},stop:()=>{i&&(cancelAnimationFrame(i),i=void 0),a=!0},resume:()=>{a=!1,n=!0,t.scheduleRender()},append:(e,t)=>{l(_.append,e,t)},insertBefore:(e,t)=>{l(_.insertBefore,e,t)},merge:(e,t)=>{l(_.merge,e,t)},replace:(e,t)=>{l(_.replace,e,t)},detach:e=>{for(let t=0;t<d.length;t++)if(d[t]===e)return d.splice(t,1),c.splice(t,1)[0];throw new Error("renderFunction was not found")}},t})({postProcessProjectionOptions(e){const t=e.eventHandlerInterceptor,r=/capture$/i;e.eventHandlerInterceptor=(e,s,o,i)=>{const n=t?.(e,s,o,i),a=r.test(e);if(!((e=e.replace(r,"")).toLowerCase()in o)||a){const t=e[2].toLowerCase()+e.slice(3),r=e=>n?.call(o,e);o.addEventListener(t,r,a);const s=()=>o.removeEventListener(t,r,a),c=i.afterRemoved;i.afterRemoved=e=>{c?.(e),s()}}return n}},handleInterceptedEvent(e,t,r,s){const{eventPhase:o,type:i}=s,n=o===Event.CAPTURING_PHASE;let a=`on${i}${n?"capture":""}`;const c=t.properties;(c&&a in c||(a=`on${i[0].toUpperCase()}${i.slice(1)}${n?"Capture":""}`,c&&a in c))&&(F(),e.scheduleRender(),c[a].call(c.bind||r,s))}});let D=!1,M=class extends(c.EsriPromiseMixin(r.EventedAccessor)){static{this[O]=!0}constructor(e,t){super(e,t),this._attached=!1,this._projector=B,this._readyForTrueRender=!1,this.key=this,this.autoRenderingEnabled=!0,this._loadLocale=d((async()=>{if(this._messageBundleProps?.length){const e=await Promise.allSettled(this._messageBundleProps.map((async({bundlePath:e,propertyName:t})=>{if(this.destroyed)return;let r=await T(e);this.uiStrings&&Object.keys(this.uiStrings)&&(r=z(i(r),this.uiStrings)),this[t]=r})));if(this.destroyed)return;for(const t of e)"rejected"===t.status&&n.getLogger(this).error("widget-intl:locale-error",this.declaredClass,t.reason)}await this.loadLocale()})),this.addHandles(E()),k();const r="esri-widget-uid-"+m(),s=this.render.bind(this);this._trackingTarget=new y((()=>{this.autoRenderingEnabled&&this.scheduleRender()}));const o=()=>({vnodeSelector:"div",properties:{key:`${r}-hidden`,class:"",styles:{display:"none"}},domNode:null,children:void 0,text:void 0}),a=()=>{if(!this._readyForTrueRender||this.destroyed)return null;const e=s()??o(),t=e.properties??={};if(t.key??=r,R(e.vnodeSelector)){if(!this.visible)return o()}else this.visible?t.styles||(t.styles={}):(t.class="",t.styles={display:"none"}),t.styles.display??="";let i=0;return e.children?.forEach((e=>{R(e.vnodeSelector)||(e.properties??={},e.properties.key??=`${this.id}--${i++}`)})),P(this,e)};this.render=()=>{if(D)return a();let e=S(this)??null;if(e)return e;this._trackingTarget.clear(),D=!0;try{e=j(this._trackingTarget,a)}catch(e){throw n.getLogger(this).error(e),e}finally{D=!1}return e&&I(this,e),e};const c=this.beforeFirstRender();var l;c?this._resourcesFetch=c.then((()=>{this._readyForTrueRender=!0,this._postInitialize()})):(this._resourcesFetch=Promise.resolve().then((()=>{this._postInitialize()})),this._readyForTrueRender=!0),this.addResolvingPromise(this._resourcesFetch),l=this._resourcesFetch,$.add(l),l.finally((()=>$.delete(l)))}normalizeCtorArgs(e,t){const r={...e};return t&&(r.container=t),r}postInitialize(){}beforeFirstRender(){const e=this.loadDependencies();return this._messageBundleProps?.length||e?Promise.all([e,this._loadLocale()]).then((()=>{})).catch(l):null}loadDependencies(){return null}loadLocale(){return null}destroy(){this.destroyed||(a(this._trackingTarget),a(this.viewModel),this._detach(this.container),this._set("container",null),this._emitter.clear(),this.render=()=>null,this._projector=null,L(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return t(e)}get domNode(){return this.container}set domNode(e){this.container=e}get icon(){return null}set icon(e){this._overrideIfSome("icon",e)}get id(){return this._get("id")||this.container?.id||Date.now().toString(16)+"-widget-"+x++}set id(e){e&&this._set("id",e)}get label(){return this.declaredClass.split(".").pop()}set label(e){this._overrideIfSome("label",e)}get renderable(){return this._resourcesFetch}get visible(){return this._get("visible")}set visible(e){this._set("visible",e)}get[(O=b,w)](){return{projector:this._projector}}static{this.vnodeSelector="div"}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(L(this),this._projector.scheduleRender())}classes(...e){return N.apply(this,e)}renderNow(){L(this),this._projector.renderNow()}_postInitialize(){if(this.destroyed)return;this.scheduleRender(),this._delegatedEventNames?.length&&this.addHandles(h((()=>this.viewModel),((e,t)=>{t&&this.removeHandles("delegated-events"),e&&s(e)&&this.addHandles(this._delegatedEventNames.map((t=>o(e,t,(e=>{this.emit(t,e)})))),"delegated-events")}),p)),this.postInitialize();const e=async()=>{await this._loadLocale().catch(l),this.scheduleRender()};this.addHandles([U(e),h((()=>this.uiStrings),e)]),this.addHandles(u((()=>this.container),(e=>{this.destroyed||this._attach(e)}),{initial:!0,once:!0}))}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){this._attached&&(this._projector.detach(this.render),this._attached=!1),e?.parentNode?.removeChild(e)}};e([g()],M.prototype,"_readyForTrueRender",void 0),e([g({value:null})],M.prototype,"container",null),e([v("container")],M.prototype,"castContainer",null),e([g()],M.prototype,"icon",null),e([g()],M.prototype,"id",null),e([g()],M.prototype,"label",null),e([g()],M.prototype,"renderable",null),e([g()],M.prototype,"uiStrings",void 0),e([g()],M.prototype,"viewModel",void 0),e([g({value:!0})],M.prototype,"visible",null),e([g()],M.prototype,"key",void 0),e([g()],M.prototype,"children",void 0),e([g()],M.prototype,"afterCreate",void 0),e([g()],M.prototype,"afterUpdate",void 0),e([g()],M.prototype,"afterRemoved",void 0),M=e([f("esri.widgets.Widget")],M);const W=M;export{W as default};
