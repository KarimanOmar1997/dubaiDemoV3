// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","./chunks/tslib.es6","./Color","./core/Collection","./core/collectionUtils","./core/compilerUtils","./core/Error","./core/JSONSupport","./core/lang","./core/Loadable","./core/loadAll","./core/Logger","./core/maybe","./core/promiseUtils","./core/accessorSupport/decorators/property","./core/accessorSupport/ensureType","./core/accessorSupport/decorators/subclass","./core/accessorSupport/decorators/writer","./ground/NavigationConstraint","./support/groundInstanceUtils","./webdoc/support/opacityUtils"],(function(e,r,t,o,s,a,n,i,l,c,y,p,u,d,h,f,g,w,v,m,_){"use strict";var S,I;let C=I=class extends(i.JSONSupportMixin(c)){static{S=m.GroundSymbol}constructor(e){super(e),this[S]=!0,this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new o;const r=e=>{e.parent&&e.parent!==this&&"remove"in e.parent&&e.parent.remove(e),e.parent=this,"elevation"!==e.type&&"base-elevation"!==e.type&&p.getLogger(this).error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)};this.addHandles([this.layers.on("after-add",(e=>r(e.item))),this.layers.on("after-remove",(e=>{e.item.parent=null}))])}initialize(){this.when().catch((e=>{d.isAbortError(e)||p.getLogger(this).error("#load()","Failed to load ground",e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.layers.removeAll();for(const r of e)u.destroyMaybe(r);this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}get layers(){return this._get("layers")}set layers(e){this._set("layers",s.referenceSetter(e,this._get("layers")))}writeLayers(e,r,t,o){const s=[];e?(o={...o,layerContainerType:"ground"},e.forEach((e=>{if("write"in e){const r={};a.typeCast(e)().write(r,o)&&s.push(r)}else o?.messages&&o.messages.push(new n("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in the ground`,{layer:e}))})),r.layers=s):r.layers=s}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return y.loadAll(this,(e=>{e(this.layers)}))}async queryElevation(r,t){await this.load({signal:t?.signal});const{ElevationQuery:o}=await new Promise(((r,t)=>e(["./layers/support/ElevationQuery"],r,t)));d.throwIfAborted(t);const s=new o,a=this.layers.filter(b).toArray();return s.queryAll(a,r,t)}async createElevationSampler(r,t){await this.load({signal:t?.signal});const{ElevationQuery:o}=await new Promise(((r,t)=>e(["./layers/support/ElevationQuery"],r,t)));d.throwIfAborted(t);const s=new o,a=this.layers.filter(b).toArray();return s.createSamplerAll(a,r,t)}clone(){const e={opacity:this.opacity,surfaceColor:l.clone(this.surfaceColor),navigationConstraint:l.clone(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new I({resourceInfo:this.resourceInfo}).set(e)}read(e,r){this.resourceInfo||this._set("resourceInfo",{data:e,context:r}),super.read(e,r)}_loadFromSource(e){const r=this.resourceInfo;return r?this._loadLayersFromJSON(r.data,r.context,e):Promise.resolve()}async _loadLayersFromJSON(r,t,o){const s=t?.origin||"web-scene",a=t?.portal||null,n=t?.url||null,{populateOperationalLayers:i}=await new Promise(((r,t)=>e(["./layers/support/layersCreator"],r,t)));d.throwIfAborted(o);const l=[];if(r.layers&&Array.isArray(r.layers)){const e={context:{origin:s,url:n,portal:a,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};l.push(i(this.layers,r.layers,e))}await Promise.allSettled(l)}};function b(e){return"elevation"===e.type||function(e){return e&&"createElevationSampler"in e}(e)}return r.__decorate([h.property({json:{read:!1,write:{isRequired:!0}}})],C.prototype,"layers",null),r.__decorate([w.writer("layers")],C.prototype,"writeLayers",null),r.__decorate([h.property({readOnly:!0})],C.prototype,"resourceInfo",void 0),r.__decorate([h.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:f.Integer,read:{reader:_.transparencyToOpacity,source:"transparency"},write:{writer:(e,r)=>{r.transparency=_.opacityToTransparency(e)},target:"transparency"}}})],C.prototype,"opacity",void 0),r.__decorate([h.property({type:t,json:{type:[f.Integer],write:(e,r)=>{r.surfaceColor=e.toJSON().slice(0,3)}}})],C.prototype,"surfaceColor",void 0),r.__decorate([h.property({type:v.NavigationConstraint,json:{write:!0}})],C.prototype,"navigationConstraint",void 0),C=I=r.__decorate([g.subclass("esri.Ground")],C),C}));