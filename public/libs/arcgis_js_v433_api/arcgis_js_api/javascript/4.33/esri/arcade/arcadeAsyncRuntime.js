// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","./arcadeEnvironment","./ArcadeModule","./ArcadeModuleLoader","./containerUtils","./Dictionary","./executionError","./Feature","./FunctionWrapper","../chunks/languageUtils","./treeAnalysis","../chunks/aiServices","../chunks/array","./functions/date","./functions/feature","./functions/geomasync","./functions/geometry","./functions/maths","./functions/stats","./functions/string","../core/has","../geometry/Geometry","../geometry/SpatialReference","../support/guards"],(function(e,r,t,o,n,i,a,c,u,s,l,d,E,f,p,w,x,h,m,g,b,y,v,S){"use strict";async function A(e,r){const t=[];for(let o=0;o<r.arguments.length;o++)t.push(await O(e,r.arguments[o]));return t}async function C(e,r,t){return!0===r.preparsed?t(e,null,r.arguments):t(e,r,await A(e,r))}class F extends u.ArcadeFunction{constructor(e,r){super(),this.definition=null,this.context=null,this.definition=e,this.context=r}createFunction(e){return(...r)=>{const t={spatialReference:this.context.spatialReference,console:this.context.console,lrucache:this.context.lrucache,timeZone:this.context.timeZone??null,exports:this.context.exports,libraryResolver:this.context.libraryResolver,interceptor:this.context.interceptor,services:this.context.services,abortSignal:this.context.abortSignal,localScope:{},depthCounter:{depth:e.depthCounter+1},globalScope:this.context.globalScope};if(t.depthCounter.depth>64)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.MaximumCallDepth,null);return I(this.definition,t,r,null)}}call(e,r){return N(e,r,((t,o,n)=>{const i={spatialReference:e.spatialReference,services:e.services,console:e.console,libraryResolver:e.libraryResolver,exports:e.exports,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:{},abortSignal:e.abortSignal,globalScope:e.globalScope,depthCounter:{depth:e.depthCounter.depth+1}};if(i.depthCounter.depth>64)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.MaximumCallDepth,r);return I(this.definition,i,n,r)}))}marshalledCall(e,r,t,o){return o(e,r,(async(n,i,a)=>{const c={spatialReference:e.spatialReference,services:e.services,globalScope:t.globalScope,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,console:e.console,abortSignal:e.abortSignal,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:{}};return a=a.map((r=>!s.isFunctionParameter(r)||r instanceof u.ScopeMarshalledFunction?r:u.wrapModuleScopedResponse(r,e,o))),u.wrapModuleScopedResponse(await I(this.definition,c,a,r),t,o)}))}}async function I(e,t,o,n){const i=e.body;if(o.length!==e.params.length)throw new a.ArcadeExecutionError(t,a.ExecutionErrorCodes.WrongNumberOfParameters,null);for(let n=0;n<o.length;n++){const i=e.params[n];"Identifier"===i.type&&null!=t.localScope&&(t.localScope[r.toSymbolId(i)]={value:o[n]})}const c=await M(t,i);if(c instanceof s.ReturnResult)return c.value;if(c===s.breakResult)throw new a.ArcadeExecutionError(t,a.ExecutionErrorCodes.UnexpectedToken,n);if(c===s.continueResult)throw new a.ArcadeExecutionError(t,a.ExecutionErrorCodes.UnexpectedToken,n);return c instanceof s.ImplicitResult?c.value:c}class R extends t.ArcadeModule{constructor(e){super(),this.source=e}global(e){const t=this.executingContext.globalScope[r.toSymbolId(e)];if(s.isFunctionParameter(t.value)&&!(t.value instanceof u.ScopeMarshalledFunction)){const o=new u.ScopeMarshalledFunction;return o.fn=t.value,o.parameterEvaluator=N,o.context=this.executingContext,this.executingContext.globalScope[r.toSymbolId(e)]={value:o},o}return t.value}setGlobal(e,t){if(s.isFunctionParameter(t))throw new a.ArcadeExecutionError(null,a.ExecutionErrorCodes.AssignModuleFunction,null);this.executingContext.globalScope[r.toSymbolId(e)]={value:t}}hasGlobal(e){return void 0===this.executingContext.exports[e]&&(e=r.toSymbolId(e)),void 0!==this.executingContext.exports[e]}async loadModule(e){const t=e.spatialReference??v.WebMercator;this.moduleScope=Y(null,null,e.timeZone),this.executingContext={spatialReference:t,services:e.services,libraryResolver:new o.ArcadeModuleLoader(e.libraryResolver._moduleSingletons,this.source.syntax.loadedModules),exports:{},abortSignal:e.abortSignal??r.neverAbortedSignal,globalScope:this.moduleScope,console:e.console??H,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:null,depthCounter:{depth:1}},await L(this.executingContext,this.source.syntax)}}async function N(e,r,t){return!0===r.preparsed?t(e,null,r.arguments):t(e,r,await A(e,r))}async function O(e,t){t.breakpoint&&await t.breakpoint();try{switch(t.type){case"UpdateExpression":return await async function(e,t){const o=t.argument;if("CallExpression"===o.type)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.NeverReach,t);if("MemberExpression"===o.type){const r=await O(e,o.object);let n,c;if(!0===o.computed)n=await O(e,o.property);else{if("Identifier"!==o.property.type)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.Unrecognized,t);n=o.property.name}if(S.isArray(r)){if(!S.isNumber(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.ArrayAccessorMustBeNumber,t);if(n<0&&(n=r.length+n),n<0||n>=r.length)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.OutOfBounds,t);c=s.toNumber(r[n]),r[n]="++"===t.operator?c+1:c-1}else if(r instanceof i){if(!1===S.isString(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.KeyAccessorMustBeString,t);if(!0!==r.hasField(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.FieldNotFound,t,{key:n});c=s.toNumber(r.field(n)),r.setField(n,"++"===t.operator?c+1:c-1)}else if(r instanceof R){if(!1===S.isString(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.ModuleAccessorMustBeString,t);if(!0!==r.hasGlobal(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.ModuleExportNotFound,t);c=s.toNumber(r.global(n)),r.setGlobal(n,"++"===t.operator?c+1:c-1)}else{if(!s.isFeature(r))throw s.isImmutableArray(r)?new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.Immutable,t):new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidParameter,t);if(!1===S.isString(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.KeyAccessorMustBeString,t);if(!0!==r.hasField(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.FieldNotFound,t,{key:n});c=s.toNumber(r.field(n)),r.setField(n,"++"===t.operator?c+1:c-1)}return!1===t.prefix?c:"++"===t.operator?c+1:c-1}const n=r.toSymbolId(o);let c;if(null!=e.localScope&&void 0!==e.localScope[n])return c=s.toNumber(e.localScope[n].value),e.localScope[n]={value:"++"===t.operator?c+1:c-1},!1===t.prefix?c:"++"===t.operator?c+1:c-1;if(void 0!==e.globalScope[n])return c=s.toNumber(e.globalScope[n].value),e.globalScope[n]={value:"++"===t.operator?c+1:c-1},!1===t.prefix?c:"++"===t.operator?c+1:c-1;throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidIdentifier,t)}(e,t);case"AssignmentExpression":return await async function(e,t){const o=t.left;if("MemberExpression"===o.type){const r=await O(e,o.object);let n;if(!0===o.computed)n=await O(e,o.property);else{if("Identifier"!==o.property.type)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidIdentifier,t);n=o.property.name}const c=await O(e,t.right);if(S.isArray(r)){if(!S.isNumber(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.ArrayAccessorMustBeNumber,t);if(n<0&&(n=r.length+n),n<0||n>r.length)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.OutOfBounds,t);if(n===r.length){if("="!==t.operator)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.OutOfBounds,t);r[n]=P(c,t.operator,r[n],t,e)}else r[n]=P(c,t.operator,r[n],t,e)}else if(r instanceof i){if(!1===S.isString(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.KeyAccessorMustBeString,t);if(!0===r.hasField(n))r.setField(n,P(c,t.operator,r.field(n),t,e));else{if("="!==t.operator)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.FieldNotFound,t,{key:n});r.setField(n,P(c,t.operator,null,t,e))}}else if(r instanceof R){if(!1===S.isString(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.KeyAccessorMustBeString,t);if(!0!==r.hasGlobal(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.ModuleExportNotFound,t);r.setGlobal(n,P(c,t.operator,r.global(n),t,e))}else{if(!s.isFeature(r))throw s.isImmutableArray(r)?new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.Immutable,t):new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidParameter,t);if(!1===S.isString(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.KeyAccessorMustBeString,t);if(!0===r.hasField(n))r.setField(n,P(c,t.operator,r.field(n),t,e));else{if("="!==t.operator)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.FieldNotFound,t,{key:n});r.setField(n,P(c,t.operator,null,t,e))}}return s.voidOperation}const n=r.toSymbolId(o);if(null!=e.localScope&&void 0!==e.localScope[n]){const r=await O(e,t.right);return e.localScope[n]={value:P(r,t.operator,e.localScope[n].value,t,e)},s.voidOperation}if(void 0!==e.globalScope[n]){const r=await O(e,t.right);return e.globalScope[n]={value:P(r,t.operator,e.globalScope[n].value,t,e)},s.voidOperation}throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidIdentifier,t)}(e,t);case"TemplateLiteral":return await async function(e,r){let t="",o=0;for(const n of r.quasis)if(t+=n.value?n.value.cooked:"",!1===n.tail){if(r.expressions[o]){const n=await O(e,r.expressions[o]);if(s.isFunctionParameter(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.NoFunctionInTemplateLiteral,r);t+=s.toString(n)}o++}return t}(e,t);case"Identifier":return K(e,t);case"MemberExpression":return await async function(e,r){const t=await O(e,r.object);if(null===t)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.MemberOfNull,r);if(!1===r.computed){if("Identifier"===r.property.type){if(t instanceof i||s.isDictionaryLike(t))return t.field(r.property.name);if(t instanceof y)return n.geometryMember(t,r.property.name,e,r);if(t instanceof R){if(!t.hasGlobal(r.property.name))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidIdentifier,r);return t.global(r.property.name)}throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidMemberAccessKey,r)}throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidMemberAccessKey,r)}let o=await O(e,r.property);if(t instanceof i||s.isDictionaryLike(t)){if(S.isString(o))return t.field(o);throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof R){if(S.isString(o))return t.global(o);throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof y){if(S.isString(o))return n.geometryMember(t,o,e,r);throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(S.isArray(t)){if(S.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.OutOfBounds,r);return t[o]}throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(s.isImmutableArray(t)){if(S.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length()+o),o>=t.length()||o<0)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.OutOfBounds,r);return t.get(o)}throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(S.isString(t)){if(S.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.OutOfBounds,r);return t[o]}throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidMemberAccessKey,r)}throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidMemberAccessKey,r)}(e,t);case"Literal":return t.value;case"CallExpression":return await async function(e,t){if("MemberExpression"===t.callee.type){const r=await O(e,t.callee.object);if(!(r instanceof R))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.FunctionNotFound,t);const o=!1===t.callee.computed?t.callee.property.name:await O(e,t.callee.property);if(!r.hasGlobal(o))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.FunctionNotFound,t);const n=r.global(o);if(!s.isFunctionParameter(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.CallNonFunction,t);return n.call(e,t)}if("Identifier"!==t.callee.type)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.FunctionNotFound,t);const o=r.toSymbolId(t.callee);if(null!=e.localScope&&void 0!==e.localScope[o]){const r=e.localScope[o];if(s.isFunctionParameter(r.value))return r.value.call(e,t);throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.CallNonFunction,t)}if(void 0!==e.globalScope[o]){const r=e.globalScope[o];if(s.isFunctionParameter(r.value))return r.value.call(e,t);throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.CallNonFunction,t)}throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.FunctionNotFound,t)}(e,t);case"UnaryExpression":return await async function(e,r){const t=await O(e,r.argument);if(S.isBoolean(t)){if("!"===r.operator)return!t;if("-"===r.operator)return-1*s.toNumber(t);if("+"===r.operator)return 1*s.toNumber(t);if("~"===r.operator)return~s.toNumber(t);throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}if("-"===r.operator)return-1*s.toNumber(t);if("+"===r.operator)return 1*s.toNumber(t);if("~"===r.operator)return~s.toNumber(t);throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}(e,t);case"BinaryExpression":return await async function(e,r){const t=await O(e,r.left),o=await O(e,r.right);switch(r.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":return s.binaryOperator(s.toNumber(t),s.toNumber(o),r.operator);case"==":return s.equalityTest(t,o);case"!=":return!s.equalityTest(t,o);case"<":case">":case"<=":case">=":return s.greaterThanLessThan(t,o,r.operator);case"+":return S.isString(t)||S.isString(o)?s.toString(t)+s.toString(o):s.toNumber(t)+s.toNumber(o);case"-":return s.toNumber(t)-s.toNumber(o);case"*":return s.toNumber(t)*s.toNumber(o);case"/":return s.toNumber(t)/s.toNumber(o);case"%":return s.toNumber(t)%s.toNumber(o);default:throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.UnsupportedOperator,r)}}(e,t);case"LogicalExpression":return await async function(e,r){const t=await O(e,r.left);if(!S.isBoolean(t))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.LogicalExpressionOnlyBoolean,r);switch(r.operator){case"||":{if(!0===t)return t;const o=await O(e,r.right);if(S.isBoolean(o))return o;throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.LogicExpressionOrAnd,r)}case"&&":{if(!1===t)return t;const o=await O(e,r.right);if(S.isBoolean(o))return o;throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.LogicExpressionOrAnd,r)}default:throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.LogicExpressionOrAnd,r)}}(e,t);case"ArrayExpression":return await async function(e,r){const t=[];for(let o=0;o<r.elements.length;o++)t.push(await O(e,r.elements[o]));for(let o=0;o<t.length;o++){if(s.isFunctionParameter(t[o]))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.NoFunctionInArray,r);t[o]===s.voidOperation&&(t[o]=null)}return t}(e,t);case"ObjectExpression":return await async function(e,r){const t=[];for(let o=0;o<r.properties.length;o++){const n=r.properties[o],i=await O(e,n.value),a="Identifier"===n.key.type?n.key.name:await O(e,n.key);t[o]={key:a,value:i}}const o=Object.create(null),n=new Map;for(let i=0;i<t.length;i++){const c=t[i];if(s.isFunctionParameter(c.value))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.NoFunctionInDictionary,r);if(!1===S.isString(c.key))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.KeyMustBeString,r);let u=c.key.toString();const l=u.toLowerCase();n.has(l)?u=n.get(l):n.set(l,u),c.value===s.voidOperation?o[u]=null:o[u]=c.value}const c=new i(o);return c.immutable=!1,c}(e,t);default:throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.Unrecognized,t)}}catch(r){throw a.ensureArcadeExecutionError(e,t,r)}}async function M(e,t){t.breakpoint&&await t.breakpoint();try{switch(t.type){case"ImportDeclaration":return await async function(e,t){const o=r.toSymbolId(t.specifiers[0].local),n=e.libraryResolver.loadLibrary(o);let i;return e.libraryResolver._moduleSingletons?.has(n.uri)?i=e.libraryResolver._moduleSingletons.get(n.uri):(i=new R(n),await i.loadModule(e),e.libraryResolver._moduleSingletons?.set(n.uri,i)),e.globalScope[o]={value:i},s.voidOperation}(e,t);case"ExportNamedDeclaration":return await async function(e,t){if(await M(e,t.declaration),"FunctionDeclaration"===t.declaration.type)e.exports[r.toSymbolId(t.declaration.id)]="function";else if("VariableDeclaration"===t.declaration.type)for(const o of t.declaration.declarations)e.exports[r.toSymbolId(o.id)]="variable";return s.voidOperation}(e,t);case"VariableDeclaration":return await G(e,t,0);case"BlockStatement":return await L(e,t);case"FunctionDeclaration":return await async function(e,t){const o=r.toSymbolId(t.id);return e.globalScope[o]={value:new F(t,e)},s.voidOperation}(e,t);case"ReturnStatement":return await async function(e,r){if(null===r.argument)return new s.ReturnResult(s.voidOperation);const t=await O(e,r.argument);return new s.ReturnResult(t)}(e,t);case"IfStatement":return await async function(e,r){const t=await O(e,r.test);if(!0===t)return M(e,r.consequent);if(!1===t)return null!==r.alternate?M(e,r.alternate):s.voidOperation;throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.BooleanConditionRequired,r)}(e,t);case"ExpressionStatement":return await async function(e,r){const t=await O(e,r.expression);return t===s.voidOperation?s.voidOperation:new s.ImplicitResult(t)}(e,t);case"ForStatement":return await async function(e,r){try{for(null!==r.init&&("VariableDeclaration"===r.init.type?await M(e,r.init):await O(e,r.init));;){if(null!==r.test){const t=await O(e,r.test);if(!0===e.abortSignal?.aborted)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.Cancelled,r);if(!1===t)break;if(!0!==t)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.BooleanConditionRequired,r)}const t=await M(e,r.body);if(t===s.breakResult)break;if(t instanceof s.ReturnResult)return t;null!==r.update&&await O(e,r.update)}return s.voidOperation}catch(e){throw e}}(e,t);case"WhileStatement":return await async function(e,r){let t=await O(e,r.test);if(!1===t)return s.voidOperation;if(!0!==t)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.BooleanConditionRequired,r);for(;!0===t;){const o=await M(e,r.body);if(o===s.breakResult)break;if(o instanceof s.ReturnResult)return o;if(t=await O(e,r.test),!0!==t&&!1!==t)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.BooleanConditionRequired,r)}return s.voidOperation}(e,t);case"ForInStatement":return await async function(e,t){const o=await O(e,t.right);"VariableDeclaration"===t.left.type&&await M(e,t.left);const c=r.toSymbolId("VariableDeclaration"===t.left.type?t.left.declarations[0].id:t.left);let u=null;if(null!=e.localScope&&void 0!==e.localScope[c]&&(u=e.localScope[c]),null===u&&void 0!==e.globalScope[c]){const r=e.globalScope[c].value;u=e.globalScope[c]={value:r}}if(null===u)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidIdentifier,t);return S.isArray(o)||S.isString(o)?await k(e,t,o,u):s.isImmutableArray(o)?await B(e,t,o,u):o instanceof i||s.isDictionaryLike(o)?await k(e,t,o.keys(),u,"k"):s.isFeatureSet(o)?await D(e,t,o,u):s.isGeometry(o)?await k(e,t,n.getGeometryKeys(o),u,"k"):s.voidOperation}(e,t);case"ForOfStatement":return await async function(e,t){const o=await O(e,t.right);"VariableDeclaration"===t.left.type&&await M(e,t.left);const c=r.toSymbolId("VariableDeclaration"===t.left.type?t.left.declarations[0].id:t.left);let u=null;if(null!=e.localScope&&void 0!==e.localScope[c]&&(u=e.localScope[c]),null===u&&void 0!==e.globalScope[c]){const r=e.globalScope[c].value;u=e.globalScope[c]={value:r}}if(null===u)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidIdentifier,t);return S.isArray(o)||S.isString(o)?await k(e,t,o,u,"k"):s.isImmutableArray(o)?await B(e,t,o,u,"k"):o instanceof i||s.isDictionaryLike(o)?await async function(e,r,t,o){for(const n of t.keys()){const a=t.field(n);o.value=i.containerEntry(n,a);const c=await M(e,r.body);if(c===s.breakResult)break;if(c instanceof s.ReturnResult)return c}return s.voidOperation}(e,t,o,u):s.isFeatureSet(o)?await D(e,t,o,u):s.isGeometry(o)?await async function(e,r,t,o){for(const a of n.getGeometryKeys(t)){const c=n.geometryMember(t,a,e,r,1);o.value=i.containerEntry(a,c);const u=await M(e,r.body);if(u===s.breakResult)break;if(u instanceof s.ReturnResult)return u}return s.voidOperation}(e,t,o,u):s.voidOperation}(e,t);case"BreakStatement":return s.breakResult;case"EmptyStatement":return s.voidOperation;case"ContinueStatement":return s.continueResult;default:throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.Unrecognized,t)}}catch(r){throw a.ensureArcadeExecutionError(e,t,r)}}async function k(e,r,t,o,n="i"){const i=t.length;for(let c=0;c<i;c++){if("k"===n){if(c>=t.length)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.OutOfBounds,r);o.value=t[c]}else o.value=c;const i=await M(e,r.body);if(i===s.breakResult)break;if(i instanceof s.ReturnResult)return i}return s.voidOperation}async function B(e,r,t,o,n="i"){const i=t.length();for(let a=0;a<i;a++){o.value="k"===n?t.get(a):a;const i=await M(e,r.body);if(i===s.breakResult)break;if(i instanceof s.ReturnResult)return i}return s.voidOperation}async function D(e,r,t,o){const n=t.iterator(e.abortSignal);let i;for(;null!=(i=await n.next());){const n=c.createFromGraphicLikeObject(i.geometry,i.attributes,t,e.timeZone);n._underlyingGraphic=i,o.value=n;const a=await M(e,r.body);if(a===s.breakResult)break;if(a instanceof s.ReturnResult)return a}return s.voidOperation}function P(e,r,t,o,n){switch(r){case"=":return e===s.voidOperation?null:e;case"/=":return s.toNumber(t)/s.toNumber(e);case"*=":return s.toNumber(t)*s.toNumber(e);case"-=":return s.toNumber(t)-s.toNumber(e);case"+=":return S.isString(t)||S.isString(e)?s.toString(t)+s.toString(e):s.toNumber(t)+s.toNumber(e);case"%=":return s.toNumber(t)%s.toNumber(e);default:throw new a.ArcadeExecutionError(n,a.ExecutionErrorCodes.UnsupportedOperator,o)}}async function L(e,r){return j(e,r,0)}async function j(e,r,t){if(t>=r.body.length)return s.voidOperation;const o=await M(e,r.body[t]);return o instanceof s.ReturnResult||o===s.breakResult||o===s.continueResult||t===r.body.length-1?o:j(e,r,t+1)}async function G(e,t,o){return o>=t.declarations.length||(await async function(e,t){let o=null;if(o=null===t.init?null:await O(e,t.init),null!==e.localScope){if(o===s.voidOperation&&(o=null),"Identifier"!==t.id.type)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidIdentifier,t);const n=r.toSymbolId(t.id);return void(null!=e.localScope&&(e.localScope[n]={value:o}))}if("Identifier"!==t.id.type)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidIdentifier,t);const n=r.toSymbolId(t.id);o===s.voidOperation&&(o=null),e.globalScope[n]={value:o}}(e,t.declarations[o]),o===t.declarations.length-1||await G(e,t,o+1)),s.voidOperation}function K(e,t){const o=r.toSymbolId(t);if(null!=e.localScope&&void 0!==e.localScope[o])return e.localScope[o].value;if(void 0!==e.globalScope[o])return e.globalScope[o].value;throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.InvalidIdentifier,t)}async function U(e,r){s.pcCheck(null===r.arguments?[]:r.arguments,3,3,e,r);const t=await O(e,r.arguments[0]);if(!1===S.isBoolean(t))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.BooleanConditionRequired,r);return O(e,t?r.arguments[1]:r.arguments[2])}async function Z(e,r){s.pcCheck(null===r.arguments?[]:r.arguments,2,3,e,r);const t=await O(e,r.arguments[0]);if(3===r.arguments.length){const o=await O(e,r.arguments[1]),i=n.getNestedOptionalValue(t,o);return null!=i&&""!==i?i:O(e,r.arguments[2])}return null==t||""===t?O(e,r.arguments[1]):t}async function T(e,r){if(r.arguments.length<2)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.WrongNumberOfParameters,r);if(2===r.arguments.length)return O(e,r.arguments[1]);if((r.arguments.length-1)%2==0)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.WrongNumberOfParameters,r);return q(e,r,1,await O(e,r.arguments[0]))}async function q(e,r,t,o){const n=await O(e,r.arguments[t]);if(s.equalityTest(n,o))return O(e,r.arguments[t+1]);const i=r.arguments.length-t;return 1===i?O(e,r.arguments[t]):2===i?null:3===i?O(e,r.arguments[t+2]):q(e,r,t+2,o)}async function V(e,r){if(r.arguments.length<3)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.WrongNumberOfParameters,r);if(r.arguments.length%2==0)throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.WrongNumberOfParameters,r);const t=await O(e,r.arguments[0]);if(!1===S.isBoolean(t))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.BooleanConditionRequired,r.arguments[0]);return W(e,r,0,t)}async function W(e,r,t,o){if(!0===o)return O(e,r.arguments[t+1]);if(3===r.arguments.length-t)return O(e,r.arguments[t+2]);const n=await O(e,r.arguments[t+2]);if(!1===S.isBoolean(n))throw new a.ArcadeExecutionError(e,a.ExecutionErrorCodes.ModuleExportNotFound,r.arguments[t+2]);return W(e,r,t+2,n)}const z=function(){const e=Object.create(null);f.registerFunctions(e,C),g.registerFunctions(e,C),p.registerFunctions(e,C,K),h.registerFunctions(e,C),x.registerFunctions(e,C),m.registerFunctions(e,C),w.registerFunctions({functions:e,compiled:!1,signatures:null,evaluateIdentifier:null,mode:"async",standardFunction:C,standardFunctionAsync:N}),e.iif=U,e.defaultvalue=Z,e.decode=T,e.when=V;const r=function(){this.textformatting={value:i.textFormatting()}};(r.prototype=Object.create(null)).infinity=Object.freeze({value:Number.POSITIVE_INFINITY}),r.prototype.pi=Object.freeze({value:Math.PI});for(const[t,o]of Object.entries(e))r.prototype[t]=Object.freeze({value:new u.NativeFunction(o)});return r}();function _(e){const r={mode:"async",compiled:!1,functions:Object.create(null),signatures:[],standardFunction:C,standardFunctionAsync:N,evaluateIdentifier:K};for(let t=0;t<e.length;t++)e[t].registerFunctions(r);for(const[e,t]of Object.entries(r.functions))z.prototype[e]=Object.freeze({value:new u.NativeFunction(t)});for(let e=0;e<r.signatures.length;e++)l.addFunctionDeclaration(r.signatures[e],"async")}function Y(e,r,t){const o=new z;null==e&&(e={}),null==r&&(r={});for(const e in r)o[e]={value:new u.NativeFunction(r[e])};for(const r in e)o[r]={value:S.isGraphic(e[r])?c.createFromGraphic(e[r],t):e[r]};return o}function H(e){console.log(e)}_([E.ArrayFunctions]),_([d.AiFunctions]),e.executeScript=async function(e,t){const n=t.spatialReference??v.WebMercator;let i=null;e.usesModules&&(i=new o.ArcadeModuleLoader(new Map,e.loadedModules));const c=Y(t.vars,t.customfunctions,t.timeZone),u={spatialReference:n,services:t.services,exports:{},libraryResolver:i,abortSignal:t.abortSignal??r.neverAbortedSignal,globalScope:c,console:t.console??H,timeZone:t.timeZone??null,lrucache:t.lrucache,interceptor:t.interceptor,localScope:null,depthCounter:{depth:1}},l=await L(u,e);if(l instanceof s.ReturnResult||l instanceof s.ImplicitResult){const e=l.value;if(s.isVoid(e))return null;if(s.isFunctionParameter(e))throw new a.ArcadeExecutionError(u,a.ExecutionErrorCodes.IllegalResult,null);return e}if(s.isVoid(l))return null;if(l===s.breakResult)throw new a.ArcadeExecutionError(u,a.ExecutionErrorCodes.IllegalResult,null);if(l===s.continueResult)throw new a.ArcadeExecutionError(u,a.ExecutionErrorCodes.IllegalResult,null);throw new a.ArcadeExecutionError(u,a.ExecutionErrorCodes.NeverReach,null)},e.extend=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));