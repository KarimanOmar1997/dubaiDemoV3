// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","./arcadeEnvironment","./ArcadeModule","./ArcadeModuleLoader","./containerUtils","./Dictionary","./executionError","./Feature","./FunctionWrapper","../chunks/languageUtils","./treeAnalysis","../chunks/aiServices","../chunks/array","./functions/date","./functions/feature","./functions/geometry","./functions/geomsync","./functions/maths","./functions/stats","./functions/string","../core/compilerUtils","../core/promiseUtils","../geometry/Geometry","../geometry/SpatialReference","../support/guards"],(function(e,r,n,t,o,l,a,i,c,s,u,d,p,m,g,f,E,h,y,b,x,w,v,C,S,A){"use strict";function $(e){return e.symbols.symbolCounter++,`_T${e.symbols.symbolCounter}`}function F(e){return e.symbols.symbolCounter++,`_Tvar${e.symbols.symbolCounter}`}function M(e,r,n,t=i.ExecutionErrorCodes.InvalidIdentifier){const o=e.localScope?.variables.get(r);if(null!=o)return{type:"local",var:o};if(e.globalScope.provided.has(r))return{type:"global",var:r};const l=e.globalScope.variables.get(r);if(null!=l)return{type:"global",var:l};if(null!=e.localScope){const t=e.undeclaredGlobalsInFunctions.get(r);if(null!=t)return{type:"undeclared-global",var:t.mangledName};const o={mangledName:$(e),node:n};return e.undeclaredGlobalsInFunctions.set(r,o),{type:"undeclared-global",var:o.mangledName}}throw new i.ArcadeCompilationError(null,t,n)}function N(e,r){if(null!=e.localScope){let n=e.localScope?.variables.get(r);return null==n&&(n=$(e),e.localScope.variables.set(r,n),e.mangleMap[r]=n),{type:"local",var:n}}if(e.globalScope.provided.has(r))return{type:"global",var:r};let n=e.globalScope.variables.get(r);if(null!=n)return{type:"global",var:n};if(e.undeclaredGlobalsInFunctions.has(r)){const n=e.undeclaredGlobalsInFunctions.get(r).mangledName;return e.globalScope.variables.set(r,n),e.mangleMap[r]=n,e.undeclaredGlobalsInFunctions.delete(r),{type:"resolved-undeclared-global",var:n}}return n=$(e),e.globalScope.variables.set(r,n),e.mangleMap[r]=n,{type:"global",var:n}}class O extends s.ArcadeFunction{constructor(e,r){super(),this.paramCount=r,this.fn=e}createFunction(e){return(...r)=>{if(r.length!==this.paramCount)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.WrongNumberOfParameters,null);return this.fn(...r)}}call(e,r){return this.fn(...r.arguments)}marshalledCall(e,r,n,t){return t(e,r,((r,o,l)=>{l=l.map((r=>!u.isFunctionParameter(r)||r instanceof s.ScopeMarshalledFunction?r:s.wrapModuleScopedResponse(r,e,t)));const a=this.call(n,{arguments:l});return v.isPromiseLike(a)?a.then((e=>s.wrapModuleScopedResponse(e,n,t))):a}))}}function I(e,r,n){try{return n(e,null,r.arguments)}catch(e){throw e}}function k(e,r){switch(r.type){case"AssignmentExpression":return function(e,r){const t=k(e,r.right);if("MemberExpression"===r.left.type){let n;const o=k(e,r.left.object);return!0===r.left.computed?n=k(e,r.left.property):(n="'"+r.left.property.name+"'",j(r.left.property.name)),"lang.assignmember("+o+","+n+",'"+r.operator+"',"+t+")"}const o=n.toSymbolId(r.left);j(o);const l=M(e,o,r.left);switch(l.type){case"local":return`lscope['${l.var}']=lang.assign(${t},'${r.operator}', lscope['${l.var}'])`;case"global":return`gscope['${l.var}']=lang.assign(${t},'${r.operator}', gscope['${l.var}'])`;case"undeclared-global":return`gscope[lang.chkAssig('${l.var}',runtimeCtx)]=lang.assign(${t},'${r.operator}', gscope['${l.var}'])`;default:throw w.neverReached(l.type),new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r.left)}}(e,r);case"UpdateExpression":return function(e,r){if("CallExpression"===r.argument.type)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r);let t;if("MemberExpression"===r.argument.type){const n=k(e,r.argument.object);return!0===r.argument.computed?t=k(e,r.argument.property):(j(r.argument.property.name),t="'"+r.argument.property.name+"'"),"lang.memberupdate("+n+","+t+",'"+r.operator+"',"+r.prefix+")"}const o=n.toSymbolId(r.argument);j(o);const l=M(e,o,r.argument);switch(l.type){case"local":return`lang.update(lscope, '${l.var}', '${r.operator}', ${r.prefix})`;case"global":return`lang.update(gscope, '${l.var}', '${r.operator}', ${r.prefix})`;case"undeclared-global":return`lang.update(gscope, lang.chkAssig('${l.var}',runtimeCtx), '${r.operator}', ${r.prefix})`;default:throw w.neverReached(l.type),new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r.argument)}}(e,r);case"TemplateLiteral":return function(e,r){try{const n=[];let t=0;for(const o of r.quasis)n.push(o.value?JSON.stringify(o.value.cooked):JSON.stringify("")),!1===o.tail&&(n.push(r.expressions[t]?"lang.castString(lang.aCheck("+k(e,r.expressions[t])+", 'TemplateLiteral'))":""),t++);return"(["+n.join(",")+"]).join('')"}catch(e){throw e}}(e,r);case"Identifier":return function(e,r){const t=n.toSymbolId(r);j(t);const o=M(e,t,r);switch(o.type){case"local":return`lscope['${o.var}']`;case"global":return`gscope['${o.var}']`;case"undeclared-global":return`gscope[lang.chkAssig('${o.var}',runtimeCtx)]`;default:throw w.neverReached(o.type),new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r)}}(e,r);case"MemberExpression":return function(e,r){try{let n;return!0===r.computed?n=k(e,r.property):(j(r.property.name),n="'"+r.property.name+"'"),"lang.member("+k(e,r.object)+","+n+")"}catch(e){throw e}}(e,r);case"Literal":return null===r.value||void 0===r.value?"null":JSON.stringify(r.value);case"CallExpression":return function(e,r){try{if("MemberExpression"===r.callee.type){let n;!0===r.callee.computed?n=k(e,r.callee.property):(j(r.callee.property.name),n="'"+r.callee.property.name+"'");let t="[";for(let n=0;n<r.arguments.length;n++)n>0&&(t+=", "),t+=k(e,r.arguments[n]);return t+="]",e.isAsync?"(yield lang.callModuleFunction("+k(e,r.callee.object)+","+t+","+n+",runtimeCtx))":"lang.callModuleFunction("+k(e,r.callee.object)+","+t+","+n+",runtimeCtx)"}if("Identifier"!==r.callee.type)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.FunctionNotFound,r);const t=n.toSymbolId(r.callee);if("iif"===t)return function(e,r){try{if(3!==r.arguments.length)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.WrongNumberOfParameters,r);const n=F(e);return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${n} = ${k(e,r.arguments[0])};\n\n        if (${n} === true) {\n          return  ${k(e,r.arguments[1])};\n        }\n        else if (${n} === false) {\n          return ${k(e,r.arguments[2])};\n        }\n        else {\n          lang.error('ExecutionErrorCodes.BooleanConditionRequired');\n        }\n      ${e.isAsync?"})}()))":"}()"}`}catch(e){throw e}}(e,r);if("when"===t)return function(e,r){try{if(r.arguments.length<3)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.WrongNumberOfParameters,r);if(r.arguments.length%2==0)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.WrongNumberOfParameters,r);const n=F(e);let t="var ";for(let o=0;o<r.arguments.length-1;o+=2)t+=`${n} = lang.mustBoolean(${k(e,r.arguments[o])}, runtimeCtx);\n      if (${n} === true ) {\n        return ${k(e,r.arguments[o+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        ${t}\n        return ${k(e,r.arguments[r.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(e){throw e}}(e,r);if("defaultvalue"===t)return function(e,r){try{if(r.arguments.length<2||r.arguments.length>3)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.WrongNumberOfParameters,r);const n=F(e),t=F(e);return 3===r.arguments.length?`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n      var ${n} = ${k(e,r.arguments[0])};\n      var ${t} = ${k(e,r.arguments[1])};\n      ${n} = lang.getNestedOptionalValue(${n}, ${t});\n      return ${n} != null && ${n} !== "" ? ${n} : ${k(e,r.arguments[2])};\n      ${e.isAsync?"})}()))":"}()"}`:`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${n} = ${k(e,r.arguments[0])};\n        if (${n} === null) {\n          return  ${k(e,r.arguments[1])};\n        }\n        if (${n} === "") {\n          return  ${k(e,r.arguments[1])};\n        }\n        if (${n} === undefined) {\n          return  ${k(e,r.arguments[1])};\n        }\n        return ${n};\n      ${e.isAsync?"})}()))":"}()"}`}catch(e){throw e}}(e,r);if("decode"===t)return function(e,r){try{if(r.arguments.length<2)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.WrongNumberOfParameters,r);if(2===r.arguments.length)return`(${k(e,r.arguments[1])})`;if((r.arguments.length-1)%2==0)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.WrongNumberOfParameters,r);const n=F(e),t=F(e);let o="var ";for(let l=1;l<r.arguments.length-1;l+=2)o+=`${t} = ${k(e,r.arguments[l])};\n      if (lang.binary(${t}, ${n}, "==") === true ) {\n        return ${k(e,r.arguments[l+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${n} = ${k(e,r.arguments[0])};\n        ${o}\n        return ${k(e,r.arguments[r.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(e){throw e}}(e,r);const o=M(e,t,r.callee,i.ExecutionErrorCodes.FunctionNotFound);let l;switch(o.type){case"local":l=`lscope['${o.var}']`;break;case"global":l=`gscope['${o.var}']`;break;case"undeclared-global":l=`gscope[lang.chkAssig('${o.var}',runtimeCtx)]`;break;default:throw w.neverReached(o.type),new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r.callee)}let a="[";for(let n=0;n<r.arguments.length;n++)n>0&&(a+=", "),a+=k(e,r.arguments[n]);return a+="]",e.isAsync?"(yield lang.callfunc("+l+","+a+",runtimeCtx) )":"lang.callfunc("+l+","+a+",runtimeCtx)"}catch(e){throw e}}(e,r);case"UnaryExpression":return function(e,r){try{return"lang.unary("+k(e,r.argument)+",'"+r.operator+"')"}catch(e){throw e}}(e,r);case"BinaryExpression":return function(e,r){try{return"lang.binary("+k(e,r.left)+","+k(e,r.right)+",'"+r.operator+"')"}catch(e){throw e}}(e,r);case"LogicalExpression":return function(e,r){try{if("AssignmentExpression"===r.left.type||"UpdateExpression"===r.left.type)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.LogicalExpressionOnlyBoolean,r);if("AssignmentExpression"===r.right.type||"UpdateExpression"===r.right.type)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.LogicalExpressionOnlyBoolean,r);if("&&"===r.operator||"||"===r.operator)return"(lang.logicalCheck("+k(e,r.left)+") "+r.operator+" lang.logicalCheck("+k(e,r.right)+"))";throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.LogicExpressionOrAnd,null)}catch(e){throw e}}(e,r);case"ArrayExpression":return function(e,r){try{const n=[];for(let t=0;t<r.elements.length;t++)"Literal"===r.elements[t].type?n.push(k(e,r.elements[t])):n.push("lang.aCheck("+k(e,r.elements[t])+",'ArrayExpression')");return"["+n.join(",")+"]"}catch(e){throw e}}(e,r);case"ObjectExpression":return function(e,r){let n="lang.dictionary([";for(let t=0;t<r.properties.length;t++){const o=r.properties[t];let l;"Identifier"===o.key.type?(j(o.key.name),l="'"+o.key.name+"'"):l=k(e,o.key),t>0&&(n+=","),n+="lang.strCheck("+l+",'ObjectExpression'),lang.aCheck("+k(e,o.value)+", 'ObjectExpression')"}return n+="])",n}(e,r);default:throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.Unrecognized,r)}}function R(e,r){switch(r.type){case"EmptyStatement":return"lc.voidOperation";case"VariableDeclaration":return function(e,r){const n=[];for(let t=0;t<r.declarations.length;t++)n.push(U(e,r.declarations[t]));return n.join("\n")+" \n lastStatement=  lc.voidOperation; \n"}(e,r);case"BlockStatement":return P(e,r);case"FunctionDeclaration":return function(e,r){const t=n.toSymbolId(r.id);j(t);const o=N(e,t),l={isAsync:e.isAsync,exports:e.exports,undeclaredGlobalsInFunctions:e.undeclaredGlobalsInFunctions,moduleFactory:e.moduleFactory,moduleFactoryMap:e.moduleFactoryMap,libraryResolver:e.libraryResolver,symbols:e.symbols,mangleMap:e.mangleMap,localScope:{variables:new Map},depthCounter:e.depthCounter,globalScope:e.globalScope};let a="new lang.UserDefinedCompiledFunction( lang.functionDepthchecker(function() { var lastStatement = lc.voidOperation; \n   var lscope = runtimeCtx.localStack[runtimeCtx.localStack.length-1];\n";for(let e=0;e<r.params.length;e++){const t=n.toSymbolId(r.params[e]);j(t);const o=N(l,t);if("local"!==o.type)throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r.params[e]);a+=`lscope['${o.var}']=arguments[${e.toString()}];\n`}switch(!0===e.isAsync?(a+="return lang.__awaiter(this, void 0, void 0, function* () {\n",a+=P(l,r.body)+"\n return lastStatement; ",a+="});  }",a+=", runtimeCtx),"+r.params.length+")",a+="\n lastStatement = lc.voidOperation; \n"):(a+=P(l,r.body)+"\n return lastStatement; }, runtimeCtx),"+r.params.length+")",a+="\n lastStatement = lc.voidOperation; \n"),o.type){case"global":return`gscope['${o.var}']=${a}`;case"resolved-undeclared-global":return`gscope[lang.setAssig('${o.var}', runtimeCtx)]=${a}`;default:throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r.id)}}(e,r);case"ImportDeclaration":return function(e,r){const t=n.toSymbolId(r.specifiers[0].local);j(t);const l=e.libraryResolver?.loadLibrary(t),a=$(e);void 0===e.moduleFactory[l.uri]&&(e.moduleFactory[l.uri]=function(e,r,t){const l={isAsync:t,moduleFactory:r.moduleFactory,moduleFactoryMap:{},libraryResolver:new o.ArcadeModuleLoader(null,e.loadedModules),globalScope:{provided:Z(t,null,null),variables:new Map},localScope:null,mangleMap:{},undeclaredGlobalsInFunctions:new Map,depthCounter:{depth:1},exports:{},symbols:{symbolCounter:0}};let a=P(l,e);""===a&&(a="lc.voidOperation; ");let i="";i=t?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+a+"\n return lastStatement; }); } \n yield mainBody(); \n return this.prepareModule(runtimeCtx); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+a+"\n return lastStatement; } \n mainBody(); \n return this.prepareModule(runtimeCtx); ";const c=l.moduleFactory,s=l.moduleFactoryMap,d=l.exports,p={};let m;for(m in d)p[m]=l.mangleMap[m]??m;const g={lc:u.lc,lang:Y,mangles:l.mangleMap,prepareModule:e=>new Q(e),prepare(e,r){const t=e.spatialReference??S.WebMercator,o=z(r,null,null,e.timeZone);return{localStack:[],exports:d,exportmangle:p,gdefs:{},moduleFactory:c,moduleFactoryMap:s,moduleSingletons:e.moduleSingletons,mangleMap:this.mangles,spatialReference:t,globalScope:o,abortSignal:e.abortSignal??n.neverAbortedSignal,services:e.services,console:e.console??H,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,depthCounter:e.depthCounter}}};return new Function("context",i).bind(g)}(l.syntax,{moduleFactory:e.moduleFactory,libraryResolver:e.libraryResolver},e.isAsync)),e.moduleFactoryMap[a]=l.uri;let c="";c=e.isAsync?"(yield lang.loadModule('"+a+"', runtimeCtx) ); ":"lang.loadModule('"+a+"', runtimeCtx); ";const s=N(e,t);switch(s.type){case"global":return`gscope['${s.var}']=${c}`;case"resolved-undeclared-global":return`gscope[lang.setAssig('${s.var}', runtimeCtx)]=${c}`;default:throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r.specifiers[0].local)}}(e,r);case"ExportNamedDeclaration":return function(e,r){const t=R(e,r.declaration);if("FunctionDeclaration"===r.declaration.type)e.exports[n.toSymbolId(r.declaration.id)]="function";else if("VariableDeclaration"===r.declaration.type)for(const t of r.declaration.declarations)e.exports[n.toSymbolId(t.id)]="variable";return t}(e,r);case"ReturnStatement":return function(e,r){return null===r.argument?"return lc.voidOperation":"return "+k(e,r.argument)}(e,r);case"IfStatement":return G(e,r);case"ExpressionStatement":return function(e,r){return"AssignmentExpression"===r.expression.type?"lastStatement = lc.voidOperation; "+k(e,r.expression)+"; \n ":"lastStatement = "+k(e,r.expression)+"; "}(e,r);case"BreakStatement":return"break";case"ContinueStatement":return"continue";case"ForStatement":return function(e,r){let n="lastStatement = lc.voidOperation; \n";null!==r.init&&("VariableDeclaration"===r.init.type?n+=R(e,r.init):n+=k(e,r.init)+"; ");const t=F(e),o=F(e);return n+="var "+t+" = true; ",n+="\n do { ",null!==r.update&&(n+=" if ("+t+"===false) {\n "+k(e,r.update)+"  \n}\n "+t+"=false; \n"),null!==r.test&&(n+="var "+o+" = "+k(e,r.test)+"; ",n+="if ("+o+"===false) { break; } else if ("+o+"!==true) { lang.error('"+i.ExecutionErrorCodes.BooleanConditionRequired+"');   }\n"),n+=R(e,r.body),null!==r.update&&(n+="\n "+k(e,r.update)),n+="\n"+t+" = true; \n} while(true);  lastStatement = lc.voidOperation; ",n}(e,r);case"ForInStatement":return function(e,r){const t=F(e);let o="var "+t+" = "+k(e,r.right)+";\n";"VariableDeclaration"===r.left.type&&(o+=R(e,r.left));const l=n.toSymbolId("VariableDeclaration"===r.left.type?r.left.declarations[0].id:r.left);j(l);const a=M(e,l,r.left);let c;switch(a.type){case"local":c=`lscope['${a.var}']`;break;case"global":c=`gscope['${a.var}']`;break;case"undeclared-global":c=`gscope['${a.var}']`,o+="lang.chkAssig('"+a.var+"',runtimeCtx); \n";break;default:throw w.neverReached(a.type),new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r.left)}return o+="if ("+t+"===null) {  lastStatement = lc.voidOperation; }\n ",o+="else if (lc.isArray("+t+") || lc.isString("+t+")) {\n",o+=B(e,c,`${t}.length`,r.body),o+="}\n",o+="else if (lc.isImmutableArray("+t+")) {\n",o+=B(e,c,`${t}.length()`,r.body),o+="}\n",o+="else if (( "+t+" instanceof lang.Dictionary) || lc.isDictionaryLike("+t+")) {\n",o+=L(e,c,`${t}.keys()`,r.body),o+="}\n",e.isAsync&&(o+="else if (lc.isFeatureSet("+t+")) {\n",o+=_(e,c,t,r.body),o+="}\n"),o+=`else if (lc.isGeometry(${t})) {\n`,o+=L(e,c,`lang.getGeometryKeys(${t})`,r.body),o+="}\n",o+="else { lastStatement = lc.voidOperation; } \n",o}(e,r);case"ForOfStatement":return function(e,r){const t=F(e);let o="var "+t+" = "+k(e,r.right)+";\n";"VariableDeclaration"===r.left.type&&(o+=R(e,r.left));const l=n.toSymbolId("VariableDeclaration"===r.left.type?r.left.declarations[0].id:r.left);j(l);const a=M(e,l,r.left);let c;switch(a.type){case"local":c=`lscope['${a.var}']`;break;case"global":c=`gscope['${a.var}']`;break;case"undeclared-global":c=`gscope['${a.var}']`,o+="lang.chkAssig('"+a.var+"',runtimeCtx); \n";break;default:throw w.neverReached(a.type),new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r.left)}return o+="if ("+t+"===null) {  lastStatement = lc.voidOperation; }\n ",o+="else if (lc.isArray("+t+") || lc.isString("+t+")) {\n",o+=B(e,c,`${t}.length`,r.body,((e,r)=>[`if (${r} >= ${t}.length) {`,`  lang.error('${i.ExecutionErrorCodes.OutOfBounds}');`,"}",`${e} = ${t}[${r}];`].join("\n"))),o+="}\n",o+="else if (lc.isImmutableArray("+t+")) {\n",o+=B(e,c,`${t}.length()`,r.body,((e,r)=>`${e} = ${t}.get(${r});`)),o+="}\n",o+="else if (( "+t+" instanceof lang.Dictionary) || lc.isDictionaryLike("+t+")) {\n",o+=L(e,c,`${t}.keys()`,r.body,(e=>`lang.entry(${e}, ${t}.field(${e}))`)),o+="}\n",e.isAsync&&(o+="else if (lc.isFeatureSet("+t+")) {\n",o+=_(e,c,t,r.body),o+="}\n"),o+=`else if (lc.isGeometry(${t})) {\n`,o+=L(e,c,`lang.getGeometryKeys(${t})`,r.body,(e=>`lang.entry(${e}, lang.geometryMember(${t}, ${e}, runtimeCtx, null, 1))`)),o+="}\n",o+="else { lastStatement = lc.voidOperation; } \n",o}(e,r);case"WhileStatement":return function(e,r){let n="lastStatement = lc.voidOperation; \n";const t=F(e);return n+=`\n  var ${t} = true;\n    do {\n      ${t} = ${k(e,r.test)};\n      if (${t}==false) {\n        break;\n      }\n      if (${t}!==true) {\n        lang.error('${i.ExecutionErrorCodes.BooleanConditionRequired}');\n      }\n      ${R(e,r.body)}\n    }\n    while (${t} !== false);\n    lastStatement = lc.voidOperation;\n  `,n}(e,r);default:throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.Unrecognized,r)}}function B(e,r,n,t,o=(e,r)=>`${e} = ${r}`){const l=F(e),a=F(e);return[`var ${l} = ${n};`,`for (var ${a} = 0; ${a} < ${l}; ${a}++) {`,`  ${o(r,a)}`,`  ${R(e,t)}`,"}","lastStatement = lc.voidOperation;"].join("\n")}function L(e,r,n,t,o=e=>e){const l=F(e),a=F(e);return[`var ${l} = ${n};`,`for (var ${a} of ${l}) {`,`  ${r} = ${o(a)};`,`  ${R(e,t)}`,"}","lastStatement = lc.voidOperation;"].join("\n")}function _(e,r,n,t){const o=F(e);return[`var ${o} = ${n}.iterator(runtimeCtx.abortSignal);`,`while ((${r} = lang.graphicToFeature(yield ${o}.next(), ${n}, runtimeCtx)) != null) {`,`  ${R(e,t)}`,"}","lastStatement = lc.voidOperation;"].join("\n")}function D(e,r){return"BlockStatement"===r.type?R(e,r):"ReturnStatement"===r.type||"BreakStatement"===r.type||"ContinueStatement"===r.type?R(e,r)+"; ":"ExpressionStatement"===r.type?R(e,r):R(e,r)+"; "}function G(e,r){return`if (lang.mustBoolean(${k(e,r.test)}, runtimeCtx) === true) {\n    ${D(e,r.consequent)}\n  } `+(null!==r.alternate?"IfStatement"===r.alternate.type?" else "+G(e,r.alternate):` else {\n      ${D(e,r.alternate)}\n    }\n`:" else {\n      lastStatement = lc.voidOperation;\n    }\n")}function P(e,r){let n="";for(let t=0;t<r.body.length;t++)"EmptyStatement"!==r.body[t].type&&("ReturnStatement"===r.body[t].type||"BreakStatement"===r.body[t].type||"ContinueStatement"===r.body[t].type?n+=R(e,r.body[t])+"; \n":n+=R(e,r.body[t])+" \n");return n}function j(e){if("iif"===e)throw new i.ArcadeUncompilableError;if("decode"===e)throw new i.ArcadeUncompilableError;if("when"===e)throw new i.ArcadeUncompilableError;if("defaultvalue"===e)throw new i.ArcadeUncompilableError}function U(e,r){const t=null===r.init?"null":k(e,r.init),o=n.toSymbolId(r.id);j(o);const l=N(e,o);switch(l.type){case"local":return`lscope['${l.var}']=${t};`;case"global":return`gscope['${l.var}']=${t};`;case"resolved-undeclared-global":return`gscope[lang.setAssig('${l.var}', runtimeCtx)]=${t};`;default:throw w.neverReached(l.type),new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.NeverReach,r.id)}}function K(e,r){try{return I(e,r,((e,r)=>{throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.Unrecognized,r)}))}catch(e){throw e}}function T(e){const r=function(){this._SymbolsMap=new Set(["textformatting","infinity","pi"]),this.textformatting=a.textFormatting()};r.prototype=Object.create(null),r.provided=new Set(["textformatting","infinity","pi"]),r.prototype.infinity=Number.POSITIVE_INFINITY,r.prototype.pi=Math.PI;for(const[n,t]of Object.entries(e))r.prototype[n]=new s.NativeFunction(t),r.provided.add(n);return r}const{ScopeSync:W,ScopeAsync:V}=function(){const e=Object.create(null);g.registerFunctions(e,I),x.registerFunctions(e,I),f.registerFunctions(e,I,J),y.registerFunctions(e,I),E.registerFunctions(e,I),b.registerFunctions(e,I),e.iif=K,e.decode=K,e.when=K,e.defaultvalue=K;const r=T(e);return h.registerFunctions(e,I),{ScopeSync:T(e),ScopeAsync:r}}();function q(e,r){const n={mode:r,compiled:!0,functions:Object.create(null),signatures:[],standardFunction:I,standardFunctionAsync:I,evaluateIdentifier:J};for(const r of e)r.registerFunctions(n);if("sync"===r)for(const[e,r]of Object.entries(n.functions))W.prototype[e]=new s.NativeFunction(r),W.provided.add(e);else for(const[e,r]of Object.entries(n.functions))V.prototype[e]=new s.NativeFunction(r),V.provided.add(e);for(const e of n.signatures)d.addFunctionDeclaration(e,r)}function Z(e,r,n){const t=new Set(e?V.provided:W.provided);for(const e in n)t.add(e);for(const e in r)t.add(e);return t}function z(e,r,n,t){const o=e?new V:new W;for(const e in n)o[e]=n[e],o._SymbolsMap.add(e);for(const e in r){const n=r[e];o._SymbolsMap.add(e),A.isGraphic(n)?o[e]=c.createFromGraphic(n,t??null):o[e]=n}return o}function J(e,r){const n=r.name;if("_SymbolsMap"===n)throw new i.ArcadeExecutionError(e,i.ExecutionErrorCodes.InvalidIdentifier,null);if(e.localStack.length>0){const r=e.localStack[e.localStack.length-1];if(!n.toLowerCase().startsWith("_t")&&void 0!==r[n])return r[n];const t=e.mangleMap[n];if(void 0!==t&&void 0!==r[t])return r[t]}if(!n.toLowerCase().startsWith("_t")&&void 0!==e.globalScope[n])return e.globalScope[n];if(e.globalScope._SymbolsMap.has(n))return e.globalScope[n];const t=e.mangleMap[n];return void 0!==t?e.globalScope[t]:void 0}q([m.ArrayFunctions],"sync"),q([m.ArrayFunctions],"async"),q([p.AiFunctions],"async");const Y={isNumber:e=>A.isNumber(e),isArray:e=>A.isArray(e),isImmutableArray:e=>u.isImmutableArray(e),isDictionaryLike:e=>u.isDictionaryLike(e),isString:e=>A.isString(e),isDictionary:e=>u.isDictionary(e),isGeometry:e=>u.isGeometry(e),getGeometryKeys:e=>l.getGeometryKeys(e),geometryMember:(e,r,n,t,o=1)=>l.geometryMember(e,r,n,t,o),error(e){throw new i.ArcadeExecutionError(null,e,null)},__awaiter(e,r,n,t){const o=t.apply(e,r||[]);let l=o.next();for(;!l.done&&!v.isPromiseLike(l.value);)l=o.next(l.value);return l.done?l.value:new Promise(((e,r)=>{!function n(t){for(;!t.done;){if(v.isPromiseLike(t.value))return void Promise.resolve(t.value).then((e=>{try{n(o.next(e))}catch(e){r(e)}}),(e=>{try{n(o.throw(e))}catch(e){r(e)}}));try{t=o.next(t.value)}catch(e){return void r(e)}}e(t.value)}(l)}))},functionDepthchecker:(e,r)=>function(){if(r.depthCounter.depth++,r.localStack.push({}),r.depthCounter.depth>64)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.MaximumCallDepth,null);const n=e.apply(this,arguments);return v.isPromiseLike(n)?n.then((e=>(r.depthCounter.depth--,r.localStack.length=r.localStack.length-1,e))):(r.depthCounter.depth--,r.localStack.length=r.localStack.length-1,n)},chkAssig(e,r){if(void 0===r.gdefs[e])throw new i.ArcadeExecutionError(r,i.ExecutionErrorCodes.InvalidIdentifier,null);return e},mustBoolean(e,r){if(!0===e||!1===e)return e;throw new i.ArcadeExecutionError(r,i.ExecutionErrorCodes.BooleanConditionRequired,null)},setAssig:(e,r)=>(r.gdefs[e]=1,e),castString:e=>u.toString(e),aCheck(e,r){if(u.isFunctionParameter(e)){if("ArrayExpression"===r)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.NoFunctionInArray,null);if("ObjectExpression"===r)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.NoFunctionInDictionary,null);throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.NoFunctionInTemplateLiteral,null)}return e===u.voidOperation?null:e},Dictionary:a,Feature:c,UserDefinedCompiledFunction:O,dictionary(e){const r=Object.create(null),n=new Map;for(let t=0;t<e.length;t+=2){if(u.isFunctionParameter(e[t+1]))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.NoFunctionInDictionary,null);if(!1===A.isString(e[t]))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.KeyMustBeString,null);let o=e[t].toString();const l=o.toLowerCase();n.has(l)?o=n.get(l):n.set(l,o),e[t+1]===u.voidOperation?r[o]=null:r[o]=e[t+1]}const t=new a(r);return t.immutable=!1,t},entry:(e,r)=>a.containerEntry(e,r),strCheck(e){if(!1===A.isString(e))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.KeyMustBeString,null);return e},unary(e,r){if(A.isBoolean(e)){if("!"===r)return!e;if("-"===r)return-1*u.toNumber(e);if("+"===r)return 1*u.toNumber(e);if("~"===r)return~u.toNumber(e);throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.UnsupportedUnaryOperator,null)}if("-"===r)return-1*u.toNumber(e);if("+"===r)return 1*u.toNumber(e);if("~"===r)return~u.toNumber(e);throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.UnsupportedUnaryOperator,null)},logicalCheck(e){if(!1===A.isBoolean(e))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.LogicExpressionOrAnd,null);return e},logical(e,r,n){if(A.isBoolean(e)&&A.isBoolean(r))switch(n){case"||":return e||r;case"&&":return e&&r;default:throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.LogicExpressionOrAnd,null)}throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.LogicExpressionOrAnd,null)},binary(e,r,n){switch(n){case"|":case"<<":case">>":case">>>":case"^":case"&":return u.binaryOperator(u.toNumber(e),u.toNumber(r),n);case"==":case"=":return u.equalityTest(e,r);case"!=":return!u.equalityTest(e,r);case"<":case">":case"<=":case">=":return u.greaterThanLessThan(e,r,n);case"+":return A.isString(e)||A.isString(r)?u.toString(e)+u.toString(r):u.toNumber(e)+u.toNumber(r);case"-":return u.toNumber(e)-u.toNumber(r);case"*":return u.toNumber(e)*u.toNumber(r);case"/":return u.toNumber(e)/u.toNumber(r);case"%":return u.toNumber(e)%u.toNumber(r);default:throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.UnsupportedOperator,null)}},assign(e,r,n){switch(r){case"=":return e===u.voidOperation?null:e;case"/=":return u.toNumber(n)/u.toNumber(e);case"*=":return u.toNumber(n)*u.toNumber(e);case"-=":return u.toNumber(n)-u.toNumber(e);case"+=":return A.isString(n)||A.isString(e)?u.toString(n)+u.toString(e):u.toNumber(n)+u.toNumber(e);case"%=":return u.toNumber(n)%u.toNumber(e);default:throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.UnsupportedOperator,null)}},update(e,r,n,t){const o=u.toNumber(e[r]);return e[r]="++"===n?o+1:o-1,!1===t?o:"++"===n?o+1:o-1},graphicToFeature:(e,r,n)=>null===e?null:c.createFromGraphicLikeObject(e.geometry,e.attributes,r,n.timeZone),memberupdate(e,r,n,t){let o;if(A.isArray(e)){if(!A.isNumber(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.ArrayAccessorMustBeNumber,null);if(r<0&&(r=e.length+r),r<0||r>=e.length)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.OutOfBounds,null);o=u.toNumber(e[r]),e[r]="++"===n?o+1:o-1}else if(e instanceof a){if(!1===A.isString(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.KeyAccessorMustBeString,null);if(!0!==e.hasField(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.FieldNotFound,null,{key:r});o=u.toNumber(e.field(r)),e.setField(r,"++"===n?o+1:o-1)}else if(u.isFeature(e)){if(!1===A.isString(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.KeyAccessorMustBeString,null);if(!0!==e.hasField(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.FieldNotFound,null);o=u.toNumber(e.field(r)),e.setField(r,"++"===n?o+1:o-1)}else{if(u.isImmutableArray(e))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.Immutable,null);if(!(e instanceof Q))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidIdentifier,null);if(!1===A.isString(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.ModuleAccessorMustBeString,null);if(!0!==e.hasGlobal(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.ModuleExportNotFound,null);o=u.toNumber(e.global(r)),e.setGlobal(r,"++"===n?o+1:o-1)}return!1===t?o:"++"===n?o+1:o-1},assignmember(e,r,n,t){if(A.isArray(e)){if(!A.isNumber(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.ArrayAccessorMustBeNumber,null);if(r<0&&(r=e.length+r),r<0||r>e.length)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.OutOfBounds,null);if(r===e.length){if("="!==n)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.OutOfBounds,null);e[r]=this.assign(t,n,e[r])}else e[r]=this.assign(t,n,e[r])}else if(e instanceof a){if(!1===A.isString(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.KeyAccessorMustBeString,null);if(!0===e.hasField(r))e.setField(r,this.assign(t,n,e.field(r)));else{if("="!==n)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.FieldNotFound,null);e.setField(r,this.assign(t,n,null))}}else if(u.isFeature(e)){if(!1===A.isString(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.KeyAccessorMustBeString,null);if(!0===e.hasField(r))e.setField(r,this.assign(t,n,e.field(r)));else{if("="!==n)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.FieldNotFound,null);e.setField(r,this.assign(t,n,null))}}else{if(u.isImmutableArray(e))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.Immutable,null);if(!(e instanceof Q))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidIdentifier,null);if(!1===A.isString(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.ModuleAccessorMustBeString,null);if(!e.hasGlobal(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.ModuleExportNotFound,null);e.setGlobal(r,this.assign(t,n,e.global(r)))}},member(e,r){if(null===e)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.MemberOfNull,null);if(e instanceof a||u.isDictionaryLike(e)){if(A.isString(r))return e.field(r);throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(e instanceof C){if(A.isString(r))return l.geometryMember(e,r,null,null);throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(A.isArray(e)){if(A.isNumber(r)&&isFinite(r)&&Math.floor(r)===r){if(r<0&&(r=e.length+r),r>=e.length||r<0)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.OutOfBounds,null);return e[r]}throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(A.isString(e)){if(A.isNumber(r)&&isFinite(r)&&Math.floor(r)===r){if(r<0&&(r=e.length+r),r>=e.length||r<0)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.OutOfBounds,null);return e[r]}throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(u.isImmutableArray(e)){if(A.isNumber(r)&&isFinite(r)&&Math.floor(r)===r){if(r<0&&(r=e.length()+r),r>=e.length()||r<0)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.OutOfBounds,null);return e.get(r)}throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidMemberAccessKey,null)}if(e instanceof Q){if(A.isString(r))return e.global(r);throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidMemberAccessKey,null)}throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidMemberAccessKey,null)},callfunc:(e,r,n)=>e.call(n,{arguments:r,preparsed:!0}),loadModule(e,r){const n=r.moduleFactoryMap[e];if(r.moduleSingletons[n])return r.moduleSingletons[n];const t=r.moduleFactory[n]({moduleSingletons:r.moduleSingletons,depthCounter:r.depthCounter,lrucache:r.lrucache,interceptor:r.interceptor,services:r.services,console:r.console,abortSignal:r.abortSignal,timeZone:r.timeZone??null,spatialReference:r.spatialReference});return r.moduleSingletons[n]=t,t},callModuleFunction(e,r,n,t){if(!(e instanceof Q))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.FunctionNotFound,null);const o=e.global(n);if(!1===u.isFunctionParameter(o))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.CallNonFunction,null);return o.call(t,{preparsed:!0,arguments:r})},getNestedOptionalValue:(e,r)=>l.getNestedOptionalValue(e,r)};function H(e){console.log(e)}class Q extends t.ArcadeModule{constructor(e){super(),this.moduleContext=e}hasGlobal(e){return void 0===this.moduleContext.exports[e]&&(e=e.toLowerCase()),void 0!==this.moduleContext.exports[e]}setGlobal(e,r){const n=this.moduleContext.globalScope,t=e.toLowerCase();if(u.isFunctionParameter(r))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.AssignModuleFunction,null);n[this.moduleContext.exportmangle[t]]=r}global(e){const r=this.moduleContext.globalScope,n=e.toLowerCase(),t=r[this.moduleContext.exportmangle[n]];if(void 0===t)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.InvalidIdentifier,null);if(u.isFunctionParameter(t)&&!(t instanceof s.ScopeMarshalledFunction)){const e=new s.ScopeMarshalledFunction;return e.fn=t,e.parameterEvaluator=I,e.context=this.moduleContext,r[this.moduleContext.exportmangle[n]]=e,e}return t}}r.UserDefinedCompiledFunction=O,r.compileScript=function(e,r,t=!1){null==r&&(r={vars:{},customfunctions:{}});let l=null;e.usesModules&&(l=new o.ArcadeModuleLoader(null,e.loadedModules));const a={isAsync:t,globalScope:{provided:Z(t,r.vars,r.customfunctions),variables:new Map},moduleFactory:{},moduleFactoryMap:{},undeclaredGlobalsInFunctions:new Map,libraryResolver:l,localScope:null,mangleMap:{},depthCounter:{depth:1},exports:{},symbols:{symbolCounter:0}};let c=P(a,e);""===c&&(c="lc.voidOperation; "),a.undeclaredGlobalsInFunctions.size>0&&a.undeclaredGlobalsInFunctions.forEach((e=>{throw new i.ArcadeCompilationError(null,i.ExecutionErrorCodes.InvalidIdentifier,e.node)}));let s="";s=t?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+c+"\n return lastStatement; }); } \n return this.postProcess(yield mainBody()); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+c+"\n return lastStatement; } \n return this.postProcess(mainBody()); ";const d=a.moduleFactory,p=a.moduleFactoryMap,m=a.exports,g={};let f;for(f in m)g[f]=a.mangleMap[f]??f;const E={lc:u.lc,lang:Y,mangles:a.mangleMap,postProcess(e){if(e instanceof u.ReturnResult&&(e=e.value),e instanceof u.ImplicitResult&&(e=e.value),e===u.voidOperation&&(e=null),e===u.breakResult)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.IllegalResult,null);if(e===u.continueResult)throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.IllegalResult,null);if(u.isFunctionParameter(e))throw new i.ArcadeExecutionError(null,i.ExecutionErrorCodes.IllegalResult,null);return e},prepare(e,r){const t=e.spatialReference??S.WebMercator,o=z(r,e.vars,e.customfunctions,e.timeZone);return{localStack:[],moduleFactory:d,moduleFactoryMap:p,mangleMap:this.mangles,moduleSingletons:{},exports:m,gdefs:{},exportmangle:g,spatialReference:t,globalScope:o,abortSignal:e.abortSignal??n.neverAbortedSignal,services:e.services,console:e.console??H,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,depthCounter:{depth:1}}}};return new Function("context",s).bind(E)},r.enableAsyncSupport=async function(){return q([await new Promise(((r,n)=>e(["./functions/geomasync"],r,n)))],"async"),!0},r.extend=q,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));