// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","./arcadeEnvironment","./ArcadeModule","./ArcadeModuleLoader","./containerUtils","./Dictionary","./executionError","./Feature","./FunctionWrapper","../chunks/languageUtils","./treeAnalysis","../chunks/array","./functions/date","./functions/feature","./functions/geometry","./functions/geomsync","./functions/maths","./functions/stats","./functions/string","../core/has","../geometry/Geometry","../geometry/SpatialReference","../support/guards"],(function(e,r,t,o,n,i,c,a,u,s,l,d,E,f,p,h,x,w,b,m,g,y,v){"use strict";class A extends u.ArcadeFunction{constructor(e,r){super(),this.definition=e,this.context=r}createFunction(e){return(...r)=>{const t={spatialReference:this.context.spatialReference,console:this.context.console,services:this.context.services,timeZone:this.context.timeZone??null,lrucache:this.context.lrucache,exports:this.context.exports,libraryResolver:this.context.libraryResolver,interceptor:this.context.interceptor,abortSignal:this.context.abortSignal,localScope:{},depthCounter:{depth:e.depthCounter.depth+1},globalScope:this.context.globalScope};if(t.depthCounter.depth>64)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.MaximumCallDepth,null);return S(this.definition,t,r,null)}}call(e,r){return R(e,r,((t,o,n)=>{const i={spatialReference:e.spatialReference,services:e.services,globalScope:e.globalScope,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,timeZone:e.timeZone??null,console:e.console,lrucache:e.lrucache,interceptor:e.interceptor,abortSignal:e.abortSignal,localScope:{}};if(i.depthCounter.depth>64)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.MaximumCallDepth,r);return S(this.definition,i,n,r)}))}marshalledCall(e,r,t,o){return o(e,r,((n,i,c)=>{const a={spatialReference:e.spatialReference,globalScope:t.globalScope,services:e.services,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,console:e.console,timeZone:e.timeZone??null,lrucache:e.lrucache,interceptor:e.interceptor,abortSignal:e.abortSignal,localScope:{}};return c=c.map((r=>!s.isFunctionParameter(r)||r instanceof u.ScopeMarshalledFunction?r:u.wrapModuleScopedResponse(r,e,o))),u.wrapModuleScopedResponse(S(this.definition,a,c,r),t,o)}))}}function S(e,t,o,n){try{const i=e.body;if(o.length!==e.params.length)throw new c.ArcadeExecutionError(t,c.ExecutionErrorCodes.WrongNumberOfParameters,n);if(null!=t.localScope)for(let n=0;n<o.length;n++)t.localScope[r.toSymbolId(e.params[n])]={value:o[n]};const a=N(t,i);if(a instanceof s.ReturnResult)return a.value;if(a===s.breakResult)throw new c.ArcadeExecutionError(t,c.ExecutionErrorCodes.UnexpectedToken,n);if(a===s.continueResult)throw new c.ArcadeExecutionError(t,c.ExecutionErrorCodes.UnexpectedToken,n);return a instanceof s.ImplicitResult?a.value:a}catch(e){throw e}}class C extends t.ArcadeModule{constructor(e){super(),this.source=e}global(e){const t=this.executingContext.globalScope[r.toSymbolId(e)];if(s.isFunctionParameter(t.value)&&!(t.value instanceof u.ScopeMarshalledFunction)){const o=new u.ScopeMarshalledFunction;return o.fn=t.value,o.parameterEvaluator=R,o.context=this.executingContext,this.executingContext.globalScope[r.toSymbolId(e)]={value:o},o}return t.value}setGlobal(e,t){if(s.isFunctionParameter(t))throw new c.ArcadeExecutionError(null,c.ExecutionErrorCodes.AssignModuleFunction,null);this.executingContext.globalScope[r.toSymbolId(e)]={value:t}}hasGlobal(e){return void 0===this.executingContext.exports[e]&&(e=r.toSymbolId(e)),void 0!==this.executingContext.exports[e]}loadModule(e){const t=e.spatialReference??y.WebMercator;this.moduleScope=V(null,null,e.timeZone),this.executingContext={spatialReference:t,globalScope:this.moduleScope,localScope:null,libraryResolver:new o.ArcadeModuleLoader(e.libraryResolver._moduleSingletons,this.source.syntax.loadedModules),exports:{},services:e.services,console:e.console??W,timeZone:e.timeZone??null,lrucache:e.lrucache,interceptor:e.interceptor,abortSignal:r.neverAbortedSignal,depthCounter:{depth:1}},M(this.executingContext,this.source.syntax)}}function R(e,r,t){try{return!0===r.preparsed?t(e,null,r.arguments):t(e,r,function(e,r){const t=[];for(let o=0;o<r.arguments.length;o++)t.push(F(e,r.arguments[o]));return t}(e,r))}catch(e){throw e}}function F(e,t){try{switch(t.type){case"AssignmentExpression":return function(e,t){if("MemberExpression"===t.left.type){const r=F(e,t.left.object);let o;if(!0===t.left.computed)o=F(e,t.left.property);else{if("Identifier"!==t.left.property.type)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidIdentifier,t);o=t.left.property.name}const n=F(e,t.right);if(v.isArray(r)){if(!v.isNumber(o))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.ArrayAccessorMustBeNumber,t);if(o<0&&(o=r.length+o),o<0||o>r.length)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.OutOfBounds,t);if(o===r.length){if("="!==t.operator)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.OutOfBounds,t);r[o]=O(n,t.operator,r[o],t,e)}else r[o]=O(n,t.operator,r[o],t,e)}else if(r instanceof i){if(!1===v.isString(o))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.KeyAccessorMustBeString,t);if(!0===r.hasField(o))r.setField(o,O(n,t.operator,r.field(o),t,e));else{if("="!==t.operator)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.FieldNotFound,t,{key:o});r.setField(o,O(n,t.operator,null,t,e))}}else if(s.isFeature(r)){if(!1===v.isString(o))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.KeyAccessorMustBeString,t);if(!0===r.hasField(o))r.setField(o,O(n,t.operator,r.field(o),t,e));else{if("="!==t.operator)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.FieldNotFound,t,{key:o});r.setField(o,O(n,t.operator,null,t,e))}}else{if(s.isImmutableArray(r))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.Immutable,t);if(!(r instanceof C))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidIdentifier,t);if(!1===v.isString(o))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.ModuleAccessorMustBeString,t);if(!0!==r.hasGlobal(o))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.ModuleExportNotFound,t);r.setGlobal(o,O(n,t.operator,r.global(o),t,e))}return s.voidOperation}const o=r.toSymbolId(t.left),n=F(e,t.right);if(null!=e.localScope&&void 0!==e.localScope[o])return e.localScope[o]={value:O(n,t.operator,e.localScope[o].value,t,e)},s.voidOperation;if(void 0!==e.globalScope[o])return e.globalScope[o]={value:O(n,t.operator,e.globalScope[o].value,t,e)},s.voidOperation;throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidIdentifier,t)}(e,t);case"UpdateExpression":return function(e,t){if("CallExpression"===t.argument.type)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.NeverReach,t);let o;if("MemberExpression"===t.argument.type){const r=F(e,t.argument.object);let n;if(!0===t.argument.computed)n=F(e,t.argument.property);else{if("Identifier"!==t.argument.property.type)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.Unrecognized,t);n=t.argument.property.name}if(v.isArray(r)){if(!v.isNumber(n))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.ArrayAccessorMustBeNumber,t);if(n<0&&(n=r.length+n),n<0||n>=r.length)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.OutOfBounds,t);o=s.toNumber(r[n]),r[n]="++"===t.operator?o+1:o-1}else if(r instanceof i){if(!1===v.isString(n))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.KeyAccessorMustBeString,t);if(!0!==r.hasField(n))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.FieldNotFound,t);o=s.toNumber(r.field(n)),r.setField(n,"++"===t.operator?o+1:o-1)}else if(s.isFeature(r)){if(!1===v.isString(n))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.KeyAccessorMustBeString,t);if(!0!==r.hasField(n))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.FieldNotFound,t);o=s.toNumber(r.field(n)),r.setField(n,"++"===t.operator?o+1:o-1)}else{if(s.isImmutableArray(r))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.Immutable,t);if(!(r instanceof C))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidParameter,t);if(!1===v.isString(n))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.ModuleAccessorMustBeString,t);if(!0!==r.hasGlobal(n))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.ModuleExportNotFound,t);o=s.toNumber(r.global(n)),r.setGlobal(n,"++"===t.operator?o+1:o-1)}return!1===t.prefix?o:"++"===t.operator?o+1:o-1}const n=r.toSymbolId(t.argument);if(null!=e.localScope&&void 0!==e.localScope[n])return o=s.toNumber(e.localScope[n].value),e.localScope[n]={value:"++"===t.operator?o+1:o-1},!1===t.prefix?o:"++"===t.operator?o+1:o-1;if(void 0!==e.globalScope[n])return o=s.toNumber(e.globalScope[n].value),e.globalScope[n]={value:"++"===t.operator?o+1:o-1},!1===t.prefix?o:"++"===t.operator?o+1:o-1;throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidIdentifier,t)}(e,t);case"TemplateLiteral":return function(e,r){let t="",o=0;for(const n of r.quasis)t+=n.value?n.value.cooked:"",!1===n.tail&&(t+=r.expressions[o]?s.toString(D(F(e,r.expressions[o]),e,r)):"",o++);return t}(e,t);case"Identifier":return P(e,t);case"MemberExpression":return function(e,r){try{const t=F(e,r.object);if(null===t)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.MemberOfNull,r);if(!1===r.computed){if("Identifier"===r.property.type){if(t instanceof i||s.isDictionaryLike(t))return t.field(r.property.name);if(t instanceof g)return n.geometryMember(t,r.property.name,e,r);if(t instanceof C){if(!t.hasGlobal(r.property.name))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidIdentifier,r);return t.global(r.property.name)}}throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidMemberAccessKey,r)}let o=F(e,r.property);if(t instanceof i||s.isDictionaryLike(t)){if(v.isString(o))return t.field(o);throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof C){if(v.isString(o))return t.global(o);throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(t instanceof g){if(v.isString(o))return n.geometryMember(t,o,e,r);throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(v.isArray(t)){if(v.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.OutOfBounds,r);return t[o]}throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(v.isString(t)){if(v.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length+o),o>=t.length||o<0)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.OutOfBounds,r);return t[o]}throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidMemberAccessKey,r)}if(s.isImmutableArray(t)){if(v.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=t.length()+o),o>=t.length()||o<0)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.OutOfBounds,r);return t.get(o)}throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidMemberAccessKey,r)}throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidMemberAccessKey,r)}catch(e){throw e}}(e,t);case"Literal":return t.value;case"CallExpression":return function(e,t){try{if("MemberExpression"===t.callee.type){const r=F(e,t.callee.object);if(!(r instanceof C))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.FunctionNotFound,t);const o=!1===t.callee.computed?t.callee.property.name:F(e,t.callee.property);if(!r.hasGlobal(o))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.FunctionNotFound,t);const n=r.global(o);if(!s.isFunctionParameter(n))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.CallNonFunction,t);return n.call(e,t)}if("Identifier"!==t.callee.type)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.FunctionNotFound,t);const o=r.toSymbolId(t.callee);if(null!=e.localScope&&void 0!==e.localScope[o]){const r=e.localScope[o];if(s.isFunctionParameter(r.value))return r.value.call(e,t);throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.CallNonFunction,t)}if(void 0!==e.globalScope[o]){const r=e.globalScope[o];if(s.isFunctionParameter(r.value))return r.value.call(e,t);throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.CallNonFunction,t)}throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.FunctionNotFound,t)}catch(e){throw e}}(e,t);case"UnaryExpression":return function(e,r){try{const t=F(e,r.argument);if(v.isBoolean(t)){if("!"===r.operator)return!t;if("-"===r.operator)return-1*s.toNumber(t);if("+"===r.operator)return 1*s.toNumber(t);if("~"===r.operator)return~s.toNumber(t);throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}if("~"===r.operator)return~s.toNumber(t);if("-"===r.operator)return-1*s.toNumber(t);if("+"===r.operator)return 1*s.toNumber(t);throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.UnsupportedUnaryOperator,r)}catch(e){throw e}}(e,t);case"BinaryExpression":return function(e,r){try{const t=F(e,r.left),o=F(e,r.right);switch(r.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":return s.binaryOperator(s.toNumber(t),s.toNumber(o),r.operator);case"==":return s.equalityTest(t,o);case"!=":return!s.equalityTest(t,o);case"<":case">":case"<=":case">=":return s.greaterThanLessThan(t,o,r.operator);case"+":return v.isString(t)||v.isString(o)?s.toString(t)+s.toString(o):s.toNumber(t)+s.toNumber(o);case"-":return s.toNumber(t)-s.toNumber(o);case"*":return s.toNumber(t)*s.toNumber(o);case"/":return s.toNumber(t)/s.toNumber(o);case"%":return s.toNumber(t)%s.toNumber(o);default:throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.UnsupportedOperator,r)}}catch(e){throw e}}(e,t);case"LogicalExpression":return function(e,r){try{const t=F(e,r.left);if(v.isBoolean(t))switch(r.operator){case"||":{if(!0===t)return t;const o=F(e,r.right);if(v.isBoolean(o))return o;throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.LogicExpressionOrAnd,r)}case"&&":{if(!1===t)return t;const o=F(e,r.right);if(v.isBoolean(o))return o;throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.LogicExpressionOrAnd,r)}default:throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.LogicExpressionOrAnd,r)}throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.LogicalExpressionOnlyBoolean,r)}catch(e){throw e}}(e,t);case"ArrayExpression":return function(e,r){try{const t=[];for(let o=0;o<r.elements.length;o++){const n=F(e,r.elements[o]);if(s.isFunctionParameter(n))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.NoFunctionInArray,r);n===s.voidOperation?t.push(null):t.push(n)}return t}catch(e){throw e}}(e,t);case"ObjectExpression":return function(e,r){const t=Object.create(null),o=new Map;for(let n=0;n<r.properties.length;n++){const i=r.properties[n],a="Identifier"===i.key.type?i.key.name:F(e,i.key),u=F(e,i.value);if(s.isFunctionParameter(u))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.NoFunctionInDictionary,r);if(!1===v.isString(a))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.KeyMustBeString,r);let l=a.toString();const d=l.toLowerCase();o.has(d)?l=o.get(d):o.set(d,l),u===s.voidOperation?t[l]=null:t[l]=u}const n=new i(t);return n.immutable=!1,n}(e,t);default:throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.Unrecognized,t)}}catch(r){throw c.ensureArcadeExecutionError(e,t,r)}}function N(e,t){switch(t.type){case"EmptyStatement":return s.voidOperation;case"VariableDeclaration":return k(e,t);case"ImportDeclaration":return function(e,t){const o=r.toSymbolId(t.specifiers[0].local),n=e.libraryResolver.loadLibrary(o);let i;return e.libraryResolver._moduleSingletons?.has(n.uri)?i=e.libraryResolver._moduleSingletons.get(n.uri):(i=new C(n),i.loadModule(e),e.libraryResolver._moduleSingletons?.set(n.uri,i)),e.globalScope[o]={value:i},s.voidOperation}(e,t);case"ExportNamedDeclaration":return function(e,t){if(N(e,t.declaration),"FunctionDeclaration"===t.declaration.type)e.exports[r.toSymbolId(t.declaration.id)]="function";else if("VariableDeclaration"===t.declaration.type)for(const o of t.declaration.declarations)e.exports[r.toSymbolId(o.id)]="variable";return s.voidOperation}(e,t);case"BlockStatement":return M(e,t);case"FunctionDeclaration":return function(e,t){const o=r.toSymbolId(t.id);return e.globalScope[o]={value:new A(t,e)},s.voidOperation}(e,t);case"ReturnStatement":return function(e,r){if(null===r.argument)return new s.ReturnResult(s.voidOperation);const t=F(e,r.argument);return new s.ReturnResult(t)}(e,t);case"IfStatement":return function(e,r){const t=F(e,r.test);if(!0===t)return N(e,r.consequent);if(!1===t)return null!==r.alternate?N(e,r.alternate):s.voidOperation;throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.BooleanConditionRequired,r)}(e,t);case"ExpressionStatement":return function(e,r){const t=F(e,r.expression);return t===s.voidOperation?s.voidOperation:new s.ImplicitResult(t)}(e,t);case"BreakStatement":return s.breakResult;case"ContinueStatement":return s.continueResult;case"ForStatement":return function(e,r){null!==r.init&&("VariableDeclaration"===r.init.type?N(e,r.init):F(e,r.init));const t={testResult:!0,lastAction:s.voidOperation};do{I(e,r,t)}while(!0===t.testResult);return t.lastAction instanceof s.ReturnResult?t.lastAction:s.voidOperation}(e,t);case"ForInStatement":return function(e,t){const o=F(e,t.right);"VariableDeclaration"===t.left.type&&k(e,t.left);const a=r.toSymbolId("VariableDeclaration"===t.left.type?t.left.declarations[0].id:t.left);let u=null;if(null!=e.localScope&&void 0!==e.localScope[a]&&(u=e.localScope[a]),null===u&&void 0!==e.globalScope[a]){const r=e.globalScope[a].value;u=e.globalScope[a]={value:r}}if(null===u)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidIdentifier,t);if(v.isArray(o)||v.isString(o)){const r=o.length;for(let o=0;o<r;o++){u.value=o;const r=N(e,t.body);if(r===s.breakResult)break;if(r instanceof s.ReturnResult)return r}return s.voidOperation}if(s.isImmutableArray(o)){for(let r=0;r<o.length();r++){u.value=r;const o=N(e,t.body);if(o===s.breakResult)break;if(o instanceof s.ReturnResult)return o}return s.voidOperation}if(o instanceof i||s.isDictionaryLike(o)){const r=o.keys();for(let o=0;o<r.length;o++){u.value=r[o];const n=N(e,t.body);if(n===s.breakResult)break;if(n instanceof s.ReturnResult)return n}return s.voidOperation}if(s.isGeometry(o)){for(const r of n.getGeometryKeys(o)){u.value=r;const o=N(e,t.body);if(o===s.breakResult)break;if(o instanceof s.ReturnResult)return o}return s.voidOperation}return s.voidOperation}(e,t);case"ForOfStatement":return function(e,t){const o=F(e,t.right);"VariableDeclaration"===t.left.type&&N(e,t.left);const a=r.toSymbolId("VariableDeclaration"===t.left.type?t.left.declarations[0].id:t.left);let u=null;if(null!=e.localScope&&void 0!==e.localScope[a]&&(u=e.localScope[a]),null===u&&void 0!==e.globalScope[a]){const r=e.globalScope[a].value;u=e.globalScope[a]={value:r}}if(null===u)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidIdentifier,t);if(v.isArray(o)||v.isString(o)){const r=o.length;for(let n=0;n<r;n++){if(n>=o.length)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.OutOfBounds,t);u.value=o[n];const r=N(e,t.body);if(r===s.breakResult)break;if(r instanceof s.ReturnResult)return r}return s.voidOperation}if(s.isImmutableArray(o)){for(let r=0;r<o.length();r++){u.value=o.get(r);const n=N(e,t.body);if(n===s.breakResult)break;if(n instanceof s.ReturnResult)return n}return s.voidOperation}if(o instanceof i||s.isDictionaryLike(o)){for(const r of o.keys()){const n=o.field(r);u.value=i.containerEntry(r,n);const c=N(e,t.body);if(c===s.breakResult)break;if(c instanceof s.ReturnResult)return c}return s.voidOperation}if(s.isGeometry(o)){for(const r of n.getGeometryKeys(o)){const c=n.geometryMember(o,r,e,t,1);u.value=i.containerEntry(r,c);const a=N(e,t.body);if(a===s.breakResult)break;if(a instanceof s.ReturnResult)return a}return s.voidOperation}return s.voidOperation}(e,t);case"WhileStatement":return function(e,r){const t={testResult:!0,lastAction:s.voidOperation};if(t.testResult=F(e,r.test),!1===t.testResult)return s.voidOperation;if(!0!==t.testResult)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.BooleanConditionRequired,r);for(;!0===t.testResult&&(t.lastAction=N(e,r.body),t.lastAction!==s.breakResult)&&!(t.lastAction instanceof s.ReturnResult);)if(t.testResult=F(e,r.test),!0!==t.testResult&&!1!==t.testResult)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.BooleanConditionRequired,r);return t.lastAction instanceof s.ReturnResult?t.lastAction:s.voidOperation}(e,t);default:throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.Unrecognized,t)}}function I(e,r,t){if(null!==r.test){if(t.testResult=F(e,r.test),!1===t.testResult)return;if(!0!==t.testResult)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.BooleanConditionRequired,r)}t.lastAction=N(e,r.body),t.lastAction!==s.breakResult?t.lastAction instanceof s.ReturnResult?t.testResult=!1:null!==r.update&&F(e,r.update):t.testResult=!1}function O(e,r,t,o,n){switch(r){case"=":return e===s.voidOperation?null:e;case"/=":return s.toNumber(t)/s.toNumber(e);case"*=":return s.toNumber(t)*s.toNumber(e);case"-=":return s.toNumber(t)-s.toNumber(e);case"+=":return v.isString(t)||v.isString(e)?s.toString(t)+s.toString(e):s.toNumber(t)+s.toNumber(e);case"%=":return s.toNumber(t)%s.toNumber(e);default:throw new c.ArcadeExecutionError(n,c.ExecutionErrorCodes.UnsupportedOperator,o)}}function M(e,r){let t=s.voidOperation;for(let o=0;o<r.body.length;o++)if(t=N(e,r.body[o]),t instanceof s.ReturnResult||t===s.breakResult||t===s.continueResult)return t;return t}function k(e,r){for(let t=0;t<r.declarations.length;t++)B(e,r.declarations[t]);return s.voidOperation}function B(e,t){let o=null===t.init?null:F(e,t.init);if(o===s.voidOperation&&(o=null),"Identifier"!==t.id.type)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidIdentifier,t);const n=r.toSymbolId(t.id);null!=e.localScope?e.localScope[n]={value:o}:e.globalScope[n]={value:o}}function D(e,r,t){if(s.isFunctionParameter(e))throw new c.ArcadeExecutionError(r,c.ExecutionErrorCodes.NoFunctionInTemplateLiteral,t);return e}function P(e,t){try{const o=r.toSymbolId(t);if(null!=e.localScope&&void 0!==e.localScope[o])return e.localScope[o].value;if(void 0!==e.globalScope[o])return e.globalScope[o].value;throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.InvalidIdentifier,t)}catch(e){throw e}}function L(e,r){try{if(!0===r.preparsed)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.NeverReach,r);const t=r.arguments;s.pcCheck(null===t?[]:t,3,3,e,r);const o=F(e,t[0]);if(!1===v.isBoolean(o))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.BooleanConditionRequired,r);return F(e,!0===o?t[1]:t[2])}catch(e){throw e}}function j(e,r){try{if(!0===r.preparsed)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.NeverReach,r);const t=r.arguments;s.pcCheck(null===t?[]:t,2,3,e,r);const o=F(e,t[0]);if(3===t.length){const r=F(e,t[1]),i=n.getNestedOptionalValue(o,r);return null!=i&&""!==i?i:F(e,t[2])}return null===o||""===o||void 0===o?F(e,t[1]):o}catch(e){throw e}}function G(e,r){try{if(!0===r.preparsed)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.NeverReach,r);const t=r.arguments;if(t.length<2)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.WrongNumberOfParameters,r);if(2===t.length)return F(e,t[1]);if((t.length-1)%2==0)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.WrongNumberOfParameters,r);return K(e,r,1,F(e,t[0]))}catch(e){throw e}}function K(e,r,t,o){try{const n=r.arguments,i=F(e,n[t]);if(s.equalityTest(i,o))return F(e,n[t+1]);{const i=n.length-t;return 1===i?F(e,n[t]):2===i?null:3===i?F(e,n[t+2]):K(e,r,t+2,o)}}catch(e){throw e}}function U(e,r){try{if(!0===r.preparsed)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.NeverReach,r);const t=r.arguments;if(t.length<3)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.WrongNumberOfParameters,r);if(t.length%2==0)throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.WrongNumberOfParameters,r);const o=F(e,t[0]);if(!1===v.isBoolean(o))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.BooleanConditionRequired,t[0]);return q(e,r,0,o)}catch(e){throw e}}function q(e,r,t,o){try{const n=r.arguments;if(!0===o)return F(e,n[t+1]);if(3===n.length-t)return F(e,n[t+2]);{const o=F(e,n[t+2]);if(!1===v.isBoolean(o))throw new c.ArcadeExecutionError(e,c.ExecutionErrorCodes.BooleanConditionRequired,n[t+2]);return q(e,r,t+2,o)}}catch(e){throw e}}const T=function(){const e=Object.create(null);E.registerFunctions(e,R),b.registerFunctions(e,R),f.registerFunctions(e,R,P),x.registerFunctions(e,R),p.registerFunctions(e,R),w.registerFunctions(e,R),h.registerFunctions(e,R),e.iif=L,e.defaultvalue=j,e.decode=G,e.when=U;const r=function(){this.textformatting={value:i.textFormatting()}};(r.prototype=Object.create(null)).infinity=Object.freeze({value:Number.POSITIVE_INFINITY}),r.prototype.pi=Object.freeze({value:Math.PI});for(const[t,o]of Object.entries(e))r.prototype[t]=Object.freeze({value:new u.NativeFunction(o)});return r}();function Z(e){const r={mode:"sync",compiled:!1,functions:Object.create(null),signatures:[],standardFunction:R,evaluateIdentifier:P};for(let t=0;t<e.length;t++)e[t].registerFunctions(r);for(const[e,t]of Object.entries(r.functions))T.prototype[e]=Object.freeze({value:new u.NativeFunction(t)});for(let e=0;e<r.signatures.length;e++)l.addFunctionDeclaration(r.signatures[e],"sync")}function V(e,r,t){const o=new T;e||(e={}),r||(r={});for(const e in r)o[e]={value:new u.NativeFunction(r[e])};for(const r in e)o[r]={value:v.isGraphic(e[r])?a.createFromGraphic(e[r],t):e[r]};return o}function W(e){console.log(e)}Z([d.ArrayFunctions]),e.executeScript=function(e,t){const n=t.spatialReference??y.WebMercator;let i=null;e.usesModules&&(i=new o.ArcadeModuleLoader(new Map,e.loadedModules));const a={spatialReference:n,globalScope:V(t.vars,t.customfunctions,t.timeZone),localScope:null,services:t.services,exports:{},libraryResolver:i,console:t.console??W,timeZone:t.timeZone??null,lrucache:t.lrucache,interceptor:t.interceptor,abortSignal:r.neverAbortedSignal,depthCounter:{depth:1}},u=M(a,e);if(u instanceof s.ReturnResult||u instanceof s.ImplicitResult){const e=u.value;if(s.isVoid(e))return null;if(s.isFunctionParameter(e))throw new c.ArcadeExecutionError(a,c.ExecutionErrorCodes.IllegalResult,null);return e}if(s.isVoid(u))return null;if(u===s.breakResult)throw new c.ArcadeExecutionError(a,c.ExecutionErrorCodes.IllegalResult,null);if(u===s.continueResult)throw new c.ArcadeExecutionError(a,c.ExecutionErrorCodes.IllegalResult,null);throw new c.ArcadeExecutionError(a,c.ExecutionErrorCodes.NeverReach,null)},e.extend=Z,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));