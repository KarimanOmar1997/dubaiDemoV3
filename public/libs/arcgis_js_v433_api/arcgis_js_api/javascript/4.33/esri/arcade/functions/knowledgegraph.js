// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../../config","../ArcadePortal","../Dictionary","../executionError","../../chunks/languageUtils","../portalUtils","../../geometry/Geometry","../../geometry/projectionUtils","../../geometry/SpatialReference","../../geometry/support/webMercatorUtils","../../portal/Portal","../../portal/PortalItem","../../rest/geometryService/project","../../rest/knowledgeGraph/Entity","../../rest/knowledgeGraph/GraphQueryStreaming","../../rest/knowledgeGraph/ObjectValue","../../rest/knowledgeGraph/Path","../../rest/knowledgeGraph/Relationship","../../rest/support/ProjectParameters","../../support/guards"],(function(e,r,t,n,i,o,a,s,c,l,u,p,f,d,g,h,m,y,w,S,E,x){"use strict";let G=null;async function v(r,t){const n=new d({portal:r,id:t});return await n.load(),null===G&&(G=await new Promise(((r,t)=>e(["../../rest/knowledgeGraphService"],r,t)))),await G.fetchKnowledgeGraph(n.url)}function P(e,r,t,n,i){if(null===e)return null;if(x.isString(e)||x.isNumber(e))return e;if(a.isDate(e))return e.toJSDate();if(a.isDate(e))return e.toJSDate();if(a.isDateOnly(e))return e.toStorageFormat();if(a.isTime(e))return e.toStorageString();if(a.isDictionary(e)){const o={};for(const a of e.keys())o[a]=P(e.field(a),r,t,n,i),o[a]instanceof c&&i.push({container:o,indexer:a});return o}if(x.isArray(e)){const o=e.map((e=>P(e,r,t,n,i)));for(let e=0;e<o.length;e++)o[e]instanceof c&&i.push({container:o,indexer:e});return o}return a.isGeometry(e)?e.spatialReference.isWGS84?e:e.spatialReference.isWebMercator&&r?p.webMercatorToGeographic(e):e:void 0}function R(e,r){if(!e)return null;const t={};for(const n in e)t[n]=b(e[n],r);return t}function b(e,r){return null===e?null:x.isArray(e)?e.map((e=>b(e,r))):e instanceof h?{graphTypeName:e.typeName,id:e.id,graphType:"entity",properties:R(e.properties,r)}:e instanceof y?{graphType:"object",properties:R(e.properties,r)}:e instanceof S?{graphTypeName:e.typeName,id:e.id,graphType:"relationship",originId:e.originId??null,destinationId:e.destinationId??null,properties:R(e.properties,r)}:e instanceof w?{graphType:"path",path:e.path?e.path.map((e=>b(e,r))):null}:a.isGeometry(e)?function(e,r){if(!e)return e;if(e.spatialReference.isWGS84&&r.spatialReference.isWebMercator)return p.geographicToWebMercator(e);if(e.spatialReference.equals(r.spatialReference))return e;throw new o.ArcadeExecutionError(r,o.ExecutionErrorCodes.WrongSpatialReference,null)}(e,r):x.isString(e)||x.isNumber(e)||x.isDate(e)?e:null}r.registerFunctions=function(r){"async"===r.mode&&(r.functions.knowledgegraphbyportalitem=function(e,t){return r.standardFunctionAsync(e,t,((r,i,c)=>{if(a.pcCheck(c,2,2,e,t),null===c[0])throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.PortalRequired,t);if(c[0]instanceof n){const r=a.toString(c[1]);let t;return t=e.services?.portal?e.services.portal:f.getDefault(),v(s.getPortal(c[0],t),r)}if(!1===x.isString(c[0]))throw new o.ArcadeExecutionError(e,o.ExecutionErrorCodes.InvalidParameter,t);const l=a.toString(c[0]);return v(e.services?.portal??f.getDefault(),l)}))},r.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),r.functions.querygraph=function(n,s){return r.standardFunctionAsync(n,s,(async(r,c,p)=>{a.pcCheck(p,2,4,n,s);const f=p[0];if(!a.isKnowledgeGraph(f))throw new o.ArcadeExecutionError(n,o.ExecutionErrorCodes.InvalidParameter,s);const d=p[1];if(!x.isString(d))throw new o.ArcadeExecutionError(n,o.ExecutionErrorCodes.InvalidParameter,s);null===G&&(G=await new Promise(((r,t)=>e(["../../rest/knowledgeGraphService"],r,t))));let h=null;const y=a.defaultUndefined(p[2],null);if(!(y instanceof i||null===y))throw new o.ArcadeExecutionError(n,o.ExecutionErrorCodes.InvalidParameter,s);if(y){let e=[];h=P(y,!0,!1,n,e),e=e.filter((e=>!e.container[e.indexer].spatialReference.isWGS84)),e.length>0&&await async function(e){const r=t.geometryServiceUrl??"";if(!r){l.isLoaded()||await l.load();for(const r of e)r.container[r.indexer]=l.project(r.container[r.indexer],u.WGS84);return}const n=e.map((e=>e.container[e.indexer])),i=new E({geometries:n,outSpatialReference:u.WGS84}),o=await g.project(r,i);for(let r=0;r<o.length;r++){const t=e[r];t.container[t.indexer]=o[r]}}(e)}const w=a.defaultUndefined(p[3],!1),S=new m({openCypherQuery:d,bindParameters:h,provenanceBehavior:w?"include":"exclude"});(f?.serviceDefinition?.currentVersion??11.3)>11.2&&(S.outputSpatialReference=n.spatialReference);const v=(await G.executeQueryStreaming(f,S)).resultRowsStream.getReader(),R=[];try{for(;;){const{done:e,value:r}=await v.read();if(e)break;if(x.isArray(r))for(const e of r)R.push(b(e,n));else{const e=[];for(const t of r)e.push(b(r[t],n));R.push(e)}}}catch(e){throw e}return i.convertJsonToArcade(R,a.defaultTimeZone(n),!1,!0)}))},r.signatures.push({name:"querygraph",min:2,max:4}))},Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));