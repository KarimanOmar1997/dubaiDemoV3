// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../arcade/arcadeCompiler","../arcade/ArcadeModuleResolver","../arcade/arcadeRuntime","../arcade/executionError","../arcade/parser","../arcade/treeAnalysis","../arcade/functions/geomsync","../core/has","../core/maybe"],(function(e,r,t,n,c,s,i,u,o,a,l){"use strict";const d=new Set(["feature","angle","bearing","centroid","envelopeintersects","extent","geometry","ringisclockwise"]);let p=!1,f=!1,S=null,m=[];function y(e,r){if(!0===r.useAsync||!0===e.isAsync)return function(e,r){if(null===S)throw new s.ArcadeExecutionError(null,s.ExecutionErrorCodes.AsyncNotEnabled,null);if(a("esri-csp-restrictions"))return function(r){return S.executeScript(e,r)};try{return t.compileScript(e,r,!0)}catch(r){if("esri.arcade.arcadeuncompilableerror"===r.declaredRootClass)return function(r){return S.executeScript(e,r)};throw r}}(e,r);if(a("esri-csp-restrictions"))return function(r){return c.executeScript(e,r)};try{return t.compileScript(e,r)}catch(r){if("esri.arcade.arcadeuncompilableerror"===r.declaredRootClass)return function(r){return c.executeScript(e,r)};throw r}}function b(e){c.extend(e),t.extend(e,"sync"),null===S?m.push(e):(t.extend(e,"async"),S.extend(e))}function x(e,r=[]){return i.parseScript(e,r)}function w(e,r,t=[]){return A(i.parseScript(e,t),r)}function A(e,r){if(!0===r.useAsync||!0===e.isAsync){if(null===S)throw new s.ArcadeExecutionError(null,s.ExecutionErrorCodes.AsyncNotEnabled,null);return S.executeScript(e,r)}return c.executeScript(e,r)}function E(e,r){return u.referencesMember(e,r)}function h(e,r){return u.referencesFunction(e,r)}function F(e,r=!1){return void 0===r&&(r=!1),u.findLiteralMemberAccesses(e).map((({varId:e,memberId:r})=>`${e}.${r}`))}function M(e){return u.findExpectedFieldLiterals(e)}function g(e,r=[]){return void 0===e.usesGeometry&&u.findScriptDependencies(e,r),!0===e.usesGeometry}let I=null;function G(){return I||(I=v(),I)}async function v(){return await o.loadOperators(),f=!0,!0}let P=null;function U(){return null!==P||(P=D()),P}async function D(){await t.enableAsyncSupport(),S=await new Promise(((r,t)=>e(["../arcade/arcadeAsyncRuntime"],r,t)));for(const e of m)S.extend(e),t.extend(e,"async");return m=null,!0}function C(){return p}function L(){return!!S}function R(){return f}let _=null;function k(){return _||(_=O(),_)}async function O(){await U();const[r,n,c,s,i,u]=await Promise.all([new Promise(((r,t)=>e(["../arcade/featureSetUtils"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetbase"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetgeom"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetstats"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/featuresetstring"],r,t))),new Promise(((r,t)=>e(["../arcade/functions/knowledgegraph"],r,t)))]);return H=r,S.extend([n,c,s,i,u]),t.extend([n,c,s,i,u],"async"),p=!0,!0}function T(e,r=[]){return void 0===e.usesFeatureSet&&u.findScriptDependencies(e,r),!0===e.usesFeatureSet}function $(e,r=[]){return void 0===e.isAsync&&u.findScriptDependencies(e,r),!0===e.isAsync}async function j(e,r,t=[],n=!1,c=null){return z(new Set,e,r,t,n,c)}async function z(e,r,t,n=[],c=!1,s=null){const i="string"==typeof r?x(r):r,u=[];return i&&(!1===R()&&(g(i)||c)&&u.push(G()),!1===L()&&(!0===i.isAsync||t)&&u.push(U()),!1===C()&&(T(i)||function(e,r){if(r){for(const t of r)if(E(e,t))return!0;return!1}return!1}(i,n))&&u.push(k())),u.length&&await Promise.all(u),await V(e,i,s,t,c),!0}function N(e,r=[]){return void 0===e.usesModules&&u.findScriptDependencies(e,r),!0===e.usesModules}async function V(e,r,t=null,c=!1,i=!1){const o=u.findModuleImports(r);null===t&&o.length>0&&(t=n.ArcadeModuleResolver.getDefault()),r.loadedModules={};for(const n of o){l.assertIsSome(t);const u=t.normalizeModuleUri(n.source);if(e.has(u.uri))throw new s.ArcadeExecutionError(null,s.ExecutionErrorCodes.CircularModules,null);e.add(u.uri);const o=await t.fetchModule(u);await z(e,o,c,[],i,t),e.delete(u.uri),o.isAsync&&(r.isAsync=!0),o.usesFeatureSet&&(r.usesFeatureSet=!0),o.usesGeometry&&(r.usesGeometry=!0),r.loadedModules[n.libname]={uri:u.uri,script:o}}}function q(e){if(g(e))return!0;const r=u.findFunctionCalls(e);let t=!1;for(let e=0;e<r.length;e++)if(d.has(r[e])){t=!0;break}return t}function B(e,r){const t=null==r?null:new Set(r.map((e=>e.toLowerCase())));return u.findLiteralMemberAccesses(e).some((({varId:e,memberId:r})=>"$view"===e&&(null==t||t.has(r))))}let H=null;function J(){return H}const K=Object.freeze(Object.defineProperty({__proto__:null,_loadScriptDependenciesImpl:z,compileScript:y,enableAsyncSupport:U,enableAsyncSupportImpl:D,enableFeatureSetSupport:k,enableFeatureSetSupportImpl:O,enableGeometrySupport:G,enableGeometrySupportImpl:v,executeScript:A,extend:b,extractExpectedFieldLiterals:M,extractFieldLiterals:F,featureSetUtils:J,isAsyncEnabled:L,isFeatureSetSupportEnabled:C,isGeometryEnabled:R,loadDependentModules:V,loadScriptDependencies:j,parseAndExecuteScript:w,parseScript:x,referencesFunction:h,referencesMember:E,scriptIsAsync:$,scriptTouchesGeometry:q,scriptUsesFeatureSet:T,scriptUsesGeometryEngine:g,scriptUsesModules:N,scriptUsesViewProperties:B},Symbol.toStringTag,{value:"Module"}));r._loadScriptDependenciesImpl=z,r.arcade=K,r.compileScript=y,r.enableAsyncSupport=U,r.enableAsyncSupportImpl=D,r.enableFeatureSetSupport=k,r.enableFeatureSetSupportImpl=O,r.enableGeometrySupport=G,r.enableGeometrySupportImpl=v,r.executeScript=A,r.extend=b,r.extractExpectedFieldLiterals=M,r.extractFieldLiterals=F,r.featureSetUtils=J,r.isAsyncEnabled=L,r.isFeatureSetSupportEnabled=C,r.isGeometryEnabled=R,r.loadDependentModules=V,r.loadScriptDependencies=j,r.parseAndExecuteScript=w,r.parseScript=x,r.referencesFunction=h,r.referencesMember=E,r.scriptIsAsync=$,r.scriptTouchesGeometry=q,r.scriptUsesFeatureSet=T,r.scriptUsesGeometryEngine=g,r.scriptUsesModules=N,r.scriptUsesViewProperties=B}));