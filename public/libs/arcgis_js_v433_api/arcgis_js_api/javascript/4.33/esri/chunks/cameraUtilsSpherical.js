// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../core/Cyclical","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","./vec42","../core/libs/gl-matrix-2/factories/vec4f64","../core/libs/gl-matrix-2/math/common","../geometry/ellipsoidUtils","../geometry/Extent","../geometry/Polygon","../geometry/SpatialReference","../geometry/support/coordsUtils","../geometry/support/frustum","../geometry/support/lineSegment","../geometry/support/plane","../geometry/support/ray","./sphere","../geometry/support/webMercatorUtils","../views/3d/state/Frustum","../views/3d/state/NearFarHeuristic","../views/3d/state/utils/viewUtils","../views/3d/support/cameraUtilsInternal","../views/3d/support/earthUtils","../views/3d/support/mathUtils"],(function(e,t,r,n,a,s,o,i,c,l,u,d,m,p,h,g,f,T,y,M,R,I,E,A,_,x,S){"use strict";const v=o.fromValues(0,0,1),b=s.normalize(o.create(),o.fromValues(1,1,1)),C=new t.Cyclical(-180,180),N=a.create(),O=o.create(),P=o.create();function F(e,t,a,o=_.createDirectionUp()){s.cross(O,e,v),0===s.dot(O,O)&&s.cross(O,e,b),n.fromRotation(N,-r.deg2rad(t),e),n.rotate(N,N,-r.deg2rad(a),O);const{up:i,direction:c}=o;return s.cross(i,O,e),s.normalize(i,i),s.transformMat4(i,i,N),s.normalize(c,e),s.negate(c,c),s.transformMat4(c,c,N),o}function w(e,t,r,n){const a=O,o=P;return s.normalize(a,e),s.cross(P,a,v),0===s.dot(P,P)&&s.cross(P,a,b),s.cross(o,P,a),_.directionToHeadingTilt(t,r,n,a,o)}function U(e,t,n,a){const i={eye:o.create(),up:null,tilt:a,heading:n},c=O;c[0]=e[0],c[1]=e[2],c[2]=-e[1];const l=t,u=r.deg2rad(n),d=r.deg2rad(a),m=Math.sin(u),p=Math.cos(u),h=Math.sin(d),g=Math.cos(d),f=s.length(c);let T;if(Math.abs(d)<1e-8)T=l+f;else{const e=f/h,t=r.asinClamped(l/e),n=Math.PI-d-t;T=e*Math.sin(n)}const y=g*l,M=l*l*(h*h),R=p*p*M,I=T-y,E=I*I,A=R*(R+E-c[1]*c[1]);if(A<0)return s.scale(i.eye,c,T/f),i.tilt=0,D(i,e);const _=Math.sqrt(A),x=c[1]*I,S=R+E;let v;if(v=p>0?-_+x:_+x,Math.abs(S)<1e-8)return f<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=l):s.scale(i.eye,c,T/f),i.tilt=0,L(i.eye),D(i,e);i.eye[1]=v/S;const b=m*m*M,C=h*l,N=p*C*i.eye[1],P=i.eye[1]*i.eye[1],F=1-P,w=Math.sqrt(F),U=R*P+b-2*N*w*I+F*E;return Math.abs(U)<1e-8?(s.scale(i.eye,c,T/f),i.tilt=0,L(i.eye),D(i,e)):(i.eye[0]=(F*(T*c[0]-y*c[0])-C*w*(c[0]*i.eye[1]*p+c[2]*m))/U,i.eye[2]=(F*(T*c[2]-y*c[2])-C*w*(c[2]*i.eye[1]*p-c[0]*m))/U,s.scale(i.eye,i.eye,T),L(i.eye),D(i,e))}function L(e){const t=e[1];e[1]=-e[2],e[2]=t}function D(e,t){const r=F(t,e.heading,e.tilt);return e.up=r.up,e}function H(e,t,n){const a=s.length(t),o=Math.sqrt(n*n+a*a-2*n*a*Math.cos(Math.PI-e)),i=r.asinClamped(n/(o/Math.sin(e)));return r.rad2deg(e-i)}function q(e,t,n){const a=r.deg2rad(e),o=s.length(t);return r.asinClamped(n/(o/Math.sin(a)))+a}function k(e,n,a,s,o){let i,c,l,m;const h=n.latitude,g=u.getReferenceEllipsoid(e.spatialReference).radius,f=n.longitude,T=x.getLonDeltaForDistance(h,a,g)/2;i=f-T,c=f+T;const y=r.deg2rad(h),M=(1+Math.sin(y))/(1-Math.sin(y)),I=(M+1)*Math.tan(s/g/2),E=I*I;function A(e){const r=Math.PI/2;return(e=t.cyclical2PI.normalize(e,-r))>r&&(e=Math.PI-e),e}if(l=1.5*Math.PI-2*Math.atan(.5*(I+Math.sqrt(4*M+E))),m=l+s/g,l=A(l),m=A(m),m<l){const e=m;m=l,l=e}if(l=Math.max(r.rad2deg(l),-90),m=Math.min(r.rad2deg(m),90),c=C.monotonic(i,c),c-i>180){const e=(c-i-180)/2;i+=e,c-=e}const _=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:p.WGS84;return o?(o.xmin=i,o.ymin=l,o.xmax=c,o.ymax=m,o.spatialReference=_):o=new d(i,l,c,m,_),e.spatialReference&&e.spatialReference.isWebMercator&&R.geographicToWebMercator(o,!1,o),o}function z(e,t){const{renderCoordsHelper:n}=e,a=e.state.camera.clone(),c=new I.Frustum(n);a.near=E.minNearDistanceInMeters,c.update(a);const u=n.getAltitude(t),d=e.spatialReference,p=n.referenceEllipsoid.radius,f=a.eye,R=1+s.distance(f,t)/(p+u),x=Math.sqrt(R*R-1),{minCurvature:v,maxCurvature:b,minSamples:C,maxSamples:N}=W,O=function(e){const{renderCoordsHelper:t,state:{camera:r}}=e,{center:n,eye:a}=r,s=Math.abs(t.getAltitude(n)),o=Math.abs(Math.PI/2-A.viewAngle(t,n,a));return M.fromRadius(J,t.referenceEllipsoid.radius+s),M.cameraFrustumCoverage(J,o,r.distance,r.fovY)}(e),P=r.clamp((x-v)/(b-v),0,1),F=Math.round(r.lerp(C,N,P)),w=a.aboveGround,U=c.planes[g.PlaneIndex.FAR],L=[],D=T.fromPositionAndNormal(o.ZEROS,V,T.create()),H=T.fromPositionAndNormal(o.ZEROS,B,T.create());i.set(Q,0,0,0,0);for(let e=0;e<4;e++){const t=e===I.LineIndex.NEAR_FAR_BOTTOM_RIGHT&&!w||e===I.LineIndex.NEAR_FAR_TOP_LEFT&&w?1-O:0,a=e===I.LineIndex.NEAR_FAR_BOTTOM_RIGHT&&w||e===I.LineIndex.NEAR_FAR_TOP_LEFT&&!w?O:1,i=c.lines[e],l=c.lines[3===e?0:e+1];for(let c=0;c<F;c++){const d=c/F,m=e===I.LineIndex.NEAR_FAR_BOTTOM_RIGHT?1-(1-d)**2:e===I.LineIndex.NEAR_FAR_TOP_LEFT?d**2:d,p=0===c?0:r.lerp(t,a,m),h=s.lerp(Z,i.origin,l.origin,p),g=S.slerp(i.direction,l.direction,p,j);n.intersectManifoldClosestSilhouette(y.wrap(h,g),u,Y),_.clampLineSegmentToPlane(Y,f,Y,U),L.push(o.clone(Y)),0!==L.length&&s.sqrDist(L.at(-1),Y);const M=(T.isPointInside(D,Y)?1:0)|(T.isPointInside(H,Y)?2:0);Q[M]=1}}L.length>2&&s.sqrDist(L[0],L.at(-1));const q=i.squaredLength(Q)>1?function(e,t){const r=[];for(const n of e)r.push(...G(n,t));return r}(G(L,D),H):[L],k=function(e,t,r){const n=2*l.getEpsilon();return e.map((e=>{const a=[];let s=!1;for(const o of e)t.fromRenderCoords(o,Y,r),Math.abs(o[0])<n&&Math.abs(o[1])<n?(a.push([null,Y[1]]),a.push([null,Y[1]]),s=!0):a.push([Y[0],Y[1]]);if(s)for(let e=0;e<a.length;e++){const t=a[e];if(null!=t[0])continue;const r=a[e+1],n=a.at(0===e?-1:e-1);t[0]=n[0],e++;const s=a.at(e===a.length-1?0:e+1);r[0]=s[0]}return a.push(a[0]),h.isClockwise(a)||a.reverse(),a}))}(q,n,d);return new m({rings:k,spatialReference:d})}function G(e,t){const r=[],n=[],a=l.getEpsilon();for(let i=0;i<e.length;i++){const c=e[i],l=i===e.length-1?e[0]:e[i+1],u=f.fromPoints(c,l,K),d=T.intersectLineOrRay(t,u.origin,u.vector,T.IntersectFlags.NONE,Y);switch(d){case T.IntersectResult.INSIDE:r.push(c);break;case T.IntersectResult.OUTSIDE:n.push(c);break;case T.IntersectResult.INTERSECTS_INSIDE_OUT:case T.IntersectResult.INTERSECTS_OUTSIDE_IN:{const[e,i,l]=d===T.IntersectResult.INTERSECTS_INSIDE_OUT?[1,r,n]:[-1,n,r],u=T.getNormal(t),m=s.scaleAndAdd(o.create(),Y,u,e*a),p=s.scaleAndAdd(o.create(),Y,u,e*-a);i.push(c),i.push(m),l.push(p)}}}const i=[];return r.length&&i.push(r),n.length&&i.push(n),i}const W={minCurvature:r.deg2rad(5),maxCurvature:r.deg2rad(50),minSamples:1,maxSamples:6},V=o.fromValues(1,0,0),B=o.fromValues(0,1,0),j=o.create(),Z=o.create(),Y=o.create(),J=M.create(),K=f.create(),Q=c.create(),X=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:w,eyeForCenterWithHeadingTilt:U,eyeTiltToLookAtTilt:q,headingTiltToDirectionUp:F,lookAtTiltToEyeTilt:H,toArea:z,toExtent:k},Symbol.toStringTag,{value:"Module"}));e.cameraUtilsSpherical=X,e.directionToHeadingTilt=w,e.eyeForCenterWithHeadingTilt=U,e.eyeTiltToLookAtTilt=q,e.headingTiltToDirectionUp=F,e.lookAtTiltToEyeTilt=H,e.toArea=z,e.toExtent=k}));