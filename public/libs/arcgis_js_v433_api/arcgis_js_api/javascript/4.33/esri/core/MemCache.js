// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports"],(function(t){"use strict";var e;t.RemoveMode=void 0,(e=t.RemoveMode||(t.RemoveMode={}))[e.ALL=0]="ALL",e[e.SOME=1]="SOME";class i{constructor(t,e,i,h=0){this.name=t,this._storage=e,this.removeFunc=i,this._defaultPriority=h,this.id=`${s++}${r}`,this.size=0,this._hit=0,this._miss=0,this._storage.register(this)}destroy(){this._storage.deregister(this),this._storage=null}get hitRate(){return this._hit/(this._hit+this._miss)}get storageSize(){return this._storage.size}getSize(t){return this._storage.getSize(this,t)}set maxSize(t){this._storage.setMaxSize(this,t)}resetHitRate(){this._hit=this._miss=0}put(t,e,i=this._defaultPriority){this._storage.put(this,t,e,e.cachedMemory,i)}pop(t){const e=this._storage.pop(this,t);return void 0===e?++this._miss:++this._hit,e}get(t){const e=this._storage.get(this,t);return void 0===e?++this._miss:++this._hit,e}peek(t){return this._storage.peek(this,t)}updateSize(t,e){this._storage.updateSize(this,t,e,e.cachedMemory)}clear(){this._storage.clear(this)}clearAll(){this._storage.clearAll()}*[Symbol.iterator](){yield*this._storage.values(this)}get performanceInfo(){return this._storage.performanceInfo}resetStats(){this._storage.resetStats()}}let s=0;class h{constructor(t,e,i){this.entry=t,this.size=e,this.lifetime=i,this.lives=i}}const r=":";t.MemCache=i,t.MemCacheStorage=class{get size(){return this._size}constructor(t=10485760){this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._users=new Map,this._sizeLimits=new Map}destroy(){this.clearAll(),this._sizeLimits.clear(),this._users.clear()}register(t){this._users.set(t.id.slice(0,-1),t)}deregister(t){this.clear(t),this._sizeLimits.delete(t),this._users.delete(t.id.slice(0,-1))}get maxSize(){return this._maxSize}set maxSize(t){this._maxSize=Math.max(t,-1),this._checkSize()}getSize(t,e){const i=this._db.get(t.id+e);return i?.size??0}put(e,i,s,r,o){i=e.id+i;const _=this._db.get(i);if(_&&(this._size-=_.size,e.size-=_.size,this._db.delete(i),_.entry!==s&&this._notifyRemove(i,_.entry,_.size,t.RemoveMode.ALL)),r>this._maxSize)return void this._notifyRemove(i,s,r,t.RemoveMode.ALL);if(void 0===s)return void console.warn("Refusing to cache undefined entry ");if(!r||r<0)return console.warn(`Refusing to cache entry with size ${r} for key ${i}`),void this._notifyRemove(i,s,0,t.RemoveMode.ALL);const n=1+Math.max(o,-4)- -3;this._db.set(i,new h(s,r,n)),this._size+=r,e.size+=r,this._checkSize()}updateSize(e,i,s,h){i=e.id+i;const r=this._db.get(i);if(r&&r.entry===s){for(this._size-=r.size,e.size-=r.size;h>this._maxSize;){const e=this._notifyRemove(i,s,h,t.RemoveMode.SOME);if(!(null!=e&&e>0))return void this._db.delete(i);h=e}r.size=h,this._size+=h,e.size+=h,this._checkSize()}}pop(t,e){e=t.id+e;const i=this._db.get(e);if(i)return this._size-=i.size,t.size-=i.size,this._db.delete(e),++this._hit,i.entry;++this._miss}get(t,e){e=t.id+e;const i=this._db.get(e);if(void 0!==i)return this._db.delete(e),i.lives=i.lifetime,this._db.set(e,i),++this._hit,i.entry;++this._miss}peek(t,e){const i=this._db.get(t.id+e);return i?++this._hit:++this._miss,i?.entry}get performanceInfo(){const t={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},e={},i=new Array;this._db.forEach(((t,s)=>{const h=t.lifetime;i[h]=(i[h]||0)+t.size,this._users.forEach((i=>{const{id:h,name:r}=i;if(s.startsWith(h)){const i=e[r]||0;e[r]=i+t.size}}))}));const s={};this._users.forEach((t=>{const i=t.name;if("hitRate"in t&&"number"==typeof t.hitRate&&!isNaN(t.hitRate)&&t.hitRate>0){const h=e[i]||0;e[i]=h,s[i]=Math.round(100*t.hitRate)+"%"}else s[i]="0%"}));const h=Object.keys(e);h.sort(((t,i)=>e[i]-e[t])),h.forEach((i=>t[i]=Math.round(e[i]/2**20)+"MB / "+s[i]));for(let e=i.length-1;e>=0;--e){const s=i[e];s&&(t["Priority "+(e+-3-1)]=Math.round(s/this._size*100)+"%")}return t}resetStats(){this._hit=this._miss=0,this._users.forEach((t=>t.resetHitRate()))}clear(e){const i=e.id;this._db.forEach(((e,s)=>{s.startsWith(i)&&(this._size-=e.size,this._db.delete(s),this._notifyRemove(s,e.entry,e.size,t.RemoveMode.ALL))})),e.size=0}clearAll(){this._db.forEach(((e,i)=>this._notifyRemove(i,e.entry,e.size,t.RemoveMode.ALL))),this._users.forEach((t=>t.size=0)),this._size=0,this._db.clear()}*values(t){for(const[e,i]of this._db)e.startsWith(t.id)&&(yield i.entry)}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(t,e,i,s){const h=this._users.get(t.split(r)[0])?.removeFunc,o=h?.(e,s,i);return"number"==typeof o?o:null}_checkSize(){this._sizeLimits.forEach(((t,e)=>this._checkSizeLimits(t,e))),this._checkSizeLimits(this.maxSize)}setMaxSize(t,e){null==e||e<=0?this._sizeLimits.delete(t):this._sizeLimits.set(t,e)}_checkSizeLimits(t,e){const i=e??this;if(i.size<=t)return;const s=e?.id;let h=!0;for(;h;){h=!1;for(const[o,_]of this._db)if(0===_.lifetime&&(!s||o.startsWith(s))){const s=e??this._users.get(o.split(r)[0]);if(this._purgeItem(o,_,s),i.size<=.9*t)return;h||=this._db.has(o)}}for(const[h,o]of this._db)if(!s||h.startsWith(s)){const s=e??this._users.get(h.split(r)[0]);if(this._purgeItem(h,o,s),i.size<=.9*t)return}}_purgeItem(e,i,s){if(this._db.delete(e),i.lives<=1){this._size-=i.size,s&&(s.size-=i.size);const h=this._notifyRemove(e,i.entry,i.size,t.RemoveMode.SOME);null!=h&&h>0&&(this._size+=h,s&&(s.size+=h),i.lives=i.lifetime,i.size=h,this._db.set(e,i))}else--i.lives,this._db.set(e,i)}},t.MinPriority=-3,t.NoPriority=-4,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));