// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../core/Logger","../core/MapUtils","../core/promiseUtils","../core/SetUtils","./sharedTemplates/templateDefinitions/templateDefinitionUtils","../layers/support/layerUtils","../undoredo/support/Services"],(function(e,t,r,a,n,i,s,o){"use strict";function l(e){return u(e)&&"definition"in e}function u(e){return null!=e&&"templateId"in e}const p=e=>null==e||"object"!=typeof e?[]:[..."templates"in e&&Array.isArray(e.templates)?e.templates:[],..."types"in e&&Array.isArray(e.types)?e.types.flatMap((e=>e.templates)):[]];function f(e,t){return s.isSubtypeSublayer(t)&&t.parent?e.tablesAndLayersLookup.get(t.parent):s.isFeatureLayer(t)?e.tablesAndLayersLookup.get(t):null}function c(e){const t=new Map;for(const a of e)r.getOrCreateMapValue(t,a.subtypeCode??1/0,(()=>[])).push(a);return t}e.getAllStandardFeatureTemplatesForLayer=p,e.getServiceInfoForLayer=f,e.getTemplatesForLayers=async function(e,i,l){if(null==i)return e.map((e=>({layer:e,templates:p(e)})));const u=await async function(e,t){const r=await o.getServices(t).load(),a=new Set;for(const t of e)n.addMaybe(a,f(r,t));return await Promise.all(Array.from(a).map((e=>e.featureService.load()))),a}(e,i);a.throwIfAborted(l);const d=new Map,y=Array.from(u).map((e=>async function({serviceInfo:e,out:t,signal:n}){const{featureService:i,layersAndTables:o}=e,l=await async function({featureService:e,layers:t,signal:a}){if(!e.capabilities?.editing.supportsSharedTemplates)return new Map;const n=new Map(t.map((e=>[e.layerId,e]))),i=await e.querySharedTemplates({query:{layers:Array.from(n.keys())},requestOptions:{signal:a}}),s=new Map;for(const e of i)for(const t of e.layerIds)n.has(t)&&r.getOrCreateMapValue(s,n.get(t),(()=>[])).push(e);return s}({featureService:i,layers:o.toArray(),signal:n});a.throwIfAborted(n);for(const[e,r]of l.entries())if(0!==r.length)if(s.isSubtypeGroupLayer(e)){const a=c(r),n=[],i=a.get(1/0)??n;for(const r of e.sublayers){const e=a.get(r.subtypeCode)??n;t.set(r,[...e,...i])}}else t.set(e,r)}({serviceInfo:e,out:d,signal:l}))),m=await Promise.allSettled(y);for(const e of m.filter((e=>"rejected"===e.status)))t.getLogger("esri.editing.templateUtils").warn("Failed to fetch shared templates for service. Will use standard templates if available.",e.reason);return e.map((e=>({layer:e,templates:d.get(e)??p(e)})))},e.isLoadedSharedTemplate=function(e){return l(e)&&null!=e?.definition},e.isSharedFeatureTemplate=function(e){return l(e)&&"feature"===e?.type&&(null==e.definition||i.isFeatureTemplateDefinition(e.definition))},e.isSharedGroupTemplate=function(e){return l(e)&&"group"===e?.type&&(null==e.definition||i.isGroupTemplateDefinition(e.definition))},e.isSharedPresetTemplate=function(e){return l(e)&&"preset"===e?.type&&(null==e.definition||i.isPresetTemplateDefinition(e.definition))},e.isSharedTemplate=l,e.isSharedTemplateMetadata=function(e){return u(e)&&!("definition"in e)},e.isSharedTemplateOrMetadata=u,e.isStandardFeatureTemplate=function(e){return null!=e&&"prototype"in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));