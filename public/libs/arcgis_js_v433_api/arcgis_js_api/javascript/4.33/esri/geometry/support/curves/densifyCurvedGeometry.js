// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","./bezierCurveUtils","./circularArcUtils","./curveUtils","./ellipticArc4Utils","./ellipticArc7Utils","./mathUtils"],(function(t,i,e,n,s,r,a){"use strict";const c={maxSegmentLength:1/0,maxDeviation:1/0,maxSegmentsPerCurve:12e3,minSegmentsPerCurve:1},h=1e-6,o=[0,0];class u{constructor(t,i){this.curveStart=t,this.curveEnd=i,this.tStart=0,this.tEnd=0,this.tEndStack=[],this.arcEndStack=[]}get stackSize(){return this.tEndStack.length}initialize(t,i){this.tStart=0,this.arcStart=t,this.tEndStack.push(1),this.arcEndStack.push(i)}splitAt(t){this.tEndStack.push(this.tEnd),this.arcEndStack.push(this.arcEnd),this.tEndStack.push(t),this.arcEndStack.push(this.interpolate(t))}splitInHalf(){return this.splitAt((this.tStart+this.tEnd)/2)}pop(){this.tEnd=this.tEndStack.pop(),this.arcEnd=this.arcEndStack.pop()}next(){this.tStart=this.tEnd,this.arcStart=this.arcEnd}densify(t,{maxDeviation:i,maxSegmentLength:e,maxSegmentsPerCurve:n,minSegmentsPerCurve:s}){const r=e*e,c=i*i,o=1/n,u=this.interpolate(0),p=this.interpolate(1);a.distance2(this.curveStart,u)>h&&t.push(u),this.initialize(u,p);const l=1/s;for(let t=s-1;t>0;t--){const i=t*l;this.pop(),this.splitAt(i)}for(;this.stackSize>0;)this.pop(),this.tStart===this.tEnd||this.tEnd-this.tStart<o||(0===r||!isFinite(r)||a.distance2(this.arcStart,this.arcEnd)<r)&&(0===c||!isFinite(c)||this.getDeviation2()<c)?(t.push(this.arcEnd),this.next()):this.splitInHalf();return a.distance2(this.curveEnd,p)>h&&t.push([...this.curveEnd]),t}}class p extends u{constructor(t,i){const[e,n,s]=i.b;super(t,e),this._controlPointsStack=[],this._curveControlPoints=[n,s],this._arcControlPoints=[n,s],this._controlPointsStack.push(this._arcControlPoints)}splitAt(t){const{arcStart:i,arcEnd:e,tStart:n,tEnd:s}=this,[r,c]=this._arcControlPoints,h=(t-n)/(s-n),u=a.interpolateSegment([],i,r,h),p=a.interpolateSegment(o,r,c,h),l=a.interpolateSegment([],c,e,h),d=a.interpolateSegment([],u,p,h),S=a.interpolateSegment([],p,l,h),m=a.interpolateSegment([],d,S,h);this.tEndStack.push(this.tEnd),this.arcEndStack.push(this.arcEnd),this._controlPointsStack.push([S,l]),this.tEndStack.push(t),this.arcEndStack.push(m),this._arcControlPoints[0]=u,this._arcControlPoints[1]=d,this._controlPointsStack.push(this._arcControlPoints)}pop(){super.pop(),this._arcControlPoints=this._controlPointsStack.pop()}interpolate(t){const{curveStart:e,curveEnd:n}=this,[s,r]=this._curveControlPoints;return i.interpolateCubicBezier(e,s,r,n,t)}getDeviation2(){const{arcStart:t,arcEnd:i}=this,[e,n]=this._arcControlPoints;return Math.max(a.pointToSegmentDistance2(e,t,i),a.pointToSegmentDistance2(n,t,i))}}class l extends u{constructor(t,i){const[e]=i.a;super(t,e),this._derivedEllipse=r.deriveEllipse(t,i)}pop(){super.pop(),this._tMid=(this.tStart+this.tEnd)/2,this._arcMid=this.interpolate(this._tMid)}splitInHalf(){this.tEndStack.push(this.tEnd),this.arcEndStack.push(this.arcEnd),this.tEndStack.push(this._tMid),this.arcEndStack.push(this._arcMid)}interpolate(t){return r.interpolateEllipse(this._derivedEllipse,t)}getDeviation2(){return a.pointToSegmentDistance2(this._arcMid,this.arcStart,this.arcEnd)}}function d(t,i,e,{cx:n,cy:s,radius:r,thetaStart:c,thetaEnd:o,isInvalid:u},{maxDeviation:p,maxSegmentLength:l,maxSegmentsPerCurve:d,minSegmentsPerCurve:S}){if(u)return t.push([...e]),t;const m=2*r,E=[n+r*Math.cos(c),s+r*Math.sin(c)],g=[n+r*Math.cos(o),s+r*Math.sin(o)];a.distance2(i,E)>h&&t.push(E);const v=Math.abs(o-c),f=l<m?2*Math.asin(l/m):v,C=p<=r?2*Math.acos(1-p/r):v,P=Math.min(f,C),x=Math.min(d,Math.max(S,Math.ceil(Math.abs(v/P)))),k=1/x;for(let i=1;i<x;i++){const e=i*k,a=c*(1-e)+o*e;t.push([n+r*Math.cos(a),s+r*Math.sin(a)])}return t.push(g),a.distance2(e,g)>h&&t.push([...e]),t}function S(t,i,r,a){if(n.isCoordinate(r))return t.push([...r]),t;if(n.isBezierCurve(r))return function(t,i,e,n){return new p(i,e).densify(t,n)}(t,i,r,a);if(n.isCircularArc(r))return function(t,i,n,s){const r=e.deriveCircleFromCircularArc(i,n),[a]=n.c;return d(t,i,a,r,s)}(t,i,r,a);if(n.isEllipticArc(r)){if(n.isEllipticArc4(r))return function(t,i,e,n){const r=s.deriveCircleFromEllipticArc4(i,e),[a]=e.a;return d(t,i,a,r,n)}(t,i,r,a);if(n.isEllipticArc7(r))return function(t,i,e,n){const[s,r,a,c,h,o,u]=e.a;return 0===o||0===u?(t.push([...s]),t):new l(i,e).densify(t,n)}(t,i,r,a)}return t}t.densifyCurvedGeometry=function(t,i){if(!n.isCurvedGeometry(t))return t;const e=n.getCurves(t),s=[];for(const t of e){const e=[];for(let s=0,r=1;r<t.length;s=r++){const a=n.getEndpoint(t[s]);0===s&&e.push(a),S(e,a,t[r],{maxSegmentLength:i.maxSegmentLength??c.maxSegmentLength,maxDeviation:i.maxDeviation??c.maxDeviation,maxSegmentsPerCurve:i.maxSegmentsPerCurve??c.maxSegmentsPerCurve,minSegmentsPerCurve:Math.max(i.minSegmentsPerCurve??c.minSegmentsPerCurve,1)})}s.push(e)}return"curvePaths"in t?{paths:s,spatialReference:t.spatialReference}:{rings:s,spatialReference:t.spatialReference}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));