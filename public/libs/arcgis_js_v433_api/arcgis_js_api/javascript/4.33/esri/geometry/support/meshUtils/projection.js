// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../projection/computeTranslationToOriginAndRotation","../../projection/projectBuffer","../Ellipsoid","../spatialReferenceUtils","../webMercatorUtils","../buffer/BufferView","../../../chunks/vec3","../../../chunks/vec4"],(function(r,e,t,o,f,n,c,a,i,u,l,T,s,m,V,y){"use strict";function p(e,t,o,f,n){const c=t===r.VectorType.NORMAL?3:4,a=[0,0];for(let r=0,t=1;r<e.length;r+=c,t+=3){f(o[t],a);const i=e[r]*a[0],u=e[r+1]*a[1],l=e[r+2],T=1/Math.sqrt(i*i+u*u+l*l);n[r]=i*T,n[r+1]=u*T,n[r+2]=l*T,4===c&&(n[r+3]=e[r+3])}return n}var P,A;function d(e,o,n,c,a){switch(i.computeTranslationToOriginAndRotation(c,n,N,c),e===A.FROM_PCPF&&f.invert(N,N),o){case r.VectorType.NORMAL:return t.normalFromMat4(a,N);case r.VectorType.TANGENT:return t.fromMat4(a,N)}}function M(e,t,o,f,n,a,i,u){if(!t)return;const l=f.count;if(function(r){return r.isWGS84||T.isCGCS2000(r)||T.isMars(r)||T.isMoon(r)}(n))for(let r=0;r<l;r++)a.getVec(r,F),t.getVec(r,g),c.transformMat3(g,g,d(e,o,F,i,w)),u.setVec(r,g);else for(let n=0;n<l;n++){a.getVec(n,F),t.getVec(n,g);const l=s.y2lat(f.get(n,1));let T=Math.cos(l);o===r.VectorType.TANGENT!=(e===A.TO_PCPF)&&(T=1/T),d(e,o,F,i,w),e===A.TO_PCPF?(w[0]*=T,w[1]*=T,w[2]*=T,w[3]*=T,w[4]*=T,w[5]*=T):(w[0]*=T,w[3]*=T,w[6]*=T,w[1]*=T,w[4]*=T,w[7]*=T),c.transformMat3(g,g,w),c.normalize(g,g),u.setVec(n,g)}return u}r.VectorType=void 0,(P=r.VectorType||(r.VectorType={}))[P.NORMAL=0]="NORMAL",P[P.TANGENT=1]="TANGENT",function(r){r[r.TO_PCPF=0]="TO_PCPF",r[r.FROM_PCPF=1]="FROM_PCPF"}(A||(A={}));const F=a.create(),g=a.create(),N=n.create(),w=o.create();r.loadProjectErrorMessage="Projection may be possible after calling projection.load().",r.logProjectionError=function(r,e,t,o){r.error(`Failed to project from (wkid:${e.wkid}) to (wkid:${t.wkid}).${o?" ":""}${o}`)},r.projectFromPCPF=function(r,e,t,o){return u.projectBuffer(r,e,0,t,o,0)?t:null},r.projectNormalFromPCPF=function(e,t,o,f,n,c){return M(A.FROM_PCPF,m.BufferViewVec3f.fromTypedArray(e),r.VectorType.NORMAL,m.BufferViewVec3f64.fromTypedArray(t),o,m.BufferViewVec3f64.fromTypedArray(f),n,m.BufferViewVec3f.fromTypedArray(c))?c:null},r.projectNormalToPCPF=function(e,t,o,f,n,c){return M(A.TO_PCPF,m.BufferViewVec3f.fromTypedArray(e),r.VectorType.NORMAL,m.BufferViewVec3f64.fromTypedArray(t),o,m.BufferViewVec3f64.fromTypedArray(f),n,m.BufferViewVec3f.fromTypedArray(c))?c:null},r.projectTangentFromPCPF=function(e,t,o,f,n,c){if(!M(A.FROM_PCPF,m.BufferViewVec3f.fromTypedArray(e,16),r.VectorType.TANGENT,m.BufferViewVec3f64.fromTypedArray(t),o,m.BufferViewVec3f64.fromTypedArray(f),n,m.BufferViewVec3f.fromTypedArray(c,16)))return null;for(let r=3;r<e.length;r+=4)c[r]=e[r];return c},r.projectTangentToPCPF=function(e,t,o,f,n,c){if(!M(A.TO_PCPF,m.BufferViewVec3f.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),r.VectorType.TANGENT,m.BufferViewVec3f64.fromTypedArray(t),o,m.BufferViewVec3f64.fromTypedArray(f),n,m.BufferViewVec3f.fromTypedArray(c,4*Float32Array.BYTES_PER_ELEMENT)))return null;for(let r=3;r<e.length;r+=4)c[r]=e[r];return c},r.projectToPCPF=function(r,e,t,o){return u.projectBuffer(r,e,0,t,o,0)?t:null},r.transformNormal=function(r,o,f){return t.normalFromMat4(w,f),V.transformMat3(o,r,w),e.hasScaling(w)&&V.normalize(o,o),o},r.transformTangent=function(r,o,f){return t.fromMat4(w,f),y.transformMat3(o,r,w),e.hasScaling(w)&&V.normalize(o,o,4),o},r.transformVectorENUPlateCarree=function(t,o,f,n){const c=o===r.VectorType.NORMAL;return p(t,o,f,((r,t)=>{const o=Math.cos(e.deg2rad(r));t[0]=c?o:1/o,t[1]=1}),n)},r.transformVectorWMPlateCarree=function(e,t,o,f){const n=t===r.VectorType.NORMAL;return p(e,t,o,((r,e)=>{const t=Math.cosh(-r/l.earth.radius);e[0]=1,e[1]=n?t:1/t}),f)},Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));