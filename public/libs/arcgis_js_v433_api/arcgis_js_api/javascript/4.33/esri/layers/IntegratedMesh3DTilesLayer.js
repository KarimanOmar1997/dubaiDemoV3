// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../chunks/tslib.es6","../request","../core/Error","../core/Logger","../core/mathUtils","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/persistable","../chunks/vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/ellipsoidUtils","../geometry/Extent","../geometry/SpatialReference","../geometry/projection/projectBuffer","./Layer","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/CustomParametersMixin","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./support/commonProperties","./support/SceneModifications","../support/elevationInfoUtils","../chunks/persistableUrlUtils"],(function(e,t,r,i,o,a,s,n,l,c,d,p,u,f,m,y,h,g,x,_,S,b,v,M,A,E,L,I,w,R,V){"use strict";let N=class extends(v.ArcGISService(A.OperationalLayer(E.PortalLayer(L.ScaleRangeLayer(a.MultiOriginJSONMixin(M.CustomParametersMixin(b.APIKeyMixin(S)))))))){readModifications(e,t,r){this._modificationsSource={url:V.fromJSON(e,r),context:r}}initialize(){this.addHandles(n.on((()=>this.modifications),"after-changes",(()=>this.modifications=this.modifications),n.sync))}constructor(e){super(e),this.operationalLayerType="IntegratedMesh3DTilesLayer",this.modifications=null,this._modificationsSource=null,this.spatialReference=new x({wkid:4326,vcsWkid:115700}),this.fullExtent=new g(-180,-90,180,90,this.spatialReference),this.url=null,this.type="integrated-mesh-3dtiles",this.path=null,this.minScale=0,this.maxScale=0,this.rootTilesetJSON=null}set elevationInfo(e){null!=e&&"absolute-height"!==e.mode||this._set("elevationInfo",e),this._validateElevationInfo(e)}_verifyArray(e,t){if(!Array.isArray(e)||e.length<t)return!1;for(const t of e)if("number"!=typeof t)return!1;return!0}_initFullExtent(){const e=this.rootTilesetJSON?.root?.boundingVolume;if(!e)return;if(e.box){const t=e?.box;if(t[3]>7645211&&t[7]>7645211&&t[11]>7645211)return}const t=this.rootTilesetJSON?.root?.transform,r=y.create();if(e.region&&this._verifyArray(e.region,6)){const t=e.region,r=o.rad2deg(t[0]),i=o.rad2deg(t[1]),a=t[4],s=o.rad2deg(t[2]),n=o.rad2deg(t[3]),l=t[5];this.fullExtent=new g({xmin:r,ymin:i,zmin:a,xmax:s,ymax:n,zmax:l,spatialReference:this.spatialReference})}else if(e.sphere&&this._verifyArray(e.sphere,4)){const i=e.sphere,o=y.fromValues(i[0],i[1],i[2]),a=i[3]/Math.sqrt(3),s=y.create();m.subtract(s,o,y.fromValues(a,a,a));const n=y.create();if(m.add(n,o,y.fromValues(a,a,a)),t&&this._verifyArray(t,16)){const e=t;m.transformMat4(r,s,e),m.copy(s,r),m.transformMat4(r,n,e),m.copy(n,r)}_.projectBuffer(s,h.WGS84ECEFSpatialReferenceLike,0,s,x.WGS84,0),_.projectBuffer(n,h.WGS84ECEFSpatialReferenceLike,0,n,x.WGS84,0);const l=y.create(),c=y.create();m.min(l,s,n),m.max(c,s,n),this.fullExtent=new g({xmin:l[0],ymin:l[1],zmin:l[2],xmax:c[0],ymax:c[1],zmax:c[2],spatialReference:this.spatialReference})}else if(e.box&&this._verifyArray(e.box,12)){const r=e.box,i=y.fromValues(r[0],r[1],r[2]),o=y.fromValues(r[3],r[4],r[5]),a=y.fromValues(r[6],r[7],r[8]),s=y.fromValues(r[9],r[10],r[11]),n=[];for(let e=0;e<8;++e)n.push(y.create());if(m.add(n[0],i,o),m.add(n[0],n[0],a),m.add(n[0],n[0],s),m.sub(n[1],i,o),m.add(n[1],n[1],a),m.add(n[1],n[1],s),m.add(n[2],i,o),m.sub(n[2],n[2],a),m.add(n[2],n[2],s),m.sub(n[3],i,o),m.sub(n[3],n[3],a),m.add(n[3],n[3],s),m.add(n[4],i,o),m.add(n[4],n[4],a),m.sub(n[4],n[4],s),m.sub(n[5],i,o),m.add(n[5],n[5],a),m.sub(n[5],n[5],s),m.add(n[6],i,o),m.sub(n[6],n[6],a),m.sub(n[6],n[6],s),m.sub(n[7],i,o),m.sub(n[7],n[7],a),m.sub(n[7],n[7],s),t&&this._verifyArray(t,16)){const e=t;for(let t=0;t<8;++t)m.transformMat4(n[t],n[t],e)}const l=y.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),c=y.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let e=0;e<8;++e)_.projectBuffer(n[e],h.WGS84ECEFSpatialReferenceLike,0,n[e],x.WGS84,0),m.min(c,c,n[e]),m.max(l,l,n[e]);this.fullExtent=new g({xmin:c[0],ymin:c[1],zmin:c[2],xmax:l[0],ymax:l[1],zmax:l[2],spatialReference:this.spatialReference})}}async load(e){return this.addResolvingPromise(this._doLoad(e)),this}async _doLoad(e){const i=null!=e?e.signal:null;try{await this.loadFromPortal({supportedTypes:["3DTiles Service"],validateItem:e=>{if(e.typeKeywords?.includes("IntegratedMesh"))return!0;throw new r("portal:invalid-layer-item-type","Invalid layer item, expected '${expectedType}' ",{expectedType:"3DTiles Service containing IntegratedMesh"})}},e)}catch(e){s.throwIfAbortError(e)}if(null!=this._modificationsSource){const t=await w.fromUrl(this._modificationsSource.url,this.spatialReference,e);this.setAtOrigin("modifications",t,this._modificationsSource.context.origin),this._modificationsSource=null}if(this.url){const e=t(this.url,{query:{...this.customParameters,token:this.apiKey},responseType:"json",signal:i}).then((e=>{this.rootTilesetJSON=e.data,this._initFullExtent()}),(e=>{s.throwIfAbortError(e)}));await e}}beforeSave(){if(null!=this._modificationsSource)return this.load().then((()=>{}),(()=>{}))}async fetchAttributionData(){return this.load().then((()=>({})))}_validateElevationInfo(e){const t="Integrated mesh 3d tiles layers";R.logInvalidElevationInfoWarning(i.getLogger(this),R.elevationModeRequiredMessage(t,"absolute-height",e)),R.logInvalidElevationInfoWarning(i.getLogger(this),R.featureExpressionUnsupportedMessage(t,e))}};return e.__decorate([l.property({type:["IntegratedMesh3DTilesLayer"]})],N.prototype,"operationalLayerType",void 0),e.__decorate([l.property({type:w,clonable:e=>e.clone()}),f.persistable({origins:["web-scene","portal-item"],type:"resource",prefix:"modifications"})],N.prototype,"modifications",void 0),e.__decorate([p.reader(["web-scene","portal-item"],"modifications")],N.prototype,"readModifications",null),e.__decorate([l.property({type:x})],N.prototype,"spatialReference",void 0),e.__decorate([l.property({type:g})],N.prototype,"fullExtent",void 0),e.__decorate([l.property(I.elevationInfo)],N.prototype,"elevationInfo",null),e.__decorate([l.property({type:["show","hide"]})],N.prototype,"listMode",void 0),e.__decorate([l.property(I.url)],N.prototype,"url",void 0),e.__decorate([l.property({readOnly:!0})],N.prototype,"type",void 0),e.__decorate([l.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],N.prototype,"path",void 0),e.__decorate([l.property({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:!1,write:!1}}}})],N.prototype,"minScale",void 0),e.__decorate([l.property({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:!1,write:!1}}}})],N.prototype,"maxScale",void 0),N=e.__decorate([u.subclass("esri.layers.IntegratedMesh3DTilesLayer")],N),N}));