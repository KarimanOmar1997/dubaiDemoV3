// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
require({cache:{"esri/layers/mixins/ArcGISCachedService":function(){define(["exports","../../chunks/tslib.es6","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../geometry/SpatialReference","../support/TileInfo","../support/TileInfoTilemapCache","../support/TilemapCache"],(function(e,r,t,i,o,a,s,l,n,p,c,u){"use strict";e.ArcGISCachedService=e=>{let i=class extends e{constructor(){super(...arguments),this.copyright=null,this.minScale=0,this.maxScale=0,this.spatialReference=null,this.tileInfo=null,this.tilemapCache=null}destroy(){this.tilemapCache?.destroy?.()}readMinScale(e,r){return null!=r.minLOD&&null!=r.maxLOD?e:0}readMaxScale(e,r){return null!=r.minLOD&&null!=r.maxLOD?e:0}get supportsBlankTile(){return this.version>=10.2}readTilemapCache(e,r,t){const i=r.capabilities?.includes("Tilemap");let{minLOD:o,maxLOD:a,minScale:s,maxScale:l}=r;if(null==o&&null==a&&(0!==s||0!==l)){const e=e=>Math.round(1e4*e)/1e4;s=e(s||r.tileInfo.lods[0].scale),l=e(l||r.tileInfo.lods[r.tileInfo.lods.length-1].scale);for(const t of r.tileInfo.lods){const r=e(t.scale);o=r>=s?t.level:o,a=r>=l?t.level:a}}if(i)return new u.TilemapCache({layer:this,minLOD:o,maxLOD:a});if(r.tileInfo){const e=new p;return e.read(r.tileInfo,t),new c(e,o,a)}return null}};return r.__decorate([t.property({json:{read:{source:"copyrightText"}}})],i.prototype,"copyright",void 0),r.__decorate([t.property()],i.prototype,"minScale",void 0),r.__decorate([s.reader("service","minScale")],i.prototype,"readMinScale",null),r.__decorate([t.property()],i.prototype,"maxScale",void 0),r.__decorate([s.reader("service","maxScale")],i.prototype,"readMaxScale",null),r.__decorate([t.property({type:n})],i.prototype,"spatialReference",void 0),r.__decorate([t.property({readOnly:!0})],i.prototype,"supportsBlankTile",null),r.__decorate([t.property({type:p})],i.prototype,"tileInfo",void 0),r.__decorate([t.property()],i.prototype,"tilemapCache",void 0),r.__decorate([s.reader("service","tilemapCache",["capabilities","tileInfo"])],i.prototype,"readTilemapCache",null),r.__decorate([t.property()],i.prototype,"version",void 0),i=r.__decorate([l.subclass("esri.layers.mixins.ArcGISCachedService")],i),i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/TileInfo":function(){define(["exports","../../chunks/tslib.es6","../../core/jsonMap","../../core/JSONSupport","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/aaBoundingRect","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","./LOD","./TileKey"],(function(e,r,t,i,o,a,s,l,n,p,c,u,d,y,h,f,m,b,g){"use strict";var v;const _=new t.JSONMap({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});var S,w;return e.default=class extends i{static{v=this}static create(e={}){const{resolutionFactor:r=1,scales:t,size:i=256,spatialReference:a=y.WebMercator,numLODs:s=24}=e;if(!f.isValid(a)){const e=[];if(t)for(let r=0;r<t.length;r++){const i=t[r];e.push(new b({level:r,scale:i,resolution:i}))}else{let r=5e-4;for(let t=s-1;t>=0;t--)e.unshift(new b({level:t,scale:r,resolution:r})),r*=2}return new v({dpi:96,lods:e,origin:new d(0,0,a),size:[i,i],spatialReference:a})}const l=f.getInfo(a),n=e.origin?new d({x:e.origin.x,y:e.origin.y,spatialReference:a}):new d(l?{x:l.origin[0],y:l.origin[1],spatialReference:a}:{x:0,y:0,spatialReference:a}),p=1/(39.37*o.getMetersPerUnitForSR(a)*96),c=[];if(t)for(let e=0;e<t.length;e++){const r=t[e],i=r*p;c.push(new b({level:e,scale:r,resolution:i}))}else{let e=f.isGeographic(a)?512/i*591657527.5917094:256/i*591657527.591555;const t=Math.ceil(s/r);c.push(new b({level:0,scale:e,resolution:e*p}));for(let i=1;i<t;i++){const t=e/2**r,o=t*p;c.push(new b({level:i,scale:t,resolution:o})),e=t}}return new v({dpi:96,lods:c,origin:n,size:[i,i],spatialReference:a})}constructor(e){super(e),this.dpi=96,this.format=null,this.origin=null,this.size=null,this.spatialReference=null}get isWrappable(){const{spatialReference:e,origin:r}=this;if(e&&r){const t=f.getInfo(e);return e.isWrappable&&!!t&&Math.abs(t.origin[0]-r.x)<=t.dx}return!1}readOrigin(e,r){return d.fromJSON({spatialReference:r.spatialReference,...e})}set lods(e){let r=0,t=0;const i=[],o=this._levelToLOD={};e&&(r=-1/0,t=1/0,e.forEach((e=>{i.push(e.scale),r=e.scale>r?e.scale:r,t=e.scale<t?e.scale:t,o[e.level]=e}))),this._set("scales",i),this._set("lods",e),this._initializeUpsampleLevels()}readSize(e,r){return[r.cols,r.rows]}writeSize(e,r){r.cols=e[0],r.rows=e[1]}zoomToScale(e){const r=this.scales;if(e<=0)return r[0];if(e>=r.length-1)return r[r.length-1];const t=Math.floor(e),i=t+1;return r[t]/(r[t]/r[i])**(e-t)}scaleToZoom(e){const r=this.scales,t=r.length-1;let i=0;for(;i<t;i++){const t=r[i],o=r[i+1];if(t<=e)return i;if(o===e)return i+1;if(t>e&&o<e)return i+Math.log(t/e)/Math.log(t/o)}return i}tileAt(e,r,t,i){const o=this.lodAt(e);if(!o)return null;let a,s;if("number"==typeof r)a=r,s=t;else if(f.equals(r.spatialReference,this.spatialReference))a=r.x,s=r.y,i=t;else{const e=m.project(r,this.spatialReference);if(null==e)return null;a=e.x,s=e.y,i=t}const l=o.resolution*this.size[0],n=o.resolution*this.size[1];return i||(i=new g.TileKey(null,0,0,0,h.create())),i.level=e,i.row=Math.floor((this.origin.y-s)/n+.001),i.col=Math.floor((a-this.origin.x)/l+.001),this.updateTileInfo(i),i}updateTileInfo(e,r=v.ExtrapolateOptions.NONE){let t=this.lodAt(e.level);if(!t&&r===v.ExtrapolateOptions.POWER_OF_TWO){const r=this.lods[this.lods.length-1];r.level<e.level&&(t=r)}if(!t)return;const i=e.level-t.level,o=t.resolution*this.size[0]/2**i,a=t.resolution*this.size[1]/2**i;e.id=`${e.level}/${e.row}/${e.col}`,e.extent||(e.extent=h.create()),e.extent[0]=this.origin.x+e.col*o,e.extent[1]=this.origin.y-(e.row+1)*a,e.extent[2]=e.extent[0]+o,e.extent[3]=e.extent[1]+a}upsampleTile(e){const r=this._upsampleLevels[e.level];return!(!r||-1===r.parentLevel||(e.level=r.parentLevel,e.row=Math.floor(e.row/r.factor+.001),e.col=Math.floor(e.col/r.factor+.001),this.updateTileInfo(e),0))}getTileBounds(e,r){const t=this.lodAt(r.level);if(null==t)return null;const{resolution:i}=t,o=i*this.size[0],a=i*this.size[1];return e[0]=this.origin.x+r.col*o,e[1]=this.origin.y-(r.row+1)*a,e[2]=e[0]+o,e[3]=e[1]+a,e}lodAt(e){return this._levelToLOD?.[e]??null}clone(){return v.fromJSON(this.write({}))}getCompatibleForVTL(e){if(this.size[0]!==this.size[1]||256===this.size[0]&&512===e)return null;const r=(512===this.size[0]&&256===e?-1:0)+(this.spatialReference.isGeographic?1:0);if(this.size[0]===e&&0===r)return this;const t=[],i=this.lods.length-r;for(let e=0;e<i;e++){const i=e+r,{scale:o,resolution:a}=i>=0?this.lods[i]:{scale:2*this.lods[0].scale,resolution:2*this.lods[0].resolution};t.push(new b({level:e,scale:o,resolution:a}))}return new v({size:[e,e],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:t})}_initializeUpsampleLevels(){const e=this.lods;this._upsampleLevels=[];let r=null;for(let t=0;t<e.length;t++){const i=e[t];this._upsampleLevels[i.level]={parentLevel:r?r.level:-1,factor:r?r.resolution/i.resolution:0},r=i}}},r.__decorate([a.property({type:Number,json:{write:!0}})],e.default.prototype,"compressionQuality",void 0),r.__decorate([a.property({type:Number,json:{write:!0}})],e.default.prototype,"dpi",void 0),r.__decorate([a.property({type:String,json:{read:_.read,write:_.write,origins:{"web-scene":{read:!1,write:!1}}}})],e.default.prototype,"format",void 0),r.__decorate([a.property({readOnly:!0})],e.default.prototype,"isWrappable",null),r.__decorate([a.property({type:d,json:{write:!0}})],e.default.prototype,"origin",void 0),r.__decorate([p.reader("origin")],e.default.prototype,"readOrigin",null),r.__decorate([a.property({type:[b],value:null,json:{write:!0}})],e.default.prototype,"lods",null),r.__decorate([a.property({readOnly:!0})],e.default.prototype,"scales",void 0),r.__decorate([a.property({cast:e=>Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]})],e.default.prototype,"size",void 0),r.__decorate([p.reader("size",["rows","cols"])],e.default.prototype,"readSize",null),r.__decorate([u.writer("size",{cols:{type:s.Integer},rows:{type:s.Integer}})],e.default.prototype,"writeSize",null),r.__decorate([a.property({type:y,json:{write:!0}})],e.default.prototype,"spatialReference",void 0),e.default=v=r.__decorate([c.subclass("esri.layers.support.TileInfo")],e.default),(w=(S=e.default||(e.default={})).ExtrapolateOptions||(S.ExtrapolateOptions={}))[w.NONE=0]="NONE",w[w.POWER_OF_TWO=1]="POWER_OF_TWO",e.default}))},"esri/layers/support/LOD":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,r,t,i,o,a,s,l){"use strict";var n;return e.default=class extends t{static{n=this}constructor(e){super(e),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new n({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}},r.__decorate([i.property({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.default.prototype,"cols",void 0),r.__decorate([i.property({type:o.Integer,json:{write:!0}})],e.default.prototype,"level",void 0),r.__decorate([i.property({type:String,json:{write:!0}})],e.default.prototype,"levelValue",void 0),r.__decorate([i.property({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.default.prototype,"origin",void 0),r.__decorate([i.property({type:Number,json:{write:!0}})],e.default.prototype,"resolution",void 0),r.__decorate([i.property({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.default.prototype,"rows",void 0),r.__decorate([i.property({type:Number,json:{write:!0}})],e.default.prototype,"scale",void 0),e.default=n=r.__decorate([l.subclass("esri.layers.support.LOD")],e.default),e.default}))},"esri/layers/support/TileKey":function(){define(["exports"],(function(e){"use strict";e.TileKey=class{constructor(e,r,t,i,o=void 0){this.id=e,this.level=r,this.row=t,this.col=i,this.extent=o}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/TileInfoTilemapCache":function(){define(["../../core/Error","../../core/promiseUtils"],(function(e,r){"use strict";return class{constructor(e,r=0,t=e.lods[e.lods.length-1].level){this.tileInfo=e,this.minLOD=r,this.maxLOD=t,e.lodAt(r)||(this.minLOD=e.lods[0].level),e.lodAt(t)||(this.maxLOD=e.lods[e.lods.length-1].level)}get effectiveMinLOD(){return this.minLOD??this.tileInfo.lods[0].level}get effectiveMaxLOD(){return this.maxLOD??this.tileInfo.lods[this.tileInfo.lods.length-1].level}getAvailability(e,r,t){const i=this.tileInfo?.lodAt(e);return!i||e<this.minLOD||e>this.maxLOD?"unavailable":i.cols&&i.rows?t>=i.cols[0]&&t<=i.cols[1]&&r>=i.rows[0]&&r<=i.rows[1]?"unknown":"unavailable":"unknown"}async fetchAvailability(t,i,o,a){await r.waitTick(a);const s=this.getAvailability(t,i,o);if("unavailable"===s)throw new e("tile-map:tile-unavailable","Tile is not available",{level:t,row:i,col:o});return s}async fetchAvailabilityUpsample(e,t,i,o,a){await r.waitTick(a),o.level=e,o.row=t,o.col=i;const s=this.tileInfo;return s.updateTileInfo(o),this.fetchAvailability(e,t,i,a).catch((e=>{if(r.isAbortError(e))throw e;if(s.upsampleTile(o))return this.fetchAvailabilityUpsample(o.level,o.row,o.col,o,a);throw e}))}}}))},"esri/layers/support/TilemapCache":function(){define(["exports","../../chunks/tslib.es6","../../request","../../core/Accessor","../../core/ByteSizeUnit","../../core/Error","../../core/handleUtils","../../core/has","../../core/LRUCache","../../core/PooledArray","../../core/promiseUtils","../../core/reactiveUtils","../../core/scheduling","../../core/urlUtils","../../core/accessorSupport/decorators/property","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./TileKey","./Tilemap"],(function(e,r,t,i,o,a,s,l,n,p,c,u,d,y,h,f,m,b,g,v){"use strict";var _;function S(e,r,t){return new a("tile-map:tile-unavailable","Tile is not available",{level:e,row:r,col:t})}e.TilemapCache=class extends i{static{_=this}constructor(e){super(e),this._pendingTilemapRequests={},this.request=t,this.size=32,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new n.LRUCache(2*o.ByteSizeUnit.MEGABYTES),this.addHandles(u.watch((()=>{const{layer:e}=this;return[e?.parsedUrl,e?.tileServers,e?.apiKey,e?.customParameters]}),(()=>this._initializeTilemapDefinition()),u.initial))}get effectiveMinLOD(){return this.minLOD??this.layer.tileInfo.lods[0].level}get effectiveMaxLOD(){return this.maxLOD??this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}getAvailability(e,r,t){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return"unavailable";const i=this._tilemapFromCache(e,r,t,this._tmpTilemapDefinition);return i?i.getAvailability(r,t):"unknown"}fetchAvailability(e,r,t,i){return!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD?Promise.reject(S(e,r,t)):this._fetchTilemap(e,r,t,i).catch((e=>e)).then((i=>{if(i instanceof v.Tilemap){const o=i.getAvailability(r,t);if("unavailable"===o)throw S(e,r,t);return o}if(c.isAbortError(i))throw i;return"unknown"}))}fetchAvailabilityUpsample(e,r,t,i,o){i.level=e,i.row=r,i.col=t;const a=this.layer.tileInfo;a.updateTileInfo(i);const s=this.fetchAvailability(e,r,t,o).catch((e=>{if(c.isAbortError(e))throw e;if(a.upsampleTile(i))return this.fetchAvailabilityUpsample(i.level,i.row,i.col,i,o);throw e}));return this._fetchAvailabilityUpsamplePrefetch(i.id,e,r,t,o,s),s}async _fetchAvailabilityUpsamplePrefetch(e,r,t,i,o,a){if(!this._prefetchingEnabled||null==e)return;const l=`prefetch-${e}`;if(this.hasHandles(l))return;const n=new AbortController;a.then((()=>n.abort()),(()=>n.abort()));let p=!1;const u=s.makeHandle((()=>{p||(p=!0,n.abort())}));if(this.addHandles(u,l),await d.waitTicks(10,n.signal).catch((()=>{})),p||(p=!0,this.removeHandles(l)),c.isAborted(n))return;const y=new g.TileKey(e,r,t,i),h={...o,signal:n.signal},f=this.layer.tileInfo;for(let e=0;_._prefetches.length<_._maxPrefetch&&f.upsampleTile(y);++e){const e=this.fetchAvailability(y.level,y.row,y.col,h);_._prefetches.push(e);const r=()=>{_._prefetches.removeUnordered(e)};e.then(r,r)}}static{this._maxPrefetch=4}static{this._prefetches=new p({initialSize:_._maxPrefetch})}_fetchTilemap(e,r,t,i){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return Promise.reject(new a("tilemap-cache:level-unavailable",`Level ${e} is unavailable in the service`));const o=this._tmpTilemapDefinition,s=this._tilemapFromCache(e,r,t,o);if(s)return Promise.resolve(s);const l=i?.signal;return i={...i,signal:null},new Promise(((e,r)=>{c.onAbort(l,(()=>r(c.createAbortError())));const t=v.tilemapDefinitionId(o);let a=this._pendingTilemapRequests[t];if(!a){a=v.Tilemap.fromDefinition(o,i).then((e=>(this._tilemapCache.put(t,e,e.byteSize),e)));const e=()=>{delete this._pendingTilemapRequests[t]};this._pendingTilemapRequests[t]=a,a.then(e,e)}a.then(e,r)}))}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;const{parsedUrl:e,apiKey:r,customParameters:t}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:y.objectToQuery({...e.query,...t,token:r??e.query?.token}),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(e,r,t,i){i.level=e,i.row=r-r%this.size,i.col=t-t%this.size;const o=v.tilemapDefinitionId(i);return this._tilemapCache.get(o)}get test(){}},r.__decorate([h.property({constructOnly:!0})],e.TilemapCache.prototype,"layer",void 0),r.__decorate([h.property({constructOnly:!0})],e.TilemapCache.prototype,"minLOD",void 0),r.__decorate([h.property({constructOnly:!0})],e.TilemapCache.prototype,"maxLOD",void 0),r.__decorate([h.property({constructOnly:!0})],e.TilemapCache.prototype,"request",void 0),r.__decorate([h.property({constructOnly:!0})],e.TilemapCache.prototype,"size",void 0),e.TilemapCache=_=r.__decorate([b.subclass("esri.layers.support.TilemapCache")],e.TilemapCache),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/ByteSizeUnit":function(){define(["exports"],(function(e){"use strict";var r;e.ByteSizeUnit=void 0,(r=e.ByteSizeUnit||(e.ByteSizeUnit={}))[r.KILOBYTES=1024]="KILOBYTES",r[r.MEGABYTES=1048576]="MEGABYTES",r[r.GIGABYTES=1073741824]="GIGABYTES",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/Tilemap":function(){define(["exports","../../request","../../core/Error","../../core/lang","../../core/memoryEstimations","../../geometry/support/UintArray"],(function(e,r,t,i,o,a){"use strict";class s{constructor(e){!function(e){if(!e?.location)throw new t("tilemap:missing-location","Location missing from tilemap response");if(!1===e.valid)throw new t("tilemap:invalid","Tilemap response was marked as invalid");if(!e.data)throw new t("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(e.data))throw new t("tilemap:data-mismatch","Data must be an array of numbers");if(e.data.length!==e.location.width*e.location.height)throw new t("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}(e);const{location:r,data:s}=e;this.location=Object.freeze(i.clone(r));const l=this.location.width,n=this.location.height;let p=!0,c=!0;const u=Math.ceil(l*n/32),d=a.newUintArray(u);let y=0;for(let e=0;e<s.length;e++){const r=e%32;s[e]?(c=!1,d[y]|=1<<r):p=!1,31===r&&++y}c?(this._availability="unavailable",this.byteSize=40):p?(this._availability="available",this.byteSize=40):(this._availability=d,this.byteSize=40+o.estimateNumberArrayMemory(d))}getAvailability(e,r){if("unavailable"===this._availability||"available"===this._availability)return this._availability;const t=(e-this.location.top)*this.location.width+(r-this.location.left),i=t%32,o=t>>5,a=this._availability;return o<0||o>a.length?"unknown":a[o]&1<<i?"available":"unavailable"}static fromDefinition(e,i){const o=e.service.request||r,{row:a,col:l,width:n,height:p}=e,c={query:{f:"json"}};return i=i?{...c,...i}:c,o(function(e){let r;if(e.service.tileServers?.length){const t=e.service.tileServers;r=`${t&&t.length?t[e.row%t.length]:e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}else r=`${e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`;const t=e.service.query;return t&&(r=`${r}?${t}`),r}(e),i).then((e=>e.data)).catch((e=>{if(422===e?.details?.httpStatus)return{location:{top:a,left:l,width:n,height:p},valid:!0,data:new Array(n*p).fill(0)};throw e})).then((e=>{if(e.location&&(e.location.top!==a||e.location.left!==l||e.location.width!==n||e.location.height!==p))throw new t("tilemap:location-mismatch","Tilemap response for different location than requested",{response:e,definition:{top:a,left:l,width:n,height:p}});return s.fromJSON(e)}))}static fromJSON(e){return Object.freeze(new s(e))}}e.Tilemap=s,e.tilemapDefinitionId=function(e){return`${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/UintArray":function(){define(["exports","../../core/typedArrayUtil"],(function(e,r){"use strict";e.newUintArray=function(e,t=!1){return e<=r.nativeArrayMaxSize?t?new Array(e).fill(0):new Array(e):new Uint32Array(e)},e.uintSubArray=function(e,r,t){return Array.isArray(e)?e.slice(r,r+t):e.subarray(r,r+t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/mixins/ArcGISMapService":function(){define(["exports","../../chunks/tslib.es6","../../request","../../core/MapUtils","../../core/promiseUtils","../../core/urlUtils","../../core/Version","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/PropertyOrigin","../../geometry/Extent","../../geometry/SpatialReference","../support/arcgisLayerUrl","../support/commonProperties","../../portal/support/portalItemUtils"],(function(e,r,t,i,o,a,s,l,n,p,c,u,d,y,h,f,m,b,g){"use strict";e.ArcGISMapService=e=>{let n=class extends e{constructor(){super(...arguments),this.capabilities=void 0,this.copyright=null,this.fullExtent=null,this.legendEnabled=!0,this.spatialReference=null,this.version=void 0,this._allLayersAndTablesMap=null}readCapabilities(e,r){const t=r.capabilities&&r.capabilities.split(",").map((e=>e.toLowerCase().trim()));if(!t)return{operations:{supportsExportMap:!1,supportsExportTiles:!1,supportsIdentify:!1,supportsQuery:!1,supportsTileMap:!1},exportMap:null,exportTiles:null};const i=this.type,o="tile"!==i&&!!r.supportsDynamicLayers,a=t.includes("query"),l=t.includes("map"),n=!!r.exportTilesAllowed,p=t.includes("tilemap"),c=t.includes("data"),u="tile"!==i&&(!r.tileInfo||o),d="tile"!==i&&(!r.tileInfo||o),y="tile"!==i,h="tile"!==i&&o&&r.currentVersion>=11.1,f=r.cimVersion?s.Version.parse(r.cimVersion):null,m=f?.greaterEqual(1,4)??!1,b=f?.greaterEqual(2,0)??!1;return{operations:{supportsExportMap:l,supportsExportTiles:n,supportsIdentify:a,supportsQuery:c,supportsTileMap:p},exportMap:l?{supportsArcadeExpressionForLabeling:m,supportsCIMSymbols:b,supportsDynamicLayers:o,supportsSublayerOrderBy:h,supportsSublayerDefinitionExpression:d,supportsSublayerVisibility:u,supportsSublayersChanges:y}:null,exportTiles:n?{maxExportTilesCount:+r.maxExportTilesCount}:null}}readVersion(e,r){let t=r.currentVersion;return t||(t=r.hasOwnProperty("capabilities")||r.hasOwnProperty("tables")?10:r.hasOwnProperty("supportedImageFormatTypes")?9.31:9.3),t}async fetchRelatedService(e){const r=this.portalItem;if(!r||!g.isHostedLayer(r))return null;this._relatedFeatureServicePromise||(this._relatedFeatureServicePromise=r.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},e).then((e=>e.find((e=>"Feature Service"===e.type))??null),(()=>null)));const t=await this._relatedFeatureServicePromise;return o.throwIfAborted(e),t?{itemId:t.id,url:t.url}:null}async fetchSublayerInfo(e,r){const{source:i}=e;if(this?.portalItem&&"tile"===this.type&&"map-layer"===i?.type&&g.isHostedLayer(this.portalItem)&&e.originIdOf("url")<y.OriginId.SERVICE){const t=await this.fetchRelatedService(r);t&&(e.url=a.join(t.url,i.mapLayerId.toString()),e.layerItemId=t.itemId)}const{url:o}=e;let s;if("data-layer"===i.type)s=(await t(o,{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey},...r})).data;else if(o&&e.originIdOf("url")>y.OriginId.SERVICE)try{const e=await this._fetchAllLayersAndTablesFromService(o),r=m.parse(o)?.sublayer??i.mapLayerId;s=e.get(r)}catch{}else{let t=e.id;"map-layer"===i?.type&&(t=i.mapLayerId);try{s=(await this.fetchAllLayersAndTables(r)).get(t)}catch{}}return s}async fetchAllLayersAndTables(e){return this._fetchAllLayersAndTablesFromService(this.parsedUrl?.path,e)}async _fetchAllLayersAndTablesFromService(e,r){await this.load(r),this._allLayersAndTablesMap||=new Map;const s=m.parse(e),l=i.getOrCreateMapValue(this._allLayersAndTablesMap,s?.url.path,(()=>t(a.join(s?.url.path,"/layers"),{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey}}).then((e=>{const r=new Map,{layers:t,tables:i}=e.data,o=[...t??[],...i??[]];for(const e of o)r.set(e.id,e);return{result:r}}),(e=>({error:e}))))),n=await l;if(o.throwIfAborted(r),"result"in n)return n.result;throw n.error}};return r.__decorate([l.property({readOnly:!0})],n.prototype,"capabilities",void 0),r.__decorate([u.reader("service","capabilities",["capabilities","cimVersion","currentVersion","exportTilesAllowed","maxExportTilesCount","supportsDynamicLayers","tileInfo"])],n.prototype,"readCapabilities",null),r.__decorate([l.property({json:{read:{source:"copyrightText"}}})],n.prototype,"copyright",void 0),r.__decorate([l.property({type:h})],n.prototype,"fullExtent",void 0),r.__decorate([l.property(b.id)],n.prototype,"id",void 0),r.__decorate([l.property({type:Boolean,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend"}}})],n.prototype,"legendEnabled",void 0),r.__decorate([l.property(b.popupEnabled)],n.prototype,"popupEnabled",void 0),r.__decorate([l.property({type:f})],n.prototype,"spatialReference",void 0),r.__decorate([l.property({readOnly:!0})],n.prototype,"version",void 0),r.__decorate([u.reader("service","version",["currentVersion","capabilities","tables","supportedImageFormatTypes"])],n.prototype,"readVersion",null),n=r.__decorate([d.subclass("esri.layers.mixins.ArcGISMapService")],n),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/mixins/SublayersOwner":function(){define(["exports","../../chunks/tslib.es6","../../core/Collection","../../core/CollectionFlattener","../../core/Error","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/utils","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/PropertyOrigin","../support/Sublayer","../support/sublayerUtils"],(function(e,r,t,i,o,a,s,l,n,p,c,u,d,y,h){"use strict";const f=t.ofType(y);function m(e,r){e&&e.forEach((e=>{r(e),e.sublayers&&e.sublayers.length&&m(e.sublayers,r)}))}e.SublayersOwner=e=>{let n=class extends e{constructor(...e){super(...e),this.allSublayers=new i({getCollections:()=>[this.sublayers],getChildrenFunction:e=>e.sublayers}),this.sublayersSourceJSON={[d.OriginId.SERVICE]:{},[d.OriginId.PORTAL_ITEM]:{},[d.OriginId.WEB_SCENE]:{},[d.OriginId.WEB_MAP]:{},[d.OriginId.LINK_CHART]:{}},this.subtables=null,this.addHandles([s.watch((()=>this.sublayers),((e,r)=>this._handleSublayersChange(e,r)),s.sync),s.watch((()=>this.subtables),((e,r)=>this._handleSublayersChange(e,r)),s.sync)])}destroy(){this.allSublayers.destroy()}readSublayers(e,r){if(!r||!e)return;const{sublayersSourceJSON:t}=this,i=d.nameToId(r.origin);if(i<d.OriginId.SERVICE)return;if(t[i]={context:r,visibleLayers:e.visibleLayers||t[i].visibleLayers,layers:e.layers||t[i].layers},i>d.OriginId.SERVICE)return;this._set("serviceSublayers",this.createSublayersForOrigin("service").sublayers);const{sublayers:o,origin:a}=this.createSublayersForOrigin("web-document"),s=c.getProperties(this);s.setDefaultOrigin(a),this._set("sublayers",new f(o)),s.setDefaultOrigin("user")}findSublayerById(e){return this.allSublayers.find((r=>r.id===e))}createServiceSublayers(){return this.createSublayersForOrigin("service").sublayers}createSublayersForOrigin(e){let r;const t="web-document"===e?d.nameToId("web-map"):d.nameToId(e);let i=d.OriginId.SERVICE,o=this.sublayersSourceJSON[d.OriginId.SERVICE].layers,a=this.sublayersSourceJSON[d.OriginId.SERVICE].context,s=null;const l=[d.OriginId.PORTAL_ITEM,d.OriginId.WEB_SCENE,d.OriginId.WEB_MAP].filter((e=>e<=t));for(const e of l){const r=this.sublayersSourceJSON[e];h.isSublayerOverhaul(r.layers)&&(i=e,o=r.layers,a=r.context,r.visibleLayers&&(s={visibleLayers:r.visibleLayers,context:r.context}))}const n=[d.OriginId.PORTAL_ITEM,d.OriginId.WEB_SCENE,d.OriginId.WEB_MAP].filter((e=>e>i&&e<=t));let p=null;for(const e of n){const{layers:t,visibleLayers:i,context:o}=this.sublayersSourceJSON[e];t&&(p={layers:t,context:o},r??=e),i&&(s={visibleLayers:i,context:o})}const c=function(e,r){const t=[],i={};return e?(e.forEach((e=>{const o=new y;if(o.read(e,r),i[o.id]=o,null!=e.parentLayerId&&-1!==e.parentLayerId){const r=i[e.parentLayerId];r.sublayers||(r.sublayers=[]),r.sublayers.unshift(o)}else t.unshift(o)})),t):t}(o,a),u=new Map,b=new Set;if(p)for(const e of p.layers)u.set(e.id,e);if(s?.visibleLayers)for(const e of s.visibleLayers)b.add(e);return m(c,(e=>{p&&e.read(u.get(e.id),p.context),s&&e.read({defaultVisibility:b.has(e.id)},s.context)})),{origin:d.idToName(i),originWithPartialOverrides:r?d.idToName(r):null,sublayers:new f({items:c})}}read(e,r){super.read(e,r),this.readSublayers(e,r)}_handleSublayersChange(e,r){r&&(r.forEach((e=>{e.parent=null,e.layer=null})),this.removeHandles("sublayers-owner")),e&&(e.forEach((e=>{e.parent=this,e.layer=this})),this.addHandles([e.on("after-add",(({item:e})=>{e.parent=this,e.layer=this})),e.on("after-remove",(({item:e})=>{e.parent=null,e.layer=null}))],"sublayers-owner"),"tile"===this.type&&this.addHandles(e.on("before-changes",(e=>{a.getLogger("esri.layers.TileLayer").error(new o("tilelayer:sublayers-non-modifiable","ISublayer can't be added, moved, or removed from the layer's sublayers",{layer:this})),e.preventDefault()})),"sublayers-owner"))}};return r.__decorate([l.property({readOnly:!0})],n.prototype,"allSublayers",void 0),r.__decorate([l.property({readOnly:!0,type:t.ofType(y)})],n.prototype,"serviceSublayers",void 0),r.__decorate([l.property({value:null,type:f,json:{read:!1,write:{allowNull:!0,ignoreOrigin:!0}}})],n.prototype,"sublayers",void 0),r.__decorate([l.property({readOnly:!0})],n.prototype,"sublayersSourceJSON",void 0),r.__decorate([l.property({type:f,json:{read:{source:"tables"}}})],n.prototype,"subtables",void 0),n=r.__decorate([u.subclass("esri.layers.mixins.SublayersOwner")],n),n},e.forEachSublayer=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/Sublayer":function(){define(["require","exports","../../chunks/tslib.es6","../../PopupTemplate","../../request","../../core/Collection","../../core/Error","../../core/has","../../core/Identifiable","../../core/lang","../../core/Loadable","../../core/Logger","../../core/MultiOriginJSONSupport","../../core/sql","../../core/urlUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../core/accessorSupport/ensureType","../../core/accessorSupport/PropertyOrigin","../../core/accessorSupport/utils","../../geometry/Extent","../../geometry/SpatialReference","../../geometry/support/typeUtils","../graphics/sources/support/QueryTask","../mixins/OrderedLayer","./featureLayerUtils","./FeatureType","./Field","./FieldsIndex","./fieldUtils","./LabelClass","./labelingInfo","./LayerFloorInfo","./OrderByInfo","./Relationship","./serviceCapabilitiesUtils","./source/DataLayerSource","./source/MapLayerSource","../../renderers/support/typeUtils","../../rest/utils","../../rest/support/AttachmentQuery","../../rest/support/Query","../../support/popupUtils","../../symbols/support/typeUtils","../../tables/AttributeTableTemplate"],(function(e,r,t,i,o,a,s,l,n,p,c,u,d,y,h,f,m,b,g,v,_,S,w,I,O,T,L,x,E,A,P,D,M,C,R,F,j,U,q,N,B,V,k,z,G,$,J,W){"use strict";const Q=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));var K;function H(e){return"esriSMS"===e?.type}function Y(e,r,t){const i=t.minimumWritableOrigin||t.origin;return!!i&&e.originIdOf(r)>=S.nameToId(i)}function X(e,r,t){const i=Y(this,r,t);return{ignoreOrigin:!0,allowNull:i,enabled:!!t&&"map-image"===t.layer?.type&&(t.writeSublayerStructure||i)}}function Z(e,r,t){return{enabled:!!t&&"tile"===t.layer?.type&&(Y(this,r,t)||this._isOverridden(r))}}function ee(e,r,t){return{ignoreOrigin:!0,enabled:t&&t.writeSublayerStructure||!1}}function re(e,r,t){return{ignoreOrigin:!0,enabled:!!t?.writeSublayerStructure&&this.originIdOf(r)>S.OriginId.SERVICE}}function te(e,r,t){return{ignoreOrigin:!0,enabled:!!t&&(t.writeSublayerStructure||Y(this,r,t))}}let ie=0;const oe=new Set(["layer","parent","loaded","loadStatus","loadError","loadWarnings"]);return r.default=class extends(d.MultiOriginJSONMixin(n.IdentifiableMixin(c))){static{K=this}constructor(e){super(e),this.attributeTableTemplate=null,this.capabilities=void 0,this.maxScaleRange={minScale:0,maxScale:0},this.fields=null,this.fullExtent=null,this.geometryType=null,this.globalIdField=null,this.isTable=!1,this.legendEnabled=!0,this.objectIdField=null,this.parent=null,this.popupEnabled=!0,this.popupTemplate=null,this.relationships=null,this.sourceJSON=null,this.spatialReference=null,this.title=null,this.typeIdField=null,this.type="sublayer",this.types=null,this._lastParsedUrl=null}async load(e){return this.addResolvingPromise((async()=>{const{layer:r,url:t}=this;if(!r&&!t)throw new s("sublayer:missing-layer","Sublayer can't be loaded without being part of a layer",{sublayer:this});const i=r?await r.fetchSublayerInfo(this,e):(await o(t,{responseType:"json",query:{f:"json"},...e})).data;i&&(this.sourceJSON=i,this.read({layerDefinition:i},{origin:"service",layer:r,url:k.parseUrl(t)}))})()),this}readCapabilities(e,r){r=r.layerDefinition||r;const{attachment:t,operations:{supportsQuery:i,supportsQueryAttachments:o},query:{supportsFormatPBF:a,supportsOrderBy:s,supportsPagination:l},data:{supportsAttachment:n},queryRelated:p}=q.getFeatureLayerCapabilities(r,this.url);return{attachment:{supportsOrderByFields:t?.supportsOrderByFields??!1,supportsResize:t?.supportsResize??!1},exportMap:{supportsModification:!!r.canModifyLayer},operations:{supportsQuery:i,supportsQueryAttachments:o},data:{supportsAttachment:n},query:{supportsFormatPBF:a,supportsOrderBy:s,supportsPagination:l},queryRelated:p}}get defaultPopupTemplate(){return this.createPopupTemplate()}set definitionExpression(e){this._setAndNotifyLayer("definitionExpression",e)}get effectiveScaleRange(){const{minScale:e,maxScale:r}=this;return{minScale:e,maxScale:r}}readMaxScaleRange(e,r){return{minScale:(r=r.layerDefinition||r).minScale??0,maxScale:r.maxScale??0}}get fieldsIndex(){return new D(this.fields||[])}set floorInfo(e){this._setAndNotifyLayer("floorInfo",e)}readGlobalIdFieldFromService(e,r){if((r=r.layerDefinition||r).globalIdField)return r.globalIdField;if(r.fields)for(const e of r.fields)if("esriFieldTypeGlobalID"===e.type)return e.name}get id(){return this._get("id")??ie++}set id(e){this._get("id")!==e&&(!1!==this.layer?.capabilities?.exportMap?.supportsDynamicLayers?this._set("id",e):this._logLockedError("id","capability not available 'layer.capabilities.exportMap.supportsDynamicLayers'"))}readIsTable(e,r){return"Table"===r.type}set labelingInfo(e){this._setAndNotifyLayer("labelingInfo",e)}writeLabelingInfo(e,r,t,i){e&&e.length&&(r.layerDefinition={drawingInfo:{labelingInfo:e.map((e=>e.write({},i)))}})}set labelsVisible(e){this._setAndNotifyLayer("labelsVisible",e)}set layer(e){this._set("layer",e),this.sublayers?.forEach((r=>r.layer=e))}set listMode(e){this._set("listMode",e)}set minScale(e){this._setAndNotifyLayer("minScale",e)}readMinScale(e,r){return r.minScale||r.layerDefinition?.minScale||0}set maxScale(e){this._setAndNotifyLayer("maxScale",e)}readMaxScale(e,r){return r.maxScale||r.layerDefinition?.maxScale||0}readObjectIdFieldFromService(e,r){if((r=r.layerDefinition||r).objectIdField)return r.objectIdField;const t=r.fields?.find((e=>"esriFieldTypeOID"===e.type));return t?.name}set opacity(e){this._setAndNotifyLayer("opacity",e)}readOpacity(e,r){const{layerDefinition:t}=r;return 1-.01*(t?.transparency??t?.drawingInfo?.transparency??0)}writeOpacity(e,r,t,i){r.layerDefinition={drawingInfo:{transparency:100-100*e}}}set orderBy(e){this._setAndNotifyLayer("orderBy",e)}writeParent(e,r){this.parent&&this.parent!==this.layer?r.parentLayerId=_.ensureInteger(this.parent.id):r.parentLayerId=-1}get queryTask(){if(!this.layer)return null;const{capabilities:e,fieldsIndex:r,layer:t,url:i}=this,{spatialReference:o}=t,a="gdbVersion"in t?t.gdbVersion:void 0,s=l("featurelayer-pbf")&&e?.query.supportsFormatPBF;return new L({fieldsIndex:r,gdbVersion:a,pbfSupported:s,queryAttachmentsSupported:e?.operations?.supportsQueryAttachments??!1,sourceSpatialReference:o,url:i})}set renderer(e){if(M.fixRendererFields(e,this.fieldsIndex),e)for(const r of e.symbols)if(J.isSymbol3D(r)){u.getLogger(this).warn("Sublayer renderer should use 2D symbols");break}this._setAndNotifyLayer("renderer",e)}get source(){return this._get("source")||new B.MapLayerSource({mapLayerId:this.id})}set source(e){this._setAndNotifyLayer("source",e)}set sublayers(e){this._handleSublayersChange(e,this._get("sublayers")),this._set("sublayers",e)}castSublayers(e){return _.ensureType(a.ofType(K),e)}writeSublayers(e,r,t){this.sublayers?.length&&(r[t]=this.sublayers.map((e=>e.id)).toArray().reverse())}readTitle(e,r){return r.layerDefinition?.name??r.name}readTypeIdField(e,r){let t=(r=r.layerDefinition||r).typeIdField;if(t&&r.fields){t=t.toLowerCase();const e=r.fields.find((e=>e.name.toLowerCase()===t));e&&(t=e.name)}return t}get url(){const e=this.layer?.parsedUrl??this._lastParsedUrl,r=this.source;if(!e)return null;if(this._lastParsedUrl=e,"map-layer"===r?.type)return`${e.path}/${r.mapLayerId}`;const t={layer:JSON.stringify({source:this.source})};return`${e.path}/dynamicLayer?${h.objectToQuery(t)}`}set url(e){this._overrideIfSome("url",e)}set visible(e){this._setAndNotifyLayer("visible",e)}writeVisible(e,r,t,i){r[t]=this.getAtOrigin("defaultVisibility","service")||e}clone(){const{store:e}=w.getProperties(this),r=new K;return w.getProperties(r).store=e.clone(oe),this.commitProperty("url"),r._lastParsedUrl=this._lastParsedUrl,r}createPopupTemplate(e){return $.createPopupTemplate(this,e)}createQuery(){return new G({returnGeometry:!0,where:this.definitionExpression||"1=1"})}async createFeatureLayer(){if(this.hasOwnProperty("sublayers"))return null;const r=(await new Promise(((r,t)=>e(["../FeatureLayer"],(e=>r(Q(e))),t)))).default,{layer:t,url:i}=this;let o;if(i&&this.originIdOf("url")>S.OriginId.SERVICE)o=new r({url:i});else{if(!t?.parsedUrl)throw new s("createFeatureLayer:missing-information","Cannot create a FeatureLayer without a url or a parent layer");{const e=t.parsedUrl;o=new r({url:e.path}),e&&this.source&&("map-layer"===this.source.type?o.layerId=this.source.mapLayerId:o.dynamicDataSource=this.source)}}return null!=t?.refreshInterval&&(o.refreshInterval=t.refreshInterval),this.definitionExpression&&(o.definitionExpression=this.definitionExpression),this.floorInfo&&(o.floorInfo=p.clone(this.floorInfo)),this.originIdOf("labelingInfo")>S.OriginId.SERVICE&&(o.labelingInfo=p.clone(this.labelingInfo)),this.originIdOf("labelsVisible")>S.OriginId.DEFAULTS&&(o.labelsVisible=this.labelsVisible),this.originIdOf("legendEnabled")>S.OriginId.DEFAULTS&&(o.legendEnabled=this.legendEnabled),this.originIdOf("visible")>S.OriginId.DEFAULTS&&(o.visible=this.visible),this.originIdOf("minScale")>S.OriginId.DEFAULTS&&(o.minScale=this.minScale),this.originIdOf("maxScale")>S.OriginId.DEFAULTS&&(o.maxScale=this.maxScale),this.originIdOf("opacity")>S.OriginId.DEFAULTS&&(o.opacity=this.opacity),this.originIdOf("popupTemplate")>S.OriginId.DEFAULTS&&(o.popupTemplate=p.clone(this.popupTemplate)),this.originIdOf("renderer")>S.OriginId.SERVICE&&(o.renderer=p.clone(this.renderer)),"data-layer"===this.source?.type&&(o.dynamicDataSource=this.source.clone()),this.originIdOf("title")>S.OriginId.DEFAULTS&&(o.title=this.title),"map-image"===t?.type&&t.originIdOf("customParameters")>S.OriginId.DEFAULTS&&(o.customParameters=t.customParameters),"tile"===t?.type&&t.originIdOf("customParameters")>S.OriginId.DEFAULTS&&(o.customParameters=t.customParameters),o}getField(e){return this.fieldsIndex.get(e)}getFeatureType(e){return E.getFeatureType(this.types,this.typeIdField,e)}getFieldDomain(e,r){const t=r?.feature,i=this.getFeatureType(t);if(i){const r=i.domains&&i.domains[e];if(r&&"inherited"!==r.type)return r}return this._getLayerDomain(e)}async queryAttachments(e,r){await this.load(),e=z.from(e);const t=this.capabilities;if(!t?.data?.supportsAttachment)throw new s("queryAttachments:not-supported","this layer doesn't support attachments");const{attachmentTypes:i,objectIds:o,globalIds:a,num:l,size:n,start:p,where:c}=e;if(!t?.operations?.supportsQueryAttachments&&(i?.length>0||a?.length>0||n?.length>0||l||p||c))throw new s("queryAttachments:option-not-supported","when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e);if(!(o?.length||a?.length||c))throw new s("queryAttachments:invalid-query","'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);return!t?.attachment?.supportsOrderByFields&&e.orderByFields?.length&&((e=e.clone()).orderByFields=null),this.queryTask.executeAttachmentQuery(e,r)}async queryFeatureCount(e=this.createQuery(),r){if(await this.load(),!this.capabilities.operations.supportsQuery)throw new s("queryFeatureCount:not-supported","this layer doesn't support queries.");if(!this.url)throw new s("queryFeatureCount:not-supported","this layer has no url.");const t=this.layer?.apiKey;return await this.queryTask.executeForCount(e,{...r,query:{...this.layer?.customParameters,token:t}})}async queryFeatures(e=this.createQuery(),r){if(await this.load(),!this.capabilities.operations.supportsQuery)throw new s("queryFeatures:not-supported","this layer doesn't support queries.");if(!this.url)throw new s("queryFeatures:not-supported","this layer has no url.");const t=await this.queryTask.execute(e,{...r,query:{...this.layer?.customParameters,token:this.layer?.apiKey}});if(t?.features)for(const e of t.features)e.sourceLayer=this;return t}async queryObjectIds(e=this.createQuery(),r){if(await this.load(),!this.capabilities.operations.supportsQuery)throw new s("queryObjectIds:not-supported","this layer doesn't support queries.");if(!this.url)throw new s("queryObjectIds:not-supported","this layer has no url.");const t=this.layer?.apiKey;return await this.queryTask.executeForIds(e,{...r,query:{...this.layer?.customParameters,token:t}})}async queryRelatedFeatures(e,r){if(await this.load(),!this.capabilities.operations.supportsQuery)throw new s("queryRelatedFeatures:not-supported","this layer doesn't support queries.");if(!this.url)throw new s("queryRelatedFeatures:not-supported","this layer has no url.");const t=this.layer?.apiKey;return await this.queryTask.executeRelationshipQuery(e,{...r,query:{...this.layer?.customParameters,token:t}})}async queryRelatedFeaturesCount(e,r){if(await this.load(),!this.capabilities.operations.supportsQuery)throw new s("queryRelatedFeaturesCount:not-supported","this layer doesn't support queries.");if(!this.capabilities.queryRelated.supportsCount)throw new s("queryRelatedFeaturesCount:not-supported","this layer doesn't support query related counts.");if(!this.url)throw new s("queryRelatedFeaturesCount:not-supported","this layer has no url.");const t=this.layer?.apiKey;return await this.queryTask.executeRelationshipQueryForCount(e,{...r,query:{...this.layer?.customParameters,token:t}})}toExportImageJSON(e){const r={id:this.id,source:this.source?.toJSON()||{mapLayerId:this.id,type:"mapLayer"}},t=y.sqlAnd(e,this.definitionExpression);null!=t&&(r.definitionExpression=t);const i=["renderer","labelingInfo","opacity","labelsVisible"].reduce(((e,r)=>(e[r]=this.originIdOf(r),e)),{});if(Object.keys(i).some((e=>i[e]>S.OriginId.SERVICE))){const e=r.drawingInfo={};if(i.renderer>S.OriginId.SERVICE&&(e.renderer=this.renderer?this.renderer.toJSON():null),i.labelsVisible>S.OriginId.SERVICE&&(e.showLabels=this.labelsVisible),this.labelsVisible&&i.labelingInfo>S.OriginId.SERVICE)if(this.labelingInfo){!this.loaded&&this.labelingInfo?.some((e=>!e.labelPlacement))&&u.getLogger(this).warnOnce(`A Sublayer (title: ${this.title}, id: ${this.id}) has an undefined 'labelPlacement' and so labels cannot be displayed. Either define a valid 'labelPlacement' or call Sublayer.load() to use a default value based on geometry type.`,{sublayer:this});let r=this.labelingInfo;null!=this.geometryType&&(r=R.validateLabelingInfo(this.labelingInfo,T.featureGeometryTypeKebabDictionary.toJSON(this.geometryType))),e.showLabels=!0,e.labelingInfo=r.filter((e=>e.labelPlacement)).map((e=>e.toJSON({origin:"service",layer:this.layer})))}else e.showLabels=!1;i.opacity>S.OriginId.SERVICE&&(e.transparency=100-100*this.opacity),this._assignDefaultSymbolColors(e.renderer)}return(this.layer?.capabilities?.exportMap?.supportsSublayerOrderBy??!1)&&this.originIdOf("orderBy")>S.OriginId.SERVICE&&(r.orderBy=this.orderBy?.map((e=>e.toJSON()))??null),r}_assignDefaultSymbolColors(e){this._forEachSimpleMarkerSymbols(e,(e=>{e.color||"esriSMSX"!==e.style&&"esriSMSCross"!==e.style||(e.outline?.color?e.color=e.outline.color:e.color=[0,0,0,0])}))}_forEachSimpleMarkerSymbols(e,r){if(e){const t=("uniqueValueInfos"in e?e.uniqueValueInfos:"classBreakInfos"in e?e.classBreakInfos:null)??[];for(const e of t)H(e.symbol)&&r(e.symbol);"symbol"in e&&H(e.symbol)&&r(e.symbol),"defaultSymbol"in e&&H(e.defaultSymbol)&&r(e.defaultSymbol)}}_setAndNotifyLayer(e,r){const t=this.layer,i=this._get(e);let o,a;switch(e){case"definitionExpression":case"floorInfo":o="supportsSublayerDefinitionExpression";break;case"minScale":case"maxScale":case"visible":o="supportsSublayerVisibility";break;case"labelingInfo":case"labelsVisible":case"opacity":case"renderer":case"source":o="supportsDynamicLayers",a="supportsModification";break;case"orderBy":o="supportsSublayerOrderBy",a="supportsModification"}const s=w.getProperties(this).getDefaultOrigin();if("service"!==s){if(o&&!1===this.layer?.capabilities?.exportMap?.[o])return void this._logLockedError(e,`capability not available 'layer.capabilities.exportMap.${o}'`);if(a&&!1===this.capabilities?.exportMap[a])return void this._logLockedError(e,`capability not available 'capabilities.exportMap.${a}'`)}"source"!==e||"not-loaded"===this.loadStatus?(this._set(e,r),"service"!==s&&i!==r&&t&&t.emit&&t.emit("sublayer-update",{propertyName:e,target:this})):this._logLockedError(e,"'source' can't be changed after calling sublayer.load()")}_handleSublayersChange(e,r){r&&(r.forEach((e=>{e.parent=null,e.layer=null})),this.removeAllHandles()),e&&(e.forEach((e=>{e.parent=this,e.layer=this.layer})),this.addHandles([e.on("after-add",(({item:e})=>{e.parent=this,e.layer=this.layer})),e.on("after-remove",(({item:e})=>{e.parent=null,e.layer=null})),e.on("before-changes",(e=>{(this.layer?.capabilities?.exportMap?.supportsSublayersChanges??1)||(u.getLogger(this).error(new s("sublayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",{sublayer:this,layer:this.layer})),e.preventDefault())}))]))}_logLockedError(e,r){const{layer:t,declaredClass:i}=this;u.getLogger(i).error(new s("sublayer:locked",`Property '${String(e)}' can't be changed on Sublayer from the layer '${t?.id}'`,{reason:r,sublayer:this,layer:t}))}_getLayerDomain(e){return this.fieldsIndex.get(e)?.domain??null}static{this.test={isMapImageLayerOverridePolicy:e=>e===re||e===ee||e===X,isTileImageLayerOverridePolicy:e=>e===Z}}},t.__decorate([f.property({type:W,json:{name:"attributeTableInfo",write:{overridePolicy:X},origins:{"web-scene":{write:!1}}}})],r.default.prototype,"attributeTableTemplate",void 0),t.__decorate([f.property({readOnly:!0})],r.default.prototype,"capabilities",void 0),t.__decorate([b.reader("service","capabilities",["layerDefinition.canModifyLayer","layerDefinition.capabilities"])],r.default.prototype,"readCapabilities",null),t.__decorate([f.property()],r.default.prototype,"defaultPopupTemplate",null),t.__decorate([f.property({type:String,value:null,json:{name:"layerDefinition.definitionExpression",write:{allowNull:!0,overridePolicy:X}}})],r.default.prototype,"definitionExpression",null),t.__decorate([f.property({readOnly:!0})],r.default.prototype,"effectiveScaleRange",null),t.__decorate([b.reader("service","maxScaleRange",["minScale","maxScale"])],r.default.prototype,"readMaxScaleRange",null),t.__decorate([f.property({type:[P],json:{origins:{service:{read:{source:"layerDefinition.fields"}}}}})],r.default.prototype,"fields",void 0),t.__decorate([f.property({readOnly:!0})],r.default.prototype,"fieldsIndex",null),t.__decorate([f.property({type:F,value:null,json:{name:"layerDefinition.floorInfo",read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo",overridePolicy:X},origins:{"web-scene":{read:!1,write:!1}}}})],r.default.prototype,"floorInfo",null),t.__decorate([f.property({type:I,json:{read:{source:"layerDefinition.extent"}}})],r.default.prototype,"fullExtent",void 0),t.__decorate([f.property({type:T.featureGeometryTypeKebabDictionary.apiValues,json:{origins:{service:{name:"layerDefinition.geometryType",read:{reader:T.featureGeometryTypeKebabDictionary.read}}}}})],r.default.prototype,"geometryType",void 0),t.__decorate([f.property({type:String})],r.default.prototype,"globalIdField",void 0),t.__decorate([b.reader("service","globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"])],r.default.prototype,"readGlobalIdFieldFromService",null),t.__decorate([f.property({type:_.Integer,json:{write:{ignoreOrigin:!0}}})],r.default.prototype,"id",null),t.__decorate([f.property({readOnly:!0})],r.default.prototype,"isTable",void 0),t.__decorate([b.reader("service","isTable",["type"])],r.default.prototype,"readIsTable",null),t.__decorate([f.property({value:null,type:[C],json:{read:{source:"layerDefinition.drawingInfo.labelingInfo"},write:{target:"layerDefinition.drawingInfo.labelingInfo",overridePolicy:re}}})],r.default.prototype,"labelingInfo",null),t.__decorate([v.writer("labelingInfo")],r.default.prototype,"writeLabelingInfo",null),t.__decorate([f.property({type:Boolean,value:!0,json:{read:{source:"layerDefinition.drawingInfo.showLabels"},write:{target:"layerDefinition.drawingInfo.showLabels",overridePolicy:ee}}})],r.default.prototype,"labelsVisible",null),t.__decorate([f.property({value:null})],r.default.prototype,"layer",null),t.__decorate([f.property({type:String,json:{write:{overridePolicy:Z}}})],r.default.prototype,"layerItemId",void 0),t.__decorate([f.property({type:Boolean,value:!0,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend",overridePolicy:te}}})],r.default.prototype,"legendEnabled",void 0),t.__decorate([f.property({type:["show","hide","hide-children"],value:"show",json:{read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],r.default.prototype,"listMode",null),t.__decorate([f.property({type:Number,value:0,json:{write:{overridePolicy:ee}}})],r.default.prototype,"minScale",null),t.__decorate([b.reader("minScale",["minScale","layerDefinition.minScale"])],r.default.prototype,"readMinScale",null),t.__decorate([f.property({type:Number,value:0,json:{write:{overridePolicy:ee}}})],r.default.prototype,"maxScale",null),t.__decorate([b.reader("maxScale",["maxScale","layerDefinition.maxScale"])],r.default.prototype,"readMaxScale",null),t.__decorate([f.property()],r.default.prototype,"objectIdField",void 0),t.__decorate([b.reader("service","objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"])],r.default.prototype,"readObjectIdFieldFromService",null),t.__decorate([f.property({type:Number,value:1,json:{write:{target:"layerDefinition.drawingInfo.transparency",overridePolicy:ee}}})],r.default.prototype,"opacity",null),t.__decorate([b.reader("opacity",["layerDefinition.drawingInfo.transparency","layerDefinition.transparency"])],r.default.prototype,"readOpacity",null),t.__decorate([v.writer("opacity")],r.default.prototype,"writeOpacity",null),t.__decorate([f.property({value:null,type:[j],json:{name:"layerDefinition.orderBy",read:{reader:x.readOrderByInfos},write:{overridePolicy:X},origins:{"web-scene":{read:!1,write:!1}}}})],r.default.prototype,"orderBy",null),t.__decorate([f.property({json:{type:_.Integer,write:{target:"parentLayerId",writerEnsuresNonNull:!0,overridePolicy:ee}}})],r.default.prototype,"parent",void 0),t.__decorate([v.writer("parent")],r.default.prototype,"writeParent",null),t.__decorate([f.property({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(e,r)=>!r.disablePopup},write:{target:"disablePopup",overridePolicy:te,writer(e,r,t){r[t]=!e}}}})],r.default.prototype,"popupEnabled",void 0),t.__decorate([f.property({type:i,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:te}}})],r.default.prototype,"popupTemplate",void 0),t.__decorate([f.property({readOnly:!0})],r.default.prototype,"queryTask",null),t.__decorate([f.property({type:[U],readOnly:!0,json:{origins:{service:{read:{source:"layerDefinition.relationships"}}}}})],r.default.prototype,"relationships",void 0),t.__decorate([f.property({types:V.rendererTypes,value:null,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:re},origins:{"web-scene":{types:V.webSceneRendererTypes,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:re}}}}})],r.default.prototype,"renderer",null),t.__decorate([f.property({types:{key:"type",base:null,typeMap:{"data-layer":N.DataLayerSource,"map-layer":B.MapLayerSource}},cast(e){if(e){if("mapLayerId"in e)return _.ensureClass(B.MapLayerSource,e);if("dataSource"in e)return _.ensureClass(N.DataLayerSource,e)}return e},json:{name:"layerDefinition.source",write:{overridePolicy:ee}}})],r.default.prototype,"source",null),t.__decorate([f.property()],r.default.prototype,"sourceJSON",void 0),t.__decorate([f.property({type:O,json:{origins:{service:{read:{source:"layerDefinition.extent.spatialReference"}}}}})],r.default.prototype,"spatialReference",void 0),t.__decorate([f.property({value:null,json:{type:[_.Integer],write:{target:"subLayerIds",allowNull:!0,overridePolicy:ee}}})],r.default.prototype,"sublayers",null),t.__decorate([m.cast("sublayers")],r.default.prototype,"castSublayers",null),t.__decorate([v.writer("sublayers")],r.default.prototype,"writeSublayers",null),t.__decorate([f.property({type:String,json:{name:"name",write:{overridePolicy:te}}})],r.default.prototype,"title",void 0),t.__decorate([b.reader("service","title",["name","layerDefinition.name"])],r.default.prototype,"readTitle",null),t.__decorate([f.property({type:String})],r.default.prototype,"typeIdField",void 0),t.__decorate([f.property({json:{read:!1},readOnly:!0,value:"sublayer"})],r.default.prototype,"type",void 0),t.__decorate([b.reader("typeIdField",["layerDefinition.typeIdField"])],r.default.prototype,"readTypeIdField",null),t.__decorate([f.property({type:[A],json:{origins:{service:{read:{source:"layerDefinition.types"}}}}})],r.default.prototype,"types",void 0),t.__decorate([f.property({type:String,json:{name:"layerUrl",write:{overridePolicy:Z}}})],r.default.prototype,"url",null),t.__decorate([f.property({type:Boolean,value:!0,json:{read:{source:"defaultVisibility"},write:{target:"defaultVisibility",overridePolicy:ee}}})],r.default.prototype,"visible",null),t.__decorate([v.writer("visible")],r.default.prototype,"writeVisible",null),r.default=K=t.__decorate([g.subclass("esri.layers.support.Sublayer")],r.default),r.default}))},"esri/layers/support/sublayerUtils":function(){define(["exports","../../core/accessorSupport/PropertyOrigin"],(function(e,r){"use strict";function t(e,r){if(!e?.length||null==r)return!0;const t=r.slice().reverse().flatten((({sublayers:e})=>e&&e.toArray().reverse())).map((e=>e.id)).toArray();if(e.length>t.length)return!1;let i=0;const o=t.length;for(const{id:r}of e){for(;i<o&&t[i]!==r;)i++;if(i>=o)return!1}return!0}e.isExportDynamic=function(e,i,o){return!!e.some((e=>{const t=e.source,i=!t||"map-layer"===t.type&&t.mapLayerId===e.id&&(null==t.gdbVersion||t.gdbVersion===o);e.commitProperty("renderer"),e.commitProperty("labelingInfo"),e.commitProperty("opacity"),e.commitProperty("labelsVisible"),e.commitProperty("orderBy");const a=e.layer?.capabilities?.exportMap?.supportsSublayerOrderBy??!1;return!i||e.originIdOf("renderer")>r.OriginId.SERVICE||e.originIdOf("labelingInfo")>r.OriginId.SERVICE||e.originIdOf("opacity")>r.OriginId.SERVICE||e.originIdOf("labelsVisible")>r.OriginId.SERVICE||a&&e.originIdOf("orderBy")>r.OriginId.SERVICE}))||!t(e,i)},e.isSublayerOverhaul=function(e){return!!e&&e.some((e=>null!=e.minScale||null!=e.layerDefinition?.minScale))},e.shouldWriteSublayerStructure=function(e,r,i){return r.flatten((({sublayers:e})=>e)).length!==e.length||!!e.some((e=>e.originIdOf("minScale")>i||e.originIdOf("maxScale")>i||e.originIdOf("renderer")>i||e.originIdOf("labelingInfo")>i||e.originIdOf("opacity")>i||e.originIdOf("labelsVisible")>i||e.originIdOf("source")>i))||!t(e,r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/imageBitmapUtils":function(){define(["exports","../../core/Error","../../core/promiseUtils"],(function(e,r,t){"use strict";e.createBitmap=async function(e,i,o){let a;try{a=await createImageBitmap(e)}catch(e){throw new r("request:server",`Unable to load ${i}`,{url:i,error:e})}return t.throwIfAborted(o),a},e.createTileBitmap=async function(e,i,o,a,s){let l;try{l=await createImageBitmap(e)}catch(e){throw new r("request:server",`Unable to load tile ${i}/${o}/${a}`,{error:e,level:i,row:o,col:a})}return t.throwIfAborted(s),l},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"*noref":1}}),define(["../chunks/tslib.es6","../request","../core/Error","../core/loadAll","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer","../geometry/SpatialReference","./Layer","./mixins/APIKeyMixin","./mixins/ArcGISCachedService","./mixins/ArcGISMapService","./mixins/ArcGISService","./mixins/BlendLayer","./mixins/CustomParametersMixin","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/RefreshableLayer","./mixins/ScaleRangeLayer","./mixins/SublayersOwner","./support/arcgisLayerUrl","./support/commonProperties","./support/imageBitmapUtils","./support/Sublayer","../symbols/support/ElevationInfo"],(function(e,r,t,i,o,a,s,l,n,p,c,u,d,y,h,f,m,b,g,v,_,S,w,I,O,T,L,x,E,A,P,D){"use strict";var M;const C=["Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Elevation/World_Hillshade","Elevation/World_Hillshade_Dark","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Ocean_Basemap","Reference/World_Boundaries_and_Places","Reference/World_Boundaries_and_Places_Alternate","Reference/World_Transportation","World_Imagery","World_Street_Map","World_Topo_Map"];let R=M=class extends(_.BlendLayer(T.ScaleRangeLayer(L.SublayersOwner(b.ArcGISCachedService(g.ArcGISMapService(w.OperationalLayer(I.PortalLayer(v.ArcGISService(o.MultiOriginJSONMixin(O.RefreshableLayer(m.APIKeyMixin(S.CustomParametersMixin(f))))))))))))){constructor(...e){super(...e),this.listMode="show",this.elevationInfo=new D({mode:"on-the-ground"}),this.isReference=null,this.operationalLayerType="ArcGISTiledMapServiceLayer",this.resampling=!0,this.sourceJSON=null,this.spatialReference=null,this.path=null,this.sublayers=null,this.type="tile",this.url=null}normalizeCtorArgs(e,r){return"string"==typeof e?{url:e,...r}:e}load(e){const r=null!=e?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]},e).catch(a.throwIfAbortError).then((()=>this._fetchService(r)))),Promise.resolve(this)}get attributionDataUrl(){const e=this.parsedUrl?.path.toLowerCase();return e?this._getDefaultAttribution(this._getMapName(e)):null}readSpatialReference(e,r){return(e=e||r.tileInfo?.spatialReference)&&h.fromJSON(e)}writeSublayers(e,r,t,i){if(!this.loaded||!e)return;const o=e.slice().reverse().flatten((({sublayers:e})=>e&&e.toArray().reverse())).toArray(),a=[],s={writeSublayerStructure:!1,...i};o.forEach((e=>{const r=e.write({},s);a.push(r)})),a.some((e=>Object.keys(e).length>1))&&(r.layers=a)}get tileServers(){return this._getDefaultTileServers(this.parsedUrl?.path)}castTileServers(e){return Array.isArray(e)?e.map((e=>s.urlToObject(e).path)):null}fetchTile(e,t,i,o={}){const{signal:a}=o,s=this.getTileUrl(e,t,i),l={responseType:"image",signal:a,query:{...this.refreshParameters}};return r(s,l).then((e=>e.data))}async fetchImageBitmapTile(e,t,i,o={}){const{signal:a}=o;if(this.fetchTile!==M.prototype.fetchTile){const r=await this.fetchTile(e,t,i,o);return A.createTileBitmap(r,e,t,i,a)}const s=this.getTileUrl(e,t,i),l={responseType:"blob",signal:a,query:{...this.refreshParameters}},{data:n}=await r(s,l);return A.createTileBitmap(n,e,t,i,a)}getTileUrl(e,r,t){const i=!this.capabilities.operations.supportsTileMap&&this.supportsBlankTile,o=s.objectToQuery({...this.parsedUrl?.query,blankTile:!i&&null,...this.customParameters,token:this.apiKey}),a=this.tileServers;return`${a&&a.length?a[r%a.length]:this.parsedUrl?.path}/tile/${e}/${r}/${t}${o?"?"+o:""}`}loadAll(){return i.loadAll(this,(e=>{e(this.allSublayers)}))}_fetchService(e){return new Promise(((i,o)=>{if(this.sourceJSON){if(null!=this.sourceJSON.bandCount&&null!=this.sourceJSON.pixelSizeX)throw new t("tile-layer:unsupported-url","use ImageryTileLayer to open a tiled image service");return void i({data:this.sourceJSON})}if(!this.parsedUrl)throw new t("tile-layer:undefined-url","layer's url is not defined");const a=x.parse(this.parsedUrl.path);if(null!=a&&"ImageServer"===a.serverType)throw new t("tile-layer:unsupported-url","use ImageryTileLayer to open a tiled image service");r(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters,token:this.apiKey},responseType:"json",signal:e}).then(i,o)})).then((r=>{let t=this.url;if(r.ssl&&(t=this.url=t.replace(/^http:/i,"https:")),this.sourceJSON=r.data,this.read(r.data,{origin:"service",url:this.parsedUrl}),10.1===this.version&&!x.isHostedAgolService(t))return this._fetchServerVersion(t,e).then((e=>{this.read({currentVersion:e})})).catch((()=>{}))}))}_fetchServerVersion(e,i){if(!x.isArcGISUrl(e))return Promise.reject();const o=e.replace(/(.*\/rest)\/.*/i,"$1")+"/info";return r(o,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:i}).then((e=>{if(e.data?.currentVersion)return e.data.currentVersion;throw new t("tile-layer:version-not-available","Server did not provide a version")}))}_getMapName(e){const r=e.match(/^(?:https?:)?\/\/(server\.arcgisonline\.com|services\.arcgisonline\.com|ibasemaps-api\.arcgis\.com)\/arcgis\/rest\/services\/([^/]+(\/[^/]+)*)\/mapserver/i);return r?r[2]:void 0}_getDefaultAttribution(e){if(null==e)return null;let r;e=e.toLowerCase();for(let t=0,i=C.length;t<i;t++)if(r=C[t],r.toLowerCase().includes(e))return s.makeAbsolute("//static.arcgis.com/attribution/"+r);return null}_getDefaultTileServers(e){if(null==e)return[];const r=-1!==e.search(/^(?:https?:)?\/\/server\.arcgisonline\.com/i),t=-1!==e.search(/^(?:https?:)?\/\/services\.arcgisonline\.com/i);return r||t?[e,e.replace(r?/server\.arcgisonline/i:/services\.arcgisonline/i,r?"services.arcgisonline":"server.arcgisonline")]:[]}get hasOverriddenFetchTile(){return!this.fetchTile[F]}};e.__decorate([l.property({readOnly:!0})],R.prototype,"attributionDataUrl",null),e.__decorate([l.property({type:["show","hide","hide-children"]})],R.prototype,"listMode",void 0),e.__decorate([l.property({json:{read:!0,write:!0}})],R.prototype,"blendMode",void 0),e.__decorate([l.property()],R.prototype,"elevationInfo",void 0),e.__decorate([l.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],R.prototype,"isReference",void 0),e.__decorate([l.property({readOnly:!0,type:["ArcGISTiledMapServiceLayer"]})],R.prototype,"operationalLayerType",void 0),e.__decorate([l.property({type:Boolean})],R.prototype,"resampling",void 0),e.__decorate([l.property()],R.prototype,"sourceJSON",void 0),e.__decorate([l.property({type:h})],R.prototype,"spatialReference",void 0),e.__decorate([u.reader("spatialReference",["spatialReference","tileInfo"])],R.prototype,"readSpatialReference",null),e.__decorate([l.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],R.prototype,"path",void 0),e.__decorate([l.property({readOnly:!0})],R.prototype,"sublayers",void 0),e.__decorate([y.writer("sublayers",{layers:{type:[P]}})],R.prototype,"writeSublayers",null),e.__decorate([l.property({json:{read:!1,write:!1}})],R.prototype,"popupEnabled",void 0),e.__decorate([l.property()],R.prototype,"tileServers",null),e.__decorate([n.cast("tileServers")],R.prototype,"castTileServers",null),e.__decorate([l.property({readOnly:!0,json:{read:!1}})],R.prototype,"type",void 0),e.__decorate([l.property(E.url)],R.prototype,"url",void 0),R=M=e.__decorate([d.subclass("esri.layers.TileLayer")],R);const F=Symbol("default-fetch-tile");return R.prototype.fetchTile[F]=!0,R}));