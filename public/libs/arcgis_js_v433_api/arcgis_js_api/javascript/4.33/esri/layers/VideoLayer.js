// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../chunks/tslib.es6","../Color","../request","../core/deprecate","../core/Error","../core/Logger","../core/mathUtils","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/PropertyOrigin","../geometry/Extent","../geometry/Polyline","../geometry/SpatialReference","./Layer","./mixins/ArcGISService","./mixins/BlendLayer","./mixins/CustomParametersMixin","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./support/arcgisLayerUrl","./support/commonProperties","./support/multiLayerServiceUtils","./support/PlaybackInfo","./support/serviceCapabilitiesUtils","./support/TelemetryData","./support/TelemetryDisplay","./support/VideoFrame","./support/VideoTimeExtent","./video/VideoController","./video/videoUtils","../symbols/CIMSymbol","../symbols/PictureMarkerSymbol","../symbols/SimpleFillSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleMarkerSymbol","../symbols/Symbol","../symbols/support/jsonUtils"],(function(e,r,t,o,i,l,n,s,a,p,y,d,c,u,m,h,_,v,g,S,f,b,O,T,w,I,L,C,P,x,U,E,j,M,N,V,k,F,A,G,R,H,J,z,D){"use strict";function q(e,r){return{ignoreOrigin:this.originIdOf(r)<_.OriginId.PORTAL_ITEM}}let B=[];const W=new r([255,127,0]),Q=new r([0,0,0,.05]),$=new J({angle:0,color:W,size:10,style:"cross"}),Z=new R({color:Q,outline:new H({color:W,width:2})}),K=new H({color:W,width:1}),X=new J({angle:0,color:W,outline:{color:[255,255,255],width:1.33},size:10,style:"circle"}),Y=new H({color:W,width:1}),ee={types:{base:z,key:"type",typeMap:{"simple-marker":J,"picture-marker":G,cim:A}},json:{name:"drawingInfo.sensorSymbol",write:{writer:D.write,overridePolicy:q}}};function re(e,r){return{type:r,json:{name:e,write:{overridePolicy:q}}}}let te=class extends(O.BlendLayer(L.ScaleRangeLayer(b.ArcGISService(w.OperationalLayer(I.PortalLayer(s.MultiOriginJSONMixin(T.CustomParametersMixin(f)))))))){constructor(e){super(e),this.capabilities=null,this.codecs=null,this.connectionInfo=null,this.controller=new k,this.copyright=null,this.created=null,this.customParameters=null,this.description=null,this.elevationSource=null,this.frame=null,this.frameCenterSymbol=$.clone(),this.frameCount=null,this.frameEffect=null,this.frameOpacity=1,this.frameOutlineSymbol=Z.clone(),this.fullExtent=null,this.initialExtent=null,this.layerId=null,this.operationalLayerType="ArcGISVideoLayer",this.playbackInfo=null,this.posterUrl=null,this.qualities=null,this.sensorSymbolOrientation={source:"platformHeading",symbolOffset:0},this.sensorSymbol=X.clone(),this.sensorSightLineSymbol=K.clone(),this.sensorTrailSymbol=Y.clone(),this.serviceItemId=null,this.sourceJSON=null,this.sourceQuality=null,this.sourceType=null,this.spatialReference=S.WGS84,this.start=0,this.telemetryDisplay=new M,this.type="video",this.url=null,this.version=null,this.videoLayersInfo=null}initialize(){this.addHandles([p.watch((()=>this.metadata),(()=>{this.notifyChange("telemetry"),this.notifyChange("groundControlPoints"),this.notifyChange("frameHorizonPoints")})),p.watch((()=>this.telemetry?.sensorLocation),(e=>this._setSensorTrail(e)),p.initial)]),p.whenOnce((()=>this.loaded&&"can-play"===this.state&&this.duration>0)).then((()=>{this.start>=0&&this.start<=this.duration&&this.setCurrentTime(this.start)}))}destroy(){this.removeAllHandles(),this.controller&&this.controller.destroy()}load(e){const r=null!=e?e.signal:null,t=this.loadFromPortal({supportedTypes:["Video Service"],supportsData:!1},e).catch(a.throwIfAbortError).then((()=>this._fetchService(r)));return this.addResolvingPromise(t),Promise.resolve(this)}get autoplay(){return this.controller?.autoplay??!1}set autoplay(e){this.controller.autoplay=e}get buffered(){return this.controller.buffered}readCapabilitiesFromService(e,r){return E.getVideoLayerCapabilities(r)}readConnectionInfo(e,r){const t=Object.values(r.connectionUrl);return t?.length&&(this.controller.playerUrl=t[0]),r.connectionUrl}get currentTime(){return this.controller.currentTime}get duration(){return this.controller.duration}get ended(){return this.controller.ended}get frameHorizonPoints(){return F.getFrameHorizonPoints(this.metadata)}get groundControlPoints(){return F.getGroundControlPoints(this.metadata)}get isLive(){return this.controller?.isLive??!1}get livestreamStatus(){return this.controller?.livestreamStatus}get loop(){return this.controller.loop}set loop(e){this.controller.loop=e}get metadata(){return this.controller?.currentMetadata}get mimeType(){return this.controller?.mimeType}get muted(){return this.controller.muted}set muted(e){this.controller.muted=e}get parsedUrl(){return x.normalizeParsedUrlObject(this)}get playbackRate(){return this.controller.rate}set playbackRate(e){this.controller.rate=e}get playerUrl(){return this.controller.playerUrl}get playing(){return this.controller.playing}get started(){return this.controller?.started??!1}get state(){return this.controller.state}get telemetry(){return F.getTelemetryData(this.metadata)}readTitleFromService(e,{name:r}){return this.url?C.titleFromUrlAndName(this.url,r):r}get videoElement(){return this.controller?.element}get videoHeight(){return this.controller?.videoHeight}readLayerInfosFromService(e,r){return F.getServiceLayersInfo(r)}get videoTimeExtent(){return o.deprecatedProperty(l.getLogger(this),"videoTimeExtent",{replacement:"fullTimeExtent",version:"4.33",warnOnce:!0}),this.fullTimeExtent}get videoWidth(){return this.controller?.videoWidth}get volume(){return this.controller?.volume??0}set volume(e){this.controller.volume=e}get waiting(){return this.controller.waiting}play(){this.controller.play()}pause(){this.controller.pause()}reset(){B=[],this.controller.reset()}setCurrentTime(e){if(this.duration<0)return;const r=n.clamp(e,0,this.duration);this.controller.setCurrentTime(r)}toGround(e,r){return this.controller?.sensorModel?.metadataSupportsTransforms?this.controller.sensorModel.transformImageToGeo(e,r):null}toVideo(e){if(!this.controller?.sensorModel?.metadataSupportsTransforms)return null;const r=this.controller.sensorModel.transformGeoToImage(e.x,e.y,e.z);return{x:r[0],y:r[1]}}updateTelemetryColor(e){this.frameCenterSymbol=F.getStyledTelemetrySymbol(this.frameCenterSymbol,e)??$,this.frameOutlineSymbol=F.getStyledTelemetrySymbol(this.frameOutlineSymbol,e,Q)??Z,this.sensorSightLineSymbol=F.getStyledTelemetrySymbol(this.sensorSightLineSymbol,e)??K,this.sensorTrailSymbol=F.getStyledTelemetrySymbol(this.sensorTrailSymbol,e)??Y,this.sensorSymbol=F.getStyledTelemetrySymbol(this.sensorSymbol,e)??X}write(e,r){return null==this.layerId?(r?.messages?.push(new i("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' cannot be saved to a web map, web scene, or portal item. The ArcGIS server version must be greater than 11.2.`)),null):super.write(e,r)}async _fetchService(e){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});const{data:r,ssl:o}=await t(this.url,{query:{f:"json",...this.parsedUrl.query,...this.customParameters},signal:e});if(o&&(this.url=this.url.replace(/^http:/i,"https:")),!r?.currentVersion)return r.currentVersion="11.2",this.sourceJSON=r,void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});if(this.layerId??=r.layers?.[0]?.id??null,null==this.layerId)throw new i("arcgis-layers:url-mismatch","The url is not a valid arcgis resource");const{data:l}=await t(this.parsedUrl.path,{query:{f:"json",...this.customParameters},signal:e});this.sourceJSON={...r,...l},this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl})}_setSensorTrail(e){if(!e)return;const r=F.getSensorTrailPoints(e,B);B=[...r];const t=B.map((e=>e.toArray())),o=new g({hasZ:e.hasZ,paths:[t]});this.telemetry.sensorTrail=o.clone()}};return e.__decorate([y.property({type:Boolean,json:{write:{ignoreOrigin:!0}}})],te.prototype,"autoplay",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"buffered",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"cameraInfo",void 0),e.__decorate([y.property({readOnly:!0,json:{read:!1}})],te.prototype,"capabilities",void 0),e.__decorate([m.reader("service","capabilities",["supportsAppend","supportsCoverageQuery","supportsExportClip","supportsExportFrameset","supportsMensuration","supportsPreviews","supportsUpdate"])],te.prototype,"readCapabilitiesFromService",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"codecs",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"connectionInfo",void 0),e.__decorate([m.reader("connectionInfo",["connectionUrl"])],te.prototype,"readConnectionInfo",null),e.__decorate([y.property()],te.prototype,"controller",void 0),e.__decorate([y.property({type:String})],te.prototype,"copyright",void 0),e.__decorate([y.property({readOnly:!0,type:Date})],te.prototype,"created",void 0),e.__decorate([y.property({type:Number})],te.prototype,"currentTime",null),e.__decorate([y.property({json:{write:!1}})],te.prototype,"customParameters",void 0),e.__decorate([y.property({type:String})],te.prototype,"description",void 0),e.__decorate([y.property({type:Number})],te.prototype,"duration",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"elevationSource",void 0),e.__decorate([y.property({type:Boolean})],te.prototype,"ended",null),e.__decorate([y.property({type:N})],te.prototype,"frame",void 0),e.__decorate([y.property(re("drawingInfo.frameCenterSymbol",J))],te.prototype,"frameCenterSymbol",void 0),e.__decorate([y.property({readOnly:!0,type:d.Integer})],te.prototype,"frameCount",void 0),e.__decorate([y.property(O.effectProperty)],te.prototype,"frameEffect",void 0),e.__decorate([y.property(P.opacity)],te.prototype,"frameOpacity",void 0),e.__decorate([y.property(re("drawingInfo.frameOutlineSymbol",R))],te.prototype,"frameOutlineSymbol",void 0),e.__decorate([y.property({type:v})],te.prototype,"fullExtent",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"frameHorizonPoints",null),e.__decorate([y.property({readOnly:!0,json:{read:{reader:F.readVideoTimeExtent,source:"time"}},type:V})],te.prototype,"fullTimeExtent",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"groundControlPoints",null),e.__decorate([y.property(P.id)],te.prototype,"id",void 0),e.__decorate([y.property({type:v})],te.prototype,"initialExtent",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"isLive",null),e.__decorate([y.property({type:d.Integer,json:{read:!1,origins:{service:{read:{source:"id"}}}}})],te.prototype,"layerId",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"livestreamStatus",null),e.__decorate([y.property({type:Boolean})],te.prototype,"loop",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"metadata",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"mimeType",null),e.__decorate([y.property({type:Boolean,json:{write:{ignoreOrigin:!0}}})],te.prototype,"muted",null),e.__decorate([y.property({type:["ArcGISVideoLayer"]})],te.prototype,"operationalLayerType",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"parsedUrl",null),e.__decorate([y.property({type:U})],te.prototype,"playbackInfo",void 0),e.__decorate([y.property({type:Number})],te.prototype,"playbackRate",null),e.__decorate([y.property({readOnly:!0,type:String})],te.prototype,"playerUrl",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"playing",null),e.__decorate([y.property({readOnly:!0,json:{read:{source:"poster"}}})],te.prototype,"posterUrl",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"qualities",void 0),e.__decorate([y.property()],te.prototype,"sensorSymbolOrientation",void 0),e.__decorate([y.property(ee)],te.prototype,"sensorSymbol",void 0),e.__decorate([y.property(re("drawingInfo.sensorSightLineSymbol",H))],te.prototype,"sensorSightLineSymbol",void 0),e.__decorate([y.property(re("drawingInfo.sensorTrailSymbol",H))],te.prototype,"sensorTrailSymbol",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"serviceItemId",void 0),e.__decorate([y.property()],te.prototype,"sourceJSON",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"sourceQuality",void 0),e.__decorate([y.property({readOnly:!0,json:{name:"serviceType"}})],te.prototype,"sourceType",void 0),e.__decorate([y.property()],te.prototype,"spatialReference",void 0),e.__decorate([y.property({json:{write:!0}})],te.prototype,"start",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"started",null),e.__decorate([y.property({readOnly:!0,type:String})],te.prototype,"state",null),e.__decorate([y.property({readOnly:!0,type:j})],te.prototype,"telemetry",null),e.__decorate([y.property({type:M,nonNullable:!0,json:{write:{ignoreOrigin:!0}}})],te.prototype,"telemetryDisplay",void 0),e.__decorate([m.reader("service","title",["name"])],te.prototype,"readTitleFromService",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"type",void 0),e.__decorate([y.property(x.urlProperty())],te.prototype,"url",void 0),e.__decorate([y.property({readOnly:!0,type:Number,json:{read:{source:"currentVersion"}}})],te.prototype,"version",void 0),e.__decorate([y.property({readOnly:!0})],te.prototype,"videoElement",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"videoHeight",null),e.__decorate([y.property({readOnly:!0,json:{read:!1}})],te.prototype,"videoLayersInfo",void 0),e.__decorate([m.reader("service","videoLayersInfo",["id","name","poster","serviceType","type"])],te.prototype,"readLayerInfosFromService",null),e.__decorate([y.property({type:V,readOnly:!0})],te.prototype,"videoTimeExtent",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"videoWidth",null),e.__decorate([y.property()],te.prototype,"volume",null),e.__decorate([y.property({readOnly:!0})],te.prototype,"waiting",null),te=e.__decorate([h.subclass("esri.layers.VideoLayer")],te),te}));