// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../request","../../core/Error","../../core/Logger","../../core/urlUtils","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../graphics/featureConversionUtils","../graphics/OptimizedFeatureSet","../graphics/sources/geojson/geojson","../graphics/sources/support/clientSideDefaults","../graphics/sources/support/sourceUtils","../support/FieldsIndex","../support/fieldType","../../time/constants"],(function(e,t,n,i,r,a,o,s,l,c,u,d,f,m,p,g){"use strict";const y=()=>i.getLogger("esri.layers.ogc.ogcFeatureUtils"),w="startindex",b=new Set([w,"offset"]),h="http://www.opengis.net/def/crs/",F=`${h}OGC/1.3/CRS84`;var j;async function I(e,i,d){const{collection:{links:p,landingPage:{url:g}},layerDefinition:y,maxRecordCount:w,queryParameters:{apiKey:b,customParameters:h},spatialReference:F,supportedCrs:I}=e,x=S(p,"items",j.geojson)||S(p,"http://www.opengis.net/def/rel/ogc/1.0/items",j.geojson);if(null==x)throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:v,num:O,start:P,timeExtent:q,where:C}=i;if(i.objectIds)throw new n("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");const N=a.fromJSON(F),D=i.outSpatialReference??N,G=D.isWGS84?null:T(D,I),A=function(e,t){if(!function(e){return null!=e&&"extent"===e.type}(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:k(e)};const i=T(n,t);return null!=i?{bbox:k(e),"bbox-crs":i}:n.isWebMercator?{bbox:k(s.project(e,a.WGS84))}:null}(v,I),R=function(e){if(null==e)return null;const{start:t,end:n}=e;return`${null!=t?t.toISOString():".."}/${null!=n?n.toISOString():".."}`}(q),W=function(e){return null!=e&&e&&"1=1"!==e?e:null}(C),$=O??(null==P?w:10),M=0===P?void 0:P,{fields:L,geometryType:Z,hasZ:J,objectIdField:K,paginationParameter:U}=y,z=r.makeAbsolute(x.href,g),{data:E}=await t(z,{...d,query:{...h,...A,crs:G,datetime:R,query:W,limit:$,[U]:M,token:b},headers:{accept:j.geojson}}),Q=u.createOptimizedFeatures(E,{geometryType:Z,hasZ:J,objectIdField:K}),_=Q.length===$&&!!S(E.links??[],"next",j.geojson),B=new m(L);for(const e of Q){const t={};f.mixAttributes(B,t,e.attributes,!0);for(const e of B.fields)e.nullable&&!(e.name in t)&&(t[e.name]=null);t[K]=e.attributes[K],e.attributes=t}if(!G&&D.isWebMercator)for(const e of Q)if(null!=e.geometry&&null!=Z){const t=l.convertToGeometry(e.geometry,Z,J,!1);t.spatialReference=a.WGS84,e.geometry=l.convertFromGeometry(s.project(t,D))}for(const e of Q)e.objectId=e.attributes[K];const V=G||!G&&D.isWebMercator?D.toJSON():o.wgs84,H=new c;return H.exceededTransferLimit=_,H.features=Q,H.fields=L,H.geometryType=Z,H.hasZ=J,H.spatialReference=V,H}function T(e,t){const{isWebMercator:n,wkid:i}=e;if(!i)return null;const r=n?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return r?`${h}${r}`:null}function k(e){if(null==e)return"";const{xmin:t,ymin:n,xmax:i,ymax:r}=e;return`${t},${n},${i},${r}`}function S(e,t,n){return e.find((({rel:e,type:i})=>e===t&&i===n))??e.find((({rel:e,type:n})=>e===t&&!n))}!function(e){e.json="application/json",e.geojson="application/geo+json",e.openapi="application/vnd.oai.openapi+json;version=3.0"}(j||(j={})),e.crsDefault=F,e.crsPrefix=h,e.getCollectionDefinition=async function(e,i,o={},s=5){const{links:l}=e,c=S(l,"items",j.geojson)||S(l,"http://www.opengis.net/def/rel/ogc/1.0/items",j.geojson);if(null==c)throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{apiKey:f,customParameters:h,signal:F}=o,I=r.makeAbsolute(c.href,e.landingPage.url),T={limit:s,...h,token:f},k=r.addQueryParameters(I,T),x={accept:j.geojson},{data:v}=await t(k,{signal:F,headers:x}),O=function(e,t,n){if(!n)return;const i=S(n,"next",j.geojson),a=r.urlToObject(i?.href)?.query;if(!a)return;const o=r.urlToObject(e).query,s=Object.keys(o??{}),l=Object.entries(a).filter((([e])=>!s.includes(e))).find((([e,n])=>b.has(e.toLowerCase())&&Number.parseInt(n,10)===t)),c=l?.[0];return c}(k,s,v.links)??w;u.validateGeoJSON(v);const P=u.inferLayerProperties(v,{geometryType:i.geometryType}),q=i.fields||P.fields||[],C=null!=i.hasZ?i.hasZ:P.hasZ,N=P.geometryType,D=i.objectIdField||P.objectIdFieldName||"OBJECTID";let G=i.timeInfo;const A=q.find((({name:e})=>e===D));if(A)A.editable=!1,A.nullable=!1;else{if(!P.objectIdFieldType)throw new n("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");q.unshift({name:D,alias:D,type:"number"===P.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(D!==P.objectIdFieldName){const e=q.find((({name:e})=>e===P.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}q===P.fields&&P.unknownFields.length>0&&y().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:P.unknownFields}});for(const e of q){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new n("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(!p.kebabDict.jsonValues.includes(e.type))throw new n("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(G){const e=new m(q);if(G.startTimeField){const t=e.get(G.startTimeField);t?(G.startTimeField=t.name,t.type="esriFieldTypeDate"):G.startTimeField=null}if(G.endTimeField){const t=e.get(G.endTimeField);t?(G.endTimeField=t.name,t.type="esriFieldTypeDate"):G.endTimeField=null}if(G.trackIdField){const t=e.get(G.trackIdField);t?G.trackIdField=t.name:(G.trackIdField=null,y().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:G}}))}G.timeReference||={timeZoneIANA:g.utc},G.startTimeField||G.endTimeField||(y().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:G}}),G=void 0)}const R=N?d.createDrawingInfo(N):null,W=function(e){const t=e.extent?.spatial;if(!t)return null;const n=t.bbox[0],i=4===n.length,[r,o]=n,s=i?void 0:n[2];return{xmin:r,ymin:o,xmax:i?n[2]:n[3],ymax:i?n[3]:n[4],zmin:s,zmax:i?void 0:n[5],spatialReference:a.WGS84.toJSON()}}(e);return{drawingInfo:R,extent:W,geometryType:N,fields:q,hasZ:!!C,objectIdField:D,paginationParameter:O,timeInfo:G}},e.getServerCollections=async function(e,i={}){const{links:a,url:o}=e,s=S(a,"data",j.json)||S(a,"http://www.opengis.net/def/rel/ogc/1.0/data",j.json);if(null==s)throw new n("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:l,customParameters:c,signal:u}=i,d=r.makeAbsolute(s.href,o),{data:f}=await t(d,{signal:u,headers:{accept:j.json},query:{...c,token:l}});for(const t of f.collections)t.landingPage=e;return f},e.getServerConformance=async function(e,i={}){const{links:a,url:o}=e,s=S(a,"conformance",j.json)||S(a,"http://www.opengis.net/def/rel/ogc/1.0/conformance",j.json);if(null==s)throw new n("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:l,customParameters:c,signal:u}=i,d=r.makeAbsolute(s.href,o),{data:f}=await t(d,{signal:u,headers:{accept:j.json},query:{...c,token:l}});return f},e.getServerLandingPage=async function(e,n={}){const{apiKey:i,customParameters:r,signal:a}=n,{data:o}=await t(e,{signal:a,headers:{accept:j.json},query:{...r,token:i}});return o.url=e,o},e.getServerOpenApi=async function(e,n={}){const{links:i,url:a}=e,o=S(i,"service-desc",j.openapi);if(null==o)return y().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:s,customParameters:l,signal:c}=n,u=r.makeAbsolute(o.href,a),{data:d}=await t(u,{signal:c,headers:{accept:j.openapi},query:{...l,token:s}});return d},e.getSpatialReferenceWkid=function(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=t?.groups;if(!n)return null;const{authority:i,code:r}=n;switch(i.toLowerCase()){case"ogc":switch(r.toLowerCase()){case"crs27":return a.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return a.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(r,10);return Number.isNaN(e)?null:e}default:return null}},e.queryFeatureSetJSON=async function(e,t,n){const i=await I(e,t,n);return l.convertToFeatureSet(i)},e.queryOptimizedFeatureSet=I,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));