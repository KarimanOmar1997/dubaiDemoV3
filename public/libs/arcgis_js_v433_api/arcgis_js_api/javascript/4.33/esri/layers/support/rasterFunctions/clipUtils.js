// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/unitUtils","../../../geometry/Extent","../../../geometry/Point","../PixelBlock"],(function(e,t,n,i,a,r){"use strict";function o(e){const{geometry:t,size:n,srcExtent:i,srcMask:a}=e,[r,o]=n;let x;const h=i.width/r,s=i.height/o,{xmin:l,ymax:m}=i;if("extent"===t.type){const e=(t.xmin-l)/h,n=(t.xmax-l)/h,i=(m-t.ymax)/s,a=(m-t.ymin)/s;x=[[[e,i],[e,a],[n,a],[n,i],[e,i]]]}else x=t.rings.map((e=>e.map((([e,t])=>[(e-l)/h,(m-t)/s]))));return function(e,t,n){const[i,a]=t,r=new OffscreenCanvas(i,a).getContext("2d");r.fillStyle="#f00",r.beginPath(),e.forEach((e=>{r.moveTo(e[0][0],e[0][1]);for(let t=0;t<e.length;t++)r.lineTo(e[t][0],e[t][1]);r.closePath()})),r.fill();const o=r.getImageData(0,0,i,a).data,x=i*a,h=new Uint8Array(x);let s=!1;for(let e=0;e<x;e++)n&&!n[e]||(o[4*e+3]>127?h[e]=255:s=!0);return s||n?h:void 0}(x,n,a)}function x(e,t,a,r=!0){const{spatialReference:o}=e,{x,y:h}=function(e,t){if(e.spatialReference.equals(t))return e;const i=n.getMetersPerUnitForSR(e.spatialReference),a=n.getMetersPerUnitForSR(t);if(i===a)return e;const r=i/a;return{x:e.x*r,y:e.y*r}}(a,o);let s,l,m;const p="extent"===t.type?t:t.extent;let{xmin:c,xmax:y,ymax:f,ymin:u}=p;const{xmin:M,ymax:w}=e.extent;return r?(c=M+(c>M?x*Math.round((c-M)/x):0),f=w-(f<w?h*Math.round((w-f)/h):0),y=M+(y>M?x*Math.round((y-M)/x):0),u=w-(u<w?h*Math.round((w-u)/h):0),s=new i({xmin:c,ymax:f,xmax:y,ymin:u,spatialReference:o}),l=Math.round(s.width/x),m=Math.round(s.height/h)):(l=Math.floor((y-c)/x+.8),m=Math.floor((f-u)/h+.8),c=M+(c>M?x*Math.floor((c-M)/x+.1):0),f=w-(f<w?h*Math.floor((w-f)/h+.1):0),y=c+l*x,u=f-m*h,s=new i({xmin:c,ymax:f,xmax:y,ymin:u,spatialReference:o})),{extent:s,width:l,height:m}}t.clip=async function(t,n,i){if("extent"===i.type)return function(e,t,n){const{width:i,height:a}=e,o=new Uint8Array(i*a),x=t.width/i,h=t.height/a;if(n.width/x<.5||n.height/h<.5)return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]});const{xmin:s,xmax:l,ymin:m,ymax:p}=t,{xmin:c,xmax:y,ymin:f,ymax:u}=n,M=Math.max(s,c),w=Math.min(l,y),d=Math.max(m,f),g=Math.min(p,u),T=.5*x,k=.5*h;if(w-M<T||g-d<k||w<s+T||M>l-T||d>p-k||g<m+k)return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]});const R=Math.max(0,(M-s)/x),P=Math.min(i,Math.max(0,(w-s)/x)),S=Math.max(0,(p-g)/h),U=Math.min(a,Math.max(0,(p-d)/h)),A=Math.round(R),v=Math.round(P)-1,z=Math.round(S),E=Math.round(U)-1;if(A===v&&R%1>.5&&P%1<.5||z===E&&S%1>.5&&U%1<.5)return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]});if(0===A&&0===z&&v===i&&E===a)return e;const I=e.mask;for(let e=z;e<=E;e++)for(let t=A;t<=v;t++){const n=e*i+t;o[n]=I?I[n]:255}return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]})}(t,n,i);const{width:a,height:x}=t,h=new Uint8Array(a*x);return(await new Promise(((t,n)=>e(["../../../geometry/operators/intersectsOperator"],t,n)))).execute(n,i)?"polyline"===i.type?function(e,t,n){const{width:i,height:a}=e,o=new Uint8Array(i*a),x=t.width/i,h=t.height/a,{xmin:s,ymax:l}=t,{paths:m}=n,p=e.mask;for(let e=0;e<m.length;e++){const t=m[e];for(let e=0;e<t.length-1;e++){const[n,r]=t[e],[m,c]=t[e+1];let y=Math.floor((l-r)/h),f=Math.floor((l-c)/h);if(f<y){const e=y;y=f,f=e}y=Math.max(0,y),f=Math.min(a-1,f);const u=(m-n)/(c-r);for(let e=y;e<=f;e++){const t=e===y?Math.max(r,c):(a+1-e)*h,l=e===f?Math.min(r,c):t-h;let M=c===r?Math.floor((n-s)/x):Math.floor((u*(t-r)+n-s)/x),w=c===r?Math.floor((m-s)/x):Math.floor((u*(l-r)+n-s)/x);if(w<M){const e=M;M=w,w=e}const d=e*i;M=Math.max(0,M),w=Math.min(i-1,w);for(let e=d+M;e<=d+w;e++)o[e]=p?p[e]:255}}}return new r({pixelType:e.pixelType,width:i,height:a,mask:o,pixels:[...e.pixels]})}(t,n,i):(await new Promise(((t,n)=>e(["../../../geometry/operators/containsOperator"],t,n)))).execute(i,n)?t:function(e,t,n){if(!e)return e;const{width:i,height:a}=e,x=o({geometry:n,size:[i,a],srcExtent:t,srcMask:e.mask});return new r({pixelType:e.pixelType,width:i,height:a,mask:x,maskIsAlpha:!1,pixels:[...e.pixels]})}(t,n,i):new r({pixelType:t.pixelType,width:a,height:x,mask:h,maskIsAlpha:!1,pixels:[...t.pixels]})},t.clipRasterInfo=function(e,t){const{extent:n}=x(e,t,new a({x:e.pixelSize.x,y:e.pixelSize.y,spatialReference:e.spatialReference})),{extent:i}=e.extent;if(n.xmax=Math.min(n.xmax,i.xmax),n.ymax=Math.min(n.ymax,i.ymax),n.xmin<n.xmax&&n.ymin<n.ymax){const{x:t,y:i}=e.pixelSize,a=Math.round(n.width/t),r=Math.round(n.height/i);e.extent=n,e.width=a,e.height=r}},t.convertGeometryToMask=o,t.snapToRaster=x,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));