// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../chunks/tslib.es6","../request","../core/JSONSupport","../core/Loadable","../core/sql","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./support/typeUtils","./support/utils","../support/guards"],(function(e,t,s,o,r,n,i,a,u,c,l,p,d,y){"use strict";return e.default=class extends(o.JSONSupportMixin(r)){constructor(e){super(e),this.rulesCategorized={attachment:[],containment:[],connectivity:[]},this.request=s}initialize(){}async load(e){const t=this.rulesLayer.load(e).then((()=>this._initializeRulesTable()));return this.addResolvingPromise(t),this}getFeaturesCanAssociateWithClause(e,t,s){const o=new Map,[r,i]=d.getAssetFieldNames(e.sourceLayer);if(!r||!i)return"";const a=d.getRuleValues(e),u=d.getRuleValues(t);s.forEach((e=>{const{type:t,direction:s}=e;this._getRulesForAssociationType(t).forEach((e=>{d.getCompatibleRuleElements(e,a,s).filter((e=>e.networkSource?.layerId===u.layerId)).forEach((e=>{const t=e.assetGroup?.assetGroupCode,s=e.assetType?.assetTypeCode;if(null!=t&&null!=s){const e=o.get(t)??new Set;e.add(s),o.set(t,e)}}))}))}));let c=[];return this._mergeAssetCodes(o).forEach(((e,t)=>{const s=`${r} IN (${t})`,o=n.sqlIn(i,[...e]);s&&o&&c.push(n.sqlAnd(s,o))})),c.length>1&&(c=c.map((e=>`(${e})`))),c.join(" OR ")}getFeaturesCanAssociateWith(e,t,s){return null==d.getFeatureSourceLayerId(e)?[]:t.filter((t=>this.canAssociateFeatures(e,t,s)))}canAssociateFeatures(e,t,s){if(!this._canSupportAssociations([e,t]))return!1;const o=d.getRuleValues(e),r=d.getRuleValues(t);return s.some((e=>{const{type:t,direction:s}=e;return this._getRulesForAssociationType(t).some((e=>"to"===s?d.doesRuleAllowAssociation(e,r,o):d.doesRuleAllowAssociation(e,o,r)))}))}getLayersCanAssociateWith(e,t,s){return null==d.getFeatureSourceLayerId(e)?[]:t.filter((t=>this.canAssociateFeatureToLayer(e,t,s)))}canAssociateFeatureToLayer(e,t,s){if(!this._canSupportAssociations([e,t]))return!1;const o=d.getRuleValues(e),r=d.getRuleValues(t);return s.some((e=>{const{type:t,direction:s}=e;return this._getRulesForAssociationType(t).some((e=>"to"===s?d.doesRuleAllowAssociation(e,r,o):d.doesRuleAllowAssociation(e,o,r)))}))}getFeatureSQL(e,t){const s=e.layerId.toString(),o=e.fieldsIndex?.normalizeFieldName("assetGroup"),r=e.fieldsIndex?.normalizeFieldName("assetType"),n=o?t.attributes[o]:null,i=r?t.attributes[r]:null,a=this.rulesHash[s];if(a){const e=a.assetGroupHash[n];if(e)return e.assetTypeHash[i]||null}return null}async _initializeRulesTable(){const e={};let t;!function(e){e[e.from=0]="from",e[e.to=1]="to",e[e.via=2]="via"}(t||(t={}));const s=[{networkSourceId:"fromNetworkSource",assetGroupId:"fromAssetGroup",assetTypeId:"fromAssetType"},{networkSourceId:"toNetworkSource",assetGroupId:"toAssetGroup",assetTypeId:"toAssetType"},{networkSourceId:"viaNetworkSource",assetGroupId:"viaAssetGroup",assetTypeId:"viaAssetType"}];this.rulesCategorized={attachment:[],containment:[],connectivity:[]};for(const o of this.rules){if(o.ruleType===p.RuleType.RTAttachment){this.rulesCategorized.attachment.push(o);continue}if(o.ruleType===p.RuleType.RTContainment){this.rulesCategorized.containment.push(o);continue}if(o.ruleType===p.RuleType.RTJunctionJunctionConnectivity){this.rulesCategorized.connectivity.push(o);continue}this.rulesCategorized.connectivity.push(o);let r=[[t.from,t.to],[t.to,t.from]];o.ruleType===p.RuleType.RTEdgeJunctionEdgeConnectivity&&(r=[[t.from,t.via],[t.via,t.from],[t.to,t.via],[t.via,t.to]]);for(const i of r){const r=i.shift(),a=i.shift();let u=!1;switch(o.ruleType){case p.RuleType.RTEdgeJunctionEdgeConnectivity:u=r===t.from||r===t.to;break;case p.RuleType.RTJunctionEdgeConnectivity:u=r===t.to}const c=s[r],l=o[c.networkSourceId]?.layerId.toString()??"",d=o[c.assetGroupId]?.assetGroupCode?.toString(),y=o[c.assetTypeId],h=y?.assetTypeCode?.toString(),f=s[a],g=o[f.networkSourceId]?.layerId.toString()??"",T=o[f.assetGroupId]?.assetGroupCode?.toString(),m=o[f.assetTypeId],R=m?.assetTypeCode?.toString(),A=e[l]??{assetGroupHash:{}};if(!(d&&h&&T&&R))continue;const v=A.assetGroupHash[d]??{assetTypeHash:{}},S=v.assetTypeHash[h]??{};if(S[g]=S[g]??{},u){S[l]=S[l]??{};const e=n.sqlAnd(`assetgroup = ${d}`,`assettype = ${h}`);"esriNECPEndVertex"===m?.connectivityPolicy?S[l].endVertex=S[l]?.endVertex?`${S[l].endVertex}`:`(${e})`:S[l].anyVertex=S[l].anyVertex?`${S[l].anyVertex}`:`(${e})`}const C=n.sqlAnd(`assetgroup = ${T}`,`assettype = ${R}`);"esriNECPEndVertex"===m?.connectivityPolicy?S[g].endVertex=S[g]?.endVertex?n.sqlOr(S[g].endVertex,C):`(${C})`:S[g].anyVertex=S[g]?.anyVertex?n.sqlOr(S[g].anyVertex,C):`(${C})`,v.assetTypeHash[h]=S,A.assetGroupHash[d]=v,e[l]=A}}this._set("rulesHash",e)}_getRulesForAssociationType(e){const{rulesCategorized:t}=this;switch(e){case"attachment":return t.attachment;case"containment":return t.containment;case"connectivity":case"junction-junction-connectivity":return t.connectivity.filter((e=>e.ruleType===p.RuleType.RTJunctionJunctionConnectivity));case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":return t.connectivity.filter((e=>e.ruleType===p.RuleType.RTJunctionEdgeConnectivity||e.ruleType===p.RuleType.RTEdgeJunctionEdgeConnectivity));default:return[]}}_areSetsEqual(e,t){if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;return!0}_mergeAssetCodes(e){const t=new Map,s=new Set;for(const[o,r]of e){const n=new Set([o]);for(const[t,i]of e)o!==t&&!s.has(t)&&this._areSetsEqual(r,i)&&(n.add(t),s.add(t));const i=Array.from(n).sort().join(",");t.set(i,r)}return t}_canSupportAssociations(e){return e.every((e=>{const t=y.isGraphic(e)?e.sourceLayer:e,[s,o]=d.getAssetFieldNames(t);return null!=s&&null!=o}))}},t.__decorate([i.property({constructOnly:!0})],e.default.prototype,"rulesLayer",void 0),t.__decorate([i.property({constructOnly:!0})],e.default.prototype,"rules",void 0),t.__decorate([i.property({readOnly:!0})],e.default.prototype,"rulesHash",void 0),t.__decorate([i.property()],e.default.prototype,"rulesCategorized",void 0),t.__decorate([i.property({constructOnly:!0})],e.default.prototype,"request",void 0),e.default=t.__decorate([l.subclass("esri.networks.RulesTable")],e.default),e.default}));