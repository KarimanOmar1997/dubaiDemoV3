// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../../request","../../core/Error","../../layers/support/featureQueryAll","../../layers/support/layerUtils","./typeUtils","../../portal/PortalItem","../../rest/support/FeatureSet","../../support/guards"],(function(e,t,r,n,o,l,u,a,s,i){"use strict";const c=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function y(e,t,r,n,o,l){if(!r||!n)return!1;const u=d(e,r,l),a=d(t,n,l);if(o){const o=d(e,n,l),s=d(t,r,l);return u&&a||o&&s}return u&&a}function p(e,t){const r=e.terminal?.terminalId,n=t.terminalId;return null==r&&null==n||(1===r?null==n||1===n:r===n)}function d(e,t,r){const{assetGroupCode:n,assetTypeCode:o}=e;return("layerId"in e?e.layerId===t.networkSource?.layerId:e.networkSourceId===t.networkSource?.sourceId)&&(null==n||n===t.assetGroup?.assetGroupCode)&&(null==o||o===t.assetType?.assetTypeCode)&&(!r||!("terminalId"in e)||p(t,e))}function m(e){return{fromRuleElement:{networkSource:e.fromNetworkSource,assetGroup:e.fromAssetGroup,assetType:e.fromAssetType,terminal:e.fromTerminal},viaRuleElement:e.viaNetworkSource?{networkSource:e.viaNetworkSource,assetGroup:e.viaAssetGroup,assetType:e.viaAssetType,terminal:e.viaTerminal}:void 0,toRuleElement:{networkSource:e.toNetworkSource,assetGroup:e.toAssetGroup,assetType:e.toAssetType,terminal:e.toTerminal}}}function f(e){const{sourceLayer:t}=e;let r;return l.isFeatureLayer(t)?r=t.layerId:l.isSubtypeSublayer(t)&&(r=t.parent?.layerId),r??null}function T(e){const[t,r]=R(e.sourceLayer);return[t?e.attributes[t]:null,r?e.attributes[r]:null]}function R(e){return e&&"fieldsIndex"in e?[e.fieldsIndex.normalizeFieldName("assetGroup")??null,e.fieldsIndex.normalizeFieldName("assetType")??null]:[null,null]}async function w(t,r){if("Utility Network Layer"===t){const{default:t}=await new Promise(((t,r)=>e(["../UtilityNetwork"],(e=>t(c(e))),r)));return new t({layerUrl:r})}return null}t.doElementsMatchRule=y,t.doesRuleAllowAssociation=function(e,t,r){const{fromRuleElement:n,viaRuleElement:o,toRuleElement:l}=m(e);switch(e.ruleType){case u.RuleType.RTContainment:case u.RuleType.RTAttachment:return y(t,r,n,l,!1,!1);case u.RuleType.RTJunctionEdgeConnectivity:case u.RuleType.RTJunctionJunctionConnectivity:return y(t,r,n,l,!0,!0);case u.RuleType.RTEdgeJunctionEdgeConnectivity:return y(t,r,n,o,!0,!0)||y(t,r,l,o,!0,!0);default:return!1}},t.getAssetFieldNames=R,t.getCompatibleRuleElements=function(e,t,r="from"){const{fromRuleElement:n,viaRuleElement:o,toRuleElement:l}=m(e),a=[];switch(e.ruleType){case u.RuleType.RTContainment:case u.RuleType.RTAttachment:"from"===r&&d(t,n,!1)?a.push(l):"to"===r&&d(t,l,!1)&&a.push(n);break;case u.RuleType.RTJunctionEdgeConnectivity:case u.RuleType.RTJunctionJunctionConnectivity:d(t,n,!0)?a.push(l):d(t,l,!0)&&a.push(n);break;case u.RuleType.RTEdgeJunctionEdgeConnectivity:o&&(d(t,o,!0)?(a.push(n),a.push(l)):(d(t,n,!0)||d(t,l,!0))&&a.push(o));break;default:return[]}return a},t.getElementsFromRule=m,t.getFeatureAssetCodes=T,t.getFeatureSourceLayerId=f,t.getFeaturesFromLayers=async function(e,t){const r=e.layers,n=e.layerInfos,l=e.returnGeometry||!1,u=e.outSpatialReference;return await Promise.all(r.map((async e=>{await e.load()}))),(await Promise.all(r.map((async e=>{const r=n.find((t=>t.layerUrl===e.parsedUrl?.path));if(!r?.objectIds?.length)return{layer:e,featureSet:void 0};const a=e.createQuery();a.returnGeometry=l,a.outFields=r.outFields||["*"],a.outSpatialReference=u,a.gdbVersion=e.gdbVersion,a.objectIds=r.objectIds,t&&(a.where="1=1");const i=s.fromJSON(await o.queryAllJSON(e,a));return i.features.forEach((t=>{t.layer=t.sourceLayer=e})),{layer:e,featureSet:i}})))).filter((e=>void 0!==e.featureSet))},t.getRuleValues=function(e){let t=null,r=null,n=null;if(i.isGraphic(e))t=f(e),[r,n]=T(e);else if(l.isSubtypeSublayer(e)){t=e.parent?.layerId??null;const[n]=R(e);n===e.subtypeField&&(r=e.subtypeCode)}else t=e.layerId??null;return{layerId:t,assetGroupCode:r,assetTypeCode:n}},t.isRuleElementMatch=d,t.isTerminalMatch=p,t.networkFromPortalItem=async function(e){let t="portalItem"in e?e:{portalItem:e};!t.portalItem||t.portalItem instanceof a||(t={...t,portalItem:new a(t.portalItem)});const o=t.portalItem;if(await o.load(),"Feature Service"!==o.type)throw new n("portal:unknown-item-type","Unknown item type '${type}'",{type:o.type});const l=o.url,u=await r(l,{responseType:"json",query:{f:"json"}}),s="Network Layer";if(u.data.type?.includes(s))return w(u.data.type,l);if(u.data.layers){const e=u.data.layers.find((e=>e.type.includes(s)));if(e){const t=`${l}/${e.id}`;return w(e.type,t)}}return null},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));