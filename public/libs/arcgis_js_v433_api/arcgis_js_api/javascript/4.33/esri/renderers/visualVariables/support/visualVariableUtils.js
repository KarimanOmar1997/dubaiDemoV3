// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../Color","../../../Graphic","../../../core/compilerUtils","../../../core/Logger","../../support/lengthUtils","./sizeVariableUtils"],(function(e,n,a,i,t,r,l){"use strict";const s=()=>t.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),o=e=>s().warn(`The visualVariable should be an instance of esri.renderers.visualVariables.${e}`),u=()=>s().error("Use of arcade expressions requires an arcade context"),c=new a,f=Math.PI;function p(e,a,i){const t="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"color"===e.type)):e;if(!t)return;if("esri.renderers.visualVariables.ColorVariable"!==t.declaredClass)return void o("ColorVariable");const r="number"==typeof a,s=r?null:a,c=s?.attributes;let f=r?a:null;const p=t.field,{ipData:d,hasExpression:b}=t.cache;let v=t.cache.compiledFunc;if(!p&&!b){const e=t.stops;return e&&e[0]&&e[0].color}if("number"!=typeof f)if(b){if(null==i?.arcade)return void u();const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},n=i.arcade.arcadeUtils,a=n.getViewInfo(e),r=n.createExecContext(s,a,i.timeZone);if(!v){const e=n.createSyntaxTree(t.valueExpression);v=n.createFunction(e),t.cache.compiledFunc=v}f=n.executeFunction(v,r)}else c&&(f=c[p]);const m=t.normalizationField,h=null!=c&&null!=m?parseFloat(c[m]):void 0;if(null!=f&&(!m||r||!isNaN(h)&&0!==h)){l.isValidNumber(h)&&!r&&(f/=h);const e=y(f,d);if(e){const a=e[0],r=e[1],l=a===r?t.stops[a].color:n.blendColors(t.stops[a].color,t.stops[r].color,e[2],null!=i?i.color:void 0);return new n(l)}}}function d(e,n,a){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"opacity"===e.type)):e;if(!i)return;if("esri.renderers.visualVariables.OpacityVariable"!==i.declaredClass)return void o("OpacityVariable");const t="number"==typeof n,r=t?null:n,s=r?.attributes;let c=t?n:null;const f=i.field,{ipData:p,hasExpression:d}=i.cache;let b=i.cache.compiledFunc;if(!f&&!d){const e=i.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof c)if(d){if(null==a?.arcade)return void u();const e={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},n=a.arcade.arcadeUtils,t=n.getViewInfo(e),l=n.createExecContext(r,t,a.timeZone);if(!b){const e=n.createSyntaxTree(i.valueExpression);b=n.createFunction(e),i.cache.compiledFunc=b}c=n.executeFunction(b,l)}else s&&(c=s[f]);const v=i.normalizationField,m=null!=s&&null!=v?parseFloat(s[v]):void 0;if(null!=c&&(!v||t||!isNaN(m)&&0!==m)){l.isValidNumber(m)&&!t&&(c/=m);const e=y(c,p);if(e){const n=e[0],a=e[1];if(n===a)return i.stops[n].opacity;{const t=i.stops[n].opacity;return t+(i.stops[a].opacity-t)*e[2]}}}}function b(e,n,a){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"rotation"===e.type)):e;if(!i)return;if("esri.renderers.visualVariables.RotationVariable"!==i.declaredClass)return void o("RotationVariable");const t=i.axis||"heading",r="heading"===t&&"arithmetic"===i.rotationType?90:0,l="heading"===t&&"arithmetic"===i.rotationType?-1:1,s="number"==typeof n?null:n,c=s?.attributes,f=i.field,{hasExpression:p}=i.cache;let d=i.cache.compiledFunc,b=null;if(!f&&!p)return b;if(p){if(null==a?.arcade)return void u();const e={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},n=a.arcade.arcadeUtils,t=n.getViewInfo(e),r=n.createExecContext(s,t,a.timeZone);if(!d){const e=n.createSyntaxTree(i.valueExpression);d=n.createFunction(e),i.cache.compiledFunc=d}b=n.executeFunction(d,r)}else c&&(b=c[f]);return b="number"!=typeof b||isNaN(b)?null:r+l*b,b}function v(e,n,a){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"size"===e.type)):e;if(!i)return;if("esri.renderers.visualVariables.SizeVariable"!==i.declaredClass)return void o("SizeVariable");const t=function(e,n,a){const i="number"==typeof n,t=i?null:n,r=t?.attributes;let s=i?n:null;const{isScaleDriven:o}=e.cache;let c=e.cache.compiledFunc;if(o){const n=null!=a?a.scale:void 0,i=null!=a?a.view:void 0;s=null==n||"3d"===i?function(e){let n=null,a=null;const i=e.stops;return i?(n=i[0].value,a=i[i.length-1].value):(n=e.minDataValue||0,a=e.maxDataValue||0),(n+a)/2}(e):n}else if(!i)switch(e.inputValueType){case l.InputValueType.Expression:{if(null==a?.arcade)return void u();const n={viewingMode:a.viewingMode,scale:a.scale,spatialReference:a.spatialReference},i=a.arcade.arcadeUtils,r=i.getViewInfo(n),l=i.createExecContext(t,r,a.timeZone);if(!c){const n=i.createSyntaxTree(e.valueExpression);c=i.createFunction(n),e.cache.compiledFunc=c}s=i.executeFunction(c,l);break}case l.InputValueType.Field:r&&(s=r[e.field]);break;case l.InputValueType.Unknown:s=null}if(!l.isValidNumber(s))return null;if(i||!e.normalizationField)return s;const f=r?parseFloat(r[e.normalizationField]):null;return l.isValidNumber(f)&&0!==f?s/f:null}(i,n,a),r=V(t,i,n,a,i.cache.ipData);return null==r||isNaN(r)?void 0:r}function m(e,n,a){return null==e?null:l.isSizeVariable(e)?v(e,n,a):l.isValidNumber(e)?e:null}function h(e,n,a){return l.isValidNumber(a)&&e>a?a:l.isValidNumber(n)&&e<n?n:e}function V(e,n,a,i,t){switch(n.transformationType){case l.TransformationType.Additive:return function(e,n,a,i){const t=m(n.minSize,a,i)||n.minDataValue;return null==e&&null==t?null:(e??0)+(t??0)}(e,n,a,i);case l.TransformationType.Constant:return function(e,n,a){const i=e.stops;let t=i?.length&&i[0].size;return null==t&&(t=e.minSize),m(t,n,a)}(n,a,i);case l.TransformationType.ClampedLinear:return function(e,n,a,i){const t=m(n.minSize,a,i);if(null==e)return t;const{minDataValue:r,maxDataValue:l}=n;if(null==r||null==l)return null;const s=(e-r)/(l-r),o=m(n.maxSize,a,i),u=null!=i?i.shape:void 0;if(e<=r)return t;if(e>=l)return o;if(null==t||null==o)return null;if("area"===n.scaleBy&&u){const e="circle"===u,n=e?f*(t/2)**2:t*t,a=n+s*((e?f*(o/2)**2:o*o)-n);return e?2*Math.sqrt(a/f):Math.sqrt(a)}return t+s*(o-t)}(e,n,a,i);case l.TransformationType.Proportional:return function(e,n,a,i){const t=m(n.minSize,a,i);if(null==e||null==t)return t;const r=null!=i?i.shape:void 0,{minDataValue:l}=n;if(null==l)return null;const s=e/l,o=m(n.maxSize,a,i);let u=null;return u="circle"===r?2*Math.sqrt(s*(t/2)**2):"square"===r||"diamond"===r||"image"===r?Math.sqrt(s*t**2):s*t,h(u,t,o)}(e,n,a,i);case l.TransformationType.Stops:return function(e,n,a,i,t){if(null==e)return null;const[r,l,s]=y(e,t);if(r===l)return m(n.stops?.[r].size,a,i);{const e=m(n.stops?.[r].size,a,i),t=m(n.stops?.[l].size,a,i);return null==e||null==t?null:e+(t-e)*s}}(e,n,a,i,t);case l.TransformationType.RealWorldSize:return function(e,n,a,i){const t=(i?.resolution??1)*r.meterIn[n.valueUnit],l=m(n.minSize,a,i),s=m(n.maxSize,a,i),{valueRepresentation:o}=n;if(null==e)return l;let u=null;return u="area"===o?2*Math.sqrt(e/f)/t:"radius"===o||"distance"===o?2*e/t:e/t,h(u,l,s)}(e,n,a,i);case l.TransformationType.Identity:return e;case l.TransformationType.Unknown:return null}}function y(e,n){if(!n)return;let a=0,i=n.length-1;return n.some(((n,t)=>e<n?(i=t,!0):(a=t,!1))),[a,i,(e-n[a])/(n[i]-n[a])]}e.getAllSizes=function(e,n,a){const t=["proportional","proportional","proportional"];for(const r of e){const e=r.useSymbolValue?"symbol-value":v(r,n,a)??"proportional";switch(r.axis){case"width":t[0]=e;break;case"depth":t[1]=e;break;case"height":t[2]=e;break;case"width-and-depth":t[0]=e,t[1]=e;break;case"all":case void 0:case null:t[0]=e,t[1]=e,t[2]=e;break;default:i.neverReached(r.axis)}}return t},e.getColor=p,e.getOpacity=d,e.getRotationAngle=b,e.getSize=v,e.getSizeForValue=V,e.getSizeFromNumberOrVariable=m,e.getSizeRangeAtScale=function(e,n,a){const{isScaleDriven:i}=e.cache;if(!(i&&"3d"===a||n))return null;const t={scale:n,view:a};let r=m(e.minSize,c,t),l=m(e.maxSize,c,t);if(null!=r||null!=l){if(r>l){const e=l;l=r,r=e}return{minSize:r,maxSize:l}}},e.getVisualVariableValues=function(e,n,a){if(!e.visualVariables)return;const i=[],t=[],r=[],l=[],s=[];for(const n of e.visualVariables)switch(n.type){case"color":t.push(n);break;case"opacity":r.push(n);break;case"rotation":s.push(n);break;case"size":l.push(n)}return t.forEach((e=>{const t=p(e,n,a);i.push({variable:e,value:t})})),r.forEach((e=>{const t=d(e,n,a);i.push({variable:e,value:t})})),s.forEach((e=>{const t=b(e,n,a);i.push({variable:e,value:t})})),l.forEach((e=>{const t=v(e,n,a);i.push({variable:e,value:t})})),i},e.viewScaleRE=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));