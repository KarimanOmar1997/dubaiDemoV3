// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../config","../../kernel","../../request","../../core/arrayUtils","../../core/Error","../../core/Identifiable","../../core/JSONSupport","../../core/lang","../../core/Loadable","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../editing/sharedTemplates/SharedTemplateMetadata","../../geometry/SpatialReference","../../layers/graphics/applyEditsUtils","../../layers/graphics/editingSupport","../../layers/mixins/EditBusLayer","../../layers/support/featureLayerUtils","../../layers/support/layerUtils","../../layers/support/serviceCapabilitiesUtils","../../portal/PortalItem","../../portal/support/portalItemUtils","../../portal/support/urlUtils","../utils","../query/operations/editsZScale","../sharedTemplates/querySharedTemplates","../support/jsonUtils","../../versionManagement/support/versionManagementUtils"],(function(e,t,s,r,a,i,o,n,l,d,u,p,c,y,h,m,b,f,g,v,S,E,O,I,A,w,_,F,R,U,T,C){"use strict";function j(e,t){const s=t.id;return{id:s,name:t.name,url:`${e}/${s}`,type:t.type||"Table"}}function P(e){return{isDataVersioned:T.readBoolean(e,"hasVersionedData",!1),isDataBranchVersioned:T.readBoolean(e,"hasBranchVersionedData",!1)}}function V(e,t){const s=e?e.toLowerCase().split(",").map((e=>e.trim())):[],r=s.includes("query"),a=s.includes("editing")&&!t.datesInUnknownTimezone;let i=a&&s.includes("create"),o=a&&s.includes("delete"),n=a&&s.includes("update");return a&&!(i||o||n)&&(i=o=n=!0),{supportsAdd:i,supportsDelete:o,supportsEditing:a,supportsChangeTracking:s.includes("changetracking"),supportsQuery:r,supportsQueryDataElements:T.readBoolean(t,"supportsQueryDataElements",!1),supportsQueryDomains:T.readBoolean(t,"supportsQueryDomains",!1),supportsQueryContingentValues:T.readBoolean(t,"supportsQueryContingentValues",!1),supportsSync:s.includes("sync"),supportsUpdate:n}}function D(e){return{maxRecordCountFactor:T.readNumber(e,"maxRecordCountFactor",void 0),maxRecordCount:T.readNumber(e,"maxRecordCount",void 0)}}function G(e){const t=e?.advancedEditingCapabilities;return{supportsAsyncApplyEdits:T.readBoolean(t,"supportsAsyncApplyEdits",!1),supportsGlobalId:T.readBoolean(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:T.readBoolean(t,"supportsReturnServiceEditsInSourceSR",!1),supportsSharedTemplates:T.readBoolean(e,"supportsSharedTemplates",!1)||T.readBoolean(e,"hasSharedTemplates",!1),supportsSplit:T.readBoolean(t,"supportsSplit",!1)}}function k(e){const t=e?.syncCapabilities,s=t?.supportedSyncDataOptions;return{supportsAsync:T.readBoolean(t,"supportsAsync",!1),supportedSyncDataOptions:{annotations:!(1&~s),dimensions:!(2&~s),contingentValues:!(4&~s),attributeRules:!(8&~s),utilityNetworkSystem:!(16&~s),annotationFullModel:!(32&~s),include3DObjects:!(64&~s),utilityNetworkMissingLayers:!(128&~s),preserveTrueCurves:!(256&~s)}}}let N=class extends(n.JSONSupportMixin(o.IdentifiableMixin(d))){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.userTypeExtensions=[],this.layerInfos=null,this.tableInfos=null,this.capabilities=null}read(e,t){this.sourceJSON=e,super.read(e,t)}get utilityNetworkUrl(){if(this.sourceJSON)for(const e of this.sourceJSON.layers)if("Utility Network Layer"===e.type)return`${this.url}/${e.id}`;return null}get versionManagementServiceUrl(){return this.sourceJSON?.hasBranchVersionedData&&!_.isSecureProxyService(this.url)?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readLayerInfos(e,t){return(t.layers||[]).map((e=>{const{type:t,geometryType:s}=e;return{...j(this.url,e),type:t||"Feature Layer",geometryType:s}}))}readTableInfos(e,t){return(t.tables||[]).map((e=>j(this.url,e)))}readCapabilities(e,t){return function(e){return{data:P(e),sync:k(e),operations:V(e.capabilities,e),query:D(e),editing:G(e)}}(t)}get effectiveCapabilities(){const e=this.capabilities;if(!e)return null;const t=l.clone(e),{operations:s}=t;return this.userHasUpdateItemPrivileges?(s.supportsAdd=s.supportsDelete=s.supportsEditing=s.supportsQuery=s.supportsUpdate=!0,t):(this.userHasFullEditingPrivileges&&s.supportsEditing&&(s.supportsAdd=s.supportsDelete=s.supportsUpdate=!0),t)}load(e){return this.addResolvingPromise(this._fetchService(this.url,e).then((()=>this._setUserPrivileges(e)))),Promise.resolve(this)}async fetchAllLayersAndTables(e){return await this.load(e),this._fetchLayersAndTablesPromise||=this._fetchLayersAndTables(this.url),u.throwIfAborted(e),this._fetchLayersAndTablesPromise}async applyEdits(e,t){let s=null;try{const{results:r,edits:a,editedFeatures:i}=await this._internalApplyEdits(e,t),o=e=>e.filter((e=>!e.error)).map(l.clone);let n=0;return r.map((e=>{s=S.emitApplyEditsEvent(this.url,e.id,t?.gdbVersion,!0);const r={edits:a[n],addedFeatures:o(e.addFeatureResults),updatedFeatures:o(e.updateFeatureResults),deletedFeatures:o(e.deleteFeatureResults),addedAttachments:o(e.addAttachmentResults),updatedAttachments:o(e.updateAttachmentResults),deletedAttachments:o(e.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:e.editMoment?new Date(e.editMoment):null};n+=1,i.length>0&&(r.editedFeatures=i),s.resolve(r),s=null})),r}catch(e){throw s&&s.reject(e),e}}async querySharedTemplates(e){const t={...e?.query};return null==t.layers&&null==t.templateIds&&(t.layers=this.layerInfos.map((e=>e.id))),(await U.querySharedTemplates({serviceUrl:this.url,query:t,requestOptions:e?.requestOptions})).map((e=>{const t=b.fromJSON(e);return t.featureService=this,t}))}async _setUserPrivileges(e){if(t.userPrivilegesApplied)try{const{features:{fullEdit:t},content:{updateItem:s}}=await this._fetchUserPrivileges(this.sourceJSON.serviceItemId,e);this._set("userHasFullEditingPrivileges",t),this._set("userHasUpdateItemPrivileges",s)}catch(e){u.throwIfAbortError(e)}}async _fetchUserPrivileges(e,t){const r=!0,a=!1,i=!1;if(!e)return{features:{edit:r,fullEdit:a},content:{updateItem:i}};let o,n,l;try{o=await O.getOwningPortalUrl(this.url,t)}catch(e){u.throwIfAbortError(e)}try{const e=null!=t?t.signal:null;n=await(s.id?.getCredential(`${o}/sharing`,{prompt:!1,signal:e}))}catch(e){u.throwIfAbortError(e)}if(!n)return{features:{edit:r,fullEdit:a},content:{updateItem:i}};try{if(l=new A({id:e,portal:{url:o}}),await l.load(t),l.portal.user)return w.getUserPrivileges(l)}catch(e){u.throwIfAbortError(e)}return{features:{edit:r,fullEdit:a},content:{updateItem:i}}}async _internalApplyEdits(e,t){await E.ensureCredentialIfSignedIn(this.url);const s=t?.globalIdUsed??!1,i=f.fromJSON(this.sourceJSON.spatialReference),{edits:o,options:n}=await this._processApplyEditsParams(e,t),l=await Promise.all(o.map((async e=>{const t=e.addFeatures?.map((e=>g.getFeatureJSON({spatialReference:i},e,null)))??[],r=(await Promise.all(t)).filter(a.isSome),o=r.length>0?r:null,n=e.updateFeatures?.map((e=>g.getFeatureJSON({spatialReference:i},e,null)))??[],l=(await Promise.all(n)).filter(a.isSome),d=l.length>0?l:null,u=g.getFeatureIds(e.identifierFields,e.deleteFeatures,s),p=u.length>0?u:null;R.unapplyEditsZUnitScaling(o,d,i);const c=await g.getAttachmentEditsJSON(e.identifierFields,e);let y=null;c&&(y={adds:c.adds.length>0?c.adds:void 0,updates:c.updates.length>0?c.updates:void 0,deletes:c.deletes.length>0?c.deletes:void 0});const h={};return e.deleteAssociations&&(h.deleteAssociations=e.deleteAssociations),e.combineGroupedObjects&&(h.combineGroupedObjects=e.combineGroupedObjects),e.divideGroupedObjects&&(h.divideGroupedObjects=e.divideGroupedObjects),{id:e.id,adds:o,updates:d,deletes:p,attachments:y,...h}}))),d={gdbVersion:n?.gdbVersion,rollbackOnFailure:!0,useGlobalIds:s,returnEditMoment:!0,honorSequenceOfEdits:n?.honorSequenceOfEdits,usePreviousEditMoment:n?.usePreviousEditMoment,returnServiceEditsInSourceSR:!1,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};await C.isSafeToEditVersion(this.url,t?.gdbVersion,!0);const u=C.isVersionInEditSession(this.url,t?.gdbVersion||null);d.edits=JSON.stringify(l);const p=F.parseUrl(this.url),c=F.asValidOptions(p.query,{query:F.encode({...d,f:"json"}),method:"post"});let y;u&&(c.authMode="immediate",c.query.sessionId=C.currentSessionId);try{y=await r(this.url+"/applyEdits",c)}catch(e){if(!g.isProtectedOrPrivateVersionError(e))throw e;c.authMode="immediate",y=await r(this.url+"/applyEdits",c)}return{...M(y),edits:o}}async _processApplyEditsParams(e,t){const s={...t,usingFeatureServiceEndpoint:!0,usingTelecomOperations:e.some((e=>e.deleteAssociations||e.combineGroupedObjects||e.divideGroupedObjects))};return{edits:await Promise.all(e.map((async e=>{const t=this.effectiveCapabilities,r=e&&(e.addFeatures||e.updateFeatures||e.deleteFeatures),a=e&&(e.addAttachments||e.updateAttachments||e.deleteAttachments);if(v.checkEditingCapabilities(e,t,s,!!r,!!a,"feature-service"),!t.data.isDataVersioned&&s?.gdbVersion)throw new i("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isDataVersioned'");const o=v.normalizeEdits(e,t,"feature-service"),n={};e.deleteAssociations&&(n.deleteAssociations=e.deleteAssociations),e.combineGroupedObjects&&(n.combineGroupedObjects=e.combineGroupedObjects),e.divideGroupedObjects&&(n.divideGroupedObjects=e.divideGroupedObjects);const l=await v.normalizeGeometries(o);return{id:e.id,...l,...n,identifierFields:e.identifierFields}}))),options:s}}async _fetchService(e,t){if(this.sourceJSON)return void this.read(this.sourceJSON,{url:F.parseUrl(e)});const s=await r(e,{responseType:"json",query:{f:"json"},...t});this.read(s.data,{url:F.parseUrl(e)})}async _fetchLayersAndTables(e){const t=`${e}/layers`,s=await r(t,{responseType:"json",query:{f:"json"}});return{layers:s.data.layers.map((e=>{const{type:t,geometryType:s}=e,r=j(this.url,e),a=I.getFeatureLayerCapabilities(e,r.url);return{...r,type:t||"Feature Layer",geometryType:s,capabilities:a}})),tables:s.data.tables.map((e=>{const t=j(this.url,e),s=I.getFeatureLayerCapabilities(e,t.url);return{...t,capabilities:s}}))}}};function M(e){const t=e.data,s=[];return{results:t.map((e=>{const t={addResults:e.addResults??[],updateResults:e.updateResults??[],deleteResults:e.deleteResults??[],attachments:e.attachments,editMoment:e.editMoment},r=g.unpackEditResultData(t),a=e.editedFeatures,i=a?.spatialReference?new f({wkid:a?.spatialReference.wkid,wkt:a?.spatialReference.wkt,latestWkid:a?.spatialReference.latestWkid,latestVcsWkid:a?.spatialReference.latestVcsWkid,vcsWkid:a?.spatialReference.vcsWkid}):null,o=a?g.createEditedFeatures(a,i):null;o&&s.push({layerId:e.id,editedFeatures:o});const n={};return e.divideGroupedObjectResults&&(n.divideGroupedObjectResults=e.divideGroupedObjectResults),e.combineGroupedObjectResults&&(n.combineGroupedObjectResults=e.combineGroupedObjectResults),{id:e.id,editedFeatures:o,...r,...n}})),editedFeatures:s}}return e.__decorate([p.property()],N.prototype,"url",void 0),e.__decorate([p.property()],N.prototype,"sourceJSON",void 0),e.__decorate([p.property()],N.prototype,"userHasFullEditingPrivileges",void 0),e.__decorate([p.property()],N.prototype,"userHasUpdateItemPrivileges",void 0),e.__decorate([p.property({readOnly:!0})],N.prototype,"utilityNetworkUrl",null),e.__decorate([p.property({readOnly:!0})],N.prototype,"versionManagementServiceUrl",null),e.__decorate([p.property()],N.prototype,"userTypeExtensions",void 0),e.__decorate([p.property({json:{read:{source:["layers"]}}})],N.prototype,"layerInfos",void 0),e.__decorate([h.reader("layerInfos",["layers"])],N.prototype,"readLayerInfos",null),e.__decorate([p.property({json:{read:{source:["tables"]}}})],N.prototype,"tableInfos",void 0),e.__decorate([h.reader("tableInfos",["tables"])],N.prototype,"readTableInfos",null),e.__decorate([p.property({readOnly:!0,json:{read:{source:["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],N.prototype,"capabilities",void 0),e.__decorate([h.reader("capabilities",["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"])],N.prototype,"readCapabilities",null),e.__decorate([p.property({readOnly:!0})],N.prototype,"effectiveCapabilities",null),N=e.__decorate([m.subclass("esri.rest.featureService.FeatureService")],N),N}));