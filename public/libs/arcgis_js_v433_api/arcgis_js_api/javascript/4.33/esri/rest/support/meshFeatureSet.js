// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../Graphic","../../core/Logger","../../core/MapUtils","../../geometry/Extent","../../geometry/Mesh","../../geometry/SpatialReference","../../geometry/support/meshUtils/External","../../layers/support/infoFor3D","./FeatureSet","./meshFeatureAttributes"],(function(e,t,r,s,n,a,o,u,i,c,l){"use strict";function f(e,t,r,s,o){const i=e.attributes[t],c=o.get(i);if(null==c||!e.geometry)return null;const f=l.extractMeshFeatureOrigin(e.attributes,r,s.transformFieldRoles),m=n.fromJSON(e.geometry);m.spatialReference=r;const g=l.extractMeshFeatureTransform(e.attributes,s.transformFieldRoles),y=r.isGeographic?"local":"georeferenced",h=function(e){const t=Array.from(e.files.values()),r=new Array;for(const e of t){if(e.status!==p.COMPLETED)return null;const t=new Array;for(const r of e.parts){if(!r)return null;t.push(new u.ServiceAssetPart(r.url,r.hash))}r.push(new u.ServiceAsset(e.name,e.mimeType,t))}return{type:"service",assets:r}}(c);return h?a.createWithExternalSource(f,h,{extent:m,transform:g,vertexSpace:y,unitConversionDisabled:!0}):a.createIncomplete(f,{extent:m,transform:g,vertexSpace:y})}var p;function m(e,t){const n=new Map;for(const a of t){const t=a.parentGlobalId;if(null==t)continue;const o=a.assetName,u=a.assetType,c=a.assetHash,l=a.assetURL,f=a.conversionStatus,p=a.seqNo,m=i.getFormatIdMimeType(u,e.supportedFormats);if(!m){r.getLogger("esri.rest.support.meshFeatureSet").error("mesh-feature-set:unknown-format",`Service returned an asset of type ${u}, but it does not list it as a supported type`);continue}const y=s.getOrCreateMapValue(n,t,(()=>({files:new Map})));s.getOrCreateMapValue(y.files,o,(()=>({name:o,type:u,mimeType:m,status:g(f),parts:[]}))).parts[p]={hash:c,url:l}}return n}function g(e){switch(e){case"COMPLETED":case"SUBMITTED":return p.COMPLETED;case"INPROGRESS":return p.PENDING;default:return p.FAILED}}!function(e){e[e.FAILED=0]="FAILED",e[e.PENDING=1]="PENDING",e[e.COMPLETED=2]="COMPLETED"}(p||(p={})),e.assetMapFromAssetMapsJSON=m,e.extractMesh=f,e.meshFeatureSetFromJSON=function(e,r,s){const n=s.features;s.features=[],delete s.geometryType;const a=c.fromJSON(s);if(a.geometryType="mesh",!s.assetMaps)return a;const u=m(r,s.assetMaps),i=e.sourceSpatialReference??o.WGS84,l=s.globalIdFieldName,{outFields:p}=e,g=null!=p&&p.length>0?(y=p.includes("*")?null:new Set(p),({attributes:e})=>{if(!e)return{};if(!y)return e;for(const t in e)y.has(t)||delete e[t];return e}):()=>({});var y;for(const e of n){const s=f(e,l,i,r,u);a.features.push(new t({geometry:s,attributes:g(e)}))}return a},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));