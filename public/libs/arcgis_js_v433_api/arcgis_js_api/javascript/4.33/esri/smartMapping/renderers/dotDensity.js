// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../core/colorUtils","../../core/Error","../../geometry/support/scaleUtils","../../renderers/DotDensityRenderer","../../renderers/support/AuthoringInfo","../heuristics/outline","./support/dotDensityUtils","./support/regenerateUtils","./support/utils","../statistics/spatialStatistics","../statistics/summaryStatisticsForAttributes","../statistics/support/attributeDensity","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/dotDensity"],(function(e,t,a,r,i,n,l,s,o,u,d,p,c,y,m,f,g){"use strict";async function b(e){const t=e.view;if(!(e?.layer&&t&&e.attributes?.length))throw new a("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new a("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");e.forBinning&&y.verifyBinningParams(e,"dot-density-renderer");const r={...e,view:t,layer:e.layer,attributes:e.attributes},i=[f.LayerType.FeatureLayer,f.LayerType.ParquetLayer,f.LayerType.KnowledgeGraphSublayer,f.LayerType.OGCFeatureLayer,f.LayerType.GeoJSONLayer,f.LayerType.WFSLayer],n=e.forBinning?f.binningCapableLayerTypes:i,l=f.createLayerAdapter(r.layer,n,e.forBinning);if(!l)throw new a("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(n).join(", "));r.dotBlendingEnabled??=!0,r.dotValueOptimizationEnabled??=!0;const s=null!=r.signal?{signal:r.signal}:null;if(await Promise.all([t.when(),l.load(s)]),"polygon"!==l.geometryType)throw new a("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");const o=[],d=r.attributes;for(const e of d){const t=await m.getFieldsList({field:e.field,valueExpression:e.valueExpression});o.push(...t)}const p=u.verifyBasicFieldValidity(l,o.filter(Boolean),"dot-density-renderer:invalid-parameters");if(p)throw p;return{...r,layer:l}}function w(e){return{dotValue:1,referenceScale:e.scale,minSliderValue:1,maxSliderValue:100}}async function v(e){const{view:t,layer:a,attributes:i,signal:n,filter:l}=e,o=await a.getSampleFeatures({view:t,sampleSize:500,returnGeometry:!0,filter:l,signal:n},"json"),[u,c]=await Promise.all([d({features:o,geometryType:a.geometryType}),p({layer:a,attributes:i,filter:l,includeZeros:!1,includeNegatives:!1,view:t,signal:n})]),y=null!=u&&"avgSize"in u&&u.avgSize,m=c.avg;if(!y||!m)return w(t);const f=r.getResolutionForScale(t.scale,t.spatialReference),g=y*y/(f*f)*.1;return{dotValue:s.roundValue(m/g)||1,referenceScale:t.scale,minSliderValue:1,maxSliderValue:s.roundValue(m)}}async function h(e){const{view:t,layer:a,attributes:i,signal:n,filter:l}=e,o=[];for(const e of i){const t=await m.getFieldsList({field:e.field,valueExpression:e.valueExpression});o.push(...t)}const u=await a.getSampleFeatures({view:t,sampleSize:500,requiredFields:o,filter:l,returnGeometry:!0,signal:n},"json"),{minDensity:d,maxDensity:p,avgDensity:y}=await c({features:u,attributes:i,includeZeros:!1,includeNegatives:!1,view:t});if(!y||!d||!p)return w(t);const f=r.getResolutionForScale(t.scale,t.spatialReference),g=f*f,b=s.roundValue(d*g),v=s.roundValue(p*g);let h=s.roundValue(y*g*10)||1;return h>v&&(h=v),{dotValue:h,referenceScale:t.scale,minSliderValue:b,maxSliderValue:v}}e.createRenderer=async function(e){const r=await b(e),s=r.layer,o=s.geometryType,d=await async function(e){let t=e.dotDensityScheme,a=null,r=null;const i=await u.getBasemapInfo(e.basemap,e.view);if(a=null!=i.basemapId?i.basemapId:null,r=null!=i.basemapTheme?i.basemapTheme:null,t)return{scheme:g.cloneScheme(t),basemapId:a,basemapTheme:r};const n=g.getSchemes({numColors:e.attributes.length,basemapTheme:r});return n&&(t=n.primaryScheme,a=n.basemapId,r=n.basemapTheme),{scheme:t,basemapId:a,basemapTheme:r}}(r),p=d?.scheme;if(!p)throw new a("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");const c=r.view,y=r.filter,m={layer:s,view:c,filter:y,attributes:r.attributes,signal:r.signal},f={layer:r.layer,view:c,filter:y,signal:r.signal},[w,S]=await Promise.all([r.trueDensity?h(m):v(m),r.outlineOptimizationEnabled?l(f).catch(u.errorCallback):null]),{dotValue:V,referenceScale:T,minSliderValue:E,maxSliderValue:x}=w,L=t.createUniqueColors(p.colors,r.attributes.length),O=r.attributes.map(((e,t)=>({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:L[t]}))),D=new i({attributes:O,dotBlendingEnabled:r.dotBlendingEnabled,outline:S?u.getSymbolOutlineFromScheme(p,o,S.opacity):null,dotValue:V,referenceScale:r.dotValueOptimizationEnabled?T:null,legendOptions:r.legendOptions});return S?.visualVariables.length&&(D.visualVariables=S.visualVariables.map((e=>e.clone()))),D.authoringInfo=new n({type:"dot-density",minSliderValue:E,maxSliderValue:x}),{renderer:D,dotDensityScheme:p,basemapId:d.basemapId,basemapTheme:d.basemapTheme}},e.regenerateRenderer=async function(e){const{creatorParameters:t,renderer:r}=await async function(e){const t="regenerate-dot-density-renderer";await o.processRegenerateParams(e,t);const r=await o.getRendererToUpdate(e);if("dot-density"!==o.getStyleType(r))throw new a(`${t}:invalid-parameters`,"Renderer is invalid");const{layer:i,forBinning:n,filter:l,view:s,signal:u}=e,d=o.hasOutlineVV(r),p=r.attributes.map((e=>({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle}))),c=await b({layer:i,attributes:p,dotValueOptimizationEnabled:null!=r.referenceScale,outlineOptimizationEnabled:d,forBinning:n,filter:l,view:s,signal:u});return{...e,creatorParameters:c,renderer:r}}(e),{layer:i,attributes:n,outlineOptimizationEnabled:s,view:d,signal:p,filter:c}=t,y={layer:i,view:d,filter:c,attributes:n,signal:p},[m,f]=await Promise.all([t.trueDensity?h(y):v(y),s?l({layer:i,view:d,signal:p,filter:c}).catch(u.errorCallback):null]),{dotValue:g,referenceScale:w,minSliderValue:S,maxSliderValue:V}=m;return r.dotValue=g,r.referenceScale=t.dotValueOptimizationEnabled?w:null,r.authoringInfo&&(r.authoringInfo.minSliderValue=S,r.authoringInfo.maxSliderValue=V),o.spliceVisualVariables(r,f?.visualVariables,o.findOutlineVVIndex),{renderer:r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));