// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../Color","../../core/arrayUtils","../../core/colorUtils","../../core/Error","../../core/screenUtils","../../intl/messages","../../layers/support/AggregateField","../../layers/support/ExpressionInfo","../../renderers/PieChartRenderer","../../renderers/support/AttributeColorInfo","../../renderers/support/OthersCategory","../../renderers/support/RendererLegendOptions","../heuristics/outline","../heuristics/sizeRange","./size","./support/regenerateUtils","./support/utils","../statistics/predominantCategories","../statistics/support/utils","../support/binningUtils","../support/utils","../support/adapters/support/layerUtils","../symbology/pieChart","../../symbols/SimpleLineSymbol","../../symbols/support/cimSymbolUtils"],(function(e,r,a,i,n,t,l,s,o,u,p,c,d,m,f,y,b,h,g,w,v,S,z,V,E,T){"use strict";const C=[z.LayerType.CSVLayer,z.LayerType.FeatureLayer,z.LayerType.GeoJSONLayer,z.LayerType.KnowledgeGraphSublayer,z.LayerType.OGCFeatureLayer,z.LayerType.OrientedImageryLayer,z.LayerType.ParquetLayer,z.LayerType.StreamLayer,z.LayerType.WFSLayer];async function x(e){if(!(e?.layer&&e.view&&e.attributes?.length))throw new n("pie-chart-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>10)throw new n("pie-chart-renderer:invalid-parameters","PieChart renderer does not support more than 10 attributes");e.forBinning&&v.verifyBinningParams(e,"pie-chart-renderer");const r={...e,layer:e.layer,view:e.view,attributes:e.attributes};r.shape=r.shape||"pie",r.othersCategoryEnabled??=!0,r.includeSizeVariable=e.includeSizeVariable||!1;const a=e.forBinning?z.binningCapableLayerTypes:C,i=z.createLayerAdapter(r.layer,a,e.forBinning);if(!i)throw new n("pie-chart-renderer:invalid-parameters","'layer' must be one of these types: "+z.getLayerTypeLabels(a).join(", "));const t=null!=r.signal?{signal:r.signal}:null;await Promise.all([e.view.when(),i.load(t)]);const l=i.geometryType,s="polygon"===l,o="point"===l||"multipoint"===l||s;if(r.outlineOptimizationEnabled=!!s&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=!!o&&r.sizeOptimizationEnabled,!o)throw new n("pie-chart-renderer:not-supported","PieChart renderer is only supported for point and polygon layers");const u=[],p=r.attributes;for(const e of p){const r=await S.getFieldsList({field:e.field,valueExpression:e.valueExpression});u.push(...r)}const c=h.verifyBasicFieldValidity(i,u.filter(Boolean),"pie-chart-renderer:invalid-parameters");if(c)throw c;return{...r,layer:i}}async function L(e){let r=e.pieChartScheme,a=null,i=null;const n=await h.getBasemapInfo(e.basemap,e.view);if(a=null!=n.basemapId?n.basemapId:null,i=null!=n.basemapTheme?n.basemapTheme:null,r)return{scheme:V.cloneScheme(r),basemapId:a,basemapTheme:i};const t=V.getSchemes({numColors:e.attributes.length,geometryType:e.layer.geometryType,basemapTheme:i});return t&&(r=t.primaryScheme,a=t.basemapId,i=t.basemapTheme),{scheme:r,basemapId:a,basemapTheme:i}}async function O(e,r){const{valueExpression:a,sqlExpression:i,sqlWhere:n}=w.getSumOfAttributesExpr(e.attributes),t=await l.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");return y.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:a,sqlExpression:i,sqlWhere:n,sizeScheme:r,sizeOptimizationEnabled:e.sizeOptimizationEnabled,legendOptions:{title:t.sumOfCategories},filter:e.filter,view:e.view,signal:e.signal})}function I(e,r,a){r||e.visualVariables.forEach((e=>{"number"==typeof e.minSize&&"number"==typeof e.maxSize&&(e.minSize*=2.5,e.maxSize*=1.8)})),r&&"point"===a&&e.visualVariables.forEach((e=>{e?.minSize&&"object"==typeof e.minSize&&e.minSize?.stops?.forEach((e=>{e.size*=1.8}))}))}function $(e,r){"point"===r&&e.minSize.stops?.forEach((e=>{e.size*=2.5})),"polygon"===r&&e.minSize.stops?.forEach((e=>{e.size*=1.8}))}const k=new Set(["unique-value","class-breaks"]),q=new r("#aaaaaa"),B=new r("#5c5c5c"),P=[new r("#e60049"),new r("#0bb4ff"),new r("#50e991"),new r("#e6d800"),new r("#9b19f5"),new r("#ffa300"),new r("#dc0ab4"),new r("#b3d4ff"),new r("#00bfa0"),new r("#f0cccc")];function F(e){return"SUM_"+(e+"").replaceAll(/[^a-zA-Z0-9_]/g,"_")}function U(e,r){if("simple-marker"===e?.type&&e.color)return e.color.clone();if("cim"===e?.type){const r=T.getCIMSymbolColor(e);if(r)return r.clone()}return r?r.clone():q.clone()}function R(e,r){return`Number(Text($feature["${e}"]) == "${r.value+""}")`}function M(e,r){return`Number(!(${r.map((r=>`(Text($feature["${e}"]) == "${r.value+""}")`)).join(" || ")}))`}function A(e,r){return`Number($feature["${e}"] >= ${r.minValue} && $feature["${e}"] < ${r.maxValue})`}function j(e,r){return`Number(!(${r.map((r=>`($feature["${e}"] >= ${r.minValue} && $feature["${e}"] < ${r.maxValue})`)).join(" || ")}))`}e.createRenderer=async function(e){const[r,s]=await Promise.all([x(e),l.fetchMessageBundle("esri/smartMapping/t9n/smartMapping")]),o=await L(r),y=o?.scheme;if(!y)throw new n("pie-chart-renderer:insufficient-info","Unable to find pie-chart scheme");const{layer:b,includeSizeVariable:w,sizeOptimizationEnabled:v,outlineOptimizationEnabled:S,view:z,signal:T,filter:C}=r,k=y.sizeScheme,q=r.attributes,B=q.map((e=>e.field)).filter(a.isSome),[P,F,U,R]=await Promise.all([B.length>1?g({layer:b,fields:B,view:z,signal:T,filter:C}):null,w?O(r,k):null,!w&&v?f({layer:b,view:z,signal:T,filter:C}).catch(h.errorCallback):null,S?m({layer:b,view:z,signal:T,filter:C}).catch(h.errorCallback):null]),M=P?.predominantCategoryInfos?{uniqueValueInfos:P.predominantCategoryInfos}:{uniqueValueInfos:B.map((e=>({value:e,count:0})))},A=i.createUniqueColors(y.colors,q.length),j=q.map(((e,r)=>new p({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:A[r]}))),N=b.geometryType,_=null!=k&&"background"in k&&k.background,G=new u({attributes:j,othersCategory:new c.OthersCategory({label:s.other,color:r.othersCategoryEnabled?y.colorForOthersCategory:null,threshold:.04}),holePercentage:"donut"===r.shape?.45:0,backgroundFillSymbol:_?h.createSymbol(N,{type:"2d",color:_.color,outline:h.getSymbolOutlineFromScheme(_,N,R?.opacity)}):null,size:t.toPt(y.size),outline:new E(h.getSymbolOutlineFromScheme(y,"point",R?.opacity)),legendOptions:d.from(r.legendOptions)});if(F&&(I(F,v,N),G.authoringInfo=F.authoringInfo.clone(),G.visualVariables=F.visualVariables?.map((e=>e.clone()))),R?.visualVariables?.length){const e=R.visualVariables.map((e=>e.clone())).filter((e=>"color"!==e.type&&"rotation"!==e.type));G.visualVariables?G.visualVariables.push(...e):G.visualVariables=e}return U?.minSize&&($(U,N),G.visualVariables?G.visualVariables.push(U.minSize):G.visualVariables=[U.minSize]),{renderer:G,pieChartScheme:V.cloneScheme(y),size:F,basemapId:o.basemapId,basemapTheme:o.basemapTheme,statistics:M}},e.createRendererForClustering=async function(e){const r=await async function(e){if(!e||!e.layer)throw new n("pie-chart-cluster-renderer:missing-parameters","'layer' parameter is required");const r={...e};r.shape=r.shape||"pie",r.defaultSymbolEnabled??=!0;const a=e.layer;if(!z.getLayerTypes(C).includes(a.type))throw new n("pie-chart-cluster-renderer:invalid-parameters","'layer' must be one of these types: "+z.getLayerTypeLabels(C).join(", "));const i=null!=r.signal?{signal:r.signal}:null;if(await a.load(i),"point"!==a.geometryType)throw new n("pie-chart-cluster-renderer:invalid-parameters","Cluster renderers are only supported for point layers");const t="renderer"in a?a.renderer:void 0;if(!t)throw new n("pie-chart-cluster-renderer:invalid-parameters","input layer does not have a renderer.");if(!k.has(t.type))throw new n("pie-chart-cluster-renderer:invalid-parameters",`Cannot create a pie chart renderer for clusters based on a ${t.type} renderer.`);if("valueExpression"in t&&t.valueExpression)throw new n("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer whose renderer contains a valueExpression.");if("unique-value"===t.type){if(t.field2)throw new n("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a UniqueValueRenderer using more than one field.");if(null!=t.uniqueValueInfos&&t.uniqueValueInfos.length>10)throw new n("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer cannot be created from a UniqueValueRenderer with more than 10 unique value infos.")}if("class-breaks"===t.type){if(t.classBreakInfos.length<2)throw new n("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer renderer with a continuous color or size gradient.");if(t.classBreakInfos.length>10)throw new n("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with more than 10 class break infos.");if("class-breaks-size"===t?.authoringInfo?.type)throw new n("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with breaks varied by size instead of color.")}return r}(e),{layer:a,shape:t,defaultSymbolEnabled:c,legendOptions:m}=r,f="renderer"in a?a.renderer:void 0,y=(await l.fetchMessageBundle("esri/smartMapping/t9n/smartMapping")).other;let b=[];"unique-value"===f?.type&&(b=function(e){const{renderer:r,defaultSymbolEnabled:a,defaultLabelBackup:n}=e,{field:t,defaultSymbol:l,defaultLabel:u}=r,p=r.uniqueValueInfos??[],c=l&&a,d=c?9:10,m=i.createUniqueColors(P,d),f=(t?p.slice(0,d).map(((e,r)=>{const a=e.label,i=m[r];return{field:new s({name:F(e.value?.toString()),alias:a,onStatisticExpression:new o({title:`Field definition - ${a}`,expression:R(t,e),returnType:"number"}),statisticType:"sum"}),color:U(e.symbol,i)}})):null)??[];if(c){const e="cluster_default",r=u||n;f.push({field:new s({name:F(e),alias:r,onStatisticExpression:new o({title:`Field definition - ${r}`,expression:M(t,p),returnType:"number"}),statisticType:"sum"}),color:U(l,B)})}return f}({renderer:f,defaultSymbolEnabled:c,defaultLabelBackup:y})),"class-breaks"===f?.type&&(b=function(e){const{renderer:r,defaultSymbolEnabled:a,defaultLabelBackup:n}=e,{field:t,classBreakInfos:l,defaultSymbol:u,defaultLabel:p}=r,c=u&&a,d=c?9:10,m=i.createUniqueColors(P,d),f=l.slice(0,d).map(((e,r)=>{const a=e.label||`${e.minValue} - ${e.maxValue}`,i=m[r];return{field:new s({name:F(a),alias:a,onStatisticExpression:new o({title:`Field definition - ${a}`,expression:A(t,e),returnType:"number"}),statisticType:"sum"}),color:U(e.symbol,i)}}));if(c){const e="cluster_default",r=p||n;f.push({field:new s({name:F(e),alias:r,onStatisticExpression:new o({title:`Field definition - ${r}`,expression:j(t,l),returnType:"number"}),statisticType:"sum"}),color:U(u,B)})}return f}({renderer:f,defaultSymbolEnabled:c,defaultLabelBackup:y}));const h=[],g=[];for(const e of b){const{field:r,color:a}=e;h.push(r),g.push(new p({color:a,field:r.name,label:r.alias}))}return{fields:h,renderer:new u({attributes:g,legendOptions:d.from(m),holePercentage:"donut"===t?.45:0,outline:null,size:9,othersCategory:null})}},e.regenerateRenderer=async function(e){const{creatorParameters:r,view:a,signal:i,filter:t,renderer:l}=await async function(e){const r="regenerate-pie-chart-renderer",a=e.includedParts?.includes("size-variable")??!0;await b.processRegenerateParams(e,r);const i=await b.getRendererToUpdate(e);if("pie-chart"!==b.getStyleType(i))throw new n(`${r}:invalid-parameters`,"Renderer is invalid");const{visualVariables:t}=i,{layer:l,forBinning:s,filter:o,view:u,signal:p}=e,c=b.hasOutlineVV(i),d=b.hasScaleDependentSizeVV(i),m=a&&t?.some(b.isSizeVV),f=i.attributes.map((e=>({field:e.field,label:e.label,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle}))),y=await x({layer:l,attributes:f,outlineOptimizationEnabled:c,sizeOptimizationEnabled:d,includeSizeVariable:m,forBinning:s,filter:o,view:u,signal:p});return{...e,creatorParameters:y,renderer:i}}(e),{layer:s,outlineOptimizationEnabled:o,includeSizeVariable:u,sizeOptimizationEnabled:p}=r,c=await L(r),d=c?.scheme?.sizeScheme,[y,g,w]=await Promise.all([o?m({layer:s,view:a,signal:i,filter:t}).catch(h.errorCallback):null,u?O(r,d):null,!u&&p?f({layer:s,view:a,signal:i,filter:t}).catch(h.errorCallback):null]),v=s.geometryType;if(g&&(I(g,p,v),b.spliceVisualVariables(l,g?.visualVariables,b.findSizeVVIndex),b.updateAuthoringInfoVisualVariable(l,g?.authoringInfo,"size")),y?.visualVariables?.length){const e=y.visualVariables.map((e=>e.clone())).filter((e=>"color"!==e.type&&"rotation"!==e.type));b.spliceVisualVariables(l,e,b.findOutlineVVIndex)}return w?.minSize&&($(w,v),b.spliceVisualVariables(l,w?.minSize,b.findScaleDependentSizeVVIndex)),{renderer:l}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));