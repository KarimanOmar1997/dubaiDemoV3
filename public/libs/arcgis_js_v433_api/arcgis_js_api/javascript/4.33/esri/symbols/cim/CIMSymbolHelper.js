// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../core/BidiText","../../core/has","../../core/lang","../../core/Logger","../../core/RandomLCG","../../core/screenUtils","../../geometry/support/aaBoundingRect","../../geometry/support/boundsUtils","../Font","./CIMPlacements","./CIMSymbolDrawHelper","./defaultCIMValues","./enums","./utils","../support/defaults","../../views/2d/engine/vectorTiles/GeometryUtils","../../views/2d/engine/webgl/definitions","../../views/2d/engine/webgl/mesh/templates/shapingUtils","../../views/2d/layers/graphics/graphicsUtils"],(function(e,t,r,a,o,i,n,s,l,c,m,u,y,f,h,p,M,g,S,d){"use strict";const b=Math.PI,C=b/2,x=Math.PI/180,I=96/72,k=()=>o.getLogger("esri.symbols.cim.CIMSymbolHelper");function P(e,t,r){switch(t.type){case"CIMSymbolReference":return P(e,t.symbol,r);case"CIMPointSymbol":null==r&&(r={x:0,y:0}),e.drawSymbol(t,r);break;case"CIMLineSymbol":null==r&&(r={paths:[[[0,0],[10,0]]]}),e.drawSymbol(t,r);break;case"CIMPolygonSymbol":null==r&&(r={rings:[[[0,0],[0,10],[10,10],[10,0],[0,0]]]}),e.drawSymbol(t,r);break;case"CIMTextSymbol":{const r={x:0,y:0};e.drawSymbol(t,r);break}case"CIMVectorMarker":{const r=new m.Placement;e.drawMarker(t,r);break}}return e.envelope()}function w(e){if(!e)return 0;switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAtExtremities":case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementAtRatioPositions":case"CIMMarkerPlacementOnLine":case"CIMMarkerPlacementOnVertices":return Math.abs(e.offset);default:return 0}}function L(e){if(!e)return 0;switch(e.type){case"CIMGeometricEffectArrow":return Math.abs(.5*e.width);case"CIMGeometricEffectBuffer":return Math.abs(e.size);case"CIMGeometricEffectControlMeasureLine":return 500;case"CIMGeometricEffectExtension":case"CIMGeometricEffectRadial":return Math.abs(e.length);case"CIMGeometricEffectJog":return Math.abs(.5*e.length);case"CIMGeometricEffectMove":return Math.max(Math.abs(h.getNumericValue(e.offsetX)),Math.abs(h.getNumericValue(e.offsetY)));case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":return Math.abs(e.offset);case"CIMGeometricEffectRegularPolygon":return Math.abs(e.radius);case"CIMGeometricEffectRotate":case"CIMGeometricEffectScale":default:return 0;case"CIMGeometricEffectTaperedPolygon":return.5*Math.max(Math.abs(e.fromWidth),Math.abs(e.toWidth));case"CIMGeometricEffectWave":return Math.abs(e.amplitude);case"CIMGeometricEffectDonut":return Math.abs(e.width)}}function F(e){if(!e)return 0;let t=0;for(const r of e)t+=L(r);return t}class T{static getEnvelope(e,t,r){if(!e)return null;const a=new u.EnvDrawHelper(r);if(Array.isArray(e)){let r;for(const o of e)r?r.union(P(a,o,t)):r=P(a,o,t);return r}return P(a,e,t)}static getTextureInfo(e,t,r,a,o){const i=a??this.getEnvelope(e,null,t);if(!i)return[0,0,0,0,1];const n=Math.max(i.width,i.height)*I;let s=null!=o?Math.max(o/n,1):1;s*=I,i.x*=s,i.y*=s,i.width*=s,i.height*=s,i.width=Math.max(Math.ceil(i.x+i.width)-Math.floor(i.x),1)-1,i.height=Math.max(Math.ceil(i.y+i.height)-Math.floor(i.y),1)-1;let l=i.x+.5*i.width,c=i.y+.5*i.height;return l+=i.x-Math.floor(i.x),c+=i.y-Math.floor(i.y),a||(i.width+=r,i.height+=r,l+=r/2,c+=r/2),[i.width,i.height,l,c,s]}static getTextureAnchor(e,t,r){const[a,o,i,n,s]=this.getTextureInfo(e,t,2,null,r);return[-i/a,-n/o,o/s*I]}static rasterize(e,t,r,a,o=!0,i){const[n,s,l,c,y]=this.getTextureInfo(t,a,2,r,i);e.width=n,e.height=s;const f=e.getContext("2d",{willReadFrequently:!0}),h=u.Transformation.createScale(y,-y);h.translate(.5*n-l,.5*s+c);const p=new u.CanvasDrawHelper(f,a,h);switch(t.type){case"CIMPointSymbol":{const e={type:"point",x:0,y:0};p.drawSymbol(t,e);break}case"CIMVectorMarker":{const e=new m.Placement;p.drawMarker(t,e);break}}const M=f.getImageData(0,0,e.width,e.height),g=new Uint8Array(M.data);if(o){let e;for(let t=0;t<g.length;t+=4)e=g[t+3]/255,g[t]=g[t]*e,g[t+1]=g[t+1]*e,g[t+2]=g[t+2]*e}return[g,e.width,e.height,-l/n,-c/s]}static fromTextSymbol(e){const{text:t}=e;return{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,anchorPointUnits:"Relative",dominantSizeAxis3D:"Y",size:10,billboardMode3D:"FaceNearPlane",frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:T.createCIMTextSymbolfromTextSymbol(e),textString:t}],scaleSymbolsProportionally:!0,respectFrame:!0}],scaleX:1,angleAlignment:"Display"}}static fromPictureFillSymbol(e){const{height:t,outline:r,width:a,xoffset:o,xscale:i,yoffset:n,yscale:s}=e,l=[],c={type:"CIMPolygonSymbol",symbolLayers:l};if(r){const e=Y(r);e&&l.push(e)}let m=e.url;"esriPFS"===e.type&&e.imageData&&(m=e.imageData);const u="angle"in e?e.angle??0:0,y=(a??0)*(i||1),p=(t??0)*(s||1);return l.push({type:"CIMPictureFill",invertBackfaceTexture:!1,scaleX:1,textureFilter:f.TextureFilter.Picture,tintColor:null,url:m,height:p,width:y,offsetX:h.getNumericValue(o),offsetY:h.getNumericValue(n),rotation:h.getNumericValue(-u),colorSubstitutions:null}),c}static fromSimpleFillSymbol(e){const{color:t,style:r,outline:o}=e,i=[],s={type:"CIMPolygonSymbol",symbolLayers:i};if(o){const e=Y(o);e&&i.push(e)}if(r&&"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r){const e={type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",color:N(t),capStyle:f.LineCapStyle.Butt,joinStyle:f.LineJoinStyle.Miter,width:.75}]};let o=0;const s=n.px2pt(H(r)?8:10);switch(r){case"vertical":case"esriSFSVertical":o=90;break;case"forward-diagonal":case"esriSFSForwardDiagonal":case"diagonal-cross":case"esriSFSDiagonalCross":o=-45;break;case"backward-diagonal":case"esriSFSBackwardDiagonal":o=45;break;case"cross":case"esriSFSCross":o=0}i.push({type:"CIMHatchFill",lineSymbol:e,offsetX:0,offsetY:0,rotation:o,separation:s}),"cross"===r||"esriSFSCross"===r?i.push({type:"CIMHatchFill",lineSymbol:a.clone(e),offsetX:0,offsetY:0,rotation:90,separation:s}):"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r||i.push({type:"CIMHatchFill",lineSymbol:a.clone(e),offsetX:0,offsetY:0,rotation:45,separation:s})}else!r||"solid"!==r&&"esriSFSSolid"!==r||i.push({type:"CIMSolidFill",enable:!0,color:N(t)});return s}static fromSimpleLineSymbol(e){const{cap:t,color:r,join:a,marker:o,miterLimit:i,style:n,width:s}=e;let l=null;"solid"!==n&&"none"!==n&&"esriSLSSolid"!==n&&"esriSLSNull"!==n&&(l=[{type:"CIMGeometricEffectDashes",dashTemplate:B(n,t),lineDashEnding:"NoConstraint",scaleDash:!0,offsetAlongLine:null}]);const c=[];if(o){let e;switch(o.placement){case"begin-end":e=f.ExtremityPlacement.Both;break;case"begin":e=f.ExtremityPlacement.JustBegin;break;case"end":e=f.ExtremityPlacement.JustEnd;break;default:e=f.ExtremityPlacement.None}const t=T.fromSimpleMarker(o,s,r).symbolLayers[0];t.markerPlacement={type:"CIMMarkerPlacementAtExtremities",placePerPart:!1,angleToLine:!0,offset:0,extremityPlacement:e,offsetAlongLine:0},c.push(t)}return c.push({type:"CIMSolidStroke",color:"none"!==n&&"esriSLSNull"!==n?N(r):[0,0,0,0],capStyle:D(t),joinStyle:z(a),miterLimit:i,width:s,effects:l}),{type:"CIMLineSymbol",symbolLayers:c}}static fromPictureMarker(e){const{angle:t,height:r,width:a,xoffset:o,yoffset:i}=e;let n=e.url;return"esriPMS"===e.type&&e.imageData&&(n=e.imageData),{type:"CIMPointSymbol",symbolLayers:[{type:"CIMPictureMarker",invertBackfaceTexture:!1,scaleX:1,textureFilter:f.TextureFilter.Picture,tintColor:null,url:n,size:r,width:a,offsetX:h.getNumericValue(o),offsetY:h.getNumericValue(i),rotation:h.getNumericValue(-t)}]}}static createCIMTextSymbolfromTextSymbol(e){const{angle:r,color:a,font:o,haloColor:i,haloSize:n,horizontalAlignment:s,kerning:l,lineWidth:c,text:m,verticalAlignment:u,xoffset:y,yoffset:p,backgroundColor:M,borderLineColor:g,borderLineSize:S}=e;let d,b,C,x,I,k;o&&(d=o.family,b=o.style,C=o.weight,x=o.size,I=o.decoration);let P=!1;return m&&(P=t.bidiText(m)[1]),(M||S)&&(k={type:"CIMBackgroundCallout",margin:null,backgroundSymbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",color:N(M)},{type:"CIMSolidStroke",color:N(g),width:S}]},accentBarSymbol:null,gap:null,leaderLineSymbol:null,lineStyle:null}),{type:"CIMTextSymbol",angle:r,blockProgression:f.BlockProgression.BTT,depth3D:1,extrapolateBaselines:!0,fontEffects:f.FontEffects.Normal,fontEncoding:f.FontEncoding.Unicode,fontFamilyName:d||"Arial",fontStyleName:v(b,C),fontType:f.FontType.Unspecified,haloSize:n,height:x,hinting:f.GlyphHinting.Default,horizontalAlignment:G(s??"center"),kerning:l,letterWidth:100,ligatures:!0,lineGapType:"Multiple",lineWidth:c,offsetX:h.getNumericValue(y),offsetY:h.getNumericValue(p),strikethrough:"line-through"===I,underline:"underline"===I,symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:N(a)}]},haloSymbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:N(i)}]},shadowColor:[0,0,0,255],shadowOffsetX:1,shadowOffsetY:1,textCase:"Normal",textDirection:P?f.TextReadingDirection.RTL:f.TextReadingDirection.LTR,verticalAlignment:V(u??"baseline"),verticalGlyphOrientation:f.VerticalGlyphOrientation.Right,wordSpacing:100,billboardMode3D:f.BillBoardMode.FaceNearPlane,callout:k}}static createPictureMarkerRasterizationParam(e){const{angle:t,height:r,width:a,xoffset:o,yoffset:i}=e,n=e.url??e.source?.url??e.source?.imageData;return n?{type:"sprite-rasterization-param",overrides:[],resource:{type:"CIMPictureMarker",invertBackfaceTexture:!1,scaleX:1,textureFilter:f.TextureFilter.Picture,tintColor:null,url:n,size:r,width:a,offsetX:h.getNumericValue(o),offsetY:h.getNumericValue(i),rotation:h.getNumericValue(-t)}}:null}static createPictureFillRasterizationParam(e){const{width:t,height:r,xoffset:a,yoffset:o,url:i}=e;return i?{type:"sprite-rasterization-param",overrides:[],resource:{type:"CIMPictureFill",scaleX:1,textureFilter:f.TextureFilter.Picture,tintColor:null,url:i,width:t,height:r,offsetX:h.getNumericValue(a),offsetY:h.getNumericValue(o),rotation:0}}:null}static fromSimpleMarker(e,t,r){const{style:a}=e,o=e.color??r;if("path"===a||"esriSMSPath"===a){const t=[];if("outline"in e&&e.outline){const r=e.outline;t.push({type:"CIMSolidStroke",enable:!0,width:r.width,color:N(r.color),path:e.path})}t.push({type:"CIMSolidFill",enable:!0,color:N(o),path:e.path});const[r,a]=X("square");return{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:-h.getNumericValue(e.angle),size:h.getNumericValue(e.size||6),offsetX:h.getNumericValue(e.xoffset),offsetY:h.getNumericValue(e.yoffset),scaleSymbolsProportionally:!1,frame:r,markerGraphics:[{type:"CIMMarkerGraphic",geometry:a,symbol:{type:"CIMPolygonSymbol",symbolLayers:t}}]}]}}const i=[];let n,s,l=e.size;if("outline"in e&&e.outline&&"none"!==e.outline.style&&"esriSLSNull"!==e.outline.style){const t=e.outline,r="solid"!==t.style&&"esriSLSSolid"!==t.style;[n,s]=r?X(a,e.size):X(a);const o=t.width??p.defaultPolylineSymbol2D.width;if(r){const t=o/e.size,r=(n.xmax-n.xmin)*t/2,a=(n.ymax-n.ymin)*t/2;n.xmin-=r,n.xmax+=r,n.ymin-=a,n.ymax+=a,l&&(l+=o)}const c="cross"!==e.style&&"x"!==e.style||"dot"===e?.outline.style||"short-dot"===e?.outline.style?f.LineDashEnding.HalfGap:f.LineDashEnding.FullPattern,m=r?[{type:"CIMGeometricEffectAddControlPoints"},{type:"CIMGeometricEffectDashes",dashTemplate:B(t.style,null).map((e=>t.width&&t.width>0?e*t.width:e)),lineDashEnding:c,controlPointEnding:f.LineDashEnding.FullPattern}]:void 0;i.push({type:"CIMSolidStroke",capStyle:r?f.LineCapStyle.Round:f.LineCapStyle.Butt,enable:!0,width:o,color:N(t.color),effects:m})}else!t||"line-marker"!==e.type||"cross"!==e.style&&"x"!==e.style?[n,s]=X(a):([n,s]=X(a),i.push({type:"CIMSolidStroke",enable:!0,width:t,color:N(o)}));i.push({type:"CIMSolidFill",enable:!0,color:N(o)});const c={type:"CIMPolygonSymbol",symbolLayers:i};return{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:h.getNumericValue(-e.angle),size:h.getNumericValue(l||6*t),offsetX:h.getNumericValue(e.xoffset),offsetY:h.getNumericValue(e.yoffset),scaleSymbolsProportionally:!1,frame:n,markerGraphics:[{type:"CIMMarkerGraphic",geometry:s,symbol:c}]}]}}static fromCIMHatchFill(e,t){const r=t*(e.separation??y.defaultCIMValues.CIMHatchFill.separation),o=r/2,i=a.clone(e.lineSymbol);i.symbolLayers?.forEach((e=>{switch(e.type){case"CIMSolidStroke":null!=e.width&&(e.width*=t),e.effects?.forEach((e=>{if("CIMGeometricEffectDashes"===e.type){const r=e.dashTemplate;e.dashTemplate=r?.map((e=>e*t))}}));break;case"CIMVectorMarker":{null!=e.size&&(e.size*=t);const r=e.markerPlacement;null!=r&&"placementTemplate"in r&&(r.placementTemplate=r.placementTemplate.map((e=>e*t)));break}}}));let n=this._getLineSymbolPeriod(i)||4;for(;n<4;)n*=2;const s=n/2;return{type:"CIMVectorMarker",frame:{xmin:-s,xmax:s,ymin:-o,ymax:o},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[-s,0],[s,0]]]},symbol:i}],size:r}}static fetchResources(e,t,r,a=null){return e&&t?(E(e,(e=>{!function(e,t,r){e.effects&&null==t.geometryEngine&&(t.geometryEnginePromise?r.push(t.geometryEnginePromise):h.isGeometryEngineRequired(e.effects)&&(t.geometryEnginePromise=h.importGeometryEngine(),r.push(t.geometryEnginePromise),t.geometryEnginePromise.then((e=>t.geometryEngine=e))))}(e,t,r),"url"in e&&e.url&&r.push(t.fetchResource(e.url,{signal:a}))})),r):r}static fetchFonts(e,t,r){if(e&&t)if("symbolLayers"in e&&e.symbolLayers){for(const a of e.symbolLayers)if("CIMVectorMarker"===a.type&&a.markerGraphics)for(const e of a.markerGraphics)e?.symbol&&T.fetchFonts(e.symbol,t,r)}else if("CIMTextSymbol"===e.type){const{fontFamilyName:a,fontStyleName:o}=e;if(!a||"calcitewebcoreicons"===a.toLowerCase())return;const{style:i,weight:n}=h.fromCIMFontStyle(o),s=h.fromCIMFontDecoration(e),l=new c({family:a,style:i,weight:n,decoration:s});r.push(t.loadFont(l).catch((()=>{k().error(`Unsupported font ${a} in CIM symbol`)})))}}static _getLineSymbolPeriod(e){if(e){const t=this._getEffectsRepeat(e.effects);if(t)return t;if(e.symbolLayers)for(const t of e.symbolLayers)if(t){const e=this._getEffectsRepeat(t.effects);if(e)return e;switch(t.type){case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":case"CIMObjectMarker3D":case"CIMglTFMarker3D":{const e=this._getPlacementRepeat(t.markerPlacement);if(e)return e}}}}return 0}static _getEffectsRepeat(e){if(e)for(const t of e)if(t)switch(t.type){case"CIMGeometricEffectDashes":{const e=t.dashTemplate;if(e&&e.length){let t=0;for(const r of e)t+=r;return 1&e.length&&(t*=2),t}break}case"CIMGeometricEffectWave":return t.period;default:k().error(`unsupported geometric effect type ${t.type}`)}return 0}static _getPlacementRepeat(e){if(e)switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineVariableSize":{const t=e.placementTemplate;if(t&&t.length){let e=0;for(const r of t)e+=+r;return 1&t.length&&(e*=2),e}break}}return 0}static fromCIMInsidePolygon(e){const t=e.markerPlacement,r={...e};r.markerPlacement=null,r.anchorPoint=null;const a=Math.abs(t.stepX),o=Math.abs(t.stepY),s=(t.randomness??100)/100;let l,c,m,u;if("Random"===t.gridType){const e=n.px2pt(g.randomInsidePolygonTextureSize),r=Math.max(Math.floor(e/a),1),y=Math.max(Math.floor(e/o),1);l=r*a/2,c=y*o/2,m=2*c;const f=new i(t.seed),h=s*a/1.5,p=s*o/1.5;u=[];for(let e=0;e<r;e++)for(let t=0;t<y;t++){const r=e*a-l+h*(.5-f.getFloat()),i=t*o-c+p*(.5-f.getFloat());u.push({x:r,y:i}),0===e&&u.push({x:r+2*l,y:i}),0===t&&u.push({x:r,y:i+2*c})}}else!0===t.shiftOddRows?(l=a/2,c=o,m=2*o,u=[{x:-l,y:0},{x:l,y:0},{x:0,y:c},{x:0,y:-c}]):(l=a/2,c=o/2,m=o,u=[{x:-a,y:0},{x:0,y:-o},{x:-a,y:-o},{x:0,y:0},{x:a,y:0},{x:0,y:o},{x:a,y:o},{x:-a,y:o},{x:a,y:-o}]);return{type:"CIMVectorMarker",frame:{xmin:-l,xmax:l,ymin:-c,ymax:c},markerGraphics:u.map((e=>({type:"CIMMarkerGraphic",geometry:e,symbol:{type:"CIMPointSymbol",symbolLayers:[r]}}))),size:m}}}function E(e,t){if(e)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const r=e.symbolLayers;if(!r)return;for(const e of r)if(t(e),"CIMVectorMarker"===e.type){const r=e.markerGraphics;if(!r)continue;for(const e of r)if(e){const r=e.symbol;r&&E(r,t)}}break}}}const D=e=>{if(!e)return f.LineCapStyle.Butt;switch(e){case"butt":return f.LineCapStyle.Butt;case"square":return f.LineCapStyle.Square;case"round":return f.LineCapStyle.Round}},z=e=>{if(!e)return f.LineJoinStyle.Miter;switch(e){case"miter":return f.LineJoinStyle.Miter;case"round":return f.LineJoinStyle.Round;case"bevel":return f.LineJoinStyle.Bevel}},G=e=>{if(null==e)return"Center";switch(e){case"left":return"Left";case"right":return"Right";case"center":return"Center"}},V=e=>{if(null==e)return"Center";switch(e){case"baseline":return"Baseline";case"top":return"Top";case"middle":return"Center";case"bottom":return"Bottom"}},N=e=>{if(!e)return[0,0,0,0];const{r:t,g:r,b:a,a:o}=e;return[t,r,a,255*o]},v=(e,t)=>{const r=R(t),a=A(e);return r&&a?`${r}-${a}`:`${r}${a}`},R=e=>{if(!e)return"";switch(e.toLowerCase()){case"bold":case"bolder":return"bold"}return""},A=e=>{if(!e)return"";switch(e.toLowerCase()){case"italic":case"oblique":return"italic"}return""},B=(e,t)=>{const a=r("safari")?.001:0,o="butt"===t;switch(e){case"dash":case"esriSLSDash":return o?[4,3]:[3,4];case"dash-dot":case"esriSLSDashDot":return o?[4,3,1,3]:[3,4,a,4];case"dot":case"esriSLSDot":return o?[1,3]:[a,4];case"long-dash":case"esriSLSLongDash":return o?[8,3]:[7,4];case"long-dash-dot":case"esriSLSLongDashDot":return o?[8,3,1,3]:[7,4,a,4];case"long-dash-dot-dot":case"esriSLSDashDotDot":return o?[8,3,1,3,1,3]:[7,4,a,4,a,4];case"short-dash":case"esriSLSShortDash":return o?[4,1]:[3,2];case"short-dash-dot":case"esriSLSShortDashDot":return o?[4,1,1,1]:[3,2,a,2];case"short-dash-dot-dot":case"esriSLSShortDashDotDot":return o?[4,1,1,1,1,1]:[3,2,a,2,a,2];case"short-dot":case"esriSLSShortDot":return o?[1,1]:[a,2];case"solid":case"esriSLSSolid":case"none":return k().error("Unexpected: style does not require rasterization"),[0,0];default:return k().error(`Tried to rasterize SLS, but found an unexpected style: ${e}!`),[0,0]}},X=(e,t=100)=>{const r=t/2;let a,o;const i=e;if("circle"===i||"esriSMSCircle"===i){const e=.25;let t=Math.acos(1-e/r),i=Math.ceil(b/t/4);0===i&&(i=1),t=C/i,i*=4;const n=[];n.push([r,0]);for(let e=1;e<i;e++)n.push([r*Math.cos(e*t),-r*Math.sin(e*t)]);n.push([r,0]),a={rings:[n]},o={xmin:-r,ymin:-r,xmax:r,ymax:r}}else if("cross"===i||"esriSMSCross"===i){const e=0;a={paths:[[[e,r],[e,-r]],[[r,e],[-r,e]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r}}else if("diamond"===i||"esriSMSDiamond"===i)a={rings:[[[-r,0],[0,r],[r,0],[0,-r],[-r,0]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r};else if("square"===i||"esriSMSSquare"===i)a={rings:[[[-r,-r],[-r,r],[r,r],[r,-r],[-r,-r]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r};else if("x"===i||"esriSMSX"===i)a={paths:[[[r,r],[-r,-r]],[[r,-r],[-r,r]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r};else if("triangle"===i||"esriSMSTriangle"===i){const e=.5773502691896257*t,r=-e,i=2/3*t,n=i-t;a={rings:[[[r,n],[0,i],[e,n],[r,n]]]},o={xmin:r,ymin:n,xmax:e,ymax:i}}else"arrow"===i&&(a={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},o={xmin:-r,ymin:-r,xmax:r,ymax:r});return[o,a]},H=e=>"vertical"===e||"horizontal"===e||"cross"===e||"esriSFSCross"===e||"esriSFSVertical"===e||"esriSFSHorizontal"===e;function Y(e){if(!e)return null;let t=null;const{cap:r,color:a,join:o,miterLimit:i,style:n,width:s}=e;return"solid"!==n&&"none"!==n&&"esriSLSSolid"!==n&&"esriSLSNull"!==n&&(t=[{type:"CIMGeometricEffectDashes",dashTemplate:B(n,r),lineDashEnding:"NoConstraint",scaleDash:!0,offsetAlongLine:null}]),{type:"CIMSolidStroke",color:"esriSLSNull"!==n&&"none"!==n?N(a):[0,0,0,0],capStyle:D(r),joinStyle:z(o),miterLimit:i,width:s,effects:t}}e.CIMSymbolHelper=T,e.CIMSymbolInflatedSizeHelper=class{static getSymbolInflateSize(e,t,r,a,o){return e||(e=[0,0,0,0]),t?this._getInflateSize(e,t,r,a,o):e}static safeSize(e){const t=Math.max(Math.abs(e[0]),Math.abs(e[2])),r=Math.max(Math.abs(e[1]),Math.abs(e[3]));return Math.sqrt(t*t+r*r)}static _vectorMarkerBounds(e,t,r,a){let o=!0;const i=s.create();if(t?.markerGraphics)for(const n of t.markerGraphics){const t=[0,0,0,0];n.geometry&&(l.getBoundsXY(i,n.geometry),t[0]=0,t[1]=0,t[2]=0,t[3]=0,this.getSymbolInflateSize(t,n.symbol,r,0,a),i[0]+=t[0],i[1]+=t[1],i[2]+=t[2],i[3]+=t[3],o?(e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],o=!1):(e[0]=Math.min(e[0],i[0]),e[1]=Math.min(e[1],i[1]),e[2]=Math.max(e[2],i[2]),e[3]=Math.max(e[3],i[3])))}return e}static _getInflateSize(e,t,r,a,o){if(void 0!==t.symbolLayers){const i=this._getLayersInflateSize(e,t.symbolLayers,r,a,o),n=F(t.effects);return n>0&&(i[0]-=n,i[1]-=n,i[2]+=n,i[3]+=n),i}return this._getTextInflatedSize(e,t,o)}static _getLayersInflateSize(e,t,r,a,o){let i=!0;if(!t)return e;for(const n of t){if(!n)continue;let t=[0,0,0,0];switch(n.type){case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":{const e=n;let r=e.width;null!=r&&(e.capStyle===f.LineCapStyle.Square||e.joinStyle===f.LineJoinStyle.Miter?r/=1.4142135623730951:r/=2,t[0]=-r,t[1]=-r,t[2]=r,t[3]=r);break}case"CIMCharacterMarker":case"CIMVectorMarker":case"CIMPictureMarker":{const e=n;if("CIMVectorMarker"===n.type){const e=n;if(t=this._vectorMarkerBounds(t,e,r,o),e.frame){const r=(e.frame.xmin+e.frame.xmax)/2,a=(e.frame.ymin+e.frame.ymax)/2;if(t[0]-=r,t[1]-=a,t[2]-=r,t[3]-=a,null!=e.size){const r=e.size/(e.frame.ymax-e.frame.ymin);t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r}}}else if("CIMPictureMarker"===n.type){const a=n,o=r.getResource(a.url);let i=1;if(null!=o&&o.height&&(i=o.width/o.height),null!=e.size){const r=e.size/2,o=e.size*i*a.scaleX/2;t=[-o,-r,o,r]}}else if(null!=e.size){const r=e.size/2;t=[-r,-r,r,r]}if(e.anchorPoint){let r,a;"Absolute"===e.anchorPointUnits?(r=e.anchorPoint.x,a=e.anchorPoint.y):(r=e.anchorPoint.x*(t[2]-t[0]),a=e.anchorPoint.y*(t[3]-t[1]));const o=1.25*Math.sqrt(r*r+a*a);t[0]-=o,t[1]-=o,t[2]+=o,t[3]+=o}let i=h.getNumericValue(e.rotation);if(e.rotateClockwise&&(i=-i),a&&(i-=a),i){const e=x*i,r=Math.cos(e),a=Math.sin(e),o=s.create([M.cInfinity,M.cInfinity,-M.cInfinity,-M.cInfinity]);s.expandPointInPlace(o,[t[0]*r-t[1]*a,t[0]*a+t[1]*r]),s.expandPointInPlace(o,[t[0]*r-t[3]*a,t[0]*a+t[3]*r]),s.expandPointInPlace(o,[t[2]*r-t[1]*a,t[2]*a+t[1]*r]),s.expandPointInPlace(o,[t[2]*r-t[3]*a,t[2]*a+t[3]*r]),t=o}let l=h.getNumericValue(e.offsetX),c=h.getNumericValue(e.offsetY);if(a){const e=x*a,t=Math.cos(e),r=Math.sin(e),o=l*r+c*t;l=l*t-c*r,c=o}t[0]+=l,t[1]+=c,t[2]+=l,t[3]+=c;const m=w(e.markerPlacement);m>0&&(t[0]-=m,t[1]-=m,t[2]+=m,t[3]+=m);break}}const l=F(n.effects);l>0&&(t[0]-=l,t[1]-=l,t[2]+=l,t[3]+=l),i?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],i=!1):(e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[2]),e[3]=Math.max(e[3],t[3]))}return e}static _getTextInflatedSize(e,t,r){const a=d.roundPtToWholePixel(t.height??y.defaultCIMValues.CIMTextSymbol.height);if(e[0]=-a/2,e[1]=-a/2,e[2]=a/2,e[3]=a/2,!r)return e;const o=r.get(t);if(!o)return e;if(!o.glyphMosaicItems.glyphs.length)return e;const{lineGapType:i,lineGap:n}=t,s=i?u.lineGapType2LineHeight(i,n??0,a):0,l="CIMBackgroundCallout"===t.callout?.type,c=S.shapeGlyphs(o.glyphMosaicItems,{scale:a/g.glyphSize,angle:h.getNumericValue(t.angle),xOffset:h.getNumericValue(t.offsetX),yOffset:h.getNumericValue(t.offsetY),horizontalAlignment:t.horizontalAlignment,verticalAlignment:t.verticalAlignment,maxLineWidth:d.getLineWidth(t.lineWidth),lineHeight:g.magicLabelLineHeight*Math.max(.25,Math.min(s||1,4)),decoration:t.font.decoration||"none",useCIMAngleBehavior:!0,hasBackground:l}).boundsT,m=Math.sqrt(c.width*c.width+c.height*c.height);return e[0]-=c.x+m,e[1]-=c.y-m,e[2]+=c.x+m,e[3]+=-c.y+m,e}},e.capTypeToEnum=D,e.getEffectsInflateSize=F,e.slsDashToTemplateArray=B,e.symbolToCIM=function(e){let t;switch(e.type){case"cim":return e.data;case"web-style":return e;case"simple-marker":{const r=T.fromSimpleMarker(e);if(!r)throw new Error("InternalError: Cannot convert symbol to CIM");t=r;break}case"picture-marker":t=T.fromPictureMarker(e);break;case"simple-line":t=T.fromSimpleLineSymbol(e);break;case"simple-fill":t=T.fromSimpleFillSymbol(e);break;case"picture-fill":t=T.fromPictureFillSymbol(e);break;case"text":t=T.fromTextSymbol(e)}return{type:"CIMSymbolReference",symbol:t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));