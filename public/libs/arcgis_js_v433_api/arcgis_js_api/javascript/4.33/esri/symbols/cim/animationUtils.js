// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../core/Logger","./animationDebugFlags","./defaultCIMValues","./enums","./SDFHelper","./utils","../../views/2d/engine/webgl/animations/instructions"],(function(t,e,n,o,r,a,i,s){"use strict";function m(t){return!!t.animations&&t.animations.length>0}function c(t){return!!t.animations&&t.animations.some((t=>"CIMSymbolAnimationMoveAlongLine"===t.type))}const l=new Set(["CIMSymbolAnimationOffset","CIMSymbolAnimationRotation","CIMSymbolAnimationSize","CIMSymbolAnimationScale"]);function p(t){return!!t.animations&&t.animations.some((t=>l.has(t.type)))}function f(t,e){let n=0,o=0;const r="Absolute"!==t.anchorPointUnits;return t.anchorPoint&&(n=-t.anchorPoint.x,o=-t.anchorPoint.y),{...e,transform:{type:"AnimatedTransform",relativeTranslation:r,absoluteScale:!1,translation:g([n,o]),rotation:g(0),scale:g(1),parent:e.transform}}}function u(t,e){switch(e.type){case"CIMPictureMarker":case"CIMVectorMarker":return i.getProcessParam(t,e,"Rotation")}return 0}function y(t,e){switch(e.type){case"CIMPointSymbol":case"CIMVectorMarker":return[1,1,1,1];case"CIMSolidStroke":case"CIMSolidFill":return i.getProcessParam(t,e,"Color");case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":return i.getProcessParam(t,e,"TintColor")}return[1,1,1,1]}function P(t,e){if(!e)return{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:s.TimeOrigin.Local,repeatType:r.AnimatedSymbolRepeatType.Loop,easing:r.AnimatedSymbolEasingType.Linear,playAnimation:1,reverseAnimation:0};const n=i.getProcessParam(t,e,"Duration");let a;a=i.getProcessParam(t,e,"RandomizeStartTime")?{type:"Process",op:"Random",min:0,max:n,seed:i.getProcessParam(t,e,"RandomizeStartSeed")}:i.getProcessParam(t,e,"StartTimeOffset");const m=i.getProcessParam(t,e,"RepeatDelay"),c=i.getProcessParam(t,e,"PlayAnimation"),l=i.getProcessParam(t,e,"ReverseAnimation"),p=i.getValue(e.repeatType,o.defaultCIMValues.CIMAnimatedSymbolProperties.repeattype);return{duration:n,startTimeOffset:a,repeatDelay:m,timeOriginSelector:p===r.AnimatedSymbolRepeatType.None?s.TimeOrigin.Local:s.TimeOrigin.Global,repeatType:p,easing:i.getValue(e.easing,o.defaultCIMValues.CIMAnimatedSymbolProperties.easing),playAnimation:c,reverseAnimation:l}}function g(t){return{from:t,to:t,timing:{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:s.TimeOrigin.Local,repeatType:r.AnimatedSymbolRepeatType.Loop,easing:r.AnimatedSymbolEasingType.Linear,playAnimation:1,reverseAnimation:0}}}t.checkForAnimations=function t(e){if(null==e)return!1;if("object"!=typeof e)return!1;if(e.animations&&Array.isArray(e.animations)&&e.animations.length>0)return!0;for(const n in e)if(t(e[n]))return!0;return!1},t.getAnimationParams=function(t,e,n){const o=function(t,e,n){const o=function(t,e){const{animations:n}=e,o=n?.filter((t=>"CIMSymbolAnimationOffset"===t.type))[0];return o?{from:[0,0],to:[i.getProcessParam(t,o,"OffsetX"),i.getProcessParam(t,o,"OffsetY")],timing:P(t,o.animatedSymbolProperties)}:g([0,0])}(t,e),r=function(t,e){const{animations:n}=e,o=function(t,e){switch(e.type){case"CIMPictureMarker":case"CIMVectorMarker":return i.getProcessParam(t,e,"RotateClockwise")}return 0}(t,e),r={type:"Process",op:"Divide",left:u(t,e),right:{type:"Process",op:"Cond",condition:o,ifTrue:-1,ifFalse:1}},a=n?.filter((t=>"CIMSymbolAnimationRotation"===t.type))[0];if(!a)return g(r);const s={type:"Process",op:"Add",left:i.getProcessParam(t,a,"ToRotation"),right:{type:"Process",op:"Divide",left:r,right:-1}};return{from:r,to:{type:"Process",op:"Add",left:r,right:{type:"Process",op:"Cond",condition:i.getProcessParam(t,a,"RotateClockwise"),ifTrue:{type:"Process",op:"MatchWinding",sign:-1,angle:s},ifFalse:{type:"Process",op:"MatchWinding",sign:1,angle:s}}},timing:P(t,a.animatedSymbolProperties)}}(t,e),a=function(t,e){const{animations:n}=e;let o;o="CIMPictureMarker"===e.type||"CIMVectorMarker"===e.type?i.getProcessParam(t,e,"Size"):"CIMSolidStroke"===e.type||"CIMPictureStroke"===e.type?i.getProcessParam(t,e,"Width"):i.getSize(e)||10;const r=n?.filter((t=>"CIMSymbolAnimationScale"===t.type))[0];if(!r){const e=n?.filter((t=>"CIMSymbolAnimationSize"===t.type))[0];return e?{from:1,to:{type:"Process",op:"Divide",left:i.getProcessParam(t,e,"ToSize"),right:o},timing:P(t,e.animatedSymbolProperties)}:g(1)}return{from:1,to:i.getProcessParam(t,r,"ScaleFactor"),timing:P(t,r.animatedSymbolProperties)}}(t,e);return{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:o,rotation:r,scale:a,parent:n}}(t,e,n.transform),r=function(t,e,n){return{type:"AnimatedColor",color:g(y(t,e)),opacity:g(1),parent:n}}(t,e,n.fromColor),a=function(t,e,n){const{animations:o}=e;let r=y(t,e);const a=o?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return a&&(r=i.getProcessParam(t,a,"ToColor")),{type:"AnimatedColor",color:g(r),opacity:g(1),parent:n}}(t,e,n.toColor),s=function(t,e,n){const{animations:o}=e,r=o?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return r?{type:"AnimatedColor",color:g([1,1,1,1]),opacity:{from:0,to:1,timing:P(t,r?.animatedSymbolProperties)},parent:[1,1,1,1]}:n}(t,e,n.colorMix),l=function(t,e,n){const{animations:o}=e;let r=g(1);const a=o?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];return a&&(r=g({type:"Process",op:"Transparency",value:i.getProcessParam(t,a,"ToTransparency")})),{type:"AnimatedColor",color:g([1,1,1,1]),opacity:r,parent:n}}(t,e,n.toOpacity),f=function(t,e,n){const{animations:o}=e,r=o?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];return r?{type:"AnimatedColor",color:g([1,1,1,1]),opacity:{from:0,to:1,timing:P(t,r?.animatedSymbolProperties)},parent:[1,1,1,1]}:n}(t,e,n.opacityMix),d=function(t,e,n){const{animations:o}=e,r=o?.filter((t=>"CIMSymbolAnimationMoveAlongLine"===t.type))[0];if(!r)return n;let a,s;const m=P(t,r.animatedSymbolProperties),c=i.hasProcessParam(t,r,"DistanceAlong"),l=i.hasProcessParam(t,r,"Speed"),p=c&&i.getProcessParam(t,r,"DistanceAlong"),f=l&&i.getProcessParam(t,r,"Speed"),u=!0===r.continuous;if(!1!==p)a={type:"Process",op:"Divide",left:p,right:100},s=!0;else if(!1!==f)a={type:"Process",op:"Multiply",left:f,right:m.duration},s=!1;else{if(!u)throw new Error("Either distanceAlong, speed or continuous must be specified.");a=1,s=!0}return{type:"AnimatedShift",multiplyByLineLength:s,shift:{from:0,to:a,timing:m},parent:n}}(t,e,n.shift);return{transform:o,fromColor:r,toColor:a,colorMix:s,toOpacity:l,opacityMix:f,shift:d,hasAnimations:n.hasAnimations||m(e),hasShiftAnimation:n.hasShiftAnimation||c(e),hasMotionAnimations:n.hasMotionAnimations||p(e)}},t.getFrameTranslation=function(t,e){const n=e?.5*-(e.xmin+e.xmax):0,o=e?.5*-(e.ymin+e.ymax):0;let r=0,i=0;if("x"in t&&"y"in t)r=t.x+n,i=t.y+o;else{const e=a.getExtent(t);e&&(r=(e[0]+e[2])/2+n,i=(e[1]+e[3])/2+o)}return[r,i]},t.getStaticParam=g,t.handleAbsoluteAnchor=function(t,e){return"Absolute"!==t.anchorPointUnits?e:f(t,e)},t.handleAnchor=f,t.handleMarker=function(t,n,o){if("CIMCharacterMarker"===n.type)return e.getLogger("animationUtils").error("#handleMarker()","CIM character markers do not support animations"),o;const r=i.getProcessParam(t,n,"OffsetX"),a=i.getProcessParam(t,n,"OffsetY");if("CIMPictureMarker"===n.type)return{...o,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:g([r,a]),rotation:g(0),scale:g(i.getProcessParam(t,n,"Size")),parent:o.transform}};const s=n.frame,m=s.ymax-s.ymin;return{...o,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:g([r,a]),rotation:g(0),scale:g({type:"Process",op:"Divide",left:i.getProcessParam(t,n,"Size"),right:m}),parent:o.transform}}},t.handleRelativeAnchor=function(t,e){return"Absolute"===t.anchorPointUnits?e:f(t,e)},t.shouldUseAnimatedPath=function(t){return!n.animationDebugFlags.forceStaticPath&&(n.animationDebugFlags.forceAnimatedPath||t.hasAnimations)},t.translate=function(t,e,n){return{...t,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:g([e,n]),rotation:g(0),scale:g(1),parent:t.transform}}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));