// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/RandomLCG","../CIMPlacements","../enums"],(function(t,s,i,e){"use strict";const n=512,h=24,_=1e-6;class r{static{this.instance=null}static local(){return null===r.instance&&(r.instance=new r),r.instance}execute(t,s,i,e,n){return new a(t,s,i,e,n)}}class a{constructor(t,h,_,r,a){if(this._xMin=0,this._xMax=0,this._yMin=0,this._yMax=0,this._currentX=0,this._currentY=0,this._accelerationMap=null,this._testInsidePolygon=!1,this._verticalSubdivision=!0,this._stepX=Math.abs(h.stepX??16)*_,this._stepY=Math.abs(h.stepY??16)*_,this._stepX=Math.round(128*this._stepX)/128,this._stepY=Math.round(128*this._stepY)/128,0!==this._stepX&&0!==this._stepY){if(this._gridType=h.gridType??e.PlacementGridType.Fixed,this._gridType===e.PlacementGridType.Random){const t=h.seed??13,i=1;this._randomLCG=new s(t*i),this._randomness=(h.randomness??100)/100,this._gridAngle=0,this._shiftOddRows=!1,this._cosAngle=1,this._sinAngle=0,this._offsetX=0,this._offsetY=0,this._buildRandomValues()}else{if(this._randomness=0,this._gridAngle=h.gridAngle??0,this._shiftOddRows=h.shiftOddRows??!1,this._offsetX=(h.offsetX??0)*_,this._offsetY=(h.offsetY??0)*_,this._cosAngle=Math.cos(this._gridAngle/180*Math.PI),this._sinAngle=-Math.sin(this._gridAngle/180*Math.PI),this._stepX)if(this._offsetX<0)for(;this._offsetX<-.5*this._stepX;)this._offsetX+=this._stepX;else for(;this._offsetX>=.5*this._stepX;)this._offsetX-=this._stepX;if(this._stepY)if(this._offsetY<0)for(;this._offsetY<-.5*this._stepY;)this._offsetY+=this._stepY;else for(;this._offsetY>=.5*this._stepY;)this._offsetY-=this._stepY}if(this._graphicOriginX=0,this._graphicOriginY=0,null!=r){const[t,s,i,e]=r.split("/"),h=parseFloat(t),_=parseFloat(s),a=parseFloat(i),o=parseFloat(e);this._graphicOriginX=-(o*2**h+a)*n,this._graphicOriginY=_*n,this._testInsidePolygon=!0}this._internalPlacement=new i.Placement,this._calculateMinMax(t),this._geometryCursor=t}}next(){return this._geometryCursor?this._nextInside():null}_buildRandomValues(){if(!a._randValues){a._randValues=[];for(let t=0;t<h;t++)for(let t=0;t<h;t++)a._randValues.push(this._randomLCG.getFloat()),a._randValues.push(this._randomLCG.getFloat())}}_calculateMinMax(t){let s,i,e,h,_,r,a,o,l,c,f,u,p,M;this._xMin=0,this._xMax=0,this._yMin=0,this._yMax=0,a=o=p=f=Number.MAX_VALUE,l=c=M=u=-Number.MAX_VALUE;const g=1!==this._cosAngle;for(t.reset();t.nextPath();)for(;t.nextPoint();)r=t.x,_=t.y,s=r-this._graphicOriginX-this._offsetX,i=_-this._graphicOriginY-this._offsetY,g?(e=this._cosAngle*s-this._sinAngle*i,h=this._sinAngle*s+this._cosAngle*i):(e=s,h=i),a=Math.min(a,e),l=Math.max(l,e),o=Math.min(o,h),c=Math.max(c,h),f=Math.min(f,_),u=Math.max(u,_),p=Math.min(p,r),M=Math.max(M,r);f=f!==Number.MAX_VALUE?f:-512-this._stepY,u=u!==-Number.MAX_VALUE?u:this._stepY,p=p!==Number.MAX_VALUE?p:-this._stepX,M=M!==-Number.MAX_VALUE?M:n+this._stepX;const d=u-f,X=M-p;if(this._verticalSubdivision=d>=X,this._polygonMin=this._verticalSubdivision?f:p,this._testInsidePolygon){let t=0-this._graphicOriginX-this._offsetX-this._stepX,s=n-this._graphicOriginX-this._offsetX+this._stepX,i=-512-this._graphicOriginY-this._offsetY-this._stepY,e=0-this._graphicOriginY-this._offsetY+this._stepY;if(g){const n=[[t,i],[t,e],[s,i],[s,e]];t=i=Number.MAX_VALUE,s=e=-Number.MAX_VALUE;for(const h of n){const n=this._cosAngle*h[0]-this._sinAngle*h[1],_=this._sinAngle*h[0]+this._cosAngle*h[1];t=Math.min(t,n),s=Math.max(s,n),i=Math.min(i,_),e=Math.max(e,_)}}a=a!==Number.MAX_VALUE?Math.max(a,t):t,o=o!==Number.MAX_VALUE?Math.max(o,i):i,l=l!==-Number.MAX_VALUE?Math.min(l,s):s,c=c!==-Number.MAX_VALUE?Math.min(c,e):e}this._xMin=Math.round(a/this._stepX),this._xMax=Math.round(l/this._stepX),this._yMin=Math.round(o/this._stepY),this._yMax=Math.round(c/this._stepY),this._currentX=this._xMax+1,this._currentY=this._yMin-1,this._buildAccelerationMap(t,p,M,f,u)}_buildAccelerationMap(t,s,i,e,h){t.reset();const _=new Map,r=this._verticalSubdivision,a=r?h-e:i-s;let l=Math.ceil(a/10);if(l<=1)return;const c=Math.floor(a/l);let f,u,p,M,g,d,X,m,x,A,Y;for(l++,this._delta=c,r?(x=-512-2*this._stepY,A=2*this._stepY,Y=e):(x=-2*this._stepX,A=n+2*this._stepX,Y=s);t.nextPath();)if(!(t.pathSize<2)&&t.nextPoint())for(f=t.x,u=t.y;t.nextPoint();f=p,u=M){if(p=t.x,M=t.y,r){if(u===M||u<x&&M<x||u>A&&M>A)continue;g=Math.min(u,M),d=Math.max(u,M)}else{if(f===p||f<x&&p<x||f>A&&p>A)continue;g=Math.min(f,p),d=Math.max(f,p)}for(;g<d;)X=Math.floor((g-Y)/c),o(X,f,u,p,M,_),g+=c;m=Math.floor((d-Y)/c),m>X&&o(m,f,u,p,M,_)}this._accelerationMap=_}_nextInside(){for(;;){if(this._currentX>this._xMax){if(this._currentY++,this._currentY>this._yMax)return null;this._currentX=this._xMin,this._shiftOddRows&&this._currentY%2&&this._currentX--}let t=this._currentX*this._stepX+this._offsetX;this._shiftOddRows&&this._currentY%2&&(t+=.5*this._stepX);const s=this._currentY*this._stepY+this._offsetY;let i,n;if(this._currentX++,this._gridType===e.PlacementGridType.Random){const e=(this._currentX%h+h)%h,_=(this._currentY%h+h)%h;i=this._graphicOriginX+t+this._stepX*this._randomness*(.5-a._randValues[_*h+e])*2/3,n=this._graphicOriginY+s+this._stepY*this._randomness*(.5-a._randValues[_*h+e+1])*2/3}else i=this._graphicOriginX+this._cosAngle*t+this._sinAngle*s,n=this._graphicOriginY-this._sinAngle*t+this._cosAngle*s;if(!this._testInsidePolygon||this._isInsidePolygon(i,n,this._geometryCursor))return this._internalPlacement.setTranslate(i,n),this._internalPlacement}}_isInsidePolygon(t,s,i){if(null==this._accelerationMap)return function(t,s,i){let e,n,h,r,a=0;for(t+=_,s+=_,i.reset();i.nextPath();)if(i.nextPoint())for(e=i.x,n=i.y;i.nextPoint();e=h,n=r)h=i.x,r=i.y,n>s!=r>s&&((h-e)*(s-n)-(r-n)*(t-e)>0?a++:a--);return 0!==a}(t,s,i);t+=_,s+=_;const e=this._verticalSubdivision,n=e?s:t,h=Math.floor((n-this._polygonMin)/this._delta),r=this._accelerationMap.get(h);if(!r)return!1;let a,o,l,c=0;for(const i of r){if(a=i[0],o=i[1],e){if(a[1]>s==o[1]>s)continue;l=(o[0]-a[0])*(s-a[1])-(o[1]-a[1])*(t-a[0])}else{if(a[0]>t==o[0]>t)continue;l=(o[1]-a[1])*(t-a[0])-(o[0]-a[0])*(s-a[1])}l>0?c++:c--}return 0!==c}}function o(t,s,i,e,n,h){let _=h.get(t);_||(_=[],h.set(t,_)),_.push([[s,i],[e,n]])}t.PlacementInsidePolygon=r,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));