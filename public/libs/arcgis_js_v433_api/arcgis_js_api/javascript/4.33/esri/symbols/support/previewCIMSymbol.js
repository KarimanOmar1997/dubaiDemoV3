// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../core/screenUtils","../cim/CIMSymbolHelper","../cim/CIMSymbolRasterizer","../cim/OverrideHelper","../cim/utils","./previewUtils","./renderUtils"],(function(e,t,i,l,o,n,r,a){"use strict";const s=new l.CIMSymbolRasterizer(null),m=t.px2pt(r.SymbolSizeDefaults.size),y=t.px2pt(r.SymbolSizeDefaults.maxSize),p=t.px2pt(r.SymbolSizeDefaults.lineWidth);async function c(e,t={},l){const r=t.cimOptions||t;l??=r.geometryType||n.mapCIMSymbolToGeometryType(e?.data?.symbol);const{feature:a,fieldMap:m,viewParams:y}=r,p=await o.OverrideHelper.resolveSymbolOverrides(e.data,a,null,m,l,null,y);if(!p)return null;(e=e.clone()).data={type:"CIMSymbolReference",symbol:p},e.data.primitiveOverrides=void 0;const c=[];return i.CIMSymbolHelper.fetchResources(p,s.resourceManager,c),i.CIMSymbolHelper.fetchFonts(p,s.resourceManager,c),c.length>0&&await Promise.all(c),i.CIMSymbolHelper.getEnvelope(p,null,s.resourceManager)}e.getCIMSymbolPreviewSize=c,e.previewCIMSymbol=async function(e,i={}){const{node:l,opacity:o,symbolConfig:r}=i,h=null!=r&&"object"==typeof r&&"isSquareFill"in r&&r.isSquareFill,u=i.cimOptions||i,d=u.geometryType||n.mapCIMSymbolToGeometryType(e?.data?.symbol),g=await async function(e,t,i){const l=t?.size;let o=null!=l&&"object"==typeof l&&"width"in l?l.width:l,n=null!=l&&"object"==typeof l&&"height"in l?l.height:l;if(!o||!n)if("esriGeometryPolygon"===i)o=n=t.maxSize?Math.min(t.maxSize,m):m;else{const l=await c(e,t,i);l&&(o=l.width,n=l.height),"esriGeometryPolyline"===i&&(o=t.maxSize?Math.min(t.maxSize,p):p),o=null!=o&&isFinite(o)?Math.min(o,y):m,n=null!=n&&isFinite(n)?Math.max(Math.min(n,y),1):m}return"legend"===t.style&&"esriGeometryPolyline"===i&&(o=p),{width:o,height:n}}(e,i,d),{feature:f,fieldMap:S}=u,b=i?.geometry||h||"esriGeometryPolygon"!==d?"preview":"legend";let w=g;const M=g;if(i?.geometry&&("esriGeometryPolygon"===d||"esriGeometryPolyline"===d)){const e=200;if(t.pt2px(g.width)<e||t.pt2px(g.height)<e){const i=g.width>g.height?t.px2pt(e)*g.height/g.width:t.px2pt(e);w={width:g.width>g.height?t.px2pt(e):t.px2pt(e)*g.width/g.height,height:i}}}const x=await s.rasterizeCIMSymbolAsync(e,f,w,b,S,d,null,u.viewParams,u.allowScalingUp,i?.geometry?.toJSON());if(!x)return null;const{width:v,height:C}=x,z=document.createElement("canvas");z.width=v,z.height=C,z.getContext("2d").putImageData(x,0,0);const I=t.pt2px(M.width),P=t.pt2px(M.height),G=new Image(I,P);G.src=z.toDataURL(),G.ariaLabel=i.ariaLabel??null,G.alt=i.ariaLabel??"",null!=o&&(G.style.opacity=`${o}`);let O=G;if(null!=i.effectView){const e={shape:{type:"image",x:0,y:0,width:I,height:P,src:G.src},fill:null,stroke:null,offset:[0,0]};O=a.renderSymbol([[e]],[I,P],i)}return l&&O&&l.appendChild(O),O},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));