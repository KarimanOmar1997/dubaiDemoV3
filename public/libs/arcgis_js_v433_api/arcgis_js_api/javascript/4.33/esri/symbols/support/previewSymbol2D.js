// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../Color","../../core/colorUtils","../../core/Error","../../core/fontUtils","../../core/screenUtils","../../geometry/support/quantizationUtils","./gfxUtils","./previewUtils","./renderUtils","./textUtils"],(function(t,e,n,i,o,a,l,s,r,h,c){"use strict";const u="picture-fill",p=r.SymbolSizeDefaults.size,d=r.SymbolSizeDefaults.maxSize,m=r.SymbolSizeDefaults.maxOutlineSize,g=r.SymbolSizeDefaults.lineWidth,f=document.createElement("canvas");function y(t,e,n){if("polygon"===t.type){const i=t.extent,o=0===i.width?1:i.width,a=0===i.height?1:i.height;t=l.quantizePolygon({originPosition:"upperLeft",scale:[o/e,a/n],translate:[i.xmin,i.ymax]},{},t);let s="";for(let e=0;e<t.rings.length;e++){const n=t.rings[e];for(let t=0;t<n.length;t++){const e=n[t][0],i=n[t][1];let o="";0===t?(o=`M${e.toString()} ${i.toString()}`,""!==s&&(o=` ${o}`),s+=o):t===n.length-1?(o=`l${e.toString()} ${i.toString()} Z`,""!==s&&(o=` ${o}`),s+=o):(o=`l${e.toString()} ${i.toString()}`,""!==s&&(o=` ${o}`),s+=o)}}return s}if("polyline"===t.type){const i=t.extent,o=0===i.width?1:i.width,a=0===i.height?1:i.height;t=l.quantizePolyline({originPosition:"upperLeft",scale:[o/e,a/n],translate:[i.xmin,i.ymax]},{},t);let s="";for(let e=0;e<t.paths.length;e++){const n=t.paths[e];for(let t=0;t<n.length;t++){const e=n[t][0],i=n[t][1];let o="";0===t?(o=`M${e.toString()} ${i.toString()}`,""!==s&&(o=` ${o}`),s+=o):(o=`l${e.toString()} ${i.toString()}`,""!==s&&(o=` ${o}`),s+=o)}}return s}return""}function w(t,e){const n=f.getContext("2d"),i=[];e&&(e.weight&&i.push(e.weight),e.size&&i.push(e.size+"px"),e.family&&i.push(e.family)),n.font=i.join(" ");const{width:o,actualBoundingBoxLeft:a,actualBoundingBoxRight:l,actualBoundingBoxAscent:s,actualBoundingBoxDescent:r}=n.measureText(t);return{width:Math.ceil(Math.max(o,a+l)),height:Math.ceil(s+r),x:Math.floor(a),y:Math.floor((s-r)/2)}}function x(t){const e=t?.size;return{width:null!=e&&"object"==typeof e&&"width"in e?a.pt2px(e.width):null,height:null!=e&&"object"==typeof e&&"height"in e?a.pt2px(e.height):null}}function b(t,e){return t>e?"dark":"light"}function S(t,e){const n="number"==typeof e?.size?e?.size:null,i=null!=n?a.pt2px(n):null,o=null!=e?.maxSize?a.pt2px(e.maxSize):null;let l="angle"in t?t.angle:null;null!=e?.rotation&&(l=(l??0)+e.rotation);const h=s.getFill(t);let c=s.getStroke(t);"dark"!==v(t,245)||e?.ignoreWhiteSymbols||(c={width:.75,...c,color:"#bdc3c7"});let f=null;const b={shape:null,fill:h,stroke:c,offset:[0,0]};c?.width&&(c.width=Math.min(c.width,m));const S=c?.width||0;let M=null!=e?.size&&(null==e?.scale||e?.scale),z=0,k=0,L=!1;switch(t.type){case"simple-marker":{const n=t.style,{width:s,height:r}=x(e);let h=s===r&&null!=s?s:null!=i?i:Math.min(a.pt2px(t.size),o||d);if(!0===e?.useMarkerSymbolSize&&null!==s&&null!==r){const e=Math.min(a.pt2px(t.size),o||d);h=e>s&&e>r?Math.min(s,r):e}switch(z=h,k=h,n){case"circle":b.shape={type:"circle",cx:0,cy:0,r:.5*h},M||(z+=S,k+=S);break;case"cross":b.shape={type:"path",path:[{command:"M",values:[0,.5*k]},{command:"L",values:[z,.5*k]},{command:"M",values:[.5*z,0]},{command:"L",values:[.5*z,k]}]};break;case"diamond":b.shape={type:"path",path:[{command:"M",values:[0,.5*k]},{command:"L",values:[.5*z,0]},{command:"L",values:[z,.5*k]},{command:"L",values:[.5*z,k]},{command:"Z",values:[]}]},M||(z+=S,k+=S);break;case"square":b.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[z,0]},{command:"L",values:[z,k]},{command:"L",values:[0,k]},{command:"Z",values:[]}]},M||(z+=S,k+=S),l&&(L=!0);break;case"triangle":b.shape={type:"path",path:[{command:"M",values:[.5*z,0]},{command:"L",values:[z,k]},{command:"L",values:[0,k]},{command:"Z",values:[]}]},M||(z+=S,k+=S),l&&(L=!0);break;case"x":b.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[z,k]},{command:"M",values:[z,0]},{command:"L",values:[0,k]}]},l&&(L=!0);break;case"path":b.shape={type:"path",path:t.path||""},M||(z+=S,k+=S),l&&(L=!0),M=!0}break}case"simple-line":{const{width:t,height:n}=x(e),o=s.getDashArray(c).reduce(((t,e)=>t+e),0),a=o&&Math.ceil(g/o),l=n??i??S,r=t??(o*a||g);if(M=!0,"polyline"===e?.geometry?.type&&e?.geometry?.extent){z=r,k=n??z;const t=1e3,i=.15*t;f=[z,k],k=f[0]>f[1]?t*f[1]/f[0]:t,z=f[0]>f[1]?t:t*f[0]/f[1],c?.width&&(c.width=c.width*t/(f[1]>f[0]?f[1]:f[0]),c.width>i&&(c.width=i)),b.shape={type:"path",path:y(e.geometry,z,k)}}else z=null!=e?.maxSize?Math.min(r,e.maxSize):r,k=l,c&&(c.width=l),b.shape={type:"path",path:[{command:"M",values:[l/2,k/2]},{command:"L",values:[z-l/2,k/2]}]};break}case u:case"simple-fill":{const t="object"==typeof e?.symbolConfig&&!!e?.symbolConfig?.isSquareFill,{width:n,height:o}=x(e);z=!t&&n!==o||null==n?null!=i?i:p:n,k=!t&&n!==o||null==o?z:o,M||(z+=S,k+=S),M=!0,e?.geometry?.extent&&"polygon"===e?.geometry?.type?(f=[z,k],k=f[0]>f[1]?1e3*f[1]/f[0]:1e3,z=f[0]>f[1]?1e3:1e3*f[0]/f[1],b.shape={type:"path",path:y(e.geometry,z,k)}):b.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[z,0]},{command:"L",values:[z,k]},{command:"L",values:[0,k]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:r.shapes.fill[0];break}case"picture-marker":{const n=Math.min(a.pt2px(t.width),o||d),s=Math.min(a.pt2px(t.height),o||d),{width:r,height:h}=x(e),c=r===h&&null!=r?r:null!=i?i:Math.max(n,s),u=t.width/t.height;z=u<=1?Math.ceil(c*u):c,k=u<=1?c:Math.ceil(c/u),b.shape={type:"image",x:-Math.round(z/2),y:-Math.round(k/2),width:z,height:k,src:t.url||""},l&&(L=!0);break}case"text":{const n=t,l=e?.overrideText||n.text||"Aa",s=n.font,{width:r,height:h}=x(e),c=null!=h?h:null!=i?i:Math.min(a.pt2px(s.size),o||d),{width:u,height:p}=w(l,{weight:s.weight,size:c,family:s.family}),m=/[\uE600-\uE6FF]/.test(l);z=r??(m?c:u),k=m?c:p;let g=.5*(m?c:p);m&&(g+=5),b.shape={type:"text",text:l,x:n.xoffset||0,y:n.yoffset||g,align:"middle",alignBaseline:n.verticalAlignment,decoration:s&&s.decoration,rotated:n.rotated,kerning:n.kerning},b.font=s&&{size:c,style:s.style,decoration:s.decoration,weight:s.weight,family:s.family};break}}return{shapeDescriptor:b,size:[z,k],outputSize:f,renderOptions:{node:e?.node,scale:M,opacity:e?.opacity,rotations:[l],useRotationSize:L,effectView:e?.effectView,ariaLabel:e?.ariaLabel,clipBloomEffect:e?.clipBloomEffect}}}function v(t,i=225){const o=s.getFill(t),a=s.getStroke(t),l=!o||"type"in o?null:new e(o),r=a?.color?new e(a?.color):null,h=l?b(n.getColorLuminance(l),i):null,c=r?b(n.getColorLuminance(r),i):null;return c?h?h===c?h:i>=225?"light":"dark":c:h}t.getContrastingBackgroundTheme=v,t.getRenderSymbolParameters=S,t.previewSymbol2D=async function(t,e){const{shapeDescriptor:n,size:l,renderOptions:p,outputSize:d}=S(t,e);if(!n.shape)throw new i("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,e){const n=e.fill,i=t.color;if("pattern"===n?.type&&i&&t.type!==u){const t=await s.getPatternUrlWithColor(n.src,i.toCss(!0));n.src=t,e.fill=n}}(t,n),await async function(t,e,n,i){if(!("font"in t)||!t.font||"text"!==e.shape.type)return;try{await o.loadFont(t.font)}catch{}const{width:a,height:l}=x(i);if(!/[\uE600-\uE6FF]/.test(e.shape.text)){const{width:o,height:s,x:r,y:h}=w(e.shape.text,{weight:e.font?.weight,size:e.font?.size,family:e.font?.family});n[0]=a??o,n[1]=l??s,e.shape.x=r,e.shape.y=h;let c="angle"in t?t.angle:null;if(null!=i?.rotation&&(c=(c??0)+i.rotation),c){const t=c*(Math.PI/180),e=Math.abs(Math.sin(t)),i=Math.abs(Math.cos(t));n[1]=n[0]*e+n[1]*i}}}(t,n,l,e);const m=[[n]];if("object"==typeof e?.symbolConfig&&e?.symbolConfig?.applyColorModulation){const t=.6*l[0];m.unshift([{...n,offset:[-t,0],fill:r.adjustColorBrightness(n.fill,-.3)}]),m.push([{...n,offset:[t,0],fill:r.adjustColorBrightness(n.fill,.3)}]),l[0]+=2*t,p.scale=!1}"text"===t.type&&function(t,e,n,i,o){if(null!=t.haloColor&&null!=t.haloSize){o.masking??=n.map((()=>[]));const l=a.pt2px(t.haloSize);i[0]+=l,i[1]+=l,n.unshift([{...e,fill:null,stroke:{color:t.haloColor,width:2*l,join:"round",cap:"round"}}]),o.masking.unshift([{shape:{type:"rect",x:0,y:0,width:i[0]+2*c.backgroundPadding,height:i[1]+2*c.backgroundPadding},fill:[255,255,255],stroke:null},{...e,fill:[0,0,0,0],stroke:null}])}null==t.backgroundColor&&null==t.borderLineColor||(i[0]+=2*c.backgroundPadding,i[1]+=2*c.backgroundPadding,n.unshift([{shape:{type:"rect",x:0,y:0,width:i[0],height:i[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:a.pt2px(t.borderLineSize)}}]),o.masking?.unshift([]))}(t,n,m,l,p);const g=h.renderSymbol(m,l,p);if(d&&g){const t="img"===g.nodeName.toLowerCase()?g:g.firstChild;"svg"===t.nodeName.toLowerCase()&&t.setAttribute("viewBox",`0 0 ${l[0].toString()} ${l[1].toString()}`),t.setAttribute("width",d[0].toString()),t.setAttribute("height",d[1].toString()),d.length>2&&(t.style.setProperty("padding-left",d[2]?.toString()+"px"),t.style.setProperty("padding-right",d[2]?.toString()+"px"),t.style.setProperty("padding-top",d[3]?.toString()+"px"),t.style.setProperty("padding-bottom",d[3]?.toString()+"px"),t.style.setProperty("box-sizing","border-box"))}return g},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));