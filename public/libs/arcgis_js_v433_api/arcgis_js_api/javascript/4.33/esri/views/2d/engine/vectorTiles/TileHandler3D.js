// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../../../core/MemCache","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../geometry/support/aaBoundingRect","./constants","./TileHandler","./VectorTile","../../tiling/TileInfoViewPOT","../../tiling/TileKey"],(function(e,t,i,o,n,s,r,l,a){"use strict";class g extends s.TileHandler{constructor(e,t,i,o){super(e,t,i,e.tileInfo.lods.length-1),this._memCache=o,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new l(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(s,l){const g=new a(s[0],s[1],s[2],0);let h=this._memCache.get(g.id);if(h)return h.retain(),h;const c=await this._getVectorTileData(g);if(t.throwIfAborted(l),!this._layer)return null;if(h=this._memCache.get(g.id),h)return h.retain(),h;const u=this._layer.tileInfo.getTileBounds(o.create(),g),T=this._tileInfoView.getTileResolution(s[0]);return h=new r.VectorTile(g,T,u[0],u[3],n.tilePixelSize,n.tilePixelSize,this._styleRepository,this._memCache),h.setData(c),c&&(h.retain(),this._memCache.put(g.id,h,e.MinPriority)),h.neededForCoverage=!0,h.transforms.tileUnitsToPixels=i.fromValues(1/8,0,0,0,1/8,0,0,0,1),h}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const i=new AbortController,o={signal:i.signal},n=this._getParsedVectorTileData(e,o).then((e=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),e))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,n),this._ongoingRequestToController.set(t,i),n}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((i=>this.parseTileData({key:e,data:i},t)))}}return g}));