// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../../../core/maybe","../vtlBrushes","./shaders/VTLMaterialManager","./style/StyleDefinition","../../../webgl/enums"],(function(e,t,l,s,r){"use strict";const a=1e-6,n=[null];return class{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache={vtlBackground:null,vtlFill:null,vtlLine:null,vtlCircle:null,vtlSymbol:null},this._vtlMaterialManager=new l}dispose(){this._brushCache.vtlBackground?.dispose(),this._brushCache.vtlFill?.dispose(),this._brushCache.vtlLine?.dispose(),this._brushCache.vtlCircle?.dispose(),this._brushCache.vtlSymbol?.dispose(),this._brushCache=null,this._vtlMaterialManager=e.disposeMaybe(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,l,r){const i=r.layers;e.renderPass="translucent";let o=this._brushCache.vtlSymbol;null==o&&(o=new t.vtlBrushes.vtlSymbol,this._brushCache.vtlSymbol=o),n[0]=l;for(let t=0;t<i.length;t++){const l=i[t];if(l.type!==s.StyleLayerType.SYMBOL)continue;const r=l.getLayoutProperty("visibility");if(r&&r.getValue()===s.Visibility.NONE)continue;const u=e.displayLevel;void 0!==l.minzoom&&l.minzoom>u+a||void 0!==l.maxzoom&&l.maxzoom<=u-a||(e.styleLayerUID=l.uid,e.styleLayer=l,o.drawMany(e,n))}n[0]=null}drawBackground(e,l,r){if(0===r.backgroundBucketIds.length)return;const{context:i,displayLevel:o,requiredLevel:u}=e;l.key.level=u,i.setBlendingEnabled(!0),i.setDepthTestEnabled(!1),i.setStencilTestEnabled(!1),e.renderPass="background";let h=this._brushCache.vtlBackground;null==h&&(h=new t.vtlBrushes.vtlBackground,this._brushCache.vtlBackground=h),n[0]=l,r.backgroundBucketIds.forEach((t=>{const l=r.getLayerById(t);if(l.type!==s.StyleLayerType.BACKGROUND)return;const i=l.getLayoutProperty("visibility");i&&i.getValue()===s.Visibility.NONE||void 0!==l.minzoom&&l.minzoom>o+a||void 0!==l.maxzoom&&l.maxzoom<=o-a||(e.styleLayerUID=l.uid,e.styleLayer=l,h.drawMany(e,n))})),n[0]=null}drawTile(e,t,l,a){const{context:n}=e,i=l.layers;n.setBlendingEnabled(!1),n.setDepthTestEnabled(!0),n.setDepthWriteEnabled(!0),n.setDepthFunction(r.CompareFunction.LEQUAL);const o=i.filter((e=>{if(null!=a&&a!==e.type||!t.layerData.has(e.uid))return!1;const l=e.getLayoutProperty("visibility");return l?.getValue()!==s.Visibility.NONE}));e.renderPass="opaque";for(let l=o.length-1;l>=0;--l)this._renderStyleLayer(o[l],e,t);n.setDepthWriteEnabled(!1),n.setBlendingEnabled(!0),n.setBlendFunctionSeparate(r.BlendFactor.ONE,r.BlendFactor.ONE_MINUS_SRC_ALPHA,r.BlendFactor.ONE,r.BlendFactor.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent",o.forEach((l=>this._renderStyleLayer(l,e,t))),n.setDepthTestEnabled(!1),n.bindVAO()}_renderStyleLayer(e,l,r){const{renderPass:i}=l;let o;switch(e.type){case s.StyleLayerType.BACKGROUND:if("background"!==i)return;o=this._brushCache.vtlBackground,o||(o=new t.vtlBrushes.vtlBackground,this._brushCache.vtlBackground=o);break;case s.StyleLayerType.FILL:if("opaque"!==i&&"translucent"!==l.renderPass)return;o=this._brushCache.vtlFill,null==o&&(o=new t.vtlBrushes.vtlFill,this._brushCache.vtlFill=o);break;case s.StyleLayerType.LINE:if("translucent"!==i)return;o=this._brushCache.vtlLine,null==o&&(o=new t.vtlBrushes.vtlLine,this._brushCache.vtlLine=o);break;case s.StyleLayerType.CIRCLE:if("translucent"!==i)return;o=this._brushCache.vtlCircle,null==o&&(o=new t.vtlBrushes.vtlCircle,this._brushCache.vtlCircle=o);break;case s.StyleLayerType.SYMBOL:if("translucent"!==i)return;o=this._brushCache.vtlSymbol,null==o&&(o=new t.vtlBrushes.vtlSymbol,this._brushCache.vtlSymbol=o)}const{displayLevel:u}=l,{minzoom:h,maxzoom:c}=e;if(void 0!==h&&h>u+a||void 0!==c&&c<=u-a)return;const{context:y}=l;y.setStencilTestEnabled(!1),y.setStencilWriteMask(0),l.styleLayerUID=e.uid,l.styleLayer=e,n[0]=r,o.drawMany(l,n),n[0]=null}}}));