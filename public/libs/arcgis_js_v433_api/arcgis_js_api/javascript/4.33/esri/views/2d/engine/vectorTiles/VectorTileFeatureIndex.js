// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../../../Graphic","../../../../core/MapUtils","../../../../core/pbf","../../../../core/libs/rbush/PooledRBush","./constants","./enums","./Feature","./GeometryUtils","./SourceLayerData","./style/StyleLayer"],(function(e,t,s,i,r,l,o,n,a,y){"use strict";const c=(e,t)=>{const s=e.vtlSymbol.sourceTile,i=t.vtlSymbol.sourceTile;return s.level!==i.level?s.level-i.level:s.row!==i.row?s.row-i.row:s.col!==i.col?s.col-i.col:e.styleLayerUID-t.styleLayerUID};class u{constructor(e,t,s,i,r){this.tileKey=e,this._tileLayerData=t,this._styleRepository=s,this._tileHandler=i,this._parentLayer=r,this._index=null,this._tileKeyToPBF=new Map}static create(e,t,s,i,r){return new u(e,t,s,i,r)}clear(){this._index?.clear(),this._tileKeyToPBF.clear()}async queryAttributes(e,t,s,r,l){if(0===this._tileLayerData.size||!this._styleRepository||!this._tileHandler)return[];null===this._index&&(this._index=new i.PooledRBush(100,h),await this._indexLayers());const o=[];return this._queryIndex(o,e,t,s,this.tileKey.level,r),l&&l?.length>0&&await this._getSymbolsAttributes(o,l),o}async _indexLayers(){const e=this.tileKey,t=this._styleRepository.layers,s=await this._getTilePayload(e);for(const[i,r]of this._tileLayerData){const o=t[i],n=s.find((e=>e.sourceName===o.source));if(!n)continue;const{protobuff:a,key:y}=n;if(r.type!==l.BucketType.SYMBOL){const t=1<<e.level-y.level,s=e.row-y.row*t,i=e.col-y.col*t;this._indexLayer(o,a,e.level,t,s,i)}}}_indexLayer(e,t,i,l,c,u){const h=e.sourceLayer,d=e.getFeatureFilter(),_=i,f=i+1,g=n.getTileMargins(_),m=new s(new Uint8Array(t),new DataView(t));for(;m.next();)switch(m.tag()){case 3:{const t=m.getMessage(),s=new a(t);if(t.release(),s.name!==h)continue;const n=s.getData(),w=s.extent/l,x=w*u-g,b=w*c-g,p=x+w+2*g,I=b+w+2*g,L=w/r.tilePixelSize,v=r.tileCoordSize/w,T=w*u,S=w*c;for(;n.nextTag(2);){const t=n.getMessage(),r=new o(t,s);if(t.release(),d&&!d.filter(r,i))continue;const l=r.values||{},a=l._minzoom,c=l._maxzoom;if(a&&a>=10*f||c&&c<=10*_)continue;const u=e.getFeatureInflatedBounds(r,_,s.extent,L);null==u||u[0]>p||u[1]>I||u[2]<x||u[3]<b||(u[0]=(u[0]-T)*v,u[1]=(u[1]-S)*v,u[2]=(u[2]-T)*v,u[3]=(u[3]-S)*v,this._index.insert(new y.IndexItem(e,r,u,v,T,S)))}break}default:m.skip()}m.release()}async _getSymbolsAttributes(e,t){if(!t||0===t.length)return e;const s=[];if(t.sort(c),t.length>0){let e=0,{styleLayerUID:i}=t[0];for(let r=1;r<t.length;r++){const{styleLayerUID:l}=t[r];l!==i&&(s.push({from:e,to:r,styleLayerUID:i,sourceTileKey:t[r-1].vtlSymbol.sourceTile}),e=r,i=l)}const r=t.length-1;s.push({from:e,to:t.length,styleLayerUID:i,sourceTileKey:t[r].vtlSymbol.sourceTile})}const i=this._styleRepository.layers;for(const r of s){const s=await this._getTilePayload(r.sourceTileKey),l=i[r.styleLayerUID],o=!!l&&s.find((e=>e.sourceName===l.source));o&&this._addSymbolsAttributes(e,t.slice(r.from,r.to).map((e=>e.vtlSymbol.featureIndex)),r.styleLayerUID,o)}return e}_addSymbolsAttributes(t,s,i,r){const l=this._styleRepository.layers,o=r.key,n=this.tileKey,a=1<<n.level-o.level,y=n.row-o.row*a,c=n.col-o.col*a;this._getSymbolAttributes(r.protobuff,s,i,a,y,c).forEach((s=>{const{attributes:r,tilePoint:o}=s;t.push({layerId:l[i].id,layerIndex:i,graphic:new e({attributes:r,origin:{type:"vector-tile",layerId:l[i].id,layerIndex:i,layer:this._parentLayer}}),tilePoint:o})}))}_getSymbolAttributes(e,t,i,l,n,y){const c=[],u=this._styleRepository.layers;let h=0;t.sort(((e,t)=>e-t));const d=new s(new Uint8Array(e),new DataView(e));for(;d.next();)switch(d.tag()){case 3:{const e=d.getMessage(),s=new a(e);if(e.release(),s.name!==u[i].sourceLayer)continue;const _=s.getData(),f=s.extent/l,g=r.tileCoordSize/f,m=f*y,w=f*n;let x=0;for(;_.nextTag(2);){const e=_.getMessage();if(x++===t[h]){const t=new o(e,s),i=t.values,r=t.getGeometry(),l=null!=r?[g*(r[0][0].x-m),g*(r[0][0].y-w)]:null;c.push({attributes:i,tilePoint:l}),h++}if(e.release(),h===t.length)return c}break}default:d.skip()}return d.release(),c}_queryIndex(t,s,i,l,o,n){const a=r.tilePixelRatio*l*(window.devicePixelRatio||1);return this._index?.search({minX:s-a,minY:i-a,maxX:s+a,maxY:i+a},(r=>{const{layer:a,feature:y}=r;a.isIntersectingFeature(s,i,l,y,o,n,r)&&t.push({layerId:a.id,layerIndex:a.uid,tilePoint:null,graphic:new e({attributes:y.values,origin:{type:"vector-tile",layerId:r.layer.id,layerIndex:r.layer.uid,layer:this._parentLayer}})})})),t}async _getTilePayload(e){return t.getOrCreateMapValue(this._tileKeyToPBF,e.id,(()=>this._tileHandler.fetchTilePBFs(e))).then((e=>e))}}const h=e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]});return u}));