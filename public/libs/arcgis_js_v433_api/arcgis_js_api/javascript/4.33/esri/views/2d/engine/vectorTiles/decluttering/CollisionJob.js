// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/libs/gl-matrix-2/factories/mat3f32","./config","./util","../style/StyleDefinition"],(function(e,t,r,s,o){"use strict";e.CollisionJob=class{constructor(e,o,n,i,l,c){this._symbols=e,this._styleRepository=i,this._zoom=l,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new s.GridIndex(o,n,r.collisionGridCellSize),this._si=Math.sin(Math.PI*c/180),this._co=Math.cos(Math.PI*c/180),i.cachedStyles&&(this._styleProps=i.cachedStyles);for(const r of e)for(const e of r.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,t.clone(e.tile.transforms.tileUnitsToPixels))}work(e){const t=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const r=this._symbols[this._currentLayerCursor],s=this._getProperties(r.styleLayerUID),o=this._styleRepository.layerContexts?.get(r.styleLayerUID);for(;this._currentSymbolCursor<r.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-t>e)return!1;const n=r.symbols[this._currentSymbolCursor];if(!n.uniqueSymbol?.show)continue;const i=this._computeCoordinates(n,s,o),l=n.uniqueSymbol;if(!l.show)continue;const{iconAllowOverlap:c,textAllowOverlap:h}=s;for(const e of i){if(!e.enabled)continue;const t=l.parts[e.partIndex];t.show&&!(e.partIndex?h:c)&&this._doesCollide(e)&&(e.hard?l.show=!1:t.show=!1)}l.show&&this._insertColliders(l.parts,i,s)}}return!0}_insertColliders(e,t,r){const{iconIgnorePlacement:s,textIgnorePlacement:o}=r;for(const r of t){if(!r.enabled)continue;if(r.partIndex?o:s)continue;if(!e[r.partIndex].show)continue;const t=r.xScreen+r.dxScreen,n=r.yScreen+r.dyScreen,i=t+r.width,l=n+r.height,[c,h,d,a]=this._gridIndex.getCellSpan(t,n,i,l);for(let e=h;e<=a;e++)for(let t=c;t<=d;t++)this._gridIndex.cells[e][t].push(r)}}_computeCoordinates(e,t,r){const{iconRotationAlignment:s,textRotationAlignment:n,iconTranslate:i,iconTranslateAnchor:l,textTranslate:c,textTranslateAnchor:h}=t,d=this._si,a=this._co,y=this._zoom,u=this._allNeededMatrices.get(e.tile),x=e.uniqueSymbol,_=e.colliders(r);let S=0;for(const e of _){const[t,r]=0===e.partIndex?i:c,x=0===e.partIndex?l:h,_=e.minLod<=y&&y<=e.maxLod;S+=_?0:1,e.enabled=_,e.xScreen=e.xTile*u[0]+e.yTile*u[3]+u[6],e.yScreen=e.xTile*u[1]+e.yTile*u[4]+u[7],x===o.TranslateAnchor.MAP?(e.xScreen+=a*t-d*r,e.yScreen+=d*t+a*r):(e.xScreen+=t,e.yScreen+=r),o.RotationAlignment.VIEWPORT===(0===e.partIndex?s:n)?(e.dxScreen=e.dxPixels,e.dyScreen=e.dyPixels):(e.dxScreen=a*(e.dxPixels+e.width/2)-d*(e.dyPixels+e.height/2)-e.width/2,e.dyScreen=d*(e.dxPixels+e.width/2)+a*(e.dyPixels+e.height/2)-e.height/2)}return _.length>0&&S===_.length&&x&&(x.show=!1),_}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const r=this._styleRepository.getLayerStyleProperties?.(e,this._zoom);return this._styleProps.set(e,r),r}_doesCollide(e){const t=e.xScreen+e.dxScreen,r=e.yScreen+e.dyScreen,s=t+e.width,o=r+e.height,[n,i,l,c]=this._gridIndex.getCellSpan(t,r,s,o);for(let h=i;h<=c;h++)for(let i=n;i<=l;i++){const n=this._gridIndex.cells[h][i];for(const i of n){if(null!=i.labelId&&null!=e.labelId&&i.labelId===e.labelId)continue;const n=i.xScreen+i.dxScreen,l=i.yScreen+i.dyScreen,c=n+i.width,h=l+i.height;if(!(s<n||t>c||o<l||r>h))return!0}}return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));