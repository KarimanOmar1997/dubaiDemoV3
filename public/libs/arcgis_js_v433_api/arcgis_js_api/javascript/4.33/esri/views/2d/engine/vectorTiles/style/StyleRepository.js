// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../../../../core/lang","./StyleDefinition","./StyleLayer"],(function(e,t,r){"use strict";class a{constructor(r,a=!0){if(this.backgroundBucketIds=[],this._uidToLayer=new Map,this._layerByName={},this._runningId=0,this._style=a?e.clone(r):r,this._style.layers||(this._style.layers=[]),this.version=parseFloat(this._style.version),this.layers=this._style.layers.map(((e,t,r)=>this._create(e,t,r))).filter((e=>!!e)),this.layers)for(let e=0;e<this.layers.length;e++){const r=this.layers[e];this._layerByName[r.id]=r,this._uidToLayer.set(r.uid,r),r.type===t.StyleLayerType.BACKGROUND&&this.backgroundBucketIds.push(r.id)}this._identifyRefLayers()}getLayerStyleProperties(e,r){const a=this.getStyleLayerByUID(e),i=a?.getLayoutValue("symbol-placement",r)!==t.SymbolPlacement.POINT;let l=a?.getLayoutValue("icon-rotation-alignment",r);l===t.RotationAlignment.AUTO&&(l=i?t.RotationAlignment.MAP:t.RotationAlignment.VIEWPORT);let s=a?.getLayoutValue("text-rotation-alignment",r);s===t.RotationAlignment.AUTO&&(s=i?t.RotationAlignment.MAP:t.RotationAlignment.VIEWPORT);const y=a?.getPaintValue("icon-translate",r),n=a?.getPaintValue("icon-translate-anchor",r),o=a?.getPaintValue("text-translate",r),u=a?.getPaintValue("text-translate-anchor",r);return{geometryType:null,iconAllowOverlap:a?.getLayoutValue("icon-allow-overlap",r),iconIgnorePlacement:a?.getLayoutValue("icon-ignore-placement",r),textAllowOverlap:a?.getLayoutValue("text-allow-overlap",r),textIgnorePlacement:a?.getLayoutValue("text-ignore-placement",r),iconRotationAlignment:l,textRotationAlignment:s,iconTranslateAnchor:n,iconTranslate:y,textTranslateAnchor:u,textTranslate:o}}isPainterDataDriven(e){const t=this._layerByName[e];return!!t&&t.isPainterDataDriven()}getStyleLayerId(e){return e>=this.layers.length?null:this.layers[e].id}getStyleLayerByUID(e){return this._uidToLayer.get(e)??null}getStyleLayerIndex(e){const t=this._layerByName[e];return t?this.layers.indexOf(t):-1}setStyleLayer(e,t){if(!e?.id)return;const r=this._style;null!=t&&t>=this.layers.length&&(t=this.layers.length-1);let i,l=!0;const s=this._layerByName[e.id];if(s){const y=this.layers.indexOf(s);t||(t=y),t===y?(l=!1,i=a._recreateLayer(e,s),this.layers[t]=i,r.layers[t]=e):(this.layers.splice(y,1),r.layers.splice(y,1),i=this._create(e,t,this.layers),this.layers.splice(t,0,i),r.layers.splice(t,0,e))}else i=this._create(e,t,this.layers),!t||t>=this.layers.length?(this.layers.push(i),r.layers.push(e)):(this.layers.splice(t,0,i),r.layers.splice(t,0,e));this._layerByName[e.id]=i,this._uidToLayer.set(i.uid,i),l&&this._recomputeZValues(),this._identifyRefLayers()}getStyleLayer(e){const t=this._layerByName[e];return t?{type:t.typeName,id:t.id,source:t.source,"source-layer":t.sourceLayer,minzoom:t.minzoom,maxzoom:t.maxzoom,filter:t.filter,layout:t.layout,paint:t.paint}:null}deleteStyleLayer(e){const t=this._layerByName[e];if(t){delete this._layerByName[e],this._uidToLayer.delete(t.uid);const r=this.layers.indexOf(t);this.layers.splice(r,1),this._style.layers.splice(r,1),this._recomputeZValues(),this._identifyRefLayers()}}getLayerById(e){return this._layerByName[e]}getLayoutProperties(e){const t=this._layerByName[e];return t?t.layout:null}getPaintProperties(e){const t=this._layerByName[e];return t?t.paint:null}setPaintProperties(e,t){const r=this._layerByName[e];if(!r)return;const i={type:r.typeName,id:r.id,source:r.source,"source-layer":r.sourceLayer,minzoom:r.minzoom,maxzoom:r.maxzoom,filter:r.filter,layout:r.layout,paint:t},l=a._recreateLayer(i,r),s=this.layers.indexOf(r);this.layers[s]=l,this._style.layers[s].paint=t,this._layerByName[r.id]=l,this._uidToLayer.set(r.uid,l)}setLayoutProperties(e,t){const r=this._layerByName[e];if(!r)return;const i={type:r.typeName,id:r.id,source:r.source,"source-layer":r.sourceLayer,minzoom:r.minzoom,maxzoom:r.maxzoom,filter:r.filter,layout:t,paint:r.paint},l=a._recreateLayer(i,r),s=this.layers.indexOf(r);this.layers[s]=l,this._style.layers[s].layout=t,this._layerByName[r.id]=l,this._uidToLayer.set(r.uid,l)}setStyleLayerVisibility(e,t){const r=this._layerByName[e];if(!r)return;const i=r.layout||{};i.visibility=t;const l={type:r.typeName,id:r.id,source:r.source,"source-layer":r.sourceLayer,minzoom:r.minzoom,maxzoom:r.maxzoom,filter:r.filter,layout:i,paint:r.paint},s=a._recreateLayer(l,r),y=this.layers.indexOf(r);this.layers[y]=s,this._style.layers[y].layout=i,this._layerByName[r.id]=s,this._uidToLayer.set(r.uid,s)}getStyleLayerVisibility(e){const t=this._layerByName[e];if(!t)return"none";const r=t.layout;return r?.visibility??"visible"}_recomputeZValues(){const e=this.layers,t=1/(e.length+1);for(let r=0;r<e.length;r++)e[r].z=1-(1+r)*t}_identifyRefLayers(){const e=[],r=[];let a=0;for(const i of this.layers){const l=i.layout;if(i.type===t.StyleLayerType.FILL){const t=i;let r=i.source+"|"+i.sourceLayer;r+="|"+(l?.visibility??""),r+="|"+i.minzoom,r+="|"+i.maxzoom,r+="|"+JSON.stringify(i.filter),(t.hasDataDrivenFill||t.hasDataDrivenOutline)&&(r+="|"+a),e.push({key:r,layer:i})}else if(i.type===t.StyleLayerType.LINE){const e=i,t=i.paint,s=null!=t&&(null!=t["line-pattern"]||null!=t["line-dasharray"]);let y=i.source+"|"+i.sourceLayer;y+="|"+(l?.visibility??""),y+="|"+i.minzoom,y+="|"+i.maxzoom,y+="|"+JSON.stringify(i.filter),y+="|"+(void 0!==l?l["line-cap"]:""),y+="|"+(void 0!==l?l["line-join"]:""),(e.hasDataDrivenLine||s)&&(y+="|"+a),r.push({key:y,layer:i})}++a}this._assignRefLayers(e),this._assignRefLayers(r)}_assignRefLayers(e){let r,a;e.sort(((e,t)=>e.key<t.key?-1:e.key>t.key?1:0));const i=e.length;for(let l=0;l<i;l++){const s=e[l];if(s.key===r)s.layer.refLayerId=a;else if(r=s.key,a=s.layer.id,s.layer.type===t.StyleLayerType.FILL){if(!s.layer.getPaintProperty("fill-outline-color"))for(let t=l+1;t<i;t++){const i=e[t];if(i.key!==r)break;if(i.layer.getPaintProperty("fill-outline-color")){e[l]=i,e[t]=s,a=i.layer.id;break}}}else if(s.layer.type===t.StyleLayerType.LINE){let t=s.layer;for(let y=l+1;y<i;y++){const i=e[y];if(i.key!==r)break;const n=i.layer;(t.canUseThinTessellation&&!n.canUseThinTessellation||!t.canUseThinTessellation&&(n.getPaintProperty("line-pattern")||n.getPaintProperty("line-dasharray")))&&(t=n,e[l]=i,e[y]=s,a=i.layer.id)}}}}_create(e,a,i){const l=1-(1+a)*(1/(i.length+1)),s=this._runningId++;switch(e.type){case"background":return new r.BackgroundStyleLayer(t.StyleLayerType.BACKGROUND,e,l,s);case"fill":return new r.FillStyleLayer(t.StyleLayerType.FILL,e,l,s);case"line":return new r.LineStyleLayer(t.StyleLayerType.LINE,e,l,s);case"symbol":return new r.SymbolStyleLayer(t.StyleLayerType.SYMBOL,e,l,s);case"raster":return console.warn(`Unsupported vector tile raster layer ${e.id}`),null;case"circle":return new r.CircleStyleLayer(t.StyleLayerType.CIRCLE,e,l,s)}return null}static _recreateLayer(e,a){switch(e.type){case"background":return new r.BackgroundStyleLayer(t.StyleLayerType.BACKGROUND,e,a.z,a.uid);case"fill":return new r.FillStyleLayer(t.StyleLayerType.FILL,e,a.z,a.uid);case"line":return new r.LineStyleLayer(t.StyleLayerType.LINE,e,a.z,a.uid);case"symbol":return new r.SymbolStyleLayer(t.StyleLayerType.SYMBOL,e,a.z,a.uid);case"raster":return console.warn(`Unsupported vector tile raster layer ${e.id}`),null;case"circle":return new r.CircleStyleLayer(t.StyleLayerType.CIRCLE,e,a.z,a.uid)}return null}}return a}));