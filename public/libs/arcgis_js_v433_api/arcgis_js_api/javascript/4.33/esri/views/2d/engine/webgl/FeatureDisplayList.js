// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","./enums","./cpuMapped/FreeList","./shaderGraph/techniques/featureTechniqueUtils","../../../webgl/enums"],(function(t,e,n,i,a,s){"use strict";class r{constructor(t,e,n,i,a){this.instance=t,this.materialKey=e,this.target=n,this.start=i,this.count=a}get textureKey(){return 255&this.materialKey}get indexEnd(){return this.start+this.count}extend(t){this.count+=t}render(t){this.instance.techniqueRef.render(t,this)}get key(){return this.target.key}getStencilReference(){return this.target.stencilRef}getAttributePrecisionPackFactors(){const t=this.instance.instanceId;return this.target.getMesh(t).getAttributePrecisionPackFactors()}draw(t,e){a.isHittest(t)?this.drawCompute(t.context,e):this.drawGeometry(t.context,e)}drawCompute(t,e){const n=this.instance.instanceId,i=this.target.getMesh(n).getComputeVAO(t,e),a=this.start*Uint32Array.BYTES_PER_ELEMENT/3;t.bindVAO(i),t.drawElements(s.PrimitiveType.POINTS,this.count/3,s.DataType.UNSIGNED_INT,a),t.bindVAO(null)}drawGeometry(t,e){const n=this.instance.instanceId,i=this.target.getMesh(n).getGeometryVAO(t,e),a=this.start*Uint32Array.BYTES_PER_ELEMENT;t.bindVAO(i),t.drawElements(s.PrimitiveType.TRIANGLES,this.count,s.DataType.UNSIGNED_INT,a),t.bindVAO(null)}}class d{constructor(){this._length=0,this._minOrderedLength=0,this._materialKeys=new Set}static fromDisplayEntities(t,e,n,i){const a=new d;for(const s of t.values())for(const t of s.records){const s=n.getInstance(t.instanceId),r=s.instanceId<<16|255&t.textureKey;a.addRecord(s,r,t.indexStart,t.indexCount,t.vertexStart,t.vertexCount,e,i)}return a}get length(){return this._length}get minOrderedLength(){return this._minOrderedLength}get minUnorderedLength(){return this._materialKeys.size}render(t,e){const{drawPhase:n}=t;for(const i of this.infos()){const a=i.instance.techniqueRef;a.drawPhase&n&&(null==e||a.type===e)&&i.render(t)}}addRecord(t,e,a,s,d,h,l,o){let c=a,u=s;if(u||(c=d,u=h),!u)return;if(null==this._head){const n=new r(t,e,l,c,u);return this._head=new i.List(n),this._tail=this._head,this._length++,void this._minOrderedLength++}if(o===n.FeatureBatchingStrategy.STRICT_ORDER)return this._insert(t,e,l,c,u,this._tail,null);let _=null,g=this._head;const y=t.instanceId,m=t.techniqueRef.symbologyPlane;if(o===n.FeatureBatchingStrategy.STRICT_MARKERS_AND_TEXT&&(m===n.FeatureSymbologyDrawOrder.MARKER||m===n.FeatureSymbologyDrawOrder.TEXT))return this._insert(t,e,l,c,u,this._tail,null);for(;g;){const n=g.data.instance,i=n.instanceId,a=n.techniqueRef.symbologyPlane,s=_?.data.instance.instanceId;if(m<a||y===s&&y!==i)return this._insert(t,e,l,c,u,_,g);_=g,g=g.next}this._insert(t,e,l,c,u,_,null)}*infos(){if(null!=this._head)for(const t of this._head.values())yield t}_insert(t,e,n,a,s,d,h){if(null==d&&null==h){const d=new r(t,e,n,a,s);return this._head=new i.List(d),this._tail=this._head,this._length++,void this._minOrderedLength++}return e!==this._tail.data.materialKey&&this._minOrderedLength++,this._materialKeys.add(e),null==d&&null!=h?this._insertAtHead(t,e,n,a,s,h):null!=d&&null==h?this._insertAtEnd(t,e,n,a,s,d):null!=d&&null!=h?this._insertAtMiddle(t,e,n,a,s,d,h):void 0}_insertAtHead(t,e,n,a,s,d){const h=a+s;if(e===d.data.materialKey&&n===d.data.target&&h===d.data.start)d.data.start=a,d.data.count+=s;else{const h=new r(t,e,n,a,s);this._head=new i.List(h),this._head.next=d,this._length++}}_insertAtEnd(t,e,n,a,s,d){if(d.data.materialKey===e&&d.data.indexEnd===a)d.data.count+=s;else{const h=new r(t,e,n,a,s);this._tail=new i.List(h),d.next=this._tail,this._length++}}_insertAtMiddle(t,e,n,a,s,d,h){const l=a+s;if(d.data.materialKey===e&&d.data.target===n&&d.data.indexEnd===a)d.data.count+=s,d.data.materialKey===h.data.materialKey&&d.data.target===h.data.target&&d.data.indexEnd===h.data.start&&(d.data.count+=h.data.count,d.next=h.next,this._length--);else if(e===h.data.materialKey&&n===h.data.target&&l===h.data.start)h.data.start=a,h.data.count+=s;else{const l=new r(t,e,n,a,s),o=new i.List(l);d.next=o,o.next=h,this._length++}}}t.DisplayList=d,t.DisplayListInfo=r,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));