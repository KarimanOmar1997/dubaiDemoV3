// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../symbols/cim/enums","./definitions"],(function(t,e,i){"use strict";function x(t,e){return t.x===e.x&&t.y===e.y}function r(t,e){return t.x=e.y,t.y=-e.x,t}function n(t,e){return t.x=-e.y,t.y=e.x,t}function y(t,e){return t.x=e.x,t.y=e.y,t}function s(t,e){return t.x=-e.x,t.y=-e.y,t}function o(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function h(t,e){return t.x*e.x+t.y*e.y}function l(t,e,i,x){return t.x=e.x*i+e.y*x,t.y=e.x*x-e.y*i,t}t.LineTessellation=class{constructor(t,e,i){this._writeVertex=t,this._writeTriangle=e,this._canUseThinTessellation=i,this._prevNormal={x:void 0,y:void 0},this._nextNormal={x:void 0,y:void 0},this._textureNormalLeft={x:0,y:1},this._textureNormalRight={x:0,y:-1},this._textureNormal={x:void 0,y:void 0},this._joinNormal={x:void 0,y:void 0},this._inner={x:void 0,y:void 0},this._outer={x:void 0,y:void 0},this._roundStart={x:void 0,y:void 0},this._roundEnd={x:void 0,y:void 0},this._startBreak={x:void 0,y:void 0},this._endBreak={x:void 0,y:void 0},this._innerPrev={x:void 0,y:void 0},this._innerNext={x:void 0,y:void 0},this._bevelStart={x:void 0,y:void 0},this._bevelEnd={x:void 0,y:void 0},this._bevelMiddle={x:void 0,y:void 0}}tessellate(t,e,r=this._canUseThinTessellation){!function(t){if(!t)return;const e=t.length;if(e<=1)return;let i=0;for(let r=1;r<e;r++)x(t[r],t[i])||++i===r||(t[i]=t[r]);t.length=i+1}(t),r&&e.halfWidth<i.thinLineHalfWidthThreshold&&!e.offset?this._tessellateThin(t,e):this._tessellate(t,e)}_tessellateThin(t,e){if(t.length<2)return;const i=e.wrapDistance||65535;let x=e.initialDistance||0,r=!1,n=t[0].x,y=t[0].y;const s=t.length;for(let e=1;e<s;++e){r&&(r=!1,x=0);let s=t[e].x,o=t[e].y,h=s-n,l=o-y,a=Math.sqrt(h*h+l*l);if(h/=a,l/=a,x+a>i){r=!0;const t=(i-x)/a;a=i-x,s=(1-t)*n+t*s,o=(1-t)*y+t*o,--e}const _=this._writeVertex(n,y,0,0,h,l,l,-h,0,-1,x),c=this._writeVertex(n,y,0,0,h,l,-l,h,0,1,x);x+=a;const d=this._writeVertex(s,o,0,0,h,l,l,-h,0,-1,x),T=this._writeVertex(s,o,0,0,h,l,-l,h,0,1,x);this._writeTriangle(_,c,d),this._writeTriangle(c,d,T),n=s,y=o}}_tessellate(t,i){const a=t[0],_=t[t.length-1],c=x(a,_),d=c?3:2;if(t.length<d)return;const T=i.pixelCoordRatio,u=null!=i.capType?i.capType:e.CapType.BUTT,v=null!=i.joinType?i.joinType:e.JoinType.MITER,f=null!=i.miterLimit?Math.min(i.miterLimit,4):2,w=null!=i.roundLimit?Math.min(i.roundLimit,1.05):1.05,p=null!=i.halfWidth?i.halfWidth:2,g=!!i.textured;let V,m,N,b=null;const E=this._prevNormal,R=this._nextNormal;let M=-1,U=-1;const k=this._joinNormal;let L,B;const C=this._textureNormalLeft,D=this._textureNormalRight,J=this._textureNormal;let S=-1,O=-1;const A=i.wrapDistance||65535;let P=i.initialDistance||0;const j=this._writeVertex,I=this._writeTriangle,W=(t,e,i,x,r,n)=>{const y=j(m,N,L,B,i,x,t,e,r,n,P);return S>=0&&O>=0&&y>=0&&I(S,O,y),S=O,O=y,y};c&&(V=t[t.length-2],R.x=_.x-V.x,R.y=_.y-V.y,U=o(R),R.x/=U,R.y/=U);let q=!1;for(let i=0;i<t.length;++i){if(q&&(q=!1,P=0),V&&(E.x=-R.x,E.y=-R.y,M=U,P+M>A&&(q=!0)),q){const e=(A-P)/M;M=A-P,V={x:(1-e)*V.x+e*t[i].x,y:(1-e)*V.y+e*t[i].y},--i}else V=t[i];m=V.x,N=V.y;const x=i<=0&&!q,a=i===t.length-1;if(x||(P+=M),b=a?c?t[1]:null:t[i+1],b?(R.x=b.x-m,R.y=b.y-N,U=o(R),R.x/=U,R.y/=U):(R.x=void 0,R.y=void 0),!c){if(x){n(k,R),L=k.x,B=k.y,u===e.CapType.SQUARE&&(W(-R.y-R.x,R.x-R.y,R.x,R.y,0,-1),W(R.y-R.x,-R.x-R.y,R.x,R.y,0,1)),u===e.CapType.ROUND&&(W(-R.y-R.x,R.x-R.y,R.x,R.y,-1,-1),W(R.y-R.x,-R.x-R.y,R.x,R.y,-1,1)),u!==e.CapType.ROUND&&u!==e.CapType.BUTT||(W(-R.y,R.x,R.x,R.y,0,-1),W(R.y,-R.x,R.x,R.y,0,1));continue}if(a){r(k,E),L=k.x,B=k.y,u!==e.CapType.ROUND&&u!==e.CapType.BUTT||(W(E.y,-E.x,-E.x,-E.y,0,-1),W(-E.y,E.x,-E.x,-E.y,0,1)),u===e.CapType.SQUARE&&(W(E.y-E.x,-E.x-E.y,-E.x,-E.y,0,-1),W(-E.y-E.x,E.x-E.y,-E.x,-E.y,0,1)),u===e.CapType.ROUND&&(W(E.y-E.x,-E.x-E.y,-E.x,-E.y,1,-1),W(-E.y-E.x,E.x-E.y,-E.x,-E.y,1,1));continue}}let _,d,j=(X=R,-((Q=E).x*X.y-Q.y*X.x));if(Math.abs(j)<.01)h(E,R)>0?(k.x=E.x,k.y=E.y,j=1,_=Number.MAX_VALUE,d=!0):(n(k,R),j=1,_=1,d=!1);else{k.x=(E.x+R.x)/j,k.y=(E.y+R.y)/j,_=o(k);const t=(_-1)*p*T;d=_>4||t>M&&t>U}L=k.x,B=k.y;let I=v;switch(v){case e.JoinType.BEVEL:_<1.05&&(I=e.JoinType.MITER);break;case e.JoinType.ROUND:_<w&&(I=e.JoinType.MITER);break;case e.JoinType.MITER:_>f&&(I=e.JoinType.BEVEL)}switch(I){case e.JoinType.MITER:if(W(k.x,k.y,-E.x,-E.y,0,-1),W(-k.x,-k.y,-E.x,-E.y,0,1),a)break;if(g){const t=q?0:P;S=this._writeVertex(m,N,L,B,R.x,R.y,k.x,k.y,0,-1,t),O=this._writeVertex(m,N,L,B,R.x,R.y,-k.x,-k.y,0,1,t)}break;case e.JoinType.BEVEL:{const t=j<0;let e,i,x,o;if(t){const t=S;S=O,O=t,e=C,i=D}else e=D,i=C;if(d)x=t?n(this._innerPrev,E):r(this._innerPrev,E),o=t?r(this._innerNext,R):n(this._innerNext,R);else{const e=t?s(this._inner,k):y(this._inner,k);x=e,o=e}const h=t?r(this._bevelStart,E):n(this._bevelStart,E);W(x.x,x.y,-E.x,-E.y,e.x,e.y);const _=W(h.x,h.y,-E.x,-E.y,i.x,i.y);if(a)break;const c=t?n(this._bevelEnd,R):r(this._bevelEnd,R);if(d){const t=this._writeVertex(m,N,L,B,-E.x,-E.y,0,0,0,0,P);S=this._writeVertex(m,N,L,B,R.x,R.y,o.x,o.y,e.x,e.y,P),O=this._writeVertex(m,N,L,B,R.x,R.y,c.x,c.y,i.x,i.y,P),this._writeTriangle(_,t,O)}else{if(g){const t=this._bevelMiddle;t.x=(h.x+c.x)/2,t.y=(h.y+c.y)/2,l(J,t,-E.x,-E.y),W(t.x,t.y,-E.x,-E.y,J.x,J.y),l(J,t,R.x,R.y),S=this._writeVertex(m,N,L,B,R.x,R.y,t.x,t.y,J.x,J.y,P),O=this._writeVertex(m,N,L,B,R.x,R.y,o.x,o.y,e.x,e.y,P)}else{const t=S;S=O,O=t}W(c.x,c.y,R.x,R.y,i.x,i.y)}if(t){const t=S;S=O,O=t}break}case e.JoinType.ROUND:{const t=j<0;let e,i;if(t){const t=S;S=O,O=t,e=C,i=D}else e=D,i=C;const x=t?s(this._inner,k):y(this._inner,k);let o,c;d?(o=t?n(this._innerPrev,E):r(this._innerPrev,E),c=t?r(this._innerNext,R):n(this._innerNext,R)):(o=x,c=x);const T=t?r(this._roundStart,E):n(this._roundStart,E),u=t?n(this._roundEnd,R):r(this._roundEnd,R),v=W(o.x,o.y,-E.x,-E.y,e.x,e.y),f=W(T.x,T.y,-E.x,-E.y,i.x,i.y);if(a)break;const w=this._writeVertex(m,N,L,B,-E.x,-E.y,0,0,0,0,P);d||this._writeTriangle(S,O,w);const p=s(this._outer,x),V=this._writeVertex(m,N,L,B,R.x,R.y,u.x,u.y,i.x,i.y,P);let b,M;const U=_>2;if(U){let e;_!==Number.MAX_VALUE?(p.x/=_,p.y/=_,e=h(E,p),e=(_*(e*e-1)+1)/e):e=-1,b=t?r(this._startBreak,E):n(this._startBreak,E),b.x+=E.x*e,b.y+=E.y*e,M=t?n(this._endBreak,R):r(this._endBreak,R),M.x+=R.x*e,M.y+=R.y*e}l(J,p,-E.x,-E.y);const A=this._writeVertex(m,N,L,B,-E.x,-E.y,p.x,p.y,J.x,J.y,P);l(J,p,R.x,R.y);const I=g?this._writeVertex(m,N,L,B,R.x,R.y,p.x,p.y,J.x,J.y,P):A,q=w,Q=g?this._writeVertex(m,N,L,B,R.x,R.y,0,0,0,0,P):w;let X=-1,H=-1;if(U&&(l(J,b,-E.x,-E.y),X=this._writeVertex(m,N,L,B,-E.x,-E.y,b.x,b.y,J.x,J.y,P),l(J,M,R.x,R.y),H=this._writeVertex(m,N,L,B,R.x,R.y,M.x,M.y,J.x,J.y,P)),g?U?(this._writeTriangle(q,f,X),this._writeTriangle(q,X,A),this._writeTriangle(Q,I,H),this._writeTriangle(Q,H,V)):(this._writeTriangle(q,f,A),this._writeTriangle(Q,I,V)):U?(this._writeTriangle(w,f,X),this._writeTriangle(w,X,H),this._writeTriangle(w,H,V)):(this._writeTriangle(w,f,A),this._writeTriangle(w,I,V)),d?(S=this._writeVertex(m,N,L,B,R.x,R.y,c.x,c.y,e.x,e.y,P),O=V):(S=g?this._writeVertex(m,N,L,B,R.x,R.y,c.x,c.y,e.x,e.y,P):v,this._writeTriangle(S,Q,V),O=V),t){const t=S;S=O,O=t}break}}}var Q,X}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));