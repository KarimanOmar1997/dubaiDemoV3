// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/maybe","../../../../core/libs/gl-matrix-2/math/common","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./definitions","./VertexStream","./shaders/StencilPrograms","../../../webgl/enums","../../../webgl/ProgramTemplate"],(function(t,e,i,r,s,a,n,o,l,c,d,h,m){"use strict";const u=a.fromValues(-.5,-.5);t.WorldExtentRenderer=class{constructor(){this._centerNdc=o.create(),this._pxToNdc=o.create(),this._worldDimensionsPx=o.create(),this._mat3=s.create(),this._initialized=!1}dispose(){this._program=e.disposeMaybe(this._program),this._quad=e.disposeMaybe(this._quad)}render(t,e,i){const{context:r}=t,s=this._updateGeometry(t,i);if(null!=e){const{r:t,g:i,b:s,a}=e;r.setClearColor(a*t/255,a*i/255,a*s/255,a)}else r.setClearColor(0,0,0,0);if(r.setStencilFunction(h.CompareFunction.ALWAYS,0,255),r.setStencilWriteMask(255),!s)return r.setClearStencil(l.backbufferStencilVisible),void r.clear(h.FramebufferBit.STENCIL|h.FramebufferBit.COLOR);r.setClearStencil(l.backbufferStencilClipped),r.clear(h.FramebufferBit.STENCIL|h.FramebufferBit.COLOR),this._initialized||this._initialize(r),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setColorMask(!1,!1,!1,!1),r.setBlendingEnabled(!1),r.setStencilOp(h.StencilOperation.KEEP,h.StencilOperation.KEEP,h.StencilOperation.REPLACE),r.setStencilFunction(h.CompareFunction.ALWAYS,l.backbufferStencilVisible,255),r.setStencilTestEnabled(!0),r.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.bind(),this._quad.draw(),this._quad.unbind()}_initialize(t){if(this._initialized)return;const e=m.createProgram(t,d.stencil);e&&(this._program=e,this._quad=new c(t,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(t,e){const{state:s,pixelRatio:a}=t,{size:o,rotation:l}=s,c=Math.round(o[0]*a),d=Math.round(o[1]*a);if(!s.spatialReference.isWrappable)return!1;const h=i.toRadian(l),m=Math.abs(Math.cos(h)),b=Math.abs(Math.sin(h)),f=Math.round(c*m+d*b),_=Math.round(a*s.worldScreenWidth);if(f<=_)return!1;const p=c*b+d*m,S=(e.left-e.right)*a/c,g=(e.bottom-e.top)*a/d;n.set(this._worldDimensionsPx,_,p,1),n.set(this._pxToNdc,2/c,-2/d,1),n.set(this._centerNdc,S,g,1);const x=this._mat3;return r.fromTranslation(x,this._centerNdc),r.scale(x,x,this._pxToNdc),0!==l&&r.rotate(x,x,h),r.scale(x,x,this._worldDimensionsPx),r.translate(x,x,u),!0}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));