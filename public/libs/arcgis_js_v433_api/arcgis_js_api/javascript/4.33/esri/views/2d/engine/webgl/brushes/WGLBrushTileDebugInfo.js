// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../../../../core/libs/gl-matrix-2/factories/vec4f32","../DefaultVertexAttributeLayouts","../FeatureTile","./WGLBrush","../shaders/BackgroundPrograms","../shaders/TileInfoPrograms","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/ProgramTemplate","../../../../webgl/Texture","../../../../webgl/TextureDescriptor","../../../../webgl/VertexArrayObject"],(function(e,t,r,i,o,n,s,a,l,c,u,f){"use strict";const d=16;return class extends i{constructor(){super(...arguments),this._color=e.fromValues(1,0,0,1)}dispose(){this._outlineProgram?.dispose(),this._outlineProgram=null,this._tileInfoProgram?.dispose(),this._tileInfoProgram=null,this._outlineVertexArrayObject?.dispose(),this._outlineVertexArrayObject=null,this._tileInfoVertexArrayObject?.dispose(),this._tileInfoVertexArrayObject=null,this._ctx=null}prepareState({context:e}){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA,a.BlendFactor.ONE,a.BlendFactor.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!1)}draw(e,t){const{context:i,requestRender:o,allowDelayedRender:n}=e;if(!t.isReady&&t instanceof r.FeatureTile&&t.hasData)return;if(this._loadWGLResources(i),n&&null!=o&&(!this._outlineProgram.compiled||!this._tileInfoProgram.compiled))return void o();i.bindVAO(this._outlineVertexArrayObject),i.useProgram(this._outlineProgram),this._outlineProgram.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),this._outlineProgram.setUniform2f("u_coord_range",t.rangeX,t.rangeY),this._outlineProgram.setUniform1f("u_depth",0),this._outlineProgram.setUniform4fv("u_color",this._color),i.drawArrays(a.PrimitiveType.LINE_STRIP,0,4);const s=this._getTexture(i,t);s?(i.bindVAO(this._tileInfoVertexArrayObject),i.useProgram(this._tileInfoProgram),i.bindTexture(s,0),this._tileInfoProgram.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),this._tileInfoProgram.setUniform1f("u_depth",0),this._tileInfoProgram.setUniform2f("u_coord_ratio",t.rangeX/t.width,t.rangeY/t.height),this._tileInfoProgram.setUniform2f("u_delta",0,0),this._tileInfoProgram.setUniform2f("u_dimensions",s.descriptor.width,s.descriptor.height),i.drawArrays(a.PrimitiveType.TRIANGLE_STRIP,0,4),i.bindVAO()):i.bindVAO()}_loadWGLResources(e){if(this._outlineProgram&&this._tileInfoProgram)return;const r=l.createProgram(e,o.background),i=l.createProgram(e,n.tileInfo),c=new Int8Array([0,0,1,0,1,1,0,1]),u=s.BufferObject.createVertex(e,a.Usage.STATIC_DRAW,c),d=new f.VertexArrayObject(e,o.background.attributes,t.Pos2b,new Map([["geometry",u]])),g=new Int8Array([0,0,1,0,0,1,1,1]),h=s.BufferObject.createVertex(e,a.Usage.STATIC_DRAW,g),m=new f.VertexArrayObject(e,n.tileInfo.attributes,t.Pos2b,new Map([["geometry",h]]));this._outlineProgram=r,this._tileInfoProgram=i,this._outlineVertexArrayObject=d,this._tileInfoVertexArrayObject=m}_getTexture(e,t){if(!this._ctx){const e=document.createElement("canvas");e.width=512,e.height=512,this._ctx=e.getContext("2d")}if(!t.tileDebugInfoTexture){const r=new u.TextureDescriptor;r.wrapMode=a.TextureWrapMode.CLAMP_TO_EDGE,r.samplingMode=a.TextureSamplingMode.LINEAR,r.isImmutable=!0,r.width=512,r.height=512,t.tileDebugInfoTexture=new c.Texture(e,r)}const r=this._ctx;r.clearRect(0,0,r.canvas.width,r.canvas.height),r.textAlign="left",r.textBaseline="top",r.font="14px sans-serif",r.lineWidth=2,r.fillStyle="white",r.strokeStyle="black";const{debugSlot:i}=t;let o=8+99.2*i;const n=`${i}) ${t.key.id} (${t.constructor.name})`;r.strokeText(n,8,o),r.fillText(n,8,o),o+=d;const{debugInfo:s}=t;if(s){const{length:e,minOrderedLength:t,minUnorderedLength:i,triangleCount:n}=s.display;if(e>0){const t=`Length: ${e}`;r.strokeText(t,8,o),r.fillText(t,8,o),o+=d}if(t){const e=`Min ordered length: ${t}`;r.strokeText(e,8,o),r.fillText(e,8,o),o+=d}if(i){const e=`Min unordered length: ${i}`;r.strokeText(e,8,o),r.fillText(e,8,o),o+=d}if(n>0){n>1e5&&(r.fillStyle="red",r.strokeStyle="white");const e=`Triangle count: ${n}`;r.strokeText(e,8,o),r.fillText(e,8,o),o+=d}const{bytesUsed:a,bytesReserved:l}=s.memory;if(r.fillStyle="white",r.strokeStyle="black",a>0||l>0){const e=`Memory usage: ${a} of ${l} bytes`;r.strokeText(e,8,o),r.fillText(e,8,o),o+=d}}return t.tileDebugInfoTexture.setData(r.canvas),t.tileDebugInfoTexture}}}));