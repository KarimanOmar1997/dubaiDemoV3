// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/has","../definitions","./Effect","../../../../webgl/enums"],(function(t,e,s,i,o){"use strict";class n extends i.Effect{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:t},i){if(!i.length)return null;const o=i.shift(),n=o.x,r=o.y;this._outstanding=o;const l=e("esri-mobile");return{type:"hittest",distance:(l?s.hittestToleranceMobile:s.hittestToleranceDesktop)*t,smallSymbolDistance:(l?s.hittestToleranceMobile:s.hittestToleranceSmallSymbol)*t,smallSymbolSizeThreshold:s.hittestSmallSymbolThreshold,position:[n,r]}}bind(t){const{context:e,attributeView:i}=t;if(!i.size)return;const n=i.getBlock(s.AttributeDataType.GPGPU);if(null==n)return;const r=n.getFBO(e);e.setViewport(0,0,i.size,i.size),e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(o.FramebufferBit.COLOR|o.FramebufferBit.DEPTH)}unbind(){}draw(t){if(null==this._outstanding)return;const e=this._outstanding;this._outstanding=null,this._resolve(t,e.resolvers)}async _resolve(t,e){const{context:i,attributeView:n}=t,r=n.getBlock(s.AttributeDataType.GPGPU);if(null==r)return void e.forEach((t=>t.resolve([])));const l=r.getFBO(i),a=new Uint8Array(l.width*l.height*4);try{await l.readPixelsAsync(0,0,l.width,l.height,o.PixelFormat.RGBA,o.PixelType.UNSIGNED_BYTE,a)}catch(t){return void e.forEach((t=>t.resolve([])))}const c=[];for(let t=0;t<a.length;t+=4){const e=t/4;a[t]&&c.push(e)}e.forEach((t=>t.resolve(c)))}}t.HittestEffect=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));