// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/maybe","../../VertexStream","../../../../../webgl/enums","../../../../../webgl/FramebufferObject","../../../../../webgl/TextureDescriptor"],(function(e,t,s,i,r,o){"use strict";const n=[1,0],a=[0,1],u=[1,.8,.6,.4,.2],l=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];e.Bloom=class{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad=t.disposeMaybe(this._quad),this._intensityFBO=t.disposeMaybe(this._intensityFBO),this._compositeFBO=t.disposeMaybe(this._compositeFBO),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,t,r){const{width:o,height:c}=t,{context:m,painter:p}=e,{materialManager:_}=p,h=m.gl,d=this._programDesc,{strength:f,radius:b,threshold:F}=r;this._quad||(this._quad=new s(m,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,o,c),m.setStencilTestEnabled(!1),m.setBlendingEnabled(!0),m.setBlendFunction(i.BlendFactor.ONE,i.BlendFactor.ONE_MINUS_SRC_ALPHA),m.setStencilWriteMask(0);const B=this._quad;B.bind(),m.bindFramebuffer(this._intensityFBO);const O=_.getProgram(d.luminosityHighPass);m.useProgram(O),m.bindTexture(t.colorTexture,0),O.setUniform1i("u_texture",0),O.setUniform3fv("u_defaultColor",[0,0,0]),O.setUniform1f("u_defaultOpacity",0),O.setUniform1f("u_luminosityThreshold",F),O.setUniform1f("u_smoothWidth",.01);const x=[Math.round(o/2),Math.round(c/2)];m.setViewport(0,0,x[0],x[1]),m.setClearColor(0,0,0,0),m.clear(h.COLOR_BUFFER_BIT),B.draw(),m.setBlendingEnabled(!1);let g=this._intensityFBO.colorTexture;for(let e=0;e<this._nMips;e++){const t=_.getProgram(d.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[e]}]);m.useProgram(t),m.bindTexture(g,e+1),t.setUniform1i("u_colorTexture",e+1),t.setUniform2fv("u_texSize",x),t.setUniform2fv("u_direction",n),m.setViewport(0,0,x[0],x[1]);const s=this._mipsFBOs[e];m.bindFramebuffer(s.horizontal),B.draw(),g=s.horizontal.colorTexture,m.bindFramebuffer(s.vertical),m.bindTexture(g,e+1),t.setUniform2fv("u_direction",a),B.draw(),g=s.vertical.colorTexture,x[0]=Math.round(x[0]/2),x[1]=Math.round(x[1]/2)}m.setViewport(0,0,o,c);const T=_.getProgram(d.composite,[{name:"nummips",value:5}]);m.bindFramebuffer(this._compositeFBO),m.useProgram(T),T.setUniform1f("u_bloomStrength",f),T.setUniform1f("u_bloomRadius",b),T.setUniform1fv("u_bloomFactors",u),T.setUniform3fv("u_bloomTintColors",l),m.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),T.setUniform1i("u_blurTexture1",1),m.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),T.setUniform1i("u_blurTexture2",2),m.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),T.setUniform1i("u_blurTexture3",3),m.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),T.setUniform1i("u_blurTexture4",4),m.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),T.setUniform1i("u_blurTexture5",5),B.draw(),m.bindFramebuffer(t),m.setBlendingEnabled(!0);const M=_.getProgram(d.blit);m.useProgram(M),m.bindTexture(this._compositeFBO.colorTexture,6),M.setUniform1i("u_texture",6),m.setBlendFunction(i.BlendFactor.ONE,i.BlendFactor.ONE),B.draw(),B.unbind(),m.setBlendFunction(i.BlendFactor.ONE,i.BlendFactor.ONE_MINUS_SRC_ALPHA),m.setStencilTestEnabled(!0)}_createOrResizeResources(e,t,s){const{context:n}=e;if(this._compositeFBO&&this._size[0]===t&&this._size[1]===s)return;this._size[0]=t,this._size[1]=s;const a=[Math.round(t/2),Math.round(s/2)];if(this._compositeFBO)this._compositeFBO.resize(t,s);else{const e=new o.TextureDescriptor(t,s);e.internalFormat=i.PixelFormat.RGBA,e.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,this._compositeFBO=new r.FramebufferObject(n,e)}if(this._intensityFBO)this._intensityFBO.resize(a[0],a[1]);else{const e=new o.TextureDescriptor(a[0],a[1]);e.internalFormat=i.PixelFormat.RGBA,e.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,this._intensityFBO=new r.FramebufferObject(n,e)}for(let e=0;e<this._nMips;e++){if(this._mipsFBOs[e])this._mipsFBOs[e].horizontal.resize(a[0],a[1]),this._mipsFBOs[e].vertical.resize(a[0],a[1]);else{const t=new o.TextureDescriptor(a[0],a[1]);t.internalFormat=i.PixelFormat.RGBA,t.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,this._mipsFBOs[e]={horizontal:new r.FramebufferObject(n,t),vertical:new r.FramebufferObject(n,t)}}a[0]=Math.round(a[0]/2),a[1]=Math.round(a[1]/2)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));