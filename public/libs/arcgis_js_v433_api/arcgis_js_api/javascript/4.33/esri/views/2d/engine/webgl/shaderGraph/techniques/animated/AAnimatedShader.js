// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../chunks/tslib.es6","../../../../../../../symbols/cim/animationDebugFlags","../../../animations/instructions","../../GraphShaderModule","../../graph/glsl","./AnimationUniformInfo","./enums","../markers/markerConstants","../shaders/AFeatureShader","../shaders/constants","../shaders/LocalTileOffset","../shaders/MosaicInfo","../shaders/utils","../shaders/VisualVariableColor","../shaders/VisualVariableOpacity","../shaders/VisualVariableRotation","../shaders/VisualVariableSizeMinMaxValue","../shaders/VisualVariableSizeScaleStops","../shaders/VisualVariableSizeStops","../shaders/VisualVariableSizeUnitValue","../shaders/vvUtils"],(function(t,e,i,a,o,l,n,s,r,u,c,d,p,m,y,V,b,S,g,_,f,v){"use strict";class h extends u.FeatureVertexInput{}e.__decorate([o.location(3,l.Vec2)],h.prototype,"offset",void 0),e.__decorate([o.location(4,l.Vec4)],h.prototype,"sizing",void 0),e.__decorate([o.location(5,l.Vec4)],h.prototype,"value1Position2Value2",void 0),e.__decorate([o.location(6,l.Vec4)],h.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),e.__decorate([o.location(7,l.Vec2)],h.prototype,"zoomRange",void 0),e.__decorate([o.location(8,l.Float)],h.prototype,"lineLength",void 0);class x extends u.FeatureFragmentInput{}class w extends u.AFeatureShader{_vertexPreamble(t,e,i){const{id:a,offset:o,animationPointerAndBaseSizeAndReferenceSize:n,sizing:u}=t,d=n.xy,p=n.z,y=n.w,V=u.xy,b=this._getEvalParams(t,V,i);let S,g;if(t.value1Position2Value2){const e=F(d,s.AnimationParamIndex.shift,b).a,i=t.pos,a=t.value1Position2Value2.yz,o=t.value1Position2Value2.x,n=t.value1Position2Value2.w,r=e.subtract(o).divide(n.subtract(o));g=i.add(a.subtract(i).multiply(r)),S=l.step(new l.Float(1),r).add(l.step(new l.Float(0),l.negate(r)))}else g=t.pos,S=new l.Float(0);const _=u.z,f=m.getBit(t.bitset,r.MarkerConstants.bitset.isStroke),h=u.w,x=m.getBit(t.bitset,r.MarkerConstants.bitset.scaleSymbolsProportionally),w=F(d,s.AnimationParamIndex.transform,b),z=l.cond([l.equal(m.getBit(t.bitset,r.MarkerConstants.bitset.isMapAligned),new l.Float(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new l.Float(0)]),P=new l.Mat2(l.cos(z),l.sin(z.multiply(-1)),l.sin(z),l.cos(z)).multiply(w.xy),T=w.z.subtract(z).subtract(e.multiply(c.c256ToRad)),M=w.w,I=m.getBit(t.bitset,r.MarkerConstants.bitset.isSDF),A=v.getVisualVariableSize(this,a,new l.Float(y)).divide(new l.Float(y));return{baseSize:p,animationPointer:d,strokeWidth:_,isOutline:f,unscaledDistanceToPx:h,scaleSymbolsProportionally:x,isSDF:I,position:this._getScreenPosition({id:a,pos:g,offset:o,referenceSize:y,translation:P,rotation:T,scale:M,vvScale:A}),evalParams:b,vvScale:A,scale:M,clip:S}}_getScreenPosition(t){const{pos:e,translation:i,rotation:a,scale:o,offset:n,id:s,vvScale:r}=t,u=v.getVisualVariableAngle(this,s).multiply(Math.PI/180),c=i.x.multiply(4/3),d=i.y.multiply(-1).multiply(4/3),p=l.sin(u),m=l.cos(u),y=m.multiply(c).add(l.negate(p).multiply(d)),V=p.multiply(c).add(m.multiply(d)),b=l.sin(a.subtract(u)),S=l.cos(a.subtract(u)),g=new l.Float(0),_=new l.Float(1),{pixelRatio:f}=this.animationInfo,h=new l.Mat3(_,g,g,g,_,g,y.multiply(f),V.multiply(f),_),x=new l.Mat3(S,b.multiply(-1),g,b,S,g,0,0,_),w=o.multiply(r).multiply(f).multiply(4/3),F=x.multiply(w),z=this.animationInfo.toScreen.multiply(new l.Vec3(e,1)),P=h.multiply(z).xy,T=F.multiply(new l.Vec3(n,0)).xy;return P.add(T)}_clip(t,e){let a=super.clip(t,e);const o=l.lessThanEqual(this._getLocalTimeOrigin(t),new l.Float(0));return i.animationDebugFlags.forceGlobalTimeOrigin||(a=a.add(l.cond([o,()=>new l.Float(2)],[!0,()=>new l.Float(0)]))),a}_getLocalTimeOrigin(t){return this.storage.getLocalTimeOrigin(t)}_toNdc(t){return this.animationInfo.toNdc.multiply(new l.Vec3(t,1)).xy}_getEvalParams(t,e,i){const{globalTime:a,animationTextureSize:o,animationTexture:l}=this.animationInfo;return{globalTime:a,localTimeOrigin:this._getLocalTimeOrigin(t.id),animationTextureSize:o,animationTexture:l,pixelDimensions:e,lineLength:i}}_getColor(t,e){return l.ifElse(l.equal(e.isSDF,new l.Float(1)),this._getSDFColor(t,e),this._getSpriteColor(t,e))}_getSpriteColor(t,e){return l.texture2D(this.mosaicInfo.texture,t).multiply(e.color)}_getSDFColor(t,e){const i=l.texture2D(this.mosaicInfo.texture,t),a=new l.Float(.5).subtract(m.rgba2float(i)).multiply(e.distanceToPx).multiply(c.softEdgeRatio),o=l.clamp(new l.Float(.5).subtract(a),new l.Float(0),new l.Float(1)),n=e.color.multiply(o),s=e.outlineSize.multiply(.5),r=l.abs(a).subtract(s),u=l.clamp(new l.Float(.5).subtract(r),new l.Float(0),new l.Float(1)),d=e.outlineColor.multiply(u);return new l.Float(1).subtract(d.a).multiply(n).add(d)}}function F(t,e,i){const o=t.add(new l.Vec2(e,0)),n=l.texture2D(i.animationTexture,o.add(.5).divide(i.animationTextureSize)).xy;return t=t.add(n),l.block({animationPointer:t,...i},l.Vec4,null,(t=>{const{out:e}=t;if(!e)throw new Error("out is null");return a.generateVirtualMachineSource({...t,out:e})}))}e.__decorate([o.uniform(p.MosaicInfo)],w.prototype,"mosaicInfo",void 0),e.__decorate([o.uniform(n.AnimationUniformInfo)],w.prototype,"animationInfo",void 0),e.__decorate([o.uniform(d.LocalTileOffset)],w.prototype,"localTileOffset",void 0),e.__decorate([o.option(y.VisualVariableColor)],w.prototype,"visualVariableColor",void 0),e.__decorate([o.option(V.VisualVariableOpacity)],w.prototype,"visualVariableOpacity",void 0),e.__decorate([o.option(S.VisualVariableSizeMinMaxValue)],w.prototype,"visualVariableSizeMinMaxValue",void 0),e.__decorate([o.option(g.VisualVariableSizeScaleStops)],w.prototype,"visualVariableSizeScaleStops",void 0),e.__decorate([o.option(_.VisualVariableSizeStops)],w.prototype,"visualVariableSizeStops",void 0),e.__decorate([o.option(f.VisualVariableSizeUnitValue)],w.prototype,"visualVariableSizeUnitValue",void 0),e.__decorate([o.option(b.VisualVariableRotation)],w.prototype,"visualVariableRotation",void 0),t.AAnimatedFragmentInput=x,t.AAnimatedShader=w,t.AAnimatedVertexInput=h,t.getValue=F,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));