// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../chunks/tslib.es6","../../../../../../../symbols/cim/animationDebugFlags","../../GraphShaderModule","../../graph/glsl","./AAnimatedShader","./enums","../markers/markerConstants","../shaders/hittestUtils","../shaders/utils","../shaders/vvUtils"],(function(e,t,i,a,o,n,l,s,r,d,c){"use strict";class u extends n.AAnimatedVertexInput{}t.__decorate([a.location(9,o.Vec2)],u.prototype,"uv",void 0),t.__decorate([a.location(10,o.Float)],u.prototype,"angle",void 0);class m extends a.ComputeVertexInput{}t.__decorate([a.location(11,o.Vec2)],m.prototype,"offsetNextVertex1",void 0),t.__decorate([a.location(12,o.Vec2)],m.prototype,"offsetNextVertex2",void 0),t.__decorate([a.location(13,o.Vec2)],m.prototype,"textureUVNextVertex1",void 0),t.__decorate([a.location(14,o.Vec2)],m.prototype,"textureUVNextVertex2",void 0);class p extends n.AAnimatedFragmentInput{}function h(e,t,i,a){return t.multiply(e.x).add(i.multiply(e.y)).add(a.multiply(e.z))}class x extends n.AAnimatedShader{constructor(){super(...arguments),this.type="AnimatedMarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=e.uv.divide(this.mosaicInfo.size),{position:a,animationPointer:r,evalParams:u,isOutline:m,unscaledDistanceToPx:p,vvScale:h,strokeWidth:x,scaleSymbolsProportionally:y,scale:g,isSDF:V,baseSize:_,clip:f}=this._vertexPreamble(e,e.angle,e.lineLength||new o.Float(0)),v=this._toNdc(a);let w=n.getValue(r,l.AnimationParamIndex.fromColor,u);w=new o.Vec4(w.rgb.multiply(w.a),w.a);let T=n.getValue(r,l.AnimationParamIndex.toColor,u);T=new o.Vec4(T.rgb.multiply(T.a),T.a);let S=n.getValue(r,l.AnimationParamIndex.colorMix,u);S=new o.Vec4(S.rgb.multiply(S.a),S.a);const b=n.getValue(r,l.AnimationParamIndex.toOpacity,u).a,F=n.getValue(r,l.AnimationParamIndex.opacityMix,u).a,P=c.getVisualVariableColor(this,e.id,w,o.or(d.getBitBool(e.bitset,s.MarkerConstants.bitset.colorLocked),new o.Bool(m))),C=o.mix(P,T,S),A=c.getVisualVariableOpacity(this,e.id),M=o.mix(A,b,F),k=C.multiply(M),z=this.clip(e.id,e.zoomRange).add(f.multiply(2)),I=p.multiply(h);return{glPosition:new o.Vec4(v,z,1),uv:i,color:k.multiply(new o.Float(1).subtract(m)),outlineColor:k.multiply(m),distanceToPx:I,strokeWidth:x.multiply(o.mix(new o.Float(1),g,y)),isOutline:m,isSDF:V,...this.maybeRunHittest(e,t,{pos:e.pos,size:_,sizeCorrection:new o.Float(1),isMapAligned:new o.Float(1),vvRotationMat3:new o.Mat3(1,0,0,0,1,0,0,0,1),placementMat3:new o.Mat3(1,0,0,0,1,0,0,0,1),outlineSize:new o.Float(1),distanceToPx:I,isSDF:V})}}fragment(e){let t=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return i.animationDebugFlags.spotlightAnimatedSymbols&&(t=t.add(new o.Vec4(0,.3,0,.3))),this.getFragmentOutput(t,e)}hittest(e,t,i){return o.ifElse(o.lessThan(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_hittestSmallMarker(e,t,i){const{position:a,distance:n,smallSymbolDistance:l}=this.hittestRequest,s=n.subtract(l),{viewMat3:r,tileMat3:d}=this.view,c=r.multiply(d).multiply(new o.Vec3(i.pos,1)).xy,u=i.size.multiply(.5);return o.distance(c,a).subtract(u).add(s)}_hittestMarker(e,t,i){const a=this._vertexPreamble({...e},e.angle,new o.Float(0)).position,n=this._vertexPreamble({...e,offset:t.offsetNextVertex1},e.angle,new o.Float(0)).position,l=this._vertexPreamble({...e,offset:t.offsetNextVertex2},e.angle,new o.Float(0)).position,s=this.hittestRequest.position,d=this.hittestRequest.distance,c=r.distPointTriangle(s,a,n,l);return o.ifElse(o.greaterThan(c,d),c,this._hittestSamples(a,n,l,e,t,i))}_hittestSamples(e,t,i,a,n,l){const{outlineSize:s,isSDF:d,distanceToPx:c}=l,u=this.hittestRequest.position,m=this.hittestRequest.distance,p=r.xyToBarycentric(u.add(new o.Vec2(o.negate(m),o.negate(m))),e,t,i),x=r.xyToBarycentric(u.add(new o.Vec2(0,o.negate(m))),e,t,i),y=r.xyToBarycentric(u.add(new o.Vec2(m,o.negate(m))),e,t,i),g=r.xyToBarycentric(u.add(new o.Vec2(o.negate(m),0)),e,t,i),V=r.xyToBarycentric(u,e,t,i),_=r.xyToBarycentric(u.add(new o.Vec2(m,0)),e,t,i),f=r.xyToBarycentric(u.add(new o.Vec2(o.negate(m),m)),e,t,i),v=r.xyToBarycentric(u.add(new o.Vec2(0,m)),e,t,i),w=r.xyToBarycentric(u.add(new o.Vec2(m,m)),e,t,i),T=a.uv.divide(this.mosaicInfo.size),S=n.textureUVNextVertex1.divide(this.mosaicInfo.size),b=n.textureUVNextVertex2.divide(this.mosaicInfo.size),F={color:new o.Vec4(1,1,1,1),outlineSize:s,outlineColor:new o.Vec4(1,1,1,1),isSDF:d,distanceToPx:c};let P=new o.Float(0);return P=P.add(r.inTriangle(p).multiply(this._getColor(h(p,T,S,b),F).a)),P=P.add(r.inTriangle(x).multiply(this._getColor(h(x,T,S,b),F).a)),P=P.add(r.inTriangle(y).multiply(this._getColor(h(y,T,S,b),F).a)),P=P.add(r.inTriangle(g).multiply(this._getColor(h(g,T,S,b),F).a)),P=P.add(r.inTriangle(V).multiply(this._getColor(h(V,T,S,b),F).a)),P=P.add(r.inTriangle(_).multiply(this._getColor(h(_,T,S,b),F).a)),P=P.add(r.inTriangle(f).multiply(this._getColor(h(f,T,S,b),F).a)),P=P.add(r.inTriangle(v).multiply(this._getColor(h(v,T,S,b),F).a)),P=P.add(r.inTriangle(w).multiply(this._getColor(h(w,T,S,b),F).a)),o.step(P,new o.Float(.05)).multiply(r.failHittest(this.hittestRequest))}}t.__decorate([t.__param(0,a.input(u)),t.__param(1,a.input(m))],x.prototype,"vertex",null),t.__decorate([t.__param(0,a.input(p))],x.prototype,"fragment",null),e.AnimatedMarkerFragmentInput=p,e.AnimatedMarkerShader=x,e.AnimatedMarkerVertexInput=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));