// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../core/screenUtils","../../../../../../../geometry/GeometryCursor","../../../../../../../symbols/cim/enums","../../../definitions","../../../TurboLine","../../../mesh/templates/templateUtils","./AnimatedMeshWriter","./attributes","./ComputedAnimatedParams","../fill/meshWriterUtils","../line/LineMeshWriter"],(function(e,t,i,s,n,r,a,o,l,h,u,d){"use strict";class m extends o.AAnimatedMeshWriter{_write(e,t,s){const n=s??i.GeometryCursor.fromFeatureSetReaderCIM(t);if(!n)return;const r=this.evaluatedMeshParams.sprite,{textureBinding:a}=r;e.recordStart(this.instanceId,this.attributeLayout,a);const o=t.getDisplayId();this._writePoly(e,o,n.asOptimized()),e.recordEnd()}}class c{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0,this.pathLength=0}}e.AAnimatedPolyMeshWriter=m,e.AnimatedFillMeshWriter=class extends m{constructor(){super(...arguments),this.vertexSpec={createComputedParams:h.createComputedAnimatedMeshParams,attributes:{id:l.id,bitset:l.bitset,pos:l.pos,offset:l.offset.fill,tlbr:l.tlbr,animationPointerAndBaseSizeAndReferenceSize:l.animationPointerAndBaseSizeAndReferenceSize,sizing:l.sizing},optionalAttributes:{zoomRange:l.zoomRange,value1Position2Value2:l.noTiming,lineLength:l.noLineLength}}}_writePoly(e,t,i){const s=[];if(!a.triangulate(s,i))return;const n=e.vertexCount();i.forEachVertex(((i,s)=>{this._writeVertex(e,t,i,s)})),e.indexEnsureSize(s.length);for(const t of s)e.indexWrite(n+t)}},e.AnimatedLineMeshWriter=class extends m{constructor(){super(...arguments),this.vertexSpec={createComputedParams:h.createComputedAnimatedMeshParams,attributes:{id:l.id,bitset:l.bitset,pos:l.pos,offset:l.offset.line,tlbr:l.tlbr,animationPointerAndBaseSizeAndReferenceSize:l.animationPointerAndBaseSizeAndReferenceSize,sizing:l.sizing,accumulatedDistance:l.accumulatedDistance,normal:l.normal,segmentDirection:l.segmentDirection},optionalAttributes:{zoomRange:l.zoomRange,value1Position2Value2:l.noTiming,lineLength:l.lineLength}},this._tessParams=new d.LineTessellationParams,this._currentWrite=new c,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:65535,textured:!1},this._lineLength=0,this._lineTessellator=new r.LineTessellation(((e,t,i,s,n,r,a,o,l,h,u)=>this._writeTesselatedVertex(e,t,i,s,n,r,a,o,l,h,u,this._lineLength)),this._writeTriangle.bind(this),!1)}_writePoly(e,n,r){const o=a.clipLinesMarshall(i.GeometryCursor.fromOptimized(r,"esriGeometryPolyline"),64);if(null==o)return;const{_currentWrite:l,_tessellationOptions:h}=this,{baseSize:d,capType:m,joinType:c,miterLimit:p}=this.evaluatedMeshParams,f=t.pt2px(.5*d);h.halfWidth=f,h.capType=u.processLineCapInput(m||s.LineCapStyle.Round),h.joinType=u.processLineJoinInput(c||s.LineJoinStyle.Round),h.miterLimit=p||2,l.out=e,l.id=n,l.vertexCount=0,l.indexCount=0,l.vertexFrom=e.vertexCount(),l.vertexBounds=1;for(const{line:e,start:t,pathLength:i}of o){h.initialDistance=t%65535,l.pathLength=i,this._lineLength=0;for(let t=1;t<e.length;t++){const i=e[t].x-e[t-1].x,s=e[t].y-e[t-1].y;this._lineLength+=Math.sqrt(i*i+s*s)}this._lineTessellator.tessellate(e,h,!1)}}_writeTesselatedVertex(e,t,i,s,n,r,a,o,l,h,u,d){const{out:m,id:c,vertexBounds:p,pathLength:f}=this._currentWrite;return this.hasEffects&&m.recordBounds(e,t,p,p),this._tessParams.extrusionOffsetX=a,this._tessParams.extrusionOffsetY=o,this._tessParams.normalX=l,this._tessParams.normalY=h,this._tessParams.directionX=n,this._tessParams.directionY=r,this._tessParams.distance=u,this._tessParams.pathLength=f,this._tessParams.lineLength=d,this._writeVertex(m,c,e,t,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(e,t,i){const{out:s}=this._currentWrite;s.indexEnsureSize(3),s.indexWrite(e),s.indexWrite(t),s.indexWrite(i),this._currentWrite.indexCount+=3}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));