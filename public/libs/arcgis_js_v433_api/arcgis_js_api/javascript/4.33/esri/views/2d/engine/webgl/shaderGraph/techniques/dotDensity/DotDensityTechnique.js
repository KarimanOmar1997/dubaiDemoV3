// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../definitions","../FeatureTechnique","../featureTechniqueUtils","../TechniqueType","./DotDensityPointShader","./DotDensityPolygonShader","./DotDensityResources","../shaders/FillShader","../../../../../../webgl/enums"],(function(e,t,i,r,s,o,n,a,l,u){"use strict";class d extends i.FeatureTechnique{constructor(){super(...arguments),this.type=s.TechniqueType.DotDensity,this.shaders={polygon:new n.DotDensityPolygonShader,point:new o.DotDensityPointShader,fill:new l.FillShader},this._resources=new Map}render(e,t){r.isHighlight(e)||r.isHittest(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:{...r.getFeatureUniforms(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...r.getSelectionDefines(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:r.isHittest(e)}),i.setPipelineState(r.getFeaturePipelineState(e)),i.submitDraw(e,t)}_renderDotDensity(e,i){const{context:s,painter:o,requiredLevel:n}=e,a=i.instance.getInput().uniforms,l=this._getOrCreateResourcesRecord(s),d=l.getDotDensityTextures(s,t.tileSize,a.seed),c=1/2**(n-i.target.key.level),h=t.tileSize,g=h*window.devicePixelRatio*h*window.devicePixelRatio,p=1/c*(1/c),f=a.dotScale?e.state.scale/a.dotScale:1,w=a.dotValue*f*p;o.setShader({shader:this.shaders.polygon,uniforms:{...r.getFeatureUniforms(e,i.target),instance:{isActive:a.isActive,colors:a.colors,dotValue:Math.max(1,w)},draw:{dotTexture0:{unit:t.textureBindingRenderer0,texture:d[0]},dotTexture1:{unit:t.textureBindingRenderer1,texture:d[1]},tileZoomFactor:c,pixelRatio:window.devicePixelRatio,tileDotsOverArea:g/(t.tileSize*window.devicePixelRatio*t.tileSize*window.devicePixelRatio)}},defines:{...r.getSelectionDefines(e),blending:a.blending},optionalAttributes:{},useComputeBuffer:!1});const D=s.getViewport();s.setViewport(0,0,t.tileSize,t.tileSize);const S=s.getBoundFramebufferObject(),y=l.getFBO(s);s.bindFramebuffer(y),s.setClearColor(0,0,0,0),s.clear(u.FramebufferBit.COLOR),o.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),o.updatePipelineState(s),o.submitDraw(e,i),s.bindFramebuffer(S),s.setViewport(D.x,D.y,D.width,D.height);const m=l.getFBO(s).colorTexture,x={shader:this.shaders.point,uniforms:{view:r.getViewUniforms(e,i.target),instance:{dotSize:a.dotSize},draw:{locations:{unit:t.textureBindingRenderer0,texture:m},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...r.getSelectionDefines(e)},optionalAttributes:{},useComputeBuffer:!1};o.setPipelineState(r.getFeaturePipelineState(e)),o.submitDrawMesh(s,x,l.getDotDensityMesh(s))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new a.DotDensityResources,this._resources.set(e,t)),t}}e.DotDensityTechnique=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));