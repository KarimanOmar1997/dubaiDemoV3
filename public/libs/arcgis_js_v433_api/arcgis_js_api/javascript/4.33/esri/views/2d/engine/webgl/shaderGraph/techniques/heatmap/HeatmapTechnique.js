// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../enums","../FeatureTechnique","../featureTechniqueUtils","../TechniqueType","./HeatmapResources","../shaders/HeatmapAccumulateShader","../shaders/HeatmapResolveShader","../../../../../../webgl/enums"],(function(e,t,r,s,i,n,u,a,o){"use strict";class c extends r.FeatureTechnique{constructor(){super(...arguments),this.type=i.TechniqueType.Heatmap,this.drawPhase=t.WGLDrawPhase.MAP|t.WGLDrawPhase.HITTEST|t.WGLDrawPhase.DEBUG,this.shaders={accumulate:new u.HeatmapAccumulateShader,resolve:new a.HeatmapResolveShader},this._isBound=!1,this._resources=new Map}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:r,painter:i,state:n}=e,u=t.instance.getInput(),{isFieldActive:a}=u.uniforms,o=this._getOrCreateResourcesRecord(r),c=o.loadQualityProfile(r);s.isHittest(e)||this._bind(e,o,u),i.setShader({shader:this.shaders.accumulate,uniforms:{...s.getFeatureUniforms(e,t.target),kernelControls:{radius:f(u,n),isFieldActive:a?1:0}},defines:{...s.getSelectionDefines(e),...c.defines},optionalAttributes:{},useComputeBuffer:s.isHittest(e)});const l=s.isHittest(e)?h:d;i.setPipelineState(l),i.submitDraw(e,t)}getStencilReference(e){return l(e)}renderResolvePass(e,t){if(s.isHittest(e))return;const{context:r,painter:i}=e,n=this._resources.get(r);if(null==this._prevFBO||null==this._prevViewport||!n?.initialized)return;const{defines:u}=n.loadQualityProfile(r),{minDensity:a,maxDensity:o,radius:c}=t.getInput().uniforms,l=n.accumulateFramebuffer,d=n.resolveGradientTexture,h={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:8,texture:l.colorTexture},minAndInvRange:[a,1/(o-a)],normalization:3/(c*c*Math.PI)},gradient:{texture:{unit:9,texture:d}}},defines:u,optionalAttributes:{},useComputeBuffer:!1};r.bindFramebuffer(this._prevFBO),r.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),r.bindTexture(l.colorTexture,8),r.bindTexture(d,9),i.setPipelineState(p),i.submitDrawMesh(r,h,i.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new n.HeatmapResources,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,r){if(this._isBound)return;const{context:s,state:i,pixelRatio:n}=e,u=s.getBoundFramebufferObject(),a=s.getViewport();this._prevFBO=u,this._prevViewport=a;const{gradient:c,gradientHash:l}=r.uniforms;t.ensureResolveGradientTexture(s,l,c);const{width:d,height:h}=a,p=function(e,t){const r=t>1.5?.25:.5;return e<1/(2*r)?1:r}(f(r,i),n),m=d*p,b=h*p,w=t.ensureAccumulateFBO(s,m,b);s.blitFramebuffer(u,w,o.FramebufferBit.STENCIL),s.bindFramebuffer(w),s.setViewport(0,0,w.width,w.height),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(o.FramebufferBit.COLOR),this._isBound=!0}}function l(e){return e.key.level+1}const d={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:l,compare:o.CompareFunction.GEQUAL,mask:255,op:{fail:o.StencilOperation.KEEP,zFail:o.StencilOperation.KEEP,zPass:o.StencilOperation.REPLACE}}}},h={...d,stencil:!1},p={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function f(e,t){const{referenceScale:r,radius:s}=e.uniforms;return s*(0!==r?r/t.scale:1)}e.HeatmapTechnique=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));