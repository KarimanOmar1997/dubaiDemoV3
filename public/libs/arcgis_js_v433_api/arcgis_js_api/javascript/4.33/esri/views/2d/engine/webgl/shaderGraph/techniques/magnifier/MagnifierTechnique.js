// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../core/mathUtils","../../../../../../../core/maybe","../../../../../../../core/urlUtils","../../utils","../Technique","../TechniqueType","../shaders/MagnifierShader","../../../../../../webgl/enums","../../../../../../webgl/Texture","../../../../../../webgl/TextureDescriptor"],(function(e,t,i,r,s,o,a,n,u,l,h){"use strict";class c extends o.Technique{constructor(){super(...arguments),this.type=a.TechniqueType.Magnifier,this._resourcePixelRatio=1,this._position=[0,0,0,0],this.shaders={magnifier:new n.MagnifierShader}}updateResources(e,i,r,s){e.pixelRatio!==this._resourcePixelRatio&&this._destroyResources(),this._readbackTexture||this._initializeResources(e,i,r,s);const{context:o,pixelRatio:a}=e,{factor:n,offset:u,position:l}=s,{size:h}=e.state,c=s.size*a,x=1/n,p=Math.ceil(x*c);this._readbackTexture.resize(p,p);const d=a*h[0],T=a*h[1],m=.5*p,_=.5*p,g=t.clamp(a*l.x,m,d-m-1),y=t.clamp(T-a*l.y,_,T-_-1),M=g-m,b=y-_,f=this._readbackTexture;o.bindTexture(f,0),o.gl.copyTexImage2D(f.descriptor.target,0,f.descriptor.pixelFormat,M,b,p,p,0);const R=(g+u.x*a)/d*2-1,w=(y-u.y*a)/T*2-1,k=c/d*2,P=c/T*2;this._position[0]=R,this._position[1]=w,this._position[2]=k,this._position[3]=P}render(e,t){const{context:i,painter:r}=e;r.setPipelineState(s.simplePipelineState);const o={readbackTexture:{texture:this._readbackTexture,unit:0},maskTexture:{texture:this._maskTexture,unit:7},overlayTexture:{texture:this._overlayTexture,unit:6},drawPos:this._position,...t};r.submitDrawMesh(i,{shader:this.shaders.magnifier,uniforms:{config:o},defines:null,optionalAttributes:null,useComputeBuffer:!1},r.quadMesh)}shutdown(){this._destroyResources()}_initializeResources(e,t,i,s){const o=e.context;this._resourcePixelRatio=e.pixelRatio;const a=Math.ceil(s.size*e.pixelRatio);i.width=a,i.height=a;const n=new h.TextureDescriptor;n.internalFormat=u.PixelFormat.RGBA,n.wrapMode=u.TextureWrapMode.CLAMP_TO_EDGE,n.samplingMode=u.TextureSamplingMode.NEAREST,n.flipped=!0,n.preMultiplyAlpha=!r.isSVG(i.src)||!e.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new l.Texture(o,n,i),t.width=a,t.height=a,n.pixelFormat=n.internalFormat=u.PixelFormat.ALPHA,this._maskTexture=new l.Texture(o,n,t);const c=1/s.factor;n.pixelFormat=n.internalFormat=u.PixelFormat.RGBA,n.width=n.height=Math.ceil(c*a),n.samplingMode=u.TextureSamplingMode.LINEAR,n.flipped=!1,this._readbackTexture=new l.Texture(o,n)}_destroyResources(){i.disposeMaybe(this._maskTexture),i.disposeMaybe(this._overlayTexture),i.disposeMaybe(this._readbackTexture),this._maskTexture=null,this._overlayTexture=null,this._readbackTexture=null}}e.MagnifierTechnique=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));