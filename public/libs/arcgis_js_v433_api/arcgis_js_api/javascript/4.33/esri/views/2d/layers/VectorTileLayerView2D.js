// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
require({cache:{"esri/views/2d/engine/vectorTiles/TileHandler":function(){define(["exports","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../core/workers/workers","./enums","./GlyphMosaic","./GlyphSource","./SpriteMosaic","../../tiling/TileKey"],(function(e,t,i,r,s,n,a,o,l,c){"use strict";e.TileHandler=class{constructor(e,t,i,r){this._layer=e,this._styleRepository=t,this.devicePixelRatio=i,this._sourceDataMaxLOD=r,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=t.abortMaybe(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}get glyphMosaic(){return this._glyphMosaic}async start(e){this._requestSprite(e);const t=this._layer.currentStyleInfo.glyphsUrl,n=new o(t?r.addQueryParameters(t,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new a(1024,1024,n),this._broadcastPromise=s.open("WorkerTileHandler",{client:this,schedule:e.schedule,signal:e.signal}).then((t=>{if(this._layer&&(this._connection?.close(),this._connection=t,this._layer&&!this._connection.closed)){const r=t.broadcast("setStyle",{style:this._layer.currentStyleInfo.style,sourceDataMaxLOD:this._sourceDataMaxLOD},e);Promise.all(r).catch((e=>i.throwIfNotAbortError(e)))}}))}_requestSprite(e){this._spriteSourceAbortController?.abort();const t=new AbortController;this._spriteSourceAbortController=t;const r=e?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,r&&(this._inputSignalEventListener=function(e){return()=>e.abort()}(t),r.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:s}=t,n={...e,signal:s};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,n),this._spriteSourcePromise.then((e=>{i.throwIfAbortError(s),this._spriteMosaic=new l(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}))}async updateStyle(e){const t=[];for(const i of e)i.type===n.StyleUpdateType.SPRITES_CHANGED?t.push({type:n.StyleUpdateType.SPRITES_CHANGED,data:{spriteSource:null}}):t.push(i);return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",t)),this._broadcastPromise}setSpriteSource(e){const t=new l(1024,1024,250);return t.setSpriteSource(e),this._spriteMosaic=t,this._spriteSourcePromise=Promise.resolve(e),this._spriteSourceAbortController=null,t}async setStyle(e,t,i){await this._broadcastPromise,this._styleRepository=e,this._sourceDataMaxLOD=i,this._requestSprite();const s=new o(this._layer.currentStyleInfo.glyphsUrl?r.addQueryParameters(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new a(1024,1024,s),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",{style:t,sourceDataMaxLOD:this._sourceDataMaxLOD})),this._broadcastPromise}async fetchTileData(e,t){const i=await this._getRefKeys(e,t);return this._getSourcesData(Object.keys(this._layer.sourceNameToSource),i,t)}async fetchTilePBFs(e){const t=Object.keys(this._layer.sourceNameToSource),i={},r=await this._getRefKeys(e,i),s=[],n=[];for(let e=0;e<r.length;e++)if(null==r[e].value||null==t[e])n.push(null);else{const a=r[e].value,o=this._getTilePayload(a,t[e],i);o.then((e=>{s.push({...e,key:a})})),n.push(o)}return Promise.all(n).then((()=>s))}async parseTileData(e,t){const i=e&&e.data;if(!i)return null;const{sourceName2DataAndRefKey:r,transferList:s}=i;return 0===Object.keys(r).length?null:this._broadcastPromise.then((()=>this._connection.invoke("createTileAndParse",{key:e.key.id,sourceName2DataAndRefKey:r,styleLayerUIDs:e.styleLayerUIDs},{...t,transferList:s})))}async getSprites(e){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(e)}getGlyphs(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)}async _getTilePayload(e,t,r){const s=c.pool.acquire(e.id),n=this._layer.sourceNameToSource[t],{level:a,row:o,col:l}=s;c.pool.release(s);try{return{protobuff:await n.requestTile(a,o,l,r),sourceName:t}}catch(e){if(i.isAbortError(e))throw e;return{protobuff:null,sourceName:t}}}async _getRefKeys(e,t){const r=this._layer.sourceNameToSource,s=new Array;for(const i in r){const n=r[i].getRefKey(e,t);s.push(n)}return i.eachAlways(s)}_getSourcesData(e,t,r){const s=[];for(let i=0;i<t.length;i++)if(null==t[i].value||null==e[i])s.push(null);else{const n=t[i].value,a=this._getTilePayload(n,e[i],r);s.push(a)}return i.eachAlways(s).then((e=>{const i={},r=[];for(let s=0;s<e.length;s++){const n=e[s].value;if(n&&n.protobuff&&n.protobuff.byteLength>0){const e=t[s].value.id;i[n.sourceName]={refKey:e,protobuff:n.protobuff},r.push(n.protobuff)}}return{sourceName2DataAndRefKey:i,transferList:r}}))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/GlyphMosaic":function(){define(["./RectangleBinPack","../webgl/Rect","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,i,r,s){"use strict";return class{constructor(t,i,r){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=i,this._glyphSource=r,this._binPack=new e(t-4,i-4),this._glyphData.push(new Uint8Array(t*i)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(i,r){const s=[],n=this._glyphSource,a=new Set,o=1/256;for(const e of r){const t=Math.floor(e*o);a.add(t)}const l=[];return a.forEach((e=>{const t=i+e;if(this._rangePromises.has(t))l.push(this._rangePromises.get(t));else{const r=n.getRange(i,e).then((()=>{this._rangePromises.delete(t)}),(()=>{this._rangePromises.delete(t)}));this._rangePromises.set(t,r),l.push(r)}})),Promise.all(l).then((()=>{let a=this._glyphIndex[i];a||(a={},this._glyphIndex[i]=a);for(const o of r){const r=a[o];if(r){s[o]={sdf:!0,rect:r.rect,metrics:r.metrics,page:r.page,code:o};continue}const l=n.getGlyph(i,o);if(!l?.metrics)continue;const c=l.metrics;let h;if(0===c.width)h=new t(0,0,0,0);else{const t=3,i=c.width+2*t,r=c.height+2*t;let s=i%4?4-i%4:4,n=r%4?4-r%4:4;1===s&&(s=5),1===n&&(n=5),h=this._binPack.allocate(i+s,r+n),h.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new e(this.width-4,this.height-4),h=this._binPack.allocate(i+s,r+n));const a=this._glyphData[this._currentPage],o=l.bitmap;let u,p;if(o)for(let e=0;e<r;e++){u=i*e,p=this.width*(h.y+e+1)+h.x;for(let e=0;e<i;e++)a[p+e+1]=o.at(u+e)}}a[o]={rect:h,metrics:c,tileIDs:null,page:this._currentPage},s[o]={sdf:!0,rect:h,metrics:c,page:this._currentPage,code:o},this._dirties[this._currentPage]=!0}return s}))}removeGlyphs(e){for(const t in this._glyphIndex){const i=this._glyphIndex[t];if(!i)continue;let r;for(const t in i)if(r=i[t],r.tileIDs.delete(e),0===r.tileIDs.size){const e=this._glyphData[r.page],s=r.rect;let n,a;for(let t=0;t<s.height;t++)for(n=this.width*(s.y+t)+s.x,a=0;a<s.width;a++)e[n+a]=0;delete i[t],this._dirties[r.page]=!0}}}bind(e,t,n,a=0){if(!this._textures[n]){const t=new s.TextureDescriptor;t.pixelFormat=i.PixelFormat.ALPHA,t.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,t.width=this.width,t.height=this.height,this._textures[n]=new r.Texture(e,t,new Uint8Array(this.width*this.height))}const o=this._textures[n];o.setSamplingMode(t),this._dirties[n]&&o.setData(this._glyphData[n]),e.bindTexture(o,a),this._dirties[n]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0}}}))},"esri/views/2d/engine/vectorTiles/RectangleBinPack":function(){define(["../webgl/Rect"],(function(e){"use strict";return class{constructor(t,i){this._width=0,this._height=0,this._free=[],this._width=t,this._height=i,this._free.push(new e(0,0,t,i))}get width(){return this._width}get height(){return this._height}allocate(t,i){if(t>this._width||i>this._height)return new e;let r=null,s=-1;for(let e=0;e<this._free.length;++e){const n=this._free[e];t<=n.width&&i<=n.height&&(null===r||n.y<=r.y&&n.x<=r.x)&&(r=n,s=e)}return null===r?new e:(this._free.splice(s,1),r.width<r.height?(r.width>t&&this._free.push(new e(r.x+t,r.y,r.width-t,i)),r.height>i&&this._free.push(new e(r.x,r.y+i,r.width,r.height-i))):(r.width>t&&this._free.push(new e(r.x+t,r.y,r.width-t,r.height)),r.height>i&&this._free.push(new e(r.x,r.y+i,t,r.height-i))),new e(r.x,r.y,t,i))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}}))},"esri/views/2d/engine/vectorTiles/GlyphSource":function(){define(["../../../../request","../../../../core/pbf"],(function(e,t){"use strict";class i{constructor(e){if(this._metrics=[],!e)return void(this._allBitmaps=null);const t=new Map;let i=0;for(;e.next();)switch(e.tag()){case 1:{const r=e.getMessage();for(;r.next();)switch(r.tag()){case 3:{const e=r.getMessage();let s,n,a,o,l,c,h;for(;e.next();)switch(e.tag()){case 1:s=e.getUInt32();break;case 2:n=e.getBytes();break;case 3:a=e.getUInt32();break;case 4:o=e.getUInt32();break;case 5:l=e.getSInt32();break;case 6:c=e.getSInt32();break;case 7:h=e.getUInt32();break;default:e.skip()}if(e.release(),s){const e=n?.length??0;this._metrics[s]={width:a,height:o,left:l,top:c,advance:h,startOffset:i,length:e},t.set(s,n),i+=e}break}default:r.skip()}r.release();break}default:e.skip()}const r=new Uint8Array(i),s=this._metrics;for(const[e,i]of t){const{startOffset:t,length:n}=s[e];if(i)for(let e=0;e<n;++e)r[t+e]=i[e]}this._allBitmaps=r}getMetrics(e){return this._metrics[e]}getBitmap(e){if(!this._allBitmaps)return;const t=this._metrics[e];if(void 0===t)return;const{startOffset:i,length:r}=t;return 0!==r?new s(this._allBitmaps,i,r):void 0}}class r{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class s{constructor(e,t,i){this._array=e,this._start=t,this.length=i}at(e){return 0<=e&&e<this.length?this._array[this._start+e]:void 0}}return class{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(r,s){const n=this._getFontStack(r);if(n.getRange(s))return Promise.resolve();const a=256*s,o=a+255;if(this._baseURL){const l=this._baseURL.replace("{fontstack}",r).replace("{range}",a+"-"+o);return e(l,{responseType:"array-buffer"}).then((e=>{n.addRange(s,new i(new t(new Uint8Array(e.data),new DataView(e.data))))})).catch((()=>{n.addRange(s,new i)}))}return n.addRange(s,new i),Promise.resolve()}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const r=Math.floor(t/256),s=i.getRange(r);return s?{metrics:s.getMetrics(t),bitmap:s.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new r),t}}}))},"esri/views/2d/engine/vectorTiles/SpriteMosaic":function(){define(["../../../../core/has","../../../../symbols/cim/rasterizingUtils","./RectangleBinPack","../webgl/Rect","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,i,r,s,n,a){"use strict";class o{constructor(e,t,r=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,t<=0&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=t,r>0&&(this._maxItemSize=r),this._binPack=new i(e-4,t-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(const e of this._textures)e&&e.dispose();this._textures.length=0}getWidth(e){return e>=this._size.length?-1:this._size[e][0]}getHeight(e){return e>=this._size.length?-1:this._size[e][1]}getPageSize(e){return e>=this._size.length?null:this._size[e]}setSpriteSource(e){if(this.dispose(),this.pixelRatio=e.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new i(this._pageWidth-4,this._pageHeight-4);const e=Math.floor(this._pageWidth),t=Math.floor(this._pageHeight),r=new Uint32Array(e*t);this._mosaicsData[0]=r,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=e}getSpriteItem(e,t=!1){let i,r,s=this._mosaicRects[e];if(s)return s;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;if(e&&e.startsWith("dasharray-")?([i,r]=this._rasterizeDash(e),t=!0):i=this._sprites.getSpriteInfo(e),!i?.width||!i.height||i.width<0||i.height<0)return null;const n=i.width,a=i.height,[o,l,c]=this._allocateImage(n,a);return o.width<=0?null:(this._copy(o,i,l,c,t,r),s={type:"sprite",rect:o,width:n,height:a,sdf:i.sdf,simplePattern:!1,rasterizationScale:i.pixelRatio??1,samplingMode:"Linear",page:l},this._mosaicRects[e]=s,s)}getSpriteItems(e){const t={};for(const i of e)t[i.name]=this.getSpriteItem(i.name,i.repeat);return t}getMosaicItemPosition(e,t){const i=this.getSpriteItem(e,t),r=i?.rect;if(!r)return null;r.width=i.width,r.height=i.height;const s=i.width,n=i.height;return{tl:[r.x+2,r.y+2],br:[r.x+2+s,r.y+2+n],page:i.page}}bind(e,t,i=0,r=0){if(i>=this._size.length||i>=this._mosaicsData.length)return;if(!this._textures[i]){const t=new a.TextureDescriptor;t.wrapMode=s.TextureWrapMode.CLAMP_TO_EDGE,t.width=this._size[i][0],t.height=this._size[i][1],this._textures[i]=new n.Texture(e,t,new Uint8Array(this._mosaicsData[i].buffer))}const o=this._textures[i];o.setSamplingMode(t),this._dirties[i]&&o.setData(new Uint8Array(this._mosaicsData[i].buffer)),e.bindTexture(o,r),this._dirties[i]=!1}static _copyBits(e,t,i,r,s,n,a,o,l,c,h){let u=r*t+i,p=o*n+a;if(h){p-=n;for(let a=-1;a<=c;a++,u=((a+c)%c+r)*t+i,p+=n)for(let t=-1;t<=l;t++)s[p+t]=e[u+(t+l)%l]}else for(let i=0;i<c;i++){for(let t=0;t<l;t++)s[p+t]=e[u+t];u+=t,p+=n}}_copy(e,t,i,r,s,n){if(!this._sprites||"loaded"!==this._sprites.loadStatus||i>=this._mosaicsData.length)return;const a=new Uint32Array(n?n.buffer:this._sprites.image.buffer),l=this._mosaicsData[i],c=n?t.width:this._sprites.width;o._copyBits(a,c,t.x,t.y,l,r[0],e.x+2,e.y+2,t.width,t.height,s),this._dirties[i]=!0}_allocateImage(e,t){e+=2,t+=2;const s=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<s){const i=new r(0,0,e,t);return this._mosaicsData.push(new Uint32Array(e*t)),this._dirties.push(!0),this._size.push([e,t]),this._textures.push(void 0),[i,this._mosaicsData.length-1,[e,t]]}let n=e%4?4-e%4:4,a=t%4?4-t%4:4;1===n&&(n=5),1===a&&(a=5);const o=this._binPack.allocate(e+n,t+a);return o.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new i(this._pageWidth-4,this._pageHeight-4),this._allocateImage(e,t)):[o,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(e){const i=e.match(/\[(.*?)\]/);if(!i)return null;const r=i[1].split(",").map(Number),s=e.slice(e.lastIndexOf("-")+1),[n,a,o]=t.rasterizeDash(r,s);return[{x:0,y:0,width:a,height:o,sdf:!0,pixelRatio:1},new Uint8Array(n.buffer)]}}return o}))},"esri/views/2d/engine/vectorTiles/TileManager":function(){define(["exports","../../../../core/LRUCache","../../../../geometry/support/aaBoundingRect","./constants","../../tiling/TileCoverage","../../tiling/TileKey"],(function(e,t,i,r,s,n){"use strict";const a=(e,t)=>e+1/(1<<2*t);function o(e){const[t,i,r,s]=e.split("/"),n=parseInt(t,10);return 0===n?null:`${n-1}/${parseInt(i,10)>>1}/${parseInt(r,10)>>1}/${parseInt(s,10)}`}e.TileManager=class{constructor(e,i){this._tiles=new Map,this._tileCache=new t.LRUCache(40,(e=>e.dispose())),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=i}destroy(){for(const e of this._tiles.values())e.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);const t=this.tileInfoView,i=t.getTileCoverage(e.state,0,!0,"smallest");if(!i)return!0;const{spans:r,lodInfo:a}=i,{level:o}=a,l=this._tiles,c=new Set,h=new Set;for(const{row:e,colFrom:t,colTo:i}of r)for(let r=t;r<=i;r++){const t=n.getId(o,e,a.normalizeCol(r),a.getWorldForColumn(r)),i=this._getOrAcquireTile(t);c.add(t),i.processed()?this._addToContainer(i):h.add(new n(t))}for(const[e,t]of l)t.isCoverage=c.has(e);for(const e of h)this._findPlaceholdersForMissingTiles(e,c);let u=!1;for(const[e,r]of l)r.neededForCoverage=c.has(e),r.neededForCoverage||r.isHoldingForFade&&t.intersects(i,r.key)&&c.add(e),r.isFading&&(u=!0);for(const e of this._tiles.keys())c.has(e)||this._releaseTile(e);return s.pool.release(i),!u}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}getIntersectingTiles(e,t,r,s,n){const a=[0,0],o=[0,0];s.toMap(a,e-r,t+r),s.toMap(o,e+r,t-r);const l=Math.min(a[0],o[0]),c=Math.min(a[1],o[1]),h=Math.max(a[0],o[0]),u=Math.max(a[1],o[1]),p=i.fromValues(l,c,h,u),y=i.create(),d=[];for(const e of this._visibleTiles.values())this.tileInfoView.getTileBounds(y,e.key),i.intersects(p,y)&&d.push(e);if(null!=n&&n.length>0){const e=new Set(d.map((e=>e.id))),t=n.filter((t=>!e.has(t.tileKey.id))).map((e=>this._visibleTiles.get(e.tileKey.id))).filter((e=>void 0!==e));d.push(...t)}return d}_findPlaceholdersForMissingTiles(e,t){const i=[];for(const r of this._tiles.values())this._addPlaceholderChild(i,r,e,t);const r=i.reduce(a,0);Math.abs(1-r)<1e-6||this._addPlaceholderParent(e.id,t)}_addPlaceholderChild(e,t,i,r){t.key.level<=i.level||!t.hasData()||function(e,t){const i=t.level-e.level;return e.row===t.row>>i&&e.col===t.col>>i&&e.world===t.world}(i,t.key)&&(this._addToContainer(t),r.add(t.id),e.push(t.key.level-i.level))}_addPlaceholderParent(e,t){const i=this._tiles;let r=e;for(;;){if(r=o(r),!r||t.has(r))return;const e=i.get(r);if(e?.hasData())return this._addToContainer(e),void t.add(e.id)}}_getOrAcquireTile(e){let t=this._tiles.get(e);return t||(t=this._tileCache.pop(e),t||(t=this.acquireTile(new n(e))),this._tiles.set(e,t),t)}_releaseTile(e){const t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}_addToContainer(e){let t;const i=[],r=this._container;if(r.contains(e))return;const s=this._visibleTiles;for(const r of s.values())this._canConnectDirectly(e,r)&&i.push(r),null==t&&this._canConnectDirectly(r,e)&&(t=r);if(null!=t){for(const r of i)t.childrenTiles.delete(r),e.childrenTiles.add(r),r.parentTile=e;t.childrenTiles.add(e),e.parentTile=t}else for(const t of i)e.childrenTiles.add(t),t.parentTile=e;s.set(e.id,e),r.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),null!=e.parentTile){e.parentTile.childrenTiles.delete(e);for(const t of e.childrenTiles)null!=e.parentTile&&e.parentTile.childrenTiles.add(t)}for(const t of e.childrenTiles)t.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,t){const i=e.key;let{level:r,row:s,col:n,world:a}=t.key;const o=this._visibleTiles;for(;r>0;){if(r--,s>>=1,n>>=1,i.level===r&&i.row===s&&i.col===n&&i.world===a)return!0;if(o.has(`${r}/${s}/${n}/${a}`))return!1}return!1}_updateCacheSize(e){const t=e.state.size;if(t[0]===this._viewSize[0]&&t[1]===this._viewSize[1])return;const i=Math.ceil(t[0]/r.tilePixelSize)+1,s=Math.ceil(t[1]/r.tilePixelSize)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*i*s}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/VectorTileContainer":function(){define(["exports","../../../../geometry/support/aaBoundingRect","../../../../layers/support/TileInfo","./constants","./decluttering/SymbolFader","./decluttering/util","./style/StyleDefinition","../webgl/enums","../webgl/RenderableTile","../webgl/TileContainer","../../tiling/TileCoverage","../../tiling/TileKey","../../../webgl/enums"],(function(e,t,i,r,s,n,a,o,l,c,h,u,p){"use strict";const y=1e-6;function d(e,t){if(e){const i=e.getLayoutProperty("visibility");if(!i||i.getValue()!==a.Visibility.NONE&&(void 0===e.minzoom||e.minzoom<t+y)&&(void 0===e.maxzoom||e.maxzoom>=t-y))return!0}return!1}e.VectorTileContainer=class extends c{constructor(e){super(e),this._backgroundTiles=[],this._computeDisplayInfoView(e)}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[]}get fading(){return this._symbolFader?.fading??!1}get symbolFader(){return this._symbolFader}get symbolRepository(){return this._symbolFader?.symbolRepository}setStyleResources(e,t,i,a){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=i,this.tileInfoView=a,this._computeDisplayInfoView(a),null==this._symbolFader){const e=(e,t)=>{e.allSymbolsFadingOut=!0,e.lastOpacityUpdate=t,n.writeOpacityToBuffers(e,t,!0),e.decluttered=!0,e.requestRender()};this._symbolFader=new s.SymbolFader("vector-tile",this._styleRepository,e,this.children,r.tileCoordSize)}this._symbolFader.styleRepository=i}setSpriteMosaic(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e}deleteStyleLayers(e){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(e)}createRenderParams(e){return{...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==o.WGLDrawPhase.MAP&&e.drawPhase!==o.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||super.doRender(e)}addChild(e){return super.addChild(e),null!=this._symbolFader?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return null!=this._symbolFader&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;t!==o.WGLDrawPhase.DEBUG?this._doRender(e):super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];null!=this._symbolFader&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter((e=>e.neededForCoverage&&e.hasData()))}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()}_doRender(e){const{context:t,state:i}=e,r=this._styleRepository;if(!r)return;const s=r.layers,n=this._displayInfo.scaleToZoom(i.scale);r.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,r.backgroundBucketIds,n)),super.renderChildren(e),e.drawPhase===o.WGLDrawPhase.MAP&&this._fade(n,i);const a=this.children.filter((e=>e.visible&&e.hasData()));if(!a||0===a.length)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const e of a)e.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(p.StencilOperation.KEEP,p.StencilOperation.KEEP,p.StencilOperation.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(p.CompareFunction.LEQUAL),t.setClearDepth(1),t.clear(p.FramebufferBit.DEPTH),e.renderPass="opaque";for(let t=s.length-1;t>=0;t--)this._renderStyleLayer(s[t],e,a);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(p.BlendFactor.ONE,p.BlendFactor.ONE_MINUS_SRC_ALPHA,p.BlendFactor.ONE,p.BlendFactor.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let t=0;t<s.length;t++)this._renderStyleLayer(s[t],e,a);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0);for(const e of a)e.debugInfo.display.triangleCount=e.triangleCount}_fade(e,t){null!=this._symbolFader&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,i){const{displayLevel:r,painter:s,renderPass:n}=t;if(void 0===e)return;const o=e.getLayoutProperty("visibility");if(o&&o.getValue()===a.Visibility.NONE)return;let l;switch(e.type){case a.StyleLayerType.BACKGROUND:return;case a.StyleLayerType.FILL:if("opaque"!==n&&"translucent"!==t.renderPass)return;l="vtlFill";break;case a.StyleLayerType.LINE:if("translucent"!==n)return;l="vtlLine";break;case a.StyleLayerType.CIRCLE:if("translucent"!==n)return;l="vtlCircle";break;case a.StyleLayerType.SYMBOL:if("translucent"!==n)return;l="vtlSymbol"}if(i=e.type===a.StyleLayerType.SYMBOL?i.filter((e=>e.decluttered)):i.filter((e=>e.neededForCoverage)),"vtlSymbol"!==l&&(0===i.length||void 0!==e.minzoom&&e.minzoom>=r+y||void 0!==e.maxzoom&&e.maxzoom<r-y))return;const c=e.uid;t.styleLayerUID=c,t.styleLayer=e;for(const e of i)if(e.layerData.has(c)){s.renderObjects(t,i,l);break}}_renderBackgroundLayers(e,i,s){const{context:n,painter:o,state:c}=e,y=this._styleRepository;let g=!1;for(const e of i)if(y.getLayerById(e).type===a.StyleLayerType.BACKGROUND&&d(y.getLayerById(e),s)){g=!0;break}if(!g)return;const f=this.tileInfoView,_=f.getTileCoverage(e.state,0,!0,"smallest"),{spans:m,lodInfo:T}=_,{level:w}=T,b=t.create(),v=[];if(this._renderPasses){const t=this._renderPasses[0];null!=this._clippingInfos&&(t.brushes[0].prepareState(e),t.brushes[0].drawMany(e,this._clippingInfos))}const S=this._backgroundTiles;let x,E=0;for(const{row:e,colFrom:i,colTo:s}of m)for(let n=i;n<=s;n++){if(E<S.length)x=S[E],x.key.set(w,e,T.normalizeCol(n),T.getWorldForColumn(n)),f.getTileBounds(b,x.key,!1),x.x=b[0],x.y=b[3],x.resolution=f.getTileResolution(w);else{const i=new u(w,e,T.normalizeCol(n),T.getWorldForColumn(n)),s=f.getTileBounds(t.create(),i),a=f.getTileResolution(w);x=new l.RenderableTile(i,a,s[0],s[3],r.tilePixelSize,r.tilePixelSize,r.tileCoordSize,r.tileCoordSize),S.push(x)}x.setTransform(c),v.push(x),E++}n.setStencilWriteMask(0),n.setColorMask(!0,!0,!0,!0),n.setStencilOp(p.StencilOperation.KEEP,p.StencilOperation.KEEP,p.StencilOperation.REPLACE),n.setStencilFunction(p.CompareFunction.EQUAL,0,255),n.setStencilTestEnabled(!0);for(const t of i){const i=y.getLayerById(t);i.type===a.StyleLayerType.BACKGROUND&&d(i,s)&&(e.styleLayerUID=i.uid,e.styleLayer=i,o.renderObjects(e,v,"vtlBackground"))}h.pool.release(_)}_computeDisplayInfoView(e){let t=e.tileInfo.lods[0].scale;const s=Math.max(25,e.tileInfo.lods.length),n=[];for(let e=0;e<=s;e++)n.push(t),t/=2;this._displayInfo=i.create({scales:n,size:r.tilePixelSize,spatialReference:e.spatialReference,numLODs:s})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/webgl/RenderableTile":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/mat3f32","./TiledDisplayObject"],(function(e,t,i){"use strict";class r extends i.TiledDisplayObject{_createTransforms(){return{displayViewScreenMat3:t.create(),tileMat3:t.create()}}}e.RenderableTile=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/VectorTileFeatureIndex":function(){define(["../../../../Graphic","../../../../core/MapUtils","../../../../core/pbf","../../../../core/libs/rbush/PooledRBush","./constants","./enums","./Feature","./GeometryUtils","./SourceLayerData","./style/StyleLayer"],(function(e,t,i,r,s,n,a,o,l,c){"use strict";const h=(e,t)=>{const i=e.vtlSymbol.sourceTile,r=t.vtlSymbol.sourceTile;return i.level!==r.level?i.level-r.level:i.row!==r.row?i.row-r.row:i.col!==r.col?i.col-r.col:e.styleLayerUID-t.styleLayerUID};class u{constructor(e,t,i,r,s){this.tileKey=e,this._tileLayerData=t,this._styleRepository=i,this._tileHandler=r,this._parentLayer=s,this._index=null,this._tileKeyToPBF=new Map}static create(e,t,i,r,s){return new u(e,t,i,r,s)}clear(){this._index?.clear(),this._tileKeyToPBF.clear()}async queryAttributes(e,t,i,s,n){if(0===this._tileLayerData.size||!this._styleRepository||!this._tileHandler)return[];null===this._index&&(this._index=new r.PooledRBush(100,p),await this._indexLayers());const a=[];return this._queryIndex(a,e,t,i,this.tileKey.level,s),n&&n?.length>0&&await this._getSymbolsAttributes(a,n),a}async _indexLayers(){const e=this.tileKey,t=this._styleRepository.layers,i=await this._getTilePayload(e);for(const[r,s]of this._tileLayerData){const a=t[r],o=i.find((e=>e.sourceName===a.source));if(!o)continue;const{protobuff:l,key:c}=o;if(s.type!==n.BucketType.SYMBOL){const t=1<<e.level-c.level,i=e.row-c.row*t,r=e.col-c.col*t;this._indexLayer(a,l,e.level,t,i,r)}}}_indexLayer(e,t,r,n,h,u){const p=e.sourceLayer,y=e.getFeatureFilter(),d=r,g=r+1,f=o.getTileMargins(d),_=new i(new Uint8Array(t),new DataView(t));for(;_.next();)switch(_.tag()){case 3:{const t=_.getMessage(),i=new l(t);if(t.release(),i.name!==p)continue;const o=i.getData(),m=i.extent/n,T=m*u-f,w=m*h-f,b=T+m+2*f,v=w+m+2*f,S=m/s.tilePixelSize,x=s.tileCoordSize/m,E=m*u,D=m*h;for(;o.nextTag(2);){const t=o.getMessage(),s=new a(t,i);if(t.release(),y&&!y.filter(s,r))continue;const n=s.values||{},l=n._minzoom,h=n._maxzoom;if(l&&l>=10*g||h&&h<=10*d)continue;const u=e.getFeatureInflatedBounds(s,d,i.extent,S);null==u||u[0]>b||u[1]>v||u[2]<T||u[3]<w||(u[0]=(u[0]-E)*x,u[1]=(u[1]-D)*x,u[2]=(u[2]-E)*x,u[3]=(u[3]-D)*x,this._index.insert(new c.IndexItem(e,s,u,x,E,D)))}break}default:_.skip()}_.release()}async _getSymbolsAttributes(e,t){if(!t||0===t.length)return e;const i=[];if(t.sort(h),t.length>0){let e=0,{styleLayerUID:r}=t[0];for(let s=1;s<t.length;s++){const{styleLayerUID:n}=t[s];n!==r&&(i.push({from:e,to:s,styleLayerUID:r,sourceTileKey:t[s-1].vtlSymbol.sourceTile}),e=s,r=n)}const s=t.length-1;i.push({from:e,to:t.length,styleLayerUID:r,sourceTileKey:t[s].vtlSymbol.sourceTile})}const r=this._styleRepository.layers;for(const s of i){const i=await this._getTilePayload(s.sourceTileKey),n=r[s.styleLayerUID],a=!!n&&i.find((e=>e.sourceName===n.source));a&&this._addSymbolsAttributes(e,t.slice(s.from,s.to).map((e=>e.vtlSymbol.featureIndex)),s.styleLayerUID,a)}return e}_addSymbolsAttributes(t,i,r,s){const n=this._styleRepository.layers,a=s.key,o=this.tileKey,l=1<<o.level-a.level,c=o.row-a.row*l,h=o.col-a.col*l;this._getSymbolAttributes(s.protobuff,i,r,l,c,h).forEach((i=>{const{attributes:s,tilePoint:a}=i;t.push({layerId:n[r].id,layerIndex:r,graphic:new e({attributes:s,origin:{type:"vector-tile",layerId:n[r].id,layerIndex:r,layer:this._parentLayer}}),tilePoint:a})}))}_getSymbolAttributes(e,t,r,n,o,c){const h=[],u=this._styleRepository.layers;let p=0;t.sort(((e,t)=>e-t));const y=new i(new Uint8Array(e),new DataView(e));for(;y.next();)switch(y.tag()){case 3:{const e=y.getMessage(),i=new l(e);if(e.release(),i.name!==u[r].sourceLayer)continue;const d=i.getData(),g=i.extent/n,f=s.tileCoordSize/g,_=g*c,m=g*o;let T=0;for(;d.nextTag(2);){const e=d.getMessage();if(T++===t[p]){const t=new a(e,i),r=t.values,s=t.getGeometry(),n=null!=s?[f*(s[0][0].x-_),f*(s[0][0].y-m)]:null;h.push({attributes:r,tilePoint:n}),p++}if(e.release(),p===t.length)return h}break}default:y.skip()}return y.release(),h}_queryIndex(t,i,r,n,a,o){const l=s.tilePixelRatio*n*(window.devicePixelRatio||1);return this._index?.search({minX:i-l,minY:r-l,maxX:i+l,maxY:r+l},(s=>{const{layer:l,feature:c}=s;l.isIntersectingFeature(i,r,n,c,a,o,s)&&t.push({layerId:l.id,layerIndex:l.uid,tilePoint:null,graphic:new e({attributes:c.values,origin:{type:"vector-tile",layerId:s.layer.id,layerIndex:s.layer.uid,layer:this._parentLayer}})})})),t}async _getTilePayload(e){return t.getOrCreateMapValue(this._tileKeyToPBF,e.id,(()=>this._tileHandler.fetchTilePBFs(e))).then((e=>e))}}const p=e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]});return u}))},"esri/core/libs/rbush/PooledRBush":function(){define(["exports","../../arrayUtils","../../compilerUtils","../../has","../../PooledArray","../../../chunks/quickselect"],(function(e,t,i,r,s,n){"use strict";function a(e,t){let r=e;for(T.clear();r;){if(!0===r.leaf)for(const e of r.children)t(i.toConst(e));else T.pushArray(r.children);r=T.pop()??null}}function o(e,t){l(e,0,e.children.length,t,e)}function l(e,t,i,r,s){s||(s=new x([])),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let n,a=t;a<i;a++)n=e.children[a],c(s,e.leaf?r(n):n);return s}function c(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function h(e,t){return e.minX-t.minX}function u(e,t){return e.minY-t.minY}function p(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function y(e){return e.maxX-e.minX+(e.maxY-e.minY)}function d(e,t){const i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,s-i)*Math.max(0,n-r)}function g(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function f(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function _(e,t,i,r,s){const a=[t,i];for(;a.length;){const t=a.pop(),i=a.pop();if(t-i<=r)continue;const o=i+Math.ceil((t-i)/r/2)*r;n.quickselect(e,o,i,t,s),a.push(i,o,o,t)}}const m=new s,T=new s,w=new s,b=new s({deallocator:void 0});class v{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class S extends v{constructor(){super(...arguments),this.height=1,this.indexHint=new t.PositionHint}}class x extends S{constructor(e){super(),this.children=e,this.leaf=!0}}class E extends S{constructor(e){super(),this.children=e,this.leaf=!1}}e.BBox=v,e.PooledRBush=class{constructor(e=9,t){this._compareMinX=h,this._compareMinY=u,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),m.prune(),T.prune(),w.prune(),b.prune()}all(e){a(this._data,e)}search(e,t){let i=this._data;const r=this._toBBox;if(f(e,i))for(m.clear();i;){for(let s=0,n=i.children.length;s<n;s++){const n=i.children[s],o=i.leaf?r(n):n;f(e,o)&&(i.leaf?t(n):g(e,o)?a(n,t):m.push(n))}i=m.pop()}}collides(e){let t=this._data;const i=this._toBBox;if(!f(e,t))return!1;for(m.clear();t;){for(let r=0,s=t.children.length;r<s;r++){const s=t.children[r],n=t.leaf?i(s):s;if(f(e,n)){if(t.leaf||g(e,n))return!0;m.push(s)}}t=m.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new x([]),this}remove(e){if(!e)return this;let r,s=this._data,n=null,a=0,o=!1;const l=this._toBBox(e);for(w.clear(),b.clear();s||w.length>0;){if(s||(s=w.pop(),n=w.data[w.length-1],a=b.pop()??0,o=!0),s.leaf&&(r=t.indexOf(s.children,i.toConst(e),s.children.length,s.indexHint),-1!==r))return s.children.splice(r,1),w.push(s),this._condense(w),this;o||s.leaf||!g(s,l)?n?(a++,s=n.children[a],o=!1):s=null:(w.push(s),b.push(a),a=0,n=s,s=s.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_build(e,t,i,r){const s=i-t+1;let n=this._maxEntries;if(s<=n){const r=new x(e.slice(t,i+1));return o(r,this._toBBox),r}r||(r=Math.ceil(Math.log(s)/Math.log(n)),n=Math.ceil(s/n**(r-1)));const a=new E([]);a.height=r;const l=Math.ceil(s/n),c=l*Math.ceil(Math.sqrt(n));_(e,t,i,c,this._compareMinX);for(let s=t;s<=i;s+=c){const t=Math.min(s+c-1,i);_(e,s,t,l,this._compareMinY);for(let i=s;i<=t;i+=l){const s=Math.min(i+l-1,t);a.children.push(this._build(e,i,s,r-1))}}return o(a,this._toBBox),a}_insert(e,t,i){const r=this._toBBox,s=i?e:r(e);w.clear();const n=function(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){let i,r=1/0,a=1/0;for(let o=0,l=t.children.length;o<l;o++){const l=t.children[o],c=p(l),h=(s=e,n=l,(Math.max(n.maxX,s.maxX)-Math.min(n.minX,s.minX))*(Math.max(n.maxY,s.maxY)-Math.min(n.minY,s.minY))-c);h<a?(a=h,r=c<r?c:r,i=l):h===a&&c<r&&(r=c,i=l)}t=i||t.children[0]}var s,n;return t}(s,this._data,t,w);for(n.children.push(e),c(n,s);t>=0&&w.data[t].children.length>this._maxEntries;)this._split(w,t),t--;!function(e,t,i){for(let r=i;r>=0;r--)c(t.data[r],e)}(s,w,t)}_split(e,t){const i=e.data[t],r=i.children.length,s=this._minEntries;this._chooseSplitAxis(i,s,r);const n=this._chooseSplitIndex(i,s,r);if(!n)return;const a=i.children.splice(n,i.children.length-n),l=i.leaf?new x(a):new E(a);l.height=i.height,o(i,this._toBBox),o(l,this._toBBox),t?e.data[t-1].children.push(l):this._splitRoot(i,l)}_splitRoot(e,t){this._data=new E([e,t]),this._data.height=e.height+1,o(this._data,this._toBBox)}_chooseSplitIndex(e,t,i){let r,s,n;r=s=1/0;for(let a=t;a<=i-t;a++){const t=l(e,0,a,this._toBBox),o=l(e,a,i,this._toBBox),c=d(t,o),h=p(t)+p(o);c<r?(r=c,n=a,s=h<s?h:s):c===r&&h<s&&(s=h,n=a)}return n}_chooseSplitAxis(e,t,i){const r=e.leaf?this._compareMinX:h,s=e.leaf?this._compareMinY:u;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,s)&&e.children.sort(r)}_allDistMargin(e,t,i,r){e.children.sort(r);const s=this._toBBox,n=l(e,0,t,s),a=l(e,i-t,i,s);let o=y(n)+y(a);for(let r=t;r<i-t;r++){const t=e.children[r];c(n,e.leaf?s(t):t),o+=y(n)}for(let r=i-t-1;r>=t;r--){const t=e.children[r];c(a,e.leaf?s(t):t),o+=y(a)}return o}_condense(e){for(let i=e.length-1;i>=0;i--){const r=e.data[i];if(0===r.children.length)if(i>0){const s=e.data[i-1],n=s.children;n.splice(t.indexOf(n,r,n.length,s.indexHint),1)}else this.clear();else o(r,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/Feature":function(){define(["../../../../geometry/support/TileClipper"],(function(e){"use strict";var t;return function(e){e[e.moveTo=1]="moveTo",e[e.lineTo=2]="lineTo",e[e.close=7]="close"}(t||(t={})),class{constructor(e,t,i=0){this.values={},this._geometry=void 0,this._pbfGeometry=null,this.featureIndex=i;const r=t.keys,s=t.values,n=e.asUnsafe();for(;n.next();)switch(n.tag()){case 1:this.id=n.getUInt64();break;case 2:{const e=n.getMessage().asUnsafe(),t=this.values;for(;!e.empty();){const i=e.getUInt32(),n=e.getUInt32();t[r[i]]=s[n]}e.release();break}case 3:this.type=n.getUInt32();break;case 4:this._pbfGeometry=n.getMessage();break;default:n.skip()}}getGeometry(i){if(void 0!==this._geometry)return this._geometry;if(!this._pbfGeometry)return null;const r=this._pbfGeometry.asUnsafe();let s,n;this._pbfGeometry=null,i?i.reset(this.type):s=[];let a,o=t.moveTo,l=0,c=0,h=0;for(;!r.empty();){if(0===l){const e=r.getUInt32();o=7&e,l=e>>3}switch(l--,o){case t.moveTo:c+=r.getSInt32(),h+=r.getSInt32(),i?i.moveTo(c,h):s&&(n&&s.push(n),n=[],n.push(new e.Point(c,h)));break;case t.lineTo:c+=r.getSInt32(),h+=r.getSInt32(),i?i.lineTo(c,h):n&&n.push(new e.Point(c,h));break;case t.close:i?i.close():n&&!n[0].equals(c,h)&&n.push(n[0].clone());break;default:throw r.release(),new Error("Invalid path operation")}}return i?a=i.result():s&&(n&&s.push(n),a=s),r.release(),this._geometry=a,a}}}))},"esri/views/2d/engine/vectorTiles/SourceLayerData":function(){define(["./constants"],(function(e){"use strict";class t{constructor(i){this.extent=e.tileCoordSize,this.keys=[],this.values=[],this._pbfLayer=i.clone();const r=i.asUnsafe();for(;r.next();)switch(r.tag()){case 1:this.name=r.getString();break;case 3:this.keys.push(r.getString());break;case 4:this.values.push(r.processMessage(t._parseValue));break;case 5:this.extent=r.getUInt32();break;default:r.skip()}}getData(){return this._pbfLayer}static _parseValue(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getInt64();case 5:return e.getUInt64();case 6:return e.getSInt64();case 7:return e.getBool();default:e.skip()}return null}}return t}))},"esri/views/2d/engine/vectorTiles/style/StyleLayer":function(){define(["exports","../../../../../geometry/support/aaBoundingRect","../constants","../enums","../GeometryUtils","../shaders/VTLBackgroundMaterial","../shaders/VTLCircleMaterial","../shaders/VTLFillMaterial","../shaders/VTLLineMaterial","../shaders/VTLSymbolMaterial","./Filter","./StyleDefinition","./StyleProperty","../../webgl/definitions"],(function(e,t,i,r,s,n,a,o,l,c,h,u,p,y){"use strict";var d;e.CapType=void 0,(d=e.CapType||(e.CapType={}))[d.BUTT=0]="BUTT",d[d.ROUND=1]="ROUND",d[d.SQUARE=2]="SQUARE",d[d.UNKNOWN=4]="UNKNOWN";class g{constructor(e,t,i,r){switch(this.type=e,this.typeName=t.type,this.id=t.id,this.source=t.source,this.sourceLayer=t["source-layer"],this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,this.filter=t.filter,this.layout=t.layout,this.paint=t.paint,this.z=i,this.uid=r,e){case u.StyleLayerType.BACKGROUND:this._layoutDefinition=u.StyleDefinition.backgroundLayoutDefinition,this._paintDefinition=u.StyleDefinition.backgroundPaintDefinition;break;case u.StyleLayerType.FILL:this._layoutDefinition=u.StyleDefinition.fillLayoutDefinition,this._paintDefinition=u.StyleDefinition.fillPaintDefinition;break;case u.StyleLayerType.LINE:this._layoutDefinition=u.StyleDefinition.lineLayoutDefinition,this._paintDefinition=u.StyleDefinition.linePaintDefinition;break;case u.StyleLayerType.SYMBOL:this._layoutDefinition=u.StyleDefinition.symbolLayoutDefinition,this._paintDefinition=u.StyleDefinition.symbolPaintDefinition;break;case u.StyleLayerType.CIRCLE:this._layoutDefinition=u.StyleDefinition.circleLayoutDefinition,this._paintDefinition=u.StyleDefinition.circlePaintDefinition}this._layoutProperties=this._parseLayout(this.layout),this._paintProperties=this._parsePaint(this.paint)}getFeatureFilter(){return void 0!==this._featureFilter?this._featureFilter:this._featureFilter=h.createFilter(this.filter)}getLayoutProperty(e){return this._layoutProperties[e]}getPaintProperty(e){return this._paintProperties[e]}getLayoutValue(e,t,i){let r;const s=this._layoutProperties[e];return s&&(r=s.getValue(t,i)),void 0===r&&(r=this._layoutDefinition[e].default),r}getPaintValue(e,t,i){let r;const s=this._paintProperties[e];return s&&(r=s.getValue(t,i)),void 0===r&&(r=this._paintDefinition[e].default),r}isPainterDataDriven(){const e=this._paintProperties;if(e)for(const t in e)if(e[t].isDataDriven)return!0;return!1}isIntersectingFeature(e,t,i,r,s,n,a){return!1}getFeatureInflatedBounds(e,t,i,r){return null}_parseLayout(e){const t={};for(const i in e){const r=this._layoutDefinition[i];r&&(t[i]=new p(r,e[i]))}return t}_parsePaint(e){const t={};for(const i in e){const r=this._paintDefinition[i];r&&(t[i]=new p(r,e[i]))}return t}computeAttributesKey(e,t,i,r){let s=0,n=0;for(const e of t){let t=3;if(!e||e!==r){const r=i[e],{isLayout:s,isOptional:n}=r,a=s?this.getLayoutProperty(e):this.getPaintProperty(e);t=a?.interpolator?2:a?.isDataDriven?1:n&&!a?3:0}n|=t<<s,s+=2}return n<<3|e}}function f(e){const i=e?.getGeometry();if(null==i)return null;let r=1/0,s=1/0,n=-1/0,a=-1/0;for(const e of i)if(e)for(const t of e)r=Math.min(r,t.x),s=Math.min(s,t.y),n=Math.max(n,t.x),a=Math.max(a,t.y);return t.fromValues(r,s,n,a)}e.BackgroundStyleLayer=class extends g{constructor(e,t,i,s){super(e,t,i,s),this.backgroundMaterial=new n.VTLBackgroundMaterial(this.computeAttributesKey(r.ShaderProgramType.BACKGROUND,n.VTLBackgroundMaterial.ATTRIBUTES,n.VTLBackgroundMaterial.ATTRIBUTES_INFO))}},e.CircleStyleLayer=class extends g{constructor(e,t,i,s){super(e,t,i,s),this.circleMaterial=new a.VTLCircleMaterial(this.computeAttributesKey(r.ShaderProgramType.CIRCLE,a.VTLCircleMaterial.ATTRIBUTES,a.VTLCircleMaterial.ATTRIBUTES_INFO))}getFeatureInflatedBounds(e,t,r,s){const n=f(e);if(!n)return null;const a=this.getPaintValue("circle-translate",t,e),o=Math.max(a[0],a[1]);n[0]-=o,n[2]-=o,n[1]+=o,n[3]+=o;const l=s*(i.tilePixelRatio*(this.getPaintValue("circle-radius",t,e)+this.getPaintValue("circle-stroke-width",t,e))/2);return n[0]-=l,n[1]-=l,n[2]+=l,n[3]+=l,n}isIntersectingFeature(e,t,r,n,a,o,l){const c=n.getGeometry();if(!c)return!1;const h=i.tilePixelRatio/l.normalizationRatio;e=e/l.normalizationRatio+l.normalizationOffsetX,t=t/l.normalizationRatio+l.normalizationOffsetY,r*=h;const u=s.translateAnchor(this.getPaintValue("circle-translate",a,n),this.getPaintValue("circle-translate-anchor",a,n),o,h),p=h*(this.getPaintValue("circle-radius",a,n)+this.getPaintValue("circle-stroke-width",a,n));let y,d;for(const i of c)if(i)for(const s of i)if(y=s.x+u.x,d=s.y+u.y,Math.sqrt((e-y)*(e-y)+(t-d)*(t-d))-r<=p)return!0;return!1}},e.FillStyleLayer=class extends g{constructor(e,t,i,s){super(e,t,i,s);const n=this.getPaintProperty("fill-color"),a=this.getPaintProperty("fill-opacity"),l=this.getPaintProperty("fill-pattern");this.hasDataDrivenColor=n?.isDataDriven,this.hasDataDrivenOpacity=a?.isDataDriven,this.hasDataDrivenFill=this.hasDataDrivenColor||this.hasDataDrivenOpacity||l?.isDataDriven;const c=this.getPaintProperty("fill-outline-color");this.outlineUsesFillColor=!c,this.hasDataDrivenOutlineColor=c?.isDataDriven,this.hasDataDrivenOutline=c?c.isDataDriven:!!n&&n.isDataDriven,this.hasDataDrivenOutline=(c?this.hasDataDrivenOutlineColor:this.hasDataDrivenColor)||this.hasDataDrivenOpacity,this.fillMaterial=new o.VTLFillMaterial(this.computeAttributesKey(r.ShaderProgramType.FILL,o.VTLFillMaterial.ATTRIBUTES,o.VTLFillMaterial.ATTRIBUTES_INFO)),this.outlineMaterial=new o.VTLOutlineMaterial(this.computeAttributesKey(r.ShaderProgramType.OUTLINE,this.outlineUsesFillColor?o.VTLOutlineMaterial.ATTRIBUTES_FILL:o.VTLOutlineMaterial.ATTRIBUTES_OUTLINE,this.outlineUsesFillColor?o.VTLOutlineMaterial.ATTRIBUTES_INFO_FILL:o.VTLOutlineMaterial.ATTRIBUTES_INFO_OUTLINE),this.outlineUsesFillColor)}getFeatureInflatedBounds(e,t,i,r){const s=f(e);if(!s)return null;const n=this.getPaintValue("fill-translate",t,e),a=r*Math.max(n[0],n[1]);return s[0]-=a,s[2]-=a,s[1]+=a,s[3]+=a,s}isIntersectingFeature(e,t,r,n,a,o,l){const c=n.getGeometry();if(!c)return!1;const h=i.tilePixelRatio/l.normalizationRatio;e=e/l.normalizationRatio+l.normalizationOffsetX,t=t/l.normalizationRatio+l.normalizationOffsetY;const u=s.translateAnchor(this.getPaintValue("fill-translate",a,n),this.getPaintValue("fill-translate-anchor",a,n),o,i.tilePixelRatio);return e-=h*u.x,t-=h*u.y,!!s.pointInPolygon(e,t,c)||s.distanceFromToPolylineWithinThreshold(e,t,c,h*r)}},e.IconLayout=class{constructor(e,t,i){let r;this.allowOverlap=e.getLayoutValue("icon-allow-overlap",t),this.ignorePlacement=e.getLayoutValue("icon-ignore-placement",t),this.keepUpright=e.getLayoutValue("icon-keep-upright",t),this.optional=e.getLayoutValue("icon-optional",t),this.rotationAlignment=e.getLayoutValue("icon-rotation-alignment",t),this.rotationAlignment===u.RotationAlignment.AUTO&&(this.rotationAlignment=i?u.RotationAlignment.MAP:u.RotationAlignment.VIEWPORT),r=e.getLayoutProperty("icon-anchor"),r?.isDataDriven?this._anchorProp=r:this.anchor=e.getLayoutValue("icon-anchor",t),r=e.getLayoutProperty("icon-offset"),r?.isDataDriven?this._offsetProp=r:this.offset=e.getLayoutValue("icon-offset",t),r=e.getLayoutProperty("icon-padding"),r?.isDataDriven?this._paddingProp=r:this.padding=e.getLayoutValue("icon-padding",t),r=e.getLayoutProperty("icon-rotate"),r?.isDataDriven?this._rotateProp=r:this.rotate=e.getLayoutValue("icon-rotate",t),r=e.getLayoutProperty("icon-size"),r?.isDataDriven?this._sizeProp=r:this.size=e.getLayoutValue("icon-size",t)}update(e,t){this._anchorProp&&(this.anchor=this._anchorProp.getValue(e,t)),this._offsetProp&&(this.offset=this._offsetProp.getValue(e,t)),this._paddingProp&&(this.padding=this._paddingProp.getValue(e,t)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(e,t)),this._sizeProp&&(this.size=this._sizeProp.getValue(e,t))}},e.IndexItem=class{constructor(e,t,i,r,s,n){this.layer=e,this.feature=t,this.bounds=i,this.normalizationRatio=r,this.normalizationOffsetX=s,this.normalizationOffsetY=n}},e.LineStyleLayer=class extends g{constructor(e,t,i,s){super(e,t,i,s);const n=this.getPaintProperty("line-pattern");if(this.lineMaterial=new l.VTLLineMaterial(this.computeAttributesKey(r.ShaderProgramType.LINE,l.VTLLineMaterial.ATTRIBUTES,l.VTLLineMaterial.ATTRIBUTES_INFO,n?"line-dasharray":"")),this.hasDataDrivenLine=this.getPaintProperty("line-blur")?.isDataDriven||this.getPaintProperty("line-color")?.isDataDriven||this.getPaintProperty("line-gap-width")?.isDataDriven||this.getPaintProperty("line-offset")?.isDataDriven||this.getPaintProperty("line-opacity")?.isDataDriven||this.getPaintProperty("line-pattern")?.isDataDriven||this.getPaintProperty("line-dasharray")?.isDataDriven||this.getLayoutProperty("line-cap")?.isDataDriven||this.getPaintProperty("line-width")?.isDataDriven,this.canUseThinTessellation=!1,!this.hasDataDrivenLine){const e=this.getPaintProperty("line-width");if(!e||"number"==typeof e&&.5*e<y.thinLineHalfWidthThreshold){const e=this.getPaintProperty("line-offset");(!e||"number"==typeof e&&0===e)&&(this.canUseThinTessellation=!0)}}}getDashKey(t,i){let r;switch(i){case e.CapType.BUTT:r="Butt";break;case e.CapType.ROUND:r="Round";break;case e.CapType.SQUARE:r="Square";break;default:r="Butt"}return`dasharray-[${t.toString()}]-${r}`}getFeatureInflatedBounds(e,t,i,r){const s=f(e);if(!s)return null;const n=this.getPaintValue("line-translate",t,e),a=r*Math.max(n[0],n[1]);s[0]-=a,s[2]-=a,s[1]+=a,s[3]+=a;const o=r*Math.abs(this.getPaintValue("line-offset",t,e)||0),l=r*(this.getPaintValue("line-width",t,e)/2);return s[0]-=o+l,s[1]-=o+l,s[2]+=o+l,s[3]+=o+l,s}isIntersectingFeature(e,t,r,n,a,o,l){let c=n.getGeometry();if(!c)return!1;const h=i.tilePixelRatio/l.normalizationRatio;e=e/l.normalizationRatio+l.normalizationOffsetX,t=t/l.normalizationRatio+l.normalizationOffsetY;const u=s.translateAnchor(this.getPaintValue("line-translate",a,n),this.getPaintValue("line-translate-anchor",a,n),o,i.tilePixelRatio);e-=h*u.x,t-=h*u.y;const p=h*this.getPaintValue("line-offset",a,n)||0;0!==p&&(c=s.offsetLine(c,-p));const y=this.getPaintValue("line-width",a,n)/2;return s.distanceFromToPolylineWithinThreshold(e,t,c,h*(r+y))}},e.StyleLayer=g,e.SymbolStyleLayer=class extends g{constructor(e,t,i,s){super(e,t,i,s),this.iconMaterial=new c.VTLIconMaterial(this.computeAttributesKey(r.ShaderProgramType.ICON,c.VTLIconMaterial.ATTRIBUTES,c.VTLIconMaterial.ATTRIBUTES_INFO)),this.textMaterial=new c.VTLTextMaterial(this.computeAttributesKey(r.ShaderProgramType.TEXT,c.VTLTextMaterial.ATTRIBUTES,c.VTLTextMaterial.ATTRIBUTES_INFO)),this.hasDataDrivenIcon=this.getPaintProperty("icon-color")?.isDataDriven||this.getPaintProperty("icon-halo-blur")?.isDataDriven||this.getPaintProperty("icon-halo-color")?.isDataDriven||this.getPaintProperty("icon-halo-width")?.isDataDriven||this.getPaintProperty("icon-opacity")?.isDataDriven||this.getLayoutProperty("icon-size")?.isDataDriven,this.hasDataDrivenText=this.getPaintProperty("text-color")?.isDataDriven||this.getPaintProperty("text-halo-blur")?.isDataDriven||this.getPaintProperty("text-halo-color")?.isDataDriven||this.getPaintProperty("text-halo-width")?.isDataDriven||this.getPaintProperty("text-opacity")?.isDataDriven||this.getLayoutProperty("text-size")?.isDataDriven}},e.TextLayout=class{constructor(e,t,i){let r;this.allowOverlap=e.getLayoutValue("text-allow-overlap",t),this.ignorePlacement=e.getLayoutValue("text-ignore-placement",t),this.keepUpright=e.getLayoutValue("text-keep-upright",t),this.optional=e.getLayoutValue("text-optional",t),this.rotationAlignment=e.getLayoutValue("text-rotation-alignment",t),this.rotationAlignment===u.RotationAlignment.AUTO&&(this.rotationAlignment=i?u.RotationAlignment.MAP:u.RotationAlignment.VIEWPORT),r=e.getLayoutProperty("text-anchor"),r?.isDataDriven?this._anchorProp=r:this.anchor=e.getLayoutValue("text-anchor",t),r=e.getLayoutProperty("text-justify"),r?.isDataDriven?this._justifyProp=r:this.justify=e.getLayoutValue("text-justify",t),r=e.getLayoutProperty("text-letter-spacing"),r?.isDataDriven?this._letterSpacingProp=r:this.letterSpacing=e.getLayoutValue("text-letter-spacing",t),r=e.getLayoutProperty("text-line-height"),r?.isDataDriven?this._lineHeightProp=r:this.lineHeight=e.getLayoutValue("text-line-height",t),r=e.getLayoutProperty("text-max-angle"),r?.isDataDriven?this._maxAngleProp=r:this.maxAngle=e.getLayoutValue("text-max-angle",t),r=e.getLayoutProperty("text-max-width"),r?.isDataDriven?this._maxWidthProp=r:this.maxWidth=e.getLayoutValue("text-max-width",t),r=e.getLayoutProperty("text-offset"),r?.isDataDriven?this._offsetProp=r:this.offset=e.getLayoutValue("text-offset",t),r=e.getLayoutProperty("text-padding"),r?.isDataDriven?this._paddingProp=r:this.padding=e.getLayoutValue("text-padding",t),r=e.getLayoutProperty("text-rotate"),r?.isDataDriven?this._rotateProp=r:this.rotate=e.getLayoutValue("text-rotate",t),r=e.getLayoutProperty("text-size"),r?.isDataDriven?this._sizeProp=r:this.size=e.getLayoutValue("text-size",t),r=e.getLayoutProperty("text-writing-mode"),r?.isDataDriven?this._writingModeProp=r:this.writingMode=e.getLayoutValue("text-writing-mode",t)}update(e,t){this._anchorProp&&(this.anchor=this._anchorProp.getValue(e,t)),this._justifyProp&&(this.justify=this._justifyProp.getValue(e,t)),this._letterSpacingProp&&(this.letterSpacing=this._letterSpacingProp.getValue(e,t)),this._lineHeightProp&&(this.lineHeight=this._lineHeightProp.getValue(e,t)),this._maxAngleProp&&(this.maxAngle=this._maxAngleProp.getValue(e,t)),this._maxWidthProp&&(this.maxWidth=this._maxWidthProp.getValue(e,t)),this._offsetProp&&(this.offset=this._offsetProp.getValue(e,t)),this._paddingProp&&(this.padding=this._paddingProp.getValue(e,t)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(e,t)),this._sizeProp&&(this.size=this._sizeProp.getValue(e,t)),this._writingModeProp&&(this.writingMode=this._writingModeProp.getValue(e,t))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/shaders/VTLBackgroundMaterial":function(){define(["exports","./VTLMaterial","../../../../webgl/enums","../../../../webgl/VertexElementDescriptor"],(function(e,t,i,r){"use strict";class s extends t.VTLMaterial{static{this.ATTRIBUTES=[]}static{this.GEOMETRY_LAYOUT=[new r.VertexElementDescriptor("a_pos",2,i.DataType.BYTE,0,2)]}static{this.ATTRIBUTES_INFO={}}constructor(e){super(e)}geometryInfo(){return s.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return s.ATTRIBUTES}attributesInfo(){return s.ATTRIBUTES_INFO}}e.VTLBackgroundMaterial=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/shaders/VTLMaterial":function(){define(["exports","../MemoryBuffer","./enums","../../../../webgl/enums","../../../../webgl/VertexElementDescriptor"],(function(e,t,i,r,s){"use strict";class n{constructor(e){this._locations=new Map,this._key=e}get key(){return this._key}get type(){return 7&this._key}defines(){return[]}getStride(){return this._layout||this._buildAttributesInfo(),this._stride}getAttributeLocations(){return 0===this._locations.size&&this._buildAttributesInfo(),this._locations}getLayoutInfo(){return this._layout||this._buildAttributesInfo(),this._layout}getEncodingInfos(){return this._propertyEncodingInfo||this._buildAttributesInfo(),this._propertyEncodingInfo}getUniforms(){return this._uniforms||this._buildAttributesInfo(),this._uniforms}getShaderHeader(){return this._shaderHeader||this._buildAttributesInfo(),this._shaderHeader}getShaderMain(){return this._shaderMain||this._buildAttributesInfo(),this._shaderMain}setDataUniforms(e,t,i,r,s){const n=this.getUniforms();for(const a of n){const{name:n,type:o,getValue:l}=a,c=l(i,t,r,s);if(null!==c)switch(o){case"float":e.setUniform1f(n,c);break;case"vec2":e.setUniform2fv(n,c);break;case"vec4":e.setUniform4fv(n,c)}}}encodeAttributes(e,t,r,s){const n=this.attributesInfo(),a=this.getEncodingInfos(),o=[];let l=0,c=0;for(const h of Object.keys(a)){const u=a[h],{type:p,precisionFactor:y,isLayout:d}=n[h],g=d?r.getLayoutProperty(h):r.getPaintProperty(h),f=g.interpolator?.getInterpolationRange(t);let _=0;for(const r of u){const{offset:n,bufferElementsToAdd:a}=r;if(a>0){for(let e=0;e<a;e++)o.push(0);l+=c,c=r.bufferElementsToAdd}const h=s??g.getValue(f?f[_]:t,e);switch(p){case i.EncodingType.R8_SIGNED:case i.EncodingType.R8_UNSIGNED:o[l]|=this._encodeByte(h*(y||1),8*n);break;case i.EncodingType.R16_SIGNED:case i.EncodingType.R16_UNSIGNED:o[l]|=this._encodeShort(h*(y||1),8*n);break;case i.EncodingType.R8G8_SIGNED:case i.EncodingType.R8G8_UNSIGNED:o[l]|=this._encodeByte(h*(y||1),8*n),o[l]|=this._encodeByte(h*(y||1),8*n+8);break;case i.EncodingType.R16G16_SIGNED:case i.EncodingType.R16G16_UNSIGNED:o[l]|=this._encodeShort(h*(y||1),8*n),o[l]|=this._encodeShort(h*(y||1),8*n+16);break;case i.EncodingType.R8G8B8A8_SIGNED:case i.EncodingType.R8G8B8A8_UNSIGNED:o[l]|=this._encodeByte(h*(y||1),8*n),o[l]|=this._encodeByte(h*(y||1),8*n+8),o[l]|=this._encodeByte(h*(y||1),8*n+16),o[l]|=this._encodeByte(h*(y||1),8*n+24);break;case i.EncodingType.R8G8B8A8_COLOR:o[l]=this._encodeColor(h);break;case i.EncodingType.R16G16B16A16_DASHARRAY:case i.EncodingType.R16G16B16A16_PATTERN:this._encodePattern(l,o,h);break;default:throw new Error("Unsupported encoding type")}_++}}return o}getAtributeState(e){let t=0;const i=3+2*e;return t|=this._bit(i),t|=this._bit(i+1)<<1,t}static{this._encodingInfo={[i.EncodingType.R8_SIGNED]:{dataType:r.DataType.BYTE,bytesPerElement:1,count:1,normalized:!1},[i.EncodingType.R8_UNSIGNED]:{dataType:r.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:1,normalized:!1},[i.EncodingType.R16_SIGNED]:{dataType:r.DataType.SHORT,bytesPerElement:2,count:1,normalized:!1},[i.EncodingType.R16_UNSIGNED]:{dataType:r.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:1,normalized:!1},[i.EncodingType.R8G8_SIGNED]:{dataType:r.DataType.BYTE,bytesPerElement:1,count:2,normalized:!1},[i.EncodingType.R8G8_UNSIGNED]:{dataType:r.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:2,normalized:!1},[i.EncodingType.R16G16_SIGNED]:{dataType:r.DataType.SHORT,bytesPerElement:2,count:2,normalized:!1},[i.EncodingType.R16G16_UNSIGNED]:{dataType:r.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:2,normalized:!1},[i.EncodingType.R8G8B8A8_SIGNED]:{dataType:r.DataType.BYTE,bytesPerElement:1,count:4,normalized:!1},[i.EncodingType.R8G8B8A8_UNSIGNED]:{dataType:r.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:4,normalized:!1},[i.EncodingType.R8G8B8A8_COLOR]:{dataType:r.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:4,normalized:!0},[i.EncodingType.R16G16B16A16_DASHARRAY]:{dataType:r.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:4,normalized:!1},[i.EncodingType.R16G16B16A16_PATTERN]:{dataType:r.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:4,normalized:!1}}}_buildAttributesInfo(){const e=[],t={},s={};let a=-1;const o=this.attributesInfo(),l=this.attributes();let c=-1;for(const r of l){c++;const l=this.getAtributeState(c);if(l===i.AttributeStatus.UNIFORM||l===i.AttributeStatus.UNUSED)continue;const h=o[r],u=[];t[r]=u;const p=h.type;for(let t=0;t<l;t++){const{dataType:t,bytesPerElement:i,count:r,normalized:o}=n._encodingInfo[p],l=i*r,c=`${t}-${!0===o}`;let h=s[c],y=0;if(!h||h.count+r>4)a++,h={dataIndex:a,count:0,offset:0},4!==r&&(s[c]=h),e.push({location:-1,name:"a_data_"+a,count:r,type:t,normalized:o}),y=Math.ceil(Math.max(l/4,1));else{const t=e[h.dataIndex];t.count+=r,y=Math.ceil(Math.max(t.count*i/4,1))-Math.ceil(Math.max(h.offset/4,1))}u.push({dataIndex:h.dataIndex,offset:h.offset,bufferElementsToAdd:y}),h.offset+=l,h.count+=r}}for(const t of e)switch(t.type){case r.DataType.BYTE:case r.DataType.UNSIGNED_BYTE:t.count=4;break;case r.DataType.SHORT:case r.DataType.UNSIGNED_SHORT:t.count+=t.count%2}this._buildVertexBufferLayout(e);let h=0;const u=this._layout.get("geometry");for(const e of u)this._locations.set(e.name,h++);const p=this._layout.get("opacity");if(p)for(const e of p)this._locations.set(e.name,h++);this._buildShaderInfo(e,t),this._propertyEncodingInfo=t}_buildVertexBufferLayout(e){const t=new Map,i=this.geometryInfo();let r=i[0].stride;if(0===e.length)t.set("geometry",i);else{const n=[];let o=r;for(const t of e)r+=a(t.type)*t.count;for(const e of i)n.push(new s.VertexElementDescriptor(e.name,e.count,e.type,e.offset,r,e.normalized));for(const t of e)n.push(new s.VertexElementDescriptor(t.name,t.count,t.type,o,r,t.normalized)),o+=a(t.type)*t.count;t.set("geometry",n)}const n=this.opacityInfo();n&&t.set("opacity",n),this._layout=t,this._stride=r}_buildShaderInfo(e,t){let r="\n",s="\n";const a=[];for(const t of e)r+=`attribute ${this._getType(t.count)} ${t.name};\n`;const l=this.attributes(),c=this.attributesInfo();let h=-1;for(const e of l){h++;const{name:l,type:u,precisionFactor:p,isLayout:y}=c[e],d=p&&1!==p?" * "+1/p:"",{bytesPerElement:g,count:f}=n._encodingInfo[u],_=e=>`a_data_${e.dataIndex}${o(f,e.offset,g)}`;switch(this.getAtributeState(h)){case i.AttributeStatus.UNIFORM:{const t=this._getType(f),n=`u_${l}`;a.push({name:n,type:t,getValue:(t,r,s,n)=>{const a=y?t.getLayoutValue(e,r):t.getPaintValue(e,r);if(u===i.EncodingType.R16G16B16A16_DASHARRAY){const e=t.getDashKey(a,t.getLayoutValue("line-cap",r)),i=n.getMosaicItemPosition(e,!1);if(null==i)return null;const{tl:s,br:o}=i;return[s[0],o[1],o[0],s[1]]}if(u===i.EncodingType.R16G16B16A16_PATTERN){const t=n.getMosaicItemPosition(a,!e.includes("line-"));if(null==t)return null;const{tl:i,br:r}=t;return[i[0],r[1],r[0],i[1]]}if(u===i.EncodingType.R8G8B8A8_COLOR){const e=a[3];return[e*a[0],e*a[1],e*a[2],e]}return a}}),r+=`uniform ${t} ${n};\n`,s+=`${t} ${l} = ${n};\n`}break;case i.AttributeStatus.DATA_DRIVEN:{const i=_(t[e][0]);s+=`${this._getType(f)} ${l} = ${i}${d};\n`}break;case i.AttributeStatus.INTERPOLATED_DATA_DRIVEN:{const i=`u_t_${l}`;a.push({name:i,type:"float",getValue:(t,i,r,s)=>(y?t.getLayoutProperty(e):t.getPaintProperty(e)).interpolator.interpolationUniformValue(r,i)}),r+=`uniform float ${i};\n`;const n=_(t[e][0]),o=_(t[e][1]);s+=`${this._getType(f)} ${l} = mix(${n}${d}, ${o}${d}, ${i});\n`}}}this._shaderHeader=r,this._shaderMain=s,this._uniforms=a}_bit(e){return(this._key&1<<e)>>e}_getType(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4"}throw new Error("Invalid count")}_encodeColor(e){const i=255*e[3];return t.i8888to32(e[0]*i,e[1]*i,e[2]*i,i)}_encodePattern(e,t,i){if(!i?.rect)return;const r=i.rect,s=i.width,n=i.height;t[e]=this._encodeShort(r.x+2,0),t[e]|=this._encodeShort(r.y+2+n,16),t[e+1]=this._encodeShort(r.x+2+s,0),t[e+1]|=this._encodeShort(r.y+2,16)}_encodeByte(e,t){return(255&e)<<t}_encodeShort(e,t){return(65535&e)<<t}}const a=e=>{switch(e){case r.DataType.FLOAT:case r.DataType.INT:case r.DataType.UNSIGNED_INT:return 4;case r.DataType.SHORT:case r.DataType.UNSIGNED_SHORT:case r.DataType.HALF_FLOAT:return 2;case r.DataType.BYTE:case r.DataType.UNSIGNED_BYTE:return 1}},o=(e,t,i)=>{const r=t/i;if(1===e)switch(r){case 0:return".x";case 1:return".y";case 2:return".z";case 3:return".w"}else if(2===e)switch(r){case 0:return".xy";case 1:return".yz";case 2:return".zw"}else if(3===e)switch(r){case 0:return".xyz";case 1:return".yzw"}return""};e.VTLMaterial=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/MemoryBuffer":function(){define(["../../../../core/has"],(function(e){"use strict";return class{constructor(e){this._array=[],this._stride=e}get array(){return this._array}get index(){return 4*this._array.length/this._stride}get itemSize(){return this._stride}get sizeInBytes(){return 4*this._array.length}reset(){this.array.length=0}toBuffer(){return new Uint32Array(this._array).buffer}static i1616to32(e,t){return 65535&e|t<<16}static i8888to32(e,t,i,r){return 255&e|(255&t)<<8|(255&i)<<16|r<<24}static i8816to32(e,t,i){return 255&e|(255&t)<<8|i<<16}}}))},"esri/views/2d/engine/vectorTiles/shaders/enums":function(){define(["exports"],(function(e){"use strict";var t,i;e.EncodingType=void 0,(t=e.EncodingType||(e.EncodingType={}))[t.R8_SIGNED=0]="R8_SIGNED",t[t.R8_UNSIGNED=1]="R8_UNSIGNED",t[t.R16_SIGNED=2]="R16_SIGNED",t[t.R16_UNSIGNED=3]="R16_UNSIGNED",t[t.R8G8_SIGNED=4]="R8G8_SIGNED",t[t.R8G8_UNSIGNED=5]="R8G8_UNSIGNED",t[t.R16G16_SIGNED=6]="R16G16_SIGNED",t[t.R16G16_UNSIGNED=7]="R16G16_UNSIGNED",t[t.R8G8B8A8_SIGNED=8]="R8G8B8A8_SIGNED",t[t.R8G8B8A8_UNSIGNED=9]="R8G8B8A8_UNSIGNED",t[t.R8G8B8A8_COLOR=10]="R8G8B8A8_COLOR",t[t.R16G16B16A16_DASHARRAY=11]="R16G16B16A16_DASHARRAY",t[t.R16G16B16A16_PATTERN=12]="R16G16B16A16_PATTERN",e.AttributeStatus=void 0,(i=e.AttributeStatus||(e.AttributeStatus={}))[i.UNIFORM=0]="UNIFORM",i[i.DATA_DRIVEN=1]="DATA_DRIVEN",i[i.INTERPOLATED_DATA_DRIVEN=2]="INTERPOLATED_DATA_DRIVEN",i[i.UNUSED=3]="UNUSED",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/shaders/VTLCircleMaterial":function(){define(["exports","./enums","./VTLMaterial","../../../../webgl/enums","../../../../webgl/VertexElementDescriptor"],(function(e,t,i,r,s){"use strict";class n extends i.VTLMaterial{static{this.ATTRIBUTES=["circle-radius","circle-color","circle-opacity","circle-stroke-width","circle-stroke-color","circle-stroke-opacity","circle-blur"]}static{this.GEOMETRY_LAYOUT=[new s.VertexElementDescriptor("a_pos",2,r.DataType.SHORT,0,4)]}static{this.ATTRIBUTES_INFO={"circle-radius":{name:"radius",type:t.EncodingType.R8_UNSIGNED},"circle-color":{name:"color",type:t.EncodingType.R8G8B8A8_COLOR},"circle-opacity":{name:"opacity",type:t.EncodingType.R8_UNSIGNED,precisionFactor:100},"circle-stroke-width":{name:"stroke_width",type:t.EncodingType.R8_UNSIGNED,precisionFactor:4},"circle-stroke-color":{name:"stroke_color",type:t.EncodingType.R8G8B8A8_COLOR},"circle-stroke-opacity":{name:"stroke_opacity",type:t.EncodingType.R8_UNSIGNED,precisionFactor:100},"circle-blur":{name:"blur",type:t.EncodingType.R8_UNSIGNED,precisionFactor:32}}}constructor(e){super(e)}geometryInfo(){return n.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return n.ATTRIBUTES}attributesInfo(){return n.ATTRIBUTES_INFO}}e.VTLCircleMaterial=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/shaders/VTLFillMaterial":function(){define(["exports","./enums","./VTLMaterial","../../../../webgl/enums","../../../../webgl/VertexElementDescriptor"],(function(e,t,i,r,s){"use strict";class n extends i.VTLMaterial{static{this.ATTRIBUTES=["fill-color","fill-opacity","fill-pattern"]}static{this.GEOMETRY_LAYOUT=[new s.VertexElementDescriptor("a_pos",2,r.DataType.SHORT,0,4)]}static{this.ATTRIBUTES_INFO={"fill-color":{name:"color",type:t.EncodingType.R8G8B8A8_COLOR},"fill-opacity":{name:"opacity",type:t.EncodingType.R8_UNSIGNED,precisionFactor:100},"fill-pattern":{name:"tlbr",type:t.EncodingType.R16G16B16A16_PATTERN,isOptional:!0}}}constructor(e){super(e)}geometryInfo(){return n.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return n.ATTRIBUTES}attributesInfo(){return n.ATTRIBUTES_INFO}}class a extends i.VTLMaterial{static{this.ATTRIBUTES_OUTLINE=["fill-outline-color","fill-opacity"]}static{this.ATTRIBUTES_FILL=["fill-color","fill-opacity"]}static{this.GEOMETRY_LAYOUT=[new s.VertexElementDescriptor("a_pos",2,r.DataType.SHORT,0,8),new s.VertexElementDescriptor("a_offset",2,r.DataType.BYTE,4,8),new s.VertexElementDescriptor("a_xnormal",2,r.DataType.BYTE,6,8)]}static{this.ATTRIBUTES_INFO_OUTLINE={"fill-outline-color":{name:"color",type:t.EncodingType.R8G8B8A8_COLOR},"fill-opacity":{name:"opacity",type:t.EncodingType.R8_UNSIGNED,precisionFactor:100}}}static{this.ATTRIBUTES_INFO_FILL={"fill-color":{name:"color",type:t.EncodingType.R8G8B8A8_COLOR},"fill-opacity":{name:"opacity",type:t.EncodingType.R8_UNSIGNED,precisionFactor:100}}}constructor(e,t){super(e),this._usefillColor=t}geometryInfo(){return a.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return this._usefillColor?a.ATTRIBUTES_FILL:a.ATTRIBUTES_OUTLINE}attributesInfo(){return this._usefillColor?a.ATTRIBUTES_INFO_FILL:a.ATTRIBUTES_INFO_OUTLINE}}e.VTLFillMaterial=n,e.VTLOutlineMaterial=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/shaders/VTLLineMaterial":function(){define(["exports","./enums","./VTLMaterial","../../../../webgl/enums","../../../../webgl/VertexElementDescriptor"],(function(e,t,i,r,s){"use strict";class n extends i.VTLMaterial{static{this.ATTRIBUTES=["line-blur","line-color","line-gap-width","line-offset","line-opacity","line-width","line-pattern","line-dasharray"]}static{this.GEOMETRY_LAYOUT=[new s.VertexElementDescriptor("a_pos",2,r.DataType.SHORT,0,16),new s.VertexElementDescriptor("a_extrude_offset",4,r.DataType.BYTE,4,16),new s.VertexElementDescriptor("a_dir_normal",4,r.DataType.BYTE,8,16),new s.VertexElementDescriptor("a_accumulatedDistance",2,r.DataType.UNSIGNED_SHORT,12,16)]}static{this.ATTRIBUTES_INFO={"line-width":{name:"width",type:t.EncodingType.R8_UNSIGNED,precisionFactor:2},"line-gap-width":{name:"gap_width",type:t.EncodingType.R8_UNSIGNED,precisionFactor:2},"line-offset":{name:"offset",type:t.EncodingType.R8_SIGNED,precisionFactor:2},"line-color":{name:"color",type:t.EncodingType.R8G8B8A8_COLOR},"line-opacity":{name:"opacity",type:t.EncodingType.R8_UNSIGNED,precisionFactor:100},"line-blur":{name:"blur",type:t.EncodingType.R8_UNSIGNED,precisionFactor:4},"line-pattern":{name:"tlbr",type:t.EncodingType.R16G16B16A16_PATTERN,isOptional:!0},"line-dasharray":{name:"tlbr",type:t.EncodingType.R16G16B16A16_DASHARRAY,isOptional:!0}}}constructor(e){super(e)}geometryInfo(){return n.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return n.ATTRIBUTES}attributesInfo(){return n.ATTRIBUTES_INFO}}e.VTLLineMaterial=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/shaders/VTLSymbolMaterial":function(){define(["exports","./enums","./VTLMaterial","../../../../webgl/enums","../../../../webgl/VertexElementDescriptor"],(function(e,t,i,r,s){"use strict";const n=[new s.VertexElementDescriptor("a_pos",2,r.DataType.SHORT,0,16),new s.VertexElementDescriptor("a_vertexOffset",2,r.DataType.SHORT,4,16),new s.VertexElementDescriptor("a_texAngleRange",4,r.DataType.UNSIGNED_BYTE,8,16),new s.VertexElementDescriptor("a_levelInfo",4,r.DataType.UNSIGNED_BYTE,12,16)],a=[new s.VertexElementDescriptor("a_opacityInfo",1,r.DataType.UNSIGNED_BYTE,0,1)];class o extends i.VTLMaterial{static{this.ATTRIBUTES=["icon-color","icon-opacity","icon-halo-blur","icon-halo-color","icon-halo-width","icon-size"]}static{this.ATTRIBUTES_INFO={"icon-color":{name:"color",type:t.EncodingType.R8G8B8A8_COLOR},"icon-opacity":{name:"opacity",type:t.EncodingType.R8_UNSIGNED,precisionFactor:100},"icon-halo-color":{name:"halo_color",type:t.EncodingType.R8G8B8A8_COLOR},"icon-halo-width":{name:"halo_width",type:t.EncodingType.R8_UNSIGNED,precisionFactor:4},"icon-halo-blur":{name:"halo_blur",type:t.EncodingType.R8_UNSIGNED,precisionFactor:4},"icon-size":{name:"size",type:t.EncodingType.R8_UNSIGNED,precisionFactor:32,isLayout:!0}}}constructor(e){super(e)}geometryInfo(){return n}opacityInfo(){return a}attributes(){return o.ATTRIBUTES}attributesInfo(){return o.ATTRIBUTES_INFO}}class l extends i.VTLMaterial{static{this.ATTRIBUTES=["text-color","text-opacity","text-halo-blur","text-halo-color","text-halo-width","text-size"]}static{this.ATTRIBUTES_INFO={"text-color":{name:"color",type:t.EncodingType.R8G8B8A8_COLOR},"text-opacity":{name:"opacity",type:t.EncodingType.R8_UNSIGNED,precisionFactor:100},"text-halo-color":{name:"halo_color",type:t.EncodingType.R8G8B8A8_COLOR},"text-halo-width":{name:"halo_width",type:t.EncodingType.R8_UNSIGNED,precisionFactor:4},"text-halo-blur":{name:"halo_blur",type:t.EncodingType.R8_UNSIGNED,precisionFactor:4},"text-size":{name:"size",type:t.EncodingType.R8_UNSIGNED,isLayout:!0}}}constructor(e){super(e)}geometryInfo(){return n}opacityInfo(){return a}attributes(){return l.ATTRIBUTES}attributesInfo(){return l.ATTRIBUTES_INFO}}e.VTLIconMaterial=o,e.VTLTextMaterial=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/style/Filter":function(){define(["../expression/expression","../expression/types"],(function(e,t){"use strict";class i{constructor(e){this._expression=e}filter(e,t){if(!this._expression)return!0;try{return this._expression.evaluate(e,t)}catch(e){return console.log(e.message),!0}}static createFilter(r){if(!r)return null;this.isLegacyFilter(r)&&(r=this.convertLegacyFilter(r));try{const s=e.createExpression(r,null,t.booleanType);return new i(s)}catch(e){return console.log(e.message),null}}static isLegacyFilter(e){if(!Array.isArray(e))return!0;if(0===e.length)return!0;switch(e[0]){case"==":case"!=":case">":case"<":case">=":case"<=":return 3===e.length&&"string"==typeof e[1]&&!Array.isArray(e[2]);case"in":return e.length>=3&&"string"==typeof e[1]&&!Array.isArray(e[2]);case"!in":case"none":case"!has":return!0;case"any":case"all":for(let t=1;t<e.length;t++)if(this.isLegacyFilter(e[t]))return!0;return!1;case"has":return 2===e.length&&("$id"===e[1]||"$type"===e[1]);default:return!1}}static convertLegacyFilter(e){if(!Array.isArray(e)||0===e.length)return!0;const t=e[0];if(1===e.length)return"any"!==t;switch(t){case"==":return i.convertComparison("==",e[1],e[2]);case"!=":return i.negate(i.convertComparison("==",e[1],e[2]));case">":case"<":case">=":case"<=":return i.convertComparison(t,e[1],e[2]);case"in":return i.convertIn(e[1],e.slice(2));case"!in":return i.negate(i.convertIn(e[1],e.slice(2)));case"any":case"all":case"none":return i.convertCombining(t,e.slice(1));case"has":return i.convertHas(e[1]);case"!has":return i.negate(i.convertHas(e[1]));default:throw new Error("Unexpected legacy filter.")}}static convertComparison(e,t,i){switch(t){case"$type":return[e,["geometry-type"],i];case"$id":return[e,["id"],i];default:return[e,["get",t],i]}}static convertIn(e,t){switch(e){case"$type":return["in",["geometry-type"],["literal",t]];case"$id":return["in",["id"],["literal",t]];default:return["in",["get",e],["literal",t]]}}static convertHas(e){switch(e){case"$type":return!0;case"$id":return["has-id"];default:return["has",e]}}static convertCombining(e,t){return[e].concat(t.map(this.convertLegacyFilter))}static negate(e){return["!",e]}}return i}))},"esri/views/2d/engine/vectorTiles/expression/expression":function(){define(["exports","../../../../../Color","../../../../../core/colorUtils","../../../../../geometry/support/TileClipper","../../../unitBezier","../GeometryUtils","./types"],(function(e,t,i,r,s,n,a){"use strict";class o{constructor(e){this._parent=e,this._vars={}}add(e,t){this._vars[e]=t}get(e){return this._vars[e]?this._vars[e]:this._parent?this._parent.get(e):null}}class l{constructor(){this.type=a.valueType}static parse(e){if(e.length>1)throw new Error('"id" does not expect arguments');return new l}evaluate(e,t){return e?.id}}class c{constructor(){this.type=a.stringType}static parse(e){if(e.length>1)throw new Error('"geometry-type" does not expect arguments');return new c}evaluate(e,t){if(!e)return null;switch(e.type){case r.GeometryType.Point:return"Point";case r.GeometryType.LineString:return"LineString";case r.GeometryType.Polygon:return"Polygon";default:return null}}}class h{constructor(){this.type=a.objectType}static parse(e){if(e.length>1)throw new Error('"properties" does not expect arguments');return new h}evaluate(e,t){return e?.values}}class u{constructor(){this.type=a.numberType}static parse(e){if(e.length>1)throw new Error('"zoom" does not expect arguments');return new u}evaluate(e,t){return t}}class p{constructor(e,t,i){this._lhs=e,this._rhs=t,this._compare=i,this.type=a.booleanType}static parse(e,t,i){if(3!==e.length&&4!==e.length)throw new Error(`"${e[0]}" expects 2 or 3 arguments`);if(4===e.length)throw new Error(`"${e[0]}" collator not supported`);return new p(te(e[1],t),te(e[2],t),i)}evaluate(e,t){return this._compare(this._lhs.evaluate(e,t),this._rhs.evaluate(e,t))}}class y extends p{static parse(e,t){return p.parse(e,t,((e,t)=>e===t))}}class d extends p{static parse(e,t){return p.parse(e,t,((e,t)=>e!==t))}}class g extends p{static parse(e,t){return p.parse(e,t,((e,t)=>e<t))}}class f extends p{static parse(e,t){return p.parse(e,t,((e,t)=>e<=t))}}class _ extends p{static parse(e,t){return p.parse(e,t,((e,t)=>e>t))}}class m extends p{static parse(e,t){return p.parse(e,t,((e,t)=>e>=t))}}class T{constructor(e){this._arg=e,this.type=a.booleanType}static parse(e,t){if(2!==e.length)throw new Error('"!" expects 1 argument');return new T(te(e[1],t))}evaluate(e,t){return!this._arg.evaluate(e,t)}}class w{constructor(e){this._args=e,this.type=a.booleanType}static parse(e,t){const i=[];for(let r=1;r<e.length;r++)i.push(te(e[r],t));return new w(i)}evaluate(e,t){for(const i of this._args)if(!i.evaluate(e,t))return!1;return!0}}class b{constructor(e){this._args=e,this.type=a.booleanType}static parse(e,t){const i=[];for(let r=1;r<e.length;r++)i.push(te(e[r],t));return new b(i)}evaluate(e,t){for(const i of this._args)if(i.evaluate(e,t))return!0;return!1}}class v{constructor(e){this._args=e,this.type=a.booleanType}static parse(e,t){const i=[];for(let r=1;r<e.length;r++)i.push(te(e[r],t));return new v(i)}evaluate(e,t){for(const i of this._args)if(i.evaluate(e,t))return!1;return!0}}class S{constructor(e,t,i){this.type=e,this._args=t,this._fallback=i}static parse(e,t,i){if(e.length<4)throw new Error('"case" expects at least 3 arguments');if(e.length%2==1)throw new Error('"case" expects an odd number of arguments');let r;const s=[];for(let n=1;n<e.length-1;n+=2){const a=te(e[n],t),o=te(e[n+1],t,i);r||(r=o.type),s.push({condition:a,output:o})}const n=te(e[e.length-1],t,i);return r||(r=n.type),new S(r,s,n)}evaluate(e,t){for(const i of this._args)if(i.condition.evaluate(e,t))return i.output.evaluate(e,t);return this._fallback.evaluate(e,t)}}class x{constructor(e,t){this.type=e,this._args=t}static parse(e,t){if(e.length<2)throw new Error('"coalesce" expects at least 1 argument');let i;const r=[];for(let s=1;s<e.length;s++){const n=te(e[s],t);i||(i=n.type),r.push(n)}return new x(i,r)}evaluate(e,t){for(const i of this._args){const r=i.evaluate(e,t);if(null!==r)return r}return null}}class E{constructor(e,t,i,r,s){this.type=e,this._input=t,this._labels=i,this._outputs=r,this._fallback=s}static parse(e,t){if(e.length<3)throw new Error('"match" expects at least 3 arguments');if(e.length%2==0)throw new Error('"case" expects an even number of arguments');let i;const r=te(e[1],t),s=[],n={};let a;for(let r=2;r<e.length-1;r+=2){let o=e[r];Array.isArray(o)||(o=[o]);for(const e of o){const t=typeof e;if("string"!==t&&"number"!==t)throw new Error('"match" requires string or number literal as labels');if(a){if(t!==a)throw new Error('"match" requires labels to have the same type')}else a=t;n[e]=s.length}const l=te(e[r+1],t);i||(i=l.type),s.push(l)}return new E(i,r,n,s,te(e[e.length-1],t))}evaluate(e,t){const i=this._input.evaluate(e,t);return(this._outputs[this._labels[i]]||this._fallback).evaluate(e,t)}}class D{constructor(e,t,i,r,s){this._operator=e,this.type=t,this.interpolation=i,this.input=r,this._stops=s}static parse(e,t,i){const r=e[0];if(e.length<5)throw new Error(`"${r}" expects at least 4 arguments`);const s=e[1];if(!Array.isArray(s)||0===s.length)throw new Error(`"${s}" is not a valid interpolation`);switch(s[0]){case"linear":if(1!==s.length)throw new Error("Linear interpolation cannot have parameters");break;case"exponential":if(2!==s.length||"number"!=typeof s[1])throw new Error("Exponential interpolation requires one numeric argument");break;case"cubic-bezier":if(5!==s.length)throw new Error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1");for(let e=1;e<5;e++){const t=s[e];if("number"!=typeof t||t<0||t>1)throw new Error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1")}break;default:throw new Error(`"${e[0]}" unknown interpolation type "${s[0]}"`)}if(e.length%2!=1)throw new Error(`"${r}" expects an even number of arguments`);const n=te(e[2],t,a.numberType);let o;"interpolate-hcl"===r||"interpolate-lab"===r?o=a.colorType:i&&"value"!==i.kind&&(o=i);const l=[];for(let i=3;i<e.length;i+=2){const s=e[i];if("number"!=typeof s)throw new Error(`"${r}" requires stop inputs as literal numbers`);if(l.length&&l[l.length-1][0]>=s)throw new Error(`"${r}" requires strictly ascending stop inputs`);const n=te(e[i+1],t,o);o||(o=n.type),l.push([s,n])}if(o&&o!==a.colorType&&o!==a.numberType&&("array"!==o.kind||o.itemType!==a.numberType))throw new Error(`"${r}" cannot interpolate type ${a.typeToString(o)}`);return new D(r,o,s,n,l)}evaluate(e,r){const s=this._stops;if(1===s.length)return s[0][1].evaluate(e,r);const o=this.input.evaluate(e,r);if(o<=s[0][0])return s[0][1].evaluate(e,r);if(o>=s[s.length-1][0])return s[s.length-1][1].evaluate(e,r);let l=0;for(;++l<s.length&&!(o<s[l][0]););const c=s[l-1][0],h=s[l][0],u=D.interpolationRatio(this.interpolation,o,c,h),p=s[l-1][1].evaluate(e,r),y=s[l][1].evaluate(e,r);if("interpolate"===this._operator){if("array"===this.type.kind&&Array.isArray(p)&&Array.isArray(y))return p.map(((e,t)=>n.interpolate(e,y[t],u)));if("color"===this.type.kind&&p instanceof t&&y instanceof t){const e=new t(p),i=new t(y);return new t([n.interpolate(e.r,i.r,u),n.interpolate(e.g,i.g,u),n.interpolate(e.b,i.b,u),n.interpolate(e.a,i.a,u)])}if("number"===this.type.kind&&"number"==typeof p&&"number"==typeof y)return n.interpolate(p,y,u);throw new Error(`"${this._operator}" cannot interpolate type ${a.typeToString(this.type)}`)}if("interpolate-hcl"===this._operator){const e=i.toLCH(p),r=i.toLCH(y),s=r.h-e.h,a=i.toRGB({h:e.h+u*(s>180||s<-180?s-360*Math.round(s/360):s),c:n.interpolate(e.c,r.c,u),l:n.interpolate(e.l,r.l,u)});return new t({a:n.interpolate(p.a,y.a,u),...a})}if("interpolate-lab"===this._operator){const e=i.toLAB(p),r=i.toLAB(y),s=i.toRGB({l:n.interpolate(e.l,r.l,u),a:n.interpolate(e.a,r.a,u),b:n.interpolate(e.b,r.b,u)});return new t({a:n.interpolate(p.a,y.a,u),...s})}throw new Error(`Unexpected operator "${this._operator}"`)}interpolationUniformValue(e,t){const i=this._stops;if(1===i.length)return 0;if(e>=i[i.length-1][0])return 0;let r=0;for(;++r<i.length&&!(e<i[r][0]););const s=i[r-1][0],n=i[r][0];return D.interpolationRatio(this.interpolation,t,s,n)}getInterpolationRange(e){const t=this._stops;if(1===t.length){const e=t[0][0];return[e,e]}const i=t[t.length-1][0];if(e>=i)return[i,i];let r=0;for(;++r<t.length&&!(e<t[r][0]););return[t[r-1][0],t[r][0]]}static interpolationRatio(e,t,i,r){let n=0;return"linear"===e[0]?n=D._exponentialInterpolationRatio(t,1,i,r):"exponential"===e[0]?n=D._exponentialInterpolationRatio(t,e[1],i,r):"cubic-bezier"===e[0]&&(n=s.unitBezier(e[1],e[2],e[3],e[4])(D._exponentialInterpolationRatio(t,1,i,r),1e-5)),n<0?n=0:n>1&&(n=1),n}static _exponentialInterpolationRatio(e,t,i,r){const s=r-i;if(0===s)return 0;const n=e-i;return 1===t?n/s:(t**n-1)/(t**s-1)}}class I{constructor(e,t,i){this.type=e,this._input=t,this._stops=i}static parse(e,t){if(e.length<5)throw new Error('"step" expects at least 4 arguments');if(e.length%2!=1)throw new Error('"step" expects an even number of arguments');const i=te(e[1],t,a.numberType);let r;const s=[];s.push([-1/0,te(e[2],t)]);for(let i=3;i<e.length;i+=2){const n=e[i];if("number"!=typeof n)throw new Error('"step" requires stop inputs as literal numbers');if(s.length&&s[s.length-1][0]>=n)throw new Error('"step" requires strictly ascending stop inputs');const a=te(e[i+1],t);r||(r=a.type),s.push([n,a])}return new I(r,i,s)}evaluate(e,t){const i=this._stops;if(1===i.length)return i[0][1].evaluate(e,t);const r=this._input.evaluate(e,t);let s=0;for(;++s<i.length&&!(r<i[s][0]););return this._stops[s-1][1].evaluate(e,t)}}class L{constructor(e,t){this.type=e,this._output=t}static parse(e,t,i){if(e.length<4)throw new Error('"let" expects at least 3 arguments');if(e.length%2==1)throw new Error('"let" expects an odd number of arguments');const r=new o(t);for(let i=1;i<e.length-1;i+=2){const s=e[i];if("string"!=typeof s)throw new Error(`"let" requires a string to define variable names - found ${s}`);r.add(s,te(e[i+1],t))}const s=te(e[e.length-1],r,i);return new L(s.type,s)}evaluate(e,t){return this._output.evaluate(e,t)}}class R{constructor(e,t){this.type=e,this.output=t}static parse(e,t,i){if(2!==e.length||"string"!=typeof e[1])throw new Error('"var" requires just one literal string argument');const r=t.get(e[1]);if(!r)throw new Error(`${e[1]} must be defined before being used in a "var" expression`);return new R(i||a.valueType,r)}evaluate(e,t){return this.output.evaluate(e,t)}}class P{constructor(e,t,i){this.type=e,this._index=t,this._array=i}static parse(e,t){if(3!==e.length)throw new Error('"at" expects 2 arguments');const i=te(e[1],t,a.numberType),r=te(e[2],t);return new P(r.type.itemType,i,r)}evaluate(e,t){const i=this._index.evaluate(e,t),r=this._array.evaluate(e,t);if(i<0||i>=r.length)throw new Error('"at" index out of bounds');if(i!==Math.floor(i))throw new Error('"at" index must be an integer');return r[i]}}class A{constructor(e,t){this._key=e,this._obj=t,this.type=a.valueType}static parse(e,t){let i,r;switch(e.length){case 2:return i=te(e[1],t),new A(i);case 3:return i=te(e[1],t),r=te(e[2],t),new A(i,r);default:throw new Error('"get" expects 1 or 2 arguments')}}evaluate(e,t){const i=this._key.evaluate(e,t);return this._obj?this._obj.evaluate(e,t)[i]:e?.values[i]}}class M{constructor(e,t){this._key=e,this._obj=t,this.type=a.booleanType}static parse(e,t){let i,r;switch(e.length){case 2:return i=te(e[1],t),new M(i);case 3:return i=te(e[1],t),r=te(e[2],t),new M(i,r);default:throw new Error('"has" expects 1 or 2 arguments')}}evaluate(e,t){const i=this._key.evaluate(e,t);return this._obj?i in this._obj.evaluate(e,t):!!e?.values[i]}}class C{constructor(e,t){this._key=e,this._vals=t,this.type=a.booleanType}static parse(e,t){if(3!==e.length)throw new Error('"in" expects 2 arguments');return new C(te(e[1],t),te(e[2],t))}evaluate(e,t){const i=this._key.evaluate(e,t);return this._vals.evaluate(e,t).includes(i)}}class U{constructor(e,t,i){this._item=e,this._array=t,this._from=i,this.type=a.numberType}static parse(e,t){if(e.length<3||e.length>4)throw new Error('"index-of" expects 3 or 4 arguments');const i=te(e[1],t),r=te(e[2],t);if(4===e.length){const s=te(e[3],t,a.numberType);return new U(i,r,s)}return new U(i,r)}evaluate(e,t){const i=this._item.evaluate(e,t),r=this._array.evaluate(e,t);if(this._from){const s=this._from.evaluate(e,t);if(s!==Math.floor(s))throw new Error('"index-of" index must be an integer');return r.indexOf(i,s)}return r.indexOf(i)}}class N{constructor(e){this._arg=e,this.type=a.numberType}static parse(e,t){if(2!==e.length)throw new Error('"length" expects 2 arguments');const i=te(e[1],t);return new N(i)}evaluate(e,t){const i=this._arg.evaluate(e,t);if("string"==typeof i)return i.length;if(Array.isArray(i))return i.length;throw new Error('"length" expects string or array')}}class O{constructor(e,t,i,r){this.type=e,this._array=t,this._from=i,this._to=r}static parse(e,t){if(e.length<3||e.length>4)throw new Error('"slice" expects 2 or 3 arguments');const i=te(e[1],t),r=te(e[2],t,a.numberType);if(r.type!==a.numberType)throw new Error('"slice" index must return a number');if(4===e.length){const s=te(e[3],t,a.numberType);if(s.type!==a.numberType)throw new Error('"slice" index must return a number');return new O(i.type,i,r,s)}return new O(i.type,i,r)}evaluate(e,t){const i=this._array.evaluate(e,t);if(!Array.isArray(i)&&"string"!=typeof i)throw new Error('"slice" input must be an array or a string');const r=this._from.evaluate(e,t);if(r<0||r>=i.length)throw new Error('"slice" index out of bounds');if(r!==Math.floor(r))throw new Error('"slice" index must be an integer');if(this._to){const s=this._to.evaluate(e,t);if(s<0||s>=i.length)throw new Error('"slice" index out of bounds');if(s!==Math.floor(s))throw new Error('"slice" index must be an integer');return i.slice(r,s)}return i.slice(r)}}class B{constructor(){this.type=a.booleanType}static parse(e){if(1!==e.length)throw new Error('"has-id" expects no arguments');return new B}evaluate(e,t){return void 0!==e?.id}}class V{constructor(e,t){this._args=e,this._calculate=t,this.type=a.numberType}static parse(e,t,i){const r=e.slice(1).map((e=>te(e,t)));return new V(r,i)}evaluate(e,t){let i;return this._args&&(i=this._args.map((i=>i.evaluate(e,t)))),this._calculate(i)}}class k extends V{static parse(e,t){switch(e.length){case 2:return V.parse(e,t,(e=>-e[0]));case 3:return V.parse(e,t,(e=>e[0]-e[1]));default:throw new Error('"-" expects 1 or 2 arguments')}}}class G extends V{static parse(e,t){return V.parse(e,t,(e=>{let t=1;for(const i of e)t*=i;return t}))}}class F extends V{static parse(e,t){if(3===e.length)return V.parse(e,t,(e=>e[0]/e[1]));throw new Error('"/" expects 2 arguments')}}class z extends V{static parse(e,t){if(3===e.length)return V.parse(e,t,(e=>e[0]%e[1]));throw new Error('"%" expects 2 arguments')}}class H extends V{static parse(e,t){if(3===e.length)return V.parse(e,t,(e=>e[0]**e[1]));throw new Error('"^" expects 1 or 2 arguments')}}class Y extends V{static parse(e,t){return V.parse(e,t,(e=>{let t=0;for(const i of e)t+=i;return t}))}}class q{constructor(e,t){this._args=e,this._calculate=t,this.type=a.numberType}static{this.ops={abs:e=>Math.abs(e[0]),acos:e=>Math.acos(e[0]),asin:e=>Math.asin(e[0]),atan:e=>Math.atan(e[0]),ceil:e=>Math.ceil(e[0]),cos:e=>Math.cos(e[0]),e:()=>Math.E,floor:e=>Math.floor(e[0]),ln:e=>Math.log(e[0]),ln2:()=>Math.LN2,log10:e=>Math.log(e[0])/Math.LN10,log2:e=>Math.log(e[0])/Math.LN2,max:e=>Math.max(...e),min:e=>Math.min(...e),pi:()=>Math.PI,round:e=>Math.round(e[0]),sin:e=>Math.sin(e[0]),sqrt:e=>Math.sqrt(e[0]),tan:e=>Math.tan(e[0])}}static parse(e,t){const i=e.slice(1).map((e=>te(e,t)));return new q(i,q.ops[e[0]])}evaluate(e,t){let i;return this._args&&(i=this._args.map((i=>i.evaluate(e,t)))),this._calculate(i)}}class ${constructor(e){this._args=e,this.type=a.stringType}static parse(e,t){return new $(e.slice(1).map((e=>te(e,t))))}evaluate(e,t){return this._args.map((i=>i.evaluate(e,t))).join("")}}class j{constructor(e,t){this._arg=e,this._calculate=t,this.type=a.stringType}static{this.ops={downcase:e=>e.toLowerCase(),upcase:e=>e.toUpperCase()}}static parse(e,t){if(2!==e.length)throw new Error(`${e[0]} expects 1 argument`);const i=te(e[1],t);return new j(i,j.ops[e[0]])}evaluate(e,t){return this._calculate(this._arg.evaluate(e,t))}}class Q{constructor(e){this._args=e,this.type=a.colorType}static parse(e,t){if(4!==e.length)throw new Error('"rgb" expects 3 arguments');const i=e.slice(1).map((e=>te(e,t)));return new Q(i)}evaluate(e,i){const r=this._validate(this._args[0].evaluate(e,i)),s=this._validate(this._args[1].evaluate(e,i)),n=this._validate(this._args[2].evaluate(e,i));return new t({r,g:s,b:n})}_validate(e){if("number"!=typeof e||e<0||e>255)throw new Error(`${e}: invalid color component`);return Math.round(e)}}class K{constructor(e){this._args=e,this.type=a.colorType}static parse(e,t){if(5!==e.length)throw new Error('"rgba" expects 4 arguments');const i=e.slice(1).map((e=>te(e,t)));return new K(i)}evaluate(e,i){const r=this._validate(this._args[0].evaluate(e,i)),s=this._validate(this._args[1].evaluate(e,i)),n=this._validate(this._args[2].evaluate(e,i)),a=this._validateAlpha(this._args[3].evaluate(e,i));return new t({r,g:s,b:n,a})}_validate(e){if("number"!=typeof e||e<0||e>255)throw new Error(`${e}: invalid color component`);return Math.round(e)}_validateAlpha(e){if("number"!=typeof e||e<0||e>1)throw new Error(`${e}: invalid alpha color component`);return e}}class X{constructor(e){this._color=e,this.type=a.arrayType(a.numberType,4)}static parse(e,t){if(2!==e.length)throw new Error('"to-rgba" expects 1 argument');const i=te(e[1],t);return new X(i)}evaluate(e,i){return new t(this._color.evaluate(e,i)).toRgba()}}class W{constructor(e,t){this.type=e,this._args=t}static parse(e,t){const i=e[0];if(e.length<2)throw new Error(`${i} expects at least one argument`);let r,s=1;if("array"===i){if(e.length>2){switch(e[1]){case"string":r=a.stringType;break;case"number":r=a.numberType;break;case"boolean":r=a.booleanType;break;default:throw new Error('"array" type argument must be string, number or boolean')}s++}else r=a.valueType;let t;if(e.length>3){if(t=e[2],null!==t&&("number"!=typeof t||t<0||t!==Math.floor(t)))throw new Error('"array" length argument must be a positive integer literal');s++}r=a.arrayType(r,t)}else switch(i){case"string":r=a.stringType;break;case"number":r=a.numberType;break;case"boolean":r=a.booleanType;break;case"object":r=a.objectType}const n=[];for(;s<e.length;s++){const i=te(e[s],t);n.push(i)}return new W(r,n)}evaluate(e,t){let i;for(const r of this._args){const s=r.evaluate(e,t);if(i=a.getType(s),a.matchType(i,this.type))return s}throw new Error(`Expected ${a.typeToString(this.type)} but got ${a.typeToString(i)}`)}}class Z{static{this.types={"to-boolean":a.booleanType,"to-color":a.colorType,"to-number":a.numberType,"to-string":a.stringType}}constructor(e,t){this.type=e,this._args=t}static parse(e,t){const i=e[0],r=Z.types[i];if(r===a.booleanType||r===a.stringType){if(2!==e.length)throw new Error(`${i} expects one argument`)}else if(e.length<2)throw new Error(`${i} expects at least one argument`);const s=[];for(let i=1;i<e.length;i++){const r=te(e[i],t);s.push(r)}return new Z(r,s)}evaluate(e,i){if(this.type===a.booleanType)return Boolean(this._args[0].evaluate(e,i));if(this.type===a.stringType)return a.valueToString(this._args[0].evaluate(e,i));if(this.type===a.numberType){for(const t of this._args){const r=Number(t.evaluate(e,i));if(!isNaN(r))return r}return null}if(this.type===a.colorType){for(const r of this._args)try{const s=Z.toColor(r.evaluate(e,i));if(s instanceof t)return s}catch{}return null}}static toBoolean(e){return Boolean(e)}static toString(e){return a.valueToString(e)}static toNumber(e){const t=Number(e);if(isNaN(t))throw new Error(`"${e}" is not a number`);return t}static toColor(e){if(e instanceof t)return e;if("string"==typeof e){const i=t.fromString(e);if(i)return i;throw new Error(`"${e}" is not a color`)}if(Array.isArray(e))return t.fromArray(e);throw new Error(`"${e}" is not a color`)}}class J{constructor(e){this._val=e,this.type=a.getType(e)}static parse(e){if(2!==e.length)throw new Error('"literal" expects 1 argument');return new J(e[1])}evaluate(e,t){return this._val}}class ee{constructor(e){this._arg=e,this.type=a.stringType}static parse(e,t){if(2!==e.length)throw new Error('"typeof" expects 1 argument');return new ee(te(e[1],t))}evaluate(e,t){return a.typeToString(a.getType(this._arg.evaluate(e,t)))}}function te(e,t,i){const r=typeof e;if("string"===r||"boolean"===r||"number"===r||null===e){if(i)switch(i.kind){case"string":"string"!==r&&(e=Z.toString(e));break;case"number":"number"!==r&&(e=Z.toNumber(e));break;case"color":e=Z.toColor(e)}e=["literal",e]}if(!Array.isArray(e)||0===e.length)throw new Error("Expression must be a non empty array");const s=e[0];if("string"!=typeof s)throw new Error("First element of expression must be a string");const n=ie[s];if(void 0===n)throw new Error(`Invalid expression operator "${s}"`);if(!n)throw new Error(`Unimplemented expression operator "${s}"`);return n.parse(e,t,i)}const ie={array:W,boolean:W,collator:null,format:null,image:null,literal:J,number:W,"number-format":null,object:W,string:W,"to-boolean":Z,"to-color":Z,"to-number":Z,"to-string":Z,typeof:ee,accumulated:null,"feature-state":null,"geometry-type":c,id:l,"line-progress":null,properties:h,at:P,get:A,has:M,in:C,"index-of":U,length:N,slice:O,"!":T,"!=":d,"<":g,"<=":f,"==":y,">":_,">=":m,all:w,any:b,case:S,coalesce:x,match:E,within:null,interpolate:D,"interpolate-hcl":D,"interpolate-lab":D,step:I,let:L,var:R,concat:$,downcase:j,"is-supported-script":null,"resolved-locale":null,upcase:j,rgb:Q,rgba:K,"to-rgba":X,"-":k,"*":G,"/":F,"%":z,"^":H,"+":Y,abs:q,acos:q,asin:q,atan:q,ceil:q,cos:q,e:q,floor:q,ln:q,ln2:q,log10:q,log2:q,max:q,min:q,pi:q,round:q,sin:q,sqrt:q,tan:q,zoom:u,"heatmap-density":null,"has-id":B,none:v};e.ALL=w,e.ANY=b,e.Add=Y,e.Assert=W,e.At=P,e.Calculate=q,e.Case=S,e.Coalesce=x,e.Coerce=Z,e.Concat=$,e.Div=F,e.EQ=y,e.GE=m,e.GT=_,e.GeomType=c,e.Get=A,e.Has=M,e.HasID=B,e.ID=l,e.In=C,e.IndexOf=U,e.Interpolate=D,e.LE=f,e.LT=g,e.Length=N,e.Let=L,e.Literal=J,e.Match=E,e.Mod=z,e.Mul=G,e.NE=d,e.NONE=v,e.NOT=T,e.Pow=H,e.Properties=h,e.Rgb=Q,e.Rgba=K,e.Slice=O,e.Step=I,e.String=j,e.Sub=k,e.ToRgba=X,e.TypeOf=ee,e.Var=R,e.Zoom=u,e.createExpression=te,e.ops=ie,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/expression/types":function(){define(["exports","../../../../../Color"],(function(e,t){"use strict";const i={kind:"null"},r={kind:"number"},s={kind:"string"},n={kind:"boolean"},a={kind:"color"},o={kind:"object"},l={kind:"value"};function c(e,t){return{kind:"array",itemType:e,n:t}}const h=[i,r,s,n,a,o,c(l)];e.arrayType=c,e.booleanType=n,e.colorType=a,e.getType=function e(h){if(null===h)return i;if("string"==typeof h)return s;if("boolean"==typeof h)return n;if("number"==typeof h)return r;if(h instanceof t)return a;if(Array.isArray(h)){let t;for(const i of h){const r=e(i);if(t){if(t!==r){t=l;break}}else t=r}return c(t||l,h.length)}return"object"==typeof h?o:l},e.matchType=function e(t,i){if("array"===i.kind)return"array"===t.kind&&(0===t.n&&"value"===t.itemType.kind||e(t.itemType,i.itemType))&&("number"!=typeof i.n||i.n===t.n);if("value"===i.kind)for(const i of h)if(e(t,i))return!0;return i.kind===t.kind},e.nullType=i,e.numberType=r,e.objectType=o,e.stringType=s,e.typeToString=function e(t){if("array"===t.kind){const i=e(t.itemType);return"number"==typeof t.n?`array<${i}, ${t.n}>`:"value"===t.itemType.kind?"array":`array<${i}>`}return t.kind},e.valueToString=function(e){if(null===e)return"";const i=typeof e;return"string"===i?e:"number"===i||"boolean"===i?String(e):e instanceof t?e.toString():JSON.stringify(e)},e.valueType=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/style/StyleProperty":function(){define(["../../../../../Color","../../../../../colorUtils","../GeometryUtils","../expression/expression","../expression/types"],(function(e,t,i,r,s){"use strict";class n{constructor(e,t){let i;switch(this.isDataDriven=!1,this.interpolator=null,e.type){case"number":case"color":i=!0;break;case"array":i="number"===e.value;break;default:i=!1}if((null==t||""===t&&"color"===e.type)&&(t=e.default),Array.isArray(t)&&t.length>0&&r.ops[t[0]]){const i={number:s.numberType,color:s.colorType,string:s.stringType,boolean:s.booleanType,enum:s.stringType};try{const n="array"===e.type?s.arrayType(i[e.value]||s.valueType,e.length):i[e.type],a=r.createExpression(t,null,n);this.getValue=this._buildExpression(a,e),this.isDataDriven=!0,a instanceof r.Interpolate&&a.input instanceof r.Zoom&&(this.interpolator=a)}catch(t){console.log(t.message),this.getValue=this._buildSimple(e.default)}return}i&&"interval"===t.type&&(i=!1);const n=t?.stops&&t.stops.length>0;if(n)for(const i of t.stops)i[1]=this._validate(i[1],e);if(this.isDataDriven=!!t&&!!t.property,this.isDataDriven)if(void 0!==t.default&&(t.default=this._validate(t.default,e)),n)switch(t.type){case"identity":this.getValue=this._buildIdentity(t,e);break;case"categorical":this.getValue=this._buildCategorical(t,e);break;default:this.getValue=i?this._buildInterpolate(t,e):this._buildInterval(t,e)}else this.getValue=this._buildIdentity(t,e);else n?this.getValue=i?this._buildZoomInterpolate(t):this._buildZoomInterval(t):(t=this._validate(t,e),this.getValue=this._buildSimple(t))}_validate(e,t){if("number"===t.type){if(null!=t.minimum&&e<t.minimum)return t.minimum;if(null!=t.maximum&&e>t.maximum)return t.maximum}else"color"===t.type?e=n._parseColor(e):"enum"===t.type?"string"==typeof e&&(e=t.values.indexOf(e)):"array"===t.type&&"enum"===t.value?e=e.map((e=>"string"==typeof e?t.values.indexOf(e):e)):"string"===t.type&&(e=s.valueToString(e));return e}_buildSimple(e){return()=>e}_buildExpression(e,t){return(i,r)=>{try{const s=e.evaluate(r,i);return void 0===s?t.default:this._validate(s,t)}catch(e){return console.log(e.message),t.default}}}_buildIdentity(e,t){return(i,r)=>{let s;return r&&(s=r.values[e.property]),void 0!==s&&(s=this._validate(s,t)),null!=s?s:void 0!==e.default?e.default:t.default}}_buildCategorical(e,t){return(i,r)=>{let s;return r&&(s=r.values[e.property]),s=this._categorical(s,e.stops),void 0!==s?s:void 0!==e.default?e.default:t.default}}_buildInterval(e,t){return(i,r)=>{let s;return r&&(s=r.values[e.property]),"number"==typeof s?this._interval(s,e.stops):void 0!==e.default?e.default:t.default}}_buildInterpolate(e,t){return(i,r)=>{let s;return r&&(s=r.values[e.property]),"number"==typeof s?this._interpolate(s,e.stops,e.base||1):void 0!==e.default?e.default:t.default}}_buildZoomInterpolate(e){return t=>this._interpolate(t,e.stops,e.base||1)}_buildZoomInterval(e){return t=>this._interval(t,e.stops)}_categorical(e,t){const i=t.length;for(let r=0;r<i;r++)if(t[r][0]===e)return t[r][1]}_interval(e,t){const i=t.length;let r=0;for(let s=0;s<i&&t[s][0]<=e;s++)r=s;return t[r][1]}_interpolate(e,t,r){let s,n;const a=t.length;for(let i=0;i<a;i++){const r=t[i];if(!(r[0]<=e)){n=r;break}s=r}if(s&&n){const t=n[0]-s[0],a=e-s[0],o=1===r?a/t:(r**a-1)/(r**t-1);if(Array.isArray(s[1])){const e=s[1],t=n[1],r=[];for(let s=0;s<e.length;s++)r.push(i.interpolate(e[s],t[s],o));return r}return i.interpolate(s[1],n[1],o)}return s?s[1]:n?n[1]:void 0}static _isEmpty(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0}static _parseColor(i){return Array.isArray(i)?i:"string"==typeof i?t.parseToUnitRgba(i)??void 0:i instanceof e&&!this._isEmpty(i)?e.toUnitRGBA(i):void 0}}return n}))},"esri/views/2d/engine/vectorTiles/style/StyleRepository":function(){define(["../../../../../core/lang","./StyleDefinition","./StyleLayer"],(function(e,t,i){"use strict";class r{constructor(i,r=!0){if(this.backgroundBucketIds=[],this._uidToLayer=new Map,this._layerByName={},this._runningId=0,this._style=r?e.clone(i):i,this._style.layers||(this._style.layers=[]),this.version=parseFloat(this._style.version),this.layers=this._style.layers.map(((e,t,i)=>this._create(e,t,i))).filter((e=>!!e)),this.layers)for(let e=0;e<this.layers.length;e++){const i=this.layers[e];this._layerByName[i.id]=i,this._uidToLayer.set(i.uid,i),i.type===t.StyleLayerType.BACKGROUND&&this.backgroundBucketIds.push(i.id)}this._identifyRefLayers()}getLayerStyleProperties(e,i){const r=this.getStyleLayerByUID(e),s=r?.getLayoutValue("symbol-placement",i)!==t.SymbolPlacement.POINT;let n=r?.getLayoutValue("icon-rotation-alignment",i);n===t.RotationAlignment.AUTO&&(n=s?t.RotationAlignment.MAP:t.RotationAlignment.VIEWPORT);let a=r?.getLayoutValue("text-rotation-alignment",i);a===t.RotationAlignment.AUTO&&(a=s?t.RotationAlignment.MAP:t.RotationAlignment.VIEWPORT);const o=r?.getPaintValue("icon-translate",i),l=r?.getPaintValue("icon-translate-anchor",i),c=r?.getPaintValue("text-translate",i),h=r?.getPaintValue("text-translate-anchor",i);return{geometryType:null,iconAllowOverlap:r?.getLayoutValue("icon-allow-overlap",i),iconIgnorePlacement:r?.getLayoutValue("icon-ignore-placement",i),textAllowOverlap:r?.getLayoutValue("text-allow-overlap",i),textIgnorePlacement:r?.getLayoutValue("text-ignore-placement",i),iconRotationAlignment:n,textRotationAlignment:a,iconTranslateAnchor:l,iconTranslate:o,textTranslateAnchor:h,textTranslate:c}}isPainterDataDriven(e){const t=this._layerByName[e];return!!t&&t.isPainterDataDriven()}getStyleLayerId(e){return e>=this.layers.length?null:this.layers[e].id}getStyleLayerByUID(e){return this._uidToLayer.get(e)??null}getStyleLayerIndex(e){const t=this._layerByName[e];return t?this.layers.indexOf(t):-1}setStyleLayer(e,t){if(!e?.id)return;const i=this._style;null!=t&&t>=this.layers.length&&(t=this.layers.length-1);let s,n=!0;const a=this._layerByName[e.id];if(a){const o=this.layers.indexOf(a);t||(t=o),t===o?(n=!1,s=r._recreateLayer(e,a),this.layers[t]=s,i.layers[t]=e):(this.layers.splice(o,1),i.layers.splice(o,1),s=this._create(e,t,this.layers),this.layers.splice(t,0,s),i.layers.splice(t,0,e))}else s=this._create(e,t,this.layers),!t||t>=this.layers.length?(this.layers.push(s),i.layers.push(e)):(this.layers.splice(t,0,s),i.layers.splice(t,0,e));this._layerByName[e.id]=s,this._uidToLayer.set(s.uid,s),n&&this._recomputeZValues(),this._identifyRefLayers()}getStyleLayer(e){const t=this._layerByName[e];return t?{type:t.typeName,id:t.id,source:t.source,"source-layer":t.sourceLayer,minzoom:t.minzoom,maxzoom:t.maxzoom,filter:t.filter,layout:t.layout,paint:t.paint}:null}deleteStyleLayer(e){const t=this._layerByName[e];if(t){delete this._layerByName[e],this._uidToLayer.delete(t.uid);const i=this.layers.indexOf(t);this.layers.splice(i,1),this._style.layers.splice(i,1),this._recomputeZValues(),this._identifyRefLayers()}}getLayerById(e){return this._layerByName[e]}getLayoutProperties(e){const t=this._layerByName[e];return t?t.layout:null}getPaintProperties(e){const t=this._layerByName[e];return t?t.paint:null}setPaintProperties(e,t){const i=this._layerByName[e];if(!i)return;const s={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:i.layout,paint:t},n=r._recreateLayer(s,i),a=this.layers.indexOf(i);this.layers[a]=n,this._style.layers[a].paint=t,this._layerByName[i.id]=n,this._uidToLayer.set(i.uid,n)}setLayoutProperties(e,t){const i=this._layerByName[e];if(!i)return;const s={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:t,paint:i.paint},n=r._recreateLayer(s,i),a=this.layers.indexOf(i);this.layers[a]=n,this._style.layers[a].layout=t,this._layerByName[i.id]=n,this._uidToLayer.set(i.uid,n)}setStyleLayerVisibility(e,t){const i=this._layerByName[e];if(!i)return;const s=i.layout||{};s.visibility=t;const n={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:s,paint:i.paint},a=r._recreateLayer(n,i),o=this.layers.indexOf(i);this.layers[o]=a,this._style.layers[o].layout=s,this._layerByName[i.id]=a,this._uidToLayer.set(i.uid,a)}getStyleLayerVisibility(e){const t=this._layerByName[e];if(!t)return"none";const i=t.layout;return i?.visibility??"visible"}_recomputeZValues(){const e=this.layers,t=1/(e.length+1);for(let i=0;i<e.length;i++)e[i].z=1-(1+i)*t}_identifyRefLayers(){const e=[],i=[];let r=0;for(const s of this.layers){const n=s.layout;if(s.type===t.StyleLayerType.FILL){const t=s;let i=s.source+"|"+s.sourceLayer;i+="|"+(n?.visibility??""),i+="|"+s.minzoom,i+="|"+s.maxzoom,i+="|"+JSON.stringify(s.filter),(t.hasDataDrivenFill||t.hasDataDrivenOutline)&&(i+="|"+r),e.push({key:i,layer:s})}else if(s.type===t.StyleLayerType.LINE){const e=s,t=s.paint,a=null!=t&&(null!=t["line-pattern"]||null!=t["line-dasharray"]);let o=s.source+"|"+s.sourceLayer;o+="|"+(n?.visibility??""),o+="|"+s.minzoom,o+="|"+s.maxzoom,o+="|"+JSON.stringify(s.filter),o+="|"+(void 0!==n?n["line-cap"]:""),o+="|"+(void 0!==n?n["line-join"]:""),(e.hasDataDrivenLine||a)&&(o+="|"+r),i.push({key:o,layer:s})}++r}this._assignRefLayers(e),this._assignRefLayers(i)}_assignRefLayers(e){let i,r;e.sort(((e,t)=>e.key<t.key?-1:e.key>t.key?1:0));const s=e.length;for(let n=0;n<s;n++){const a=e[n];if(a.key===i)a.layer.refLayerId=r;else if(i=a.key,r=a.layer.id,a.layer.type===t.StyleLayerType.FILL){if(!a.layer.getPaintProperty("fill-outline-color"))for(let t=n+1;t<s;t++){const s=e[t];if(s.key!==i)break;if(s.layer.getPaintProperty("fill-outline-color")){e[n]=s,e[t]=a,r=s.layer.id;break}}}else if(a.layer.type===t.StyleLayerType.LINE){let t=a.layer;for(let o=n+1;o<s;o++){const s=e[o];if(s.key!==i)break;const l=s.layer;(t.canUseThinTessellation&&!l.canUseThinTessellation||!t.canUseThinTessellation&&(l.getPaintProperty("line-pattern")||l.getPaintProperty("line-dasharray")))&&(t=l,e[n]=s,e[o]=a,r=s.layer.id)}}}}_create(e,r,s){const n=1-(1+r)*(1/(s.length+1)),a=this._runningId++;switch(e.type){case"background":return new i.BackgroundStyleLayer(t.StyleLayerType.BACKGROUND,e,n,a);case"fill":return new i.FillStyleLayer(t.StyleLayerType.FILL,e,n,a);case"line":return new i.LineStyleLayer(t.StyleLayerType.LINE,e,n,a);case"symbol":return new i.SymbolStyleLayer(t.StyleLayerType.SYMBOL,e,n,a);case"raster":return console.warn(`Unsupported vector tile raster layer ${e.id}`),null;case"circle":return new i.CircleStyleLayer(t.StyleLayerType.CIRCLE,e,n,a)}return null}static _recreateLayer(e,r){switch(e.type){case"background":return new i.BackgroundStyleLayer(t.StyleLayerType.BACKGROUND,e,r.z,r.uid);case"fill":return new i.FillStyleLayer(t.StyleLayerType.FILL,e,r.z,r.uid);case"line":return new i.LineStyleLayer(t.StyleLayerType.LINE,e,r.z,r.uid);case"symbol":return new i.SymbolStyleLayer(t.StyleLayerType.SYMBOL,e,r.z,r.uid);case"raster":return console.warn(`Unsupported vector tile raster layer ${e.id}`),null;case"circle":return new i.CircleStyleLayer(t.StyleLayerType.CIRCLE,e,r.z,r.uid)}return null}}return r}))},"esri/views/2d/layers/LayerView2D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Collection","../../../core/collectionUtils","../../../core/Error","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../linkChart/utils","../engine/Container","./support/HighlightCounter","./support/util","../support/highlightOptionsUtils","../../layers/support/ClipRect","../../layers/support/Geometry","../../layers/support/Path","../../support/HighlightOptions","../../support/layerViewUtils"],(function(e,t,i,r,s,n,a,o,l,c,h,u,p,y,d,g,f,_,m,T,w){"use strict";const b=i.ofType({key:"type",base:null,typeMap:{rect:f,path:m,geometry:_}}),v=new(i.ofType(T));e.LayerView2DMixin=e=>{let o=class extends e{constructor(){super(...arguments),this._highlightCounter=new y.HighlightCounter,this.attached=!1,this.clips=new b,this.highlights=null,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this._visibleAtCurrentScale=!0}initialize(){const e=this.view?.spatialReferenceLocked??!0,t=this.view?.spatialReference;t&&e&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new s("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new p.Container),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([n.watch((()=>this.suspended),(e=>{this.container&&(this.container.visible=!e)}),n.syncAndInitial),n.watch((()=>this.updateSuspended),(e=>{this.view&&!e&&this.updateRequested&&this.view.requestUpdate()}),n.syncAndInitial),n.watch((()=>this.layer?.opacity??1),(e=>{this.container&&(this.container.opacity=e)}),n.syncAndInitial),n.watch((()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal"),(e=>{this.container&&(this.container.blendMode=e)}),n.syncAndInitial),n.watch((()=>this.layer&&"effect"in this.layer?this.layer.effect:null),(e=>{this.container&&(this.container.effect=e)}),n.syncAndInitial),n.watch((()=>this._mergedHighlights.items.map((e=>({name:e.name,options:{fillColor:e.color,haloColor:e.haloColor,fillOpacity:e.fillOpacity,haloOpacity:e.haloOpacity,haloWidth:e.haloWidth,haloBlur:e.haloBlur}})))),(()=>{this.container.highlightGradient=d.createOrReuseHighlightGradient(this.container.highlightGradient,this._mergedHighlights.items)}),n.syncAndInitial),n.watch((()=>this._mergedHighlights.items.map((e=>e.name))),(()=>{this._processHighlight()})),n.on((()=>this.clips),"change",(()=>{this.container&&(this.container.clips=this.clips)}),n.syncAndInitial),n.watch((()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null})),(({scale:e,scaleRange:t})=>{const i=w.isInEffectiveScaleRange(t,e);i!==this._visibleAtCurrentScale&&(this._visibleAtCurrentScale=i)}),n.syncAndInitial)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then((e=>{e===this&&this.processAttach()}),(()=>{})):this.when().then((()=>{this.processAttach()}),(()=>{})))}destroy(){this.processDetach(),this.updateRequested=!1}get highlightOptions(){return g.getDefaultHighlightOptions(this)}set highlightOptions(e){g.setDefaultHighlightOptions(this,e)}get hasHighlight(){return this._highlightCounter.size>0}get _mergedHighlights(){if(!this.view)return v;if(!this.highlights)return this.view.highlights;const e=this.view.highlights.clone();for(const t of this.highlights){const i=e.find((e=>e.name===t.name));i&&i.assignFrom(t)}return e}get highlightIds(){return Array.from(this._highlightCounter.objectIds)}get scheduler(){return this.view.scheduler}get spatialReferenceSupported(){const e=this.view?.spatialReference;return null==e||this.supportsSpatialReference(e)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating||this.container.transitioning)}get visibleAtCurrentScale(){return this._visibleAtCurrentScale}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(e){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",e),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1}hitTest(e,t){return Promise.resolve(null)}supportsSpatialReference(e){return!0}canResume(){if(!this.spatialReferenceSupported)return!1;switch(this.layer?.type){case"link-chart":case"knowledge-graph-sublayer":case"graphics":break;default:if(u.isLinkChartView(this.view)&&!this.view.inGeographicLayout)return!1}return!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const e=super.getSuspendInfo(),t=!this.spatialReferenceSupported;return t&&(e.spatialReferenceNotSupported=t),e}addAttachHandles(e){this.addHandles(e,"attach")}_addHighlights(e,t){this._highlightCounter.add(e,t)&&this._processHighlight()}_removeHighlights(e,t){this._highlightCounter.delete(e,t)&&this._processHighlight()}_processHighlight(){}_getHighlights(){const e=[];for(const[t,i]of this._highlightCounter.highlightNamesByObjectId){const r=this._getHighlightBits(i);e.push({objectId:t,highlightFlags:r})}return e}_getHighlightBits(e){const t=new Set(e);let i=1,r=0;if(!this.view)return 0;const s=this._mergedHighlights;for(const{name:e}of s)t.delete(e)&&(r=i),i<<=1;return r}};return t.__decorate([a.property()],o.prototype,"attached",void 0),t.__decorate([a.property({type:b,set(e){const t=r.referenceSetter(e,this._get("clips"),b);this._set("clips",t)}})],o.prototype,"clips",void 0),t.__decorate([a.property()],o.prototype,"container",void 0),t.__decorate([a.property({type:T})],o.prototype,"highlightOptions",null),t.__decorate([a.property({type:i.ofType(T)})],o.prototype,"highlights",void 0),t.__decorate([a.property()],o.prototype,"_mergedHighlights",null),t.__decorate([a.property()],o.prototype,"moving",void 0),t.__decorate([a.property({readOnly:!0})],o.prototype,"spatialReferenceSupported",null),t.__decorate([a.property({readOnly:!0})],o.prototype,"updateParameters",void 0),t.__decorate([a.property()],o.prototype,"updateRequested",void 0),t.__decorate([a.property()],o.prototype,"updating",null),t.__decorate([a.property()],o.prototype,"view",void 0),t.__decorate([a.property()],o.prototype,"_visibleAtCurrentScale",void 0),t.__decorate([a.property({readOnly:!0})],o.prototype,"visibleAtCurrentScale",null),o=t.__decorate([h.subclass("esri.views.2d.layers.LayerView2D")],o),o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/linkChart/utils":function(){define(["exports"],(function(e){"use strict";e.isLinkChartView=function(e){return null!=e&&"object"==typeof e&&"2d"===e.type&&"linkchart"===e.view2dType},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/layers/support/HighlightCounter":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/MapUtils","../../../../core/ReactiveMap","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass"],(function(e,t,i,r,s,n,a,o,l,c){"use strict";e.HighlightCounter=class extends i{constructor(){super(...arguments),this._idToCounters=new s}get size(){return this._idToCounters.size}get objectIds(){return this._idToCounters.keys()}get highlightNamesByObjectId(){return function*(e){for(const[t,i]of e)yield[t,i.keys()]}(this._idToCounters)}add(e,t){let i=!1;for(const s of e){const e=r.getOrCreateMapValue(this._idToCounters,s,(()=>(i=!0,new Map))),n=e.get(t)??0;n||(i=!0),e.set(t,n+1)}return i}delete(e,t){let i=!1;for(const r of e){const e=this._idToCounters.get(r);if(!e)continue;let s=e.get(t);null!=s&&(s--,s>0?e.set(t,s):(e.delete(t),i=!0),0===e.size&&(this._idToCounters.delete(r),i=!0))}return i}},e.HighlightCounter=t.__decorate([c.subclass("esri.views.2d.layers.support.HighlightCounter")],e.HighlightCounter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/layers/support/ClipRect":function(){define(["exports","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./ClipArea"],(function(e,t,i,r,s,n,a,o){"use strict";var l;return e.default=l=class extends o{constructor(e){super(e),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new l({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}},t.__decorate([i.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"left",void 0),t.__decorate([i.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"right",void 0),t.__decorate([i.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"top",void 0),t.__decorate([i.property({type:[Number,String],json:{write:!0}})],e.default.prototype,"bottom",void 0),e.default=l=t.__decorate([a.subclass("esri.views.layers.support.ClipRect")],e.default),e.default}))},"esri/views/layers/support/ClipArea":function(){define(["exports","../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],(function(e,t,i,r,s,n,a,o){"use strict";return e.default=class extends i{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}},t.__decorate([r.property({readOnly:!0})],e.default.prototype,"version",null),e.default=t.__decorate([o.subclass("esri.views.layers.support.ClipArea")],e.default),e.default}))},"esri/views/layers/support/Geometry":function(){define(["exports","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Polygon","../../../geometry/support/jsonUtils","./ClipArea"],(function(e,t,i,r,s,n,a,o,l,c,h,u){"use strict";var p;const y={base:l,key:"type",typeMap:{extent:o,polygon:c}};return e.default=p=class extends u{constructor(e){super(e),this.type="geometry",this.geometry=null}clone(){return new p({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}},t.__decorate([i.property({types:y,json:{read:h.fromJSON,write:!0}})],e.default.prototype,"geometry",void 0),e.default=p=t.__decorate([a.subclass("esri.views.layers.support.Geometry")],e.default),e.default}))},"esri/views/layers/support/Path":function(){define(["exports","../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./ClipArea"],(function(e,t,i,r,s,n,a,o){"use strict";return e.default=class extends o{constructor(e){super(e),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}},t.__decorate([i.property({type:[[[Number]]],json:{write:!0}})],e.default.prototype,"path",void 0),e.default=t.__decorate([a.subclass("esri.views.layers.support.Path")],e.default),e.default}))},"esri/views/2d/tiling/TileInfoViewPOT":function(){define(["../../../layers/support/TileInfo","./TileInfoView","./TileKey"],(function(e,t,i){"use strict";return class extends t{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(e){const t=i.pool.acquire(e),r=0===t.level?null:i.getId(t.level-1,t.row>>1,t.col>>1,t.world);return i.pool.release(t),r}getTileCoverage(e,t,i=!0,r){const s=super.getTileCoverage(e,t,i,r);if(!s)return s;const n=1<<s.lodInfo.level;return s.spans=s.spans.filter((e=>e.row>=0&&e.row<n)),s}scaleToLevel(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];{const t=this._fullCacheLodInfos;if(e>t[0].scale)return t[0].level;let i,r;for(let s=0;s<t.length-1;s++)if(r=t[s+1],e>r.scale)return i=t[s],i.level+(i.scale-e)/(i.scale-r.scale);return t[t.length-1].level}}_initializeFullCacheLODs(t){let i;if(0===t[0].level)i=t.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})));else{const t=this.tileInfo.size[0],r=this.tileInfo.spatialReference;i=e.create({size:t,spatialReference:r}).lods.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})))}for(let e=0;e<i.length;e++)this._levelByScale[i[e].scale]=i[e].level;this._fullCacheLodInfos=i}}}))},"esri/views/layers/RefreshableLayerView":function(){define(["../../chunks/tslib.es6","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/has","../../core/RandomLCG","../../core/Error","../../core/accessorSupport/decorators/subclass"],(function(e,t,i,r,s,n,a,o){"use strict";return s=>{let n=class extends s{initialize(){this.addHandles(r.on((()=>this.layer),"refresh",(e=>{this.doRefresh(e.dataChanged).catch((e=>{i.isAbortError(e)||t.getLogger(this).error(e)}))})),"RefreshableLayerView")}};return n=e.__decorate([o.subclass("esri.views.layers.RefreshableLayerView")],n),n}}))},"*noref":1}}),define(["../../../chunks/tslib.es6","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/diffUtils","../../../geometry/Point","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","../engine/vectorTiles/enums","../engine/vectorTiles/TileHandler","../engine/vectorTiles/TileManager","../engine/vectorTiles/VectorTile","../engine/vectorTiles/VectorTileContainer","../engine/vectorTiles/VectorTileFeatureIndex","../engine/vectorTiles/style/StyleDefinition","../engine/vectorTiles/style/StyleRepository","./LayerView2D","../tiling/TileInfoViewPOT","../tiling/TileQueue","../../layers/LayerView","../../layers/RefreshableLayerView","../../support/Scheduler"],(function(e,t,i,r,s,n,a,o,l,c,h,u,p,y,d,g,f,_,m,T,w,b,v,S,x,E){"use strict";let D=class extends(x(w.LayerView2DMixin(S))){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._styeChanged=!1,this._spriteSourceChanged=!1}get fading(){return this._vectorTileContainer?.fading??!1}get hasVisibleFeatures(){const e=this._vectorTileContainer.children;for(const t of e)if(t.hasFeatures())return!0;return!1}get spriteSourceChanged(){return this._spriteSourceChanged}get styleChanged(){return this._styeChanged}async hitTest(e,t){const i=this._tileHandlerPromise,r=this._vectorTileContainer?.symbolFader;if(!i||!this._isTileHandlerReady||!r)return;await i;let s=null;const n=this._vectorTileContainer?.symbolRepository;n&&(s=n.querySymbols(t,2,r.decluttererOffset,{}));const a=this.view.state,o=this._tileManager.getIntersectingTiles(t.x,t.y,2,a,s);if((!o||0===o.length)&&0===s?.length)return null;e=e.clone().normalize();const l=[],c=[];for(const t of o)l.push(this._queryTile(c,e,2,this.view.state.rotation,t,s?.filter((e=>e.tileKey.id===t.id))));return await Promise.all(l),c}update(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._tileHandler.devicePixelRatio=e.pixelRatio,void this._loadStyle()):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._pauseQueues(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._resumeQueues()))}attach(){const{style:e}=this.layer.currentStyleInfo;this._styleRepository=new T(e),this._tileInfoView=new b(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new f.VectorTileContainer(this._tileInfoView),this._tileHandler=new y.TileHandler(this.layer,this._styleRepository,window.devicePixelRatio||1,this.layer.tileInfo.lods.length-1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",(e=>{if(this._styeChanged=!0,e.isDataDriven)this._styleChanges.push({type:p.StyleUpdateType.PAINTER_CHANGED,data:e}),this.requestUpdate();else{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const r=i.type===m.StyleLayerType.SYMBOL;t.setPaintProperties(e.layer,e.paint),r&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender()}})),this.layer.on("layout-change",(e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;this._styeChanged=!0;const r=l.diff(i.layout,e.layout);if(null!=r){if(l.hasDiff(r,"visibility")&&1===function(e){if(null==e)return 0;switch(e.type){case"partial":return Object.keys(e.diff).length;case"complete":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case"collection":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}(r))return t.setLayoutProperties(e.layer,e.layout),i.type===m.StyleLayerType.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),void this._vectorTileContainer?.requestRender();this._styleChanges.push({type:p.StyleUpdateType.LAYOUT_CHANGED,data:e}),this.requestUpdate()}})),this.layer.on("style-layer-visibility-change",(e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);i&&(this._styeChanged=!0,t.setStyleLayerVisibility(e.layer,e.visibility),i.type===m.StyleLayerType.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender())})),this.layer.on("style-layer-change",(e=>{this._styleChanges.push({type:p.StyleUpdateType.LAYER_CHANGED,data:e}),this._styeChanged=!0,this.requestUpdate()})),this.layer.on("delete-style-layer",(e=>{this._styleChanges.push({type:p.StyleUpdateType.LAYER_REMOVED,data:e}),this._styeChanged=!0,this.requestUpdate()})),this.layer.on("load-style",(()=>this._loadStyle())),this.layer.on("spriteSource-change",(e=>{this._spriteSourceChanged=!0,this._styleChanges.push({type:p.StyleUpdateType.SPRITES_CHANGED,data:e});const t=this._styleRepository.layers;for(const e of t)switch(e.type){case m.StyleLayerType.SYMBOL:e.getLayoutProperty("icon-image")&&this._styleChanges.push({type:p.StyleUpdateType.LAYOUT_CHANGED,data:{layer:e.id,layout:e.layout}});break;case m.StyleLayerType.LINE:e.getPaintProperty("line-pattern")&&this._styleChanges.push({type:p.StyleUpdateType.PAINTER_CHANGED,data:{layer:e.id,paint:e.paint,isDataDriven:e.isPainterDataDriven()}});break;case m.StyleLayerType.FILL:e.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:p.StyleUpdateType.PAINTER_CHANGED,data:{layer:e.id,paint:e.paint,isDataDriven:e.isPainterDataDriven()}})}this.requestUpdate()}))])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=r.destroyMaybe(this._vectorTileContainer),this._tileHandler=r.destroyMaybe(this._tileHandler)}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return u.equals(this.layer.tileInfo?.spatialReference,e)}canResume(){let e=super.canResume();const{currentStyleInfo:t}=this.layer;if(e&&t?.layerDefinition){const i=this.view.scale,{minScale:r,maxScale:s}=t.layerDefinition;t?.layerDefinition&&(r&&r<i&&(e=!1),s&&s>i&&(e=!1))}return e}isUpdating(){return this.fading}acquireTile(e){const t=this._createVectorTile(e);return this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then((e=>this._parseQueue.push({key:t.key,data:e}))).then((e=>{t.once("attach",(()=>this.requestUpdate())),t.setData(e),this.requestUpdate()})).catch((e=>{s.isAbortError(e)||i.getLogger(this).error(e)}))),t}releaseTile(e){const t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}async doRefresh(){if(!this.attached)return;if(this.suspended)return this._tileManager.clear(),void this.requestUpdate();this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._tileManager.clearCache(),this._resumeQueues();const e=this._vectorTileContainer.children,t=[];try{for(const i of e){const e=this._updatingHandles.addPromise(this._fetchQueue.push(i.key).then((e=>this._parseQueue.push({key:i.key,data:e}))).then((e=>i.setData(e))).finally((()=>i.featureIndex=null)));t.push(e)}await Promise.all(t)}catch(e){i.getLogger(this).error("error refreshing vector-tiles layer-view",e),this._resumeQueues(),this._isTileHandlerReady=!0}this._isTileHandlerReady=!0,this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new d.TileManager({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const e=new AbortController,t=this._tileHandler.start({signal:e.signal}).then((()=>{this._fetchQueue=new v({tileInfoView:this._tileInfoView,process:(e,t)=>this._getTileData(e,t),concurrency:15,scheduler:this.scheduler,priority:E.TaskPriority.MAPVIEW_FETCH_QUEUE}),this._parseQueue=new v({tileInfoView:this._tileInfoView,process:(e,t)=>this._parseTileData(e,t),concurrency:8,scheduler:this.scheduler,priority:E.TaskPriority.MAPVIEW_VECTOR_TILE_PARSING_QUEUE}),this.requestUpdate(),this._isTileHandlerReady=!0}));this._tileHandler.spriteMosaic.then((e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this.requestUpdate()})),this._tileHandlerAbortController=e,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=r.destroyMaybe(this._fetchQueue),this._parseQueue=r.destroyMaybe(this._parseQueue),this._tileManager=r.destroyMaybe(this._tileManager),this._vectorTileContainer.removeAllChildren()}async _getTileData(e,t){return this._tileHandler.fetchTileData(e,t)}async _parseTileData(e,t){return this._tileHandler.parseTileData(e,t)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._tileManager.clearCache();const e=this._styleChanges;try{await this._tileHandler.updateStyle(e)}catch(e){i.getLogger(this).error("error applying vector-tiles style update",e.message),this._resumeQueues(),this._isTileHandlerReady=!0}const t=this._styleRepository,r=new Set;e.forEach((e=>{if(e.type!==p.StyleUpdateType.LAYER_REMOVED)return;const i=e.data,s=t.getLayerById(i.layer);s&&r.add(s.uid)}));const s=new Set;e.forEach((e=>{let i;switch(e.type){case p.StyleUpdateType.PAINTER_CHANGED:t.setPaintProperties(e.data.layer,e.data.paint),i=e.data.layer;break;case p.StyleUpdateType.LAYOUT_CHANGED:t.setLayoutProperties(e.data.layer,e.data.layout),i=e.data.layer;break;case p.StyleUpdateType.LAYER_REMOVED:return void t.deleteStyleLayer(e.data.layer);case p.StyleUpdateType.LAYER_CHANGED:t.setStyleLayer(e.data.layer,e.data.index),i=e.data.layer.id;break;case p.StyleUpdateType.SPRITES_CHANGED:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(e.data.spriteSource))}if(i){const e=t.getLayerById(i);e&&s.add(e.uid)}}));const n=this._vectorTileContainer.children;if(r.size>0){const e=Array.from(r);this._vectorTileContainer.deleteStyleLayers(e);for(const t of n)t.deleteLayerData(e)}if(this._resumeQueues(),s.size>0){const e=Array.from(s),t=[];for(const i of n){const r=this._updatingHandles.addPromise(this._fetchQueue.push(i.key).then((t=>this._parseQueue.push({key:i.key,data:t,styleLayerUIDs:e}))).then((e=>i.setData(e))).finally((()=>i.featureIndex=null)));t.push(r)}await Promise.all(t)}this._styleChanges=[],this._isTileHandlerReady=!0,this.requestUpdate()}async _loadStyle(){const{style:e}=this.layer.currentStyleInfo,i=t.clone(e);this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._styleRepository=new T(i),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:r}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,i,this.layer.tileInfo.lods.length-1),await this._tileHandlerPromise}catch(e){if(!s.isAbortError(e))throw e}if(r.aborted)return this._resumeQueues(),this._isTileHandlerReady=!0,this._styeChanged=!1,this._spriteSourceChanged=!1,void this.requestUpdate();const n=await this._tileHandler.spriteMosaic,a=this._vectorTileContainer;this._tileInfoView=new b(this.layer.tileInfo,this.layer.fullExtent),a.setStyleResources(n,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this._tileManager=new d.TileManager({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),this._resumeQueues(),this._isTileHandlerReady=!0,this.requestUpdate(),this._styeChanged=!1,this._spriteSourceChanged=!1}_createVectorTile(e){const t=this._tileInfoView.getTileBounds(h.create(),e),i=this._tileInfoView.getTileResolution(e.level);return new g.VectorTile(e,i,t[0],t[3],512,512,this._styleRepository)}async _queryTile(e,t,i,r,s,n){if(0===s.layerData.size)return;const a=this._ensureTileIndex(s),o=this._tileInfoView.getTileBounds(h.create(),s.key,!0),l=(t.x-o[0])/(o[2]-o[0])*4096,c=4096*(1-(t.y-o[1])/(o[3]-o[1])),u=await a.queryAttributes(l,c,i,r,n);for(const i of u)i.graphic.geometry=this._tileToMapPoint(i.tilePoint,s.transforms.tileUnitsToPixels),e.push({type:"graphic",layer:this.layer,graphic:i.graphic,mapPoint:t.clone()});e.sort(((e,t)=>t.graphic.origin.layerIndex-e.graphic.origin.layerIndex))}_tileToMapPoint(e,t){if(!e)return null;const i=e[0]*t[0]+e[1]*t[3]+t[6],r=e[0]*t[1]+e[1]*t[4]+t[7],s=this.view.state,n=[0,0];return s.toMap(n,[i,r]),new c({x:n[0],y:n[1],spatialReference:s.spatialReference})}_ensureTileIndex(e){let t=e.featureIndex;return t||(t=_.create(e.key,e.layerData,this._styleRepository,this._tileHandler,this.layer),e.featureIndex=t),t}_pauseQueues(){this._fetchQueue.pause(),this._parseQueue.pause()}_resumeQueues(){this._fetchQueue.resume(),this._parseQueue.resume()}_clearQueues(){this._fetchQueue.clear(),this._parseQueue.clear()}};return e.__decorate([n.property()],D.prototype,"_isTileHandlerReady",void 0),D=e.__decorate([o.subclass("esri.views.2d.layers.VectorTileLayerView2D")],D),D}));