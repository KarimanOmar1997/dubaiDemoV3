// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/support/UpdatingHandles","../../engine/AFeatureContainer","../../engine/webgl/enums","../../engine/webgl/shaderGraph/techniques/FeatureInstanceStore","../../engine/webgl/shaderGraph/techniques/TechniqueRegistry","../../engine/webgl/shaderGraph/techniques/TechniqueType","./RenderState","../support/util"],(function(e,t,s,r,i,n,a,h,o,d,l,u){"use strict";class c{constructor(e,t){this.id=e,this.version=t,this._resolver=r.createResolver(),this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0}destroy(){this._resolver.reject()}}class _ extends n.AFeatureContainer{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new i.UpdatingHandles,this._hitTestsRequests=[],this._store=new h,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._shouldUnlockAttributeView=!1,this._layerView=e,this.addTransitionable(this._layerView.featureEffectView)}destroy(){super.destroy(),this._renderState=s.destroyMaybe(this._renderState),this._renderStateNext=s.destroyMaybe(this._renderStateNext)}renderChildren(e){if(this._updateAttributeView(),this._renderState?.update(this.attributeView.currentEpoch),this._layerView.requestUpdate(),this._renderState){const e=Array.from(this._renderState.tiles()).filter((e=>e.needsUpload));e.length&&(e[Math.floor(Math.random()*e.length)].upload(),e.length>=2&&this.requestRender());for(const e of this._renderState.tiles())e.tryReady(this.attributeView.currentEpoch)&&(this._subscriptions.get(e.key.id)?.end(),this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._layerView.view.labelManager.symbolFader.restartDeclutter(),this.requestRender())}const t=this._layerView.subscriptionManager.updateVisibility();this.setVisibleTiles(t);for(const t of this.children)t.setTransform(e.state);switch(super.renderChildren(e),e.drawPhase){case a.WGLDrawPhase.MAP:return this._renderMapPhase(e);case a.WGLDrawPhase.HIGHLIGHT:return this._renderHighlightPhase(e);case a.WGLDrawPhase.LABEL:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get _instanceStore(){return this._store}get instanceStore(){return this._store}get layerView(){return this._layerView}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight}get _layer(){return this._layerView.layer}_getHeatmapInstance(e){if(null==this._instanceStore||!(e.drawPhase&o.Techniques.heatmap.drawPhase))return null;for(const e of this._instanceStore.values())if(p(e))return e;return null}get tiles(){return this._renderState?.tiles()}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter((e=>this._visibleTiles.has(e.key.id))):[]}updateAttributeView(e){this.requestRender(),this.attributeView.requestUpdate(e),this.hasLabels&&(this._layerView.view.labelManager.requestUpdate(),this._layerView.view.labelManager.symbolFader.restartDeclutter())}updateSubscriptions(e){for(const{tileId:t,version:s}of e.subscribe)if(this._subscriptions.has(t))this._subscriptions.get(t).version=s;else{const e=new c(t,s);this._subscriptions.set(t,e),this.updatingHandles.addPromise(e.promise)}for(const t of e.unsubscribe){const e=this._subscriptions.get(t);e?.destroy(),this._subscriptions.delete(t),this.removeTile(t)}}isDone(e){return!!this._renderState&&this._renderState.isTileDone(e)}async updateRenderState(e){t("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),this._renderStateNext=new l.RenderState((()=>this._stage),(e=>this._subscriptions.get(e)?.version),e,this.layerView.view.labelManager.symbolFader,this,this.tileInfoView)}getDisplayStatistics(e,t){const s=this._statisticsByLevel.get(e);return s?s.get(t):null}updateStatistics(e,t){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:t});let s=this._statisticsByLevel.get(e);s||(s=new Map,this._statisticsByLevel.set(e,s));for(const e of t)s.set(e.fieldName,{minValue:e.minValue,maxValue:e.maxValue})}lockForOverrides(){this._renderState?.lockUploads(),this._lockStatisticUpdates=!0,this.attributeView.locked||(this.attributeView.lockTextureUploads(),this._shouldUnlockAttributeView=!0)}unlockForOverrides(){this._renderState?.unlockUploads(),this._shouldUnlockAttributeView&&(this.attributeView.unlockTextureUploads(),this._shouldUnlockAttributeView=!1),this._lockStatisticUpdates=!1;for(const e of this._updateStatisticsRequests)this.updateStatistics(e.level,e.statistics);this._updateStatisticsRequests=[],this._renderState?.flush(),this.requestRender()}trySwapRenderState(){if(this._renderStateNext){t("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`);const e=new Map;for(const t of this._renderState?.tiles()||[])e.set(t.id,t.metricsVisibility);this._renderState?.destroy(),this._renderState=this._renderStateNext,this._renderState.flush();for(const t of this._renderState.tiles())t.copyMetricsVisibility(e.get(t.id)||new Set);this._renderStateNext=null}this.requestRender()}setVisibleTiles(e){this._visibleTiles=e;for(const t of this.tiles??[])t.rendering=e.has(t.key.id)}async onMessage(e,s){r.throwIfAborted(s);const i=e.inner;if(!this._subscriptions.has(i.id))return;const n=this._subscriptions.get(i.id);if(n.version!==i.subscriptionVesrion){if(t("esri-2d-update-debug")){const e=`${i.subscriptionVesrion} != ${n.version}`;console.debug(`Version[${e}] Tile[${i.id}] FeatureContainer - Dropping message, outdated version]`,i)}return}const a=this._renderStateNext??this._renderState;if(!a)throw new Error("InternalError: No renderState defined");a.version!==i.version&&console.error(`InternalError: Version mismatch. [renderState: ${a.version}, message: ${i.version}]`),a.enqueueUpdate(e),this.requestRender(),this._layerView.view.labelManager.requestUpdate(),this._layerView.requestUpdate()}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e))}hitTest(e){let t=this._hitTestsRequests.find((({x:t,y:s})=>t===e.x&&s===e.y));const s=r.createResolver();return t?t.resolvers.push(s):(t={x:e.x,y:e.y,resolvers:[s]},this._hitTestsRequests.push(t)),this.requestRender(),s.promise}getSortKeys(e){const t=new Set(e),s=new Map;for(const e of this.children)if(e.getSortKeys(t).forEach(((e,t)=>s.set(t,e))),s.size===t.size)break;return s}get hasAnimation(){return this.hasLabels}doRender(e){const{minScale:t,maxScale:s}=this._layer.effectiveScaleRange,r=e.state.scale;r<=(t||1/0)&&r>=s&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}setStencilReference(e){if(null==this._getHeatmapInstance(e))super.setStencilReference(e);else for(const e of this.children)e.stencilRef=o.Techniques.heatmap.getStencilReference(e)}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,a.FeatureSelection.All),this._hitTestsRequests.length>0&&this._renderHittest(e)}_renderHighlightPhase(e){this.hasHighlight&&u.renderHighlight(e,!1,(e=>{this._renderFeatures(e,a.FeatureSelection.Highlight)}))}_renderLabelPhase(e){this._renderFeatures(e,a.FeatureSelection.All)}_renderInsideEffect(e){const t=e.painter.effects.insideEffect;t.bind(e),this._renderFeatures(e,a.FeatureSelection.InsideEffect),t.draw(e,this._layerView.featureEffectView.includedEffects),t.unbind()}_renderOutsideEffect(e){const t=e.painter.effects.outsideEffect;t.bind(e),this._renderFeatures(e,a.FeatureSelection.OutsideEffect),t.draw(e,this._layerView.featureEffectView.excludedEffects),t.unbind()}_renderHittest(e){const{context:t}=e,s=e.painter.effects.hittest,r=t.getBoundFramebufferObject(),i=t.getViewport(),n=e.passOptions,h=e.drawPhase;s.bind(e),e.passOptions=s.createOptions(e,this._hitTestsRequests),e.drawPhase=a.WGLDrawPhase.HITTEST;const{distance:o,smallSymbolDistance:d}=e.passOptions,l=Math.max(o,d);for(const t of this.children)t.visible&&t.containsScreenPoint(e.state,e.passOptions.position,2*l)&&this._renderTile(t,e,a.FeatureSelection.All);s.draw(e),s.unbind(),t.bindFramebuffer(r),t.restoreViewport(i),e.passOptions=n,e.drawPhase=h}_renderFeatures(e,t){const s=this._getHeatmapInstance(e);null!=s?this._renderHeatmapFeatures(e,t,s):this._renderGeometryFeatures(e,t)}_renderGeometryFeatures(e,t){for(const s of this.children)s.visible&&this._renderTile(s,e,t)}_renderHeatmapFeatures(e,t,s){for(const s of this.children)s.visible&&this._renderTile(s,e,t,d.TechniqueType.Heatmap);s.techniqueRef.renderResolvePass(e,s)}_renderTile(e,s,r,i){const n=t("featurelayer-strict-draw-order")?a.FeatureBatchingStrategy.STRICT_ORDER:t("featurelayer-force-marker-text-draw-order")?a.FeatureBatchingStrategy.STRICT_MARKERS_AND_TEXT:a.FeatureBatchingStrategy.BATCHING,h=e.getDisplayList(this._instanceStore,n);s.selection=r,h?.render(s,i)}}function p(e){return e.techniqueRef.type===d.TechniqueType.Heatmap}e.FeatureContainer=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));