// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/Error","./featureReductionUtils","./geometryUtils","./labelingUtils","../schema/SourceSchema","../schema/processor/SimpleProcessorSchema","../support/rendererUtils"],(function(e,t,r,o,n,i,l,a){"use strict";e.InMemoryLayerAdapter=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,o=n.getFeatureReductionDeconflictionEnabled(t,e)??n.getLayerDeconflictionEnabled(t),i=r.getEffectiveFeatureReduction(t,e),l=[...t.labelingInfo||[],...i?.labelingInfo||[]];return[{vvEvaluators:{0:n.createLabelVVEvaluator(t.renderer)},deconflictionEnabled:o,labelingInfo:l}]}async createServiceOptions(e){const r=this.layer,{capabilities:n,objectIdField:i}=r,l=r.fieldsIndex.toJSON(),a=o.getServiceGeometryType(r),s=r.timeInfo?.toJSON(),u=r.spatialReference.toJSON();!function(e){if(!("openPorts"in e))throw new t("featurelayer:source-not-supported","source is not supported")}(r.source);const c=await r.source.openPorts(),d=i,p=e.spatialReference.toJSON();return{type:"memory",source:c,orderByFields:d,outSpatialReference:p,metadata:{fieldsIndex:l,geometryType:a,featureIdInfo:{type:"object-id",fieldName:r.objectIdField},timeInfo:s,spatialReference:u,outSpatialReference:p,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:"datesInUnknownTimezone"in r?r.datesInUnknownTimezone:null,dateFieldsTimeZone:"dateFieldsTimeZone"in r?r.dateFieldsTimeZone:null},queryMetadata:{maxRecordCount:n.query.maxRecordCount,supportsCompactGeometry:n.query.supportsCompactGeometry,supportsDefaultSpatialReference:n.query.supportsDefaultSpatialReference,supportsFormatPBF:n.query.supportsFormatPBF,supportsMaxRecordCountFactor:n.query.supportsMaxRecordCountFactor,supportsQuantization:n.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t){const{definitionExpression:r,timeExtent:o,displayFilterInfo:n}=this.layer,l={customParameters:null,definitionExpression:r,displayFilterInfo:n,timeExtent:o};return i.createFeatureSourceSchema(l,e,t,null)}createProcessorSchema(e,t,o){const{fields:n,renderer:i,geometryType:a,labelingInfo:s,labelsVisible:u,orderBy:c,objectIdField:d}=this.layer,p="trackInfo"in this.layer?this.layer.trackInfo:null,y={fields:n.map((e=>e.toJSON())),renderer:i?.clone(),labelingInfoSource:this.layer.id,featureReduction:r.getEffectiveFeatureReduction(this.layer,t),geometryType:a,labelingInfo:s,labelsVisible:u,objectIdField:d,orderBy:c??"default",trackInfo:p};return l.createSimpleProcessorSchema(e,t,y,o)}get hasRequiredSupport(){return a.isRendererSupported(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.definitionExpression,()=>this.layer.displayFilterInfo,()=>this.layer.orderBy,()=>"outFields"in this.layer?this.layer.outFields:null,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>r.getEffectiveFeatureReduction(this.layer,e),()=>"trackInfo"in this.layer?this.layer.trackInfo:null]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));