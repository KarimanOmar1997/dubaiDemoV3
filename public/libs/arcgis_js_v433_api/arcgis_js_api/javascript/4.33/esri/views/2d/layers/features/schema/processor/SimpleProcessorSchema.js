// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/screenUtils","../../../../../../layers/support/OrderByInfo","../../../../engine/webgl/shaderGraph/techniques/TechniqueType","./LabelMatcherSchema","./MatcherSchema","./StorageSchema","./VisualVariablesSchema"],(function(e,r,t,a,i,s,n,l){"use strict";function o(e,r){return e.fields.map((e=>({...e.toJSON(),type:c(e,r)})))}function c(e,r){const{onStatisticExpression:t,onStatisticField:a,statisticType:i}=e;switch(i){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(t){const{returnType:e}=t;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=r.find((e=>e.name===a));return e?e.type:"esriFieldTypeString"}}}function u(e){return e.techniqueType===a.TechniqueType.AnimatedMarker}function b(e){if("simple"===e.type&&e.meshes.some(u))return!0;if("interval"===e.type){if(e.intervals.some((e=>e.meshes.some(u))))return!0;if(e.backgroundFill.some(u))return!0}if("map"===e.type){if(e.map.some((e=>e.symbol.some(u))))return!0;if(e.backgroundFill.some(u))return!0}return!1}e.createSimpleProcessorSchema=async function(e,a,c,u){const f=c.featureReduction;if(f)switch(f.type){case"binning":return async function(e,t,a,c,u){const f=o(e,c.fields),m=e.renderer,p=await s.createMatcherSchema(t,m),y=n.createStorageSchema(m,[null,null]),d=l.createVisualVariableUniforms(m),g=await i.createLabelMatcherSchema(t,{geometryType:"polygon",labelingInfoSource:c.labelingInfoSource+"-binning",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},d),h=b(p),S="geohash"===e.binType?{type:"geohash",fixBinLevel:e.fixedBinLevel??3}:{type:"grid",size:r.pt2px(e.size),fixedBinLevel:e.fixedBinLevel};return{storage:y,mesh:{properties:{sortKey:null,timeZone:a.timeZone,returnMeshObjectId:h,displayRefreshVersion:u,currentUser:a.currentUser},strategy:{type:"binning",fields:f,index:S,featureFilter:a.filters[0]},factory:{labels:g,symbology:p}},expressionProperties:{timeExtent:a.timeExtent?.toJSON()}}}(f,e,a,c,u);case"cluster":return async function(e,t,a,c,u){const f=o(e,c.fields),m={type:"cluster",feature:await s.createMatcherSchema(t,e.effectiveFeatureRenderer),cluster:await s.createMatcherSchema(t,e.effectiveClusterRenderer)},p=l.createVisualVariableUniforms(e.effectiveFeatureRenderer),y={type:"cluster",feature:await i.createLabelMatcherSchema(t,c,p),cluster:await i.createLabelMatcherSchema(t,{geometryType:"point",labelingInfoSource:c.labelingInfoSource+"-clusters",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},p)},d=n.createStorageSchema(e.effectiveFeatureRenderer,[null,null]),g=b(m);return{storage:d,mesh:{properties:{sortKey:null,timeZone:a.timeZone,displayRefreshVersion:u,returnMeshObjectId:g,currentUser:a.currentUser},strategy:{type:"cluster",fields:f,featureFilter:a.filters[0],clusterRadius:r.pt2px(e.clusterRadius/2)},factory:{labels:y,symbology:m}},expressionProperties:{timeExtent:a.timeExtent?.toJSON()}}}(f,e,a,c,u)}if(c.trackInfo?.enabled)return async function(e,r,t,a,c){const u=o(e,a.fields),f={type:"track",previousObservation:await s.createMatcherSchema(r,e.previousObservations.renderer),latestObservation:await s.createMatcherSchema(r,e.latestObservations.renderer),trackLine:await s.createMatcherSchema(r,e.trackLines.renderer)},m={type:"track",previousObservation:await i.createLabelMatcherSchema(r,{geometryType:a.geometryType,labelingInfoSource:a.labelingInfoSource+"-track-prev",labelingInfo:e.previousObservations.labelingInfo,labelsVisible:e.previousObservations.labelsVisible},l.createVisualVariableUniforms(e.previousObservations.renderer)),latestObservation:await i.createLabelMatcherSchema(r,{geometryType:a.geometryType,labelingInfoSource:a.labelingInfoSource+"-track-latest",labelingInfo:e.latestObservations.labelingInfo,labelsVisible:e.latestObservations.labelsVisible},l.createVisualVariableUniforms(e.latestObservations.renderer)),trackLine:await i.createLabelMatcherSchema(r,{geometryType:"polyline",labelingInfoSource:a.labelingInfoSource+"-track-line",labelingInfo:e.trackLines.labelingInfo,labelsVisible:e.trackLines.labelsVisible},l.createVisualVariableUniforms(e.trackLines.renderer))},p=n.createTrackStorageSchema(e,[null,null]),y=b(f);return{storage:p,mesh:{properties:{sortKey:null,timeZone:t.timeZone,returnMeshObjectId:y,displayRefreshVersion:c,currentUser:t.currentUser},strategy:{type:"track",featureFilter:t.filters[0],fields:u,maxDisplayDuration:e.maxDisplayDuration?.toMilliseconds()??0,maxDisplayObservationsPerTrack:e.maxDisplayObservationsPerTrack,showLatestObservation:e.latestObservations.visible,showPreviousObservations:e.previousObservations.visible,showTrackLine:e.trackLines.visible,timeField:e.timeField},factory:{labels:m,symbology:f}},expressionProperties:{timeExtent:t.timeExtent?.toJSON()}}}(c.trackInfo,e,a,c,u);const m=function(e,r,a){const i=null!=r&&"unique-value"===r.type&&r.orderByClassesEnabled;if("default"!==e||i||(e=[new t({field:a,order:"descending"})]),"default"!==e&&e?.length){e.length;const r=e[0],t="ascending"===r.order?"asc":"desc";return r.field?{field:r.field,order:t}:r.valueExpression?{expression:r.valueExpression,order:t}:null}return i?{byRenderer:!0,order:"asc"}:null}(c.orderBy,c.renderer,c.objectIdField),p=n.createStorageSchema(c.renderer,a.filters),y=await async function(e,r){const t=r.renderer,a=l.createVisualVariableUniforms(t);return{symbology:await s.createMatcherSchema(e,t),labels:await i.createLabelMatcherSchema(e,r,a)}}(e,c),d=b(y.symbology);return{storage:p,mesh:{properties:{sortKey:m,timeZone:a.timeZone,returnMeshObjectId:d,displayRefreshVersion:u,currentUser:a.currentUser},strategy:{type:"feature"},factory:y},expressionProperties:{timeExtent:a.timeExtent?.toJSON()}}},e.getAggregateFields=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));