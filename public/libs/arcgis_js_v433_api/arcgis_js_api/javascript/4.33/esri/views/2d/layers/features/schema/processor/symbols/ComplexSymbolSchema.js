// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../symbols/cim/CIMSymbolHelper","../../../../../../../symbols/cim/defaultCIMValues","../../../../../../../symbols/cim/enums","../../../../../engine/webgl/shaderGraph/techniques/TechniqueRegistry","../VisualVariablesSchema","./utils"],(function(e,a,i,l,n,t,o){"use strict";function s(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function r(e){if(null==e)return null;if(Array.isArray(e)){const[a,i,l,n]=e;return[a,i,l,255*n]}return"string"==typeof e?e:{...e,defaultValue:r(e?.defaultValue)}}function c(e,a,i){const{uniforms:l,schemaOptions:o}=a,{store:s}=o,r=e.isOutline?{...t.noVisualVariables,visualVariableSizeScaleStops:l.visualVariableSizeOutlineScaleStops}:{visualVariableColor:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity,visualVariableSizeMinMaxValue:l.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:l.visualVariableSizeScaleStops,visualVariableSizeStops:l.visualVariableSizeStops,visualVariableSizeUnitValue:l.visualVariableSizeUnitValue,visualVariableRotation:l.visualVariableRotation};if(e.animationParams){const{hasShiftAnimation:a}=e.animationParams.params,l=a?n.Techniques.animatedMarkerShift:n.Techniques.animatedMarker;return u(s.ensureInstance(l,{uniforms:r,optionalAttributes:{zoomRange:!0,value1Position2Value2:e.animationParams.params.hasShiftAnimation,lineLength:a}}),e,t.noVisualVariables,i)}return m(s.ensureInstance(n.Techniques.marker,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,l,i)}function u(e,a,i,n){return a.animationParams?[e.createMeshInfo({pixelDimensions:a.pixelDimensions,texelDimensions:a.texelDimensions,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null,sprite:o.getAnimatedTechniqueSprite(a),animations:a.animationParams,scaleInfo:n.scaleInfo,scaleSymbolsProportionally:a.scaleSymbolsProportionally,strokeWidth:a.outlineWidth,isMapAligned:a.alignment===l.Alignment.MAP,colorLocked:a.colorLocked,isStroke:a.isStroke,baseSize:a.baseSize,placement:a.markerPlacement,referenceSize:a.referenceSize,angleToLine:!!a.markerPlacement&&a.markerPlacement.placement&&"angleToLine"in a.markerPlacement.placement&&a.markerPlacement.placement.angleToLine,sizeRatio:a.sizeRatio,patternHeight:null})]:[]}function f(e,a,i,l){return a.animationParams?[e.createMeshInfo({effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null,sprite:o.getAnimatedTechniqueSprite(a),animations:a.animationParams,scaleInfo:l.scaleInfo,scaleSymbolsProportionally:!1,strokeWidth:1,isMapAligned:!0,colorLocked:a.colorLocked||!1,isStroke:!1,baseSize:"width"in a?a.width:-1,placement:null,referenceSize:2,angleToLine:!1,sizeRatio:1,patternHeight:"fill"===a.type&&a.spriteRasterizationParam?a.height:null,joinType:"join"in a?a.join:"round",capType:"cap"in a?a.cap:"round",miterLimit:"miterLimit"in a&&a.miterLimit||2})]:[]}function m(e,a,l,{scaleInfo:n,scaleExpression:s}){const c=o.hasSizeVVUniform(l);return[e.createMeshInfo({size:a.size,scaleX:a.scaleX,anchorX:a.anchorPoint.x,anchorY:a.anchorPoint.y,angle:a.rotation,color:r(a.color)??[0,0,0,0],colorLocked:a.colorLocked,frameHeight:a.frameHeight,widthRatio:a.widthRatio,scaleInfo:n,offsetX:a.offsetX,offsetY:a.offsetY,outlineColor:r(a.outlineColor)??[0,0,0,0],outlineSize:a.outlineWidth,referenceSize:a.referenceSize||i.defaultCIMValues.CIMVectorMarker.size,rotateClockwise:a.rotateClockwise,scaleFactor:s??1,sizeRatio:a.sizeRatio,alignment:a.alignment,isAbsoluteAnchorPoint:a.isAbsoluteAnchorPoint,scaleSymbolsProportionally:a.scaleSymbolsProportionally,sprite:a.spriteRasterizationParam,hasSizeVV:c,placement:a.markerPlacement,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null,transforms:a.transform,minPixelBuffer:t.getMaxSizeVVSize(l)})]}function p(e,a,i){const{uniforms:l,schemaOptions:t}=a,{store:o}=t;return S(o.ensureInstance(n.Techniques.outlineFill,{uniforms:{visualVariableColor:e.colorLocked?null:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity,visualVariableSizeMinMaxValue:null,visualVariableSizeScaleStops:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function S(e,a,i){const l=r(a.color)??[0,0,0,0],n=r(a.outlineColor)??[0,0,0,0];return[e.createMeshInfo({color:l,outlineColor:n,width:a.outlineWidth,referenceWidth:a.referenceWidth,capType:a.cap,joinType:a.join,miterLimit:a.miterLimit,outlineUsesColorVV:!a.outlineColorLocked,hasSizeVV:!1,scaleInfo:i.scaleInfo,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null,outlineEffects:a.outlineEffects?{type:"cim-effect-infos",effectInfos:a.outlineEffects}:null})]}function b(e,a,{scaleInfo:i}){return[e.createMeshInfo({color:r(a.color)??[0,0,0,0],scaleInfo:i,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null})]}function V(e,a,i){if(!e.spriteRasterizationParam)return function(e,a,i){const{uniforms:l,schemaOptions:o}=a,{store:s}=o,r={visualVariableColor:e.colorLocked?null:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity};if(e.animationParams){const a=n.Techniques.animatedFill;return f(s.ensureInstance(a,{uniforms:{...r,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),e,t.noVisualVariables,i)}return b(s.ensureInstance(n.Techniques.fill,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}(e,a,i);const{uniforms:l,schemaOptions:o}=a,{store:s}=o,r={visualVariableColor:e.colorLocked?null:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity};if(e.animationParams){const a=n.Techniques.animatedFill;return f(s.ensureInstance(a,{uniforms:{...r,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),e,t.noVisualVariables,i)}return h(s.ensureInstance(n.Techniques.complexFill,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,null!=l.visualVariableColor,i)}function h(e,a,i,{scaleInfo:l}){if(!a.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const n=!!a.hasUnresolvedReplacementColor&&(!i||a.colorLocked),t=a.sampleAlphaOnly&&!n,o=a.spriteRasterizationParam;return[e.createMeshInfo({color:r(a.color)??[0,0,0,0],height:a.height,aspectRatio:a.scaleX,offsetX:a.offsetX,offsetY:a.offsetY,scaleX:1,scaleY:1,angle:a.angle,applyRandomOffset:a.applyRandomOffset,sampleAlphaOnly:t,scaleProportionally:"CIMHatchFill"===o.resource.type,sprite:o,scaleInfo:l,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null})]}function z(e,a,i){const{uniforms:l,schemaOptions:t}=a,{store:o}=t;return d(o.ensureInstance(n.Techniques.gradientFill,{uniforms:{visualVariableColor:null,visualVariableOpacity:l.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function d(e,a,{scaleInfo:i}){if(!a.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const l=a.spriteRasterizationParam;return[e.createMeshInfo({color:r(a.color)??[0,0,0,0],angle:a.angle,gradientMethod:a.gradientMethod,gradientSize:a.gradientSize,gradientSizeUnits:a.gradientSizeUnits,gradientType:a.gradientType,sprite:l,scaleInfo:i,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null})]}function v(e,a,i){const{uniforms:l,schemaOptions:o}=a,{store:s}=o,r=e.isOutline?{...t.noVisualVariables,visualVariableSizeScaleStops:l.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity,visualVariableSizeMinMaxValue:l.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:l.visualVariableSizeScaleStops,visualVariableSizeStops:l.visualVariableSizeStops,visualVariableSizeUnitValue:l.visualVariableSizeUnitValue};if(e.animationParams){const{hasShiftAnimation:a}=e.animationParams.params,l=n.Techniques.animatedLine;return f(s.ensureInstance(l,{uniforms:{...r,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,accumulatedDistance:!0,segmentDirection:!0,normal:!0,lineLength:a}}),e,t.noVisualVariables,i)}const c={uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}},u=!!(r.visualVariableSizeMinMaxValue||r.visualVariableSizeScaleStops||r.visualVariableSizeStops||r.visualVariableSizeUnitValue);return e.spriteRasterizationParam?y(s.ensureInstance(n.Techniques.texturedLine,c),e,u,i):g(s.ensureInstance(n.Techniques.line,c),e,u,i)}function I(e,a,{scaleInfo:i}){return{color:r(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:i,hasSizeVV:a,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}function g(e,a,i,l){if(a.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const n=I(a,i,l);return[e.createMeshInfo(n)]}function y(e,a,i,l){const{spriteRasterizationParam:n,scaleDash:t,sampleAlphaOnly:o}=a;if(!n)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({...I(a,i,l),offsetAlongLine:a.offsetAlongLine??0,shouldScaleDash:t??!1,shouldSampleAlphaOnly:o,isSDF:"CIMPictureStroke"!==n.resource.type&&"CIMGradientStroke"!==n.resource.type,sprite:n})]}function M(e,a,i){const{uniforms:l,schemaOptions:o}=a,{store:s}=o;return P(s.ensureInstance(n.Techniques.gradientStroke,{uniforms:e.isOutline?{...t.noVisualVariables,visualVariableSizeScaleStops:l.visualVariableSizeOutlineScaleStops}:{visualVariableColor:null,visualVariableOpacity:l.visualVariableOpacity,visualVariableSizeMinMaxValue:l.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:l.visualVariableSizeScaleStops,visualVariableSizeStops:l.visualVariableSizeStops,visualVariableSizeUnitValue:l.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function P(e,a,i){if(!a.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const l=a.spriteRasterizationParam;return[e.createMeshInfo({...I(a,!1,i),gradientMethod:a.gradientMethod,gradientSize:a.gradientSize,gradientSizeUnits:a.gradientSizeUnits,gradientType:a.gradientType,sprite:l,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null})]}function C(e,a,i){const{uniforms:l,schemaOptions:t}=a,{store:o}=t;return R(o.ensureInstance(n.Techniques.text,{uniforms:{visualVariableColor:e.colorLocked?null:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity,visualVariableRotation:l.visualVariableRotation,visualVariableSizeMinMaxValue:l.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:l.visualVariableSizeScaleStops,visualVariableSizeStops:l.visualVariableSizeStops,visualVariableSizeUnitValue:l.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1,visibility:!1}}),e,l,i)}function R(e,a,i,{scaleInfo:l,scaleExpression:n}){return[e.createMeshInfo({boxBackgroundColor:r(a.backgroundColor),boxBorderLineColor:r(a.borderLineColor),boxBorderLineSize:a.borderLineWidth??0,color:r(a.color)??[0,0,0,0],offsetX:a.offsetX,offsetY:a.offsetY,postAngle:a.angle,fontSize:a.size,referenceSize:a.referenceSize,decoration:a.decoration,haloColor:r(a.haloColor)??[0,0,0,0],haloSize:a.haloSize??0,outlineColor:r(a.outlineColor)??[0,0,0,0],outlineSize:a.outlineSize,lineWidth:a.lineWidth||512,lineHeightRatio:1,horizontalAlignment:a.horizontalAlignment??"center",verticalAlignment:a.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:a.textRasterizationParam,scaleInfo:l,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null,placement:a.markerPlacement,transforms:a.transform,scaleFactor:n??1,minPixelBuffer:t.getMaxSizeVVSize(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,labelClassId:-1})]}e.createAnimatedMarkerMeshInfos=u,e.createAnimatedPolyMeshInfos=f,e.createComplexFillMeshInfos=h,e.createComplexMarkerMeshInfos=m,e.createComplexSimpleFillMeshInfos=b,e.createComplexSimpleLineMeshInfos=g,e.createComplexSimpleOutlineFillMeshInfos=S,e.createComplexSymbolInstances=async function(e,i){const{cimResourceManager:l,cimAnalyzer:n,scaleExpression:t}=i.schemaOptions;await Promise.all(a.CIMSymbolHelper.fetchResources(e.symbol,l,[]));const o=n.analyzeSymbolReference(e,!1),r={scaleInfo:s(e),scaleExpression:t},u=[];for(const e of o)switch(e.type){case"marker":u.push(...c(e,i,r));break;case"fill":u.push(...V(e,i,r));break;case"outlineFill":u.push(...p(e,i,r));break;case"gradientFill":u.push(...z(e,i,r));break;case"line":u.push(...v(e,i,r));break;case"gradientStroke":u.push(...M(e,i,r));break;case"text":u.push(...C(e,i,r))}return u},e.createComplexTextMeshInfos=R,e.createComplexTexturedLineMeshInfos=y,e.createGradientFillMeshInfos=d,e.createGradientStrokeMeshInfos=P,e.getScaleInfo=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));