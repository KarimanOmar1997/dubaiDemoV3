// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../Color","../../../../analysis/dimensionUtils","../../../../analysis/LengthDimension","../../../../core/Accessor","../../../../core/Handles","../../../../core/handleUtils","../../../../core/has","../../../../core/lang","../../../../core/mapCollectionUtils","../../../../core/maybe","../../../../core/memoize","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/support/UpdatingHandles","../../../../geometry/Point","../../../../layers/graphics/hydratedFeatures","./lengthDimensionConstraintUtils","./lengthDimensionManipulatorUtils","./lengthDimensionUtils","./settings","../images/Factory","../../interactive/SnappingVisualizer3D","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/VerticesVisualElement","../../webgl-engine/lib/Material","../../webgl-engine/materials/ImageMaterial","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/RibbonLineMaterial","../../../interactive/coordinateHelper","../../../interactive/editGeometry/EditGeometry","../../../interactive/editGeometry/EditGeometryOperations","../../../interactive/snapping/SnappingContext","../../../interactive/snapping/SnappingDragPipelineStep","../../../interactive/snapping/SnappingManagerPool","../../../interactive/snapping/SnappingOperation","../../../interactive/snapping/snappingUtils"],(function(t,e,n,i,a,o,s,r,l,p,u,d,c,h,g,m,_,M,f,y,v,S,C,b,w,D,T,O,P,H,L,x,G,z,V,R,A,U,I,E,k,F){"use strict";t.LengthDimensionSubTool=class extends o{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new s,this._updatingHandles=new y.UpdatingHandles,this._getSnappingContext=c.memoize((t=>new U.SnappingContext({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new A.EditGeometryOperations(new R.EditGeometry("point",V.createCoordinateHelper(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new O.SnappingVisualizer3D})));const{view:e}=t;this._snappingManagerResult=E.acquire(e),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:G.createStipplePatternSimple(2)}),this._constraintSnappingIndicator=new P.LineVisualElement({view:e,attached:!0,width:1,renderOccluded:L.RenderOccludedFlag.OccludeAndTransparent,stipplePattern:G.createStipplePatternSimple(5),isDecoration:!0});const i=n.toUnitRGBA(D.disabledPointColor);this._stagedStartIndicator=new H.VerticesVisualElement({view:e,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,color:i,size:2*D.pointRadius,outlineSize:0,renderOccluded:L.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0})}initialize(){const{view:t}=this;this._snappingOperation=new k.SnappingOperation({view:t});const e=D.getTransparentAccentColor(t.effectiveTheme),i=D.getContrastColor(t.effectiveTheme),a=!t.stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._textureHandle=T.getRotateHeadingTexture(t.stage.textures,{accentColor:e,contrastColor:i,preMultiplyAlpha:a}),this._orientationManipulatorMaterial=new x.ImageMaterial({draped:!1,texture:this._textureHandle.texture,writeDepth:!1,renderOccluded:L.RenderOccludedFlag.Opaque,isDecoration:!0});const o=u.mapCollection((()=>this.analysisViewData.computations),(({computation:t})=>this._createManipulators(t)));this.addHandles([g.watch((()=>({accentColor:D.getTransparentAccentColor(t.effectiveTheme),contrastColor:D.getContrastColor(t.effectiveTheme)})),(({accentColor:e,contrastColor:i})=>{const o=this._textureHandle;this._textureHandle=T.getRotateHeadingTexture(t.stage.textures,{accentColor:e,contrastColor:i,preMultiplyAlpha:a}),this._orientationManipulatorMaterial.setParameters({texture:this._textureHandle.texture}),o?.release();const s=n.toUnitRGBA(e);this._unfocusedOffsetManipulatorMaterial.setParameters({color:s}),this._focusedOffsetManipulatorMaterial.setParameters({color:s}),this._thinOffsetManipulatorMaterial.setParameters({color:s}),this._constraintSnappingIndicator.color=s}),g.initial),r.destroyHandle(o),g.watch((()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation})),(({stagedPoint:t,stagedComputation:e})=>{if(null==e||null==t)return;const n=S.clonePoint(t,new v);this._applyPointUpdate(e,{endPoint:n})}),g.sync),g.watch((()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator})),((t,e)=>{const{stagedDimension:n,selectedComputation:i,firstGrabbedManipulator:a}=t;if(n===e?.stagedDimension&&a===e?.firstGrabbedManipulator){for(const n of[i,e?.selectedComputation])if(null!=n){const e=this._computationManipulators.get(n);null!=e&&this._updateManipulators(n,e,t)}}else for(const[e,n]of this._computationManipulators)this._updateManipulators(e,n,t)}),g.syncAndInitial),g.watch((()=>this.analysis.style.lineSize),(t=>this._updateManipulatorStyle(t)),g.initial),g.watch((()=>this.view.state.camera),(()=>{null!=this._stagedComputation&&this._updateStagedDimensionOffset(this._stagedComputation)})),g.watch((()=>{const t=this._stagedComputation;if(!t)return null;const e=t.elevationAlignedStartPoint,n=f.create();return null!=e&&this.view.renderCoordsHelper.toRenderCoords(e,n)?n:null}),(t=>{null!=t?(this._stagedStartIndicator.vertices=[t],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1}))]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),F.setupSnappingToggleHandles(this,(()=>{const t=this._activeComputation,e=this._stagedComputation;if(null==t||null!=e){const t=this.view.inputManager.latestPointerType??"mouse",e=this._getSnappingContext(t);this._updatingHandles.addPromise(h.ignoreAbortErrors(this._snappingOperation.snapAgainNearPreviousMapPoint(this._snappingManager,e)))}if(null!=t){const{start:e,end:n}=this._computationManipulators.get(t);if(e.grabbing||n.grabbing){const n=e.grabbing?"start":"end",i=this._computeConstraint(t);C.reapplyConstraint(t,n,{constraint:i,view:this.view})}}}))}destroy(){this._textureHandle=d.releaseMaybe(this._textureHandle),this._snappingOperation=d.destroyMaybe(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(null!=this._stagedComputation)return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&null!=t?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1)?.computation;return null==t||null==e||e.dimension!==t?null:e}get _constraintHandles(){return[g.when((()=>this.analysisViewData.selectedComputation),(t=>{t.previousConstraint=this._computeConstraint(t)}),{...g.syncAndInitial,equals:p.equals}),g.watch((()=>{const t=this._activeComputation;if(null==t)return null;const{measureType:e,orientation:n}=t.dimension;return{measureType:e,orientation:n,computation:t}}),((t,e)=>{if(null!=t&&null==e){const{measureType:e,orientation:n,computation:a}=t;switch(a.previousConstraint){case C.LengthDimensionConstraint.Horizontal:a.preConstraintProperties={measureType:i.LengthDimensionMeasureType.Horizontal,orientation:0};break;case C.LengthDimensionConstraint.Vertical:a.preConstraintProperties={measureType:i.LengthDimensionMeasureType.Vertical,orientation:0};break;case C.LengthDimensionConstraint.Direct:a.preConstraintProperties={measureType:i.LengthDimensionMeasureType.Direct,orientation:n};break;default:a.preConstraintProperties={measureType:e,orientation:n}}}null==t&&null!=e&&(e.computation.preConstraintProperties=null)}),g.sync)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[g.watch((()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation})),(({stagedComputation:e,activeComputation:n})=>{const i=this._constraintSnappingIndicator;if(this.removeHandles(t),null!=n)if(n===e)i.attached=!0;else{const{start:e,end:a}=this._computationManipulators.get(n),o=()=>{i.attached=e.grabbing||a.grabbing};o(),this.addHandles([e.events.on("grab-changed",o),a.events.on("grab-changed",o)],t)}else i.attached=!1})),g.watch((()=>{const t=this._activeComputation;return null!=t?{geometry:t.geometry,constraint:t.previousConstraint}:{}}),(({geometry:t,constraint:e})=>{const n=this._constraintSnappingIndicator;null!=t&&null!=e&&e!==C.LengthDimensionConstraint.Direct?(n.visible=!0,n.setGeometryFromSegment(t.directSegment)):n.visible=!1}))]}removeStaged(){return null!=this._stagedDimension&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(null==e){const e=this._onUnstagedClick(t);return this.analysis.dimensions.add(e),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if("touch"===e)return;const n=this._getSnappingContext(e);this._updatingHandles.addPromise(h.ignoreAbortErrors(this._snappingOperation.snap({point:t},this._snappingManager,n)))}onManipulatorSelectionChanged(){null!=this.analysisViewData.selectedComputation&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let n=t;if("mouse"===e){const i=this._getSnappingContext(e);n=this._snappingManager.update({point:t,context:i})}const o=new a({startPoint:S.clonePoint(n,new v),endPoint:null,measureType:i.LengthDimensionMeasureType.Horizontal});return this._stagedDimension=o,this._resetSnappingState(),o}_onStagedClick({mapPoint:t,pointerType:e}){const n=this._stagedComputation;if(null==n)return;let i=t;if("mouse"===e){const n=this._getSnappingContext(e);i=this._snappingManager.update({point:t,context:n})}const a=S.clonePoint(i,new v);this._applyPointUpdate(n,{endPoint:a}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(t){const e=this._setupPointManipulator(t,{isStart:!0}),n=this._setupPointManipulator(t,{isStart:!1}),a=this._setupOffsetManipulator(t),o=this._setupHeadingManipulator(t),s=this._setupRotationManipulator(t),l=this._setupMeasureTypeManipulator(t,i.LengthDimensionMeasureType.Direct),p=this._setupMeasureTypeManipulator(t,i.LengthDimensionMeasureType.Horizontal),u=this._setupMeasureTypeManipulator(t,i.LengthDimensionMeasureType.Vertical),d=new b.LengthDimensionManipulators({start:e,end:n,offset:a,heading:o,rotation:s,direct:l,horizontal:p,vertical:u});this._setupComputationToManipulatorsSync(t,d),this._computationManipulators.set(t,d),this.manipulators.addMany(d.values());const c=r.handlesGroup(d.values().map((t=>t.events.on("focus-changed",(()=>{d.values().some((t=>t.focused))&&this._resetSnappingState()})))));return{manipulators:d,remove:()=>{c.remove(),this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const t of d.values())this.manipulators.remove(t)}}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([g.watch((()=>t.geometry),(()=>this._updateManipulators(t,e)),{...g.syncAndInitial,equals:p.equals})],t)}_setupPointManipulator(t,e){const{view:n}=this,{dimension:i}=t,a=new b.LengthDimensionPointManipulator(n,{metadata:i}),o=b.pointManipulatorHandles(a,{isStart:e.isStart,createSnappingPipelineStep:t=>I.createSnapDragEventPipelineStep({snappingContext:this._getSnappingContext(t),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:i,onUpdate:e=>this._applyPointUpdate(t,e),view:n});return this._computationHandles.add(o,t),a}_setupOffsetManipulator(t){const{view:e}=this,n=b.createOffsetManipulator(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),i=b.offsetManipulatorHandles(n,{computation:t,view:e});return this._computationHandles.add(i,t),n}_setupHeadingManipulator(t){const{view:e}=this,n=new b.LineOfSightOrientationManipulator(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),i=b.headingManipulatorHandles(n,{computation:t,view:e});return this._computationHandles.add(i,t),n}_setupRotationManipulator(t){const{view:e}=this,n=new b.LineOfSightOrientationManipulator(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),i=b.rotationManipulatorHandles(n,{computation:t,view:e});return this._computationHandles.add(i,t),n}_setupMeasureTypeManipulator(t,e){const{view:n}=this,i=b.createMeasureTypeManipulator(n,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),a=b.measureTypeManipulatorHandles(i,{computation:t,manipulatorMeasureType:e,view:n});return this._computationHandles.add(a,t),i}_updateManipulators(t,e,n={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:a,selectedComputation:o,firstGrabbedManipulator:s}=n,{start:r,end:l,offset:p,heading:u,rotation:d}=e,c=o===t,h=w.isValidComputation(t),{dimension:g}=t;for(const t of e.values()){const e=h&&null==a&&(null==s||t===s);t===p?(t.available=e,t.selected=c):t.available=e&&c}if(!h)return;null!=this._computeConstraint(t)?e.forEachMeasureTypeManipulator((t=>t.available=!1)):e.manipulatorForMeasureType(g.measureType).available=!1;for(const t of[u,d])g.measureType===i.LengthDimensionMeasureType.Direct&&0!==g.offset||(t.available=!1);w.arePointsVerticallyAligned(t)?d.available=!1:u.available=!1;const{geometry:m}=t;r.renderLocation=m.directSegment.startRenderSpace,l.renderLocation=m.directSegment.endRenderSpace;const{renderCoordsHelper:_}=this.view;b.updateOffsetManipulatorTransform(p,m,_),u.available&&b.updateHeadingManipulatorTransform(u,t,_),d.available&&b.updateRotationManipulatorTransform(d,t,_),e.forEachMeasureTypeManipulator(((e,n)=>{e.available&&b.updateMeasureTypeManipulatorTransform(e,t,n,_)}))}_updateManipulatorStyle(t){const e=b.unfocusedOffsetWidth(t),n=b.focusedOffsetWidth(t),i={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:t,heading:e,rotation:a}of this._computationManipulators.values())t.radius=n/2,e.update(i),a.update(i);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:n})}_applyPointUpdate(t,e){const{view:n}=this,i=w.computationToGeometryDependencies(t);"startPoint"in e&&(i.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(i.elevationAlignedEndPoint=e.endPoint);const a=w.computeGeometryFromDimension(i,n.renderCoordsHelper);if(null==a)return;const o=this._computeConstraint({...i,geometry:a});C.applyConstraint(t,e,{...i,constraint:o,unconstrainedGeometry:a,view:n}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(null==t.geometry)return;t.geometry.directSegment.eval(.5,q);const{state:e,renderCoordsHelper:n}=this.view,i=e.camera.computeScreenPixelSizeAt(q);t.dimension.offset=D.initialOffsetPx*i*n.unitInMeters}_computeConstraint(t){return C.computeConstraint(C.constraintDependencies(t,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new z.RibbonLineMaterial({width:1,renderOccluded:L.RenderOccludedFlag.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get test(){}},e.__decorate([m.property({constructOnly:!0})],t.LengthDimensionSubTool.prototype,"analysis",void 0),e.__decorate([m.property({constructOnly:!0})],t.LengthDimensionSubTool.prototype,"analysisViewData",void 0),e.__decorate([m.property({constructOnly:!0})],t.LengthDimensionSubTool.prototype,"manipulators",void 0),e.__decorate([m.property({constructOnly:!0})],t.LengthDimensionSubTool.prototype,"parentTool",void 0),e.__decorate([m.property({constructOnly:!0,nonNullable:!0})],t.LengthDimensionSubTool.prototype,"view",void 0),e.__decorate([m.property({readOnly:!0})],t.LengthDimensionSubTool.prototype,"updating",null),e.__decorate([m.property()],t.LengthDimensionSubTool.prototype,"firstGrabbedManipulator",null),e.__decorate([m.property()],t.LengthDimensionSubTool.prototype,"hasGrabbedManipulators",null),e.__decorate([m.property()],t.LengthDimensionSubTool.prototype,"snappingOptions",null),e.__decorate([m.property()],t.LengthDimensionSubTool.prototype,"_stagedDimension",void 0),e.__decorate([m.property()],t.LengthDimensionSubTool.prototype,"_activeComputation",null),e.__decorate([m.property()],t.LengthDimensionSubTool.prototype,"_stagedComputation",null),t.LengthDimensionSubTool=e.__decorate([M.subclass("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],t.LengthDimensionSubTool);const q=f.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));