// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../Color","../../../../analysis/dimensionUtils","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/Point","../../../../geometry/support/plane","../../../../geometry/support/vectorStacks","../../../../layers/graphics/hydratedFeatures","./lengthDimensionUtils","./settings","../../interactive/Manipulator3D","../../interactive/manipulatorUtils","../../interactive/RenderObject","../../interactive/editingTools/dragEventPipeline3D","../../interactive/visualElements/support/Segment","../../support/engineContent/marker","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Material","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/RibbonLineMaterial","../../../interactive/dragEventPipeline","../../../interactive/interfaces"],(function(e,t,n,a,r,i,o,s,l,c,d,u,p,m,g,f,h,y,M,S,v,T,P,b,w,D,x,O,R,F,C,H){"use strict";class A extends M.Manipulator3D{constructor(e,n){const a=S.createManipulatorMaterial(t.toUnitRGBA(y.getTransparentAccentColor(e.effectiveTheme))),r=[new v.RenderObject(x.createSphereGeometry(a,1,32,32),J)];super({view:e,renderObjects:r,metadata:n.metadata,available:!1,grabCursor:"crosshair",radius:y.pointRadius,collisionPriority:1}),this._themeHandle=i.watch((()=>({color:t.toUnitRGBA(y.getTransparentAccentColor(e.effectiveTheme))})),(e=>a.setParameters(e)))}destroy(){this._themeHandle.remove(),super.destroy()}}class E extends M.Manipulator3D{constructor(e,{lineSizePt:n,material:a,metadata:r}){super({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:r}),this._options={calloutColor:u.create(),lineSizePt:n,material:a},this._themeHandle=i.watch((()=>t.toUnitRGBA(y.getTransparentAccentColor(e.effectiveTheme))),(e=>{this._options.calloutColor=e,q(this,L({...this._options,metadata:this.metadata}))}),i.initial)}update({lineSizePt:e,material:t}){this._options.lineSizePt=e,this._options.material=t,q(this,L({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function L({calloutColor:e,lineSizePt:t,material:n,metadata:a}){return{calloutLength:.25*b.markerSizePerLineWidth*y.markerLineSizeFraction*o.pt2px(t)+y.orientationCalloutOffsetPx,calloutColor:e,calloutWidth:y.orientationCalloutWidth,customStateMask:J,discScale:y.orientationDiscScale,focusMultiplier:y.orientationFocusMultiplier,material:n,metadata:a}}function G(e){const{cancel:t,computation:n,settingHeading:a,steps:i,view:o}=e;if(!h.isValidComputation(n))return;const{renderCoordsHelper:s}=o,{dimension:l,geometry:u}=n,p=d.create(),f=k(d.create(),u,u.directSegment,s),y=N(g.sv3d.get(),{forHeading:a,geometry:u,renderCoordsHelper:s}),M=m.fromPositionAndNormal(f,y,m.create()),v=a?l.orientation??h.headingFromGeometry(u,o.renderCoordsHelper):l.orientation??0;i.next(T.screenToRenderPlane(o,M)).next((e=>{"start"===e.action&&c.copy(p,e.renderStart);const t=m.getNormal(M),n=S.calculateInputRotationTransform(p,e.renderEnd,f,t);let i=v-r.rad2deg(n);a||(i=U(i)),l.orientation=i})),t.next(C.resetProperties(l,["orientation"]))}function U(e){const t=a.cyclicalDegrees.normalize(e)%90;return t<y.orientationSnapThresholdDegrees?e-t:90-t<y.orientationSnapThresholdDegrees?e+(90-t):e}function j(e,t,n,a){const r=c.subtract(g.sv3d.get(),n.endRenderSpace,n.startRenderSpace);c.cross(r,r,a);const i=m.fromPositionAndNormal(n.startRenderSpace,r,m.create()),o=m.fromPositionAndNormal(n.startRenderSpace,a,m.create()),s=t.offset;let l,d=0;const u=new C.EventPipeline;return u.next(T.screenToRenderPlane(e,i)).next((n=>{"start"===n.action&&(d=m.signedDistance(o,n.renderStart));const a=(m.signedDistance(o,n.renderEnd)-d)*e.renderCoordsHelper.unitInMeters;t.offset=s+a,l=n})),e=>(u.execute(e),l)}function z(e,t){const{directSegment:n}=e,{renderCoordsHelper:a}=t,r=h.directUp(g.sv3d.get(),e,a),i=h.directStartToEnd(g.sv3d.get(),e),o=c.cross(g.sv3d.get(),i,r),{viewForward:s}=t.state.camera;c.dot(o,s)>0&&c.scale(o,o,-1);const l=n.eval(.5,g.sv3d.get());return a.headingAtPosition(l,o)}function V(e,t,n,{forHeading:a}){const{dimension:r,geometry:i}=t,{primaryOffsetAxis:o}=i,s=c.scale(W,o,r.offset>=0?1:-1),l=N(_,{forHeading:a,geometry:i,renderCoordsHelper:n});c.cross(l,l,s);const u=S.calculateTranslateRotateFromBases(s,l,d.ZEROS,X);e.modelTransform=u,e.renderLocation=k(K,i,i.dimensionSegment,n)}const W=d.create(),_=d.create();function k(e,t,n,a){const{startRenderSpace:r,endRenderSpace:i}=n,o=function(e,t){const n=h.directStartToEnd(B,e),a=h.directUp(I,e,t);return c.dot(n,a)>0}(t,a)?r:i;return c.copy(e,o)}function N(e,{forHeading:t,geometry:n,renderCoordsHelper:a}){return t?h.directUp(e,n,a):h.dimensionStartToEnd(e,n,{invert:!0})}const B=d.create(),I=d.create();function Z(e){return o.pt2px(e)+y.focusedLinePaddingPx}function q(e,t){const n=t.material,a=t.focusMultiplier??S.rotateManipulatorDefaults.focusMultiplier,r=t.calloutLength??S.rotateManipulatorDefaults.calloutLength,i=S.rotateManipulatorDefaults.discRadius*(t.discScale??1),o=i*a,s=(e,t)=>{const n=[0,1,2,2,3,0];return new D.Geometry(t,[[R.VertexAttribute.POSITION,new w.Attribute([r-e,-e,0,r+e,-e,0,r+e,e,0,r-e,e,0],n,3,!0)],[R.VertexAttribute.UV0,new w.Attribute([0,0,1,0,1,1,0,1],n,2,!0)]])},l=t.calloutWidth??S.rotateManipulatorDefaults.calloutWidth,c=new F.RibbonLineMaterial({width:l,color:t.calloutColor,renderOccluded:O.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0}),d=x.createPolylineGeometry(c,[[0,0,0],[r-i,0,0]]),u=x.createPolylineGeometry(c,[[0,0,0],[r-o,0,0]]),p=t.customStateMask??H.ManipulatorStateCustomFlags.None;e.collisionType={type:"disc",direction:[0,0,1],offset:[r,0,0]},e.focusMultiplier=a,e.metadata=t.metadata,e.radius=i,e.renderObjects=[new v.RenderObject(s(i,n),H.ManipulatorStateFlags.Unfocused|p),new v.RenderObject(d,H.ManipulatorStateFlags.Unfocused|p),new v.RenderObject(s(o,n),H.ManipulatorStateFlags.Focused|p),new v.RenderObject(u,H.ManipulatorStateFlags.Focused|p)]}const J=H.ManipulatorStateCustomFlags.Custom1,K=d.create(),Q=d.create(),X=l.create(),Y=new P.EuclideanSegment;e.DidPointerMoveRecentlyFlag=J,e.LengthDimensionManipulators=class{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find((t=>this.hasOwnProperty(t)&&e===this[t]))}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const t of n.lengthDimensionMeasureType)e(this.manipulatorForMeasureType(t),t)}manipulatorForMeasureType(e){switch(e){case n.LengthDimensionMeasureType.Direct:return this.direct;case n.LengthDimensionMeasureType.Horizontal:return this.horizontal;case n.LengthDimensionMeasureType.Vertical:return this.vertical}}},e.LengthDimensionPointManipulator=A,e.LineOfSightOrientationManipulator=E,e.automaticHeadingFromCamera=z,e.createMeasureTypeManipulator=function(e,t){const n=[d.fromValues(-.5,0,0),d.fromValues(.5,0,0)],a=x.createPolylineGeometry(t.thinOffsetManipulatorMaterial,n),r=x.createPolylineGeometry(t.unfocusedMaterial,n.map((e=>c.scale(d.create(),e,y.lengthFraction)))),i=r.instantiate({material:t.focusedMaterial});return new M.Manipulator3D({view:e,renderObjects:[new v.RenderObject(r,H.ManipulatorStateFlags.Unfocused|J),new v.RenderObject(i,H.ManipulatorStateFlags.Focused|J),new v.RenderObject(a,J)],collisionType:{type:"line",paths:[n]},radius:Z(t.lineSizePt)/2,available:!1,metadata:t.metadata,...S.worldScaledManipulatorSettings})},e.createOffsetManipulator=function(e,t){const n=[d.fromValues(-.5,0,0),d.fromValues(.5,0,0)],a=x.createPolylineGeometry(t.unfocusedMaterial,n.map((e=>c.scale(d.create(),e,y.lengthFraction)))),r=a.instantiate({material:t.focusedMaterial});return new M.Manipulator3D({view:e,renderObjects:[new v.RenderObject(a,H.ManipulatorStateFlags.Unfocused|H.ManipulatorStateFlags.Selected|J),new v.RenderObject(r,H.ManipulatorStateFlags.Focused|J)],collisionType:{type:"line",paths:[n]},radius:Z(t.lineSizePt)/2,metadata:t.metadata,available:!1,...S.worldScaledManipulatorSettings})},e.focusedOffsetWidth=Z,e.headingManipulatorHandles=function(e,{computation:t,view:n}){return[C.createManipulatorDragEventPipeline(e,((e,a,r)=>{G({cancel:r,computation:t,settingHeading:!0,steps:a,view:n})}))]},e.measureTypeManipulatorHandles=function(e,{computation:t,manipulatorMeasureType:a,view:r}){let i=n.LengthDimensionMeasureType.Direct,o=0,s=0;return[e.events.on("grab-changed",(n=>{if("start"!==n.action||!h.isValidComputation(t))return;const{dimension:l,geometry:d}=t;i=l.measureType,o=l.offset,s=l.orientation;const u=c.copy(g.sv3d.get(),e.renderLocation);l.measureType=a,l.offset=h.computeOffsetForPoint(u,a,d,r.renderCoordsHelper),l.orientation=0})),C.createManipulatorDragEventPipeline(e,((e,n,l)=>{if(!h.isValidComputation(t))return;const{geometry:c,dimension:d}=t,{renderCoordsHelper:u}=r,p=h.computeSegmentForMeasureType(Y,a,t,u),m=h.computeOffsetAxis(g.sv3d.get(),{measureType:a,directSegment:c.directSegment,renderCoordsHelper:u}),f=T.hideManipulatorWhileDragging(e);n.next(f).next(j(r,d,p,m)),l.next(f).next((e=>(d.measureType=i,d.offset=o,d.orientation=s,e)))}))]},e.offsetManipulatorHandles=function(e,{computation:t,view:n}){return[C.createManipulatorDragEventPipeline(e,((e,a,r)=>{if(!h.isValidComputation(t)||!e.selected)return;const{geometry:i,dimension:o}=t,s=T.hideManipulatorWhileDragging(e);a.next(s).next(j(n,o,i.dimensionSegment,i.primaryOffsetAxis)),r.next(s).next(C.resetProperties(o,["offset"]))}))]},e.pointManipulatorHandles=function(e,{isStart:t,createSnappingPipelineStep:n,dimension:a,onUpdate:r,view:i}){const o=t?"startPoint":"endPoint";return[C.createManipulatorDragEventPipeline(e,((e,t,s,l)=>{const c=T.hideManipulatorWhileDragging(e),{snappingStep:d,cancelSnapping:u}=n(l);s=s.next(c).next(C.resetProperties(a,[o,"measureType","orientation"])).next(u),t.next(c).next(T.screenToMap3D(i)).next(...d).next((e=>{const t=f.clonePoint(e.mapEnd,new p);r("startPoint"===o?{startPoint:t}:{endPoint:t})}))}))]},e.rotationManipulatorHandles=function(e,{computation:t,view:n}){return[C.createManipulatorDragEventPipeline(e,((e,a,r)=>{G({cancel:r,computation:t,settingHeading:!1,steps:a,view:n})})),e.events.on("immediate-click",(e=>{!function(e,t,n){const{dimension:r,geometry:i}=t;if(90===r.orientation||270===r.orientation)return r.orientation=0,void e.stopPropagation();if(null==i)return;const{renderCoordsHelper:o}=n,s=h.computeGeometryFromDimension({...h.computationToGeometryDependencies(t),orientation:90},o),l=h.computeGeometryFromDimension({...h.computationToGeometryDependencies(t),orientation:270},o);if(null==s||null==l)return;const c=h.headingFromGeometry(s,o),d=h.headingFromGeometry(l,o),u=z(i,n),p=a.cyclicalDegrees.shortestSignedDiff(u,c),m=a.cyclicalDegrees.shortestSignedDiff(u,d);r.orientation=Math.abs(p)<Math.abs(m)?90:270,e.stopPropagation()}(e,t,n)}))]},e.snapOrientationToNearestRightAngle=U,e.unfocusedOffsetWidth=function(e){return o.pt2px(e)+y.linePaddingPx},e.updateHeadingManipulatorTransform=function(e,t,n){V(e,t,n,{forHeading:!0})},e.updateMeasureTypeManipulatorTransform=function(e,t,n,a){const{geometry:r}=t,i=h.computeSegmentForMeasureType(Y,n,t,a),o=h.computeOffsetAxis(K,{measureType:n,directSegment:r.directSegment,renderCoordsHelper:a}),l=c.sub(Q,i.endRenderSpace,i.startRenderSpace),u=S.calculateTranslateRotateFromBases(l,o,d.ZEROS,X),p=c.length(l);s.scale(u,u,c.set(Q,p,p,p)),e.modelTransform=u,e.renderLocation=i.eval(.5,Q)},e.updateOffsetManipulatorTransform=function(e,t,n){const{dimensionSegment:a,primaryOffsetAxis:r}=t,i=h.dimensionStartToEnd(K,t),o=c.exactEquals(i,d.ZEROS)?s.identity(X):S.calculateTranslateRotateFromBases(i,r,d.ZEROS,X),l=Math.max(c.length(i),y.minLengthMeters/n.unitInMeters);s.scale(o,o,c.set(K,l,l,l)),e.modelTransform=o,e.renderLocation=a.eval(.5,K)},e.updateRotationManipulatorTransform=function(e,t,n){V(e,t,n,{forHeading:!1})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));