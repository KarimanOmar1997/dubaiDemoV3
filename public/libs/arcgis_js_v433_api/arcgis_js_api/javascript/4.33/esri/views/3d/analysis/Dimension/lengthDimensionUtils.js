// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../analysis/dimensionUtils","../../../../core/mathUtils","../../../../core/quantityUtils","../../../../core/unitUtils","../../../../core/accessorSupport/ensureType","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../../geometry/support/Axis","../../../../geometry/support/vectorStacks","../../../../layers/graphics/dehydratedPoint","../../../../layers/graphics/hydratedFeatures","../../interactive/visualElements/support/Segment","../../../support/euclideanLengthMeasurementUtils","../../../support/geodesicMeasurementUtils"],(function(e,n,t,i,r,o,a,s,d,c,l,u,g,p,m,S,f,v){"use strict";class y{constructor(e,n,t,i,r,o){this.elevationAlignedStartPoint=e,this.elevationAlignedEndPoint=n,this.directSegment=t,this.dimensionSegment=i,this.primaryOffsetAxis=r,this.spatialReference=o}}const R=o.ensureType(l);var A;function P(e,n,t){return t.toRenderCoords(n.elevationAlignedStartPoint,e.startRenderSpace),t.toRenderCoords(n.elevationAlignedEndPoint,e.endRenderSpace),e}e.OffsetSegmentLocation=void 0,(A=e.OffsetSegmentLocation||(e.OffsetSegmentLocation={}))[A.Start=0]="Start",A[A.End=1]="End";const h=p.makeDehydratedPoint(0,0,0,null),D=new S.EuclideanSegment;function T(e,i){const{measureType:r,elevationAlignedStartPoint:o,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:l,endRenderSpace:p},directSegment:m,renderCoordsHelper:S}=i,f=m.eval(.5,g.sv3d.get()),v=S.worldUpAtPosition(f,g.sv3d.get()),y=S.worldBasisAtPosition(f,u.Axis.Y,g.sv3d.get());switch(r){case n.LengthDimensionMeasureType.Horizontal:d.copy(e,v);break;case n.LengthDimensionMeasureType.Vertical:d.dot(l,v)<d.dot(p,v)?d.sub(e,p,l):d.sub(e,l,p),d.cross(e,e,v),d.cross(e,e,v);break;case n.LengthDimensionMeasureType.Direct:{const n=i.orientation??0;if(L({elevationAlignedStartPoint:o,elevationAlignedEndPoint:s}))a.fromRotation(E,-t.deg2rad(n),v),d.transformMat4(e,y,E);else{const i=d.sub(g.sv3d.get(),p,l),r=d.cross(g.sv3d.get(),i,v);d.cross(r,r,i),a.fromRotation(E,t.deg2rad(n),i),d.transformMat4(e,r,E)}break}}return d.equals(e,c.ZEROS)?d.copy(e,y):d.normalize(e,e)}const E=s.create();function L({elevationAlignedStartPoint:e,elevationAlignedEndPoint:n}){return null!=e&&null!=n&&e.x===n.x&&e.y===n.y}function M(e,n,t,i,r){const{startRenderSpace:o,endRenderSpace:a}=i,s=t/r.unitInMeters,[c,l]=function(e,n,t,i=0){const r=d.dot(n,t),o=d.dot(e,t),a=Math.abs(r-o)+i;return r>o?[a,i]:[i,a]}(o,a,n,s);return d.scaleAndAdd(e.startRenderSpace,i.startRenderSpace,n,c),d.scaleAndAdd(e.endRenderSpace,i.endRenderSpace,n,l),e}function b(e,n,t={invert:!1}){const{startRenderSpace:i,endRenderSpace:r}=n.dimensionSegment;return t.invert?d.sub(e,i,r):d.sub(e,r,i)}const x=c.create();e.LengthDimensionGeometry=y,e.arePointsVerticallyAligned=L,e.computationToGeometryDependencies=function(e){const{elevationAlignedStartPoint:n,elevationAlignedEndPoint:t,dimension:{offset:i,measureType:r,orientation:o}}=e;return{elevationAlignedStartPoint:n,elevationAlignedEndPoint:t,offset:i,measureType:r,orientation:o}},e.computeGeometryFromDimension=function({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:r,orientation:o},a,s=null){if(null==e||null==t)return null;const l=P(s?.directSegment??new S.EuclideanSegment,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},a),u=s?.primaryOffsetAxis??c.create();T(u,{measureType:r,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:l,orientation:o,renderCoordsHelper:a});const g=s?.dimensionSegment??new S.EuclideanSegment;return L({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&r===n.LengthDimensionMeasureType.Vertical?(d.copy(g.startRenderSpace,l.startRenderSpace),d.copy(g.endRenderSpace,l.endRenderSpace)):M(g,u,i,l,a),new y(e,t,l,g,u,a.spatialReference)},e.computeLength=function(e,t,o,a){if(null==e)return null;let s;if(t===n.LengthDimensionMeasureType.Horizontal)s=a.autoDistanceBetweenPoints2D(R(e.elevationAlignedStartPoint),R(e.elevationAlignedEndPoint));else{const{startRenderSpace:n,endRenderSpace:t}=e.dimensionSegment;s=f.euclideanDirectDistance(n,t,e.spatialReference)}if(null==s)return null;const d=t===n.LengthDimensionMeasureType.Vertical?r.adaptiveVerticalLengthUnit(s.value,s.unit,o):r.adaptiveLengthUnit(s.value,s.unit,o);return i.toUnit(s,d)},e.computeOffsetAxis=T,e.computeOffsetForPoint=function(e,n,t,i){const{directSegment:r}=t,o=T(g.sv3d.get(),{measureType:n,directSegment:r,renderCoordsHelper:i}),a=M(D,o,0,r,i).eval(.5,g.sv3d.get()),s=d.sub(g.sv3d.get(),e,a);return d.dot(s,o)*i.unitInMeters},e.computeSegmentForMeasureType=function(e,t,i,r){switch(t){case n.LengthDimensionMeasureType.Direct:return P(e,i,r);case n.LengthDimensionMeasureType.Horizontal:case n.LengthDimensionMeasureType.Vertical:{const{elevationAlignedStartPoint:o,elevationAlignedEndPoint:a,dimension:s,geometry:l}=i;let u;if(s.measureType===n.LengthDimensionMeasureType.Direct){const e=function(e,n){const t=e.directSegment.eval(.5,g.sv3d.get()),i=n.worldUpAtPosition(t,g.sv3d.get()),r=e.dimensionSegment.eval(.5,g.sv3d.get()),o=d.sub(g.sv3d.get(),r,t);return!d.equals(o,c.ZEROS)&&d.dot(o,i)>0}(l,r);u=e===o.z>a.z,t===n.LengthDimensionMeasureType.Horizontal&&(u=!u)}else u=!function(e){const{startRenderSpace:n,endRenderSpace:t}=e.dimensionSegment,{startRenderSpace:i,endRenderSpace:r}=e.directSegment;return d.sqrDist(i,n)<d.sqrDist(r,t)}(l);const[p,S]=u?[o,a]:[a,o],f=m.clonePoint(S,h);return t===n.LengthDimensionMeasureType.Horizontal?f.z=p.z:(f.x=p.x,f.y=p.y),r.toRenderCoords(p,e.startRenderSpace),r.toRenderCoords(f,e.endRenderSpace),e}}},e.computeSpanningSegment=function(n,t,i,r){return t===e.OffsetSegmentLocation.Start?(d.copy(n.startRenderSpace,i.startRenderSpace),d.copy(n.endRenderSpace,r.startRenderSpace)):(d.copy(n.startRenderSpace,i.endRenderSpace),d.copy(n.endRenderSpace,r.endRenderSpace)),n},e.dimensionStartToEnd=b,e.directStartToEnd=function(e,n){const{startRenderSpace:t,endRenderSpace:i}=n.directSegment;return d.sub(e,i,t)},e.directUp=function(e,n,t){const i=n.directSegment.eval(.5,g.sv3d.get());return t.worldUpAtPosition(i,e)},e.headingFromGeometry=function(e,n){const t=e.directSegment.eval(.5,g.sv3d.get());return n.headingAtPosition(t,e.primaryOffsetAxis)},e.isGeodesicDimension=function(e){const{elevationAlignedStartPoint:n,elevationAlignedEndPoint:t}=e;if(null==n||null==t)return!1;const r=f.euclideanDirectDistanceBetweenPoints(n,t);return null!=r&&i.toUnit(r,"meters").value>v.geodesicDistanceThreshold},e.isValidComputation=function(e){return null!=e.geometry},e.maxScreenLengthSquaredFromGeometry=function(e,n){return d.squaredLength(b(x,e))/n**2},e.offsetSegment=function(e,n,t,i){d.scaleAndAdd(e.startRenderSpace,n.startRenderSpace,t,i),d.scaleAndAdd(e.endRenderSpace,n.endRenderSpace,t,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));