// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../intl","../../../../core/Accessor","../../../../core/colorUtils","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/quantityFormatUtils","../../../../core/quantityUtils","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../interfaces","./interfaces","../../interactive/support/viewUtils","../../interactive/visualElements/LabelVisualElement","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/MeasurementArrowVisualElement","../../interactive/visualElements/RightAngleQuadVisualElement","../../interactive/visualElements/support/Segment","../../webgl-engine/lib/Material","../../webgl-engine/materials/lineStippleUtils","../../../support/geodesicMeasurementUtils","../../../../intl/locale","../../../../intl/messages"],(function(e,t,i,n,a,s,r,l,o,c,d,u,h,m,g,p,_,v,b,L,y,V,w,M,S,E,A,z,P,D,O,f,C){"use strict";e.DirectLineMeasurementVisualization=class extends n{get _parameters(){const e=this.view.effectiveTheme,{accentColor:t,textColor:i}=e,n=a.unitRGBAFromColor(t),s=a.multiplyOpacityToUnitRGBA(t,.75),r=a.unitRGBAFromColor(a.getContrast(t)),l=a.getContrast(i,a.BrightnessThreshold.Low);return{accentColor:n,contrastColor:r,translucentAccentColor:s,triangleLineWidth:3,geodesicProjectionLineWidth:2,guideLineWidth:2,guideStippleLengthPixels:3,directLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12,textColor:i,textBackgroundColor:a.multiplyOpacity(l,.6),textCalloutColor:a.multiplyOpacity(l,.5)}}get visible(){return this.analysisView.visible}get viewMode(){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.analysisView;if(null==e||null==t||e.equals(t))return V.ViewMode.None;const i=this.analysisView.result;if(null==i)return V.ViewMode.Direct;if("geodesic"===this.actualVisualizedMeasurement)return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?V.ViewMode.ProjectedGeodesic:V.ViewMode.Direct;const{verticalDistance:n,horizontalDistance:a}=i,s=c.toUnit(n,"meters").value,r=c.toUnit(a,"meters").value;return Math.min(s/r,r/s)<this.triangleCollapseRatioThreshold?V.ViewMode.Direct:V.ViewMode.Triangle}get actualVisualizedMeasurement(){const{measurementMode:e,result:t}=this.analysisView;switch(e){case y.MeasurementMode.Auto:return null!=t&&c.toUnit(t.horizontalDistance,"meters").value>O.geodesicDistanceThreshold?"geodesic":"euclidean";case y.MeasurementMode.Euclidean:return"euclidean";case y.MeasurementMode.Geodesic:return"geodesic"}}get allowVisualElementsOrientationChange(){return null==this._triangleOrientationOverride}set allowVisualElementsOrientationChange(e){null==this._triangleOrientationOverride!==e&&(null==this._triangleOrientationOverride?this._triangleOrientationOverride=this._actualVisualElementsOrientation:this._triangleOrientationOverride=null)}get labels(){return"geodesic"===this.actualVisualizedMeasurement?{direct:null,horizontal:this._segmentLabel,vertical:this._verticalLabel}:{direct:this._segmentLabel,horizontal:this._horizontalLabel,vertical:this._verticalLabel}}constructor(e){super(e),this._segmentVisualElement=null,this._triangleVisualElement=null,this._rightAngleQuad=null,this._projectedGeodesicLine=null,this._geodesicStartHint=null,this._geodesicEndHint=null,this._segmentLabel=null,this._verticalLabel=null,this._horizontalLabel=null,this._startPosition=L.create(),this._endPosition=L.create(),this._cornerPosition=L.create(),this._startPositionAtSeaLevel=L.create(),this._endPositionAtSeaLevel=L.create(),this._triangleOrientationOverride=null,this.messages=null,this.loadingMessages=!0,this.visualElementOrientation=V.VisualElementOrientation.Auto,this.triangleCollapseRatioThreshold=.03}initialize(){const e={attached:!0,view:this.view,isDecoration:!0},{guideLineWidth:t,guideStippleLengthPixels:i,triangleLineWidth:n,geodesicProjectionLineWidth:a,directLabelFontSize:s,verticalLabelFontSize:r,horizontalLabelFontSize:l}=this._parameters;this._segmentVisualElement=new E.MeasurementArrowVisualElement({...e,geometry:null,renderOccluded:P.RenderOccludedFlag.OccludeAndTransparent}),this._triangleVisualElement=new S.LineVisualElement({...e,width:n,renderOccluded:P.RenderOccludedFlag.OccludeAndTransparent}),this._rightAngleQuad=new A.RightAngleQuadVisualElement({...e,renderOccluded:P.RenderOccludedFlag.OccludeAndTransparent});const o={...e,polygonOffset:!0,renderOccluded:P.RenderOccludedFlag.OccludeAndTransparent};this._projectedGeodesicLine=new S.LineVisualElement({...o,width:a,stipplePattern:D.createStipplePatternSimple(i)}),this._geodesicStartHint=new S.LineVisualElement({...o,width:t,stipplePattern:D.createStipplePatternSimple(i)}),this._geodesicEndHint=new S.LineVisualElement({...o,width:t,stipplePattern:D.createStipplePatternSimple(i)}),this._segmentLabel=new M.LabelVisualElement({...e,fontSize:s}),this._verticalLabel=new M.LabelVisualElement({...e,fontSize:r}),this._horizontalLabel=new M.LabelVisualElement({...e,fontSize:l}),this.addHandles([d.watch((()=>{const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.analysisView,i=this.view;return{view:i,camera:i.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}}),(e=>this._updateGeometryAndViewMode(e)),d.syncAndInitial),d.watch((()=>({visible:this.visible,viewMode:this.viewMode})),(e=>this._updateVisualElementVisibility(e)),d.syncAndInitial),d.watch((()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement})),(e=>this._updateLabelText(e)),d.syncAndInitial),d.watch((()=>({visible:this.visible,viewMode:this.viewMode})),(e=>this._updateLabelVisibility(e)),d.syncAndInitial),d.watch((()=>this._measurementArrowStripeLength),(e=>this._updateSegmentStripeLength(e)),d.syncAndInitial),f.onLocaleChange((async()=>this._updateMessageBundle())),d.watch((()=>this._parameters),(({textBackgroundColor:e,textCalloutColor:t,textColor:i,translucentAccentColor:n,accentColor:a,contrastColor:s})=>{const{_segmentLabel:r,_verticalLabel:l,_horizontalLabel:o,_triangleVisualElement:c,_rightAngleQuad:d,_projectedGeodesicLine:u,_geodesicStartHint:h,_geodesicEndHint:m,_segmentVisualElement:g}=this;r.backgroundColor=e,r.calloutColor=t,r.textColor=i,l.backgroundColor=e,l.calloutColor=t,l.textColor=i,o.backgroundColor=e,o.calloutColor=t,o.textColor=i,c.color=n,d.color=n,u.color=n,h.color=n,m.color=n,g.color=a,g.contrastColor=s}),d.initial)]),this._updateMessageBundle()}destroy(){this._segmentVisualElement=l.destroyMaybe(this._segmentVisualElement),this._triangleVisualElement=l.destroyMaybe(this._triangleVisualElement),this._rightAngleQuad=l.destroyMaybe(this._rightAngleQuad),this._projectedGeodesicLine=l.destroyMaybe(this._projectedGeodesicLine),this._geodesicStartHint=l.destroyMaybe(this._geodesicStartHint),this._geodesicEndHint=l.destroyMaybe(this._geodesicEndHint),this._segmentLabel=l.destroyMaybe(this._segmentLabel),this._verticalLabel=l.destroyMaybe(this._verticalLabel),this._horizontalLabel=l.destroyMaybe(this._horizontalLabel),this.set("view",null)}_updateVisualElementVisibility({visible:e,viewMode:t}){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,e)switch(t){case V.ViewMode.None:break;case V.ViewMode.Direct:this._segmentVisualElement.visible=!0;break;case V.ViewMode.Triangle:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case V.ViewMode.ProjectedGeodesic:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}}_updateGeometryAndViewMode({view:e,camera:t,viewMode:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:a,orientation:s,visualizedMeasurement:r,stripeLength:l}){const o=e.renderCoordsHelper;if(null==o||null==n||null==a||n.equals(a))return;let c=this._startPosition,d=this._endPosition;o.toRenderCoords(n,c),o.toRenderCoords(a,d);const u=s===V.VisualElementOrientation.AboveSegment?1:-1,h=u*(o.getAltitude(d)-o.getAltitude(c));h<0&&(c=this._endPosition,d=this._startPosition);const m="geodesic"===r?new z.GeodesicSegment(this._startPosition,this._endPosition,o.spatialReference):new z.EuclideanSegment(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=m,this._updateSegmentStripeLength(l),i){case V.ViewMode.Direct:this._updateSegment(m,s);break;case V.ViewMode.Triangle:this._updateSegmentAndTriangle({view:e,camera:t,segment:m,orientation:s,startPosition:c,endPosition:d,deltaSign:u,altitudeDelta:h});break;case V.ViewMode.ProjectedGeodesic:this._updateSegmentAndProjection({view:e,orientation:s,startPosition:c,endPosition:d})}}_updateSegment(e,t){this._segmentLabel.anchor=t===V.VisualElementOrientation.AboveSegment?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"}}_updateSegmentAndTriangle({view:{renderCoordsHelper:e},camera:t,segment:i,orientation:n,startPosition:a,endPosition:s,deltaSign:r,altitudeDelta:l}){const o=this._cornerPosition;e.worldUpAtPosition(a,o),b.scale(o,o,r*Math.abs(l)),b.add(o,o,a),this._triangleVisualElement.geometry=[[[a[0],a[1],a[2]],[o[0],o[1],o[2]],[s[0],s[1],s[2]]]],this._rightAngleQuad.geometry={previous:a,center:o,next:s};const c=new z.EuclideanSegment(a,o),d=new z.EuclideanSegment(o,s),u=function(e,t,i,n,a){const s=G,r=T;a.projectToRenderScreen(i,s),a.projectToRenderScreen(t,r);const l={segment:"bottom",horizontal:"top",vertical:s[0]<r[0]?"left":"right"};{const n=R,s=H;if(w.renderScreenSpaceTangent(e,i,a,n),w.renderScreenSpaceTangent(e,t,a,s),v.dot(n,s)>=x){const e=Math.sign(n[1])===Math.sign(s[1]);l.segment=e?M.mirrorPosition(l.vertical):l.vertical}else{const e=U;w.renderScreenSpaceTangent(i,t,a,e),v.dot(e,s)>=x&&(l.segment=Math.sign(e[0])===Math.sign(s[0])?M.mirrorPosition(l.horizontal):l.horizontal)}}if(n===V.VisualElementOrientation.BelowSegment){const e=e=>"top"===e?"bottom":"top";l.segment=e(l.segment),l.horizontal=e(l.horizontal),l.vertical=e(l.vertical)}return l}(a,s,o,n,t);this._segmentLabel.anchor=u.segment,this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:c,sampleLocation:"center"},this._verticalLabel.anchor=u.vertical,this._horizontalLabel.geometry={type:"segment",segment:d,sampleLocation:"center"},this._horizontalLabel.anchor=u.horizontal}_updateSegmentAndProjection({view:{renderCoordsHelper:e},orientation:t,startPosition:i,endPosition:n}){e.setAltitude(this._startPositionAtSeaLevel,0,i),e.setAltitude(this._endPositionAtSeaLevel,0,n);const a=new z.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,e.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(a),this._geodesicStartHint.setGeometryFromSegment(new z.EuclideanSegment(this._startPositionAtSeaLevel,i)),this._geodesicEndHint.setGeometryFromSegment(new z.EuclideanSegment(this._endPositionAtSeaLevel,n)),this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"},this._segmentLabel.anchor=t===V.VisualElementOrientation.AboveSegment?"top":"bottom"}_updateLabelText({text:e,visualizedMeasurement:t}){null!=e?(this._segmentLabel.text="euclidean"===t?e.directDistance:e.horizontalDistance,this._horizontalLabel.text=e.horizontalDistance,this._verticalLabel.text=e.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=null),this.notifyChange("labels")}_updateLabelVisibility({visible:e,viewMode:t}){const i=this._segmentLabel,n=this._horizontalLabel,a=this._verticalLabel;if(i.visible=!1,n.visible=!1,a.visible=!1,e)switch(t){case V.ViewMode.Direct:i.visible=!0;break;case V.ViewMode.Triangle:i.visible=!0,n.visible=!0,a.visible=!0;break;case V.ViewMode.ProjectedGeodesic:i.visible=!0;case V.ViewMode.None:}}get _labelsText(){if(this.destroyed)return null;const e=this.messages,t=this.analysisView.result;if(null==t||null==e)return null;const{directDistance:i,horizontalDistance:n,verticalDistance:a}=t,s=this.analysisView.unit,r=e=>({directDistance:"",horizontalDistance:"",verticalDistance:"",...e});switch(s){case"metric":return r({directDistance:i&&o.formatMetricLength(e,i),horizontalDistance:n&&o.formatMetricLength(e,n),verticalDistance:a&&o.formatMetricVerticalLength(e,a)});case"imperial":return r({directDistance:i&&o.formatImperialLength(e,i),horizontalDistance:n&&o.formatImperialLength(e,n),verticalDistance:a&&o.formatImperialVerticalLength(e,a)});default:return r({directDistance:i&&o.formatDecimal(e,i,s),horizontalDistance:n&&o.formatDecimal(e,n,s),verticalDistance:a&&o.formatDecimal(e,a,s)})}}_updateSegmentStripeLength(e){const t=this._segmentVisualElement;null!=e?(t.stripeLength=e,t.stripesEnabled=!0):t.stripesEnabled=!1}get _actualVisualElementsOrientation(){if(null!=this._triangleOrientationOverride)return this._triangleOrientationOverride;const e=this.visualElementOrientation;return e===V.VisualElementOrientation.Auto?this.view.state.camera.aboveGround?V.VisualElementOrientation.AboveSegment:V.VisualElementOrientation.BelowSegment:e}_requiresGeodesicGuideAt(e){const t=this.view;if(!t?.state)return!1;const i=t.state.camera,n=t.renderCoordsHelper;if(!n)return!1;const a=i.computeScreenPixelSizeAt(e);return n.getAltitude(e)/a>=10}get _measurementArrowStripeLength(){const{result:e,unit:t}=this.analysisView;if(null==e)return null;let i=null;const n=e.directDistance;switch(t){case"metric":i=n&&c.toUnit(n,"meters");break;case"imperial":i=n&&c.toUnit(n,h.adaptiveImperialLengthUnit(n.value,n.unit));break;default:i=n&&c.toUnit(n,t)}return null==i?null:r.nextHighestPowerOfTen(i.value/30)*h.convertUnit(1,i.unit,"meters")}_updateMessageBundle(){this.loadingMessages=!0,C.fetchMessageBundle("esri/core/t9n/Units").then((e=>{this.messages=e})).finally((()=>{this.loadingMessages=!1}))}get testData(){}},t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_parameters",null),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_triangleOrientationOverride",void 0),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"messages",void 0),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"view",void 0),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"analysis",void 0),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"analysisView",void 0),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"loadingMessages",void 0),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"visible",null),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"viewMode",null),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"actualVisualizedMeasurement",null),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"visualElementOrientation",void 0),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"triangleCollapseRatioThreshold",void 0),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"allowVisualElementsOrientationChange",null),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"labels",null),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_labelsText",null),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_actualVisualElementsOrientation",null),t.__decorate([m.property()],e.DirectLineMeasurementVisualization.prototype,"_measurementArrowStripeLength",null),e.DirectLineMeasurementVisualization=t.__decorate([_.subclass("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],e.DirectLineMeasurementVisualization);const x=Math.cos(r.deg2rad(12)),G=u.createRenderScreenPointArray3(),T=u.createRenderScreenPointArray3(),R=u.createRenderScreenPointArray(),H=u.createRenderScreenPointArray(),U=u.createRenderScreenPointArray();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));