// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../analysis/SlicePlane","../../../../core/has","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Extent","../../../../geometry/Point","../../../../geometry/projectionUtils","../../../../geometry/support/Axis","../../../../chunks/boundedPlane","../../../../geometry/support/plane","../../../../geometry/support/ray","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","./settings","./sliceToolConfig","../support/projectionUtils","../../interactive/manipulatorUtils","../../interactive/visualElements/LineVisualElement","../../interactive/visualElements/SlicePlaneVisualElement","../../support/RenderCoordsHelper","../../support/geometryUtils/ray","../../webgl-engine/lib/Material","../../../interactive/interfaces"],(function(e,t,i,n,s,o,r,a,l,c,d,u,g,p,b,m,f,h,v,T,R,A,I,P,S,E,O,y){"use strict";function V(t,i,n,s,o,r){const l=a.dot(t,i),c=h.sv3d.get(),d=h.sv3d.get();switch(s===e.SliceOrientation.HORIZONTAL_OR_VERTICAL?Math.abs(l)>T.verticalDotThreshold?e.SliceOrientation.HORIZONTAL:e.SliceOrientation.VERTICAL:s){case e.SliceOrientation.VERTICAL:{const e=Math.abs(l)<=T.smallAngleDotThreshold?t:n.viewUp;a.cross(c,e,i),a.copy(d,i);break}case e.SliceOrientation.HORIZONTAL:a.cross(c,n.viewUp,i),a.cross(d,i,c);break;case e.SliceOrientation.TILTED:{const e=Math.abs(l)<=T.smallAngleDotThreshold?i:n.viewUp;a.cross(c,e,t),a.cross(d,t,c);break}}const u=a.cross(h.sv3d.get(),c,d);a.dot(u,n.viewForward)>0&&a.scale(d,d,-1),a.normalize(o,c),a.normalize(r,d)}function w(e,t,i){const n=t.worldUpAtPosition(e.origin,h.sv3d.get()),s=e.basis1,o=N(e,n),r=Math.round(o/X)*X;return p.rotate(e,r-o,s,i)}var L;function C(e,t){switch(t){case L.POSITIVE_X:return{basis:e.basis1,direction:1,position:a.add(h.sv3d.get(),e.origin,e.basis1),edge:t};case L.POSITIVE_Y:return{basis:e.basis2,direction:1,position:a.add(h.sv3d.get(),e.origin,e.basis2),edge:t};case L.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:a.subtract(h.sv3d.get(),e.origin,e.basis1),edge:t};case L.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:a.subtract(h.sv3d.get(),e.origin,e.basis2),edge:t}}}function H(e,t,i){const n=i.projectToRenderScreen(a.add(h.sv3d.get(),e,t),o.castRenderScreenPointArray3(h.sv3d.get())),s=i.projectToRenderScreen(a.subtract(h.sv3d.get(),e,t),o.castRenderScreenPointArray3(h.sv3d.get()));return a.squaredLength(a.subtract(n,n,s))}function M(e){const t=a.length(e.basis1),i=a.length(e.basis2);return T.resizeHandleEdgePaddingFrac*Math.min(t,i)}function x(e){return M(e)}function _(e){return 0!==e.direction[0]&&0!==e.direction[1]}function N(e,t){return f.angleAroundAxis(t,e.basis2,e.basis1)+X}function z(e,t){if(null==e?.position)return null;const i=R.applyProjectionAndElevationAlignment(e.position,t.spatialReference,t.elevationProvider);if(null==i)return null;const n=S.RenderCoordsHelper.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),s=e.width*n,o=e.height*n;return{position:i,heading:e.heading,tilt:e.tilt,renderWidth:s,renderHeight:o}}function U(e,t,i,o=p.create()){if(null==e)return null;const r=function(e,t,i,o,r,l,c=p.create()){return l.toRenderCoords(e,c.origin)?(l.worldBasisAtPosition(c.origin,g.Axis.X,c.basis1),l.worldBasisAtPosition(c.origin,g.Axis.Y,c.basis2),b.fromVectorsAndPoint(c.basis2,c.basis1,c.origin,c.plane),p.rotate(c,-s.deg2rad(t),p.normal(c),c),p.rotate(c,s.deg2rad(i),c.basis1,c),a.scale(c.basis1,c.basis1,o/2),a.scale(c.basis2,c.basis2,r/2),p.updateUnboundedPlane(c),c):(n.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,o);return i.tiltEnabled||null==r||w(r,t.renderCoordsHelper,r),r}!function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"}(L||(L={}));const D=y.ManipulatorStateCustomFlags.Custom1;var F,j;e.RotationAxis=void 0,(F=e.RotationAxis||(e.RotationAxis={}))[F.HEADING=1]="HEADING",F[F.TILT=2]="TILT",e.SliceOrientation=void 0,(j=e.SliceOrientation||(e.SliceOrientation={}))[j.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",j[j.HORIZONTAL=1]="HORIZONTAL",j[j.VERTICAL=2]="VERTICAL",j[j.TILTED=3]="TILTED";const G=y.ManipulatorStateCustomFlags.Custom2,Z=m.create(),X=Math.PI/2,k=y.ManipulatorStateCustomFlags.Custom1,B=y.ManipulatorStateCustomFlags.Custom2;e.DidPointerMoveRecentlyFlag=D,e.IsShiftEdgeOnScreenFlag=G,e.calculateBoundedPlaneTranslateRotate=function(e,t){return A.calculateTranslateRotateFromBases(e.basis1,e.basis2,e.origin,t)},e.calculateDiagonalResizeHandleScale=x,e.calculatePlaneHalfSize=function(e,t){return T.initialPlaneHalfSizeViewProportion*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)},e.createGridVisualElement=function(e){return new P.SlicePlaneVisualElement({view:e,attached:!1,backgroundColor:v.planeColor,gridColor:v.getGridColor(e.effectiveTheme),gridWidth:4,renderOccluded:O.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0})},e.createOutlineVisualElement=function(e){return new I.LineVisualElement({view:e,attached:!1,color:v.getOutlineColor(e.effectiveTheme),width:T.planeOutlineWidth,renderOccluded:O.RenderOccludedFlag.OccludeAndTransparent,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]],isDecoration:!0})},e.createPlane=function(e,t,i,n,s,o,r,l){return V(t,r.worldUpAtPosition(e,h.sv3d.get()),s,o,l.basis1,l.basis2),a.scale(l.basis1,l.basis1,i),a.scale(l.basis2,l.basis2,n),a.copy(l.origin,e),b.fromVectorsAndPoint(l.basis2,l.basis1,l.origin,l.plane),l},e.createRotatePlane=function(t,i,n,s){const o=i.worldUpAtPosition(t.origin,h.sv3d.get()),r=h.sv3d.get();switch(n){case e.RotationAxis.HEADING:a.copy(r,o);break;case e.RotationAxis.TILT:a.copy(r,t.basis1)}return b.fromPositionAndNormal(t.origin,r,s)},e.createShiftPlane=function(e,t,i,n){const s=a.cross(h.sv3d.get(),t,i);return a.cross(s,s,t),b.fromPositionAndNormal(e,s,n)},e.forceHorizontalOrVertical=w,e.isDiagonalResizeHandle=_,e.isIBuildingSceneLayerView3D=function(e){return null!=("building-scene-3d"===e.type?e:null)},e.normalToBases=V,e.planeToExtent=function(e,t,i){if(null==e)return null;const n=e.origin,s=h.sv3d.get(),o=h.sv3d.get(),r=h.sv3d.get(),l=h.sv3d.get();let d,u,g,p,b,m;a.add(s,n,e.basis1),a.add(s,s,e.basis2),a.add(o,n,e.basis1),a.sub(o,o,e.basis2),a.sub(r,n,e.basis1),a.sub(r,r,e.basis2),a.sub(l,n,e.basis1),a.add(l,l,e.basis2);for(const e of[s,o,r,l]){const n=t.fromRenderCoords(e,e,i);if(null==n)return null;d=null==d?n[0]:Math.min(d,n[0]),u=null==u?n[0]:Math.max(u,n[0]),g=null==g?n[1]:Math.min(g,n[1]),p=null==p?n[1]:Math.max(p,n[1]),b=null==b?n[2]:Math.min(b,n[2]),m=null==m?n[2]:Math.max(m,n[2])}return new c({xmin:d,xmax:u,ymin:g,ymax:p,zmin:b,zmax:m,spatialReference:i})},e.planeToShape=function(e,i,n,o=new t){if(null==e)return null;const{renderCoordsHelper:r}=i,l=r.fromRenderCoords(e.origin,new d({spatialReference:i.spatialReference}));if(null==l)return null;const c=u.tryProjectWithZConversion(l,n);if(null==c)return null;o.position=c;const g=2*a.length(e.basis1),p=2*a.length(e.basis2),b=S.RenderCoordsHelper.renderUnitScaleFactor(i.spatialReference,n);o.width=g*b,o.height=p*b;const m=r.worldUpAtPosition(e.origin,h.sv3d.get());return o.tilt=s.rad2deg(N(e,m)),o.heading=r.headingAtPosition(e.origin,e.basis1)-90,o},e.projectAndElevationAlignShape=z,e.projectedShapeToPlane=U,e.resizeNormal=k,e.resizeOutlineOnly=B,e.resizePlane=function(e,t,i,n,s,o){const r=a.copy(h.sv3d.get(),s.origin);a.add(r,r,a.scale(h.sv3d.get(),s.basis1,e.direction[0]<0?1:-1)),a.add(r,r,a.scale(h.sv3d.get(),s.basis2,e.direction[1]<0?1:-1));const l=a.length(s.basis1),c=a.length(s.basis2),d=a.subtract(h.sv3d.get(),i,r),u=a.subtract(h.sv3d.get(),t,r);let g=0,b=0;if(_(e)){const t=x(s),i=x(o);g=l-.5*e.direction[0]*a.dot(s.basis1,u)/l,b=c-.5*e.direction[1]*a.dot(s.basis2,u)/c;const n=i/t;g*=n,b*=n}const m=g+.5*e.direction[0]*a.dot(s.basis1,d)/l,f=b+.5*e.direction[1]*a.dot(s.basis2,d)/c,v=a.scale(h.sv3d.get(),s.basis1,m/l),R=a.scale(h.sv3d.get(),s.basis2,f/c);(m<=0||H(o.origin,v,n)<=T.planeMinBasisScreenLen2)&&a.copy(v,o.basis1),(f<=0||H(o.origin,R,n)<=T.planeMinBasisScreenLen2)&&a.copy(R,o.basis2);const A=a.copy(h.sv3d.get(),r);return a.add(A,A,a.scale(h.sv3d.get(),v,e.direction[0]<0?-1:1)),a.add(A,A,a.scale(h.sv3d.get(),R,e.direction[1]<0?-1:1)),p.fromValues(A,v,R,o)},e.shapeToPlane=function(e,t,i,n=p.create()){const s=z(e,t);return null==s?null:U(s,t,i,n)},e.updateResizeHandle=function(e,t,i,n){const s=a.length(n.basis1),o=a.length(n.basis2),l=M(n),c=x(n),d=a.set(h.sv3d.get(),0,0,0);a.add(d,a.scale(h.sv3d.get(),n.basis1,t.direction[0]),a.scale(h.sv3d.get(),n.basis2,t.direction[1])),a.add(d,n.origin,d);let u=0,g=1;if(_(t))1===t.direction[0]&&-1===t.direction[1]?u=X:1===t.direction[0]&&1===t.direction[1]?u=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(u=3*Math.PI/2),g=c;else{const e=0!==t.direction[0]?1:2;u=1===e?X:0,g=(1===e?o:s)-l}const p=r.fromZRotation(h.sm4d.get(),u);r.scale(p,p,a.set(h.sv3d.get(),g,g,g)),r.multiply(p,i,p),p[12]=0,p[13]=0,p[14]=0,e.modelTransform=p,e.renderLocation=d},e.updateRotateHeadingHandle=function(e,t,i,n){const s=n.worldUpAtPosition(i.origin,h.sv3d.get()),o=C(i,L.POSITIVE_X),a=r.fromZRotation(h.sm4d.get(),o.edge*Math.PI/2);r.rotateX(a,a,-N(i,s)),r.multiply(a,t,a),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=o.position},e.updateRotateTiltHandle=function(e,t,i){const n=C(i,L.POSITIVE_Y),s=r.fromZRotation(h.sm4d.get(),n.edge*Math.PI/2);r.rotateX(s,s,X),r.multiply(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=n.position},e.updateShiftRestartHandle=function(e,t,i,n){const s=C(i,L.NEGATIVE_X),c=h.sm4d.get();r.rotateZ(c,t,s.edge*Math.PI/2);const d=a.normalize(h.sv3d.get(),s.basis);let u=a.scale(h.sv3d.get(),d,s.direction*n.computeScreenPixelSizeAt(s.position)*T.shiftRestartOffsetDistance);a.add(u,u,s.position);const g=n.projectToRenderScreen(u,o.castRenderScreenPointArray3(h.sv3d.get())),b=function(e,t){const[i,n,s,o]=e.viewport,r=Math.min(s,o)/16;let a=!0;return t[0]<i+r?(t[0]=i+r,a=!1):t[0]>i+s-r&&(t[0]=i+s-r,a=!1),t[1]<n+r?(t[1]=n+r,a=!1):t[1]>n+o-r&&(t[1]=n+o-r,a=!1),a}(n,g);E.fromRender(n,g,Z),a.normalize(Z.direction,Z.direction);const m=h.sv3d.get();!b&&p.intersectRay(i,Z,m)&&(u=m),c[12]=0,c[13]=0,c[14]=0,e.modelTransform=c,e.renderLocation=l.clone(u),b?e.state|=G:e.state&=~G},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));