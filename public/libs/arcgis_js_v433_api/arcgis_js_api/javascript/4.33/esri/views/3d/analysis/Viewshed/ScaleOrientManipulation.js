// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Handles","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/boundedPlane","../../../../geometry/support/ray","../Slice/sliceToolConfig","./ArrowManipulator","./ViewshedConfiguration","./viewshedToolUtils","../../interactive/editingTools/dragEventPipeline3D","../../interactive/editingTools/ManipulatorType","../../interactive/editingTools/manipulations/config","../../interactive/editingTools/manipulations/InteractiveManipulation","../../../interactive/dragEventPipeline"],(function(e,t,a,i,n,r,o,l,s,c,u,p,d,m,h,g,T,v){"use strict";class _ extends T.InteractiveManipulation{constructor(e){super(),this._handles=new t,this._tool=e.tool,this._view=e.view;const a=p.viewshedToolManipulatorConfiguration.scaleOrientHandleRadius;this._manipulatorHeading=new u.ArrowManipulator(this._view,a),this._manipulatorTilt=new u.ArrowManipulator(this._view,a),this._manipulatorDistance=new u.ArrowManipulator(this._view,a),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return v.createManipulatorDragEventPipeline(this._manipulatorHeading,((i,n,o,s,c)=>{const u=this._view,{tiltParallelToSurface:p,farDistanceRenderSpace:m,upVector:g,observerRenderSpace:T,targetRenderSpace:v,rightVector:_}=t,f=Math.sin(a.deg2rad(p))*m,M=r.add(w,T,r.scale(R,g,f)),D=r.sub(R,v,M),S=r.scale(y,_,r.len(D)),A=l.fromValues(M,D,S),E=d.screenToCircleAngle(n,u,A,t).next((e=>({...e,manipulatorType:h.ManipulatorType.ROTATE})));e(i,E,o)}))}createTiltDragPipeline(e,t){return v.createManipulatorDragEventPipeline(this._manipulatorTilt,((a,i,n,o,s)=>{const{observerRenderSpace:c,farDistanceRenderSpace:u,upVector:p,targetDirection:m}=t,g=r.dot(m,p),T=r.scaleAndAdd(w,m,p,-g);r.scale(T,r.normalize(T,T),u);const v=r.scale(R,p,u),_=l.fromValues(c,T,v),f=d.screenToCircleAngle(i,this._view,_,t).next((e=>({...e,manipulatorType:h.ManipulatorType.ROTATE})));e(a,f,n)}))}createDistanceDragPipeline(e,t){return v.createManipulatorDragEventPipeline(this._manipulatorDistance,((a,i,n,r,o)=>{const l=s.fromValues(t.observerRenderSpace,t.targetDirection),c=i.next(v.dragAtLocation(this._view,a.location)).next(m.screenToRenderRay(this._view,l)).next((e=>({...e,manipulatorType:h.ManipulatorType.SCALE})));e(a,c,n)}))}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const a=n.create(),o=e=>{i.multiply(a,e,a)},l=p.viewshedToolManipulatorConfiguration.scaleOrientSize*(g.discRadiusSmall/g.discRadius);o(i.fromScaling(f,r.set(w,l,l,l))),o(d.getViewshedRotationMatrix(e,f));const s=p.viewshedToolManipulatorConfiguration.scaleOrientHandleRadius*c.displayFocusMultiplier*l,u=r.scale(w,e.targetDirection,s);o(i.fromTranslation(f,u));const m=i.fromZRotation(f,-D);i.mul(m,m,i.fromYRotation(M,-D)),this._manipulatorHeading.modelTransform=i.mul(n.create(),a,m);const h=i.fromYRotation(f,D);i.mul(h,h,i.fromZRotation(M,Math.PI)),this._manipulatorTilt.modelTransform=i.multiply(n.create(),a,h),this._manipulatorDistance.modelTransform=a}forEachManipulator(e){e(this._manipulatorHeading,h.ManipulatorType.ROTATE),e(this._manipulatorTilt,h.ManipulatorType.ROTATE),e(this._manipulatorDistance,h.ManipulatorType.SCALE)}}const f=n.create(),M=n.create(),w=o.create(),R=o.create(),y=o.create(),D=Math.PI/2;e.ScaleOrientManipulation=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));