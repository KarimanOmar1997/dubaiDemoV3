// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/compilerUtils","../../../core/mathUtils","../../../core/signal","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/axisAngleDegrees","../../../geometry/support/Ellipsoid","./Clouds","./weather"],(function(a,t,e,s,i,r,h,d,o,n,c,l){"use strict";var F;a.FadeState=void 0,(F=a.FadeState||(a.FadeState={}))[F.HIDE=0]="HIDE",F[F.FADE_IN=1]="FADE_IN",F[F.SHOW=2]="SHOW",F[F.CROSS_FADE=3]="CROSS_FADE",F[F.FADE_OUT=4]="FADE_OUT";class S{constructor(){this.anchorPoint=d.create(),this.radiusCurvatureCorrection=0,this.transform=r.create()}}const _=d.fromValues(0,0,1),u=o.create(),p=d.create();a.CloudsParameters=class{constructor(){this.startTime=0,this._data=s.signal(null),this.coverage=0,this.absorption=0,this._readChannels=c.CloudsTextureChannels.RG,this.parallax=new S,this.parallaxNew=new S,this._anchorPoint=d.create(),this._fadeState=s.signal(a.FadeState.HIDE),this._fadeFactor=s.signal(1)}get data(){return this._data.value}set data(a){this._data.value=a}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case a.FadeState.HIDE:return 0;case a.FadeState.FADE_OUT:return 1-this.fadeFactor;case a.FadeState.FADE_IN:return this.fadeFactor;case a.FadeState.SHOW:case a.FadeState.CROSS_FADE:return 1}}fade(a,t,s){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=s?e.clamp((t-this.startTime)/(1.25*s),0,1):1,1===this.fadeFactor&&this._endFade()),this._evaluateState(a,t),this._updateParallax(a)}_evaluateState(t,e){const s=t.relativeElevation,i=this._updateAnchorPoint(t);(s>1.7*l.heightLimit||s<-1e4||i>2e5)&&this.opacity>0?this._startFade(a.FadeState.HIDE,e):this.isFading||(s>l.heightLimit||s<-.35*l.heightLimit||i>1e5?this.opacity>0&&this._startFade(a.FadeState.FADE_OUT,e):c.ensureClouds(this.data)&&(0===this.opacity?this._startFade(a.FadeState.FADE_IN,e):this.data.state===c.CubeMapState.Ready&&(this.fadeState===a.FadeState.SHOW?this._startFade(a.FadeState.CROSS_FADE,e):this._startFade(a.FadeState.SHOW,e))))}_updateParallax(a){const t=h.squaredLength(a.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-n.earth.radius*n.earth.radius,0))/Math.sqrt(t),o.fromPoints(_,this.parallax.anchorPoint,u),i.rotate(this.parallax.transform,r.IDENTITY,u[3],o.axis(u)),o.fromPoints(_,this.parallaxNew.anchorPoint,u),i.rotate(this.parallaxNew.transform,r.IDENTITY,u[3],o.axis(u))}_updateAnchorPoint(t){return h.normalize(this._anchorPoint,t.eye),h.scale(this._anchorPoint,this._anchorPoint,n.earth.radius),this.fadeState===a.FadeState.HIDE&&this.data?.state===c.CubeMapState.Ready?(h.copy(this.parallax.anchorPoint,this._anchorPoint),0):h.length(h.subtract(p,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(t,e){switch(this._fadeState.value=t,this.startTime=e,t){case a.FadeState.CROSS_FADE:this.requestFade(),this._switchReadChannels(),h.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case a.FadeState.FADE_IN:this.requestFade(),this._switchReadChannels(),h.copy(this.parallax.anchorPoint,this._anchorPoint),h.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case a.FadeState.FADE_OUT:this.requestFade();break;case a.FadeState.SHOW:this._switchReadChannels(),h.copy(this.parallax.anchorPoint,this._anchorPoint),h.copy(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case a.FadeState.HIDE:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==c.CubeMapState.Ready&&(this.data.state=c.CubeMapState.Idle),this.fadeState){case a.FadeState.CROSS_FADE:h.copy(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=a.FadeState.SHOW;break;case a.FadeState.FADE_IN:this._fadeState.value=a.FadeState.SHOW;break;case a.FadeState.FADE_OUT:this._fadeState.value=a.FadeState.HIDE;break;case a.FadeState.SHOW:case a.FadeState.HIDE:break;default:t.neverReached(this.fadeState)}}_switchReadChannels(){this.data?.state===c.CubeMapState.Ready&&(this._readChannels=1-this._readChannels,this.data.state=c.CubeMapState.Fading)}get isFading(){return this.fadeState===a.FadeState.FADE_OUT||this.fadeState===a.FadeState.FADE_IN||this.fadeState===a.FadeState.CROSS_FADE}},Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})}));