// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/ellipsoidUtils","../webgl","./PrecipitationTechnique","./PrecipitationTechniqueConfiguration","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/effects/TransparentEnvironment","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/VertexArrayObject","../webgl-engine/lib/VertexAttribute","../../webgl/BufferObject","../../webgl/enums","../../webgl/Util"],(function(e,t,i,s,r,n,a,o,c,d,p,l,u,h,y,f,m,_,b,g,P,w,A,T){"use strict";e.Precipitation=class extends _.TransparentEnvironment{constructor(e){super(e),this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new h.PrecipitationPassParameters,this._configuration=new y.PrecipitationTechniqueConfiguration;const{view:t,type:i}=e;this._configuration.type="rainy"===i?y.PrecipitationType.Rain:y.PrecipitationType.Snow,t.stage.renderView.techniques.precompile(h.PrecipitationTechnique,this._configuration),this._passParameters.time=0,this._passParameters.radius=l.getReferenceEllipsoid(t.spatialReference).radius,this.addHandles([r.watch((()=>t.environment.weather),(e=>{e.type===i&&this.addHandles(r.watch((()=>e.precipitation),(e=>this._adjustParticles(e)),r.syncAndInitial))}),r.syncAndInitial)]),this.addHandles(r.watch((()=>t.stage?.renderer.renderContext.bind.clouds.fadeFactor??1),(e=>{this._passParameters.opacity=e,1===e&&(this.removeHandles("opacity"),this.addHandles(r.watch((()=>t.stage?.renderer.renderContext.bind.clouds.opacity??1),(e=>this._passParameters.opacity=e),r.syncAndInitial),"opacity"))}),r.sync),"opacity")}initialize(){this.addHandles([r.watch((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),r.syncAndInitial)])}_adjustParticles(e){const t=e<.5?i.lerp(0,.35,2*e):i.lerp(.35,1,2*(e-.5));this._numParticles=I*t}destroy(){this._numParticles=0,this._vao=s.disposeMaybe(this._vao),this._instanceIdBuffer=s.disposeMaybe(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles(r.watch((()=>this.renderContext?.bind.clouds.fadeFactor??1),(t=>{this._passParameters.opacity=1-t,1===t&&(this.removeAllHandles(),e())})),"opacity")}updateAnimation(e){const t=("rainy"===this.type?this._rainSpeed:this._snowSpeed)*n.secondsFromMilliseconds(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext;this._instanceIdBuffer??=this._createInstanceIndices(t);const i=Math.round(this._numParticles*this._passParameters.opacity),s=e.find((({name:e})=>e===u.InternalRenderCategory.TRANSPARENT_ENVIRONMENT));if(i<1)return s;const r=this.techniques.get(h.PrecipitationTechnique,this._configuration);if(!r.compiled)return this.requestRender(b.RenderRequestType.UPDATE),s;const n=t.bindTechnique(r,this.bindParameters,this._passParameters);return this._vao??=function(e,t){const i=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new g.VertexArrayObject(e,t,new Map([["geometry",f.glLayout(v)]]),new Map([["geometry",w.BufferObject.createVertex(e,A.Usage.STATIC_DRAW,i)]]))}(t,r.locations),t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),T.bindVertexBufferLayout(t,r.locations,this._instanceIdBuffer,x,0),t.drawArraysInstanced(A.PrimitiveType.TRIANGLES,0,3,i),T.unbindVertexBufferLayout(t,r.locations,this._instanceIdBuffer,x),s}_createInstanceIndices(e){const t=[];for(let e=0;e<I;e++)t.push(e);return w.BufferObject.createVertex(e,A.Usage.STATIC_DRAW,new Float32Array(t))}},t.__decorate([a.property({constructOnly:!0})],e.Precipitation.prototype,"type",void 0),e.Precipitation=t.__decorate([p.subclass("esri.views.3d.environment.Precipitation")],e.Precipitation);const I=25e4,v=m.newLayout().vec3f(P.VertexAttribute.POSITION),x=f.glLayout(m.newLayout().f32(P.VertexAttribute.INSTANCEFEATUREATTRIBUTE),1);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));