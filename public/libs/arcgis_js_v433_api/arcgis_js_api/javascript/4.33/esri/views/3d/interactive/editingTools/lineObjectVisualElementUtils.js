// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/handleUtils","../../../../core/mathUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../Manipulator3D","./GrabbingState","./manipulatedObjectUtils","./ManipulatorState","./ManipulatorType","./settings","../visualElements/ExtendedLineVisualElement","../visualElements/LaserlineVisualElement","../visualElements/OutlineVisualElement","../../webgl-engine/lib/Material"],(function(e,t,a,n,l,i,o,s,r,c,d,u,h,p,m,v,g){"use strict";function b(e){return null!=e&&("polygon"===e.type||"polyline"===e.type)}const f=o.create();e.createVisualElements=function(e){const{object:o}=e,y=function(e){const{view:a,object:l}=e,i=c.manipulatedObjectGeometry(l),o=new v.OutlineVisualElement({view:a,geometry:b(i)?i:null,elevationInfo:l.elevationInfo,attached:!1,isDecoration:!0}),s=new h.Settings({getTheme:()=>a.effectiveTheme}),r=()=>{o.attached=l.visible},d=t.handlesGroup([n.watch((()=>s.visualElements.lineObjects.outline),(e=>e.apply(o)),n.initial),n.watch((()=>s.visualElements.lineObjects.shadowStyle),(e=>e.apply(o)),n.initial),n.watch((()=>l.visible),r),n.watch((()=>l.isDraped),(e=>{o.isDraped=e}),n.initial),l.on("committed",(()=>{const e=c.manipulatedObjectGeometry(l);o.geometry=b(e)?e:null})),t.destroyHandle(o)]);return r(),{visualElement:o,remove:()=>d.remove()}}(e),E=function(e,o){const{object:v,view:y}=e,E=[],w=v.elevationInfo,S="on-the-ground"===w.mode||!w.offset&&"absolute-height"!==w.mode,O=new d.ManipulatorState,M=new h.Settings({getTheme:()=>y.effectiveTheme}),T=M.visualElements,j=new p.ExtendedLineVisualElement({view:y,extensionType:T.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:g.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0}),G=a.deg2rad(T.heightPlaneAngleCutoff),D=new m.LaserlineVisualElement({view:y,attached:!1,angleCutoff:G,isDecoration:!0}),L=l.signal(1);E.push(n.watch((()=>({lineShadowStyle:M.visualElements.lineObjects.shadowStyle,pointShadowStyle:M.visualElements.pointObjects.shadowStyle,alpha:L.value})),(({lineShadowStyle:e,pointShadowStyle:t,alpha:a})=>{e.apply(o,a),t.apply(j,a)}),n.initial));const V=l.signal(1);E.push(n.watch((()=>({heightPlane:M.visualElements.heightPlane,alpha:V.value})),(({heightPlane:e,alpha:t})=>e.apply(D,t)),n.initial));const A=()=>{O.update(e);const t=c.manipulatedObjectGeometry(v);if(!v.visible||S&&(v.isDraped||!b(t)||!t.hasZ))return o.laserlineEnabled=!1,j.attached=!1,void(D.attached=!1);o.laserlineEnabled=!0;const a=O.grabbingState&r.GrabbingState.XY?T.laserlineAlphaMultiplier:1;L.value=a;const n=O.grabbingState&r.GrabbingState.Z?T.laserlineAlphaMultiplier:1;V.value=n,function(e,t){const a=1===t.numSelected?t.firstSelected:t.numSelected>1&&null!=t.firstGrabbedXY?t.firstGrabbedXY:null;null!=a?(e.setStartEndFromWorldDownAtLocation(a.renderLocation),e.attached=!0):e.attached=!1}(j,O),function(e,t,a,n){if(n.numSelected>0){i.set(f,0,0,0);let t=0;e.forEachManipulator(((e,a)=>{a===u.ManipulatorType.TRANSLATE_XY&&e.selected&&e instanceof s.Manipulator3D&&(i.add(f,f,e.renderLocation),t++)})),t>0?(a.heightManifoldTarget=i.scale(f,f,1/t),a.attached=!0):a.attached=!1}else{const n=t.attachmentOrigin;null!=n&&e.view.renderCoordsHelper.toRenderCoords(n,f)?(a.heightManifoldTarget=f,a.attached=!0):a.attached=!1}}(e,o,D,O)};E.push(n.watch((()=>M.visualElements.zVerticalLine),(e=>e.apply(j)),n.initial)),E.push(v.on("committed",A),n.watch((()=>v.visible),A),o.events.on("attachment-origin-changed",A),t.destroyHandle(j),t.destroyHandle(D));const H=[],x=()=>{t.removeHandles(H),H.length=0,e.forEachManipulator((e=>H.push(e.events.on("grab-changed",A)))),e.forEachManipulator((e=>H.push(e.events.on("select-changed",A)))),A()};return x(),E.push(e.onManipulatorsChanged(x),t.refHandle((()=>t.handlesGroup(H)))),t.handlesGroup(E)}(e,y.visualElement),w=[y,E];return o.maskOccludee&&w.push(o.maskOccludee()),{visualElement:y.visualElement,remove:()=>t.removeHandles(w)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));