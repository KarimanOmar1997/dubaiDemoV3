// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../Color","../../../../../core/colorUtils","../../../../../core/Evented","../../../../../core/handleUtils","../../../../../core/has","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../Manipulator3D","../../manipulatorUtils","../../RenderObject","../dragEventPipeline3D","../ManipulatorType","../settings","./config","./Manipulation","./moveUtils","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces"],(function(e,t,a,i,r,n,s,o,l,c,u,d,p,m,h,M,f,_,g,v,b,O,w,R,y,F){"use strict";class U extends b.Manipulation{constructor(e){super(),this._radius=v.discRadius,this.events=new i,this._tool=e.tool,this._view=e.view;const t=new g.Settings({getTheme:()=>this._view.effectiveTheme});this._settings=t,null!=e.radius&&(this._radius=e.radius);const a=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:h.createManipulatorMaterial(T(a,1,.25),R.RenderOccludedFlag.Occlude),materialFocused:h.createManipulatorMaterial(T(a,1,0),R.RenderOccludedFlag.Occlude),materialOccludedUnfocused:h.createManipulatorMaterial(T(a,.7,0),t.zManipulator.renderOccluded),materialOccludedFocused:h.createManipulatorMaterial(T(a,.85,0),t.zManipulator.renderOccluded)},this._themeHandle=l.watch((()=>this._view.effectiveTheme.accentColor),(e=>{const t=T(e,1,.25),a=T(e,1,0),i=T(e,.7,0),r=T(e,.85,0),{materialUnfocused:n,materialFocused:s,materialOccludedUnfocused:o,materialOccludedFocused:l}=this._materials;n.setParameters({color:t}),s.setParameters({color:a}),o.setParameters({color:i}),l.setParameters({color:r})})),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._themeHandle=o.removeMaybe(this._themeHandle),this._manipulator.applyObjectTransform=z,this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))}forEachManipulator(e){e(this._manipulator,_.ManipulatorType.TRANSLATE_Z)}createManipulatedObjectDragPipeline(e,t,a){if(!t.operations)return r.makeHandle();const i=t.operations.data.spatialReference;return O.createManipulatedMoveDragPipeline(t,a,(t=>this.createDragPipeline(((a,i,r,n,s)=>(({steps:i,cancel:r}=e(a,i,r,n,s)),t(a,i,r))),i)))}createDragPipeline(e,t){const a=this._view;return y.createManipulatorDragEventPipeline(this._manipulator,((i,r,n,s,o)=>{const l=r.next((e=>({...e,manipulatorType:_.ManipulatorType.TRANSLATE_Z}))).next(f.screenToZConstrained(a,i.renderLocation,t)).next(y.addScreenDelta());e(i,l,n,s,o)}))}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._settings,t=this._radius/v.discRadius,a=e.zManipulator.height*t,i=e.zManipulator.coneHeight*t,r=e.zManipulator.coneWidth*t,n=e.zManipulator.width*t,s=[p.fromValues(0,0,0),p.fromValues(0,0,a)],o=[p.fromValues(0,0,0),p.fromValues(0,0,a+i)],l=(()=>{const e=u.create();return c.translate(e,e,[0,0,a]),c.rotateX(e,e,Math.PI/2),e})(),{materialUnfocused:d,materialFocused:m,materialOccludedUnfocused:h,materialOccludedFocused:f}=this._materials,_=w.createTubeGeometry(d,s,n/2,16,!1),g=w.createConeGeometry(d,i,r/2,16,!1);g.transformation=l,this._manipulator.renderObjects=[new M.RenderObject(g,F.ManipulatorStateFlags.Unfocused),new M.RenderObject(_,F.ManipulatorStateFlags.Unfocused),new M.RenderObject(g.instantiate({material:m}),F.ManipulatorStateFlags.Focused),new M.RenderObject(_.instantiate({material:m}),F.ManipulatorStateFlags.Focused),new M.RenderObject(g.instantiate({material:h}),F.ManipulatorStateFlags.Unfocused),new M.RenderObject(_.instantiate({material:h}),F.ManipulatorStateFlags.Unfocused),new M.RenderObject(g.instantiate({material:f}),F.ManipulatorStateFlags.Focused),new M.RenderObject(_.instantiate({material:f}),F.ManipulatorStateFlags.Focused)],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[o]}}_createManipulator(){const e=this._view,t=new m.Manipulator3D({view:e,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=t=>{const a=e.state.camera,i=S;e.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const r=d.dist(a.eye,i),n=a.computeRenderPixelSizeAtDist(r),o=d.subtract(P,i,a.eye);d.normalize(o,o);const l=j;e.renderCoordsHelper.worldUpAtPosition(S,l);const c=Math.abs(d.dot(o,l)),u=d.cross(P,o,l),p=d.cross(P,u,l),m=s.clamp(c,.01,1),h=1-Math.sqrt(1-m*m)/m/a.fullWidth,M=this._settings,f=this._radius/v.discRadius,_=M.zManipulator.width*f;d.scale(p,d.normalize(p,p),(1/h-1)*r+n*_),t[12]-=P[0],t[13]-=P[1],t[14]-=P[2]},this._manipulator=t,this._updateManipulator()}get test(){}}function T(e,i,r){const n=a.darken(e,r);return n.a*=i,t.toUnitRGBA(n)}const S=p.create(),P=p.create(),j=p.create(),z=()=>{};e.MoveZManipulation=U,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));