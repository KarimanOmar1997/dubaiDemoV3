// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Accessor","../../../../../core/colorUtils","../../../../../core/Cyclical","../../../../../core/Evented","../../../../../core/has","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/plane","../../../../../geometry/support/ray","../../../../../geometry/support/vectorStacks","../../Manipulator3D","../../manipulatorUtils","../../RenderObject","../dragEventPipeline3D","../ManipulatorType","../manipulations/config","../../../webgl-engine/lib/basicInterfaces","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Material","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/dragEventPipeline","../../../../interactive/interfaces"],(function(t,e,a,r,i,o,n,s,c,l,d,u,h,g,p,m,_,f,S,M,v,D,R,b,y,T,I,w,O,A,P,F,k,C,j){"use strict";var E,U;function x(t,e,a){return e.projectToScreen(t,N),S.set(a,N[0],N[1],0)}function L(t,e){let a=null,r=1;const i=()=>r;return{start:()=>{r=t.getScale(),a=t.getScale,t.getScale=i,e()},update:t=>(r+=((r+1)/2-r)*Math.min(t*O.ringResetAnimationSpeedFactor,1),e(),Math.abs(r-1)<.01?U.STOP:U.CONTINUE),destroy:()=>{a&&(t.getScale=a),e()}}}!function(t){t.ScaleIn=j.ManipulatorStateCustomFlags.Custom2,t.ScaleOut=j.ManipulatorStateCustomFlags.Custom3,t.RotateLeft=j.ManipulatorStateCustomFlags.Custom4,t.RotateRight=j.ManipulatorStateCustomFlags.Custom5,t.Unlocked=j.ManipulatorStateCustomFlags.Custom7,t.DelayedFocused=j.ManipulatorStateCustomFlags.Custom8,t.TouchInput=j.ManipulatorStateCustomFlags.Custom12}(E||(E={})),t.ScaleRotateTransform=class extends a{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}get updating(){return!!this._activeAnimation}constructor(t){super(t),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=O.ringIndicatorDelayMs,this.events=new o,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this.adapter.scale:1}initialize(){this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([l.watch((()=>{const{adapter:t}=this;return[t.angle,t.scale]}),(()=>this._updateManipulatorTransform()))])}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=d.addFrameTask({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=c.destroyMaybe(this._activeAnimation)}forEachManipulator(t){t(this._ringManipulator,w.ManipulatorType.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const e=this.tool.object,a=C.createManipulatorDragEventPipeline(t,((t,a,r)=>{this._scaleRotateDragData=null;const o=this.adapter.startInteraction(),n={mode:"none",origin:M.clone(t.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=n,this._updateDragState();const c=R.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,c),a.next(I.screenToRenderPlane(this.tool.view,v.fromPositionAndNormal(t.renderLocation,c,v.create()))).next((t=>{const a=v.getNormal(t.plane),r=y.calculateInputRotationTransform(t.renderStart,t.renderEnd,n.origin,a),c=i.cyclicalPI.shortestSignedDiff(n.angle,r);n.angleDir=s.clamp(n.angleDir+c,-.3,O.rotateIndicatorDirectionBuffer),n.angle=r;const l=function(t,e){const a=S.subtract(R.sv3d.get(),e.renderStart,t.origin),r=S.subtract(R.sv3d.get(),e.renderEnd,t.origin),i=S.length(a),o=S.length(r);return 0===i?0:o/i}(n,t),d=l-this.adapter.scale;if(n.scaleDir=s.clamp(n.scaleDir+d,-.2,O.scaleIndicatorDirectionBuffer),this._onScaleChanged(),"none"===n.mode){const a=this.mode||function(t,e,a,r){const{renderStart:i,renderEnd:o}=t,n=x(i,r,R.sv3d.get()),s=x(o,r,R.sv3d.get());if(S.squaredDistance(n,s)<O.dragThresholdPx*O.dragThresholdPx)return null;const c=S.subtract(R.sv3d.get(),i,a),l=S.cross(R.sv3d.get(),c,v.getNormal(e)),d=i,u=S.add(R.sv3d.get(),d,l),h=x(a,r,R.sv3d.get()),g=n,p=x(u,r,R.sv3d.get()),m=S.subtract(R.sv3d.get(),p,g),_=S.subtract(R.sv3d.get(),n,h),f=D.wrap(g,m),M=D.wrap(h,_);return D.distance2(f,s)<D.distance2(M,s)?"rotate":"scale"}(t,t.plane,n.origin,this.tool.view.state.camera);if(null!=a){switch(a){case"rotate":this.tool.events.emit("rotate-start",{object:e,angle:0}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]});break;case"scale":this.tool.events.emit("scale-start",{object:e,xScale:1,yScale:1}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]})}n.mode=a}}switch(n.mode){case"rotate":o.state.angle=n.initialAngle+r;break;case"scale":o.state.scale=l,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),t.action){case"start":case"update":switch(n.mode){case"rotate":this.tool.events.emit("rotate",{object:e,angle:s.rad2deg(n.angle)});break;case"scale":this.tool.events.emit("scale",{object:e,xScale:l,yScale:l})}break;case"end":switch(n.mode){case"rotate":this.tool.events.emit("rotate-stop",{object:e,angle:s.rad2deg(n.angle)});break;case"scale":this.tool.events.emit("scale-stop",{object:e,xScale:l,yScale:l})}}return"end"===t.action&&(this.startAnimation(L(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),o.done()),t})),r.next((()=>{if(o.cancel(),null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.events.emit("rotate-stop",{object:e,angle:0});break;case"scale":this.tool.events.emit("scale-stop",{object:e,xScale:1,yScale:1})}this.startAnimation(L(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}}))}));this.addHandles([a,t.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(function(t,e,a){let r=0,i=null;const o=()=>!1;return{start:()=>{i=t.getFocused,t.getFocused=o,r=0,e()},update:t=>(r+=t,!i?.()||r>=a.delayMs?U.STOP:U.CONTINUE),destroy:()=>{i&&(t.getFocused=i),e()}}}(this,(()=>this._updateDelayedFocusedState()),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()})),t.events.on("immediate-click",(t=>{t.stopPropagation()})),l.watch((()=>this.tool.object.visible),(t=>this._ringManipulator.available=t),l.initial)])}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(E.DelayedFocused,this.getFocused())}_updateDragState(){if(this._ringManipulator.updateStateEnabled(E.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode)),null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut,!1),this._ringManipulator.updateStateEnabled(E.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(E.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(E.RotateLeft|E.RotateRight,!1),this._ringManipulator.updateStateEnabled(E.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(E.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(E.ScaleIn|E.ScaleOut|E.RotateLeft|E.RotateRight,!1)}_updateManipulatorTransform(){const t=_.fromRotation(R.sm4d.get(),this.adapter.angle,M.fromValues(0,0,1));if(null==t)return;const e=this.getScale(),a=_.fromScaling(R.sm4d.get(),S.set(R.sv3d.get(),e,e,e));this._ringManipulator.modelTransform=_.multiply(R.sm4d.get(),a,t)}_createRingManipulator(){const t=(t,e,a)=>{const r=[],i=Math.ceil(O.geometrySegments*(e-t)/(2*Math.PI));for(let o=0;o<i+1;o++){const n=t+o*(e-t)/i;r.push(M.fromValues(a*Math.cos(n),a*Math.sin(n),0))}return r},e=e=>t(0,2*Math.PI,e),a=this._createMaterial(1),r=(t,e,r=a)=>P.createPathExtrusionGeometry(r,(t=>[[-t/2,0],[t/2,0],[t/2,O.ringHeight/2],[-t/2,O.ringHeight/2]])(e),t,[],[],!1),i=e(O.ringRadius),o=r(i,O.ringThickness),n={left:new Array,right:new Array},s=[];for(let e=0;e<2;e++){const i=e*Math.PI-Math.PI/4,o=Math.PI/2-O.rotateIndicatorArcLength,c=i+o,l=i+Math.PI/2-o,d=t(c,l,O.innerIndicatorRadius),u=r(d,O.indicatorThickness);s.push(d),s.push(t(c,l,O.outerIndicatorRadius-O.ringThickness/2)),n.left.push(u),n.right.push(u.instantiate());for(let t=0;t<2;t++){const e=0===t,r=f.create();if(e){_.scale(r,r,[1,-1,1]),_.rotate(r,r,-c,[0,0,1]);const t=Math.round(O.rotateIndicatorArrowPlacementPercentage*(d.length-1));r[12]=d[t][0],r[13]=d[t][1],r[14]=d[t][2]}else{_.rotate(r,r,l,[0,0,1]);const t=Math.round((1-O.rotateIndicatorArrowPlacementPercentage)*(d.length-1));r[12]=d[t][0],r[13]=d[t][1],r[14]=d[t][2]}const i=P.createExtrudedTriangle(a,O.rotateIndicatorArrowTipLength,0,O.rotateIndicatorArrowTipRadius,O.ringHeight);P.transformInPlace(i,r),(e?n.left:n.right).push(i)}}const c=[];for(let e=0;e<2;e++){const a=e*Math.PI-Math.PI/4,i=Math.PI/2-O.scaleIndicatorArcLength,o=a+i,n=a+Math.PI/2-i,s=t(o,n,O.outerIndicatorRadius);c.push(r(s,O.indicatorThickness))}const l=this._createMaterial(.66),d=this._createMaterial(.5),u=this._createMaterial(.33),h=e(O.ringRadius+O.scaleIndicatorOffset1),g=e(O.ringRadius+O.scaleIndicatorOffset2),p=r(h,O.indicatorThickness,l),m=r(g,O.indicatorThickness,u),S=e(O.ringRadius-O.scaleIndicatorOffset1),v=e(O.ringRadius-O.scaleIndicatorOffset2),D=r(S,O.indicatorThickness,l),R=r(v,O.indicatorThickness,u);let y=[new T.RenderObject(o,E.DelayedFocused),new T.RenderObject(o.instantiate({material:d}),j.ManipulatorStateFlags.None)];this.mode&&"scale"!==this.mode||(y=y.concat([...c.map((t=>new T.RenderObject(t,E.DelayedFocused|E.Unlocked))),new T.RenderObject(p,E.DelayedFocused|E.ScaleIn),new T.RenderObject(m,E.DelayedFocused|E.ScaleIn),new T.RenderObject(D,E.DelayedFocused|E.ScaleOut),new T.RenderObject(R,E.DelayedFocused|E.ScaleOut)])),this.mode&&"rotate"!==this.mode||(y=y.concat([...n.right.map((t=>new T.RenderObject(t.instantiate(),E.DelayedFocused|E.Unlocked))),...n.left.map((t=>new T.RenderObject(t,E.DelayedFocused|E.RotateLeft))),...n.right.map((t=>new T.RenderObject(t,E.DelayedFocused|E.RotateRight)))]));const I=[i,...s];return new b.Manipulator3D({view:this.tool.view,renderObjects:y,autoScaleRenderObjects:!1,worldOriented:!0,radius:O.ringThickness,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:this.tool.object.elevationInfo,collisionType:{type:"ribbon",paths:I,direction:M.fromValues(0,0,1)}})}_createMaterial(t){const e=new k.ColorMaterial({cullFace:A.CullFaceOptions.Back,renderOccluded:F.RenderOccludedFlag.Transparent,isDecoration:!0});return this.addHandles(l.watch((()=>r.multiplyOpacityToUnitRGBA(this.tool.view.effectiveTheme.accentColor,t)),(t=>e.setParameters({color:t})),l.initial)),e}get test(){}},e.__decorate([h.property({constructOnly:!0})],t.ScaleRotateTransform.prototype,"tool",void 0),e.__decorate([h.property({constructOnly:!0})],t.ScaleRotateTransform.prototype,"adapter",void 0),e.__decorate([h.property({constructOnly:!0})],t.ScaleRotateTransform.prototype,"sketchOptions",void 0),e.__decorate([h.property()],t.ScaleRotateTransform.prototype,"mode",void 0),e.__decorate([h.property()],t.ScaleRotateTransform.prototype,"_activeAnimation",void 0),e.__decorate([h.property()],t.ScaleRotateTransform.prototype,"updating",null),t.ScaleRotateTransform=e.__decorate([m.subclass("esri.views.3d.interactive.editingTools.transform.ScaleRotateTransform")],t.ScaleRotateTransform),function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(U||(U={}));const N=u.createScreenPointArray();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));