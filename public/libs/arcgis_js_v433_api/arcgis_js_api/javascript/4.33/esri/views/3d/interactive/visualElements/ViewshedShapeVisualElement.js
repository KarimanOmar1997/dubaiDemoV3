// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../analysis/Viewshed/ViewshedConfiguration","../../analysis/Viewshed/viewshedToolUtils","./Object3DVisualElement","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/ColorMaterial"],(function(e,t,a,r,i,o,s,n,l,c,d,u,m){"use strict";class h extends l.Object3DVisualElement{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new m.ColorMaterial({...s.viewshedVisualizationConfiguration.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(null==e)return;const t=r.create(),i=e.farDistanceRenderSpace;a.fromScaling(t,o.fromValues(i,i,i)),n.getViewshedRotationMatrix(e,v),a.mul(t,v,t),a.fromTranslation(v,this._viewshedComputedData.observerRenderSpace),a.mul(t,v,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachMaterial(e){e(this._material)}createGeometries(e){const{_material:r,viewshedComputedData:o}=this;if(null==o||null==r||!o.valid)return;const l=function(e,r){const{horizontalFieldOfView:o,verticalFieldOfView:l}=r,m=i.set(p,0,0,1),h=i.set(g,0,1,0),D=i.set(w,1,0,0);n.rotateBy(m,m,t.deg2rad(l/2),h),n.rotateBy(m,m,t.deg2rad(o/2),D);const V=e=>Math.ceil(Math.abs(e)/s.arcAnglePerSegment)+1,C=t.deg2rad(o),M=i.copy(b,D),x=V(C),_=f(-C/(x-1)),R=a.fromRotation(v,_,M),S=t.deg2rad(-l),E=V(S),O=f(S/(E-1)),T=i.copy(g,h),A=a.fromRotation(y,t.deg2rad(o)/2,D);i.transformMat4(T,T,A);const P=y,G=[],j=i.copy(w,m);for(let e=0;e<x;e++){a.fromRotation(P,O,T);for(let t=0;t<E;t++){const a=3*(t*x+e);G[a]=j[0],G[a+1]=j[1],G[a+2]=j[2],i.transformMat4(j,j,P)}i.transformMat4(T,T,R),i.transformMat4(m,m,R),i.copy(j,m)}const N=x*E;G[3*N]=0,G[3*N+1]=0,G[3*N+2]=0;const z=[];for(let e=0;e<x-1;e++)for(let t=0;t<E-1;t++){const a=6*(t*(x-1)+e);z[a]=t*x+e,z[a+1]=(t+1)*x+e,z[a+2]=t*x+e+1,z[a+3]=t*x+e+1,z[a+4]=(t+1)*x+e,z[a+5]=(t+1)*x+e+1}const B=[z];if(360!==o&&0!==l){const e=[],t=[];for(let a=0;a<E-1;a++){const r=3*a;e[r]=N,e[r+1]=(a+1)*x,e[r+2]=a*x,t[r]=N,t[r+1]=a*x+x-1,t[r+2]=(a+1)*x+x-1}B.push(e,t)}if(180!==l&&0!==o){const e=[],t=[];for(let a=0;a<x-1;a++){const r=3*a;e[r]=N,e[r+1]=a,e[r+2]=a+1,t[r]=N,t[r+1]=a+(E-1)*x+1,t[r+2]=a+(E-1)*x}B.push(e,t)}return B.map((t=>{const a=[[u.VertexAttribute.POSITION,new c.Attribute(G,t,3,!0)]];return new d.Geometry(e,a)}))}(r,o);l.forEach((t=>e.addGeometry(t)))}}function f(e){return isNaN(e)?1:e}const p=o.create(),g=o.create(),w=o.create(),b=o.create(),v=r.create(),y=r.create();e.ViewshedShapeVisualElement=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));