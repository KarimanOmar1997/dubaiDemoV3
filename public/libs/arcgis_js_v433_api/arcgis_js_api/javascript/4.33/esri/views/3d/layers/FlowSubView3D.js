// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/projectionUtils","../../../geometry/support/aaBoundingRect","../../../symbols/support/ElevationInfo","../../2d/engine/flow/dataUtils","../../2d/engine/flow/utils","./SubView3D","../support/flow/geometryUtils","../support/flow/loadUtils","../support/flow/StreamlinesStyle3D","../terrain/tileUtils"],(function(e,t,r,o,l,s,i,n,a,u,d,c,p,h,y,_,g,f,m,w){"use strict";return e.default=class extends _{constructor(e){super(e),this.type="flow",this._preorderIterator=new w.IteratorPreorder,this._abortController=null,this._debouncedLoad=l.debounce((async()=>{const{view:e,_style:t}=this;if(null==t)return;const r=this._computeExtent();if(null==r)return;const o={extent:r,timeExtent:this.layer.timeExtent,size:this._viewSizeWithEqualRatio(r),pixelRatio:e.state.contentPixelRatio};null==this._abortController&&(this._abortController=new AbortController);const s=this._abortController,i=await t.load(o,s.signal);l.throwIfAborted(s.signal),null!=i&&(this._resources?.detach(),i.attach(e.stage),this._resources=i)})),this._loadImagery=(e,t)=>{const{extent:r,size:[o,l],timeExtent:s}=e;return h.loadImagery(this.layer,r,o,l,s,t)},this._createFlowGeometry=(e,t)=>g.createFlowGeometry(this.view,e,t,this.elevationInfo)}initialize(){this.addHandles([s.when((()=>this.newStyleRequired),(()=>this._updateStyle()),s.sync)]),this.updatingHandles.add((()=>this._style),(()=>this._triggerLoad())),this._updateStyle(),this.updatingHandles.addWhen((()=>!this.view.basemapTerrain?.updating),(()=>this._triggerLoad()))}destroy(){this._abortController=o.abortMaybe(this._abortController),this.clear()}get layer(){return this.layerView.layer}get flowRenderer(){const e=this.layer.renderer;return"flow"!==e?.type?null:e}get elevationInfo(){return new p({mode:"absolute-height",offset:1e3})}get dataBounds(){const{fullExtent:e}=this.layer,{spatialReference:t}=this.view.basemapTerrain,r=d.projectOrLoad(e,t).geometry;return null==r?null:c.fromExtent(r)}get simulationSettings(){const{flowRenderer:e}=this;return null==e?null:y.getFlowSimulationSettings(e)}get newStyleRequired(){const e=this._style?.simulationSettings,t=this.simulationSettings;return null!=e&&null!=t&&!y.simulationSettingsEqual(e,t)}doRefresh(){return this._triggerLoad()}clear(){this._resources?.detach(),this._resources=null}_triggerLoad(){return l.ignoreAbortErrors(this.updatingHandles.addPromise(this._debouncedLoad()))}_updateStyle(){const{simulationSettings:e}=this;null!=e&&(this._style?.destroy(),this._style=new m({simulationSettings:e,loadImagery:this._loadImagery,createGeometry:this._createFlowGeometry}))}_computeExtent(){const e=this.view.basemapTerrain,t=e?.rootTiles;if(null==t||0===t.length)return null;const{spatialReference:r}=e,{dataBounds:o}=this;if(!r||null==o)return null;const l=f.boundingRectOfTileTree(t,this._preorderIterator,o);return null==l?null:(c.intersection(l,o,l),c.toExtent(l,r))}_viewSizeWithEqualRatio(e){const t=(e.xmax-e.xmin)/(e.ymax-e.ymin),[r,o]=this.view.size;return r<o?[r,Math.floor(r/t)]:[Math.floor(o*t),o]}get test(){}},t.__decorate([i.property()],e.default.prototype,"type",void 0),t.__decorate([i.property()],e.default.prototype,"_style",void 0),t.__decorate([i.property()],e.default.prototype,"layer",null),t.__decorate([i.property()],e.default.prototype,"flowRenderer",null),t.__decorate([i.property()],e.default.prototype,"elevationInfo",null),t.__decorate([i.property()],e.default.prototype,"dataBounds",null),t.__decorate([i.property()],e.default.prototype,"simulationSettings",null),t.__decorate([i.property()],e.default.prototype,"newStyleRequired",null),e.default=t.__decorate([u.subclass("esri.views.3d.layers.FlowSubView3D")],e.default),e.default}));