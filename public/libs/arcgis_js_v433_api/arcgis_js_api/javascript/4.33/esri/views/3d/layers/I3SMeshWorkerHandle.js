// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Logger","../../../core/PooledArray","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/workers/WorkerHandle","../../../geometry/projectionUtils","../../../geometry/projection/projectVectorToVector","../../../libs/i3s/enums"],(function(e,s,t,o,i,r,n,a){"use strict";class h extends i.WorkerHandle{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,s,t,o){const i={context:e,modifications:u(s,t,o),isGeodetic:o.isGeographic};this.broadcast(i,"setModifications")}setLegacySchema(e,s){const t=JSON.stringify(s);return this.broadcast({context:e,jsonSchema:t},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}project(e,s){return this.invokeMethod("project",e,s)}transformNormals(e,s){return this.invokeMethod("transformNormals",e,s)}}const c=new t({deallocator:null}),p=o.create();function u(e,t,o){c.clear();let i=1/0,h=1/0,u=-1/0,f=-1/0,l=!1;for(const e of t){const t="clip"===e.type?a.ModificationType.Inside:"mask"===e.type?a.ModificationType.Outside:a.ModificationType.Replace,d=e.geometry;let m=e=>e;if(d.spatialReference){if(!r.canProjectWithoutEngine(d.spatialReference,o)){s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}m=e=>(n.projectVectorToVector(e,d.spatialReference,p,o),p)}else d.hasZ||(p[2]=0,m=e=>(p[0]=e[0],p[1]=e[1],p));l=l||t===a.ModificationType.Outside,c.push(t),c.push(d.rings.length);for(const e of d.rings){c.push(e.length);for(const s of e){const e=m(s);c.push(e[0]),c.push(e[1]),c.push(e[2]),i=Math.min(i,e[0]),h=Math.min(h,e[1]),u=Math.max(u,e[0]),f=Math.max(f,e[1])}}}if(null!=e)if(l){const s=1e-4;c.push(a.ModificationType.Inside),c.push(2),c.push(4),c.push(i-s),c.push(h-s),c.push(0),c.push(u+s),c.push(h-s),c.push(0),c.push(u+s),c.push(f+s),c.push(0),c.push(i-s),c.push(f+s),c.push(0),c.push(4),c.push(e[0]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[3]),c.push(0),c.push(e[0]),c.push(e[3]),c.push(0)}else c.push(a.ModificationType.Outside),c.push(1),c.push(4),c.push(e[0]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[3]),c.push(0),c.push(e[0]),c.push(e[3]),c.push(0);c.push(a.ModificationType.Finished);const d=new Float64Array(c.length);for(let e=0;e<c.length;++e)d[e]=c.at(e);return d}e.I3SMeshWorkerHandle=h,e.TransformedData=class{constructor(e,s,t,o,i,r,n){this.componentOffsets=e,this.featureIds=s,this.anchorIds=t,this.anchors=o,this.transformedGeometry=i,this.globalTrafo=r,this.obb=n}},e.TransformedGeometry=class{constructor(e,s,t,o,i,r){this.layout=e,this.interleavedVertexData=s,this.indices=t,this.hasColors=o,this.hasModifications=i,this.positionData=r}},e.toWasmModification=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));