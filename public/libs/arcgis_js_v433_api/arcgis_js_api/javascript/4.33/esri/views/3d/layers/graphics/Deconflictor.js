// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../core/support/UpdatingHandles","../../../../geometry/ellipsoidUtils","../../../../geometry/support/aaBoundingRect","../../../../chunks/boundedPlane","../../../../geometry/support/ray","../../../../chunks/sphere","./DeconflictAABR","./deconflictorDebug","./enums","../../webgl/RenderCamera","../../webgl-engine/lib/GPUPointOcclusionQuery","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/HUDMaterial","../../webgl-engine/materials/ScaleInfo","../../../support/Yield"],(function(t,i,e,s,c,r,o,n,a,l,u,h,d,p,y,_,f,g,b,v,O,m,D,w,S,I,C,G,k,A,P,V,Q){"use strict";const N=y.create(),T=y.create(),x=f.create(),E=f.create(),M=y.create(),R=h.create(),U=D.create(),F=m.create(),L=y.create(),H=v.create();class B{constructor(t){this.id=t,this.aabr=v.create(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.culled=!1,this.visible=!1,this.priority=0}}function W(t,i){const e=0!==t.distanceToOccluder&&t.distance>t.distanceToOccluder,s=0!==i.distanceToOccluder&&i.distance>i.distanceToOccluder;return e!==s?+e-+s:t.priority!==i.priority?i.priority-t.priority:t.distance!==i.distance?t.distance-i.distance:t.visible!==i.visible?+i.visible-+t.visible:t.id-i.id}var j;t.State=void 0,(j=t.State||(t.State={}))[j.Idle=0]="Idle",j[j.CheckOcclusion=1]="CheckOcclusion",j[j.WaitOcclusion=2]="WaitOcclusion",j[j.Collect=3]="Collect",j[j.Deconflict=4]="Deconflict",j[j.NumStates=5]="NumStates";class z{constructor(){this.camera=new C,this.slicePlane=O.create(),this.slicePlaneEnabled=!1}copyFrom(t){this.camera.copyFrom(t.camera),O.copy(t.slicePlane,this.slicePlane),this.slicePlaneEnabled=t.slicePlaneEnabled}}t.Deconflictor=class extends e{get dirty(){return this._dirty}get state(){return this._state}constructor(i){super(i),this._dirty=!1,this._viewState=new z,this._state=t.State.Idle,this._checkOcclusion=new Map,this._active=new Map,this._checkOcclusionIterator=null,this._activeIterator=null,this._occlusionQueryUids=new Array,this._updatingHandles=new g.UpdatingHandles,this._deconflictor=new w.DeconflictAABR(((t,i)=>{t.visible=i,this._setGraphicVisibility(this._active.get(t.id),i)}),((t,i)=>t.id!==i.id),W),this._baseOccludedVisibility=10,this._altitudeFactor=2,this._minAltitudeDifference=100}initialize(){this._updatingHandles.add((()=>(this.view?.map?.ground?.opacity??0)>0),(()=>this.setDirty())),this._updatingHandles.add((()=>this.view.ready),(()=>this._occlusionQuery=null))}destroy(){this._occlusionQuery=null,this._updatingHandles.destroy(),this._deconflictor.destroy(),this._checkOcclusion.clear(),this._active.clear()}setDirty(){!this._dirty&&(this._active.size>0||this._checkOcclusion.size>0)&&(this._dirty=!0,this.notifyChange("updating"))}setPriority(t,i){const e=this._active.get(t.graphic.uid)?.getInfo(this.visibilityGroup);e&&(e.priority=i)}get updating(){return this._state!==t.State.Idle||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const i=this._state/t.State.NumStates;return this._dirty?.5*i:i}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(i){switch(this._state){case t.State.Idle:this._startUpdate(),i.madeProgress();case t.State.CheckOcclusion:if(this._state=t.State.CheckOcclusion,!this._processCheckOcclusion(i))return;case t.State.WaitOcclusion:if(this._state=t.State.WaitOcclusion,this._occlusionQuery&&!this._occlusionQuery.done)return Q.Yield;this._readOcclusionQueryResult(),i.madeProgress();case t.State.Collect:if(this._state=t.State.Collect,!this._collectActiveGraphics(i))return;case t.State.Deconflict:if(this._state=t.State.Deconflict,this._deconflictor.run(i),!this._deconflictor.done)return;default:this._state=t.State.Idle,this.notifyChange("updating")}}setGraphicsActive(t,i){i?t.forEach((t=>this.addToActiveGraphics(t))):t.forEach((t=>this.removeFromActiveGraphics(t)))}layerSupportsDeconfliction(t){if(null==t||"object3d"!==t.type)return!1;const i=t.stageObject;if(1!==(i?.geometries.length??0))return!1;const e=i?.geometries[0],s=e?.material;return s instanceof P.HUDMaterial}_startUpdate(){S.prepare(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:i}=this._viewState.camera;this._deconflictor.reset(t,i),this._resetIterators(),this._occlusionQueryUids.length=0,this._checkOcclusion.size||(this._occlusionQuery=c.destroyMaybe(this._occlusionQuery))}addToActiveGraphics(t){t.ensureInfo(this.visibilityGroup),this._active.set(t.graphics3DGraphic.graphic.uid,t),this.setDirty()}removeFromActiveGraphics(t){!function(t,i){const e=t.graphics3DGraphic;e.destroyed||e.setVisibilityFlag(i,I.VisibilityFlag.DECONFLICTION,!0)}(t,this.visibilityGroup),t.removeInfo(this.visibilityGroup),this._active.delete(t.graphics3DGraphic.graphic.uid),this.setDirty()}addToCheckOcclusion(t){this._checkOcclusion.set(t.graphics3DGraphic.graphic.uid,t),this.setDirty()}removeFromCheckOcclusion(t){this._checkOcclusion.delete(t.graphics3DGraphic.graphic.uid)}_processCheckOcclusion(t){if(0===this._checkOcclusion.size)return!0;const i=this._ensureCheckOcclusionIterator(),e=this._viewState.camera,s=u.transpose(R,e.viewInverseTransposeMatrix),r=this.view.map.ground.opacity>0,o="global"===this.view.viewingMode&&r&&e.relativeElevation>0?U:null;let n=0;null!=o&&(p.transformMat4(D.getCenter(o),y.ZEROS,e.viewMatrix),o[3]=b.getReferenceEllipsoid(this.view.spatialReference).radius,n=D.distanceToSilhouette(o,y.ZEROS));const a=v.create();for(;;){if(t.done)return!1;t.madeProgress();const c=i.next();if(!0===c.done)break;const r=c.value,l=r.graphics3DGraphic;if(l.destroyed)continue;if(!l.isVisible(I.VisibilityGroup.GRAPHIC,I.VisibilityFlag.DECONFLICTION))continue;const u=q(l,this.visibilityGroup);let h=null,d=!0;for(const t of u){if(!this.layerSupportsDeconfliction(t))continue;h=J,this._projectHudLayer(t,e,h),v.empty(a);const i=t.stageObject.geometries[0].material;if(this._expandBoundingRect(a,e,t,i,h),h.isOutsideScreen){d=!1;break}if(this._isCulledBySlice(r,h.positionView)){d=!1;break}if(null!=o&&Z(h,o,n)){d=!1;break}p.transformMat4(T,h.positionView,s),h.altitude=this.view.renderCoordsHelper.getAltitude(T);const c=r.ensureInfo(this.visibilityGroup);if(c.altitude=h.altitude,c.distance=h.distance,c.distanceToOccluder=h.distanceToOccluder,c.culled=!1,v.copy(c.aabr,a),i.parameters.occlusionTest)break;this._ensureOcclusionQuery().addPosition(T)===this._occlusionQueryUids.length&&this._occlusionQueryUids.push(l.graphic.uid);break}if(this._active.has(l.graphic.uid)&&(!d||!h)){const t=r.ensureInfo(this.visibilityGroup);t.visible=!h,t.culled=!0}}return this._checkOcclusionIterator=null,this._occlusionQueryUids.length||(this._occlusionQuery=c.destroyMaybe(this._occlusionQuery)),this._occlusionQuery?.start(),!0}_readOcclusionQueryResult(){if(!this._occlusionQuery||!this._occlusionQueryUids.length)return;const t=this._viewState.camera,i=this.view.renderCoordsHelper.getAltitude(t.eye);for(let t=0;t<this._occlusionQueryUids.length;t++){const e=this._occlusionQueryUids[t],s=this._checkOcclusion.get(e);if(!s)continue;const c=this._occlusionQuery.getOcclusion(t)??-1,r=s.getInfo(this.visibilityGroup);r&&(r.distanceToOccluder=c>0?r.distance-c:0);const o=c<=0||this._occludedVisibility(r?.distanceToOccluder??0,r?.distance??c,r?.altitude??0,i);this._active.has(e)?r&&(r.culled=!o,r.visible=o):this._setGraphicVisibility(s,o)}this._occlusionQueryUids.length=0}_collectActiveGraphics(t){const i=this._ensureActiveGraphicsIterator(),e=this.visibilityGroup===I.VisibilityGroup.LABEL;for(;!t.done;){t.madeProgress();const s=i.next();if(!0===s.done)return this._activeIterator=null,!0;const c=s.value,r=c.getInfo(this.visibilityGroup);r&&(e&&!c.graphics3DGraphic.isVisible()||r.culled?(S.drawPoly(r.aabr,!1,!0),this._setGraphicVisibility(c,r.visible)):this._deconflictor.add(r))}return!1}_occludedVisibility(t,i,e,s){const c=Math.max(this._minAltitudeDifference,Math.abs(e-s))-this._minAltitudeDifference;return 0===t||i-t<=this._baseOccludedVisibility+this._altitudeFactor*c}_resetIterators(){this._checkOcclusionIterator=null,this._activeIterator=null}_ensureCheckOcclusionIterator(){return this._checkOcclusionIterator??=this._checkOcclusion.values(),this._checkOcclusionIterator}_ensureActiveGraphicsIterator(){return this._activeIterator??=this._active.values(),this._activeIterator}_ensureOcclusionQuery(){return this._occlusionQuery??=new G.GPUPointOcclusionQuery({view:this.view}),this._occlusionQueryUids.length||this._occlusionQuery.init(this._checkOcclusion.size,this._viewState.camera.eye),this._occlusionQuery}_projectHudLayer(t,i,e){const s=t.stageObject,c=s.geometries[0],r=c.material,o=D.getCenter(s.boundingVolumeWorldSpace.bounds);p.transformMat4(N,o,i.viewMatrix);const n=c.attributes,a=n.get(A.VertexAttribute.NORMAL).data,l=n.get(A.VertexAttribute.CENTEROFFSETANDDISTANCE).data;r.applyShaderOffsetsView(N,a,s.transformation,l,i,e.scaleInfo,N),_.set(x,N[0],N[1],N[2],1),_.transformMat4(E,x,i.projectionMatrix),p.scale(e.positionNDC,E,1/E[3]),r.applyShaderOffsetsNDC(e.positionNDC,l,i,e.positionNDC,M),e.distanceWithoutPolygonOffset=i.depthNDCToWorld(M[2]),e.distance=M[2]===e.positionNDC[2]?e.distanceWithoutPolygonOffset:i.depthNDCToWorld(e.positionNDC[2]),_.set(E,e.positionNDC[0],e.positionNDC[1],e.positionNDC[2],1),_.transformMat4(x,E,i.inverseProjectionMatrix),_.scale(x,x,1/x[3]),p.set(e.positionView,N[0],N[1],N[2])}_isCulledBySlice(t,i){return t.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&O.extrusionContainsPoint(this._viewState.slicePlane,i)}_expandBoundingRect(t,i,e,c,{positionNDC:r,scaleInfo:o}){const n=e.getScreenSize(Y);k.applyPrecomputedScaleFactor(n,o.factor,n),n[0]*=i.pixelRatio,n[1]*=i.pixelRatio;const a=v.offset(c.calculateRelativeScreenBounds(n,o.factorAlignment.scale*i.pixelRatio,H),s.lerp(0,i.fullWidth,.5+.5*r[0]),s.lerp(0,i.fullHeight,.5+.5*r[1])),l=this.marginFactor;if(0!==l){const t=l*Math.min(v.width(a),v.height(a));a[0]-=t,a[1]-=t,a[2]+=t,a[3]+=t}v.expand(t,a,t)}_setGraphicVisibility(t,i){const e=t?.graphics3DGraphic;e&&!e.destroyed&&(e.setVisibilityFlag(this.visibilityGroup,I.VisibilityFlag.DECONFLICTION,i),this.visibilityGroup===I.VisibilityGroup.LABEL&&this.view.labeler.setLabelGraphicVisibility(e,i))}},i.__decorate([r.property({constructOnly:!0})],t.Deconflictor.prototype,"view",void 0),i.__decorate([r.property({type:Boolean,readOnly:!0})],t.Deconflictor.prototype,"updating",null),i.__decorate([r.property({readOnly:!0})],t.Deconflictor.prototype,"_updatingHandles",void 0),t.Deconflictor=i.__decorate([l.subclass("esri.views.3d.layers.graphics.Deconflictor")],t.Deconflictor);const Y=d.create();function Z(t,i,e){return p.copy(F.direction,t.positionView),p.set(F.origin,0,0,0),!!D.intersectRay(i,F,L)&&t.distanceWithoutPolygonOffset>e}function q(t,i){return i===I.VisibilityGroup.LABEL?t.labelLayers:t.layers}const J=new class{constructor(){this.positionView=y.create(),this.positionNDC=y.create(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new V.ScaleInfo}get isOutsideScreen(){const t=this.positionNDC;return t[0]<-1||t[1]<-1||t[2]<-1||t[0]>=1||t[1]>=1||t[2]>=1}};t.DeconflictorGraphic=class{constructor(t,i){this.graphics3DGraphic=t,this.slicePlaneEnabled=i,this._info=null,this._labelInfo=null}ensureInfo(t){let i=this.getInfo(t);return i||(i=new B(this.graphics3DGraphic.graphic.uid),this._setInfo(t,i)),i}getInfo(t){return t===I.VisibilityGroup.LABEL?this._labelInfo:this._info}removeInfo(t){this._setInfo(t,null)}_setInfo(t,i){t===I.VisibilityGroup.LABEL?this._labelInfo=i:this._info=i}},t.DeconflictorViewState=z,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));