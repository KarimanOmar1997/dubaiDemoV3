// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/projection/projectBuffer","./elevationAlignmentUtils","../../support/debugFlags","../../support/ElevationProvider","../../webgl-engine/lib/GeometryWithMapPositions","../../webgl-engine/lib/VertexAttribute"],(function(e,t,n,o,a,r,i,s,l,c,u,f){"use strict";const g=n.create(),m=.01,p=a.create(),d=a.create(),b=a.create(),I=n.create(),T=a.create(),S=new s.SampleElevationInfo;function A(e,t,n,o,a){let r=!1;const s=e.transformation,u=t.requiresSampledElevationInfo;d[0]=s[12],d[1]=s[13],d[2]=s[14],e.invalidateBoundingInfo();const g=e.getMutableAttribute(f.VertexAttribute.POSITION),I=g.data,T=g.size,A=I.length/T,v=new c.SamplePosition(e.mapPositions,n);let O=0,h=0;for(let e=0;e<A;e++){if(b[0]=I[O],b[1]=I[O+1],b[2]=I[O+2],o(v,S),u&&(h+=S.sampledElevation),l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS)I[O]=v.array[v.offset],I[O+1]=v.array[v.offset+1],I[O+2]=S.z,i.projectBuffer(I,n,O,I,a.spatialReference,O,1),I[O]-=d[0],I[O+1]-=d[1],I[O+2]-=d[2],r=!0;else{p[0]=I[O]+d[0],p[1]=I[O+1]+d[1],p[2]=I[O+2]+d[2],a.setAltitude(p,S.z),I[O]=p[0]-d[0],I[O+1]=p[1]-d[1],I[O+2]=p[2]-d[2];const e=m/a.unitInMeters;(Math.abs(b[0]-I[O])>=e||Math.abs(b[1]-I[O+1])>=e||Math.abs(b[2]-I[O+2])>=e)&&(r=!0)}O+=T,v.offset+=3}return h/=A,{update:r,averageGeometrySampledElevation:h}}e.perLodInstanceElevationAligner=function(e,t,n,a,i){const s=e.graphics3DSymbolLayer.lodRenderer;if(null==s)return 0;const c=t.centerPointInElevationSR;a(c,S);const u="absolute-height"!==t.mode?S.sampledElevation:0,f=s.instanceData,g=e.instanceIndex,d=I;f.getGlobalTransform(g,d);const b=o.set(T,d[12],d[13],d[14]);l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(p[0]=c.x,p[1]=c.y,p[2]=S.z,r.computeTranslationToOriginAndRotation(c.spatialReference,p,d,i.spatialReference)&&f.setGlobalTransform(g,d)):i.setAltitudeOfTransformation(S.z,d);const A=m/i.unitInMeters;return(l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(d[12]-b[0])>=A||Math.abs(d[13]-b[1])>=A||Math.abs(d[14]-b[2])>=A)&&f.setGlobalTransform(g,d),u},e.perObjectElevationAligner=function(e,n,a,i,c,u){const f=e.stageObject,d=n.centerPointInElevationSR;let b=0;f.usesVerticalDistanceToGround?(i(d,S),s.updateVertexPointGroundDistance(f,S.verticalDistanceToGround),b=S.sampledElevation):(i(d,S),"absolute-height"!==n.mode&&(b=S.sampledElevation));const I=t.copy(g,u??f.transformation),A=o.set(T,I[12],I[13],I[14]);l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(p[0]=d.x,p[1]=d.y,p[2]=S.z,r.computeTranslationToOriginAndRotation(d.spatialReference,p,I,c.spatialReference)&&(u?t.copy(u,I):f.transformation=I)):c.setAltitudeOfTransformation(S.z,I);const v=m/c.unitInMeters;return(Math.abs(I[12]-A[0])>=v||Math.abs(I[13]-A[1])>=v||Math.abs(I[14]-A[2])>=v)&&(u?t.copy(u,I):f.transformation=I),b},e.perVertexElevationAligner=function(e,t,n,o,a){const r=e.stageObject,i=r.geometries;let s=0;for(const e of i){if(!u.isGeometryWithMapPositions(e))continue;const{update:i,averageGeometrySampledElevation:l}=A(e,t,n,o,a);s+=l,i&&r.geometryVertexAttributeUpdated(e,f.VertexAttribute.POSITION)}return s/i.length},e.sharedGeometryElevationAligner=function(e,t,n,o,a){const r=e.stageObject,i=r.geometries;if(0===i.length)return 0;let s=0,l=null,c=0,g=!1;for(const e of i){if(!u.isGeometryWithMapPositions(e))continue;const i=e.attributes.get(f.VertexAttribute.POSITION);if(i!==l){const{update:r,averageGeometrySampledElevation:s}=A(e,t,n,o,a);c=s,l=i,g=r}g&&r.geometryVertexAttributeUpdated(e,f.VertexAttribute.POSITION),s+=c}return s/i.length},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));