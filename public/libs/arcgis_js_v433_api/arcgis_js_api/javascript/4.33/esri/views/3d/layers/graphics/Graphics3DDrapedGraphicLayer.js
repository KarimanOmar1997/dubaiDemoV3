// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","./graphicUtils","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/ModelDirtyTypes"],(function(e,t,i,r,o,s,n,a){"use strict";const d=o.create(),c=r.create(),h=i.create();e.Graphics3DDrapedGraphicLayer=class{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this._drapeSourceRenderer=r,this.type="draped",this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,a.DirtyOperation.ADD);if(e||this._addedToStage){for(const e of this.renderGeometries)e.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,a.DirtyState.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,a.DirtyOperation.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=i.create()){return t.set(e,0,0,0)}getBoundingBoxObjectSpace(e=r.create()){return r.empty(e)}addObjectState(e){e.stateType===n.Object3DState.Highlight&&(this.renderGeometries.forEach((t=>{const i=t.geometry.allocateIdAndHighlight(e.highlightName);e.addRenderGeometry(t,i,this)})),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,a.DirtyState.HIGHLIGHT))}removeObjectState(e){this.renderGeometries.forEach((t=>e.removeByObject(t)))}updateHighlights(e){}removeRenderGeometryObjectState(e,t){t.channel===n.Object3DState.Highlight&&(e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries([e],a.DirtyState.HIGHLIGHT))}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.geometry.computeAttachmentOrigin(h)&&(e.draped.origin[0]+=h[0],e.draped.origin[1]+=h[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,o,n){r.empty(n);for(let t=0;t<this.renderGeometries.length;t++){const o=this.renderGeometries[t];this._getRenderGeometryProjectedBoundingRect(o,e,d,i),r.expandWithRect(n,d)}if(t){let e;r.center(n,h);const i=s.demResolutionForBoundingBox(n,t.service.spatialReference,t);try{e=await t.service.queryElevation(h[0],h[1],o,i,"ground")}catch(e){}null!=e&&(n[2]=Math.min(n[2],e),n[5]=Math.max(n[5],e))}return n}_getRenderGeometryProjectedBoundingRect(e,t,i,o){if(this.boundingBox)r.set(c,this.boundingBox);else{const t=e.boundingSphere,i=t[3];c[0]=t[0]-i,c[1]=t[1]-i,c[2]=t[2]-i,c[3]=t[0]+i,c[4]=t[1]+i,c[5]=t[2]+i}return t(c,0,2),this.calculateRelativeScreenBounds&&o.push({location:r.center(c),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),r.toRect(c,i)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));