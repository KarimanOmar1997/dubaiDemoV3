// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../Color","../../../../core/has","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../renderers/support/RenderingInfo","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DGraphicCreationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DObjectMetadata","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","./SymbolComplexity","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/LineCalloutMaterial","../../webgl-engine/lib/IntersectableGeometry"],(function(e,t,n,r,a,i,o,s,l,c,h,d,p,u,y,f,m,b,g,x,v,C,O){"use strict";class E extends y.Graphics3DSymbolLayer{static{this.elevationModeChangeTypes={definedChanged:c.SymbolUpdateType.UPDATE,staysOnTheGround:c.SymbolUpdateType.UPDATE,onTheGroundChanged:c.SymbolUpdateType.RECREATE}}constructor(e,t){super(e,null,t,_),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new C.LineCalloutMaterial(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new C.Parameters,a=this.symbol,o=a.callout;if(o.color){const n=t.toUnitRGBA(o.color);n[3]*=this._getLayerOpacity(),e.color=n}else e.color=i.ZEROS;if(e.size=r.pt2px(o.size||0),a.verticalOffset){const{screenLength:t,minWorldLength:n,maxWorldLength:i}=a.verticalOffset;e.verticalOffset={screenLength:r.pt2px(t),minWorldLength:n||0,maxWorldLength:null!=i?i:1/0}}e.borderColor=null!=o.border?.color?t.toUnitRGBA(o.border.color):null;const s="object"===a.symbolLayers.at(0).type,l="label-3d"===a.type;return e.occlusionTest=!s&&!n("enable-feature:non-occluded-hud"),s&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=l,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return G}createGraphics3DGraphic(e,t){const n=e.renderingInfo,r=e.graphic,a=this.setGraphicElevationContext(r,new h.ElevationContext,n.elevationOffset||0),i=n.symbol,o="on-the-ground"===this._elevationContext.mode&&("cim"===i.type||!i.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==i.type&&o)return null;if("point-3d"===i.type&&i.symbolLayers.every((e=>"text"===e.type&&!s.textSymbolLayerSupportsVerticalOffset(e))))return null;const l=f.computeCentroid(r.geometry);return null==l?null:this._createAs3DShape(l,a,n,r.uid,t)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,n){const r=this._elevationContext.mode,a=c.elevationModeChangeUpdateType(E.elevationModeChangeTypes,n,r);return a!==c.SymbolUpdateType.UPDATE||e?.forEach((e=>{const n=t(e);null!=n&&this.updateGraphicElevationContext(e.graphic,n)})),a}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,n=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(n),t}updateGraphicElevationContext(e,t){const{elevationContext:n,metadata:r}=t;this.setGraphicElevationContext(e,n,r?.elevationOffset??0),t.needsElevationUpdates=c.needsElevationUpdates2D(n.mode)}computeComplexity(){return new b.SymbolComplexity({verticesPerFeature:6})}_getOrCreateMaterial(e,t){const n=this._perInstanceMaterialParameters(e),r=C.uniqueMaterialIdentifier(n);if(r===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let e=t.get(r);return null==e&&(e=new C.LineCalloutMaterial(n,this._context.spherical),t.set(r,e)),e}return new C.LineCalloutMaterial(n,this._context.spherical)}_createAs3DShape(e,t,n,r,a){const i=this._context.layerViewUid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerViewUid:i}),s=this._getOrCreateMaterial(n,a),h=new x.Geometry(s,function(e){const{translation:t,centerOffset:n}=e,r=t?new g.Attribute([t[0],t[1],t[2]],S,3,!0):new g.Attribute([0,0,0],S,3,!0),a=n?new g.Attribute([n[0],n[1],n[2],n[3]],S,4,!0):new g.Attribute([0,0,0,1],S,4,!0);return[[v.VertexAttribute.POSITION,r],[v.VertexAttribute.NORMAL,new g.Attribute([0,0,1],S,3,!0)],[v.VertexAttribute.CENTEROFFSETANDDISTANCE,a]]}(n),null,O.GeometryType.Point,o),d=m.createStageObject(this._context,e,h,t,r);if(null==d)return null;const y=new p.Graphics3DObject3DGraphicLayer(this,d.object,null,l.perObjectElevationAligner,t);return y.metadata=new u.Graphics3DObjectMetadata(n.elevationOffset),y.alignedSampledElevation=d.sampledElevation,y.needsElevationUpdates=c.needsElevationUpdates2D(t.mode),m.extendPointGraphicElevationContext(y,e,this._context.elevationProvider),y}}const S=[0],G={mode:"relative-to-ground",offset:0},_={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class P extends o.RenderingInfo{constructor(e,t,n=a.create(),r=i.create(),o=0,s="world",l=0){super(e,t),this.translation=n,this.centerOffset=r,this.horizontalScreenOffset=o,this.centerOffsetUnits=s,this.elevationOffset=l}}class A extends d.Graphics3DGraphicCreationContext{}e.Graphics3DLineCalloutSymbolLayer=E,e.LineCalloutCreationContext=A,e.LineCalloutSymbolLayerRenderingInfo=P,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));