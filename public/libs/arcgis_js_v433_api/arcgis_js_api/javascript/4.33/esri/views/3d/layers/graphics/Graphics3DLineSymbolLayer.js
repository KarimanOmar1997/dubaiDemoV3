// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../Color","../../../../core/Error","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/Extent","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingBox","../../../../renderers/support/renderingInfoUtils","./ElevationAligners","./elevationAlignmentUtils","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayer","./interfaces","./lineUtils","../support/FastSymbolUpdates","../../support/debugFlags","../../support/engineContent/line","../../support/renderInfoUtils/line","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/LineMarkerMaterial","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/RibbonLineMaterial"],(function(e,t,r,a,i,s,n,l,o,p,c,h,y,m,d,u,g,f,_,b,L,M,k,C,v,P,R,S){"use strict";const E=["polyline","polygon","extent"];class A extends u.Graphics3DSymbolLayer{static{this.elevationModeChangeTypes={definedChanged:y.SymbolUpdateType.RECREATE,staysOnTheGround:y.SymbolUpdateType.NONE,onTheGroundChanged:y.SymbolUpdateType.RECREATE}}constructor(e,t,r,a){super(e,t,r,a,function(e){return 1===(e.material?.color?.a??1)&&1===(e.marker?.color?.a??1)}(t))}async doLoad(){if(this._fastUpdates=_.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastMarkerUpdates=_.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(!0)),!this._drivenProperties.size&&(null!=this.symbolLayer.size?this.symbolLayer.size:a.px2pt(1))<0)throw new r("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")}_getMaterialParameters(e,t=!1){const r=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);this._patternHidesLine&&!t&&(r[3]=0);const a={width:this._computeMaterialWidth(this.symbolLayer?.size),color:r,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:f.parseCapType(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:R.getStipplePatternForLinePattern(this.symbolLayer.pattern)};return t&&this._fastMarkerUpdates?.visualVariables?{...a,...this._fastMarkerUpdates.materialParameters}:this._fastUpdates?.visualVariables?{...a,...this._fastUpdates.materialParameters}:a}get _materialColor(){return this.symbolLayer.material?.color}get _markerColor(){return this.symbolLayer.marker?.color}get _lineMaterial(){return null==this._materials[x.Line]&&(this._materials[x.Line]=new S.RibbonLineMaterial(this._getMaterialParameters(!1))),this._materials[x.Line]}get _ringMaterial(){return null==this._materials[x.Ring]&&(this._materials[x.Ring]=new S.RibbonLineMaterial(this._getMaterialParameters(!0))),this._materials[x.Ring]}get _wireframeLineMaterial(){return null==this._materials[x.LineWireframe]&&(this._materials[x.LineWireframe]=new S.RibbonLineMaterial({...this._getMaterialParameters(!1),wireframe:!0})),this._materials[x.LineWireframe]}get _wireframeRingMaterial(){return null==this._materials[x.RingWireframe]&&(this._materials[x.RingWireframe]=new S.RibbonLineMaterial({...this._getMaterialParameters(!0),wireframe:!0})),this._materials[x.RingWireframe]}get _markerMaterial(){return null==this._materials[x.Marker]&&null!=this.symbolLayer.marker&&(this._materials[x.Marker]=new P.LineMarkerMaterial({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,markerPrimitive:f.parseLineMarkerStyle(this.symbolLayer.marker.style)})),this._materials[x.Marker]}_getDrivenSize(e){if(this._drivenProperties.size){const t=e.size;return null!=t?a.pt2px(c.getDriverAxisSizeValueAny(t)):this._getFallbackSize()}return 1}_getDrivenColor({color:e,opacity:t}){const r=n.fromValues(1,1,1,1);return this._drivenProperties.color&&s.copy(r,e??this._getFallbackOpacityAndColor()),this._drivenProperties.opacity&&(r[3]=t??this._getFallbackOpacity()),r}_getDrivenMarkerColor({color:e,opacity:t}){const r=n.ones();return this._drivenProperties.color&&s.copy(r,e??this._getFallbackMarkerOpacityAndColor()),this._drivenProperties.opacity&&(r[3]=t??this._getFallbackMarkerOpacity()),r}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,E,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.draped?this._createAsOverlay(e):this._createAs3DShape(e,r,t.uid)}applyRendererDiff(e,t){for(const r in e.diff){if("visualVariables"!==r)return g.ApplyRendererDiffResult.RecreateSymbol;{const e=this._fastUpdates;if(!_.updateFastSymbolUpdatesState(e,t,this._fastVisualVariableConvertOptions()))return g.ApplyRendererDiffResult.RecreateSymbol;for(const t of this._materials)t instanceof S.RibbonLineMaterial&&t.setParameters(e.materialParameters);const r=this._fastMarkerUpdates,a=!0;if(!_.updateFastSymbolUpdatesState(r,t,this._fastVisualVariableConvertOptions(a)))return g.ApplyRendererDiffResult.RecreateSymbol;for(const e of this._materials)e instanceof P.LineMarkerMaterial&&e.setParameters(r.materialParameters)}}return g.ApplyRendererDiffResult.FastUpdate}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff,r={};"complete"===t.size?.type&&(r.width=this._computeMaterialWidth(t.size.newValue),delete t.size),"complete"===t.cap?.type&&(r.cap=f.parseCapType(t.cap.newValue??"butt"),delete t.cap);const a=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,a),e.symbolLayerStatePatches.push((()=>{for(const e of this._materials)e?.setParameters(r)}))}layerOpacityChanged(){for(const e of this._materials)this._updateMaterialLayerOpacity(e,e instanceof P.LineMarkerMaterial)}_updateMaterialLayerOpacity(e,t=!1){if(null==e)return;const r=e.parameters.color,a=this.symbolLayer?.material?.color,i=this._patternHidesLine&&!t?0:this._getCombinedOpacity(a),s=n.fromValues(r[0],r[1],r[2],i);e.setParameters({color:s})}layerElevationInfoChanged(e,t,r){const a=this._elevationContext.mode,i=y.elevationModeChangeUpdateType(A.elevationModeChangeTypes,r,a);if(i!==y.SymbolUpdateType.UPDATE)return i;const s=y.needsElevationUpdates2D(a);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};for(const t of this._materials)t?.setParameters(e);return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,r){const a=D(e.graphic.geometry),i="polygon"===a.type?a.rings:a.paths,s=new Array,n=p.create(),l=M.geometryToRenderInfo(a,this._context.elevationProvider,this._context.renderCoordsHelper,t),o="polygon"===a.type?"rings":"paths";this._logGeometryCreationWarnings(l,i,o,"LineSymbol3DLayer");for(let t=0;t<l.lines.length;t++){const i=l.lines[t],o=i.position,c=i.mapPositions;if(null!=this._context.clippingExtent&&(p.fromBuffer(c,n),!p.intersectsClippingArea(n,this._context.clippingExtent)))continue;const h=this._createGeometry("polygon"===a.type?this._ringMaterial:this._lineMaterial,e,o,c,a.type,U.ELEVATED,r);if(s.push(h),b.debugFlags.LINE_WIREFRAMES&&s.push(h.instantiate({material:"polygon"===a.type?this._wireframeRingMaterial:this._wireframeLineMaterial})),null!=this._markerMaterial){const t=h.instantiate({material:this._markerMaterial});t.setAttributeData(v.VertexAttribute.COLOR,this._getDrivenMarkerColor(e.renderingInfo)),s.push(t)}}if(0===s.length)return null;const c=this._context.layerViewUid,m=new k.Object3D({geometries:s,castShadow:!1,layerViewUid:c,graphicUid:r}),u=new d.Graphics3DObject3DGraphicLayer(this,m,null,h.sharedGeometryElevationAligner,t);return u.alignedSampledElevation=l.sampledElevation,u.needsElevationUpdates=y.needsElevationUpdates2D(t.mode),u}_createGeometry(e,t,r,a,i,s,n){const l=s===U.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,o="polygon"===i,p=this._fastUpdates?.visualVariables.color,c=this._fastUpdates?.visualVariables.size,h=this._fastUpdates?.visualVariables.opacity,y=this._context.layerViewUid,m=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerViewUid:y}),d={position:r,size:c?null:this._getDrivenSize(t.renderingInfo),color:p?null:this._getDrivenColor(t.renderingInfo),sizeFeature:c?_.getAttributeValue(c.field,t.graphic):null,colorFeature:p?_.getAttributeValue(p.field,t.graphic):null,opacityFeature:h?_.getAttributeValue(h.field,t.graphic):null};return L.createGeometry(e,{overlayInfo:l,removeDuplicateStartEnd:o,mapPositions:a,attributeData:d},m)}_createAsOverlay(e){const t=e.graphic,r=D(t.geometry),a="polygon"===r.type?r.rings:r.paths,i="polygon"===r.type?this._ringMaterial:this._lineMaterial;i.renderPriority=this._renderPriority;const s=b.debugFlags.LINE_WIREFRAMES?"polygon"===r.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,n=this._markerMaterial;null!=s&&(s.renderPriority=this._renderPriority-.001),null!=n&&(n.renderPriority=this._renderPriority-.002);const l=new Array,o=p.create(),c=p.empty(),h=M.geometryToRenderInfoDraped(r,this._context.overlaySR),y="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(h,a,y,"LineSymbol3DLayer");for(const a of h.lines){if(p.fromBuffer(a.position,o),!p.intersectsClippingArea(o,this._context.clippingExtent))continue;p.expandWithAABB(c,o);const h=i=>{const s=this._createGeometry(i,e,a.position,void 0,r.type,U.DRAPED,t.uid),n=this._context.layerViewUid,o=new C.RenderGeometry(s,{layerViewUid:n,graphicUid:t.uid});l.push(o)};if(null!=n){h(n);const e=this.symbolLayer.marker.placement;"begin"!==e&&"begin-end"!==e||p.expandWithBuffer(o,a.position,0,1),"end"!==e&&"begin-end"!==e||p.expandWithBuffer(o,a.position,a.position.length-3,1)}h(i),b.debugFlags.LINE_WIREFRAMES&&h(s)}return new m.Graphics3DDrapedGraphicLayer(this,l,c,this._context.drapeSourceRenderer)}get _patternHidesLine(){const e=this.symbolLayer.pattern;return null!=e&&"style"===e.type&&"none"===e.style}_computeMaterialWidth(e){return e=e??a.px2pt(1),this._drivenProperties.size?this._fastUpdates?.visualVariables.size?a.pt2px(1):1:a.pt2px(e)}_prepareMaterialPatch(e,t,r){const a=t.material;if(null==a)return void(r.changed&&r.useMaterialColor&&w(this._getCombinedOpacityAndColor(this._materialColor),this._materials[x.Marker],e));if("collection"===a.type)return;const i="complete"===a.type?a.newValue?.color:"complete"===a.diff.color?.type?a.diff.color.newValue:null,s=this._getCombinedOpacityAndColor(i);r.useMaterialColor&&w(n.clone(s),this._materials[x.Marker],e),this._patternHidesLine&&(s[3]=0),w(s,this._materials[x.Line],e),delete t.material}_prepareMarkerPatch(e,t){const r=t.marker,a=this._markerMaterial;if(null==r||"partial"!==r.type||null==r.diff||null!=r.diff.placement||null!=r.diff.style&&"complete"!==r.diff.style.type||null!=r.diff.color&&"complete"!==r.diff.color.type||null==a)return{changed:!1,useMaterialColor:null==this._markerColor};const i=r.diff.color,s=null!=i,n=s?i.newValue:null,l=null==n&&null==this._markerColor;n&&w(this._getCombinedOpacityAndColor(n),a,e);const o=r.diff.style?.newValue;return o&&e.symbolLayerStatePatches.push((()=>a.setParameters({markerPrimitive:f.parseLineMarkerStyle(o)}))),delete t.marker,{changed:s,useMaterialColor:l}}_fastVisualVariableConvertOptions(e=!1){const t=this._getFallbackSize();return new _.ConvertOptions({supports:{size:!0,color:!0,rotation:!1,opacity:!0},fallbackColor:e?this._getFallbackMarkerOpacityAndColor():this._getFallbackOpacityAndColor(),fallbackSize:i.fromValues(t,t,t)})}_getFallbackOpacityAndColor(){const e=this.symbolLayer?.material?.color;return t.toUnitRGBA(e)??n.ZEROS}_getFallbackOpacity(){return this.symbolLayer?.material?.color?.a??0}_getFallbackMarkerOpacityAndColor(){const e=this.symbolLayer?.marker?.color;return t.toUnitRGBA(e)??n.ZEROS}_getFallbackMarkerOpacity(){return this.symbolLayer?.marker?.color?.a??0}_getFallbackSize(){const e=this.symbolLayer?.size;return null!=e?a.pt2px(e):1}}function D(e){switch(e.type){case"extent":if(e instanceof l)return o.fromExtent(e);break;case"polygon":case"polyline":return e}return null}function w(e,t,r){null!=t&&r.symbolLayerStatePatches.push((()=>t.setParameters({color:e})))}var U,x;!function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(U||(U={})),function(e){e[e.Line=0]="Line",e[e.Ring=1]="Ring",e[e.LineWireframe=2]="LineWireframe",e[e.RingWireframe=3]="RingWireframe",e[e.Marker=4]="Marker"}(x||(x={})),e.Graphics3DLineSymbolLayer=A,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));