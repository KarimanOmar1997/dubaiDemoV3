// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../Color","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/projection/projectPointToVector","../../../../geometry/support/aaBoundingBox","../../../../symbols/support/materialUtils","../../../../symbols/support/ObjectSymbol3DLayerResource","../../../../symbols/support/symbolLayerUtils3D","./defaultSymbolComplexity","./ElevationAligners","./elevationAlignmentUtils","./Graphics3DLodInstanceGraphicLayer","./Graphics3DSymbolLayer","./graphicUtils","./interfaces","./Loadable","./lodResourceUtils","./objectResourceUtils","./pointUtils","./primitiveObjectSymbolUtils","./SymbolComplexity","./webStyleUtils","../support/FastSymbolUpdates","../../webgl-engine/effects/geometry/olidUtils","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/lib/lodRendering/LodRenderer","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/pbrUtils"],(function(e,t,s,r,i,a,o,n,l,c,h,d,u,p,m,y,f,_,g,b,R,v,x,S,P,L,O,C,E,U,w,T,A,G,B,I){"use strict";class D{constructor(e,t,s,r,i,a,o,n,l,c,h=null){this.lodResources=e,this.lodRenderer=t,this.stageResources=s,this.resourceSize=r,this.isEsriSymbolResource=i,this.isWosr=a,this.resourceBoundingBox=o,this.symbolSize=n,this.extentPadding=l,this.physicalBasedRenderingEnabled=c,this.pivotOffset=h}}class F extends b.Graphics3DSymbolLayer{getCachedSize(){const[e,t,s]=null!=this._resources?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:s}}constructor(e,t,s,r){super(e,t,s,r,function(e){return 1===(e.material?.color?.a??1)&&null==e.resource?.href}(t)),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=s.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size){const e=R.validateSymbolLayerSize(this.symbolLayer);if(e)throw new Error(e)}if(this._isPrimitive){const t=this.symbolLayer.resource,s=t&&O.isValidPrimitive(t?.primitive)?t.primitive:p.defaultPrimitive;this._resources=await this._createResourcesForPrimitive(s,e)}else{const t=await E.getResourceUrlFromSymbolStyle(this.symbol.styleOrigin),s=t?.href??this.symbolLayer.resource?.href;this._resources=await this._createResourcesForUrl(s,e)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.updateComplexity()}get extentPadding(){return null!=this._resources?this._resources.extentPadding:0}get _isPrimitive(){return null!=this._primitive}get lodRenderer(){return this._resources?.lodRenderer}get materials(){return this._resources?.stageResources.materials??[]}async _createResourcesForPrimitive(e,s){const i=this.symbolLayer,a=d.create(m.objectSymbolLayerPrimitiveBoundingBox(e)),c=n.fromArray(d.size(a)),h=n.fromArray(m.objectSymbolLayerSizeWithResourceSize(c,i)),p=o.length(h),y=i?.material,f={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:I.schematicMRRFactors,ambient:n.ONES,diffuse:n.ONES,opacity:1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:i.castShadows,emissiveStrength:y?.emissive?.strength??0,emissiveSource:u.EmissiveSourceMode.Color,offsetTransparentBackfaces:!1,drivenOpacity:this.needsDrivenTransparentPass},_=!!f.usePBR,g=y?.color,b=this.symbol;if("point-3d"===b.type&&b.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=b.verticalOffset;f.verticalOffset={screenLength:r.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},f.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(f.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)f.externalColor=l.ONES;else{const e=null!=g?this._drivenProperties.opacity?l.fromArray([...t.toUnitRGB(g),1]):t.toUnitRGBA(g):this._drivenProperties.opacity?l.ONES:l.ZEROS;f.externalColor=e}this._fastUpdates=U.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(a,h,c,null)),f.isInstanced=!0,this._fastUpdates?(Object.assign(f,this._fastUpdates.materialParameters),this._optionalFields.push(A.VertexAttribute.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(f.hasInstancedColor=!0,this._optionalFields.push(A.VertexAttribute.COLOR)),w.olidEnabled()&&this._optionalFields.push(A.VertexAttribute.OLIDCOLOR);const R=new B.DefaultMaterial(f,this._context);R.setParameters({cullFace:j(R.transparent)});const v=O.primitiveLodResources(e,R);if(!v)throw new Error(`Unknown object symbol primitive: ${e}`);const x=await this._createStageResources(v,_,s),S=await this._createLodRenderer(v,s);return new D(v,S,x,c,!1,!1,a,h,p,_)}async _createResourcesForUrl(e,t){const s={isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},i={spherical:this._context.spherical,materialParameters:s,streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache,compressionOptions:{compressionTracker:this._context.compressionTracker,compressionCallback:()=>this.updateComplexity()}};this._fastUpdates=U.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(i.materialParameters,this._fastUpdates.materialParameters),this._optionalFields.push(A.VertexAttribute.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(i.materialParameters.hasInstancedColor=!0,this._optionalFields.push(A.VertexAttribute.COLOR)),w.olidEnabled()&&this._optionalFields.push(A.VertexAttribute.OLIDCOLOR);const a=this.symbol;if("point-3d"===a.type&&a.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=a.verticalOffset;i.materialParameters.verticalOffset={screenLength:r.pt2px(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},i.materialParameters.castShadows=!1}const l=this._context.physicalBasedRenderingEnabled;i.signal=t,i.usePBR=l,i.skipHighLods=this._context.skipHighSymbolLods;const c=await P.fetch(e,i),h=c.isEsriSymbolResource,u=c.isWosr,p=S.makeLodResources(c.lods),y=this._context,f=this.symbolLayer.material,_=this._getExternalColorParameters(f),g=this.needsDrivenTransparentPass,b=p.getMaterials();b.forEach((e=>{e.setParameters({..._,drivenOpacity:g}),y.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:y.sharedResources.screenSizePerspectiveSettings})}));const R=c.referenceBoundingBox,v=n.fromArray(d.size(R)),x=n.fromArray(p.levels[0].pivotOffset),L=n.fromArray(m.objectSymbolLayerSizeWithResourceSize(v,this.symbolLayer)),O=o.length(L),C=this._fastUpdates;U.updateFastSymbolUpdatesState(C,this._context.renderer,this._fastVisualVariableConvertOptions(R,L,v,x))&&b.forEach((e=>e.setParameters(C.materialParameters)));const E=await this._createStageResources(p,l,t),T=await this._createLodRenderer(p,t);return new D(p,T,E,v,h,u,R,L,O,l,x)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,t,r){const i=this._context.stage,a=e.getMaterials();t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();const o=e.getTextures();i.addTextures(o),this._addDisposeResource((()=>{o.forEach((e=>e.unload())),i.removeTextures(o)})),await Promise.all(o.map((e=>this._context.stage.schedule((()=>e.load(i.renderView.renderingContext)),r)))),s.throwIfAborted(r);const n=e.getEngineGeometries();return{materials:a,textures:o,geometries:n}}async _createLodRenderer(e,t){const s=this._context.stage,r={layerViewUid:this._context.layerViewUid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},a=this._fastUpdates,o=a?{applyTransform:(e,t,s)=>{e.getFeatureAttribute(t,H),i.copy(s,U.evaluateModelTransform(a.materialParameters,H,s))},scaleFactor:(e,t,s)=>{t.getFeatureAttribute(s,H),U.evaluateModelTransformScale(e,a.materialParameters,H)}}:null,n=new G.LodRenderer({symbol:e,optionalFields:this._optionalFields,metadata:r,shaderTransformation:o},this._context.scheduler);return n.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource((()=>{s.removeRenderPlugin(n),n.destroy()})),await s.addRenderPlugin(n,t),n}_getExternalColorParameters(e){const s={};if(this._drivenProperties.color)s.externalColor=l.ONES;else if(null!=e?.color){const r=t.toUnitRGBA(e.color);this._drivenProperties.opacity&&(r[3]=1),s.externalColor=r}else s.externalColor=l.ONES,s.colorMixMode="ignore";return s.emissiveStrength=e?.emissive?.strength??1,s.emissiveSource=u.getEmissiveMode(e?.emissive?.source??"emissive"),s}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach((e=>e())),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const s=L.placePointOnGeometry(t.geometry);if(null==s)return this.logger.warn(`unsupported geometry type for object symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t),i=e.renderingInfo;return this._createAs3DShape(t,s,i,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(null==this._resources)return;const e=this._getLayerOpacity(),t=this._resources.stageResources.materials;for(let s=0;s<t.length;s++){const r=t[s];r.setParameters({layerOpacity:e}),this._isPrimitive&&r.setParameters({cullFace:j(r.transparent)})}}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,_.needsElevationUpdates3D)}slicePlaneEnabledChanged(){if(null==this._resources)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(null==this._resources)return!0;const{stageResources:e,isWosr:t}=this._resources;for(const s of e.materials)this._isPrimitive?s.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||s.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(e,t){if(null==this._resources)return v.ApplyRendererDiffResult.RecreateSymbol;const{stageResources:{materials:s},lodRenderer:r,resourceBoundingBox:i,symbolSize:a,resourceSize:o,pivotOffset:n}=this._resources;for(const l in e.diff){if("visualVariables"!==l)return v.ApplyRendererDiffResult.RecreateSymbol;if(!U.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions(i,a,o,n)))return v.ApplyRendererDiffResult.RecreateSymbol;for(const e of s)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return v.ApplyRendererDiffResult.FastUpdate}computeComplexity(){if(null==this._resources)return super.computeComplexity();const e=this._resources.lodResources,t=y.estimateNumVerticesForLods(e.levels),s=e.computeUsedMemory(),r={...y.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer),resourceBytes:s};return new C.SymbolComplexity({verticesPerFeature:t,memory:r})}_hasLodRenderer(){return null!=this._resources}_createAs3DShape(e,t,s,r,i){if(!this._hasLodRenderer()||null==this._resources)return null;const a=this.getFastUpdateAttrValues(e),o=this._context.clippingExtent;if(h.projectPointToVector(t,k,this._context.elevationProvider.spatialReference),null!=o&&!d.containsPoint(o,k))return null;const n=V(r),l=this._computeGlobalTransform(t,r,W,N),c=this._computeLocalTransform(this._resources,this.symbolLayer,s,M),u=this._resources.lodRenderer.instanceData,p=u.addInstance();if(this._instanceIndexToGraphicUid.set(p,i),u.setLocalTransform(p,c,!1),u.setGlobalTransform(p,l),a&&u.setFeatureAttribute(p,a),null==this._fastUpdates&&this._hasPerInstanceColor()){const e=this._getVertexOpacityAndColor(s,this._getFallbackOpacityAndColor(),255);u.setColor(p,e)}const m=this._context.stage.renderView.olidRenderHelper;if(m){const e=m.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid});u.setObjectAndLayerIdColor(p,e)}const y=new g.Graphics3DLodInstanceGraphicLayer(this,p,f.perLodInstanceElevationAligner,r,this._context.stage.view.state.highlightOrderMap);return n&&(y.alignedSampledElevation=N.sampledElevation),y.needsElevationUpdates=_.needsElevationUpdates3D(r.mode),L.extendPointGraphicElevationContext(y,t,this._context.elevationProvider),y}_computeGlobalTransform(e,t,s,r){return _.evaluateElevationInfoAtPoint(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),k[0]=e.x,k[1]=e.y,k[2]=r.z,c.computeTranslationToOriginAndRotation(e.spatialReference,k,s,this._context.renderCoordsHelper.spatialReference),s}_computeLocalTransform(e,t,s,r){return i.identity(r),this._applyObjectRotation(s,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,s,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,s){if(this._fastUpdates?.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,a=R.computeObjectScale(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===a[0]&&1===a[1]&&1===a[2]||i.scale(s,s,a)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(null==this._resources)return!0;const s=t&&L.placePointOnGeometry(t);if(null==s)return!1;const r=this.getGeometryElevationMode(t);return e.elevationContext.mode===r&&(this._computeGlobalTransform(s,e.elevationContext,W,N),V(e.elevationContext)&&(e.alignedSampledElevation=N.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,W,!0),L.extendPointGraphicElevationContext(e,s,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(null==this._resources)return;const s=(e,t,s)=>(null!=e&&"complete"===e.type?e.newValue:t)??s,r=s(t.heading,this.symbolLayer.heading,0),i=s(t.tilt,this.symbolLayer.tilt,0),a=s(t.roll,this.symbolLayer.roll,0),o=s(t.width,this.symbolLayer.width,void 0),l=s(t.height,this.symbolLayer.height,void 0),c=s(t.depth,this.symbolLayer.depth,void 0),h=s(t.anchor,this.symbolLayer.anchor,void 0),d=s(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const u={heading:r,tilt:i,roll:a,anchor:h,anchorPosition:d},p=this._resources;this.loadStatus===x.LoadStatus.LOADED&&e.symbolLayerStatePatches.push((()=>{p.symbolSize=n.fromArray(m.objectSymbolLayerSizeWithResourceSize(p.resourceSize,{width:o,height:l,depth:c,isPrimitive:this._isPrimitive}))})),e.graphics3DGraphicPatches.push((({instanceIndex:e},t)=>{const s=this._computeLocalTransform(p,u,t,M);p.lodRenderer.instanceData.setLocalTransform(e,s,!0)}))}_preparePatchColor(e,s){if(!s.material||"partial"!==s.material.type)return;const r=s.material.diff;if(!r.color||"complete"!==r.color.type||null==r.color.newValue||null==r.color.oldValue)return;const i=r.color.newValue,a=null!=i?t.toUnitRGBA(i):l.ONES;delete r.color;const o=this._resources;if(null==o)return;const n=this._isPrimitive;e.graphics3DGraphicPatches.push((({instanceIndex:e})=>{if(this._hasPerInstanceColor())o.lodRenderer.instanceData.setColor(e,a);else{const e={externalColor:a};for(const t of o.stageResources.materials)t.setParameters(e),n&&t.setParameters({cullFace:j(t.transparent)})}}))}_applyObjectRotation(e,t,s){if(!this._fastUpdates?.requiresShaderTransformation||!t)return R.computeObjectRotation(e.heading,e.tilt,e.roll,s)}_applyAnchor(e,t,s){if(this._fastUpdates?.requiresShaderTransformation)return;const r=z(e.resourceBoundingBox,e.pivotOffset,t);r&&i.translate(s,s,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,s,r){const i=null!=e?n.fromArray(d.size(e)):n.ONES,a=null!=e?z(e,r,this.symbolLayer):n.ZEROS,o=this._context.renderCoordsHelper.unitInMeters,l=R.computeObjectScale(null!=t?t:void 0,t,s,o),c=n.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new U.ConvertOptions({supports:{size:!0,color:!0,rotation:!0,opacity:!1},modelSize:i,symbolSize:t??n.ONES,unitInMeters:o,anchor:a,scale:l,rotation:c,fallbackColor:this._getFallbackOpacityAndColor(),fallbackSize:l})}get _primitive(){const{resource:e}=this.symbolLayer;return null!=e?.href?null:e?.primitive??p.defaultPrimitive}_getFallbackOpacityAndColor(){const e=this.symbolLayer.material?.color;return null==e?null==this._primitive?l.ONES:l.ZEROS:t.toUnitRGBA(e)}}function z(e,t,s){const r=n.create();switch(s.anchor){case"center":o.copy(r,d.center(e)),o.negate(r,r);break;case"top":{const t=d.center(e);o.set(r,-t[0],-t[1],-e[5]);break}case"bottom":{const t=d.center(e);o.set(r,-t[0],-t[1],-e[2]);break}case"relative":{const t=d.center(e),i=d.size(e),a=s.anchorPosition,l=a?n.fromValues(a.x,a.y,a.z):n.ZEROS;o.multiply(r,i,l),o.add(r,r,t),o.negate(r,r);break}default:null!=t?o.negate(r,t):o.copy(r,n.ZEROS)}return r}function V(e){return"absolute-height"!==e.mode}function j(e){return e?T.CullFaceOptions.None:T.CullFaceOptions.Back}const k=n.create(),M=a.create(),W=a.create(),H=l.create(),N=new _.SampleElevationInfo;e.Graphics3DObjectSymbolLayer=F,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));