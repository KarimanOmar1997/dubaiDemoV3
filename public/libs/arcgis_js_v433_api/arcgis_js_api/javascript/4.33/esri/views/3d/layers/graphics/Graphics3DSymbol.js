// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/has","../../../../core/promiseUtils","./defaultSymbolComplexity","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCreationContext","./interfaces","./Loadable","./symbolMemory"],(function(e,t,s,r,a,o,i,l,n,y,h,c,u){"use strict";class d extends c.Loadable{set symbol(e){this._symbol=e,e.symbolLayers.forEach(((t,s)=>{const r=this.symbolLayers[s];null!=r&&(r.symbol=e,r.symbolLayer=t)}))}get symbol(){return this._symbol}constructor(e,t,s){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=s,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(t){let s=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(s=this._backgroundLayers.concat(s));const a=s.length;for(;this.symbolLayers.length<s.length;)this.symbolLayers.push(null);this.symbolLayers.length=s.length;const i=[];if(!p){const{make:t}=await new Promise(((t,s)=>e(["./Graphics3DSymbolLayerFactory"],t,s)));p=t}for(let e=0;e<a;e++){const r=s.at(e);if(!1===r.enabled)continue;m.renderPriority=1-(1+e)/a,m.renderPriorityStep=1/a,m.ignoreDrivers=r.ignoreDrivers;const l=p(this.symbol,r,this._context,m),n=o.onAbortOrThrow(t,(()=>{this.symbolLayers[e]=null,l.destroy()}));n&&i.push(n),this.symbolLayers[e]=l}if(await r.forEach(this.symbolLayers,(async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}})),i.forEach((e=>e.remove())),o.throwIfAborted(t),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((e=>e?.queryForSnapping))}updateFocus(e,t){this.symbolLayers.forEach((s=>s?.updateFocus(e,t)))}createGraphics3DGraphic(e,t){const s=e.graphic,r=this.symbolLayers.map((t=>t?.createGraphics3DGraphic(e)??null)),a=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new l.Graphics3DGraphic(s,t||this,r,e.layer,a)}get complexity(){return i.totalSymbolComplexities(this.symbolLayers.map((e=>null!=e?e.complexity:null)))}globalPropertyChanged(e,t){const s=this.symbolLayers.length;for(let r=0;r<s;r++){const s=this.symbolLayers[r],a=e=>{const t=e.layers[r];return t instanceof n.Graphics3DObject3DGraphicLayer?t:null};if(null!=s&&!s.globalPropertyChanged(e,t,a))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==c.LoadStatus.LOADED?h.ApplyRendererDiffResult.RecreateSymbol:this.symbolLayers.reduce(((s,r)=>s!==h.ApplyRendererDiffResult.RecreateSymbol&&null!=r?Math.min(s,r.applyRendererDiff(e,t)):s),h.ApplyRendererDiffResult.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===c.LoadStatus.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const s=t.symbolLayers.diff;this.symbolLayers.forEach(((t,r)=>{if(null==t)return;const a=s[r];if(a){const s={diff:a,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(s),e.symbolStatePatches.push(...s.symbolLayerStatePatches),s.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const a=e.layers[r];null!=a&&s.graphics3DGraphicPatches.forEach((e=>e(a,t)))}))}}))}updateGeometry(e,t){return this._updateGeometryOrTransform(e,((e,s)=>e.updateGeometry(s,t)))}updateTransform(e,t,s,r){return this._updateGeometryOrTransform(e,((e,a)=>e.updateTransform(a,t,s,r)))}_updateGeometryOrTransform(e,t){for(let s=0;s<this.symbolLayers.length;s++){const r=this.symbolLayers[s];if(null==r)continue;const a=e.layers[s];if(!a||!t(r,a))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const s=this.symbolLayers[t];if(null==s)continue;const r=e.layers[t];null!=r&&s.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=!1,t=!1;for(const s of this.symbolLayers)if(null!=s){if(s.loadStatus===c.LoadStatus.LOADING)return h.FastUpdateStatus.Loading;s.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?h.FastUpdateStatus.Mixed:h.FastUpdateStatus.Fast:e?h.FastUpdateStatus.Slow:h.FastUpdateStatus.Undefined}async queryForSnapping(e,t,r,a){const i=this.symbolLayers.filter(s.isSome).filter((e=>null!=e.queryForSnapping)).map((s=>s.queryForSnapping(e,t,r,a))),l=await Promise.all(i);return o.throwIfAborted(a),l.flat()}destroy(){if(!this.destroyed){super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get cachedMemory(){return u.getSymbolMemorySize(this)}}let p=null;const m=new y.Graphics3DSymbolLayerCreationContext;t.Graphics3DSymbol=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));