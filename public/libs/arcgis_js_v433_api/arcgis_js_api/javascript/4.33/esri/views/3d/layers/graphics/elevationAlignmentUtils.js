// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/projection/projectBuffer","../../../../layers/graphics/dehydratedFeatureUtils","../../support/ElevationProvider","../../webgl-engine/lib/VertexAttribute"],(function(e,t,n,o,r,i,a,l,s){"use strict";function u(e,t,n,o,r){const i=(a.isDehydratedPoint(e)?e.z:l.isSamplePosition(e)?e.array[e.offset+2]:e[2])||0;switch(n.mode){case"on-the-ground":{const n=l.getElevationAtPoint(t,e,"ground")??0;return r.verticalDistanceToGround=0,r.sampledElevation=n,void(r.z=n)}case"relative-to-ground":{const a=l.getElevationAtPoint(t,e,"ground")??0,s=n.geometryZWithOffset(i,o);return r.verticalDistanceToGround=s,r.sampledElevation=a,void(r.z=s+a)}case"relative-to-scene":{const a=l.getElevationAtPoint(t,e,"scene")??0,s=n.geometryZWithOffset(i,o);return r.verticalDistanceToGround=s,r.sampledElevation=a,void(r.z=s+a)}case"absolute-height":{const a=n.geometryZWithOffset(i,o),s=l.getElevationAtPoint(t,e,"ground")??0;return r.verticalDistanceToGround=a-s,r.sampledElevation=s,void(r.z=a)}default:return void(r.z=0)}}function c(e,t){for(let n=0;n<e.geometries.length;++n){const o=e.geometries[n].getMutableAttribute(s.VertexAttribute.CENTEROFFSETANDDISTANCE);o&&o.data[3]!==t&&(o.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[n],s.VertexAttribute.CENTEROFFSETANDDISTANCE))}}class f{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var d;e.SymbolUpdateType=void 0,(d=e.SymbolUpdateType||(e.SymbolUpdateType={}))[d.NONE=0]="NONE",d[d.UPDATE=1]="UPDATE",d[d.RECREATE=2]="RECREATE";const p={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,n,o,r,i,a,l){const s=l.calculateOffsetRenderUnits(a),u=l.featureExpressionInfoContext;t*=3,o*=3;for(let i=0;i<r;++i){const r=e[t],i=e[t+1],a=e[t+2];n[o]=r,n[o+1]=i,n[o+2]=null==u?a+s:s,t+=3,o+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return 0!==t||null!=n}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,n,o,r,i){let a=0;const l=i.spatialReference;t*=3,o*=3;for(let s=0;s<r;++s){const r=e[t],s=e[t+1],u=e[t+2],c=i.getElevation(r,s,u,l,"ground")??0;a+=c,n[o]=r,n[o+1]=s,n[o+2]=c,t+=3,o+=3}return a/r},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,n,o,r,i,a,l){let s=0;const u=l.calculateOffsetRenderUnits(a),c=l.featureExpressionInfoContext,f=i.spatialReference;t*=3,o*=3;for(let a=0;a<r;++a){const r=e[t],a=e[t+1],l=e[t+2],d=i.getElevation(r,a,l,f,"ground")??0;s+=d,n[o]=r,n[o+1]=a,n[o+2]=null==c?l+d+u:d+u,t+=3,o+=3}return s/r},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,n,o,r,i,a,l){let s=0;const u=l.calculateOffsetRenderUnits(a),c=l.featureExpressionInfoContext,f=i.spatialReference;t*=3,o*=3;for(let a=0;a<r;++a){const r=e[t],a=e[t+1],l=e[t+2],d=i.getElevation(r,a,l,f,"scene")??0;s+=d,n[o]=r,n[o+1]=a,n[o+2]=null==c?l+d+u:d+u,t+=3,o+=3}return s/r},requiresAlignment:()=>!0}},g=n.create(),v=new f,m=o.create();e.SampleElevationInfo=f,e.applyElevationAlignmentForHUD=function(e,n,o,i,a){u(n,o,a,i,v),c(e,v.verticalDistanceToGround);const l=v.sampledElevation,s=t.copy(g,e.transformation);return m[0]=n.x,m[1]=n.y,m[2]=v.z,r.computeTranslationToOriginAndRotation(n.spatialReference,m,s,i.spatialReference)?e.transformation=s:console.warn("Could not locate symbol object properly, it might be misplaced"),l},e.applyPerVertexElevationAlignment=function(e,t,n,o,r,a,l,s,u,c,f){const d=p[f.mode];let g,v,m=0;if(i.projectBuffer(e,t,n,o,u.spatialReference,r,s))return d?.requiresAlignment(f)?(m=d.applyElevationAlignmentBuffer(o,r,a,l,s,u,c,f),g=a,v=l):(g=o,v=r),i.projectBuffer(g,u.spatialReference,v,a,c.spatialReference,l,s)?m:void 0},e.elevationModeChangeUpdateType=function(t,n,o){return"on-the-ground"===n&&"on-the-ground"===o?t.staysOnTheGround:n===o||"on-the-ground"!==n&&"on-the-ground"!==o?null==n||null==o?t.definedChanged:e.SymbolUpdateType.UPDATE:t.onTheGroundChanged},e.evaluateElevationAlignmentAtPoint=function(e,t,n,o){return u(e,t,n,o,v),v.z},e.evaluateElevationInfoAtPoint=u,e.needsElevationUpdates2D=function(e){return"relative-to-ground"===e||"relative-to-scene"===e},e.needsElevationUpdates3D=function(e){return"absolute-height"!==e},e.updateVertexPointGroundDistance=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));