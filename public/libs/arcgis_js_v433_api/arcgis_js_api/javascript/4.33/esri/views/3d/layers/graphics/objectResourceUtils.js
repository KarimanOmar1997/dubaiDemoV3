// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../colorUtils","../../../../core/devEnvironmentUtils","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/FloatArray","../../../../geometry/support/buffer/BufferView","../../../../chunks/vec3","../../../../chunks/vec4","../../../../chunks/vec2","../../glTF/DefaultLoadingContext","../../glTF/internal/indexUtils","../../glTF/internal/resourceUtils","../../glTF/internal/TextureTransformUtils","./ProcessedObjectResource","./wosrLoader","../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Texture","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/pbrUtils"],(function(e,t,r,o,i,n,s,a,l,u,c,d,m,f,g,x,p,T,b,h,w,y,M,R,B,v,A,S,F,V,O,E){"use strict";function C(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}const L=s.create();t.fetch=async function(t,s){const D=C(o.adjustStaticAGOUrl(t));if("wosr"===D.fileType){const e=await(s.cache?s.cache.loadWOSR(D.url,s):R.load(D.url,s)),{engineResources:t,referenceBoundingBox:r}=R.processLoadResult(e,s);return{lods:t,referenceBoundingBox:r,isEsriSymbolResource:!1,isWosr:!0}}let I;if(s.cache)I=await s.cache.loadGLTF(D.url,s,!!s.usePBR);else{const{loadGLTF:t}=await new Promise(((t,r)=>e(["../../glTF/loader"],t,r)));I=await t(new b.DefaultLoadingContext(s.streamDataRequester),D.url,s,s.usePBR)}const P=I.model.meta?.ESRI_proxyEllipsoid,U=I.meta.isEsriSymbolResource&&null!=P&&"EsriRealisticTreesStyle"===I.meta.ESRI_webstyle;U&&!I.customMeta.esriTreeRendering&&(I.customMeta.esriTreeRendering=!0,function(e,t){for(let o=0;o<e.model.lods.length;++o){const i=e.model.lods[o];for(const n of i.parts){const i=n.attributes.normal;if(null==i)return;const s=n.attributes.position,u=s.count,m=d.create(),f=d.create(),x=d.create(),p=new Float32Array(4*u),T=new Float32Array(3*u),b=a.invert(l.create(),n.transform);let h=0,w=0;for(let a=0;a<u;a++){s.getVec(a,f),i.getVec(a,m),c.transformMat4(f,f,n.transform),c.subtract(x,f,t.center),c.divide(x,x,t.radius);const l=x[2],u=c.length(x),d=Math.min(.45+.55*u*u,1)**r.colorGamma;c.divide(x,x,t.radius),null!==b&&c.transformMat4(x,x,b),c.normalize(x,x),o+1!==e.model.lods.length&&e.model.lods.length>1&&(l>-1?c.lerp(x,x,m,.2):c.lerp(x,x,m,Math.min(-4*l-3.8,1))),T[h]=x[0],T[h+1]=x[1],T[h+2]=x[2],h+=3,p[w]=d,p[w+1]=d,p[w+2]=d,p[w+3]=1,w+=4}n.attributes.normal=new g.BufferViewVec3f(T),n.attributes.color=new g.BufferViewVec4f(p)}}}(I,P));const G=!!s.usePBR,N=I.meta.isEsriSymbolResource?{usePBR:G,isSchematic:!1,treeRendering:U,mrrFactors:E.esriSymbologyMRRFactors}:{usePBR:G,isSchematic:!1,treeRendering:!1,mrrFactors:E.advancedMRRFactors},k={...s.materialParameters,treeRendering:U},{engineResources:j,referenceBoundingBox:q}=function(e,t,o,s,a,l){const c=e.model,d=new Array,b=new Map,R=new Map,C=c.lods.length,D=m.empty();return c.lods.forEach(((e,I)=>{const P=!0===s.skipHighLods&&(C>1&&0===I||C>3&&1===I)||!1===s.skipHighLods&&null!=a&&I!==a;if(P&&0!==I)return;const U=new M.ProcessedObjectResource(e.name,e.lodThreshold,[0,0,0]);e.parts.forEach((e=>{const a=P?new O.DefaultMaterial({},s):function(e,t,o,i,n,s,a,l,c){const d=e.materials.get(t.material);if(null==d)return null;const{normal:m,color:f,texCoord0:g,tangent:x}=t.attributes,p=t.material+(m?"_normal":"")+(f?"_color":"")+(g?"_texCoord0":"")+(x?"_tangent":""),T=null!=t.attributes.texCoord0,b=null!=t.attributes.normal,h=function(e){switch(e){case"BLEND":return A.AlphaDiscardMode.Blend;case"MASK":return A.AlphaDiscardMode.Mask;case"OPAQUE":case null:case void 0:return A.AlphaDiscardMode.Opaque}}(d.alphaMode);if(!s.has(p)){if(T){const t=(t,r=!1,o=!1)=>{if(null!=t&&!a.has(t)){const i=e.textures.get(t);if(i){const e=i.data,n=r&&!w.isEncodedMeshTexture(e)?l.compressionOptions:void 0;a.set(t,new F.Texture(w.isEncodedMeshTexture(e)?e.data:e,{...i.parameters,preMultiplyAlpha:!w.isEncodedMeshTexture(e)&&o,encoding:w.isEncodedMeshTexture(e)?e.encoding:void 0,compressionOptions:n}))}}},r=h!==A.AlphaDiscardMode.Opaque&&!c;t(d.colorTexture,r,h!==A.AlphaDiscardMode.Opaque),t(d.normalTexture),t(d.occlusionTexture,!0),t(d.emissiveTexture),t(d.metallicRoughnessTexture,!0)}const o=1/r.colorGamma,m=d.color[0]**o,f=d.color[1]**o,g=d.color[2]**o,x=d.emissiveFactor[0]**o,M=d.emissiveFactor[1]**o,R=d.emissiveFactor[2]**o,v=null!=d.colorTexture&&T?a.get(d.colorTexture):null,S=E.useSchematicPBR(d),V=null!=d.normalTextureTransform?.scale?d.normalTextureTransform?.scale:u.ONES;s.set(p,new O.DefaultMaterial({...i,customDepthTest:A.DepthTestFunction.Lequal,textureAlphaMode:h,textureAlphaCutoff:d.alphaCutoff,diffuse:[m,f,g],ambient:[m,f,g],opacity:"OPAQUE"===d.alphaMode?1:d.opacity,doubleSided:d.doubleSided,doubleSidedType:"winding-order",cullFace:d.doubleSided?A.CullFaceOptions.None:A.CullFaceOptions.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:b?B.NormalType.Attribute:B.NormalType.ScreenDerivative,castShadows:!0,receiveShadows:d.receiveShadows,receiveAmbientOcclusion:d.receiveAmbientOcclusion,textureId:null!=v?v.id:void 0,colorMixMode:d.colorMixMode,normalTextureId:null!=d.normalTexture&&T?a.get(d.normalTexture).id:void 0,textureAlphaPremultiplied:null!=v&&!!v.parameters.preMultiplyAlpha,occlusionTextureId:null!=d.occlusionTexture&&T?a.get(d.occlusionTexture).id:void 0,emissiveTextureId:null!=d.emissiveTexture&&T?a.get(d.emissiveTexture).id:void 0,metallicRoughnessTextureId:null!=d.metallicRoughnessTexture&&T?a.get(d.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[x,M,R],mrrFactors:S?E.schematicMRRFactors:[d.metallicFactor,d.roughnessFactor,i.mrrFactors[2]],isSchematic:S,colorTextureTransformMatrix:y.getTransformMatrix(d.colorTextureTransform),normalTextureTransformMatrix:y.getTransformMatrix(d.normalTextureTransform),scale:[V[0],V[1]],occlusionTextureTransformMatrix:y.getTransformMatrix(d.occlusionTextureTransform),emissiveTextureTransformMatrix:y.getTransformMatrix(d.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:y.getTransformMatrix(d.metallicRoughnessTextureTransform),...n},l))}const M=s.get(p);if(o.stageResources.materials.push(M),T){const e=e=>{null!=e&&o.stageResources.textures.push(a.get(e))};e(d.colorTexture),e(d.normalTexture),e(d.occlusionTexture),e(d.emissiveTexture),e(d.metallicRoughnessTexture)}return M}(c,e,U,t,o,b,R,s,l),{geometry:d,vertexCount:M}=function(e,t){const r=e.attributes.position.count,o=h.convertPrimitiveToTriangles(e.indices||r,e.primitiveType),s=f.newFloatArray(3*r),{typedBuffer:a,typedBufferStride:l}=e.attributes.position;x.transformMat4(s,a,e.transform,3,l);const u=[[V.VertexAttribute.POSITION,new v.Attribute(s,o,3,!0)]];if(null!=e.attributes.normal){const t=f.newFloatArray(3*r),{typedBuffer:s,typedBufferStride:a}=e.attributes.normal;n.normalFromMat4(L,e.transform),x.transformMat3(t,s,L,3,a),i.hasScaling(L)&&x.normalize(t,t),u.push([V.VertexAttribute.NORMAL,new v.Attribute(t,o,3,!0)])}if(null!=e.attributes.tangent){const t=f.newFloatArray(4*r),{typedBuffer:s,typedBufferStride:a}=e.attributes.tangent;n.fromMat4(L,e.transform),p.transformMat3(t,s,L,4,a),i.hasScaling(L)&&x.normalize(t,t,4),u.push([V.VertexAttribute.TANGENT,new v.Attribute(t,o,4,!0)])}if(null!=e.attributes.texCoord0){const t=f.newFloatArray(2*r),{typedBuffer:i,typedBufferStride:n}=e.attributes.texCoord0;T.normalizeIntegerBuffer(t,i,2,n),u.push([V.VertexAttribute.UV0,new v.Attribute(t,o,2,!0)])}const c=e.attributes.color;if(null!=c){const t=new Uint8Array(4*r);4===c.elementCount?c instanceof g.BufferViewVec4f?p.linearToSRGB(t,c,1,255):(c instanceof g.BufferViewVec4u8||c instanceof g.BufferViewVec4u16)&&p.linearToSRGB(t,c,1/255,255):(t.fill(255),c instanceof g.BufferViewVec3f?x.linearToSRGB(t,c.typedBuffer,1,255,4,c.typedBufferStride):(e.attributes.color instanceof g.BufferViewVec3u8||e.attributes.color instanceof g.BufferViewVec3u16)&&x.linearToSRGB(t,c.typedBuffer,1/255,255,4,e.attributes.color.typedBufferStride)),u.push([V.VertexAttribute.COLOR,new v.Attribute(t,o,4,!0)])}return{geometry:new S.Geometry(t,u),vertexCount:r}}(e,a??new O.DefaultMaterial({},s)),C=d.boundingInfo;null!=C&&0===I&&(m.expandWithVec3(D,C.bbMin),m.expandWithVec3(D,C.bbMax)),null!=a&&(U.stageResources.geometries.push(d),U.numberOfVertices+=M)})),P||d.push(U)})),{engineResources:d,referenceBoundingBox:D}}(I,N,k,s,D.specifiedLodIndex,U);return{lods:j,referenceBoundingBox:q,isEsriSymbolResource:I.meta.isEsriSymbolResource,isWosr:!1}},t.parseUrl=C,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));