// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../chunks/tslib.es6","../../../../../../core/uid","../../../../../../core/accessorSupport/decorators/property","../../../../../../core/has","../../../../../../core/Logger","../../../../../../core/RandomLCG","../../../../../../core/accessorSupport/decorators/subclass","../../../../support/buffer/glUtil","../../../../webgl-engine/core/shaderLibrary/ShaderOutput","../../../../webgl-engine/effects/RenderPlugin","../../../../webgl-engine/lib/GLMaterials","../../../../webgl-engine/lib/IntersectorType","../../../../webgl-engine/lib/Object3D","../../../../webgl-engine/lib/RenderSlot","../../../../webgl-engine/materials/DrawParameters","../../../../webgl-engine/materials/HUDMaterial"],(function(e,t,r,i,n,s,a,o,l,u,c,d,h,m,g,f,p){"use strict";e.DirectRenderer=class extends c.SyncRenderPlugin{constructor(e){super(e),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new f.DrawParameters,this._bufferWriter=null,this.slicePlaneEnabled=!1,this.isGround=!1,this.type=e.material instanceof p.HUDMaterial?h.IntersectorType.HUD:h.IntersectorType.OBJECT,this.layerViewUid=e.layerViewUid}get produces(){return this._produces}get numFeatures(){let e=0;return this._renderGeometries.forEach((t=>e+=t.numElements/6)),e}get usedMemory(){let e=0;return this._renderGeometries.forEach((t=>{e+=t.vao.usedMemory})),e}intersect(e,t,i,n){const{material:s,_bufferWriter:a,layerViewUid:o,_renderGeometries:l}=this;null!=a.intersect&&l.forEach((({buffer:t,localOrigin:l,items:u})=>a.intersect(t.data,s.parameters,l,e,i,n,((t,i,n,a)=>{if(!u.visibilities[n])return;const l=u.objectIds[n];e.handleObjectIntersection({object:{id:r.nullUid,graphicUid:l,layerViewUid:o,boundingVolumeWorldSpace:new m.BoundingVolume,geometries:[{material:s}]},geometryId:0,primitiveIndex:n},t,i,null,a)}))))}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>t!==u.ShaderOutput.Highlight&&t!==u.ShaderOutput.ShadowHighlight&&e(t)))}))}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const t of e)this.removeRenderGeometryBuffer(t)}acquireTechniques(e){const t=this.material;if(!t.shouldRender(e))return null;const{output:r,bind:i}=e,n=t.produces.get(i.slot);if(!n?.(r))return null;if(r===u.ShaderOutput.Highlight||r===u.ShaderOutput.ShadowHighlight)return null;const s=this._glMaterials.load(e.rctx,i.slot,r);return s?.beginSlot(i)}render(e,t){const r=this._renderGeometries;if(0===r.size)return;const{bind:i}=e,n=i.slot===g.RenderSlot.OCCLUDER_MATERIAL||i.slot===g.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL?i.slot:null,s=e.rctx;s.runAppleAmdDriverHelper(),s.bindTechnique(t,i,this.material.parameters);const a=t.program;for(const[e,o]of r){const{vao:e,localOrigin:r,drawCalls:l}=o;this._drawParameters.origin=r,a.bindDraw(i,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(e),s.bindVAO(e),s.setPipelineState(t.getPipeline(!1,n));for(const e of l)s.drawArrays(t.primitiveType,e.start,e.count)}}initializeRenderContext(e){this._glMaterials=new d.GLMaterials(this.material,e.materials),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,l.glLayout(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}addRenderGeometryBuffer(e,t,r,i){this.removeRenderGeometryBuffer(e);const{data:n,elementCount:s}=t,a=this._vaoCache.newVao(n.byteLength);a.vertexBuffers.get("geometry").setSubData(new Uint8Array(n),0,0,n.byteLength);const o={localOrigin:i,numElements:s,buffer:t,items:r,vao:a,drawCalls:this._produceDrawCalls(r)};this._renderGeometries.set(e,o)}updateRenderGeometryBuffer(e,t,r,i){const{data:n,elementCount:s}=t,a=this._renderGeometries.get(e);if(null==a)return;this._vaoCache.deleteVao(a.vao);const o=this._vaoCache.newVao(n.byteLength);o.vertexBuffers.get("geometry").setSubData(new Uint8Array(n),0,0,n.byteLength),a.localOrigin=i,a.numElements=s,a.buffer=t,a.items=r,a.vao=o,a.drawCalls=this._produceDrawCalls(r)}removeRenderGeometryBuffer(e){const t=this._renderGeometries.get(e);null!=t&&(this._vaoCache.deleteVao(t.vao),this._renderGeometries.delete(e))}updateVisibility(e,t){const r=this._renderGeometries.get(e);if(null==r)return;const{items:i}=r;if(i.visibilities.length!==t.length)throw new Error("Unexpected mismatch between old and new visibility flag buffer length.");i.visibilities=t,r.drawCalls=this._produceDrawCalls(i)}hasHighlight(){return!1}_produceDrawCalls(e){const{visibilities:t,ranges:r}=e,i=[];if(function(e){return"numItems"in e}(r)){if(0===r.numItems)return[];const e=r.numVertices;let n=null;for(let s=0;s<r.numItems;++s)t[s]?null==n?(n={start:s*e,count:e},i.push(n)):n.count+=e:n=null}else{const e=r.counts,n=e.length;if(0===n)return[];let s=null,a=0;for(let r=0;r<n;++r){const n=t[r],o=e[r];n?null==s?(s={start:a,count:o},i.push(s)):s.count+=o:s=null,a+=o}}return i}},t.__decorate([i.property({constructOnly:!0})],e.DirectRenderer.prototype,"material",void 0),e.DirectRenderer=t.__decorate([o.subclass("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],e.DirectRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));