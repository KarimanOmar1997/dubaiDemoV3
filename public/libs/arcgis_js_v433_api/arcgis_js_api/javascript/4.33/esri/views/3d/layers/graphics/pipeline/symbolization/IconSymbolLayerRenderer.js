// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../Color","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../../../symbols/support/IconSymbol3DLayerResource","../../graphicUtils","../../placementUtils","../PipelineCommand","../featureData/processingUtils","./symbolizationUtils","../../../../support/engineContent/sdfPrimitives","../../../../webgl-engine/lib/Attribute","../../../../webgl-engine/lib/VertexAttribute"],(function(e,t,r,i,n,o,a,l,s,c,d,u,m,y){"use strict";function C(e){return null!=e&&("cross"===e||"x"===e)}function _(e){return e.resource?.href?null:e.resource?.primitive??o.defaultPrimitive}const p={hasIntrinsicColor:!1},h=n.ZEROS;e.IconSymbolLayerRenderer=class{constructor(e,t){this._context=null,this._symbolLayer=null,this._draped=!1,this._loaded=!1,this._loadingPromise=null,this._iconTextureID=null,this._materialId=null,this._context=t,this._symbolLayer=e}get loaded(){return this._loaded}load(){return null==this._loadingPromise&&(this._loadingPromise=this._load()),this._loadingPromise}_destroy(){this._iconTextureID=null}async _load(){const e=this._context.renderCommandContext,t=await e.createTexture((()=>u.createTextureInfo("circle")));this._iconTextureID=t;const r={anchorPosition:l.namedAnchorToHUDMaterialAnchorPos.center,occlusionTest:!0,hasSlicePlane:!1,color:this._getFillColor(),outlineColor:this._getOutlineColor(),outlineSize:1,distanceFieldBoundingBox:u.defaultBoundingBox,textureId:t,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:u.requiresHalfTexelOffset("circle")};this._materialId=await e.createMaterial({type:"hud",parameters:r}),await e.createDirectRenderer(this._materialId),this._loaded=!0}async createAddCommand(e){const{_materialId:t,_context:r}=this,{renderCommandContext:i}=r;if(null==t)throw new Error("expected material not to be null");const n=await this._createGeometry(e);if(null==n)return r.createPipelineCommand();const o=c.computeTileCenterRenderCoordinates(e,r);return r.createPipelineCommand(i.addDirectRendererGeometry(e.id,n,o))}async _createGeometry(e){const{_materialId:t,_context:i}=this,{mainThreadDelegate:n}=i,{featureCount:o}=e;if(0===o||null==t)return null;const a=c.readObjectIds(e),l=c.readMapCoordinates(e),s=await n.applyElevationAlignmentTo(l),u=c.projectToRenderCoordinates(s,i),C=new Float64Array([0,0,1]),_=new Float64Array([255,255,255,255]),p=new Float64Array([24,24]),h=new Float64Array([0,0,0,1]),b=new Float64Array([0,0]),x=new Float64Array([0]),g=new Uint32Array(o);for(let e=0;e<o;++e)g[e]=e;const A=new Uint32Array(o);for(let e=0;e<o;++e)A[e]=0;const f=new m.Attribute(u,g,3,!0),I=new m.Attribute(C,A,3,!0),w=new m.Attribute(b,A,2,!0),O=new m.Attribute(_,A,4,!0),P=new m.Attribute(x,A,1,!0),T=new m.Attribute(p,A,2,!0),D=new m.Attribute(h,A,4,!0),R=[[y.VertexAttribute.POSITION,f],[y.VertexAttribute.NORMAL,I],[y.VertexAttribute.UV0,w],[y.VertexAttribute.COLOR,O],[y.VertexAttribute.ROTATION,P],[y.VertexAttribute.SIZE,T],[y.VertexAttribute.CENTEROFFSETANDDISTANCE,D]],v=new Uint8Array(o);return e.getVisibilityArray(v),{attributes:d.inputAttributesToAttributesMap(R),objectAndLayerIdColor:void 0,transformation:r.create(),materialId:t,objectIds:a,visibilities:v}}async createRemoveCommand(e){const{_materialId:t,_context:r}=this,i=r.renderCommandContext;return null==t?r.createPipelineCommand():r.createPipelineCommand(i.removeDirectRendererGeometryBuffer(t,e))}async createUpdateVisibilityCommand(e){const{_materialId:t,_context:r}=this,i=r.renderCommandContext;if(null==t)return r.createPipelineCommand();const n=new Uint8Array(e.featureCount);return e.getVisibilityArray(n),r.createPipelineCommand(i.updateVisibility(t,e.id,n))}async createUpdateLayerViewOpacityCommand(e){const{_context:t,_materialId:r}=this,i=t.renderCommandContext;return null==r?t.createPipelineCommand():t.createPipelineCommand(i.updateMaterial({type:"hud",materialId:r,parameters:{color:this._getFillColor(),outlineColor:this._getOutlineColor()}}))}async createUpdateElevationCommand(e){const{_materialId:t,_context:r}=this,{renderCommandContext:i}=r,{featureCount:n,id:o}=e;if(null==t||0===n)return r.createPipelineCommand();const a=await this._createGeometry(e);if(null==a)return r.createPipelineCommand();const l=c.computeTileCenterRenderCoordinates(e,r);return r.createPipelineCommand(i.updateDirectRendererGeometry(o,a,l))}async createDestroyCommand(){const{_iconTextureID:e,_context:t}=this,r=t.renderCommandContext;let i;return i=null!=e?await r.releaseTexture(e):s.PipelineCommand.create(r),i.appendPipelineStateCommand((()=>this._destroy())),i}_getOutlineColor(){const e=this._getLayerOpacity(),r=this._symbolLayer,i=r?.outline?.color;if(null!=i){const r=t.toUnitRGB(i),n=i.a*e;return[r[0],r[1],r[2],n]}return[0,0,0,0]}_getFillColor(){if(C(this._getPrimitive()))return h;const e=null==this._getPrimitive(),t=this._symbolLayer?.material?.color;return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getLayerOpacity(){return this._context.layerViewInfo.fullOpacity}_getCombinedOpacity(e,t=p){const r=this._draped?1:this._getLayerOpacity();return e?r*e.a:t.hasIntrinsicColor?r:0}_getCombinedOpacityAndColor(e,r=p){const n=this._getCombinedOpacity(e,r),o=null!=e?t.toUnitRGB(e):i.ONES;return a.mixinColorAndOpacity(o,n)}_getPrimitive(){return _(this._symbolLayer)}},e.defaultMaterialOptions=p,e.getPrimitive=_,e.isOutlineOnly=C,e.transparentUnit=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));