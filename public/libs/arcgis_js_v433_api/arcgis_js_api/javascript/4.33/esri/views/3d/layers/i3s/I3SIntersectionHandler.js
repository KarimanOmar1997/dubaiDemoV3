// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../ViewingMode","./I3SUtil","./Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/IntersectorType","../../webgl-engine/lib/RayIntersections","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,n,i,s,r,l,o,c){"use strict";e.I3SIntersectionHandler=class{constructor(e){this.type=l.IntersectorType.I3S,this._needVerticalOffset=!1,this.layerViewUid=e.layerViewUid,this.sublayerId=e.sublayerId,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}updateElevationAlignState(e,n){this._needVerticalOffset=e&&n===t.ViewingMode.Global}intersect(e,t,l,a,d,u){const b=e.results,y=e.options.store===s.StoreResults.ALL,I=e.ray.direction,f=e.tolerance;let g=e=>e,h=e=>e;const R=c.getVerticalOffsetI3S(e.verticalOffset??(this._needVerticalOffset?0:null));null!=e.verticalOffset&&null!=R&&(g=e=>R.applyToMbs(e),h=e=>R.applyToObb(e));const p=new o.MeshIntersectionOptions(u,e.options.normalRequired);this._traverseNodeHierarchy(((s,o)=>{if(0===s.childrenLoaded)return!1;const c=s.serviceObbInRenderSR?.isValid?s.serviceObbInRenderSR:null;return!(c&&!h(c).intersectRay(l,I,f)||(!o||!c&&n.isValidMbs(s.serviceMbsInRenderSR)&&!function(e,t,n,i=0){const s=e[3]+i,r=t[0]-e[0],l=t[1]-e[1],o=t[2]-e[2],c=n[0],a=n[1],d=n[2],u=c*r+a*l+d*o;return u*u-(c*c+a*a+d*d)*(r*r+l*l+o*o-s*s)>=0}(g(s.serviceMbsInRenderSR),l,I,f)||null!=s.geometryObbInRenderSR&&!h(s.geometryObbInRenderSR).intersectRay(l,I,f)||this._collection.intersect(o,l,a,f,R,p,((n,o,c,d)=>{if(o<0||null!=t&&!t(l,a,o))return;const u=e=>{const t=new i.I3sTarget(this.layerViewUid,this.sublayerId,s.index,n,d);e.set(this.type,t,o,c)};if(this.isGround&&(null==b.ground.distance||o<b.ground.distance)&&u(b.ground),!e.options.isFiltered&&((null==b.min.distance||o<b.min.distance)&&u(b.min),(null==b.max.distance||o>b.max.distance)&&u(b.max),y)){const t=new r.IntersectorResult(e.ray);u(t),e.results.all.push(t)}})),0))}))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));