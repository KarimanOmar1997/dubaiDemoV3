// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../../../core/PooledArray","./I3SNode","../support/I3SLayerView"],(function(e,i,s){"use strict";const t=new e({deallocator:null});return class{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,i,s){this._maxLodLevel=s.maxLodLevel,this._index=i,this._removeNodes=e}shouldLoadNode(e){if(null==e)return!1;const i=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(i)||!!i.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const i=this._layerView.view.resourceController.memoryController.usedMemory,s=Math.max(0,Math.floor(10*(i-1)));t.clear(),this._lodGlobalHandling(this._index.rootNode,s,!1,!!this._layerView.nodeCrossfadingEnabled);const d=t.length;this._removeNodes(t,e);const o=t.length<d;return 0!==t.length&&(this._lodGlobalDirty=!0),t.clear(),o}_lodGlobalHandling(e,d,o,n){if(null==e)return!1;const l=e.index,r=this._index,a=this._layerView,h=r.nodeTraversalState(e),u=this._isChosenMaxLOD(h),c=e.resources.isEmpty;if(u&&c)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const _=a.isNodeLoaded(l);if(n&&_&&u){const i=!o&&this.hasNoVisibleChildren(e);a.fadeNode(l,s.FadeDirection.FadeIn,!i)}const x=_&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(l));if(_&&(a.updateNodeState(l,u?i.NodeState.Leaf:i.NodeState.Hole),u))return x&&this._removeChildrenRecursive(e),x;const L=e.childCount>0;let y=L;if(L)for(let i=0;i<e.childCount;i++){const e=r.getChildIndex(l,i),s=r.getNode(e);null!=s?!r.isGeometryVisible(e)||this._lodGlobalHandling(s,d,o||x,n)||(y=!1):r.isNodeVisible(e)&&(y=!1)}const N=_&&!u&&(y||t.length<d);N&&t.push(l),!n||N||!_||o||y||a.fadeNode(l,s.FadeDirection.FadeIn,!1);const b=e.resources.isEmpty;return y||x&&!N||b}_removeChildrenRecursive(e){this._index.traverseDescendants(e,(e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&t.push(e.index),e.childrenLoaded>0)))}hasNoVisibleChildren(e){let i=!0;return this._index.traverseDescendants(e,(e=>!(!i||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0))),i}_childrenRequireLoading(e){let i=!1,s=!0;return this._index.traverseDescendants(e,(e=>{if(!s||!this._index.isNodeVisible(e.index))return!1;const t=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(t)&&this._index.isGeometryVisible(e.index)&&(i=!0),this._layerView.isNodeLoaded(e.index)?(s=!1,!1):e.childrenLoaded>0})),s&&i}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}}));