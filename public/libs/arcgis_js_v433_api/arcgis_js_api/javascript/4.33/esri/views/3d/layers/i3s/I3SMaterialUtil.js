// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/colorUtils","../../../../core/has","../../../../core/mathUtils","../../../../symbols/support/materialUtils","./enums","../../webgl-engine/core/material/RenderTexture","../../webgl-engine/core/shaderLibrary/util/EllipsoidMode","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Texture","../../webgl-engine/materials/pbrUtils","../../../webgl/enums","../../../../webscene/support/AlphaCutoff"],(function(e,r,a,o,t,s,n,i,l,u,c,d,m){"use strict";function g(e){return e.sort(((e,r)=>e.encoding-r.encoding))}const T={ktx2:s.TextureEncoding.KTX2,basis:s.TextureEncoding.Basis,dds:s.TextureEncoding.DDS_S3TC,png:s.TextureEncoding.PNG,jpg:s.TextureEncoding.JPG,"ktx-etc2":s.TextureEncoding.KTX_ETC2},x={[l.TextureEncodingMimeType.KTX2_ENCODING]:s.TextureEncoding.Basis,[l.TextureEncodingMimeType.BASIS_ENCODING]:s.TextureEncoding.Basis,[l.TextureEncodingMimeType.DDS_ENCODING]:s.TextureEncoding.DDS_S3TC,"image/png":s.TextureEncoding.PNG,"image/jpg":s.TextureEncoding.JPG,"image/jpeg":s.TextureEncoding.JPG,"image/ktx":s.TextureEncoding.KTX_ETC2},p=()=>({alphaMode:"opaque",alphaCutoff:m.alphaCutoff,doubleSided:!0,cullFace:l.CullFaceOptions.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}),h={s:d.TextureWrapMode.CLAMP_TO_EDGE,t:d.TextureWrapMode.CLAMP_TO_EDGE},F={s:d.TextureWrapMode.REPEAT,t:d.TextureWrapMode.REPEAT};e.configureMaterial=function(e,a,o,u,d,g){const T=g.rendererTextureUsage,x=e=>function(e,r,a){if(null==e||a===s.TextureUsage.None)return null;for(let o=0;o<e.length;o++){const t=e[o];if(null!=t&&0!==(t.usage&a)){const e=r[o];return null!=e?e.id:null}}return null}(u,o,e&T),p=r.validateColorAndOpacity(a.metallicRoughness.baseColorFactor);e.baseColor=[p[0],p[1],p[2],p[3]],e.hasParametersFromSource=!!a.hasParametersFromSource,e.usePBR=g.usePBR,e.mrrFactors=[a.metallicRoughness.metallicFactor,a.metallicRoughness.roughnessFactor,a.hasParametersFromSource?c.schematicMRRFactors[2]:c.advancedMRRFactors[2]],e.emissiveBaseColor=a.emissiveFactor,e.emissiveSource=t.EmissiveSourceMode.Emissive,e.isIntegratedMesh=g.isIntegratedMesh,e.textureAlphaCutoff="mask"===a.alphaMode?a.alphaCutoff:m.alphaCutoff,e.alphaDiscardMode="opaque"===a.alphaMode?l.AlphaDiscardMode.Opaque:"mask"===a.alphaMode?l.AlphaDiscardMode.Mask:l.AlphaDiscardMode.MaskBlend;const h=[],F=x(s.TextureUsage.Color|s.TextureUsage.AlphaMask);null!=F&&(e.baseColorTexture=new n.RenderTexture(d,F),h.push(e.baseColorTexture.loadPromise));const f=x(s.TextureUsage.MetallicRoughness);null!=f&&(e.metallicRoughnessTexture=new n.RenderTexture(d,f),h.push(e.metallicRoughnessTexture.loadPromise));const C=x(s.TextureUsage.Emissive);null!=C&&(e.emissionTexture=new n.RenderTexture(d,C),h.push(e.emissionTexture.loadPromise));const E=x(s.TextureUsage.Occlusion);null!=E&&(e.occlusionTexture=new n.RenderTexture(d,E),h.push(e.occlusionTexture.loadPromise));const M=x(s.TextureUsage.Normal);return null!=M&&(e.normalTexture=new n.RenderTexture(d,M),h.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=g.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=a.doubleSided,e.commonMaterialParameters.cullFace=a.cullFace,e.ellipsoidMode=i.getEllipsoidMode(g.viewSpatialReference),Promise.all(h)},e.createTexture=function(e,r,o,t,n,i){if(null==e?.data)return null;const c=e.data,d=t.renderingContext.parameters.maxMaxAnisotropy,m=d>1,g=o||!r.wrapTextures?h:F,T=function(e){switch(e){case s.TextureEncoding.KTX2:return l.TextureEncodingMimeType.KTX2_ENCODING;case s.TextureEncoding.Basis:return l.TextureEncodingMimeType.BASIS_ENCODING;case s.TextureEncoding.DDS_S3TC:return l.TextureEncodingMimeType.DDS_ENCODING;case s.TextureEncoding.PNG:return"image/png";case s.TextureEncoding.JPG:return"image/jpeg";case s.TextureEncoding.KTX_ETC2:return"image/ktx";default:return""}}(e.encoding),x=e.usage&s.TextureUsage.Color?"opaque"===r.alphaMode?3:4:3,p=function(e,r){return!(!a("enable-feature:esri-compress-IM-textures")||0===(e&s.uncompressedFormats)||r&~s.compressibleUsages)}(e.encoding,e.usage)?{compressionTracker:n,compressionCallback:i}:void 0;return new u.Texture(c,{mipmap:m,maxAnisotropy:d,encoding:T,wrap:g,components:x,compressionOptions:p,noUnpackFlip:!0})},e.defaultMaterial=p,e.getMaterialAndTextures=function(e,o,t){const n=new Map,i=(e,r)=>{if(null==e)return-1;const a=n.get(e.id);if(a)return a.usage|=r,a.id;const o=n.size;return n.set(e.id,{id:o,usage:r}),o},u=o.pbrMetallicRoughness,d=u?.baseColorFactor?r.validateColorAndOpacity(u.baseColorFactor):null,m=o.emissiveFactor,x=a("disable-feature:diffuse-rendering-i3s")||t?c.useSchematicPBRI3S({normalTexture:o.normalTexture,emissiveTexture:o.emissiveTexture,emissiveFactor:o.emissiveFactor,occlusionTexture:o.occlusionTexture,metallicRoughnessTexture:u?.metallicRoughnessTexture,metallicFactor:u?.metallicFactor,roughnessFactor:u?.roughnessFactor}):c.useSchematicPBR({normalTexture:o.normalTexture,emissiveTexture:o.emissiveTexture,emissiveFactor:o.emissiveFactor,occlusionTexture:o.occlusionTexture,metallicRoughnessTexture:u?.metallicRoughnessTexture,metallicFactor:u?.metallicFactor,roughnessFactor:u?.roughnessFactor}),p=x?c.schematicMRRFactors[0]:u?.metallicFactor??c.advancedMRRFactors[0],h=x?c.schematicMRRFactors[1]:u?.roughnessFactor??c.advancedMRRFactors[1],F="mask"===o.alphaMode?s.TextureUsage.Color|s.TextureUsage.AlphaMask:s.TextureUsage.Color,f={baseColorFactor:d?[d[0],d[1],d[2],d[3]]:[1,1,1,1],baseColorTextureId:i(u?.baseColorTexture,F),metallicRoughnessTextureId:i(u?.metallicRoughnessTexture,s.TextureUsage.MetallicRoughness),metallicFactor:p,roughnessFactor:h},C={alphaMode:o.alphaMode,alphaCutoff:o.alphaCutoff,doubleSided:o.doubleSided,cullFace:"none"===o.cullFace?l.CullFaceOptions.None:"back"===o.cullFace?l.CullFaceOptions.Back:"front"===o.cullFace?l.CullFaceOptions.Front:l.CullFaceOptions.None,normalTextureId:i(o.normalTexture,s.TextureUsage.Normal),emissiveTextureId:i(o.emissiveTexture,s.TextureUsage.Emissive),occlusionTextureId:i(o.occlusionTexture,s.TextureUsage.Occlusion),emissiveFactor:m?[m[0],m[1],m[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,hasParametersFromSource:x},E=[];return n.forEach((({usage:r},a)=>{const o=null!=e&&e[a]&&e[a].formats,t=o?g(o.map((({name:e,format:r})=>({name:e,encoding:T[r]})))):[];E.push({id:a,usage:r,encodings:t})})),{material:C,textures:E}},e.getMaterialAndTexturesFromShared=function(e){const a=e?.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,t=e?.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,n=a?e.materialDefinitions?.[a]:null,i=t?e.textureDefinitions?.[t]:null,u=p();if(null!=n){const e=n.params;e.diffuse&&(r.validateColor(e.diffuse),u.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(u.doubleSided=e.doubleSided,u.cullFace=e.doubleSided?l.CullFaceOptions.None:l.CullFaceOptions.Back),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(u.cullFace="none"===e.cullFace?l.CullFaceOptions.None:"back"===e.cullFace?l.CullFaceOptions.Back:l.CullFaceOptions.Front),e.transparency&&(u.metallicRoughness.baseColorFactor[3]=o.clamp(1-e.transparency,0,1)),(e.useVertexColorAlpha||u.metallicRoughness.baseColorFactor[3]<1)&&(u.alphaMode="blend")}const c=[];if(null!=i){const e=0;!i.wrap||"repeat"!==i.wrap[0]&&"repeat"!==i.wrap[1]||(u.wrapTextures=!0);let r=s.TextureUsage.Color;"rgba"===i.channels&&(u.alphaMode="blend",r|=s.TextureUsage.AlphaMask);const a=i.images.length-1,o=i.images[a],t=e=>e?.split("/").pop(),n=Array.isArray(i.encoding)?g(i.encoding.map(((e,r)=>({name:t(o.href[r]),encoding:x[e]||0})))):[{name:t(o.href),encoding:x[i.encoding]||0}];c.push({id:e,usage:r,encodings:n}),u.metallicRoughness.baseColorTextureId=e}return{material:u,textures:c}},e.getSupportedEncodings=function(e){const r=!!e.compressedTextureS3TC,o=!!e.compressedTextureETC,t=a("disable-feature:i3s-basis")?0:s.TextureEncoding.Basis|s.TextureEncoding.KTX2,n=s.TextureEncoding.JPG|s.TextureEncoding.PNG,i=t|s.TextureEncoding.DDS_S3TC;return n|(r?i:0)|(o?t:0)},e.selectEncoding=function(e,r){if(null!=r)return e.find((e=>0!==(e.encoding&r)))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));