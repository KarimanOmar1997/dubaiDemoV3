// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybeUpdating","../../../../core/reactiveUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/sql/WhereClause","../../../../geometry/ellipsoidUtils","../../../../geometry/projectionUtils","../../../../geometry/SpatialReference","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/projection/projectVectorToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/DoubleArray","../../../../geometry/support/Ellipsoid","../../../../geometry/support/spatialReferenceUtils","../../../../chunks/sphere","../../../../geometry/support/webMercatorUtils","../../../../layers/support/FeatureFilter","./I3SUtil"],(function(e,t,r,i,n,s,o,a,l,c,p,u,d,g,h,y,f,m,S,w,_,F,R,I,b,v,E,M,j,V){"use strict";t.I3SMeshViewFilter=class extends i{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){l.whenOnce((()=>this.viewFilter?.geometry||null!=this.layerFilter)).then((()=>this.loadAsyncModule(new Promise(((t,r)=>e(["../../../../geometry/geometryEngine"],t,r))).then((e=>{this.destroyed||(this._geometryEngine=e)})))))}get sortedObjectIds(){if(null==this.viewFilter?.objectIds)return null;const e=I.doubleArrayFrom(this.viewFilter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=this.viewFilter?.where;if(null==e||!e)return null;try{return y.create(e,{fieldsIndex:this.layerFieldsIndex})}catch(e){s.getLogger(this).error(`Failed to parse filter where clause: ${e}`)}return null}addFilters(e,t,r,i){const n=this.sortedObjectIds;null!=n&&e.push((e=>V.objectIdFilter(n,!0,e))),this.addSqlFilter(e,this.parsedWhereClause),this.addTimeFilter(e,this.viewFilter?.timeExtent);const o=a.unwrapUpdating(this._layerMaskGeometries),l=this._geometryEngine,c=()=>s.getLogger(this);if(null!=o&&null!=this.layerFilter&&null!=l){const n=this.layerFilter.spatialRelationship;e.push(((e,s)=>A(c,l,e,s,i,t,r,o,n)))}const p=a.unwrapUpdating(this._viewMaskGeometries);if(null!=p&&null!=this.viewFilter&&null!=l){const n=this.viewFilter.spatialRelationship;e.push(((e,s)=>A(c,l,e,s,i,t,r,p,n)))}}isMBSGeometryVisible(e,t,r){const i=a.unwrapUpdating(this._layerMaskGeometries),n=this._geometryEngine;if(null!=i&&null!=this.layerFilter&&null!=n){const o=this.layerFilter.spatialRelationship,a=i[0].spatialReference||t;return w.projectBoundingSphere(e,r,U,a)?G(n,U,i,a,o):(s.getLogger(this).warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}const o=a.unwrapUpdating(this._viewMaskGeometries);if(null!=o&&null!=this.viewFilter&&null!=n){const i=this.viewFilter.spatialRelationship,a=o[0].spatialReference||t;return w.projectBoundingSphere(e,r,U,a)?G(n,U,o,a,i):(s.getLogger(this).warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){const e=a.unwrapUpdating(this._viewMaskGeometries),t=a.unwrapUpdating(this._layerMaskGeometries);return null==e||null==t?e||t:t.concat(e)}get _layerMaskGeometries(){const e=this.layerFilter;return null==e?null:null==this._geometryEngine?a.updating:"disjoint"===e.spatialRelationship?e.geometries.map((e=>({type:"polygon",rings:e.rings,spatialReference:e.spatialReference,cache:{}}))):[e.geometries.reduce(((e,t)=>(e.rings=[...e.rings,...t.rings],e)),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}get _viewMaskGeometries(){if(null==this.viewFilter)return null;const{geometry:e}=this.viewFilter;if(null==e)return null;if(null==this.viewFilter||null==this._geometryEngine)return a.updating;const{distance:t,units:r}=this.viewFilter,i=this.viewFilter.spatialRelationship,n="mesh"===e.type?e.extent:e;if(null==t||0===t)return D(this._geometryEngine,n,i);const o=r||c.getUnitString(n.spatialReference);if(n.spatialReference.isWGS84){const e=this._geometryEngine.geodesicBuffer(n,t,o);return D(this._geometryEngine,e,i)}const l=M.project(n,S.WGS84);if(null!=l){const e=M.project(this._geometryEngine.geodesicBuffer(l,t,o),n.spatialReference);return D(this._geometryEngine,e,i)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(m.load().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let p=null;try{p=m.project(n,S.WGS84)}catch(e){}if(p)try{p=m.project(this._geometryEngine.geodesicBuffer(p,t,o),n.spatialReference)}catch(e){p=null}return p||s.getLogger(this).error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${n.spatialReference.wkid}) to WGS84.`),D(this._geometryEngine,p,i)}get updating(){return a.isUpdating(this._layerMaskGeometries)||a.isUpdating(this._viewMaskGeometries)}static checkSupport(e){return!(null==e||(null==(t=e.spatialRelationship)||!k.includes(t))&&(s.getLogger(this.prototype).warn(`Filters with spatialRelationship other than ${k.join(", ")} are not supported for mesh scene layers`),1));var t}},r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"layerFilter",void 0),r.__decorate([p.property({type:j})],t.I3SMeshViewFilter.prototype,"viewFilter",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"addSqlFilter",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"addTimeFilter",void 0),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"sortedObjectIds",null),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedWhereClause",null),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedGeometry",null),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_layerMaskGeometries",null),r.__decorate([p.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_viewMaskGeometries",null),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"updating",null),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0),r.__decorate([p.property()],t.I3SMeshViewFilter.prototype,"_geometryEngine",void 0),t.I3SMeshViewFilter=r.__decorate([d.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],t.I3SMeshViewFilter);const k=["contains","intersects","disjoint"];var T;function D(e,t,r){if(null==t)return null;if("disjoint"===r&&"polygon"===t.type){const r=t.rings.length,i=t.spatialReference,s=new Array(r);for(let e=0;e<r;++e){const r=R.fromValues(1/0,1/0,-1/0,-1/0);R.expandWithNestedArray(r,t.rings[e]),s[e]={type:"polygon",rings:[t.rings[e]],spatialReference:i,cache:{},aabr:r}}s.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const o=new Set,a=new n.PositionHint;for(let t=0;t<s.length;++t){const r=s[t],i=r.aabr[0];o.forEach((t=>{if(i>=t.aabr[2])return void o.delete(t);if(r.aabr[1]>t.aabr[3]||r.aabr[3]<t.aabr[1]||!e.intersects(r,t))return;r.rings=r.rings.concat(t.rings),R.expand(r.aabr,t.aabr,r.aabr),r.cache={},o.delete(t);const l=n.indexOf(s,t,s.length,a);s.splice(l,1)})),o.add(r)}for(const e of s)e.aabr=void 0;return s}return[t]}function G(e,t,r,i,n){if(t[3]>=.5*(t[2]+f.getReferenceEllipsoid(i).radius))return!0;const s=x(e,t,i);return r.every((t=>C(e,t,s,n)!==T.DISCARD))}function A(e,t,r,i,n,s,o,a,l){const c=a[0].spatialReference||s.spatialReference;if(!w.projectBoundingSphere(i.node.serviceMbsInIndexSR,o,U,c))return void e().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const p=x(t,U,c),u=function(e,t,r,i,n){const s=t.renderSpatialReference,o=new Map,a={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:r};let l,c;switch(a.rings[0][3]=a.rings[0][0],e){case"intersects":l=(e,t,r)=>e.intersects(t,r)?T.KEEP:T.TEST,c=O;break;case"contains":l=(e,t,r)=>e.contains(t,r)?T.TEST:T.DISCARD,c=O;break;default:l=(e,t,r)=>e.disjoint(t,r)?T.TEST:T.DISCARD,c=L}return{collection:i,object:n,type:e,maskSR:r,renderSR:s,aabbCache:o,triangle:a,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:l,geometryTest:c}}(l,s,c,n,i.objectHandle),d="intersects"===l;let g=null;for(const e of a){if(0===r.length)return;switch(C(t,e,p,l)){case T.DISCARD:return d&&(i.weaklyRemovedIds=i.weaklyRemovedIds?.concat(r)??r.slice()),void(r.length=0);case T.KEEP:continue}V.filterInPlace(r,i.featureIds,(r=>!!B(t,e,r,u)||(d&&(g||=[],g.push(i.featureIds[r])),!1)))}g&&(i.weaklyRemovedIds=i.weaklyRemovedIds?.concat(g)??g)}!function(e){e[e.KEEP=0]="KEEP",e[e.DISCARD=1]="DISCARD",e[e.TEST=2]="TEST"}(T||(T={}));const U=E.fromValues(0,0,0,0);function x(e,t,r){const i={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:r},n=!v.isWGS84(r)&&!v.isWebMercator(r),s=Number.isNaN(t[3])?0:o.clamp(t[3],0,2*b.earth.radius),a=n?e.buffer(i,s,1):e.geodesicBuffer(i,s,1);return a.type="polygon",a}function C(e,t,r,i){switch(i){case"intersects":case"contains":return O(e,t,r);case"disjoint":return L(e,t,r)}}function O(e,t,r){return e.intersects(t,r)?e.contains(t,r)?T.KEEP:T.TEST:T.DISCARD}function L(e,t,r){return e.intersects(t,r)?e.contains(t,r)?T.DISCARD:T.TEST:T.KEEP}function B(e,t,r,i){const{collection:n,object:s,renderSR:o,maskSR:a,geometryTest:l,aabbCache:c}=i;let p=c.get(r);if(!p){const e=n.getObjectTransform(s);n.getComponentAabb(s,r,P);const t=[h.fromValues(P[0],P[1],0),h.fromValues(P[0],P[4],0),h.fromValues(P[3],P[4],0),h.fromValues(P[3],P[1],0)];for(let r=0;r<4;++r)g.transformMat3(t[r],t[r],e.rotationScale),g.add(t[r],t[r],e.position),_.projectVectorToVector(t[r],o,t[r],a);p={type:"polygon",rings:[t],spatialReference:a,cache:{}},p.rings[0][4]=p.rings[0][0],c.set(r,p)}switch(l(e,t,p)){case T.DISCARD:return!1;case T.KEEP:return!0}const{triangle:u,triangleTest:d,positions:y}=i,f=u.rings[0][0],m=u.rings[0][1],S=u.rings[0][2],w=n.getObjectTransform(s);n.getComponentPositions(s,r,y);const{indices:F,data:R,stride:I,startIndex:b,endIndex:v}=y;for(let r=b;r<v;r+=3){const i=I*F[r],n=I*F[r+1],s=I*F[r+2];switch(g.set(f,R[i],R[i+1],R[i+2]),g.set(m,R[n],R[n+1],R[n+2]),g.set(S,R[s],R[s+1],R[s+2]),g.transformMat3(f,f,w.rotationScale),g.transformMat3(m,m,w.rotationScale),g.transformMat3(S,S,w.rotationScale),g.add(f,f,w.position),g.add(m,m,w.position),g.add(S,S,w.position),_.projectVectorToVector(f,o,f,a),_.projectVectorToVector(m,o,m,a),_.projectVectorToVector(S,o,S,a),d(e,t,u)){case T.DISCARD:return!1;case T.KEEP:return!0}}return"intersects"!==i.type}const P=F.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));