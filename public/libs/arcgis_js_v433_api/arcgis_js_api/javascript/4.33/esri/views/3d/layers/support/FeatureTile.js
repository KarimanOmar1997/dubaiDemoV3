// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/arrayUtils","../../../../core/memoryEstimations","../../../../core/signal","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../graphics/graphicUtils"],(function(t,e,s,i,a,u,r,h){"use strict";var n,c;t.FetchStatus=void 0,(n=t.FetchStatus||(t.FetchStatus={}))[n.FETCH_NEEDED=0]="FETCH_NEEDED",n[n.REFETCH_NEEDED=1]="REFETCH_NEEDED",n[n.FETCHING=2]="FETCHING",n[n.REFETCHING=3]="REFETCHING",n[n.DONE=4]="DONE",n[n.FULL=5]="FULL",t.ReduceMode=void 0,(c=t.ReduceMode||(t.ReduceMode={}))[c.SIZE=0]="SIZE",c[c.RANDOM=1]="RANDOM";class l{constructor(t,e,i,a){this.features=e,this.numFeatures=i,this.emptyFeatureRatio=a,this.cachedMemory=s.baseObjectMemory+t.estimatedSize,this.resolution=t.displayingResolution,this.availableFields=t.availableFields,this.fetchStatus=t.fetchStatus,this.exceededTransferLimit=t.exceededTransferLimit.value,this.fetchInformation=t.fetchInformation.value}}const d=u.create(),f=a.create();t.FeatureTile=class{constructor(e){this.descriptor=e,this._numVertices=0,this.exceededTransferLimit=i.signal(!1),this._fetchFailed=i.signal(!1),this._sorted=!1,this._numFeatures=i.signal(-1),this._emptyFeatureRatio=i.signal(0),this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._displayingFeatures=null,this.alive=!0,this.filtered=!1,this._features=null,this._featuresLength=i.signal(0),this._featureLimit=i.signal(0),this._fetchStatus=t.FetchStatus.FETCH_NEEDED,this.fetchInformation=i.signal(""),this.fetchingResolution=this.displayingResolution=e.resolution}get featuresMissing(){return this.fetchFailed||(this.hasPreciseFeatureCount?this._featuresLength.value<this.numFeatures:this.exceededTransferLimit.value)}get showsAllFeatures(){return!this.fetchFailed&&null!=this.displayingFeatures&&(this.hasPreciseFeatureCount?this.displayingFeatures.length===this.numFeatures:!this.exceededTransferLimit.value)}get missingAttributes(){return this._missingAttributes}get fetchFailed(){return this._fetchFailed.value}set fetchFailed(t){this._fetchFailed.value=t}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(t){this._displayingFeatures=t,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){const t=this.isFetched&&this.featuresMissing;return!this.filtered&&(t||this.hasFeatureLimit)}get features(){return this._features}get featureLimit(){return this._featureLimit.value}set featureLimit(t){this._featureLimit.value!==t&&(this._featureLimit.value=t,this._estimatedUnusedSizeDirty=!0)}get hasFeatureLimit(){return this.featureLimit!==this._featuresLength.value}get availableFields(){return this._availableFields}setFeatures(t,e,s,i){this._availableFields=s,this._features=t,this._featuresLength.value=t?.length??0,this._sorted=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this._missingAttributes=i,t&&t.length>0?(this._emptyFeatureRatio.value=e/(t.length+e),this._numVertices=t.reduce(((t,e)=>t+r.numVertices(e.geometry)),0)):(this._emptyFeatureRatio.value=0,this._numVertices=0)}computeZQuantizationFactor(){if(this._features&&this._features.length>0){const t=this._features.reduce(((t,{geometry:e})=>Math.max(t,h.computeMaxZ(e)??0)),0);return Math.floor(t/this.descriptor.planetRadius)+1}return 1}get emptyFeatureRatio(){return this._emptyFeatureRatio.value}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures.value:this._features?this._featuresLength.value:0}set numFeatures(t){this._numFeatures.value=t}get hasPreciseFeatureCount(){return this._numFeatures.value>-1}get needsFeatureCount(){return-1===this._numFeatures.value}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let t=0;t<this._features.length;++t){const e=r.estimateSize(this._features[t]);this._estimatedSize+=e,t>=this.featureLimit&&(this._estimatedUnusedSize+=e)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let t=this.featureLimit;t<this._features.length;++t)this._estimatedUnusedSize+=r.estimateSize(this._features[t]);return!0}return!1}get fetchStatus(){return this._fetchStatus}requestFetch(){this._fetchStatus=t.FetchStatus.FETCH_NEEDED}requestRefetch(){this._fetchStatus=t.FetchStatus.REFETCH_NEEDED}startFetch(){this._fetchStatus=this.needsRefetch?t.FetchStatus.REFETCHING:t.FetchStatus.FETCHING}fetchDone(t){this._fetchStatus=t}get isFetching(){return this._fetchStatus===t.FetchStatus.FETCHING||this._fetchStatus===t.FetchStatus.REFETCHING}get isRefetching(){return this._fetchStatus===t.FetchStatus.REFETCHING}get needsFetch(){return this._fetchStatus===t.FetchStatus.FETCH_NEEDED||this._fetchStatus===t.FetchStatus.REFETCH_NEEDED}get needsRefetch(){return this._fetchStatus===t.FetchStatus.REFETCH_NEEDED}get isFetched(){return this._fetchStatus===t.FetchStatus.DONE||this._fetchStatus===t.FetchStatus.FULL}isFullyFetched(e){return!!this.features&&(this.features.length>=e||this.fetchStatus===t.FetchStatus.FULL)}resetFetching(){this._fetchStatus=this.isRefetching?t.FetchStatus.REFETCH_NEEDED:t.FetchStatus.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!function(t,e,s){if(null==e||null==t||s!==e.length||s>t.length)return!1;for(let i=0;i<s;++i)if(t[i]!==e[i])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(t){return null==t||!this.descriptor.extent||(u.fromExtent(t,d),u.intersects(this.descriptor.extent,d))}intersectionIncludingBorrowed(t,e){const s=null!=this.extentIncludingBorrowedFeatures?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return t||s?(null!=t?(u.fromExtent(t,e),u.intersection(e,s,e)):u.copy(e,s),e):(u.copy(e,u.positiveInfinity),e)}_shuffle(t){this._features?.sort(((e,s)=>r.getObjectId(e,t)-r.getObjectId(s,t))),e.shuffle(this._features,16438)}_sortBySize(t){this._features?.sort(((e,s)=>a.diameter(r.computeAABB(s.geometry,f))-a.diameter(r.computeAABB(e.geometry,f))||r.getObjectId(e,t)-r.getObjectId(s,t)))}reduceFeatures(e,s,i,a){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let u=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&this._fetchStatus===t.FetchStatus.DONE&&this._features.length>0&&(this._fetchStatus=t.FetchStatus.REFETCH_NEEDED,u=!0),!this._sorted&&e<1&&(a===t.ReduceMode.RANDOM?this._shuffle(i):this._sortBySize(i),this._sorted=!0,this._estimatedUnusedSizeDirty=!0);const r=Math.max(this.featureLimit,Math.ceil(s*this.numFeatures));return this._features.length>r&&(this._features.length=r,this._featuresLength.value=r,this.exceededTransferLimit.value=!1,this._fetchStatus===t.FetchStatus.FULL&&(this._fetchStatus=t.FetchStatus.DONE)),u}get cache(){return new l(this,this._features,this._numFeatures.value,this._emptyFeatureRatio.value)}set cache(t){this.requestController=null,this._availableFields=t.availableFields,this._features=t.features,this._featuresLength.value=t.features?.length??0,this._numFeatures.value=t.numFeatures,this._emptyFeatureRatio.value=t.emptyFeatureRatio,this._fetchStatus=t.fetchStatus,this.exceededTransferLimit.value=t.exceededTransferLimit,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this.fetchInformation.value=t.fetchInformation}},t.FeatureTileCacheItem=l,t.failedFeatureCount=-2,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));