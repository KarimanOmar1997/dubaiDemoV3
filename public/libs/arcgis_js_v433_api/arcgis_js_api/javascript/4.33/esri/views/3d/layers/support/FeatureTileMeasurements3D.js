// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/frustum","../../../../geometry/support/ray","../../../ViewingMode","./FeatureTileVisibility3D","../../webgl/RenderCamera"],(function(e,t,i,s,o,a,r,n,l){"use strict";const d=[i.create(),i.create(),i.create(),i.create()],c=i.create(),h=i.create(),u=i.create(),m=i.freeze(0,0,1),p=a.fromValues(i.ZEROS,m);e.FeatureTileMeasurements3D=class{constructor(e,t,i){this._renderCoordsHelper=e,this._tilingScheme=t,this._camera=new l,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new n.FeatureTileVisibility3D(e,i)}set opaqueGround(e){this._visibility.opaqueGround=e}setup(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(e){const{measures:t,extent:i,level:o}=e;t.visible=this._visibility.compute(e),t.distance=s.distance(i,this._focusOnMap),t.mergeable=!0,t.lodLevel=n.minTileLOD,t.splitPriority=Math.max(0,n.minTileLOD-o),t.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(e):this._updateSplitAndLodLocal(e))}_updateSplitAndLodGlobal(e){const i=e.level,s=this._renderCoordsHelper,{eye:o,fov:a}=this._camera,r=s.referenceEllipsoid.radius,l=t.len(o)-r;if(2*Math.atan(r/l)<a&&l>0)return void(e.measures.lodLevel=Math.max(i,n.minTileLOD));const h=d,{extent:m}=e,{_surfaceElevation:_}=this;t.set(h[0],m[0],m[1],_),t.set(h[1],m[2],m[1],_),t.set(h[2],m[2],m[3],_),t.set(h[3],m[0],m[3],_);const f=t.set(c,.5*(m[0]+m[2]),.5*(m[1]+m[3]),_),v=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)s.toRenderCoords(h[e],v,h[e]);s.toRenderCoords(f,v,f);const M=t.normalize(p.direction,f),y=t.dot(o,M),b=t.scale(u,M,y);this._updateSplitAndLod(e,h,f,b)}_updateSplitAndLodLocal(e){const i=d,{extent:s}=e,{_surfaceElevation:o}=this;t.set(i[0],s[0],s[1],o),t.set(i[1],s[2],s[1],o),t.set(i[2],s[2],s[3],o),t.set(i[3],s[0],s[3],o);const a=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)this._renderCoordsHelper.toRenderCoords(i[e],a,i[e]);const r=t.set(c,.5*(i[0][0]+i[2][0]),.5*(i[0][1]+i[2][1]),.25*(i[0][2]+i[1][2]+i[2][2]+i[3][2])),n=t.set(h,r[0],r[1],0),{eye:l,far:_}=this._camera,f=t.set(u,n[0],n[1],l[2]);t.set(p.origin,n[0],n[1],l[2]-2*_),t.copy(p.direction,m),this._updateSplitAndLod(e,i,r,f)}_updateSplitAndLod(e,i,s,a){const r=Math.max(t.dist(i[0],i[2]),t.dist(i[1],i[3]),t.dist(i[0],s)+t.dist(s,i[2]),t.dist(i[1],s)+t.dist(s,i[3])),{eye:n,near:l,fov:d,viewForward:c,width:h,height:u,pixelRatio:m,frustum:p}=this._camera,_=t.dot(n,c),f=t.dot(s,c)-_,v=t.dist(s,n);let M=f,y=f,b=v,g=v;const L=(e,t)=>t<l?1:Math.sqrt(e*e-t*t)/t;let x=L(v,f);for(const e of i){const i=t.dot(e,c)-_;M=Math.min(M,i),y=Math.max(y,i);const s=t.dist(e,n);g=Math.max(g,s),b=Math.min(b,s);const o=L(s,i);x=Math.min(x,o)}if(y<l)return void(e.measures.lodLevel=0);const S=Math.cos(.5*d),w=t.dist(n,a);x>S&&w>.5*r&&(y=2*g,M=2*b);const O=.5*Math.sqrt(h*h+u*u)/m,P=2*Math.tan(.5*d),R=e=>312*Math.max(l,e)/O*P,C=e.level,A=r*2**C*Math.max(1,P),G=R(M),T=Math.ceil(Math.log2(Math.max(1,A/G)));if(e.measures.lodLevel=Math.max(T,e.measures.lodLevel),e.measures.splitPriority+=e.measures.lodLevel-C,C<T){const t=+o.intersectsPoint(p,i[0])+ +o.intersectsPoint(p,i[1])+ +o.intersectsPoint(p,i[2])+ +o.intersectsPoint(p,i[3]);e.measures.splitPriority+=t}const D=R(y)/G;D>2.5&&(e.measures.splitPriority+=D)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===r.ViewingMode.Global}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));