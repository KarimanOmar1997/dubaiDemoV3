// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Collection","../../../../core/handleUtils","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/PooledArray","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/aaBoundingRect","./FeatureTileDescriptor","./FeatureTileMeasurements3D","./FeatureTileVisibility3D","../../support/extentUtils","../../../support/Scheduler"],(function(e,t,i,r,s,l,n,o,a,u,c,d,h,p,_,T,m,g,y,f,v){"use strict";function w(e,t){return e.lodLevelDelta-t.lodLevelDelta||e.measures.splitPriority-t.measures.splitPriority||t.measures.distance-e.measures.distance}e.FeatureTileTree3D=class extends i{constructor(e){super(e),this.tiles=new r,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=c.signal(!1),this._pendingTiles=c.signal(null),this._newTiles=new a,this._tests=!1,this._measurements=new g.FeatureTileMeasurements3D(e.renderCoordsHelper,e.tilingSchemeOwner.tilingScheme,this._opaqueGround)}initialize(){const e=()=>this._setDirty();this.addHandles([u.watch((()=>this.tileSize),(()=>this._reset()),u.syncAndInitial),u.watch((()=>this.cameraOnSurface?.location),e,u.syncAndInitial),u.watch((()=>this.viewState?.contentCamera),e,u.syncAndInitial),u.watch((()=>this.focus?.location),e,u.syncAndInitial),u.watch((()=>this.terrain?.baseOpacity??1),e),u.watch((()=>this.tilingScheme),(e=>{this._reset(),this._measurements=new g.FeatureTileMeasurements3D(this.renderCoordsHelper,e,this._opaqueGround)}),u.sync),u.watch((()=>this._opaqueGround),(e=>this._measurements.opaqueGround=e),u.sync)]),this._frameWorker=this.scheduler?.registerTask(v.TaskPriority.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=o.removeMaybe(this._frameWorker)}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void n.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=T.create();return f.toBoundingRect(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}addClient(){const e=d.generateUID();return this._clients.add(e),1===this._clients.size&&this._setDirty(),s.makeHandle((()=>this._removeClient(e)))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}get _opaqueGround(){return 1===(this.terrain?.baseOpacity??1)}_setDirty(){this._hasClients&&!this.suspended&&(this._frameWorker?this._dirty.value=!0:this.runTask(v.noBudget))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty.value=!1}get running(){return this.updating}_reset(){this._newTiles.clear(),this._pendingTiles.value=null,this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map((t=>new m.FeatureTileDescriptor(t[0],t[1],t[2],e)))}runTask(e){e=this._tests?v.noBudget:e,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(e),null!=this._frameWorker&&(this._frameWorker.priority=v.TaskPriority.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(e),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=v.TaskPriority.FEATURE_TILE_TREE)}_startUpdate(e){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:t,_filterExtentRect:i,_newTiles:r}=this;t.setup(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter((e=>{if(t.update(e),e.measures.visible&&(!i||T.intersects(e.extent,i))){if(e.measures.splitPriority>0)return!0;r.push(e)}return!1})).sort(w),this._newTiles.clear(),e.madeProgress()}_splitPendingTiles(e){const t=this._pendingTiles.value;if(!t)return;const{tilingScheme:i,_filterExtentRect:r,_newTiles:s,_measurements:l}=this;for(;t.length>0&&this._tileBudgetRatio<=2;){const n=t.pop();if(e.madeProgress(),n.measures.splitPriority>0){i.ensureMaxLod(n.level+1);const e=n.createChildren();for(const i of e)l.update(i),!i.measures.visible||r&&!T.intersects(i.extent,r)||(i.measures.splitPriority>0?t.push(i):s.push(i));t.sort(w),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else s.push(n);if(e.done)return}s.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),s.clear(),l.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/60}_mergeNewTiles(e,t=!1){if(this._tileBudgetRatio<=e)return;const{_newTiles:i,_measurements:r}=this;i.sort(((e,t)=>t.measures.distance-e.measures.distance));const s=new Map(i.map((e=>[e.id,e]))),l=i.length;for(const l of s.values()){const{lij:n,measures:o}=l;if(!o.mergeable||n[1]%2!=0||n[2]%2!=0||n[0]<=1||l.lodLevelDelta>=y.maxLODLevelDelta)continue;const a=o.lodLevel;let u=a,c=!0;const d=s.get(m.getFeatureTileId(n[0],n[1]+1,n[2]));let h=Math.abs((d?.measures.lodLevel??0)-a),p=0===h||t&&d?.measures.mergeable&&h<=1;if(!d||!p)continue;u+=d.measures.lodLevel,c&&=0===h;const _=s.get(m.getFeatureTileId(n[0],n[1],n[2]+1));if(h=Math.abs((_?.measures.lodLevel??0)-a),p=0===h||t&&_?.measures.mergeable&&h<=1,!_||!p)continue;u+=_.measures.lodLevel,c&&=0===h;const T=s.get(m.getFeatureTileId(n[0],n[1]+1,n[2]+1));if(h=Math.abs((T?.measures.lodLevel??0)-a),p=0===h||t&&T?.measures.mergeable&&h<=1,!T||!p)continue;u+=T.measures.lodLevel,c&&=0===h,i.removeUnordered(l),i.removeUnordered(d),i.removeUnordered(_),i.removeUnordered(T),s.delete(l.id),s.delete(d.id),s.delete(_.id),s.delete(T.id);const g=new m.FeatureTileDescriptor(n[0]-1,n[1]/2,n[2]/2,this.tilingScheme);if(r.update(g),g.measures.visible=!0,g.measures.lodLevel=u/4,g.measures.mergeable=c,i.push(g),s.set(g.id,g),this._tileBudgetRatio<=e)return}i.length<l&&this._mergeNewTiles(e,t)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const e of this.tiles.items)e.used=!1;let e=!1;const t=this._newTiles.filter((t=>{const i=this._idToTile.get(t.id);return i?(e||=i.measures.lodLevel!==t.measures.lodLevel,i.measures={...t.measures},i.used=!0):this._idToTile.set(t.id,t),!i})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles(),!e||i.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}},t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"scheduler",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"renderCoordsHelper",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"tilingSchemeOwner",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"cameraOnSurface",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"focus",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"viewState",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"terrain",void 0),t.__decorate([h.property()],e.FeatureTileTree3D.prototype,"tiles",void 0),t.__decorate([h.property()],e.FeatureTileTree3D.prototype,"tileSize",void 0),t.__decorate([h.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"tilingScheme",null),t.__decorate([h.property()],e.FeatureTileTree3D.prototype,"filterExtent",null),t.__decorate([h.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"_filterExtentRect",null),t.__decorate([h.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"_rootTileIds",null),t.__decorate([h.property({value:!1})],e.FeatureTileTree3D.prototype,"suspended",null),t.__decorate([h.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"updating",null),e.FeatureTileTree3D=t.__decorate([_.subclass("esri.views.3d.layers.support.FeatureTileTree3D")],e.FeatureTileTree3D),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));