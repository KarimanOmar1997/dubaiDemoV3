// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/sql","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../layers/support/FeatureFilter","../../../../layers/support/floorFilterUtils","../graphics/QueryEngine","../graphics/QueryEngineContext","../../../support/Scheduler"],(function(e,t,i,r,o,s,l,n,a,u,c,p,_,d,h,y,F,g){"use strict";e.FeatureVisibilityFilter=class extends i{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new _.UpdatingHandles,this._abortController=new AbortController}initialize(){const e=g.TaskPriority.FILTER_VISIBILITY,{layer:t,view:i}=this._configuration,{featureStore:r}=this.context,{spatialReference:o,resourceController:n}=i,a=this._configuration.hasZ??!1,u=this._configuration.hasM??!1,c=new F.QueryEngineContext(o,t,n,(()=>r),a,u);this._queryEngine=new y.QueryEngine({context:c,priority:e}),this._frameTask=i.resourceController.scheduler.registerTask(e),this._updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this._updateRequested=!0),l.initial),this._updatingHandles.addWhen((()=>!this._frameTask.updating&&this._updateRequested),(()=>{this._frameTask.schedule((()=>this._updateVisibility()),this._abortController.signal).catch(s.throwIfNotAbortError),this._updateRequested=!1}),l.initial)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=o.removeMaybe(this._frameTask),this._queryEngine=o.destroyMaybe(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _effectiveDisplayFilter(){return"effectiveDisplayFilter"in this._configuration?this._configuration.effectiveDisplayFilter:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return h.getFloorFilterClause(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_effectiveDisplayFilter:t,_timeExtent:i,_floorFilter:r}=this;let o=e?.clone();if(null!=t&&(o??=new d,o.where=n.sqlAnd(o.where,t.where)),null!=i&&(o??=new d,o.timeExtent=o.timeExtent?.intersection(i)??i),null!=r){o??=new d;const e=null==o.where||""===o.where;o.where=e?r:n.sqlAnd(o.where,r)}return o}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async _updateVisibility(){const{signal:e}=this._abortController,{context:t,_frameTask:i,_sceneFilter:o,_compositedFeatureFilter:l}=this;if(s.throwIfAborted(e),null==l&&null==o||0===t.getFeatureCount())return await i.schedule((()=>this.clear()),e);try{const r=await this._updatingHandles.addPromise(this._queryEngine.executeQueryForIdSet(l,o,e));return s.throwIfAborted(e),await i.schedule((()=>{t.updateFeatureVisibilities((e=>r.has(e)))}),e)}catch(o){return s.throwIfAbortError(o),r.getLogger(this).warn(`FeatureFilter query failed: ${o}`,{error:o}),await i.schedule((()=>{t.setAllFeaturesVisibility(!0)}),e)}}},t.__decorate([a.property({constructOnly:!0})],e.FeatureVisibilityFilter.prototype,"context",void 0),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"updating",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"defaultVisibility",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_featureFilter",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_effectiveDisplayFilter",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_sceneFilter",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_floorFilter",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_timeExtent",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_configuration",null),t.__decorate([a.property()],e.FeatureVisibilityFilter.prototype,"_updateRequested",void 0),e.FeatureVisibilityFilter=t.__decorate([p.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],e.FeatureVisibilityFilter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));