// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/watch","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../ViewAnimation","../../ViewingMode","./Constraints","./controllers/AnimationController","./controllers/CameraController","../webgl/RenderCamera","../webgl-engine/lib/DepthRange","../webgl-engine/lib/rendererUtils","../../support/HighlightDefaults","../../support/PropertiesPool","../../support/RenderState"],(function(e,t,r,o,a,i,n,s,l,p,c,d,h,m,u,g,_,y,C,w,v,f,P){"use strict";let R=class extends t{constructor(e){super(e),this._propertiesPool=new f.PropertiesPool({camera:y},this),this._lastSeenCameraProjectionValues=new y,this.mode=P.RenderState.ANIMATING,this._cssCamera=new y,this._camera=new y,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new u.Constraints({state:this}),this.events=new r,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new f.PropertiesPool({camera:y},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===m.ViewingMode.Global){const e=d.getReferenceEllipsoid(this.spatialReference).radius;this.camera=new y({eye:c.fromValues(4*e,0,0),center:c.fromValues(e,0,0),up:c.fromValues(0,0,1)})}else this.camera=new y({eye:c.fromValues(0,0,100),center:c.fromValues(0,0,0),up:c.fromValues(0,1,0)})}get animation(){return this.cameraController instanceof g.AnimationController&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:r,pixelRatio:o}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/o),e.width=Math.round(r/o),e}get camera(){return this._camera}set camera(e){e!==V&&V.copyFrom(e),V.computeUp(this.viewingMode),this.events.emit("before-camera-change",{camera:V});const t=this._camera;if(r=this._lastSeenCameraProjectionValues,o=V,(r.fov!==o.fov||r.fullViewport[0]!==o.fullViewport[0]||r.fullViewport[1]!==o.fullViewport[1]||r.fullViewport[2]!==o.fullViewport[2]||r.fullViewport[3]!==o.fullViewport[3]||r.padding[w.PaddingSide.TOP]!==o.padding[w.PaddingSide.TOP]||r.padding[w.PaddingSide.RIGHT]!==o.padding[w.PaddingSide.RIGHT]||r.padding[w.PaddingSide.BOTTOM]!==o.padding[w.PaddingSide.BOTTOM]||r.padding[w.PaddingSide.LEFT]!==o.padding[w.PaddingSide.LEFT])&&(this._lastSeenCameraProjectionValues.copyFrom(V),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(V)&&(this._camera=this._propertiesPool.get("camera").copyFrom(V),this._cameraChanged=!t.almostEquals(V),this._cameraChanged)){const e=p.afterDispatch((()=>{this._cameraChanged=!1,e.remove()}))}var r,o}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===P.RenderState.IDLE}get updating(){return this.mode!==P.RenderState.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){if(null==e)return void(this._contentCamera=null);const t=e.clone();this.events.emit("before-camera-change",{camera:t,sceneDepthRange:C.DepthRange.infinite}),this._contentCamera=t}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return this.viewingMode===m.ViewingMode.Global}get isLocal(){return this.viewingMode===m.ViewingMode.Local}get viewingMode(){return m.viewingModeFromString(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,v.maximumHighlights);for(let t=0;t<e.length;){const r=e[t],o=e.findIndex((e=>e.name===r.name));o>=0&&t>o?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach(((t,r)=>e.set(t.name,r))),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(O),this.addHandles(o.when((()=>e.state===_.State.Finished||e.state===_.State.Stopped),(()=>{this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t)))}),{sync:!0,once:!0}),O),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=_.State.Rejected)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();V.copyFrom(this._get("camera")),e(V),this.camera=V,this._processingUpdates=!1,this._processUpdateQueue()}};e.__decorate([a.property({constructOnly:!0})],R.prototype,"view",void 0),e.__decorate([a.property()],R.prototype,"mode",void 0),e.__decorate([a.property({readOnly:!0,type:h})],R.prototype,"animation",null),e.__decorate([a.property({type:y})],R.prototype,"cssCamera",null),e.__decorate([a.property()],R.prototype,"_cssCamera",void 0),e.__decorate([a.property({type:y})],R.prototype,"camera",null),e.__decorate([a.property()],R.prototype,"_camera",void 0),e.__decorate([a.property({readOnly:!0})],R.prototype,"pixelRatio",null),e.__decorate([a.property()],R.prototype,"rasterPixelRatio",void 0),e.__decorate([a.property()],R.prototype,"contentPixelRatio",void 0),e.__decorate([a.property({readOnly:!0})],R.prototype,"alignPixelEnabled",null),e.__decorate([a.property({readOnly:!0})],R.prototype,"updating",null),e.__decorate([a.property({})],R.prototype,"_contentCamera",void 0),e.__decorate([a.property({type:y})],R.prototype,"contentCamera",null),e.__decorate([a.property({readOnly:!0})],R.prototype,"fixedContentCamera",null),e.__decorate([a.property({readOnly:!0})],R.prototype,"events",void 0),e.__decorate([a.property({readOnly:!0})],R.prototype,"isGlobal",null),e.__decorate([a.property({readOnly:!0})],R.prototype,"isLocal",null),e.__decorate([a.property({readOnly:!0})],R.prototype,"viewingMode",null),e.__decorate([a.property({readOnly:!0})],R.prototype,"highlights",null),e.__decorate([a.property({readOnly:!0})],R.prototype,"highlightOrderMap",null),e.__decorate([a.property({readOnly:!0})],R.prototype,"navigating",null),e.__decorate([a.property({readOnly:!0})],R.prototype,"stationary",null),e.__decorate([a.property()],R.prototype,"_cameraChanged",void 0),e.__decorate([a.property()],R.prototype,"cameraController",null),R=e.__decorate([l.subclass("esri.views.3d.state.ViewState")],R);const S=R,V=new y,O="ViewStateHandles";return S}));