// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vectorStacks","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl/RenderCamera","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,n,a,o,r,i,c,s,l,d,m,u,p,h,g,f,y,M){"use strict";var P;e.SpherePickPointFallback=void 0,(P=e.SpherePickPointFallback||(e.SpherePickPointFallback={}))[P.Ellipsoid=0]="Ellipsoid",P[P.Silhouette=1]="Silhouette";const b={exclude:new Set([M.terrainId])};function v(e,t,n){const a=o.fromRotation(h.sm4d.get(),n[3],d.axis(n));null==a||o.exactEquals(a,r.IDENTITY)||(s.subtract(oe,e.eye,t),s.transformMat4(oe,oe,a),e.eye=s.add(oe,oe,t),s.subtract(oe,e.center,t),s.transformMat4(oe,oe,a),e.center=s.add(oe,oe,t),e.up=s.transformMat4(oe,e.up,a))}const S=a.createScreenPointArray();function x(e,t,n,a){return Math.sin(e/s.length(t))*(n+a.radius)}var A;e.NavigationMode=void 0,(A=e.NavigationMode||(e.NavigationMode={}))[A.Vertical=0]="Vertical",A[A.Horizontal=1]="Horizontal";const z={Elevation:3e4,Angle:n.deg2rad(16)},T=n.deg2rad(80),I=l.create();function R(e,t,n,a){const o=g.fromScreenAtEye(t,n,le);return!(null==o||(p.closestPointOnSilhouette(e,o,k),p.intersectRay(e,o,a)?s.squaredDistance(k,o.origin)<s.squaredDistance(a,o.origin)&&(s.copy(a,k),1):(s.subtract(D,t.eye,t.center),s.normalize(D,D),u.fromNormalAndOffset(D,-s.dot(s.normalize(D,D),k),C),u.intersectRay(C,o,a),1)))}const k=l.create(),D=l.create(),C=u.create();function E(e,a,o,r,i,c){let d=0;if(s.cross(ce,e,a),s.subtract(re,e,a),s.length(e)<=i||!r.aboveGround){s.cross(o,re,r.eye);const m=s.dot(e,a)/(s.length(e)*s.length(a));if(m<.9999)d=n.acosClamped(m);else{const t=s.length(s.cross(l.create(),e,a))/(s.length(e)*s.length(a));d=n.asinClamped(t)}const u=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(c)),0,T));d=-d-Math.max(0,s.length(a)-i)/(u*i)}else s.subtract(F,r.eye,r.center),s.cross(o,re,F),d=-s.length(re)/i;return s.normalize(o,o),s.scale(o,o,s.length(ce)),d}const F=l.create();function H(e,a,o,r){let i,c;const s=Math.cos(n.clamp(t.cyclicalPI.normalize(n.deg2rad(r)),0,T));return i=a>o?-(a-o)/(s*o):a<-o?Math.PI-(a+o)/(s*o):n.acosClamped(a/o),c=e>o?-(e-o)/(s*o):e<-o?Math.PI-(e+o)/(s*o):n.acosClamped(e/o),(c-i)*o}function w(e,t,n,a,o,r,c,l,d,m){const u=H(e[2],t[2],r[3],l),p=d?H(e[0],t[0],r[3],180):t[0]-e[0],h=Math.sin(c)*p-Math.cos(c)*u,g=Math.cos(c)*p+Math.sin(c)*u;s.normalize(oe,o);const f=d?h/Math.sqrt(Math.abs(r[3]**2-s.dot(n,oe)**2)):h/r[3],y=g/Math.sqrt(Math.abs(r[3]**2-s.dot(n,a)**2));i.set(m,f,y)}function N(e,t,n,a,o,r,i,c,l,d){s.cross(ce,e,t),m.coordinateSystemFromOneAxisAndNormalVector(r.up,r.eye,B,J,K),m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],r.eye,j,L,Y),s.copy(n,L),s.copy(a,j),s.normalize(n,n),s.scale(n,n,s.length(ce)),m.vectorCoordinates(e,s.normalize(J,J),s.normalize(K,K),s.normalize(B,B),Q),m.vectorCoordinates(t,J,K,B,X),w(Q,X,e,j,L,i,c,l,d,o)}function q(e,t,n,a,r,i,c){o.fromRotation(ee,r,a),o.fromRotation(te,c,i),o.multiply(ne,ee,te),s.subtract(t,e,n),s.transformMat4(t,t,ne),s.add(t,t,n)}function O(e,t,n,a,r,i){o.fromRotation(ee,a,n),o.fromRotation(te,i,r),o.multiply(ne,ee,te),s.subtract(oe,e.eye,t),s.transformMat4(oe,oe,ne),e.eye=s.add(oe,oe,t),s.subtract(oe,e.center,t),s.transformMat4(oe,oe,ne),e.center=s.add(oe,oe,t),s.subtract(oe,e.up,t),s.transformMat4(oe,oe,ne),e.up=s.add(oe,oe,t)}const V={Pole:.95,Angle:n.deg2rad(18),Tilt:45,TiltHysteresisMargin:1e-7};let G=!1;function U(e,t,n,a,o,r){const i=Math.abs(a)>Math.PI-V.Angle||Math.abs(a)<V.Angle,c=(Math.abs(e[2])<n*V.Pole||Math.abs(t)>n)&&r;return i&&c?!G&&o<V.Tilt-V.TiltHysteresisMargin?G=!0:G&&o>V.Tilt+V.TiltHysteresisMargin&&(G=!1):G=!1,G}function W(e,t,n,a,o,r){if(r)d.fromPoints(n,a,_),v(t,p.getCenter(e),_);else{const r=E(n,a,se,t,e[3],o);v(t,p.getCenter(e),d.wrapAxisAngle(se,r))}}function Z(e,t,n,a,o,r,i){const c=i?20:1;let l,d;s.copy(ae,a),ie.copyFrom(t);for(let a=0;a<c&&s.squaredDistance(n,ae)>1e-12&&(l=s.squaredDistance(n,ae),N(n,ae,L,j,$,ie,e,o,r,i),O(ie,p.getCenter(e),j,$[1],L,$[0]),q(ae,ae,p.getCenter(e),j,$[1],L,$[0]),d=s.squaredDistance(n,ae),d<l||0===a);a++)t.copyFrom(ie)}const j=l.create(),L=l.create(),Y=l.create(),B=l.create(),J=l.create(),K=l.create(),Q=l.create(),X=l.create(),$=c.create(),_=d.create(),ee=r.create(),te=r.create(),ne=r.create(),ae=l.create(),oe=l.create(),re=l.create(),ie=new y,ce=l.create(),se=l.create(),le={origin:l.create(),direction:l.create()},de={origin:l.create(),direction:l.create()};e.TiltThresholdPanningSpeed=T,e.VerticalPanTresholds=z,e.applyPanPlanar=function(e,t,n){s.subtract(I,n,t),e.eye=s.subtract(oe,e.eye,I),e.center=s.subtract(oe,e.center,I)},e.applyPanSphericalDirectRotation=W,e.applyPanSphericalPreserveHeading=Z,e.applyRotation=v,e.applyRotationWithTwoAxes=O,e.applyZoomOnSphere=function(e,t,n){t.getScreenCenter(S),f.intersectScreen(e,t,S,oe)&&(t.center=oe);const a=t.distance,o=a*n;if(Math.abs(a-o)<1e-6)return;const r=s.scale(h.sv3d.get(),t.viewForward,o);t.eye=s.subtract(oe,t.center,r)},e.applyZoomToPoint=function(e,t,n,a){const o=h.sv3d.get();let r=1-n;s.subtract(o,t,e.eye);const i=s.length(o);let c=i*(1-r);r>=0&&c<a&&(c=a,r=-(c-i)/i),Math.abs(i-c)<1e-6||(s.scale(o,o,r),e.eye=s.add(oe,e.eye,o),e.center=s.lerp(oe,e.center,t,r))},e.centroid=function(e,t){s.set(t,0,0,0);for(const n of e)s.add(t,t,n);s.scale(t,t,1/e.length)},e.distanceClampValues=[1,3e8],e.excludeTerrain=b,e.intersectPlaneFromScreenPoint=function(e,t,n,a){return u.intersectRay(e,g.fromScreen(t,n,le),a)},e.intersectPlaneFromScreenPointAtEye=function(e,t,n,a){return u.intersectRay(e,g.fromScreenAtEye(t,n,le),a)},e.lengthFromPoints=H,e.minHeightLimit=50,e.navigationMode=function(t,n,a,o){const r=t.relativeElevation;if(r>z.Elevation&&"global"===o)return e.NavigationMode.Horizontal;g.fromScreenAtEye(t,n,de);const i=Math.sign(r),c=a.worldUpAtPosition(t.eye,oe);return-i*s.dot(c,de.direction)<Math.sin(z.Angle)*s.length(de.direction)?e.NavigationMode.Vertical:e.NavigationMode.Horizontal},e.normalizeCoordinate=function(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n},e.normalizeRotationDelta=function(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e},e.offSurfaceTiltToEyeTiltGlobal=function(e,t,n,a){return x(Math.PI/2,t,n,a)+(e-Math.PI/2)},e.onSurfaceTiltToEyeTiltGlobal=x,e.panDistanceModifier=5,e.panMotionToRotationMatrix=function(e,a,r,i,c,l,d,u,p){U(e.center,s.dot(e.up,e.center),s.length(e.center),-t.cyclicalPI.normalize(n.deg2rad(l)),d,a.aboveGround)?function(e,t,n,a,r,i){const{eye:c}=e;m.coordinateSystemFromOneAxisAndNormalVector([0,0,1],c,j,L,Y);const l=t.translation[0]*n.pan,d="zoom"===r.mode?0:t.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-s.dot(e.center,j)**2/s.length(e.center)**2)),.5),p=(Math.sin(i)*d+Math.cos(i)*l)/u,h=-Math.cos(i)*d+Math.sin(i)*l;switch(o.rotate(a.pan.matrix,a.pan.matrix,p,j),a.pan.enabled=!0,r.mode){case"pan":o.rotate(a.pan.matrix,a.pan.matrix,h,L),a.pan.enabled=!0;break;case"zoom":a.zoom=-t.translation[1]*n.zoom}}(a,r,i,u,p,-t.cyclicalPI.normalize(n.deg2rad(c))):function(e,t,n,a,r){const{eye:i,viewRight:c}=e,l=s.cross(h.sv3d.get(),c,i),d=t.translation[0]*n.pan;switch(0!==d&&(o.rotate(a.pan.matrix,a.pan.matrix,-d,l),a.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*n.pan;0!==e&&(o.rotate(a.pan.matrix,a.pan.matrix,e,c),a.pan.enabled=!0);break}case"zoom":a.zoom=-t.translation[1]*n.zoom}}(a,r,i,u,p)},e.panToPosition=function(e,a,o,r,i,c,l){U(o,s.dot(a.up,o),e[3],-t.cyclicalPI.normalize(n.deg2rad(i)),c,a.aboveGround)?Z(e,a,o,r,-t.cyclicalPI.normalize(n.deg2rad(i)),c,l):W(e,a,o,r,c,l)},e.pickPointAndInitSphere=function(t,n,a,o,r,i){const c=l.create(),d=p.create();let m=!0,u=!0;return t.intersectScreen(a,c,i)?d[3]=s.length(c):(u=!1,n.aboveGround&&r!==e.SpherePickPointFallback.Ellipsoid?d[3]=Math.max(s.length(n.center),.9*o):d[3]=s.length(n.eye)-n.relativeElevation,r===e.SpherePickPointFallback.Silhouette?R(d,n,a,c):m=f.intersectScreen(d,n,a,c)),{sphere:d,scenePickPoint:m?c:null,hasGeometryIntersection:u}},e.pivotDistanceModifier=30,e.preservingHeadingThresholds=V,e.rotatePivotDistanceModifier=5,e.rotatePivotMinDistanceModifier=10,e.rotatePointAroundTwoAxes=q,e.rotateScreenPixelArea=90,e.rotationAngleAndAxisDirectRotation=E,e.rotationAnglesAndAxesHeadingPreserving=N,e.rotationAnglesHeadingPreserving=w,e.screenPixelArea=80,e.shouldPreserveHeading=U,e.sphereOrPlanePointFromScreenPoint=R,e.zoomDistanceModifier=8,e.zoomMaxDistanceModifier=1508e5,e.zoomMinDistanceModifier=200,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));