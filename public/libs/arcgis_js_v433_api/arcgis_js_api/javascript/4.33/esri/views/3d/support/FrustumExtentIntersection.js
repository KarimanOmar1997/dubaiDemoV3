// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/compilerUtils","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/projection/computeTranslationToOriginAndRotation","../../../geometry/projection/projectBoundingRect","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/lineSegment","../../../geometry/support/plane","../../../geometry/support/ray","../../ViewingMode","./intersectionUtils"],(function(e,t,i,n,r,o,s,a,c,l,d,p,h,g,_,x,u,m,f){"use strict";const R=.5*Math.PI,y=R/Math.PI*180,A=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],b=s.create(),P=r.create(),I=r.create(),E=p.create(),M=h.create(),S=_.create();e.FrustumExtentIntersection=class{constructor(e){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:s.create(),direction:s.create()},this._renderCoordsHelper=e.renderCoordsHelper;for(let e=0;e<4;e++)this._extent[e]={origin:s.create(),direction:s.create(),cap:{next:null,direction:s.create()}},this._planes[e]=x.create();this._planes[g.PlaneIndex.NEAR]=x.create(),this._planes[g.PlaneIndex.FAR]=x.create(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,i,n=!0){const r=this._extent;this._toRenderBoundingExtent(e,t,i),o.add(this._center.origin,r[0].origin,r[2].origin),o.scale(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),n||o.scale(this._center.direction,this._center.direction,-1);for(let e=0;e<4;e++){const t=r[e];this._renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);const i=r[3===e?0:e+1];t.cap.next=i.origin,o.direction(t.cap.direction,t.origin,i.origin),x.fromVectorsAndPoint(t.direction,t.cap.direction,t.origin,this._planes[e]),n||o.scale(t.direction,t.direction,-1)}x.fromVectorsAndPoint(r[0].cap.direction,r[1].cap.direction,r[0].origin,this._planes[g.PlaneIndex.NEAR]),n?x.negate(this._planes[g.PlaneIndex.NEAR],this._planes[g.PlaneIndex.FAR]):(x.copy(this._planes[g.PlaneIndex.FAR],this._planes[g.PlaneIndex.NEAR]),x.negate(this._planes[g.PlaneIndex.NEAR],this._planes[g.PlaneIndex.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*a.getReferenceEllipsoid(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(null==e)return!1;if(this._renderCoordsHelper.viewingMode===m.ViewingMode.Global){const i=this._maxSpanSpatialReference.isGeographic?y:R*t;if(this._maxSpan>i)return!0;if(null!=e.altitude&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(0===this._maxSpan){const t=this._extent[0];return!(i||!e.intersectsRay(u.wrap(t.origin,t.direction)))}for(let t=0;t<this._extent.length;t++){const n=this._extent[t];if(!i&&e.intersectsRay(u.wrap(n.origin,n.direction)))return!0;if(e.intersectsLineSegment(_.fromPoints(n.origin,n.cap.next,S),n.cap.direction))return!0}const n=i?this._planes:this._planesWithoutFar;for(let t=0;t<e.lines.length;t++){const i=e.lines[t];if(f.frustumLineSegment(n,i.origin,i.endpoint,i.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,r){h.center(e,b),b[2]=r,c.computeTranslationToOriginAndRotation(t,b,P,this._renderCoordsHelper.spatialReference),n.invert(I,P),p.empty(E);for(const{x0:n,x1:s,y0:a,y1:c}of A)for(let l=0;l<5;l++){const h=l/4;b[0]=i.lerp(e[n],e[s],h),b[1]=i.lerp(e[a],e[c],h),b[2]=r,d.projectVectorToVector(b,t,b,this._renderCoordsHelper.spatialReference),o.transformMat4(b,b,I),p.expandWithVec3(E,b)}o.set(this._extent[0].origin,E[0],E[1],E[2]),o.set(this._extent[1].origin,E[3],E[1],E[2]),o.set(this._extent[2].origin,E[3],E[4],E[2]),o.set(this._extent[3].origin,E[0],E[4],E[2]);for(let e=0;e<4;++e)o.transformMat4(this._extent[e].origin,this._extent[e].origin,P)}_toRenderBoundingExtentLocal(e,t,i){l.projectBoundingRect(e,t,M,this._renderCoordsHelper.spatialReference),o.set(this._extent[0].origin,M[0],M[1],i),o.set(this._extent[1].origin,M[2],M[1],i),o.set(this._extent[2].origin,M[2],M[3],i),o.set(this._extent[3].origin,M[0],M[3],i)}_toRenderBoundingExtent(e,i,n){switch(this._renderCoordsHelper.viewingMode){case m.ViewingMode.Global:this._toRenderBoundingExtentGlobal(e,i,n);break;case m.ViewingMode.Local:this._toRenderBoundingExtentLocal(e,i,n);break;default:t.neverReached(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(x.signedDistance(e.planes[g.PlaneIndex.NEAR],this._center.origin)<0&&o.dot(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this._extent[t];if(x.signedDistance(e.planes[g.PlaneIndex.NEAR],i.origin)<0&&o.dot(i.direction,e.direction)<0)return!0}return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));