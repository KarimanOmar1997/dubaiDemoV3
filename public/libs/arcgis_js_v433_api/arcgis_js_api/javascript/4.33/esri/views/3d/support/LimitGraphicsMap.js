// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Evented","../../../core/MapUtils","./GraphicsMap"],(function(e,t,s,i){"use strict";const n=new class{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(e){this._percentage=e,this._last=-1}sample(){const e=Math.floor(this._index*this._percentage);return++this._index,e!==this._last&&(this._last=e,!0)}};class a{constructor(e){this._parent=e,this._map=new Map}get length(){return this._map.size}forEach(e){this._map.forEach((t=>e(t)))}find(e){return s.findInMap(this._map,e)}some(e){return s.someMap(this._map,e)}toArray(){return Array.from(this._map.values())}addAndRemove(e,t){for(const t of e)this._map.set(t.objectId,t);for(const e of t)this._map.delete(e.objectId);(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})}removeMany(e){for(const t of e)this._map.delete(t.objectId);e.length>0&&this._parent.emit("change",{added:[],removed:e})}}e.LimitGraphicsMap=class extends t{constructor(e){super(),this._limit=e,this._all=new i.GraphicsMap,this._active=new a(this),this._pending=new Map,this._handle=this._all.on("change",(e=>this._handleChanges(e)))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(e){return this._active.find(e)}some(e){return this._active.some(e)}forEach(e){this._active.forEach(e)}addMany(e){this._all.addMany(e)}removeManyByObjectId(e){this._all.removeManyByObjectId(e)}_handleChanges(e){let t=e.removed;if(this._pending.size>0){t=new Array;for(const s of e.removed)this._pending.delete(s.objectId)||t.push(s)}let s=this._limit-this._active.length+t.length;s<e.added.length&&(this._active.removeMany(t),t=[],n.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach((e=>{n.sample()&&(t.push(e),this._pending.set(e.objectId,e))})),s=this._limit-this._active.length+t.length);let i=e.added;if(s<e.added.length){i=new Array,n.reset(s/e.added.length);for(const t of e.added)n.sample()?i.push(t):this._pending.set(t.objectId,t)}const a=s-i.length;a>0&&this._pending.size>0&&(n.reset(a/this._pending.size),this._pending.forEach((e=>{n.sample()&&(i.push(e),this._pending.delete(e.objectId))}))),this._active.addAndRemove(i,t)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));