// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../Camera","../../../core/Cyclical","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/Point","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToPoint","../../../geometry/projection/projectVectorToVector","../../ViewingMode","../camera/intersectionUtils","../../../chunks/cameraUtilsPlanar","../../../chunks/cameraUtilsSpherical","./earthUtils","./ElevationProvider","../../support/spatialReferenceSupport"],(function(e,t,n,r,o,i,a,c,l,s,u,f,d,p,m,h,g,y,w,T,v,S){"use strict";const R=()=>r.getLogger("esri.views.3d.support.cameraUtils"),A=96*39.37,M={heading:0,tilt:0},x=c.create(),b=new n.Cyclical(-20037508.342788905,20037508.342788905),C=new n.Cyclical(-180,180);var P;function j(e){return e.spatialReference??f.WGS84}function z({state:e}){return e.isGlobal?w.cameraUtilsSpherical:y.cameraUtilsPlanar}function D(e,t){if(null==t)return null;const n=e.renderSpatialReference,r=z(e).headingTiltToDirectionUp,i=c.create();if(!d.projectPointToVector(t.position,i,n))return null;const l=r(i,t.heading,t.tilt);a.scale(l.direction,l.direction,e.state.camera.distance),a.add(l.direction,l.direction,i);const s=g.cameraOnContentAlongViewDirection(e,i,l.direction,l.up);return s.fov=o.deg2rad(t.fov),s.row=t.layout.row,s.rows=t.layout.rows,s.column=t.layout.column,s.columns=t.layout.columns,s}e.OrientationMode=void 0,(P=e.OrientationMode||(e.OrientationMode={}))[P.LOCKED=0]="LOCKED",P[P.ADJUST=1]="ADJUST";const U=c.create();function V(e,t){const{camera:n}=e.state,{unitInMeters:r}=e.renderCoordsHelper;return t/=r,n.width/2/n.pixelRatio/(A/t)/Math.tan(n.fovX/2)}function O(e,t){const{camera:n}=e.state,{unitInMeters:r}=e.renderCoordsHelper,o=t*Math.tan(n.fovX/2),i=n.width/2/n.pixelRatio;return A/(i/o)*r}function E(e,t,n,r){const o=r.levelAtScale(t),i=L(H(e,n.eye,n.viewForward,n.up).tilt),a=Math.max(o-i,0);return r.scaleAtLevel(a)}function I(e,t,n){const r=n.levelAtScale(e),o=L(t);return n.scaleAtLevel(r+o)}function L(e){return 2*((e>90?180-e:e)/90)**2}function F(e,t,n=0){const r=D(e,t);return r?function(e,t,n=0){const r=e.basemapTerrain?.tilingScheme;if(!r)return 0;const o=l.getReferenceEllipsoid(e.spatialReference).radius,i=e.state.viewingMode===h.ViewingMode.Local?t.eye[2]:a.length(t.eye)-o;return E(e,O(e,Math.abs(i-n)),t,r)}(e,r,n):0}async function G(e,t,n,r,o,a){const c=await k(e,r.heading,r.tilt,t,n,o,a);return i.throwIfAborted(a),ne(e,c,r.fov,a)}function H(e,t,n,r,o){return z(e).directionToHeadingTilt(t,n,r,o)}function J(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,x,e.spatialReference)&&e.elevationProvider&&(v.getElevationAtPoint(e.elevationProvider,x)??0)>x[2]-1)}function q(e,t,n,r,o,i){const l=r instanceof s?r:null,u=function(e,t){const n=c.create();if(null==t)return a.copy(n,e.state.camera.center);if(t instanceof s){if(!d.projectPointToVector(t,n,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:o}=e;if(null==t.z&&null!=r&&null!=o){const r=v.getElevationAtPoint(o,t);null!=r&&e.renderCoordsHelper.setAltitude(n,r)}return n}return a.copy(n,t)}(e,r);return W(e,t,n,l,u,o,i)}async function k(e,t,n,r,o,l,u){const f=r instanceof s?r:null,p=await async function(e,t,n){const r=c.create();if(null==t)return a.copy(r,e.state.camera.center);if(t instanceof s){const{renderSpatialReference:o,basemapTerrain:a,elevationProvider:c}=e,l=t.spatialReference;if(await d.projectPointToVectorAsync(t,r,o,0,{signal:n}),i.throwIfAborted(n),null==t.z&&null!=a&&null!=c){const o=await c.queryElevation(t.x,t.y,t.z??0,l,"ground",n);i.throwIfAborted(n),null!=o&&e.renderCoordsHelper.setAltitude(r,o)}return r}return a.copy(r,t)}(e,r,u);return i.throwIfAborted(u),X(e,t,n,f,p,o,l,u)}function W(e,t,n,r,o,i,a){if(null==o)return null;if(!r&&(r=new s({spatialReference:j(e)}),!p.projectVectorToPoint(o,e.renderSpatialReference,r)))return null;const c=K(e,t,n,o,i,a);if(Z(e,n,a)&&J(e,c.eye)){const{tilt:a,mode:c}=Y(e,n,o,i);return W(e,t,a,r,o,i,c)}return N(c,o)}async function X(e,t,n,r,o,a,c,l){r||(r=new s({spatialReference:j(e)}),await p.projectVectorToPointAsync(o,e.renderSpatialReference,r,{signal:l})||(r=null)),i.throwIfAborted(l);const u=K(e,t,n,o,a,c);if(Z(e,n,c)&&await async function(e,t,n){if(J(e,t))return!0;const{elevationProvider:r,spatialReference:o,renderCoordsHelper:a}=e;if(null==r||!a.fromRenderCoords(t,x,o))return!1;const[c,l,s]=x,u=await r.queryElevation(c,l,s,o,"ground",n)??0;return i.throwIfAborted(n),u>s-1}(e,u.eye,l)){i.throwIfAborted(l);const{tilt:c,mode:s}=Y(e,n,o,a);return X(e,t,c,r,o,a,s,l)}return N(u,o)}function K(t,n,r,o,i,c){const l=function(t,n,r,o,i,c){let l=0;return c===e.OrientationMode.ADJUST&&function(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>8)return!0;const o=t,i=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return a.distance(o,i)/(Math.tan(.5*e.state.camera.fov)*r)>5}(t,o,i)?(n=0,l=function(e,t,n,r){const o=ee(e,r,t,n);if(!e.state.constraints.tilt)return o;const i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);const a=i.min*(1-$)+i.max*$;return Math.min(o,a)}(t,i,r,o)):l=ee(t,o,i,r),l=t.state.constraints.clampTilt(i,l),{heading:n,tilt:r=_(t,o,i,l)}}(t,n,r,o,i=Math.max(i,t.state.constraints.minimumPoiDistance),c);return(0,z(t).eyeForCenterWithHeadingTilt)(o,i,l.heading,l.tilt)}function Z(t,n,r){const o=t.map.ground.navigationConstraint;return r===e.OrientationMode.ADJUST&&t.state.isGlobal&&n>0&&(null==o||"stay-above"===o.type)}function Y(t,n,r,o){const i=_(t,r,o,function(e,t,n,r){let o=ee(e,r,t,n);if(!e.state.constraints.tilt)return o;const i=e.state.constraints.tilt(t);return o=Math.min(o,.5*Math.PI),i.min*(1-$)+o*$}(t,o,n,r));return{tilt:i,mode:n-i<1?e.OrientationMode.LOCKED:e.OrientationMode.ADJUST}}function N(e,t){return{...e,center:c.clone(t)}}function B(e,t){const{state:n,spatialReference:r}=e,o=t.spatialReference;return n.isGlobal&&S.isSpatialReferenceSupported(o,h.ViewingMode.Global)||n.isLocal&&r.equals(o)}function Q(e,t){let n,r,o;if(e.state.isGlobal){const e=new s(t.xmin,t.ymin,t.spatialReference),i=new s(t.xmax,t.ymax,t.spatialReference),a=t.spatialReference.isGeographic?C:b;n=new s({x:a.center(e.x,i.x),y:(i.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const c=l.getReferenceEllipsoid(t.spatialReference),u=T.getGreatCircleSpanAt(n,e,i);r=u.lon,o=u.lat,a.diff(e.x,i.x)>a.range/2&&(r+=c.halfCircumference),r=Math.min(r,c.halfCircumference),o=Math.min(o,c.halfCircumference)}else{const i=e.renderSpatialReference??t.spatialReference;i.equals(t.spatialReference)||(t=u.project(t,i)),r=t.xmax-t.xmin,o=t.ymax-t.ymin;const a=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;n=new s({x:t.xmin+.5*r,y:t.ymin+.5*o,z:a,spatialReference:i})}const i=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,a=e.state.camera,c=1/Math.tan(a.fovX/2),f=1/Math.tan(a.fovY/2),d=1/Math.tan(a.fov/2);return{center:n,distance:Math.max(.5*r*c,.5*o*f,.5*i*d)/1}}const $=.7;function _(e,t,n,r){return z(e).lookAtTiltToEyeTilt(r,t,n)}function ee(e,t,n,r){return z(e).eyeTiltToLookAtTilt(r,t,n)}function te(e,n,r,o){if(null==n)return null;const i=e.renderSpatialReference,a=new s({spatialReference:j(e)});return p.projectVectorToPoint(n.eye,i,a)?(o??=new t,o.position=a,o.heading=n.heading,o.tilt=n.tilt,o.fov=r,o):null}async function ne(e,n,r,o){const a=e.renderSpatialReference,c=new s({spatialReference:j(e)});return await p.projectVectorToPointAsync(n.eye,a,c,{signal:o}),i.throwIfAborted(o),new t(c,n.heading,n.tilt,r)}e.applyTiltAdjustToScale=E,e.directionToHeadingTilt=H,e.distanceToScale=O,e.externalToInternal=D,e.fromCenterDistanceAsync=G,e.fromCenterDistanceSync=function(e,t,n,r,o,i){return te(e,q(e,r.heading,r.tilt,t,n,o),r.fov,i)},e.fromCenterScale=async function(e,t,n,r,o,i){return G(e,t,V(e,n),r,o,i)},e.fromExtentAsync=async function(e,t,n,r,o,a){const c=B(e,t)?t:await u.projectWithZConversion(t,e.spatialReference,{signal:a});i.throwIfAborted(a);const{center:l,distance:s}=Q(e,c),f=await k(e,n,r,l,s,o,a);return i.throwIfAborted(a),ne(e,f,e.camera.fov,a)},e.fromExtentSync=function(e,t,n,r,o,i){let a;try{a=B(e,t)?t:u.project(t,e.spatialReference)}catch(e){return null}const{center:c,distance:l}=Q(e,a),s=q(e,n,r,c,l,o);return null==s?null:te(e,s,e.camera.fov,i)},e.getObserverForPointAtDistanceAsync=k,e.getObserverForPointAtDistanceSync=q,e.getViewSR=j,e.headingTiltToDirectionUp=function(e,t,n,r,o){return z(e).headingTiltToDirectionUp(t,n,r,o)},e.internalToExternal=function(e,n,r){const i=e.renderSpatialReference,a=H(e,n.eye,n.viewForward,n.up,M);let c=j(e);return m.projectVectorToVector(n.eye,i,U,c)||(c=f.WGS84,m.projectVectorToVector(n.eye,i,U,c)),null==r?r=new t(new s(U,c),a.heading,a.tilt,o.rad2deg(n.fov)):(r.position.x=U[0],r.position.y=U[1],r.position.z=U[2],r.position.spatialReference=c,r.heading=a.heading,r.tilt=a.tilt,r.fov=o.rad2deg(n.fov)),r.layout.row=n.row,r.layout.rows=n.rows,r.layout.column=n.column,r.layout.columns=n.columns,r},e.removeTiltAdjustFromScale=I,e.scaleErrorThreshold=1,e.scaleToDistance=V,e.scaleToZoom=function(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);R().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")},e.toArea=function(e,t){return z(e).toArea(e,t)},e.toExtent=function(e,t,n){const r=e.renderSpatialReference,o=new s({spatialReference:j(e)});if(!p.projectVectorToPoint(n,r,o))return null;const i=Math.tan(t.fovX/2),c=Math.tan(t.fovY/2),l=a.dist(t.eye,n),u=2*l*i*1,f=2*l*c*1;return z(e).toExtent(e,o,u,f)},e.viewScaleToCameraDistance=function(t,n,r,i,c){if(0===n)return 0;const s=a.distance(r.eye,i),u=t.basemapTerrain?.tilingScheme;if(!u)return R().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),s;let f=s;const d=H(t,r.eye,r.viewForward,r.up),p=d.tilt>90;if(t.state.isLocal){const e=(V(t,I(n,d.tilt,u))-Math.abs(r.eye[2]-c[2]))/Math.cos(o.deg2rad(d.tilt));return f=p?f-e:f+e,f}let m=1/0,h=0,g=q(t,d.heading,d.tilt,i,s,e.OrientationMode.ADJUST);if(!g)return f;const y=a.length(c);for(;m>1&&h<100;){const c=a.length(g.eye),s=p?180-g.tilt:g.tilt,w=o.deg2rad(s),T=Math.sin(w)*c,v=Math.cos(w)*c,S=V(t,I(n,g.tilt,u)),R=p?y-S:y+S,A=o.asinClamped(T/R),M=Math.cos(A)*R-v,x=a.distance(g.eye,i);f=p?x-M:x+M,g=q(t,d.heading,d.tilt,i,f,e.OrientationMode.ADJUST);const b=te(t,g,o.rad2deg(r.fov));if(!g||!b)return f;const C=F(t,b,y-l.getReferenceEllipsoid(t.spatialReference).radius);m=Math.abs(n-C),++h}return f},e.zoomToScale=function(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);R().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));