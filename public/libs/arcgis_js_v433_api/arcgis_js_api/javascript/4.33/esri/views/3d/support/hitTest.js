// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../Graphic","../../../core/iteratorUtils","../../../core/screenUtils","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/projection/projectVectorToVector","../../../layers/LayerConstants","../../../layers/support/layerUtils","./debugFlags","./ElevationProvider","../webgl-engine/lib/Intersector","../webgl-engine/lib/IntersectorInterfaces","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/IntersectorType","../webgl-engine/lib/intersectorUtilsConversions","../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,n,i,r,s,c,l,o,a,u,d,p,g,f,y,m,I){"use strict";function h(e,t,n){return t.getIntersectionPoint(T)?(n=U(e,T,n),t.intersector===y.IntersectorType.TERRAIN&&e.basemapTerrain&&(n.z=d.getElevationAtPoint(e.basemapTerrain,n)??0),n):null}function b(e){const t=e.sourceLayer,n=e.layer,i=t&&"objectIdField"in t?t:n&&"objectIdField"in n?n:t;if(i){const t=i.objectIdField??o.fallbackObjectIDAttribute,n=e.attributes?.[t];if(n)return`o-${i.id}-${n}`}return`u-${e.uid}`}function w(e,t){return E(e,b(t))}function E(e,t){return null==e||(null==e.include||e.include.has(t))&&(null==e.exclude||!e.exclude.has(t))}function U(e,t,n){let i=e.spatialReference||c.WGS84;return l.projectVectorToVector(t,e.renderSpatialReference,T,i)?t=T:(i=c.WGS84,l.projectVectorToVector(t,e.renderSpatialReference,T,i)&&(t=T)),n?(n.x=t[0],n.y=t[1],n.z=t[2],n.spatialReference=i):n=new s(t,i),n}function S(e,t){const n=V(e,t.include,x.INCLUDE),i=V(e,t.exclude,x.EXCLUDE);return{include:n.layerViewUids,exclude:i.layerViewUids,graphics:{include:n.graphicUids,exclude:i.graphicUids},mediaElements:{include:n.mediaElements,exclude:i.mediaElements}}}function V(e,i,r,s={layerViewUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!i)return s;if(i instanceof t)!function(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}(s,b(i)),r===x.INCLUDE&&(null!=e.graphicsView&&i.layer===e?R(s,e.graphicsView.uid):i.layer&&L(s,e,i.layer.uid));else if("layer"in i&&"element"in i)!function(e,t){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(t)}(s,i.element),r===x.INCLUDE&&L(s,e,i.layer.uid);else if(n.isIterable(i))for(const t of i)t===e.graphics&&null!=e.graphicsView?R(s,e.graphicsView.uid):t===e.map.ground?R(s,I.terrainId):V(e,t,r,s);else"uid"in i&&L(s,e,i.uid);return s}function L(e,t,n){const i=t.allLayerViews.find((e=>e.layer.uid===n));i&&R(e,i.uid)}function R(e,t){e.layerViewUids||(e.layerViewUids=new Set),e.layerViewUids.add(t)}const T=r.create();var x;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(x||(x={})),e.computeMapPointFromVec3d=U,e.externalToInternalIntersectOptions=S,e.getGraphicFilterUid=b,e.hitTest=async function(e,t,n,r){const s=n?S(e,n):r,c=i.createScreenPointArray(t.x,t.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const l=new p.Intersector(e.state.viewingMode);l.options.selectionMode=!0,l.options.store=g.StoreResults.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(c,l,s);const o=await async function(e,t,n){const i=new Array;let r,s=null;const c={defer(e){r=e()}};for(let l=0;l<t.length;l++){const o=t[l],u=m.toOwner(o,e);if(null!=u&&(u===e.map.ground||"type"in u&&a.isIntegratedMeshLayer(u.type)))break;const d=m.toHit(o,e,c)??await r;if(r=null,null==d)continue;if("graphic"===d.type){if(null==s&&l!==t.length-1&&(s=new Set),null!=s){const e=b(d.graphic);if(s.has(e))continue;s.add(e)}if(!w(n,d.graphic))continue}const p=h(e,o),g=o.distanceInRenderSpace;if("media"===d.type){const e=d.element.toSource(p);i.push({...d,mapPoint:p,distance:g,sourcePoint:e})}else i.push({...d,mapPoint:p,distance:g})}return i}(e,l.results.all,s.graphics),d=l.results.ground,y=m.toOwner(d,e),I=null!=y&&"type"in y&&a.isIntegratedMeshLayer(y.type)?y:null,E={screenPoint:t,results:o,ground:{mapPoint:h(e,d),distance:f.isValidIntersectorResult(d)?d.distanceInRenderSpace:0,layer:I}};return u.debugFlags.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(E.intersector=l),E},e.intersectResultToMapPoint=h,e.toMap=function(e,t,n,r){const s=n?S(e,n):r,c=!(!s.graphics?.include&&!s.graphics?.exclude),l=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),o=i.screenPointObjectToArray(t);s.enableDraped=s.include&&!s.include.has(I.terrainId)||s.exclude?.has(I.terrainId);const a=e.sceneIntersectionHelper,u=new p.Intersector(e.state.viewingMode);if(u.options.selectionMode=!0,u.options.store=c||l?g.StoreResults.ALL:g.StoreResults.MIN,u.options.excludeLabels=n?.excludeLabels??!1,a.intersectIntersectorScreen(o,u,s),c||l){for(const t of u.results.all){const n=m.toHit(t,e);if(null==n)return h(e,t);if(c&&("graphic"!==n.type||w(s.graphics,n.graphic)))return h(e,t);if(l&&("media"!==n.type||E(s.mediaElements,n.element)))return h(e,t)}return null}return h(e,u.results.min)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));