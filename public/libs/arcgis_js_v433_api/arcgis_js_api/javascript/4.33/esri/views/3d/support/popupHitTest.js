// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../layers/support/layerUtils","../terrain/LayerClass","../../support/hitTestSelectUtils"],(function(e,a,t,r){"use strict";const s={layerUids:new Set,layerViews:[]};e.popupHitTest=async function(e,n){const{results:i,ground:l}=await r.hitTestSelectSimilarDistance(e,n),o=(!l.layer||!a.isIntegratedMeshLayer(l.layer.type))&&l.mapPoint,y=[],c=function(e){const a=new Map;for(const t of e.allLayerViews){const e=t.layer.uid;a.set(e,t)}return a}(e),p=o?function(e,a){const r=new Set,s=new Set;for(let a=e.basemapTerrain.numLayers(t.LayerClass.MAP)-1;a>=0;a--){const n=e.basemapTerrain.layerViewByIndex(a,t.LayerClass.MAP);r.add(n.layer.uid),s.add(n)}const n=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:e}of n){const t=a.get(e);t&&(r.add(e),s.add(t))}return{layerUids:r,layerViews:Array.from(s).reverse()}}(e,c):s;let d=0,u=0;const f=()=>{const e=p.layerViews[u];o&&e&&"fetchPopupFeaturesAtLocation"in e&&y.push({mapPoint:l.mapPoint,layerView:e}),++u};let w=null;for(;d<i.length||u<p.layerViews.length;){const a=i[d];if(a&&"graphic"!==a.type)++d;else if("scene"!==a?.layer?.type||a?.layer?.parent!==e?.map?.basemap)if(a){const e=a.layer?.uid,t=p.layerUids.has(e)&&a.distance===l.distance,r=c.get(a.layer?.uid);if(w??=a.mapPoint,u<p.layerViews.length&&(t||(a.distance??0)>l.distance)&&p.layerViews[u]!==r){f();continue}y.push({graphic:a.graphic,layerView:r}),++d}else f();else++d}return w??=l.mapPoint,{hits:y,location:w}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));