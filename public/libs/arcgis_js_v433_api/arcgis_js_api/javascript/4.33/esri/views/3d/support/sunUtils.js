// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Logger","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../ViewingMode","../../../chunks/SunCalc","./mathUtils"],(function(t,e,i,o,n,a,l,r,c,s,u,m){"use strict";const d={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class f{constructor(t,e){this.direct=t,this.ambient=e}}function g(t,e,i){e===s.ViewingMode.Global?r.normalize(_,t.eye):r.set(_,0,0,1),r.scale(k,t.viewForward,-1);const n=m.angle(k,_),a=Math.max(n-2*$,0),l=.85*a/(a+1),c=Math.max($,n-$-l);o.fromRotation(U,-c,t.viewRight),r.transformMat4(i,k,U),r.add(i,i,r.scale(X,t.viewRight,j)),r.normalize(i,i)}function p(t,e,n,a){const l=y,c=o.identity(b);if(n===s.ViewingMode.Global)u.SunCalc.getPosition(t,0,0,l),r.set(a,0,0,-1),o.rotateX(c,c,-l.azimuth),o.rotateY(c,c,-l.altitude),r.transformMat4(a,a,c);else{const n=d.planarDirection,s=n.globalAngles,m=e[2];let f=(Math.abs(m)-n.localAltitude)/(n.globalAltitude-n.localAltitude);f=i.clamp(f,0,1),f<1?(u.SunCalc.getPosition(t,e[1],e[0],l),l.azimuth=(1-f)*l.azimuth+f*s.azimuth,l.altitude=(1-f)*l.altitude+f*s.altitude):(l.azimuth=s.azimuth,l.altitude=s.altitude),r.set(a,0,-1,0),o.rotateZ(c,c,-l.azimuth),o.rotateX(c,c,-l.altitude),r.transformMat4(a,a,c)}}const h=c.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258),b=n.create(),y={azimuth:0,altitude:0};function w(t){switch(t){case"disabled":case"sunny":case"cloudy":return new f(1,1);case"rainy":return new f(.4,1.2);case"snowy":return new f(.5,1.3);case"foggy":return new f(.2,1.6)}}function A(t,e){const i=(t[0]+t[1]+t[2])/3;t[0]+=(i-t[0])*e,t[1]+=(i-t[1])*e,t[2]+=(i-t[2])*e}const M=c.fromValues(.01,.01,.01),v=c.fromValues(1,.6,.5),V=c.fromValues(1,.98,.98),S=c.fromValues(1,1,1),x=c.fromValues(.8,.8,1),T=c.fromValues(.8,.8,1),N=c.fromValues(.98,.98,1),O=c.fromValues(1,1,1),z=l.fromValues(.01,d.local.ambientAtNight),D=l.fromValues(d.local.directAtTwilight,d.local.ambientAtTwilight),P=l.fromValues(.9*d.local.directAtNoon,d.local.ambientAtNoon),C=l.fromValues(d.local.directAtNoon,d.local.ambientAtNoon),I=P,E=V,L=N,G=D,H=v,R=T,F=new Date(0),U=n.create(),_=c.create(),k=c.create(),X=c.create(),$=.25,j=.2;t.ColorAndIntensity=class{constructor(){this.ambient={color:c.fromValues(1,1,1),intensity:.55},this.direct={color:c.fromValues(1,1,1),intensity:.55,directionToLightSource:c.clone(h)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}},t.computeColorAndIntensity=function(t,e,o,n,s,m){r.set(m.ambient.color,1,1,1),m.ambient.intensity=d.global.ambient,r.set(m.direct.color,1,1,1),m.direct.intensity=d.global.direct;const f=e[2],h=i.clamp((Math.abs(f)-d.local.altitude)/(d.global.altitude-d.local.altitude),0,1);let b;if(m.globalFactor=h,null!=t&&(b=u.SunCalc.getTimes(t,e[1],e[0])),h<1){let e;if(null!=t)e=function(t,e,i){const o=t.valueOf();let n,s;e.polarException===u.SunCalc.PolarException.MIDNIGHT_SUN?(n=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,s=n+432e6):e.polarException===u.SunCalc.PolarException.POLAR_NIGHT?(n=o-2,s=o-1):(n=e.sunrise.valueOf(),s=e.sunset.valueOf());const m=s-n,d=n+m/2,f=m/4,g=d-f,p=d+f,h=.06*m,b=n-h/2,y=n+h/2,F=s-h/2,U=s+h/2,_=l.create(),k=c.create(),X=c.create();let $="";if(o<b||o>U)a.copy(_,z),r.copy(k,M),r.copy(X,x),$="night";else if(o<y){const t=(o-b)/(y-b);a.lerp(_,z,D,t),r.lerp(k,M,v,t),r.lerp(X,x,T,t),$="sun rising"}else if(o<g){const t=(o-y)/(g-y);a.lerp(_,D,P,t),r.lerp(k,v,V,t),r.lerp(X,T,N,t),$="early morning"}else if(o<d){const t=(o-g)/(d-g);a.lerp(_,P,C,t),r.lerp(k,V,S,t),r.lerp(X,N,O,t),$="late morning"}else if(o<p){const t=(o-d)/(p-d);a.lerp(_,C,I,t),r.lerp(k,S,E,t),r.lerp(X,O,L,t),$="early afternoon"}else if(o<F){const t=(o-p)/(F-p);a.lerp(_,I,G,t),r.lerp(k,E,H,t),r.lerp(X,L,R,t),$="late afternoon"}else if(o<U){const t=(o-F)/(U-F);a.lerp(_,G,z,t),r.lerp(k,H,M,t),r.lerp(X,R,x,t),$="sun setting"}let j=0;switch(i){case"rainy":case"foggy":j=.8;break;case"snowy":j=.5}j>0&&(A(k,j),A(X,j));const q=w(i);return{direct:{intensity:_[0]*q.direct,color:k},ambient:{intensity:_[1]*q.ambient,color:X},timeOfDay:$}}(t,b,n);else{const t=w(n);e={direct:{intensity:d.local.directAtNoon*t.direct,color:c.fromValues(1,1,1)},ambient:{intensity:d.local.ambientAtNoon*t.ambient,color:c.fromValues(1,1,1)},timeOfDay:"early afternoon"}}r.lerp(m.ambient.color,e.ambient.color,m.ambient.color,h),m.ambient.intensity=i.lerp(e.ambient.intensity,m.ambient.intensity,h),r.lerp(m.direct.color,e.direct.color,m.direct.color,h),m.direct.intensity=i.lerp(e.direct.intensity,m.direct.intensity,h),m.specularStrength="rainy"===n||"snowy"===n||"foggy"===n?0:1,m.environmentStrength="rainy"===n?.7:"snowy"===n||"foggy"===n?.75:1}m.noonFactor=null!=t?function(t,e){const o=t.valueOf();let n,a;e.polarException===u.SunCalc.PolarException.MIDNIGHT_SUN?(n=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=n+432e6):e.polarException===u.SunCalc.PolarException.POLAR_NIGHT?(n=o-2,a=o-1):(n=e.sunrise.valueOf(),a=e.sunset.valueOf());const l=n+(a-n)/2;return 1-i.clamp(Math.abs(o-l)/432e5,0,1)}(t,b):1,null!=t?p(t,e,o,m.direct.directionToLightSource):g(s,o,m.direct.directionToLightSource)},t.computeDirectionsOverTime=function(t,i,o,n,a,l){const r=t.getTime(),s=Math.max(0,i.getTime()-r),u=Math.floor(s/o)+1,m=Math.min(l,u),d=new Array(m),f=1===m?0:s/(m-1);u>m&&e.getLogger("esri.views.3d.support.sunUtils").warnOnce("computeDirectionsOverTime",`Requested interval ${o} exceeds maximum supported interval of ${Math.floor(f)} based on the provided time range.`);for(let t=0;t<m;++t)F.setTime(r+f*t),d[t]=c.create(),p(F,n,a,d[t]);return d},t.computeShadowsEnabled=function(t,e){if(e===s.ViewingMode.Global)return!0;const i=d.planarDirection;return Math.abs(t)<i.localAltitude},t.computeVirtualLightDirection=g,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));