// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/Evented","../../../core/has","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/reactiveUtils","../../../core/SetUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat4","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../layers/interfaces","../support/debugFlags","./interfaces","./Overlay","./OverlayContent","./OverlayRenderTargets","../webgl/RenderCamera","../webgl-engine/core/shaderLibrary/ShaderOutput","../webgl-engine/core/shaderLibrary/terrain/Overlay.glsl","../../../chunks/TextureOnly.glsl","../webgl-engine/effects/RenderPlugin","../webgl-engine/effects/highlight/Highlight","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/GLMaterialRepository","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/Material","../webgl-engine/lib/OITPass","../webgl-engine/lib/RenderContext","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/ShadowMap","../webgl-engine/lib/TextureTechnique","../webgl-engine/lib/TextureTechniqueConfiguration","../webgl-engine/lib/Update","../webgl-engine/lib/UpdatePolicy","../webgl-engine/lighting/Lightsources","../../../chunks/OverlayCompositing.glsl","../webgl-engine/shaders/OverlayCompositingTechnique","../../support/Scheduler","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor"],(function(e,r,t,s,i,n,a,o,d,l,h,c,u,g,p,_,y,m,R,O,v,T,f,b,S,x,C,D,w,P,E,M,A,I,W,q,F,L,N,V,k,G,H,U,B,z,Y){"use strict";e.OverlayRenderer=class extends C.SyncRenderPlugin{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new G.OverlayCompositingPassParameters,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new a,this._passParameters=new x.TextureOnlyPassParameters,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new f,this.events=new t,this.longitudeCyclical=null,this.produces=new Map([[W.RenderSlot.DRAPED_MATERIAL,e=>e!==b.ShaderOutput.Highlight||this.hasHighlights],[W.RenderSlot.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this._view,r=e.stage,t=r.renderer.fboCache,{waterTextures:s,techniques:i}=r.renderView;this._renderContext=new I.RenderContext(this._rctx,new q.ShadowMap(t,e.state.viewingMode),i),this.addHandles([o.watch((()=>s.updating),(()=>this.events.emit("content-changed")),o.syncAndInitial),o.watch((()=>this.spatialReference),(e=>this._localOriginFactory=new E.GridLocalOriginFactory(e)),o.syncAndInitial),o.on((()=>e.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0)),o.watch((()=>D.trackHighlightOptions(e.state.highlights)),(()=>this._sortedDrapeSourceRenderersDirty=!0),o.initial),o.watch((()=>e.state.highlights),(r=>{this._bindParameters.highlights=r,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap}),o.initial),e.resourceController.scheduler.registerTask(U.TaskPriority.OVERLAY_RENDERER,this)]);const{_bindParameters:n,_camera:a}=this;a.near=1,a.far=1e4,a.relativeElevation=null,n.slot=W.RenderSlot.DRAPED_MATERIAL,n.mainDepth=null,n.camera=a,n.oitPass=A.OITPass.NONE,n.updateLighting([new k.AmbientLight(_.ones())],0,0,N.Update.Immediate)}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._passParameters.texture=n.disposeMaybe(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const r=new P.GLMaterialRepository(this._view.stage.renderView.textures,this._techniques,(()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed")));this._pluginContext={...e,materials:r},this._techniques.precompile(H.OverlayCompositingTechnique)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||i.someMap(this._renderers,(e=>e.updating||e.canCompact))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMaterialRenderer(e){for(const r of this._renderers.values()){const t=r.getMaterialRenderer(e);if(t)return t}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map((e=>e.drapeSource.layer)).filter((e=>!!e))}registerDrapeSource(e,r){const t=this._renderers.get(e);null!=t&&t.destroy(),this._renderers.set(e,r),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(o.watch((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e)}removeDrapeSourceRenderer(e){if(null==e)return;const r=this._renderers.get(e);null!=r&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),r.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&d.someSet(e,(e=>e.drapeTargetType===y.DrapeTargetType.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=d.someSet(e,(e=>e.drapeSourceType===y.DrapeSourceType.Features)),this._hasDrapedRasterSource=d.someSet(e,(e=>e.drapeSourceType===y.DrapeSourceType.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,r,t=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new T.OverlayRenderTargets(this._stage.renderer.fboCache),this._overlays=[new O.Overlay,new O.Overlay]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r),this._bindParameters.overlayStretch=t}disposeOverlays(){this._overlays=null,this._renderTargets=n.disposeMaybe(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){return e===v.OverlayContent.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(v.OverlayContent.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,r){let t=!1;for(const[s,i]of this._renderers){if(e.done)break;(s.destroyed||r(s))&&i.commitChanges()&&(t=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,t=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),t&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=i.someMap(this._renderers,(e=>e.hasHighlights)),this.notifyChange("rendersOccludedDraped"))}compact(e){let r=!1;for(const t of this._renderers.values()){if(e.done)break;r=t.compact(e)||r}return r&&this.notifyChange("updating"),r}hasHighlight(e){return i.someMap(this._renderers,(r=>r.hasHighlight(e)))}processSyncDrapeSources(){this._processDrapeSources(U.noBudget,(e=>e.updatePolicy===V.UpdatePolicy.SYNC))}get isEmpty(){return!m.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&!i.someMap(this._renderers,(e=>!e.isEmpty))}get hasWater(){const e=i.someMap(this._renderers,(({hasWater:e})=>e));return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=K,++this._techniques.precompiling;const r=this._sortedRenderers.some((({renderer:e})=>e.precompile(this._renderContext)));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=e,r}renders(e){if(m.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==v.OverlayContent.Occluded&&e!==v.OverlayContent.Highlight)return!0;if(!this._overlays)return!1;const r=this._overlays[R.OverlayIndex.INNER];for(const e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);if(!r.hasSomeSizedView())return!1;const t=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find((r=>r.content===e))?.output??b.ShaderOutput.Color,++this._techniques.precompiling;const s=this._sortedRenderers.some((({renderer:e})=>e.precompile(this._renderContext)));return--this._techniques.precompiling,this._renderContext.output=t,s}get mode(){return this.isEmpty?S.OverlayMode.Disabled:this.hasWater&&this.renders(v.OverlayContent.WaterNormal)?S.OverlayMode.EnabledWithWater:this._renderTargets?.getTexture(v.OverlayContent.Color)?S.OverlayMode.Enabled:S.OverlayMode.Disabled}updateAnimation(e){let r=!1;return this._renderers.forEach((t=>r=t.updateAnimation(e)||r)),r&&this.parent.requestRender(w.RenderRequestType.BACKGROUND),r}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return;const r=this._bindParameters;r.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const e of this._renderTargets.targets){if(e.content===v.OverlayContent.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const t=e.output;this._renderContext.output=t,r.slot=t===b.ShaderOutput.Normal?W.RenderSlot.DRAPED_WATER:W.RenderSlot.DRAPED_MATERIAL,t===b.ShaderOutput.Highlight&&(r.highlightMixTexture=r.highlights.length>1?this._rctx.emptyTexture:null),e.content===v.OverlayContent.Occluded&&(this._renderContext.renderOccludedMask=K),this._sortedRenderers.forAll((({drapeSource:r,renderer:t})=>{e.content===v.OverlayContent.ColorNoRasterImage&&r.drapeSourceType===y.DrapeSourceType.RasterImage||t.precompile(this._renderContext)})),this._renderContext.renderOccludedMask=I.defaultRenderOccludedMask,r.highlightMixTexture=null}--this._techniques.precompiling}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;for(const e of this._renderTargets.targets){if(e.content===v.OverlayContent.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=this._drawTarget(R.OverlayIndex.INNER,e),t=this._drawTarget(R.OverlayIndex.OUTER,e);(r||t)&&e.fbo.generateMipMap()}}}_drawTarget(e,r){const t=this._overlays[e],s=t.canvasGeometries;if(0===s.numViews)return!1;const i=this._view.state.contentPixelRatio;this._screenToWorldRatio=i*t.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:n}=r;if(this.isEmpty||n===b.ShaderOutput.Normal&&!this.hasWater||!t.hasSomeSizedView())return!1;const{_rctx:a,_camera:o,_renderContext:d,_bindParameters:l}=this;if(o.pixelRatio=t.pixelRatio*i,d.output=n,l.screenToWorldRatio=this._screenToWorldRatio,l.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,l.slot=n===b.ShaderOutput.Normal?W.RenderSlot.DRAPED_WATER:W.RenderSlot.DRAPED_MATERIAL,r.content===v.OverlayContent.Occluded&&(d.renderOccludedMask=K),!this.renders(r.content))return d.renderOccludedMask=I.defaultRenderOccludedMask,!1;const{resolution:h}=t,c=e===R.OverlayIndex.INNER,u=c?0:h;if(a.setViewport(u,0,h,h),this._bindTargetFBO(r),c)if(r.output!==b.ShaderOutput.Highlight)a.setClearColor(0,0,0,0),a.clear(B.FramebufferBit.COLOR);else{const{gl:e}=a;e.clearBufferuiv(e.COLOR,0,[0,0,0,0])}if(m.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&r.content!==v.OverlayContent.Occluded&&r.content!==v.OverlayContent.Highlight){this._techniques.precompile(F.TextureTechnique,Z);const r=this._techniques.get(F.TextureTechnique,Z);for(let i=0;i<s.numViews;i++)this._setViewParameters(s.extents[i],t),this._ensureDebugPatternResources(t.resolution,j[e]),a.bindTechnique(r,l,this._passParameters),a.screen.draw()}if(r.output===b.ShaderOutput.Highlight){const{fboCache:t}=this._stage.renderer,s=this._resolution;this._bindTargetFBO(r),D.renderHighlightBuffer(a,t,{width:s,height:s},l,(()=>this._renderAllGeometry(e,r)),u)}else this._renderAllGeometry(e,r);return a.bindFramebuffer(null),d.renderOccludedMask=I.defaultRenderOccludedMask,!0}_renderAllGeometry(e,r){const t=this._overlays[e],s=t.canvasGeometries;this._sortedRenderers.forAll((({drapeSource:i,renderer:n})=>{if(r.content===v.OverlayContent.ColorNoRasterImage&&i.drapeSourceType===y.DrapeSourceType.RasterImage)return;const{fullOpacity:a}=i,o=null!=a&&a<1&&r.output===b.ShaderOutput.Color&&this._bindTemporaryFBO();for(let e=0;e<s.numViews;e++)this._setViewParameters(s.extents[e],t),n.render(this._renderContext);if(o){this._bindTargetFBO(r),this._overlayParameters.texture=o.getTexture(),this._overlayParameters.opacity=a,this._overlayParameters.overlayIndex=e;const t=this._techniques.get(H.OverlayCompositingTechnique);this._rctx.bindTechnique(t,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),o.release()}}))}_bindTargetFBO(e){const r=this._resolution,t=2*r;e.fbo.bind(this._rctx,t,r)}_bindTemporaryFBO(){const e=this._resolution,r=2*e,t=this._stage.renderer.fboCache,s=t.acquire(r,e,"overlay tmp");return t.rctx.bindFramebuffer(s.fbo),t.rctx.clear(B.FramebufferBit.COLOR),s}get _resolution(){return this._overlays?.[R.OverlayIndex.INNER].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,r,t,s){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(const{renderer:n}of this._sortedRenderers)i=n.intersect?.(e,r,t,s,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this._view.map.allLayers,r=e.length;this._renderers.forEach(((t,s)=>{const i=e.indexOf(s.layer),n=i>=0,a=s.renderGroup??(n?y.DrapedRenderGroup.MapLayer:y.DrapedRenderGroup.ViewLayer),o=s.drapeSourcePriorityOffset??0,d=r*a+(n?i:0)+o;this._sortedRenderers.push(new X(s,t,d))})),this._sortedRenderers.sort(((e,r)=>e.index-r.index))}_setViewParameters(e,r){const t=this._camera;t.viewport=[0,0,r.resolution,r.resolution],g.ortho(t.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],t.near,t.far),g.fromTranslation(t.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,r){if(p.set(this._passParameters.color,r[0],r[1],r[2]),this._passParameters.texture)return;const t=new Uint8Array(e*e*4);let s=0;for(let r=0;r<e;r++)for(let i=0;i<e;i++){const n=Math.floor(i/10),a=Math.floor(r/10);n<2||a<2||10*n>e-20||10*a>e-20?(t[s++]=255,t[s++]=255,t[s++]=255,t[s++]=255):(t[s++]=255,t[s++]=255,t[s++]=255,t[s++]=1&n&&1&a?1&i^1&r?0:255:1&n^1&a?0:128)}const i=new Y.TextureDescriptor(e);i.samplingMode=B.TextureSamplingMode.NEAREST,this._passParameters.texture=new z.Texture(this._rctx,i,t)}get test(){}},r.__decorate([l.property()],e.OverlayRenderer.prototype,"hasHighlights",void 0),r.__decorate([l.property()],e.OverlayRenderer.prototype,"_sortedDrapeSourceRenderersDirty",void 0),r.__decorate([l.property({constructOnly:!0})],e.OverlayRenderer.prototype,"parent",void 0),r.__decorate([l.property({readOnly:!0})],e.OverlayRenderer.prototype,"_techniques",null),r.__decorate([l.property({type:Boolean,readOnly:!0})],e.OverlayRenderer.prototype,"updating",null),r.__decorate([l.property()],e.OverlayRenderer.prototype,"isEmpty",null),r.__decorate([l.property({readOnly:!0})],e.OverlayRenderer.prototype,"rendersOccludedDraped",null),e.OverlayRenderer=r.__decorate([u.subclass("esri.views.3d.terrain.OverlayRenderer")],e.OverlayRenderer);class X{constructor(e,r,t){this.drapeSource=e,this.renderer=r,this.index=t}}const j=[[1,.5,.5],[.5,.5,1]],K=M.RenderOccludedFlag.OccludeAndTransparent,Z=new L.TextureTechniqueConfiguration;Z.hasAlpha=!0,e.drapedZ=-2,e.overlayRenderOccludedFlag=K,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));