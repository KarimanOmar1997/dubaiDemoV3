// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/SpatialReference","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","./PatchGeometryFactory","./Tile","./TileFrustumVisibility","../webgl-engine/lib/RayIntersections"],(function(e,t,r,i,o,n,a,s,l,u,c){"use strict";class h extends l.Tile{constructor(e,t,r,i,o){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=n.create(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,r,i,o)}init(e,o,n,s,l){super.init(e,o,n,s,l);const u=l.view.renderSpatialReference,c=l.spatialReference,h=null!=u&&a.isPlateCarree(u)&&null!=c&&c.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=h;const{isWebMercatorOnPlateCarree:d}=l,m=this._extentInRenderSR,b=this.extent;if(d){const e=t.fromValues(b[0],b[1],0);i.projectVectorToVector(e,r.WebMercator,e,r.PlateCarree);const o=t.fromValues(b[2],b[3],0);i.projectVectorToVector(o,r.WebMercator,o,r.PlateCarree),m[0]=e[0],m[1]=e[1],m[2]=o[0],m[3]=o[1]}else for(let e=0;e<4;++e)m[e]=b[e]*h;this.centerAtSeaLevel[0]=.5*(m[0]+m[2]),this.centerAtSeaLevel[1]=.5*(m[1]+m[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(m[2]-m[0],m[3]-m[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),r=.5*(e[3]-e[1]),i=Math.sqrt(t*t+r*r),o=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(i,o);this._center[l.CenterPosition.MIDDLE][3]=n}_calculateFrustumVisibility(e){const t=this._aabb(),r=t[0],i=t[1],o=t[2],n=t[3],a=t[4],s=t[5];let l=!0;for(let t=0;t<6;t++){const c=e[t],h=c[0],d=c[1],m=c[2],b=c[3];if(h*(h>0?r:n)+d*(d>0?i:a)+m*(m>0?o:s)+b>=0)return u.TileFrustumVisibility.OUTSIDE;l=l&&h*(h<0?r:n)+d*(d<0?i:a)+m*(m<0?o:s)+b<=0}return l?u.TileFrustumVisibility.INSIDE:u.TileFrustumVisibility.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return o.wrap(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,r,i){return d[0]=1/t[0],d[1]=1/t[1],d[2]=1/t[2],c.intersectAabbInvDirBefore(this._aabb(),e,d,r,i)}createGeometry(){s.createPlanarGlobePatch(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,r=this.renderData;let i=e,o=t;if(r){const e=r.geometry.boundingBox;i=e[2],o=e[5]}else if(!this.leaf){i=1/0,o=-1/0;for(const e of this.children){const t=e;i=Math.min(i,t._subtreeGeometryElevationBoundMin),o=Math.max(o,t._subtreeGeometryElevationBoundMax)}}if(i!==this._subtreeGeometryElevationBoundMin||o!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=i,this._subtreeGeometryElevationBoundMax=o;const e=this.parent;e?._updateSubtreeGeometryElevationsBounds()}}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){s.updateCornersPlanar(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){s.updateEdgesAndCornersPlanar(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){s.updateEdgeElevationsAndResolutionsPlanar(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}}const d=t.create();e.PlanarPatch=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));