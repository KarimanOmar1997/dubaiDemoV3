// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../Color","../../../core/has","../../../core/maybe","../../../core/MemCachePool","../../../core/ObjectPool","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/buffer/BufferView","../../ViewingMode","./interfaces","./LayerClass","./OverlayContent","./OverlayRenderer","./PatchRenderData","./RenderOrder","./TerrainAttributesCache","./terrainUtils","./TileRenderer","./TileUpdate","./tileUtils","./TransparencyMode","../webgl-engine/collections/Component/ComponentIntersectionData","../webgl-engine/core/shaderLibrary/ShaderOutput","../webgl-engine/core/shaderLibrary/terrain/TileBlendInput","../webgl-engine/effects/RenderPlugin","../webgl-engine/lib/Attribute","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/IntersectorInterfaces","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/IntersectorType","../webgl-engine/lib/Material","../webgl-engine/lib/RayIntersections","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/VertexAttribute","../webgl-engine/lib/verticalOffsetUtils","../webgl-engine/materials/DrawParameters","../../../chunks/Terrain.glsl","../webgl-engine/shaders/TerrainTechnique","../webgl-engine/shaders/TerrainTechniqueConfiguration","../../webgl/enums"],(function(e,t,r,i,n,s,a,l,o,d,c,u,h,p,g,_,f,y,b,T,R,O,m,S,x,v,P,w,D,C,E,A,I,N,B,M,U,F,q,G,k,L,V,z,H,j,Y,Z,Q,W){"use strict";const X=_.create();e.TerrainRenderer=class extends N.SyncRenderPlugin{get _isGlobal(){return this._stage.viewingMode===y.ViewingMode.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,r,i,n,l){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=r,this._ellipsoidRadius=i,this._compressionTracker=n,this.type=q.IntersectorType.TERRAIN,this.isGround=!0,this._passParameters=new Y.TerrainPassParameters,this._drawParameters=new j.DrawParameters,this._renderDataPool=new a(m.PatchRenderData),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new D.IteratorPreorder,this._castShadows=!1,this._inViewshed=!1,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=G.RenderOccludedFlag.Occlude,this.produces=new Map([[L.RenderSlot.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===C.TransparencyMode.Opaque],[L.RenderSlot.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===C.TransparencyMode.Transparent||this.transparency===C.TransparencyMode.InvisibleWithDraped)],[L.RenderSlot.OCCLUDED_GROUND,()=>this._produces()&&this.renderOccludedFlags===O.overlayRenderOccludedFlag]]),this._tileSize=256,this._configuration=new Q.TerrainTechniqueConfiguration(t.viewingMode===y.ViewingMode.Global),this._tileTextureCache=new s.MemCachePool(((e,t)=>l.newCache(e,t)),"TileTexture"),this.tileGeometryCache=new x.TerrainAttributesCache(l)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(l.watch((()=>this._overlayRenderer.rendersOccludedDraped),(e=>{this.renderOccludedFlags=e?O.overlayRenderOccludedFlag:G.RenderOccludedFlag.Occlude,this.setNeedsRender()}),l.sync))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?N.ConsumesDepth:N.ConsumesNone}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerViewUid(){return H.terrainId}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._configuration.screenSizePerspective!==e&&(this._configuration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,w.TileUpdate.TEXTURE_FADING)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const r=g.fromValues(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,r)??!1}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===w.TileUpdate.TEXTURE_FADING?b.TextureUpdate.FADING:b.TextureUpdate.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const t of e.layerInfo[T.LayerClass.ELEVATION])t.pendingUpdates&=~w.TileUpdate.GEOMETRY;e.resetPendingUpdate(w.TileUpdate.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return p.ZEROS;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=M.RenderRequestType.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=M.RenderRequestType.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=M.RenderRequestType.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new P.TileRenderer(this._rctx,this._tileSize,this._techniques,this._tileTextureCache,this._compressionTracker),this.updateTileBackground()}uninitializeRenderContext(){this._tileRenderer=n.disposeMaybe(this._tileRenderer)}intersect(e,t,r,i){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==C.TransparencyMode.Opaque)return;const n=K,s=J;h.subtract(n,i,r),h.set(s,1/n[0],1/n[1],1/n[2]);const a=e.results.min,l=e.results.max,o=e.results.ground,d=e.options.store===U.StoreResults.MIN,c=!!e.results.ground.target,u=H.getVerticalOffsetTerrain(e.verticalOffset),p=e.tolerance;let g,y=d&&null!=a.distance?a.distance:1/0;const b=e.options,T=b.normalRequired||!b.backfacesTerrain,R=new k.MeshIntersectionOptions(!1,T),O=c=>{const O=c.renderData;if(!O?.vao)return;const m=O.geometry;_.set(X,m.boundingBox);const S=O.localOrigin;null!=u&&(u.localOrigin=S,u.applyToAabb(X));const x=X;if($[0]=r[0]-S[0],$[1]=r[1]-S[1],$[2]=r[2]-S[2],!k.intersectAabbInvDirBefore(x,$,s,p,y))return;const v=(e,t,r)=>{e.set(this.type,c,t,r),y=d&&null!=a.distance?a.distance:1/0},P=(s,d,c)=>{if((!T||null!=c)&&s>=0&&(b.backfacesTerrain||h.dot(c,n)<0)&&(b.invisibleTerrain||!b.selectionMode||null==t||t(r,i,s))){if((null==o.distance||s<o.distance)&&v(o,s,c),b.isFiltered)return;b.store===U.StoreResults.ALL&&(null==g?(g=new F.IntersectorResult(e.ray),v(g,s,c),e.results.all.push(g)):s<g.distance&&v(g,s,c)),(null==a.distance||s<a.distance)&&v(a,s,c),b.store!==U.StoreResults.MIN&&(null==l.distance||s>l.distance)&&v(l,s,c)}},w=ee;h.subtract(w,i,S);const{indices:D,indexCount:C}=m,A=m.vertexAttributes,I=A.getField(z.VertexAttribute.POSITION,f.BufferViewVec3f),N=new B.Vertices(I.typedBuffer,3,A.stride/4),M=C/3;if(!u&&M>E.componentMinimalSizeForIntersectionData){const e=c.renderData;null==e.intersectionData&&(e.intersectionData=new E.ComponentIntersectionData(D,0,M,N)),e.intersectionData.intersectRay($,w,R,P)}else k.intersectTriangles($,w,0,M,D,N,u,R,P)},m=this._rootTiles;null!=m&&(()=>{const t=this._tileIterator;t.reset(m);const i=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||i&&e.intersectsClippingArea)||null==u&&!e.intersectsRay(r,n,p,y)||c&&this._useStencilForTile(e)?t.skipSubtree():O(e)})()}processScaleRangeQueries(e,t){if(!t.done&&e)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const r of t)null!=r.renderData?.textureReference&&e.queriesForTile(r);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!i("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const r=e.bind.viewshedEnabled;if(this._inViewshed!==r&&(this._inViewshed=r,this._patchesByOriginDirty=!0),e.bind.slot===L.RenderSlot.OCCLUDED_GROUND){if(0===(e.renderOccludedMask&O.overlayRenderOccludedFlag))return null}else{const t=this.transparency===C.TransparencyMode.Opaque?L.RenderSlot.OPAQUE_TERRAIN:L.RenderSlot.TRANSPARENT_TERRAIN;if(e.bind.slot!==t)return null}if(this.transparency===C.TransparencyMode.Invisible)return null;const n=this._configuration;switch(n.screenSpaceReflections=n.cloudReflections=n.receiveShadows=n.receiveAmbientOcclusion=n.renderOccluded=n.hasHighlightMixTexture=!1,n.overlayMode=this._overlayRenderer.mode,e.output){case A.ShaderOutput.Color:case A.ShaderOutput.ColorEmission:{n.screenSpaceReflections=null!=e.bind.ssr.lastFrameColor,n.cloudReflections=null!=e.bind.clouds.data,n.receiveShadows=e.bind.shadowMap.ready;const t=e.bind.slot===L.RenderSlot.OCCLUDED_GROUND;return n.renderOccluded=t,n.receiveAmbientOcclusion=!t&&null!=e.bind.ssao,this._acquireTechnique(e.output)}case A.ShaderOutput.Shadow:case A.ShaderOutput.ShadowExcludeHighlight:return this._castShadows?this._acquireTechnique(A.ShaderOutput.Shadow):null;case A.ShaderOutput.ViewshedShadow:return this._inViewshed?this._acquireTechnique(A.ShaderOutput.ViewshedShadow):null;case A.ShaderOutput.Depth:case A.ShaderOutput.Normal:return this._acquireTechnique(e.output);case A.ShaderOutput.ObjectAndLayerIdColor:return this._acquireTechnique(A.ShaderOutput.ObjectAndLayerIdColor);case A.ShaderOutput.Highlight:return n.hasHighlightMixTexture=null!=e.bind.highlightMixTexture,this._overlayRenderer.hasHighlights?this._acquireTechnique(A.ShaderOutput.Highlight):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case A.ShaderOutput.Color:case A.ShaderOutput.ColorEmission:{const r=e.bind.slot===L.RenderSlot.OCCLUDED_GROUND?R.OverlayContent.Occluded:R.OverlayContent.Color;this._renderMaterialPass(e,t,r);break}case A.ShaderOutput.Depth:case A.ShaderOutput.Normal:this._renderAuxiliaryPass(e,t,R.OverlayContent.Color,this._visiblePatchesByOrigin);break;case A.ShaderOutput.Highlight:{const r=e.bind.highlight?.name;r&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(R.OverlayContent.Highlight)&&this._overlayRenderer.hasHighlight(r)&&this._renderAuxiliaryPass(e,t,R.OverlayContent.Highlight,this._visiblePatchesByOrigin);break}case A.ShaderOutput.Shadow:case A.ShaderOutput.ShadowExcludeHighlight:case A.ShaderOutput.ViewshedShadow:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case A.ShaderOutput.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,R.OverlayContent.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=r.toUnitRGBA(e);i=p.fromValues(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,b.TextureUpdate.FADING))),this._configuration.tileBlendInput=t.backgroundIsGrid?I.TileBlendInput.GridComposite:null!=t.backgroundColor?I.TileBlendInput.ColorComposite:I.TileBlendInput.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==S.RenderOrder.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const r of e)D.sortTiles(this.renderOrder,r,t);e.sort(((e,t)=>D.compareTiles(e[0],t[0],this.renderOrder))),this._visiblePatchesByOrigin=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),r=e.renderData;if(!r){this._numTilesCulled++;continue}const i=r.localOrigin;if(this._castShadows||this._inViewshed){let t=this._allPatchesByOrigin.get(i);t||(t=[],this._allPatchesByOrigin.set(i,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let n=this._visiblePatchesByOrigin.get(i);n||(n=[],this._visiblePatchesByOrigin.set(i,n)),n.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,r,i){const n=e.rctx;this._passParameters.overlayContent=r,n.bindTechnique(t,e.bind,this._passParameters);const s=this._stencilEnabledLayerExtents.length>0;i.forEach((i=>{this._drawParameters.origin=i[0].renderData.localOrigin,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters);for(let n=0;n<i.length;n++)this._renderPatch(e,t,i[n],W.PrimitiveType.TRIANGLES,s,r)})),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,r){const{rctx:i}=e;this._passParameters.overlayContent=r,i.bindTechnique(t,e.bind,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const n=e.bind.camera,s=t.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const e=V.getSettings(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:n.fovY})}const a=this._stencilEnabledLayerExtents.length>0,l=r===R.OverlayContent.Occluded;l&&(s.bindTexture("tex",i.emptyTexture),s.setUniform3fv("textureOpacities",p.ZEROS),s.setUniform4fv("texOffsetAndScale",g.ZEROS));const o=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:p.ZEROS;this._configuration.tileBlendInput===I.TileBlendInput.ColorComposite&&s.setUniform3fv("backgroundColor",o);const d=this.wireframe?W.PrimitiveType.LINES:W.PrimitiveType.TRIANGLES;this._configuration.textureFadingEnabled&&s.bindTexture("texNext",i.emptyTexture);const c=this._visiblePatchesByOrigin;for(const i of c.values()){const n=i[0].renderData.localOrigin;this._drawParameters.origin=n,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const n of i){const i=n.renderData,o=i.textureReference;if(null!=o){if(!l){s.setUniform4fv("texOffsetAndScale",o.offsetAndScale),s.bindTexture("tex",o.texture.texture);const e=i.textureFadeFactor,t=e<1?i.nextTextureReference:null;this._configuration.textureFadingEnabled&&t&&e<1?(s.setUniform1f("fadeFactor",e),s.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),s.setUniform3fv("nextTexOpacities",t.opacities),s.bindTexture("texNext",t.texture.texture)):s.setUniform1f("fadeFactor",1),i.textureIsFading&&this.setNeedsRender(),s.setUniform3fv("textureOpacities",o.opacities)}this._renderPatch(e,t,n,d,a,r),n.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,r,i,n,s){const a=r.renderData,l=a.vao,o=l?.indexBuffer;if(!l||null==o)return void(v.enableTerrainInternalChecks&&console.error("Rendered tile with no indices: ",r.lij," : ",a));const d=t.program;null==s||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(d,a.overlay),n&&(t.useStencil=this._useStencilForTile(r),e.rctx.setPipelineState(t.getPipeline()));const c=a.geometry.indexCount;e.rctx.bindVAO(l),d.assertCompatibleVertexAttributeLocations(l),e.rctx.drawElements(i,c,o.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e){return this._configuration.output=e,this._techniques.get(Z.TerrainTechnique,this._configuration)}get test(){}hasHighlight(e){return this._overlayRenderer.hasHighlight(e)}},t.__decorate([o.property({readOnly:!0})],e.TerrainRenderer.prototype,"_isGlobal",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"renderOccludedFlags",void 0),t.__decorate([o.property({value:!1})],e.TerrainRenderer.prototype,"renderingDisabled",null),t.__decorate([o.property({value:!0})],e.TerrainRenderer.prototype,"visible",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"renderPatchBorders",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"visualizeNormals",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"cullBackFaces",null),t.__decorate([o.property({value:S.RenderOrder.FRONT_TO_BACK})],e.TerrainRenderer.prototype,"renderOrder",null),t.__decorate([o.property()],e.TerrainRenderer.prototype,"wireframe",null),e.TerrainRenderer=t.__decorate([u.subclass("esri.views.3d.terrain.TerrainRenderer")],e.TerrainRenderer);const K=p.create(),J=p.create(),$=p.create(),ee=p.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));