// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/Logger","../../../core/maybe","../../../core/libs/gl-matrix-2/factories/vec2f64","../../2d/engine/imagery/enums","../../2d/engine/vectorTiles/VectorTileRendererHelper3D","./BlendLayersTechnique","./BlendLayersTechniqueConfiguration","./LayerClass","./RasterColorizerTechnique","./RasterColorizerTechniqueConfiguration","./support/MultiSizeFramebuffer","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/terrain/BaseOpacityMode","../webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput","../webgl-engine/core/shaderLibrary/terrain/PremultipliedAlphaSource","../../../chunks/BlendLayers.glsl","../webgl-engine/lib/BindParameters","../webgl-engine/lib/glUtil3D","../../webgl/enums","../../webgl/Texture","../../webgl/Util"],(function(e,t,r,i,s,o,a,n,u,l,d,c,h,_,p,f,b,y,g,T,B,x){"use strict";e.TileCompositor=class{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new o.VectorTileRendererHelper3D,this._bindParameters=new y.BindParameters(null),this._blendConfiguration=new n.BlendLayersTechniqueConfiguration,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=g.createQuadVAO(this._rctx,g.Layout.Pos2Tex)}dispose(){this._fbos.forEach(r.disposeMaybe),this._fbos=null,this._vtFBO=r.disposeMaybe(this._vtFBO),this._vaoQuad=r.disposeMaybe(this._vaoQuad),this._vectorTileHelper=r.disposeMaybe(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendTechnique(e,t,r,i=f.PremultipliedAlphaSource.Off,s=b.BackgroundMode.BelowLayer){return this._blendConfiguration.output=t,this._blendConfiguration.blendMode=e,this._blendConfiguration.baseOpacityMode=r,this._blendConfiguration.premultipliedSource=i,this._blendConfiguration.background=s,this._techniques.precompile(a.BlendLayersTechnique,this._blendConfiguration),this._techniques.get(a.BlendLayersTechnique,this._blendConfiguration)}drawBackground(e,t){const r=this._acquireBlendTechnique(h.LayerBlendMode.Normal,t?p.BlendLayersOutput.ColorComposite:p.BlendLayersOutput.GridComposite,_.BaseOpacityMode.NotRequired,f.PremultipliedAlphaSource.Off,b.BackgroundMode.Only),i=this._rctx.bindTechnique(r,this._bindParameters,e);this._render(i)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(T.PrimitiveType.TRIANGLE_STRIP,0,x.vertexCount(this._vaoQuad,"geometry"))}drawGroup(e,t,r,i,s=f.PremultipliedAlphaSource.On){t===p.BlendLayersOutput.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(r).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture)),e.texture=this.currentFBO(r).colorTexture,this.closeGroup(r);const o=e.baseOpacity<1?_.BaseOpacityMode.Required:_.BaseOpacityMode.NotRequired,a=this._acquireBlendTechnique(i,t,o,s),n=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(n)}drawImageData(e,t,r,i,s=f.PremultipliedAlphaSource.Off){if(null==e.texture)return;const o=e.baseOpacity<1?_.BaseOpacityMode.Required:_.BaseOpacityMode.NotRequired;e.fboTexture=t===p.BlendLayersOutput.GroupBackgroundComposite||i===h.LayerBlendMode.Normal&&o===_.BaseOpacityMode.NotRequired&&s===f.PremultipliedAlphaSource.Off?null:this.switch(r).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture);const a=this._acquireBlendTechnique(i,t,o,s),n=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(n)}drawRasterData(e,t,r,i,s){const o=s.sourceLayerInfo.data;if(!o.source)return;if(s.tile.surface.layerViewByIndex(s.layerIndex,u.LayerClass.MAP).ensureSymbolizerParameters(o),!o.bind(this._rctx))return;const a=e.baseOpacity<1?_.BaseOpacityMode.Required:_.BaseOpacityMode.NotRequired;e.fboTexture=i===h.LayerBlendMode.Normal&&a===_.BaseOpacityMode.NotRequired?null:this.switch(r).colorTexture;const n=this._acquireRasterTechnique(o,t,i,a);if(!n)return;o.opacity=e.opacity;const l=o.getUniforms(this._rctx);l.scale=s.scale,l.offset=s.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const d=this._rctx.bindTechnique(n,this._bindParameters,l);this._render(d)}_acquireRasterTechnique(e,t,r,i){if(!this._rctx.capabilities.colorBufferFloat)return null;const o=e.symbolizerParameters,a=["stretch","lut","hillshade"].indexOf(o.type);return this._rasterConfiguration??=new d.RasterColorizerTechniqueConfiguration,this._rasterConfiguration.output=t,this._rasterConfiguration.blendMode=r,this._rasterConfiguration.baseOpacityMode=i,this._rasterConfiguration.colorizerType=a,this._rasterConfiguration.applyColormap=!!o.colormap,this._rasterConfiguration.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterConfiguration.stretchType=e.hasStretchTypeNone()?s.RasterColorizerStretchType.Noop:s.RasterColorizerStretchType.PerBand,this._techniques.precompile(l.RasterColorizerTechnique,this._rasterConfiguration),this._techniques.get(l.RasterColorizerTechnique,this._rasterConfiguration)}drawVectorData(e,r,s,o,a,n,l,d){const b=this._rctx,y=a.sourceLayerInfo.data,g=a.tile.surface.layerViewByIndex(a.layerIndex,u.LayerClass.MAP),B=e.baseOpacity<1?_.BaseOpacityMode.Required:_.BaseOpacityMode.NotRequired,x=B===_.BaseOpacityMode.Required||e.opacity<1||o!==h.LayerBlendMode.Normal||r!==p.BlendLayersOutput.Composite,m=x?f.PremultipliedAlphaSource.On:f.PremultipliedAlphaSource.Off,O=this._acquireBlendTechnique(o,r,B,m);b.setPipelineState(O.getPipeline());let C=null,q=null;x?(q=this.currentFBO(s),null==this._vtFBO&&(this._vtFBO=new c.MultiSizeFramebuffer(this._rctx)),C=this._vtFBO.get(s),b.bindFramebuffer(C),this._clearCurrentFBO()):d&&b.clear(T.FramebufferBit.DEPTH);try{this._vectorTileHelper.renderBackground(b,a.sourceLod,g.painter,g.layer.styleRepository,g.schemaHelper,Math.round(1/a.scale),a.offset,l,n,g.contentZoom),y&&this._vectorTileHelper.renderContent(b,a.sourceLod,y,a.vtlNeighborInfos,g.painter,g.layer.styleRepository,g.schemaHelper,Math.round(1/a.scale),a.offset,l,n,g.contentZoom)}catch(e){t.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",e)}return!C||(b.bindFramebuffer(q),e.texture=C.colorTexture,e.offset=i.ZEROS,e.scale=1,this.drawImageData(e,r,s,o,m),d)}copyFBOToTexture(e){const t=this._rctx,r=t.bindTexture(e.texture,B.Texture.TEXTURE_UNIT_FOR_UPDATES),i=e.descriptor;t.gl.copyTexImage2D(T.TextureType.TEXTURE_2D,0,i.pixelFormat,0,0,i.width,i.height,0),e.generateMipmap(),t.bindTexture(r,B.Texture.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(T.FramebufferBit.COLOR|T.FramebufferBit.DEPTH|T.FramebufferBit.STENCIL)}_initFBO(e,t,r){this._rctx.bindFramebuffer(e),r&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,r=!0){if(this._current=t,t>=this._fbos.length)for(let e=this._fbos.length;e<=t;e++)this._fbos.push(new c.MultiSizeFramebuffer(this._rctx));this._initFBO(this._fbos[t].get(e),e,r)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),r=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));