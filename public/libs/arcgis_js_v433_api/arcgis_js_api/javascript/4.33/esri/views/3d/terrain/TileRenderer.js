// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/has","../../../core/maybe","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../layers/support/layerUtils","../support/flowUtils","./BlendLayersTechnique","./interfaces","./LayerClass","./NeighborIndex","./TerrainData","./terrainUtils","./TextureFader","./TextureReference","./TileCompositor","./TileRenderInfo","./TileTexture","./TileUpdate","./tileUtils","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput","../webgl-engine/lib/glUtil3D","../../support/TextureCompressionWorkerHandle","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor"],(function(e,t,r,s,a,i,o,n,u,l,c,p,d,h,T,y,m,f,_,x,g,b,L,I,w,O,R,P){"use strict";class C{constructor(e,t,r,s,a,i){this.start=e,this.end=t,this.blendMode=r,this.opacity=s,this.output=a,this.baseOpacity=i}}function k(e,t,r){S.layerIndex=t,S.vtlNeighborInfos.clear();const a=e.layerInfo[c.LayerClass.MAP][t];if(s.set(S.offset,0,0),S.tile=e,S.scale=1,S.sourceLod=e.lij,S.sourceLayerInfo=a,S.isVTLBackground=r,a.data)return r&&e.forEachLoadedNeighbor(((r,s)=>{if(r.level!==e.level)return;const i=r.layerInfo[c.LayerClass.MAP][t];if(!h.isVectorTilePerLayerInfo(i)||a.data===i.data)return;const o=S.vtlNeighborInfos.pushNew();o.offset=D[s],o.sourceLod=r.lij,o.sourceLayerInfo=i})),S;const i=a.upsampleInfo,o=i?.tile?.layerInfo[c.LayerClass.MAP][t];return o&&i.tile?(S.tile=i.tile,s.copy(S.offset,i.offset),S.scale=i.scale,S.sourceLod=i.tile.lij,S.sourceLayerInfo=o,S):r?S:null}function M(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function A(e){let t="normal"!==e.blendMode;return o.isGroupLayer(e.parent)&&(t=A(e.parent)||t),t}function B(e,t){o.isGroupLayer(e.parent)&&B(e.parent,t);const r=e.uid;if(null!=r&&""!==r){const s=E.get(r);s?s.start=t:E.set(r,new C(t,t,e.blendMode,e.opacity,L.BlendLayersOutput.Composite,1))}}const E=new Map,N=new Array,S=new f.TileRenderInfo,U=i.fromValues(0,0,1,1),D=new Array;D[p.NeighborIndex.NORTH]=[0,-1],D[p.NeighborIndex.NORTH_EAST]=[-1,-1],D[p.NeighborIndex.EAST]=[-1,0],D[p.NeighborIndex.SOUTH_EAST]=[-1,1],D[p.NeighborIndex.SOUTH]=[0,1],D[p.NeighborIndex.SOUTH_WEST]=[1,1],D[p.NeighborIndex.WEST]=[1,0],D[p.NeighborIndex.NORTH_WEST]=[1,-1],e.GroupInfo=C,e.TileRenderer=class{constructor(e,t,r,s,a){this._rctx=e,this.tileSize=t,this._techniques=r,this._cache=s,this._compressionTracker=a,this._passParameters=new u.BlendLayersPassParameters,this._backgroundColor=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new m.TileCompositor(this._rctx,this._techniques)}dispose(){this._compositor=r.disposeMaybe(this._compositor),this._backgroundTexture=r.releaseMaybe(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,s=r.baseOpacity;let a=0,i=0,u=this.tileSize,p=!1,d=!1;const T=r.view.state.contentPixelRatio;let y=!1;E.clear(),N.length=0;const m=e.layerInfo[c.LayerClass.MAP];let f=0,_=null;for(;f<m.length;f++){const t=r.layerViewByIndex(f,c.LayerClass.MAP),l=t.layer,b=!g.fallsWithinLayerView(e,t),L=l.opacity,I=t.fullOpacity;if(d=d||o.isBaseLayer(l),n.isLayerViewWithFlowRenderer(t))continue;if(h.isBlendableLayerView(t)){let e="normal"!==t.layer.blendMode;if(o.isGroupLayer(l.parent)){const t=l.parent.uid;null!=t&&""!==t&&(e=A(l.parent)||e)}e&&(y=e,p=!1)}if((b||0===L)&&!y){m[f].pendingUpdates&=~(x.TileUpdate.TEXTURE_NOFADING&x.TileUpdate.TEXTURE_FADING);continue}++i;const w=h.isVectorTileLayerView(t),O=k(e,f,w);if(O){if(m[f].pendingUpdates&=~(x.TileUpdate.TEXTURE_NOFADING&x.TileUpdate.TEXTURE_FADING),o.isGroupLayer(l.parent)){const e=l.parent.uid;null!=e&&""!==e&&B(l.parent,f)}w?u=Math.max(u,this.tileSize*T):1===s&&1===I&&(t.isOpaque||this._dataToTexture(O,o.isReferenceLayer(l))&&O.sourceLayerInfo.data.descriptor.isOpaque)&&(p=!0),++a,null===_&&(_=f)}}const b=u/this.tileSize;0!==a&&null!==_?1===a&&!y&&this._useLayerTexture(e,_)||this._composeLayers(e,t,f-1,d,u,b,!p||y,E,y):this._useBackgroundTexture(e,i,t!==l.TextureUpdate.FADING)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundTexture&&this._drawBackgroundTexture(this._backgroundTexture))}_ensureBackgroundTexture(){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(this.tileSize,!1),this._drawBackgroundTexture(this._backgroundTexture)),this._backgroundTexture}_drawBackgroundTexture(e){this._compositor.bind(this.tileSize),this._passParameters.offset=a.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(e),this._compositor.unbind()}_useBackgroundTexture(e,t,r){const s=e.renderData,a=!r&&null!=s.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?T.ActivationTime.Delayed:T.ActivationTime.Immediate,i=this._ensureBackgroundTexture();s.setTextureReference(new y.TextureReference(i,l.TextureUpdate.FADING,U,e.surface.baseOpacity,0,1),a)}_useLayerTexture(e,t){const r=e.surface.layerViewByIndex(t,c.LayerClass.MAP),s=o.isBaseLayer(r.layer),a=s?e.surface.baseOpacity:1,n=s?1:e.surface.baseOpacity,u=r.fullOpacity,p=k(e,t,!1);return!!this._dataToTexture(p,o.isReferenceLayer(r.layer))&&(e.renderData.setTextureReference(new y.TextureReference(p.sourceLayerInfo.data,l.TextureUpdate.FADING,i.fromValues(p.offset[0],p.offset[1],p.scale,p.scale),a,n,u)),!0)}_composeLayers(e,t,r,s,i,n,u,l,p){this._compositor.ensureBuffer(i);const d=e.surface.baseOpacity;let T=!1,m=O.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,f=!1,_=0;for(let t=r;t>=0;t--){const r=e.surface.layerViewByIndex(t,c.LayerClass.MAP),y=r.layer,x=h.isVectorTileLayerView(r),I=k(e,t,x),w=y.opacity,R=!g.fallsWithinLayerView(e,r);if(!I||(0===w||R)&&!p)continue;const P=!o.isBaseLayer(y)&&!T;P&&(T=!0);let C=!1;l.forEach((e=>{e.start===t&&(e.output=s?L.BlendLayersOutput.Composite:u&&P?this.backgroundIsGrid?L.BlendLayersOutput.GridComposite:L.BlendLayersOutput.ColorComposite:L.BlendLayersOutput.Composite,e.baseOpacity=P?d:1,N.push(e),this._compositor.openGroup(i),C=!0)}));const A=0===_,B=C?L.BlendLayersOutput.GroupBackgroundComposite:u&&A?this.backgroundIsGrid?L.BlendLayersOutput.GridComposite:L.BlendLayersOutput.ColorComposite:L.BlendLayersOutput.Composite,E=b.blendModeFromString[h.isBlendableLayerView(r)?r.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=P&&!C&&d<1?d:1,this._passParameters.opacity=w,h.isVectorTileRenderInfo(I)?f=this._compositor.drawVectorData(this._passParameters,B,i,E,I,n,this.tileSize,f):h.isImageryTileRenderInfo(I)?(this._compositor.drawRasterData(this._passParameters,B,i,E,I),M(I)&&(m=O.TextureSamplingMode.NEAREST)):this._dataToTexture(I,o.isReferenceLayer(y))&&(this._passParameters.texture=I.sourceLayerInfo.data.texture,this._passParameters.offset=I.offset,this._passParameters.scale=I.scale,this._compositor.drawImageData(this._passParameters,B,i,E));N.length>0&&N[N.length-1].end===t;){const e=N.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=a.ZEROS,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,i,b.blendModeFromString[e.blendMode])}_++}const x=e.renderData,I=p||T&&d<1,w=x.ensureTexture(i,I,t,(()=>this._buildTexture(i,I,m)));this._compositor.copyFBOToTexture(w),this._compositor.unbind(),x.setTextureReference(new y.TextureReference(w,t,U,T?1:d,0,1))}_dataToTexture(e,t){if(h.isImageSourceRenderInfo(e)){const r=e.sourceLayerInfo,s=1===e.scale&&!t;r.data=this._buildTexture(r.data,!0,s,e.tile.onCompressionFinished),e.tile.setMemoryDirty()}return h.isTextureTileRenderInfo(e)}_buildTexture(e,t,r=O.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,s=()=>{}){if(null==e)return null;const a=new P.TextureDescriptor;a.wrapMode=O.TextureWrapMode.CLAMP_TO_EDGE,a.samplingMode="boolean"==typeof r?O.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:r,a.maxAnisotropy=this._maxAnisotropy,a.preMultiplyAlpha=!0,a.flipped=!0,a.hasMipmap=!0,t||(a.pixelFormat=O.PixelFormat.RGB);const i=this._rctx,o="boolean"==typeof r&&r;let n;if("number"==typeof e)a.width=a.height=e,n=this._buildTileTexture(a);else if(d.isImageWithType(e))a.isOpaque=e.isOpaque,a.isOpaque&&(a.pixelFormat=O.PixelFormat.RGB),a.width=e.element.width,a.height=e.element.height,n=this._buildTileTexture(a,o,s,e.element);else try{a.width=e.width,a.height=e.height,n=this._buildTileTexture(a,o,s,e)}catch(e){n=new _.TileTexture(I.createEmptyTexture(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const u=i.bindTexture(n.texture,R.Texture.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),i.bindTexture(u,R.Texture.TEXTURE_UNIT_FOR_UPDATES),n}_buildTileTexture(e,t=!1,r=()=>{},s){const a=this._cache.pop(_.getCacheKey(e,!1))??this._cache.pop(_.getCacheKey(e,!0));if(t&&=w.isCompressible(s,e),a)return a.retain(),t?a.texture.enableCompression({compressionTracker:this._compressionTracker,compressionCallback:r}):a.texture.disableCompression(),a.texture.setData(s),a;e.compress=t?{compressionTracker:this._compressionTracker,compressionCallback:r}:void 0;const i=new R.Texture(this._rctx,e,s);return new _.TileTexture(i,this._cache)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));