// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/aaBoundingRect","../../../layers/support/layerUtils","../../ViewingMode","../support/supportedSpatialReference","./terrainUtils","./TilingScheme"],(function(e,t,i,s,r,o,l,n,c,a,h,p,d,g,S){"use strict";e.TilingSchemeLogic=class extends i{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",(()=>this._update())),r.watch((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!h.isTiledLayer(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,i){return null!=g.getTiledLayerInfo(e,t,i)}(t,this.viewSpatialReference,this.viewingMode)||(e=t,"vector-tile"===t?.type||g.isProjectableRasterLayer(t))))),e)if(e.isResolved()){const t=e,i=g.getTiledLayerInfo(t,this.viewSpatialReference,this.viewingMode);if(null!=i){const e=new S.TilingScheme(i.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===p.ViewingMode.Global){const t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=S.TilingScheme.makeWebMercatorAuxiliarySphere(t):d.isSupportedEarthGCS(i)&&(e=S.TilingScheme.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(r.watch((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===p.ViewingMode.Global){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=S.TilingScheme.WebMercatorAuxiliarySphere:d.isSupportedGCSOnGlobe(e)&&(this.tilingScheme=S.TilingScheme.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||a.equals(e,this.extent)||(this.tilingScheme=S.TilingScheme.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}},t.__decorate([o.property()],e.TilingSchemeLogic.prototype,"tilingScheme",void 0),t.__decorate([o.property({readOnly:!0})],e.TilingSchemeLogic.prototype,"extent",void 0),t.__decorate([o.property({value:!1})],e.TilingSchemeLogic.prototype,"tilingSchemeLocked",void 0),t.__decorate([o.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"viewSpatialReference",void 0),t.__decorate([o.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"layers",void 0),t.__decorate([o.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"extentHelper",void 0),t.__decorate([o.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"viewingMode",void 0),e.TilingSchemeLogic=t.__decorate([c.subclass("esri.views.3d.terrain.TilingSchemeLogic")],e.TilingSchemeLogic),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));