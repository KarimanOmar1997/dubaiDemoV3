// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Error","../../webgl/ManagedColorAttachment","../../webgl/ManagedDepthTexture","../../webgl/ManagedFBO","./FBOCacheFormats","./FBOPool","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture"],(function(e,t,a,r,c,h,o,n,i,s){"use strict";function l(e,t=0){return`${e}.color${t}`}function u(e){return`${e}.depth`}const m=new c("default","default",null,(()=>m),(()=>m),(()=>{}));function d(e,t,a){return`${t}x${a}:${e}`}m.release=()=>!1,e.FBOCache=class{constructor(e){this.rctx=e,this._interactive=!1,this._acquired=new Set,this._cache=new o.FBOPool(e.newCache,"FBOCache"),this._depthCache=new o.FBOPool(e.newCache,"DepthAttachmentCache"),this._colorCache=new o.FBOPool(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){const{debugCallback:e}=this;e&&this._acquired.forEach((t=>e(t.name,t.fbo)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>e+t.cachedMemory),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e,this._interactive=e}get interactive(){return this._interactive}acquire(e,a,r,o=h.ColorFormat.RGBA8UNORM){const s=d(o,e,a);let m=this._cache.pop(s);const{rctx:C}=this;if(m){m.retain(),m.setName(r);const e=m.getAttachment(n.DepthStencilAttachment);e&&(e.name=u(r));const a=m.getAttachment(n.ColorAttachment0);a&&(a.name=l(r,0));const{fbo:c}=m;if(!c)throw new t("renderer","attempt to use a none existing framebuffer");C.temporaryBindFramebufferObject(c,(()=>{C.setDrawBuffers([n.ColorAttachment0]),C.unbindTexture(c.colorTexture)}))}else{const t=new i.FramebufferObject(C),d=(t,r,c)=>{r??=h.ColorFormat.RGBA8UNORM;const o=this._acquireColor(r,e,a,c??l(m.name,t-n.ColorAttachment0));return this.rctx.unbindTexture(o.attachment),m.attachColor(o,t),o.release(),m},p=t=>{t??=h.DepthFormat.DEPTH24_STENCIL8;const r=this.acquireDepth(t,e,a,u(m.name));return m.attachDepth(r),r.release(),m},_=()=>{this.debugCallback?.(m.name,m.fbo),this._acquired.delete(m);const e=h.isDepthFormat(o);e&&null!=m?.getAttachment(n.DepthStencilAttachment)||!e&&null!=m?.getAttachment(n.ColorAttachment0)?(e?(m.fbo?.invalidateAttachments([n.DepthStencilAttachment]),m.detachAllColors()):(m.fbo?.invalidateAttachments([n.ColorAttachment0]),m.detachAllButColor0()),this._cache.put(m)):m?.dispose()};m=new c(s,r,t,d,p,_),h.isDepthFormat(o)?m.acquireDepth(o):m.acquireColor(n.ColorAttachment0,o,r)}return this._trackHandle(m)}acquireDepth(e,t,a,c){const o=d(e,t,a);let n=this._depthCache.pop(o);if(n)n.retain(),n.attachment.setShadowFiltering(!1);else{const c=new s.Texture(this.rctx,{...h.DepthTextureFormats[e],width:t,height:a});n=new r.ManagedDepthTexture(o,c,(()=>this._depthCache.put(n)))}return n.name=c,n}_acquireColor(e,t,r,c){const o=d(e,t,r);let n=this._colorCache.pop(o);if(n)n.retain();else{const c=new s.Texture(this.rctx,{...h.ColorFormats[e],width:t,height:r});n=new a.ManagedColorAttachment(o,c,(()=>this._colorCache.put(n)))}return n.name=c,n}_trackHandle(e){return this._acquired.add(e),e}},e.defaultWebGLFBO=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));