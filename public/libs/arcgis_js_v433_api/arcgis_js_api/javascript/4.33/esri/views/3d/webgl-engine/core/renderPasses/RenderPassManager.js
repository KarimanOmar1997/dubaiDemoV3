// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Logger","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./AllRenderPasses","./RenderPassIdentifier","../shaderLibrary/ShaderOutput","../util/TwoVectorPosition","../../effects/RenderPlugin","../../lib/DepthRange","../../lib/RenderSlot"],(function(e,s,t,r,a,i,o,h,n,u,d,l,c,p,m,S,P,_,g){"use strict";e.RenderPassManager=class extends P.SyncRenderPlugin{constructor(){super({}),this.produces=new Map([[g.RenderSlot.OPAQUE_MATERIAL,e=>this._produces(e,g.RenderSlot.OPAQUE_MATERIAL)],[g.RenderSlot.TRANSPARENT_MATERIAL,e=>this._produces(e,g.RenderSlot.TRANSPARENT_MATERIAL)],[g.RenderSlot.INTEGRATED_MESH,e=>this._produces(e,g.RenderSlot.INTEGRATED_MESH)],[g.RenderSlot.OCCLUDED_GROUND,e=>this._produces(e,g.RenderSlot.OCCLUDED_GROUND)]]),this._materialPassParameters=new c.MaterialPassParameters,this._shadowPassParameters=new c.ShadowMapPassParameters,this._highlightPassParameters=new c.HighlightPassParameters,this._viewshedPassParameters=new c.ViewshedShadowMapPassParameters,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new c.AllRenderPasses(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e,s){return!!this._invoke(e,s,(e=>e.count>0))}prepareRender(e){const{_systems:s,_passes:t}=this;if(0!==s.size&&null!=t){for(const e of Object.values(t))e.prepareSubmit();s.forEach((s=>s.submit(t,e.bind)));for(const e of Object.values(t))e.finishSubmit()}}acquireTechniques(e){if(0===this._systems.size)return null;const s=e.output===m.ShaderOutput.Shadow||e.output===m.ShaderOutput.ShadowHighlight||e.output===m.ShaderOutput.ShadowExcludeHighlight?this._shadowPassParameters:e.output===m.ShaderOutput.ViewshedShadow?this._viewshedPassParameters:e.output===m.ShaderOutput.Highlight?this._highlightPassParameters:this._materialPassParameters,t=e.bind;return this._updateParameters(t.camera,s,t.slot),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,((s,t)=>s.acquire(t,e.bind)))}render(e,s){this._invoke(e.output,e.bind.slot,((t,r)=>t.dispatch(r,e.bind,s)))}_invoke(e,s,t){if(null==this._passes)return null;switch(s){case g.RenderSlot.OPAQUE_MATERIAL:switch(e){case m.ShaderOutput.Color:case m.ShaderOutput.ColorEmission:case m.ShaderOutput.Depth:case m.ShaderOutput.Normal:case m.ShaderOutput.ObjectAndLayerIdColor:return t(this._passes.opaque,this._materialPassParameters);case m.ShaderOutput.Highlight:return t(this._passes.highlight,this._highlightPassParameters);case m.ShaderOutput.Shadow:return t(this._passes.shadowMap,this._shadowPassParameters);case m.ShaderOutput.ShadowHighlight:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case m.ShaderOutput.ShadowExcludeHighlight:return t(this._passes.defaultShadowMap,this._shadowPassParameters);case m.ShaderOutput.ViewshedShadow:return t(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case g.RenderSlot.TRANSPARENT_MATERIAL:switch(e){case m.ShaderOutput.Color:case m.ShaderOutput.ColorEmission:case m.ShaderOutput.Depth:case m.ShaderOutput.Normal:case m.ShaderOutput.ObjectAndLayerIdColor:return t(this._passes.transparent,this._materialPassParameters)}break;case g.RenderSlot.INTEGRATED_MESH:switch(e){case m.ShaderOutput.Color:case m.ShaderOutput.ColorEmission:case m.ShaderOutput.Depth:case m.ShaderOutput.Normal:case m.ShaderOutput.ObjectAndLayerIdColor:return t(this._passes.integratedMesh,this._materialPassParameters);case m.ShaderOutput.Highlight:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}break;case g.RenderSlot.OCCLUDED_GROUND:switch(e){case m.ShaderOutput.Color:case m.ShaderOutput.ColorEmission:case m.ShaderOutput.Depth:case m.ShaderOutput.Normal:case m.ShaderOutput.ObjectAndLayerIdColor:return t(this._passes.occludedGround,this._materialPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const s=new _.DepthRange;return this._systems.forEach((t=>s.union(t.queryDepthRange(e)))),s}get hasEmissions(){let e=!1;return this._systems.forEach((s=>e=s.hasEmissions||e)),e}_updateParameters(e,s,t){const r=e.viewInverseTransposeMatrix,a=t===g.RenderSlot.TRANSPARENT_MATERIAL,i=t===g.RenderSlot.OCCLUDED_GROUND;d.set(R,r[3],r[7],r[11]),O.set(R),d.copy(s.transformWorldFromViewTH,O.high),d.copy(s.transformWorldFromViewTL,O.low),d.copy(s.slicePlaneLocalOrigin,R),h.fromMat4(s.transformViewFromCameraRelativeRS,e.viewMatrix),u.copy(s.transformProjFromView,e.projectionMatrix),s.identifier===p.RenderPassIdentifier.Material&&(this._materialPassParameters.transparent=a,this._materialPassParameters.occludedGround=i,h.transpose(w,s.transformViewFromCameraRelativeRS),h.invert(s.transformNormalViewFromGlobal,w))}hasHighlight(e){for(const s of this._systems)if(s.hasHighlight(e))return!0;return!1}},e.RenderPassManager=s.__decorate([o.subclass("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],e.RenderPassManager);const R=l.create(),w=n.create(),O=new S.TwoVectorPosition;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));