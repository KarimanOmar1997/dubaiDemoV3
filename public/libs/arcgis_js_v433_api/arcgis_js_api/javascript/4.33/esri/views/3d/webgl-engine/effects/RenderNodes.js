// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/Logger","../../../../core/PooledArray","../../webgl/utils","../core/FBOCache","../../../webgl/checkWebGLError"],(function(e,r,t,o,s,n){"use strict";e.RenderNodes=class{constructor(e){this._context=e,this._nodes=new t}destroy(){this._nodes.forEach((e=>e.destroy())),this._nodes.clear()}add(e){this._nodes.push(e),n.hasFeatureFlagWebGLDebug&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}remove(e){this._nodes.remove(e),n.hasFeatureFlagWebGLDebug&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}produces(e){return this._nodes.some((({produces:r})=>r===e))}require(e,...r){const t=this._nodes,o=r=>t.reduce(((t,{consumes:o,produces:s})=>t+(!o.required.includes(e)||null!=r&&s!==r?0:1)),0);return 0===r.length?o():r.reduce(((e,r)=>e+o(r)),0)}optional(e,...r){const t=this._nodes,o=r=>t.reduce(((t,{consumes:o,produces:s})=>t+(!o.optional?.includes(e)||null!=r&&s!==r?0:1)),0);return 0===r.length?o():r.reduce(((e,r)=>e+o(r)),0)}updateAnimation(e){return this._nodes.reduce(((r,t)=>t.updateAnimation(e)||r),!1)}precompile(...e){++this._context.techniques.precompiling;for(const r of e)this._nodes.forEach((e=>{e.produces===r&&e.precompile()}));--this._context.techniques.precompiling}render(e,r,t=()=>{}){return this._render(e,r,t)??(o.isManagedFBO(e)?e:s.defaultWebGLFBO)}produce(e,r,t=()=>{}){return this._render(e,r,t)}_render(e,t,o=()=>{}){const s="string"==typeof e?e:e.name,n=this._nodes.filter((({produces:e})=>e===s));if(0===n.length)return;let c="string"==typeof e?null:e;return n.some((e=>{const n=c?[c]:[],d=null==c;for(const r of e.consumes.required){if(r===s){if(d)return!1;continue}const e=t.get(r);if(e)n.push(e);else if("emissive"!==r||!t.get(s)?.hasAttachment(r))return o?.(n),!1}if(e.consumes.optional)for(const r of e.consumes.optional){if(r===s)continue;const e=t.get(r);e&&n.push(e)}try{const o=e.doRender(n);o&&o!==c&&(s!==o.name&&(r.getLogger(e).errorOnce(`RenderNode produced ${o.name}, expected ${s}`),o.setName(s)),c?.release(),c=o,t.set(s,c))}catch(t){r.getLogger(e).errorOnce(t)}return o?.(n),d&&null!=c})),this._context.rctx.enforceState(),c}requireGeometryDepth(){return this._nodes.some((e=>"disabled"!==e.produces&&e.requireGeometryDepth))}get test(){return{nodes:this._nodes}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));