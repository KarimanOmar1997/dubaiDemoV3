// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../webgl","../../core/FBOCacheFormats","../TransparentEnvironment","../../../../../chunks/BloomBlur.glsl","./BloomBlurTechnique","./BloomBlurTechniqueConfiguration","../../../../../chunks/BloomComposition.glsl","./BloomCompositionTechnique","./BloomPresets.glsl","../../lib/basicInterfaces","../../../../webgl/enums"],(function(e,t,r,o,s,i,a,n,l,u,c,m,h,d,p,b,_,g,P,T){"use strict";e.BloomRenderNode=class extends m.TransparentEnvironment{constructor(e){super(e),this.consumes={required:[u.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,"emissive"]},this._blurHorizontalConfiguration=new p.BloomBlurTechniqueConfiguration,this._blurVerticalConfiguration=new p.BloomBlurTechniqueConfiguration,this._compositionParameters=new b.BloomCompositionPassParameters,this._blurParameters=new h.BloomBlurPassParameters,this._blurScale=3.06,this._bloomResults=new Array}initialize(){this.addHandles([o.watch((()=>this._updateFogParameters()),(()=>{}),o.syncAndInitial),o.watch((()=>this.view.qualitySettings.bloom),(e=>{e?(this._enable(),this.precompile()):this._disable()}),o.syncAndInitial)])}destroy(){}_updateFogParameters(){const e=this.view.environment.weather;if("sunny"===e.type||"cloudy"===e.type)this._blurParameters.blurRadius=g.blurRadiusPresets[e.type];else{const t="foggy"===e.type?e.fogStrength:e.precipitation;this._blurParameters.blurRadius=r.lerp(g.blurRadiusPresets.cloudy,g.blurRadiusPresets[e.type],t)}this._compositionParameters.lodFactors=g.lodFactorsPresets[e.type].far,this._compositionParameters.lodFactorsFront=g.lodFactorsPresets[e.type].near,this.requestRender(P.RenderRequestType.UPDATE)}precompile(){this.techniques.precompile(d.BloomBlurTechnique,this._blurHorizontalConfiguration),this._blurVerticalConfiguration.bloomStage=h.BlurDirection.Vertical,this.techniques.precompile(d.BloomBlurTechnique,this._blurVerticalConfiguration),this.techniques.precompile(_.BloomCompositionTechnique)}render(e){const t=e.find((({name:e})=>e===u.InternalRenderCategory.TRANSPARENT_ENVIRONMENT)),r=t.getAttachment(T.ColorAttachment1)?.attachment;if(!r)return t;const o=this.techniques.get(d.BloomBlurTechnique,this._blurHorizontalConfiguration),s=this.techniques.get(d.BloomBlurTechnique,this._blurVerticalConfiguration),i=this.techniques.get(_.BloomCompositionTechnique);if(!o.compiled||!s.compiled||!i.compiled)return this.requestRender(P.RenderRequestType.UPDATE),t;const a=t.getTexture(),n=this.fboCache,{fullWidth:l,fullHeight:m}=this.bindParameters.camera,h=this.renderingContext;let p=r,b=l/2,g=m/2;const B=this._blurParameters.blurRadius;for(let e=0;e<5;e++){const t=n.acquire(b,g,"bloomHorizontal",c.ColorFormat.RGBA16FLOAT);this._blurParameters.color=p,this._prepareFBO(t,b,g),h.bindTechnique(o,this.bindParameters,this._blurParameters),h.screen.draw();const r=n.acquire(b,g,"bloomVertical",c.ColorFormat.RGBA16FLOAT);this._blurParameters.color=t.getTexture(),this._prepareFBO(r,b,g),h.bindTechnique(s,this.bindParameters,this._blurParameters),h.screen.draw(),t.release(),this._bloomResults[e]=r,b=Math.ceil(b/2),g=Math.ceil(g/2),p=this._bloomResults[e].getTexture(),this._blurParameters.blurRadius*=this._blurScale}this._blurParameters.blurRadius=B,this._compositionParameters.color=a,this._compositionParameters.emission=r,this._compositionParameters.bloomTexture0=this._bloomResults[0].getTexture(),this._compositionParameters.bloomTexture1=this._bloomResults[1].getTexture(),this._compositionParameters.bloomTexture2=this._bloomResults[2].getTexture(),this._compositionParameters.bloomTexture3=this._bloomResults[3].getTexture(),this._compositionParameters.bloomTexture4=this._bloomResults[4].getTexture();const R=n.acquire(a.descriptor.width,a.descriptor.height,this.produces);return this._prepareFBO(R,l,m),h.bindTechnique(i,this.bindParameters,this._compositionParameters),h.screen.draw(),this._bloomResults.forEach((e=>e.release())),R.attachDepth(t.getAttachment(T.DepthStencilAttachment)),R.attachColor(t.getAttachment(T.ColorAttachment1),T.ColorAttachment1),R}_prepareFBO(e,t,r){const o=this.renderingContext;o.bindFramebuffer(e.fbo),o.setViewport(0,0,t,r),o.setClearColor(0,0,0,0),o.clear(T.FramebufferBit.COLOR)}get test(){return{compositionParameters:this._compositionParameters,blurParameters:this._blurParameters,setLodFactors:e=>{this._compositionParameters.lodFactors=g.normalizePreset(e)}}}},t.__decorate([s.property()],e.BloomRenderNode.prototype,"consumes",void 0),e.BloomRenderNode=t.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.bloom.BloomRenderNode")],e.BloomRenderNode),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));