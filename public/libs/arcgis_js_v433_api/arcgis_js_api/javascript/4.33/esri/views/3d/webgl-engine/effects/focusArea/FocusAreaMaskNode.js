// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../webgl","../../../webgl/RenderNode","../../core/FBOCacheFormats","./FocusAreaMaskTechnique","../../lib/DefaultVertexAttributeLocations","../../lib/DefaultVertexBufferLayouts","../../lib/VertexArrayObject","../../../../../chunks/FocusAreaMask.glsl","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/NoParameters"],(function(e,t,s,r,o,i,a,n,c,u,h,l,p,d,A,g,f,m){"use strict";e.FocusAreaMaskNode=class extends c{constructor(e){super({...e,view:e.focusAreasView.view}),this.consumes={required:[n.RenderCategory.TRANSPARENT]},this.produces=n.InternalRenderCategory.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new A.FocusAreaMaskDrawParameters}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach((e=>e.dispose())),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(h.FocusAreaMaskTechnique)}render(e){const t=this.techniques.get(h.FocusAreaMaskTechnique),s=this.bindParameters,r=s.camera,o=r.fullViewport[2],i=r.fullViewport[3];if(!t.compiled||!this._vaos)return void this.requestRender();const a=e.find((({name:e})=>e===n.RenderCategory.TRANSPARENT)),c=this.renderingContext,l=this.fboCache.acquire(o,i,n.InternalRenderCategory.FOCUSAREA,u.ColorFormat.RG8UNORM);this.view.stage.renderer.occludedRequiresStencil?(l.acquireDepth(u.DepthFormat.DEPTH24_STENCIL8),c.blitFramebuffer(a.fbo,l.fbo,f.FramebufferBit.DEPTH)):l.attachDepth(a.getAttachment(f.DepthStencilAttachment)),c.bindFramebuffer(l.fbo),c.setClearColor(0,0,0,1),c.clear(f.FramebufferBit.COLOR|f.FramebufferBit.STENCIL),c.setViewport(0,0,o,i);const p=c.bindTechnique(t,s);c.setFaceCullingEnabled(!1),c.setStencilTestEnabled(!0),c.setStencilOpSeparate(f.Face.FRONT,f.StencilOperation.KEEP,f.StencilOperation.INCR_WRAP,f.StencilOperation.KEEP),c.setStencilOpSeparate(f.Face.BACK,f.StencilOperation.KEEP,f.StencilOperation.DECR_WRAP,f.StencilOperation.KEEP),c.setDepthWriteEnabled(!1);for(let e=0;e<this._vaos.length;e++){const t=this._vaos[e],r=this._counts[e];this._maskParameters.origin=this._origins[e],p.bindDraw(s,m.noParameters,this._maskParameters),c.bindVAO(t),c.setDepthTestEnabled(!0),c.setStencilWriteMask(255),c.setStencilFunction(f.CompareFunction.ALWAYS,0,255),c.setColorMask(!1,!1,!1,!1),c.drawArrays(f.PrimitiveType.TRIANGLES,0,r),c.setDepthTestEnabled(!1),c.setStencilWriteMask(0),c.setStencilFunction(f.CompareFunction.NOTEQUAL,0,255),c.setColorMask(!0,!0,!0,!0),c.drawArrays(f.PrimitiveType.TRIANGLES,0,r)}return l}updateGeometries(){this.view.stage&&(this._vaos.forEach((e=>e.dispose())),this._vaos.length=this._counts.length=this._origins.length=0,this.focusAreasView.volumes.forEach((e=>e.forEach((e=>{const t=new Array,s=e.indicesBottom;for(let r=0;r<s.length;r++)t.push(e.positions[3*(s[r]-1)]),t.push(e.positions[3*(s[r]-1)+1]),t.push(e.positions[3*(s[r]-1)+2]);const r=e.indicesExtruded;for(let s=0;s<r.length;s++)t.push(e.positions[3*r[s]]),t.push(e.positions[3*r[s]+1]),t.push(e.positions[3*r[s]+2]);const o=new d.VertexArrayObject(this.renderingContext,l.Default3D,new Map([["geometry",p.Pos3]]),new Map([["geometry",g.BufferObject.createVertex(this.renderingContext,f.Usage.STATIC_DRAW,new Float32Array(t))]]));this._vaos.push(o),this._counts.push(s.length+r.length),this._origins.push(e.origin)})))),this.requestRender())}},t.__decorate([s.property()],e.FocusAreaMaskNode.prototype,"consumes",void 0),t.__decorate([s.property()],e.FocusAreaMaskNode.prototype,"produces",void 0),t.__decorate([s.property({constructOnly:!0})],e.FocusAreaMaskNode.prototype,"focusAreasView",void 0),e.FocusAreaMaskNode=t.__decorate([a.subclass("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],e.FocusAreaMaskNode),e.FocusAreaGeometry=class{constructor(e,t,s,r,o){this.positions=e,this.indicesBottom=t,this.indicesExtruded=s,this.height=r,this.origin=o}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));