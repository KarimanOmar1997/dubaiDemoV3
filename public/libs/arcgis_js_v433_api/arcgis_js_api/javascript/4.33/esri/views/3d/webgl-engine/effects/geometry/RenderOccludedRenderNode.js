// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/PooledArray","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../webgl","../../../webgl/RenderNode","../../core/FBOCacheFormats","../blit/Blit","../../lib/Material","../../lib/RenderSlot","../../shaders/CompositingTechniqueConfiguration","../../../../webgl/enums"],(function(e,r,t,n,d,c,o,s,l,i,a,u,p,h,g,R,f){"use strict";e.RenderOccludedRenderNode=class extends a{constructor(e){super(e),this.consumes={required:[i.InternalRenderCategory.OCCLUDED]},this.produces=i.InternalRenderCategory.OCCLUDED,this._blit=new p.Blit(e.view.stage.renderView.techniques,R.BlitMode.PremultipliedAlpha)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forAll((r=>{e.precompileSlots(r,g.RenderSlot.OCCLUDED_GROUND,g.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL),r.material&&e.precompileOccludedSlots(r,O)}))}render(e){const r=e.find((({name:e})=>e===this.produces));return this._renderOccludedAndTransparentStencil(r),this._renderOccludedComposite(r),r}_renderOccludedAndTransparentStencil(e){const r=this.view.stage.renderer,t=m;t.clear();for(const e of r.plugins.plugins)e.renderOccludedFlags&h.RenderOccludedFlag.OccludeAndTransparentStencil&&t.push(e);0!==t.length&&(r.renderSlots(t,g.RenderSlot.OCCLUDER_MATERIAL),this._renderAndComposite(e,e.getAttachment(f.DepthStencilAttachment),.5,(()=>r.renderSlots(t,g.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL)),!1,!1),t.clear())}_renderOccludedComposite(e){const r=this.view.stage.renderer,t=m;t.clear();let n=0;for(const e of r.plugins.plugins){const r=e.renderOccludedFlags&b;n|=r,r&&t.push(e)}if(!n)return void t.clear();const d=this._getDepthStencilAttachment(e);let c=d.clearStencil;for(const o of O)n&o&&(this._renderAndComposite(e,d.depth,o===h.RenderOccludedFlag.Opaque?1:.5,(()=>r.renderOccludedSlots(t,o)),!0,c),c=!1);d.release(),t.clear()}_renderAndComposite(e,r,t,n,d,c){const o=this.renderingContext,{width:s,height:i}=e.fbo,a=this.fboCache.acquire(s,i,"tmp color");a.attachDepth(r),o.bindFramebuffer(a.fbo),o.clearFramebuffer(l.ZEROS,d,c),n(),a.detachDepth(),this._blit.blend(o,a,e,this.bindParameters,t),a.release()}_getDepthStencilAttachment(e){const{width:r,height:t}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const e=this.fboCache.acquireDepth(u.DepthFormat.DEPTH24_STENCIL8,r,t,"retained stencil");return{depth:e,release:()=>e.release(),clearStencil:!0}}const n=this.fboCache.acquire(r,t,"retained stencil",u.DepthFormat.DEPTH24_STENCIL8);return this.renderingContext.blitFramebuffer(e.fbo,n.fbo,f.FramebufferBit.STENCIL),{depth:n.getAttachment(f.DepthStencilAttachment),release:()=>n.release(),clearStencil:!1}}},r.__decorate([n.property()],e.RenderOccludedRenderNode.prototype,"consumes",void 0),r.__decorate([n.property()],e.RenderOccludedRenderNode.prototype,"produces",void 0),e.RenderOccludedRenderNode=r.__decorate([s.subclass("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],e.RenderOccludedRenderNode);const m=new t,O=[h.RenderOccludedFlag.OccludeAndTransparent,h.RenderOccludedFlag.Transparent,h.RenderOccludedFlag.Opaque],b=O.reduce(((e,r)=>e|r),h.RenderOccludedFlag.None);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));