// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl","../../../webgl/RenderNode","../../core/FBOCacheFormats","./HighlightApplyTechnique","./HighlightBlurTechnique","./HighlightDownsampleTechnique","./HighlightPassParameters","./HighlightToSingleTechnique","../../lib/basicInterfaces","../../lib/DefaultVertexAttributeLocations","../../lib/DefaultVertexBufferLayouts","../../lib/VertexArrayObject","../../../../../chunks/HighlightBlur.glsl","../../../../../chunks/HighlightDownsample.glsl","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,i,r,h,l,s,o,a,n,g,c,u,d,p,T,m,f,b,x,C,w,H,_,v,y,P,R){"use strict";e.Highlight=class extends c{constructor(){super(...arguments),this.produces=g.InternalRenderCategory.HIGHLIGHTS,this.consumes={required:[g.InternalRenderCategory.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new _.HighlightDownsampleDrawParameters,this._passParameters=new m.HighlightPassParameters,this._highlightBlurDrawParameters=new H.HighlightBlurDrawParameters,this._grid=new q}initialize(){this.addHandles([h.watch((()=>this._updateOptionsTexture()),(()=>{}),h.initial)])}destroy(){this._grid.coverage=r.releaseMaybe(this._grid.coverage),this._grid.vao=r.disposeMaybe(this._grid.vao),this._passParameters.highlightOptionsTexture=r.releaseMaybe(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(null==this._passParameters.highlightOptionsTexture){const e=new R.TextureDescriptor(16,2);e.internalFormat=y.PixelFormat.RGBA,e.samplingMode=y.TextureSamplingMode.NEAREST,this._passParameters.highlightOptionsTexture=new P.Texture(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(function(e){const t=new Uint8Array(128);let i=0;for(const r of e){const e=4*i,h=4*i+64;++i;const{color:l}=r,s=r.haloColor??l;t[e+0]=l.r,t[e+1]=l.g,t[e+2]=l.b,t[e+3]=r.fillOpacity*l.a*255,t[h+0]=s.r,t[h+1]=s.g,t[h+2]=s.b,t[h+3]=r.haloOpacity*s.a*255}return t}(this.view.state.highlights)),this.requestRender(b.RenderRequestType.UPDATE)}precompile(){this.techniques.precompile(T.HighlightDownsampleTechnique),this.techniques.precompile(f.HighlightToSingleTechnique),this.techniques.precompile(p.HighlightBlurTechnique),this.techniques.precompile(d.HighlightApplyTechnique)}render(e){const t=e.find((({name:e})=>e===g.InternalRenderCategory.HIGHLIGHTS)),{techniques:i,bindParameters:r,_passParameters:h,renderingContext:l}=this;if(!r.decorations)return t;const s=i.get(T.HighlightDownsampleTechnique);if(!s.compiled)return this.requestRender(b.RenderRequestType.UPDATE),t;const o=e.find((({name:e})=>"highlights"===e)).getTexture();h.highlightTexture=o;const{camera:a}=r;return this._renderHighlightPostprocess(o,(()=>{this._gridUpdateResources(o);const e=this._gridComputeCoverage(s,o,r),{horizontalCellCount:t,verticalCellCount:i}=e;return h.horizontalCellCount=t,h.verticalCellCount=i,h.coverageTexture=e.coverage?.getTexture(),e}),(e=>{const t=e.verticalCellCount*e.horizontalCellCount;l.bindVAO(e.vao),l.drawElementsInstanced(y.PrimitiveType.TRIANGLES,6,y.DataType.UNSIGNED_BYTE,0,t)}),(()=>{l.bindFramebuffer(t.fbo),l.setViewport4fv(a.fullViewport)})),h.highlightTexture=null,h.coverageTexture=null,t}_renderHighlightPostprocess(e,t,i,r){const{fboCache:h,techniques:l,bindParameters:s,_passParameters:o,renderingContext:a}=this,g=l.get(f.HighlightToSingleTechnique),c=l.get(p.HighlightBlurTechnique),T=l.get(d.HighlightApplyTechnique);if(!T.compiled||!c.compiled||!g.compiled)return void this.requestRender(b.RenderRequestType.UPDATE);o.highlightTexture=e;const m=t(),{width:x,height:C}=e.descriptor;o.highlightTexture=e;const{camera:w}=s,{fullWidth:H,fullHeight:_,pixelRatio:v}=w,P=Math.ceil(H/v),R=Math.ceil(_/v),{_highlightBlurDrawParameters:q}=this,O=this.view.stage.renderView.renderer,{highlights:D}=s;for(let e=0;e<D.length;++e){const{name:t}=D[e];if(!O.hasHighlight(t))continue;o.highlightLevel=e,a.setClearColor(0,0,0,0);const l=h.acquire(x,C,"single highlight",u.ColorFormat.RG8UNORM);a.bindFramebuffer(l.fbo),a.setViewport(0,0,x,C),a.clear(y.FramebufferBit.COLOR),a.bindTechnique(g,s,o),i(m),q.blurInput=l.getTexture(),n.set(q.blurSize,1/P,0);const d=h.acquire(P,R,"single highlight blur h",u.ColorFormat.RG8UNORM);a.unbindTexture(d.fbo?.colorTexture),a.bindFramebuffer(d.fbo),a.setViewport(0,0,P,R),a.clear(y.FramebufferBit.COLOR),a.bindTechnique(c,s,o,q),i(m),l.release(),n.set(q.blurSize,0,1/R),o.highlightBlurTexture=d.getTexture(),r(),a.bindTechnique(T,s,o,q),i(m),d.release()}}_gridUpdateResources(e){const t=this._grid,{width:i,height:r}=e.descriptor;if(t.horizontalCellCount=Math.ceil(i/_.gridCellPixelSize),t.verticalCellCount=Math.ceil(r/_.gridCellPixelSize),t.vao)return;const h=this.renderingContext,l=v.BufferObject.createIndex(h,y.Usage.STATIC_DRAW,D);t.vao=new w.VertexArrayObject(h,x.Default3D,new Map([["geometry",C.NoVertex]]),new Map([["geometry",v.BufferObject.createVertex(h,y.Usage.STATIC_DRAW)]]),l)}_gridComputeCoverage(e,t,i){const r=this.renderingContext,h=this._grid,l=t.descriptor,s=Math.ceil(l.width/_.gridCellPixelSize),o=Math.ceil(l.height/_.gridCellPixelSize);this._downsampleDrawParameters.input=t;const{highlights:a}=i;h.coverage?.release();const n=this.fboCache.acquire(s,o,"highlight coverage",a.length>S?u.ColorFormat.RG8UINT:u.ColorFormat.R8UINT);return h.coverage=n,r.bindFramebuffer(n.fbo),r.bindTechnique(e,i,this._passParameters,this._downsampleDrawParameters),r.setViewport(0,0,s,o),r.screen.draw(),h}get test(){}},t.__decorate([l.property()],e.Highlight.prototype,"produces",void 0),t.__decorate([l.property()],e.Highlight.prototype,"consumes",void 0),e.Highlight=t.__decorate([a.subclass("esri.views.3d.webgl-engine.effects.highlight.Highlight")],e.Highlight);class q{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}}let O=0;const D=new Uint8Array([0,1,2,2,1,3]),S=4;e.maxHighlightsPerChannel=S,e.renderHighlightBuffer=function(e,t,i,r,h,l=0){const{highlights:s}=r,o=s.length>1?t.acquire(i.width,i.height,"highlight mix",s.length>S?u.ColorFormat.RG8UINT:u.ColorFormat.R8UINT):null,{gl:a}=e;if(o){const t=e.getBoundFramebufferObject();e.bindFramebuffer(o.fbo),a.clearBufferuiv(a.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}const g=o?.getTexture();r.highlightMixTexture=g,n.set(r.highlightMixOrigin,l,0),s.forEach(((t,s)=>{if(s>0){const t=P.Texture.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(g,t),e.setActiveTexture(t),a.copyTexSubImage2D(y.TextureType.TEXTURE_2D,0,0,0,l,0,i.width,i.height),e.bindTexture(null,t)}e.clear(y.FramebufferBit.DEPTH),r.highlightLevel=s,h()})),r.highlightLevel=null,r.highlightMixTexture=null,o?.release()},e.trackHighlightOptions=function(e){let t=0;for(const i of e){const{name:e}=i;t+=e.length;const{color:r,fillOpacity:h,haloColor:l,haloOpacity:s}=i;t+=r.r+r.g+r.b+r.a+h,t+=l?l.r+l.g+l.b+l.a+s:0}const i=e.at(0);if(i){const{shadowOpacity:e,shadowDifference:r,shadowColor:h}=i;t+=e+r+h.r+h.g+h.b+h.a}return O+++(t>=0?0:1)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));