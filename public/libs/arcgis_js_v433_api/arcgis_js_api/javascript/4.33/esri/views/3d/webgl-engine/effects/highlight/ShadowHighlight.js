// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/colorUtils","../../../../../core/mathUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../ViewingMode","../../../webgl","../../../webgl/RenderNode","./ShadowHighlightTechnique","../../lib/basicInterfaces","../../../../support/HighlightDefaults"],(function(e,t,i,s,a,r,h,o,c,d,n,p,l,g,u,w,m,y){"use strict";const _=1/512;e.ShadowHighlight=class extends u{constructor(e){super(e),this.produces=g.RenderCategory.COMPOSITE,this.consumes={required:[g.RenderCategory.COMPOSITE,"highlights"]},this._passParameters=new w.ShadowHighlightPassParameters,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([a.watch((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=e??y.defaultShadowOpacity,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),a.syncAndInitial),a.watch((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=e??y.defaultShadowDifference,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),a.syncAndInitial),a.watch((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=i.unitRGBAFromColor(e??y.defaultShadowColor),this._ensureMaxOpacity()}),a.syncAndInitial)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(m.RenderRequestType.UPDATE)}precompile(){this.techniques.precompile(w.ShadowHighlightTechnique)}render(e){const t=e.find((({name:e})=>e===g.RenderCategory.COMPOSITE)),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return t;const s=this.techniques.get(w.ShadowHighlightTechnique);if(s.compiled){this._passParameters.highlightTexture=e.find((({name:e})=>"highlights"===e))?.getTexture(),this._passParameters.origin=i.camera.center;const a=this.renderingContext;a.bindFramebuffer(t.fbo),a.bindTechnique(s,i,this._passParameters),a.screen.draw()}else this.requestRender(m.RenderRequestType.UPDATE);return t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-s.smoothstep(4e4,5e4,e.relativeElevation);const i=this.viewingMode===l.ViewingMode.Global?n.normalize(f,e.center):n.set(f,0,0,1),a=n.dot(i,t);return this._passParameters.dayNightTerminator=s.smoothstep(0,1,s.clamp(30*a,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=_}},t.__decorate([r.property()],e.ShadowHighlight.prototype,"produces",void 0),t.__decorate([r.property()],e.ShadowHighlight.prototype,"consumes",void 0),t.__decorate([r.property({constructOnly:!0})],e.ShadowHighlight.prototype,"viewingMode",void 0),e.ShadowHighlight=t.__decorate([d.subclass("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],e.ShadowHighlight);const f=p.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));