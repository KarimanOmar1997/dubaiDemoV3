// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/time","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl","../../../webgl/RenderNode","../../core/FBOCacheFormats","../../core/shaderLibrary/shading/ScreenSpaceConstants","./SSAOBlurTechnique","./SSAONoiseData","./SSAOParameters","./SSAOTechnique","../../lib/basicInterfaces","../../../../../chunks/SSAO.glsl","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,r,t,s,a,i,o,n,c,d,l,u,h,p,m,S,b,w,T,_,f,P,O,g,A){"use strict";e.SSAO=class extends p{constructor(e){super(e),this.consumes={required:["normals"]},this.produces=h.InternalRenderCategory.SSAO,this.isEnabled=()=>!1,this._enableTime=i.Milliseconds(0),this._passParameters=new T.SSAOPassParameters,this._drawParameters=new T.BlurDrawParameters}initialize(){const e=Uint8Array.from(atob(w.noiseData),(e=>e.charCodeAt(0))),r=new A.TextureDescriptor;r.wrapMode=O.TextureWrapMode.CLAMP_TO_EDGE,r.pixelFormat=O.PixelFormat.RGB,r.wrapMode=O.TextureWrapMode.REPEAT,r.hasMipmap=!0,r.width=32,r.height=32,this._passParameters.noiseTexture=new g.Texture(this.renderingContext,r,e),this.techniques.precompile(_.SSAOTechnique),this.techniques.precompile(b.SSAOBlurTechnique),this.addHandles(a.watch((()=>this.isEnabled()),(()=>this._enableTime=i.Milliseconds(0))))}destroy(){this._passParameters.noiseTexture=s.disposeMaybe(this._passParameters.noiseTexture)}render(e){const r=e.find((({name:e})=>"normals"===e)),s=r?.getTexture(),a=r?.getTexture(O.DepthStencilAttachment);if(!s||!a)return;const o=this.techniques.get(_.SSAOTechnique),n=this.techniques.get(b.SSAOBlurTechnique);if(!o.compiled||!n.compiled)return this._enableTime=i.Milliseconds(performance.now()),void this.requestRender(f.RenderRequestType.UPDATE);0===this._enableTime&&(this._enableTime=i.Milliseconds(performance.now()));const c=this.renderingContext,d=this.view.qualitySettings.fadeDuration,l=this.bindParameters,p=l.camera,w=p.relativeElevation,T=t.clamp((S.distanceFadeEnd-w)/(S.distanceFadeEnd-S.distanceFadeStart),0,1),g=d>0?Math.min(d,performance.now()-this._enableTime)/d:1,A=g*T;this._passParameters.normalTexture=s,this._passParameters.depthTexture=a,this._passParameters.projScale=1/p.computeScreenPixelSizeAtDist(1),this._passParameters.intensity=4*x/P.getRadius(p)**6*A;const q=p.fullViewport[2],y=p.fullViewport[3],R=this.fboCache.acquire(q,y,"ssao input",m.ColorFormat.RG8UNORM);c.bindFramebuffer(R.fbo),c.setViewport(0,0,q,y),c.bindTechnique(o,l,this._passParameters,this._drawParameters),c.screen.draw();const C=Math.round(q/2),M=Math.round(y/2),F=this.fboCache.acquire(C,M,"ssao blur",m.ColorFormat.R8UNORM);c.bindFramebuffer(F.fbo),this._drawParameters.colorTexture=R.getTexture(),u.set(this._drawParameters.blurSize,0,2/y),c.bindTechnique(n,l,this._passParameters,this._drawParameters),c.setViewport(0,0,C,M),c.screen.draw(),R.release();const v=this.fboCache.acquire(C,M,h.InternalRenderCategory.SSAO,m.ColorFormat.R8UNORM);return c.bindFramebuffer(v.fbo),c.setViewport(0,0,q,y),c.setClearColor(1,1,1,0),c.clear(O.FramebufferBit.COLOR),this._drawParameters.colorTexture=F.getTexture(),u.set(this._drawParameters.blurSize,2/q,0),c.bindTechnique(n,l,this._passParameters,this._drawParameters),c.setViewport(0,0,C,M),c.screen.draw(),c.setViewport4fv(p.fullViewport),F.release(),g<1&&this.requestRender(f.RenderRequestType.UPDATE),v}},r.__decorate([o.property()],e.SSAO.prototype,"consumes",void 0),r.__decorate([o.property()],e.SSAO.prototype,"produces",void 0),r.__decorate([o.property({constructOnly:!0})],e.SSAO.prototype,"isEnabled",void 0),e.SSAO=r.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],e.SSAO);const x=.5;e.blurSizePixels=2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));