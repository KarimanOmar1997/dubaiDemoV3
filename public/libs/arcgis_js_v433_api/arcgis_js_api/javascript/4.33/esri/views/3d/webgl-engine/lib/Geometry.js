// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/uid","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../geometry/support/Indices","./AttributeArray","./BoundingInfo","./geometryDataUtils","./IntersectableGeometry","./Object3DStateID","./Util","./VertexAttribute","../../../webgl/checkWebGLError"],(function(t,e,i,n,s,r,h,o,a,g,u,l,c){"use strict";class d{constructor(t,i,n=null,r=a.GeometryType.Mesh,h=null,o=-1){this.material=t,this.mapPositions=n,this.type=r,this.objectAndLayerIdColor=h,this.edgeIndicesLength=o,this.highlights=new Set,this._highlightOptionsCounts=new Map,this.id=e.generateUID(),this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[t,e]of i)this._attributes.set(t,{...e,indices:s.compactIndices(e.indices)}),t===l.VertexAttribute.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(t).indices.length:this.edgeIndicesLength)}instantiate(t={}){const e=new d(t.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach(((t,i)=>{t.exclusive=!1,e._attributes.set(i,t)})),e._boundingInfo=this._boundingInfo,e.transformation=t.transformation||this.transformation,e}get attributes(){return this._attributes}getMutableAttribute(t){let e=this._attributes.get(t);return e&&!e.exclusive&&(e={...e,exclusive:!0,data:r.cloneAttributeData(e.data)},this._attributes.set(t,e)),e}setAttributeData(t,e){const i=this._attributes.get(t);i?this._attributes.set(t,{...i,exclusive:!0,data:e}):c.webglDebugEnabled()&&console.warn(`Setting undefined attribute ${t} data`)}get indexCount(){const t=this._attributes.values().next().value?.indices;return t?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??=this._calculateBoundingInfo(),this._boundingInfo}computeAttachmentOrigin(t){return!!(this.type===a.GeometryType.Mesh?this._computeAttachmentOriginTriangles(t):this.type===a.GeometryType.Line?this._computeAttachmentOriginLines(t):this._computeAttachmentOriginPoints(t))&&(null!=this._transformation&&n.transformMat4(t,t,this._transformation),!0)}_computeAttachmentOriginTriangles(t){const e=this.attributes.get(l.VertexAttribute.POSITION);return o.computeAttachmentOriginTriangles(e,t)}_computeAttachmentOriginLines(t){const e=this.attributes.get(l.VertexAttribute.POSITION);return o.computeAttachmentOriginLines(e,function(t,e){return!(!("isClosed"in t)||!t.isClosed)&&e.indices.length>2}(this.material.parameters,e),t)}_computeAttachmentOriginPoints(t){const e=this.attributes.get(l.VertexAttribute.POSITION);return o.computeAttachmentOriginPoints(e,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.attributes.get(l.VertexAttribute.POSITION);if(!t||0===t.indices.length)return null;const e=this.type===a.GeometryType.Mesh?3:1;u.assert(t.indices.length%e===0,"Indexing error: "+t.indices.length+" not divisible by "+e);const i=s.getContinuousIndexArray(t.indices.length/e);return new h.BoundingInfo(i,e,t)}get transformation(){return this._transformation??i.IDENTITY}set transformation(t){this._transformation=t&&t!==i.IDENTITY?i.clone(t):null}get highlightNames(){return this._highlightOptionsCounts}get hasHighlights(){return this._highlightOptionsCounts.size>0}foreachHighlightOptions(t){this._highlightOptionsCounts.forEach(((e,i)=>t(i)))}allocateIdAndHighlight(t){const e=new g.Object3DHighlightStateID(t);return this.addHighlight(e)}addHighlight(t){this.highlights.add(t);const{highlightName:e}=t,i=(this._highlightOptionsCounts.get(e)??0)+1;return this._highlightOptionsCounts.set(e,i),t}removeHighlight(t){if(this.highlights.delete(t)){const{highlightName:e}=t,i=this._highlightOptionsCounts.get(e)??0;i<=1?this._highlightOptionsCounts.delete(e):this._highlightOptionsCounts.set(e,i-1)}}}Object.defineProperty(t,"GeometryType",{enumerable:!0,get:()=>a.GeometryType}),t.Geometry=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));