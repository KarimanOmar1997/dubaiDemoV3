// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","../../../ViewingMode","../../webgl/RenderCamera","./HUDIntersectorResult","./IntersectorInterfaces","./IntersectorResult","./IntersectorType","./verticalOffsetUtils"],(function(t,e,r,s,i,n,a,o,c,h,l){"use strict";const f=1e-5;function d(t,e){return(e??-Number.MAX_VALUE)-(t??-Number.MAX_VALUE)}class u{constructor(){this.min=new c.IntersectorResult(s.create()),this.max=new c.IntersectorResult(s.create()),this.hud={min:new a.HUDIntersectorResult(s.create()),max:new a.HUDIntersectorResult(s.create()),all:new Array},this.ground=new c.IntersectorResult(s.create()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}t.Intersector=class{constructor(t){this.options=new o.IntersectorOptions,this._results=new u,this.transform=new l.IntersectorTransform,this.camera=new n,this.tolerance=f,this.verticalOffset=null,this._ray=s.create(),this._rayEnd=r.create(),this._rayBeginTransformed=r.create(),this._rayEndTransformed=r.create(),this.viewingMode=t??i.ViewingMode.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,e,r){this.resetWithRay(s.fromPoints(t,e,this._ray),r)}resetWithRay(t,r){this.camera=r,t!==this._ray&&s.copy(t,this._ray),0!==this.options.verticalOffset?this.viewingMode===i.ViewingMode.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,e.add(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,e,r,s,i){this.point=e,this.filterPredicate=s,this.tolerance=r??f;const n=l.getVerticalOffsetObject3D(this.verticalOffset);if(t&&t.length>0){const e=i?t=>{i(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const r of t){const t=r.getSpatialQueryAccelerator?.();null!=t?(null!=n?t.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,e,n):t.forEachAlongRay(this._ray.origin,this._ray.direction,e),this.options.selectionMode&&this.options.hud&&t.forEachDegenerateObject(e)):r.objects.forEach((t=>e(t)))}}this.sortResults()}intersectObject(t){const r=t.geometries;if(!r)return;const s=t.effectiveTransformation,i=l.getVerticalOffsetObject3D(this.verticalOffset);for(const n of r){if(!n.visible)continue;const{material:r,id:a}=n;if(!r.visible)continue;this.transform.setAndInvalidateLazyTransforms(s,n.transformation),e.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),e.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const o=this.transform.transform;null!=i&&(i.objectTransform=this.transform),r.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((e,r,s,i)=>this.handleObjectIntersection({object:t,geometryId:a,primitiveIndex:s},e,r,o,i)))}}handleObjectIntersection(t,e,r,s,i){if(e<0||null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,e))return;const n=i?this._results.hud:this._results;t=i?new a.HUDTarget(t,i):t;const l=i?s=>s.set(h.IntersectorType.HUD,t,e,r):i=>i.set(h.IntersectorType.OBJECT,t,e,r,s);if((null==n.min.distance||e<n.min.distance)&&l(n.min),this.options.store!==o.StoreResults.MIN&&(null==n.max.distance||e>n.max.distance)&&l(n.max),this.options.store===o.StoreResults.ALL)if(i){const t=new a.HUDIntersectorResult(this._ray);l(t),this._results.hud.all.push(t)}else{const t=new c.IntersectorResult(this._ray);l(t),this._results.all.push(t)}}sortResults(t=this._results.all){t.sort(((t,e)=>t.distance!==e.distance?(t.distance??0)-(e.distance??0):t.drapedLayerOrder!==e.drapedLayerOrder?d(t.drapedLayerOrder,e.drapedLayerOrder):d(t.renderPriority,e.renderPriority)))}},t.defaultTolerance=f,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));