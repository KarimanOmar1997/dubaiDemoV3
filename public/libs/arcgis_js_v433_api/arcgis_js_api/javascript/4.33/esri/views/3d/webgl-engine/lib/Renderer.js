// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../chunks/tslib.es6","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/colorUtils","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/time","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f32","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/Indices","../../webgl","../../environment/atmosphereUtils","../../state/NearFarHeuristic","../../support/debugFlags","../core/FBOCache","../core/FBOCacheFormats","../core/renderPasses/RenderPassManager","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/hud/HUDRenderStyle","../core/shaderLibrary/shading/ScreenSpaceConstants","../effects/RenderNodes","../effects/RenderPluginManager","../effects/blit/Blit","../effects/highlight/Highlight","../effects/transparency/OITBlend","./AnimationTimer","./AnimationTimeStep","./basicInterfaces","./BoundingInfo","./DepthRange","./depthRangeUtils","./hudFragmentOpacityParameters","./MainFramebuffer","./Material","./OITPass","./RenderContext","./RendererBase","./rendererUtils","./RenderFeature","./RenderPluginInput","./RenderSlot","./ShadowAccumulator","./ShadowMap","./SliceHelper","./edgeRendering/interfaces","../materials/renderers/MergedRenderer","../parts/renderUtils","../statistics/RendererPerformanceInfo","../../../support/RenderState","../../../webgl/enums"],(function(e,t,r,i,s,a,n,h,o,d,l,u,_,c,p,m,g,f,R,b,S,T,A,E,C,P,y,O,I,D,w,N,M,H,x,F,L,U,v,G,q,V,B,Q,W,k,z,j,Y,Z,X,K,J,$,ee,te,re,ie,se,ae,ne,he){"use strict";var oe;t.Renderer=class extends Y.RendererBase{constructor(e,t,r,i,s,h){super({stage:e}),this._techniques=r,this._rctx=i,this._compositingHelper=s,this._requestRender=h,this._pluginsHas={hudElements:!1,water:!1},this.renderPassManager=new I.RenderPassManager,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=S.fromValues(0,0,0,1),this._sliceHelper=new te,this._blit=null,this._oitblend=null,this.sceneDepthRange=u.signal(V.DepthRange.infinite),this._state=u.signal(ne.RenderState.IDLE),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new v.AnimationTimeStep,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=u.signal(0),this._lastFrameTime=_.Milliseconds(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new K.RenderPluginInput,this._releaseNormals=e=>{e.some((({name:e})=>"normals"===e))&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new y.FBOCache(i),this._renderStateFeatures=u.signal(X.setupFeatureDefaults(!n("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new W.MainFramebuffer(this.fboCache),this.performanceInfo=new ae.RendererPerformanceInfo(this._rctx),this._shadowMap=new ee.ShadowMap(this.fboCache,e.viewingMode),this._shadowAccumulator=new $.ShadowAccumulator(this.fboCache,r,e,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t}),((t,r,i)=>{const s=e.view.qualitySettings.maximumPixelRatio;t.shadowMap.start(t.camera,r,i,!0,s),this._renderShadowCascades(D.ShaderOutput.Shadow,t.shadowMap),t.shadowMap.finish(),t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.contentCamera)}),h),this._renderContext=new j.RenderContext(this._rctx,this._shadowMap,r),this._nodes=new M.RenderNodes(this._renderContext),this._plugins=new H.RenderPluginManager({renderContext:this._renderContext,techniques:r,materials:t,requestRender:h,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this._plugins.add(this.renderPassManager),this.addHandles([l.watch((()=>e.view.state.camera),(()=>h()),l.syncAndInitial),l.watch((()=>P.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(re.Transparency.TRANSPARENT):()=>{},h()}),l.initial),l.watch((()=>e.view.environment.background?.color),(e=>{const t=e?a.unitRGBAFromColor(e):S.ZEROS;R.set(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),h()}),l.syncAndInitial),l.watch((()=>e.view.state.camera.relativeElevation),(e=>this._inGlobeView=(e??1/0)>=N.distanceFadeEnd),l.syncAndInitial),l.watch((()=>this._bindParameters.clouds.fadeFactor),(()=>this._bindParameters.fadeLighting()),l.sync),l.watch((()=>this._bindParameters.clouds.data?.state),(()=>h()),l.sync),l.watch((()=>e.view.state.highlights),(e=>{this._bindParameters.highlights=e,h()}),l.initial)])}destroy(){this._gpuTimerHandle=o.removeMaybe(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=o.abortMaybe(this._loadEdgeViewTask),this._edgeView=o.destroyMaybe(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),this._blit=null,this._oitblend=null,q.BoundingInfo.prune(),ie.MergedRenderer.prune(),T.pruneIndexArrays()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(e=null,t=!n("disable-feature:high-quality-idle")){this._renderStateFeatures.value=X.setupFeatureDefaults(t,e),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,r){this._renderStateFeatures.mutate((i=>i.set(t,e,r))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(X.RenderFeature.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(X.RenderFeature.WaterReflection))}get _hasHighlights(){return this._plugins.produces(D.ShaderOutput.Highlight,J.RenderSlot.OPAQUE_MATERIAL,J.RenderSlot.TRANSPARENT_MATERIAL,J.RenderSlot.DRAPED_MATERIAL,J.RenderSlot.HUD_MATERIAL,J.RenderSlot.LABEL_MATERIAL)}hasHighlight(e){return this._plugins.hasHighlight(e)}get _hasHUDHighlights(){return this._plugins.produces(D.ShaderOutput.Highlight,J.RenderSlot.HUD_MATERIAL,J.RenderSlot.LABEL_MATERIAL)}get hasSSAO(){return(this.stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(X.RenderFeature.SSAO))&&!this._inGlobeView}get hasSMAA(){return this.stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(X.RenderFeature.Antialiasing)}get fullResolutionAtmosphere(){return this.stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(X.RenderFeature.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=o.releaseMaybe(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=o.releaseMaybe(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=o.releaseMaybe(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=o.releaseMaybe(this._bindParameters.depth),this._bindParameters.hudVisibility=o.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return this._loadEdgeViewTask&&!this._loadEdgeViewTask.finished||this._edgeView?.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=s.createTask((async t=>{const{EdgeView:r}=await new Promise(((t,r)=>e(["./edgeRendering/EdgeView"],t,r)));d.throwIfAborted(t);const i=this._edgeView=new r({rctx:this._rctx,renderSR:this.stage.view.renderSpatialReference,viewingMode:this.stage.view.stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:(s=this.stage.view.resourceController,e=>s.immediate.schedule(e))});var s;return this.addHandles(l.watch((()=>i.updating),(()=>this._requestRender()),l.sync)),this._requestRender(),this._edgeViewCallbacks.forEach((e=>e(i))),this._edgeViewCallbacks.length=0,i}))),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&g.equals(this._bindParameters.ssr.reprojectionMatrix,f.IDENTITY)}set _reprojectionMatrix(e){i.update(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:r}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){if(null!=e.environment.weather){const t=e.environment.weather;this._bindParameters.weather=t,this._bindParameters.snowCover=!!e.weatherVisible&&null!=t&&"snowy"===t.type&&"enabled"===t.snowCover}const t="virtual"!==e.environment.lighting.type;r.enableFillLights!==t&&(r.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}set slice(e){this._sliceHelper.update(e)&&this._requestRender()}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}commit(e,t){return this._isRendering&&console.warn("Renderer.modify called while rendering"),!!super.commit(e,t,this._plugins.context)&&(this.updateHasFlags(),!0)}rendererAdded(e){this._plugins.add(e)}rendererRemoved(e){this._plugins.remove(e)}get occludedRequiresStencil(){return this.occludedRequiresOccludeeStencil||this.occludedRequiresIntegratedMeshStencil}get occludedRequiresOccludeeStencil(){return this._bindParameters.hasOccludees&&0!==(this.plugins.renderOccludedFlags&k.RenderOccludedFlag.OccludeAndTransparentStencil)}get occludedRequiresIntegratedMeshStencil(){return this._plugins.produces(D.ShaderOutput.Color,J.RenderSlot.INTEGRATED_MESH)&&this._plugins.produces(D.ShaderOutput.Color,J.RenderSlot.OCCLUDED_GROUND)}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(D.ShaderOutput.Color,...pe),e.water=this._plugins.produces(D.ShaderOutput.Normal,J.RenderSlot.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??=new U.AnimationTimer(e.camera,t),this._animationTimer.advance(e.camera,t,this._animationTimeDilation);const r=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?o.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,r=Z.RendererTarget.Default,i=!1){try{return this._isRendering=!0,this._render(e,t,r,i)}catch(e){console.error(`Exception during rendering: ${e}`)}finally{this._isRendering=!1}return new se.RenderSceneResult(this._pluginInput.get(A.RenderCategory.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:r,navigatingOpacity:i,maxDelta:s,tiltFadeStart:a,tiltFadeEnd:n,altitudeStart:o,altitudeEnd:d}=Q.hudFragmentOpacityParameters,l=this.stage.view,u=l.stateManager.camera,_=l.qualitySettings.fadeDuration,c=e===ne.RenderState.IDLE?r:i,p=h.clamp((u.tilt-a)/(n-a),0,1),m=h.clamp(((u.position.z??0)-o)/(d-o),0,1),g=h.lerp(h.lerp(1,c,p),1,m),f=this._bindParameters.hudOccludedFragmentOpacity;if(_<=0||f===g||0===this._lastFrameTime||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=g,void(this._lastFrameTime=t);const R=t-this._lastFrameTime;this._lastFrameTime=t;const b=Math.max(1-r,Math.abs(r-i)),S=Math.min(b*R/_,s);S>=Math.abs(g-f)?this._bindParameters.hudOccludedFragmentOpacity=g:(this._bindParameters.hudOccludedFragmentOpacity=f+Math.sign(g-f)*S,this._requestRender())}_render(e,t,r=Z.RendererTarget.Default,i){this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=r===Z.RendererTarget.Default,this._disposeBindBuffers();const{camera:s,contentCamera:a,mode:n,alignPixelEnabled:h}=e;this._state.value=n;const o=this._nodes.produces("magnifier-color"),d=this._nodes.produces(A.RenderCategory.FINAL),l=this._nodes.require("emissive",A.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,A.RenderCategory.COMPOSITE,A.RenderCategory.FINAL)>0&&this._plugins.hasEmissions,u=l?D.ShaderOutput.ColorEmission:D.ShaderOutput.Color;this._renderContext.time=t,this._renderContext.output=u,this._bindParameters.oitPass=z.OITPass.NONE,this._bindParameters.alignPixelEnabled=h,this._bindParameters.decorations=!i,this._bindParameters.mainDepth=null;const _=!i||!this._sliceHelper.isDecoration;this._bindParameters.slicePlane=_?this._sliceHelper.plane:null,this._bindParameters.viewshedEnabled=this._nodes.produces(A.InternalRenderCategory.VIEWSHED),this._renderOverlay(t),s.setGLViewport(this._rctx);const c=this._framebuffer,p=c.initialize(s.fullWidth,s.fullHeight,this._backgroundColor,l);this.hasReflections?(p?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=p):p?.release(),this._ensureBindParametersCamera(s,a),this._updateHUDOccludedFragmentOpacity(n,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!i;const m=this._highQualityTransparency&&this._hasTransparentTerrain,g=this._plugins.produces(D.ShaderOutput.Color,..._e);this._precompilePrepasses(),this.performanceInfo.advance(ae.PerformanceCategory.PREPARE);const f=this._computeShadowDepthRange(s);this._renderShadowMap(s,this._bindParameters.lighting.mainLight.direction,f),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(f,s,a),this._ensureBindParametersSSR(t),this._precompileShaders(m,g,u),this._renderContext.output=u,c.bind(),this._bindParameters.mainDepth=c.depth.attachment,this._renderOpaque(m),this._renderTransparent(g,m,u),this._shadowMap.disposeMainBuffer(),this._pluginInput.set(A.InternalRenderCategory.FOCUSAREA,this._renderFocusAreaGeometry()),c.update((e=>this._renderNodes(A.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,e))),c.update((e=>this._renderNodes(A.InternalRenderCategory.VIEWSHED,e))),c.update((e=>this._renderNodes(A.InternalRenderCategory.LASERLINES,e))),c.update((e=>this._renderNodes(A.InternalRenderCategory.FOCUSAREA_COLOR,e))),this._pluginInput.release(A.InternalRenderCategory.FOCUSAREA),c.update((e=>this._renderNodes(A.InternalRenderCategory.OCCLUDED,e))),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._renderHighlightShadowMap(s,this._bindParameters.lighting.mainLight.direction,f);const R=r===Z.RendererTarget.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;c.update((e=>this._renderNodes(A.RenderCategory.COMPOSITE,e))),this._shadowMap.disposeOffscreenBuffers();const b=!(r!==Z.RendererTarget.Default||d||o&&!i),S=this._pluginInput.get(A.RenderCategory.COMPOSITE),T=b?y.defaultWebGLFBO:this.fboCache.acquire(S.fbo.width,S.fbo.height,A.InternalRenderCategory.ANTIALIASING),E=this._nodes.produces(A.InternalRenderCategory.ANTIALIASING)?this._renderNodes(A.InternalRenderCategory.ANTIALIASING,T):this._blitFBO(S,T,!1);let C;this._pluginInput.set(A.InternalRenderCategory.ANTIALIASING,E),this._hasHUDHighlights?(this._renderHUD(w.HUDRenderStyle.NotOccluded,E,u),C=this._renderNodes(A.InternalRenderCategory.HIGHLIGHTS,E)):(C=this._renderNodes(A.InternalRenderCategory.HIGHLIGHTS,E),this._renderHUD(w.HUDRenderStyle.NotOccluded,C,u));const P=this._renderNodes(A.InternalRenderCategory.MAGNIFIER,C);return o&&!i&&r===Z.RendererTarget.Default&&!d&&this._blitFBO(P),d?(P.attachDepth(c.depth),this._blitFBO(this._renderNodes(A.RenderCategory.FINAL,P)),P.detachDepth()):this._pluginInput.set(A.RenderCategory.FINAL,P),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),c.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),r!==Z.RendererTarget.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),new se.RenderSceneResult(this._pluginInput.get(A.RenderCategory.FINAL),R)}_precompileShaders(e,t,r){++this._plugins.context.techniques.precompiling,this._renderContext.output=r,this._precompileOpaqueGeometry(),this._nodes.precompile(A.InternalRenderCategory.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=D.ShaderOutput.Depth,this._plugins.precompile(J.RenderSlot.TRANSPARENT_TERRAIN),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=r,this._plugins.precompile(J.RenderSlot.TRANSPARENT_TERRAIN),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(A.InternalRenderCategory.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(J.RenderSlot.OCCLUSION_PIXELS),this._plugins.precompile(J.RenderSlot.LINE_CALLOUTS),this._precompileHUD(w.HUDRenderStyle.Occluded),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(A.InternalRenderCategory.VIEWSHED,A.InternalRenderCategory.LASERLINES,A.InternalRenderCategory.FOCUSAREA_COLOR,A.InternalRenderCategory.OCCLUDED,A.InternalRenderCategory.ANTIALIASING,A.InternalRenderCategory.HIGHLIGHTS);const i=this._bindParameters;i.highlightMixTexture=i.highlights.length>1?this._rctx.emptyTexture:null,this._precompileHUD(w.HUDRenderStyle.NotOccluded),this._hasHighlights&&(i.highlights.forEach(((e,t)=>{i.highlightLevel=t,this._precompileAllGeometry(D.ShaderOutput.Highlight)})),i.highlightLevel=null),i.highlightMixTexture=null,this._nodes.precompile(A.RenderCategory.COMPOSITE,A.InternalRenderCategory.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(J.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),--this._plugins.context.techniques.precompiling}_renderFocusAreaGeometry(){const e=this._nodes.produce(A.InternalRenderCategory.FOCUSAREA,this._pluginInput);return e&&this.performanceInfo.advance(ae.PerformanceCategory.FOCUS_AREA_MASK),e}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let r=this.fboCache.acquire(t.width,t.height,"olid");return r.acquireDepth(O.DepthFormat.DEPTH24_STENCIL8),r=this._nodes.render(r,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(ae.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,r}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,r=e===G.RenderRequestType.BACKGROUND;if(r||t){const e=r?this.performanceInfo.elapsedTime:0;let i=0;t?i=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const s=Math.max(e,i);this._animationTimestep.frame(s,r)}}readMainDepth(e,t){const{mainDepth:r,camera:i}=this._bindParameters;if(!r)return;const s=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(s.fbo),i.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(S.ZEROS),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,r),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),s.fbo?.readPixels(e[0],e[1],e[2],e[3],he.PixelFormat.RGBA,he.PixelType.UNSIGNED_BYTE,t),s.release()}readHUDVisibility(e,t,r,i,s){this._bindParameters.hudVisibility?.fbo?.readPixels(e,t,r,i,he.PixelFormat.RGBA,he.PixelType.UNSIGNED_BYTE,s)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!t?.shouldRender())return;const r=this._framebufferSize,i=this.fboCache.acquire(r.width,r.height,"edges"),s=this._bindParameters.geometryDepth;this.renderToTargets((()=>t.render(this._bindParameters,e)),i,s??this._framebuffer.depth,S.ZEROS),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,i.getTexture()),i.release(),this.performanceInfo.advance(e===re.Transparency.OPAQUE?ae.PerformanceCategory.OPAQUE_EDGES:ae.PerformanceCategory.TRANSPARENT_EDGES)}_renderOverlay(e){this._bindParameters.overlay=this.overlay?.render(e),this._bindParameters.overlay&&this.performanceInfo.advance(ae.PerformanceCategory.OVERLAY)}_renderShadowMap(e,t,r){if(!this.shadowsEnabled)return;const{contentCamera:i}=this._bindParameters,s=this._shadowMap;s.start(e,t,r,this.isFeatureEnabled(X.RenderFeature.HighResolutionShadows),this.stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(D.ShaderOutput.ShadowExcludeHighlight,this._shadowMap),s.copySnapshot(ee.SnapshotSlot.ExcludeHighlight),this._renderShadowCascades(D.ShaderOutput.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(D.ShaderOutput.Shadow),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,i),this.performanceInfo.advance(ae.PerformanceCategory.SHADOW_MAP)}_renderHighlightShadowMap(e,t,r){if(!this.shadowsEnabled||!this._needsShadowHighlight)return;const{contentCamera:i}=this._bindParameters,s=this._shadowMap;s.start(e,t,r,this.isFeatureEnabled(X.RenderFeature.HighResolutionShadows),this.stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(D.ShaderOutput.ShadowHighlight,this._shadowMap),s.moveSnapshot(ee.SnapshotSlot.Highlight),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,i),this.performanceInfo.advance(ae.PerformanceCategory.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){t.bindFbo();for(const r of t.cascades)r.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(r.camera,r.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(D.ShaderOutput.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._shadowAccumulator.active||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");e?(this._pluginInput.set(A.InternalRenderCategory.SSAO,this._renderSSAO()),this._needsDepth?(this._rctx.bindFramebuffer(e.fbo),this._rctx.clear(he.FramebufferBit.STENCIL),this._renderGeometryWithoutNormals(D.ShaderOutput.Depth),o.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=e.obtainDepthTexture(),this.performanceInfo.advance(ae.PerformanceCategory.DEPTH)):(e.detachDepth(),this._bindParameters.depth=o.releaseMaybe(this._bindParameters.depth)),this.hasSSAO&&this._pluginInput.release("normals")):this._renderAllGeometryDepth()}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=o.releaseMaybe(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"depth",O.DepthFormat.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear(he.FramebufferBit.DEPTH|he.FramebufferBit.STENCIL),this.renderAllGeometry(D.ShaderOutput.Depth),o.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(ae.PerformanceCategory.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=o.releaseMaybe(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=D.ShaderOutput.Depth;const r=this._framebufferSize,i=this.fboCache.acquire(r.width,r.height,"terrain depth",O.DepthFormat.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(i.fbo),this._rctx.clear(he.FramebufferBit.DEPTH|he.FramebufferBit.STENCIL),this._renderTransparentTerrain(),o.releaseMaybe(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=i.obtainDepthTexture(),this._renderContext.output=t,i.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=o.releaseMaybe(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:r,height:i}=this._framebufferSize,s=this.fboCache.acquire(r,i,"geometry depth",O.DepthFormat.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(he.FramebufferBit.DEPTH|he.FramebufferBit.STENCIL),this._renderOpaqueAndTransparentGeometry(D.ShaderOutput.Depth),this._renderContext.output=t,o.releaseMaybe(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=s.obtainDepthTexture(),s.release()}get _needsShadowDepthRange(){return this._shadowMap.enabled||this._shadowAccumulator.active}_computeShadowDepthRange(e){if(!this._needsShadowDepthRange)return V.DepthRange.zero;const t=B.depthRangeFromScene(e,this._plugins.plugins,this.stage.layers,B.DepthRangeMode.SHADOW_CASTERS);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}updateSceneDepthRange(e){if(!this.stage.view.state.isGlobal)return void(this.sceneDepthRange.value=V.DepthRange.infinite);if((this.stage.view.renderCoordsHelper?.getAltitude(e.eye)??0)<E.innerAtmosphereFadeStart)return void(this.sceneDepthRange.value=V.DepthRange.infinite);const t=e.clone();t.near=C.minNearDistanceInMeters,t.far=1e10;const r=B.depthRangeFromScene(t,this._plugins.plugins,this.stage.layers,B.DepthRangeMode.FULL_SCENE);r.union(this._plugins.queryDepthRange(t)),this.sceneDepthRange.value.far===r.far&&this.sceneDepthRange.value.near===r.near||(this.sceneDepthRange.value=r)}get _normalsRequired(){const e=this._nodes.require("normals",A.RenderCategory.FINAL,A.RenderCategory.COMPOSITE,A.RenderCategory.OPAQUE,A.RenderCategory.TRANSPARENT,A.InternalRenderCategory.VIEWSHED,A.InternalRenderCategory.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(D.ShaderOutput.Normal),this._needsDepth&&this._precompileAllGeometry(D.ShaderOutput.Depth),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(D.ShaderOutput.ShadowHighlight),this._precompileShadowCascades(D.ShaderOutput.ShadowExcludeHighlight),this._precompileShadowCascades(D.ShaderOutput.ShadowHighlight)):this._precompileShadowCascades(D.ShaderOutput.Shadow)),this._shadowAccumulator.active&&this._precompileAllGeometry(D.ShaderOutput.Shadow)}_renderNormals(){const e=this._normalsRequired;if(0===e)return;const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"normals",O.ColorFormat.RGBA8UNORM);r.acquireDepth(O.DepthFormat.DEPTH24_STENCIL8),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(S.ZEROS,!0,!0),this._renderGeometryWithNormals(D.ShaderOutput.Normal);const i=this._nodes.optional("normals",A.RenderCategory.FINAL,A.RenderCategory.COMPOSITE,A.RenderCategory.OPAQUE,A.RenderCategory.TRANSPARENT,A.InternalRenderCategory.VIEWSHED);return r.retain(e+i-1),this.performanceInfo.advance(ae.PerformanceCategory.NORMALS),r}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return;const t=this._nodes.produce(A.InternalRenderCategory.SSAO,this._pluginInput);return this._bindParameters.ssao=t,t&&this.performanceInfo.advance(ae.PerformanceCategory.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(J.RenderSlot.TRANSPARENT_TERRAIN),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const r of t)this._bindParameters.slot=r,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const r of t)this._renderContext.renderOccludedMask=r,this.precompileSlots(e,...ce);this._renderContext.renderOccludedMask=j.defaultRenderOccludedMask}renderSlots(e,...t){for(const r of t)this._bindParameters.slot=r,e.forAll((e=>{const t=e.acquireTechniques(this._renderContext);t&&e.render(this._renderContext,t)}))}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>k.RenderOccludedFlag.Occlude&&this._plugins.render(J.RenderSlot.OCCLUDED_GROUND),this.renderSlots(e,...ce),this._renderContext.renderOccludedMask=j.defaultRenderOccludedMask}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(J.RenderSlot.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(D.ShaderOutput.ViewshedShadow)}renderViewshedShadowMap(e){const{camera:t,contentCamera:r}=this._bindParameters,i=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(D.ShaderOutput.ViewshedShadow),this._ensureBindParametersCamera(t,r),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=i}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(...de),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(...le)}_precompileOpaqueGeometry(){this._plugins.precompile(...ue)}_renderOpaqueGeometry(){this._plugins.render(...ue)}_renderTransparentGeometry(){this._plugins.render(..._e)}get _hasTransparentTerrain(){return this._plugins.produces(D.ShaderOutput.Color,J.RenderSlot.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){const e=()=>this._plugins.render(J.RenderSlot.TRANSPARENT_TERRAIN);if(!D.isColorOrColorEmission(this._renderContext.output))return void e();const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,r,this._framebuffer.depth,S.ZEROS),r}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,J.RenderSlot.OCCLUSION_PIXELS)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=o.releaseMaybe(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let r=this._bindParameters.hudVisibility;r?.fbo?.width===e&&r?.fbo?.height===t||(r?.release(),r=this.fboCache.acquire(e,t,"hud visibility",O.ColorFormat.RGBA4UNORM),this._bindParameters.hudVisibility=r);const i=this._bindParameters.geometryDepth;r.attachDepth(i||this._framebuffer.depth),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(J.RenderSlot.OCCLUSION_PIXELS),r.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(ae.PerformanceCategory.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===w.HUDRenderStyle.Occluded){const e=()=>this._plugins.render(J.RenderSlot.LINE_CALLOUTS),t=this._framebufferSize,r=this.fboCache.acquireDepth(O.DepthFormat.DEPTH16,t.width,t.height,"line callouts");this.renderToTargets(e,this._framebuffer.color,r,void 0,!0,!0),r.release()}else this._plugins.render(J.RenderSlot.LINE_CALLOUTS)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=D.ShaderOutput.Highlight,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&D.isColorOrColorEmission(this._renderContext.output)?(this._bindParameters.oitPass=z.OITPass.ColorAlpha,this._plugins.precompile(...pe),this._bindParameters.oitPass=z.OITPass.FrontFace,this._plugins.precompile(...pe),this._bindParameters.oitPass=z.OITPass.NONE):this._plugins.precompile(...pe),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,r){if(this._pluginsHas.hudElements){if(this._oitEnabled){const i=this._renderOIT(oe.HUD,r,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,i.getTexture()),i.release()}else if(this._renderContext.output=r,e===w.HUDRenderStyle.Occluded){const t=()=>this._renderHUDElements(e),r=this._framebufferSize,i=this.fboCache.acquireDepth(O.DepthFormat.DEPTH16,r.width,r.height,"hud");this.renderToTargets(t,this._framebuffer.color,i,void 0,!0,!0),i.release()}else t.acquireDepth(O.DepthFormat.DEPTH16),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===w.HUDRenderStyle.Occluded?ae.PerformanceCategory.HUD_OCCLUDED:ae.PerformanceCategory.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(...pe)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(D.ShaderOutput.ShadowHighlight,J.RenderSlot.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:r}=this,i=this._framebufferSize,{highlights:s}=r,a=e.acquire(i.width,i.height,"highlights",s.length>F.maxHighlightsPerChannel?O.ColorFormat.RG8UINT:O.ColorFormat.R8UINT);a.acquireDepth(O.DepthFormat.DEPTH24_STENCIL8),t.bindFramebuffer(a.fbo);const{gl:n}=t;return n.clearBufferuiv(n.COLOR,0,[0,0,0,0]),this._renderContext.output=D.ShaderOutput.Highlight,t.bindFramebuffer(a.fbo),F.renderHighlightBuffer(t,e,i,r,(()=>this._renderHighlightGeometries())),this.performanceInfo.advance(ae.PerformanceCategory.HIGHLIGHTS),a}_renderHighlightGeometries(){this._plugins.render(...me),this._rctx.clear(he.FramebufferBit.DEPTH),this._renderHUDElements(w.HUDRenderStyle.Both)}_renderShadowAccumulation(e,t,r){this._shadowAccumulator.updateDepthRange(e),this._shadowAccumulator.accumulating&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,t,r)&&this.performanceInfo.advance(ae.PerformanceCategory.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&D.isColorOrColorEmission(this._renderContext.output)?(this._bindParameters.oitPass=z.OITPass.ColorAlpha,this._plugins.precompile(..._e),this._bindParameters.oitPass=z.OITPass.FrontFace,this._plugins.precompile(..._e),this._bindParameters.oitPass=z.OITPass.NONE):this._plugins.precompile(..._e)}_renderOIT(e,t,r=w.HUDRenderStyle.Both){const i=e===oe.HUD,s=this._framebufferSize,a=i?this.fboCache.acquire(s.width,s.height,"oit hud composite"):null,n=i?()=>this._renderHUDElements(r):()=>this._renderTransparentGeometry(),h=this._bindParameters,o=this._renderContext.output;this._renderContext.output=t,h.oitPass=z.OITPass.ColorAlpha;const d=a?"oit hud color+alpha":"oit color+alpha",l=this.fboCache.acquire(s.width,s.height,d,O.ColorFormat.RGBA16FLOAT),u=t===D.ShaderOutput.ColorEmission;u&&l.acquireColor(he.ColorAttachment1,O.ColorFormat.RGBA16FLOAT,"emissive"),l.acquireColor(u?he.ColorAttachment2:he.ColorAttachment1,O.ColorFormat.R16FLOAT),a||l.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(l.fbo),this._rctx.clearFramebuffer([0,0,0,1]),u&&this._rctx.clearBuffer(1,b.ZEROS),n(),l.detachDepth(),h.oitPass=z.OITPass.FrontFace;const _=this.fboCache.acquire(s.width,s.height,a?"oit hud front":"oit front");return u&&_.acquireColor(he.ColorAttachment1,O.ColorFormat.RGBA16FLOAT,"emissive"),a?_.acquireDepth(O.DepthFormat.DEPTH16):_.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(_.fbo),this._rctx.clearFramebuffer(S.ZEROS,!!a),n(),_.detachDepth(),h.oitPass=z.OITPass.NONE,a?(this._rctx.bindFramebuffer(a.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(he.FramebufferBit.COLOR)):this._framebuffer.bind(),this._oitblend??=new L.OITBlend(this._techniques),this._oitblend.blend(this._rctx,l,_,h,u),a?.detachDepth(),_.release(),l.release(),this._renderContext.output=o,a}_renderOpaque(e){const t=this.plugins.produces(D.ShaderOutput.Color,...ue);if(t){this._plugins.render(J.RenderSlot.INTEGRATED_MESH,J.RenderSlot.OPAQUE_TERRAIN);const e=this._framebuffer;e.update((e=>this._renderNodes(A.InternalRenderCategory.OPAQUE_TERRAIN,e))),e.bind(),this._plugins.render(J.RenderSlot.OPAQUE_MATERIAL,J.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS)}const r=this._framebuffer;r.update((e=>this._renderNodes(A.RenderCategory.OPAQUE,e,t))),this.fboCache.debugCallback?.(A.RenderCategory.OPAQUE,r.color.fbo),r.update((e=>this._renderNodes(A.InternalRenderCategory.OPAQUE_ENVIRONMENT,e))),this.fboCache.debugCallback?.(A.InternalRenderCategory.OPAQUE_ENVIRONMENT,r.color.fbo),this._renderTerrainDepth(e),this._renderEdges(re.Transparency.OPAQUE)}_renderTransparent(e,t,r){const i=this._framebuffer;i.bind(),this._renderPlugins(J.RenderSlot.VOXEL,ae.PerformanceCategory.VOXEL),this._renderHiddenTransparentEdges(),e&&(this._oitEnabled?this._renderOIT(oe.Geometry,r):this._renderTransparentGeometry()),i.update((t=>this._renderNodes(A.RenderCategory.TRANSPARENT,t,e))),this.fboCache.debugCallback?.(A.RenderCategory.TRANSPARENT,i.color.fbo),this._renderGeometryDepth(t),this._renderHUDVisibility(),t||this._plugins.render(J.RenderSlot.LINE_CALLOUTS),this._renderEdges(re.Transparency.TRANSPARENT);const s=this._hasTransparentTerrain?this._renderTransparentTerrain():null;s&&(this.performanceInfo.advance(ae.PerformanceCategory.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(t?this._renderLineCallouts(w.HUDRenderStyle.Occluded):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,s.getTexture())),this._renderHUD(w.HUDRenderStyle.Occluded,i.color,r))),this._bindParameters.cullAboveTerrain=!1,s&&(i.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,s.getTexture()),s.release(),t&&(this._renderEdges(re.Transparency.OPAQUE),e&&(this._oitEnabled?this._renderOIT(oe.Geometry,r):this._renderTransparentGeometry(),this.performanceInfo.advance(ae.PerformanceCategory.TRANSPARENT)),this._renderEdges(re.Transparency.TRANSPARENT))),this._bindParameters.ssao=o.releaseMaybe(this._bindParameters.ssao),t&&this._renderLineCallouts(w.HUDRenderStyle.NotOccluded),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(ae.PerformanceCategory.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(J.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),this.performanceInfo.advance(ae.PerformanceCategory.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(e),this.performanceInfo.advance(t))}_renderNodes(e,t,r=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return r&&this.performanceInfo.advance(e),t;const i=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),i}_blitFBO(e,t=y.defaultWebGLFBO,r=!0){return this._blit??=new x.Blit(this._techniques),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),r&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=f.IDENTITY:(g.invert(fe,this._bindParameters.camera.viewMatrix),g.invert(ge,this._bindParameters.camera.projectionMatrix),g.multiply(Re,fe,ge),g.multiply(Re,this._renderContext.lastFrameCamera.viewMatrix,Re),g.multiply(Re,this._renderContext.lastFrameCamera.projectionMatrix,Re),this._reprojectionMatrix=Re);const t=this.stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=f.IDENTITY,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,r,i){this._bindParameters.updateLighting(e,t,r,i),this._requestRender(G.RenderRequestType.UPDATE)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,t,r,i,s=!1,a=!1){t.attachDepth(r),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(i,s,a),e(),t.detachDepth()}get test(){}},r.__decorate([c.property({readOnly:!0})],t.Renderer.prototype,"fullResolutionAtmosphere",null),r.__decorate([c.property()],t.Renderer.prototype,"_edgeView",void 0),r.__decorate([c.property()],t.Renderer.prototype,"updating",null),t.Renderer=r.__decorate([m.subclass("esri.views.3d.webgl-engine.lib.Renderer")],t.Renderer),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(oe||(oe={}));const de=[J.RenderSlot.INTEGRATED_MESH,J.RenderSlot.OPAQUE_TERRAIN,J.RenderSlot.OPAQUE_MATERIAL,J.RenderSlot.TRANSPARENT_MATERIAL],le=[J.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS,J.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],ue=[J.RenderSlot.INTEGRATED_MESH,J.RenderSlot.OPAQUE_TERRAIN,J.RenderSlot.OPAQUE_MATERIAL,J.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS],_e=[J.RenderSlot.TRANSPARENT_MATERIAL,J.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],ce=[J.RenderSlot.OPAQUE_MATERIAL,J.RenderSlot.TRANSPARENT_MATERIAL,J.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],pe=[J.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,J.RenderSlot.HUD_MATERIAL,J.RenderSlot.LABEL_MATERIAL],me=[J.RenderSlot.TRANSPARENT_MATERIAL,J.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,J.RenderSlot.OPAQUE_MATERIAL,J.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS,J.RenderSlot.TRANSPARENT_TERRAIN,J.RenderSlot.INTEGRATED_MESH,J.RenderSlot.OPAQUE_TERRAIN],ge=f.create(),fe=f.create(),Re=f.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));