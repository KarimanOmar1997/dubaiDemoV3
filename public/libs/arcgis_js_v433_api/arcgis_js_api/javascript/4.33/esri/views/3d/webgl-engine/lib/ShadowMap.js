// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../ViewingMode","../core/FBOCacheFormats","./CascadeCamera","./textureUtils","./Util","../../../webgl/enums"],(function(t,e,s,a,i,r,c,h,n,o,l,d,u,_,m,g,f,p,x){"use strict";var b;t.SnapshotSlot=void 0,(b=t.SnapshotSlot||(t.SnapshotSlot={}))[b.Highlight=0]="Highlight",b[b.ExcludeHighlight=1]="ExcludeHighlight";class M{constructor(){this.camera=new g.CascadeCamera,this.lightMat=c.create()}}class y{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}const w=c.create(),C=u.create(),S=[];for(let t=0;t<8;++t)S.push(u.create());const D=n.create(),v=n.create(),T=n.create(),H=n.create(),F=n.create(),O=l.create(),j=[],B=c.create(),I=c.IDENTITY.concat(c.IDENTITY,c.IDENTITY,c.IDENTITY,c.IDENTITY),N=n.create(),E=n.create(),R=[n.create(),n.create(),n.create(),n.create()],V=n.create(),Q=n.create(),L=n.create(),q=n.create(),z=n.create(),A=n.create(),W=n.create();function P(t,e){return 3*e+t}const Y=n.create();function k(t,e){return h.set(Y,t[e],t[e+3]),Y}const U=n.create(),G=i.create();t.ShadowMap=class{constructor(t,s){this._fbos=t,this._viewingMode=s,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new y,this._projectionView=c.create(),this._projectionViewInverse=c.create(),this._modelViewLight=c.create(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=u.create(),this._cascades=[new M,new M,new M,new M],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(e("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(x.DepthStencilAttachment)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return d.set(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=a.releaseMaybe(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(t){this.settings.maxNumCascadesHighQuality=s.clamp(Math.floor(t),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(t){this._enabled=t,t||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let t=0;t<this._numCascades;++t)j[t]=this._cascades[t];return j.length=this._numCascades,j}start(t,e,s,a,i){p.assert(this.enabled);const{near:r,far:c}=function(t){let{near:e,far:s}=t;return e<2&&(e=2),s<2&&(s=2),e>=s&&(e=2,s=4),{near:e,far:s}}(s);this._computeCascadeDistances(r,c,a),this._textureHeight=this._computeTextureHeight(t,i,a),this._setupMatrices(t,e);const{viewMatrix:h,projectionMatrix:n}=t;for(let t=0;t<this._numCascades;++t)this._constructCascade(t,n,h,e);this._lastOrigin=null,this.clear()}finish(){p.assert(this.enabled)}getShadowMapMatrices(t){if(!this._lastOrigin||!o.exactEquals(t,this._lastOrigin)){this._lastOrigin=this._lastOrigin||l.create(),o.copy(this._lastOrigin,t);for(let e=0;e<this._numCascades;++e){r.translate(B,this._cascades[e].lightMat,t);for(let t=0;t<16;++t)I[16*e+t]=B[t]}}return I}moveSnapshot(e){p.assert(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(e===t.SnapshotSlot.Highlight?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){if(!this.enabled)return;const s=this._handle?.getTexture(x.DepthStencilAttachment)?.descriptor;if(!s)return;this._snapshots[e]?.release();const a=e===t.SnapshotSlot.Highlight?"shadow map highlight":"shadow map excluding highlight",i=this._acquireFBO(a);this._snapshots[e]=i;const r=this._handle?.fbo;if(!r||!i?.fbo)return void console.error("No FBO");const{rctx:c}=this._fbos;c.blitFramebuffer(r,i.fbo,x.FramebufferBit.DEPTH)}getSnapshot(t){return this.enabled?this._snapshots[t]?.getTexture(x.DepthStencilAttachment):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(x.FramebufferBit.DEPTH)}_computeTextureHeight({pixelRatio:t,fullWidth:e,fullHeight:s},a,i){const r=Math.min(window.devicePixelRatio,a)/t,c=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return f.applyTextureResizeModulo(Math.max(e,s)*r*c,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(t){const e=this._fbos.acquire(this._textureWidth,this._textureHeight,t,m.DepthFormat.DEPTH16);return e.getTexture(x.DepthStencilAttachment)?.setShadowFiltering(!0),e}_discardSnapshot(t){this._snapshots[t]=a.releaseMaybe(this._snapshots[t])}_discardSnapshots(){for(let t=0;t<this._snapshots.length;++t)this._discardSnapshot(t);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(t,e,a,i){const c=this._cascades[t],n=-this._cascadeDistances[t],l=-this._cascadeDistances[t+1],u=(e[10]*n+e[14])/Math.abs(e[11]*n+e[15]),_=(e[10]*l+e[14])/Math.abs(e[11]*l+e[15]);p.assert(u<_);for(let t=0;t<8;++t){d.set(C,t%4==0||t%4==3?-1:1,t%4==0||t%4==1?-1:1,t<4?u:_,1);const e=S[t];d.transformMat4(e,C,this._projectionViewInverse),e[0]/=e[3],e[1]/=e[3],e[2]/=e[3]}o.negate(O,S[0]),c.camera.viewMatrix=r.translate(w,this._modelViewLight,O);for(let t=0;t<8;++t)o.transformMat4(S[t],S[t],c.camera.viewMatrix);let m=S[0][2],g=S[0][2];for(let t=1;t<8;++t)m=Math.min(m,S[t][2]),g=Math.max(g,S[t][2]);m-=200,g+=200,c.camera.near=-g,c.camera.far=-m,function(t,e,a,i,r){const c=1/S[0][3],n=1/S[4][3];p.assert(c<n);let o=c+Math.sqrt(c*n);const l=Math.sin(s.acosClamped(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));o/=l,function(t,e,s,a,i,r,c,n){h.set(N,0,0);for(let e=0;e<4;++e)h.add(N,N,t[e]);h.scale(N,N,.25),h.set(E,0,0);for(let e=4;e<8;++e)h.add(E,E,t[e]);h.scale(E,E,.25),h.lerp(R[0],t[4],t[5],.5),h.lerp(R[1],t[5],t[6],.5),h.lerp(R[2],t[6],t[7],.5),h.lerp(R[3],t[7],t[4],.5);let o=0,l=h.squaredDistance(R[0],N);for(let t=1;t<4;++t){const e=h.squaredDistance(R[t],N);e<l&&(l=e,o=t)}h.subtract(V,R[o],t[o+4]);const d=V[0];let u,_;V[0]=-V[1],V[1]=d,h.subtract(Q,E,N),h.dot(Q,V)<0&&h.negate(V,V),h.lerp(V,V,Q,s),h.normalize(V,V),u=_=h.dot(h.subtract(L,t[0],N),V);for(let e=1;e<8;++e){const s=h.dot(h.subtract(L,t[e],N),V);s<u?u=s:s>_&&(_=s)}h.copy(a,N),h.scale(L,V,u-e),h.add(a,a,L);let m=-1,g=1,f=0,x=0;for(let e=0;e<8;++e){h.subtract(q,t[e],a),h.normalize(q,q);const s=V[0]*q[1]-V[1]*q[0];s>0?s>m&&(m=s,f=e):s<g&&(g=s,x=e)}p.verify(m>0,"leftArea"),p.verify(g<0,"rightArea"),h.scale(z,V,u),h.add(z,z,N),h.scale(A,V,_),h.add(A,A,N),W[0]=-V[1],W[1]=V[0];const b=p.rayRay2D(a,t[x],A,h.add(L,A,W),1,i),M=p.rayRay2D(a,t[f],A,L,1,r),y=p.rayRay2D(a,t[f],z,h.add(L,z,W),1,c),w=p.rayRay2D(a,t[x],z,L,1,n);p.verify(b,"rayRay"),p.verify(M,"rayRay"),p.verify(y,"rayRay"),p.verify(w,"rayRay")}(S,o,l,D,v,T,H,F),function(t,e,s,a,i){h.subtract(U,s,a),h.scale(U,U,.5),G[0]=U[0],G[1]=U[1],G[2]=0,G[3]=U[1],G[4]=-U[0],G[5]=0,G[6]=U[0]*U[0]+U[1]*U[1],G[7]=U[0]*U[1]-U[1]*U[0],G[8]=1,G[P(0,2)]=-h.dot(k(G,0),t),G[P(1,2)]=-h.dot(k(G,1),t);let r=h.dot(k(G,0),s)+G[P(0,2)],c=h.dot(k(G,1),s)+G[P(1,2)],n=h.dot(k(G,0),a)+G[P(0,2)],o=h.dot(k(G,1),a)+G[P(1,2)];r=-(r+n)/(c+o),G[P(0,0)]+=G[P(1,0)]*r,G[P(0,1)]+=G[P(1,1)]*r,G[P(0,2)]+=G[P(1,2)]*r,r=1/(h.dot(k(G,0),s)+G[P(0,2)]),c=1/(h.dot(k(G,1),s)+G[P(1,2)]),G[P(0,0)]*=r,G[P(0,1)]*=r,G[P(0,2)]*=r,G[P(1,0)]*=c,G[P(1,1)]*=c,G[P(1,2)]*=c,G[P(2,0)]=G[P(1,0)],G[P(2,1)]=G[P(1,1)],G[P(2,2)]=G[P(1,2)],G[P(1,2)]+=1,r=h.dot(k(G,1),e)+G[P(1,2)],c=h.dot(k(G,2),e)+G[P(2,2)],n=h.dot(k(G,1),s)+G[P(1,2)],o=h.dot(k(G,2),s)+G[P(2,2)],r=-.5*(r/c+n/o),G[P(1,0)]+=G[P(2,0)]*r,G[P(1,1)]+=G[P(2,1)]*r,G[P(1,2)]+=G[P(2,2)]*r,r=h.dot(k(G,1),e)+G[P(1,2)],c=h.dot(k(G,2),e)+G[P(2,2)],n=-c/r,G[P(1,0)]*=n,G[P(1,1)]*=n,G[P(1,2)]*=n,i[0]=G[0],i[1]=G[1],i[2]=0,i[3]=G[2],i[4]=G[3],i[5]=G[4],i[6]=0,i[7]=G[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=G[6],i[13]=G[7],i[14]=0,i[15]=G[8]}(D,v,H,F,r.projectionMatrix),r.projectionMatrix[10]=2/(a-i),r.projectionMatrix[14]=-(a+i)/(a-i)}(a,i,m,g,c.camera),r.multiply(c.lightMat,c.camera.projectionMatrix,c.camera.viewMatrix);const f=this._textureHeight;c.camera.viewport=[t*f,0,f,f]}_setupMatrices(t,e){r.multiply(this._projectionView,t.projectionMatrix,t.viewMatrix),r.invert(this._projectionViewInverse,this._projectionView);const s=this._viewingMode===_.ViewingMode.Global?t.eye:o.set(O,0,0,1);r.lookAt(this._modelViewLight,[0,0,0],[-e[0],-e[1],-e[2]],s)}_computeCascadeDistances(t,e,a){const i=a?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(p.logWithBase(e/t,4)),i);const r=(e-t)/this._numCascades,c=(e/t)**(1/this._numCascades);let h=t,n=t;for(let t=0;t<this._numCascades+1;++t)this._cascadeDistances[t]=s.lerp(h,n,this.settings.splitSchemeLambda),h*=c,n+=r}get test(){}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));