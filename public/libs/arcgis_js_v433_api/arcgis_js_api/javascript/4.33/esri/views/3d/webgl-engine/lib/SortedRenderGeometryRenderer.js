// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/MapUtils","../../../../core/PooledArray","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/sphere","../../terrain/Intersector","../core/shaderLibrary/ShaderOutput","./ChangeSet","./IntersectorInterfaces","./IntersectorResult","./IntersectorType","./Material","./ModelDirtyTypes","./RendererBase","./RenderSlot","../../../support/Scheduler"],(function(e,r,t,s,n,i,o,d,a,h,c,l,p,u,g,m,y,_,R,f,S,G){"use strict";e.SortedRenderGeometryRenderer=class extends f.RendererBase{constructor(e){super(e),this._pending=new v,this._changes=new u.ChangeSet,this._sortedRenderers=new n,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlight(e){return s.someMap(this.renderers,(r=>r.hasHighlight(e)))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(const e of this.renderers.values())if(0!==e.numGeometries&&e.renderOccludedFlags&~_.RenderOccludedFlag.Occlude)return!0;return!1}get isEmpty(){return!this.updating&&0===this.renderers.size&&0===this._geometries.size}get sortedRenderers(){return this._sortedRenderers}commitChanges(){return!!this.updating&&(this._processAddsRemoves(),this.commit(this._changes,G.noBudget,this.rendererContext.pluginContext)&&(this._updateSortedMaterialRenderers(),this._hasHighlights=s.someMap(this.renderers,(e=>{const r=e.produces.get(S.RenderSlot.DRAPED_MATERIAL);return!!r&&r(p.ShaderOutput.Highlight)})),this._hasWater=s.someMap(this.renderers,(e=>{const r=e.produces.get(S.RenderSlot.DRAPED_WATER);return!!r&&r(p.ShaderOutput.Normal)}))),this.notifyChange("updating"),!0)}rendererAdded(){this._sortedRenderers.clear()}rendererRemoved(){this._sortedRenderers.clear()}addGeometries(e,r){if(0===e.length)return;const t=this._validateRenderGeometries(e);for(const e of t)this._geometries.set(e.id,e);const s=this._pending.empty;for(const e of t)this._pending.adds.add(e);s&&this.notifyChange("updating"),r===R.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,r){const t=this._pending.empty,s=this._pending.adds;for(const r of e)s.has(r)?(this._pending.removed.add(r),s.delete(r)):this._pending.removed.has(r)||this._pending.removes.add(r),this._geometries.delete(r.id);t&&!this._pending.empty&&this.notifyChange("updating"),r===R.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,r){const t=0===this._changes.updates.length;for(const t of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._ensureValidRenderGeometry(t),e.updateType=r}switch(t&&this._changes.updates.length>0&&this.notifyChange("updating"),r){case R.DirtyState.TRANSFORMATION:case R.DirtyState.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case R.DirtyState.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let r=!1;return this._sortedRenderers.forAll((t=>r=!!t.updateAnimation&&t.updateAnimation(e)||r)),r}precompile(e){return this._sortedRenderers.reduce(((r,t)=>t.precompile(e)||r),!1)}render(e){this._sortedRenderers.forAll((r=>{const t=r.acquireTechniques(e);t&&r.render(e,t)}))}intersect(e,r,t,s,n){for(const i of this._geometries.values()){if(!s(i))continue;this._intersectRenderGeometry(i,t,r,0,e,n);const o=this.rendererContext.longitudeCyclical;o&&(i.boundingSphere[0]-i.boundingSphere[3]<o.min&&this._intersectRenderGeometry(i,t,r,o.range,e,n),i.boundingSphere[0]+i.boundingSphere[3]>o.max&&this._intersectRenderGeometry(i,t,r,-o.range,e,n)),n++}return n}_updateSortedMaterialRenderers(){if(!(this._sortedRenderers.length>0)){for(const e of this.renderers.values())this._sortedRenderers.push(e);this._sortedRenderers.sort(((e,r)=>r.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-r.drapedPriority:(r.material?.renderPriority||0)-(e.material?.renderPriority||0)))}}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace((({renderGeometry:e})=>!this._pending.has(e))),this._pending.clear()}_intersectRenderGeometry(e,r,t,s,n,i){if(!e.visible||!e.material.visible||!e.material.intersectDraped)return;let o=0;s+=e.transformation[12],o=e.transformation[13],O[0]=t[0]-s,O[1]=t[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,n,O,((t,s,o)=>{!function(e,r,t,s,n,i,o){const d=new l.OverlayTarget(i,o,r),a=r=>{r.set(y.IntersectorType.OVERLAY,d,e.distance,e.normal,e.transformation,t,s)};if((null==n.results.min.drapedLayerOrder||t>=n.results.min.drapedLayerOrder)&&(null==n.results.min.distance||n.results.ground.distance<=n.results.min.distance)&&a(n.results.min),n.options.store!==g.StoreResults.MIN&&(null==n.results.max.drapedLayerOrder||t<n.results.max.drapedLayerOrder)&&(null==n.results.max.distance||n.results.ground.distance>n.results.max.distance)&&a(n.results.max),n.options.store===g.StoreResults.ALL){const e=new m.IntersectorResult(n.ray);a(e),n.results.all.push(e)}}(r,o,i,e.material.renderPriority,n,e.layerViewUid,e.graphicUid)}),r)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let r;for(const{graphicUid:t}of e)null!=t&&t!==r&&(this.drapeSource.notifyGraphicGeometryChanged(t),r=t)}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let r;for(const{graphicUid:t}of e)null!=t&&t!==r&&(this.drapeSource.notifyGraphicVisibilityChanged(t),r=t)}_validateRenderGeometries(e){for(const r of e)this._ensureValidRenderGeometry(r);return e}_ensureValidRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin(c.getCenter(e.boundingSphere))),e}get test(){}},r.__decorate([i.property({constructOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"drapeSource",void 0),r.__decorate([i.property({constructOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"rendererContext",void 0),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"updating",null),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"rctx",null),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"_localOriginFactory",null),r.__decorate([i.property({readOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"isEmpty",null),r.__decorate([i.property()],e.SortedRenderGeometryRenderer.prototype,"_geometries",void 0),e.SortedRenderGeometryRenderer=r.__decorate([a.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],e.SortedRenderGeometryRenderer);class v{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const O=h.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));