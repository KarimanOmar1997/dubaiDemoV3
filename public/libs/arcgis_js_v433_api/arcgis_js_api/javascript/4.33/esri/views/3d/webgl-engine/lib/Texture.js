// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","../../../../core/Error","../../../../core/Evented","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/typedArrayUtil","../../../../core/uid","../../../../core/urlUtils","../../../../layers/support/videoUtils","../../../../support/requestImageUtils","../../../../support/requestUtils","./basicInterfaces","./BasisUtil","./DDSUtil","./textureUtils","./Util","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,r,a,i,s,o,n,l,m,d,h,p,u,_,c,g,T,x,y){"use strict";function E(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}const A={wrap:{s:T.TextureWrapMode.REPEAT,t:T.TextureWrapMode.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};e.Texture=class{constructor(e,t){this._data=e,this.id=n.generateUID(),this.events=new a,this._parameters={...A,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(l.isBlobProtocol(e.src)||"auto"===e.preload&&e.crossOrigin)&&(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src,e.paused&&e.autoplay)){const t=[];m.whenVideoPlayable(e,(e=>t.push(e))).then((()=>{e.play()})).finally((()=>t.forEach((e=>e.remove()))))}}_startPreloadImageElement(e){l.isDataProtocol(e.src)||l.isBlobProtocol(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new y.TextureDescriptor;return t.wrapMode=this._parameters.wrap??T.TextureWrapMode.REPEAT,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?T.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:T.TextureSamplingMode.LINEAR,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return null!=this._glTexture}get usedMemory(){return this._glTexture?.usedMemory||function(e,t){if(null==e)return 0;if(o.isArrayBuffer(e)||o.isUint8Array(e))return t.encoding===p.TextureEncodingMimeType.KTX2_ENCODING?u.estimateMemoryKTX2(e,!!t.mipmap):t.encoding===p.TextureEncodingMimeType.BASIS_ENCODING?u.estimateMemoryBasis(e,!!t.mipmap):e.byteLength;const{width:r,height:a}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?E(e):t;return(t.mipmap?4/3:1)*r*a*(t.components||4)||0}(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const t=this._data;return null==t?(this._glTexture=new x.Texture(e,this._createDescriptor(e),null),this._glTexture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),"string"==typeof t?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):o.isUint8Array(t)&&this._parameters.encoding===p.TextureEncodingMimeType.DDS_ENCODING?this._loadFromDDSData(e,t):o.isArrayBuffer(t)&&this._parameters.encoding===p.TextureEncodingMimeType.DDS_ENCODING?this._loadFromDDSData(e,new Uint8Array(t)):(o.isArrayBuffer(t)||o.isUint8Array(t))&&this._parameters.encoding===p.TextureEncodingMimeType.KTX2_ENCODING?this._loadFromKTX2(e,t):(o.isArrayBuffer(t)||o.isUint8Array(t))&&this._parameters.encoding===p.TextureEncodingMimeType.BASIS_ENCODING?this._loadFromBasis(e,t):o.isUint8Array(t)?this._loadFromPixelData(e,t):o.isArrayBuffer(t)?this._loadFromPixelData(e,new Uint8Array(t)):null)}_update(e,t){return null==this._glTexture||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=_.createDDSTexture(e,this._createDescriptor(e),t),this._emptyTexture=null,this._glTexture}_loadFromKTX2(e,t){return this._loadAsync((()=>u.createTextureKTX2(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromBasis(e,t){return this._loadAsync((()=>u.createTextureBasis(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromPixelData(e,t){g.assert(this._parameters.width>0&&this._parameters.height>0);const r=this._createDescriptor(e);return r.pixelFormat=1===this._parameters.components?T.PixelFormat.LUMINANCE:3===this._parameters.components?T.PixelFormat.RGB:T.PixelFormat.RGBA,r.pixelFormat!==T.PixelFormat.RGB&&r.pixelFormat!==T.PixelFormat.RGBA||(r.compress=this._parameters.compressionOptions),r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new x.Texture(e,r,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync((async r=>{const a=await d.requestImage(t,{signal:r});return s.throwIfAborted(r),this._loadFromImage(e,a)}))}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync((async r=>{const a=await h.loadImageAsync(t,t.src,!1,r);return s.throwIfAborted(r),this._loadFromImage(e,a)}))}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync((a=>new Promise(((o,n)=>{const l=()=>{t.removeEventListener("loadeddata",m),t.removeEventListener("error",d),i.removeMaybe(h)},m=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(l(),o(this._loadFromImage(e,t)))},d=e=>{l(),n(e||new r("texture:load-error","Failed to load video"))};t.addEventListener("loadeddata",m),t.addEventListener("error",d);const h=s.onAbort(a,(()=>d(s.createAbortError())))}))))}_loadFromImage(e,t){let r=t;r instanceof HTMLVideoElement||(r=c.ensureImageMaxSize(r,e.parameters));const a=E(r);this._parameters.width=a.width,this._parameters.height=a.height;const i=this._createDescriptor(e);return i.pixelFormat=3===this._parameters.components?T.PixelFormat.RGB:T.PixelFormat.RGBA,i.width=a.width,i.height=a.height,i.compress=this._parameters.compressionOptions,this._glTexture=new x.Texture(e,i,r),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const r=e(t.signal);this._loadingPromise=r;const a=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null),this._emptyTexture=null};return r.then(a,a),r}unload(){if(this._glTexture=i.disposeMaybe(this._glTexture),this._emptyTexture=null,null!=this._loadingController){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));