// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../core/FBOCacheFormats","./textureUtils","./ViewshedFaceCamera","../../../webgl/enums","../../../webgl/textureUtils"],(function(t,e,i,s,r,a,h,o,c,n,l,u,d){"use strict";class f{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(t){const e=t?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*e}textureResizeModulo(t){return Math.ceil(t/this.textureSizeMultiple)*this.textureSizeMultiple}}const m=["front","left","right","back","top","bottom"];t.ViewshedShadowMap=class{constructor(t){this._fbos=t,this._faces={},this._width=0,this._height=0,this.settings=new f,this._maxTextureSize=Math.min(e("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture(u.DepthStencilAttachment)}get ready(){return null!=this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const t=this.faces;return 0===t.length?null:t[0].nearFar}get numActiveFaces(){const t=this._faces;let e=0;return Object.keys(t).forEach((i=>{t[i]&&(e+=1)})),e}get faces(){const t=this._faces,e=[];for(const i of m){const s=t[i];s&&e.push(s)}return e}get atlasRegions(){return this.faces.map((t=>[t.x/this._width,(t.x+t.width)/this._width,t.y/this._height,(t.y+t.height)/this._height]))}get viewshedProjectionMatrices(){return this.faces.map((t=>t.projectionMatrix))}get viewshedViewMatrices(){return this.faces.map((t=>t.viewMatrix))}_setupFaceCamera(t,e,s,c){const{effectiveObserverRenderSpace:n,tiltedUpVector:u,targetRenderSpace:d,farDistanceRenderSpace:f,horizontalFieldOfView:m,verticalFieldOfView:g}=e,p=o.create();h.sub(p,d,n);const _=o.create(),x=o.create(),b=(t,e)=>{const i=o.create(),s=a.create();return r.fromRotation(s,t,e),h.transformMat4(i,p,s),h.add(i,n,i),i};let S,w=u;const M=Math.min(90,m),F=Math.min(90,Math.max(0,(m-90)/2));let z=-45,T=45,O=-45,v=45;if(!["top","bottom"].includes(t)){const t=t=>i.clamp(t,-45,45);O=t(-g/2)-this.settings.toleranceBottomTop,v=t(+g/2)+this.settings.toleranceBottomTop}switch(t){case"front":S=d,z=-M/2,T=M/2;break;case"left":S=b(Math.PI/2,u),z=45-F;break;case"right":S=b(-Math.PI/2,u),T=-45+F;break;case"top":S=h.add(_,n,u),w=h.negate(x,p);break;case"bottom":S=h.sub(_,n,u),w=p;break;case"back":S=b(Math.PI,u)}const B=new l.ViewshedFaceCamera({center:S,eye:n,up:w,far:f});B.sectionAnglesDeg=[z-this.settings.toleranceSides,T+this.settings.toleranceSides,O,v],B.fovY=Math.PI/2;const y=B.setViewport(s,c);return this._faces[t]=B,y}isActive(t){return this._computeActiveFaces(t).size>0}_computeActiveFaces(t){const e=new Set,{horizontalFieldOfView:i,verticalFieldOfView:s}=t,r=-s/2,a=s/2;return 0===i||0===s||(r<=45&&a>=-45&&e.add("front"),i>90&&(e.add("left"),e.add("right")),i>270&&e.add("back"),a>45-this.settings.toleranceBottomTop&&e.add("top"),r<-45+this.settings.toleranceBottomTop&&e.add("bottom")),e}_computeBaseTextureSize({pixelRatio:t,fullWidth:e,fullHeight:i},s,r,a){const h=s/t,o=this.settings.textureSizeModifier(r);return n.applyTextureResizeModulo(Math.max(e,i)*h*o,this._maxTextureSize/a)}_ensureFBO(t){const e=this._width,i=this._height,s=this._handle?.fbo;s&&s.width===e&&s.height===i&&t===d.isSizedDepthStencilFormat(s.depthStencilTexture?.descriptor?.internalFormat??u.SizedDepthFormat.DEPTH_COMPONENT16)||(this._handle?.release(),this._handle=this._allocateFBO(t))}_allocateFBO(t){const{_width:e,_height:i}=this,s=t?c.DepthFormat.DEPTH24_STENCIL8:c.DepthFormat.DEPTH16,r=this._fbos.acquire(e,i,"viewshed shadow map",s);return r.getTexture(u.DepthStencilAttachment)?.setShadowFiltering(!1),r}clearFBO(t){const e=this._fbos.rctx;this._ensureFBO(t),e.bindFramebuffer(this._handle?.fbo),e.setClearColor(1,1,1,1),e.clear(u.FramebufferBit.COLOR|u.FramebufferBit.DEPTH)}dispose(){this._debugFBO||(this._handle=s.releaseMaybe(this._handle))}start(t,e,i,s,r=!1){this._faces={};const a=this._computeActiveFaces(e),h=a.size;if(0===h)return!1;const o=this._computeBaseTextureSize(t,s,i,h);let c=0,n=0,l=0;return m.filter((t=>a.has(t))).forEach((t=>{const i=function(t,e){if(e<4)return 0;const i="front"===t||"left"===t;return 4===e?i?0:1:i||"right"===t?0:1}(t,h);i>n&&(l=Math.max(l,c),c=0),n=i;const s=i*o;c+=this._setupFaceCamera(t,e,[c,s],o)})),l=Math.max(l,c),this._width=this.settings.textureResizeModulo(l),this._height=(h<4?1:2)*o,this.clearFBO(r),!0}finish(){}get test(){}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));