// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/PooledArray","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/frustum","../../../../chunks/sphere","../../support/mathUtils","./DepthRange","./Octree","./Util"],(function(e,t,r,n,a,i,s,o,h,f,c,l,u){"use strict";var d;function _(e,t,n){if(!n.visible)return;if(!o.intersectsSphere(t.frustum,n.boundingVolumeWorldSpace.bounds))return;const a=n.transformation,i=O;n.geometries.forEach((n=>{r.multiply(i,a,n.transformation);const s=f.maxScale(i);g(e,t,n.boundingInfo,i,s)}))}function g(e,t,r,n,i){if(null==r)return;a.transformMat4(h.getCenter(D),r.center,n);const{eye:s,viewForward:f}=t,c=f[0]*(D[0]-s[0])+f[1]*(D[1]-s[1])+f[2]*(D[2]-s[2]);if(D[3]=r.radius*i,!(c-D[3]>e.near&&c+D[3]<e.far)&&o.intersectsSphere(t.frustum,D))if(r.radius>100&&r.getChildren())for(const a of r.getChildren())g(e,t,a,n,i);else v.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,n,r.bbMin,r.bbMax)}function m(e,t,r){const n=t.eye,a=t.viewForward,i=(r[0]-n[0])*a[0]+(r[1]-n[1])*a[1]+(r[2]-n[2])*a[2];e.near=Math.min(e.near,i-r[3]),e.far=Math.max(e.far,i+r[3])}e.DepthRangeMode=void 0,(d=e.DepthRangeMode||(e.DepthRangeMode={}))[d.SHADOW_CASTERS=0]="SHADOW_CASTERS",d[d.FULL_SCENE=1]="FULL_SCENE";class p{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new c.DepthRange(0,0)}compute(t,r,n){this._reset();const{viewMatrix:a}=t;r.forAll((t=>{t.forEachGeometry((t=>{if(!t.visible||n===e.DepthRangeMode.SHADOW_CASTERS&&!t.castShadow)return;const r=t.boundingSphere,i=a[2]*r[0]+a[6]*r[1]+a[10]*r[2]+a[14],s=i-r[3],o=i+r[3];this._geometries.push(t),this._near.push(-o),this._far.push(-s)}))}));const i=new c.DepthRange;if(0===this._geometries.length)return i;for(let e=0;e<this._geometries.length;++e)this._near[e]>i.far&&(i.far=this._near[e]),this._near[e]>2&&this._far[e]<i.near&&(i.near=this._far[e]);const s=this._looseRange;s.near=Math.max(.5*i.near,2),s.far=2*i.far;let o=0,h=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<i.near&&(this._near[e]>=s.near?i.near=this._near[e]:this._nearCandidates[o++]=e),this._far[e]>i.far&&(this._far[e]<=s.far?i.far=this._far[e]:this._farCandidates[h++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return i;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let e=0;e<this._nearCandidates.length;++e){const r=this._nearCandidates[e];if(this._near[r]<i.near){const e=this._geometries[r],{boundingInfo:n,shaderTransformation:a}=e;this._includeNearBoundingInfoRec(t,n,a,i)}}for(let e=0;e<this._farCandidates.length;++e){const r=this._farCandidates[e];if(this._far[r]>i.far){const e=this._geometries[r],{boundingInfo:n,shaderTransformation:a}=e;this._includeFarBoundingInfoRec(t,n,a,i)}}return this._reset(),i}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const r=h.getCenter(e),n=h.getRadius(e);return t[0][0]*r[0]+t[0][1]*r[1]+t[0][2]*r[2]+t[0][3]>n||t[1][0]*r[0]+t[1][1]*r[1]+t[1][2]*r[2]+t[1][3]>n||t[2][0]*r[0]+t[2][1]*r[1]+t[2][2]*r[2]+t[2][3]>n||t[3][0]*r[0]+t[3][1]*r[1]+t[3][2]*r[2]+t[3][3]>n}_includeNearBoundingInfoRec(e,t,r,n){if(null==t)return;const i=t.center;a.transformMat4(h.getCenter(D),i,r),D[3]=t.radius*f.maxScale(r);const{frustum:s}=e;if(this._isOutsideSidePlanes(D,s))return;const o=D[0],c=D[1],l=D[2],u=D[3],{viewMatrix:d}=e,_=d[2]*o+d[6]*c+d[10]*l+d[14],g=_+u;if(!(-(_-u)<2||-g>=n.near))if(-g>this._looseRange.near)n.near=-g;else{if(u>100){const a=t.getChildren();if(void 0!==a){for(const t of a)this._includeNearBoundingInfoRec(e,t,r,n);return}}v.unionDepthRangeWithAABB(n,e.viewProjectionMatrix,r,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,r,n){if(null==t)return;const i=t.center;a.transformMat4(h.getCenter(D),i,r),D[3]=t.radius*f.maxScale(r);const{frustum:s}=e;if(this._isOutsideSidePlanes(D,s))return;const[o,c,l,u]=D,{viewMatrix:d}=e,_=d[2]*o+d[6]*c+d[10]*l+d[14]-u;if(!(-_<=n.far))if(-_<this._looseRange.far)n.far=-_;else{if(u>100){const a=t.getChildren();if(void 0!==a){for(const t of a)this._includeFarBoundingInfoRec(e,t,r,n);return}}v.unionDepthRangeWithAABB(n,e.viewProjectionMatrix,r,t.bbMin,t.bbMax)}}}function R(e,t,r){let n=[e,t,r];for(let e=0;e<4;++e){const t=n;n=[];for(let r=0;r<t.length;++r){const a=t[r],i=t[(r+1)%t.length];b(i,e)?(b(a,e)||n.push(C(a,i,e)),n.push(i)):b(a,e)&&n.push(C(a,i,e))}}return n}function b(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void u.assert(!1)}function C(e,t,r){let n=0;return 0===r?n=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?n=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?n=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(n=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),i.lerp(s.create(),e,t,n)}const M=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],D=h.create(),O=n.create(),S=new c.DepthRange,w=new class{constructor(){this._items=new t({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll((e=>{const n=e.object.boundingVolumeWorldSpace.bounds,a=(n[0]-t[0])*r[0]+(n[1]-t[1])*r[1]+(n[2]-t[2])*r[2];e.distance=a,e.near=a-n[3],e.far=a+n[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,r){if(t===l.DepthOrder.FRONT_TO_BACK)for(let t=0;t<this._items.length;++t){const n=this._items.data[t];n.far<e.near||n.near>e.far||r(n.object,n.near,n.far)}else for(let t=this._items.length-1;t>=0;--t){const n=this._items.data[t];n.far<e.near||n.near>e.far||r(n.object,n.near,n.far)}}},A=new p,v=new class{constructor(){this._modelViewProj=n.create(),this._clipPosition=[s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create()]}unionDepthRangeWithAABB(e,t,n,a,i){const s=this._modelViewProj;r.multiply(s,t,n);let o=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],r=0===e||3===e||4===e||7===e?a[0]:i[0],n=0===e||1===e||4===e||5===e?a[1]:i[1],o=e<4?a[2]:i[2];t[0]=s[0]*r+s[4]*n+s[8]*o+s[12],t[1]=s[1]*r+s[5]*n+s[9]*o+s[13],t[2]=s[2]*r+s[6]*n+s[10]*o+s[14],t[3]=s[3]*r+s[7]*n+s[11]*o+s[15]}for(let t=0;t<12;++t){const r=R(this._clipPosition[M[t][0]],this._clipPosition[M[t][1]],this._clipPosition[M[t][2]]);let n=!0;for(let e=0;e<r.length;++e)if(r[e][3]>=2){n=!1;break}if(!n){o=!0;for(let t=0;t<r.length;++t){const n=r[t][3];Number.isFinite(n)&&(e.near=Math.min(n,e.near),e.far=Math.max(n,e.far))}}}return o}};e.DepthRangeFromRenderGeometries=p,e.depthRangeFromScene=function(e,t,r,n){let a=0;if(!t.some((e=>!!e.material&&(a+=e.numGeometries,a>=1e4))))return A.compute(e,t,n);const i=new c.DepthRange;return r.forAll((t=>i.union(function(e,t){if(!t.visible)return;const r=new c.DepthRange,n=t.getSpatialQueryAccelerator();return n?function(e,t,r){const{eye:n,viewForward:a,frustum:i}=t,s=e=>e.visible,o=r.objectCount;if(o<500)S.set(t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(n,a,l.DepthOrder.FRONT_TO_BACK,S,((r,n)=>{_(e,t,r),S.far=e.near,n.setRange(S)}),i,s),S.set(Math.max(e.far,t.near),t.far),r.forEachInDepthRange(n,a,l.DepthOrder.BACK_TO_FRONT,S,((r,n)=>{_(e,t,r),S.near=e.far,n.setRange(S)}),i,s);else{const n=Math.max(Math.min(o,500),Math.ceil(.1*o)),h=r.findClosest(a,l.DepthOrder.FRONT_TO_BACK,i,s,n),f=r.findClosest(a,l.DepthOrder.BACK_TO_FRONT,i,s,n);h&&f&&(m(e,t,h.boundingVolumeWorldSpace.bounds),m(e,t,f.boundingVolumeWorldSpace.bounds))}}(r,e,n):function(e,t,r){w.clear(),r.forEach((e=>{e.visible&&0!==e.geometries.length&&w.add(e)})),w.empty||(w.sort(t),S.set(t.near,Math.min(e.near,t.far)),w.forEachInDepthRange(S,l.DepthOrder.FRONT_TO_BACK,((r,n)=>{n<e.near&&_(e,t,r)})),S.set(Math.max(e.far,t.near),t.far),w.forEachInDepthRange(S,l.DepthOrder.BACK_TO_FRONT,((t,r,n)=>{e.far=Math.max(e.far,n)})))}(r,e,t.objects),r}(e,t)))),i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));