// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/PooledArray","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../../chunks/vec32","../../../support/debugFlags","../../core/util/TwoVectorPosition","./EdgeShaderParameters","./EdgeShaderTechnique","./EdgeShaderTechniqueConfiguration","./interfaces","../../shaders/sources/edgeRenderer/EdgeUtil.glsl","../../../../webgl/enums"],(function(e,r,t,s,a,n,i,o,d,c,l,h,T){"use strict";const g={type:h.EdgeType.Solid,hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0};class _{constructor(e,t,s){this.rctx=e,this._techniques=t,this._configuration=new c.EdgeShaderTechniqueConfiguration,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[l.Transparency.TRANSPARENT]:{[l.Transparency.TRANSPARENT]:new r,[l.Transparency.OPAQUE]:new r},[l.Transparency.OPAQUE]:{[l.Transparency.TRANSPARENT]:new r,[l.Transparency.OPAQUE]:new r}},this._renderablesDirty=!1,this._drawParameters=new o.EdgeDrawParameters,this._settings={...g,...s},this.key=_.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const a=this._settings.strokesTexture.variants;this.writerSettings={variants:a,reducedPrecision:n.debugFlags.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.type=this._settings.type,this._configuration.silhouette=!1,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.spherical=s.spherical}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,r){this._renderablesDirty&&this._sortRenderables();const t=this._sortedRenderables[r];t[l.Transparency.TRANSPARENT].forAll(e),t[l.Transparency.OPAQUE].forAll(e)}acquireTechnique(e,r){return this._lastOriginId=null,this._configuration.terrainDepthTest=e.terrainDepthTest,this._configuration.cullAboveTerrain=e.cullAboveTerrain,this._configuration.silhouette=r,this._techniques.get(d.EdgeShaderTechnique,this._configuration)}renderRegularEdges(e,r,t,s,a){this._render(e,r,r.regular.vao,t,s,a)}renderSilhouetteEdges(e,r,t,s,a){this._render(e,r,r.silhouette.vao,t,s,a)}_render(e,r,t,s,a,n){n>0&&(this._bindDraw(e,r,s,a),this.rctx.bindVAO(t),this.rctx.drawArraysInstanced(T.PrimitiveType.TRIANGLE_FAN,0,4,n))}_bindDraw(e,r,s,n){this._drawParameters.componentDataTexture=r.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture;const o=r.transform.origin;if(o){const t=o.origin.id;this._lastOriginId!==t&&(e.setUniformMatrix4fv("localView",o.viewMatrix),this._lastOriginId=t),e.setUniformMatrix4fv("model",r.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=o.origin.vec3}else{const e=new i.TwoVectorPosition(r.transform.position),s=t.transpose(u,t.invert(u,r.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=e.low,this._drawParameters.transformWorldFromModelTH=e.high,this._drawParameters.transformWorldFromModelRS=r.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=s;const o=n.camera.viewInverseTransposeMatrix;a.set(this._drawParameters.slicePlaneLocalOrigin,o[3],o[7],o[11])}e.bindDraw(n,s,this._drawParameters)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[l.Transparency.TRANSPARENT][l.Transparency.TRANSPARENT].clear(),this._sortedRenderables[l.Transparency.TRANSPARENT][l.Transparency.OPAQUE].clear(),this._sortedRenderables[l.Transparency.OPAQUE][l.Transparency.TRANSPARENT].clear(),this._sortedRenderables[l.Transparency.OPAQUE][l.Transparency.OPAQUE].clear(),this._renderables.forEach((e=>this._sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)));const e=(e,r)=>e.transform.origin?r.transform.origin?e.transform.origin.origin.id<r.transform.origin.origin.id?-1:e.transform.origin.origin.id>r.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[l.Transparency.TRANSPARENT][l.Transparency.TRANSPARENT].sort(e),this._sortedRenderables[l.Transparency.TRANSPARENT][l.Transparency.OPAQUE].sort(e),this._sortedRenderables[l.Transparency.OPAQUE][l.Transparency.TRANSPARENT].sort(e),this._sortedRenderables[l.Transparency.OPAQUE][l.Transparency.OPAQUE].sort(e)}static getKey(e,r,t){return`edges-t:${e}:${r}:${t}`}}const u=s.create();e.EdgeRenderer=_,e.extensionLengthOffset=128,e.lineWidthFractionFactor=8,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));