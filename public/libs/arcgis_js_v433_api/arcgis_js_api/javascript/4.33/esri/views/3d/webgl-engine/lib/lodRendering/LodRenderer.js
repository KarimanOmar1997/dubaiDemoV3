// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/arrayUtils","../../../../../core/Error","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../support/debugFlags","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","../../../webgl/RenderCamera","../../core/shaderLibrary/ShaderOutput","../../effects/RenderPlugin","../DefaultVertexAttributeLocations","../DepthRange","../IntersectorType","../Octree","../RenderSlot","../Util","../VertexAttribute","./InstanceData","./InstanceOctree","./LevelSelector","./LodLevel","./RenderInstanceData","../../materials/internal/MaterialUtil","../../materials/renderers/utils","../../shaders/DefaultMaterialTechnique","../../../../support/HighlightDefaults","../../../../support/Scheduler","../../../../webgl/Util"],(function(e,t,a,r,n,s,i,l,o,c,d,h,u,_,g,p,f,m,y,I,R,v,b,C,D,E,S,A,L,T,O,x,M,F,N,V,w,H,U){"use strict";function B(e,t,a){const r=e.allocateHead();var n,s,i,l;n=t,s=a,i=e.view,l=r,N.encodeDoubleVec3(n.modelOrigin,s,i.modelOriginHi,i.modelOriginLo,l),i.model.copyFrom(l,n.model,s),i.modelNormal.copyFrom(l,n.modelNormal,s),n.color&&i.color&&i.color.copyFrom(l,n.color,s),n.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(l,n.objectAndLayerIdColor,s),n.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(l,n.featureAttribute,s)}e.LodRenderer=class extends R.AsyncRenderPlugin{constructor(e,t){super(e),this.type=C.IntersectorType.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new y,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[E.RenderSlot.OPAQUE_MATERIAL,e=>this._produces(e)],[E.RenderSlot.TRANSPARENT_MATERIAL,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new L.InstanceData({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(H.TaskPriority.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function(e){let t=m.newLayout().vec3f(A.VertexAttribute.INSTANCEMODELORIGINHI).vec3f(A.VertexAttribute.INSTANCEMODELORIGINLO).mat3f(A.VertexAttribute.INSTANCEMODEL).mat3f(A.VertexAttribute.INSTANCEMODELNORMAL);return null!=e&&e.includes("featureAttribute")&&(t=t.vec4f(A.VertexAttribute.INSTANCEFEATUREATTRIBUTE)),null!=e&&e.includes("color")&&(t=t.vec4u8(A.VertexAttribute.INSTANCECOLOR)),null!=e&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(A.VertexAttribute.INSTANCEOBJECTANDLAYERIDCOLOR)),t}(this.optionalFields),this._glInstanceBufferLayout=f.glLayout(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)})),this._instanceData.events.on("instance-visibility-changed",(({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDataMap.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)t[0]!==w.defaultHighlightName&&e.push(t[1]);return e}hasHighlight(e){return this._highlightRenderInstanceDataMap.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some((e=>e.components.some((e=>e.material.hasEmissions))))}get usedMemory(){return this._allRenderInstanceData.reduce(((e,t)=>t.reduce(((e,t)=>e+t.usedMemory),e)),this._levels.reduce(((e,t)=>e+t.components.reduce(((e,t)=>e+t.usedMemory),0)),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,a)=>{const r=this._allRenderInstanceData[0][a].size+this._allRenderInstanceData[1][a].size,n=e.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*n,trianglesPerInstance:n})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}_createRenderInstanceDataArray(e=[]){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map((a=>{e.push(new M.RenderInstanceData(t,this._instanceBufferLayout))})),e}async initializeRenderContext(e,t){this._context=e,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const r=await Promise.allSettled(this.symbol.levels.map((a=>x.LodLevel.create(e,a,t)))),n=r.map((e=>"fulfilled"===e.status?e.value:null)).filter(a.isSome);if(i.isAborted(t)||n.length!==r.length){n.forEach((e=>e.destroy())),i.throwIfAborted(t);for(const e of r)if("rejected"===e.status)throw e.reason}this._levels=n,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,a=e.levels.map((e=>e.minScreenSpaceRadius));return new O.LevelSelector(t,a)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceDataMap.forEach((e=>e.forEach((e=>e.destroy()))))}_hasTransparentLevels(){return this._levels.some((e=>e.components.some((e=>{const t=e.material.produces.get(E.RenderSlot.TRANSPARENT_MATERIAL);return t?.(I.ShaderOutput.Color)}))))}hasHighlights(){return n.someMap(this._highlightRenderInstanceDataMap,(e=>e.some((e=>e.size>0))))}_produces(e){return(e!==I.ShaderOutput.Highlight||this.hasHighlights())&&(e!==I.ShaderOutput.ShadowHighlight||this.hasHighlight(w.defaultHighlightName))}prepareRender(e){if(!p.debugFlags.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(H.noBudget),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const a=new Array,r=this.levels;return t.forEach((t=>r.forEach((({components:r},n)=>r.forEach((r=>a.push(this._beginComponent(e,t[n],r)))))))),a}render(e,t){const a=this._getInstanceDatas(e);if(!a||null==t)return;let r=0;e.rctx.bindVAO();const n=this.levels;a.forEach((a=>n.forEach((({components:n},s)=>n.forEach((n=>this._renderComponent(e,t[r++],a[s],n,s)))))))}_getInstanceDatas(e){const{output:t,bind:a}=e,r=t===I.ShaderOutput.Highlight,n=t===I.ShaderOutput.ShadowHighlight,s=!r&&!n,i=t!==I.ShaderOutput.ShadowExcludeHighlight;if(s)return i?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDataMap:l}=this;if(i){if(r){const e=a.highlight?.name;if(!e)return null;const t=l.get(e);return t?[t]:null}const e=l.get(w.defaultHighlightName);return n?e?[e]:null:Array.from(l.values())}return null}intersect(e,t,a,r){if(!this.baseMaterial.visible||null==this._octree)return;const n=_.create();u.subtract(n,r,a);const s=n=>{this._instanceData.getCombinedModelTransform(n,G),e.transform.set(G),u.transformMat4(z,a,e.transform.inverse),u.transformMat4(j,r,e.transform.inverse);const s=this._instanceData.getState(n),i=this._instanceData.getLodLevel(n),l=this._levels.length;S.assert(0!==(s&L.StateFlags.ACTIVE),"invalid instance state"),S.assert(i>=0&&i<l,"invaid lod level"),this._levels[i].intersect(e,t,z,j,n,this.metadata,l)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(s):this._octree.forEachAlongRay(a,n,s)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new T.InstanceOctree(e,this.baseBoundingSphere);for(let a=0;a<e.capacity;++a)t.get(a)&L.StateFlags.ACTIVE&&this._octreeCached.addInstance(a)}return this._octreeCached}_invalidateOctree(){this._octreeCached=s.destroyMaybe(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return new b.DepthRange;const t=e.viewForward,a=this._octree.findClosest(t,D.DepthOrder.FRONT_TO_BACK,e.frustum),r=this._octree.findClosest(t,D.DepthOrder.BACK_TO_FRONT,e.frustum);if(null==a||null==r)return new b.DepthRange;const n=e.eye,s=this._instanceData.view;s.boundingSphere.getVec(a,q),u.subtract(q,q,n);const i=u.dot(q,t)-q[3];s.boundingSphere.getVec(r,q),u.subtract(q,q,n);const l=u.dot(q,t)+q[3];return new b.DepthRange(i,l)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:a,_levelSelector:s}=this;this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.beginUpdate()))));const i=this._instanceData,l=i.view;let o=i.size;const c=i.capacity;let d=this._instanceIndex;const h=Math.ceil(c/500),{_highlightRenderInstanceDataMap:u}=this;for(let _=0;_<o&&!e.done;++_){d===this._cycleStartIndex&&this._startUpdateCycle();const _=l.state.get(d);let g=0;if(!(_&L.StateFlags.ALLOCATED)){d=d+1===c?0:d+1,o++;continue}const p=l.lodLevel.get(d);if(_&L.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[p].freeTail(),_&L.StateFlags.HIGHLIGHT_ACTIVE){const e=i.geHighlightOptionsPrev(d);if(e){const t=u.get(e);if(!t)throw new r("internal:lod-renderer","Internal error in lodRenderer");t[p].freeTail(),t.every((e=>e.isEmpty))&&(t.forEach((e=>e.destroy())),u.delete(e))}}if(_&L.StateFlags.REMOVE)i.freeInstance(d);else if(_&L.StateFlags.VISIBLE){let e=0;if(t&&(l.modelOrigin.getVec(d,P),e=s.selectLevel(P,i.getCombinedMedianScaleFactor(d),a)),g=_&~(L.StateFlags.ACTIVE|L.StateFlags.TRANSFORM_CHANGED),e>=0)if(_&L.StateFlags.HIGHLIGHT){const t=i.getHighlightName(d);if(t){const a=()=>{const e=this._createRenderInstanceDataArray();return e.forEach((e=>e.beginUpdate())),e},s=n.getOrCreateMapValue(u,t,a);if(e>=s.length)throw new r("internal:lod-renderer",`LodRenderer internal error - missing lodLevel ${e}`);B(s[e],l,d)}g|=L.StateFlags.HIGHLIGHT_ACTIVE}else B(this._defaultRenderInstanceData[e],l,d),g|=L.StateFlags.DEFAULT_ACTIVE;l.state.set(d,g),l.lodLevel.set(d,e)}else g=_&~(L.StateFlags.ACTIVE|L.StateFlags.TRANSFORM_CHANGED),l.state.set(d,g);if(null!=this._octreeCached){const e=!!(_&L.StateFlags.ACTIVE),t=!!(g&L.StateFlags.ACTIVE);!e&&t?this._octreeCached.addInstance(d):e&&!t?this._octreeCached.removeInstance(d):e&&t&&_&L.StateFlags.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(d),this._octreeCached.addInstance(d))}d=d+1===c?0:d+1,d%h===0&&e.madeProgress()}this._instanceIndex=d,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.endUpdate())))),this._context.requestRender()}_beginComponent(e,t,a){if(0===t.size)return null;const r=a.glMaterials.load(e.rctx,e.bind.slot,e.output);return r?.beginSlot(e.bind)}_renderComponent(e,t,a,r,n){if(!t)return;const{bind:s,rctx:i}=e;i.runAppleAmdDriverHelper();const l=i.bindTechnique(t,s,r.material.parameters,W);i.bindVAO(r.vao),t.ensureAttributeLocations(r.vao),p.debugFlags.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===I.ShaderOutput.Color&&(l.setUniform4fv("externalColor",k[Math.min(n,k.length-1)]),l.setUniform1i("colorMixMode",F.colorMixModes.replace));const o=a.capacity,c=a.headIndex,d=a.tailIndex,h=a.firstIndex,u=this._glInstanceBufferLayout,_=(e,n)=>{U.bindVertexBufferLayout(i,v.Default3D,a.buffer,u,e),i.drawArraysInstanced(t.primitiveType,0,r.vertexCount,n-e),U.unbindVertexBufferLayout(i,v.Default3D,a.buffer,u)};r.material.transparent&&null!=h?c>d?(S.assert(h>=d&&h<=c,"invalid firstIndex"),_(h,c),_(d,h)):c<d&&(h<=c?(S.assert(h>=0&&h<=c,"invalid firstIndex"),_(h,c),_(d,o),_(0,h)):(S.assert(h>=d&&h<=o,"invalid firstIndex"),_(h,o),_(0,c),_(d,h))):c>d?_(d,c):c<d&&(_(0,c),_(d,o)),i.bindVAO(null)}},t.__decorate([l.property({constructOnly:!0})],e.LodRenderer.prototype,"symbol",void 0),t.__decorate([l.property({constructOnly:!0})],e.LodRenderer.prototype,"optionalFields",void 0),t.__decorate([l.property({constructOnly:!0})],e.LodRenderer.prototype,"metadata",void 0),t.__decorate([l.property({constructOnly:!0})],e.LodRenderer.prototype,"shaderTransformation",void 0),t.__decorate([l.property()],e.LodRenderer.prototype,"_instanceData",void 0),t.__decorate([l.property()],e.LodRenderer.prototype,"_cycleStartIndex",void 0),t.__decorate([l.property({readOnly:!0})],e.LodRenderer.prototype,"_enableLevelSelection",null),t.__decorate([l.property()],e.LodRenderer.prototype,"_updateCyclesWithStaticCamera",void 0),t.__decorate([l.property({readOnly:!0})],e.LodRenderer.prototype,"running",null),e.LodRenderer=t.__decorate([d.subclass("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],e.LodRenderer);const P=_.create(),q=g.create(),G=h.create(),z=_.create(),j=_.create(),k=[g.fromValues(1,0,1,1),g.fromValues(0,0,1,1),g.fromValues(0,1,0,1),g.fromValues(1,1,0,1),g.fromValues(1,0,0,1)],W=new V.DefaultMaterialDrawParameters;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));