// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/sphere","../../../ViewingMode","../../support/orientedBoundingBox"],(function(t,e,s,r,n,a,i,o,h,f){"use strict";class l{constructor(t,e,s){this._original=t,this._update=e,this._dirty=!0,this._transform=s()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}}class c{constructor(t=0){this.offset=t,this.tmpVertex=i.create()}applyToVertex(t,e,s){const r=a.set(d,t,e,s),n=a.add(M,r,this.localOrigin),i=this.offset/a.length(n);return a.scaleAndAdd(this.tmpVertex,r,n,i),this.tmpVertex}applyToAabb(t){const e=b,s=O,r=v;for(let n=0;n<3;++n)e[n]=t[0+n]+this.localOrigin[n],s[n]=t[3+n]+this.localOrigin[n],r[n]=e[n];const n=this.applyToVertex(e[0],e[1],e[2]);for(let e=0;e<3;++e)t[e]=n[e],t[e+3]=n[e];const a=e=>{const s=this.applyToVertex(e[0],e[1],e[2]);for(let e=0;e<3;++e)t[e]=Math.min(t[e],s[e]),t[e+3]=Math.max(t[e+3],s[e])};for(let t=1;t<8;++t){for(let n=0;n<3;++n)r[n]=t&1<<n?s[n]:e[n];a(r)}let i=0;for(let t=0;t<3;++t)e[t]*s[t]<0&&(i|=1<<t);if(0!==i&&7!==i)for(let t=0;t<8;++t)if(0===(i&t)){for(let n=0;n<3;++n)r[n]=i&1<<n?0:t&1<<n?e[n]:s[n];a(r)}for(let e=0;e<3;++e)t[e]-=this.localOrigin[e],t[e+3]-=this.localOrigin[e];return t}}class m{constructor(t=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=i.create(),this._tmpMbs=o.create(),this._tmpObb=new f.Obb,this._resetOffset(t)}_resetOffset(t){this._offset=t,this._totalOffset=t}set offset(t){this._resetOffset(t)}get offset(){return this._offset}set componentOffset(t){this._totalOffset=this._offset+t}set localOrigin(t){this.componentLocalOriginLength=a.length(t)}applyToVertex(t,e,s){const r=a.set(d,t,e,s),n=a.set(M,t,e,s+this.componentLocalOriginLength),i=this._totalOffset/a.length(n);return a.scaleAndAdd(this._tmpVertex,r,n,i),this._tmpVertex}applyToAabb(t){const e=this.componentLocalOriginLength,s=t[0],r=t[1],n=t[2]+e,a=t[3],i=t[4],o=t[5]+e,h=Math.abs(s),f=Math.abs(r),l=Math.abs(n),c=Math.abs(a),m=Math.abs(i),p=Math.abs(o),g=.5*(1+Math.sign(s*a))*Math.min(h,c),_=.5*(1+Math.sign(r*i))*Math.min(f,m),u=.5*(1+Math.sign(n*o))*Math.min(l,p),d=Math.max(h,c),M=Math.max(f,m),b=Math.max(l,p),O=Math.sqrt(g*g+_*_+u*u),v=Math.sign(h+s),T=Math.sign(f+r),x=Math.sign(l+n),y=Math.sign(c+a),V=Math.sign(m+i),A=Math.sign(p+o),I=this._totalOffset;if(O<I)return t[0]-=(1-v)*I,t[1]-=(1-T)*I,t[2]-=(1-x)*I,t[3]+=y*I,t[4]+=V*I,t[5]+=A*I,t;const w=I/Math.sqrt(d*d+M*M+b*b),L=I/O,C=L-w,j=-C;return t[0]+=s*(v*j+L),t[1]+=r*(T*j+L),t[2]+=n*(x*j+L),t[3]+=a*(y*C+w),t[4]+=i*(V*C+w),t[5]+=o*(A*C+w),t}applyToMbs(t){const e=a.length(o.getCenter(t)),s=this._totalOffset/e;return a.scaleAndAdd(o.getCenter(this._tmpMbs),o.getCenter(t),o.getCenter(t),s),this._tmpMbs[3]=t[3]+t[3]*this._totalOffset/e,this._tmpMbs}applyToObb(t){return f.computeOffsetObb(t,this._totalOffset,this._totalOffset,h.ViewingMode.Global,this._tmpObb),this._tmpObb}}class p{constructor(t=0){this.offset=t,this.sphere=o.create(),this.tmpVertex=i.create()}applyToVertex(t,e,s){const r=this.objectTransform.transform,n=a.set(d,t,e,s),i=a.transformMat4(n,n,r),o=this.offset/a.length(i);a.scaleAndAdd(i,i,i,o);const h=this.objectTransform.inverse;return a.transformMat4(this.tmpVertex,i,h),this.tmpVertex}applyToMinMax(t,e){const s=this.offset/a.length(t);a.scaleAndAdd(t,t,t,s);const r=this.offset/a.length(e);a.scaleAndAdd(e,e,e,r)}applyToAabb(t){const e=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*e,t[1]+=t[1]*e,t[2]+=t[2]*e;const s=this.offset/Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]);return t[3]+=t[3]*s,t[4]+=t[4]*s,t[5]+=t[5]*s,t}applyToBoundingSphere(t){const e=a.length(o.getCenter(t)),s=this.offset/e;return a.scaleAndAdd(o.getCenter(this.sphere),o.getCenter(t),o.getCenter(t),s),this.sphere[3]=t[3]+t[3]*this.offset/e,this.sphere}}const g=new p,_=new m,u=new c,d=i.create(),M=i.create(),b=i.create(),O=i.create(),v=i.create();t.I3SVerticalOffsetGlobalViewingMode=m,t.IntersectorTransform=class{constructor(){this._transform=n.create(),this._transformInverse=new l({value:this._transform},r.invert,n.create),this._transformInverseTranspose=new l(this._transformInverse,r.transpose,n.create),this._transformTranspose=new l({value:this._transform},r.transpose,n.create),this._transformInverseRotation=new l({value:this._transform},e.normalFromMat4Legacy,s.create)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(t){r.copy(this._transform,t)}multiplyTransform(t){r.multiply(this._transform,this._transform,t)}set(t){r.copy(this._transform,t),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(t,e){this.setTransformMatrix(t),this.multiplyTransform(e),this._invalidateLazyTransforms()}},t.Object3DVerticalOffsetGlobalViewingMode=p,t.TerrainVerticalOffsetGlobalViewingMode=c,t.getVerticalOffsetI3S=function(t){return null!=t?(_.offset=t,_):null},t.getVerticalOffsetObject3D=function(t){return null!=t?(g.offset=t,g):null},t.getVerticalOffsetTerrain=function(t){return null!=t?(u.offset=t,u):null},t.terrainId="terrain",Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));