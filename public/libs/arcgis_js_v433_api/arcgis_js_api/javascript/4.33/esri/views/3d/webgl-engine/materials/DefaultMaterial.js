// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../symbols/support/materialUtils","../../../ViewingMode","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/attributes/NormalAttribute.glsl","../core/shaderLibrary/output/Emissions.glsl","../core/shaderLibrary/shading/Normals.glsl","../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../effects/geometry/olidUtils","../lib/basicInterfaces","../lib/GLTextureMaterial","../lib/Material","../lib/OrderIndependentTransparency","../lib/RayIntersections","../lib/RenderSlot","../lib/VertexAttribute","../lib/verticalOffsetUtils","./DefaultBufferWriter","./internal/MaterialUtil","../shaders/DefaultMaterialTechnique","../shaders/DefaultMaterialTechniqueConfiguration","../shaders/RealisticTreeTechnique","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,s,a,i,o,l,n,u,c,d,h,m,p,f,T,v,x,S,b,M,g,O,y,R){"use strict";class D extends p.Material{constructor(e,t){super(e,E),this.materialType="default",this.supportsEdges=!0,this.intersectDraped=void 0,this.produces=new Map([[v.RenderSlot.OPAQUE_MATERIAL,e=>(o.is3DGeometryOutputMRT(e)||o.isShadowRelatedOutput(e))&&!this.transparent],[v.RenderSlot.TRANSPARENT_MATERIAL,e=>(o.is3DGeometryOutputMRT(e)||o.isShadowRelatedOutput(e))&&this.transparent&&this.parameters.writeDepth],[v.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,e=>(o.is3DGeometryOutput(e)||o.isShadowRelatedOutput(e))&&this.transparent&&!this.parameters.writeDepth]]),this._vertexBufferLayout=function(e){const t=i.newLayout().vec3f(x.VertexAttribute.POSITION);return e.normalType===l.NormalType.Compressed?t.vec2i16(x.VertexAttribute.NORMALCOMPRESSED,{glNormalized:!0}):t.vec3f(x.VertexAttribute.NORMAL),e.hasVertexTangents&&t.vec4f(x.VertexAttribute.TANGENT),(e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId)&&t.vec2f16(x.VertexAttribute.UV0),e.hasVertexColors&&t.vec4u8(x.VertexAttribute.COLOR),e.hasSymbolColors&&t.vec4u8(x.VertexAttribute.SYMBOLCOLOR),d.olidEnabled()&&t.vec4u8(x.VertexAttribute.OLIDCOLOR),t}(this.parameters),this._configuration=new O.DefaultMaterialTechniqueConfiguration(t.spherical)}isVisibleForOutput(e){return e!==o.ShaderOutput.Shadow&&e!==o.ShaderOutput.ShadowExcludeHighlight&&e!==o.ShaderOutput.ShadowHighlight||this.parameters.castShadows}get visible(){const{layerOpacity:e,colorMixMode:t,opacity:r,externalColor:s}=this.parameters;return e*("replace"===t?1:r)*("ignore"===t?1:s[3])>=R.alphaCutoff}get _hasEmissiveBase(){return!!this.parameters.emissiveTextureId||!t.exactEquals(this.parameters.emissiveBaseColor,r.ZEROS)}get hasEmissions(){return this.parameters.emissiveStrength>0&&(this.parameters.emissiveSource===s.EmissiveSourceMode.Emissive&&this._hasEmissiveBase||this.parameters.emissiveSource===s.EmissiveSourceMode.Color)}getConfiguration(e,t){const{parameters:r,_configuration:a}=this,{treeRendering:i,doubleSided:d,doubleSidedType:m}=r;return super.getConfiguration(e,t,this._configuration),a.hasNormalTexture=!i&&!!r.normalTextureId,a.hasColorTexture=!!r.textureId,a.hasVertexTangents=!i&&r.hasVertexTangents,a.instanced=r.isInstanced,a.instancedDoublePrecision=r.instancedDoublePrecision,a.vvSize=!!r.vvSize,a.hasVerticalOffset=null!=r.verticalOffset,a.hasScreenSizePerspective=null!=r.screenSizePerspective,a.hasSlicePlane=r.hasSlicePlane,a.alphaDiscardMode=r.textureAlphaMode,a.normalType=i?l.NormalType.Attribute:r.normalType,a.transparent=this.transparent,a.writeDepth=r.writeDepth,a.customDepthTest=r.customDepthTest??h.DepthTestFunction.Less,a.hasOccludees=t.hasOccludees,a.cullFace=r.hasSlicePlane?h.CullFaceOptions.None:r.cullFace,a.cullAboveTerrain=t.cullAboveTerrain,a.hasModelTransformation=!i&&null!=r.modelTransformation,a.hasVertexColors=r.hasVertexColors,a.hasSymbolColors=r.hasSymbolColors,a.doubleSidedMode=i?u.NormalsDoubleSidedMode.WindingOrder:d&&"normal"===m?u.NormalsDoubleSidedMode.View:d&&"winding-order"===m?u.NormalsDoubleSidedMode.WindingOrder:u.NormalsDoubleSidedMode.None,a.instancedColor=r.hasInstancedColor,o.isColorOrColorEmission(e)?(a.terrainDepthTest=t.terrainDepthTest,a.receiveShadows=r.receiveShadows,a.receiveAmbientOcclusion=r.receiveAmbientOcclusion&&null!=t.ssao):(a.terrainDepthTest=!1,a.receiveShadows=a.receiveAmbientOcclusion=!1),a.vvColor=!!r.vvColor,a.textureAlphaPremultiplied=!!r.textureAlphaPremultiplied,a.pbrMode=r.usePBR?r.isSchematic?c.PBRMode.Schematic:c.PBRMode.Normal:c.PBRMode.Disabled,a.hasMetallicRoughnessTexture=!i&&!!r.metallicRoughnessTextureId,a.emissionSource=i?n.EmissionSource.None:null!=r.emissiveTextureId&&r.emissiveSource===s.EmissiveSourceMode.Emissive?n.EmissionSource.Texture:r.usePBR?r.emissiveSource===s.EmissiveSourceMode.Emissive?n.EmissionSource.EmissiveColor:n.EmissionSource.SymbolColor:n.EmissionSource.None,a.hasOcclusionTexture=!i&&!!r.occlusionTextureId,a.offsetBackfaces=!(!this.transparent||!r.offsetTransparentBackfaces),a.oitPass=t.oitPass,a.enableOffset=t.camera.relativeElevation<f.OITPolygonOffsetLimit,a.snowCover=t.snowCover,a.hasBloom=o.isColorEmission(e),a.hasColorTextureTransform=!!r.colorTextureTransformMatrix,a.hasNormalTextureTransform=!!r.normalTextureTransformMatrix,a.hasEmissionTextureTransform=!!r.emissiveTextureTransformMatrix,a.hasOcclusionTextureTransform=!!r.occlusionTextureTransformMatrix,a.hasMetallicRoughnessTextureTransform=!!r.metallicRoughnessTextureTransformMatrix,a}intersect(e,r,s,i,o,l){if(null!=this.parameters.verticalOffset){const e=s.camera;t.set(V,r[12],r[13],r[14]);let l=null;switch(s.viewingMode){case a.ViewingMode.Global:l=t.normalize(L,V);break;case a.ViewingMode.Local:l=t.copy(L,I)}let n=0;const u=t.subtract(B,V,e.eye),c=t.length(u),d=t.scale(u,u,1/c);let h=null;this.parameters.screenSizePerspective&&(h=t.dot(l,d)),n+=M.verticalOffsetAtDistance(e,c,this.parameters.verticalOffset,h??0,this.parameters.screenSizePerspective),t.scale(l,l,n),t.transformMat3(N,l,s.transform.inverseRotation),i=t.subtract(P,i,N),o=t.subtract(w,o,N)}T.intersectTriangleGeometry(e,s,i,o,S.getVerticalOffsetObject3D(s.verticalOffset),l)}createGLMaterial(e){return new A(e)}createBufferWriter(){return new b.DefaultBufferWriter(this._vertexBufferLayout)}get transparent(){return C(this.parameters)}}class A extends m.GLTextureMaterial{constructor(e){super({...e,...e.material.parameters})}beginSlot(e){this._material.setParameters({receiveShadows:e.shadowMap.enabled});const r=this._material.parameters;this.updateTexture(r.textureId);const s=e.camera.viewInverseTransposeMatrix;return t.set(r.origin,s[3],s[7],s[11]),this._material.setParameters(this.textureBindParameters),this.getTechnique(r.treeRendering?y.RealisticTreeTechnique:g.DefaultMaterialTechnique,e)}}class E extends g.DefaultMaterialPassParameters{constructor(){super(...arguments),this.treeRendering=!1,this.hasVertexTangents=!1}}function C(e){const{drivenOpacity:t,opacity:r,externalColor:[s,a,i,o],layerOpacity:l,texture:n,textureId:u,textureAlphaMode:c,colorMixMode:d}=e;return t||r<1&&"replace"!==d||o<1&&"ignore"!==d||l<1||(null!=n||null!=u)&&c!==h.AlphaDiscardMode.Opaque&&c!==h.AlphaDiscardMode.Mask&&"replace"!==d}const P=r.create(),w=r.create(),I=r.fromValues(0,0,1),L=r.create(),N=r.create(),V=r.create(),B=r.create();e.DefaultGLMaterial=A,e.DefaultMaterial=D,e.DefaultMaterialParameters=E,e.isTransparent=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));