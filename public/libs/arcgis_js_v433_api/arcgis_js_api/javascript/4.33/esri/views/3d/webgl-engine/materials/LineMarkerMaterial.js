// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/float16","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/VertexAttribute","./VisualVariablePassParameters","./internal/bufferWriterUtils","../shaders/LineMarkerTechnique","../shaders/LineMarkerTechniqueConfiguration","../shaders/RibbonLineTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,a,s,n,o,h,c,l,u,p,d,T,A){"use strict";class m extends o.Material{constructor(e){super(e,S),this._configuration=new d.LineMarkerTechniqueConfiguration,this.vertexAttributeLocations=p.vertexAttributeLocations,this.produces=new Map([[h.RenderSlot.OPAQUE_MATERIAL,e=>e===s.ShaderOutput.Highlight||s.isColor(e)&&this.parameters.renderOccluded===o.RenderOccludedFlag.OccludeAndTransparentStencil],[h.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS,e=>s.isDepth(e)],[h.RenderSlot.OCCLUDER_MATERIAL,e=>s.isColorHighlightOrDepth(e)&&this.parameters.renderOccluded===o.RenderOccludedFlag.OccludeAndTransparentStencil],[h.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,e=>s.isColorHighlightOrDepth(e)&&this.parameters.renderOccluded===o.RenderOccludedFlag.OccludeAndTransparentStencil],[h.RenderSlot.TRANSPARENT_MATERIAL,e=>s.isColor(e)&&this.parameters.writeDepth],[h.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,e=>s.isColor(e)&&!this.parameters.writeDepth],[h.RenderSlot.DRAPED_MATERIAL,e=>s.isColorOrColorEmission(e)||e===s.ShaderOutput.Highlight]]),this.intersectDraped=void 0,this._layout=this.createLayout()}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.space=t.slot===h.RenderSlot.DRAPED_MATERIAL?d.LineMarkerSpace.Draped:this.parameters.worldSpace?d.LineMarkerSpace.World:d.LineMarkerSpace.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==T.CapType.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=t.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===o.RenderOccludedFlag.OccludeAndTransparentStencil,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest&&s.isColorOrColorEmission(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}get visible(){return this.parameters.color[3]>=A.alphaCutoff}intersect(){}createLayout(){const e=a.newLayout().vec3f(c.VertexAttribute.POSITION).vec4f16(c.VertexAttribute.PREVIOUSDELTA).vec2f16(c.VertexAttribute.UV0);return this.parameters.vvColor?e.f32(c.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4u8(c.VertexAttribute.COLOR,{glNormalized:!0}),this.parameters.vvOpacity&&e.f32(c.VertexAttribute.OPACITYFEATUREATTRIBUTE),this.parameters.vvSize?e.f32(c.VertexAttribute.SIZEFEATUREATTRIBUTE):e.f16(c.VertexAttribute.SIZE),this.parameters.worldSpace&&e.vec3f16(c.VertexAttribute.NORMAL),e}createBufferWriter(){return new f(this._layout,this.parameters)}createGLMaterial(e){return new E(e)}}class E extends n{dispose(){super.dispose(),this._markerTextures.release(this._markerPrimitive),this._markerPrimitive=null}beginSlot(e){const t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextures.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this.getTechnique(p.LineMarkerTechnique,e)}}class S extends l.VisualVariablePassParameters{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=T.CapType.BUTT,this.anchor=d.LineMarkerAnchor.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.markerTexture=null}}class f{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(e,r,a,s,n,o){const h=a.get(c.VertexAttribute.POSITION).data,l=h.length/3;let p=[1,0,0];const d=a.get(c.VertexAttribute.NORMAL);this._parameters.worldSpace&&null!=d&&(p=d.data);let T=1,A=0;this._parameters.vvSize?A=a.get(c.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:a.has(c.VertexAttribute.SIZE)&&(T=a.get(c.VertexAttribute.SIZE).data[0]);let m=[1,1,1,1],E=0;this._parameters.vvColor?E=a.get(c.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:a.has(c.VertexAttribute.COLOR)&&(m=a.get(c.VertexAttribute.COLOR).data);let S=0;this._parameters.vvOpacity&&(S=a.get(c.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);const f=new Float32Array(n.buffer),v=i.makeFloat16Array(n.buffer),O=new Uint8Array(n.buffer);let R=o*(this.vertexBufferLayout.stride/4);const b=f.BYTES_PER_ELEMENT/v.BYTES_PER_ELEMENT,C=4/b,L=(e,t,r,i)=>{f[R++]=e[0],f[R++]=e[1],f[R++]=e[2],u.writeDeltaF16Vector(t,e,v,R*b),R+=C;let a=R*b;if(v[a++]=r[0],v[a++]=r[1],R=Math.ceil(a/b),this._parameters.vvColor)f[R++]=E;else{const e=Math.min(4*i,m.length-4),t=4*R++;O[t]=255*m[e],O[t+1]=255*m[e+1],O[t+2]=255*m[e+2],O[t+3]=255*m[e+3]}this._parameters.vvOpacity&&(f[R++]=S),a=R*b,this._parameters.vvSize?(f[R++]=A,a+=2):v[a++]=T,this._parameters.worldSpace&&(v[a++]=p[0],v[a++]=p[1],v[a++]=p[2]),R=Math.ceil(a/b)};let I;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(I||(I={}));const M=(r,i)=>{const a=t.set(g,h[3*r],h[3*r+1],h[3*r+2]),s=_;let n=r+i;do{t.set(s,h[3*n],h[3*n+1],h[3*n+2]),n+=i}while(t.equals(a,s)&&n>=0&&n<l);e&&(t.transformMat4(a,a,e),t.transformMat4(s,s,e)),L(a,s,[-1,-1],r),L(a,s,[1,-1],r),L(a,s,[1,1],r),L(a,s,[-1,-1],r),L(a,s,[1,1],r),L(a,s,[-1,1],r)},P=this._parameters.placement;return"begin"!==P&&"begin-end"!==P||M(0,I.ASCENDING),"end"!==P&&"begin-end"!==P||M(l-1,I.DESCENDING),null}}const g=r.create(),_=r.create();e.LineMarkerMaterial=m,e.Parameters=S,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));