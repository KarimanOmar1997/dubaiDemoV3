// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/output/Emissions.glsl","../core/shaderLibrary/shading/Normals.glsl","../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../effects/geometry/olidUtils","../lib/GLMaterial","../lib/Material","../lib/PathGeometry","../lib/RayIntersections","../lib/RenderSlot","../lib/VertexAttribute","./DefaultBufferWriter","./PathTechnique","./PathTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],(function(e,t,i,r,s,a,o,n,u,h,c,l,d,p,b,f,m,g,S,v,A){"use strict";class O extends d.Material{constructor(e,t){super(e,R),this.vertexAttributeLocations=S.vertexAttributeLocations,this.supportsEdges=!0,this._pp0=r.fromValues(0,0,1),this._pp1=r.fromValues(0,0,0),this.produces=new Map([[f.RenderSlot.OPAQUE_MATERIAL,e=>(this.parameters.castShadows&&o.isShadowRelatedOutput(e)||o.is3DGeometryOutputMRT(e))&&!this.transparent],[f.RenderSlot.TRANSPARENT_MATERIAL,e=>(this.parameters.castShadows&&o.isShadowRelatedOutput(e)||o.is3DGeometryOutputMRT(e))&&this.transparent]]),this._configuration=new v.PathTechniqueConfiguration(t.spherical)}get hasEmissions(){return this.parameters.emissiveStrength>0}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.transparent,this._configuration.hasOccludees=t.hasOccludees,o.isColorOrColorEmission(e)?(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?u.NormalsDoubleSidedMode.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?u.NormalsDoubleSidedMode.WindingOrder:u.NormalsDoubleSidedMode.None,this._configuration.receiveShadows=t.shadowMap.enabled,this._configuration.receiveAmbientOcclusion=null!=t.ssao):this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.pbrMode=this.parameters.usePBR?h.PBRMode.Schematic:h.PBRMode.Disabled,this._configuration.emissionSource=this.parameters.usePBR?n.EmissionSource.SymbolColor:n.EmissionSource.None,this._configuration.hasBloom=o.isColorEmission(e),this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.snowCover=t.snowCover,this._configuration}isVisibleForOutput(e){return e!==o.ShaderOutput.Shadow&&e!==o.ShaderOutput.ShadowExcludeHighlight&&e!==o.ShaderOutput.ShadowHighlight||this.parameters.castShadows}get visible(){return this.parameters.opacity>=A.alphaCutoff}intersect(e,t,i,r,s,a){this._intersect(e,i,r,s,a)}intersectDraped(e,t,i,r){return this._pp0[0]=this._pp1[0]=i[0],this._pp0[1]=this._pp1[1]=i[1],this._intersect(e,t,this._pp0,this._pp1,r)}_intersect(e,r,a,o,n){const u=e;if(!p.isPathGeometry(u))return;const h=u.path,c=i.clone(this.parameters.size);if(this.parameters.vvSize){const{offset:e,factor:i,minSize:r,maxSize:s,fallback:a}=this.parameters.vvSize,o=h.sizeAttributeValue;Number.isNaN(o)?(c[0]*=a[0],c[1]*=a[2]):(c[0]*=t.clamp(e[0]+o*i[0],r[0],s[0]),c[1]*=t.clamp(e[2]+o*i[2],r[2],s[2]))}const l=new b.MeshIntersectionOptions(!1,r.options.normalRequired),d=Math.max(c[0],c[1]),f=e.boundingInfo;if(null==f)return void _(h,c,a,o,l,n);const m=s.fromValues(f.bbMin[0]-d,f.bbMin[1]-d,f.bbMin[2]-d,f.bbMax[0]+d,f.bbMax[1]+d,f.bbMax[2]+d),g=[o[0]-a[0],o[1]-a[1],o[2]-a[2]],S=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),v=[S/g[0],S/g[1],S/g[2]];b.intersectAabbInvDir(m,a,v,r.tolerance)&&_(h,c,a,o,l,n)}createBufferWriter(){return new g.DefaultBufferWriter(this._layout)}get _layout(){const e=a.newLayout().vec3f(m.VertexAttribute.POSITION).vec4f16(m.VertexAttribute.PROFILEVERTEXANDNORMAL).vec2i16(m.VertexAttribute.PROFILERIGHT,{glNormalized:!0}).vec2i16(m.VertexAttribute.PROFILEUP,{glNormalized:!0});return this.parameters.vvSize&&e.f32(m.VertexAttribute.SIZEFEATUREATTRIBUTE),this.parameters.vvColor&&e.f32(m.VertexAttribute.COLORFEATUREATTRIBUTE),this.parameters.vvOpacity&&e.f32(m.VertexAttribute.OPACITYFEATUREATTRIBUTE),c.olidEnabled()&&e.vec4u8(m.VertexAttribute.OLIDCOLOR),e.vec3f16(m.VertexAttribute.PROFILEAUXDATA),e}createGLMaterial(e){return new T(e)}get transparent(){const{parameters:e}=this;return e.drivenOpacity||e.opacity<1}}class T extends l{beginSlot(e){return this.getTechnique(S.PathTechnique,e)}}function _(e,t,i,r,s,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,r,s,a)}class R extends S.PathPassParameters{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.castShadows=!0,this.hasSlicePlane=!1,this.drivenOpacity=!1,this.usePBR=!1}}e.Parameters=R,e.PathMaterial=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));