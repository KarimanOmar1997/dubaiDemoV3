// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/buffer/BufferView","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../effects/geometry/olidUtils","../lib/basicInterfaces","../lib/GLMaterial","../lib/OrderIndependentTransparency","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./DefaultBufferWriter","./PatternStyle","./TriangleMaterial","./VisualVariablePassParameters","./internal/bufferWriterUtils","../shaders/PatternTechnique","../shaders/PatternTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,a,o,n,l,u,f,c,h,d,p,g,b,A,O,T){"use strict";class C extends p.TriangleMaterial{constructor(e){super(e,V),this._configuration=new O.PatternTechniqueConfiguration,this.vertexAttributeLocations=a.olidEnabled()?A.vertexAttributeLocationsOID:A.vertexAttributeLocations,this.supportsEdges=!0,this.produces=new Map([[u.RenderSlot.OPAQUE_MATERIAL,e=>s.isHighlightOrOID(e)],[u.RenderSlot.TRANSPARENT_MATERIAL,e=>s.isColorOrColorEmission(e)],[u.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,e=>s.isDepth(e)],[u.RenderSlot.DRAPED_MATERIAL,e=>this.parameters.draped&&s.isColorEmissionHighlightOrOID(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<l.OITPolygonOffsetLimit,this._configuration.terrainDepthTest=t.terrainDepthTest&&s.isColorOrColorEmission(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}get visible(){return this.parameters.color[3]>=T.alphaCutoff}createGLMaterial(e){return new P(e)}createBufferWriter(){const e=i.newLayout().vec3f(c.VertexAttribute.POSITION).vec4f(c.VertexAttribute.UVMAPSPACE);return this.parameters.draped||e.mat3f(c.VertexAttribute.BOUNDINGRECT),this.parameters.vvColor?e.f32(c.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4u8(c.VertexAttribute.COLOR),a.olidEnabled()&&e.vec4u8(c.VertexAttribute.OLIDCOLOR),new m(e)}}class P extends n{beginSlot(e){return this.getTechnique(A.PatternTechnique,e)}}class m extends h.DefaultBufferWriter{write(e,t,i,s,a,o){const n=b.writeDefaultAttributes(i,s,this.vertexBufferLayout,e,t,a,o);for(const t of this.vertexBufferLayout.fields.keys()){const s=i.get(t),n=s?.indices;if(s&&n)switch(t){case c.VertexAttribute.UVMAPSPACE:{f.assert(4===s.size);const e=a.getField(t,r.BufferViewVec4f);e&&b.writeBufferVec4(s,e,o);break}case c.VertexAttribute.BOUNDINGRECT:{f.assert(9===s.size);const i=a.getField(t,r.BufferViewMat3f);i&&v(s,e,i,o);break}}}return n}}function v(e,t,r,i){const{data:s,indices:a}=e,o=t,n=r.typedBuffer,l=r.typedBufferStride,u=a.length;i*=l;for(let e=0;e<u;++e){const t=9*a[e],r=s[t],u=s[t+1],f=s[t+2];n[i]=o[0]*r+o[4]*u+o[8]*f+o[12],n[i+1]=o[1]*r+o[5]*u+o[9]*f+o[13],n[i+2]=o[2]*r+o[6]*u+o[10]*f+o[14];for(let e=3;e<9;++e)n[i+e]=s[t+e];i+=l}}class V extends g.VisualVariablePassParameters{constructor(){super(...arguments),this.color=t.fromValues(1,1,1,1),this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=o.CullFaceOptions.None,this.hasOccludees=!1,this.style=d.Style.Cross,this.draped=!0}}e.Parameters=V,e.PatternMaterial=C,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));