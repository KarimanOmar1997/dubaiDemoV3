// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../geometry/support/buffer/BufferView","../../lib/Util","../../lib/VertexAttribute"],(function(e,t,r,f,i,s,o){"use strict";function n(e,t,r){const{data:f,indices:i}=e,s=t.typedBuffer,o=t.typedBufferStride,n=i.length;r*=o;for(let e=0;e<n;++e){const t=2*i[e];s[r]=f[t],s[r+1]=f[t+1],r+=o}}function c(e,t,r,f=1){const{data:i,indices:s}=e,o=t.typedBuffer,n=t.typedBufferStride,c=s.length;if(r*=n,1===f)for(let e=0;e<c;++e){const t=3*s[e];o[r]=i[t],o[r+1]=i[t+1],o[r+2]=i[t+2],r+=n}else for(let e=0;e<c;++e){const t=3*s[e];for(let e=0;e<f;++e)o[r]=i[t],o[r+1]=i[t+1],o[r+2]=i[t+2],r+=n}}function u(e,t,r,f=1){const{data:i,indices:s}=e,o=t.typedBuffer,n=t.typedBufferStride,c=s.length;if(r*=n,1===f)for(let e=0;e<c;++e){const t=4*s[e];o[r]=i[t],o[r+1]=i[t+1],o[r+2]=i[t+2],o[r+3]=i[t+3],r+=n}else for(let e=0;e<c;++e){const t=4*s[e];for(let e=0;e<f;++e)o[r]=i[t],o[r+1]=i[t+1],o[r+2]=i[t+2],o[r+3]=i[t+3],r+=n}}function l(e,t,r,i,s=1){if(!t)return void c(e,r,i,s);const{data:o,indices:n}=e,u=r.typedBuffer,l=r.typedBufferStride,a=n.length,d=t[0],V=t[1],B=t[2],b=t[4],w=t[5],g=t[6],A=t[8],y=t[9],p=t[10],O=t[12],h=t[13],F=t[14];i*=l;let I=0,x=0,T=0;const N=f.hasIdentityRotation(t)?e=>{I=o[e]+O,x=o[e+1]+h,T=o[e+2]+F}:e=>{const t=o[e],r=o[e+1],f=o[e+2];I=d*t+b*r+A*f+O,x=V*t+w*r+y*f+h,T=B*t+g*r+p*f+F};if(1===s)for(let e=0;e<a;++e)N(3*n[e]),u[i]=I,u[i+1]=x,u[i+2]=T,i+=l;else for(let e=0;e<a;++e){N(3*n[e]);for(let e=0;e<s;++e)u[i]=I,u[i+1]=x,u[i+2]=T,i+=l}}function a(e,t,r,i,s=1){if(!t)return void c(e,r,i,s);const{data:o,indices:n}=e,u=t,l=r.typedBuffer,a=r.typedBufferStride,d=n.length,V=u[0],B=u[1],b=u[2],w=u[4],g=u[5],A=u[6],y=u[8],p=u[9],O=u[10],h=!f.isOrthoNormal(u),F=1e-6,I=.999999;i*=a;let x=0,T=0,N=0;const R=f.hasIdentityRotation(u)?e=>{x=o[e],T=o[e+1],N=o[e+2]}:e=>{const t=o[e],r=o[e+1],f=o[e+2];x=V*t+w*r+y*f,T=B*t+g*r+p*f,N=b*t+A*r+O*f};if(1===s)if(h)for(let e=0;e<d;++e){R(3*n[e]);const t=x*x+T*T+N*N;if(t<I&&t>F){const e=1/Math.sqrt(t);l[i]=x*e,l[i+1]=T*e,l[i+2]=N*e}else l[i]=x,l[i+1]=T,l[i+2]=N;i+=a}else for(let e=0;e<d;++e)R(3*n[e]),l[i]=x,l[i+1]=T,l[i+2]=N,i+=a;else for(let e=0;e<d;++e){if(R(3*n[e]),h){const e=x*x+T*T+N*N;if(e<I&&e>F){const t=1/Math.sqrt(e);x*=t,T*=t,N*=t}}for(let e=0;e<s;++e)l[i]=x,l[i+1]=T,l[i+2]=N,i+=a}}function d(e,t,r,i,s=1){if(!t)return void u(e,r,i,s);const{data:o,indices:n}=e,c=t,l=r.typedBuffer,a=r.typedBufferStride,d=n.length,V=c[0],B=c[1],b=c[2],w=c[4],g=c[5],A=c[6],y=c[8],p=c[9],O=c[10],h=!f.isOrthoNormal(c),F=1e-6,I=.999999;if(i*=a,1===s)for(let e=0;e<d;++e){const t=4*n[e],r=o[t],f=o[t+1],s=o[t+2],c=o[t+3];let u=V*r+w*f+y*s,d=B*r+g*f+p*s,x=b*r+A*f+O*s;if(h){const e=u*u+d*d+x*x;if(e<I&&e>F){const t=1/Math.sqrt(e);u*=t,d*=t,x*=t}}l[i]=u,l[i+1]=d,l[i+2]=x,l[i+3]=c,i+=a}else for(let e=0;e<d;++e){const t=4*n[e],r=o[t],f=o[t+1],c=o[t+2],u=o[t+3];let d=V*r+w*f+y*c,x=B*r+g*f+p*c,T=b*r+A*f+O*c;if(h){const e=d*d+x*x+T*T;if(e<I&&e>F){const t=1/Math.sqrt(e);d*=t,x*=t,T*=t}}for(let e=0;e<s;++e)l[i]=d,l[i+1]=x,l[i+2]=T,l[i+3]=u,i+=a}}function V(e,t,r,f,i=1){const{data:s,indices:o}=e,n=r.typedBuffer,c=r.typedBufferStride,u=o.length;if(f*=c,t!==s.length||4!==t)if(1!==i)if(4!==t)for(let e=0;e<u;++e){const t=3*o[e];for(let e=0;e<i;++e)n[f]=s[t],n[f+1]=s[t+1],n[f+2]=s[t+2],n[f+3]=255,f+=c}else for(let e=0;e<u;++e){const t=4*o[e];for(let e=0;e<i;++e)n[f]=s[t],n[f+1]=s[t+1],n[f+2]=s[t+2],n[f+3]=s[t+3],f+=c}else{if(4===t){for(let e=0;e<u;++e){const t=4*o[e];n[f]=s[t],n[f+1]=s[t+1],n[f+2]=s[t+2],n[f+3]=s[t+3],f+=c}return}for(let e=0;e<u;++e){const t=3*o[e];n[f]=s[t],n[f+1]=s[t+1],n[f+2]=s[t+2],n[f+3]=255,f+=c}}else{n[f]=s[0],n[f+1]=s[1],n[f+2]=s[2],n[f+3]=s[3];const e=new Uint32Array(r.typedBuffer.buffer,r.start),t=c/4,o=e[f/=4];f+=t;const l=u*i;for(let r=1;r<l;++r)e[f]=o,f+=t}}function B(e,t,r){const{data:f,indices:i}=e,s=t.typedBuffer,o=t.typedBufferStride,n=i.length,c=f[0];r*=o;for(let e=0;e<n;++e)s[r]=c,r+=o}const b=r.create();function w(e,t,r,f,i=1){const s=t.typedBuffer,o=t.typedBufferStride;if(f*=o,1===i)for(let t=0;t<r;++t)s[f]=e[0],s[f+1]=e[1],s[f+2]=e[2],s[f+3]=e[3],f+=o;else for(let t=0;t<r;++t)for(let t=0;t<i;++t)s[f]=e[0],s[f+1]=e[1],s[f+2]=e[2],s[f+3]=e[3],f+=o}function g(e,t,r,f,b,w){switch(e){case o.VertexAttribute.POSITION:{s.assert(3===t.size);const f=b.getField(e,i.BufferViewVec3f);s.assert(!!f,`No buffer view for ${e}`),l(t,r,f,w);break}case o.VertexAttribute.NORMAL:{s.assert(3===t.size);const r=b.getField(e,i.BufferViewVec3f);s.assert(!!r,`No buffer view for ${e}`),a(t,f,r,w);break}case o.VertexAttribute.NORMALCOMPRESSED:case o.VertexAttribute.PROFILERIGHT:case o.VertexAttribute.PROFILEUP:{s.assert(2===t.size);const r=b.getField(e,i.BufferViewVec2i16);s.assert(!!r,`No buffer view for ${e}`),n(t,r,w);break}case o.VertexAttribute.UV0:{s.assert(2===t.size);const r=b.getField(e,i.BufferViewVec2f16)??b.getField(e,i.BufferViewVec2f);s.assert(!!r,`No buffer view for ${e}`),n(t,r,w);break}case o.VertexAttribute.UVI:{s.assert(2===t.size);const r=b.getField(e,i.BufferViewVec2i16);s.assert(!!r,`No buffer view for ${e}`),n(t,r,w);break}case o.VertexAttribute.COLOR:case o.VertexAttribute.SYMBOLCOLOR:{const r=b.getField(e,i.BufferViewVec4u8);s.assert(!!r,`No buffer view for ${e}`),s.assert(3===t.size||4===t.size),V(t,t.size,r,w);break}case o.VertexAttribute.COLORFEATUREATTRIBUTE:case o.VertexAttribute.OPACITYFEATUREATTRIBUTE:case o.VertexAttribute.SIZEFEATUREATTRIBUTE:{const r=b.getField(e,i.BufferViewFloat)??b.getField(e,i.BufferViewFloat);s.assert(!!r,`No buffer view for ${e}`),s.assert(1===t.size),B(t,r,w);break}case o.VertexAttribute.TANGENT:{s.assert(4===t.size);const f=b.getField(e,i.BufferViewVec4f);s.assert(!!f,`No buffer view for ${e}`),d(t,r,f,w);break}case o.VertexAttribute.PROFILEVERTEXANDNORMAL:{s.assert(4===t.size);const r=b.getField(e,i.BufferViewVec4f16)??b.getField(e,i.BufferViewVec4f);s.assert(!!r,`No buffer view for ${e}`),u(t,r,w);break}case o.VertexAttribute.PROFILEAUXDATA:{s.assert(3===t.size);const r=b.getField(e,i.BufferViewVec3f16)??b.getField(e,i.BufferViewVec3f);s.assert(!!r,`No buffer view for ${e}`),c(t,r,w);break}}}e.writeBufferFloat=function(e,t,r,f=1){const{data:i,indices:s}=e,o=t.typedBuffer,n=t.typedBufferStride,c=s.length;if(r*=n,1===f)for(let e=0;e<c;++e)o[r]=i[s[e]],r+=n;else for(let e=0;e<c;++e){const t=i[s[e]];for(let e=0;e<f;e++)o[r]=t,r+=n}},e.writeBufferMat3f=function(e,t,r){const{data:f,indices:i}=e,s=t.typedBuffer,o=t.typedBufferStride,n=i.length;r*=o;for(let e=0;e<n;++e){const t=9*i[e];for(let e=0;e<9;++e)s[r+e]=f[t+e];r+=o}},e.writeBufferMat4f=function(e,t,r){const{data:f,indices:i}=e,s=t.typedBuffer,o=t.typedBufferStride,n=i.length;r*=o;for(let e=0;e<n;++e){const t=16*i[e];for(let e=0;e<16;++e)s[r+e]=f[t+e];r+=o}},e.writeBufferVec2=n,e.writeBufferVec3=c,e.writeBufferVec4=u,e.writeBufferVec4Zeros=function(e,t,r){const f=e.typedBuffer,i=e.typedBufferStride;t*=i;for(let e=0;e<r;++e)f[t]=0,f[t+1]=0,f[t+2]=0,f[t+3]=0,t+=i},e.writeColor=V,e.writeDefaultAttribute=g,e.writeDefaultAttributes=function(e,t,r,f,s,n,c){let u={numItems:0,numVerticesPerItem:0};for(const l of r.fields.keys()){const r=e.get(l),a=r?.indices;if(r&&a)l===o.VertexAttribute.POSITION&&(u={numItems:1,numVerticesPerItem:a.length}),g(l,r,f,s,n,c);else if(l===o.VertexAttribute.OLIDCOLOR&&null!=t){const r=e.get(o.VertexAttribute.POSITION)?.indices;if(r){const e=r.length;w(t,n.getField(l,i.BufferViewVec4u8),e,c)}}}return u},e.writeDeltaF16Vector=function(e,r,f,i){t.subtract(b,e,r);const s=Math.max(Math.sqrt(t.length(b)),1e-4);t.scale(b,b,1/s),f[i++]=b[0],f[i++]=b[1],f[i++]=b[2],f[i++]=s},e.writeNormal=a,e.writeOlidColor=w,e.writePosition=l,e.writeTangent=d,e.writeVVFeatureAttribute=B,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));