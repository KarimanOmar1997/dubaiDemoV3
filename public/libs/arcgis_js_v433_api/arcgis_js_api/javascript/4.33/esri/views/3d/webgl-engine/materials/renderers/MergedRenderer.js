// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/tslib.es6","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/NestedMap","../../../../../core/PooledArray","../../../../../core/SetUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../support/buffer/glUtil","../../core/shaderLibrary/ShaderOutput","../../effects/RenderPlugin","../../lib/GLMaterials","../../lib/ModelDirtyTypes","../../lib/RenderSlot","../../lib/Util","../DrawParameters","./BufferRange","./Instance","./PerBufferData","./PerOriginData","../../../../support/HighlightDefaults"],(function(e,t,r,i,s,a,n,o,l,h,u,d,c,f,g,m,p,y,_,b,w,v,O,C,A,M,S){"use strict";e.MergedRenderer=class extends p.SyncRenderPlugin{get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(e){return this._highlightNames.has(e)}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new v.DrawParameters,this._highlightNames=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=a.disposeMaybe(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this._updateProduces()}_updateProduces(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==m.ShaderOutput.Highlight&&t!==m.ShaderOutput.ShadowHighlight||this._hasHighlights))&&e(t)))}))}initializeRenderContext(e){W??=e.renderContext.rctx.isAssumedMetalDriver,this._glMaterials=new y.GLMaterials(this.material,e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,g.glLayout(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}get renderOccludedFlags(){return this.material.renderOccludedFlags}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.cachedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((({geometry:t})=>e(t)))))))}modify(e,t){this._applyUpdates(e,t),this._applyAddsAndRemoves(e),this._updateDrawCommands()}get canCompact(){for(const e of this._dataByOrigin.values())if(e.buffers.some((e=>e.holes.length>1)))return!0;return!1}compact(e){if(!this.canCompact)return!1;let t=!1;for(const r of this._dataByOrigin.values()){const i=new Array;for(let t=0;t<r.buffers.length&&!e.done;){const s=r.buffers[t];s.holes.length<=1?++t:(s.instances.forEach((({geometry:e})=>i.push(e))),this._vaoCache.deleteVao(s.vao),r.buffers[t]=r.buffers[r.buffers.length-1],--r.buffers.length,e.madeProgress())}if(i.length>0){for(r.buffers.forEach((e=>this._applyAdds(e,i)));i.length>0;)r.buffers.push(this._applyAndRebuild(new A.PerBufferData,i,null));t=!0}}return t}updateHighlights(e){this.highlightOrderMap=e,this._highlightNames.clear(),this._dataByOrigin.forEach((t=>{t.buffers.forEach((t=>{t.updateHighlights(e),t.highlightNames.forEach((e=>this._highlightNames.add(e)))}))})),this._updateProduces()}_applyUpdates(e,t){const r=this._bufferWriter;if(null==r)return void e.clearUpdates();const i=r.vertexBufferLayout.stride/4;for(const s of e.updates){if(t.done)return;const{renderGeometry:a,updateType:n}=s;e.pending.updates.removeUnordered(s),t.madeProgress();const o=this._dataByOrigin.get(a.localOrigin.id),l=o?.findBuffer(a.id);if(null==l)return;const h=l.instances.get(a.id);if(n&(_.DirtyState.GEOMETRY|_.DirtyState.TRANSFORMATION)){const e=U(r.elementCount(h.geometry.geometry.attributes)*i),t=r.vertexBufferLayout.createView(e.buffer);this._writeGeometry(a,t,0),l.vao.vertexBuffers.get("geometry").setSubData(e,h.from*i,0,h.numElements*i)}n&(_.DirtyState.HIGHLIGHT|_.DirtyState.OCCLUDEE|_.DirtyState.VISIBILITY)&&(l.drawCommandsDirty=!0)}}_computeDeltas(e,t){const r=new n.NestedMap;for(const t of e){const e=t.localOrigin;if(null==e)continue;let i=r.get(e.id,null);null==i&&(i=new B(e.vec3),r.set(e.id,null,i)),i.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const i=this._dataByOrigin.get(t.id),s=i?.findBuffer(e.id);if(null==s)continue;let a=r.get(t.id,s);null==a&&(a=new B(t.vec3),r.set(t.id,s,a)),a.changes.push(e)}return r}_applyAddsAndRemoves(e){const{_bufferWriter:t,_dataByOrigin:i,_vaoCache:s}=this;if(null==t||null==s)return void e.clearAddsAndRemoves();const a=t.vertexBufferLayout.stride/4,n=this._computeDeltas(e.adds,e.removes);n.forEach(((e,o)=>{const l=e.get(null),h=l?.changes??[];n.delete(o,null);let u=i.get(o);if(e.forEach(((e,l)=>{if(n.delete(o,l),null==l&&w.assert(!1,"No VAO for removed geometries"),l.instances.size===e.changes.length)return s.deleteVao(l.vao),r.removeUnordered(u.buffers,l),void(0===u.buffers.length&&0===h.length&&i.delete(o));const d=l.numElements,c=l.vao.getByteLength("geometry")/4,f=h.reduce(((e,r)=>e+t.elementCount(r.geometry.attributes)),0),g=e.changes.reduce(((e,r)=>e+t.elementCount(r.geometry.attributes)),0),m=Math.min((d+f-g)*a,I),p=m>c;m>H&&m<c/2?(e.changes.forEach((({id:e})=>l.deleteInstance(e))),l.instances.forEach((({geometry:e})=>h.push(e))),this._vaoCache.deleteVao(l.vao),r.removeUnordered(u.buffers,l)):p?this._applyAndRebuild(l,h,e):this._applyRemoves(l,e)})),h.length>0)for(null==u&&(u=new M.PerOriginData(l.origin),i.set(o,u)),u.buffers.forEach((e=>this._applyAdds(e,h)));h.length>0;)u.buffers.push(this._applyAndRebuild(new A.PerBufferData,h,null))})),e.clearAddsAndRemoves()}_updateDrawCommands(){this._highlightNames.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.updateIfDrawCommandsDirty(this.highlightOrderMap,this._bufferWriter.vertexBufferLayout.stride),e.hasHighlights&&l.addMany(this._highlightNames,e.highlightNames),this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,r){if(r)for(const t of r.changes)e.deleteInstance(t.id);const i=this._bufferWriter,s=i.vertexBufferLayout.stride,a=s/4,n=Math.floor(I/a);let o=e.numElements;for(;t.length>0;){const r=t.pop(),s=i.elementCount(r.geometry.attributes);if(o+s>n&&o>0){t.push(r);break}o+=s;const a=new C.Instance(r,0,0,this.highlightOrderMap);w.assert(null==e.instances.get(r.id)),e.addInstance(r.id,a)}const l=o*a,h=U(l),u=i.vertexBufferLayout.createView(h.buffer);let d=0;e.resetInstanceSummary(),e.instances.forEach(((t,r)=>{this._writeGeometry(t.geometry,u,d);const s=d;d+=i.elementCount(t.geometry.geometry.attributes),e.updateInstance(r,s,d),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(V(l)),e.vao.vertexBuffers.get("geometry").setSubData(h,0,0,d*a),e.holes.clear();const c=e.holes.pushNew();return c.from=d,c.to=Math.floor(e.vao.getByteLength("geometry")/s),e.updateDrawCommands(this.highlightOrderMap,s),e}_applyRemoves(e,t){if(0===t.changes.length||null==this._bufferWriter)return;let r=1/0,i=-1/0;for(const s of t.changes){const t=s.id,a=e.instances.get(t);if(!a)continue;e.deleteInstance(t),W&&(r=Math.min(r,a.from),i=Math.max(i,a.to));const n=x.back();if(n){if(n.to===a.from){n.to=a.to;continue}if(n.from===a.to){n.from=a.from;continue}}const o=x.pushNew();o.from=a.from,o.to=a.to}O.mergeAdjacentRanges(x);const s=this._bufferWriter.vertexBufferLayout.stride/4,a=e.vao.vertexBuffers.get("geometry");if(W){const t=(i-r)*s,n=U(t),o=this._bufferWriter.vertexBufferLayout.createView(n.buffer);n.fill(0,0,t),e.instances.forEach((e=>{if(!(e.from>=r&&e.to<=i))return;const t=e.from-r;this._writeGeometry(e.geometry,o,t)})),a.setSubData(n,r*s,0,t)}else{const e=x.reduce(((e,t)=>Math.max(e,t.numElements)),0)*s,t=U(e);t.fill(0,0,e),x.forAll((e=>a.setSubData(t,e.from*s,0,e.numElements*s)))}e.holes.pushArray(x.data,x.length),x.forAll(((e,t)=>x.data[t]=null)),x.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null==this._bufferWriter)return;if(!A.hasVao(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,s=i.vertexBufferLayout.stride/4,a=e.numElements,n=t.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),o=Math.min((a+n)*s,I),l=4*o;if(e.vao.getByteLength("geometry")<V(I-H)&&l>e.vao.getByteLength("geometry"))return void this._applyAndRebuild(e,t,null);O.mergeAdjacentRanges(e.holes);const h=new Array;let u=1/0,d=-1/0;for(const r of t){const t=i.elementCount(r.geometry.attributes),s=E(e.holes,t);h.push(s),W&&null!=s&&(u=Math.min(s,u),d=Math.max(s+t,d))}const c=e.vao.vertexBuffers.get("geometry");let f=0,g=0,m=0;const p=U(W?(d-u)*s:o),y=i.vertexBufferLayout.createView(p.buffer);if(t.forEach(((t,r)=>{const a=h[r];if(null==a)return;const n=i.elementCount(t.geometry.attributes);if(!W){if(m!==a){const e=m-g;e>0&&c.setSubData(p,g*s,0,e*s),g=a,f=0}this._writeGeometry(t,y,f),f+=n,m=a+n}const o=new C.Instance(t,a,a+n,this.highlightOrderMap);w.assert(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0})),W){const t=(d-u)*s;p.fill(0,0,t),e.instances.forEach((e=>{if(!(e.from>=u&&e.to<=d))return;const t=e.from-u;this._writeGeometry(e.geometry,y,t)})),g=u,m=d}const _=m-g;_>0&&c.setSubData(p,g*s,0,_*s),r.filterInPlace(t,((e,t)=>null==h[t]))}_writeGeometry(e,t,r){null!=this._bufferWriter&&(c.copy(D,e.transformation),D[12]-=e.localOrigin.vec3[0],D[13]-=e.localOrigin.vec3[1],D[14]-=e.localOrigin.vec3[2],c.invert(R,D),c.transpose(R,R),this._bufferWriter.write(D,R,e.geometry.attributes,e.geometry.objectAndLayerIdColor,t,r))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:r}=e,i=this.material.produces.get(r.slot);if(!i?.(t))return null;const{highlight:s,slot:a}=r,n=t===m.ShaderOutput.ShadowHighlight,o=t===m.ShaderOutput.Highlight,l=o||n,h=s?.name;if(l&&(0===this._highlightNames.size||o&&h&&!this._highlightNames.has(h)))return null;const u=t===m.ShaderOutput.ShadowExcludeHighlight,d=!(l||u);for(const{buffers:i}of this._dataByOrigin.values())for(const s of i){if(c=s.highlightNames,o&&h&&!c.has(h))continue;const i=n?s.drawCommandsHighlights.get(S.defaultHighlightName):l?h?s.drawCommandsHighlights.get(h):s.drawCommandsHighlights.size>0:((u&&s.needsMultipleCommands()?s.drawCommandsShadowHighlightRest:s.drawCommandsDefault)||null)?.length??!1,f=d&&s.drawCommandsOccludees||null;if(i||f?.length){const i=this._glMaterials.load(e.rctx,a,t),s=i?.beginSlot(r);if(s)return s}}var c;return null}render(e,t){const{output:r,bind:i}=e,{slot:s,highlight:a}=i,n=r===m.ShaderOutput.Highlight,l=a?.name??"";if(n&&!a)return;const h=r===m.ShaderOutput.ShadowHighlight,u=n||h,d=r===m.ShaderOutput.ShadowExcludeHighlight,c=!(u||d),f=s===b.RenderSlot.OCCLUDER_MATERIAL||s===b.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL?s:null,{rctx:g}=e;g.runAppleAmdDriverHelper();const p=g.bindTechnique(t,i,this.material.parameters);for(const e of this._dataByOrigin.values())for(const r of e.buffers){if(n&&(!r.hasHighlights||!r.drawCommandsHighlights.has(l)))continue;if(h&&(!r.hasHighlights||!r.drawCommandsHighlights.has(S.defaultHighlightName)))continue;const s=()=>{const e=[],t=r.drawCommandsHighlights.get(S.defaultHighlightName)??new o;return t&&e.push(t),e},a=u&&!h?r.drawCommandsHighlights.get(l)??null:null,m=h?s():u?a?[a]:G:d&&r.needsMultipleCommands()?[r.drawCommandsShadowHighlightRest]:[r.drawCommandsDefault],y=m.some((e=>e.length>0)),_=c&&r.drawCommandsOccludees||null;if(y||_?.length){if(this._drawParameters.origin=e.origin,p.bindDraw(i,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(r.vao),g.bindVAO(r.vao),y)for(const e of m)g.setPipelineState(t.getPipeline(!1,f)),e.forAll((e=>g.drawArrays(t.primitiveType,e.first,e.count)));_?.length&&(g.setPipelineState(t.getPipeline(!0,f)),_.forAll((e=>g.drawArrays(t.primitiveType,e.first,e.count))))}}}static prune(){T=new Float32Array(H)}get test(){}},t.__decorate([h.property({constructOnly:!0})],e.MergedRenderer.prototype,"material",void 0),t.__decorate([h.property({})],e.MergedRenderer.prototype,"highlightOrderMap",void 0),e.MergedRenderer=t.__decorate([d.subclass("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],e.MergedRenderer);class B{constructor(e){this.origin=e,this.changes=new Array}}function E(e,t){const r=e.find((e=>e.numElements>=t));if(null==r)return null;const i=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),i}const D=f.create(),R=f.create(),x=new o({allocator:e=>e||new O.BufferRange,deallocator:null}),H=65536,L=4*H,P=1024,N=16777216,I=N/4;let T=new Float32Array(H);function U(e){return T.length<e&&(T=new Float32Array(e)),T}function V(e){const t=4*e;return t<=P?P:t<L?s.nextHighestPowerOfTwo(t):Math.max(Math.min(Math.ceil(1.5*t/L)*L,N),t)}const G=[];let W;e.sizeForVao=V,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));