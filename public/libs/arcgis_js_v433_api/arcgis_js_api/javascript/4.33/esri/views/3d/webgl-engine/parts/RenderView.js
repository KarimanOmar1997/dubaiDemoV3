// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/floatRGBA","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/time","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/spatialReferenceUtils","../../../ViewingMode","../../environment/ChapmanAtmosphere","../../environment/CloudsComposition","../../environment/Fog","../../environment/LocalAtmosphere","../../environment/MarsAtmosphere","../collections/Component/ComponentObjectCollection","../core/shaderTechnique/ShaderTechniqueConstructionContext","../core/shaderTechnique/ShaderTechniqueRepository","../effects/bloom/BloomRenderNode","../effects/geometry/ObjectAndLayerIDRenderNode","../effects/geometry/olidUtils","../effects/geometry/RenderOccludedRenderNode","../effects/haze/Haze","../effects/highlight/Highlight","../effects/highlight/ShadowHighlight","../effects/magnifier/Magnifier","../effects/smaa/SMAA","../effects/ssao/SSAO","../effects/stars/Stars","../lib/basicInterfaces","../lib/CompositingHelper","../lib/GLMaterialRepository","../lib/ObjectAndLayerIdRenderHelper","../lib/Renderer","../lib/RenderingContext","../lib/TextureRepository","../materials/markerTextureRepository","../materials/stippleTextureRepository","../materials/internal/WaterTextureRepository","./contextCache","./renderUtils","./ScreenshotManager","./testUtils","../../../support/RenderState","../../../webgl/checkWebGLError"],(function(e,t,r,n,s,i,o,a,d,h,c,p,l,u,_,y,R,m,g,w,x,f,b,v,A,T,C,S,M,O,q,L,U,D,k,V,E,j,B,H,F,W,G,N,P,I,z,K,X,Q,J){"use strict";e.RenderView=class extends r{constructor(e){super(e),this.events=new n,this.waterTextures=new P.WaterTextureRepository,this.olidRenderHelper=C.olidEnabled()?new B.ObjectAndLayerIdRenderHelper:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this.bloom=null,this.test=null;const t=e.stage;try{this._initializeContext(t)}catch(e){return void console.error("Failed to initialize context",e)}const{memoryController:r}=t.view.resourceController;this.stippleTextures=N.createStippleTextureRepository(this._rctx,r),this.markerTextures=G.createMarkerTextureRepository(this._rctx,r),this._techniques=new v.ShaderTechniqueRepository(new b.ShaderTechniqueConstructionContext(this._rctx,t.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new W.TextureRepository(t),this.addHandles(this._textures.events.on("changed",(e=>this.requestRender(e))));const s=new j.GLMaterialRepository(this._textures,this._techniques,(()=>this.requestRender()),(()=>this.requestRender()));this._compositingHelper=new E(this._rctx,this._techniques),this.renderer=new H.Renderer(t,s,this._techniques,this._rctx,this._compositingHelper,(e=>this.requestRender(e))),this.addHandles([d.watch((()=>t.view.ready),(e=>{e&&this._createRenderNodes()}),d.initial),d.watch((()=>this.waterTextures?.updating),(()=>this.requestRender()),d.initial),d.watch((()=>t.view.qualityProfile),(e=>this.renderer?.updateRenderFeatures(e)),d.syncAndInitial)]);const i={renderScene:(e,t,r,n)=>this.renderer.render(e,t,r,n),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(e,r,n)=>t.options.screenshot.renderOverlay(e,r,n)};this._screenshotManager=new K.ScreenshotManager(this._rctx,i,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(t)}destroy(){const e=this.stage?.container;e?.contains(this._canvas)&&e.removeChild(this._canvas),this._frameTask=a.removeMaybe(this._frameTask),this._techniques=a.destroyMaybe(this._techniques),this._componentObjects=a.destroyMaybe(this._componentObjects),this._screenshotManager=a.destroyMaybe(this._screenshotManager),a.destroyMaybe(this.renderer),this._textures=a.destroyMaybe(this._textures),a.destroyMaybe(this.waterTextures),a.destroyMaybe(this.markerTextures),a.destroyMaybe(this.stippleTextures),this._canvas=null,this._rctx=a.destroyMaybe(this._rctx)}_createRenderNodes(){const{view:e,viewingMode:t}=this.stage;new k.Stars({view:e}),_.isMoon(e.spatialReference)||(t===y.ViewingMode.Local?(new w.LocalAtmosphere({view:e}),this.bloom=new A.BloomRenderNode({view:e})):_.isMars(e.spatialReference)?(new x({view:e}),this.bloom=new A.BloomRenderNode({view:e})):(new R.ChapmanAtmosphere({view:e}),new m.CloudsComposition({view:e}),this.bloom=new A.BloomRenderNode({view:e}),new M.Haze({view:e}),new g.Fog({view:e}))),new D.SSAO({view:e,isEnabled:()=>this.renderer.hasSSAO}),new U.SMAA({view:e,isEnabled:()=>this.renderer.hasSMAA}),new L.Magnifier({view:e}),new O.Highlight({view:e}),new q.ShadowHighlight({view:e,viewingMode:t}),new S.RenderOccludedRenderNode({view:e}),C.olidEnabled()&&new T.ObjectAndLayerIDRenderNode({view:e})}requestRender(e=V.RenderRequestType.UPDATE){this._needsRender=!0,e===V.RenderRequestType.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,r,n,i,o=i){const a=n.constrainWindowSize(t,r,i*n.pixelRatio,o*n.pixelRatio),d=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,d);const h=(e,t,r)=>s.unpackFloatRGBA(t,e)*(r[1]-r[0])+r[0];let c=Number.MAX_VALUE;for(let e=0;e<a[2]*a[3];e++){const t=h(4*e,d,n.nearFar);c>t&&t!==n.nearFar[0]&&t!==n.nearFar[1]&&(c=t)}if(e){const s=e.pickDepth(t*n.pixelRatio,r*n.pixelRatio,n);null!=s&&c>s&&s!==n.nearFar[0]&&s!==n.nearFar[1]&&(c=s)}return c===Number.MAX_VALUE?void 0:c}_ensureLinearDepthArrayBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){z.removeLoadedShaderModules(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let r=!1,n=V.RenderRequestType.BACKGROUND,s=!1;const i={preRender:({time:s})=>{r=this.updating,n=this._needsUpdate?V.RenderRequestType.UPDATE:V.RenderRequestType.BACKGROUND,this._needsRender&&this.renderer.updateSceneDepthRange(t.camera),e.commitSyncLayers(),s=this.test?.time??s,(c.Milliseconds(s-this._lastAnimationUpdate)>this.renderer.animationTimestep||r||this._needsRender)&&(this.renderer.updateAnimation(t,s)&&this.requestRender(V.RenderRequestType.BACKGROUND),this._lastAnimationUpdate=s)},render:({time:e})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const r=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,e=this.test?.time??e,this.renderer.render(t,e),s=!0,r&&this.renderer.hasReflections&&(this.requestRender(V.RenderRequestType.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:e})=>{this._textures.update();const r=new K.ScreenshotContext(t,this.renderer.fboCache);e=this.test?.time??e,this._screenshotManager.update(r,e)},finish:()=>{s&&(this.renderer.finish(t.mode===Q.RenderState.IDLE?n:V.RenderRequestType.UPDATE),s=!1)}};this._frameTask=h.addFrameTask(i)}_initializeContext(e){const{options:t}=e,r=t.canvas??document.createElement("canvas");r.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=r;const n={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},s=r.getContext("webgl2",n);if(null==s)return void o.getLogger(this).error("A WebGL2 context could not be created.");J.checkWebGLError(s,!0),this._rctx=function(e,t){const r={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8,maxPreferredTexturePixels:t.view.qualitySettings.maxTexturePixels,newCache:(e,r)=>t.view.resourceController.memoryController.newCache(e,r)};if(X.contextCache.enabled){let t=Y.get(e);return t?(t.configure(r),t.ref(),t):(t=new F.RenderingContext(e,r),Y.set(e,t),t.ref(),t)}return new F.RenderingContext(e,r)}(s,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&o.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:a}=e;!this._rctx.contextAttributes.alpha&&i("safari")>=11&&(a.style.backgroundColor="black"),a.contains(r)||a.appendChild(r)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}getObjectAndLayerIdColor(e){return this.olidRenderHelper?.getObjectAndLayerIdColor(e)}get componentObjectCollection(){return null==this._componentObjects&&(this._componentObjects=new f.ComponentObjectCollection(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(e){this._componentObjects=e}updateQualitySettings(e){this.test&&null!=this.test.time&&(this.test.savedFadeDuration=e.fadeDuration,e.fadeDuration=c.Milliseconds(0)),this._rctx.updateOptions({maxPreferredTexturePixels:this.stage.view.qualitySettings.maxTexturePixels})}},t.__decorate([p.property({type:Boolean,readOnly:!0})],e.RenderView.prototype,"updating",null),t.__decorate([p.property({constructOnly:!0})],e.RenderView.prototype,"stage",void 0),t.__decorate([p.property()],e.RenderView.prototype,"_rctx",void 0),t.__decorate([p.property()],e.RenderView.prototype,"_canvas",void 0),t.__decorate([p.property()],e.RenderView.prototype,"stippleTextures",void 0),t.__decorate([p.property()],e.RenderView.prototype,"markerTextures",void 0),t.__decorate([p.property()],e.RenderView.prototype,"waterTextures",void 0),t.__decorate([p.property({readOnly:!0})],e.RenderView.prototype,"olidRenderHelper",void 0),t.__decorate([p.property()],e.RenderView.prototype,"_textures",void 0),t.__decorate([p.property({readOnly:!0})],e.RenderView.prototype,"renderer",void 0),t.__decorate([p.property()],e.RenderView.prototype,"_screenshotManager",void 0),t.__decorate([p.property()],e.RenderView.prototype,"componentObjectCollection",null),t.__decorate([p.property()],e.RenderView.prototype,"_componentObjects",void 0),t.__decorate([p.property()],e.RenderView.prototype,"_needsUpdate",void 0),t.__decorate([p.property()],e.RenderView.prototype,"_needsWaterReflectionUpdate",void 0),e.RenderView=t.__decorate([u.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView);const Y=I.getContextCache();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));