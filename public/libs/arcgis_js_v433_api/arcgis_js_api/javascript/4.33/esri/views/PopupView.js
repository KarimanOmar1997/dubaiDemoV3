// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../chunks/tslib.es6","../core/asyncUtils","../core/Error","../core/has","../core/Logger","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./input/InputManager"],(function(e,p,t,o,i,s,r,a,u,n,c,l,h){"use strict";const d=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function w(e){return null!=e&&"open"in e&&"declaredClass"in e}function y(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}class f{constructor(e){this.layerView=e,this._resolver=a.createResolver(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(e){const{layerView:p,graphics:t,_resolver:o}=this;if(!p)return o.resolve(t),o.promise;let i;return p.fetchPopupFeaturesFromGraphics(t,e).catch((e=>(i=e,null))).then((e=>{e?o.resolve(e):o.reject(i)})),o.promise}}p.PopupView=p=>{let c=class extends p{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([u.watch((()=>[this.ui,this.popup]),(([e,p],t)=>{const o="popup";if(t){const[e,i]=t;e&&w(i)&&(i.view=null,y(i)&&(e.remove(i,o),i!==p&&p&&i.destroy()))}e&&w(p)&&(p.view=this,y(p)&&e.add(p,{key:o,position:"manual",internal:!0}))}),u.syncAndInitial),this.on("click",(e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(w(this.popup)?this.popup.viewModel.handleViewClick(e):e.defer((async()=>{await this.setupPopup(),w(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)})))}),h.ViewEventPriorities.WIDGET)]),u.whenOnce((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{new Promise(((p,t)=>e(["../widgets/Popup"],(e=>p(d(e))),t)))}))}destroy(){this.destroyed||this.closePopup()}async openPopup(e){if(w(this.popup))return this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void r.getLogger(this).error(new i("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}}closePopup(){this._popupSetupTask?.abort(),w(this.popup)&&this.popup.close()}async fetchPopupFeatures(e,p){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(e,p),p)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!w(this.popup))return this._popupSetupTask=o.createTask((async p=>{const{default:t}=await new Promise(((p,t)=>e(["../widgets/Popup"],(e=>p(d(e))),t)));if(a.throwIfAborted(p),!this.popup||w(this.popup))return;const o=this.popup;delete o.open,delete o.close,this.popup=new t(o)})),this._popupSetupTask.promise}async _popupHitsToFeatures({location:e,hits:p},t){const o=[],i=[];let r=!1;const u=a.wrapAbortWithTimeout(t,s("popup-view-fetch-timeout")??5e3),n=e=>{const p=i.at(-1);return p&&p.layerView===e&&!r?p:(e=>{const p=new f(e);return i.push(p),o.push(p.promise),p})(e)};for(const e of p)"graphic"in e?(n(e.layerView).graphics.push(e.graphic),r=!1):(o.push(e.layerView.fetchPopupFeaturesAtLocation(e.mapPoint,u)),r=!0);i.map((e=>e.resolve(u)));const c=a.allSettledValues(o).then((e=>e.filter((e=>!!e)).flat()));return{pendingFeatures:o,allGraphicsPromise:c,location:e}}async _getPopupHits(e,p){const{hits:t,location:o}=await this.popupHitTest(e);a.throwIfAborted(p);const i=[];for(const e of t)if("graphic"in e){if(this._isValidPopupGraphic(e.graphic,p)){const p=this._isValidPopupGraphicsLayerView(e.layerView)?e.layerView:void 0;i.push({graphic:e.graphic,layerView:p})}}else this._isValidPopupLocationLayerView(e.layerView)&&i.push({mapPoint:e.mapPoint,layerView:e.layerView});return{hits:i,location:o}}_isValidPopupGraphic(e,p){return e&&!!e.getEffectivePopupTemplate(p?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(e){return!e||(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesFromGraphics"in e}_isValidPopupLocationLayerView(e){return(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesAtLocation"in e}};return t.__decorate([n.property()],c.prototype,"popup",void 0),t.__decorate([n.property()],c.prototype,"popupEnabled",void 0),c=t.__decorate([l.subclass("esri.views.PopupView")],c),c},Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})}));