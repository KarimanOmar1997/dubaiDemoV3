// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
require({cache:{"esri/core/accessorSupport/overrideDefaultsFrom":function(){define(["exports","../Accessor","./PropertyOrigin","./utils"],(function(e,t,r,i){"use strict";e.overrideDefaultsFrom=function e(s,n){const o=i.getProperties(s),a=i.getProperties(n),l=o.store,c=a.store,u=a.metadata;for(const i in u){const n=u[i],o=l.originOf(i),a=c.originOf(i);if(!n.readOnly&&a!==r.OriginId.DEFAULTS)if(o===r.OriginId.DEFAULTS)s.set(i,c.get(i));else{const r=l.get(i),s=c.get(i);r&&s&&s instanceof t&&r instanceof t&&r instanceof s.constructor&&e(r,s)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/projection/projectBoundingRect":function(){define(["exports","../../core/libs/gl-matrix-2/factories/vec3f64","./projectBuffer","../support/aaBoundingRect","../support/spatialReferenceUtils"],(function(e,t,r,i,s){"use strict";const n=t.create();e.projectBoundingRect=function(e,t,o,a){return!(null==e||(s.equals(t,a)?(i.copy(o,e),0):(n[0]=e[0],n[1]=e[1],n[2]=0,!r.projectBuffer(n,t,0,n,a,0)||(o[0]=n[0],o[1]=n[1],n[0]=e[2],n[1]=e[3],n[2]=0,!r.projectBuffer(n,t,0,n,a,0)||(o[2]=n[0],o[3]=n[1],0)))))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/projection/projectPointToVector":function(){define(["exports","../../core/libs/gl-matrix-2/factories/vec3f64","../projectionUtils","./projectBuffer"],(function(e,t,r,i){"use strict";function s(e,t,s,o){if(r.canProjectWithoutEngine(e.spatialReference,s)){n[0]=e.x,n[1]=e.y;const r=e.z;return n[2]=r??o??0,i.projectBuffer(n,e.spatialReference,0,t,s,0)}const a=r.tryProjectWithZConversion(e,s);return!!a&&(t[0]=a?.x,t[1]=a?.y,t[2]=a?.z??o??0,!0)}const n=t.create();e.projectPointToVector=s,e.projectPointToVectorAsync=async function(e,t,i,n,o){return await r.initializeProjection(e.spatialReference,i,null,o),s(e,t,i,n)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/coordinateSystem":function(){define(["exports","../../core/libs/gl-matrix-2/math/mat4","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../ellipsoidUtils","../SpatialReference","../spatialReferenceEllipsoidUtils","./Axis","../../chunks/boundedPlane","../../chunks/sphere"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e){return{operations:e,value:e.create()}}function d(e,t,r=u(e)){return r.operations=e,e.copy(t,r.value),r}const h=2**50;function p(e,t,r,i){return e.operations.setAltitudeAt(e.value,t,r,i)}const m=i.create(),f=i.create();e.altitudeAt=function(e,t){return e.operations.altitudeAt(e.value,t)},e.axisAt=function(e,t,r,i){return e.operations.axisAt(e.value,t,r,i)},e.closestPoint=function(e,t,r){return e.operations.closestPoint(e.value,t,r)},e.closestPointOnSilhouette=function(e,t,r){return e.operations.closestPointOnSilhouette(e.value,t,r)},e.coordinateSystemFromOneAxisAndNormalVector=function(e,t,i,s,n){r.copy(i,e),r.copy(f,t),r.normalize(f,f),r.cross(s,f,i),r.cross(n,s,i)},e.create=function(e){const{value:t,operations:r}=e;return{operations:r,value:r.create(t)}},e.createFromOperations=u,e.createGlobal=function(e){return d(c.sphere,c.fromValues(0,0,0,s.getReferenceEllipsoid(e).radius))},e.createLocal=function(){return d(l.boundedPlane,l.fromValues([0,0,0],[h,0,0],[0,h,0]))},e.distanceToSilhouette=function(e,t){return e.operations.distanceToSilhouette(e.value,t)},e.elevate=function(e,t,r){return e.operations.elevate(e.value,t,r.value)},e.fromValues=d,e.getExtent=function(e,t){return e.operations.getExtent(e.value,t),t},e.intersectRay=function(e,t,r){return e.operations.intersectRay(e.value,t,r)},e.intersectRayClosestSilhouette=function(e,t,r){return e.operations.intersectRayClosestSilhouette(e.value,t,r)},e.normalAt=function(e,t,r){return e.operations.axisAt(e.value,t,a.Axis.Z,r)},e.renderSRFromViewSR=function(e,t){return e?o.getSphericalPCPF(t):t.isGeographic?n.PlateCarree:t},e.setAltitudeAt=p,e.setAltitudeOfTransformation=function(e,i,s,n){return i!==n&&t.copy(n,i),r.set(m,n[12],n[13],n[14]),p(e,m,s,m),n[12]=m[0],n[13]=m[1],n[14]=m[2],n},e.setExtent=function(e,t,r){return e.operations.setExtent(e.value,t,r.value),r},e.vectorCoordinates=function(e,t,i,s,n){return n[0]=r.dot(e,t),n[1]=r.dot(e,i),n[2]=r.dot(e,s),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/spatialReferenceEllipsoidUtils":function(){define(["exports","./ellipsoidUtils","./SpatialReference","./support/spatialReferenceUtils"],(function(e,t,r,i){"use strict";const s=new r(t.SphericalECEFSpatialReferenceLike),n=new r(t.SphericalPCPFMarsLike),o=new r(t.SphericalPCPFMoonLike),a=new r(t.WGS84ECEFSpatialReferenceLike),l=new Map,c=n.wkt.toUpperCase(),u=o.wkt.toUpperCase();e.SphericalECEFSpatialReference=s,e.SphericalPCPFMars=n,e.SphericalPCPFMoon=o,e.WGS84ECEFSpatialReference=a,e.getSphericalPCPF=function(e){const t=l.get(e);if(t)return t;let r=s;if(e)if(e===n)r=n;else if(e===o)r=o;else{const t=e.wkid,s=e.latestWkid;if(null!=t||null!=s)i.isWKIDFromMars(t)||i.isWKIDFromMars(s)?r=n:(i.isWKIDFromMoon(t)||i.isWKIDFromMoon(s))&&(r=o);else{const t=e.wkt2??e.wkt;if(t){const e=t.toUpperCase();e===c?r=n:e===u&&(r=o)}}}return l.set(e,r),r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/boundedPlane":function(){define(["exports","../core/has","../core/Logger","../core/mathUtils","../core/ObjectStack","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/support/aaBoundingRect","../geometry/support/Axis","../geometry/support/lineSegment","../geometry/support/plane","../geometry/support/ray","../geometry/support/vector","../geometry/support/vectorStacks"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";const g=()=>r.getLogger("esri.views.3d.support.geometryUtils.boundedPlane"),y=class{constructor(){this.plane=h.create(),this.origin=l.create(),this.basis1=l.create(),this.basis2=l.create()}};function _(e=Y){return{plane:h.create(e.plane),origin:l.clone(e.origin),basis1:l.clone(e.basis1),basis2:l.clone(e.basis2)}}function b(e,t,r){const i=ee.get();return i.origin=e,i.basis1=t,i.basis2=r,i.plane=h.wrap(0,0,0,0),x(i),i}function v(e,t=_()){return w(e.origin,e.basis1,e.basis2,t)}function S(e,t){a.copy(t.origin,e.origin),a.copy(t.basis1,e.basis1),a.copy(t.basis2,e.basis2),h.copy(t.plane,e.plane)}function w(e,t,r,i=_()){return a.copy(i.origin,e),a.copy(i.basis1,t),a.copy(i.basis2,r),x(i),s=i,n="fromValues()",Math.abs(a.dot(s.basis1,s.basis2)/(a.length(s.basis1)*a.length(s.basis2)))>1e-6&&g().warn(n,"Provided basis vectors are not perpendicular"),Math.abs(a.dot(s.basis1,H(s)))>1e-6&&g().warn(n,"Basis vectors and plane normal are not perpendicular"),Math.abs(-a.dot(H(s),s.origin)-s.plane[3])>1e-6&&g().warn(n,"Plane offset is not consistent with plane origin"),i;var s,n}function x(e){h.fromVectorsAndPoint(e.basis2,e.basis1,e.origin,e.plane)}function T(e,t,r){e!==r&&v(e,r);const i=a.scale(f.sv3d.get(),H(e),t);return a.add(r.origin,r.origin,i),r.plane[3]-=t,r}function C(e,t,r){return M(t,r),T(r,G(e,e.origin),r),r}function P(e,t){const r=e.basis1[0],i=e.basis2[1],[s,n]=e.origin;return c.fromValues(s-r,n-i,s+r,n+i,t)}function M(e,t=_()){const r=(e[2]-e[0])/2,i=(e[3]-e[1])/2;return a.set(t.origin,e[0]+r,e[1]+i,0),a.set(t.basis1,r,0,0),a.set(t.basis2,0,i,0),h.fromValues(0,0,1,0,t.plane),t}function R(e,t,r){return!!h.intersectRay(e.plane,t,r)&&W(e,r)}function E(e,t,r){if(R(e,t,r))return r;const i=O(e,t,f.sv3d.get());return a.add(r,t.origin,a.scale(f.sv3d.get(),t.direction,a.distance(t.origin,i)/a.length(t.direction))),r}function O(e,t,r){const s=X.get();Z(e,t,s,X.get());let n=Number.POSITIVE_INFINITY;for(const o of te){const l=Q(e,o,K.get()),c=f.sv3d.get();if(h.intersectLineSegment(s,l,c)){const e=a.direction(f.sv3d.get(),t.origin,c),s=Math.abs(i.acosClamped(a.dot(t.direction,e)));s<n&&(n=s,a.copy(r,c))}}return n===Number.POSITIVE_INFINITY?I(e,t,r):r}function A(e,t){return(t-e)/t}function I(e,t,r){if(R(e,t,r))return r;const i=X.get(),s=X.get();Z(e,t,i,s);let n=Number.POSITIVE_INFINITY;for(const o of te){const l=Q(e,o,K.get()),c=f.sv3d.get();if(h.intersectLineSegmentClamp(i,l,c)){const e=p.distance2(t,c);if(!h.isPointInside(s,c))continue;e<n&&(n=e,a.copy(r,c))}}return L(e,t.origin)<n&&D(e,t.origin,r),r}function D(e,t,r){const i=h.projectPoint(e.plane,t,f.sv3d.get()),s=d.projectPointClamp($(e,e.basis1),i,-1,1,f.sv3d.get()),n=d.projectPointClamp($(e,e.basis2),i,-1,1,f.sv3d.get());return a.subtract(r,a.add(f.sv3d.get(),s,n),e.origin),r}function F(e,t,r){const{origin:i,basis1:s,basis2:n}=e,o=a.subtract(f.sv3d.get(),t,i),l=m.projectPointSignedLength(s,o),c=m.projectPointSignedLength(n,o),u=m.projectPointSignedLength(H(e),o);return a.set(r,l,c,u)}function L(e,t){const r=F(e,t,f.sv3d.get()),{basis1:i,basis2:s}=e,n=a.length(i),o=a.length(s),l=Math.max(Math.abs(r[0])-n,0),c=Math.max(Math.abs(r[1])-o,0),u=r[2];return l*l+c*c+u*u}function N(e,t){return Math.sqrt(L(e,t))}function U(e,t){let r=Number.NEGATIVE_INFINITY;for(const i of te){const s=Q(e,i,K.get()),n=d.distance2(s,t);n>r&&(r=n)}return Math.sqrt(r)}function V(e,t){return h.isPointInside(e.plane,t)&&W(e,t)}function B(e,t,r,i){return function(e,t,r){switch(t){case u.Axis.X:a.copy(r,e.basis1),a.normalize(r,r);break;case u.Axis.Y:a.copy(r,e.basis2),a.normalize(r,r);break;case u.Axis.Z:a.copy(r,H(e))}return r}(e,r,i)}function G(e,t){const r=-e.plane[3];return m.projectPointSignedLength(H(e),t)-r}function k(e,t,r,i){const s=G(e,t),n=a.scale(J,H(e),r-s);return a.add(i,t,n),i}function z(e,t){return a.exactEquals(e.basis1,t.basis1)&&a.exactEquals(e.basis2,t.basis2)&&a.exactEquals(e.origin,t.origin)}function j(e,t,r){return e!==r&&v(e,r),n.invert(re,t),n.transpose(re,re),a.transformMat4(r.basis1,e.basis1,re),a.transformMat4(r.basis2,e.basis2,re),a.transformMat4(h.getNormal(r.plane),h.getNormal(e.plane),re),a.transformMat4(r.origin,e.origin,t),h.setOffsetFromPoint(r.plane,r.plane,r.origin),r}function q(e,t,r,i){return e!==i&&v(e,i),n.fromRotation(ie,t,r),a.transformMat4(i.basis1,e.basis1,ie),a.transformMat4(i.basis2,e.basis2,ie),x(i),i}function H(e){return h.getNormal(e.plane)}function W(e,t){const r=a.subtract(f.sv3d.get(),t,e.origin),i=a.squaredLength(e.basis1),s=a.squaredLength(e.basis2),n=a.dot(e.basis1,r),o=a.dot(e.basis2,r);return-n-i<0&&n-i<0&&-o-s<0&&o-s<0}function $(e,t){const r=K.get();return a.copy(r.origin,e.origin),a.copy(r.vector,t),r}function Q(e,t,r){const{basis1:i,basis2:s,origin:n}=e,o=a.scale(f.sv3d.get(),i,t.origin[0]),l=a.scale(f.sv3d.get(),s,t.origin[1]);a.add(r.origin,o,l),a.add(r.origin,r.origin,n);const c=a.scale(f.sv3d.get(),i,t.direction[0]),u=a.scale(f.sv3d.get(),s,t.direction[1]);return a.scale(r.vector,a.add(c,c,u),2),r}function Z(e,t,r,i){const s=H(e);h.fromVectorsAndPoint(s,t.direction,t.origin,r),h.fromVectorsAndPoint(h.getNormal(r),s,t.origin,i)}const Y={plane:h.create(),origin:l.fromValues(0,0,0),basis1:l.fromValues(1,0,0),basis2:l.fromValues(0,1,0)},X=new s.ObjectStack(h.create),K=new s.ObjectStack(d.create),J=l.create(),ee=new s.ObjectStack((()=>_())),te=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],re=o.create(),ie=o.create(),se=Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:y,altitudeAt:G,axisAt:B,cameraFrustumCoverage:A,closestPoint:I,closestPointOnSilhouette:O,copy:v,copyWithoutVerify:S,create:_,distance:N,distance2:L,distanceToSilhouette:U,elevate:T,equals:z,extrusionContainsPoint:V,fromAABoundingRect:M,fromValues:w,getExtent:P,intersectRay:R,intersectRayClosestSilhouette:E,normal:H,projectPoint:D,projectPointLocal:F,rotate:q,setAltitudeAt:k,setExtent:C,transform:j,up:Y,updateUnboundedPlane:x,wrap:b},Symbol.toStringTag,{value:"Module"}));e.BoundedPlaneClass=y,e.altitudeAt=G,e.axisAt=B,e.boundedPlane=se,e.cameraFrustumCoverage=A,e.closestPoint=I,e.closestPointOnSilhouette=O,e.copy=v,e.copyWithoutVerify=S,e.create=_,e.distance=N,e.distance2=L,e.distanceToSilhouette=U,e.elevate=T,e.equals=z,e.extrusionContainsPoint=V,e.fromAABoundingRect=M,e.fromValues=w,e.getExtent=P,e.intersectRay=R,e.intersectRayClosestSilhouette=E,e.normal=H,e.projectPoint=D,e.projectPointLocal=F,e.rotate=q,e.setAltitudeAt=k,e.setExtent=C,e.transform=j,e.up=Y,e.updateUnboundedPlane=x,e.wrap=b}))},"esri/core/ObjectStack":function(){define(["exports","./nextTick"],(function(e,t){"use strict";e.ObjectStack=class{constructor(e){this._allocator=e,this._items=[],this._itemsPtr=0,this._grow()}get(){return 0===this._itemsPtr&&t.nextTick((()=>this._reset())),this._itemsPtr===this._items.length&&this._grow(),this._items[this._itemsPtr++]}_reset(){const e=Math.min(3*Math.max(8,this._itemsPtr),this._itemsPtr+3072);this._items.length=Math.min(e,this._items.length),this._itemsPtr=0}_grow(){for(let e=0;e<Math.max(8,Math.min(this._items.length,1024));e++)this._items.push(this._allocator())}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/lineSegment":function(){define(["exports","../../core/mathUtils","../../core/ObjectStack","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","./vectorStacks"],(function(e,t,r,i,s,n){"use strict";function o(e){return e?{origin:s.clone(e.origin),vector:s.clone(e.vector)}:{origin:s.create(),vector:s.create()}}function a(e,t){const r=h.get();return r.origin=e,r.vector=t,r}function l(e,t,r=o()){return i.copy(r.origin,e),i.copy(r.vector,t),r}function c(e,r,s,o,a){const{vector:l,origin:c}=e,u=i.subtract(n.sv3d.get(),r,c),d=i.dot(l,u)/i.squaredLength(l);return i.scale(a,l,t.clamp(d,s,o)),i.add(a,a,e.origin)}function u(e,r,s,o){const a=1e-6,l=e.origin,c=i.add(n.sv3d.get(),l,e.vector),u=r.origin,d=i.add(n.sv3d.get(),u,r.vector),h=n.sv3d.get(),p=n.sv3d.get();if(h[0]=l[0]-u[0],h[1]=l[1]-u[1],h[2]=l[2]-u[2],p[0]=d[0]-u[0],p[1]=d[1]-u[1],p[2]=d[2]-u[2],Math.abs(p[0])<a&&Math.abs(p[1])<a&&Math.abs(p[2])<a)return!1;const m=n.sv3d.get();if(m[0]=c[0]-l[0],m[1]=c[1]-l[1],m[2]=c[2]-l[2],Math.abs(m[0])<a&&Math.abs(m[1])<a&&Math.abs(m[2])<a)return!1;const f=h[0]*p[0]+h[1]*p[1]+h[2]*p[2],g=p[0]*m[0]+p[1]*m[1]+p[2]*m[2],y=h[0]*m[0]+h[1]*m[1]+h[2]*m[2],_=p[0]*p[0]+p[1]*p[1]+p[2]*p[2],b=(m[0]*m[0]+m[1]*m[1]+m[2]*m[2])*_-g*g;if(Math.abs(b)<a)return!1;let v=(f*g-y*_)/b,S=(f+g*v)/_;s&&(v=t.clamp(v,0,1),S=t.clamp(S,0,1));const w=n.sv3d.get(),x=n.sv3d.get();return w[0]=l[0]+v*m[0],w[1]=l[1]+v*m[1],w[2]=l[2]+v*m[2],x[0]=u[0]+S*p[0],x[1]=u[1]+S*p[1],x[2]=u[2]+S*p[2],o.tA=v,o.tB=S,o.pA=w,o.pB=x,o.distance2=i.squaredDistance(w,x),!0}const d={tA:0,tB:0,pA:s.create(),pB:s.create(),distance2:0},h=new r.ObjectStack((()=>o()));e.closestLineSegmentPoint=function(e,t,r){return!!u(e,t,!0,d)&&(i.copy(r,d.pA),!0)},e.closestRayDistance2=function(e,t){if(u(e,a(t.origin,t.direction),!1,d)){const{tA:t,pB:r,distance2:s}=d;if(t>=0&&t<=1)return s;if(t<0)return i.squaredDistance(e.origin,r);if(t>1)return i.squaredDistance(i.add(n.sv3d.get(),e.origin,e.vector),r)}return null},e.copy=function(e,t=o()){return l(e.origin,e.vector,t)},e.create=o,e.distance2=function(e,r){const s=i.subtract(n.sv3d.get(),r,e.origin),o=i.dot(e.vector,s),a=i.dot(e.vector,e.vector),l=t.clamp(o/a,0,1),c=i.subtract(n.sv3d.get(),i.scale(n.sv3d.get(),e.vector,l),s);return i.dot(c,c)},e.fromPoints=function(e,t,r=o()){return i.copy(r.origin,e),i.subtract(r.vector,t,e),r},e.fromValues=l,e.pointAt=function(e,t,r){return i.add(r,e.origin,i.scale(r,e.vector,t))},e.projectPoint=function(e,t,r){return c(e,t,0,1,r)},e.projectPointClamp=c,e.wrap=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/vectorStacks":function(){define(["exports","../../core/VectorStack"],(function(e,t){"use strict";const r=t.VectorStack.createVec2f64(),i=t.VectorStack.createVec3f64(),s=t.VectorStack.createVec4f64(),n=t.VectorStack.createMat3f64(),o=t.VectorStack.createMat4f64(),a=t.VectorStack.createQuatf64();e.sm3d=n,e.sm4d=o,e.sq4d=a,e.sv2d=r,e.sv3d=i,e.sv4d=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/VectorStack":function(){define(["exports","./has","./nextTick","./libs/gl-matrix-2/factories/mat3f64","./libs/gl-matrix-2/factories/mat4f64","./libs/gl-matrix-2/factories/quatf64","./libs/gl-matrix-2/factories/vec2f64","./libs/gl-matrix-2/factories/vec3f64","./libs/gl-matrix-2/factories/vec4f64"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c{constructor(e){this._create=e,this._items=new Array,this._itemsPtr=0}get(){return 0===this._itemsPtr&&r.nextTick((()=>this._reset())),this._itemsPtr>=this._items.length&&this._items.push(this._create()),this._items[this._itemsPtr++]}_reset(){const e=2*this._itemsPtr;this._items.length>e&&(this._items.length=e),this._itemsPtr=0}static createVec2f64(){return new c(o.create)}static createVec3f64(){return new c(a.create)}static createVec4f64(){return new c(l.create)}static createMat3f64(){return new c(i.create)}static createMat4f64(){return new c(s.create)}static createQuatf64(){return new c(n.create)}get test(){}}e.VectorStack=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/libs/gl-matrix-2/factories/vec2f64":function(){define(["exports"],(function(e){"use strict";function t(){return[0,0]}function r(e){return[e[0],e[1]]}function i(e,t){return[e,t]}function s(e,t){return[e,t]}function n(e,t=[0,0]){const r=Math.min(2,e.length);for(let i=0;i<r;++i)t[i]=e[i];return t}function o(){return[0,0]}function a(){return i(1,1)}function l(){return i(1,0)}function c(){return i(0,1)}const u=[0,0],d=a(),h=l(),p=c(),m=Object.freeze(Object.defineProperty({__proto__:null,ONES:d,UNIT_X:h,UNIT_Y:p,ZEROS:u,clone:r,create:t,freeze:s,fromArray:n,fromValues:i,ones:a,unitX:l,unitY:c,zeros:o},Symbol.toStringTag,{value:"Module"}));e.ONES=d,e.UNIT_X=h,e.UNIT_Y=p,e.ZEROS=u,e.clone=r,e.create=t,e.freeze=s,e.fromArray=n,e.fromValues=i,e.ones=a,e.unitX=l,e.unitY=c,e.vec2f64=m,e.zeros=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/plane":function(){define(["exports","../../core/mathUtils","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../../chunks/vec42","./vector","./vectorStacks","../../views/3d/support/mathUtils"],(function(e,t,r,i,s,n,o,a){"use strict";function l(e=M){return[e[0],e[1],e[2],e[3]]}const c=s.exactEquals,u=s.equals;function d(e,t){return h(t[0],t[1],t[2],t[3],e)}function h(e,t,r,i,s=l()){return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}function p(e,t,r){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=Math.abs(i-1)>1e-5&&i>1e-12?1/Math.sqrt(i):1;return r[0]=t[0]*s,r[1]=t[1]*s,r[2]=t[2]*s,r[3]=-(r[0]*e[0]+r[1]*e[1]+r[2]*e[2]),r}function m(e,t,r,i=l()){const s=r[0]-t[0],n=r[1]-t[1],o=r[2]-t[2],a=e[0]-t[0],c=e[1]-t[1],u=e[2]-t[2],d=n*u-o*c,h=o*a-s*u,p=s*c-n*a,m=d*d+h*h+p*p,f=Math.abs(m-1)>1e-5&&m>1e-12?1/Math.sqrt(m):1;return i[0]=d*f,i[1]=h*f,i[2]=p*f,i[3]=-(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]),i}function f(e,t,i,s=0,n=Math.floor(i*(1/3)),o=Math.floor(i*(2/3))){if(i<3)return!1;t(y,s);let a=n,l=!1;for(;a<i-1&&!l;)t(_,a),a++,l=!r.exactEquals(y,_);if(!l)return!1;for(a=Math.max(a,o),l=!1;a<i&&!l;)t(b,a),a++,r.subtract(v,y,_),r.normalize(v,v),r.subtract(S,_,b),r.normalize(S,S),l=!r.exactEquals(y,b)&&!r.exactEquals(_,b)&&Math.abs(r.dot(v,S))<g;return l?(m(y,_,b,e),!0):(0!==s||1!==n||2!==o)&&f(e,t,i,0,1,2)}const g=.99619469809,y=i.create(),_=i.create(),b=i.create(),v=i.create(),S=i.create();function w(e,t,i){const s=r.scale(o.sv3d.get(),e,r.dot(e,t));return r.subtract(i,t,s),i}function x(e,t){return r.dot(e,t)+e[3]}var T;function C(t){return t===e.IntersectResult.INTERSECTS_INSIDE_OUT||t===e.IntersectResult.INTERSECTS_OUTSIDE_IN}function P(i,s,n,o,a){const l=r.dot(i,n),c=x(i,s);if(0===l)return c>=0?e.IntersectResult.INSIDE:e.IntersectResult.OUTSIDE;let u=-c/l;return o&e.IntersectFlags.CLAMP&&(u=t.clamp(u,0,1)),!(o&e.IntersectFlags.INFINITE_MIN)&&u<0||!(o&e.IntersectFlags.INFINITE_MAX)&&u>1?c>=0?e.IntersectResult.INSIDE:e.IntersectResult.OUTSIDE:(r.add(a,s,r.scale(a,n,u)),c>=0?e.IntersectResult.INTERSECTS_INSIDE_OUT:e.IntersectResult.INTERSECTS_OUTSIDE_IN)}e.IntersectResult=void 0,(T=e.IntersectResult||(e.IntersectResult={}))[T.INTERSECTS_INSIDE_OUT=0]="INTERSECTS_INSIDE_OUT",T[T.INTERSECTS_OUTSIDE_IN=1]="INTERSECTS_OUTSIDE_IN",T[T.INSIDE=2]="INSIDE",T[T.OUTSIDE=3]="OUTSIDE";const M=[0,0,1,0];var R;e.IntersectFlags=void 0,(R=e.IntersectFlags||(e.IntersectFlags={}))[R.NONE=0]="NONE",R[R.CLAMP=1]="CLAMP",R[R.INFINITE_MIN=4]="INFINITE_MIN",R[R.INFINITE_MAX=8]="INFINITE_MAX";const E=e.IntersectFlags.INFINITE_MIN|e.IntersectFlags.INFINITE_MAX,O=e.IntersectFlags.INFINITE_MAX;e.clip=function(e,t){const i=r.dot(e,t.ray.direction),s=-x(e,t.ray.origin);if(s<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return s>0;if((s<0||i<0)&&!(s<0&&i<0))return!0;const n=s/i;return i>0?n<t.c1&&(t.c1=n):n>t.c0&&(t.c0=n),t.c0<=t.c1},e.clipInfinite=function(e,t){const i=r.dot(e,t.ray.direction),s=-x(e,t.ray.origin);if(i>-1e-6&&i<1e-6)return s>0;const n=s/i;return i>0?n<t.c1&&(t.c1=n):n>t.c0&&(t.c0=n),t.c0<=t.c1},e.copy=d,e.create=l,e.distance=function(e,t){return Math.abs(x(e,t))},e.equals=u,e.exactEquals=c,e.fromArray=function(e,t,i=!0){const s=t.length/3;return f(e,((e,i)=>r.set(e,t[3*i+0],t[3*i+1],t[3*i+2])),i?s-1:s)},e.fromManyPoints=f,e.fromNormalAndOffset=function(e,t,i){return r.copy(i,e),i[3]=t,i},e.fromPoints=m,e.fromPositionAndNormal=p,e.fromValues=h,e.fromVectorsAndPoint=function(e,t,i,s){return r.cross(b,t,e),p(i,b,s)},e.getNormal=function(e){return e},e.intersectLine=function(e,t,i,s){return C(P(e,t,r.subtract(o.sv3d.get(),i,t),E,s))},e.intersectLineOrRay=P,e.intersectLineSegment=function(t,r,i){return C(P(t,r.origin,r.vector,e.IntersectFlags.NONE,i))},e.intersectLineSegmentClamp=function(t,r,i){return C(P(t,r.origin,r.vector,e.IntersectFlags.CLAMP,i))},e.intersectRay=function(e,t,r){return null!=t&&C(P(e,t.origin,t.direction,O,r))},e.isPointInside=function(e,t){return x(e,t)>=0},e.negate=function(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},e.projectPoint=function(e,t,i){const s=r.scale(o.sv3d.get(),e,-e[3]),n=w(e,r.subtract(o.sv3d.get(),t,s),o.sv3d.get());return r.add(i,n,s),i},e.projectPointLocal=function(e,t,i,s){const l=e,c=o.sv3d.get(),u=o.sv3d.get();a.tangentFrame(l,c,u);const d=r.subtract(o.sv3d.get(),i,t),h=n.projectPointSignedLength(c,d),p=n.projectPointSignedLength(u,d),m=n.projectPointSignedLength(l,d);return r.set(s,h,p,m)},e.projectVector=w,e.setOffsetFromPoint=function(e,t,i){return t!==e&&d(e,t),e[3]=-r.dot(e,i),e},e.signedDistance=x,e.up=M,e.wrap=function(e=M[0],t=M[1],r=M[2],i=M[3]){return h(e,t,r,i,o.sv4d.get())},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/vector":function(){define(["exports","../../core/mathUtils","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t,r,i){"use strict";const s=i.create(),n=i.create();e.angle=function(e,i){const s=r.dot(e,i)/(r.length(e)*r.length(i));return-t.acosClamped(s)},e.angleAroundAxis=function(e,i,o){r.normalize(s,e),r.normalize(n,i);const a=r.dot(s,n),l=t.acosClamped(a),c=r.cross(s,s,n);return r.dot(c,o)<0?2*Math.PI-l:l},e.projectPoint=function(e,t,i){const s=r.dot(e,t)/r.dot(e,e);return r.scale(i,e,s)},e.projectPointSignedLength=function(e,t){return r.dot(e,t)/r.length(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/mathUtils":function(){define(["exports","../../../core/mathUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t,r,i){"use strict";const s=i.create(),n=i.create(),o=i.create(),a=i.create(),l=i.create();e.angle=function(e,i,s){e=r.normalize(a,e),i=r.normalize(l,i);const n=t.acosClamped(r.dot(e,i));if(s){const t=r.cross(o,e,i);if(r.dot(t,s)<0)return-n}return n},e.bilerp=function(e,t,r,i,s,n){const o=e+(t-e)*s;return o+(r+(i-r)*s-o)*n},e.cosCapped=function(e,t){return e>t?Math.cos(t):Math.cos(e)},e.fovx2fovy=function(e,t,r){return 2*Math.atan(r*Math.tan(.5*e)/t)},e.fovy2fovx=function(e,t,r){return 2*Math.atan(t*Math.tan(.5*e)/r)},e.makeOrthonormal=function(e,t,i){i=i||e;const s=r.dot(e,t);r.set(i,e[0]-s*t[0],e[1]-s*t[1],e[2]-s*t[2]),r.normalize(i,i)},e.makePiecewiseLinearFunction=function(e){const t=e.length;return r=>{if(r<=e[0][0])return e[0][1];if(r>=e[t-1][0])return e[t-1][1];let i=1;for(;r>e[i][0];)i++;const s=e[i-1][0],n=e[i][0],o=(n-r)/(n-s);return o*e[i-1][1]+(1-o)*e[i][1]}},e.maxScale=function(e){const t=e[0]*e[0]+e[4]*e[4]+e[8]*e[8],r=e[1]*e[1]+e[5]*e[5]+e[9]*e[9],i=e[2]*e[2]+e[6]*e[6]+e[10]*e[10];return Math.sqrt(Math.max(t,r,i))},e.midpoint3d=function(e,t){if(r.set(t,0,0,0),e.length>0){for(let i=0;i<e.length;++i)r.add(t,t,e[i]);r.scale(t,t,1/e.length)}},e.planeFromPoints=function(e,t,i,o){r.subtract(s,t,e),r.subtract(n,i,e),r.cross(o,s,n),r.normalize(o,o),o[3]=-r.dot(e,o)},e.scaleFromMatrix=function(e,t){const i=Math.sqrt(t[0]*t[0]+t[4]*t[4]+t[8]*t[8]),s=Math.sqrt(t[1]*t[1]+t[5]*t[5]+t[9]*t[9]),n=Math.sqrt(t[2]*t[2]+t[6]*t[6]+t[10]*t[10]);return r.set(e,i,s,n),e},e.slerp=function(e,t,s,n=i.create()){const o=r.length(e),c=r.length(t),u=r.dot(e,t)/(o*c);if(u<.9999999999999999){const i=Math.acos(u),d=((1-s)*o+s*c)/Math.sin(i),h=d/o*Math.sin((1-s)*i),p=d/c*Math.sin(s*i);return r.scale(a,e,h),r.scale(l,t,p),r.add(n,a,l)}return r.lerp(n,e,t,s)},e.slerpTangent=function(e,t,s,n=i.create(),o=i.create()){const c=r.length(e),u=r.length(t),d=r.dot(e,t)/(c*u);if(d<.9999999999999999){const i=Math.acos(d),h=Math.sin(i),p=Math.sin(s*i),m=Math.sin((1-s)*i),f=(1-s)*c+s*u;{const i=f/h,s=i/c*m,o=i/u*p;r.scale(a,e,s),r.scale(l,t,o),r.add(n,a,l)}{const n=1/c*(-Math.cos((1-s)*i)*i*f+m*(-c+u));r.scale(a,e,n);const d=1/u*(Math.cos(s*i)*i*f+p*(-c+u));r.scale(l,t,d),r.add(o,a,l),r.scale(o,o,1/h)}return o}return r.lerp(n,e,t,s),r.subtract(o,t,e),r.normalize(o,o),o},e.tangentFrame=function(e,t,i){Math.abs(e[0])>Math.abs(e[1])?r.set(t,0,1,0):r.set(t,1,0,0),r.cross(i,e,t),r.cross(t,i,e),r.normalize(i,i),r.normalize(t,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/ray":function(){define(["exports","../../core/arrayUtils","../../core/ObjectStack","../../core/libs/gl-matrix-2/math/mat3","../../core/libs/gl-matrix-2/factories/mat3f64","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","./vectorStacks"],(function(e,t,r,i,s,n,o,a){"use strict";function l(e){return e?c(o.clone(e.origin),o.clone(e.direction)):c(o.create(),o.create())}function c(e,t){return{origin:e,direction:t}}function u(e,t,r=l()){return n.copy(r.origin,e),n.copy(r.direction,t),r}const d=new r.ObjectStack((()=>l())),h=o.create(),p=o.create(),m=o.create(),f=s.create();e.closestPoint=function(e,t,r){const i=n.dot(e.direction,n.subtract(r,t,e.origin));return n.add(r,e.origin,n.scale(r,e.direction,i)),r},e.closestPoints=function(e,t,r,s){const o=e.origin,a=t.origin,l=e.direction,c=t.direction,u=n.dot(n.normalize(p,l),n.normalize(m,c));if(Math.abs(u)>=1)return null;const d=n.cross(p,l,c),g=n.sub(h,a,o),y=i.set(f,l[0],l[1],l[2],-c[0],-c[1],-c[2],d[0],d[1],d[2]),_=i.invert(f,y);if(null==_)return[r,s];const b=n.dot(n.set(p,_[0],_[3],_[6]),g),v=n.dot(n.set(m,_[1],_[4],_[7]),g);return n.add(r,o,n.scale(h,l,b)),n.add(s,a,n.scale(h,c,v)),[r,s]},e.copy=function(e,t=l()){return u(e.origin,e.direction,t)},e.create=l,e.distance2=function(e,t){const r=n.cross(a.sv3d.get(),n.normalize(a.sv3d.get(),e.direction),n.subtract(a.sv3d.get(),t,e.origin));return n.dot(r,r)},e.equals=function(e,r){return t.equals(e.origin,r.origin)&&t.equals(e.direction,r.direction)},e.fromPoints=function(e,t,r=l()){return n.copy(r.origin,e),n.subtract(r.direction,t,e),r},e.fromValues=u,e.wrap=function(e,t){const r=d.get();return r.origin=e,r.direction=t,r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/libs/gl-matrix-2/math/mat3":function(){define(["exports","./common"],(function(e,t){"use strict";function r(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function i(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function s(e,t,r,i,s,n,o,a,l,c){return e[0]=t,e[1]=r,e[2]=i,e[3]=s,e[4]=n,e[5]=o,e[6]=a,e[7]=l,e[8]=c,e}function n(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function o(e,t){if(e===t){const r=t[1],i=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=i,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function a(e,t){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],d=u*o-a*c,h=-u*n+a*l,p=c*n-o*l;let m=r*d+i*h+s*p;return m?(m=1/m,e[0]=d*m,e[1]=(-u*i+s*c)*m,e[2]=(a*i-s*o)*m,e[3]=h*m,e[4]=(u*r-s*l)*m,e[5]=(-a*r+s*n)*m,e[6]=p*m,e[7]=(-c*r+i*l)*m,e[8]=(o*r-i*n)*m,e):null}function l(e,t){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8];return e[0]=o*u-a*c,e[1]=s*c-i*u,e[2]=i*a-s*o,e[3]=a*l-n*u,e[4]=r*u-s*l,e[5]=s*n-r*a,e[6]=n*c-o*l,e[7]=i*l-r*c,e[8]=r*o-i*n,e}function c(e){const t=e[0],r=e[1],i=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8];return t*(c*n-o*l)+r*(-c*s+o*a)+i*(l*s-n*a)}function u(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],d=t[8],h=r[0],p=r[1],m=r[2],f=r[3],g=r[4],y=r[5],_=r[6],b=r[7],v=r[8];return e[0]=h*i+p*o+m*c,e[1]=h*s+p*a+m*u,e[2]=h*n+p*l+m*d,e[3]=f*i+g*o+y*c,e[4]=f*s+g*a+y*u,e[5]=f*n+g*l+y*d,e[6]=_*i+b*o+v*c,e[7]=_*s+b*a+v*u,e[8]=_*n+b*l+v*d,e}function d(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],d=t[8],h=r[0],p=r[1];return e[0]=i,e[1]=s,e[2]=n,e[3]=o,e[4]=a,e[5]=l,e[6]=h*i+p*o+c,e[7]=h*s+p*a+u,e[8]=h*n+p*l+d,e}function h(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],d=t[8],h=Math.sin(r),p=Math.cos(r);return e[0]=p*i+h*o,e[1]=p*s+h*a,e[2]=p*n+h*l,e[3]=p*o-h*i,e[4]=p*a-h*s,e[5]=p*l-h*n,e[6]=c,e[7]=u,e[8]=d,e}function p(e,t,r){const i=r[0],s=r[1],n=r[2];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=n*t[6],e[7]=n*t[7],e[8]=n*t[8],e}function m(e,t,r){const i=r[0],s=r[1];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e}function f(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e}function g(e,t){const r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=-r,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function y(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function _(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e}function b(e,t){const r=t[0],i=t[1],s=t[2],n=t[3],o=r+r,a=i+i,l=s+s,c=r*o,u=i*o,d=i*a,h=s*o,p=s*a,m=s*l,f=n*o,g=n*a,y=n*l;return e[0]=1-d-m,e[3]=u-y,e[6]=h+g,e[1]=u+y,e[4]=1-c-m,e[7]=p-f,e[2]=h-g,e[5]=p+f,e[8]=1-c-d,e}function v(e,t){const r=t[0],i=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],u=t[10],d=u*o-a*c,h=-u*n+a*l,p=c*n-o*l,m=r*d+i*h+s*p;if(!m)return null;const f=1/m;return e[0]=d*f,e[1]=(-u*i+s*c)*f,e[2]=(a*i-s*o)*f,e[3]=h*f,e[4]=(u*r-s*l)*f,e[5]=(-a*r+s*n)*f,e[6]=p*f,e[7]=(-c*r+i*l)*f,e[8]=(o*r-i*n)*f,e}function S(e,t){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],d=t[9],h=t[10],p=t[11],m=t[12],f=t[13],g=t[14],y=t[15],_=r*a-i*o,b=r*l-s*o,v=r*c-n*o,S=i*l-s*a,w=i*c-n*a,x=s*c-n*l,T=u*f-d*m,C=u*g-h*m,P=u*y-p*m,M=d*g-h*f,R=d*y-p*f,E=h*y-p*g;let O=_*E-b*R+v*M+S*P-w*C+x*T;return O?(O=1/O,e[0]=(a*E-l*R+c*M)*O,e[1]=(l*P-o*E-c*C)*O,e[2]=(o*R-a*P+c*T)*O,e[3]=(s*R-i*E-n*M)*O,e[4]=(r*E-s*P+n*C)*O,e[5]=(i*P-r*R-n*T)*O,e[6]=(f*x-g*w+y*S)*O,e[7]=(g*v-m*x-y*b)*O,e[8]=(m*w-f*v+y*_)*O,e):null}function w(e,t,r){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/r,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e}function x(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}function T(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+e[6]**2+e[7]**2+e[8]**2)}function C(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e}function P(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e}function M(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e}function R(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e[6]=t[6]+r[6]*i,e[7]=t[7]+r[7]*i,e[8]=t[8]+r[8]*i,e}function E(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]}function O(e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],u=e[7],d=e[8],h=r[0],p=r[1],m=r[2],f=r[3],g=r[4],y=r[5],_=r[6],b=r[7],v=r[8],S=t.getEpsilon();return Math.abs(i-h)<=S*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(s-p)<=S*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(n-m)<=S*Math.max(1,Math.abs(n),Math.abs(m))&&Math.abs(o-f)<=S*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(a-g)<=S*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(l-y)<=S*Math.max(1,Math.abs(l),Math.abs(y))&&Math.abs(c-_)<=S*Math.max(1,Math.abs(c),Math.abs(_))&&Math.abs(u-b)<=S*Math.max(1,Math.abs(u),Math.abs(b))&&Math.abs(d-v)<=S*Math.max(1,Math.abs(d),Math.abs(v))}function A(e){const r=t.getEpsilon(),i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],u=e[7],d=e[8];return Math.abs(1-(i*i+o*o+c*c))<=r&&Math.abs(1-(s*s+a*a+u*u))<=r&&Math.abs(1-(n*n+l*l+d*d))<=r}const I=u,D=P,F=Object.freeze(Object.defineProperty({__proto__:null,add:C,adjoint:l,copy:i,determinant:c,equals:O,exactEquals:E,frob:T,fromMat2d:_,fromMat4:r,fromQuat:b,fromRotation:g,fromScaling:y,fromTranslation:f,identity:n,invert:a,isOrthoNormal:A,mul:I,multiply:u,multiplyScalar:M,multiplyScalarAndAdd:R,normalFromMat4:S,normalFromMat4Legacy:v,projection:w,rotate:h,scale:p,scaleByVec2:m,set:s,str:x,sub:D,subtract:P,translate:d,transpose:o},Symbol.toStringTag,{value:"Module"}));e.add=C,e.adjoint=l,e.copy=i,e.determinant=c,e.equals=O,e.exactEquals=E,e.frob=T,e.fromMat2d=_,e.fromMat4=r,e.fromQuat=b,e.fromRotation=g,e.fromScaling=y,e.fromTranslation=f,e.identity=n,e.invert=a,e.isOrthoNormal=A,e.mat3=F,e.mul=I,e.multiply=u,e.multiplyScalar=M,e.multiplyScalarAndAdd=R,e.normalFromMat4=S,e.normalFromMat4Legacy=v,e.projection=w,e.rotate=h,e.scale=p,e.scaleByVec2=m,e.set=s,e.str=x,e.sub=D,e.subtract=P,e.translate=d,e.transpose=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/sphere":function(){define(["exports","../core/has","../core/Logger","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","./vec42","../core/libs/gl-matrix-2/factories/vec4f64","../core/libs/gl-matrix-2/math/common","../geometry/support/Axis","../geometry/support/ray","../geometry/support/sphereUtils","../geometry/support/vector","../geometry/support/vectorStacks"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";const f=g();function g(){return l.create()}const y=a.equals,_=a.equals;function b(e,t){return a.copy(t,e)}function v(e,t){return l.fromValues(e[0],e[1],e[2],t)}function S(e){return e}function w(e){e[0]=e[1]=e[2]=e[3]=0}function x(e,t){return e[0]=e[1]=e[2]=0,e[3]=t,e}function T(e){return e[3]}function C(e){return e}function P(e,t,r,i){return l.fromValues(e,t,r,i)}function M(e,t,r){return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2]),r[3]=e[3]+t,r}function R(e,t,r){return e!==r&&b(e,r),r}function E(e,t){return t}function O(e,t,r){if(null==t)return!1;if(!D(e,t,I))return!1;let{t0:i,t1:s}=I;if((i<0||s<i&&s>0)&&(i=s),i<0)return!1;if(r){const{origin:e,direction:s}=t;r[0]=e[0]+s[0]*i,r[1]=e[1]+s[1]*i,r[2]=e[2]+s[2]*i}return!0}function A(e,t,r){const i=d.fromPoints(t,r);if(!D(e,i,I))return[];const{origin:s,direction:a}=i,{t0:l,t1:u}=I,h=t=>{const r=o.create();return n.scaleAndAdd(r,s,a,t),G(e,r,r)};return Math.abs(l-u)<c.getEpsilon()?[h(l)]:[h(l),h(u)]}const I={t0:0,t1:0};function D(e,t,r){const{origin:i,direction:s}=t,n=F;n[0]=i[0]-e[0],n[1]=i[1]-e[1],n[2]=i[2]-e[2];const o=s[0]*s[0]+s[1]*s[1]+s[2]*s[2];if(0===o)return!1;const a=2*(s[0]*n[0]+s[1]*n[1]+s[2]*n[2]),l=a*a-4*o*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-e[3]*e[3]);if(l<0)return!1;const c=Math.sqrt(l);return r.t0=(-a-c)/(2*o),r.t1=(-a+c)/(2*o),!0}const F=o.create();function L(e,t){return O(e,t,null)}function N(e,t,r){if(O(e,t,r))return r;const i=U(e,t,m.sv3d.get());return n.add(r,t.origin,n.scale(m.sv3d.get(),t.direction,n.distance(t.origin,i)/n.length(t.direction))),r}function U(e,t,r){const i=m.sv3d.get(),o=m.sm4d.get();n.cross(i,t.origin,t.direction);const a=T(e);n.cross(r,i,t.origin),n.scale(r,r,1/n.length(r)*a);const l=z(e,t.origin),c=p.angle(t.origin,r);return s.fromRotation(o,c+l,i),n.transformMat4(r,r,o),r}function V(e,t,r,i){const s=T(e),n=s*s,o=t+.5*Math.PI,a=r*r+n-2*Math.cos(o)*r*s,l=Math.sqrt(a),c=a-n;if(c<=0)return.5;const u=Math.sqrt(c),d=Math.acos(u/l)-Math.asin(s/(l/Math.sin(o)));return Math.min(1,(d+.5*i)/i)}function B(e,t,r){return O(e,t,r)?r:(d.closestPoint(t,e,r),G(e,r,r))}function G(e,t,r){const i=n.subtract(m.sv3d.get(),t,e),s=n.scale(m.sv3d.get(),i,e[3]/n.length(i));return n.add(r,s,e)}function k(e,t){const r=n.subtract(m.sv3d.get(),t,e),i=n.squaredLength(r),s=e[3]*e[3];return Math.sqrt(Math.abs(i-s))}function z(e,t){const r=n.subtract(m.sv3d.get(),t,e),s=n.length(r),o=T(e),a=o+Math.abs(o-s);return i.acosClamped(o/a)}const j=o.create();function q(e,t,r,i){const s=n.subtract(j,t,e);switch(r){case u.Axis.X:{const e=h.cartesianToSpherical(s,j)[2];return n.set(i,-Math.sin(e),Math.cos(e),0)}case u.Axis.Y:{const e=h.cartesianToSpherical(s,j),t=e[1],r=e[2],o=Math.sin(t);return n.set(i,-o*Math.cos(r),-o*Math.sin(r),Math.cos(t))}case u.Axis.Z:return n.normalize(i,s);default:return}}function H(e,t){const r=n.subtract(Z,t,e);return n.length(r)-e[3]}function W(e,t,r,i){const s=H(e,t),o=q(e,t,u.Axis.Z,Z),a=n.scale(Z,o,r-s);return n.add(i,t,a)}function $(e,t){const r=n.squaredDistance(e,t),i=T(e);return r<=i*i}function Q(e,t,r=l.create()){const i=n.distance(e,t),s=e[3],o=t[3];return i+o<s?(a.copy(r,e),r):i+s<o?(a.copy(r,t),r):(n.lerp(r,e,t,(i+o-s)/(2*i)),r[3]=(i+s+o)/2,r)}const Z=o.create(),Y=g(),X=Object.freeze(Object.defineProperty({__proto__:null,NullSphere:f,altitudeAt:H,angleToSilhouette:z,axisAt:q,cameraFrustumCoverage:V,clear:w,closestPoint:B,closestPointOnSilhouette:U,containsPoint:$,copy:b,create:g,distanceToSilhouette:k,elevate:M,equals:_,exactEquals:y,fromCenterAndRadius:v,fromRadius:x,fromValues:P,getCenter:C,getExtent:E,getRadius:T,intersectLine:A,intersectRay:O,intersectRayClosestSilhouette:N,intersectsRay:L,projectPoint:G,setAltitudeAt:W,setExtent:R,tmpSphere:Y,union:Q,wrap:S},Symbol.toStringTag,{value:"Module"}));e.NullSphere=f,e.altitudeAt=H,e.angleToSilhouette=z,e.axisAt=q,e.cameraFrustumCoverage=V,e.clear=w,e.closestPoint=B,e.closestPointOnSilhouette=U,e.containsPoint=$,e.copy=b,e.create=g,e.distanceToSilhouette=k,e.elevate=M,e.equals=_,e.exactEquals=y,e.fromCenterAndRadius=v,e.fromRadius=x,e.fromValues=P,e.getCenter=C,e.getExtent=E,e.getRadius=T,e.intersectLine=A,e.intersectRay=O,e.intersectRayClosestSilhouette=N,e.intersectsRay=L,e.projectPoint=G,e.setAltitudeAt=W,e.setExtent=R,e.sphere=X,e.tmpSphere=Y,e.union=Q,e.wrap=S}))},"esri/geometry/support/sphereUtils":function(){define(["exports","../../core/mathUtils","../../chunks/vec32"],(function(e,t,r){"use strict";e.cartesianToSpherical=function(e,i){const s=r.length(e),n=t.asinClamped(e[2]/s),o=Math.atan2(e[1]/s,e[0]/s);return r.set(i,s,n,o),i},e.sphericalToCartesian=function(e,t){const i=e[0],s=e[1],n=e[2],o=Math.cos(s);r.set(t,i*o*Math.cos(n),i*o*Math.sin(n),i*Math.sin(s))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/support/tagSymbols":function(){define(["exports"],(function(e){"use strict";const t=Symbol("WebScene");e.WebSceneTag=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/BreakpointsOwner":function(){define(["exports","../chunks/tslib.es6","../core/ArrayPool","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a,l){"use strict";const c={widthBreakpoint:{getValue(e){const t=e.viewSize[0],r=e.breakpoints,i=this.values;return t<=r.xsmall?i.xsmall:t<=r.small?i.small:t<=r.medium?i.medium:t<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],r=e.breakpoints,i=this.values;return t<=r.xsmall?i.xsmall:t<=r.small?i.small:t<=r.medium?i.medium:t<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,r=t[0],i=t[1],s=this.values;return i>=r?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},u={xsmall:544,small:768,medium:992,large:1200};function d(e,t){return t?c[e].valueToClassName[t].split(" "):[]}e.BreakpointsOwner=e=>{let n=class extends e{constructor(...e){super(...e),this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=u}initialize(){this.addHandles(i.watch((()=>[this.breakpoints,this.size]),(()=>this._updateClassNames()),i.initial))}destroy(){this.destroyed||this._removeActiveClassNames()}set breakpoints(e){if(e!==this._get("breakpoints")){if(!function(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}(e)){const t=JSON.stringify(u,null,2);console.warn("provided breakpoints are not valid, using defaults:"+t),e=u}this._set("breakpoints",{...e})}}_updateClassNames(){if(!this.container)return;const e=r.acquire(),t=r.acquire();let i,s=!1;for(i in c){const r=this[i],n=c[i].getValue({viewSize:this.size,breakpoints:this.breakpoints});r!==n&&(s=!0,this[i]=n,d(i,r).forEach((e=>t.push(e))),d(i,n).forEach((t=>e.push(t))))}s&&(this._applyClassNameChanges(e,t),r.release(e),r.release(t))}_applyClassNameChanges(e,t){const r=this.container;r&&(t.forEach((e=>r.classList.remove(e))),e.forEach((e=>r.classList.add(e))))}_removeActiveClassNames(){const e=this.container;if(!e)return;let t;for(t in c)d(t,this[t]).forEach((t=>e.classList.remove(t)))}};return t.__decorate([s.property()],n.prototype,"breakpoints",null),t.__decorate([s.property()],n.prototype,"orientation",void 0),t.__decorate([s.property()],n.prototype,"widthBreakpoint",void 0),t.__decorate([s.property()],n.prototype,"heightBreakpoint",void 0),n=t.__decorate([l.subclass("esri.views.BreakpointsOwner")],n),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/DOMContainer":function(){define(["exports","../chunks/tslib.es6","../core/domUtils","../core/events","../core/handleUtils","../core/Logger","../core/maybe","../core/reactiveUtils","../core/scheduling","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./overlay/ViewOverlay"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const m=[0,0];function f(e){const t=(e.ownerDocument||window.document).defaultView,r=e.getBoundingClientRect();return m[0]=r.left+(t?.pageXOffset??0),m[1]=r.top+(t?.pageYOffset??0),m}function g(e){e&&(e.textContent="",e.parentNode&&e.parentNode.removeChild(e))}const y=16,_=750;e.DOMContainer=e=>{let u=class extends e{constructor(...e){super(...e),this._freqInfo={freq:y,time:_},this._overlayRenderTaskHandle=null,this.height=0,this.messagesCommon=null,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.addHandles([a.watch((()=>this.cursor),(e=>{const{surface:t}=this;t&&t.setAttribute("data-cursor",e)})),a.watch((()=>this.navigating),(e=>{const{surface:t}=this;t&&t.setAttribute("data-navigating",e.toString())}))])}initialize(){this.addHandles([a.watch((()=>this.ui),((e,t)=>this._handleUIChange(e,t)),a.initial),this.on("focus",(()=>this.notifyChange("focused"))),this.on("blur",(()=>this.notifyChange("focused")))])}destroy(){this.destroyed||(this.ui?.destroy(),this.container=null)}get container(){return this._get("container")??null}set container(e){const t=this._get("container"),i=r.byId(e);if(i||"string"!=typeof e||n.getLogger(this).error("#container",`element with id '${e}' not found`),t===i)return;if(this._stopMeasuring(),t&&(t.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(g(this.root),this._set("root",null)),this.userContent&&(r.reparent(this.userContent,t),g(this.userContent),this._set("userContent",null))),!i)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);i.classList.add("esri-view");const s=document.createElement("div");s.className="esri-view-user-storage",r.reparent(i,s),i.appendChild(s),this._set("userContent",s);const c=document.createElement("div");c.className="esri-view-root",i.insertBefore(c,i.firstChild),this._set("root",c);const u=document.createElement("div");u.className="esri-view-surface",u.setAttribute("role","application"),u.tabIndex=0,c.appendChild(u),this._set("surface",u);const d=new p;c.appendChild(d.surface),this._set("overlay",d),this.addHandles(a.watch((()=>d.needsRender),(e=>{e&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=l.addFrameTask({render:()=>this.overlay?.render()}):this._overlayRenderTaskHandle=o.removeMaybe(this._overlayRenderTaskHandle)}))),this.forceDOMReadyCycle(),this._set("container",i),this._startMeasuring()}get focused(){const e=document.activeElement===this.surface;return document.hasFocus()&&e}get size(){return[this.width,this.height]}set ui(e){const t=this._get("ui");t!==e&&t?.destroy(),this._set("ui",e)}blur(){this.surface?.blur()}focus(){this.surface?.focus()}pageToContainer(e,t,r){const i=this.position;return e-=i?i[0]:0,t-=i?i[1]:0,r?(r[0]=e,r[1]=t):r=[e,t],r}containerToPage(e,t,r){const i=this.position;return e+=i?i[0]:0,t+=i?i[1]:0,r?(r[0]=e,r[1]=t):r=[e,t],r}_handleUIChange(e,t){this.removeHandles("ui"),t&&t!==e&&t.destroy(),e&&(e.view=this,this.addHandles(a.watch((()=>this.root),(t=>{e.container=t?function(e){const t=document.createElement("div");return e.appendChild(t),t}(t):null}),a.initial),"ui")),this._set("ui",e)}_stopMeasuring(){this.removeHandles("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const e=this._freqInfo;e.freq=y,e.time=_;const t=l.addFrameTask({prepare:e=>{const r=this._measure(),i=this._freqInfo;if(i.time+=e.deltaTime,r&&(i.freq=y,this._get("resizing")||this._set("resizing",!0)),i.time<i.freq)return;i.time=0;const s=this._position();i.freq=s||r?y:Math.min(_,2*i.freq),!r&&i.freq>=512&&(t.pause(),this._get("resizing")&&this._set("resizing",!1))}}),r=new ResizeObserver((r=>{e.freq=y,e.time=_,t.resume()}));null!=this.container&&r.observe(this.container);const n=s.makeHandle((()=>r.disconnect()));this.addHandles([i.on(window,"resize",(()=>{e.freq=y,e.time=_,t.resume()})),n,t],"measuring"),this._measure(),this._position()}_measure(){const e=this.container,t=e?e.clientWidth:0,r=e?e.clientHeight:0;if(0===t||0===r)return this.suspended||this._set("suspended",!0),!1;const i=this.width,s=this.height;return t===i&&r===s?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",t),this._set("height",r),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:i,oldHeight:s,width:t,height:r}),!0)}_position(){const e=this.container,t=this.position,r=e&&f(e);return!(!r||t&&r[0]===t[0]&&r[1]===t[1]||(this._set("position",[r[0],r[1]]),0))}forceDOMReadyCycle(){}};return t.__decorate([c.property()],u.prototype,"container",null),t.__decorate([c.property({readOnly:!0})],u.prototype,"focused",null),t.__decorate([c.property({readOnly:!0})],u.prototype,"height",void 0),t.__decorate([c.property()],u.prototype,"messagesCommon",void 0),t.__decorate([c.property({type:p})],u.prototype,"overlay",void 0),t.__decorate([c.property({readOnly:!0})],u.prototype,"position",void 0),t.__decorate([c.property({readOnly:!0})],u.prototype,"resizing",void 0),t.__decorate([c.property({readOnly:!0})],u.prototype,"root",void 0),t.__decorate([c.property({value:null,readOnly:!0})],u.prototype,"size",null),t.__decorate([c.property({readOnly:!0})],u.prototype,"surface",void 0),t.__decorate([c.property({readOnly:!0})],u.prototype,"suspended",void 0),t.__decorate([c.property({nonNullable:!0})],u.prototype,"ui",null),t.__decorate([c.property({readOnly:!0})],u.prototype,"userContent",void 0),t.__decorate([c.property({readOnly:!0})],u.prototype,"width",void 0),t.__decorate([c.property()],u.prototype,"widthBreakpoint",void 0),u=t.__decorate([h.subclass("esri.views.DOMContainer")],u),u},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/overlay/ViewOverlay":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/Collection","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../libs/maquette/projection","../../libs/maquette/projector"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";let d=class extends t{constructor(){super(...arguments),this.items=new r,this._watchUpdatingTracking=new l.UpdatingHandles,this._callbacks=new Map,this._projector=u.createProjector(),this._hiddenProjector=u.createProjector()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange((()=>this.items),(e=>{for(const t of e.added){const e=()=>t.render();this._callbacks.set(t,e),this._projector.append(this.surface,e)}for(const t of e.removed){const e=this._projector.detach(this._callbacks.get(t));this.surface.removeChild(e.domNode),this._callbacks.delete(t)}}))}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach((e=>this._projector.detach(e))),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,r=this._hiddenProjector;let i;const s=()=>(i=e.render(),i);r.append(t,s),r.renderNow();const n={left:0,top:0,right:0,bottom:0};if(i?.domNode){const e=i.domNode.getBoundingClientRect();n.left=e.left,n.top=e.top,n.right=e.right,n.bottom=e.bottom}for(r.detach(s);t.firstChild;)t.removeChild(t.firstChild);return n}overlaps(e,t){const r=this.computeBoundingRect(e),i=this.computeBoundingRect(t);return Math.max(r.left,i.left)<=Math.min(r.right,i.right)&&Math.max(r.top,i.top)<=Math.min(r.bottom,i.bottom)}get hasVisibleItems(){return this.items.some((e=>e.visible))}async prepare(){await document.fonts.load(this._fontString()).catch((()=>{}))}renderCanvas(e,t){const r=!!t?.disableDecorations;if(!this.items.some((e=>e.visible&&!(r&&e.isDecoration))))return;const i=e.getContext("2d");i.save(),i.font=this._fontString(),this.items.forEach((e=>{r&&e.isDecoration||(i.save(),e.renderCanvas(i),i.restore())})),i.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};return e.__decorate([i.property({readOnly:!0})],d.prototype,"surface",void 0),e.__decorate([i.property({readOnly:!0})],d.prototype,"items",void 0),e.__decorate([i.property({readOnly:!0})],d.prototype,"needsRender",null),e.__decorate([i.property({readOnly:!0})],d.prototype,"_watchUpdatingTracking",void 0),e.__decorate([i.property({readOnly:!0})],d.prototype,"updating",null),d=e.__decorate([a.subclass("esri.views.overlay.ViewOverlay")],d),d}))},"esri/views/GroundView":function(){define(["../chunks/tslib.es6","../core/Accessor","../core/Collection","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./3d/support/cameraUtils","./support/GroundViewElevationSampler"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";let d=class extends t{constructor(e){super(e),this.view=null,this.layerViews=new r}initialize(){this.addHandles(i.when((()=>this.view?.map?.ground),(e=>e.load())))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return"2d"!==this.view?.type&&this.view?.ready&&this.view?.basemapTerrain?.ready?new u({view:this.view}):null}get extent(){const e=this.view;return e&&"2d"!==e.type&&e.ready?c.toExtent(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some((e=>e.updating))}get suspended(){return this.view?.suspended??!0}};return e.__decorate([s.property({readOnly:!0})],d.prototype,"elevationSampler",null),e.__decorate([s.property({readOnly:!0})],d.prototype,"extent",null),e.__decorate([s.property({type:Boolean,readOnly:!0})],d.prototype,"updating",null),e.__decorate([s.property({constructOnly:!0})],d.prototype,"view",void 0),e.__decorate([s.property({type:r,readOnly:!0})],d.prototype,"layerViews",void 0),e.__decorate([s.property({readOnly:!0})],d.prototype,"suspended",null),d=e.__decorate([l.subclass("esri.views.GroundView")],d),d}))},"esri/views/3d/support/cameraUtils":function(){define(["exports","../../../Camera","../../../core/Cyclical","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/Point","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToPoint","../../../geometry/projection/projectVectorToVector","../../ViewingMode","../camera/intersectionUtils","../../../chunks/cameraUtilsPlanar","../../../chunks/cameraUtilsSpherical","./earthUtils","./ElevationProvider","../../support/spatialReferenceSupport"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S){"use strict";const w=()=>i.getLogger("esri.views.3d.support.cameraUtils"),x=96*39.37,T={heading:0,tilt:0},C=a.create(),P=new r.Cyclical(-20037508.342788905,20037508.342788905),M=new r.Cyclical(-180,180);var R;function E(e){return e.spatialReference??d.WGS84}function O({state:e}){return e.isGlobal?_.cameraUtilsSpherical:y.cameraUtilsPlanar}function A(e,t){if(null==t)return null;const r=e.renderSpatialReference,i=O(e).headingTiltToDirectionUp,n=a.create();if(!h.projectPointToVector(t.position,n,r))return null;const l=i(n,t.heading,t.tilt);o.scale(l.direction,l.direction,e.state.camera.distance),o.add(l.direction,l.direction,n);const c=g.cameraOnContentAlongViewDirection(e,n,l.direction,l.up);return c.fov=s.deg2rad(t.fov),c.row=t.layout.row,c.rows=t.layout.rows,c.column=t.layout.column,c.columns=t.layout.columns,c}e.OrientationMode=void 0,(R=e.OrientationMode||(e.OrientationMode={}))[R.LOCKED=0]="LOCKED",R[R.ADJUST=1]="ADJUST";const I=a.create();function D(e,t){const{camera:r}=e.state,{unitInMeters:i}=e.renderCoordsHelper;return t/=i,r.width/2/r.pixelRatio/(x/t)/Math.tan(r.fovX/2)}function F(e,t){const{camera:r}=e.state,{unitInMeters:i}=e.renderCoordsHelper,s=t*Math.tan(r.fovX/2),n=r.width/2/r.pixelRatio;return x/(n/s)*i}function L(e,t,r,i){const s=i.levelAtScale(t),n=U(G(e,r.eye,r.viewForward,r.up).tilt),o=Math.max(s-n,0);return i.scaleAtLevel(o)}function N(e,t,r){const i=r.levelAtScale(e),s=U(t);return r.scaleAtLevel(i+s)}function U(e){return 2*((e>90?180-e:e)/90)**2}function V(e,t,r=0){const i=A(e,t);return i?function(e,t,r=0){const i=e.basemapTerrain?.tilingScheme;if(!i)return 0;const s=l.getReferenceEllipsoid(e.spatialReference).radius,n=e.state.viewingMode===f.ViewingMode.Local?t.eye[2]:o.length(t.eye)-s;return L(e,F(e,Math.abs(n-r)),t,i)}(e,i,r):0}async function B(e,t,r,i,s,o){const a=await j(e,i.heading,i.tilt,t,r,s,o);return n.throwIfAborted(o),re(e,a,i.fov,o)}function G(e,t,r,i,s){return O(e).directionToHeadingTilt(t,r,i,s)}function k(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,C,e.spatialReference)&&e.elevationProvider&&(v.getElevationAtPoint(e.elevationProvider,C)??0)>C[2]-1)}function z(e,t,r,i,s,n){const l=i instanceof c?i:null,u=function(e,t){const r=a.create();if(null==t)return o.copy(r,e.state.camera.center);if(t instanceof c){if(!h.projectPointToVector(t,r,e.renderSpatialReference))return null;const{basemapTerrain:i,elevationProvider:s}=e;if(null==t.z&&null!=i&&null!=s){const i=v.getElevationAtPoint(s,t);null!=i&&e.renderCoordsHelper.setAltitude(r,i)}return r}return o.copy(r,t)}(e,i);return q(e,t,r,l,u,s,n)}async function j(e,t,r,i,s,l,u){const d=i instanceof c?i:null,p=await async function(e,t,r){const i=a.create();if(null==t)return o.copy(i,e.state.camera.center);if(t instanceof c){const{renderSpatialReference:s,basemapTerrain:o,elevationProvider:a}=e,l=t.spatialReference;if(await h.projectPointToVectorAsync(t,i,s,0,{signal:r}),n.throwIfAborted(r),null==t.z&&null!=o&&null!=a){const s=await a.queryElevation(t.x,t.y,t.z??0,l,"ground",r);n.throwIfAborted(r),null!=s&&e.renderCoordsHelper.setAltitude(i,s)}return i}return o.copy(i,t)}(e,i,u);return n.throwIfAborted(u),H(e,t,r,d,p,s,l,u)}function q(e,t,r,i,s,n,o){if(null==s)return null;if(!i&&(i=new c({spatialReference:E(e)}),!p.projectVectorToPoint(s,e.renderSpatialReference,i)))return null;const a=W(e,t,r,s,n,o);if($(e,r,o)&&k(e,a.eye)){const{tilt:o,mode:a}=Q(e,r,s,n);return q(e,t,o,i,s,n,a)}return Z(a,s)}async function H(e,t,r,i,s,o,a,l){i||(i=new c({spatialReference:E(e)}),await p.projectVectorToPointAsync(s,e.renderSpatialReference,i,{signal:l})||(i=null)),n.throwIfAborted(l);const u=W(e,t,r,s,o,a);if($(e,r,a)&&await async function(e,t,r){if(k(e,t))return!0;const{elevationProvider:i,spatialReference:s,renderCoordsHelper:o}=e;if(null==i||!o.fromRenderCoords(t,C,s))return!1;const[a,l,c]=C,u=await i.queryElevation(a,l,c,s,"ground",r)??0;return n.throwIfAborted(r),u>c-1}(e,u.eye,l)){n.throwIfAborted(l);const{tilt:a,mode:c}=Q(e,r,s,o);return H(e,t,a,i,s,o,c,l)}return Z(u,s)}function W(t,r,i,s,n,a){const l=function(t,r,i,s,n,a){let l=0;return a===e.OrientationMode.ADJUST&&function(e,t,r){const i=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/i)/Math.LN2>8)return!0;const s=t,n=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return o.distance(s,n)/(Math.tan(.5*e.state.camera.fov)*i)>5}(t,s,n)?(r=0,l=function(e,t,r,i){const s=ee(e,i,t,r);if(!e.state.constraints.tilt)return s;const n=e.state.constraints.tilt(t);n.max=Math.min(n.max,.5*Math.PI);const o=n.min*(1-K)+n.max*K;return Math.min(s,o)}(t,n,i,s)):l=ee(t,s,n,i),l=t.state.constraints.clampTilt(n,l),{heading:r,tilt:i=J(t,s,n,l)}}(t,r,i,s,n=Math.max(n,t.state.constraints.minimumPoiDistance),a);return(0,O(t).eyeForCenterWithHeadingTilt)(s,n,l.heading,l.tilt)}function $(t,r,i){const s=t.map.ground.navigationConstraint;return i===e.OrientationMode.ADJUST&&t.state.isGlobal&&r>0&&(null==s||"stay-above"===s.type)}function Q(t,r,i,s){const n=J(t,i,s,function(e,t,r,i){let s=ee(e,i,t,r);if(!e.state.constraints.tilt)return s;const n=e.state.constraints.tilt(t);return s=Math.min(s,.5*Math.PI),n.min*(1-K)+s*K}(t,s,r,i));return{tilt:n,mode:r-n<1?e.OrientationMode.LOCKED:e.OrientationMode.ADJUST}}function Z(e,t){return{...e,center:a.clone(t)}}function Y(e,t){const{state:r,spatialReference:i}=e,s=t.spatialReference;return r.isGlobal&&S.isSpatialReferenceSupported(s,f.ViewingMode.Global)||r.isLocal&&i.equals(s)}function X(e,t){let r,i,s;if(e.state.isGlobal){const e=new c(t.xmin,t.ymin,t.spatialReference),n=new c(t.xmax,t.ymax,t.spatialReference),o=t.spatialReference.isGeographic?M:P;r=new c({x:o.center(e.x,n.x),y:(n.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const a=l.getReferenceEllipsoid(t.spatialReference),u=b.getGreatCircleSpanAt(r,e,n);i=u.lon,s=u.lat,o.diff(e.x,n.x)>o.range/2&&(i+=a.halfCircumference),i=Math.min(i,a.halfCircumference),s=Math.min(s,a.halfCircumference)}else{const n=e.renderSpatialReference??t.spatialReference;n.equals(t.spatialReference)||(t=u.project(t,n)),i=t.xmax-t.xmin,s=t.ymax-t.ymin;const o=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;r=new c({x:t.xmin+.5*i,y:t.ymin+.5*s,z:o,spatialReference:n})}const n=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,o=e.state.camera,a=1/Math.tan(o.fovX/2),d=1/Math.tan(o.fovY/2),h=1/Math.tan(o.fov/2);return{center:r,distance:Math.max(.5*i*a,.5*s*d,.5*n*h)/1}}const K=.7;function J(e,t,r,i){return O(e).lookAtTiltToEyeTilt(i,t,r)}function ee(e,t,r,i){return O(e).eyeTiltToLookAtTilt(i,t,r)}function te(e,r,i,s){if(null==r)return null;const n=e.renderSpatialReference,o=new c({spatialReference:E(e)});return p.projectVectorToPoint(r.eye,n,o)?(s??=new t,s.position=o,s.heading=r.heading,s.tilt=r.tilt,s.fov=i,s):null}async function re(e,r,i,s){const o=e.renderSpatialReference,a=new c({spatialReference:E(e)});return await p.projectVectorToPointAsync(r.eye,o,a,{signal:s}),n.throwIfAborted(s),new t(a,r.heading,r.tilt,i)}e.applyTiltAdjustToScale=L,e.directionToHeadingTilt=G,e.distanceToScale=F,e.externalToInternal=A,e.fromCenterDistanceAsync=B,e.fromCenterDistanceSync=function(e,t,r,i,s,n){return te(e,z(e,i.heading,i.tilt,t,r,s),i.fov,n)},e.fromCenterScale=async function(e,t,r,i,s,n){return B(e,t,D(e,r),i,s,n)},e.fromExtentAsync=async function(e,t,r,i,s,o){const a=Y(e,t)?t:await u.projectWithZConversion(t,e.spatialReference,{signal:o});n.throwIfAborted(o);const{center:l,distance:c}=X(e,a),d=await j(e,r,i,l,c,s,o);return n.throwIfAborted(o),re(e,d,e.camera.fov,o)},e.fromExtentSync=function(e,t,r,i,s,n){let o;try{o=Y(e,t)?t:u.project(t,e.spatialReference)}catch(e){return null}const{center:a,distance:l}=X(e,o),c=z(e,r,i,a,l,s);return null==c?null:te(e,c,e.camera.fov,n)},e.getObserverForPointAtDistanceAsync=j,e.getObserverForPointAtDistanceSync=z,e.getViewSR=E,e.headingTiltToDirectionUp=function(e,t,r,i,s){return O(e).headingTiltToDirectionUp(t,r,i,s)},e.internalToExternal=function(e,r,i){const n=e.renderSpatialReference,o=G(e,r.eye,r.viewForward,r.up,T);let a=E(e);return m.projectVectorToVector(r.eye,n,I,a)||(a=d.WGS84,m.projectVectorToVector(r.eye,n,I,a)),null==i?i=new t(new c(I,a),o.heading,o.tilt,s.rad2deg(r.fov)):(i.position.x=I[0],i.position.y=I[1],i.position.z=I[2],i.position.spatialReference=a,i.heading=o.heading,i.tilt=o.tilt,i.fov=s.rad2deg(r.fov)),i.layout.row=r.row,i.layout.rows=r.rows,i.layout.column=r.column,i.layout.columns=r.columns,i},e.removeTiltAdjustFromScale=N,e.scaleErrorThreshold=1,e.scaleToDistance=D,e.scaleToZoom=function(e,t){const r=e.basemapTerrain?.tilingScheme;if(r)return r.levelAtScale(t);w().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")},e.toArea=function(e,t){return O(e).toArea(e,t)},e.toExtent=function(e,t,r){const i=e.renderSpatialReference,s=new c({spatialReference:E(e)});if(!p.projectVectorToPoint(r,i,s))return null;const n=Math.tan(t.fovX/2),a=Math.tan(t.fovY/2),l=o.dist(t.eye,r),u=2*l*n*1,d=2*l*a*1;return O(e).toExtent(e,s,u,d)},e.viewScaleToCameraDistance=function(t,r,i,n,a){if(0===r)return 0;const c=o.distance(i.eye,n),u=t.basemapTerrain?.tilingScheme;if(!u)return w().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),c;let d=c;const h=G(t,i.eye,i.viewForward,i.up),p=h.tilt>90;if(t.state.isLocal){const e=(D(t,N(r,h.tilt,u))-Math.abs(i.eye[2]-a[2]))/Math.cos(s.deg2rad(h.tilt));return d=p?d-e:d+e,d}let m=1/0,f=0,g=z(t,h.heading,h.tilt,n,c,e.OrientationMode.ADJUST);if(!g)return d;const y=o.length(a);for(;m>1&&f<100;){const a=o.length(g.eye),c=p?180-g.tilt:g.tilt,_=s.deg2rad(c),b=Math.sin(_)*a,v=Math.cos(_)*a,S=D(t,N(r,g.tilt,u)),w=p?y-S:y+S,x=s.asinClamped(b/w),T=Math.cos(x)*w-v,C=o.distance(g.eye,n);d=p?C-T:C+T,g=z(t,h.heading,h.tilt,n,d,e.OrientationMode.ADJUST);const P=te(t,g,s.rad2deg(i.fov));if(!g||!P)return d;const M=V(t,P,y-l.getReferenceEllipsoid(t.spatialReference).radius);m=Math.abs(r-M),++f}return d},e.zoomToScale=function(e,t){const r=e.basemapTerrain?.tilingScheme;if(r)return r.scaleAtLevel(t);w().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/projection/projectVectorToPoint":function(){define(["exports","../../core/libs/gl-matrix-2/factories/vec3f64","../projectionUtils","./projectVectorToVector"],(function(e,t,r,i){"use strict";function s(e,t,r){return!!i.projectVectorToVector(e,t,n,r.spatialReference)&&(r.x=n[0],r.y=n[1],r.z=n[2],!0)}const n=t.create();e.projectVectorToPoint=s,e.projectVectorToPointAsync=async function(e,t,i,n){return await r.initializeProjection(t,i.spatialReference,null,n),s(e,t,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/projection/projectVectorToVector":function(){define(["exports","../projectionUtils","../SpatialReference","./projectPointToVector","../../layers/graphics/dehydratedPoint"],(function(e,t,r,i,s){"use strict";function n(e,t,r,s,n){return!(null==t||null==s||e.length<2)&&(o.x=e[0],o.y=e[1],o.z=e[2],o.spatialReference=t,i.projectPointToVector(o,r,s,n))}const o=s.makeDehydratedPoint(0,0,0,r.WGS84);e.projectVectorToVector=n,e.projectVectorToVectorAsync=async function(e,r,i,s,o,a){return await t.initializeProjection(r,s,null,a),n(e,r,i,s,o)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/dehydratedPoint":function(){define(["exports"],(function(e){"use strict";e.makeDehydratedPoint=function(e,t,r,i){return{x:e,y:t,z:r,hasZ:null!=r,hasM:!1,spatialReference:i,type:"point"}},e.setDehydratedPoint=function(e,t,r,i,s){e.x=t,e.y=r,e.z=i,e.hasZ=null!=i,e.spatialReference=s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/intersectionUtils":function(){define(["exports","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/support/aaBoundingRect","../webgl/RenderCamera","../webgl-engine/lib/DepthRange","../webgl-engine/lib/Intersector"],(function(e,t,r,i,s,n,o,a){"use strict";function l(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function c(e,r,i){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const s=l(e,r),a=e.stateManager.constraintsManager.nearFarHeuristic;let c=m.get(e);void 0===c&&(c=new n,m.set(e,c)),c.eye=r,c.center=i;const{far:u}=a.compute(c,e.renderDataExtent,o.DepthRange.infinite,s),d=u*u;return t.squaredDistance(r,i)>d}const u={},d=r.create(),h=r.create(),p=r.create(),m=new WeakMap;e.cameraOnContentAlongViewDirection=function(e,r,s,n){const o=e.state.camera.clone();r&&s&&n&&(o.eye=r,o.center=s,o.up=n),function(e,r,s){let n=u[e.viewingMode];n||(n=new a.Intersector(e.state.viewingMode),n.options.backfacesTerrain=!e.state.isGlobal,n.options.invisibleTerrain=!0,u[e.viewingMode]=n);const{isGlobal:o}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(r,n,s)||c(e,r.origin,s))||!(!e.renderCoordsHelper.intersectManifold(r,0,s)||c(e,r.origin,s))||!!o&&function(e,r,i){const s=t.dot(e.origin,e.origin)-i*i,n=s>0?Math.sqrt(s)/3:1;return t.scale(r,e.direction,n/t.length(e.direction)),t.add(r,r,e.origin),!0}(r,s,i.getReferenceEllipsoid(e.spatialReference).radius)}(e,o.ray,h)||t.copy(h,o.center);const l=e.state.constraints,m=l.minimumPoiDistance;if(t.squaredDistance(o.eye,h)<m){const r=l.collision.enabled;t.copy(p,o.viewForward),t.scale(p,p,m),r?o.eye=t.subtract(d,h,p):t.add(h,o.eye,p);const i=e.renderCoordsHelper,s=i.getAltitude(o.eye),n=l.collision.elevationMargin;r&&s<n&&(t.subtract(p,h,o.eye),o.eye=i.setAltitude(d,n,o.eye),t.add(h,o.eye,p))}return o.center=h,o},e.eyeWithinExtent=function(e,t,r,i){return null!=e.renderCoordsHelper.fromRenderCoords(t.eye,d,i)&&s.containsPoint(r,d)},e.surfaceElevationBelowRenderLocation=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl/RenderCamera":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Logger","../../../core/mathUtils","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/frustum","../../../geometry/support/ray","../../../geometry/support/vector","../../ViewingMode","../webgl-engine/lib/fov","../webgl-engine/lib/rendererUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w){"use strict";var x;let T=x=class extends t{constructor(e){super(e),this._ray=_.create(),this._viewport=g.fromValues(0,0,1,1),this._padding=g.fromValues(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=h.fromValues(1,1e3),this._viewDirty=!0,this._viewMatrix=u.create(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=u.create(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=u.create(),this._frustumDirty=!0,this._frustum=y.create(),this._fullViewport=g.create(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=m.create(),this._up=m.create(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return p.subtract(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){c.copy(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),p.set(m.create(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),p.set(m.create(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),p.set(m.create(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const e=f.scale(g.create(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&f.equals(e,t)?t:e}get screenPadding(){if(1===this.pixelRatio)return this._padding;const e=f.scale(g.create(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&f.equals(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[w.PaddingSide.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[w.PaddingSide.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[w.PaddingSide.RIGHT]+this._padding[w.PaddingSide.LEFT]}set fullWidth(e){this.width=e-(this._padding[w.PaddingSide.RIGHT]+this._padding[w.PaddingSide.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[w.PaddingSide.TOP]+this._padding[w.PaddingSide.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[w.PaddingSide.TOP]+this._padding[w.PaddingSide.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[w.PaddingSide.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[w.PaddingSide.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){f.exactEquals(this._padding,e)||(this._viewport[0]+=e[w.PaddingSide.LEFT]-this._padding[w.PaddingSide.LEFT],this._viewport[1]+=e[w.PaddingSide.BOTTOM]-this._padding[w.PaddingSide.BOTTOM],this._viewport[2]-=e[w.PaddingSide.RIGHT]+e[w.PaddingSide.LEFT]-(this._padding[w.PaddingSide.RIGHT]+this._padding[w.PaddingSide.LEFT]),this._viewport[3]-=e[w.PaddingSide.TOP]+e[w.PaddingSide.BOTTOM]-(this._padding[w.PaddingSide.TOP]+this._padding[w.PaddingSide.BOTTOM]),f.copy(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(c.multiply(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return c.invert(u.create(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||u.create()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return S.fovd2fovx(this._fov,this.width,this.height)}set fovX(e){this._fov=S.fovx2fovd(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return S.fovd2fovy(this._fov,this.width,this.height)}set fovY(e){this._fov=S.fovy2fovd(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return p.distance(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(c.invert(this._viewInverseTransposeMatrix,this.viewMatrix),c.transpose(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const{near:t,far:r}=this;return 2*t*r/(r+t-e*(r-t))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}get _projectionMatrixInternal(){const e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2)*2,i=r*this._aspect,s=r/this.rows,n=i/this.columns,o=-i/2+this.column*n,a=o+n,l=-r/2+this.row*s,d=l+s,h=c.frustum(u.create(),o*(1+2*this._padding[w.PaddingSide.LEFT]/e),a*(1+2*this._padding[w.PaddingSide.RIGHT]/e),l*(1+2*this._padding[w.PaddingSide.BOTTOM]/t),d*(1+2*this._padding[w.PaddingSide.TOP]/t),this.near,this.far),p=this._get("projectionMatrix");return p&&c.equals(p,h)?p:h}copyFrom(e){p.copy(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,f.copy(this._viewport,e.viewport),this.notifyChange("_viewport"),f.copy(this._padding,e.padding),this.notifyChange("_padding"),d.copy(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(c.copy(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(y.copy(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(c.copy(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),f.copy(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up,this.fov=e.fov}clone(){return(new x).copyFrom(this)}equals(e){return p.exactEquals(this.eye,e.eye)&&p.exactEquals(this.center,e.center)&&p.exactEquals(this.up,e.up)&&f.exactEquals(this._viewport,e.viewport)&&f.exactEquals(this._padding,e.padding)&&d.exactEquals(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||f.squaredDistance(e.screenPadding,this.screenPadding)>=t||f.squaredDistance(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;p.sub(R,e.eye,e.center),p.sub(E,this.eye,this.center);const r=p.dot(R,E),i=p.sqrLen(R),s=p.sqrLen(E),n=5e-4;return r*r>=(1-1e-10)*i*s&&p.sqrDist(e.eye,this.eye)<Math.max(i,s)*n*n}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs(b.projectPointSignedLength(this.viewForward,p.subtract(R,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=s.createScreenPointArray()){return e[0]=(this.padding[w.PaddingSide.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[w.PaddingSide.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,r=.5){return e[0]=this.padding[w.PaddingSide.LEFT]+this.width*t,e[1]=this.padding[w.PaddingSide.BOTTOM]+this.height*r,e[2]=.5,e}setGLViewport(e){const t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}applyProjection(e,t){e!==P&&p.copy(P,e),P[3]=1,f.transformMat4(P,P,this.projectionMatrix);const r=Math.abs(P[3]);p.scale(P,P,1/r);const s=this.fullViewport;t[0]=i.lerp(0,s[0]+s[2],.5+.5*P[0]),t[1]=i.lerp(0,s[1]+s[3],.5+.5*P[1]),t[2]=.5*(P[2]+1),t[3]=r}unapplyProjection(e,t){const r=this.fullViewport;P[0]=(e[0]/(r[0]+r[2])*2-1)*e[3],P[1]=(e[1]/(r[1]+r[3])*2-1)*e[3],P[2]=(2*e[2]-1)*e[3],P[3]=e[3],null!=this.inverseProjectionMatrix&&(f.transformMat4(P,P,this.inverseProjectionMatrix),t[0]=P[0],t[1]=P[1],t[2]=P[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,O),this.renderToScreen(O,t),t}projectToRenderScreen(e,t){if(P[0]=e[0],P[1]=e[1],P[2]=e[2],P[3]=1,f.transformMat4(P,P,this.viewProjectionMatrix),0===P[3])return null;const r=P;p.scale(r,r,1/Math.abs(P[3]));const s=this.fullViewport,n=i.lerp(0,s[0]+s[2],.5+.5*r[0]),o=i.lerp(0,s[1]+s[3],.5+.5*r[1]);return"x"in t?(t.x=n,t.y=o):(t[0]=n,t[1]=o,t.length>2&&(t[2]=.5*(r[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,O),t)}unprojectFromRenderScreen(e,t){if(c.multiply(M,this.projectionMatrix,this.viewMatrix),!c.invert(M,M))return null;const r=this.fullViewport;return P[0]=2*(e[0]-r[0])/r[2]-1,P[1]=2*(e[1]-r[1])/r[3]-1,P[2]=2*e[2]-1,P[3]=1,f.transformMat4(P,P,M),0===P[3]?null:(t[0]=P[0]/P[3],t[1]=P[1]/P[3],t[2]=P[2]/P[3],t)}constrainWindowSize(e,t,r,i){const s=e*this.pixelRatio,n=t*this.pixelRatio,o=Math.max(s-r/2,0),a=Math.max(this.fullHeight-n-i/2,0),l=-Math.min(s-r/2,0),c=-Math.min(this.fullHeight-n-i/2,0),u=r-l- -Math.min(this.fullWidth-s-r/2,0),d=i-c- -Math.min(n-i/2,0);return[Math.round(o),Math.round(a),Math.round(u),Math.round(d)]}computeUp(e){e===v.ViewingMode.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const r=e[0]*this.pixelRatio,i=this.fullHeight-e[1]*this.pixelRatio;return t[0]=r,t[1]=i,t}renderToScreen(e,t){const r=e[0]/this.pixelRatio,i=(this.fullHeight-e[1])/this.pixelRatio;t[0]=r,t[1]=i}_computeUpGlobal(){p.subtract(R,this.center,this.eye);const e=p.length(this.center);e<1?(p.set(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(p.dot(R,this.center))>.9999*p.length(R)*e||(p.cross(this._up,R,this.center),p.cross(this._up,this._up,R),p.normalize(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){p.direction(R,this.eye,this.center),Math.abs(R[2])<=.9999&&(p.scale(R,R,R[2]),p.set(this._up,-R[0],-R[1],1-R[2]),p.normalize(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t,i=""){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?p.exactEquals(e,t)||(p.copy(t,e),this._markViewDirty(),i.length&&this.notifyChange(i)):r.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(y.fromMatrix(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(c.lookAt(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};e.__decorate([n.property()],T.prototype,"_viewport",void 0),e.__decorate([n.property()],T.prototype,"_padding",void 0),e.__decorate([n.property()],T.prototype,"_fov",void 0),e.__decorate([n.property()],T.prototype,"_nearFar",void 0),e.__decorate([n.property()],T.prototype,"_viewDirty",void 0),e.__decorate([n.property()],T.prototype,"_viewMatrix",void 0),e.__decorate([n.property()],T.prototype,"_pixelRatio",void 0),e.__decorate([n.property()],T.prototype,"pixelRatio",null),e.__decorate([n.property()],T.prototype,"row",void 0),e.__decorate([n.property()],T.prototype,"column",void 0),e.__decorate([n.property()],T.prototype,"_rows",void 0),e.__decorate([n.property()],T.prototype,"rows",null),e.__decorate([n.property()],T.prototype,"_columns",void 0),e.__decorate([n.property()],T.prototype,"columns",null),e.__decorate([n.property()],T.prototype,"eye",null),e.__decorate([n.property()],T.prototype,"center",null),e.__decorate([n.property()],T.prototype,"_center",void 0),e.__decorate([n.property()],T.prototype,"up",null),e.__decorate([n.property()],T.prototype,"_up",void 0),e.__decorate([n.property()],T.prototype,"viewMatrix",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"viewForward",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"viewUp",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"viewRight",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"nearFar",null),e.__decorate([n.property()],T.prototype,"near",null),e.__decorate([n.property()],T.prototype,"far",null),e.__decorate([n.property()],T.prototype,"viewport",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"screenViewport",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"screenPadding",null),e.__decorate([n.property()],T.prototype,"x",null),e.__decorate([n.property()],T.prototype,"y",null),e.__decorate([n.property()],T.prototype,"width",null),e.__decorate([n.property()],T.prototype,"height",null),e.__decorate([n.property()],T.prototype,"fullWidth",null),e.__decorate([n.property()],T.prototype,"fullHeight",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"_aspect",null),e.__decorate([n.property()],T.prototype,"padding",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"projectionMatrix",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"inverseProjectionMatrix",null),e.__decorate([n.property()],T.prototype,"fov",null),e.__decorate([n.property()],T.prototype,"fovX",null),e.__decorate([n.property()],T.prototype,"fovY",null),e.__decorate([n.property()],T.prototype,"viewInverseTransposeMatrix",null),e.__decorate([n.property({readOnly:!0})],T.prototype,"_projectionMatrixInternal",null),e.__decorate([n.property()],T.prototype,"relativeElevation",void 0),T=x=e.__decorate([l.subclass("esri.views.3d.webgl.RenderCamera")],T);const C=T,P=g.create(),M=u.create(),R=m.create(),E=m.create(),O=s.createRenderScreenPointArray3();return C}))},"esri/core/libs/gl-matrix-2/math/vec2":function(){define(["exports","./common"],(function(e,t){"use strict";function r(e,t){return e[0]=t[0],e[1]=t[1],e}function i(e,t,r){return e[0]=t,e[1]=r,e}function s(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e}function n(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function o(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e}function a(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e}function l(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function c(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function u(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e}function d(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e}function h(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function p(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e}function m(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e}function f(e,t){const r=t[0]-e[0],i=t[1]-e[1];return Math.sqrt(r*r+i*i)}function g(e,t){const r=t[0]-e[0],i=t[1]-e[1];return r*r+i*i}function y(e){const t=e[0],r=e[1];return Math.sqrt(t*t+r*r)}function _(e){const t=e[0],r=e[1];return t*t+r*r}function b(e,t){return e[0]=-t[0],e[1]=-t[1],e}function v(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function S(e,t){const r=t[0],i=t[1];let s=r*r+i*i;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s),e}function w(e,t){return e[0]*t[0]+e[1]*t[1]}function x(e,t,r){const i=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=i,e}function T(e,t,r,i){const s=t[0],n=t[1];return e[0]=s+i*(r[0]-s),e[1]=n+i*(r[1]-n),e}function C(e,r=1){const i=2*t.RANDOM()*Math.PI;return e[0]=Math.cos(i)*r,e[1]=Math.sin(i)*r,e}function P(e,t,r){const i=t[0],s=t[1];return e[0]=r[0]*i+r[2]*s,e[1]=r[1]*i+r[3]*s,e}function M(e,t,r){const i=t[0],s=t[1];return e[0]=r[0]*i+r[2]*s+r[4],e[1]=r[1]*i+r[3]*s+r[5],e}function R(e,t,r){const i=t[0],s=t[1];return e[0]=r[0]*i+r[3]*s+r[6],e[1]=r[1]*i+r[4]*s+r[7],e}function E(e,t,r){const i=t[0],s=t[1];return e[0]=r[0]*i+r[4]*s+r[12],e[1]=r[1]*i+r[5]*s+r[13],e}function O(e,t,r,i){const s=t[0]-r[0],n=t[1]-r[1],o=Math.sin(i),a=Math.cos(i);return e[0]=s*a-n*o+r[0],e[1]=s*o+n*a+r[1],e}function A(e,t){const r=e[0],i=e[1],s=t[0],n=t[1];let o=r*r+i*i;o>0&&(o=1/Math.sqrt(o));let a=s*s+n*n;a>0&&(a=1/Math.sqrt(a));const l=(r*s+i*n)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function I(e){return"vec2("+e[0]+", "+e[1]+")"}function D(e,t){return e[0]===t[0]&&e[1]===t[1]}function F(e,r){const i=e[0],s=e[1],n=r[0],o=r[1],a=t.getEpsilon();return Math.abs(i-n)<=a*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(s-o)<=a*Math.max(1,Math.abs(s),Math.abs(o))}function L(e,t,r,i,s){let n=t[0]-r[0],o=t[1]-r[1];const a=(i[0]*n+i[1]*o)*(s-1);return n=i[0]*a,o=i[1]*a,e[0]=t[0]+n,e[1]=t[1]+o,e}const N=y,U=n,V=o,B=a,G=f,k=g,z=_,j=Object.freeze(Object.defineProperty({__proto__:null,add:s,angle:A,ceil:l,copy:r,cross:x,dist:G,distance:f,div:B,divide:a,dot:w,equals:F,exactEquals:D,floor:c,inverse:v,len:N,length:y,lerp:T,max:d,min:u,mul:V,multiply:o,negate:b,normalize:S,projectAndScale:L,random:C,rotate:O,round:h,scale:p,scaleAndAdd:m,set:i,sqrDist:k,sqrLen:z,squaredDistance:g,squaredLength:_,str:I,sub:U,subtract:n,transformMat2:P,transformMat2d:M,transformMat3:R,transformMat4:E},Symbol.toStringTag,{value:"Module"}));e.add=s,e.angle=A,e.ceil=l,e.copy=r,e.cross=x,e.dist=G,e.distance=f,e.div=B,e.divide=a,e.dot=w,e.equals=F,e.exactEquals=D,e.floor=c,e.inverse=v,e.len=N,e.length=y,e.lerp=T,e.max=d,e.min=u,e.mul=V,e.multiply=o,e.negate=b,e.normalize=S,e.projectAndScale=L,e.random=C,e.rotate=O,e.round=h,e.scale=p,e.scaleAndAdd=m,e.set=i,e.sqrDist=k,e.sqrLen=z,e.squaredDistance=g,e.squaredLength=_,e.str=I,e.sub=U,e.subtract=n,e.transformMat2=P,e.transformMat2d=M,e.transformMat3=R,e.transformMat4=E,e.vec2=j,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/frustum":function(){define(["exports","../../core/ObjectStack","../../core/libs/gl-matrix-2/math/mat4","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../../chunks/vec42","../../core/libs/gl-matrix-2/factories/vec4f64","./clipRay","./plane","./vectorStacks"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(){return[s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create(),s.create()]}function d(t,r){l.fromPoints(r[e.PointIndex.FAR_BOTTOM_LEFT],r[e.PointIndex.NEAR_BOTTOM_LEFT],r[e.PointIndex.NEAR_TOP_LEFT],t[e.PlaneIndex.LEFT]),l.fromPoints(r[e.PointIndex.NEAR_BOTTOM_RIGHT],r[e.PointIndex.FAR_BOTTOM_RIGHT],r[e.PointIndex.FAR_TOP_RIGHT],t[e.PlaneIndex.RIGHT]),l.fromPoints(r[e.PointIndex.FAR_BOTTOM_LEFT],r[e.PointIndex.FAR_BOTTOM_RIGHT],r[e.PointIndex.NEAR_BOTTOM_RIGHT],t[e.PlaneIndex.BOTTOM]),l.fromPoints(r[e.PointIndex.NEAR_TOP_LEFT],r[e.PointIndex.NEAR_TOP_RIGHT],r[e.PointIndex.FAR_TOP_RIGHT],t[e.PlaneIndex.TOP]),l.fromPoints(r[e.PointIndex.NEAR_BOTTOM_LEFT],r[e.PointIndex.NEAR_BOTTOM_RIGHT],r[e.PointIndex.NEAR_TOP_RIGHT],t[e.PlaneIndex.NEAR]),l.fromPoints(r[e.PointIndex.FAR_BOTTOM_RIGHT],r[e.PointIndex.FAR_BOTTOM_LEFT],r[e.PointIndex.FAR_TOP_LEFT],t[e.PlaneIndex.FAR])}function h(e,t){for(let r=0;r<g;r++)if(!l.clip(e[r],t))return!1;return!0}var p,m;e.PlaneIndex=void 0,(p=e.PlaneIndex||(e.PlaneIndex={}))[p.LEFT=0]="LEFT",p[p.RIGHT=1]="RIGHT",p[p.BOTTOM=2]="BOTTOM",p[p.TOP=3]="TOP",p[p.NEAR=4]="NEAR",p[p.FAR=5]="FAR",e.PointIndex=void 0,(m=e.PointIndex||(e.PointIndex={}))[m.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",m[m.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",m[m.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",m[m.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",m[m.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",m[m.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",m[m.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",m[m.FAR_TOP_LEFT=7]="FAR_TOP_LEFT";const f={bottom:[e.PointIndex.FAR_BOTTOM_RIGHT,e.PointIndex.NEAR_BOTTOM_RIGHT,e.PointIndex.NEAR_BOTTOM_LEFT,e.PointIndex.FAR_BOTTOM_LEFT],near:[e.PointIndex.NEAR_BOTTOM_LEFT,e.PointIndex.NEAR_BOTTOM_RIGHT,e.PointIndex.NEAR_TOP_RIGHT,e.PointIndex.NEAR_TOP_LEFT],far:[e.PointIndex.FAR_BOTTOM_RIGHT,e.PointIndex.FAR_BOTTOM_LEFT,e.PointIndex.FAR_TOP_LEFT,e.PointIndex.FAR_TOP_RIGHT],right:[e.PointIndex.NEAR_BOTTOM_RIGHT,e.PointIndex.FAR_BOTTOM_RIGHT,e.PointIndex.FAR_TOP_RIGHT,e.PointIndex.NEAR_TOP_RIGHT],left:[e.PointIndex.FAR_BOTTOM_LEFT,e.PointIndex.NEAR_BOTTOM_LEFT,e.PointIndex.NEAR_TOP_LEFT,e.PointIndex.FAR_TOP_LEFT],top:[e.PointIndex.FAR_TOP_LEFT,e.PointIndex.NEAR_TOP_LEFT,e.PointIndex.NEAR_TOP_RIGHT,e.PointIndex.FAR_TOP_RIGHT]},g=6,y=[o.fromValues(-1,-1,-1,1),o.fromValues(1,-1,-1,1),o.fromValues(1,1,-1,1),o.fromValues(-1,1,-1,1),o.fromValues(-1,-1,1,1),o.fromValues(1,-1,1,1),o.fromValues(1,1,1,1),o.fromValues(-1,1,1,1)],_=new t.ObjectStack(a.create),b=u();e.computePlanes=d,e.copy=function(e,t){for(let r=0;r<g;r++)l.copy(e[r],t[r]);return e},e.create=function(e){return e?[l.create(e[0]),l.create(e[1]),l.create(e[2]),l.create(e[3]),l.create(e[4]),l.create(e[5])]:[l.create(),l.create(),l.create(),l.create(),l.create(),l.create()]},e.createPoints=u,e.fromMatrix=function(e,t,s,o=b){const a=r.multiply(c.sm4d.get(),t,e);r.invert(a,a);for(let e=0;e<8;++e){const t=n.transformMat4(c.sv4d.get(),y[e],a);i.set(o[e],t[0]/t[3],t[1]/t[3],t[2]/t[3])}d(s,o)},e.intersectClipRay=function(e,t){for(let r=0;r<g;r++){const i=e[r];if(!l.clipInfinite(i,t))return!1}return!0},e.intersectsLineSegment=function(e,t,r){return h(e,a.fromLineSegmentAndDirection(t,r,_.get()))},e.intersectsPoint=function(e,t){for(let r=0;r<g;r++)if(l.signedDistance(e[r],t)>0)return!1;return!0},e.intersectsRay=function(e,t){return h(e,a.fromRay(t,_.get()))},e.intersectsSphere=function(e,t){for(let r=0;r<g;r++){const i=e[r];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]>=t[3])return!1}return!0},e.numPlanes=g,e.numPoints=8,e.planePointIndices=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/clipRay":function(){define(["exports","../../core/ObjectStack","../../chunks/vec32","./ray"],(function(e,t,r,i){"use strict";function s(e){return e?{ray:i.create(e.ray),c0:e.c0,c1:e.c1}:{ray:i.create(),c0:0,c1:Number.MAX_VALUE}}function n(e,t,r,n=s()){return i.copy(e,n.ray),n.c0=t,n.c1=r,n}function o(e,t,i){return r.add(i,e.ray.origin,r.scale(i,e.ray.direction,t))}const a=new t.ObjectStack((()=>s()));e.copy=function(e,t=s()){return n(e.ray,e.c0,e.c1,t)},e.create=s,e.fromLineSegmentAndDirection=function(e,t,n=s()){const o=r.length(e.vector);return i.fromValues(e.origin,t,n.ray),n.c0=0,n.c1=o,n},e.fromRay=function(e,t=s()){return i.copy(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t},e.fromValues=n,e.getAt=o,e.getEnd=function(e,t){return o(e,e.c1,t)},e.getStart=function(e,t){return o(e,e.c0,t)},e.wrap=function(e,t,r){const i=a.get();return i.ray=e,i.c0=t,i.c1=r,i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/fov":function(){define(["exports"],(function(e){"use strict";e.fovd2fovx=function(e,t,r){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+r*r))},e.fovd2fovy=function(e,t,r){return 2*Math.atan(r*Math.tan(.5*e)/Math.sqrt(t*t+r*r))},e.fovx2fovd=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/t)},e.fovy2fovd=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/rendererUtils":function(){define(["exports","./ChangeSet"],(function(e,t){"use strict";var r,i;function s(e){return e.geometry.indexCount>=1}e.RendererTarget=void 0,(r=e.RendererTarget||(e.RendererTarget={}))[r.Default=0]="Default",r[r.Screenshot=1]="Screenshot",r[r.ObjectAndLayerID=2]="ObjectAndLayerID",e.PaddingSide=void 0,(i=e.PaddingSide||(e.PaddingSide={}))[i.TOP=0]="TOP",i[i.RIGHT=1]="RIGHT",i[i.BOTTOM=2]="BOTTOM",i[i.LEFT=3]="LEFT",e.splitRenderGeometryChangeSetByMaterial=function(e){const r=new Map,i=i=>{let s=r.get(i);return s||(s=new t.MaterialChangeSet(e),r.set(i,s)),s};return e.removes.forAll((e=>{s(e)&&i(e.material).removes.push(e)})),e.adds.forAll((e=>{s(e)&&i(e.material).adds.push(e)})),e.updates.forAll((e=>{s(e.renderGeometry)&&i(e.renderGeometry.material).updates.push(e)})),r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ChangeSet":function(){define(["exports","../../../../core/PooledArray"],(function(e,t){"use strict";class r{}e.ChangeSet=class{constructor(){this.adds=new t,this.removes=new t,this.updates=new t({allocator:e=>e||new r,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}},e.MaterialChangeSet=class{constructor(e){this.pending=e,this.adds=new Array,this.removes=new Array,this.updates=new Array}clearAddsAndRemoves(){this.adds.forEach((e=>this.pending.adds.removeUnordered(e))),this.removes.forEach((e=>this.pending.removes.removeUnordered(e))),this.adds.length=0,this.removes.length=0}clearUpdates(){this.updates.forEach((e=>this.pending.updates.removeUnordered(e))),this.updates.length=0}clear(){this.clearUpdates(),this.clearAddsAndRemoves()}},e.RenderGeometryUpdate=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/DepthRange":function(){define(["exports"],(function(e){"use strict";class t{constructor(e=1/0,t=-1/0){this.near=e,this.far=t}set(e,t){this.near=e,this.far=t}union(e){null!=e&&(this.near=Math.min(this.near,e.near),this.far=Math.max(this.far,e.far))}within(e){return this.near<=e&&e<=this.far}equals(e){return this.near===e.near&&this.far===e.far}static{this.zero=new t(0,0)}static{this.infinite=new t}}e.DepthRange=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Intersector":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","../../../ViewingMode","../../webgl/RenderCamera","./HUDIntersectorResult","./IntersectorInterfaces","./IntersectorResult","./IntersectorType","./verticalOffsetUtils"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=1e-5;function h(e,t){return(t??-Number.MAX_VALUE)-(e??-Number.MAX_VALUE)}class p{constructor(){this.min=new l.IntersectorResult(i.create()),this.max=new l.IntersectorResult(i.create()),this.hud={min:new o.HUDIntersectorResult(i.create()),max:new o.HUDIntersectorResult(i.create()),all:new Array},this.ground=new l.IntersectorResult(i.create()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}}e.Intersector=class{constructor(e){this.options=new a.IntersectorOptions,this._results=new p,this.transform=new u.IntersectorTransform,this.camera=new n,this.tolerance=d,this.verticalOffset=null,this._ray=i.create(),this._rayEnd=r.create(),this._rayBeginTransformed=r.create(),this._rayEndTransformed=r.create(),this.viewingMode=e??s.ViewingMode.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,r){this.resetWithRay(i.fromPoints(e,t,this._ray),r)}resetWithRay(e,r){this.camera=r,e!==this._ray&&i.copy(e,this._ray),0!==this.options.verticalOffset?this.viewingMode===s.ViewingMode.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,t.add(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,r,i,s){this.point=t,this.filterPredicate=i,this.tolerance=r??d;const n=u.getVerticalOffsetObject3D(this.verticalOffset);if(e&&e.length>0){const t=s?e=>{s(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const r of e){const e=r.getSpatialQueryAccelerator?.();null!=e?(null!=n?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,n):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):r.objects.forEach((e=>t(e)))}}this.sortResults()}intersectObject(e){const r=e.geometries;if(!r)return;const i=e.effectiveTransformation,s=u.getVerticalOffsetObject3D(this.verticalOffset);for(const n of r){if(!n.visible)continue;const{material:r,id:o}=n;if(!r.visible)continue;this.transform.setAndInvalidateLazyTransforms(i,n.transformation),t.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),t.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const a=this.transform.transform;null!=s&&(s.objectTransform=this.transform),r.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((t,r,i,s)=>this.handleObjectIntersection({object:e,geometryId:o,primitiveIndex:i},t,r,a,s)))}}handleObjectIntersection(e,t,r,i,s){if(t<0||null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;const n=s?this._results.hud:this._results;e=s?new o.HUDTarget(e,s):e;const u=s?i=>i.set(c.IntersectorType.HUD,e,t,r):s=>s.set(c.IntersectorType.OBJECT,e,t,r,i);if((null==n.min.distance||t<n.min.distance)&&u(n.min),this.options.store!==a.StoreResults.MIN&&(null==n.max.distance||t>n.max.distance)&&u(n.max),this.options.store===a.StoreResults.ALL)if(s){const e=new o.HUDIntersectorResult(this._ray);u(e),this._results.hud.all.push(e)}else{const e=new l.IntersectorResult(this._ray);u(e),this._results.all.push(e)}}sortResults(e=this._results.all){e.sort(((e,t)=>e.distance!==t.distance?(e.distance??0)-(t.distance??0):e.drapedLayerOrder!==t.drapedLayerOrder?h(e.drapedLayerOrder,t.drapedLayerOrder):h(e.renderPriority,t.renderPriority)))}},e.defaultTolerance=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/HUDIntersectorResult":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64","./IntersectorResult","./IntersectorType","./ObjectTarget"],(function(e,t,r,i,s){"use strict";class n extends r.IntersectorResult{constructor(){super(...arguments),this.intersector=i.IntersectorType.HUD}}class o extends s.ObjectTarget{constructor(e,r){super(e.object,e.geometryId,e.primitiveIndex),this.center=t.clone(r)}}e.HUDIntersectorResult=n,e.HUDTarget=o,e.isHUDIntersectorResult=function(e){return r.isValidIntersectorResult(e)&&e.intersector===i.IntersectorType.HUD&&!!e.target&&"center"in e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/IntersectorResult":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/ray","./IntersectorType"],(function(e,t,r,i,s,n,o,a,l){"use strict";function c(e){return null!=e?.distance}const u=s.create(),d=o.create();e.IntersectorResult=class{get ray(){return this._ray}get distanceInRenderSpace(){return null==this.distance?null:(i.scale(u,this.ray.direction,this.distance),i.length(u))}withinDistance(e){return!!c(this)&&this.distanceInRenderSpace<=e}getIntersectionPoint(e){return!!c(this)&&(i.scale(u,this.ray.direction,this.distance),i.add(e,this.ray.origin,u),!0)}getTransformedNormal(e){return i.copy(d,this.normal),d[3]=0,n.transformMat4(d,d,this.transformation),i.copy(e,d),i.normalize(e,e)}constructor(e){this.intersector=l.IntersectorType.OBJECT,this.normal=s.create(),this.transformation=r.create(),this._ray=a.create(),this.init(e)}init(e){this.distance=this.target=this.drapedLayerOrder=this.renderPriority=null,this.intersector=l.IntersectorType.OBJECT,a.copy(e,this._ray)}set(e,n,o,a,l,c,u){this.intersector=e,this.distance=o,i.copy(this.normal,a??s.UNIT_Z),t.copy(this.transformation,l??r.IDENTITY),this.target=n,this.drapedLayerOrder=c,this.renderPriority=u}copy(e){a.copy(e.ray,this._ray),this.intersector=e.intersector,this.distance=e.distance,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.renderPriority=e.renderPriority,i.copy(this.normal,e.normal),t.copy(this.transformation,e.transformation)}},e.isValidIntersectorResult=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/IntersectorType":function(){define(["exports"],(function(e){"use strict";var t;e.IntersectorType=void 0,(t=e.IntersectorType||(e.IntersectorType={}))[t.OBJECT=0]="OBJECT",t[t.HUD=1]="HUD",t[t.TERRAIN=2]="TERRAIN",t[t.OVERLAY=3]="OVERLAY",t[t.I3S=4]="I3S",t[t.PCL=5]="PCL",t[t.LOD=6]="LOD",t[t.VOXEL=7]="VOXEL",t[t.TILES3D=8]="TILES3D",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ObjectTarget":function(){define(["exports"],(function(e){"use strict";e.ObjectTarget=class{constructor(e,t,r){this.object=e,this.geometryId=t,this.primitiveIndex=r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/IntersectorInterfaces":function(){define(["exports"],(function(e){"use strict";var t;e.StoreResults=void 0,(t=e.StoreResults||(e.StoreResults={}))[t.MIN=0]="MIN",t[t.MINMAX=1]="MINMAX",t[t.ALL=2]="ALL",e.IntersectorOptions=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerViewUids=[],this.store=e.StoreResults.ALL,this.normalRequired=!0,this.excludeLabels=!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/verticalOffsetUtils":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/sphere","../../../ViewingMode","../../support/orientedBoundingBox"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";class u{constructor(e,t,r){this._original=e,this._update=t,this._dirty=!0,this._transform=r()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}}class d{constructor(e=0){this.offset=e,this.tmpVertex=o.create()}applyToVertex(e,t,r){const i=n.set(y,e,t,r),s=n.add(_,i,this.localOrigin),o=this.offset/n.length(s);return n.scaleAndAdd(this.tmpVertex,i,s,o),this.tmpVertex}applyToAabb(e){const t=b,r=v,i=S;for(let s=0;s<3;++s)t[s]=e[0+s]+this.localOrigin[s],r[s]=e[3+s]+this.localOrigin[s],i[s]=t[s];const s=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=s[t],e[t+3]=s[t];const n=t=>{const r=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=Math.min(e[t],r[t]),e[t+3]=Math.max(e[t+3],r[t])};for(let e=1;e<8;++e){for(let s=0;s<3;++s)i[s]=e&1<<s?r[s]:t[s];n(i)}let o=0;for(let e=0;e<3;++e)t[e]*r[e]<0&&(o|=1<<e);if(0!==o&&7!==o)for(let e=0;e<8;++e)if(0===(o&e)){for(let s=0;s<3;++s)i[s]=o&1<<s?0:e&1<<s?t[s]:r[s];n(i)}for(let t=0;t<3;++t)e[t]-=this.localOrigin[t],e[t+3]-=this.localOrigin[t];return e}}class h{constructor(e=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=o.create(),this._tmpMbs=a.create(),this._tmpObb=new c.Obb,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=n.length(e)}applyToVertex(e,t,r){const i=n.set(y,e,t,r),s=n.set(_,e,t,r+this.componentLocalOriginLength),o=this._totalOffset/n.length(s);return n.scaleAndAdd(this._tmpVertex,i,s,o),this._tmpVertex}applyToAabb(e){const t=this.componentLocalOriginLength,r=e[0],i=e[1],s=e[2]+t,n=e[3],o=e[4],a=e[5]+t,l=Math.abs(r),c=Math.abs(i),u=Math.abs(s),d=Math.abs(n),h=Math.abs(o),p=Math.abs(a),m=.5*(1+Math.sign(r*n))*Math.min(l,d),f=.5*(1+Math.sign(i*o))*Math.min(c,h),g=.5*(1+Math.sign(s*a))*Math.min(u,p),y=Math.max(l,d),_=Math.max(c,h),b=Math.max(u,p),v=Math.sqrt(m*m+f*f+g*g),S=Math.sign(l+r),w=Math.sign(c+i),x=Math.sign(u+s),T=Math.sign(d+n),C=Math.sign(h+o),P=Math.sign(p+a),M=this._totalOffset;if(v<M)return e[0]-=(1-S)*M,e[1]-=(1-w)*M,e[2]-=(1-x)*M,e[3]+=T*M,e[4]+=C*M,e[5]+=P*M,e;const R=M/Math.sqrt(y*y+_*_+b*b),E=M/v,O=E-R,A=-O;return e[0]+=r*(S*A+E),e[1]+=i*(w*A+E),e[2]+=s*(x*A+E),e[3]+=n*(T*O+R),e[4]+=o*(C*O+R),e[5]+=a*(P*O+R),e}applyToMbs(e){const t=n.length(a.getCenter(e)),r=this._totalOffset/t;return n.scaleAndAdd(a.getCenter(this._tmpMbs),a.getCenter(e),a.getCenter(e),r),this._tmpMbs[3]=e[3]+e[3]*this._totalOffset/t,this._tmpMbs}applyToObb(e){return c.computeOffsetObb(e,this._totalOffset,this._totalOffset,l.ViewingMode.Global,this._tmpObb),this._tmpObb}}class p{constructor(e=0){this.offset=e,this.sphere=a.create(),this.tmpVertex=o.create()}applyToVertex(e,t,r){const i=this.objectTransform.transform,s=n.set(y,e,t,r),o=n.transformMat4(s,s,i),a=this.offset/n.length(o);n.scaleAndAdd(o,o,o,a);const l=this.objectTransform.inverse;return n.transformMat4(this.tmpVertex,o,l),this.tmpVertex}applyToMinMax(e,t){const r=this.offset/n.length(e);n.scaleAndAdd(e,e,e,r);const i=this.offset/n.length(t);n.scaleAndAdd(t,t,t,i)}applyToAabb(e){const t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;const r=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*r,e[4]+=e[4]*r,e[5]+=e[5]*r,e}applyToBoundingSphere(e){const t=n.length(a.getCenter(e)),r=this.offset/t;return n.scaleAndAdd(a.getCenter(this.sphere),a.getCenter(e),a.getCenter(e),r),this.sphere[3]=e[3]+e[3]*this.offset/t,this.sphere}}const m=new p,f=new h,g=new d,y=o.create(),_=o.create(),b=o.create(),v=o.create(),S=o.create();e.I3SVerticalOffsetGlobalViewingMode=h,e.IntersectorTransform=class{constructor(){this._transform=s.create(),this._transformInverse=new u({value:this._transform},i.invert,s.create),this._transformInverseTranspose=new u(this._transformInverse,i.transpose,s.create),this._transformTranspose=new u({value:this._transform},i.transpose,s.create),this._transformInverseRotation=new u({value:this._transform},t.normalFromMat4Legacy,r.create)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){i.copy(this._transform,e)}multiplyTransform(e){i.multiply(this._transform,this._transform,e)}set(e){i.copy(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this._invalidateLazyTransforms()}},e.Object3DVerticalOffsetGlobalViewingMode=p,e.TerrainVerticalOffsetGlobalViewingMode=d,e.getVerticalOffsetI3S=function(e){return null!=e?(f.offset=e,f):null},e.getVerticalOffsetObject3D=function(e){return null!=e?(m.offset=e,m):null},e.getVerticalOffsetTerrain=function(e){return null!=e?(g.offset=e,g):null},e.terrainId="terrain",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/orientedBoundingBox":function(){define(["exports","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/quat","../../../core/libs/gl-matrix-2/factories/quatf64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/ellipsoidUtils","../../../geometry/spatialReferenceEllipsoidUtils","../../../geometry/projection/computeTranslationToOriginAndRotation","../../../geometry/projection/projectBuffer","../../../geometry/projection/projectors","../../../geometry/support/plane","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/vectorStacks","../../ViewingMode","./dito","../webgl-engine/lib/Attribute"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v){"use strict";class S{constructor(e=a.ZEROS,t=q,r=n.IDENTITY){this._data=[e[0],e[1],e[2],t[0],t[1],t[2],r[0],r[1],r[2],r[3]]}clone(){const e=new S;return e._data=this._data.slice(),e}invalidate(){this._data[3]=-1}get isValid(){return this._data[3]>=0}static fromData(e){const t=new S;return t._data=e.slice(),t}static fromJSON(e){return new S(e.center,e.halfSize,e.quaternion)}copy(e){this._data=e.data.slice()}get center(){return o.set(y.sv3d.get(),this._data[0],this._data[1],this._data[2])}get centerX(){return this._data[0]}get centerY(){return this._data[1]}get centerZ(){return this._data[2]}getCenter(e){return e[0]=this._data[0],e[1]=this._data[1],e[2]=this._data[2],e}set center(e){this._data[0]=e[0],this._data[1]=e[1],this._data[2]=e[2]}setCenter(e,t,r){this._data[0]=e,this._data[1]=t,this._data[2]=r}get halfSize(){return o.set(y.sv3d.get(),this._data[3],this._data[4],this._data[5])}get halfSizeX(){return this._data[3]}get halfSizeY(){return this._data[4]}get halfSizeZ(){return this._data[5]}getHalfSize(e){return e[0]=this._data[3],e[1]=this._data[4],e[2]=this._data[5],e}set halfSize(e){this._data[3]=e[0],this._data[4]=e[1],this._data[5]=e[2]}get quaternion(){return s.set(y.sq4d.get(),this._data[6],this._data[7],this._data[8],this._data[9])}getQuaternion(e){return e[0]=this._data[6],e[1]=this._data[7],e[2]=this._data[8],e[3]=this._data[9],e}set quaternion(e){this._data[6]=e[0],this._data[7]=e[1],this._data[8]=e[2],this._data[9]=e[3]}get data(){return this._data}getCorners(e){const t=w,r=this._data;t[0]=r[6],t[1]=r[7],t[2]=r[8],t[3]=r[9];for(let i=0;i<8;++i){const s=e[i];s[0]=(1&i?-1:1)*r[3],s[1]=(2&i?-1:1)*r[4],s[2]=(4&i?-1:1)*r[5],o.transformQuat(s,s,t),s[0]+=r[0],s[1]+=r[1],s[2]+=r[2]}}doesIntersectFrustumConservativeApproximation(e){return this.intersectPlane(e[0])<=0&&this.intersectPlane(e[1])<=0&&this.intersectPlane(e[2])<=0&&this.intersectPlane(e[3])<=0&&this.intersectPlane(e[4])<=0&&this.intersectPlane(e[5])<=0}get radius(){const e=this._data[3],t=this._data[4],r=this._data[5];return Math.sqrt(e*e+t*t+r*r)}intersectSphere(e){C[0]=this._data[0]-e[0],C[1]=this._data[1]-e[1],C[2]=this._data[2]-e[2];const t=this.getQuaternion(x);return s.conjugate(w,t),o.transformQuat(C,C,w),o.abs(C,C),P[0]=Math.min(C[0],this._data[3]),P[1]=Math.min(C[1],this._data[4]),P[2]=Math.min(C[2],this._data[5]),o.sqrDist(P,C)<e[3]*e[3]}intersectSphereWithMBS(e,t=this.radius){const r=this._data;C[0]=r[0]-e[0],C[1]=r[1]-e[1],C[2]=r[2]-e[2];const i=e[3],s=i+t;return!(o.sqrLen(C)>s*s)&&(w[0]=-r[6],w[1]=-r[7],w[2]=-r[8],w[3]=r[9],o.transformQuat(C,C,w),o.abs(C,C),P[0]=Math.min(C[0],r[3]),P[1]=Math.min(C[1],r[4]),P[2]=Math.min(C[2],r[5]),o.sqrDist(P,C)<i*i)}intersectPlane(e){const t=e[0]*this._data[0]+e[1]*this._data[1]+e[2]*this._data[2]+e[3],r=this.projectedRadius(f.getNormal(e));return t>r?1:t<-r?-1:0}intersectRay(e,t,r=0){const i=this._data,s=w;s[0]=-i[6],s[1]=-i[7],s[2]=-i[8],s[3]=i[9],C[0]=e[0]-i[0],C[1]=e[1]-i[1],C[2]=e[2]-i[2];const n=o.transformQuat(C,C,w),a=o.transformQuat(P,t,w);let l=-1/0,c=1/0;const u=this.getHalfSize(U);for(let e=0;e<3;e++){const t=n[e],i=a[e],s=u[e]+r;if(Math.abs(i)>1e-6){const e=(s-t)/i,r=(-s-t)/i;l=Math.max(l,Math.min(e,r)),c=Math.min(c,Math.max(e,r))}else if(t>s||t<-s)return!1}return l<=c}projectedArea(e,r,i,n){const a=this.getQuaternion(x);s.conjugate(w,a),C[0]=e[0]-this._data[0],C[1]=e[1]-this._data[1],C[2]=e[2]-this._data[2],o.transformQuat(C,C,w);const c=this.getHalfSize(U),u=C[0]<-c[0]?-1:C[0]>c[0]?1:0,d=C[1]<-c[1]?-1:C[1]>c[1]?1:0,h=C[2]<-c[2]?-1:C[2]>c[2]?1:0,p=Math.abs(u)+Math.abs(d)+Math.abs(h);if(0===p)return 1/0;const m=1===p?4:6,f=6*(u+3*d+9*h+13);t.fromQuat(V,a),t.scale(V,V,c);const g=this.getCenter(L);for(let e=0;e<m;e++){const t=O[f+e];o.set(C,((1&t)<<1)-1,(2&t)-1,((4&t)>>1)-1),o.transformMat3(C,C,V),o.add(M,g,C),M[3]=1,l.transformMat4(M,M,r);const i=1/Math.max(1e-6,M[3]);E[2*e]=M[0]*i,E[2*e+1]=M[1]*i}const y=2*m-2;let _=E[0]*(E[3]-E[y+1])+E[y]*(E[1]-E[y-1]);for(let e=2;e<y;e+=2)_+=E[e]*(E[e+3]-E[e-1]);return Math.abs(_)*i*n*.125}projectedRadius(e){const t=this.getQuaternion(x);return s.conjugate(w,t),o.transformQuat(C,e,w),Math.abs(C[0]*this._data[3])+Math.abs(C[1]*this._data[4])+Math.abs(C[2]*this._data[5])}minimumDistancePlane(e){return e[0]*this._data[0]+e[1]*this._data[1]+e[2]*this._data[2]+e[3]-this.projectedRadius(f.getNormal(e))}maximumDistancePlane(e){return e[0]*this._data[0]+e[1]*this._data[1]+e[2]*this._data[2]+e[3]+this.projectedRadius(f.getNormal(e))}toAaBoundingBox(e){const r=this.getQuaternion(x),i=t.fromQuat(V,r),s=this._data[3]*Math.abs(i[0])+this._data[4]*Math.abs(i[3])+this._data[5]*Math.abs(i[6]),n=this._data[3]*Math.abs(i[1])+this._data[4]*Math.abs(i[4])+this._data[5]*Math.abs(i[7]),o=this._data[3]*Math.abs(i[2])+this._data[4]*Math.abs(i[5])+this._data[5]*Math.abs(i[8]);e[0]=this._data[0]-s,e[1]=this._data[1]-n,e[2]=this._data[2]-o,e[3]=this._data[0]+s,e[4]=this._data[1]+n,e[5]=this._data[2]+o}transform(e,t,r,i=0,n=d.getSphericalPCPF(r),a=d.getSphericalPCPF(t),l=m.getProjector(t,a)){if(r===n)t.isGeographic?function(e,t,r,i,n=d.getSphericalPCPF(r)){const a=u.getReferenceEllipsoid(r),l=1+Math.max(0,i)/(a.radius+e.centerZ);e.getCenter(F),F[2]+=i,p.projectBuffer(F,r,0,F,n,0),t.center=F;const c=e.getQuaternion(x);t.quaternion=c,s.conjugate(w,c),o.set(k,0,0,1),o.transformQuat(k,k,w);const h=e.getHalfSize(U);o.set(k,h[0]*Math.abs(k[0]),h[1]*Math.abs(k[1]),h[2]*Math.abs(k[2])),o.scale(k,k,a.inverseFlattening),o.add(k,h,k),t.halfSize=o.scale(k,k,l)}(this,e,t,i,a):function(e,t,r,i,n=d.getSphericalPCPF(r),a=m.getProjector(r,n)){e.getCorners(G),e.getCenter(F),F[2]+=i,h.computeTranslationToOriginAndRotation(r,F,B,n),t.setCenter(B[12],B[13],B[14]);const l=2*Math.sqrt(1+B[0]+B[5]+B[10]);w[0]=(B[6]-B[9])/l,w[1]=(B[8]-B[2])/l,w[2]=(B[1]-B[4])/l,w[3]=.25*l;const c=e.getQuaternion(x);t.quaternion=s.multiply(w,w,c),s.conjugate(w,w),o.set(z,0,0,0);const u=t.getCenter(N);for(const e of G)e[2]+=i,a(e,0,e,0),o.sub(k,e,u),o.transformQuat(k,k,w),o.abs(k,k),o.max(z,z,k);t.halfSize=z}(this,e,t,i,a,l);else if(t.isWGS84&&(r.isWebMercator||g.isPlateCarree(r)))!function(e,t,r,i,s){t.getCenter(L),L[2]+=s;const n=d.getSphericalPCPF(r);p.projectBuffer(L,e,0,L,n,0),A(n,t,L,r,i)}(t,this,r,e,i);else if(t.isWebMercator&&g.isPlateCarree(r))!function(e,t,r,i,s){t.getCenter(L),L[2]+=s,A(e,t,L,r,i)}(t,this,r,e,i);else{const s=this.getCenter(L);s[2]+=i,p.projectBuffer(s,t,0,s,r,0),e.center=s,this!==e&&(e.quaternion=this.getQuaternion(x),e.halfSize=this.getHalfSize(U))}}}const w=n.create(),x=n.create(),T=n.create(),C=a.create(),P=a.create(),M=c.create();function R(e,t=new S){return b.computeOBB(e,t),t}const E=[.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.1,1.2],O=(()=>{const e=new Int8Array(162);let t=0;const r=r=>{for(let i=0;i<r.length;i++)e[t+i]=r[i];t+=6};return r([6,2,3,1,5,4]),r([0,2,3,1,5,4]),r([0,2,3,7,5,4]),r([0,1,3,2,6,4]),r([0,1,3,2,0,0]),r([0,1,5,7,3,2]),r([0,1,3,7,6,4]),r([0,1,3,7,6,2]),r([0,1,5,7,6,2]),r([0,1,5,4,6,2]),r([0,1,5,4,0,0]),r([0,1,3,7,5,4]),r([0,2,6,4,0,0]),r([0,0,0,0,0,0]),r([1,3,7,5,0,0]),r([2,3,7,6,4,0]),r([2,3,7,6,0,0]),r([2,3,1,5,7,6]),r([0,1,5,7,6,2]),r([0,1,5,7,6,4]),r([0,1,3,7,6,4]),r([4,5,7,6,2,0]),r([4,5,7,6,0,0]),r([4,5,1,3,7,6]),r([0,2,3,7,5,4]),r([6,2,3,7,5,4]),r([6,2,3,1,5,4]),e})();function A(e,r,i,s,n){const o=r.getQuaternion(x),a=t.fromQuat(V,o),l=r.getHalfSize(U);for(let e=0;e<8;++e){for(let t=0;t<3;++t)F[t]=l[t]*(e&1<<t?-1:1);for(let t=0;t<3;++t){let r=i[t];for(let e=0;e<3;++e)r+=F[e]*a[3*e+t];I[3*e+t]=r}}p.projectBuffer(I,e,0,I,s,0,8),R(D,n)}const I=new Array(24),D=new v.Vertices(I,3),F=a.create(),L=a.create(),N=a.create(),U=a.create(),V=r.create(),B=i.create(),G=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],k=a.create(),z=a.create(),j=a.create(),q=a.freeze(-1,-1,-1);e.Obb=S,e.compute=R,e.computeOffsetObb=function(e,t,r,i,n){const l=e.getQuaternion(x);n.quaternion=l,s.conjugate(w,l);const c=e.getCenter(L),u=e.getHalfSize(U);if(i===_.ViewingMode.Global){o.transformQuat(k,c,w),o.abs(z,k),o.min(j,z,u),o.sub(j,z,j);const i=o.length(j);o.add(j,z,u);const s=o.length(j);if(i<r)n.center=c,o.set(k,r,r,r),n.halfSize=o.add(k,u,k);else{const a=s>0?1+t/s:1,l=i>0?1+r/i:1,c=(l+a)/2,d=(l-a)/2;o.scale(j,z,d),n.halfSize=o.scaleAndAdd(j,j,u,c),o.scale(j,z,c),o.scaleAndAdd(j,j,u,d),o.sign(k,k),o.multiply(k,j,k);const h=e.getQuaternion(T);n.center=o.transformQuat(k,k,h)}}else{n.center=o.scaleAndAdd(k,c,a.UNIT_Z,(r+t)/2);const e=o.transformQuat(k,a.UNIT_Z,w);o.abs(e,e),n.halfSize=o.scaleAndAdd(z,u,e,(r-t)/2)}return n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/projection/computeTranslationToOriginAndRotation":function(){define(["exports","../../core/mathUtils","../../core/libs/gl-matrix-2/math/mat4","../../core/libs/gl-matrix-2/factories/vec3f64","./localRotationUtils","./projectors","../support/spatialReferenceUtils"],(function(e,t,r,i,s,n,o){"use strict";function a(e){return e===n.ProjectionID.SPHERICAL_ECEF||e===n.ProjectionID.SPHERICAL_MARS_PCPF||e===n.ProjectionID.SPHERICAL_MOON_PCPF||e===n.ProjectionID.WGS84_ECEF}const l=t.deg2rad(1),c=i.create(),u=i.create();e.computeTranslationToOriginAndRotation=function(e,t,i,d){const h=n.getProjectorClassification(e,d);if(null==h)return!1;const p=h.source.spatialReferenceId,m=h.dest.spatialReferenceId;if(p===m&&!a(m)&&(p!==n.ProjectionID.UNKNOWN||o.equals(e,d)))return r.fromTranslation(i,t),!0;if(a(m)){const e=n.projectionTable[p][n.ProjectionID.LON_LAT],r=n.projectionTable[n.ProjectionID.LON_LAT][m];return null!=e&&null!=r&&(e(t,0,c,0),r(c,0,u,0),s.computeENUToPCPFLocalRotation(l*c[0],l*c[1],i),i[12]=u[0],i[13]=u[1],i[14]=u[2],!0)}const f=a(p);if((m===n.ProjectionID.WEB_MERCATOR||m===n.ProjectionID.PLATE_CARREE||m===n.ProjectionID.WGS84||m===n.ProjectionID.CGCS2000)&&(p===n.ProjectionID.WGS84||f||p===n.ProjectionID.WEB_MERCATOR||p===n.ProjectionID.CGCS2000)){const e=n.projectionTable[p][n.ProjectionID.LON_LAT],o=n.projectionTable[n.ProjectionID.LON_LAT][m];return null!=e&&null!=o&&(e(t,0,c,0),o(c,0,u,0),f?s.computePCPFToENULocalRotation(l*c[0],l*c[1],i):r.identity(i),i[12]=u[0],i[13]=u[1],i[14]=u[2],!0)}return!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/projection/localRotationUtils":function(){define(["exports","../../core/libs/gl-matrix-2/math/mat4"],(function(e,t){"use strict";function r(e,t,r){const i=Math.sin(e),s=Math.cos(e),n=Math.sin(t),o=Math.cos(t),a=r;return a[0]=-i,a[4]=-n*s,a[8]=o*s,a[12]=0,a[1]=s,a[5]=-n*i,a[9]=o*i,a[13]=0,a[2]=0,a[6]=o,a[10]=n,a[14]=0,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a}e.computeENUToPCPFLocalRotation=r,e.computePCPFToENULocalRotation=function(e,i,s){return r(e,i,s),t.transpose(s,s),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/dito":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/quatf64","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../webgl-engine/lib/Attribute"],(function(e,t,r,i,s,n,o){"use strict";const a=1e-6,l=n.create(),c=n.create(),u=n.create(),d=n.create(),h=n.create(),p=n.create(),m=n.create(),f=n.create(),g=n.create(),y=n.create(),_=[0,0,0],b=i.create(),v=n.create(),S=n.create(),w=n.create(),x=n.create(),T=n.create(),C=n.create();function P(e,t,r,i,s,n){if(J(t)<a)return;X(v,r,t),X(S,i,t),X(w,s,t),R(e,t,b),T[1]=b[0],x[1]=b[1],C[1]=x[1]-T[1];const o=[r,i,s],l=[v,S,w];for(let r=0;r<3;++r){R(e,o[r],b),T[0]=b[0],x[0]=b[1],R(e,l[r],b),T[2]=b[0],x[2]=b[1],C[0]=x[0]-T[0],C[2]=x[2]-T[2];const i=W(C);i<n.quality&&(Y(n.b0,o[r]),Y(n.b1,t),Y(n.b2,l[r]),n.quality=i)}}const M=n.create();function R(e,t,r){const{data:i,size:s}=e;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(let e=0;e<i.length;e+=s){const s=i[e]*t[0]+i[e+1]*t[1]+i[e+2]*t[2];r[0]=Math.min(r[0],s),r[1]=Math.max(r[1],s)}}function E(e,t,i){i.center=e,i.halfSize=s.scale(t,t,.5),i.quaternion=r.IDENTITY}const O=n.create(),A=n.create(),I=n.create(),D=n.create(),F=n.create(),L=n.create();function N(e,t,r){Y(O,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?O[0]=0:Math.abs(t[1])>Math.abs(t[2])?O[1]=0:O[2]=0,J(O)<a&&(O[0]=O[1]=O[2]=1),X(A,t,O),K(A,A),X(I,t,A),K(I,I),U(e,t,A,I,D,F),Q(L,F,D),j(t,A,I,D,F,L,r)}function U(e,t,r,i,s,n){R(e,t,b),s[0]=b[0],n[0]=b[1],R(e,r,b),s[1]=b[0],n[1]=b[1],R(e,i,b),s[2]=b[0],n[2]=b[1]}const V=n.create(),B=n.create(),G=n.create(),k=t.fromValues(1,0,0,0,1,0,0,0,1),z=r.create();function j(e,t,r,i,n,o,a){k[0]=e[0],k[1]=e[1],k[2]=e[2],k[3]=t[0],k[4]=t[1],k[5]=t[2],k[6]=r[0],k[7]=r[1],k[8]=r[2],a.quaternion=function(e,t){const r=t[0]+t[4]+t[8];if(r>0){let i=Math.sqrt(r+1);e[3]=.5*i,i=.5/i,e[0]=(t[5]-t[7])*i,e[1]=(t[6]-t[2])*i,e[2]=(t[1]-t[3])*i}else{let r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);const i=(r+1)%3,s=(r+2)%3;let n=Math.sqrt(t[3*r+r]-t[3*i+i]-t[3*s+s]+1);e[r]=.5*n,n=.5/n,e[3]=(t[3*i+s]-t[3*s+i])*n,e[i]=(t[3*i+r]+t[3*r+i])*n,e[s]=(t[3*s+r]+t[3*r+s])*n}return e}(z,k),$(V,i,n),Z(V,V,.5),Z(B,e,V[0]),Z(G,t,V[1]),$(B,B,G),Z(G,r,V[2]),a.center=s.add(B,B,G),a.halfSize=s.scale(V,o,.5)}class q{constructor(e){this.minVert=new Array(7),this.maxVert=new Array(7),this.buffer=new ArrayBuffer(448);let t=0;this.minProj=new Float64Array(this.buffer,t,7),t+=56,this.maxProj=new Float64Array(this.buffer,t,7),t+=56;for(let e=0;e<7;++e)this.minVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.maxVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.minProj[e]=Number.POSITIVE_INFINITY,this.maxProj[e]=Number.NEGATIVE_INFINITY;const r=new Array(7),i=new Array(7),{data:s,size:n}=e;for(let e=0;e<s.length;e+=n){let t=s[e];t<this.minProj[0]&&(this.minProj[0]=t,r[0]=e),t>this.maxProj[0]&&(this.maxProj[0]=t,i[0]=e),t=s[e+1],t<this.minProj[1]&&(this.minProj[1]=t,r[1]=e),t>this.maxProj[1]&&(this.maxProj[1]=t,i[1]=e),t=s[e+2],t<this.minProj[2]&&(this.minProj[2]=t,r[2]=e),t>this.maxProj[2]&&(this.maxProj[2]=t,i[2]=e),t=s[e]+s[e+1]+s[e+2],t<this.minProj[3]&&(this.minProj[3]=t,r[3]=e),t>this.maxProj[3]&&(this.maxProj[3]=t,i[3]=e),t=s[e]+s[e+1]-s[e+2],t<this.minProj[4]&&(this.minProj[4]=t,r[4]=e),t>this.maxProj[4]&&(this.maxProj[4]=t,i[4]=e),t=s[e]-s[e+1]+s[e+2],t<this.minProj[5]&&(this.minProj[5]=t,r[5]=e),t>this.maxProj[5]&&(this.maxProj[5]=t,i[5]=e),t=s[e]-s[e+1]-s[e+2],t<this.minProj[6]&&(this.minProj[6]=t,r[6]=e),t>this.maxProj[6]&&(this.maxProj[6]=t,i[6]=e)}for(let e=0;e<7;++e){let t=r[e];Y(this.minVert[e],s,t),t=i[e],Y(this.maxVert[e],s,t)}}}class H{constructor(){this.b0=n.fromValues(1,0,0),this.b1=n.fromValues(0,1,0),this.b2=n.fromValues(0,0,1),this.quality=0}}function W(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function $(e,t,r){e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2]}function Q(e,t,r){e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2]}function Z(e,t,r){e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}function Y(e,t,r=0){e[0]=t[r],e[1]=t[r+1],e[2]=t[r+2]}function X(e,t,r){const i=t[0],s=t[1],n=t[2],o=r[0],a=r[1],l=r[2];e[0]=s*l-n*a,e[1]=n*o-i*l,e[2]=i*a-s*o}function K(e,t){const r=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(r>0){const i=1/Math.sqrt(r);e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}}function J(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function ee(e,t){const r=t[0]-e[0],i=t[1]-e[1],s=t[2]-e[2];return r*r+i*i+s*s}function te(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}e.computeOBB=function(e,t){const{data:r,size:i}=e,s=r.length/i;if(s<=0)return;const v=new q(e);$(l,v.minProj,v.maxProj),Z(l,l,.5),Q(c,v.maxProj,v.minProj);const S=W(c),w=new H;w.quality=S,s<14&&(e=new o.Vertices(new Float64Array(v.buffer,112,42),3));const x=n.create(),T=n.create(),C=n.create(),R=n.create(),O=n.create(),A=n.create(),I=n.create();switch(function(e,t,r,i,s,n,o,l,c,u){if(function(e,t,r){let i=ee(e.maxVert[0],e.minVert[0]),s=0;for(let t=1;t<7;++t){const r=ee(e.maxVert[t],e.minVert[t]);r>i&&(i=r,s=t)}Y(t,e.minVert[s]),Y(r,e.maxVert[s])}(e,i,s),ee(i,s)<a)return 1;Q(o,i,s),K(o,o);const d=function(e,t,r,i){const{data:s,size:n}=e;let o=Number.NEGATIVE_INFINITY,a=0;for(let e=0;e<s.length;e+=n){_[0]=s[e]-t[0],_[1]=s[e+1]-t[1],_[2]=s[e+2]-t[2];const i=r[0]*_[0]+r[1]*_[1]+r[2]*_[2],n=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],l=_[0]*_[0]+_[1]*_[1]+_[2]*_[2]-i*i/n;l>o&&(o=l,a=e)}return Y(i,s,a),o}(t,i,o,n);return d<a?2:(Q(l,s,n),K(l,l),Q(c,n,i),K(c,c),X(r,l,o),K(r,r),P(t,r,o,l,c,u),0)}(v,e,I,x,T,C,R,O,A,w)){case 1:return void E(l,c,t);case 2:return void N(e,R,t)}!function(e,t,r,i,s,n,o,l,c){(function(e,t,r,i,s){!function(e,t,r,i,s){const{data:n,size:o}=e;Y(i,n),Y(s,i),r[0]=te(M,t),r[1]=r[0];for(let e=o;e<n.length;e+=o){const o=n[e]*t[0]+n[e+1]*t[1]+n[e+2]*t[2];o<r[0]&&(r[0]=o,Y(i,n,e)),o>r[1]&&(r[1]=o,Y(s,n,e))}}(e,t,b,s,i);const n=te(r,t);b[1]-a<=n&&(i[0]=void 0),b[0]+a>=n&&(s[0]=void 0)})(e,t,r,u,d),void 0!==u[0]&&(Q(h,u,r),K(h,h),Q(p,u,i),K(p,p),Q(m,u,s),K(m,m),X(f,p,n),K(f,f),X(g,m,o),K(g,g),X(y,h,l),K(y,y),P(e,f,n,p,h,c),P(e,g,o,m,p,c),P(e,y,l,h,m,c)),void 0!==d[0]&&(Q(h,d,r),K(h,h),Q(p,d,i),K(p,p),Q(m,d,s),K(m,m),X(f,p,n),K(f,f),X(g,m,o),K(g,g),X(y,h,l),K(y,y),P(e,f,n,p,h,c),P(e,g,o,m,p,c),P(e,y,l,h,m,c))}(e,I,x,T,C,R,O,A,w),U(e,w.b0,w.b1,w.b2,D,F);const L=n.create();Q(L,F,D),w.quality=W(L),w.quality<S?j(w.b0,w.b1,w.b2,D,F,L,t):E(l,c,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Attribute":function(){define(["exports"],(function(e){"use strict";class t{constructor(e,t,r=t){this.data=e,this.size=t,this.stride=r}}e.Attribute=class extends t{constructor(e,t,r,i=!1,s=r){super(e,r,s),this.indices=t,this.exclusive=i}},e.Vertices=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/cameraUtilsPlanar":function(){define(["exports","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","../core/libs/gl-matrix-2/factories/vec2f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/Extent","../geometry/Polygon","../geometry/projection/projectPointToVector","../geometry/projection/projectVectorToVector","../geometry/support/coordsUtils","../geometry/support/frustum","../geometry/support/polygonExtentClipping","../geometry/support/ray","../views/3d/state/Frustum","../views/3d/support/cameraUtilsInternal"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g){"use strict";const y=o.fromValues(0,1,0),_=o.fromValues(0,0,1),b=i.create(),v=o.create(),S=o.create();function w(e,i,s,o=g.createDirectionUp()){const{direction:a,up:l}=o;return r.fromZRotation(b,-t.deg2rad(i)),r.rotateX(b,b,t.deg2rad(s)),n.transformMat4(a,_,b),n.scale(a,a,-1),n.transformMat4(l,y,b),o}function x(e,t,r,i){return g.directionToHeadingTilt(t,r,i,_,y)}function T(e,t,r,i){const s=w(0,r,i),a=o.create();return n.scale(a,s.direction,-t),n.add(a,a,e),{up:s.up,eye:a,heading:r,tilt:i}}function C(e){return t.rad2deg(e)}function P(e){return t.deg2rad(e)}function M(e,t,r,i,s){const n=e.renderSpatialReference,o=e.spatialReference??t.spatialReference;return c.projectPointToVector(t,v,n),c.projectPointToVector(t,S,n),v[0]-=r/2,S[0]+=r/2,v[1]-=i/2,S[1]+=i/2,u.projectVectorToVector(v,n,v,o),u.projectVectorToVector(S,n,S,o),s?(s.xmin=v[0],s.ymin=v[1],s.xmax=S[0],s.ymax=S[1],s.spatialReference=o):s=new a(v[0],v[1],S[0],S[1],o),s}function R(e,t){const r=e.frustum,{renderCoordsHelper:i}=e,o=i.getAltitude(t),a=e.spatialReference,c=e.state.camera.eye,u=[],f=r.planes[h.PlaneIndex.FAR];for(let e=0;e<4;e++){const t=r.lines[e];i.intersectInfiniteManifold(m.wrap(t.origin,t.direction),o,O)||E(O,r,i,t.endpoint,o),g.clampLineSegmentToPlane(O,c,O,f),u.push(s.fromValues(O[0],O[1]))}return function(e,t,r){const i=e.map((e=>(n.set(O,e[0],e[1],0),t.fromRenderCoords(O,O,r),[O[0],O[1]])));return i.length<=2?new l({spatialReference:r}):(i.push(i[0].slice()),d.isClockwise(i)||i.reverse(),new l({rings:[i],spatialReference:r}))}(p.clipPolygonToExtent(u,i.extent),i,a)}function E(e,t,r,i,s){const o=t.lines[f.LineIndex.FAR_LEFT].direction,a=(s-r.getAltitude(i))/o[2];n.scaleAndAdd(e,i,o,a)}const O=o.create(),A=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:x,eyeForCenterWithHeadingTilt:T,eyeTiltToLookAtTilt:P,headingTiltToDirectionUp:w,lookAtTiltToEyeTilt:C,toArea:R,toExtent:M},Symbol.toStringTag,{value:"Module"}));e.cameraUtilsPlanar=A,e.directionToHeadingTilt=x,e.eyeForCenterWithHeadingTilt=T,e.eyeTiltToLookAtTilt=P,e.headingTiltToDirectionUp=w,e.lookAtTiltToEyeTilt=C,e.toArea=R,e.toExtent=M}))},"esri/geometry/support/polygonExtentClipping":function(){define(["exports","../../core/libs/gl-matrix-2/math/vec2","../../core/libs/gl-matrix-2/factories/vec2f64"],(function(e,t,r){"use strict";function i(e,t,i,c){const u=function(e,t){const r=t===a.LEFT||t===a.RIGHT?0:1,i=e[t],s=t===a.LEFT||t===a.BOTTOM?n.MIN:n.MAX,l=0===r?1:0;return(e,t,a)=>{if(t[r]<i&&a[r]<i)return s===n.MIN?o.OUTSIDE:o.INSIDE;if(t[r]>i&&a[r]>i)return s===n.MIN?o.INSIDE:o.OUTSIDE;const c=(a[l]-t[l])/(a[r]-t[r]),u=t[l]+c*(i-t[r]);return e[r]=i,e[l]=u,(t[r]<i?1:-1)*s>0?o.OUTSIDE_IN:o.INSIDE_OUT}}(i,c);if(e.length=0,t.length){u(l,t[0],t[0])===o.INSIDE&&s(e,t[0]);for(let i=0;i<t.length;i++){const n=t[i===t.length-1?0:i+1];switch(u(l,t[i],n)){case o.INSIDE:s(e,n);break;case o.INSIDE_OUT:s(e,r.clone(l));break;case o.OUTSIDE_IN:s(e,r.clone(l)),s(e,n);case o.OUTSIDE:}}}}function s(e,r){0!==e.length&&t.equals(e.at(-1),r)||e.push(r)}var n,o,a;!function(e){e[e.MIN=1]="MIN",e[e.MAX=-1]="MAX"}(n||(n={})),function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INSIDE=1]="INSIDE",e[e.OUTSIDE_IN=2]="OUTSIDE_IN",e[e.INSIDE_OUT=3]="INSIDE_OUT"}(o||(o={})),function(e){e[e.LEFT=0]="LEFT",e[e.BOTTOM=1]="BOTTOM",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP"}(a||(a={}));const l=r.create();e.clipPolygonToExtent=function(e,t){const r=[],s=[];return i(r,e,t,a.LEFT),i(s,r,t,a.BOTTOM),i(r,s,t,a.RIGHT),i(s,r,t,a.TOP),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/Frustum":function(){define(["exports","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/frustum"],(function(e,t,r,i){"use strict";class s{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=i.create(),this._points=i.createPoints(),this.lines=new Array(12),this._origin=r.create(),this._direction=r.create(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:r.create(),endpoint:null}}update(e){i.fromMatrix(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),t.copy(this._origin,e.eye),t.copy(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let r=0;r<this._points.length;r++)t.copy(this._points[r],e[r]);i.computePlanes(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return i.intersectsSphere(this.frustum,e)}intersectsRay(e){return i.intersectsRay(this.frustum,e)}intersectsLineSegment(e,t){return i.intersectsLineSegment(this.frustum,e,t)}intersectsPoint(e){return i.intersectsPoint(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const r=t+4;o(this.lines[t],e[t],e[r]),o(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),o(this.lines[t+8],e[r],3===t?e[4]:e[r+1])}}static{this.planePointIndices=i.planePointIndices}static{this.nearFarLineIndices=[[i.PointIndex.NEAR_BOTTOM_LEFT,i.PointIndex.FAR_BOTTOM_LEFT],[i.PointIndex.NEAR_BOTTOM_RIGHT,i.PointIndex.FAR_BOTTOM_RIGHT],[i.PointIndex.NEAR_TOP_RIGHT,i.PointIndex.FAR_TOP_RIGHT],[i.PointIndex.NEAR_TOP_LEFT,i.PointIndex.FAR_TOP_LEFT]]}}var n;function o(e,r,i){e.origin=r,e.endpoint=i,t.direction(e.direction,r,i)}e.LineIndex=void 0,(n=e.LineIndex||(e.LineIndex={}))[n.NEAR_FAR_BOTTOM_LEFT=0]="NEAR_FAR_BOTTOM_LEFT",n[n.NEAR_FAR_BOTTOM_RIGHT=1]="NEAR_FAR_BOTTOM_RIGHT",n[n.NEAR_FAR_TOP_RIGHT=2]="NEAR_FAR_TOP_RIGHT",n[n.NEAR_FAR_TOP_LEFT=3]="NEAR_FAR_TOP_LEFT",n[n.NEAR_BOTTOM=4]="NEAR_BOTTOM",n[n.NEAR_RIGHT=5]="NEAR_RIGHT",n[n.NEAR_TOP=6]="NEAR_TOP",n[n.NEAR_LEFT=7]="NEAR_LEFT",n[n.FAR_BOTTOM=8]="FAR_BOTTOM",n[n.FAR_RIGHT=9]="FAR_RIGHT",n[n.FAR_TOP=10]="FAR_TOP",n[n.FAR_LEFT=11]="FAR_LEFT",e.Frustum=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/cameraUtilsInternal":function(){define(["exports","../../../core/mathUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/lineSegment","../../../geometry/support/plane"],(function(e,t,r,i,s,n){"use strict";const o=i.create(),a=i.create(),l=i.create();e.clampLineSegmentToPlane=function(e,t,i,o){r.subtract(l,i,t),n.intersectLineSegment(o,s.wrap(t,l),e)||e===i||r.copy(e,i)},e.createDirectionUp=function(){return{direction:i.create(),up:i.create()}},e.directionToHeadingTilt=function(e,i,s,n,l){let c=r.normalize(o,e),u=r.dot(c,n);const d=u>0;u=Math.abs(u),u>.99&&(u=Math.abs(r.dot(i,n)),u<.99?(r.copy(c,i),d&&r.scale(c,c,-1)):c=null);let h=0;if(c){r.scale(a,n,r.dot(n,c)),r.subtract(c,c,a);const e=r.dot(c,l)/(r.length(c)*r.length(l));r.cross(a,c,l),h=(r.dot(a,n)>0?1:-1)*t.rad2deg(t.acosClamped(e))}const p=t.rad2deg(t.acosClamped(-r.dot(n,e)/r.length(e)));return s?(s.heading=h,s.tilt=p,s):{heading:h,tilt:p}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/cameraUtilsSpherical":function(){define(["exports","../core/Cyclical","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","./vec42","../core/libs/gl-matrix-2/factories/vec4f64","../core/libs/gl-matrix-2/math/common","../geometry/ellipsoidUtils","../geometry/Extent","../geometry/Polygon","../geometry/SpatialReference","../geometry/support/coordsUtils","../geometry/support/frustum","../geometry/support/lineSegment","../geometry/support/plane","../geometry/support/ray","./sphere","../geometry/support/webMercatorUtils","../views/3d/state/Frustum","../views/3d/state/NearFarHeuristic","../views/3d/state/utils/viewUtils","../views/3d/support/cameraUtilsInternal","../views/3d/support/earthUtils","../views/3d/support/mathUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P){"use strict";const M=o.fromValues(0,0,1),R=n.normalize(o.create(),o.fromValues(1,1,1)),E=new t.Cyclical(-180,180),O=s.create(),A=o.create(),I=o.create();function D(e,t,s,o=T.createDirectionUp()){n.cross(A,e,M),0===n.dot(A,A)&&n.cross(A,e,R),i.fromRotation(O,-r.deg2rad(t),e),i.rotate(O,O,-r.deg2rad(s),A);const{up:a,direction:l}=o;return n.cross(a,A,e),n.normalize(a,a),n.transformMat4(a,a,O),n.normalize(l,e),n.negate(l,l),n.transformMat4(l,l,O),o}function F(e,t,r,i){const s=A,o=I;return n.normalize(s,e),n.cross(I,s,M),0===n.dot(I,I)&&n.cross(I,s,R),n.cross(o,I,s),T.directionToHeadingTilt(t,r,i,s,o)}function L(e,t,i,s){const a={eye:o.create(),up:null,tilt:s,heading:i},l=A;l[0]=e[0],l[1]=e[2],l[2]=-e[1];const c=t,u=r.deg2rad(i),d=r.deg2rad(s),h=Math.sin(u),p=Math.cos(u),m=Math.sin(d),f=Math.cos(d),g=n.length(l);let y;if(Math.abs(d)<1e-8)y=c+g;else{const e=g/m,t=r.asinClamped(c/e),i=Math.PI-d-t;y=e*Math.sin(i)}const _=f*c,b=c*c*(m*m),v=p*p*b,S=y-_,w=S*S,x=v*(v+w-l[1]*l[1]);if(x<0)return n.scale(a.eye,l,y/g),a.tilt=0,U(a,e);const T=Math.sqrt(x),C=l[1]*S,P=v+w;let M;if(M=p>0?-T+C:T+C,Math.abs(P)<1e-8)return g<1e-8?(a.eye[0]=0,a.eye[1]=0,a.eye[2]=c):n.scale(a.eye,l,y/g),a.tilt=0,N(a.eye),U(a,e);a.eye[1]=M/P;const R=h*h*b,E=m*c,O=p*E*a.eye[1],I=a.eye[1]*a.eye[1],D=1-I,F=Math.sqrt(D),L=v*I+R-2*O*F*S+D*w;return Math.abs(L)<1e-8?(n.scale(a.eye,l,y/g),a.tilt=0,N(a.eye),U(a,e)):(a.eye[0]=(D*(y*l[0]-_*l[0])-E*F*(l[0]*a.eye[1]*p+l[2]*h))/L,a.eye[2]=(D*(y*l[2]-_*l[2])-E*F*(l[2]*a.eye[1]*p-l[0]*h))/L,n.scale(a.eye,a.eye,y),N(a.eye),U(a,e))}function N(e){const t=e[1];e[1]=-e[2],e[2]=t}function U(e,t){const r=D(t,e.heading,e.tilt);return e.up=r.up,e}function V(e,t,i){const s=n.length(t),o=Math.sqrt(i*i+s*s-2*i*s*Math.cos(Math.PI-e)),a=r.asinClamped(i/(o/Math.sin(e)));return r.rad2deg(e-a)}function B(e,t,i){const s=r.deg2rad(e),o=n.length(t);return r.asinClamped(i/(o/Math.sin(s)))+s}function G(e,i,s,n,o){let a,l,c,h;const m=i.latitude,f=u.getReferenceEllipsoid(e.spatialReference).radius,g=i.longitude,y=C.getLonDeltaForDistance(m,s,f)/2;a=g-y,l=g+y;const _=r.deg2rad(m),b=(1+Math.sin(_))/(1-Math.sin(_)),S=(b+1)*Math.tan(n/f/2),w=S*S;function x(e){const r=Math.PI/2;return(e=t.cyclical2PI.normalize(e,-r))>r&&(e=Math.PI-e),e}if(c=1.5*Math.PI-2*Math.atan(.5*(S+Math.sqrt(4*b+w))),h=c+n/f,c=x(c),h=x(h),h<c){const e=h;h=c,c=e}if(c=Math.max(r.rad2deg(c),-90),h=Math.min(r.rad2deg(h),90),l=E.monotonic(a,l),l-a>180){const e=(l-a-180)/2;a+=e,l-=e}const T=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:p.WGS84;return o?(o.xmin=a,o.ymin=c,o.xmax=l,o.ymax=h,o.spatialReference=T):o=new d(a,c,l,h,T),e.spatialReference&&e.spatialReference.isWebMercator&&v.geographicToWebMercator(o,!1,o),o}function k(e,t){const{renderCoordsHelper:i}=e,s=e.state.camera.clone(),l=new S.Frustum(i);s.near=w.minNearDistanceInMeters,l.update(s);const u=i.getAltitude(t),d=e.spatialReference,p=i.referenceEllipsoid.radius,g=s.eye,v=1+n.distance(g,t)/(p+u),C=Math.sqrt(v*v-1),{minCurvature:M,maxCurvature:R,minSamples:E,maxSamples:O}=j,A=function(e){const{renderCoordsHelper:t,state:{camera:r}}=e,{center:i,eye:s}=r,n=Math.abs(t.getAltitude(i)),o=Math.abs(Math.PI/2-x.viewAngle(t,i,s));return b.fromRadius(Z,t.referenceEllipsoid.radius+n),b.cameraFrustumCoverage(Z,o,r.distance,r.fovY)}(e),I=r.clamp((C-M)/(R-M),0,1),D=Math.round(r.lerp(E,O,I)),F=s.aboveGround,L=l.planes[f.PlaneIndex.FAR],N=[],U=y.fromPositionAndNormal(o.ZEROS,q,y.create()),V=y.fromPositionAndNormal(o.ZEROS,H,y.create());a.set(X,0,0,0,0);for(let e=0;e<4;e++){const t=e===S.LineIndex.NEAR_FAR_BOTTOM_RIGHT&&!F||e===S.LineIndex.NEAR_FAR_TOP_LEFT&&F?1-A:0,s=e===S.LineIndex.NEAR_FAR_BOTTOM_RIGHT&&F||e===S.LineIndex.NEAR_FAR_TOP_LEFT&&!F?A:1,a=l.lines[e],c=l.lines[3===e?0:e+1];for(let l=0;l<D;l++){const d=l/D,h=e===S.LineIndex.NEAR_FAR_BOTTOM_RIGHT?1-(1-d)**2:e===S.LineIndex.NEAR_FAR_TOP_LEFT?d**2:d,p=0===l?0:r.lerp(t,s,h),m=n.lerp($,a.origin,c.origin,p),f=P.slerp(a.direction,c.direction,p,W);i.intersectManifoldClosestSilhouette(_.wrap(m,f),u,Q),T.clampLineSegmentToPlane(Q,g,Q,L),N.push(o.clone(Q)),0!==N.length&&n.sqrDist(N.at(-1),Q);const b=(y.isPointInside(U,Q)?1:0)|(y.isPointInside(V,Q)?2:0);X[b]=1}}N.length>2&&n.sqrDist(N[0],N.at(-1));const B=a.squaredLength(X)>1?function(e,t){const r=[];for(const i of e)r.push(...z(i,t));return r}(z(N,U),V):[N],G=function(e,t,r){const i=2*c.getEpsilon();return e.map((e=>{const s=[];let n=!1;for(const o of e)t.fromRenderCoords(o,Q,r),Math.abs(o[0])<i&&Math.abs(o[1])<i?(s.push([null,Q[1]]),s.push([null,Q[1]]),n=!0):s.push([Q[0],Q[1]]);if(n)for(let e=0;e<s.length;e++){const t=s[e];if(null!=t[0])continue;const r=s[e+1],i=s.at(0===e?-1:e-1);t[0]=i[0],e++;const n=s.at(e===s.length-1?0:e+1);r[0]=n[0]}return s.push(s[0]),m.isClockwise(s)||s.reverse(),s}))}(B,i,d);return new h({rings:G,spatialReference:d})}function z(e,t){const r=[],i=[],s=c.getEpsilon();for(let a=0;a<e.length;a++){const l=e[a],c=a===e.length-1?e[0]:e[a+1],u=g.fromPoints(l,c,Y),d=y.intersectLineOrRay(t,u.origin,u.vector,y.IntersectFlags.NONE,Q);switch(d){case y.IntersectResult.INSIDE:r.push(l);break;case y.IntersectResult.OUTSIDE:i.push(l);break;case y.IntersectResult.INTERSECTS_INSIDE_OUT:case y.IntersectResult.INTERSECTS_OUTSIDE_IN:{const[e,a,c]=d===y.IntersectResult.INTERSECTS_INSIDE_OUT?[1,r,i]:[-1,i,r],u=y.getNormal(t),h=n.scaleAndAdd(o.create(),Q,u,e*s),p=n.scaleAndAdd(o.create(),Q,u,e*-s);a.push(l),a.push(h),c.push(p)}}}const a=[];return r.length&&a.push(r),i.length&&a.push(i),a}const j={minCurvature:r.deg2rad(5),maxCurvature:r.deg2rad(50),minSamples:1,maxSamples:6},q=o.fromValues(1,0,0),H=o.fromValues(0,1,0),W=o.create(),$=o.create(),Q=o.create(),Z=b.create(),Y=g.create(),X=l.create(),K=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:F,eyeForCenterWithHeadingTilt:L,eyeTiltToLookAtTilt:B,headingTiltToDirectionUp:D,lookAtTiltToEyeTilt:V,toArea:k,toExtent:G},Symbol.toStringTag,{value:"Module"}));e.cameraUtilsSpherical=K,e.directionToHeadingTilt=F,e.eyeForCenterWithHeadingTilt=L,e.eyeTiltToLookAtTilt=B,e.headingTiltToDirectionUp=D,e.lookAtTiltToEyeTilt=V,e.toArea=k,e.toExtent=G}))},"esri/views/3d/state/NearFarHeuristic":function(){define(["exports","../../../core/mathUtils","../../../core/unitUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/Extent","../../../geometry/support/ray","../../../chunks/sphere","../../ViewingMode","../environment/atmosphereUtils","../webgl-engine/lib/DepthRange"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=n.getReferenceEllipsoid(t),this._unitInMeters=r.getMetersPerUnitForSR(t,this._referenceEllipsoid.metersPerDegree)}compute(e,r,s,n){const{eye:a,center:l}=e;let c=a[2]*this._unitInMeters;const u=c,d=c-n,h=this._elevationProvider?.visibleElevationBounds;h&&(c=d>=0?u-this._unitInMeters*h.min:this._unitInMeters*h.max-u),r??=new o({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0});const p={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},f=Math.max(p.x,p.y,p.z);i.subtract(x,l,a),w[0]=x[0]>0?r.xmax:r.xmin,w[1]=x[1]>0?r.ymax:r.ymin,w[2]=x[2]>0?f/2:-f/2,i.subtract(w,w,a),i.normalize(x,x);const g=1.1*i.dot(w,x)*this._unitInMeters,_=Math.sqrt(c*(c+2*this._referenceEllipsoid.radius)),b=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),C=b*v*this._unitInMeters,P=b*S*this._unitInMeters,M=t.clamp((c-P)/(C-P),0,1)**3,R=Math.min(t.lerp(_,g,M),_)*Math.max(Math.log(Math.abs(d)),1);return m(Math.min(R,Math.max(34064e4,f))/this._unitInMeters,y,this._unitInMeters,T)}}class p{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=n.getReferenceEllipsoid(t)}compute(e,r,s,n){const{eye:o}=e,c=i.length(o),h=c-this._referenceEllipsoid.radius,p=this._referenceEllipsoid.radius+Math.min(0,n),v=Math.abs(h-n),S=Math.max(v,Math.abs(h)),M=this._elevationProvider?.visibleElevationBounds.max??0,R=u.computeInnerAltitudeFade(S),E=Math.sqrt(S*(S+2*p)),O=c+this._referenceEllipsoid.radius,A=1.2*t.lerp(E,O,R),I=(Math.log(S)-f)/(g-f);m(A,t.clamp(y-I*(y-_),_,y),1,T);const D=this._referenceEllipsoid.radius+M,F=this._referenceEllipsoid.radius+this._referenceEllipsoid.atmosphereHeight,L=Math.max(D,F),N=c-L;if(R>0&&N>b){const r=i.normalize(w,i.scale(w,e.eye,-1)),n=i.normalize(x,e.viewForward),o=t.acosClamped(i.dot(r,n)),c=.5*e.fovY,u=Math.cos(c);let h=d.DepthRange.infinite.near;if(o<=c)h=N*u;else{const t=i.normalize(w,e.viewUp),r=Math.tan(c),s=i.scale(w,t,r),o=i.normalize(w,i.subtract(w,n,s)),d=a.fromValues(e.eye,o,P),p=l.fromRadius(C,L);if(l.intersectRay(p,d,w)){const t=i.subtract(w,w,e.eye);h=i.length(t)*u}}const p=.99*Math.min(s.near,h);if(p<d.DepthRange.infinite.near&&p>T.near){const e=t.lerp(T.near,p,R);T.near=e}}return T}}function m(e,t,r,i){const s=b/r,n=e/t;return n>s?(i.far=e,i.near=n):(i.near=s,i.far=i.near*t),i}const f=7.983,g=16.994,y=2e4,_=100,b=2,v=.001,S=1e-4,w=s.create(),x=s.create(),T={near:0,far:0},C=l.create(),P=a.create();e.createNearFarHeuristic=function(e,t,r){return e===c.ViewingMode.Global?new p(t,r):new h(t,r)},e.minNearDistanceInMeters=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/atmosphereUtils":function(){define(["exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t,r){"use strict";const i=1e5,s=r.fromValues(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),n=r.fromValues(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),o=r.fromValues(parseFloat(Number(s[0]+n[0]).toFixed(6)),parseFloat(Number(s[1]+n[1]).toFixed(6)),parseFloat(Number(s[2]+n[2]).toFixed(6)));e.betaCombined=o,e.betaMie=3996e-9,e.betaOzone=n,e.betaRayleigh=s,e.computeInnerAltitudeFade=function(e){return t.clamp((e-i)/9e5,0,1)},e.innerAtmosphereDepth=1e4,e.innerAtmosphereFadeStart=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/utils/viewUtils":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t,r,i){"use strict";const s=i.create(),n=i.create();e.viewAngle=function(e,i,o){e.worldUpAtPosition(i,s),r.subtract(n,o,i);const a=r.length(n);return 0===a?0:t.acosClamped(r.dot(n,s)/a)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/earthUtils":function(){define(["exports","../../../core/mathUtils","../../../geometry/ellipsoidUtils","../../../geometry/Point"],(function(e,t,r,i){"use strict";function s(e,t,r){if(null==t.longitude||null==t.latitude||null==r.longitude||null==r.latitude)throw new Error("Invalid points: no lon/lat");return n(e,t.longitude,t.latitude,r.longitude,r.latitude)}function n(e,r,i,s,n){const o=t.deg2rad(i),a=t.deg2rad(n),l=o-a,c=t.deg2rad(r)-t.deg2rad(s),u=Math.sin(l/2),d=Math.sin(c/2),h=2*t.asinClamped(Math.sqrt(u*u+Math.cos(o)*Math.cos(a)*d*d))*e;return Math.round(1e4*h)/1e4}function o(e,t){let r=e/15;return t||(r=Math.round(r)),r}e.getGreatCircleDistance=n,e.getGreatCircleDistanceFromPoints=s,e.getGreatCircleSpanAt=function(e,t,n){const o=t.spatialReference,a=r.getReferenceEllipsoid(o),l=new i(t.x,e.y,o),c=new i(n.x,e.y,o),u=new i(e.x,t.y,o),d=new i(e.x,n.y,o);return{lon:s(a.radius,l,c),lat:s(a.radius,u,d)}},e.getLonDeltaForDistance=function(e,r,i){const s=r/i,n=t.deg2rad(e),o=Math.sin(s/2),a=Math.cos(n),l=2*t.asinClamped(Math.sqrt(o*o/(a*a)));return t.rad2deg(l)},e.longitudeToTimezone=o,e.positionToTimezoneInfo=function(e,t){const r=e?.[0];if(null==r)return null;t||(t={hours:0,minutes:0,seconds:0}),t.hours=o(r,!0);const i=t.hours%1;t.hours-=i,t.minutes=60*i;const s=t.minutes%1;return t.minutes-=s,t.seconds=Math.round(60*s),t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/ElevationProvider":function(){define(["exports","../../../layers/graphics/dehydratedFeatureUtils"],(function(e,t){"use strict";function r(e){return"array"in e}e.SamplePosition=class{constructor(e,t=null,r=0){this.array=e,this.spatialReference=t,this.offset=r}},e.getElevationAtPoint=function(e,i,s="ground"){if(t.isDehydratedPoint(i))return e.getElevation(i.x,i.y,i.z||0,i.spatialReference,s);if(r(i)){let t=i.offset;return e.getElevation(i.array[t++],i.array[t++],i.array[t]||0,i.spatialReference??e.spatialReference,s)}return e.getElevation(i[0],i[1],i[2]||0,e.spatialReference,s)},e.isSamplePosition=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/dehydratedFeatureUtils":function(){define(["exports"],(function(e){"use strict";e.isDehydratedPoint=function(e){return"point"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/spatialReferenceSupport":function(){define(["exports","../../geometry/support/SupportedGCSWkids","../ViewingMode"],(function(e,t,r){"use strict";e.isSpatialReferenceSupported=function(e,i){return null!=e&&(null==i||(i===r.ViewingMode.Local?!e.isGeographic||e.isWGS84||e.wkid===t.SupportedGCSWkids.CGCS2000:e.isWebMercator||e.isWGS84||e.wkid===t.SupportedGCSWkids.CGCS2000||e.wkid===t.SupportedGCSWkids.GCSMARS2000||e.wkid===t.SupportedGCSWkids.GCSMARS2000_SPHERE||e.wkid===t.SupportedGCSWkids.GCSMOON2000))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/GroundViewElevationSampler":function(){define(["../../chunks/tslib.es6","../../core/Evented","../../core/Logger","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/SpatialReference","../../geometry/support/aaBoundingRect","../../geometry/support/contains","../../layers/support/ElevationSampler","../3d/terrain/TerrainConst"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";let h=class extends t.EventedAccessor{constructor(e){super(e),this.noDataValue=d.elevationNoDataValue}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})))}get demResolution(){return this.view.basemapTerrain.demResolution}get extent(){const e=this.view.basemapTerrain;if(null==e?.extent||null==e.spatialReference)return null;const t=l.toExtent(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){return this.view.basemapTerrain?.spatialReference??a.WGS84}elevationAt(e,t){if(null==this.extent||!c.extentContainsXYZ(this.extent,e,t)){const i=null!=this.extent?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return r.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.view.elevationProvider?.getElevation(e,t,0,this.spatialReference,"ground")??this.noDataValue}queryElevation(e){return u.updateGeometryElevation(e.clone(),this)}};return e.__decorate([i.property({readOnly:!0})],h.prototype,"demResolution",null),e.__decorate([i.property({readOnly:!0})],h.prototype,"extent",null),e.__decorate([i.property({readOnly:!0})],h.prototype,"noDataValue",void 0),e.__decorate([i.property()],h.prototype,"spatialReference",null),e.__decorate([i.property({constructOnly:!0})],h.prototype,"view",void 0),h=e.__decorate([o.subclass("esri.views.support.GroundViewElevationSampler")],h),h}))},"esri/layers/support/ElevationSampler":function(){define(["exports","../../core/has","../../core/handleUtils","../../core/Logger","../../core/unitUtils","../../geometry/Point","../../geometry/support/aaBoundingRect","../../geometry/support/webMercatorUtils"],(function(e,t,r,i,s,n,o,a){"use strict";const l=()=>i.getLogger("esri.layers.support.ElevationSampler");class c{queryElevation(e){return d(e.clone(),this)}on(){return r.makeHandle()}projectIfRequired(e,t){return h(e,t)}}class u extends c{get spatialReference(){return this.extent.spatialReference}constructor(e,t,r){super(),this.tile=e,this.noDataValue=r;const i=e.tile.extent;this.extent=o.toExtent(i,t.spatialReference),this.extent.zmin=e.zmin,this.extent.zmax=e.zmax,this._aaExtent=i;const n=s.getMetersPerUnitForSR(t.spatialReference),a=t.lodAt(e.tile.level).resolution*n;this.demResolution={min:a,max:a}}contains(e){const t=this.projectIfRequired(e,this.spatialReference);return null!=t&&this.containsAt(t.x,t.y)}containsAt(e,t){return o.containsXY(this._aaExtent,e,t)}elevationAt(e,t){if(!this.containsAt(e,t)){const r=this.extent,i=`${r.xmin}, ${r.ymin}, ${r.xmax}, ${r.ymax}`;return l().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.tile.sample(e,t)??this.noDataValue}}function d(e,t){const r=h(e,t.spatialReference);if(!r)return null;switch(e.type){case"point":!function(e,t,r){e.z=r.elevationAt(t.x,t.y)}(e,r,t);break;case"polyline":!function(e,t,r){p.spatialReference=t.spatialReference;const i=e.hasM&&!e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s],o=t.paths[s];for(let e=0;e<n.length;e++){const t=n[e],s=o[e];p.x=s[0],p.y=s[1],i&&(t[3]=t[2]),t[2]=r.elevationAt(p.x,p.y)}}e.hasZ=!0}(e,r,t);break;case"multipoint":!function(e,t,r){p.spatialReference=t.spatialReference;const i=e.hasM&&!e.hasZ;for(let s=0;s<e.points.length;s++){const n=e.points[s],o=t.points[s];p.x=o[0],p.y=o[1],i&&(n[3]=n[2]),n[2]=r.elevationAt(p.x,p.y)}e.hasZ=!0}(e,r,t)}return e}function h(e,t){if(null==e)return null;const r=e.spatialReference;if(r.equals(t))return e;const i=a.project(e,t);return i||l().error(`Cannot project geometry spatial reference (wkid:${r.wkid}) to elevation sampler spatial reference (wkid:${t.wkid})`),i}const p=new n;e.ElevationSamplerBase=c,e.MultiTileElevationSampler=class extends c{get spatialReference(){return this.extent.spatialReference}constructor(e,t,r){let i;super(),"number"==typeof t?(this.noDataValue=t,i=null):(i=t,this.noDataValue=r),this.samplers=i?e.map((e=>new u(e,i,this.noDataValue))):e;const s=this.samplers[0];if(s){this.extent=s.extent.clone();const{min:e,max:t}=s.demResolution;this.demResolution={min:e,max:t};for(let e=1;e<this.samplers.length;e++){const t=this.samplers[e];this.extent.union(t.extent),this.demResolution.min=Math.min(this.demResolution.min,t.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,t.demResolution.max)}}else this.extent=o.toExtent(o.create(),i.spatialReference),this.demResolution={min:0,max:0}}elevationAt(e,t){let r,i=!1;for(const s of this.samplers)if(s.containsAt(e,t)&&(i=!0,r=s.elevationAt(e,t),r!==s.noDataValue))return r;return null!=r?r:(i||l().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler`),this.noDataValue)}},e.TileElevationSampler=u,e.updateGeometryElevation=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TerrainConst":function(){define(["exports","../../../core/mathUtils","../../../geometry/support/aaBoundingRect","./TilingScheme"],(function(e,t,r,i){"use strict";const s=t.clampFloat32(t.numberMaxFloat32/10),n=r.create();i.TilingScheme.WebMercatorAuxiliarySphere.getExtent(0,0,0,n);const o=r.create([-180,-90,180,90]);e.elevationNoDataValue=s,e.geographicWorldExtent=o,e.maxMemoryLodBias=2.5,e.maxPatchTesselation=512,e.maxRootTiles=64,e.maxTileNeighborLevelDelta=4,e.progressiveLoadingModulo=2,e.tooManyRootTilesAfterChangeError="Cannot extend surface to encompass all layers because it would result in too many root tiles.",e.tooManyRootTilesForLayerError="Surface extent is too large for tile resolution at level 0.",e.webMercatorWorldExtent=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TilingScheme":function(){define(["exports","../../../core/Error","../../../core/has","../../../core/mathUtils","../../../core/unitUtils","../../../geometry/Extent","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils","../../../layers/support/LOD","../../../layers/support/TileInfo"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p{constructor(e){const t=p.checkUnsupported(e);if(null!=t)throw t;const r=e;this.spatialReference=r.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=c.isGeographic(this.spatialReference),this.origin=[r.origin.x,r.origin.y],this.pixelSize=r.size[0],this.dpi=r.dpi;const i=r.lods.reduce(((e,t)=>(t.level<e.minLod.level&&(e.minLod=t),e.max=Math.max(e.max,t.level),e)),{minLod:r.lods[0],max:-1/0}),s=i.minLod,n=2**s.level;let o=s.resolution*n,a=s.scale*n;this.levels=new Array(i.max+1);for(let e=0;e<this.levels.length;e++)this.levels[e]={resolution:o,scale:a,tileSize:[o*r.size[0],o*r.size[1]]},o/=2,a/=2}clone(){return new p(this.toTileInfo())}toTileInfo(){return new h({dpi:this.dpi,origin:new o({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>new d({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,r,i){const s=this.levels[e],n=s.tileSize[0],o=s.tileSize[1];i[0]=this.origin[0]+r*n,i[2]=this.origin[0]+(r+1)*n,i[3]=this.origin[1]-t*o,i[1]=this.origin[1]-(t+1)*o}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=u.x2lon(e[0]),t[1]=u.y2lat(e[1]),t[2]=u.x2lon(e[2]),t[3]=u.y2lat(e[3])):this._isGCS&&(t[0]=i.deg2rad(e[0]),t[1]=i.deg2rad(e[1]),t[2]=i.deg2rad(e[2]),t[3]=i.deg2rad(e[3]))}getExtentGeometry(e,t,r,i=new n){return this.getExtent(e,t,r,f),i.spatialReference=this.spatialReference,i.xmin=f[0],i.ymin=f[1],i.xmax=f[2],i.ymax=f[3],i.zmin=void 0,i.zmax=void 0,i}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const{resolution:e,scale:r}=this.levels[this.levels.length-1],i=e/2*this.pixelSize;this.levels.push({resolution:e/2,scale:r/2,tileSize:[i,i]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e,t=1/0){if(p.checkUnsupported(e))return!1;const r=new p(e);if(!r.spatialReference.equals(this.spatialReference))return!1;if(r.pixelSize!==this.pixelSize)return!1;const s=Math.min(this.levels.length-1,r.levels.length-1,t),n=this.levels[s].resolution;let o=.5*n;return!(!i.floatEqualAbsolute(r.origin[0],this.origin[0],o)||!i.floatEqualAbsolute(r.origin[1],this.origin[1],o))&&(o=.5*n/2**s/this.pixelSize*12,i.floatEqualAbsolute(n,r.levels[s].resolution,o))}rootTilesInExtent(e,t=null,r=1/0){const i=new Array,s=this.levels[0].tileSize;if(null==e||0===s[0]||0===s[1])return i;p.computeRowColExtent(e,s,this.origin,f);let n=f[1],o=f[3],a=f[0],l=f[2];const c=l-a,u=o-n;if(c*u>r){const e=Math.floor(Math.sqrt(r));u>e&&(n=n+Math.floor(.5*u)-Math.floor(.5*e),o=n+e),c>e&&(a=a+Math.floor(.5*c)-Math.floor(.5*e),l=a+e)}for(let e=n;e<o;e++)for(let t=a;t<l;t++)i.push([0,e,t]);return null!=t&&(t[0]=this.origin[0]+a*s[0],t[1]=this.origin[1]-o*s[1],t[2]=this.origin[0]+l*s[0],t[3]=this.origin[1]-n*s[1]),i}static computeRowColExtent(e,t,r,i){const s=.001*(e[2]-e[0]+(e[3]-e[1]));i[0]=Math.max(0,Math.floor((e[0]+s-r[0])/t[0])),i[2]=Math.max(0,Math.ceil((e[2]-s-r[0])/t[0])),i[1]=Math.max(0,Math.floor((r[1]-e[3]+s)/t[1])),i[3]=Math.max(0,Math.ceil((r[1]-e[1]-s)/t[1]))}static isPowerOfTwo(e){const t=e.lods,r=t[0].resolution*2**t[0].level;return!t.some((e=>!i.floatEqualRelative(e.resolution,r/2**e.level)))}static hasGapInLevels(e){const t=e.lods.map((e=>e.level));t.sort(((e,t)=>e-t));for(let e=1;e<t.length;e++)if(t[e]!==t[0]+e)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&!(t&t-1)&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some((e=>null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)))}static getMissingTileInfoError(){return new t("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return null==e?m():e.lods.length<1?new t("tilingscheme:generic","Tiling scheme must have at least one level"):p.isPowerOfTwo(e)?p.hasGapInLevels(e)?new t("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):p.tileSizeSupported(e)?p.hasOriginPerLODs(e)?new t("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new t("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new t("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const r=e[2]-e[0],i=e[3]-e[1],n=s.getMetersPerUnitForSR(t),a=1.2*Math.max(r,i),l=a/256,c=l*n*(96/.0254),u=new p(new h({size:[256,256],origin:new o({x:e[0]-.5*(a-r),y:e[3]+.5*(a-i)}),lods:[new d({level:0,resolution:l,scale:c})],spatialReference:t}));return u.ensureMaxLod(20),u}static makeWebMercatorAuxiliarySphere(e){const t=new p(p.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,r=16){const i=256/t,s=new p(new h({size:[t,t],origin:new o({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new d({level:0,resolution:.703125*i,scale:295497598.570834*i})]}));return s.ensureMaxLod(r),s}static{this.WebMercatorAuxiliarySphereTileInfo=new h({size:[256,256],origin:new o({x:-20037508.342787,y:20037508.342787,spatialReference:a.WebMercator}),spatialReference:a.WebMercator,lods:[new d({level:0,resolution:156543.03392800014,scale:591657527.591555})]})}static{this.WebMercatorAuxiliarySphere=p.makeWebMercatorAuxiliarySphere(19)}get test(){}}function m(){return new t("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}const f=l.create();e.TilingScheme=p,e.getMissingTileInfoError=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/LOD":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";var l;return e.default=class extends r{static{l=this}constructor(e){super(e),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new l({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}},t.__decorate([i.property({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.default.prototype,"cols",void 0),t.__decorate([i.property({type:s.Integer,json:{write:!0}})],e.default.prototype,"level",void 0),t.__decorate([i.property({type:String,json:{write:!0}})],e.default.prototype,"levelValue",void 0),t.__decorate([i.property({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.default.prototype,"origin",void 0),t.__decorate([i.property({type:Number,json:{write:!0}})],e.default.prototype,"resolution",void 0),t.__decorate([i.property({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.default.prototype,"rows",void 0),t.__decorate([i.property({type:Number,json:{write:!0}})],e.default.prototype,"scale",void 0),e.default=l=t.__decorate([a.subclass("esri.layers.support.LOD")],e.default),e.default}))},"esri/layers/support/TileInfo":function(){define(["exports","../../chunks/tslib.es6","../../core/jsonMap","../../core/JSONSupport","../../core/unitUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/aaBoundingRect","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","./LOD","./TileKey"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_){"use strict";var b;const v=new r.JSONMap({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});var S,w;return e.default=class extends i{static{b=this}static create(e={}){const{resolutionFactor:t=1,scales:r,size:i=256,spatialReference:n=p.WebMercator,numLODs:o=24}=e;if(!f.isValid(n)){const e=[];if(r)for(let t=0;t<r.length;t++){const i=r[t];e.push(new y({level:t,scale:i,resolution:i}))}else{let t=5e-4;for(let r=o-1;r>=0;r--)e.unshift(new y({level:r,scale:t,resolution:t})),t*=2}return new b({dpi:96,lods:e,origin:new h(0,0,n),size:[i,i],spatialReference:n})}const a=f.getInfo(n),l=e.origin?new h({x:e.origin.x,y:e.origin.y,spatialReference:n}):new h(a?{x:a.origin[0],y:a.origin[1],spatialReference:n}:{x:0,y:0,spatialReference:n}),c=1/(39.37*s.getMetersPerUnitForSR(n)*96),u=[];if(r)for(let e=0;e<r.length;e++){const t=r[e],i=t*c;u.push(new y({level:e,scale:t,resolution:i}))}else{let e=f.isGeographic(n)?512/i*591657527.5917094:256/i*591657527.591555;const r=Math.ceil(o/t);u.push(new y({level:0,scale:e,resolution:e*c}));for(let i=1;i<r;i++){const r=e/2**t,s=r*c;u.push(new y({level:i,scale:r,resolution:s})),e=r}}return new b({dpi:96,lods:u,origin:l,size:[i,i],spatialReference:n})}constructor(e){super(e),this.dpi=96,this.format=null,this.origin=null,this.size=null,this.spatialReference=null}get isWrappable(){const{spatialReference:e,origin:t}=this;if(e&&t){const r=f.getInfo(e);return e.isWrappable&&!!r&&Math.abs(r.origin[0]-t.x)<=r.dx}return!1}readOrigin(e,t){return h.fromJSON({spatialReference:t.spatialReference,...e})}set lods(e){let t=0,r=0;const i=[],s=this._levelToLOD={};e&&(t=-1/0,r=1/0,e.forEach((e=>{i.push(e.scale),t=e.scale>t?e.scale:t,r=e.scale<r?e.scale:r,s[e.level]=e}))),this._set("scales",i),this._set("lods",e),this._initializeUpsampleLevels()}readSize(e,t){return[t.cols,t.rows]}writeSize(e,t){t.cols=e[0],t.rows=e[1]}zoomToScale(e){const t=this.scales;if(e<=0)return t[0];if(e>=t.length-1)return t[t.length-1];const r=Math.floor(e),i=r+1;return t[r]/(t[r]/t[i])**(e-r)}scaleToZoom(e){const t=this.scales,r=t.length-1;let i=0;for(;i<r;i++){const r=t[i],s=t[i+1];if(r<=e)return i;if(s===e)return i+1;if(r>e&&s<e)return i+Math.log(r/e)/Math.log(r/s)}return i}tileAt(e,t,r,i){const s=this.lodAt(e);if(!s)return null;let n,o;if("number"==typeof t)n=t,o=r;else if(f.equals(t.spatialReference,this.spatialReference))n=t.x,o=t.y,i=r;else{const e=g.project(t,this.spatialReference);if(null==e)return null;n=e.x,o=e.y,i=r}const a=s.resolution*this.size[0],l=s.resolution*this.size[1];return i||(i=new _.TileKey(null,0,0,0,m.create())),i.level=e,i.row=Math.floor((this.origin.y-o)/l+.001),i.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(i),i}updateTileInfo(e,t=b.ExtrapolateOptions.NONE){let r=this.lodAt(e.level);if(!r&&t===b.ExtrapolateOptions.POWER_OF_TWO){const t=this.lods[this.lods.length-1];t.level<e.level&&(r=t)}if(!r)return;const i=e.level-r.level,s=r.resolution*this.size[0]/2**i,n=r.resolution*this.size[1]/2**i;e.id=`${e.level}/${e.row}/${e.col}`,e.extent||(e.extent=m.create()),e.extent[0]=this.origin.x+e.col*s,e.extent[1]=this.origin.y-(e.row+1)*n,e.extent[2]=e.extent[0]+s,e.extent[3]=e.extent[1]+n}upsampleTile(e){const t=this._upsampleLevels[e.level];return!(!t||-1===t.parentLevel||(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),0))}getTileBounds(e,t){const r=this.lodAt(t.level);if(null==r)return null;const{resolution:i}=r,s=i*this.size[0],n=i*this.size[1];return e[0]=this.origin.x+t.col*s,e[1]=this.origin.y-(t.row+1)*n,e[2]=e[0]+s,e[3]=e[1]+n,e}lodAt(e){return this._levelToLOD?.[e]??null}clone(){return b.fromJSON(this.write({}))}getCompatibleForVTL(e){if(this.size[0]!==this.size[1]||256===this.size[0]&&512===e)return null;const t=(512===this.size[0]&&256===e?-1:0)+(this.spatialReference.isGeographic?1:0);if(this.size[0]===e&&0===t)return this;const r=[],i=this.lods.length-t;for(let e=0;e<i;e++){const i=e+t,{scale:s,resolution:n}=i>=0?this.lods[i]:{scale:2*this.lods[0].scale,resolution:2*this.lods[0].resolution};r.push(new y({level:e,scale:s,resolution:n}))}return new b({size:[e,e],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:r})}_initializeUpsampleLevels(){const e=this.lods;this._upsampleLevels=[];let t=null;for(let r=0;r<e.length;r++){const i=e[r];this._upsampleLevels[i.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/i.resolution:0},t=i}}},t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"compressionQuality",void 0),t.__decorate([n.property({type:Number,json:{write:!0}})],e.default.prototype,"dpi",void 0),t.__decorate([n.property({type:String,json:{read:v.read,write:v.write,origins:{"web-scene":{read:!1,write:!1}}}})],e.default.prototype,"format",void 0),t.__decorate([n.property({readOnly:!0})],e.default.prototype,"isWrappable",null),t.__decorate([n.property({type:h,json:{write:!0}})],e.default.prototype,"origin",void 0),t.__decorate([c.reader("origin")],e.default.prototype,"readOrigin",null),t.__decorate([n.property({type:[y],value:null,json:{write:!0}})],e.default.prototype,"lods",null),t.__decorate([n.property({readOnly:!0})],e.default.prototype,"scales",void 0),t.__decorate([n.property({cast:e=>Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]})],e.default.prototype,"size",void 0),t.__decorate([c.reader("size",["rows","cols"])],e.default.prototype,"readSize",null),t.__decorate([d.writer("size",{cols:{type:o.Integer},rows:{type:o.Integer}})],e.default.prototype,"writeSize",null),t.__decorate([n.property({type:p,json:{write:!0}})],e.default.prototype,"spatialReference",void 0),e.default=b=t.__decorate([u.subclass("esri.layers.support.TileInfo")],e.default),(w=(S=e.default||(e.default={})).ExtrapolateOptions||(S.ExtrapolateOptions={}))[w.NONE=0]="NONE",w[w.POWER_OF_TWO=1]="POWER_OF_TWO",e.default}))},"esri/layers/support/TileKey":function(){define(["exports"],(function(e){"use strict";e.TileKey=class{constructor(e,t,r,i,s=void 0){this.id=e,this.level=t,this.row=r,this.col=i,this.extent=s}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/PopupView":function(){define(["require","exports","../chunks/tslib.es6","../core/asyncUtils","../core/Error","../core/has","../core/Logger","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./input/InputManager"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";const p=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));function m(e){return null!=e&&"open"in e&&"declaredClass"in e}function f(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}class g{constructor(e){this.layerView=e,this._resolver=a.createResolver(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(e){const{layerView:t,graphics:r,_resolver:i}=this;if(!t)return i.resolve(r),i.promise;let s;return t.fetchPopupFeaturesFromGraphics(r,e).catch((e=>(s=e,null))).then((e=>{e?i.resolve(e):i.reject(s)})),i.promise}}t.PopupView=t=>{let u=class extends t{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([l.watch((()=>[this.ui,this.popup]),(([e,t],r)=>{const i="popup";if(r){const[e,s]=r;e&&m(s)&&(s.view=null,f(s)&&(e.remove(s,i),s!==t&&t&&s.destroy()))}e&&m(t)&&(t.view=this,f(t)&&e.add(t,{key:i,position:"manual",internal:!0}))}),l.syncAndInitial),this.on("click",(e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(m(this.popup)?this.popup.viewModel.handleViewClick(e):e.defer((async()=>{await this.setupPopup(),m(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)})))}),h.ViewEventPriorities.WIDGET)]),l.whenOnce((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{new Promise(((t,r)=>e(["../widgets/Popup"],(e=>t(p(e))),r)))}))}destroy(){this.destroyed||this.closePopup()}async openPopup(e){if(m(this.popup))return this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void o.getLogger(this).error(new s("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}}closePopup(){this._popupSetupTask?.abort(),m(this.popup)&&this.popup.close()}async fetchPopupFeatures(e,t){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(e,t),t)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!m(this.popup))return this._popupSetupTask=i.createTask((async t=>{const{default:r}=await new Promise(((t,r)=>e(["../widgets/Popup"],(e=>t(p(e))),r)));if(a.throwIfAborted(t),!this.popup||m(this.popup))return;const i=this.popup;delete i.open,delete i.close,this.popup=new r(i)})),this._popupSetupTask.promise}async _popupHitsToFeatures({location:e,hits:t},r){const i=[],s=[];let o=!1;const l=a.wrapAbortWithTimeout(r,n("popup-view-fetch-timeout")??5e3),c=e=>{const t=s.at(-1);return t&&t.layerView===e&&!o?t:(e=>{const t=new g(e);return s.push(t),i.push(t.promise),t})(e)};for(const e of t)"graphic"in e?(c(e.layerView).graphics.push(e.graphic),o=!1):(i.push(e.layerView.fetchPopupFeaturesAtLocation(e.mapPoint,l)),o=!0);s.map((e=>e.resolve(l)));const u=a.allSettledValues(i).then((e=>e.filter((e=>!!e)).flat()));return{pendingFeatures:i,allGraphicsPromise:u,location:e}}async _getPopupHits(e,t){const{hits:r,location:i}=await this.popupHitTest(e);a.throwIfAborted(t);const s=[];for(const e of r)if("graphic"in e){if(this._isValidPopupGraphic(e.graphic,t)){const t=this._isValidPopupGraphicsLayerView(e.layerView)?e.layerView:void 0;s.push({graphic:e.graphic,layerView:t})}}else this._isValidPopupLocationLayerView(e.layerView)&&s.push({mapPoint:e.mapPoint,layerView:e.layerView});return{hits:s,location:i}}_isValidPopupGraphic(e,t){return e&&!!e.getEffectivePopupTemplate(t?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(e){return!e||(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesFromGraphics"in e}_isValidPopupLocationLayerView(e){return(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesAtLocation"in e}};return r.__decorate([c.property()],u.prototype,"popup",void 0),r.__decorate([c.property()],u.prototype,"popupEnabled",void 0),u=r.__decorate([d.subclass("esri.views.PopupView")],u),u},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layerViewModuleImportUtils":function(){define(["require","exports","../../core/Error"],(function(e,t,r){"use strict";const i=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),s=()=>new Promise(((t,r)=>e(["./layers/TileLayerView3D"],(e=>t(i(e))),r))),n=()=>new Promise(((t,r)=>e(["./layers/ElevationLayerView3D"],(e=>t(i(e))),r))),o={"base-dynamic":()=>new Promise(((t,r)=>e(["./layers/BaseDynamicLayerView3D"],(e=>t(i(e))),r))),"base-elevation":n,"base-tile":s,"bing-maps":s,"building-scene":()=>new Promise(((t,r)=>e(["./layers/BuildingSceneLayerView3D"],(e=>t(i(e))),r))),catalog:()=>new Promise(((t,r)=>e(["./layers/CatalogLayerView3D"],(e=>t(i(e))),r))),"catalog-dynamic-group":()=>new Promise(((t,r)=>e(["./layers/CatalogDynamicGroupLayerView3D"],(e=>t(i(e))),r))),"catalog-footprint":()=>new Promise(((t,r)=>e(["./layers/CatalogFootprintLayerView3D"],(e=>t(i(e))),r))),csv:()=>new Promise(((t,r)=>e(["./layers/CSVLayerView3D"],(e=>t(i(e))),r))),dimension:()=>new Promise(((t,r)=>e(["./layers/DimensionLayerView3D"],(e=>t(i(e))),r))),elevation:n,feature:()=>new Promise(((t,r)=>e(["./layers/FeatureLayerView3D"],(e=>t(i(e))),r))),geojson:()=>new Promise(((t,r)=>e(["./layers/GeoJSONLayerView3D"],(e=>t(i(e))),r))),graphics:()=>new Promise(((t,r)=>e(["./layers/GraphicsLayerView3D"],(e=>t(i(e))),r))),group:()=>new Promise(((t,r)=>e(["./layers/GroupLayerView3D"],(e=>t(i(e))),r))),imagery:()=>new Promise(((t,r)=>e(["./layers/ImageryLayerView3D"],(e=>t(i(e))),r))),"integrated-mesh":()=>new Promise(((t,r)=>e(["./layers/IntegratedMeshLayerView3D"],(e=>t(i(e))),r))),"integrated-mesh-3dtiles":()=>new Promise(((t,r)=>e(["./layers/IntegratedMesh3DTilesLayerView3D"],(e=>t(i(e))),r))),"line-of-sight":()=>new Promise(((t,r)=>e(["./layers/LineOfSightLayerView3D"],(e=>t(i(e))),r))),"map-image":()=>new Promise(((t,r)=>e(["./layers/MapImageLayerView3D"],(e=>t(i(e))),r))),media:()=>new Promise(((t,r)=>e(["./layers/MediaLayerView3D"],(e=>t(i(e))),r))),"ogc-feature":()=>new Promise(((t,r)=>e(["./layers/OGCFeatureLayerView3D"],(e=>t(i(e))),r))),"open-street-map":s,"oriented-imagery":()=>new Promise(((t,r)=>e(["./layers/FeatureLayerView3D"],(e=>t(i(e))),r))),"point-cloud":()=>new Promise(((t,r)=>e(["./layers/PointCloudLayerView3D"],(e=>t(i(e))),r))),viewshed:()=>new Promise(((t,r)=>e(["./layers/ViewshedLayerView3D"],(e=>t(i(e))),r))),voxel:()=>new Promise(((t,r)=>e(["./layers/VoxelLayerView3D"],(e=>t(i(e))),r))),route:()=>new Promise(((t,r)=>e(["./layers/RouteLayerView3D"],(e=>t(i(e))),r))),scene:t=>null==t.profile||"mesh-pyramids"===t.profile?new Promise(((t,r)=>e(["./layers/SceneLayerView3D"],(e=>t(i(e))),r))):new Promise(((t,r)=>e(["./layers/SceneLayerGraphicsView3D"],(e=>t(i(e))),r))),stream:()=>new Promise(((t,r)=>e(["./layers/StreamLayerView3D"],(e=>t(i(e))),r))),tile:s,"imagery-tile":()=>new Promise(((t,r)=>e(["./layers/ImageryTileLayerView3D"],(e=>t(i(e))),r))),"vector-tile":()=>new Promise(((t,r)=>e(["./layers/VectorTileLayerView3D"],(e=>t(i(e))),r))),wcs:()=>new Promise(((t,r)=>e(["./layers/ImageryTileLayerView3D"],(e=>t(i(e))),r))),"web-tile":s,wfs:()=>new Promise(((t,r)=>e(["./layers/WFSLayerView3D"],(e=>t(i(e))),r))),wms:()=>new Promise(((t,r)=>e(["./layers/WMSLayerView3D"],(e=>t(i(e))),r))),wmts:()=>new Promise(((t,r)=>e(["./layers/WMTSLayerView3D"],(e=>t(i(e))),r))),parquet:null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null},a={hasLayerViewModule:e=>null!=o[e.type],importLayerView:e=>{const t=o[e.type];if(null==t)throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new r(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)}};t.layerView3DImporter=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/analysis/AnalysisViewManager3D":function(){define(["require","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/asyncUtils","../../../core/Collection","../../../core/Error","../../../core/handleUtils","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/scheduling","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const m=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),f="analyses-owner-handles";var g,y;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(g||(g={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(y||(y={}));let _=class extends r{constructor(e){super(e),this._allAnalysisViews=new s,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=b(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}},this._emitOnView=(e,t)=>this.view.emit(e,t)}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(u.createAbortError("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(u.createAbortError()),this._attachedToViewResolver=b()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(null==t||t.state.list===y.REMOVED)throw new n("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),f)}_disconnectOwners(){this.removeHandles(f),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const t of e)this._addAnalysis(t);const t=e.on("after-add",(e=>this._addAnalysis(e.item))),r=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return o.makeHandle((()=>{t.remove(),r.remove();for(const t of e)this._removeAnalysis(t)}))}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:g.PENDING,list:y.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=i.createTask((r=>this._createAnalysisViewPromise(t,r).then((t=>(this._emitOnView("analysis-view-create",{analysis:e,analysisView:t}),t)),(t=>{throw this._emitOnView("analysis-view-create-error",{analysis:e,error:t}),t}))))}else t.state.list=y.ADDED}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=y.REMOVED,this._scheduleUpdate()):l.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=d.schedule((()=>this._update())))}_update(){this._scheduledUpdateHandle=c.removeMaybe(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list!==y.REMOVED)return;const{analysis:t,view:r}=e;switch(this._items.delete(t),e.state.view){case g.PENDING:e.createAnalysisViewTask=c.abortMaybe(e.createAnalysisViewTask);break;case g.CREATED:null!=r&&(this._allAnalysisViews.remove(r),e.view=c.destroyMaybe(r),e.createAnalysisViewTask=null,this._emitOnView("analysis-view-destroy",{analysis:t,analysisView:r}))}}))}async _createAnalysisViewPromise(e,t){const r=e.analysis,i=r.type,s=this._analysisModules[i];if(this._creatingViewCount+=1,null==s.module)try{s.module=await this._loadAnalysisModule(i)}catch(e){throw this._creatingViewCount-=1,e}if(u.isAborted(t))throw this._creatingViewCount-=1,u.createAbortError("AnalysisView creation aborted");const n=new s.module.default({analysis:r,view:this.view});let o=!0;u.onAbort(t,(()=>{o&&this._destroyAnalysisView(r,n)}));try{await n.when()}catch(e){throw o=!1,this._destroyAnalysisView(r,n),e}if(u.isAborted(t))throw u.createAbortError();return o=!1,e.view=n,e.state.view=g.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_destroyAnalysisView(e,t){t.destroyed||(this._creatingViewCount-=1,t.destroy(),this._emitOnView("analysis-view-destroy",{analysis:e,analysisView:t}))}_loadAnalysisModule(t){switch(t){case"area-measurement":return new Promise(((t,r)=>e(["./AreaMeasurementAnalysisView3D"],(e=>t(m(e))),r)));case"dimension":return new Promise(((t,r)=>e(["./DimensionAnalysisView3D"],(e=>t(m(e))),r)));case"direct-line-measurement":return new Promise(((t,r)=>e(["./DirectLineMeasurementAnalysisView3D"],(e=>t(m(e))),r)));case"line-of-sight":return new Promise(((t,r)=>e(["./LineOfSightAnalysisView3D"],(e=>t(m(e))),r)));case"slice":return new Promise(((t,r)=>e(["./SliceAnalysisView3D"],(e=>t(m(e))),r)));case"viewshed":return new Promise(((t,r)=>e(["./ViewshedAnalysisView3D"],(e=>t(m(e))),r)))}}};function b(){const e=u.createResolver();return e.promise.catch((()=>{})),e}return t.__decorate([h.property()],_.prototype,"updating",null),t.__decorate([h.property({constructOnly:!0})],_.prototype,"view",void 0),t.__decorate([h.property()],_.prototype,"_allAnalysisViews",void 0),t.__decorate([h.property()],_.prototype,"_creatingViewCount",void 0),_=t.__decorate([p.subclass("esri.views.3d.analysis.AnalysisViewManager3D")],_),_}))},"esri/views/3d/constraints/Constraints":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Clonable","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./AltitudeConstraint","./ClipDistanceConstraint","./TiltConstraint"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.Constraints=class extends r{constructor(e){super(e),this.tilt=new u.TiltConstraint,this.altitude=new l.AltitudeConstraint,this.clipDistance=new c.ClipDistanceConstraint}},t.__decorate([i.property({type:u.TiltConstraint})],e.Constraints.prototype,"tilt",void 0),t.__decorate([i.property({type:l.AltitudeConstraint})],e.Constraints.prototype,"altitude",void 0),t.__decorate([i.property({type:c.ClipDistanceConstraint})],e.Constraints.prototype,"clipDistance",void 0),e.Constraints=t.__decorate([a.subclass("esri.views.3d.constraints.Constraints")],e.Constraints),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/constraints/AltitudeConstraint":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Clonable","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../state/Constraints"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.AltitudeConstraint=class extends r{constructor(){super(...arguments),this.min=l.earthAltitudeConstraint.min,this.max=l.earthAltitudeConstraint.max}},t.__decorate([i.property({type:Number})],e.AltitudeConstraint.prototype,"min",void 0),t.__decorate([i.property({type:Number})],e.AltitudeConstraint.prototype,"max",void 0),e.AltitudeConstraint=t.__decorate([a.subclass("esri.views.3d.constraints.AltitudeConstraint")],e.AltitudeConstraint),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/Constraints":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Logger","../../../core/mathUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/Ellipsoid","../../ViewingMode","../support/mathUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.Constraints=class extends r{constructor(e){super(e),this.collision=new f,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===u.ViewingMode.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==u.ViewingMode.Local?this._set("altitude",e):i.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?s.clamp(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const r=this.tilt(e);return s.clamp(t,r.min,r.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===u.ViewingMode.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,r=m)=>(r.min=p.min,r.max=e,r)}_createDefaultTiltLocal(){const e=this.collision.enabled?d.makePiecewiseLinearFunction([[4e3,p.max],[1e4,s.deg2rad(88)],[6e6,s.deg2rad(88)]]):()=>p.max;return(t,r=m)=>(r.min=p.min,r.max=e(t),r)}_createDefaultTiltGlobal(){const e=this.collision.enabled?d.makePiecewiseLinearFunction([[4e3,p.max],[5e4,s.deg2rad(88)],[6e6,s.deg2rad(88)],[2e7,p.min]]):d.makePiecewiseLinearFunction([[3e5,p.max],[3e6,s.deg2rad(88)],[6e6,s.deg2rad(88)],[2e7,p.min]]);return(t,r=m)=>(r.min=p.min,r.max=e(t),r)}},t.__decorate([n.property()],e.Constraints.prototype,"altitude",null),t.__decorate([n.property({readOnly:!0})],e.Constraints.prototype,"collision",void 0),t.__decorate([n.property()],e.Constraints.prototype,"distance",void 0),t.__decorate([n.property({readOnly:!0})],e.Constraints.prototype,"minimumPoiDistance",void 0),t.__decorate([n.property()],e.Constraints.prototype,"tilt",void 0),t.__decorate([n.property({constructOnly:!0})],e.Constraints.prototype,"state",void 0),e.Constraints=t.__decorate([l.subclass("esri.views.3d.state.Constraints")],e.Constraints);const h={min:-2e5,max:4*c.earth.radius},p={min:s.deg2rad(.5),max:s.deg2rad(179.5)},m={min:0,max:0};let f=class extends r{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};t.__decorate([n.property({type:Boolean})],f.prototype,"enabled",void 0),t.__decorate([n.property({type:Number})],f.prototype,"elevationMargin",void 0),f=t.__decorate([l.subclass("esri.views.3d.state.Constraints.CollisionConstraint")],f),e.TiltRange=p,e.earthAltitudeConstraint=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/constraints/ClipDistanceConstraint":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Clonable","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/cast","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";e.ClipDistanceConstraint=class extends r{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}},t.__decorate([i.property({type:Number,value:1e-8})],e.ClipDistanceConstraint.prototype,"near",null),t.__decorate([s.cast("near")],e.ClipDistanceConstraint.prototype,"castNear",null),t.__decorate([i.property({type:Number,value:1e-8})],e.ClipDistanceConstraint.prototype,"far",null),t.__decorate([s.cast("far")],e.ClipDistanceConstraint.prototype,"castFar",null),t.__decorate([i.property({type:["auto","manual"]})],e.ClipDistanceConstraint.prototype,"mode",void 0),e.ClipDistanceConstraint=t.__decorate([a.subclass("esri.views.3d.constraints.ClipDistanceConstraint")],e.ClipDistanceConstraint),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/constraints/TiltConstraint":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Clonable","../../../core/mathUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/cast","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../state/Constraints"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u={min:i.rad2deg(c.TiltRange.min),max:i.rad2deg(c.TiltRange.max)};e.TiltConstraint=class extends r{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return i.clamp(e,u.min,u.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}},t.__decorate([s.property({type:["auto","manual"]})],e.TiltConstraint.prototype,"mode",void 0),t.__decorate([s.property({type:Number,value:u.max})],e.TiltConstraint.prototype,"max",null),t.__decorate([n.cast("max")],e.TiltConstraint.prototype,"castMax",null),e.TiltConstraint=t.__decorate([l.subclass("esri.views.3d.constraints.TiltConstraint")],e.TiltConstraint),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/EnvironmentManager":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Evented","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/projection/projectPointToVector","../../../geometry/support/planetGCSUtils","../../../geometry/support/spatialReferenceUtils","../../ViewingMode","./EnvironmentRenderer","../support/earthUtils","../support/sunUtils","../webgl-engine/lib/Update","../webgl-engine/lighting/Lightsources"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w){"use strict";e.EnvironmentManager=class extends r.EventedAccessor{constructor(){super(),this._tmpLightParameters=new v.ColorAndIntensity,this._defaultLightParameters=new v.ColorAndIntensity,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new w.MainLight,this._ambientLight=new w.AmbientLight,this._moonLight=new w.FillLight,this._disableWeather=!1,this._renderer=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===y.ViewingMode.Global&&g.isEarth(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){const e=this._view?.stateManager?.camera?.position?.spatialReference??p.WGS84,t=f.getGCSForPlanet(e);return h.isLoadedOrLoadFor(e,t)}connectView(e){if(this._renderer)return;this._renderer=new _.EnvironmentRenderer({view:e});const t=()=>this._updateRenderParameters(),r=()=>this._cameraHandler();this.addHandles([n.watch((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),n.sync),n.watch((()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),n.sync),n.watch((()=>e.environment.lighting.directShadowsEnabled),t,n.sync),n.watch((()=>e.qualitySettings.ambientOcclusion),t,n.sync),n.watch((()=>e.qualitySettings.reflections),t,n.sync),n.watch((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),n.sync),n.watch((()=>[e.environment.weather.type,this.weatherEnabled]),(()=>this._updateLighting(null,S.Update.FadeWithWeather)),n.sync),n.watch((()=>"snowy"===e.environment.weather.type&&e.environment.weather.snowCover),t,n.sync),n.watch((()=>e.environment),(e=>e.setComputeWeatherAvailable((()=>this._weatherAvailable))),n.syncAndInitial),n.watch((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),n.syncAndInitial),n.watch((()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),n.syncAndInitial),n.watch((()=>e.state.camera),r,n.syncAndInitial),n.when((()=>this._canProjectCameraPosition),r,n.sync)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=s.destroyMaybe(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),null!=this._referencePositionGeographic)){const e=b.positionToTimezoneInfo(this._referencePositionGeographic,this._tmpTz);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const r=t.stateManager.camera;if(!r)return;const{position:i}=r,s=i.spatialReference??p.WGS84,n=f.getGCSForPlanet(s);if(!m.projectPointToVector(i,C,n)){if(null==this._referencePositionGeographic)return;return this._referencePositionGeographic=null,void this._updateLighting()}this._referencePositionGeographic?u.equals(this._referencePositionGeographic,C)||(u.copy(this._referencePositionGeographic,C),this.notifyChange("referencePositionGeographic")):this._referencePositionGeographic=d.clone(C),this._autoUpdateTimezone(this._referencePositionGeographic,e)||this._updateLighting(e)}_updateLighting(e,t=S.Update.Immediate){const r=this._view,{lighting:i}=r.environment,s="virtual"===i.type,n=this._referencePositionGeographic,o=null!=n?this._tmpLightParameters:this._defaultLightParameters;if(n){e??=s?null:i.date;const t=this._weatherAvailable?r.environment.weather.type:"disabled";v.computeColorAndIntensity(e,n,r.state.viewingMode,t,r.state.camera,o)}else s&&v.computeVirtualLightDirection(r.state.camera,r.state.viewingMode,o.direct.directionToLightSource);const a=this._mainLight,l=o.direct;u.scale(a.intensity,l.color,l.intensity*Math.PI),u.copy(a.direction,l.directionToLightSource),a.specularStrength=o.specularStrength,a.environmentStrength=o.environmentStrength;const c=this._ambientLight;u.scale(c.intensity,o.ambient.color,o.ambient.intensity);const d=this._moonLight;u.lerp(d.intensity,x,T,o.globalFactor);const h=(1-.5*o.globalFactor)*(1-.4*o.noonFactor*(1-o.globalFactor));u.scale(d.intensity,d.intensity,h),u.copy(d.direction,l.directionToLightSource),this._view.stage?.renderer.updateLighting([a,c,d],o.noonFactor,o.globalFactor,this._weatherAvailable?t:S.Update.Immediate),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const r=this._tmpDate;r.setTime((t||this._view.environment.lighting.date).getTime());const i=b.positionToTimezoneInfo(e,this._tmpTz);if(null==i)return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===i.hours&&s.minutes===i.minutes&&s.seconds===i.seconds)return!1}else s=i;const n=r.getUTCHours()-(i.hours-s.hours),o=r.getUTCMinutes()-(i.minutes-s.minutes),a=r.getUTCSeconds()-(i.seconds-s.seconds);return r.setUTCHours(n),r.setUTCMinutes(o),r.setUTCSeconds(a),!t&&this._view.environment.lighting.autoUpdate(r,i)}_updateRenderParameters(){const e=this._view.stage;if(!e)return;const t=null==this._referencePositionGeographic||v.computeShadowsEnabled(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}},t.__decorate([o.property({type:Boolean,readOnly:!0})],e.EnvironmentManager.prototype,"updating",null),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_disableWeather",void 0),t.__decorate([o.property()],e.EnvironmentManager.prototype,"weatherEnabled",null),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_weatherAvailable",null),t.__decorate([o.property()],e.EnvironmentManager.prototype,"referencePositionGeographic",null),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_referencePositionGeographic",void 0),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_renderer",void 0),t.__decorate([o.property()],e.EnvironmentManager.prototype,"_canProjectCameraPosition",null),e.EnvironmentManager=t.__decorate([c.subclass("esri.views.3d.environment.EnvironmentManager")],e.EnvironmentManager);const x=d.fromValues(.22,.22,.33),T=d.fromValues(.22,.22,.22),C=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/planetGCSUtils":function(){define(["exports","../SpatialReference","../spatialReferenceEllipsoidUtils","./spatialReferenceUtils","./SupportedGCSWkids"],(function(e,t,r,i,s){"use strict";e.getGCSForPlanet=function(e){return i.equals(e,r.SphericalPCPFMars)||i.isMars(e)?{wkid:s.SupportedGCSWkids.GCSMARS2000}:i.equals(e,r.SphericalPCPFMoon)||i.isMoon(e)?{wkid:s.SupportedGCSWkids.GCSMOON2000}:t.WGS84},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/EnvironmentRenderer":function(){define(["exports","../../../chunks/tslib.es6","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/signal","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../geometry/ellipsoidUtils","./Clouds","./CloudsPresets","./CloudsRenderer","./Precipitation","./weather","../webgl-engine/effects/RenderPlugin"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";e.EnvironmentRenderer=class extends y.SyncRenderPlugin{constructor(e){super(e),this.produces=new Map([]),this._clouds=n.signal(null),this._incarnation=0,this._precipitation=null}initialize(){this.view.stage?.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?.stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.running}get weatherAvailable(){return u.length(this.view.state.camera.eye)-d.getReferenceEllipsoid(this.view.spatialReference).radius<=g.heightLimit}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut((()=>{this._precipitationOutgoing=i.destroyMaybe(this._precipitationOutgoing)})),this._precipitation=null,++this._incarnation)}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,r=()=>this._requestRender();this.addHandles([s.watch((()=>this._precipitation),r,s.sync),s.watch((()=>this._clouds.value?.state),r,s.sync),s.watch((()=>t.state.mode),r,s.sync),s.watch((()=>this._updateClouds()),r,s.sync),s.watch((()=>this._updatePrecipitation()),r,s.sync),s.watch((()=>this.weather),(e=>this._initWeather(e)))])}uninitializeRenderContext(){this._context=null,this._clouds.value=i.destroyMaybe(this._clouds.value),this._precipitation=i.destroyMaybe(this._precipitation),this._precipitationOutgoing=i.destroyMaybe(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:r}=e;if("local"!==this.view.viewingMode&&t.clouds.data){t.clouds.fade(t.camera,r,this.view.qualitySettings.fadeDuration);const e=this._clouds.value;e&&e.state===h.CubeMapState.Idle&&0===e.coverage&&!e.running&&e.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=i.destroyMaybe(this._clouds.value));if(this._clouds.value)return;const r=this.view;this._clouds.value=new m.CloudsRenderer({context:t,view:r,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return null==e||null==this._clouds.value||this._clouds.value.applyPreset(p.cloudPresets[e.type],function(e){switch(e.type){case"rainy":case"snowy":case"cloudy":case"sunny":return e.cloudCover;case"foggy":return e.fogStrength}}(e)),++this._incarnation}_updatePrecipitation(){const e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();const t="rainy"===e.type||"snowy"===e.type,r=this._context;return t&&r&&(this._precipitation=new f.Precipitation({view:this.view,type:e.type}),++this._incarnation),this._incarnation}get test(){}hasHighlight(){return!1}},t.__decorate([o.property({constructOnly:!0})],e.EnvironmentRenderer.prototype,"view",void 0),t.__decorate([o.property({type:Boolean,readOnly:!0})],e.EnvironmentRenderer.prototype,"updating",null),t.__decorate([o.property()],e.EnvironmentRenderer.prototype,"weatherAvailable",null),t.__decorate([o.property()],e.EnvironmentRenderer.prototype,"_context",void 0),e.EnvironmentRenderer=t.__decorate([c.subclass("esri.views.3d.environment.EnvironmentRenderer")],e.EnvironmentRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/Clouds":function(){define(["exports"],(function(e){"use strict";var t,r;e.CubeMapState=void 0,(t=e.CubeMapState||(e.CubeMapState={}))[t.Idle=0]="Idle",t[t.Rendering=1]="Rendering",t[t.Ready=2]="Ready",t[t.Fading=3]="Fading",e.CloudsTextureChannels=void 0,(r=e.CloudsTextureChannels||(e.CloudsTextureChannels={}))[r.RG=0]="RG",r[r.BA=1]="BA",r[r.COUNT=2]="COUNT",e.ensureClouds=function(e){return null!=e&&!e.running},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/CloudsPresets":function(){define(["exports","./CloudsTechniqueConfiguration"],(function(e,t){"use strict";class r{constructor(e,t,r,i,s,n,o,a,l=.5){this.coverage=e,this.density=t,this.absorption=r,this.cloudSize=i,this.detailSize=s,this.smoothness=n,this.cloudHeight=o,this.raymarchingSteps=a,this.median=l}}const i={sunny:new r([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],t.RayMarchingSteps.SIXTEEN),cloudy:new r([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],t.RayMarchingSteps.TWOHUNDRED,.6),rainy:new r([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],t.RayMarchingSteps.TWOHUNDRED,.4),snowy:new r([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],t.RayMarchingSteps.HUNDRED,.65),foggy:new r([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],t.RayMarchingSteps.SIXTEEN)};i.default=i.sunny,e.CloudPreset=r,e.cloudPresets=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/CloudsTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","./Clouds","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r,i){"use strict";var s;e.RayMarchingSteps=void 0,(s=e.RayMarchingSteps||(e.RayMarchingSteps={}))[s.SIXTEEN=0]="SIXTEEN",s[s.HUNDRED=1]="HUNDRED",s[s.TWOHUNDRED=2]="TWOHUNDRED",s[s.COUNT=3]="COUNT";class n extends i.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.steps=e.RayMarchingSteps.SIXTEEN,this.writeTextureChannels=r.CloudsTextureChannels.RG}}t.__decorate([i.parameter({count:e.RayMarchingSteps.COUNT})],n.prototype,"steps",void 0),t.__decorate([i.parameter({count:r.CloudsTextureChannels.COUNT})],n.prototype,"writeTextureChannels",void 0),e.CloudsTechniqueConfiguration=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration":function(){define(["exports","../../../../../core/Error","./ShaderTechniqueConfigurationKey","../../../../webgl/NoParameters"],(function(e,t,r,i){"use strict";class s extends i.NoParameters{constructor(){super(),this._parameterBits=this._parameterBits?.map((()=>0))??[],this._parameterNames??=[]}get key(){return this._key??=new r.ShaderTechniqueConfigurationKey(this._parameterBits),this._key}decode(e=this.key){const t=this._parameterBits;this._parameterBits=[...e.bits];const r=this._parameterNames.map((e=>`    ${e}: ${this[e]}`)).join("\n");return this._parameterBits=t,r}}e.ShaderTechniqueConfiguration=s,e.parameter=function(e={}){return(r,i)=>{r.hasOwnProperty("_parameterNames")||Object.defineProperty(r,"_parameterNames",{value:r._parameterNames?.slice()??[],configurable:!0,writable:!0}),r.hasOwnProperty("_parameterBits")||Object.defineProperty(r,"_parameterBits",{value:r._parameterBits?.slice()??[0],configurable:!0,writable:!0}),r._parameterNames.push(i);const s=e.count||2,n=Math.ceil(Math.log2(s)),o=r._parameterBits;let a=0;for(;o[a]+n>16;)a++,a>=o.length&&o.push(0);const l=o[a],c=(1<<n)-1<<l;o[a]+=n,e.count?Object.defineProperty(r,i,{get(){return(this._parameterBits[a]&c)>>l},set(r){if(this[i]!==r){if(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~c|+r<<l&c,"number"!=typeof r)throw new t("internal:invalid-shader-configuration",`Configuration value for ${i} must be a number, got ${typeof r}`);if(null==e.count)throw new t("internal:invalid-shader-configuration",`Configuration value for ${i} must provide a count option`)}}}):Object.defineProperty(r,i,{get(){return!!((this._parameterBits[a]&c)>>l)},set(e){if(this[i]!==e&&(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~c|+e<<l&c,"boolean"!=typeof e))throw new t("internal:invalid-shader-configuration",`Configuration value for ${i} must be boolean, got ${typeof e}`)}})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechniqueConfigurationKey":function(){define(["exports","../../../../../core/arrayUtils"],(function(e,t){"use strict";e.ShaderTechniqueConfigurationKey=class{constructor(e){this._bits=[...e]}equals(e){return t.equals(this._bits,e.bits)}get code(){return this._code??=String.fromCharCode(...this._bits),this._code}get bits(){return this._bits}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/NoParameters":function(){define(["exports"],(function(e){"use strict";const t=class{},r=new t;e.NoParameters=t,e.noParameters=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/CloudsRenderer":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/compilerUtils","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/signal","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../core/libs/gl-matrix-2/factories/vec3f32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","./Clouds","../../../chunks/Clouds.glsl","./CloudsPresets","./CloudsTechnique","./CloudsTechniqueConfiguration","./NoiseTextureAtlas","../../support/Scheduler","../../support/Yield","../../webgl/enums","../../webgl/FramebufferObject","../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O){"use strict";e.CloudsRenderer=class extends r{constructor(e){super(e),this._state=a.signal(v.CubeMapState.Idle),this._passParameters=new S.CloudsPassParameters,this._weatherTileCount=128,this._sliceIndex=0,this._tileIndex=0,this._tilesPerSlice=1,this.coverage=s.lerp(w.cloudPresets.default.coverage[0],w.cloudPresets.default.coverage[1],.5),this.density=s.lerp(w.cloudPresets.default.density[0],w.cloudPresets.default.density[1],.5),this.absorption=s.lerp(w.cloudPresets.default.absorption[0],w.cloudPresets.default.absorption[1],.5),this.cloudSize=s.lerp(w.cloudPresets.default.cloudSize[0],w.cloudPresets.default.cloudSize[1],.5),this.detailSize=s.lerp(w.cloudPresets.default.detailSize[0],w.cloudPresets.default.detailSize[1],.5),this.smoothness=s.lerp(w.cloudPresets.default.smoothness[0],w.cloudPresets.default.smoothness[1],.5),this.cloudHeight=s.lerp(w.cloudPresets.default.cloudHeight[0],w.cloudPresets.default.cloudHeight[1],.5),this.raymarchingSteps=w.cloudPresets.default.raymarchingSteps,this._viewMatrix=m.create(),this._dirty=!0,this.running=!0,this._configuration=new T.CloudsTechniqueConfiguration}initialize(){const e=b.getReferenceEllipsoid(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(P.TaskPriority.CLOUDS_GENERATOR,this),o.watch((()=>this.coverage),t,o.initial),o.watch((()=>this.density),t,o.initial),o.watch((()=>this.absorption),t,o.initial),o.watch((()=>this.cloudSize),t,o.initial),o.watch((()=>this.detailSize),t,o.initial),o.watch((()=>this.smoothness),t,o.initial),o.watch((()=>this.cloudHeight),t,o.initial),o.watch((()=>this.raymarchingSteps),t,o.initial)]);const r=g.clone(this._computeWeatherTile());let i=0;this.addHandles(o.watch((()=>{const e=this._computeWeatherTile();return f.equals(r,e)||(++i,f.copy(r,e)),i}),t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=n.destroyMaybe(this._passParameters.noiseTexture)}_precompileTechniques(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=v.CloudsTextureChannels.RG,this.context.techniques.precompile(x.CloudsTechnique,this._configuration),this._configuration.writeTextureChannels=v.CloudsTextureChannels.BA,this.context.techniques.precompile(x.CloudsTechnique,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case T.RayMarchingSteps.SIXTEEN:this._tilesPerSlice=1;break;case T.RayMarchingSteps.HUNDRED:this._tilesPerSlice=4;break;case T.RayMarchingSteps.COUNT:case T.RayMarchingSteps.TWOHUNDRED:this._tilesPerSlice=8;break;default:i.neverReached(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(x.CloudsTechnique,this._configuration)}_computeWeatherTile(){const{camera:e,environment:t}=this.view,{latitude:r,longitude:i}=e.position;if(null==r||null==i)return g.ZEROS;f.set(F,(r+90)/180,(i+180)/360);const s=Math.floor(this._weatherTileCount*Math.abs(2*F[0]-1));F[0]=Math.floor(2*this._weatherTileCount*F[0]),F[1]=Math.floor(4*(this._weatherTileCount-s)*F[1]);let n=0,o=0;if("virtual"!==t?.lighting?.type&&null!=t?.lighting?.date){const e=new Date(t.lighting.date);e.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),n=31*e.getUTCMonth()+e.getUTCDate(),o=e.getUTCFullYear()}return F[0]=(F[0]+n)%(2*this._weatherTileCount),F[1]=(F[1]+o%100)%(4*this._weatherTileCount),F}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new C.NoiseTextureAtlas({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(null==this._fbo){const r=new O.TextureDescriptor(e,e/2);r.target=R.TextureType.TEXTURE_2D_ARRAY,r.depth=6,r.wrapMode=R.TextureWrapMode.CLAMP_TO_EDGE,this._fbo=new E.FramebufferObject(t,r),this.parameters.data=this,this.parameters.absorption=this.absorption,this.parameters.coverage=this.coverage}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=n.disposeMaybe(this._fbo),this.parameters.data=null}applyPreset(e,t){const r=e.median,i=e=>{const i=s.lerp(e[0],e[1],r);return t<.5?s.lerp(e[0],i,2*t):s.lerp(i,e[1],2*(t-.5))};this.coverage=i(e.coverage),this.density=i(e.density),this.absorption=i(e.absorption),this.cloudSize=i(e.cloudSize),this.detailSize=i(e.detailSize),this.smoothness=i(e.smoothness),this.cloudHeight=i(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompileTechniques()}setDirty(){this._dirty=this.running=!0}runTask(e){if(this.state===v.CubeMapState.Fading)return M.Yield;this._dirty&&(this._sliceIndex=this._tileIndex=0,this.state=v.CubeMapState.Rendering,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return M.Yield;const r=A[this._sliceIndex],i=I[this._sliceIndex];p.targetTo(this._viewMatrix,D,r,i),h.fromMat4(this._passParameters.viewMatrix,this._viewMatrix);const s=this.context.renderContext.rctx,n=s.getViewport(),o=S.cubeMapSize/this._tilesPerSlice,a=this._tileIndex*o;s.setViewport(0,a,S.cubeMapSize,o);const l=this._ensureFrameBufferCube(S.cubeMapSize);s.bindFramebuffer(l),this._passParameters.lastSlice=5===this._sliceIndex,s.bindTechnique(t,this.context.renderContext.bind,this._passParameters);const c=R.TextureType.TEXTURE_2D_ARRAY;return l.setColorTextureTarget(c,R.ColorAttachment0,this._sliceIndex),s.screen.draw(),s.gl.flush(),s.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,5===this._sliceIndex&&this._tileIndex===this._tilesPerSlice?(this._sliceIndex=this._tileIndex=0,this.state=v.CubeMapState.Ready,this.running=!1):this._tileIndex===this._tilesPerSlice&&(++this._sliceIndex,this._tileIndex=0),e.madeProgress(),M.Yield}},t.__decorate([l.property({constructOnly:!0})],e.CloudsRenderer.prototype,"context",void 0),t.__decorate([l.property({constructOnly:!0})],e.CloudsRenderer.prototype,"view",void 0),t.__decorate([l.property({constructOnly:!0})],e.CloudsRenderer.prototype,"requestRender",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"coverage",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"density",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"absorption",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"cloudSize",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"detailSize",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"smoothness",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"cloudHeight",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"raymarchingSteps",void 0),t.__decorate([l.property()],e.CloudsRenderer.prototype,"running",void 0),e.CloudsRenderer=t.__decorate([d.subclass("esri.views.3d.environment.CloudsRenderer")],e.CloudsRenderer);const A=[y.fromValues(1,0,0),y.fromValues(-1,0,0),y.fromValues(0,1,0),y.fromValues(0,-1,0),y.fromValues(0,0,1),y.fromValues(0,0,1)],I=[y.fromValues(0,0,-1),y.fromValues(0,0,-1),y.fromValues(0,0,-1),y.fromValues(0,0,-1),y.fromValues(0,1,0),y.fromValues(0,1,0)],D=_.zeros(),F=g.zeros();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/libs/gl-matrix-2/factories/vec3f32":function(){define(["exports"],(function(e){"use strict";function t(){return new Float32Array(3)}function r(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function i(e,t,r){const i=new Float32Array(3);return i[0]=e,i[1]=t,i[2]=r,i}function s(){return t()}function n(){return i(1,1,1)}function o(){return i(1,0,0)}function a(){return i(0,1,0)}function l(){return i(0,0,1)}const c=s(),u=n(),d=o(),h=a(),p=l(),m=Object.freeze(Object.defineProperty({__proto__:null,ONES:u,UNIT_X:d,UNIT_Y:h,UNIT_Z:p,ZEROS:c,clone:r,create:t,fromValues:i,ones:n,unitX:o,unitY:a,unitZ:l,zeros:s},Symbol.toStringTag,{value:"Module"}));e.ONES=u,e.UNIT_X=d,e.UNIT_Y=h,e.UNIT_Z=p,e.ZEROS=c,e.clone=r,e.create=t,e.fromValues=i,e.ones=n,e.unitX=o,e.unitY=a,e.unitZ=l,e.vec3f32=m,e.zeros=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Clouds.glsl":function(){define(["exports","../core/has","../core/mathUtils","../core/libs/gl-matrix-2/factories/mat3f64","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","../views/3d/environment/CloudsTechniqueConfiguration","../views/3d/environment/NoiseTextureAtlasDimensions","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/BooleanPassUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix3PassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/shaders/SphereIntersect.glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";class _ extends g.NoParameters{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.lastSlice=!1,this.viewMatrix=i.create()}}const b=t("esri-mobile")?1024:2048;function v(e){const t=new y.ShaderBuilder;t.include(l.ScreenSpacePass,!1);const i=t.fragment;return i.include(f.SphereIntersect),i.uniforms.add(new d.FloatPassUniform("cloudRadius",(e=>e.cloudRadius)),new d.FloatPassUniform("power",(e=>r.lerp(35,120,e.absorption))),new d.FloatPassUniform("sigmaE",(e=>1+e.absorption)),new d.FloatPassUniform("density",(e=>r.lerp(0,.3,e.density))),new d.FloatPassUniform("cloudSize",(e=>r.lerp(0,.02,Math.max(.01,1-e.cloudSize)))),new d.FloatPassUniform("detailSize",(e=>r.lerp(0,.2,Math.max(.01,1-e.detailSize)))),new d.FloatPassUniform("smoothness",(e=>r.lerp(0,.5,1-e.smoothness))),new d.FloatPassUniform("cloudHeight",(e=>r.lerp(0,1500,e.cloudHeight))),new d.FloatPassUniform("coverage",(e=>e.coverage)),new p.Matrix3PassUniform("view",(e=>e.viewMatrix)),new m.Texture2DPassUniform("cloudShapeTexture",(e=>null!=e.noiseTexture?e.noiseTexture.textureAtlas:null)),new u.Float2PassUniform("cloudVariables",(e=>s.set(S,e.coverage,e.absorption))),new c.BooleanPassUniform("lastSlice",(e=>e.lastSlice))),i.constants.add("halfCubeMapSize","float",.5*b),i.code.add(h.glsl`
    const int STEPS = ${e.steps===o.RayMarchingSteps.SIXTEEN?h.glsl`16`:e.steps===o.RayMarchingSteps.HUNDRED?h.glsl`100`:h.glsl`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord;
      xy.x -= halfCubeMapSize;
      xy.y = lastSlice ? fragCoord.y - halfCubeMapSize : fragCoord.y;

      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),i.code.add(h.glsl`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${h.glsl.float(a.atlasSize)};
      const float dataWidth = ${h.glsl.float(a.atlasSize)};
      const float tileRows = ${h.glsl.float(a.tileRows)};
      const vec3 atlasDimensions = vec3(${h.glsl.float(a.tileSize)}, ${h.glsl.float(a.tileSize)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${h.glsl.float(a.textureScale)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${h.glsl.float(a.weatherMapScale)} * p) / ${h.glsl.float(a.atlasSize)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),i.code.add(h.glsl`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),i.code.add(h.glsl`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),i.code.add(h.glsl`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),i.code.add(h.glsl`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),i.main.add(h.glsl`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),t}const S=n.create(),w=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:_,build:v,cubeMapSize:b},Symbol.toStringTag,{value:"Module"}));e.Clouds=w,e.CloudsPassParameters=_,e.build=v,e.cubeMapSize=b}))},"esri/views/3d/environment/NoiseTextureAtlasDimensions":function(){define(["exports","../../../core/has"],(function(e,t){"use strict";const r=t("esri-mobile")?64:128,i=r/128,s=Math.ceil(Math.sqrt(r)),n=(r+2)*s,o=n/1560;e.atlasSize=n,e.textureScale=i,e.tileRows=s,e.tileSize=r,e.weatherMapScale=o,e.weatherMapSize=1e5,e.weatherTileSize=128,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl":function(){define(["exports","../shaderModules/glsl","../../lib/VertexAttribute"],(function(e,t,r){"use strict";e.ScreenSpacePass=function(e,i=!0){e.attributes.add(r.VertexAttribute.POSITION,"vec2"),i&&e.varyings.add("uv","vec2"),e.vertex.main.add(t.glsl`
      gl_Position = vec4(position, 0.0, 1.0);
      ${i?t.glsl`uv = position * 0.5 + vec2(0.5);`:""}
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/glsl":function(){define(["exports"],(function(e){"use strict";function t(e,...t){let r="";for(let i=0;i<t.length;i++)r+=e[i]+t[i];return r+=e[e.length-1],r}!function(e){e.int=function(e){return Math.round(e).toString()},e.float=function(e){return e.toPrecision(8)}}(t||(t={})),e.If=function(e,t,r=""){return e?t:r},e.glsl=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/VertexAttribute":function(){define(["exports"],(function(e){"use strict";var t;e.VertexAttribute=void 0,(t=e.VertexAttribute||(e.VertexAttribute={})).POSITION="position",t.NORMAL="normal",t.NORMALCOMPRESSED="normalCompressed",t.UV0="uv0",t.UVI="uvi",t.COLOR="color",t.SYMBOLCOLOR="symbolColor",t.SIZE="size",t.ROTATION="rotation",t.TANGENT="tangent",t.OFFSET="offset",t.PERSPECTIVEDIVIDE="perspectiveDivide",t.CENTEROFFSETANDDISTANCE="centerOffsetAndDistance",t.LENGTH="length",t.NEXTDELTA="nextDelta",t.PREVIOUSDELTA="previousDelta",t.U0="u0",t.LINEPARAMETERS="lineParameters",t.COLORFEATUREATTRIBUTE="colorFeatureAttribute",t.SIZEFEATUREATTRIBUTE="sizeFeatureAttribute",t.OPACITYFEATUREATTRIBUTE="opacityFeatureAttribute",t.DISTANCETOSTART="distanceToStart",t.UVMAPSPACE="uvMapSpace",t.BOUNDINGRECT="boundingRect",t.UVREGION="uvRegion",t.PROFILERIGHT="profileRight",t.PROFILEUP="profileUp",t.PROFILEVERTEXANDNORMAL="profileVertexAndNormal",t.PROFILEAUXDATA="profileAuxData",t.INSTANCEMODELORIGINHI="instanceModelOriginHi",t.INSTANCEMODELORIGINLO="instanceModelOriginLo",t.INSTANCEMODEL="instanceModel",t.INSTANCEMODELNORMAL="instanceModelNormal",t.INSTANCECOLOR="instanceColor",t.INSTANCEFEATUREATTRIBUTE="instanceFeatureAttribute",t.LOCALTRANSFORM="localTransform",t.GLOBALTRANSFORM="globalTransform",t.BOUNDINGSPHERE="boundingSphere",t.MODELORIGIN="modelOrigin",t.MODELSCALEFACTORS="modelScaleFactors",t.FEATUREATTRIBUTE="featureAttribute",t.STATE="state",t.LODLEVEL="lodLevel",t.POSITION0="position0",t.POSITION1="position1",t.NORMAL2COMPRESSED="normal2Compressed",t.COMPONENTINDEX="componentIndex",t.VARIANTOFFSET="variantOffset",t.VARIANTSTROKE="variantStroke",t.VARIANTEXTENSION="variantExtension",t.SIDENESS="sideness",t.START="start",t.END="end",t.UP="up",t.START_UP="startUp",t.END_UP="endUp",t.EXTRUDE="extrude",t.OLIDCOLOR="objectAndLayerIdColor",t.INSTANCEOBJECTANDLAYERIDCOLOR="instanceObjectAndLayerIdColor",e.affectsGeometry=function(t){return t===e.VertexAttribute.POSITION},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/BooleanPassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"bool",t.BindType.Pass,((t,i,s)=>t.setUniform1b(e,r(i,s))))}}e.BooleanPassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/BindType":function(){define(["exports"],(function(e){"use strict";var t;e.BindType=void 0,(t=e.BindType||(e.BindType={}))[t.Bind=0]="Bind",t[t.Pass=1]="Pass",t[t.Draw=2]="Draw",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/Uniform":function(){define(["exports","../../core/has","./BindType"],(function(e,t,r){"use strict";e.Uniform=class{constructor(e,t,i,s,n=null){if(this.name=e,this.type=t,this.arraySize=n,this.bind={[r.BindType.Bind]:null,[r.BindType.Pass]:null,[r.BindType.Draw]:null},s)switch(i){case void 0:break;case r.BindType.Bind:this.bind[r.BindType.Bind]=s;break;case r.BindType.Pass:this.bind[r.BindType.Pass]=s;break;case r.BindType.Draw:this.bind[r.BindType.Draw]=s}}equals(e){return this.type===e.type&&this.name===e.name&&this.arraySize===e.arraySize}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Float2PassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"vec2",t.BindType.Pass,((t,i,s)=>t.setUniform2fv(e,r(i,s))))}}e.Float2PassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/FloatPassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"float",t.BindType.Pass,((t,i,s)=>t.setUniform1f(e,r(i,s))))}}e.FloatPassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Matrix3PassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"mat3",t.BindType.Pass,((t,i,s)=>t.setUniformMatrix3fv(e,r(i,s))))}}e.Matrix3PassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"sampler2D",t.BindType.Pass,((t,i,s)=>t.bindTexture(e,r(i,s))))}}e.Texture2DPassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/SphereIntersect.glsl":function(){define(["exports","../core/shaderModules/glsl"],(function(e,t){"use strict";e.SphereIntersect=function(e){e.code.add(t.glsl`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/ShaderBuilder":function(){define(["exports","../../core/Error","../../core/has","../../core/Logger","./BindType"],(function(e,t,r,i,s){"use strict";const n=()=>i.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class o{constructor(){this._includedModules=new Map}include(e,t){this._includedModules.has(e)?this._includedModules.get(e):(this._includedModules.set(e,t),e(this.builder,t))}}class a{constructor(e){this._stage=e,this._entries=new Map}add(...e){for(const t of e)this._add(t);return this._stage}get(e){return this._entries.get(e)}_add(e){if(null!=e){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new t("shaderbuilder:duplicate-uniform",`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else n().error(`Trying to add null Uniform from ${(new Error).stack}.`)}generateSource(){return Array.from(this._entries.values()).map((({name:e,arraySize:t,type:r})=>null!=t?`uniform ${r} ${e}[${t}];`:`uniform ${r} ${e};`))}get entries(){return Array.from(this._entries.values())}}class l{constructor(e){this._stage=e,this._bodies=new Array}add(e){return this._bodies.push(e),this._stage}generateSource(e){if(this._bodies.length>0)return[`void main() {\n ${this._bodies.join("\n")||""} \n}`];if(e)throw new t("shaderbuilder:missing-main","Shader does not contain main function body.");return[]}}class c{constructor(e){this._stage=e,this._entries=new Array}add(e){return this._entries.push(e),this._stage}generateSource(){return this._entries}}class u extends o{constructor(){super(...arguments),this.uniforms=new a(this),this.main=new l(this),this.code=new c(this),this.constants=new f(this)}get builder(){return this}}class d{constructor(){this._entries=new Array}add(e,t){this._entries.push([e,t])}generateSource(e){return"fragment"===e?[]:this._entries.map((e=>`in ${e[1]} ${e[0]};`))}}class h{constructor(){this._entries=new Map}add(e,t,r){this._entries.has(e)?n().warn(`Ignoring duplicate varying ${t} ${e}`):this._entries.set(e,{type:t,invariant:r?.invariant??!1})}generateSource(e){const t=new Array;return this._entries.forEach(((r,i)=>t.push((r.invariant&&"vertex"===e?"invariant ":"")+("vertex"===e?"out":"in")+` ${r.type} ${i};`))),t}}class p{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const t="vertex"===e?p.ALLOWLIST_VERTEX:p.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((e=>t.includes(e))).map((e=>`#extension ${e} : enable`))}static{this.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"]}static{this.ALLOWLIST_VERTEX=[]}}class m{constructor(){this._entries=new Map}add(e,t,r=0){const i=this._entries.get(r);i?.name!==e||i?.type!==t?this._entries.set(r,{name:e,type:t}):n().warn(`Fragment shader output location ${r} occupied`)}static{this.DEFAULT_TYPE="vec4"}static{this.DEFAULT_NAME="fragColor"}generateSource(e){if("vertex"===e)return[];0===this._entries.size&&this._entries.set(0,{name:m.DEFAULT_NAME,type:m.DEFAULT_TYPE});const t=new Array;return this._entries.forEach(((e,r)=>t.push(`layout(location = ${r}) out ${e.type} ${e.name};`))),t}}class f{constructor(e){this._stage=e,this._entries=new Set}add(e,t,r){let i="ERROR_CONSTRUCTOR_STRING";switch(t){case"float":i=f._numberToFloatStr(r);break;case"int":i=f._numberToIntStr(r);break;case"bool":i=r.toString();break;case"vec2":i=`vec2(${f._numberToFloatStr(r[0])},                            ${f._numberToFloatStr(r[1])})`;break;case"vec3":i=`vec3(${f._numberToFloatStr(r[0])},                            ${f._numberToFloatStr(r[1])},                            ${f._numberToFloatStr(r[2])})`;break;case"vec4":i=`vec4(${f._numberToFloatStr(r[0])},                            ${f._numberToFloatStr(r[1])},                            ${f._numberToFloatStr(r[2])},                            ${f._numberToFloatStr(r[3])})`;break;case"ivec2":i=`ivec2(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])})`;break;case"ivec3":i=`ivec3(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])},                             ${f._numberToIntStr(r[2])})`;break;case"ivec4":i=`ivec4(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])},                             ${f._numberToIntStr(r[2])},                             ${f._numberToIntStr(r[3])})`;break;case"uvec2":i=`uvec2(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])})`;break;case"uvec3":i=`uvec3(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])},                             ${f._numberToIntStr(r[2])})`;break;case"uvec4":i=`uvec4(${f._numberToIntStr(r[0])},                             ${f._numberToIntStr(r[1])},                             ${f._numberToIntStr(r[2])},                             ${f._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":i=`${t}(${Array.prototype.map.call(r,(e=>f._numberToFloatStr(e))).join(", ")})`}return this._entries.add(`const ${t} ${e} = ${i};`),this._stage}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}e.Code=c,e.Includes=o,e.Main=l,e.ShaderBuilder=class extends o{constructor(){super(...arguments),this.vertex=new u,this.fragment=new u,this.attributes=new d,this.varyings=new h,this.extensions=new p,this.outputs=new m}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e,t=!1){const r=this.extensions.generateSource(e),i=this.attributes.generateSource(e),s=this.varyings.generateSource(e),n="vertex"===e?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),l=n.main.generateSource(t),c="vertex"===e?"precision highp float;\n precision highp sampler2D;\n precision highp usampler2D;\n precision highp sampler2DArray;\n precision highp sampler2DShadow;\n\n\n invariant gl_Position;\n ":"#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp int;\n  precision highp sampler2D;\n  precision highp usampler2D;\n  precision highp sampler2DArray;\n  precision highp sampler2DShadow;\n#else\n  precision mediump float;\n  precision mediump int;\n  precision mediump sampler2D;\n  precision mediump usampler2D;\n  precision mediump sampler2DArray;\n  precision mediump sampler2DShadow;\n#endif",u=n.constants.generateSource(),d=this.outputs.generateSource(e);return`#version 300 es\n${r.join("\n")}\n${c}\n${u.join("\n")}\n${o.join("\n")}\n${i.join("\n")}\n${s.join("\n")}\n${d.join("\n")}\n${a.join("\n")}\n${l.join("\n")}`}generateBind(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const r=e.bind[s.BindType.Bind];r&&t.set(e.name,r)})),this.fragment.uniforms.entries.forEach((e=>{const r=e.bind[s.BindType.Bind];r&&t.set(e.name,r)}));const r=Array.from(t.values()),i=r.length;return t=>{for(let s=0;s<i;++s)r[s](e,t)}}generateBindPass(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const r=e.bind[s.BindType.Pass];r&&t.set(e.name,r)})),this.fragment.uniforms.entries.forEach((e=>{const r=e.bind[s.BindType.Pass];r&&t.set(e.name,r)}));const r=Array.from(t.values()),i=r.length;return(t,s)=>{for(let n=0;n<i;++n)r[n](e,t,s)}}generateBindDraw(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const r=e.bind[s.BindType.Draw];r&&t.set(e.name,r)})),this.fragment.uniforms.entries.forEach((e=>{const r=e.bind[s.BindType.Draw];r&&t.set(e.name,r)}));const r=Array.from(t.values()),i=r.length;return(t,s,n)=>{for(let o=0;o<i;++o)r[o](e,n,t,s)}}},e.Stage=u,e.Uniforms=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/CloudsTechnique":function(){define(["require","exports","./Clouds","../../../chunks/Clouds.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../../webgl/enums","../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends n.ShaderTechnique{constructor(t,r){super(t,r,new s.ReloadableShaderModule(i.Clouds,(()=>new Promise(((t,r)=>e(["./Clouds.glsl"],t,r))))))}initializePipeline(e){return a.makePipelineState({blending:a.simpleBlendingParams(o.BlendFactor.CONSTANT_COLOR,o.BlendFactor.ONE_MINUS_CONSTANT_COLOR,o.BlendOperation.ADD,e.writeTextureChannels===r.CloudsTextureChannels.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:o.CompareFunction.LEQUAL},colorWrite:a.defaultColorWrite})}}t.CloudsTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderTechnique/ReloadableShaderModule":function(){define(["exports"],(function(e){"use strict";e.ReloadableShaderModule=class{constructor(e,t){this._module=e,this._load=t}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechnique":function(){define(["exports","../../../../../core/Logger","../../../../../core/maybe","../shaderLibrary/ShaderOutput","../../lib/DefaultVertexAttributeLocations","../../lib/Program","../../../../webgl/enums","../../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";e.ShaderTechnique=class{constructor(e,i,a,l=s.Default3D){this.locations=l,this.primitiveType=o.PrimitiveType.TRIANGLES,this.key=i.key,this._program=new n.Program(e.rctx,a.get().build(i),l),this._pipeline=this.initializePipeline(i),this.reload=async s=>{s&&await a.reload(),this.key.equals(i.key)||t.getLogger("esri.views.3d.webgl.ShaderTechnique").warn("Configuration was changed after construction, cannot reload shader.",a),r.disposeMaybe(this._program),this._program=new n.Program(e.rctx,a.get().build(i),l),this._pipeline=this.initializePipeline(i)}}destroy(){this._program=r.disposeMaybe(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,t){return this._pipeline}initializePipeline(e){return a.makePipelineState({blending:a.premultipliedAlpha,colorWrite:a.defaultColorWrite})}},e.depthOnlyOutputBuffersOr=function(e,t){return i.isDepthOnlyOutput(e)?{buffers:[o.SpecialDrawBuffers.NONE]}:t??null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/ShaderOutput":function(){define(["exports"],(function(e){"use strict";var t;function r(t){return t===e.ShaderOutput.Highlight||t===e.ShaderOutput.ObjectAndLayerIdColor}function i(t){return t===e.ShaderOutput.Color}function s(e){return i(e)||d(e)}function n(t){return i(t)||t===e.ShaderOutput.Highlight}function o(e){return i(e)||r(e)}function a(e){return s(e)||r(e)}function l(e){return o(e)||u(e)}function c(e){return a(e)||u(e)}function u(t){return t===e.ShaderOutput.Depth}function d(t){return t===e.ShaderOutput.ColorEmission}e.ShaderOutput=void 0,(t=e.ShaderOutput||(e.ShaderOutput={}))[t.Color=0]="Color",t[t.ColorEmission=1]="ColorEmission",t[t.Depth=2]="Depth",t[t.Normal=3]="Normal",t[t.Shadow=4]="Shadow",t[t.ShadowHighlight=5]="ShadowHighlight",t[t.ShadowExcludeHighlight=6]="ShadowExcludeHighlight",t[t.ViewshedShadow=7]="ViewshedShadow",t[t.Highlight=8]="Highlight",t[t.ObjectAndLayerIdColor=9]="ObjectAndLayerIdColor",t[t.COUNT=10]="COUNT",e.is2DGeometryOutput=function(e){return i(e)||r(e)},e.is3DGeometryOutput=function(t){return l(t)||t===e.ShaderOutput.Normal},e.is3DGeometryOutputMRT=function(t){return c(t)||t===e.ShaderOutput.Normal},e.isColor=i,e.isColorEmission=d,e.isColorEmissionHighlightOIDOrDepth=c,e.isColorEmissionHighlightOrOID=a,e.isColorHighlightOIDOrDepth=l,e.isColorHighlightOrDepth=function(e){return n(e)||u(e)},e.isColorHighlightOrOID=o,e.isColorOrColorEmission=s,e.isColorOrColorEmissionOrOID=function(t){return s(t)||t===e.ShaderOutput.ObjectAndLayerIdColor},e.isColorOrHighlight=n,e.isColorOrOID=function(t){return i(t)||t===e.ShaderOutput.ObjectAndLayerIdColor},e.isDepth=u,e.isDepthOnlyOutput=function(t){switch(t){case e.ShaderOutput.Depth:case e.ShaderOutput.Shadow:case e.ShaderOutput.ShadowHighlight:case e.ShaderOutput.ShadowExcludeHighlight:case e.ShaderOutput.ViewshedShadow:return!0}return!1},e.isHighlightOrOID=r,e.isShadowRelatedOutput=function(t){return t===e.ShaderOutput.Shadow||t===e.ShaderOutput.ShadowHighlight||t===e.ShaderOutput.ShadowExcludeHighlight||t===e.ShaderOutput.ViewshedShadow},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/DefaultVertexAttributeLocations":function(){define(["exports","./VertexAttribute"],(function(e,t){"use strict";const r=new Map([[t.VertexAttribute.POSITION,0],[t.VertexAttribute.NORMAL,1],[t.VertexAttribute.NORMALCOMPRESSED,1],[t.VertexAttribute.UV0,2],[t.VertexAttribute.UVI,2],[t.VertexAttribute.COLOR,3],[t.VertexAttribute.COLORFEATUREATTRIBUTE,3],[t.VertexAttribute.SIZE,4],[t.VertexAttribute.TANGENT,4],[t.VertexAttribute.CENTEROFFSETANDDISTANCE,5],[t.VertexAttribute.SYMBOLCOLOR,5],[t.VertexAttribute.FEATUREATTRIBUTE,6],[t.VertexAttribute.INSTANCEFEATUREATTRIBUTE,6],[t.VertexAttribute.OLIDCOLOR,6],[t.VertexAttribute.INSTANCEOBJECTANDLAYERIDCOLOR,6],[t.VertexAttribute.INSTANCECOLOR,7],[t.VertexAttribute.ROTATION,8],[t.VertexAttribute.INSTANCEMODEL,8],[t.VertexAttribute.INSTANCEMODELNORMAL,12],[t.VertexAttribute.INSTANCEMODELORIGINHI,11],[t.VertexAttribute.INSTANCEMODELORIGINLO,15]]);e.Default3D=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Program":function(){define(["exports","../../../../core/has","../../../webgl/checkWebGLError"],(function(e,t,r){"use strict";e.Program=class{constructor(e,t,r){this._context=e,this._locations=r,this._textures=new Map,this._glProgram=e.programCache.acquire(t.generate("vertex",!0),t.generate("fragment",!0),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=t.generateBind(this),this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t){this._glProgram.setUniform1f(e,t)}setUniform2fv(e,t){this._glProgram.setUniform2fv(e,t)}setUniform3fv(e,t){this._glProgram.setUniform3fv(e,t)}setUniform4fv(e,t){this._glProgram.setUniform4fv(e,t)}setUniformMatrix3fv(e,t){this._glProgram.setUniformMatrix3fv(e,t)}setUniformMatrix4fv(e,t){this._glProgram.setUniformMatrix4fv(e,t)}setUniform1fv(e,t){this._glProgram.setUniform1fv(e,t)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear()}bindTexture(e,t){t?.glName||(r.webglDebugEnabled()&&console.error(`Texture sampler ${e} has no given Texture in ${(new Error).stack} `),t=this._context.emptyTexture);const i=this._ensureTextureUnit(e,t);this._context.useProgram(this),this.setUniform1i(e,i.unit),this._context.bindTexture(t,i.unit)}_ensureTextureUnit(e,t){let r=this._textures.get(e);return null==r?(r={texture:t,unit:this._textures.size},this._textures.set(e,r)):r.texture=t,r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/checkWebGLError":function(){define(["exports","../../core/Error","../../core/has","../../core/Logger","./enums"],(function(e,t,r,i,s){"use strict";function n(e){switch(e){case s.ErrorConstant.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case s.ErrorConstant.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case s.ErrorConstant.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case s.ErrorConstant.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case s.ErrorConstant.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case s.ErrorConstant.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const o=!!r("enable-feature:webgl-debug");function a(){return o}e.checkWebGLError=function(e,r=a()){if(r){const r=e.getError();if(r){const e=n(r),s=(new Error).stack;i.getLogger("esri.views.webgl.checkWebGLError").error(new t("webgl-error","WebGL error occurred",{message:e,stack:s}))}}},e.getErrorMessage=n,e.hasFeatureFlagWebGLDebug=o,e.webglDebugEnabled=a,e.webglValidateShadersEnabled=function(){return o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/enums":function(){define(["exports"],(function(e){"use strict";var t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N;e.FramebufferBit=void 0,(t=e.FramebufferBit||(e.FramebufferBit={}))[t.DEPTH=256]="DEPTH",t[t.STENCIL=1024]="STENCIL",t[t.COLOR=16384]="COLOR",e.BufferContent=void 0,(r=e.BufferContent||(e.BufferContent={}))[r.COLOR=6144]="COLOR",r[r.DEPTH=6145]="DEPTH",r[r.STENCIL=6146]="STENCIL",r[r.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e.PrimitiveType=void 0,(i=e.PrimitiveType||(e.PrimitiveType={}))[i.POINTS=0]="POINTS",i[i.LINES=1]="LINES",i[i.LINE_LOOP=2]="LINE_LOOP",i[i.LINE_STRIP=3]="LINE_STRIP",i[i.TRIANGLES=4]="TRIANGLES",i[i.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",i[i.TRIANGLE_FAN=6]="TRIANGLE_FAN",e.BlendFactor=void 0,(s=e.BlendFactor||(e.BlendFactor={}))[s.ZERO=0]="ZERO",s[s.ONE=1]="ONE",s[s.SRC_COLOR=768]="SRC_COLOR",s[s.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",s[s.SRC_ALPHA=770]="SRC_ALPHA",s[s.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",s[s.DST_ALPHA=772]="DST_ALPHA",s[s.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",s[s.DST_COLOR=774]="DST_COLOR",s[s.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",s[s.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",s[s.CONSTANT_COLOR=32769]="CONSTANT_COLOR",s[s.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",s[s.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",s[s.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e.BlendOperation=void 0,(n=e.BlendOperation||(e.BlendOperation={}))[n.ADD=32774]="ADD",n[n.MIN=32775]="MIN",n[n.MAX=32776]="MAX",n[n.SUBTRACT=32778]="SUBTRACT",n[n.REVERSE_SUBTRACT=32779]="REVERSE_SUBTRACT",e.BufferType=void 0,(o=e.BufferType||(e.BufferType={}))[o.ARRAY_BUFFER=34962]="ARRAY_BUFFER",o[o.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",o[o.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",o[o.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",o[o.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",o[o.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",o[o.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",o[o.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",e.Face=void 0,(a=e.Face||(e.Face={}))[a.FRONT=1028]="FRONT",a[a.BACK=1029]="BACK",a[a.FRONT_AND_BACK=1032]="FRONT_AND_BACK",e.CullMode=void 0,(l=e.CullMode||(e.CullMode={}))[l.CW=2304]="CW",l[l.CCW=2305]="CCW",e.DataType=void 0,(c=e.DataType||(e.DataType={}))[c.BYTE=5120]="BYTE",c[c.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",c[c.SHORT=5122]="SHORT",c[c.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",c[c.INT=5124]="INT",c[c.UNSIGNED_INT=5125]="UNSIGNED_INT",c[c.FLOAT=5126]="FLOAT",c[c.HALF_FLOAT=5131]="HALF_FLOAT",e.CompareFunction=void 0,(u=e.CompareFunction||(e.CompareFunction={}))[u.NEVER=512]="NEVER",u[u.LESS=513]="LESS",u[u.EQUAL=514]="EQUAL",u[u.LEQUAL=515]="LEQUAL",u[u.GREATER=516]="GREATER",u[u.NOTEQUAL=517]="NOTEQUAL",u[u.GEQUAL=518]="GEQUAL",u[u.ALWAYS=519]="ALWAYS",e.StencilOperation=void 0,(d=e.StencilOperation||(e.StencilOperation={}))[d.ZERO=0]="ZERO",d[d.KEEP=7680]="KEEP",d[d.REPLACE=7681]="REPLACE",d[d.INCR=7682]="INCR",d[d.DECR=7683]="DECR",d[d.INVERT=5386]="INVERT",d[d.INCR_WRAP=34055]="INCR_WRAP",d[d.DECR_WRAP=34056]="DECR_WRAP",e.TextureSamplingMode=void 0,(h=e.TextureSamplingMode||(e.TextureSamplingMode={}))[h.NEAREST=9728]="NEAREST",h[h.LINEAR=9729]="LINEAR",h[h.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",h[h.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",h[h.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",h[h.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",e.TextureWrapMode=void 0,(p=e.TextureWrapMode||(e.TextureWrapMode={}))[p.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",p[p.REPEAT=10497]="REPEAT",p[p.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e.TextureType=void 0,(m=e.TextureType||(e.TextureType={}))[m.TEXTURE_2D=3553]="TEXTURE_2D",m[m.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",m[m.TEXTURE_3D=32879]="TEXTURE_3D",m[m.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",m[m.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",m[m.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",m[m.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",m[m.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",m[m.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",m[m.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",e.TextureConstants=void 0,(f=e.TextureConstants||(e.TextureConstants={}))[f.MIN_LOD=33082]="MIN_LOD",f[f.MAX_LOD=33083]="MAX_LOD",f[f.BASE_LEVEL=33084]="BASE_LEVEL",f[f.MAX_LEVEL=33085]="MAX_LEVEL",f[f.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",e.PixelFormat=void 0,(g=e.PixelFormat||(e.PixelFormat={}))[g.ALPHA=6406]="ALPHA",g[g.RGB=6407]="RGB",g[g.RGBA=6408]="RGBA",g[g.LUMINANCE=6409]="LUMINANCE",g[g.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",g[g.RED=6403]="RED",g[g.RG=33319]="RG",g[g.RED_INTEGER=36244]="RED_INTEGER",g[g.RG_INTEGER=33320]="RG_INTEGER",g[g.RGB_INTEGER=36248]="RGB_INTEGER",g[g.RGBA_INTEGER=36249]="RGBA_INTEGER",e.SizedPixelFormat=void 0,(y=e.SizedPixelFormat||(e.SizedPixelFormat={}))[y.RGBA4=32854]="RGBA4",y[y.R16F=33325]="R16F",y[y.RG16F=33327]="RG16F",y[y.RGB32F=34837]="RGB32F",y[y.RGBA16F=34842]="RGBA16F",y[y.R32F=33326]="R32F",y[y.RG32F=33328]="RG32F",y[y.RGBA32F=34836]="RGBA32F",y[y.R11F_G11F_B10F=35898]="R11F_G11F_B10F",y[y.RGB8=32849]="RGB8",y[y.RGBA8=32856]="RGBA8",y[y.RGB5_A1=32855]="RGB5_A1",y[y.R8=33321]="R8",y[y.RG8=33323]="RG8",y[y.R8I=33329]="R8I",y[y.R8UI=33330]="R8UI",y[y.R16I=33331]="R16I",y[y.R16UI=33332]="R16UI",y[y.R32I=33333]="R32I",y[y.R32UI=33334]="R32UI",y[y.RG8I=33335]="RG8I",y[y.RG8UI=33336]="RG8UI",y[y.RG16I=33337]="RG16I",y[y.RG16UI=33338]="RG16UI",y[y.RG32I=33339]="RG32I",y[y.RG32UI=33340]="RG32UI",y[y.RGB16F=34843]="RGB16F",y[y.RGB9_E5=35901]="RGB9_E5",y[y.SRGB8=35905]="SRGB8",y[y.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",y[y.RGB565=36194]="RGB565",y[y.RGBA32UI=36208]="RGBA32UI",y[y.RGB32UI=36209]="RGB32UI",y[y.RGBA16UI=36214]="RGBA16UI",y[y.RGB16UI=36215]="RGB16UI",y[y.RGBA8UI=36220]="RGBA8UI",y[y.RGB8UI=36221]="RGB8UI",y[y.RGBA32I=36226]="RGBA32I",y[y.RGB32I=36227]="RGB32I",y[y.RGBA16I=36232]="RGBA16I",y[y.RGB16I=36233]="RGB16I",y[y.RGBA8I=36238]="RGBA8I",y[y.RGB8I=36239]="RGB8I",y[y.R8_SNORM=36756]="R8_SNORM",y[y.RG8_SNORM=36757]="RG8_SNORM",y[y.RGB8_SNORM=36758]="RGB8_SNORM",y[y.RGBA8_SNORM=36759]="RGBA8_SNORM",y[y.RGB10_A2=32857]="RGB10_A2",y[y.RGB10_A2UI=36975]="RGB10_A2UI",e.UnsizedDepthFormat=void 0,(_=e.UnsizedDepthFormat||(e.UnsizedDepthFormat={}))[_.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",_[_.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e.SizedDepthStencilFormat=void 0,(b=e.SizedDepthStencilFormat||(e.SizedDepthStencilFormat={}))[b.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",b[b.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",e.SizedDepthFormat=void 0,(v=e.SizedDepthFormat||(e.SizedDepthFormat={}))[v.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",v[v.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",v[v.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",e.SizedStencilFormat=void 0,(S=e.SizedStencilFormat||(e.SizedStencilFormat={}))[S.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e.PixelType=void 0,(w=e.PixelType||(e.PixelType={}))[w.FLOAT=5126]="FLOAT",w[w.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",w[w.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",w[w.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",w[w.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",w[w.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",w[w.BYTE=5120]="BYTE",w[w.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",w[w.SHORT=5122]="SHORT",w[w.UNSIGNED_INT=5125]="UNSIGNED_INT",w[w.INT=5124]="INT",w[w.HALF_FLOAT=5131]="HALF_FLOAT",w[w.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",w[w.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",w[w.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",w[w.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",e.Usage=void 0,(x=e.Usage||(e.Usage={}))[x.STATIC_DRAW=35044]="STATIC_DRAW",x[x.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",x[x.STREAM_DRAW=35040]="STREAM_DRAW",x[x.STATIC_READ=35045]="STATIC_READ",x[x.DYNAMIC_READ=35049]="DYNAMIC_READ",x[x.STREAM_READ=35041]="STREAM_READ",x[x.STATIC_COPY=35046]="STATIC_COPY",x[x.DYNAMIC_COPY=35050]="DYNAMIC_COPY",x[x.STREAM_COPY=35042]="STREAM_COPY",e.ShaderType=void 0,(T=e.ShaderType||(e.ShaderType={}))[T.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",T[T.VERTEX_SHADER=35633]="VERTEX_SHADER",e.FramebufferTarget=void 0,(C=e.FramebufferTarget||(e.FramebufferTarget={}))[C.FRAMEBUFFER=36160]="FRAMEBUFFER",C[C.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",C[C.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",e.ResourceType=void 0,(P=e.ResourceType||(e.ResourceType={}))[P.Texture=0]="Texture",P[P.TileTexture=1]="TileTexture",P[P.BufferObject=2]="BufferObject",P[P.VertexArrayObject=3]="VertexArrayObject",P[P.Shader=4]="Shader",P[P.Program=5]="Program",P[P.FramebufferObject=6]="FramebufferObject",P[P.Renderbuffer=7]="Renderbuffer",P[P.TransformFeedback=8]="TransformFeedback",P[P.Sync=9]="Sync",P[P.UNCOUNTED=10]="UNCOUNTED",P[P.LinesOfCode=10]="LinesOfCode",P[P.Uniform=11]="Uniform",P[P.COUNT=12]="COUNT",e.SpecialDrawBuffers=void 0,(M=e.SpecialDrawBuffers||(e.SpecialDrawBuffers={}))[M.NONE=0]="NONE",M[M.BACK=1029]="BACK",e.CompressedTextureFormat=void 0,(R=e.CompressedTextureFormat||(e.CompressedTextureFormat={}))[R.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",R[R.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",R[R.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",R[R.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",R[R.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",R[R.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",R[R.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",R[R.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",R[R.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",R[R.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",R[R.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",R[R.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",R[R.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",R[R.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e.UniformType=void 0,(E=e.UniformType||(e.UniformType={}))[E.FLOAT=5126]="FLOAT",E[E.FLOAT_VEC2=35664]="FLOAT_VEC2",E[E.FLOAT_VEC3=35665]="FLOAT_VEC3",E[E.FLOAT_VEC4=35666]="FLOAT_VEC4",E[E.INT=5124]="INT",E[E.INT_VEC2=35667]="INT_VEC2",E[E.INT_VEC3=35668]="INT_VEC3",E[E.INT_VEC4=35669]="INT_VEC4",E[E.BOOL=35670]="BOOL",E[E.BOOL_VEC2=35671]="BOOL_VEC2",E[E.BOOL_VEC3=35672]="BOOL_VEC3",E[E.BOOL_VEC4=35673]="BOOL_VEC4",E[E.FLOAT_MAT2=35674]="FLOAT_MAT2",E[E.FLOAT_MAT3=35675]="FLOAT_MAT3",E[E.FLOAT_MAT4=35676]="FLOAT_MAT4",E[E.SAMPLER_2D=35678]="SAMPLER_2D",E[E.SAMPLER_CUBE=35680]="SAMPLER_CUBE",E[E.UNSIGNED_INT=5125]="UNSIGNED_INT",E[E.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",E[E.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",E[E.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",E[E.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",E[E.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",E[E.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",E[E.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",E[E.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",E[E.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",E[E.SAMPLER_3D=35679]="SAMPLER_3D",E[E.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",E[E.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",E[E.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",E[E.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",E[E.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",E[E.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",E[E.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",E[E.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",E[E.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",E[E.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",E[E.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",E[E.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",e.SyncParameter=void 0,(O=e.SyncParameter||(e.SyncParameter={}))[O.OBJECT_TYPE=37138]="OBJECT_TYPE",O[O.SYNC_CONDITION=37139]="SYNC_CONDITION",O[O.SYNC_STATUS=37140]="SYNC_STATUS",O[O.SYNC_FLAGS=37141]="SYNC_FLAGS",e.SyncStatus=void 0,(A=e.SyncStatus||(e.SyncStatus={}))[A.UNSIGNALED=37144]="UNSIGNALED",A[A.SIGNALED=37145]="SIGNALED",e.ClientWaitSyncStatus=void 0,(I=e.ClientWaitSyncStatus||(e.ClientWaitSyncStatus={}))[I.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",I[I.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",I[I.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",I[I.WAIT_FAILED=37149]="WAIT_FAILED",e.SyncCondition=void 0,(D=e.SyncCondition||(e.SyncCondition={}))[D.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",e.SyncFlag=void 0,(F=e.SyncFlag||(e.SyncFlag={}))[F.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",e.ErrorConstant=void 0,(L=e.ErrorConstant||(e.ErrorConstant={}))[L.INVALID_ENUM=1280]="INVALID_ENUM",L[L.INVALID_VALUE=1281]="INVALID_VALUE",L[L.INVALID_OPERATION=1282]="INVALID_OPERATION",L[L.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",L[L.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",L[L.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",e.Extension=void 0,(N=e.Extension||(e.Extension={}))[N.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",e.ColorAttachment0=36064,e.ColorAttachment1=36065,e.ColorAttachment10=36074,e.ColorAttachment11=36075,e.ColorAttachment12=36076,e.ColorAttachment13=36077,e.ColorAttachment14=36078,e.ColorAttachment15=36079,e.ColorAttachment2=36066,e.ColorAttachment3=36067,e.ColorAttachment4=36068,e.ColorAttachment5=36069,e.ColorAttachment6=36070,e.ColorAttachment7=36071,e.ColorAttachment8=36072,e.ColorAttachment9=36073,e.DepthAttachment=36096,e.DepthStencilAttachment=33306,e.StencilAttachment=36128,e.baseTextureUnit=33984,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/renderState":function(){define(["exports","../3d/webgl-engine/lib/basicInterfaces","./enums"],(function(e,t,r){"use strict";function i(e,t,i=r.BlendOperation.ADD,s=[0,0,0,0]){return{srcRgb:e,srcAlpha:e,dstRgb:t,dstAlpha:t,opRgb:i,opAlpha:i,color:{r:s[0],g:s[1],b:s[2],a:s[3]}}}function s(e,t,i,s,n=r.BlendOperation.ADD,o=r.BlendOperation.ADD,a=[0,0,0,0]){return{srcRgb:e,srcAlpha:t,dstRgb:i,dstAlpha:s,opRgb:n,opAlpha:o,color:{r:a[0],g:a[1],b:a[2],a:a[3]}}}const n=i(r.BlendFactor.ZERO,r.BlendFactor.ONE_MINUS_SRC_ALPHA),o=i(r.BlendFactor.ONE,r.BlendFactor.ZERO),a=i(r.BlendFactor.ONE,r.BlendFactor.ONE),l=i(r.BlendFactor.ONE,r.BlendFactor.ONE_MINUS_SRC_ALPHA),c=s(r.BlendFactor.SRC_ALPHA,r.BlendFactor.ONE,r.BlendFactor.ONE_MINUS_SRC_ALPHA,r.BlendFactor.ONE_MINUS_SRC_ALPHA),u={face:r.Face.BACK,mode:r.CullMode.CCW},d={face:r.Face.FRONT,mode:r.CullMode.CCW};function h(e){return x.intern(e)}function p(e){return C.intern(e)}function m(e){return M.intern(e)}function f(e){return E.intern(e)}function g(e){return A.intern(e)}function y(e){return D.intern(e)}function _(e){return L.intern(e)}function b(e){return U.intern(e)}function v(e){return B.intern(e)}class S{constructor(e,t){this._makeKey=e,this._makeRef=t,this._interns=new Map}intern(e){if(!e)return null;const t=this._makeKey(e),r=this._interns;return r.has(t)||r.set(t,this._makeRef(e)),r.get(t)??null}}function w(e){return"["+e.join(",")+"]"}const x=new S(T,(e=>({__tag:"Blending",...e})));function T(e){return e?w([e.srcRgb,e.srcAlpha,e.dstRgb,e.dstAlpha,e.opRgb,e.opAlpha,e.color.r,e.color.g,e.color.b,e.color.a]):null}const C=new S(P,(e=>({__tag:"Culling",...e})));function P(e){return e?w([e.face,e.mode]):null}const M=new S(R,(e=>({__tag:"PolygonOffset",...e})));function R(e){return e?w([e.factor,e.units]):null}const E=new S(O,(e=>({__tag:"DepthTest",...e})));function O(e){return e?w([e.func]):null}const A=new S(I,(e=>({__tag:"StencilTest",...e})));function I(e){return e?w([e.function.func,e.function.ref,e.function.mask,e.operation.fail,e.operation.zFail,e.operation.zPass]):null}const D=new S(F,(e=>({__tag:"DepthWrite",...e})));function F(e){return e?w([e.zNear,e.zFar]):null}const L=new S(N,(e=>({__tag:"ColorWrite",...e})));function N(e){return e?w([e.r,e.g,e.b,e.a]):null}const U=new S(V,(e=>({__tag:"StencilWrite",...e})));function V(e){return e?w([e.mask]):null}const B=new S(G,(e=>({__tag:"DrawBuffers",...e})));function G(e){return e?w(e.buffers):null}const k=new S((function(e){return e?w([T(e.blending),P(e.culling),R(e.polygonOffset),O(e.depthTest),I(e.stencilTest),F(e.depthWrite),N(e.colorWrite),V(e.stencilWrite),G(e.drawBuffers)]):null}),(e=>({blending:h(e.blending),culling:p(e.culling),polygonOffset:m(e.polygonOffset),depthTest:f(e.depthTest),stencilTest:g(e.stencilTest),depthWrite:y(e.depthWrite),colorWrite:_(e.colorWrite),stencilWrite:b(e.stencilWrite),drawBuffers:v(e.drawBuffers)})));e.StateTracker=class{constructor(e){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._drawBuffersInvalid=!0,this._stateSetters=e}setPipeline(e){(this._pipelineInvalid||e!==this._pipeline)&&(this._setBlending(e.blending),this._setCulling(e.culling),this._setPolygonOffset(e.polygonOffset),this._setDepthTest(e.depthTest),this._setStencilTest(e.stencilTest),this._setDepthWrite(e.depthWrite),this._setColorWrite(e.colorWrite),this._setStencilWrite(e.stencilWrite),this._setDrawBuffers(e.drawBuffers),this._pipeline=e),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDrawBuffers(){this._drawBuffersInvalid=!0,this._pipelineInvalid=!0}_setBlending(e){this._blending=this._setSubState(e,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(e){this._culling=this._setSubState(e,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(e){this._polygonOffset=this._setSubState(e,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(e){this._depthTest=this._setSubState(e,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(e){this._stencilTest=this._setSubState(e,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(e){this._depthWrite=this._setSubState(e,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(e){this._colorWrite=this._setSubState(e,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(e){this._stencilWrite=this._setSubState(e,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setDrawBuffers(e){this._drawBuffers=this._setSubState(e,this._drawBuffers,this._drawBuffersInvalid,this._stateSetters.setDrawBuffers),this._drawBuffersInvalid=!1}_setSubState(e,t,r,i){return(r||e!==t)&&(i(e),this._pipelineInvalid=!0),e}},e.add=a,e.backFaceCullingParams=u,e.copySource=o,e.cullingParams=e=>e===t.CullFaceOptions.Back?u:e===t.CullFaceOptions.Front?d:null,e.defaultColorWrite={r:!0,g:!0,b:!0,a:!0},e.defaultDepthWrite={zNear:0,zFar:1},e.destinationTimesOneMinusSourceAlpha=n,e.frontFaceCullingParams=d,e.makeBlending=h,e.makeColorWrite=_,e.makeCulling=p,e.makeDepthTest=f,e.makeDepthWrite=y,e.makeDrawBuffers=v,e.makePipelineState=function(e){return k.intern(e)},e.makePolygonOffset=m,e.makeStencilTest=g,e.makeStencilWrite=b,e.premultipliedAlpha=l,e.separateBlendingParams=s,e.simpleBlendingParams=i,e.unpremultipliedAlphaToPremultipliedAlpha=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/basicInterfaces":function(){define(["exports"],(function(e){"use strict";var t,r,i,s,n,o,a,l;e.CullFaceOptions=void 0,(t=e.CullFaceOptions||(e.CullFaceOptions={}))[t.None=0]="None",t[t.Front=1]="Front",t[t.Back=2]="Back",t[t.COUNT=3]="COUNT",e.DepthTestFunction=void 0,(r=e.DepthTestFunction||(e.DepthTestFunction={}))[r.Less=0]="Less",r[r.Lequal=1]="Lequal",r[r.COUNT=2]="COUNT",e.RenderRequestType=void 0,(i=e.RenderRequestType||(e.RenderRequestType={}))[i.BACKGROUND=0]="BACKGROUND",i[i.UPDATE=1]="UPDATE",e.ResourceState=void 0,(s=e.ResourceState||(e.ResourceState={}))[s.NOT_LOADED=0]="NOT_LOADED",s[s.LOADING=1]="LOADING",s[s.LOADED=2]="LOADED",e.StencilBits=void 0,(n=e.StencilBits||(e.StencilBits={}))[n.IntegratedMeshMaskExcluded=1]="IntegratedMeshMaskExcluded",n[n.OutlineVisualElementMask=2]="OutlineVisualElementMask",e.Object3DState=void 0,(o=e.Object3DState||(e.Object3DState={}))[o.Highlight=0]="Highlight",o[o.MaskOccludee=1]="MaskOccludee",e.AlphaDiscardMode=void 0,(a=e.AlphaDiscardMode||(e.AlphaDiscardMode={}))[a.Blend=0]="Blend",a[a.Opaque=1]="Opaque",a[a.Mask=2]="Mask",a[a.MaskBlend=3]="MaskBlend",a[a.COUNT=4]="COUNT",e.TextureEncodingMimeType=void 0,(l=e.TextureEncodingMimeType||(e.TextureEncodingMimeType={})).DDS_ENCODING="image/vnd-ms.dds",l.KTX2_ENCODING="image/ktx2",l.BASIS_ENCODING="image/x.basis",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/NoiseTextureAtlas":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/NoiseTextureAtlas.glsl","./NoiseTextureAtlasConfiguration","./NoiseTextureAtlasDimensions","./NoiseTextureAtlasTechnique","../../webgl/FramebufferObject","../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";e.NoiseTextureAtlas=class extends r{constructor(e){super(e),this._needsRender=!0,this._passParameters=new u.NoiseTextureAtlasPassParameters,this._configuration=new d.NoiseTextureAtlasTechniqueConfiguration,this._fbo=new m.FramebufferObject(e.context.renderContext.rctx,new f.TextureDescriptor(h.atlasSize)),e.context.techniques.precompile(p.NoiseTextureAtlasTechnique,new d.NoiseTextureAtlasTechniqueConfiguration);const t=new d.NoiseTextureAtlasTechniqueConfiguration;t.mode=d.NoiseTextureRenderMode.WeatherMap,e.context.techniques.precompile(p.NoiseTextureAtlasTechnique,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?d.NoiseTextureRenderMode.WeatherMap:d.NoiseTextureRenderMode.Full;const e=this.context.techniques.get(p.NoiseTextureAtlasTechnique,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){c.equals(this._passParameters.weatherTile,e)||(c.copy(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=i.disposeMaybe(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,r=t.getViewport();return t.setViewport(0,0,h.atlasSize,h.atlasSize),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(r.x,r.y,r.width,r.height),this._needsRender=!1,this._fbo.colorTexture}},t.__decorate([s.property({constructOnly:!0})],e.NoiseTextureAtlas.prototype,"context",void 0),e.NoiseTextureAtlas=t.__decorate([l.subclass("esri.views.3d.environment.NoiseTextureAtlas")],e.NoiseTextureAtlas),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/NoiseTextureAtlas.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec2f64","../views/3d/environment/NoiseTextureAtlasConfiguration","../views/3d/environment/NoiseTextureAtlasDimensions","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends a.NoParameters{constructor(){super(...arguments),this.weatherTile=t.fromValues(0,0)}}function u(e){const t=new l.ShaderBuilder;if(t.include(s.ScreenSpacePass,!1),t.fragment.code.add(o.glsl`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),e.mode===r.NoiseTextureRenderMode.Full){const e=2,r=8;t.fragment.code.add(o.glsl`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),t.fragment.code.add(o.glsl`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),t.fragment.code.add(o.glsl`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),t.fragment.code.add(o.glsl`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${o.glsl.float(i.tileRows)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${o.glsl.float(r)});

      float worley0 = worley(p, ${o.glsl.float(e)} * 2.0);
      float worley1 = worley(p, ${o.glsl.float(e)} * 8.0);
      float worley2 = worley(p, ${o.glsl.float(e)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${o.glsl.float(e)});
      float worley1 = worley(p, ${o.glsl.float(e)} * 2.0);
      float worley2 = worley(p, ${o.glsl.float(e)} * 4.0);
      float worley3 = worley(p, ${o.glsl.float(e)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)}return t.fragment.uniforms.add(new n.Float2PassUniform("weatherTile",(e=>e.weatherTile))).code.add(o.glsl`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${o.glsl.float(i.weatherTileSize)});

      // Get global coordinates of p
      p += weatherTile * ${o.glsl.float(i.weatherTileSize)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${o.glsl.float(i.weatherMapSize)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.mode===r.NoiseTextureRenderMode.Full?t.fragment.main.add(o.glsl`
      float padWidth = 1.0;
      float paddedSize = ${o.glsl.float(i.tileSize)} + 2.0 * padWidth;
      float tileCount = ${o.glsl.float(i.tileRows)} * ${o.glsl.float(i.tileRows)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${o.glsl.float(i.tileSize)};
        }

        if (startPadY) {
          pixel.y += ${o.glsl.float(i.tileSize)};
        }

        if (endPadX) {
          pixel.x -= ${o.glsl.float(i.tileSize)};
        }

        if (endPadY) {
          pixel.y -= ${o.glsl.float(i.tileSize)};
        }

        uv = vec2(pixel.xy / ${o.glsl.float(i.tileSize)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${o.glsl.float(i.tileSize)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${o.glsl.float(i.tileRows)} * ${o.glsl.float(i.tileRows)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${o.glsl.float(i.tileRows)} * ${o.glsl.float(i.tileRows)});
      p = p_;
      p.z /= (${o.glsl.float(i.tileRows)} * ${o.glsl.float(i.tileRows)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${o.glsl.float(i.weatherTileSize)} * (gl_FragCoord.xy / ${o.glsl.float(i.atlasSize)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):t.fragment.main.add(o.glsl`
      vec2 mapUV = ${o.glsl.float(i.weatherTileSize)} * (gl_FragCoord.xy / ${o.glsl.float(i.atlasSize)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),t}const d=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:c,build:u},Symbol.toStringTag,{value:"Module"}));e.NoiseTextureAtlas=d,e.NoiseTextureAtlasPassParameters=c,e.build=u}))},"esri/views/3d/environment/NoiseTextureAtlasConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";var i;e.NoiseTextureRenderMode=void 0,(i=e.NoiseTextureRenderMode||(e.NoiseTextureRenderMode={}))[i.Full=0]="Full",i[i.WeatherMap=1]="WeatherMap",i[i.COUNT=2]="COUNT";class s extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.mode=e.NoiseTextureRenderMode.Full}}t.__decorate([r.parameter({count:e.NoiseTextureRenderMode.COUNT})],s.prototype,"mode",void 0),e.NoiseTextureAtlasTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/NoiseTextureAtlasTechnique":function(){define(["require","exports","../../../chunks/NoiseTextureAtlas.glsl","./NoiseTextureAtlasConfiguration","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../../webgl/enums","../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends n.ShaderTechnique{constructor(t,i){super(t,i,new s.ReloadableShaderModule(r.NoiseTextureAtlas,(()=>new Promise(((t,r)=>e(["./NoiseTextureAtlas.glsl"],t,r))))))}initializePipeline(e){return a.makePipelineState({blending:e.mode===i.NoiseTextureRenderMode.Full?a.copySource:a.separateBlendingParams(o.BlendFactor.ZERO,o.BlendFactor.ONE,o.BlendFactor.ONE,o.BlendFactor.ZERO),depthTest:{func:o.CompareFunction.ALWAYS},colorWrite:a.defaultColorWrite})}}t.NoiseTextureAtlasTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/FramebufferObject":function(){define(["exports","../../core/has","../../core/Logger","../../core/maybe","./BufferObject","./checkWebGLError","./enums","./FBOAttachmentType","./Renderbuffer","./Texture"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";class u{constructor(e,t,r){if(this._context=e,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,e.instanceCounter.increment(o.ResourceType.FramebufferObject,this),null!=t){const r=d(t)?t:new c.Texture(e,t);this._colorAttachments.set(o.ColorAttachment0,r),this._validateTextureDescriptor(r.descriptor),this._validateColorAttachmentPoint(o.ColorAttachment0)}var i;if(null!=r)if(d(i=r)||function(e){return h(e)===a.FBOAttachmentType.TextureDescriptor}(i))this._depthStencilTexture=d(r)?r:new c.Texture(e,r),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const t=function(e){return h(e)===a.FBOAttachmentType.Renderbuffer}(r)?r:new l.Renderbuffer(e,r);this._depthStencilBuffer=t,this._validateRenderbufferDescriptor(t.descriptor)}}dispose(){const{_colorAttachments:e,_glName:t}=this;if(0===e.size&&!this._depthStencilBuffer&&!this._depthStencilTexture&&!t)return;const{_context:r}=this,i=r.getBoundFramebufferObject();e.forEach(((e,t)=>this.detachColorTexture(t)?.dispose())),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),r.gl.deleteFramebuffer(t),this._glName=null,r.bindFramebuffer(i===this?null:i),r.instanceCounter.decrement(o.ResourceType.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){return this._colorAttachments.get(o.ColorAttachment0)}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){const e=this._colorAttachments.get(o.ColorAttachment0)??this._depthStencilTexture??this._depthStencilBuffer;return e?.descriptor?.width??0}get height(){const e=this._colorAttachments.get(o.ColorAttachment0)??this._depthStencilTexture??this._depthStencilBuffer;return e?.descriptor?.height??0}get usedMemory(){return[...this._colorAttachments].reduce(((e,[t,r])=>e+r.usedMemory),this.depthStencil?.usedMemory??0)}static{this._MAX_COLOR_ATTACHMENTS=-1}getColorTexture(e){const t=this._colorAttachments.get(e);return t&&d(t)?t:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(e,t=o.ColorAttachment0){if(!e)return;this._validateColorAttachmentPoint(t);const{descriptor:r}=e;this._validateTextureDescriptor(r),this.detachColorTexture(t)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,t)),this._colorAttachments.set(t,e)}detachColorTexture(e=o.ColorAttachment0){const t=this._colorAttachments.get(e);if(t)return this._initialized&&this._context.temporaryBindFramebufferObject(this,(()=>{this._framebufferTexture2D(null,e)})),this._colorAttachments.delete(e),t}setColorTextureTarget(e,t=o.ColorAttachment0,r=0){const i=this._colorAttachments.get(t);i&&(e===o.TextureType.TEXTURE_2D_ARRAY?this._framebufferTextureLayer(i.glName,t,o.FramebufferTarget.FRAMEBUFFER,0,r):this._framebufferTexture2D(i.glName,t,e,o.FramebufferTarget.FRAMEBUFFER,0))}attachDepthStencil(e){if(e)switch(e.type){case a.FBOAttachmentType.Texture:return this._attachDepthStencilTexture(e);case a.FBOAttachmentType.Renderbuffer:return this._attachDepthStencilBuffer(e)}}_attachDepthStencilTexture(e){if(null==e)return;const{descriptor:t}=e,{pixelFormat:r,dataType:i}=t;r===o.UnsizedDepthFormat.DEPTH_STENCIL||r===o.UnsizedDepthFormat.DEPTH_COMPONENT?r!==o.UnsizedDepthFormat.DEPTH_STENCIL||i===o.PixelType.UNSIGNED_INT_24_8?r!==o.UnsizedDepthFormat.DEPTH_COMPONENT||i===o.PixelType.UNSIGNED_INT||i===o.PixelType.UNSIGNED_SHORT?(this._validateTextureDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,f(r))),this._depthStencilTexture?.dispose(),this._depthStencilTexture=e):console.error("Depth texture must have data type of UNSIGNED_INT or UNSIGNED_SHORT!"):console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"):console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!")}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&this._context.temporaryBindFramebufferObject(this,(()=>{this._framebufferTexture2D(null,f(e.descriptor.pixelFormat))})),this._depthStencilTexture=null,e}_attachDepthStencilBuffer(e){if(null==e)return;const t=e.descriptor;if(this._validateRenderbufferDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const{gl:r}=this._context,i=this._getGLAttachmentPoint(t);r.framebufferRenderbuffer(o.FramebufferTarget.FRAMEBUFFER,i,r.RENDERBUFFER,e.glName)}this._depthStencilBuffer=e}detachDepthStencilBuffer(){const e=this._depthStencilBuffer;if(e&&this._initialized){const{_context:t}=this,r=t.getBoundFramebufferObject();t.bindFramebuffer(this);const{gl:i}=t,s=this._getGLAttachmentPoint(e.descriptor);i.framebufferRenderbuffer(o.FramebufferTarget.FRAMEBUFFER,s,i.RENDERBUFFER,null),t.bindFramebuffer(r)}return this._depthStencilBuffer=null,e}invalidateAttachments(e){const{_context:t}=this;t.temporaryBindFramebufferObject(this,(()=>t.gl.invalidateFramebuffer(o.FramebufferTarget.FRAMEBUFFER,e)),!0)}copyToTexture(e,t,r,i,s,n,a){(e<0||t<0||s<0||n<0)&&console.error("Offsets cannot be negative!"),(r<=0||i<=0)&&console.error("Copy width and height must be greater than zero!");const l=a.descriptor;a.descriptor.target!==o.TextureType.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),(null==l?.width||null==l?.height||e+r>this.width||t+i>this.height||s+r>l.width||n+i>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const u=this._context,d=u.bindTexture(a,c.Texture.TEXTURE_UNIT_FOR_UPDATES);u.setActiveTexture(c.Texture.TEXTURE_UNIT_FOR_UPDATES),u.bindFramebuffer(this),u.gl.copyTexSubImage2D(o.TextureType.TEXTURE_2D,0,s,n,e,t,r,i),u.bindTexture(d,c.Texture.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,t,r,i,s,n,o){(r<=0||i<=0)&&console.error("Copy width and height must be greater than zero!"),o||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,t,r,i,s,n,o)}async readPixelsAsync(e,t,r,i,n,a,l){const{gl:c}=this._context,u=s.BufferObject.createPixelPack(this._context,o.Usage.STREAM_READ,l.byteLength);this._context.bindBuffer(u);const d=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),c.readPixels(e,t,r,i,n,a,0),this._context.unbindBuffer(o.BufferType.PIXEL_PACK_BUFFER),this._context.bindFramebuffer(d),await u.getSubDataAsync(l),u.dispose()}resize(e,t){if(this.width===e&&this.height===t)return;const r={width:e,height:t};p(r,this._context.parameters.maxTextureSize),this._colorAttachments.forEach((e=>e.resize(r.width,r.height))),this._depthStencilTexture?.resize(r.width,r.height),this._initialized&&(p(r,this._context.parameters.maxRenderbufferSize),this._depthStencilBuffer?.resize(r.width,r.height),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1)}initializeAndBind(e=o.FramebufferTarget.FRAMEBUFFER){const{gl:t}=this._context;if(this._initialized)return void t.bindFramebuffer(e,this.glName);this._glName&&t.deleteFramebuffer(this._glName);const r=t.createFramebuffer();if(t.bindFramebuffer(e,r),this._colorAttachments.forEach(((t,r)=>{const i=m(t);i===o.TextureType.TEXTURE_2D_ARRAY?this._framebufferTextureLayer(t.glName,r,e,0,0):this._framebufferTexture2D(t.glName,r,i,e)})),this._depthStencilBuffer){const r=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);t.framebufferRenderbuffer(e,r,t.RENDERBUFFER,this._depthStencilBuffer.glName)}else if(this._depthStencilTexture){const t=f(this._depthStencilTexture.descriptor.pixelFormat);this._framebufferTexture2D(this._depthStencilTexture.glName,t,m(this._depthStencilTexture),e)}n.webglDebugEnabled()&&t.checkFramebufferStatus(e)!==t.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=r,this._initialized=!0}_framebufferTexture2D(e,t=o.ColorAttachment0,r=o.TextureType.TEXTURE_2D,i=o.FramebufferTarget.FRAMEBUFFER,s=0){this._context.gl.framebufferTexture2D(i,t,r,e,s)}_framebufferTextureLayer(e,t=o.ColorAttachment0,r=o.FramebufferTarget.FRAMEBUFFER,i=0,s=0){this._context.gl.framebufferTextureLayer(r,t,e,i,s)}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const t=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);e.framebufferRenderbuffer(o.FramebufferTarget.FRAMEBUFFER,t,e.RENDERBUFFER,null)}this._depthStencilBuffer=i.disposeMaybe(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,f(this._depthStencilTexture.descriptor.pixelFormat))),this._depthStencilTexture=i.disposeMaybe(this._depthStencilTexture))}_validateTextureDescriptor(e){e.target!==o.TextureType.TEXTURE_2D&&e.target!==o.TextureType.TEXTURE_CUBE_MAP&&e.target!==o.TextureType.TEXTURE_2D_ARRAY&&console.error("Texture type must be TEXTURE_2D, TEXTURE_2D_ARRAY or TEXTURE_CUBE_MAP!"),p(e,this._context.parameters.maxTextureSize),this._validateBufferDimensions(e)}_validateRenderbufferDescriptor(e){p(e,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(e)}_validateBufferDimensions(e){e.width<=0&&(e.width=this.width),e.height<=0&&(e.height=this.height),this.width>0&&this.height>0&&(this.width===e.width&&this.height===e.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(e){switch(e.internalFormat){case o.SizedDepthFormat.DEPTH_COMPONENT16:case o.SizedDepthFormat.DEPTH_COMPONENT24:case o.SizedDepthFormat.DEPTH_COMPONENT32F:return o.DepthAttachment;case o.SizedDepthStencilFormat.DEPTH24_STENCIL8:case o.SizedDepthStencilFormat.DEPTH32F_STENCIL8:return o.DepthStencilAttachment;case o.SizedStencilFormat.STENCIL_INDEX8:return o.StencilAttachment}}_validateColorAttachmentPoint(e){if(-1===u._MAX_COLOR_ATTACHMENTS){const{gl:e}=this._context;u._MAX_COLOR_ATTACHMENTS=e.getParameter(e.MAX_COLOR_ATTACHMENTS)}const t=e-o.ColorAttachment0;t+1>u._MAX_COLOR_ATTACHMENTS&&r.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${t+1}. Implementation supports up to ${u._MAX_COLOR_ATTACHMENTS} color attachments`)}}function d(e){return h(e)===a.FBOAttachmentType.Texture}function h(e){return null!=e&&"type"in e?e.type:null}function p(e,t){const i=Math.max(e.width,e.height);if(i>t){r.getLogger("esri.views.webgl.FramebufferObject").warnOnce(`Resizing FBO attachment size ${e.width}x${e.height} to device limit ${t}`);const s=t/i;return e.width=Math.round(e.width*s),e.height=Math.round(e.height*s),!1}return!0}function m(e){return e.descriptor.target===o.TextureType.TEXTURE_CUBE_MAP?o.TextureType.TEXTURE_CUBE_MAP_POSITIVE_X:e.descriptor.target===o.TextureType.TEXTURE_2D_ARRAY?o.TextureType.TEXTURE_2D_ARRAY:o.TextureType.TEXTURE_2D}function f(e){return e===o.UnsizedDepthFormat.DEPTH_COMPONENT?o.DepthAttachment:o.DepthStencilAttachment}e.FramebufferObject=u,e.ensureAttachmentMaxSize=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/BufferObject":function(){define(["exports","../../core/arrayUtils","../../core/has","../../core/Logger","../../core/typedArrayUtil","./checkWebGLError","./enums"],(function(e,t,r,i,s,n,o){"use strict";const a=()=>i.getLogger("esri.views.webgl.BufferObject");class l{static createIndex(e,t,r){return new l(e,o.BufferType.ELEMENT_ARRAY_BUFFER,t,r)}static createVertex(e,t,r){return new l(e,o.BufferType.ARRAY_BUFFER,t,r)}static createUniform(e,t,r){return new l(e,o.BufferType.UNIFORM_BUFFER,t,r)}static createPixelPack(e,t=o.Usage.STREAM_READ,r){const i=new l(e,o.BufferType.PIXEL_PACK_BUFFER,t);return r&&i.setSize(r),i}static createPixelUnpack(e,t=o.Usage.STREAM_DRAW,r){return new l(e,o.BufferType.PIXEL_UNPACK_BUFFER,t,r)}static createTransformFeedback(e,t=o.Usage.STATIC_DRAW,r){const i=new l(e,o.BufferType.TRANSFORM_FEEDBACK_BUFFER,t);return i.setSize(r),i}constructor(e,t,r,i){this._context=e,this.bufferType=t,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(o.ResourceType.BufferObject,this),this._glName=this._context.gl.createBuffer(),n.checkWebGLError(this._context.gl),i&&this.setData(i)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get usedMemory(){if(this.bufferType===o.BufferType.ELEMENT_ARRAY_BUFFER){if(this._indexType===o.DataType.UNSIGNED_INT)return 4*this._size;if(this._indexType===o.DataType.UNSIGNED_SHORT)return 2*this._size}return this._size}get _isVAOAware(){return this.bufferType===o.BufferType.ELEMENT_ARRAY_BUFFER||this.bufferType===o.BufferType.ARRAY_BUFFER}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(o.ResourceType.BufferObject,this),this._context=null):this._glName&&a().warn("Leaked WebGL buffer object")}setSize(e,t=null){if(this.bufferType===o.BufferType.ELEMENT_ARRAY_BUFFER&&null!=t)switch(this._indexType=t,t){case o.DataType.UNSIGNED_SHORT:e*=2;break;case o.DataType.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let t=e.byteLength;this.bufferType===o.BufferType.ELEMENT_ARRAY_BUFFER&&(s.isUint8Array(e)?this._indexType=o.DataType.UNSIGNED_BYTE:s.isUint16Array(e)?(t/=2,this._indexType=o.DataType.UNSIGNED_SHORT):s.isUint32Array(e)&&(t/=4,this._indexType=o.DataType.UNSIGNED_INT)),this._setBufferData(t,e)}_setBufferData(e,t=null){this._size=e;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const i=this._context.gl;null!=t?i.bufferData(this.bufferType,t,this.usage):i.bufferData(this.bufferType,e,this.usage),n.checkWebGLError(i),this._isVAOAware&&this._context.bindVAO(r)}setSubData(e,t,r,i){if(!e)return;const s=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:o}=this._context;o.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,e,r,i-r),n.checkWebGLError(o),this._isVAOAware&&this._context.bindVAO(s)}getSubData(e,r=0,i,s){if(i<0||s<0)return;const n=(l=e,t.isArrayLike(l)?e.BYTES_PER_ELEMENT:1);var l;if(n*((i??0)+(s??0))>e.byteLength)return;r+n*(s??0)>this.usedMemory&&a().warn("Potential problem getting subdata: requested data exceeds buffer size!");const c=this._context.gl;this.bufferType===o.BufferType.TRANSFORM_FEEDBACK_BUFFER?(this._context.bindBuffer(this,o.BufferType.TRANSFORM_FEEDBACK_BUFFER),c.getBufferSubData(o.BufferType.TRANSFORM_FEEDBACK_BUFFER,r,e,i,s),this._context.unbindBuffer(o.BufferType.TRANSFORM_FEEDBACK_BUFFER)):(this._context.bindBuffer(this,o.BufferType.COPY_READ_BUFFER),c.getBufferSubData(o.BufferType.COPY_READ_BUFFER,r,e,i,s),this._context.unbindBuffer(o.BufferType.COPY_READ_BUFFER))}async getSubDataAsync(e,t=0,r,i){await this._context.clientWaitAsync(),this.getSubData(e,t,r,i)}}e.BufferObject=l,e.tracer=null,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/FBOAttachmentType":function(){define(["exports"],(function(e){"use strict";var t;e.FBOAttachmentType=void 0,(t=e.FBOAttachmentType||(e.FBOAttachmentType={}))[t.TextureDescriptor=0]="TextureDescriptor",t[t.Texture=1]="Texture",t[t.Renderbuffer=2]="Renderbuffer",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/Renderbuffer":function(){define(["exports","./enums","./FBOAttachmentType","./RenderbufferDescriptor"],(function(e,t,r,i){"use strict";e.Renderbuffer=class{constructor(e,i){this._context=e,this._descriptor=i,this.type=r.FBOAttachmentType.Renderbuffer,this._context.instanceCounter.increment(t.ResourceType.Renderbuffer,this);const s=this._context.gl;this.glName=s.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:n,height:o,internalFormat:a,multisampled:l}=i;l?s.renderbufferStorageMultisample(s.RENDERBUFFER,this.samples,a,n,o):s.renderbufferStorage(s.RENDERBUFFER,a,n,o),this._context.bindRenderbuffer(null)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,t=this._context.parameters.maxSamples;return e?Math.min(e,t):t}get usedMemory(){return i.estimateMemory(this._descriptor)}resize(e,t){const r=this._descriptor;if(r.width===e&&r.height===t)return;r.width=e,r.height=t;const i=this._context.gl;this._context.bindRenderbuffer(this),r.multisampled?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,r.internalFormat,r.width,r.height):i.renderbufferStorage(i.RENDERBUFFER,r.internalFormat,r.width,r.height),this._context.bindRenderbuffer(null)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(t.ResourceType.Renderbuffer,this),this._context=null)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/RenderbufferDescriptor":function(){define(["exports","./Util"],(function(e,t){"use strict";e.RenderbufferDescriptor=class{constructor(e,t=0,r=t){this.internalFormat=e,this.width=t,this.height=r,this.multisampled=!1,this.samples=1}},e.estimateMemory=function(e){return e.width<=0||e.height<=0||null==e.internalFormat?0:e.width*e.height*t.getBytesPerElementFormat(e.internalFormat)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/Util":function(){define(["exports","../../core/has","./checkWebGLError","./enums","./getDataTypeBytes"],(function(e,t,r,i,s){"use strict";function n(e){const t=e.gl;switch(t.getError()){case t.NO_ERROR:return null;case t.INVALID_ENUM:return"An unacceptable value has been specified for an enumerated argument";case t.INVALID_VALUE:return"An unacceptable value has been specified for an argument";case t.INVALID_OPERATION:return"The specified command is not allowed for the current state";case t.INVALID_FRAMEBUFFER_OPERATION:return"The currently bound framebuffer is not framebuffer complete";case t.OUT_OF_MEMORY:return"Not enough memory is left to execute the command";case t.CONTEXT_LOST_WEBGL:return"WebGL context is lost"}return"Unknown error"}function o(e){return e[0].stride}e.bindVertexBufferLayout=function(e,t,i,o,a=0){const l=e.gl;e.bindBuffer(i);for(const i of o){const o=t.get(i.name);if(null==o){console.warn(`There is no location for vertex attribute '${i.name}' defined.`);continue}const c=a*i.stride;if(i.count<=4)l.vertexAttribPointer(o,i.count,i.type,i.normalized,i.stride,i.offset+c),l.enableVertexAttribArray(o),i.divisor>0&&e.gl.vertexAttribDivisor(o,i.divisor);else if(9===i.count)for(let t=0;t<3;t++)l.vertexAttribPointer(o+t,3,i.type,i.normalized,i.stride,i.offset+12*t+c),l.enableVertexAttribArray(o+t),i.divisor>0&&e.gl.vertexAttribDivisor(o+t,i.divisor);else if(16===i.count)for(let t=0;t<4;t++)l.vertexAttribPointer(o+t,4,i.type,i.normalized,i.stride,i.offset+16*t+c),l.enableVertexAttribArray(o+t),i.divisor>0&&e.gl?.vertexAttribDivisor(o+t,i.divisor);else console.error("Unsupported vertex attribute element count: "+i.count);if(r.webglDebugEnabled()){const t=n(e),r=s.getDataTypeBytes(i.type),o=i.offset,a=Math.round(r/o)!==r/o?`. Offset not a multiple of stride. DataType requires ${r} bytes, but descriptor has an offset of ${o}`:"";t&&console.error(`Unable to bind vertex attribute "${i.name}" with baseInstanceOffset ${c}${a}:`,t,i)}}},e.getBytesPerElementFormat=function(e){switch(e){case i.PixelFormat.ALPHA:case i.PixelFormat.LUMINANCE:case i.PixelFormat.RED:case i.PixelFormat.RED_INTEGER:case i.SizedPixelFormat.R8:case i.SizedPixelFormat.R8I:case i.SizedPixelFormat.R8UI:case i.SizedPixelFormat.R8_SNORM:case i.SizedStencilFormat.STENCIL_INDEX8:return 1;case i.PixelFormat.LUMINANCE_ALPHA:case i.PixelFormat.RG:case i.PixelFormat.RG_INTEGER:case i.SizedPixelFormat.RGBA4:case i.SizedPixelFormat.R16F:case i.SizedPixelFormat.R16I:case i.SizedPixelFormat.R16UI:case i.SizedPixelFormat.RG8:case i.SizedPixelFormat.RG8I:case i.SizedPixelFormat.RG8UI:case i.SizedPixelFormat.RG8_SNORM:case i.SizedPixelFormat.RGB565:case i.SizedPixelFormat.RGB5_A1:case i.SizedDepthFormat.DEPTH_COMPONENT16:return 2;case i.PixelFormat.RGB:case i.PixelFormat.RGB_INTEGER:case i.SizedPixelFormat.RGB8:case i.SizedPixelFormat.RGB8I:case i.SizedPixelFormat.RGB8UI:case i.SizedPixelFormat.RGB8_SNORM:case i.SizedPixelFormat.SRGB8:case i.SizedDepthFormat.DEPTH_COMPONENT24:return 3;case i.PixelFormat.RGBA:case i.PixelFormat.RGBA_INTEGER:case i.SizedPixelFormat.RGBA8:case i.SizedPixelFormat.R32F:case i.SizedPixelFormat.R11F_G11F_B10F:case i.SizedPixelFormat.RG16F:case i.SizedPixelFormat.R32I:case i.SizedPixelFormat.R32UI:case i.SizedPixelFormat.RG16I:case i.SizedPixelFormat.RG16UI:case i.SizedPixelFormat.RGBA8I:case i.SizedPixelFormat.RGBA8UI:case i.SizedPixelFormat.RGBA8_SNORM:case i.SizedPixelFormat.SRGB8_ALPHA8:case i.SizedPixelFormat.RGB9_E5:case i.SizedPixelFormat.RGB10_A2UI:case i.SizedPixelFormat.RGB10_A2:case i.SizedDepthFormat.DEPTH_COMPONENT32F:case i.SizedDepthStencilFormat.DEPTH24_STENCIL8:return 4;case i.SizedDepthStencilFormat.DEPTH32F_STENCIL8:return 5;case i.SizedPixelFormat.RGB16F:case i.SizedPixelFormat.RGB16I:case i.SizedPixelFormat.RGB16UI:return 6;case i.SizedPixelFormat.RG32F:case i.SizedPixelFormat.RG32I:case i.SizedPixelFormat.RG32UI:case i.SizedPixelFormat.RGBA16F:case i.SizedPixelFormat.RGBA16I:case i.SizedPixelFormat.RGBA16UI:return 8;case i.SizedPixelFormat.RGB32F:case i.SizedPixelFormat.RGB32I:case i.SizedPixelFormat.RGB32UI:return 12;case i.SizedPixelFormat.RGBA32F:case i.SizedPixelFormat.RGBA32I:case i.SizedPixelFormat.RGBA32UI:return 16;case i.CompressedTextureFormat.COMPRESSED_RGB_S3TC_DXT1_EXT:case i.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT1_EXT:return.5;case i.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT3_EXT:case i.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case i.CompressedTextureFormat.COMPRESSED_R11_EAC:case i.CompressedTextureFormat.COMPRESSED_SIGNED_R11_EAC:case i.CompressedTextureFormat.COMPRESSED_RGB8_ETC2:case i.CompressedTextureFormat.COMPRESSED_SRGB8_ETC2:case i.CompressedTextureFormat.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case i.CompressedTextureFormat.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return.5;case i.CompressedTextureFormat.COMPRESSED_RG11_EAC:case i.CompressedTextureFormat.COMPRESSED_SIGNED_RG11_EAC:case i.CompressedTextureFormat.COMPRESSED_RGBA8_ETC2_EAC:case i.CompressedTextureFormat.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0},e.getErrorString=n,e.getStride=o,e.unbindVertexBufferLayout=function(e,t,r,s){const n=e.gl;e.bindBuffer(r);for(const r of s){const i=t.get(r.name);if(r.count<=4)n.disableVertexAttribArray(i),r.divisor&&r.divisor>0&&e.gl?.vertexAttribDivisor(i,0);else if(9===r.count)for(let t=0;t<3;t++)n.disableVertexAttribArray(i+t),r.divisor&&r.divisor>0&&e.gl?.vertexAttribDivisor(i+t,0);else if(16===r.count)for(let t=0;t<4;t++)n.disableVertexAttribArray(i+t),r.divisor&&r.divisor>0&&e.gl?.vertexAttribDivisor(i+t,0);else console.error("Unsupported vertex attribute element count: "+r.count)}e.unbindBuffer(i.BufferType.ARRAY_BUFFER)},e.vertexCount=function(e,t){return(e.vertexBuffers.get(t)?.usedMemory??0)/o(e.layout.get(t))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/getDataTypeBytes":function(){define(["exports","./enums"],(function(e,t){"use strict";e.getDataTypeBytes=function(e){switch(e){case t.DataType.BYTE:case t.DataType.UNSIGNED_BYTE:return 1;case t.DataType.SHORT:case t.DataType.UNSIGNED_SHORT:case t.DataType.HALF_FLOAT:return 2;case t.DataType.FLOAT:case t.DataType.INT:case t.DataType.UNSIGNED_INT:return 4}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/Texture":function(){define(["exports","../../core/Error","../../core/has","../../core/Logger","../../core/maybe","../../core/promiseUtils","./checkWebGLError","./enums","./FBOAttachmentType","./TextureDescriptor","./textureUtils","./ValidatedTextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=()=>i.getLogger("esri/views/webgl/Texture");let p=class e{static{this.TEXTURE_UNIT_FOR_UPDATES=0}static{this.compressionWorkerHandle=null}constructor(e,r=null,i=null){if(this.type=l.FBOAttachmentType.Texture,this._glName=null,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._shadowFilterDirty=!1,this._wasImmutablyAllocated=!1,"context"in e)this._descriptor=e,i=r;else{const i=d.ValidatedTextureDescriptor.validate(e,r);if(!i)throw new t("texture:invalid-descriptor","Texture descriptor invalid");this._descriptor=i}this._descriptor.target===a.TextureType.TEXTURE_CUBE_MAP?this._setDataCubeMap(i):this.setData(i)}get glName(){return this._glName}get descriptor(){return this._descriptor}get usedMemory(){return c.estimateMemory(this._descriptor)}get cachedMemory(){return this.usedMemory}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty||this._shadowFilterDirty}get hasWebGLTextureObject(){return!!this._glName}dispose(){this.abortCompression(),this._descriptor.context.gl&&this.hasWebGLTextureObject&&(this._descriptor.context.instanceCounter.decrement(a.ResourceType.Texture,this),this._descriptor.context.unbindTexture(this),this._descriptor.context.gl.deleteTexture(this._glName),this._glName=null)}release(){this.dispose()}resize(e,r){const i=this._descriptor;if(i.width!==e||i.height!==r){if(this._wasImmutablyAllocated)throw new t("texture:immutable-resize","Immutable textures can't be resized!");i.width=e,i.height=r,this._descriptor.target===a.TextureType.TEXTURE_CUBE_MAP?this._setDataCubeMap(null):this.setData(null)}}enableCompression(e){this._descriptor.compress=e}disableCompression(){this._descriptor.compress=void 0}setData(e){this.abortCompression(),!u.isCompressedData(e)&&this._descriptor.internalFormat&&this._descriptor.internalFormat in a.CompressedTextureFormat&&(this._descriptor.internalFormat=void 0),this._setData(e),!u.isCompressedData(e)&&this._descriptor.compress&&this._compressOnWorker(e)}updateData(r,i,s,n,o,a,l=0){a||h().error("An attempt to use uninitialized data!"),this.hasWebGLTextureObject||h().error("An attempt to update uninitialized texture!");const c=this._descriptor;c.internalFormat=u.deriveInternalFormat(c);const{context:d,pixelFormat:p,dataType:m,target:f,isImmutable:g}=c;if(g&&!this._wasImmutablyAllocated)throw new t("texture:uninitialized","Cannot update immutable texture before allocation!");const y=d.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES,!0);(i<0||s<0||i+n>c.width||s+o>c.height)&&h().error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage();const{gl:_}=d;l&&(n&&o||h().warn("Must pass width and height if `UNPACK_SKIP_ROWS` is used"),_.pixelStorei(_.UNPACK_SKIP_ROWS,l)),u.isTexImageSource(a)?_.texSubImage2D(f,r,i,s,n,o,p,m,a):u.isCompressedData(a)?_.compressedTexSubImage2D(f,r,i,s,n,o,c.internalFormat,a.levels[r]):_.texSubImage2D(f,r,i,s,n,o,p,m,a),l&&_.pixelStorei(_.UNPACK_SKIP_ROWS,0),d.bindTexture(y,e.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(r,i,s,n,o,a,l,c){c||h().error("An attempt to use uninitialized data!"),this.hasWebGLTextureObject||h().error("An attempt to update an uninitialized texture!");const d=this._descriptor;d.internalFormat=u.deriveInternalFormat(d);const{context:p,pixelFormat:m,dataType:f,isImmutable:g,target:y}=d;if(g&&!this._wasImmutablyAllocated)throw new t("texture:uninitialized","Cannot update immutable texture before allocation!");u.is3DTarget(y)||h().warn("Attempting to set 3D texture data on a non-3D texture");const _=p.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES);p.setActiveTexture(e.TEXTURE_UNIT_FOR_UPDATES),(i<0||s<0||n<0||i+o>d.width||s+a>d.height||n+l>d.depth)&&h().error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage();const{gl:b}=p;if(u.isCompressedData(c))c=c.levels[r],b.compressedTexSubImage3D(y,r,i,s,n,o,a,l,d.internalFormat,c);else{const e=c;b.texSubImage3D(y,r,i,s,n,o,a,l,m,f,e)}p.bindTexture(_,e.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const r=this._descriptor;if(0===r.width||0===r.height)return;if(!r.hasMipmap){if(this._wasImmutablyAllocated)throw new t("texture:immutable-change","Cannot add mipmaps to immutable texture after allocation");r.hasMipmap=!0,this._samplingModeDirty=!0,u.validateTexture(r)}r.samplingMode===a.TextureSamplingMode.LINEAR?(this._samplingModeDirty=!0,r.samplingMode=a.TextureSamplingMode.LINEAR_MIPMAP_NEAREST):r.samplingMode===a.TextureSamplingMode.NEAREST&&(this._samplingModeDirty=!0,r.samplingMode=a.TextureSamplingMode.NEAREST_MIPMAP_NEAREST);const i=this._descriptor.context.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES);this._descriptor.context.setActiveTexture(e.TEXTURE_UNIT_FOR_UPDATES),this._descriptor.context.gl.generateMipmap(r.target),this._descriptor.context.bindTexture(i,e.TEXTURE_UNIT_FOR_UPDATES)}clearMipmap(){const e=this._descriptor;if(e.hasMipmap){if(this._wasImmutablyAllocated)throw new t("texture:immutable-change","Cannot delete mipmaps to immutable texture after allocation");e.hasMipmap=!1,this._samplingModeDirty=!0,u.validateTexture(e)}e.samplingMode===a.TextureSamplingMode.LINEAR_MIPMAP_NEAREST?(this._samplingModeDirty=!0,e.samplingMode=a.TextureSamplingMode.LINEAR):e.samplingMode===a.TextureSamplingMode.NEAREST_MIPMAP_NEAREST&&(this._samplingModeDirty=!0,e.samplingMode=a.TextureSamplingMode.NEAREST)}setSamplingMode(e){e!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=e,this._samplingModeDirty=!0)}setWrapMode(e){e!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=e,u.validateTexture(this._descriptor),this._wrapModeDirty=!0)}setShadowFiltering(e){e!==this._descriptor.linearFilterDepth&&(this._descriptor.linearFilterDepth=this._descriptor.compareEnabled=e,this.setSamplingMode(e?a.TextureSamplingMode.LINEAR:a.TextureSamplingMode.NEAREST),u.validateTexture(this._descriptor),this._shadowFilterDirty=!0)}applyChanges(){this._samplingModeDirty&&(this._applySamplingMode(),this._samplingModeDirty=!1),this._wrapModeDirty&&(this._applyWrapMode(),this._wrapModeDirty=!1),this._shadowFilterDirty&&(this._applyShadowMode(),this._shadowFilterDirty=!1)}abortCompression(){this._compressionAbortController=s.abortMaybe(this._compressionAbortController)}_setData(r,i){const s=this._descriptor,n=s.context?.gl;if(!n)return;o.checkWebGLError(n),this.hasWebGLTextureObject||(this._glName=n.createTexture(),s.context.instanceCounter.increment(a.ResourceType.Texture,this)),u.validateTexture(s);const l=s.context.bindTexture(this,e.TEXTURE_UNIT_FOR_UPDATES);s.context.setActiveTexture(e.TEXTURE_UNIT_FOR_UPDATES),this._configurePixelStorage(),o.checkWebGLError(n);const c=i??s.target,d=u.is3DTarget(c);if(u.isTexImageSource(r))this._setDataFromTexImageSource(r,c);else{const{width:e,height:i,depth:a}=s;if(null==e||null==i)throw new t("texture:missing-size","Width and height must be specified!");if(d&&null==a)throw new t("texture:missing-depth","Depth must be specified!");if(s.internalFormat=u.deriveInternalFormat(s),s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(c,s.internalFormat,s.hasMipmap,e,i,a),u.isCompressedData(r)){if(!u.isCompressedFormat(s.internalFormat))throw new t("texture:format-mismatch","Attempting to use compressed data with an uncompressed format!");this._setDataFromCompressedSource(r,s.internalFormat,c)}else this._texImage(c,0,s.internalFormat,e,i,a,r),o.checkWebGLError(n),s.hasMipmap&&this.generateMipmap()}this._applySamplingMode(),this._applyWrapMode(),this._applyAnisotropicFilteringParameters(),this._applyShadowMode(),o.checkWebGLError(n),s.context.bindTexture(l,e.TEXTURE_UNIT_FOR_UPDATES)}_setDataCubeMap(e=null){for(let t=a.TextureType.TEXTURE_CUBE_MAP_POSITIVE_X;t<=a.TextureType.TEXTURE_CUBE_MAP_NEGATIVE_Z;t++)this._setData(e,t)}_configurePixelStorage(){const e=this._descriptor.context.gl,{unpackAlignment:t,flipped:r,preMultiplyAlpha:i}=this._descriptor;e.pixelStorei(e.UNPACK_ALIGNMENT,t),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,r?1:0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i?1:0)}_setDataFromTexImageSource(e,t){const{gl:r}=this._descriptor.context,i=this._descriptor;i.internalFormat=u.deriveInternalFormat(i);const s=u.is3DTarget(t),{width:n,height:a,depth:l}=u.getDimensions(e);i.width&&i.height,i.width||(i.width=n),i.height||(i.height=a),s&&i.depth,s&&(i.depth=l),i.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(t,i.internalFormat,i.hasMipmap,n,a,l),this._texImage(t,0,i.internalFormat,n,a,l,e),o.checkWebGLError(r),i.hasMipmap&&(this.generateMipmap(),o.checkWebGLError(r))}_setDataFromCompressedSource(e,t,r){const i=this._descriptor,{width:s,height:n,depth:o}=i,l=e.levels,c=u.calcMipmapLevels(r,s,n,o),d=Math.min(c,l.length)-1;this._descriptor.context.gl.texParameteri(i.target,a.TextureConstants.MAX_LEVEL,d),this._forEachMipmapLevel(((e,i,s,n)=>{const o=l[Math.min(e,l.length-1)];this._compressedTexImage(r,e,t,i,s,n,o)}),d)}_texStorage(e,r,i,s,n,o){const{gl:a}=this._descriptor.context;if(!u.isSizedPixelFormat(r)&&!u.isSizedDepthFormat(r)&&!u.isSizedDepthStencilFormat(r))throw new t("texture:missing-format","Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=i?u.calcMipmapLevels(e,s,n,o):1;if(u.is3DTarget(e)){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");a.texStorage3D(e,l,r,s,n,o)}else a.texStorage2D(e,l,r,s,n);this._wasImmutablyAllocated=!0}_texImage(e,r,i,s,n,o,a){const l=this._descriptor.context.gl,c=u.is3DTarget(e),{isImmutable:d,pixelFormat:h,dataType:p}=this._descriptor;if(d){if(null!=a){const i=a;if(c){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");l.texSubImage3D(e,r,0,0,0,s,n,o,h,p,i)}else l.texSubImage2D(e,r,0,0,s,n,h,p,i)}}else{const u=a;if(c){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");l.texImage3D(e,r,i,s,n,o,0,h,p,u)}else l.texImage2D(e,r,i,s,n,0,h,p,u)}}_compressedTexImage(e,r,i,s,n,o,a){const l=this._descriptor.context.gl,c=u.is3DTarget(e);if(this._descriptor.isImmutable){if(null!=a)if(c){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");l.compressedTexSubImage3D(e,r,0,0,0,s,n,o,i,a)}else l.compressedTexSubImage2D(e,r,0,0,s,n,i,a)}else if(c){if(null==o)throw new t("texture:missing-depth","Missing depth dimension for 3D texture upload");l.compressedTexImage3D(e,r,i,s,n,o,0,a)}else l.compressedTexImage2D(e,r,i,s,n,0,a)}async _compressOnWorker(t){const{width:r,height:i,context:s,flipped:o,preMultiplyAlpha:l,hasMipmap:c}=this._descriptor,u=this._descriptor.compress?.compressionTracker,d=this._descriptor.compress?.compressionCallback,{compressedTextureETC:p,compressedTextureS3TC:m}=s.capabilities;if(!e.compressionWorkerHandle?.isCompressible(t,this._descriptor)||!p&&!m)return;this.abortCompression();const f=new AbortController;this._compressionAbortController=f,u?.increment();try{let s;t instanceof Uint8Array?s=t.buffer:(s=await createImageBitmap(t,{imageOrientation:o?"flipY":"none"}),n.throwIfAborted(f));const u={data:s,width:r,height:i,needsFlip:t instanceof Uint8Array&&this.descriptor.flipped,components:this._descriptor.pixelFormat===a.PixelFormat.RGBA?4:3,preMultiplyAlpha:l,hasMipmap:c,hasETC:!!p,hasS3TC:!!m},h=await e.compressionWorkerHandle.invoke(u,f.signal,"low");if(n.throwIfAborted(f),h.compressedTexture&&this.hasWebGLTextureObject){const e=this.usedMemory;this._descriptor.internalFormat=h.internalFormat,this._setData(h.compressedTexture),d?.(e-this.usedMemory)}}catch(e){n.isAbortError(e)||h().error("Texture compression failed!")}finally{u?.decrement(),this._compressionAbortController?.signal.aborted&&(this._compressionAbortController=null)}}_forEachMipmapLevel(e,r=1/0){let{width:i,height:s,depth:n,hasMipmap:o,target:l}=this._descriptor;const c=l===a.TextureType.TEXTURE_3D;if(null==i||null==s||c&&null==n)throw new t("texture:missing-size","Missing texture dimensions for mipmap calculation");for(let t=0;e(t,i,s,n),o&&(1!==i||1!==s||c&&1!==n)&&!(t>=r);++t)i=Math.max(1,i>>1),s=Math.max(1,s>>1),c&&(n=Math.max(1,n>>1))}_applySamplingMode(){const e=this._descriptor,t=e.context?.gl;let r=e.samplingMode,i=e.samplingMode;r===a.TextureSamplingMode.LINEAR_MIPMAP_NEAREST||r===a.TextureSamplingMode.LINEAR_MIPMAP_LINEAR?(r=a.TextureSamplingMode.LINEAR,e.hasMipmap||(i=a.TextureSamplingMode.LINEAR)):r!==a.TextureSamplingMode.NEAREST_MIPMAP_NEAREST&&r!==a.TextureSamplingMode.NEAREST_MIPMAP_LINEAR||(r=a.TextureSamplingMode.NEAREST,e.hasMipmap||(i=a.TextureSamplingMode.NEAREST)),t.texParameteri(e.target,t.TEXTURE_MAG_FILTER,r),t.texParameteri(e.target,t.TEXTURE_MIN_FILTER,i)}_applyWrapMode(){const e=this._descriptor,t=e.context?.gl;"number"==typeof e.wrapMode?(t.texParameteri(e.target,t.TEXTURE_WRAP_S,e.wrapMode),t.texParameteri(e.target,t.TEXTURE_WRAP_T,e.wrapMode)):(t.texParameteri(e.target,t.TEXTURE_WRAP_S,e.wrapMode.s),t.texParameteri(e.target,t.TEXTURE_WRAP_T,e.wrapMode.t))}_applyShadowMode(){const e=this._descriptor,t=e.context?.gl,r=e.compareEnabled?t.COMPARE_REF_TO_TEXTURE:t.NONE;t.texParameteri(e.target,t.TEXTURE_COMPARE_MODE,r),e.compareEnabled&&t.texParameteri(e.target,t.TEXTURE_COMPARE_FUNC,t.GREATER),o.checkWebGLError(t)}_applyAnisotropicFilteringParameters(){const e=this._descriptor,t=e.context.capabilities.textureFilterAnisotropic;t&&e.context.gl.texParameterf(e.target,t.TEXTURE_MAX_ANISOTROPY,e.maxAnisotropy??1)}};e.Texture=p,e.tracer=null,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/TextureDescriptor":function(){define(["exports","./enums","./FBOAttachmentType","./Util"],(function(e,t,r,i){"use strict";e.TextureDescriptor=class{constructor(e=0,i=e){this.width=e,this.height=i,this.type=r.FBOAttachmentType.TextureDescriptor,this.target=t.TextureType.TEXTURE_2D,this.pixelFormat=t.PixelFormat.RGBA,this.dataType=t.PixelType.UNSIGNED_BYTE,this.samplingMode=t.TextureSamplingMode.LINEAR,this.wrapMode=t.TextureWrapMode.REPEAT,this.maxAnisotropy=1,this.flipped=!1,this.hasMipmap=!1,this.isOpaque=!1,this.unpackAlignment=4,this.preMultiplyAlpha=!1,this.compareEnabled=!1,this.linearFilterDepth=!1,this.depth=1,this.isImmutable=!1}},e.estimateMemory=function(e){return e.width<=0||e.height<=0||e.depth<=0?0:Math.round(e.width*e.height*e.depth*(e.hasMipmap?4/3:1)*(null==e.internalFormat?4:i.getBytesPerElementFormat(e.internalFormat))*(e.target===t.TextureType.TEXTURE_CUBE_MAP?6:1))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/textureUtils":function(){define(["exports","../../core/Error","../../core/Logger","./enums"],(function(e,t,r,i){"use strict";const s=()=>r.getLogger("esri/views/webgl/textureUtils");function n(e){return e in i.SizedDepthFormat}function o(e){return e in i.SizedDepthStencilFormat}function a(e){return null!=e&&e in i.CompressedTextureFormat}function l(e){return null!=e&&"type"in e&&"compressed"===e.type}function c(e){return null!=e&&"byteLength"in e}e.calcMipmapLevels=function(e,t,r,s=1){let n=Math.max(t,r);return e===i.TextureType.TEXTURE_3D&&(n=Math.max(n,s)),Math.floor(Math.log2(n))+1},e.deriveInternalFormat=function(e){if(null!=e.internalFormat)return e.internalFormat;switch(e.dataType){case i.PixelType.FLOAT:switch(e.pixelFormat){case i.PixelFormat.RGBA:return i.SizedPixelFormat.RGBA32F;case i.PixelFormat.RGB:return i.SizedPixelFormat.RGB32F;default:throw new t("texture:unknown-format","Unable to derive format")}case i.PixelType.UNSIGNED_BYTE:switch(e.pixelFormat){case i.PixelFormat.RGBA:return i.SizedPixelFormat.RGBA8;case i.PixelFormat.RGB:return i.SizedPixelFormat.RGB8}}const{pixelFormat:r}=e;return e.internalFormat=r===i.UnsizedDepthFormat.DEPTH_STENCIL?i.SizedDepthStencilFormat.DEPTH24_STENCIL8:r===i.UnsizedDepthFormat.DEPTH_COMPONENT?i.SizedDepthFormat.DEPTH_COMPONENT24:r,e.internalFormat},e.getDimensions=function(e){let t="width"in e?e.width:e.codedWidth,r="height"in e?e.height:e.codedHeight;return e instanceof HTMLVideoElement&&(t=e.videoWidth,r=e.videoHeight),{width:t,height:r,depth:1}},e.is3DTarget=function(e){return e===i.TextureType.TEXTURE_3D||e===i.TextureType.TEXTURE_2D_ARRAY},e.isArrayBufferView=c,e.isCompressedData=l,e.isCompressedFormat=a,e.isCompressedTexture=function(e){return a(e.descriptor.internalFormat)},e.isSizedDepthFormat=n,e.isSizedDepthStencilFormat=o,e.isSizedPixelFormat=function(e){return e in i.SizedPixelFormat},e.isTexImageSource=function(e){return null!=e&&!l(e)&&!c(e)},e.validateTexture=function(e){const{width:t,height:r,depth:a}=e;(null!=t&&t<0||null!=r&&r<0||null!=a&&a<0)&&s().error("Negative dimension parameters are not allowed!");const{internalFormat:l}=e;if(l&&(n(l)||o(l))){const{linearFilterDepth:t,compareEnabled:r,samplingMode:n,hasMipmap:o}=e;o&&s().error("Depth textures cannot have mipmaps"),t?n!==i.TextureSamplingMode.LINEAR&&n!==i.TextureSamplingMode.NEAREST&&s().error("Depth textures cannot sample mipmaps"):(n!==i.TextureSamplingMode.NEAREST&&s().error("Depth textures without filtering must use NEAREST filtering"),r&&s().error("Depth textures without filtering cannot use compare function"))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/ValidatedTextureDescriptor":function(){define(["exports","./enums","./TextureDescriptor"],(function(e,t,r){"use strict";class i extends r.TextureDescriptor{constructor(e,r){switch(super(),this.context=e,Object.assign(this,r),this.internalFormat){case t.SizedPixelFormat.R16F:case t.SizedPixelFormat.R32F:case t.SizedPixelFormat.R8_SNORM:case t.SizedPixelFormat.R8:this.pixelFormat=t.PixelFormat.RED;break;case t.SizedPixelFormat.R8I:case t.SizedPixelFormat.R8UI:case t.SizedPixelFormat.R16I:case t.SizedPixelFormat.R16UI:case t.SizedPixelFormat.R32I:case t.SizedPixelFormat.R32UI:this.pixelFormat=t.PixelFormat.RED_INTEGER}}static validate(e,t){return new i(e,t)}}e.ValidatedTextureDescriptor=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/Scheduler":function(){define(["exports","../../core/Handles","../../core/has","../../core/Logger","../../core/maybe","../../core/PerformanceSampler","../../core/PooledArray","../../core/promiseUtils","../../core/reactiveUtils","../../core/signal","../../core/time","../../layers/support/PromiseQueue","./debugFlags","./RenderState","./Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";var f;e.TaskPriority=void 0,(f=e.TaskPriority||(e.TaskPriority={})).RESOURCE_CONTROLLER_IMMEDIATE="immediate",f.RESOURCE_CONTROLLER="schedule",f.SLIDE="slide",f.STREAM_DATA_LOADER="stream loader",f.ELEVATION_QUERY="elevation query",f.TERRAIN_SURFACE="terrain",f.SURFACE_GEOMETRY_UPDATES="surface geometry updates",f.LOD_RENDERER="LoD renderer",f.GRAPHICS_CORE="Graphics3D",f.I3S_CONTROLLER="I3S",f.POINT_CLOUD_LAYER="point cloud",f.FEATURE_TILE_FETCHER="feature fetcher",f.OVERLAY="overlay",f.OVERLAY_RENDERER="overlay renderer",f.STAGE="stage",f.GRAPHICS_DECONFLICTOR="graphics deconflictor",f.FILTER_VISIBILITY="Graphics3D filter visibility",f.SCALE_VISIBILITY="Graphics3D scale visibility",f.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",f.POINT_OF_INTEREST_FREQUENT="POI frequent",f.POINT_OF_INTEREST_INFREQUENT="POI infrequent",f.LABELER="labeler",f.FEATURE_QUERY_ENGINE="feature query",f.FEATURE_TILE_TREE="feature tile tree",f.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",f.ELEVATION_ALIGNMENT="elevation alignment",f.ELEVATION_ALIGNMENT_SCENE="elevation alignment scene",f.TEXT_TEXTURE_ATLAS="text texture atlas",f.TEXTURE_UNLOAD="texture unload",f.LINE_OF_SIGHT_TOOL="line of sight tool",f.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",f.ELEVATION_PROFILE="elevation profile",f.SNAPPING="snapping",f.SHADOW_ACCUMULATOR="shadow accumulator",f.CLOUDS_GENERATOR="clouds generator",f.MAPVIEW_FETCH_QUEUE="mapview fetch queue",f.MAPVIEW_LAYERVIEW_UPDATE="mapview layerview update",f.MAPVIEW_VECTOR_TILE_PARSING_QUEUE="mapview vector tile parsing queue",f[f.NONE=0]="NONE",f[f.TEST_PRIO=1]="TEST_PRIO";const g=new Map([[e.TaskPriority.RESOURCE_CONTROLLER_IMMEDIATE,0],[e.TaskPriority.RESOURCE_CONTROLLER,4],[e.TaskPriority.SLIDE,0],[e.TaskPriority.STREAM_DATA_LOADER,0],[e.TaskPriority.ELEVATION_QUERY,0],[e.TaskPriority.TERRAIN_SURFACE,1],[e.TaskPriority.SURFACE_GEOMETRY_UPDATES,1],[e.TaskPriority.LOD_RENDERER,2],[e.TaskPriority.GRAPHICS_CORE,2],[e.TaskPriority.I3S_CONTROLLER,2],[e.TaskPriority.POINT_CLOUD_LAYER,2],[e.TaskPriority.FEATURE_TILE_FETCHER,2],[e.TaskPriority.CLOUDS_GENERATOR,2],[e.TaskPriority.OVERLAY,4],[e.TaskPriority.OVERLAY_RENDERER,4],[e.TaskPriority.STAGE,4],[e.TaskPriority.GRAPHICS_DECONFLICTOR,4],[e.TaskPriority.FILTER_VISIBILITY,4],[e.TaskPriority.SCALE_VISIBILITY,4],[e.TaskPriority.FRUSTUM_VISIBILITY,4],[e.TaskPriority.POINT_OF_INTEREST_FREQUENT,6],[e.TaskPriority.POINT_OF_INTEREST_INFREQUENT,30],[e.TaskPriority.LABELER,8],[e.TaskPriority.FEATURE_QUERY_ENGINE,8],[e.TaskPriority.FEATURE_TILE_TREE,16],[e.TaskPriority.FEATURE_TILE_TREE_ACTIVE,0],[e.TaskPriority.ELEVATION_ALIGNMENT,12],[e.TaskPriority.ELEVATION_ALIGNMENT_SCENE,14],[e.TaskPriority.TEXT_TEXTURE_ATLAS,12],[e.TaskPriority.TEXTURE_UNLOAD,12],[e.TaskPriority.LINE_OF_SIGHT_TOOL,16],[e.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE,0],[e.TaskPriority.SNAPPING,0],[e.TaskPriority.SHADOW_ACCUMULATOR,30],[e.TaskPriority.MAPVIEW_FETCH_QUEUE,0],[e.TaskPriority.MAPVIEW_LAYERVIEW_UPDATE,2],[e.TaskPriority.MAPVIEW_VECTOR_TILE_PARSING_QUEUE,0]]);function y(e){return g.has(e)?g.get(e):"number"==typeof e?e:1}const _=u.Milliseconds(6.5),b=u.Milliseconds(1),v=u.Milliseconds(30),S=u.Milliseconds(1e3/30),w=u.Milliseconds(100);var x,T;!function(r){r.Scheduler=class{get updating(){return this._updating.value}_updatingChanged(){this._updating.value=this._tasks.some((e=>e.needsUpdate))}constructor(){this._updating=c.signal(!0),this._microTaskQueued=!1,this._frameNumber=0,this.performanceInfo={total:new n("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=new f,this._state=p.RenderState.INTERACTING,this._tasks=new o,this._runQueue=new o,this._load=0,this._idleStateCallbacks=new o,this._idleUpdatesStartFired=!1,this._forceTask=!1,this._debug=!1,this._debugHandle=l.watch((()=>h.SCHEDULER_LOG_SLOW_TASKS),(e=>this._debug=e),l.initial);for(const t of Object.keys(e.TaskPriority))this.performanceInfo.tasks.set(e.TaskPriority[t],new n(e.TaskPriority[t]))}destroy(){this._tasks.toArray().forEach((e=>e.remove())),this._tasks.clear(),s.removeMaybe(this._debugHandle),this._microTaskQueued=!1,this._updatingChanged()}taskRunningChanged(e){this._updatingChanged(),e&&this._budget.remaining>0&&!this._microTaskQueued&&(this._microTaskQueued=!0,queueMicrotask((()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.remaining>0&&this._schedule()&&this._runFrame())})))}registerTask(e,t){const r=new a(this,e,t);return this._tasks.push(r),this._updatingChanged(),this.performanceInfo.tasks.has(e)||this.performanceInfo.tasks.set(e,new n(e)),r}registerIdleStateCallbacks(e,t){const r={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(r),this.state===p.RenderState.IDLE&&this._idleUpdatesStartFired&&r.idleBegin();const i=this;return{remove:()=>this._removeIdleStateCallbacks(r),set idleBegin(e){i._idleUpdatesStartFired&&(r.idleEnd(),i._state===p.RenderState.IDLE&&e()),r.idleBegin=e},set idleEnd(e){r.idleEnd=e}}}get load(){return this._load}set state(e){this._state!==e&&(this._state=e,this.state!==p.RenderState.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll((e=>e.idleEnd()))))}get state(){return this._state}frame(e){this._startFrameTaskTimes();const t=this._updateBudget(e);if(t){const e=this._budget.now();this._runFrame(),this._recordFrameTaskTimes(this._budget.now()-e)}else this._recordFrameTaskTimes(0);return t}_updateBudget(e){this._test&&(this._test.usedBudget=0),++this._frameNumber;let t=_,r=e.frameDuration,i=b;switch(this.state){case p.RenderState.IDLE:t=u.Milliseconds(0),r=u.Milliseconds(Math.max(w,e.frameDuration)),i=v;break;case p.RenderState.INTERACTING:r=u.Milliseconds(Math.max(S,e.frameDuration));case p.RenderState.ANIMATING:}return r=u.Milliseconds(r-e.elapsedFrameTime-t),this.state!==p.RenderState.IDLE&&r<b&&!this._forceTask?(this._forceTask=!0,!1):(r=u.Milliseconds(Math.max(r,i)),this._budget.reset(r),this._updateLoad(),this._schedule())}_runFrame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case p.RenderState.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll((e=>e.idleBegin()))),this._runIdle();break;case p.RenderState.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test&&(this._test.usedBudget=this._budget.elapsed)}stopFrame(){this._budget.reset(u.Milliseconds(0)),this._budget.madeProgress()}_removeIdleStateCallbacks(e){this._idleUpdatesStartFired&&e.idleEnd(),this._idleStateCallbacks.removeUnordered(e)}removeTask(e){this._tasks.removeUnordered(e),this._runQueue.removeUnordered(e),this._updatingChanged()}_updateTask(e){this._tasks.forAll((t=>{t.name===e&&t.setPriority(e)}))}_getState(t){if(this._runQueue.some((e=>e.name===t)))return e.TaskState.SCHEDULED;let r=e.TaskState.IDLE;return this._tasks.forAll((i=>{i.name===t&&i.needsUpdate&&(i.schedulePriority<=1?r=e.TaskState.READY:r!==e.TaskState.READY&&(r=e.TaskState.WAITING))})),r}_getRuntime(e){let t=0;return this._tasks.forAll((r=>{r.name===e&&(t+=r.runtime)})),t}_resetRuntimes(){this._tasks.forAll((e=>e.runtime=0))}_getRunning(){const e=new Map;if(this._tasks.forAll((t=>{t.needsUpdate&&e.set(t.name,(e.get(t.name)||0)+1)})),0===e.size)return null;let t="";return e.forEach(((e,r)=>{t+=e>1?` ${e}x ${r}`:` ${r}`})),t}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const e=this._tasks.reduce(((e,t)=>t.needsUpdate?++e:e),0);this._load=.9*this._load+e*(1-.9)}_schedule(){for(this._runQueue.filterInPlace((e=>!!e.needsUpdate||(e.schedulePriority=e.basePriority,!1))),this._tasks.forAll((e=>{0===e.basePriority&&e.needsUpdate&&!this._runQueue.includes(e)&&e.blockFrame!==this._frameNumber&&this._runQueue.unshift(e)}));0===this._runQueue.length;){let e=!1,t=0;if(this._tasks.forAll((r=>{r.needsUpdate&&0!==r.schedulePriority&&0!==r.basePriority&&r.blockFrame!==this._frameNumber&&(e=!0,t=Math.max(t,r.basePriority),1===r.schedulePriority?(r.schedulePriority=0,this._runQueue.push(r)):--r.schedulePriority)})),!e)return this._updatingChanged(),!1}return this._updatingChanged(),!0}_run(){do{for(;this._runQueue.length>0;){const t=this._budget.now(),r=this._runQueue.pop();this._budget.resetProgress();try{r.task.runTask(this._budget)===m.Yield&&(r.blockFrame=this._frameNumber)}catch(e){i.getLogger("esri.views.support.Scheduler").error(`Exception in task "${r.name}"`,e),r.blockFrame=this._frameNumber}!this._budget.hasProgressed&&r.blockFrame!==this._frameNumber&&r.needsUpdate&&(r.name,e.TaskPriority.I3S_CONTROLLER,r.blockFrame=this._frameNumber),r.schedulePriority=r.basePriority;const s=this._budget.now()-t;if(r.runtime+=s,this._frameTaskTimes.set(r.priority,this._frameTaskTimes.get(r.priority)+s),this._budget.remaining<=0)return void this._updatingChanged()}}while(this._schedule());this._updatingChanged()}_startFrameTaskTimes(){for(const t of Object.keys(e.TaskPriority))this._frameTaskTimes.set(e.TaskPriority[t],0)}_recordFrameTaskTimes(e){this._frameTaskTimes.forEach(((e,t)=>this.performanceInfo.tasks.get(t).push(e))),this.performanceInfo.total.push(e)}get test(){return this._test}};class a{get task(){return this._task.value}get updating(){return this._queue.running}constructor(e,r,i){this._scheduler=e,this.name=r,this.blockFrame=0,this.runtime=0,this._queue=new d.PromiseQueue,this._handles=new t,this._basePriority=y(r),this.schedulePriority=this._basePriority,this._task=c.signal(null!=i?i:this._queue),this._handles.add(l.when((()=>this.task.running),(t=>e.taskRunningChanged(t))))}remove(){this.processQueue(C),this._scheduler.removeTask(this),this.schedule=P.schedule,this.reschedule=P.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(e){if(this.name===e)return;this.name=e;const t=y(e);0!==this._basePriority&&0===this.schedulePriority||(this.schedulePriority=t),this._basePriority=t}get priority(){return this.name}set priority(e){this.setPriority(e)}get needsUpdate(){return this.updating||this.task.running}schedule(e,t,r){return this._queue.push(e,t,r)}reschedule(e,t,r){return this._queue.unshift(e,t,r)}processQueue(e){return this._queue.runTask(e)}}class f{constructor(){this._begin=performance?.now()??0,this._budget=0,this._done=!1,this._progressed=!1,this._enabled=!0}run(e){return!this.done&&(!0===e()&&this.madeProgress(),!0)}get done(){return this._done}get budget(){return this._budget}madeProgress(){return this._progressed=!0,this._done=this.elapsed>=this._budget&&this._enabled,this._done}get enabled(){return this._enabled}set enabled(e){this._enabled=e}reset(e){this._begin=this.now(),this._budget=e,this.resetProgress()}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return this.now()-this._begin}resetProgress(){this._progressed=!1,this._done=!1}get hasProgressed(){return this._progressed}}r.Budget=f}(x||(x={})),e.TaskState=void 0,(T=e.TaskState||(e.TaskState={})).SCHEDULED="s",T.READY="r",T.WAITING="w",T.IDLE="i";const C=new x.Budget;C.enabled=!1;const P=new class{remove(){}processQueue(){}schedule(e,t,r){try{if(a.isAborted(t)){const e=a.createAbortError();return r?Promise.resolve(r(e)):Promise.reject(e)}return a.when(e(C))}catch(e){return Promise.reject(e)}}reschedule(e,t,r){return this.schedule(e,t,r)}};e.ImmediateTask=P,e.getTaskPriority=y,e.makeBudget=function(e){const t=new x.Budget;return t.reset(e),t},e.newScheduler=function(){return new x.Scheduler},e.noBudget=C,e.taskPriorities=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/PromiseQueue":function(){define(["exports","../../core/promiseUtils","../../core/signal","../../views/support/Yield"],(function(e,t,r,i){"use strict";class s{constructor(e,t,r,i=void 0,s=void 0){this.resolve=e,this.reject=t,this.callback=r,this.signal=i,this.abortCallback=s}}e.PromiseQueue=class{constructor(){this._tasks=new Array,this._numPendingTasks=r.signal(0),this._running=r.signal(!1)}get length(){return this._tasks.length}get updating(){return this._numPendingTasks.value>0}get running(){return this._running.value}_updateRunning(){this._running.value=this._tasks.length>0}destroy(){this.cancelAll()}runTask(e){if(0===this.length)return i.Yield;for(;!e.done&&this._process(e);)e.madeProgress()}push(e,t,r){return new Promise(((i,n)=>{this._tasks.push(new s(i,n,e,t,r)),++this._numPendingTasks.value,this._updateRunning()})).finally((()=>--this._numPendingTasks.value))}unshift(e,t,r){return new Promise(((i,n)=>{this._tasks.unshift(new s(i,n,e,t,r)),++this._numPendingTasks.value,this._updateRunning()})).finally((()=>--this._numPendingTasks.value))}_process(e){if(0===this._tasks.length)return!1;const r=this._tasks.shift();this._updateRunning();try{const i=t.isAborted(r.signal);if(i&&!r.abortCallback)r.reject(t.createAbortError());else{const s=i?r.abortCallback?.(t.createAbortError()):r.callback(e);t.isPromiseLike(s)?s.then(r.resolve,r.reject):r.resolve(s)}}catch(e){r.reject(e)}return!0}cancelAll(){const e=t.createAbortError();for(const t of this._tasks)if(t.abortCallback){const r=t.abortCallback(e);t.resolve(r)}else t.reject(e);this._tasks.length=0,this._updateRunning()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/Yield":function(){define(["exports"],(function(e){"use strict";const t=Symbol("Yield");e.Yield=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/debugFlags":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o){"use strict";let a=class extends t{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};return e.__decorate([r.property()],a.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),e.__decorate([r.property()],a.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),a=e.__decorate([o.subclass("esri.views.support.debugFlags")],a),new a}))},"esri/views/support/RenderState":function(){define(["exports"],(function(e){"use strict";var t;e.RenderState=void 0,(t=e.RenderState||(e.RenderState={}))[t.ANIMATING=0]="ANIMATING",t[t.INTERACTING=1]="INTERACTING",t[t.IDLE=2]="IDLE",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/Precipitation":function(){define(["exports","../../../chunks/tslib.es6","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/ellipsoidUtils","../webgl","./PrecipitationTechnique","./PrecipitationTechniqueConfiguration","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/effects/TransparentEnvironment","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/VertexArrayObject","../webgl-engine/lib/VertexAttribute","../../webgl/BufferObject","../../webgl/enums","../../webgl/Util"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x){"use strict";e.Precipitation=class extends y.TransparentEnvironment{constructor(e){super(e),this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new p.PrecipitationPassParameters,this._configuration=new m.PrecipitationTechniqueConfiguration;const{view:t,type:r}=e;this._configuration.type="rainy"===r?m.PrecipitationType.Rain:m.PrecipitationType.Snow,t.stage.renderView.techniques.precompile(p.PrecipitationTechnique,this._configuration),this._passParameters.time=0,this._passParameters.radius=d.getReferenceEllipsoid(t.spatialReference).radius,this.addHandles([s.watch((()=>t.environment.weather),(e=>{e.type===r&&this.addHandles(s.watch((()=>e.precipitation),(e=>this._adjustParticles(e)),s.syncAndInitial))}),s.syncAndInitial)]),this.addHandles(s.watch((()=>t.stage?.renderer.renderContext.bind.clouds.fadeFactor??1),(e=>{this._passParameters.opacity=e,1===e&&(this.removeHandles("opacity"),this.addHandles(s.watch((()=>t.stage?.renderer.renderContext.bind.clouds.opacity??1),(e=>this._passParameters.opacity=e),s.syncAndInitial),"opacity"))}),s.sync),"opacity")}initialize(){this.addHandles([s.watch((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),s.syncAndInitial)])}_adjustParticles(e){const t=e<.5?r.lerp(0,.35,2*e):r.lerp(.35,1,2*(e-.5));this._numParticles=T*t}destroy(){this._numParticles=0,this._vao=i.disposeMaybe(this._vao),this._instanceIdBuffer=i.disposeMaybe(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles(s.watch((()=>this.renderContext?.bind.clouds.fadeFactor??1),(t=>{this._passParameters.opacity=1-t,1===t&&(this.removeAllHandles(),e())})),"opacity")}updateAnimation(e){const t=("rainy"===this.type?this._rainSpeed:this._snowSpeed)*n.secondsFromMilliseconds(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext;this._instanceIdBuffer??=this._createInstanceIndices(t);const r=Math.round(this._numParticles*this._passParameters.opacity),i=e.find((({name:e})=>e===h.InternalRenderCategory.TRANSPARENT_ENVIRONMENT));if(r<1)return i;const s=this.techniques.get(p.PrecipitationTechnique,this._configuration);if(!s.compiled)return this.requestRender(_.RenderRequestType.UPDATE),i;const n=t.bindTechnique(s,this.bindParameters,this._passParameters);return this._vao??=function(e,t){const r=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new b.VertexArrayObject(e,t,new Map([["geometry",f.glLayout(C)]]),new Map([["geometry",S.BufferObject.createVertex(e,w.Usage.STATIC_DRAW,r)]]))}(t,s.locations),t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),x.bindVertexBufferLayout(t,s.locations,this._instanceIdBuffer,P,0),t.drawArraysInstanced(w.PrimitiveType.TRIANGLES,0,3,r),x.unbindVertexBufferLayout(t,s.locations,this._instanceIdBuffer,P),i}_createInstanceIndices(e){const t=[];for(let e=0;e<T;e++)t.push(e);return S.BufferObject.createVertex(e,w.Usage.STATIC_DRAW,new Float32Array(t))}},t.__decorate([o.property({constructOnly:!0})],e.Precipitation.prototype,"type",void 0),e.Precipitation=t.__decorate([u.subclass("esri.views.3d.environment.Precipitation")],e.Precipitation);const T=25e4,C=g.newLayout().vec3f(v.VertexAttribute.POSITION),P=f.glLayout(g.newLayout().f32(v.VertexAttribute.INSTANCEFEATUREATTRIBUTE),1);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl":function(){define(["exports","../../core/libs/gl-matrix-2/factories/mat4f64","../../geometry/projection/computeTranslationToOriginAndRotation","../../geometry/projection/projectBuffer"],(function(e,t,r,i){"use strict";var s,n;e.RenderCategory=void 0,(s=e.RenderCategory||(e.RenderCategory={})).OPAQUE="opaque-color",s.TRANSPARENT="transparent-color",s.COMPOSITE="composite-color",s.FINAL="final-color",e.InternalRenderCategory=void 0,(n=e.InternalRenderCategory||(e.InternalRenderCategory={})).SSAO="ssao",n.LASERLINES="laserline-color",n.ANTIALIASING="aa-color",n.HIGHLIGHTS="highlight-color",n.MAGNIFIER="magnifier-color",n.OCCLUDED="occluded-color",n.VIEWSHED="viewshed-color",n.OPAQUE_TERRAIN="opaque-terrain-color",n.OPAQUE_ENVIRONMENT="opaque-environment-color",n.TRANSPARENT_ENVIRONMENT="transparent-environment-color",n.FOCUSAREA="focusarea",n.FOCUSAREA_COLOR="focusarea-color",e.fromRenderCoordinates=function(e,t,r,s,n,o,a){return o=o||e.spatialReference,i.projectBuffer(t,e.renderCoordsHelper.spatialReference,r,s,o,n,a)?s:null},e.renderCoordinateTransformAt=function(e,i,s,n){return n||(n=t.create()),s=s||e.spatialReference,r.computeTranslationToOriginAndRotation(s,i,n,e.renderCoordsHelper.spatialReference)?n:null},e.toRenderCoordinates=function(e,t,r,s,n,o,a){return s=s||e.spatialReference,i.projectBuffer(t,s,r,n,e.renderCoordsHelper.spatialReference,o,a)?n:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/PrecipitationTechnique":function(){define(["require","exports","../../../chunks/Precipitation.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../webgl-engine/lib/VertexAttribute","../../webgl/enums","../../webgl/NoParameters","../../webgl/renderState"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends a.NoParameters{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}}class u extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.Precipitation,(()=>new Promise(((t,r)=>e(["./Precipitation.glsl"],t,r))))),new Map([[n.VertexAttribute.POSITION,0],[n.VertexAttribute.INSTANCEFEATUREATTRIBUTE,1]]))}initializePipeline(){return l.makePipelineState({blending:l.premultipliedAlpha,depthTest:{func:o.CompareFunction.LEQUAL},colorWrite:l.defaultColorWrite})}}t.PrecipitationPassParameters=c,t.PrecipitationTechnique=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Precipitation.glsl":function(){define(["exports","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/environment/PrecipitationTechniqueConfiguration","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform","../views/3d/webgl-engine/lib/VertexAttribute","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(e){const r=new u.ShaderBuilder;return r.attributes.add(c.VertexAttribute.POSITION,"vec3"),r.attributes.add(c.VertexAttribute.INSTANCEFEATUREATTRIBUTE,"float"),r.vertex.uniforms.add(new s.Float3BindUniform("cameraPosition",(e=>e.camera.eye)),new n.Float3PassUniform("offset",((e,r)=>function(e,r){const i=r.camera.eye,s=.5*e.width,n=1/e.width,o=t.floor(h,t.set(h,(i[0]+s)*n,(i[1]+s)*n,(i[2]+s)*n));return t.sub(o,i,t.scale(o,o,e.width))}(e,r))),new o.FloatPassUniform("width",(e=>e.width)),new o.FloatPassUniform("time",(e=>e.time)),new l.Matrix4BindUniform("proj",(e=>e.camera.projectionMatrix)),new l.Matrix4BindUniform("view",(e=>e.camera.viewMatrix))),r.varyings.add("vUv","vec2"),r.vertex.code.add(a.glsl`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),r.vertex.main.add(a.glsl`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===i.PrecipitationType.Rain?a.glsl`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:a.glsl`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),r.fragment.uniforms.add(new o.FloatPassUniform("opacity",(e=>e.opacity)),new s.Float3BindUniform("particleColor",(r=>function(e,r){const s=r.type===i.PrecipitationType.Rain?f:m,n=t.scale(h,s,g),o=e.camera.eye;t.normalize(p,o);const a=Math.max(0,t.dot(p,e.lighting.mainLight.direction));return t.lerp(n,n,s,a)}(r,e)))),r.fragment.main.add(a.glsl`
    float d = length(vUv - vec2(0.5));

    ${e.type===i.PrecipitationType.Rain?a.glsl`d = 0.35 * smoothstep(0.5, 0.0, d);`:a.glsl`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),r}const h=r.create(),p=r.create(),m=r.fromValues(1,1,1),f=r.fromValues(.85,.85,.85),g=.7,y=Object.freeze(Object.defineProperty({__proto__:null,build:d},Symbol.toStringTag,{value:"Module"}));e.Precipitation=y,e.build=d}))},"esri/views/3d/environment/PrecipitationTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";var i;e.PrecipitationType=void 0,(i=e.PrecipitationType||(e.PrecipitationType={}))[i.Rain=0]="Rain",i[i.Snow=1]="Snow",i[i.COUNT=2]="COUNT";class s extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.type=e.PrecipitationType.Rain}}t.__decorate([r.parameter({count:e.PrecipitationType.COUNT})],s.prototype,"type",void 0),e.PrecipitationTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Float3BindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"vec3",t.BindType.Bind,((t,i)=>t.setUniform3fv(e,r(i))))}}e.Float3BindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Float3PassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"vec3",t.BindType.Pass,((t,i,s)=>t.setUniform3fv(e,r(i,s))))}}e.Float3PassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"mat4",t.BindType.Bind,((t,i)=>t.setUniformMatrix4fv(e,r(i))))}}e.Matrix4BindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/buffer/glUtil":function(){define(["exports","../../../webgl/enums","../../../webgl/VertexElementDescriptor"],(function(e,t,r){"use strict";const i={u8:t.DataType.UNSIGNED_BYTE,u16:t.DataType.UNSIGNED_SHORT,u32:t.DataType.UNSIGNED_INT,i8:t.DataType.BYTE,i16:t.DataType.SHORT,i32:t.DataType.INT,f16:t.DataType.HALF_FLOAT,f32:t.DataType.FLOAT};e.glLayout=function(e,t=0){const s=e.stride;return Array.from(e.fields.keys()).map((n=>{const o=e.fields.get(n),a=o.constructor.ElementCount,l=function(e){const t=i[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}(o.constructor.ElementType),c=o.offset,u=o.optional?.glNormalized??!1;return new r.VertexElementDescriptor(n,a,l,c,s,u,t)}))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/VertexElementDescriptor":function(){define(["exports"],(function(e){"use strict";e.VertexElementDescriptor=class{constructor(e,t,r,i,s,n=!1,o=0){this.name=e,this.count=t,this.type=r,this.offset=i,this.stride=s,this.normalized=n,this.divisor=o}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/buffer/InterleavedLayout":function(){define(["exports","../../../../geometry/support/float16","../../../../geometry/support/buffer/BufferView","../../../../geometry/support/buffer/types","../../webgl-engine/lib/Util"],(function(e,t,r,i,s){"use strict";class n{constructor(e,t){this.layout=e,this.buffer="number"==typeof t?new ArrayBuffer(t*e.stride):t;for(const t of e.fields.keys()){const r=e.fields.get(t);this[t]=new r.constructor(this.buffer,r.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(e,t){const r=this[e];return r&&r.elementCount===t.ElementCount&&r.elementType===t.ElementType?r:null}slice(e,t){return new n(this.layout,this.buffer.slice(e*this.stride,t*this.stride))}copyFrom(e,t=0,r=0,i=e.count){const s=this.stride;if(s%4==0){const n=new Uint32Array(e.buffer,t*s,i*s/4);new Uint32Array(this.buffer,r*s,i*s/4).set(n)}else{const n=new Uint8Array(e.buffer,t*s,i*s);new Uint8Array(this.buffer,r*s,i*s).set(n)}return this}get cachedMemory(){return this.byteLength}dispose(){}}class o{constructor(e){this._stride=0,this._fields=new Map,e&&(this._stride=e.stride,e.fields.forEach((e=>{return this._fields.set(e[0],{...e[1],constructor:(t=e[1].constructor,c.get(t))});var t})))}freeze(){return this}vec2f16(e,i){return this._appendField(e,t.hasNativeFloat16Array?r.BufferViewVec2f16:r.BufferViewVec2f,i),this}vec2f(e,t){return this._appendField(e,r.BufferViewVec2f,t),this}vec2f64(e,t){return this._appendField(e,r.BufferViewVec2f64,t),this}vec3f16(e,i){return this._appendField(e,t.hasNativeFloat16Array?r.BufferViewVec3f16:r.BufferViewVec3f,i),this}vec3f(e,t){return this._appendField(e,r.BufferViewVec3f,t),this}vec3f64(e,t){return this._appendField(e,r.BufferViewVec3f64,t),this}vec4f16(e,i){return this._appendField(e,t.hasNativeFloat16Array?r.BufferViewVec4f16:r.BufferViewVec4f,i),this}vec4f(e,t){return this._appendField(e,r.BufferViewVec4f,t),this}vec4f64(e,t){return this._appendField(e,r.BufferViewVec4f64,t),this}mat3f(e,t){return this._appendField(e,r.BufferViewMat3f,t),this}mat3f64(e,t){return this._appendField(e,r.BufferViewMat3f64,t),this}mat4f(e,t){return this._appendField(e,r.BufferViewMat4f,t),this}mat4f64(e,t){return this._appendField(e,r.BufferViewMat4f64,t),this}vec4u8(e,t){return this._appendField(e,r.BufferViewVec4u8,t),this}f16(e,i){return this._appendField(e,t.hasNativeFloat16Array?r.BufferViewFloat16:r.BufferViewFloat,i),this}f32(e,t){return this._appendField(e,r.BufferViewFloat,t),this}f64(e,t){return this._appendField(e,r.BufferViewFloat64,t),this}u8(e,t){return this._appendField(e,r.BufferViewUint8,t),this}u16(e,t){return this._appendField(e,r.BufferViewUint16,t),this}i8(e,t){return this._appendField(e,r.BufferViewInt8,t),this}vec2i8(e,t){return this._appendField(e,r.BufferViewVec2i8,t),this}vec2i16(e,t){return this._appendField(e,r.BufferViewVec2i16,t),this}vec2u8(e,t){return this._appendField(e,r.BufferViewVec2u8,t),this}vec2u16(e,t){return this._appendField(e,r.BufferViewVec2u16,t),this}vec4u16(e,t){return this._appendField(e,r.BufferViewVec4u16,t),this}u32(e,t){return this._appendField(e,r.BufferViewUint32,t),this}_appendField(e,t,r){this._fields.has(e)&&s.assert(!1,`${e} already added to vertex buffer layout`);const n=t.ElementCount*i.elementTypeSize(t.ElementType),o=this._stride;this._fields.set(e,{constructor:t,size:n,offset:o,optional:r}),this._alignFields()}_alignFields(){let e=0,t=1;this._fields.forEach((r=>{const s=i.elementTypeSize(r.constructor.ElementType);e=Math.floor((e+s-1)/s)*s,r.offset=e,e+=r.size,t=Math.max(t,s)})),e=Math.floor((e+t-1)/t)*t,this._stride=e}createBuffer(e){return new n(this,e)}createView(e){return new n(this,e)}clone(){const e=new o;return e._stride=this._stride,e._fields=new Map,this._fields.forEach(((t,r)=>e._fields.set(r,t))),e.BufferType=this.BufferType,e}get stride(){return this._stride}get fields(){return this._fields}}const a=[r.BufferViewFloat,r.BufferViewVec2f,r.BufferViewVec3f,r.BufferViewVec4f,r.BufferViewMat3f,r.BufferViewMat4f,r.BufferViewFloat64,r.BufferViewVec2f64,r.BufferViewVec3f64,r.BufferViewVec4f64,r.BufferViewMat3f64,r.BufferViewMat4f64,r.BufferViewUint8,r.BufferViewVec2u8,r.BufferViewVec3u8,r.BufferViewVec4u8,r.BufferViewUint16,r.BufferViewVec2u16,r.BufferViewVec3u16,r.BufferViewVec4u16,r.BufferViewUint32,r.BufferViewVec2u32,r.BufferViewVec3u32,r.BufferViewVec4u32,r.BufferViewInt8,r.BufferViewVec2i8,r.BufferViewVec3i8,r.BufferViewVec4i8,r.BufferViewInt16,r.BufferViewVec2i16,r.BufferViewVec3i16,r.BufferViewVec4i16,r.BufferViewInt32,r.BufferViewVec2i32,r.BufferViewVec3i32,r.BufferViewVec4i32];function l(e){return`${e.ElementType}_${e.ElementCount}`}const c=new Map;a.forEach((e=>c.set(l(e),e))),e.InterleavedBuffer=n,e.InterleavedLayout=o,e.PackedLayout=class{constructor(e){this.fields=new Array,e.fields.forEach(((e,t)=>{const r={...e,constructor:l(e.constructor)};this.fields.push([t,r])})),this.stride=e.stride}},e.newLayout=function(){return new o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/float16":function(){define(["exports"],(function(e){"use strict";let t=globalThis.Float16Array;e.hasNativeFloat16Array=!!t,e.disableNativeF16Array=function(){t=null,e.hasNativeFloat16Array=!1},e.getFloat16ArrayConstructor=function(){return t},e.makeFloat16Array=function(...e){return new(t??Float32Array)(...e)},e.resetNativeF16Array=function(){t=globalThis.Float16Array,e.hasNativeFloat16Array=!!t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/buffer/BufferView":function(){define(["exports","../float16","./internals/Mat3","./internals/Mat4","./internals/Scalar","./internals/Vec2","./internals/Vec3","./internals/Vec4","../../../views/3d/webgl-engine/lib/Util"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends s.BufferViewScalarImpl{constructor(e,r=0,i,s){l.assert(t.hasNativeFloat16Array),super(t.getFloat16ArrayConstructor(),e,r,i,s),this.elementType="f16"}static{this.ElementType="f16"}}class u extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}static{this.ElementType="f32"}}class d extends n.BufferViewVec2Impl{constructor(e,r=0,i,s){l.assert(t.hasNativeFloat16Array),super(t.getFloat16ArrayConstructor(),e,r,i,s),this.elementType="f16"}slice(e,t){return this.sliceBuffer(d,e,t)}static{this.ElementType="f16"}}class h extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(h,e,t)}static{this.ElementType="f32"}}class p extends o.BufferViewVec3Impl{constructor(e,r=0,i,s){l.assert(t.hasNativeFloat16Array),super(t.getFloat16ArrayConstructor(),e,r,i,s),this.elementType="f16"}slice(e,t){return this.sliceBuffer(p,e,t)}static{this.ElementType="f16"}}class m extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(m,e,t)}static fromTypedArray(e,t){return new m(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}static{this.ElementType="f32"}}class f extends a.BufferViewVec4Impl{constructor(e,r=0,i,s){l.assert(t.hasNativeFloat16Array),super(t.getFloat16ArrayConstructor(),e,r,i,s),this.elementType="f16"}slice(e,t){return this.sliceBuffer(f,e,t)}static{this.ElementType="f16"}}class g extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(g,e,t)}static{this.ElementType="f32"}}class y extends r.BufferViewMat3Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(y,e,t)}static{this.ElementType="f32"}}class _ extends r.BufferViewMat3Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(_,e,t)}static{this.ElementType="f64"}}class b extends i.BufferViewMat4Impl{constructor(e,t=0,r,i){super(Float32Array,e,t,r,i),this.elementType="f32"}slice(e,t){return this.sliceBuffer(b,e,t)}static{this.ElementType="f32"}}class v extends i.BufferViewMat4Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(v,e,t)}static{this.ElementType="f64"}}class S extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(S,e,t)}static{this.ElementType="f64"}}class w extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(w,e,t)}static{this.ElementType="f64"}}class x extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(x,e,t)}static fromTypedArray(e,t){return new x(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}static{this.ElementType="f64"}}class T extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Float64Array,e,t,r,i),this.elementType="f64"}slice(e,t){return this.sliceBuffer(T,e,t)}static{this.ElementType="f64"}}class C extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Uint8Array,e,t,r,i),this.elementType="u8"}slice(e,t){return this.sliceBuffer(C,e,t)}static{this.ElementType="u8"}}class P extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Uint8Array,e,t,r,i),this.elementType="u8"}slice(e,t){return this.sliceBuffer(P,e,t)}static{this.ElementType="u8"}}class M extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Uint8Array,e,t,r,i),this.elementType="u8"}slice(e,t){return this.sliceBuffer(M,e,t)}static fromTypedArray(e,t){return new M(e.buffer,e.byteOffset,t,e.byteOffset+e.byteLength)}static{this.ElementType="u8"}}class R extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Uint8Array,e,t,r,i),this.elementType="u8"}slice(e,t){return this.sliceBuffer(R,e,t)}static{this.ElementType="u8"}}class E extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Uint16Array,e,t,r,i),this.elementType="u16"}slice(e,t){return this.sliceBuffer(E,e,t)}static{this.ElementType="u16"}}class O extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Uint16Array,e,t,r,i),this.elementType="u16"}slice(e,t){return this.sliceBuffer(O,e,t)}static{this.ElementType="u16"}}class A extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Uint16Array,e,t,r,i),this.elementType="u16"}slice(e,t){return this.sliceBuffer(A,e,t)}static{this.ElementType="u16"}}class I extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Uint16Array,e,t,r,i),this.elementType="u16"}slice(e,t){return this.sliceBuffer(I,e,t)}static{this.ElementType="u16"}}class D extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Uint32Array,e,t,r,i),this.elementType="u32"}slice(e,t){return this.sliceBuffer(D,e,t)}static{this.ElementType="u32"}}class F extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Uint32Array,e,t,r,i),this.elementType="u32"}slice(e,t){return this.sliceBuffer(F,e,t)}static{this.ElementType="u32"}}class L extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Uint32Array,e,t,r,i),this.elementType="u32"}slice(e,t){return this.sliceBuffer(L,e,t)}static{this.ElementType="u32"}}class N extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Uint32Array,e,t,r,i),this.elementType="u32"}slice(e,t){return this.sliceBuffer(N,e,t)}static{this.ElementType="u32"}}class U extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Int8Array,e,t,r,i),this.elementType="i8"}slice(e,t){return this.sliceBuffer(U,e,t)}static{this.ElementType="i8"}}class V extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Int8Array,e,t,r,i),this.elementType="i8"}slice(e,t){return this.sliceBuffer(V,e,t)}static{this.ElementType="i8"}}class B extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Int8Array,e,t,r,i),this.elementType="i8"}slice(e,t){return this.sliceBuffer(B,e,t)}static{this.ElementType="i8"}}class G extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Int8Array,e,t,r,i),this.elementType="i8"}slice(e,t){return this.sliceBuffer(G,e,t)}static{this.ElementType="i8"}}class k extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Int16Array,e,t,r,i),this.elementType="i16"}slice(e,t){return this.sliceBuffer(k,e,t)}static{this.ElementType="i16"}}class z extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Int16Array,e,t,r,i),this.elementType="i16"}slice(e,t){return this.sliceBuffer(z,e,t)}static{this.ElementType="i16"}}class j extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Int16Array,e,t,r,i),this.elementType="i16"}slice(e,t){return this.sliceBuffer(j,e,t)}static{this.ElementType="i16"}}class q extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Int16Array,e,t,r,i),this.elementType="i16"}slice(e,t){return this.sliceBuffer(q,e,t)}static{this.ElementType="i16"}}class H extends s.BufferViewScalarImpl{constructor(e,t=0,r,i){super(Int32Array,e,t,r,i),this.elementType="i32"}slice(e,t){return this.sliceBuffer(H,e,t)}static{this.ElementType="i32"}}class W extends n.BufferViewVec2Impl{constructor(e,t=0,r,i){super(Int32Array,e,t,r,i),this.elementType="i32"}slice(e,t){return this.sliceBuffer(W,e,t)}static{this.ElementType="i32"}}class $ extends o.BufferViewVec3Impl{constructor(e,t=0,r,i){super(Int32Array,e,t,r,i),this.elementType="i32"}slice(e,t){return this.sliceBuffer($,e,t)}static{this.ElementType="i32"}}class Q extends a.BufferViewVec4Impl{constructor(e,t=0,r,i){super(Int32Array,e,t,r,i),this.elementType="i32"}slice(e,t){return this.sliceBuffer(Q,e,t)}static{this.ElementType="i32"}}e.BufferViewFloat=u,e.BufferViewFloat16=c,e.BufferViewFloat64=S,e.BufferViewInt16=k,e.BufferViewInt32=H,e.BufferViewInt8=U,e.BufferViewMat3f=y,e.BufferViewMat3f64=_,e.BufferViewMat4f=b,e.BufferViewMat4f64=v,e.BufferViewUint16=E,e.BufferViewUint32=D,e.BufferViewUint8=C,e.BufferViewVec2f=h,e.BufferViewVec2f16=d,e.BufferViewVec2f64=w,e.BufferViewVec2i16=z,e.BufferViewVec2i32=W,e.BufferViewVec2i8=V,e.BufferViewVec2u16=O,e.BufferViewVec2u32=F,e.BufferViewVec2u8=P,e.BufferViewVec3f=m,e.BufferViewVec3f16=p,e.BufferViewVec3f64=x,e.BufferViewVec3i16=j,e.BufferViewVec3i32=$,e.BufferViewVec3i8=B,e.BufferViewVec3u16=A,e.BufferViewVec3u32=L,e.BufferViewVec3u8=M,e.BufferViewVec4f=g,e.BufferViewVec4f16=f,e.BufferViewVec4f64=T,e.BufferViewVec4i16=q,e.BufferViewVec4i32=Q,e.BufferViewVec4i8=G,e.BufferViewVec4u16=I,e.BufferViewVec4u32=N,e.BufferViewVec4u8=R,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/buffer/internals/Mat3":function(){define(["exports"],(function(e){"use strict";class t{static{this.ElementCount=9}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.elementCount=9;const n=this.TypedArrayConstructor;void 0===i&&(i=9*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getMat(e,t){let r=e*this.typedBufferStride;for(let e=0;e<9;e++)t[e]=this.typedBuffer[r++];return t}setMat(e,t){let r=e*this.typedBufferStride;for(let e=0;e<9;e++)this.typedBuffer[r++]=t[e]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}copyFrom(e,t,r){const i=this.typedBuffer,s=t.typedBuffer;let n=e*this.typedBufferStride,o=r*t.typedBufferStride;for(let e=0;e<9;++e)i[n++]=s[o++]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewMat3Impl=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/buffer/internals/Mat4":function(){define(["exports"],(function(e){"use strict";class t{static{this.ElementCount=16}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.elementCount=16;const n=this.TypedArrayConstructor;void 0===i&&(i=16*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getMat(e,t){let r=e*this.typedBufferStride;for(let e=0;e<16;e++)t[e]=this.typedBuffer[r++];return t}setMat(e,t){let r=e*this.typedBufferStride;for(let e=0;e<16;e++)this.typedBuffer[r++]=t[e]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}copyFrom(e,t,r){this.copyFromTypedBuffer(e,t.typedBuffer,r*t.typedBufferStride)}copyFromTypedBuffer(e,t,r){const i=this.typedBuffer;let s=e*this.typedBufferStride;for(let e=0;e<16;++e)i[s++]=t[r++]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewMat4Impl=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/buffer/internals/Scalar":function(){define(["exports"],(function(e){"use strict";class t{static{this.ElementCount=1}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.elementCount=1;const n=this.TypedArrayConstructor;void 0===i&&(i=n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.stride=i,this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride)}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}get(e){return this.typedBuffer[e*this.typedBufferStride]}set(e,t){this.typedBuffer[e*this.typedBufferStride]=t}get buffer(){return this.typedBuffer.buffer}}e.BufferViewScalarImpl=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/buffer/internals/Vec2":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/vec2"],(function(e,t){"use strict";class r{static{this.ElementCount=2}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.start=r,this.elementCount=2;const n=this.TypedArrayConstructor;void 0===i&&(i=2*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getVec(e,r){return e*=this.typedBufferStride,t.set(r,this.typedBuffer[e],this.typedBuffer[e+1])}setVec(e,t){e*=this.typedBufferStride,this.typedBuffer[e++]=t[0],this.typedBuffer[e]=t[1]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}setValues(e,t,r){e*=this.typedBufferStride,this.typedBuffer[e++]=t,this.typedBuffer[e]=r}copyFrom(e,t,r){const i=this.typedBuffer,s=t.typedBuffer;let n=e*this.typedBufferStride,o=r*t.typedBufferStride;i[n++]=s[o++],i[n]=s[o]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewVec2Impl=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/buffer/internals/Vec3":function(){define(["exports","../../../../chunks/vec32"],(function(e,t){"use strict";class r{static{this.ElementCount=3}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.elementCount=3;const n=this.TypedArrayConstructor;void 0===i&&(i=3*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getVec(e,r){return e*=this.typedBufferStride,t.set(r,this.typedBuffer[e],this.typedBuffer[e+1],this.typedBuffer[e+2])}setVec(e,t){e*=this.typedBufferStride,this.typedBuffer[e++]=t[0],this.typedBuffer[e++]=t[1],this.typedBuffer[e]=t[2]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}setValues(e,t,r,i){e*=this.typedBufferStride,this.typedBuffer[e++]=t,this.typedBuffer[e++]=r,this.typedBuffer[e]=i}copyFrom(e,t,r){const i=this.typedBuffer,s=t.typedBuffer;let n=e*this.typedBufferStride,o=r*t.typedBufferStride;i[n++]=s[o++],i[n++]=s[o++],i[n]=s[o]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewVec3Impl=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/buffer/internals/Vec4":function(){define(["exports","../../../../chunks/vec42"],(function(e,t){"use strict";class r{static{this.ElementCount=4}constructor(e,t,r=0,i,s){this.TypedArrayConstructor=e,this.start=r,this.elementCount=4;const n=this.TypedArrayConstructor;void 0===i&&(i=4*n.BYTES_PER_ELEMENT);const o=0===t.byteLength?0:r;this.typedBuffer=null==s?new n(t,o):new n(t,o,(s-r)/n.BYTES_PER_ELEMENT),this.typedBufferStride=i/n.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,t,r=this.count-t){const i=this.typedBuffer.byteOffset+t*this.stride;return new e(this.buffer,i,this.stride,i+r*this.stride)}getVec(e,r){return e*=this.typedBufferStride,t.set(r,this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e])}setVec(e,t){e*=this.typedBufferStride,this.typedBuffer[e++]=t[0],this.typedBuffer[e++]=t[1],this.typedBuffer[e++]=t[2],this.typedBuffer[e]=t[3]}get(e,t){return this.typedBuffer[e*this.typedBufferStride+t]}set(e,t,r){this.typedBuffer[e*this.typedBufferStride+t]=r}setValues(e,t,r,i,s){e*=this.typedBufferStride,this.typedBuffer[e++]=t,this.typedBuffer[e++]=r,this.typedBuffer[e++]=i,this.typedBuffer[e]=s}copyFrom(e,t,r){const i=this.typedBuffer,s=t.typedBuffer;let n=e*this.typedBufferStride,o=r*t.typedBufferStride;i[n++]=s[o++],i[n++]=s[o++],i[n++]=s[o++],i[n]=s[o]}get buffer(){return this.typedBuffer.buffer}}e.BufferViewVec4Impl=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Util":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64"],(function(e,t,r,i){"use strict";const s=i.create();class n{constructor(e){this.message=e}toString(){return`AssertException: ${this.message}`}}function o(e,t="Assertion"){if(!e){const e=new Error(t).stack;throw new n(`${t} at ${e}`)}}e.assert=o,e.isTranslationMatrix=function(e){return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&1===e[15]},e.logWithBase=function(e,t){return Math.log(e)/Math.log(t)},e.project=function(e,t,i,n,a){s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1,r.transformMat4(s,s,t),a.length>2&&(a[2]=-s[2]),r.transformMat4(s,s,i),o(0!==s[3]),a[0]=s[0]/s[3],a[1]=s[1]/s[3],a[2]=s[2]/s[3],a[0]=(.5*a[0]+.5)*n[2]+n[0],a[1]=(.5*a[1]+.5)*n[3]+n[1]},e.rayBoxTest=function(e,t,r,i){let s,n=(r[0]-e[0])/t[0],o=(i[0]-e[0])/t[0];n>o&&(s=n,n=o,o=s);let a=(r[1]-e[1])/t[1],l=(i[1]-e[1])/t[1];if(a>l&&(s=a,a=l,l=s),n>l||a>o)return!1;a>n&&(n=a),l<o&&(o=l);let c=(r[2]-e[2])/t[2],u=(i[2]-e[2])/t[2];return c>u&&(s=c,c=u,u=s),!(n>u||c>o||(u<o&&(o=u),o<0))},e.rayRay2D=function(e,r,i,s,n,o=t.create()){const a=(s[n]-i[n])*(r[0]-e[0])-(s[0]-i[0])*(r[n]-e[n]),l=(s[0]-i[0])*(e[n]-i[n])-(s[n]-i[n])*(e[0]-i[0]);if(0===a)return!1;const c=l/a;return o[0]=e[0]+c*(r[0]-e[0]),o[1]=e[n]+c*(r[n]-e[n]),!0},e.setMatrixTranslation3=function(e,t,r,i){e[12]=t,e[13]=r,e[14]=i},e.verify=function(e,t){e||(t=t||"",console.warn("Verify failed: "+t+"\n"+new Error("verify").stack))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/buffer/types":function(){define(["exports"],(function(e){"use strict";e.elementTypeSize=function(e){switch(e){case"u8":case"i8":return 1;case"u16":case"i16":case"f16":return 2;case"u32":case"i32":case"f32":return 4;case"f64":return 8}},e.isInteger=function(e){switch(e){case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":return!0;case"f16":case"f32":case"f64":return!1}},e.isSigned=function(e){switch(e){case"u8":case"u16":case"u32":return!1;case"i8":case"i16":case"i32":case"f16":case"f32":case"f64":return!0}},e.maximumValue=function(e){switch(e){case"u8":return 255;case"u16":return 65535;case"u32":return 4294967295;case"i8":return 127;case"i16":return 32767;case"i32":return 2147483647;case"f16":return 65504;case"f32":return 3402823e32;case"f64":return 179769e303}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/TransparentEnvironment":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../webgl","./OpaqueEnvironment","../lib/basicInterfaces"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";e.TransparentEnvironment=class extends l.OpaqueEnvironment{constructor(){super(...arguments),this.consumes={required:[a.InternalRenderCategory.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=a.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,this.requestRender(c.RenderRequestType.UPDATE)}},t.__decorate([r.property()],e.TransparentEnvironment.prototype,"consumes",void 0),e.TransparentEnvironment=t.__decorate([o.subclass("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],e.TransparentEnvironment),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/OpaqueEnvironment":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../webgl","../../webgl/RenderNode","../lib/basicInterfaces"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";e.OpaqueEnvironment=class extends l{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[a.InternalRenderCategory.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=a.InternalRenderCategory.OPAQUE_ENVIRONMENT,this.requestRender(c.RenderRequestType.UPDATE)}_disable(){this.produces="disabled",this.requestRender(c.RenderRequestType.UPDATE)}},t.__decorate([r.property()],e.OpaqueEnvironment.prototype,"produces",void 0),t.__decorate([r.property()],e.OpaqueEnvironment.prototype,"consumes",void 0),e.OpaqueEnvironment=t.__decorate([o.subclass("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],e.OpaqueEnvironment),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl/RenderNode":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Error","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../webgl","../webgl-engine/lib/basicInterfaces"],(function(e,t,r,i,s,n,o,a,l){"use strict";return e.default=class extends r{constructor(e){super(e),this.view=null,this.consumes={required:[]},this.produces=a.RenderCategory.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([s.watch((()=>this.view.ready),(e=>{e&&this.view.stage?.renderer.addRenderNode(this)}),s.initial)])}destroy(){this.view.stage?.renderer?.removeRenderNode(this)}precompile(){}render(){throw new i("RenderNode:render-function-not-implemented","render() is not implemented.")}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view.stage.renderView.renderingContext.gl}get techniques(){return this.view.stage.renderView.techniques}acquireOutputFramebuffer(){const e=this._frameBuffer?.getTexture()?.descriptor,t=this.view.stage.renderer.fboCache.acquire(e?.width??640,e?.height??480,this.produces);return t.fbo?.initializeAndBind(),t}bindRenderTarget(){return this._frameBuffer?.fbo?.initializeAndBind(),this._frameBuffer}requestRender(e){e===l.RenderRequestType.UPDATE&&this.view.stage?.renderView.requestRender(e),this._dirty=!0}resetWebGLState(){this.renderingContext.resetState(),this.renderingContext.bindFramebuffer(this._frameBuffer?.fbo)}get fboCache(){return this.view.stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view.stage.renderView.renderingContext}get renderContext(){return this.view.stage?.renderer.renderContext}updateAnimation(e){return!!this._dirty&&(this._dirty=!1,!0)}doRender(e){this._frameBuffer=e.find((({name:e})=>e===this.produces));try{return this.render(e)}finally{this._frameBuffer=null}}},t.__decorate([n.property({constructOnly:!0})],e.default.prototype,"view",void 0),t.__decorate([n.property({constructOnly:!0})],e.default.prototype,"consumes",void 0),t.__decorate([n.property()],e.default.prototype,"produces",void 0),t.__decorate([n.property({readOnly:!0})],e.default.prototype,"techniques",null),e.default=t.__decorate([o.subclass("esri.views.3d.webgl.RenderNode")],e.default),e.default}))},"esri/views/3d/webgl-engine/lib/VertexArrayObject":function(){define(["exports","../../../webgl/VertexArrayObject"],(function(e,t){"use strict";class r extends t.VertexArrayObject{}e.VertexArrayObject=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/VertexArrayObject":function(){define(["exports","../../core/Logger","../../core/maybe","../../core/memoryEstimations","./enums","./Util"],(function(e,t,r,i,s,n){"use strict";const o=()=>t.getLogger("esri.views.webgl.VertexArrayObject");e.VertexArrayObject=class{constructor(e,t,r,i,s=null){this._context=e,this._locations=t,this._layout=r,this._buffers=i,this._indexBuffer=s,this._glName=null,this._initialized=!1}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}getByteLength(e){return this._buffers.get(e)?.usedMemory??0}get layout(){return this._layout}get locations(){return this._locations}get usedMemory(){return Array.from(this._buffers.values()).reduce(((e,t)=>e+t.usedMemory),this._indexBuffer?.usedMemory??0+(this._buffers.size+(this._indexBuffer?1:0))*i.baseTypedArrayMemory)}get cachedMemory(){return this.usedMemory}dispose(){this._context?(this._context.getBoundVAO()===this&&this._context.bindVAO(null),this._buffers.forEach((e=>e.dispose())),this._buffers.clear(),this._indexBuffer=r.disposeMaybe(this._indexBuffer),this.disposeVAOOnly()):(this._glName||this._buffers.size>0)&&o().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(s.ResourceType.VertexArrayObject,this)),this._context=null}initialize(){if(this._initialized)return;const{gl:e}=this._context,t=e.createVertexArray();e.bindVertexArray(t),this._bindLayout(),e.bindVertexArray(null),this._glName=t,this._context.instanceCounter.increment(s.ResourceType.VertexArrayObject,this),this._initialized=!0}bind(){this.initialize(),this._context.gl.bindVertexArray(this.glName)}_bindLayout(){const{_buffers:e,_layout:t,_indexBuffer:r}=this;e||o().error("Vertex buffer dictionary is empty!");const i=this._context.gl;this._buffers.forEach(((e,r)=>{const i=t.get(r);i?n.bindVertexBufferLayout(this._context,this._locations,e,i):o().error("Vertex element descriptor is empty!")})),null!=r&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,r.glName)}unbind(){this.initialize(),this._context.gl.bindVertexArray(null)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/weather":function(){define(["exports","./CloudyWeather","./FoggyWeather","./RainyWeather","./SnowyWeather","./SunnyWeather"],(function(e,t,r,i,s,n){"use strict";const o={key:"type",base:n,typeMap:{sunny:n,cloudy:t,rainy:i,snowy:s,foggy:r}},a=Object.keys(o.typeMap);e.cloudsHeight=1e5,e.heightLimit=1e4,e.validateWeatherType=function(e,t){return!!a.includes(e)||(t.error(`"${e}" is not a valid weather type`),!1)},e.weatherTypes=o,e.weatherTypesArray=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/CloudyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new l({cloudCover:this.cloudCover})}};return e.__decorate([o.enumeration({cloudy:"cloudy"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.CloudyWeather")],c),c}))},"esri/views/3d/environment/FoggyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new l({fogStrength:this.fogStrength})}};return e.__decorate([o.enumeration({foggy:"foggy"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"fogStrength",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.FoggyWeather")],c),c}))},"esri/views/3d/environment/RainyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new l({cloudCover:this.cloudCover,precipitation:this.precipitation})}};return e.__decorate([o.enumeration({rainy:"rainy"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"precipitation",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.RainyWeather")],c),c}))},"esri/views/3d/environment/SnowyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new l({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};return e.__decorate([o.enumeration({snowy:"snowy"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"precipitation",void 0),e.__decorate([r.property({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],c.prototype,"snowCover",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.SnowyWeather")],c),c}))},"esri/views/3d/environment/SunnyWeather":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends t{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new l({cloudCover:this.cloudCover})}};return e.__decorate([o.enumeration({sunny:"sunny"}),r.property({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),c=l=e.__decorate([a.subclass("esri.views.3d.environment.SunnyWeather")],c),c}))},"esri/views/3d/webgl-engine/effects/RenderPlugin":function(){define(["exports","../../../../core/Accessor","../core/shaderLibrary/ShaderOutput","../lib/Material"],(function(e,t,r,i){"use strict";const s={required:[]},n={required:[r.ShaderOutput.Depth]};class o extends t{precompile(e){return!!this.acquireTechniques(e)}consumes(){return s}get usedMemory(){return 0}get renderOccludedFlags(){return i.RenderOccludedFlag.Occlude}get isDecoration(){return!1}get running(){return!1}modify(e,t){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}}e.AsyncRenderPlugin=class extends o{},e.ConsumesDepth=n,e.ConsumesNone=s,e.SyncRenderPlugin=class extends o{},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Material":function(){define(["exports","../../../../core/uid","../core/shaderLibrary/ShaderOutput","./DefaultVertexAttributeLocations","../materials/DefaultTechniqueConfiguration","../materials/internal/MaterialUtil","../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o){"use strict";var a;e.RenderOccludedFlag=void 0,(a=e.RenderOccludedFlag||(e.RenderOccludedFlag={}))[a.None=0]="None",a[a.Occlude=1]="Occlude",a[a.Transparent=2]="Transparent",a[a.OccludeAndTransparent=4]="OccludeAndTransparent",a[a.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",a[a.Opaque=16]="Opaque";class l extends o.NoParameters{constructor(){super(...arguments),this.renderOccluded=e.RenderOccludedFlag.Occlude,this.isDecoration=!1}}e.Material=class{constructor(e,r){this.id=t.generateUID(),this.supportsEdges=!1,this.vertexAttributeLocations=i.Default3D,this._renderPriority=0,this._parameters=new r,n.updateParameters(this._parameters,e),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(e){return!1}setParameters(e,t=!0){n.updateParameters(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this._parametersChanged())}validateParameters(e){}shouldRender(e){return this.visible&&this.isVisibleForOutput(e.output)&&(!this.parameters.isDecoration||e.bind.decorations)&&0!==(this.parameters.renderOccluded&e.renderOccludedMask)}isVisibleForOutput(e){return!0}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this._parametersChanged())}_parametersChanged(){this.repository?.materialChanged(this)}get renderOccludedFlags(){return this.visible?this.parameters.renderOccluded:e.RenderOccludedFlag.None}get hasEmissions(){return!1}getConfiguration(e,t,i=new s.DefaultTechniqueConfiguration){return i.output=e,i.hasHighlightMixTexture=e===r.ShaderOutput.Highlight&&null!=t.highlightMixTexture,i}},e.MaterialParameters=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/DefaultTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/attributes/InstancedDoubleConfiguration","../core/shaderTechnique/ShaderTechniqueConfiguration","../lib/OITPass","../../../webgl/BindType"],(function(e,t,r,i,s,n,o){"use strict";class a extends i.InstancedDoubleConfiguration{constructor(){super(...arguments),this.output=r.ShaderOutput.Color,this.oitPass=n.OITPass.NONE,this.hasSlicePlane=!1,this.hasHighlightMixTexture=!1,this.bindType=o.BindType.Pass,this.writeDepth=!0}}t.__decorate([s.parameter({count:r.ShaderOutput.COUNT})],a.prototype,"output",void 0),t.__decorate([s.parameter({count:n.OITPass.COUNT})],a.prototype,"oitPass",void 0),t.__decorate([s.parameter()],a.prototype,"hasSlicePlane",void 0),t.__decorate([s.parameter()],a.prototype,"hasHighlightMixTexture",void 0),e.DefaultTechniqueConfiguration=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/InstancedDoubleConfiguration":function(){define(["exports","../../shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t){"use strict";class r extends t.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}}e.InstancedDoubleConfiguration=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/OITPass":function(){define(["exports"],(function(e){"use strict";var t;e.OITPass=void 0,(t=e.OITPass||(e.OITPass={}))[t.NONE=0]="NONE",t[t.ColorAlpha=1]="ColorAlpha",t[t.FrontFace=2]="FrontFace",t[t.COUNT=3]="COUNT",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/internal/MaterialUtil":function(){define(["exports","../../../../../core/arrayUtils","../../../../../core/mathUtils","../../lib/screenSizePerspectiveUtils"],(function(e,t,r,i){"use strict";e.colorMixModes={multiply:1,ignore:2,replace:3,tint:4},e.updateParameters=function(e,r){let i=!1;for(const s in r){const n=r[s];void 0!==n&&(Array.isArray(n)?Array.isArray(e[s])&&t.equals(n,e[s])||(e[s]=n.slice(),i=!0):e[s]!==n&&(i=!0,e[s]=n))}return i},e.verticalOffsetAtDistance=function(e,t,s,n,o){let a=(s.screenLength||0)*e.pixelRatio;null!=o&&(a=i.scale(a,n,t,o));const l=a*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return r.clamp(l*t,s.minWorldLength||0,null!=s.maxWorldLength?s.maxWorldLength:1/0)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/screenSizePerspectiveUtils":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/boundedPlane","../../../../chunks/sphere","../../../ViewingMode"],(function(e,t,r,i,s){"use strict";function n(e,t,r){const i=r.parameters;return d.scale=Math.min(i.divisor/(t-i.offset),1),d.factor=function(e){return Math.abs(e*e*e)}(e),d}function o(e,r){return t.lerp(e*Math.max(r.scale,r.minScaleFactor),e,r.factor)}class a{get minScaleFactor(){return null!=this._fontHeight?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(e,t,r,i={camera:{distance:0,fovY:0},divisor:0,offset:0},n){this._viewingMode=e,this._description=t,this._ellipsoidRadius=r,this.parameters=i,this._fontHeight=n,this._viewingMode===s.ViewingMode.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return!(this.parameters&&this.parameters.camera.fovY===e.fovY&&this.parameters.camera.distance===e.distance||(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),0))}overrideFontHeight(e){return e!==this._fontHeight?new a(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,r){const{scaleStart:i,scaleFallOffRange:s}=this._description,{fovY:n,distance:o}=e,a=this._calculateCurvatureDependentParameters(e,t),l=this._coverageCompensation(e,t,a),{tiltAngle:c,scaleFallOffFactor:u}=a,d=Math.sin(c)*o,h=.5*Math.PI-c-n*(.5-i*l),p=d/Math.cos(h),m=h+n*s*l,f=(p-u*(d/Math.cos(m)))/(1-u);return r.camera.fovY=e.fovY,r.camera.distance=e.distance,r.offset=f,r.divisor=p-f,r}_calculateCurvatureDependentParametersLocal(e,t,r=h){return r.tiltAngle=this._description.curvatureDependent.min.tiltAngle,r.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,r}_calculateCurvatureDependentParametersGlobal(e,r,i=h){const s=this._description.curvatureDependent,n=1+e.distance/r,o=Math.sqrt(n*n-1),[a,l]=[s.min.curvature,s.max.curvature],c=t.clamp((o-a)/(l-a),0,1),[u,d]=[s.min,s.max];return i.tiltAngle=t.lerp(u.tiltAngle,d.tiltAngle,c),i.scaleFallOffFactor=t.lerp(u.scaleFallOffFactor,d.scaleFallOffFactor,c),i}_surfaceCoverageCompensationLocal(e,t,i){return r.cameraFrustumCoverage(i.tiltAngle,e.fovY)}_surfaceCoverageCompensationGlobal(e,t,r){return i.fromRadius(p,t),i.cameraFrustumCoverage(p,r.tiltAngle,e.distance,e.fovY)}}const l={curvatureDependent:{min:{curvature:t.deg2rad(10),tiltAngle:t.deg2rad(12),scaleFallOffFactor:.5},max:{curvature:t.deg2rad(70),tiltAngle:t.deg2rad(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},c={scaleFallOffFactor:.7},u={scaleFallOffFactor:.95},d={scale:0,factor:0,minScaleFactor:0},h={tiltAngle:0,scaleFallOffFactor:0},p=i.create();e.applyPrecomputedScaleFactor=function(e,t,r=[0,0]){const i=Math.min(Math.max(t.scale,t.minScaleFactor),1);return r[0]=e[0]*i,r[1]=e[1]*i,r},e.applyScaleFactor=o,e.getLabelSettings=function(e,t){const{curvatureDependent:r,scaleStart:i,scaleFallOffRange:s}=l;return new a(e,{curvatureDependent:{min:{curvature:r.min.curvature,tiltAngle:r.min.tiltAngle,scaleFallOffFactor:c.scaleFallOffFactor},max:{curvature:r.max.curvature,tiltAngle:r.max.tiltAngle,scaleFallOffFactor:u.scaleFallOffFactor}},scaleStart:i,scaleFallOffRange:s,minPixelSize:14},t)},e.getSettings=function(e,t){return new a(e,l,t)},e.precomputeScaleFactor=function(e,t,r,i){i.scale=function(e,t,r){const i=n(e,t,r);return i.minScaleFactor=0,o(1,i)}(e,t,r),i.factor=0,i.minScaleFactor=r.minScaleFactor},e.scale=function(e,t,r,i){return o(e,n(t,r,i))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/sunUtils":function(){define(["exports","../../../core/Logger","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../ViewingMode","../../../chunks/SunCalc","./mathUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class p{constructor(e,t){this.direct=e,this.ambient=t}}function m(e,t,r){t===c.ViewingMode.Global?a.normalize(k,e.eye):a.set(k,0,0,1),a.scale(z,e.viewForward,-1);const s=d.angle(z,k),n=Math.max(s-2*q,0),o=.85*n/(n+1),l=Math.max(q,s-q-o);i.fromRotation(G,-l,e.viewRight),a.transformMat4(r,z,G),a.add(r,r,a.scale(j,e.viewRight,H)),a.normalize(r,r)}function f(e,t,s,n){const o=_,l=i.identity(y);if(s===c.ViewingMode.Global)u.SunCalc.getPosition(e,0,0,o),a.set(n,0,0,-1),i.rotateX(l,l,-o.azimuth),i.rotateY(l,l,-o.altitude),a.transformMat4(n,n,l);else{const s=h.planarDirection,c=s.globalAngles,d=t[2];let p=(Math.abs(d)-s.localAltitude)/(s.globalAltitude-s.localAltitude);p=r.clamp(p,0,1),p<1?(u.SunCalc.getPosition(e,t[1],t[0],o),o.azimuth=(1-p)*o.azimuth+p*c.azimuth,o.altitude=(1-p)*o.altitude+p*c.altitude):(o.azimuth=c.azimuth,o.altitude=c.altitude),a.set(n,0,-1,0),i.rotateZ(l,l,-o.azimuth),i.rotateX(l,l,-o.altitude),a.transformMat4(n,n,l)}}const g=l.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258),y=s.create(),_={azimuth:0,altitude:0};function b(e){switch(e){case"disabled":case"sunny":case"cloudy":return new p(1,1);case"rainy":return new p(.4,1.2);case"snowy":return new p(.5,1.3);case"foggy":return new p(.2,1.6)}}function v(e,t){const r=(e[0]+e[1]+e[2])/3;e[0]+=(r-e[0])*t,e[1]+=(r-e[1])*t,e[2]+=(r-e[2])*t}const S=l.fromValues(.01,.01,.01),w=l.fromValues(1,.6,.5),x=l.fromValues(1,.98,.98),T=l.fromValues(1,1,1),C=l.fromValues(.8,.8,1),P=l.fromValues(.8,.8,1),M=l.fromValues(.98,.98,1),R=l.fromValues(1,1,1),E=o.fromValues(.01,h.local.ambientAtNight),O=o.fromValues(h.local.directAtTwilight,h.local.ambientAtTwilight),A=o.fromValues(.9*h.local.directAtNoon,h.local.ambientAtNoon),I=o.fromValues(h.local.directAtNoon,h.local.ambientAtNoon),D=A,F=x,L=M,N=O,U=w,V=P,B=new Date(0),G=s.create(),k=l.create(),z=l.create(),j=l.create(),q=.25,H=.2;e.ColorAndIntensity=class{constructor(){this.ambient={color:l.fromValues(1,1,1),intensity:.55},this.direct={color:l.fromValues(1,1,1),intensity:.55,directionToLightSource:l.clone(g)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}},e.computeColorAndIntensity=function(e,t,i,s,c,d){a.set(d.ambient.color,1,1,1),d.ambient.intensity=h.global.ambient,a.set(d.direct.color,1,1,1),d.direct.intensity=h.global.direct;const p=t[2],g=r.clamp((Math.abs(p)-h.local.altitude)/(h.global.altitude-h.local.altitude),0,1);let y;if(d.globalFactor=g,null!=e&&(y=u.SunCalc.getTimes(e,t[1],t[0])),g<1){let t;if(null!=e)t=function(e,t,r){const i=e.valueOf();let s,c;t.polarException===u.SunCalc.PolarException.MIDNIGHT_SUN?(s=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,c=s+432e6):t.polarException===u.SunCalc.PolarException.POLAR_NIGHT?(s=i-2,c=i-1):(s=t.sunrise.valueOf(),c=t.sunset.valueOf());const d=c-s,h=s+d/2,p=d/4,m=h-p,f=h+p,g=.06*d,y=s-g/2,_=s+g/2,B=c-g/2,G=c+g/2,k=o.create(),z=l.create(),j=l.create();let q="";if(i<y||i>G)n.copy(k,E),a.copy(z,S),a.copy(j,C),q="night";else if(i<_){const e=(i-y)/(_-y);n.lerp(k,E,O,e),a.lerp(z,S,w,e),a.lerp(j,C,P,e),q="sun rising"}else if(i<m){const e=(i-_)/(m-_);n.lerp(k,O,A,e),a.lerp(z,w,x,e),a.lerp(j,P,M,e),q="early morning"}else if(i<h){const e=(i-m)/(h-m);n.lerp(k,A,I,e),a.lerp(z,x,T,e),a.lerp(j,M,R,e),q="late morning"}else if(i<f){const e=(i-h)/(f-h);n.lerp(k,I,D,e),a.lerp(z,T,F,e),a.lerp(j,R,L,e),q="early afternoon"}else if(i<B){const e=(i-f)/(B-f);n.lerp(k,D,N,e),a.lerp(z,F,U,e),a.lerp(j,L,V,e),q="late afternoon"}else if(i<G){const e=(i-B)/(G-B);n.lerp(k,N,E,e),a.lerp(z,U,S,e),a.lerp(j,V,C,e),q="sun setting"}let H=0;switch(r){case"rainy":case"foggy":H=.8;break;case"snowy":H=.5}H>0&&(v(z,H),v(j,H));const W=b(r);return{direct:{intensity:k[0]*W.direct,color:z},ambient:{intensity:k[1]*W.ambient,color:j},timeOfDay:q}}(e,y,s);else{const e=b(s);t={direct:{intensity:h.local.directAtNoon*e.direct,color:l.fromValues(1,1,1)},ambient:{intensity:h.local.ambientAtNoon*e.ambient,color:l.fromValues(1,1,1)},timeOfDay:"early afternoon"}}a.lerp(d.ambient.color,t.ambient.color,d.ambient.color,g),d.ambient.intensity=r.lerp(t.ambient.intensity,d.ambient.intensity,g),a.lerp(d.direct.color,t.direct.color,d.direct.color,g),d.direct.intensity=r.lerp(t.direct.intensity,d.direct.intensity,g),d.specularStrength="rainy"===s||"snowy"===s||"foggy"===s?0:1,d.environmentStrength="rainy"===s?.7:"snowy"===s||"foggy"===s?.75:1}d.noonFactor=null!=e?function(e,t){const i=e.valueOf();let s,n;t.polarException===u.SunCalc.PolarException.MIDNIGHT_SUN?(s=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=s+432e6):t.polarException===u.SunCalc.PolarException.POLAR_NIGHT?(s=i-2,n=i-1):(s=t.sunrise.valueOf(),n=t.sunset.valueOf());const o=s+(n-s)/2;return 1-r.clamp(Math.abs(i-o)/432e5,0,1)}(e,y):1,null!=e?f(e,t,i,d.direct.directionToLightSource):m(c,i,d.direct.directionToLightSource)},e.computeDirectionsOverTime=function(e,r,i,s,n,o){const a=e.getTime(),c=Math.max(0,r.getTime()-a),u=Math.floor(c/i)+1,d=Math.min(o,u),h=new Array(d),p=1===d?0:c/(d-1);u>d&&t.getLogger("esri.views.3d.support.sunUtils").warnOnce("computeDirectionsOverTime",`Requested interval ${i} exceeds maximum supported interval of ${Math.floor(p)} based on the provided time range.`);for(let e=0;e<d;++e)B.setTime(a+p*e),h[e]=l.create(),f(B,s,n,h[e]);return h},e.computeShadowsEnabled=function(e,t){if(t===c.ViewingMode.Global)return!0;const r=h.planarDirection;return Math.abs(e)<r.localAltitude},e.computeVirtualLightDirection=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/SunCalc":function(){define(["exports"],(function(e){"use strict";var t=Math.PI,r=Math.sin,i=Math.cos,s=Math.tan,n=Math.asin,o=Math.atan2,a=Math.acos,l=t/180,c=864e5,u=2440588,d=2451545,h={dec:0,ra:0};function p(e){return new Date((e+.5-u)*c)}function m(e){return function(e){return e.valueOf()/c-.5+u}(e)-d}var f=23.4397*l;function g(e,t){return o(r(e)*i(f)-s(t)*r(f),i(e))}function y(e,t){return n(r(t)*i(f)+i(t)*r(f)*r(e))}function _(e,t,n){return o(r(e),i(e)*r(t)-s(n)*i(t))}function b(e,t,s){return n(r(t)*r(s)+i(t)*i(s)*i(e))}function v(e,t){return l*(280.16+360.9856235*e)-t}function S(e){return l*(357.5291+.98560028*e)}function w(e){return l*(1.9148*r(e)+.02*r(2*e)+3e-4*r(3*e))}function x(e,r){return e+r+102.9372*l+t}function T(e,t){var r=S(e),i=x(r,w(r));return t||(t={dec:0,ra:0}),t.dec=y(i,0),t.ra=g(i,0),t}var C={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,r,i){var s=l*-r,n=l*t,o=m(e),a=T(o,h),c=v(o,s)-a.ra;return i||(i={azimuth:0,altitude:0}),i.azimuth=_(c,n,a.dec),i.altitude=b(c,n,a.dec),i}},P=[[-.83,"sunrise","sunset"]];C.addTime=function(e,t,r){P.push([e,t,r])};var M=9e-4;function R(e,r,i){return M+(e+r)/(2*t)+i}function E(e,t,i){return d+e+.0053*r(t)-.0069*r(2*i)}function O(e){var t=l*(134.963+13.064993*e),s=l*(93.272+13.22935*e),n=l*(218.316+13.176396*e)+6.289*l*r(t),o=5.128*l*r(s),a=385001-20905*i(t);return{ra:g(n,o),dec:y(n,o),dist:a}}C.getTimes=function(e,s,n){var o=l*-n,c=l*s,u=function(e,r){return Math.round(e-M-r/(2*t))}(m(e),o),d=R(0,o,u),h=S(d),f=w(h),g=x(h,f),_=y(g,0),b=E(d,h,g);function v(e){var t=function(e,t,s){return a((r(e)-r(t)*r(s))/(i(t)*i(s)))}(e,c,_);return E(R(t,o,u),h,g)}var T,O,A,I,D,F,L,N={solarNoon:p(b),nadir:p(b-.5),polarException:C.PolarException.NORMAL};for(T=0,O=P.length;T<O;T+=1)D=b-((I=v((A=P[T])[0]*l))-b),N[A[1]]=p(D),N[A[2]]=p(I);return N.polarException=(F=P[0][0]*l,(L=(r(F)-r(c)*r(_))/(i(c)*i(_)))<-1?C.PolarException.MIDNIGHT_SUN:L>1?C.PolarException.POLAR_NIGHT:C.PolarException.NORMAL),N},C.getMoonPosition=function(e,t,r){var i=l*-r,n=l*t,o=m(e),a=O(o),c=v(o,i)-a.ra,u=b(c,n,a.dec);return u+=.017*l/s(u+10.26*l/(u+5.1*l)),{azimuth:_(c,n,a.dec),altitude:u,distance:a.dist}},C.getMoonFraction=function(e){var t=m(e),s=T(t),n=O(t),l=149598e3,c=a(r(s.dec)*r(n.dec)+i(s.dec)*i(n.dec)*i(s.ra-n.ra)),u=o(l*r(c),n.dist-l*i(c));return(1+i(u))/2},e.SunCalc=C}))},"esri/views/3d/webgl-engine/lib/Update":function(){define(["exports"],(function(e){"use strict";var t;e.Update=void 0,(t=e.Update||(e.Update={}))[t.Immediate=0]="Immediate",t[t.FadeWithWeather=1]="FadeWithWeather",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lighting/Lightsources":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t){"use strict";e.AmbientLight=class{constructor(e=t.zeros()){this.intensity=e}},e.FillLight=class{constructor(e=t.zeros(),r=t.fromValues(.57735,.57735,.57735)){this.intensity=e,this.direction=r}},e.MainLight=class{constructor(e=t.zeros(),r=t.fromValues(.57735,.57735,.57735),i=!0,s=1,n=1){this.intensity=e,this.direction=r,this.castShadows=i,this.specularStrength=s,this.environmentStrength=n}},e.SphericalHarmonicsAmbientLight=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/SceneViewEnvironment":function(){define(["../../../chunks/tslib.es6","../../../core/compilerUtils","../../../core/handleUtils","../../../core/lang","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/cast","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/ensureType","./lightingUtils","./SunLighting","./VirtualLighting","../../../webscene/Environment","../../../webscene/SunLighting","../../../webscene/VirtualLighting"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";var m;let f=class extends d{static{m=this}constructor(e){super(e),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new m({...t,lighting:t.lighting?"virtual"===t.lighting.type?u.fromWebsceneLighting(t.lighting):c.fromWebsceneLighting(t.lighting):void 0})}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(e){this._computeWeatherAvailable=e}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles(r.destroyHandle(t)),t}_convertLighting(e){return e?e instanceof c||e instanceof u?e:e instanceof h?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new c({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof p?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new u({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):a.ensureOneOfType(l.lightingTypes,e):new c}clone(){return new m({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:i.clone(this.background)})}cloneWithWebsceneEnvironment(e){return new m({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:i.clone(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):c.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):u.fromWebsceneLighting(e.lighting);default:return t.neverReached(e.lighting),c.fromWebsceneLighting(e.lighting)}}};return e.__decorate([s.property({nonNullable:!0})],f.prototype,"lighting",void 0),e.__decorate([s.property()],f.prototype,"_computeWeatherAvailable",void 0),e.__decorate([s.property({readOnly:!0})],f.prototype,"weatherAvailable",null),e.__decorate([n.cast("lighting")],f.prototype,"castLighting",null),f=m=e.__decorate([o.subclass("esri.views.3d.environment.SceneViewEnvironment")],f),f}))},"esri/views/3d/environment/lightingUtils":function(){define(["exports","./SunLighting","./VirtualLighting"],(function(e,t,r){"use strict";const i={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:t,virtual:r}};e.lightingTypes=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/SunLighting":function(){define(["../../../chunks/tslib.es6","../../../core/Evented","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../webscene/SunLighting"],(function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends(t.EventedMixin(a)){constructor(e){super(e),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=(new Date).getFullYear(),r=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",r),this._set("date",r)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new l(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const r=l.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let i=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(i=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(i=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));const s=l.calculateTimezoneOffset(this.positionTimezoneInfo);if(r!==s&&(u.target=this,u.timezoneOffset=s,this.emit("timezone-will-change",u),u.target=null),null!=e)return isNaN(e.getTime())||i!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new l({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};e.__decorate([r.property({type:Boolean})],c.prototype,"cameraTrackingEnabled",void 0),e.__decorate([r.property({type:Date})],c.prototype,"defaultDate",null),e.__decorate([r.property({type:Date})],c.prototype,"date",null),c=l=e.__decorate([o.subclass("esri.views.3d.environment.SunLighting")],c),function(e){e.calculateTimezoneOffset=function({hours:e,minutes:t,seconds:r}){return Math.round(e+t/60+r/3600)}}(c||(c={}));const u={target:null,timezoneOffset:0};return c}))},"esri/webscene/SunLighting":function(){define(["../chunks/tslib.es6","../core/JSONSupport","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/decorators/writer"],(function(e,t,r,i,s,n,o,a,l){"use strict";var c;let u=class extends t{static{c=this}constructor(e){super(e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,r){t[r]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,r){e&&(t[r]=e)}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e)}clone(){return new c(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};return e.__decorate([r.property({readOnly:!0,type:["sun"],json:{write:!0}})],u.prototype,"type",void 0),e.__decorate([r.property({type:Date,json:{type:Number,write:{target:"datetime"}}})],u.prototype,"date",void 0),e.__decorate([o.reader("date",["datetime"])],u.prototype,"readDate",null),e.__decorate([l.writer("date")],u.prototype,"writeDate",null),e.__decorate([r.property({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],u.prototype,"directShadowsEnabled",void 0),e.__decorate([o.reader("directShadowsEnabled",["directShadows"])],u.prototype,"readDirectShadowsEnabled",null),e.__decorate([l.writer("directShadowsEnabled")],u.prototype,"writedirectShadowsEnabled",null),e.__decorate([r.property({type:Number,json:{write:!0}})],u.prototype,"displayUTCOffset",void 0),e.__decorate([l.writer("displayUTCOffset")],u.prototype,"writeDisplayUTCOffset",null),u=c=e.__decorate([a.subclass("esri.webscene.SunLighting")],u),u}))},"esri/views/3d/environment/VirtualLighting":function(){define(["../../../chunks/tslib.es6","../../../core/Evented","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../webscene/VirtualLighting"],(function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends(t.EventedMixin(a)){constructor(e){super(e),this.cameraTrackingEnabled=!0}clone(){return new l({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(e){return new l(e.cloneConstructProperties())}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};return e.__decorate([r.property({type:Boolean})],c.prototype,"cameraTrackingEnabled",void 0),c=l=e.__decorate([o.subclass("esri.views.3d.environment.VirtualLighting")],c),c}))},"esri/webscene/VirtualLighting":function(){define(["../chunks/tslib.es6","../core/JSONSupport","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o){"use strict";var a;let l=class extends t{static{a=this}constructor(e){super(e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new a(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};return e.__decorate([r.property({readOnly:!0,type:["virtual"],json:{write:{isRequired:!0}}})],l.prototype,"type",void 0),e.__decorate([r.property({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],l.prototype,"directShadowsEnabled",void 0),l=a=e.__decorate([o.subclass("esri.webscene.VirtualLighting")],l),l}))},"esri/webscene/Environment":function(){define(["../chunks/tslib.es6","../core/JSONSupport","../core/lang","../core/Logger","../core/accessorSupport/decorators/property","../core/has","../core/accessorSupport/decorators/subclass","../views/3d/environment/SunnyWeather","../views/3d/environment/weather","./lightingTypes","./SunLighting","./VirtualLighting","./background/utils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";var p;const m=(e,t,r)=>({enabled:!r?.isPresentation});let f=class extends t{static{p=this}constructor(e){super(e),this.lighting=new u,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){l.validateWeatherType(e?.type,i.getLogger(this))&&this._set("weather",e)}clone(){return new p(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&"virtual"===this.lighting.type?d.prototype.clone.call(this.lighting):u.prototype.clone.call(this.lighting),background:r.clone(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};return e.__decorate([s.property({types:c.lightingTypes,nonNullable:!0,json:{write:!0}})],f.prototype,"lighting",void 0),e.__decorate([s.property(h.backgroundProperty)],f.prototype,"background",void 0),e.__decorate([s.property({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:m}}})],f.prototype,"atmosphereEnabled",void 0),e.__decorate([s.property({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:m}}})],f.prototype,"starsEnabled",void 0),e.__decorate([s.property({types:l.weatherTypes,nonNullable:!0,json:{write:!0},value:new a})],f.prototype,"weather",null),f=p=e.__decorate([o.subclass("esri.webscene.Environment")],f),f}))},"esri/webscene/lightingTypes":function(){define(["exports","./SunLighting","./VirtualLighting"],(function(e,t,r){"use strict";const i={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:t,virtual:r}};e.lightingTypes=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/webscene/background/utils":function(){define(["exports","./Background","./ColorBackground"],(function(e,t,r){"use strict";const i={base:t,key:"type",typeMap:{color:r}},s={types:i,json:{read:(n=i,(e,t,r)=>{if(!e)return e;for(const t in n.typeMap)if(e.type===t){const i=new n.typeMap[t];return i.read(e,r),i}}),write:{overridePolicy:(e,t,r)=>({enabled:!r?.isPresentation})}}};var n;e.backgroundProperty=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/webscene/background/Background":function(){define(["../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o){"use strict";let a=class extends t{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};return e.__decorate([r.property({readOnly:!0,json:{read:!1}})],a.prototype,"type",void 0),a=e.__decorate([o.subclass("esri.webscene.background.Background")],a),a}))},"esri/webscene/background/ColorBackground":function(){define(["../../chunks/tslib.es6","../../Color","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","../../symbols/support/materialUtils","./Background"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";var u;let d=u=class extends c{constructor(e){super(e),this.type="color",this.color=new t([0,0,0,1])}clone(){return new u(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};return e.__decorate([o.enumeration({color:"color"},{readOnly:!0}),r.property({json:{write:{isRequired:!0}}})],d.prototype,"type",void 0),e.__decorate([r.property(l.colorAndTransparencyProperty({nonNullable:!0,colorRequiredOnWrite:!0}))],d.prototype,"color",void 0),d=u=e.__decorate([a.subclass("esri.webscene.background.ColorBackground")],d),d}))},"esri/views/3d/input/SceneInputManager":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./handlers/DoubleClickZoom","./handlers/DragRotate","./handlers/DragZoom","./handlers/GamepadNavigation","./handlers/KeyboardNavigation","./handlers/MouseWheelZoom","./handlers/PinchAndPanNavigation","./handlers/PointerDownCancelAnimation","./handlers/TwoFingerTilt","../../input/BrowserEventSource","../../input/InputManager","../../input/handlers/PreventContextMenu","../../input/handlers/support","../../input/recognizers/Drag","../../input/recognizers/ImmediateDoubleClick","../../input/recognizers/PointerClickHoldAndDrag","../../input/recognizers/SingleAndDoubleClick","../../input/recognizers/VerticalTwoFingerDrag","../state/controllers/RotateController"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M){"use strict";let R=class extends t{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:e,dragPrimary:t,dragSecondary:r,dragTertiary:i})=>{"pro"===e&&(r="zoom",i="pan"===t?"rotate":"pan");const s={dragPrimary:t,dragSecondary:r,dragTertiary:i};this._modeDragPan&&(this._modeDragPan.pointerActions=S.getPointerActions("pan",s)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=S.getPointerActions("rotate",s)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=S.getPointerActions("zoom",s))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){const{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary="pan"===e?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=i.destroyMaybe(this._inputManager),this._source=i.destroyMaybe(this._source)}connect(){const e=this.view;this._source=new _.BrowserEventSource(this.view.surface,e.input);const t=[new x.ImmediateDoubleClick,new T.PointerClickHoldAndDrag,new C.SingleAndDoubleClick,new w.Drag(this.view.navigation),new P.VerticalTwoFingerDrag],r=new b.InputManager({eventSource:this._source,recognizers:t});this._inputManager=r,r.installHandlers("prevent-context-menu",[new v.PreventContextMenu],b.ViewEventPriorities.INTERNAL);const i={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new f.PinchAndPanNavigation(e,["primary"]),this._modeDragRotate=new u.DragRotate(e,["secondary"],M.PivotPoint.CENTER),this._modeDragZoom=new d.DragZoom(e,["tertiary"],i.fov),this._modeKeyboardNavigation=new p.KeyboardNavigation(e,i),r.installHandlers("navigation",[new g.PointerDownCancelAnimation(e),new c.DoubleClickZoom(e),new h.GamepadNavigation(e),new m.MouseWheelZoom(e,i.fov),new u.DragRotate(e,["primary"],M.PivotPoint.EYE,[i.lookAround.modifier]),new u.DragRotate(e,["secondary"],M.PivotPoint.CENTER,[i.lookAround.modifier]),new f.PinchAndPanNavigation(e,["tertiary"],[i.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new y.TwoFingerTilt(e)],b.ViewEventPriorities.INTERNAL),this.view.viewEvents.connect(r),this.addHandles([s.watch((()=>this.view.navigation?.browserTouchPanEnabled),(e=>{this._source.browserTouchPanningEnabled=!e}),s.initial),s.watch((()=>{const{actionMap:e}=this.view.navigation,{dragPrimary:t,dragSecondary:r,dragTertiary:i}=e;return{mode:this.mode,dragPrimary:t,dragSecondary:r,dragTertiary:i}}),this._updateMode,s.syncAndInitial)])}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}get test(){}};return e.__decorate([n.property()],R.prototype,"view",void 0),e.__decorate([n.property({type:["default","pro"]})],R.prototype,"mode",void 0),e.__decorate([n.property({readOnly:!0})],R.prototype,"updating",null),e.__decorate([n.property()],R.prototype,"latestPointerType",null),e.__decorate([n.property()],R.prototype,"latestPointerLocation",null),e.__decorate([n.property()],R.prototype,"multiTouchActive",null),e.__decorate([n.property()],R.prototype,"_inputManager",void 0),R=e.__decorate([l.subclass("esri.views.3d.input.SceneInputManager")],R),R}))},"esri/views/3d/input/handlers/DoubleClickZoom":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/ZoomStepControllerGlobal","../../state/controllers/ZoomStepControllerLocal","../../../input/InputHandler","../../../input/handlers/support"],(function(e,t,r,i,s,n){"use strict";class o extends s.InputHandler{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,(e=>this._handleDoubleClick(e)))}_handleDoubleClick(e){const s=e.data;if(n.eventMatchesPointerAction(s,"primary")){const n=this._view.state.isGlobal?new r.ZoomStepControllerGlobal({view:this._view,mode:"animation"}):new i.ZoomStepControllerLocal({view:this._view,mode:"animation"});this._view.state.switchCameraController(n),n.step(Math.log(.5)/Math.log(.6),t.createScreenPointArray(s.x,s.y)),e.stopPropagation()}}}e.DoubleClickZoom=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/ZoomStepControllerGlobal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/time","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","../../../../chunks/sphere","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../camera/constraintUtils/surfaceCollision","./PointToPointAnimationController","../utils/navigationUtils","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl/RenderCamera","../../webgl-engine/lib/Intersector","../../../animation/easing"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T){"use strict";e.ZoomStepControllerGlobal=class extends _.PointToPointAnimationController{constructor(){super(...arguments),this._zoomLocation=u.create(),this._tmpCamera=new w,this._tmpViewDir=u.create(),this._tmpRayDir=d.create(),this._targetOnSphere=u.create(),this._tmpCenter=u.create(),this._beginCamera=new w,this._constraintOptions=new m.ConstraintOptions(f.ConstraintTypes.ALL_EXCEPT_COLLISION,g.InteractionType.ZOOM,null,this._beginCamera),this._sphere=h.create()}initialize(){this._intersector=new x.Intersector(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const r=this.view.state;this.animation.finished?this._beginCamera.copyFrom(r.camera):this.animation.cameraAt(1,this._beginCamera);let i=!1,s=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?b.excludeTerrain:{})&&(i=e>0,s=!0),this._tmpCamera.copyFrom(r.camera),i?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:c.copy(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,s),this.begin(this._tmpCamera)}animationSettings(){return{duration:i.Milliseconds(600),easing:T.outExpo}}_updateCamera(e,t,i,s){const n=b.navigationMode(e,i,this.view.renderCoordsHelper,this.view.viewingMode),o=Math.abs(this.view.camera.position.z),a=this._zoomLocation;c.normalize(P,e.eye),c.scale(P,P,-1),v.fromScreenAtEye(e,i,this._tmpRayDir),c.normalize(this._tmpRayDir.direction,this._tmpRayDir.direction);const l=r.clamp(Math.min(b.zoomDistanceModifier,1/Math.abs(c.dot(P,this._tmpRayDir.direction)))*o,b.zoomMinDistanceModifier,b.zoomMaxDistanceModifier);if(n===b.NavigationMode.Horizontal){let r=.6**t;this._sphere[3]=c.length(a),c.subtract(this._tmpViewDir,e.center,e.eye);const s=Math.min(c.length(this._tmpViewDir),l);let n=s*r;if(r<=1&&n<4&&(n=4,r=n/s),Math.abs(s-n)<1e-6)return;const o=c.length(e.center);if(this._sphere[3]!==o){const t=this._sphere[3]+r*(o-this._sphere[3]);e.center=c.scale(C,e.center,t/o)}c.scale(this._tmpViewDir,this._tmpViewDir,-r),e.eye=c.add(C,e.center,this._tmpViewDir),p.applyAll(this.view,e,this._constraintOptions),c.squaredDistance(a,e.center)>1e-12&&S.intersectScreen(this._sphere,e,i,this._targetOnSphere)&&b.panToPosition(this._sphere,e,a,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let r=.6**Math.abs(t);const n=t>0?1:-1;c.subtract(this._tmpViewDir,a,e.eye);const o=c.length(this._tmpViewDir),u=this.view.stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,60);let d=null!=u?u:l;d=s&&t>0?Math.min(d,o):d,c.scale(this._tmpRayDir.direction,this._tmpRayDir.direction,d),c.add(a,this._tmpRayDir.origin,this._tmpRayDir.direction);let h=d*r;const p=Math.max(4,1.01*e.nearFar[0]);if(t>0&&h<p&&(h=p,r=h/d),Math.abs(d-h)<1e-6)return;c.scale(this._tmpRayDir.direction,this._tmpRayDir.direction,n*(1-r)),e.eye=c.add(C,e.eye,this._tmpRayDir.direction),e.center=c.add(C,e.center,this._tmpRayDir.direction)}y.applySurfaceCollisionConstraint(this.view,e)}},e.ZoomStepControllerGlobal=t.__decorate([l.subclass("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],e.ZoomStepControllerGlobal);const C=u.create(),P=u.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils":function(){define(["exports","./constraintUtils/altitude","./constraintUtils/common","./constraintUtils/ConstraintOptions","./constraintUtils/ConstraintTypes","./constraintUtils/distance","./constraintUtils/InteractionType","./constraintUtils/surfaceCollision","./constraintUtils/tilt","../../animation/easing"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=[{type:s.ConstraintTypes.TILT,error:function(e,t,r){return l.getTiltConstraintError(e,t,r)*t.distance},apply:l.applyTiltConstraint},{type:s.ConstraintTypes.ALTITUDE,error:t.getAltitudeConstraintError,apply:t.applyAltitudeConstraint},{type:s.ConstraintTypes.DISTANCE,error:n.getDistanceConstraintError,apply:n.applyDistanceConstraint}],d=new i.ConstraintOptions;e.applyAll=function(e,t,i=d,n=t){n!==t&&n.copyFrom(t),n.computeUp(e.state.viewingMode);let l=!1;for(let t=0;t<5;t++){let t=0;for(const s of u)if(r.hasConstraintType(i.selection,s.type)){const r=Math.abs(s.error(e,n,i));s.apply(e,n,i)&&(l=!0,t+=r)}if(0===t)break}const c=r.hasConstraintType(i.selection,s.ConstraintTypes.COLLISION),h=function(e,t){switch(e){case o.InteractionType.PAN:return a.Mode.EYE_AND_CENTER;case o.InteractionType.ASCEND:return t.state.isGlobal?a.Mode.EYE_AND_CENTER_SCALE:a.Mode.EYE_AND_CENTER;default:return a.Mode.EYE}}(i.interactionType,e);return c&&a.applySurfaceCollisionConstraint(e,n,h)&&(l=!0),l&&n.computeUp(e.state.viewingMode),l},e.pixelDistanceToInteractionFactor=function(e){const t=Math.min(1,e/150);return c.inOutCubic(t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils/altitude":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","./common","./ConstraintTypes","./InteractionType","../../support/intersectionUtils"],(function(e,t,r,i,s,n,o,a,l){"use strict";function c(e,r,i=n.defaultConstraintOptions){if(!function(e,t){const r=e.state.constraints.altitude;return!(!e.state.isGlobal||!r||t.interactionType===a.InteractionType.TUMBLE&&n.hasConstraintType(t.selection,o.ConstraintTypes.TILT))}(e,i)||!e.state.constraints.altitude)return 0;const s=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,u);!function(e,t,r){const i=t.interactionType;if(i===a.InteractionType.NONE)return;const{min:s,max:o}=r,{interactionStartCamera:l,interactionFactor:u}=t;if(!l)return;const d=i===a.InteractionType.TUMBLE||i===a.InteractionType.ZOOM,h=c(e,l),p=0===h?0:e.renderCoordsHelper.getAltitude(l.eye);r.min=s,r.max=o;const m=.05*p;n.adjustRangeForInteraction(h,p,d,u,m,r)}(e,i,s);const l=e.renderCoordsHelper.getAltitude(r.eye),d=t.clamp(l,s.min,s.max)-l;return Math.abs(d)<=1e-6?0:d}const u={min:0,max:0},d=i.create(),h=i.create(),p=i.create(),m=i.create();e.applyAltitudeConstraint=function(e,t,i=n.defaultConstraintOptions){const o=c(e,t,i);if(0===o)return!1;const a=e.renderCoordsHelper,u=a.getAltitude(t.eye)+o,f=n.interactionDirectionTowardsConstraintMinimization(t,i.interactionDirection,function(e,t,i,s){return e.renderCoordsHelper.worldUpAtPosition(t.eye,s),r.scale(s,s,i),s}(e,t,Math.sign(o),h),d),g=r.copy(p,t.viewForward),y=a.intersectInfiniteManifold(s.wrap(t.eye,f),u,m);return t.eye=null!=y?y:a.setAltitude(m,u,t.eye),t.center=l.closestPointOnRay(m,t.eye,g,t.center),!0},e.getAltitudeConstraintError=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils/common":function(){define(["exports","../../../../chunks/vec32","./ConstraintOptions","./ConstraintTypes"],(function(e,t,r,i){"use strict";const s=new r.ConstraintOptions(i.ConstraintTypes.NONE);e.adjustRangeForInteraction=function(e,t,r,i,s,n){0!==e&&(r?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):null!=i?(n.min-=Math.max(0,(t-n.min)*(1-i)),n.max+=Math.max(0,(t-n.max)*(1-i))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))},e.defaultConstraintOptions=s,e.hasConstraintType=function(e,t){return 0!==(e&t)},e.interactionDirectionTowardsConstraintMinimization=function(e,r,i,s){return r=r||e.viewForward,t.copy(s,r),t.scale(s,s,Math.sign(t.dot(r,i))),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils/ConstraintOptions":function(){define(["exports","./ConstraintTypes","./InteractionType","./TiltMode"],(function(e,t,r,i){"use strict";e.ConstraintOptions=class{constructor(e=t.ConstraintTypes.ALL,s=r.InteractionType.NONE,n=0,o=null,a=null,l=i.TiltMode.TUMBLE){this.selection=e,this.interactionType=s,this.interactionFactor=n,this.interactionStartCamera=o,this.interactionDirection=a,this.tiltMode=l}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils/ConstraintTypes":function(){define(["exports"],(function(e){"use strict";var t;e.ConstraintTypes=void 0,(t=e.ConstraintTypes||(e.ConstraintTypes={}))[t.NONE=0]="NONE",t[t.TILT=1]="TILT",t[t.ALTITUDE=2]="ALTITUDE",t[t.DISTANCE=4]="DISTANCE",t[t.COLLISION=8]="COLLISION",t[t.ALL=15]="ALL",t[t.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils/InteractionType":function(){define(["exports"],(function(e){"use strict";var t;e.InteractionType=void 0,(t=e.InteractionType||(e.InteractionType={}))[t.NONE=0]="NONE",t[t.ZOOM=1]="ZOOM",t[t.TUMBLE=2]="TUMBLE",t[t.LOOK_AROUND=3]="LOOK_AROUND",t[t.PAN=4]="PAN",t[t.ASCEND=5]="ASCEND",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils/TiltMode":function(){define(["exports"],(function(e){"use strict";var t;e.TiltMode=void 0,(t=e.TiltMode||(e.TiltMode={}))[t.TUMBLE=0]="TUMBLE",t[t.LOOK_AROUND=1]="LOOK_AROUND",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/intersectionUtils":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/plane"],(function(e,t,r,i,s){"use strict";const n={dir:i.create(),len:0,clip:t.create()};function o(e,t,i,s){const o=n;return e?(i&&s&&(o.len=r.distance(t,i)),r.copy(o.dir,e)):s?(o.len=r.distance(t,i),r.subtract(o.dir,i,t),r.scale(o.dir,o.dir,1/o.len)):(r.subtract(o.dir,i,t),r.normalize(o.dir,o.dir)),o}function a(e,t,i){const n=r.dot(s.getNormal(e),i.dir),o=-s.signedDistance(e,t);if(o<0&&n>=0)return!1;if(n>-1e-6&&n<1e-6)return o>0;if((o<0||n<0)&&!(o<0&&n<0))return!0;const a=o/n;return n>0?a<i.clip[1]&&(i.clip[1]=a):a>i.clip[0]&&(i.clip[0]=a),i.clip[0]<=i.clip[1]}function l(e,t,r,i){i.clip[0]=0,i.clip[1]=r?i.len:Number.MAX_VALUE;for(let r=0;r<e.length;r++)if(!a(e[r],t,i))return!1;return!0}e.closestPointOnRay=function(e,t,i,s){const n=r.dot(i,r.subtract(e,s,t));return r.add(e,t,r.scale(e,i,n))},e.frustumLineSegment=function(e,t,r,i){return l(e,t,r,o(i,t,r,!0))},e.frustumPoint=function(e,t){for(let r=0;r<6;r++)if(s.signedDistance(e[r],t)>0)return!1;return!0},e.frustumRay=function(e,t,r,i){return l(e,t,null,o(i,t,r,!1))},e.frustumSphere=function(e,t,r){const i=t[0],s=t[1],n=t[2];return!(e[0][0]*i+e[0][1]*s+e[0][2]*n+e[0][3]>r||e[1][0]*i+e[1][1]*s+e[1][2]*n+e[1][3]>r||e[2][0]*i+e[2][1]*s+e[2][2]*n+e[2][3]>r||e[3][0]*i+e[3][1]*s+e[3][2]*n+e[3][3]>r||e[4][0]*i+e[4][1]*s+e[4][2]*n+e[4][3]>r||e[5][0]*i+e[5][1]*s+e[5][2]*n+e[5][3]>r)},e.planeSphere=function(e,t,r){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]<r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils/distance":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/ray","../../../../chunks/sphere","./common","./InteractionType"],(function(e,t,r,i,s,n,o){"use strict";function a(e,t,r=n.defaultConstraintOptions){if(!e.state.isLocal)return 0;const i=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||i===1/0)return 0;c.min=0,c.max=i,function(e,t,r){const i=t.interactionType;if(i===o.InteractionType.NONE)return;const{min:s,max:c}=r,{interactionStartCamera:u,interactionFactor:d}=t;if(!u)return;const h=i===o.InteractionType.ZOOM||i===o.InteractionType.PAN,p=a(e,u),m=0===p?0:l(e,u);r.min=s,r.max=c;const f=.05*m;n.adjustRangeForInteraction(p,m,h,d,f,r)}(e,r,c);const s=l(e,t),u=c.max-s;return u>=-1e-6?0:u}function l(e,r){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?t.distance(r.eye,i.renderLocation):0}const c={min:0,max:0},u=r.create(),d=r.create(),h=r.create(),p=r.create(),m=r.create();e.applyDistanceConstraint=function(e,r,o=n.defaultConstraintOptions){const c=a(e,r,o);if(0===c)return!1;const f=e.pointsOfInterest.surfaceOrigin;if(!f.renderLocation)return!1;const g=l(e,r)+c,y=t.copy(u,r.eye),_=n.interactionDirectionTowardsConstraintMinimization(r,o.interactionDirection,function(e,r,i){return t.direction(i,e.eye,r)}(r,f.renderLocation,p),h);if(!s.intersectRay(s.fromCenterAndRadius(f.renderLocation,g),i.wrap(r.eye,_),m))return!1;r.eye=m;const b=t.subtract(d,r.eye,y);r.center=t.add(m,r.center,b);const v=e.renderCoordsHelper.getAltitude(r.center),S=e.renderCoordsHelper.intersectInfiniteManifold(r.ray,v,m);return null!=S&&(r.center=S),!0},e.getDistanceConstraintError=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils/surfaceCollision":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../intersectionUtils"],(function(e,t,r,i){"use strict";var s;e.Mode=void 0,(s=e.Mode||(e.Mode={}))[s.EYE=0]="EYE",s[s.EYE_AND_CENTER=1]="EYE_AND_CENTER",s[s.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE";const n=r.create(),o=r.create();e.applySurfaceCollisionConstraint=function(r,s,a=e.Mode.EYE){const l=r.state.constraints;if(!l.collision.enabled)return!1;const c=i.surfaceElevationBelowRenderLocation(r,s.eye),u=r.renderCoordsHelper.getAltitude(s.eye),d=c+l.collision.elevationMargin;if(u>=d)return!1;const h=t.length(s.eye);if(t.subtract(n,s.center,s.eye),s.eye=r.renderCoordsHelper.setAltitude(o,d,s.eye),a===e.Mode.EYE_AND_CENTER)s.center=t.add(n,s.eye,n);else if(a===e.Mode.EYE_AND_CENTER_SCALE){const e=(h-u+d)/h;s.center=t.scale(n,s.center,e)}return!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/camera/constraintUtils/tilt":function(){define(["exports","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../chunks/sphere","./common","./ConstraintTypes","./InteractionType","./TiltMode","../../state/utils/viewUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";function m(e,t,i,s=c.defaultConstraintOptions,o){if(!e.state.constraints.tilt)return 0;const _=Math.min(t.relativeElevation*w,t.distance),b=e.state.constraints.tilt(_,x);return function(e,t,r){if(t.interactionType===d.InteractionType.NONE)return;const{interactionStartCamera:i,interactionFactor:s}=t;if(!i)return;const{min:n,max:o}=r,a=m(e,i,c.defaultConstraintOptions,t),l=0===a?0:p.viewAngle(e.renderCoordsHelper,i.center,i.eye);r.min=n,r.max=o,t.interactionType===d.InteractionType.TUMBLE?(c.hasConstraintType(t.selection,u.ConstraintTypes.ALTITUDE)&&y(e,i,r),c.adjustRangeForInteraction(a,l,!0,s,S,r)):c.adjustRangeForInteraction(a,l,!1,s,S,r)}(e,i,b),s.interactionType===d.InteractionType.TUMBLE&&c.hasConstraintType(s.selection,u.ConstraintTypes.ALTITUDE)&&y(e,s.interactionStartCamera,b),i.tiltMode===h.TiltMode.LOOK_AROUND||s.tiltMode===h.TiltMode.LOOK_AROUND?function(e,t,i,s){switch(s&&(s.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,s){const o=function(e,t,i){const s=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,o=s+a.getReferenceEllipsoid(e.spatialReference).radius,c=e.renderCoordsHelper.intersectManifold(t.ray,s,v);return i.distance=Math.min(t.relativeElevation*w,t.distance),i.centerIsOnSurface=!1,null!=c?(i.distance=Math.min(t.relativeElevation*w,n.distance(t.eye,c)),i.tiltAtCenter=p.viewAngle(e.renderCoordsHelper,c,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=p.viewAngle(e.renderCoordsHelper,t.center,t.eye):(l.closestPointOnSilhouette(l.fromRadius(l.tmpSphere,o),t.ray,v),i.distance=Math.min(t.relativeElevation*w,n.distance(t.eye,v)),i.tiltAtCenter=r.acosClamped(-n.dot(t.viewForward,n.normalize(v,v)))),i.radius=o,i.eyeRadius=n.length(t.eye),i.constraints=e.state.constraints,i}(e,t,T),c=r.clamp(o.tiltAtCenter,i.min,i.max);if(!f(o.tiltAtCenter-c))return 0;let u,d;return o.centerIsOnSurface?(u=function(e){const{constraints:t,distance:r,tiltAtCenter:i}=e;let s=i,n=t.clampTilt(r,i);const o=g(e,n);if(t.clampTilt(o,i)===n)return n;let a=0;for(;a<10&&f(n-s);){const r=(s+n)/2,i=g(e,r);f(t.clampTilt(i,r)-r)?s=r:n=r,a++}return n}(o),d=function(e,t){const i=r.asinClamped(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),s=r.asinClamped(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-s:s-i}(o,u)):(u=o.constraints.clampTilt(o.distance,o.tiltAtCenter),s&&u<Math.PI/2&&(s.requiresTwoSteps=!0,u=Math.PI/2-1e-5),d=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(o,u)),s&&(s.eyeCenterDistance=g(o,u)),d}(e,t,i,s);case"local":return function(e,t,i,s){const n=p.viewAngle(e.renderCoordsHelper,t.center,t.eye),o=r.clamp(n,i.min,i.max),a=n-o;if(!f(a))return 0;if(s){const r=Math.abs(e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),i=e.renderCoordsHelper.getAltitude(t.eye)-r,n=Math.max(Math.cos(o),1e-4);Math.abs(n)>1e-4?s.eyeCenterDistance=i/n:s.eyeCenterDistance=t.distance}return a}(e,t,i,s)}}(e,t,b,o):function(e,t,i){const s=p.viewAngle(e.renderCoordsHelper,t.center,t.eye),n=s-r.clamp(s,i.min,i.max);return f(n)?n:0}(e,t,b)}function f(e){return Math.abs(e)>1e-9}function g(e,t){if(!e.centerIsOnSurface)return e.distance;const i=Math.PI-r.clamp(t,0,Math.PI),s=r.asinClamped(e.radius/e.eyeRadius*Math.sin(i)),n=Math.PI-i-s,o=Math.sin(n)/Math.sin(i);if(e.eyeRadius<e.radius&&o>1){const t=Math.PI-s,r=Math.PI-i-t;return Math.sin(r)/Math.sin(i)*e.eyeRadius}return o*e.eyeRadius}function y(e,t,i){const s=e.state.constraints;if(e.state.isLocal||!s.altitude||!t)return;const o=n.squaredLength(t.center),l=Math.sqrt(o),c=t.distance,u=a.getReferenceEllipsoid(e.spatialReference).radius,d=s.altitude.min+u,h=s.altitude.max+u,p=(d*d-c*c-o)/(-2*l*c),m=(h*h-c*c-o)/(-2*l*c);i.min=Math.max(i.min,Math.min(Math.PI-r.acosClamped(m),i.max)),i.max=Math.min(i.max,Math.PI-r.acosClamped(p))}const _=o.create(),b=s.create(),v=o.create(),S=r.deg2rad(5),w=30,x={min:0,max:0},T={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},C={eyeCenterDistance:0,requiresTwoSteps:!1};e.applyTiltConstraint=function e(r,s,o,a=!0){C.eyeCenterDistance=0,C.requiresTwoSteps=!1;const l=m(r,s,o,c.defaultConstraintOptions,C);if(0===l)return!1;switch(i.fromRotation(b,-l,s.viewRight),o.tiltMode){case h.TiltMode.LOOK_AROUND:n.transformMat4(_,s.viewForward,b),n.scale(_,_,C.eyeCenterDistance),s.center=n.add(v,s.eye,_);break;case h.TiltMode.TUMBLE:n.subtract(_,s.center,s.eye),n.transformMat4(_,_,b),s.eye=n.subtract(v,s.center,_);break;default:t.neverReached(o.tiltMode)}return s.up=n.transformMat4(v,s.up,b),!C.requiresTwoSteps||!a||e(r,s,o,!1)},e.getTiltConstraintError=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/easing":function(){define(["exports","../2d/unitBezier"],(function(e,t){"use strict";const r=e=>e,i=e=>e*e,s=e=>1-i(1-e),n=e=>e<.5?i(2*e)/2:(s(2*(e-.5))+1)/2,o=e=>e*e*e,a=e=>1-o(1-e),l=e=>e<.5?o(2*e)/2:(a(2*(e-.5))+1)/2,c=e=>e*e*e*e,u=e=>1-c(1-e),d=e=>e<.5?c(2*e)/2:(u(2*(e-.5))+1)/2,h=e=>e*e*e*e*e,p=e=>1-h(1-e),m=e=>e<.5?h(2*e)/2:(p(2*(e-.5))+1)/2,f=e=>1-Math.cos(e*Math.PI/2),g=e=>1-f(1-e),y=e=>e<.5?f(2*e)/2:(g(2*(e-.5))+1)/2,_=e=>2**(10*(e-1)),b=e=>1-_(1-e),v=e=>e<.5?_(2*e)/2:(b(2*(e-.5))+1)/2,S=e=>-(Math.sqrt(1-e*e)-1),w=e=>1-S(1-e),x=e=>e<.5?S(2*e)/2:(w(2*(e-.5))+1)/2;function T(e){const t=2*(e-Math.sqrt((e-1)*e)),r=t/2/e;return i=>i<r?e*i*i:t*i-t+1}function C(e,t){return(r,i)=>r<t?t*e(r/t,i):1-e((1-r)/(1-t),i)*(1-t)}const P=C(T(1),1),M=C(T(1),0),R=C(T(1),.5),E=C(T(2),1),O=C(T(2),0),A=C(T(2),.5),I=C(T(3),1),D=C(T(3),0),F=C(T(3),.5),L=C(T(4),1),N=C(T(4),0),U=C(T(4),.5),V={linear:r,"in-quad":i,"out-quad":s,"in-out-quad":n,"in-coast-quad":P,"out-coast-quad":M,"in-out-coast-quad":R,"in-cubic":o,"out-cubic":a,"in-out-cubic":l,"in-coast-cubic":E,"out-coast-cubic":O,"in-out-coast-cubic":A,"in-quart":c,"out-quart":u,"in-out-quart":d,"in-coast-quart":I,"out-coast-quart":D,"in-out-coast-quart":F,"in-quint":h,"out-quint":p,"in-out-quint":m,"in-coast-quint":L,"out-coast-quint":N,"in-out-coast-quint":U,"in-sine":f,"out-sine":g,"in-out-sine":y,"in-expo":_,"out-expo":b,"in-out-expo":v,"in-circ":S,"out-circ":w,"in-out-circ":x,"quad-in":i,"quad-out":s,"quad-in-out":n,"quad-in-coast":P,"quad-out-coast":M,"quad-in-out-coast":R,"cubic-in":o,"cubic-out":a,"cubic-in-out":l,"cubic-in-coast":E,"cubic-out-coast":O,"cubic-in-out-coast":A,"quart-in":c,"quart-out":u,"quart-in-out":d,"quart-in-coast":I,"quart-out-coast":D,"quart-in-out-coast":F,"quint-in":h,"quint-out":p,"quint-in-out":m,"quint-in-coast":L,"quint-out-coast":N,"quint-in-out-coast":U,"sine-in":f,"sine-out":g,"sine-in-out":y,"expo-in":_,"expo-out":b,"expo-in-out":v,"circ-in":S,"circ-out":w,"circ-in-out":x,ease:e=>t.easingFunctions.ease(e),"ease-in":e=>t.easingFunctions.easeIn(e),"ease-out":e=>t.easingFunctions.easeOut(e),"ease-in-out":e=>t.easingFunctions.easeInOut(e)};e.EasingFunctions=V,e.inCirc=S,e.inCoastCubic=E,e.inCoastQuad=P,e.inCoastQuart=I,e.inCoastQuint=L,e.inCubic=o,e.inExpo=_,e.inOutCirc=x,e.inOutCoastCubic=A,e.inOutCoastQuad=R,e.inOutCoastQuart=F,e.inOutCoastQuint=U,e.inOutCubic=l,e.inOutExpo=v,e.inOutQuad=n,e.inOutQuart=d,e.inOutQuint=m,e.inOutSine=y,e.inQuad=i,e.inQuart=c,e.inQuint=h,e.inSine=f,e.linear=r,e.outCirc=w,e.outCoastCubic=O,e.outCoastQuad=M,e.outCoastQuart=D,e.outCoastQuint=N,e.outCubic=a,e.outExpo=b,e.outQuad=s,e.outQuart=u,e.outQuint=p,e.outSine=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/unitBezier":function(){define(["exports"],(function(e){"use strict";function t(e,t,r,i){const s=3*e,n=3*(r-e)-s,o=1-s-n,a=3*t,l=3*(i-t)-a,c=1-a-l;function u(e){return((o*e+n)*e+s)*e}return function(e,t=1e-6){return r=function(e,t){let r,i,a,l,c,d;for(a=e,d=0;d<8;d++){if(l=u(a)-e,Math.abs(l)<t)return a;if(c=(3*o*(h=a)+2*n)*h+s,Math.abs(c)<1e-6)break;a-=l/c}var h;if(r=0,i=1,a=e,a<r)return r;if(a>i)return i;for(;r<i;){if(l=u(a),Math.abs(l-e)<t)return a;e>l?r=a:i=a,a=.5*(i-r)+r}return a}(e,t),((c*r+l)*r+a)*r;var r}}const r=/^cubic-bezier\((.*)\)/,i={};i.ease=t(.25,.1,.25,1),i.linear=t(0,0,1,1),i.easeIn=i["ease-in"]=t(.42,0,1,1),i.easeOut=i["ease-out"]=t(0,0,.58,1),i.easeInOut=i["ease-in-out"]=t(.42,0,.58,1),e.easingFunctions=i,e.parse=function(e){let s=i[e]||null;if(!s){const i=r.exec(e);if(i){const e=i[1].split(",").map((e=>parseFloat(e.trim())));4!==e.length||e.some((e=>isNaN(e)))||(s=t.apply(t,e))}}return s},e.unitBezier=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/PointToPointAnimationController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../ViewAnimation","../../animation/pointToPoint/Animation","./AnimationController","../../webgl/RenderCamera","../../webgl-engine/lib/Intersector","../../../animation/easing"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.PointToPointAnimationController=class extends u.AnimationController{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new c.Animation(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new l}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const r=this.animationSettings(t);m.copyFrom(this.view.state.camera);const i=new h.Intersector(this.view.state.viewingMode);this._intersectionHelper.intersectRay(m.ray,i,f)&&(m.center=f),this.animation.update(m,e,r),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?p.EasingFunctions[e.easing]:e.easing}}},t.__decorate([r.property({constructOnly:!0})],e.PointToPointAnimationController.prototype,"mode",void 0),t.__decorate([r.property({readOnly:!0})],e.PointToPointAnimationController.prototype,"isInteractive",null),e.PointToPointAnimationController=t.__decorate([o.subclass("esri.views.3d.state.controllers.PointToPointAnimationController")],e.PointToPointAnimationController);const m=new d,f=a.create();e.isPointToPointAnimationController=function(e){return null!=e&&"type"in e&&"point-to-point"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/animation/pointToPoint/Animation":function(){define(["exports","../../../../core/time","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./Camera","../../../animation/pointToPoint/Animation"],(function(e,t,r,i,s,n){"use strict";const o=i.create();e.Animation=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=t.Milliseconds(0),this._animation=new n.Animation((()=>new s.Camera(e))),this._current=new s.Camera(e)}update(e,i,s){const{source:n,target:a}=this._animation.definition,l=r.subtract(o,i.center,e.center),c=r.length(l);c>=1e-5?(l[0]/=c,l[1]/=c,l[2]/=c):(l[0]=0,l[1]=1,l[0]=0),r.copy(n.direction,l),r.copy(a.direction,l),n.copyFromRenderCamera(e),a.copyFromRenderCamera(i),this._current.copyFrom(n),this._animation.update(n,a,s),this.currentTime=t.Milliseconds(0),e.almostEquals(i)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,r){this.finished||(this.currentTime=t.Milliseconds(this.currentTime+t.millisecondsFromSeconds(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/animation/pointToPoint/Camera":function(){define(["exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../ViewingMode","../../support/mathUtils"],(function(e,t,r,i,s,n,o,a){"use strict";const l=n.create(),c=n.create(),u=n.create(),d=n.create(),h=n.create(),p=n.create(),m=n.UNIT_Z,f=n.UNIT_Y,g=n.UNIT_X,y=i.create();e.Camera=class{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=n.create(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=n.clone(f),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===o.ViewingMode.Global){const r=(s.length(this.center)+s.length(e.center))/2;t.pan=a.angle(this.center,e.center)*r}else t.pan=s.distance(this.center,e.center);let r=Math.abs(e._yaw-this._yaw);r>=Math.PI&&(r=2*Math.PI-r);const i=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(r,i),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,r,i){this.viewingMode===o.ViewingMode.Global?a.slerp(e.center,r.center,i.pan,this.center):s.lerp(this.center,e.center,r.center,i.pan),this._distance=isFinite(r.distance)?t.lerp(e.distance,r.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=t.lerp(e.pitch,r.pitch,i.rotate);let n=e._yaw;const l=r._yaw;Math.abs(l-n)>=Math.PI&&(n+=2*(n<l?1:-1)*Math.PI),this._yaw=t.lerp(n,l,i.rotate),this._fov=t.lerp(e.fov,r.fov,i.fov)}copyFrom(e){s.copy(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,s.copy(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,y);var r;s.copy(this.center,e.center),s.subtract(d,e.center,e.eye),s.transformMat3(d,d,t),s.transformMat3(h,e.up,t),this._distance=s.length(d),0!==this._distance&&(d[0]/=this._distance,d[1]/=this._distance,d[2]/=this._distance),this._pitch=(r=d,Math.PI-a.angle(m,r)),this._yaw=function(e,t){const r=p;return Math.abs(t[2])<.5?(s.copy(r,t),e[2]>0&&s.scale(r,r,-1)):s.copy(r,e),s.cross(c,r,m),s.normalize(c,c),a.angle(g,c,m)}(d,h),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,y);r.transpose(t,t),this._axisAngleVec3(g,this._pitch-Math.PI/2,f,d),this._axisAngleVec3(m,this._yaw,d,d),this._axisAngleVec3(g,this._pitch-Math.PI/2,m,h),this._axisAngleVec3(m,this._yaw,h,h),s.scale(d,d,this._distance),s.transformMat3(d,d,t),s.transformMat3(h,h,t),e.center=this.center,e.eye=s.subtract(d,this.center,d),e.up=h,e.fov=this._fov}_axisAngleVec3(e,t,r,i){const n=Math.cos(t),o=Math.sin(t);return s.scale(l,r,n),s.cross(c,e,r),s.scale(c,c,o),s.scale(u,e,(1-n)*s.dot(e,r)),s.add(i,s.add(i,l,c),u)}_lookAtOrientation(e,t=i.create()){return this._upAtLookAt(e,u),s.cross(l,this.direction,u),s.normalize(l,l),0===l[0]&&0===l[1]&&0===l[2]&&s.copy(l,g),s.cross(c,u,l),s.normalize(c,c),t[0]=l[0],t[1]=c[0],t[2]=u[0],t[3]=l[1],t[4]=c[1],t[5]=u[1],t[6]=l[2],t[7]=c[2],t[8]=u[2],t}_upAtLookAt(e,t){return this.viewingMode===o.ViewingMode.Local?s.copy(t,m):s.normalize(t,e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/Animation":function(){define(["exports","../../../core/time","../easing","./Definition","./InterpolateComponents","./Settings","./apex/Path"],(function(e,t,r,i,s,n,o){"use strict";const a=new s.InterpolateComponents;e.Animation=class{get time(){return this._time}get isLinear(){return 1===this.path.segments.length}constructor(e){this._time=t.Milliseconds(0),this._easing=r.inOutCoastQuad,this.definition=new i.Definition(e),this.path=new o.Path}update(e,i,s){this.definition.update(e,i,s),this.path.update(this.definition,s),this._time=this._applyTimeSettings(t.millisecondsFromSeconds(isFinite(this.path.time)?this.path.time:t.Seconds(0)),s),this._easing=s.easing??(this._time>=1e3?r.inOutCoastQuad:r.outExpo)}cameraAt(e,t){e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const r=this.path.interpolateComponentsAt(e,a);t.interpolate(this.definition.source,this.definition.target,r)}_normalizedEasing(e){const t=this._easing(0,this._time),r=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(r-t)}_applyTimeSettings(e,r){const i=null!=r.speedFactor?r.speedFactor:1,s=r.minDuration??n.defaultSettings.minDuration/i,o=r.maxDuration??n.defaultSettings.maxDuration/i;return null!=r.duration?t.Milliseconds(r.duration):t.Milliseconds(Math.min(Math.max(e/i,s),o))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/Definition":function(){define(["exports","../../../core/libs/gl-matrix-2/math/common","./Camera","./Settings"],(function(e,t,r,i){"use strict";class s{constructor(e){this._createCamera=e,this.compared=new r.CompareResult,this.segmentStart=0,this.segmentEnd=1,this.settings={desiredScreenFlow:i.defaultSettings.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new s(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,r){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow??i.defaultSettings.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>t.getEpsilon()}get hasFov(){return Math.abs(this.compared.fov)>t.getEpsilon()}get hasRotate(){return this.compared.rotate>t.getEpsilon()}}e.Definition=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/Camera":function(){define(["exports"],(function(e){"use strict";e.CompareResult=class{constructor(){this.pan=0,this.rotate=0,this.fov=0,this.sourceZoom=0,this.targetZoom=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/Settings":function(){define(["exports","../../../core/time"],(function(e,t){"use strict";const r={desiredScreenFlow:2,minDuration:t.Milliseconds(500),maxDuration:t.Milliseconds(8e3)},i={...r,maxDuration:t.Milliseconds(4e3)};e.defaultSettings=r,e.defaultSettings2D=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/InterpolateComponents":function(){define(["exports"],(function(e){"use strict";e.InterpolateComponents=class{constructor(){this.pan=0,this.rotate=0,this.zoom=0,this.fov=0,this.zoomOffset=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/apex/Path":function(){define(["exports","../../easing","../Path","../Segment","./planning"],(function(e,t,r,i,s){"use strict";class n extends r.Path{constructor(e,t){super(),this._preallocSegments=[new i.Segment,new i.Segment,new i.Segment],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();const r=t?.apex?s.optimalDistance(e,t.apex):null;this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,r?this._updateWithApex(r,t?.apex):this._updateWithoutApex()}segmentInterpolateComponentsAt(e,r,i){e.interpolateComponentsAt(r,i),e===this._ascensionSegment?i.zoom=t.outQuad(i.zoom):e===this._descensionSegment&&(i.zoom=t.inQuad(i.zoom))}_updateWithApex(e,t){const[r,i,s]=this._preallocSegments,n=t?.ascensionFactor??.5,o=Math.min(1-n,null!=t?.ascensionFactor&&null!=t.descensionFactor?t.descensionFactor:.5),a=1-n-o;r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*n,r.definition.compared.rotate=this.definition.compared.rotate*n,r.definition.segmentEnd=n,r.update(),this._ascensionSegment=r,this.segments.push(r),a>0&&(i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.copyFrom(this.definition),i.definition.compared.sourceZoom=e,i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*a,i.definition.compared.rotate=this.definition.compared.rotate*a,i.definition.segmentStart=r.definition.segmentEnd,i.definition.segmentEnd=r.definition.segmentEnd+a,i.update(),this.segments.push(i)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*o,s.definition.compared.rotate=this.definition.compared.rotate*o,s.definition.segmentStart=n+a,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}e.Path=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/Path":function(){define(["exports","../../../core/time"],(function(e,t){"use strict";e.Path=class{constructor(){this.segments=new Array}get time(){return this.segments.reduce(((e,r)=>t.Seconds(e+r.time)),t.Seconds(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let r=0,i=0;const s=this.definition,n=this.segments.reduce(((e,t)=>e||t.definition.hasZoom),!1);for(let o=0;o<this.segments.length;o++){const a=this.segments[o],l=a.definition;if(e<=a.time||o===this.segments.length-1){if(this.segmentInterpolateComponentsAt(a,0===a.time?0:e/a.time,t),s.hasPan&&!isNaN(t.pan)&&isFinite(s.compared.pan)?t.pan=(r+l.compared.pan*t.pan)/s.compared.pan:t.pan=1,s.hasRotate&&!isNaN(t.rotate)&&isFinite(s.compared.rotate)?t.rotate=(i+l.compared.rotate*t.rotate)/s.compared.rotate:t.rotate=1,n&&!isNaN(t.zoom)&&isFinite(l.compared.targetZoom)){const{sourceZoom:e,targetZoom:r}=l.compared,i=t.zoom*(r-e)+e,s=this.segments[0].definition.compared.sourceZoom,n=this.segments[this.segments.length-1].definition.compared.targetZoom,o=Math.abs(r-s)>Math.abs(e-s)?r:e;t.zoomOffset=o-n,t.zoom=(i-s)/(o-s)}else t.zoom=1;return t}e-=a.time,r+=l.compared.pan,i+=l.compared.rotate}}segmentInterpolateComponentsAt(e,t,r){e.interpolateComponentsAt(t,r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/Segment":function(){define(["exports","../../../core/mathUtils","../../../core/time"],(function(e,t,r){"use strict";const i=t.deg2rad(45);e.Segment=class{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,r=t.sourceZoom,i=t.targetZoom;this._zoomSign=r>i?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(r);const s=(e.source.pixelsPerRotate()+e.target.pixelsPerRotate())/2;this._rotatePixels=t.rotate*s}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:s,hasRotate:n}=this.definition;let o=0,a=0;i&&(s&&(o=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(i&&s&&n){const e=o+a+o*a;this._zoomPixelFlow=o*a/e*l,this._panPixelFlow=a/e*l,this._rotatePixelFlow=o/e*l}else if(i&&s){const e=1+o;this._zoomPixelFlow=o/e*l,this._panPixelFlow=1/e*l}else if(i&&n){const e=1+a;this._zoomPixelFlow=a/e*l,this._rotatePixelFlow=1/e*l}else if(s&&n){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*l,this._rotatePixelFlow=1/t*l}else s?this._panPixelFlow=l:i?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);if(this._time=r.Seconds(Math.max(this.rotateTime,this.zoomTime,this.panTime)),this.fovTime>this._time){const e=this.fovTime/this._time;this._time=this.fovTime,this._zoomPixelFlow/=e,this._panPixelFlow/=e,this._rotatePixelFlow/=e}}get rotateTime(){return this.definition.hasRotate?r.Seconds(this._rotatePixels/this._rotatePixelFlow):r.Seconds(0)}get zoomTime(){return this.definition.hasZoom?r.Seconds(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):r.Seconds(0)}get fovTime(){return this.definition.hasFov?r.Seconds(Math.abs(this.definition.compared.fov)/i):r.Seconds(0)}get panTime(){if(!this.definition.hasPan)return r.Seconds(0);if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return r.Seconds(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return r.Seconds(this._panPixelsAtSource/this._panPixelFlow)}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(t*(t/r)**-e-t)/(r-t)}return e}_interpolateComponentsFov(e){if(0===e)return this.definition.segmentStart;if(1===e)return this.definition.segmentEnd;if(this.definition.hasFov){const{segmentStart:t,segmentEnd:r}=this.definition;return t+e*(r-t)}return this.definition.segmentStart}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),t.zoom=this._interpolateComponentsZoom(e),t.pan=this._interpolateComponentsPan(e),t.rotate=this._interpolateComponentsRotate(e),t.zoomOffset=0,t.fov=this._interpolateComponentsFov(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/apex/planning":function(){define(["exports","./functions"],(function(e,t){"use strict";e.optimalDistance=function(e,r){let i=function(e,t){const r=Math.max(e.compared.sourceZoom,e.compared.targetZoom),i=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return i<r?null!=t.maximumDistance?r+(t.maximumDistance-r)/2:1.5*r:t.maximumDistance?Math.min(t.maximumDistance,i):i}(e,r);const s={ascensionFactor:null!=r.ascensionFactor?r.ascensionFactor:.5,descensionFactor:null!=r.descensionFactor?r.descensionFactor:.5},n=0===s.ascensionFactor,o=0===s.descensionFactor,a=n?t.tAscensionZoomOnly:t.tAscensionZoomPan,l=n?t.dtAscensionZoomOnly:t.dtAscensionZoomPan,c=n?t.ddtAscensionZoomOnly:t.ddtAscensionZoomPan,u=o?t.tDescensionZoomOnly:t.tDescensionZoomPan,d=o?t.dtDescensionZoomOnly:t.dtDescensionZoomPan,h=o?t.ddtDescensionZoomOnly:t.ddtDescensionZoomPan,p=r=>a(e,r,s)+t.tPanion(e,r,s)+u(e,r,s),m=r=>l(e,r,s)+t.dtPanion(e,r,s)+d(e,r,s),f=r=>c(e,r,s)+t.ddtPanion(e,r,s)+h(e,r,s);let g=p(i);const y=t.tBaseLine(e);let _;const b=r.maximumIterations||20,v=null!=r.maximumDistance?r.maximumDistance:1/0;for(_=0;_<b;_++){const t=r.desiredSlope??1e-6;let s=m(i);Math.abs(s)>t&&(s+=t);const n=s/f(i);if(isNaN(n)||i>=v&&n<0){if(!isFinite(v))return null;i=v,g=p(i);break}if(i-=n,i<=e.compared.sourceZoom||i<=e.compared.targetZoom)return null;const o=p(i);if(Math.abs(o-g)/g<=.005)break;g=o}return isNaN(g)||g>.7*y||i<=e.compared.sourceZoom||i<=e.compared.targetZoom?null:i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/animation/pointToPoint/apex/functions":function(){define(["exports"],(function(e){"use strict";e.ddtAscensionZoomOnly=function(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)},e.ddtAscensionZoomPan=function(e,t,r){const i=t-e.compared.sourceZoom,s=1/i,n=1/t,o=Math.log(e.compared.sourceZoom*n),a=(r.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(i))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a+2*s*o+2*n-2*o*a/(i*i)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)},e.ddtDescensionZoomOnly=function(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)},e.ddtDescensionZoomPan=function(e,t,r){const i=t-e.compared.targetZoom,s=1/i,n=1/t,o=Math.log(t/e.compared.targetZoom),a=(e.halfWindowPanAtZoom(t)+r.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a-2*s*o+2*n+2*o*a/(i*i)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)},e.ddtPanion=function(e,t,r){return-2*e.compared.pan*e.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))},e.dtAscensionZoomOnly=function(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)},e.dtAscensionZoomPan=function(e,t,r){const i=1/t,s=Math.log(e.compared.sourceZoom*i),n=1/e.desiredPixelFlow,o=1/Math.LN2,a=t-e.compared.sourceZoom,l=1/a,c=(r.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(a))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*i*n*o*l*c-e.halfWindowSize*s*n*o*l+e.halfWindowSize*s*n*o*c/(a*a)},e.dtDescensionZoomOnly=function(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)},e.dtDescensionZoomPan=function(e,t,r){const i=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,n=1/Math.LN2,o=-t+e.compared.targetZoom,a=1/o,l=(-e.halfWindowPanAtZoom(t)-r.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*i*s*n*a+e.halfWindowSize*i*s*n*l/(o*o)+e.halfWindowSize*s*n*a*l/t},e.dtPanion=function(e,t,r){return e.compared.pan*e.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))},e.tAscensionZoomOnly=function(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)},e.tAscensionZoomPan=function(e,t,r){const i=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(i);return-e.halfWindowSize*(r.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)},e.tBaseLine=function(e){const t=e.compared.sourceZoom-e.compared.targetZoom;if(0===t)return e.compared.pan*e.halfWindowSize/(e.desiredPixelFlow*e.halfWindowPanAtZoom(e.compared.sourceZoom));const r=Math.LN2*e.compared.pan,i=t,s=e.halfWindowPanAtZoom(i),n=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*s);return e.compared.sourceZoom<=e.compared.targetZoom?n*(r-s):n*(r+s)},e.tDescensionZoomOnly=function(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)},e.tDescensionZoomPan=function(e,t,r){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-r.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))},e.tPanion=function(e,t,r){return-e.compared.pan*e.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/AnimationController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../ViewAnimation","./CameraController"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.AnimationController=class extends u.CameraController{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(i.createAbortError()),this._asyncResult=null),this.state===u.State.Finished||this.state===u.State.Stopped?(r.assertIsSome(e),this.state===u.State.Finished?e.resolve():e.reject(i.createAbortError())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=u.State.Running,null!=this.viewAnimation&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==u.State.Ready&&this.state!==u.State.Running||(this.viewAnimation.state===c.State.FINISHED?this.finish():this.viewAnimation.state===c.State.STOPPED&&(this.state=u.State.Stopped))}onControllerEnd(e){null==this.viewAnimation||this.viewAnimation.done||(this.state===u.State.Finished?this.viewAnimation.finish():this.state===u.State.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===u.State.Finished?this._asyncResult.resolve():this._asyncResult.reject(i.createAbortError()))}finish(){this.finishController()}},e.AnimationController=t.__decorate([l.subclass("esri.views.3d.state.controllers.AnimationController")],e.AnimationController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/CameraController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";var l;e.State=void 0,(l=e.State||(e.State={}))[l.Ready=0]="Ready",l[l.Rejected=1]="Rejected",l[l.Running=2]="Running",l[l.Stopped=3]="Stopped",l[l.Finished=4]="Finished",e.CameraController=class extends r{constructor(t){super(t),this.state=e.State.Ready}get running(){return this.state===e.State.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=e.State.Stopped,!0)}finishController(){this.state=e.State.Finished}get steppingFinished(){return!1}},t.__decorate([i.property({constructOnly:!0})],e.CameraController.prototype,"view",void 0),t.__decorate([i.property({readOnly:!0})],e.CameraController.prototype,"running",null),t.__decorate([i.property()],e.CameraController.prototype,"state",void 0),t.__decorate([i.property({readOnly:!0})],e.CameraController.prototype,"isInteractive",null),e.CameraController=t.__decorate([a.subclass("esri.views.3d.state.controllers.CameraController")],e.CameraController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/utils/navigationUtils":function(){define(["exports","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/coordinateSystem","../../../../geometry/support/plane","../../../../chunks/sphere","../../../../geometry/support/vectorStacks","../../support/geometryUtils/ray","../../support/geometryUtils/sphere","../../webgl/RenderCamera","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_){"use strict";var b;e.SpherePickPointFallback=void 0,(b=e.SpherePickPointFallback||(e.SpherePickPointFallback={}))[b.Ellipsoid=0]="Ellipsoid",b[b.Silhouette=1]="Silhouette";const v={exclude:new Set([_.terrainId])};function S(e,t,r){const i=s.fromRotation(m.sm4d.get(),r[3],u.axis(r));null==i||s.exactEquals(i,n.IDENTITY)||(l.subtract(se,e.eye,t),l.transformMat4(se,se,i),e.eye=l.add(se,se,t),l.subtract(se,e.center,t),l.transformMat4(se,se,i),e.center=l.add(se,se,t),e.up=l.transformMat4(se,e.up,i))}const w=i.createScreenPointArray();function x(e,t,r,i){return Math.sin(e/l.length(t))*(r+i.radius)}var T;e.NavigationMode=void 0,(T=e.NavigationMode||(e.NavigationMode={}))[T.Vertical=0]="Vertical",T[T.Horizontal=1]="Horizontal";const C={Elevation:3e4,Angle:r.deg2rad(16)},P=r.deg2rad(80),M=c.create();function R(e,t,r,i){const s=f.fromScreenAtEye(t,r,ce);return!(null==s||(p.closestPointOnSilhouette(e,s,E),p.intersectRay(e,s,i)?l.squaredDistance(E,s.origin)<l.squaredDistance(i,s.origin)&&(l.copy(i,E),1):(l.subtract(O,t.eye,t.center),l.normalize(O,O),h.fromNormalAndOffset(O,-l.dot(l.normalize(O,O),E),A),h.intersectRay(A,s,i),1)))}const E=c.create(),O=c.create(),A=h.create();function I(e,i,s,n,o,a){let u=0;if(l.cross(ae,e,i),l.subtract(ne,e,i),l.length(e)<=o||!n.aboveGround){l.cross(s,ne,n.eye);const d=l.dot(e,i)/(l.length(e)*l.length(i));if(d<.9999)u=r.acosClamped(d);else{const t=l.length(l.cross(c.create(),e,i))/(l.length(e)*l.length(i));u=r.asinClamped(t)}const h=Math.cos(r.clamp(t.cyclicalPI.normalize(r.deg2rad(a)),0,P));u=-u-Math.max(0,l.length(i)-o)/(h*o)}else l.subtract(D,n.eye,n.center),l.cross(s,ne,D),u=-l.length(ne)/o;return l.normalize(s,s),l.scale(s,s,l.length(ae)),u}const D=c.create();function F(e,i,s,n){let o,a;const l=Math.cos(r.clamp(t.cyclicalPI.normalize(r.deg2rad(n)),0,P));return o=i>s?-(i-s)/(l*s):i<-s?Math.PI-(i+s)/(l*s):r.acosClamped(i/s),a=e>s?-(e-s)/(l*s):e<-s?Math.PI-(e+s)/(l*s):r.acosClamped(e/s),(a-o)*s}function L(e,t,r,i,s,n,a,c,u,d){const h=F(e[2],t[2],n[3],c),p=u?F(e[0],t[0],n[3],180):t[0]-e[0],m=Math.sin(a)*p-Math.cos(a)*h,f=Math.cos(a)*p+Math.sin(a)*h;l.normalize(se,s);const g=u?m/Math.sqrt(Math.abs(n[3]**2-l.dot(r,se)**2)):m/n[3],y=f/Math.sqrt(Math.abs(n[3]**2-l.dot(r,i)**2));o.set(d,g,y)}function N(e,t,r,i,s,n,o,a,c,u){l.cross(ae,e,t),d.coordinateSystemFromOneAxisAndNormalVector(n.up,n.eye,$,Q,Z),d.coordinateSystemFromOneAxisAndNormalVector([0,0,1],n.eye,q,H,W),l.copy(r,H),l.copy(i,q),l.normalize(r,r),l.scale(r,r,l.length(ae)),d.vectorCoordinates(e,l.normalize(Q,Q),l.normalize(Z,Z),l.normalize($,$),Y),d.vectorCoordinates(t,Q,Z,$,X),L(Y,X,e,q,H,o,a,c,u,s)}function U(e,t,r,i,n,o,a){s.fromRotation(ee,n,i),s.fromRotation(te,a,o),s.multiply(re,ee,te),l.subtract(t,e,r),l.transformMat4(t,t,re),l.add(t,t,r)}function V(e,t,r,i,n,o){s.fromRotation(ee,i,r),s.fromRotation(te,o,n),s.multiply(re,ee,te),l.subtract(se,e.eye,t),l.transformMat4(se,se,re),e.eye=l.add(se,se,t),l.subtract(se,e.center,t),l.transformMat4(se,se,re),e.center=l.add(se,se,t),l.subtract(se,e.up,t),l.transformMat4(se,se,re),e.up=l.add(se,se,t)}const B={Pole:.95,Angle:r.deg2rad(18),Tilt:45,TiltHysteresisMargin:1e-7};let G=!1;function k(e,t,r,i,s,n){const o=Math.abs(i)>Math.PI-B.Angle||Math.abs(i)<B.Angle,a=(Math.abs(e[2])<r*B.Pole||Math.abs(t)>r)&&n;return o&&a?!G&&s<B.Tilt-B.TiltHysteresisMargin?G=!0:G&&s>B.Tilt+B.TiltHysteresisMargin&&(G=!1):G=!1,G}function z(e,t,r,i,s,n){if(n)u.fromPoints(r,i,J),S(t,p.getCenter(e),J);else{const n=I(r,i,le,t,e[3],s);S(t,p.getCenter(e),u.wrapAxisAngle(le,n))}}function j(e,t,r,i,s,n,o){const a=o?20:1;let c,u;l.copy(ie,i),oe.copyFrom(t);for(let i=0;i<a&&l.squaredDistance(r,ie)>1e-12&&(c=l.squaredDistance(r,ie),N(r,ie,H,q,K,oe,e,s,n,o),V(oe,p.getCenter(e),q,K[1],H,K[0]),U(ie,ie,p.getCenter(e),q,K[1],H,K[0]),u=l.squaredDistance(r,ie),u<c||0===i);i++)t.copyFrom(oe)}const q=c.create(),H=c.create(),W=c.create(),$=c.create(),Q=c.create(),Z=c.create(),Y=c.create(),X=c.create(),K=a.create(),J=u.create(),ee=n.create(),te=n.create(),re=n.create(),ie=c.create(),se=c.create(),ne=c.create(),oe=new y,ae=c.create(),le=c.create(),ce={origin:c.create(),direction:c.create()},ue={origin:c.create(),direction:c.create()};e.TiltThresholdPanningSpeed=P,e.VerticalPanTresholds=C,e.applyPanPlanar=function(e,t,r){l.subtract(M,r,t),e.eye=l.subtract(se,e.eye,M),e.center=l.subtract(se,e.center,M)},e.applyPanSphericalDirectRotation=z,e.applyPanSphericalPreserveHeading=j,e.applyRotation=S,e.applyRotationWithTwoAxes=V,e.applyZoomOnSphere=function(e,t,r){t.getScreenCenter(w),g.intersectScreen(e,t,w,se)&&(t.center=se);const i=t.distance,s=i*r;if(Math.abs(i-s)<1e-6)return;const n=l.scale(m.sv3d.get(),t.viewForward,s);t.eye=l.subtract(se,t.center,n)},e.applyZoomToPoint=function(e,t,r,i){const s=m.sv3d.get();let n=1-r;l.subtract(s,t,e.eye);const o=l.length(s);let a=o*(1-n);n>=0&&a<i&&(a=i,n=-(a-o)/o),Math.abs(o-a)<1e-6||(l.scale(s,s,n),e.eye=l.add(se,e.eye,s),e.center=l.lerp(se,e.center,t,n))},e.centroid=function(e,t){l.set(t,0,0,0);for(const r of e)l.add(t,t,r);l.scale(t,t,1/e.length)},e.distanceClampValues=[1,3e8],e.excludeTerrain=v,e.intersectPlaneFromScreenPoint=function(e,t,r,i){return h.intersectRay(e,f.fromScreen(t,r,ce),i)},e.intersectPlaneFromScreenPointAtEye=function(e,t,r,i){return h.intersectRay(e,f.fromScreenAtEye(t,r,ce),i)},e.lengthFromPoints=F,e.minHeightLimit=50,e.navigationMode=function(t,r,i,s){const n=t.relativeElevation;if(n>C.Elevation&&"global"===s)return e.NavigationMode.Horizontal;f.fromScreenAtEye(t,r,ue);const o=Math.sign(n),a=i.worldUpAtPosition(t.eye,se);return-o*l.dot(a,ue.direction)<Math.sin(C.Angle)*l.length(ue.direction)?e.NavigationMode.Vertical:e.NavigationMode.Horizontal},e.normalizeCoordinate=function(e,t,r){return r[0]=t[0]/(e.fullWidth/e.pixelRatio),r[1]=t[1]/(e.fullHeight/e.pixelRatio),r},e.normalizeRotationDelta=function(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e},e.offSurfaceTiltToEyeTiltGlobal=function(e,t,r,i){return x(Math.PI/2,t,r,i)+(e-Math.PI/2)},e.onSurfaceTiltToEyeTiltGlobal=x,e.panDistanceModifier=5,e.panMotionToRotationMatrix=function(e,i,n,o,a,c,u,h,p){k(e.center,l.dot(e.up,e.center),l.length(e.center),-t.cyclicalPI.normalize(r.deg2rad(c)),u,i.aboveGround)?function(e,t,r,i,n,o){const{eye:a}=e;d.coordinateSystemFromOneAxisAndNormalVector([0,0,1],a,q,H,W);const c=t.translation[0]*r.pan,u="zoom"===n.mode?0:t.translation[1]*r.pan,h=Math.max(Math.sqrt(Math.abs(1-l.dot(e.center,q)**2/l.length(e.center)**2)),.5),p=(Math.sin(o)*u+Math.cos(o)*c)/h,m=-Math.cos(o)*u+Math.sin(o)*c;switch(s.rotate(i.pan.matrix,i.pan.matrix,p,q),i.pan.enabled=!0,n.mode){case"pan":s.rotate(i.pan.matrix,i.pan.matrix,m,H),i.pan.enabled=!0;break;case"zoom":i.zoom=-t.translation[1]*r.zoom}}(i,n,o,h,p,-t.cyclicalPI.normalize(r.deg2rad(a))):function(e,t,r,i,n){const{eye:o,viewRight:a}=e,c=l.cross(m.sv3d.get(),a,o),u=t.translation[0]*r.pan;switch(0!==u&&(s.rotate(i.pan.matrix,i.pan.matrix,-u,c),i.pan.enabled=!0),n.mode){case"pan":{const e=t.translation[1]*r.pan;0!==e&&(s.rotate(i.pan.matrix,i.pan.matrix,e,a),i.pan.enabled=!0);break}case"zoom":i.zoom=-t.translation[1]*r.zoom}}(i,n,o,h,p)},e.panToPosition=function(e,i,s,n,o,a,c){k(s,l.dot(i.up,s),e[3],-t.cyclicalPI.normalize(r.deg2rad(o)),a,i.aboveGround)?j(e,i,s,n,-t.cyclicalPI.normalize(r.deg2rad(o)),a,c):z(e,i,s,n,a,c)},e.pickPointAndInitSphere=function(t,r,i,s,n,o){const a=c.create(),u=p.create();let d=!0,h=!0;return t.intersectScreen(i,a,o)?u[3]=l.length(a):(h=!1,r.aboveGround&&n!==e.SpherePickPointFallback.Ellipsoid?u[3]=Math.max(l.length(r.center),.9*s):u[3]=l.length(r.eye)-r.relativeElevation,n===e.SpherePickPointFallback.Silhouette?R(u,r,i,a):d=g.intersectScreen(u,r,i,a)),{sphere:u,scenePickPoint:d?a:null,hasGeometryIntersection:h}},e.pivotDistanceModifier=30,e.preservingHeadingThresholds=B,e.rotatePivotDistanceModifier=5,e.rotatePivotMinDistanceModifier=10,e.rotatePointAroundTwoAxes=U,e.rotateScreenPixelArea=90,e.rotationAngleAndAxisDirectRotation=I,e.rotationAnglesAndAxesHeadingPreserving=N,e.rotationAnglesHeadingPreserving=L,e.screenPixelArea=80,e.shouldPreserveHeading=k,e.sphereOrPlanePointFromScreenPoint=R,e.zoomDistanceModifier=8,e.zoomMaxDistanceModifier=1508e5,e.zoomMinDistanceModifier=200,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/axisAngle":function(){define(["exports","../../core/libs/gl-matrix-2/math/quat","../../core/libs/gl-matrix-2/factories/quatf64","../../chunks/vec32","./vector","./vectorStacks"],(function(e,t,r,i,s,n){"use strict";function o(e=u){return[e[0],e[1],e[2],e[3]]}function a(e,t,r,i,s=o()){return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}function l(e){return e[3]}function c(e,t){return e[3]=t,e}const u=[0,0,1,0],d=r.create(),h=r.create();e.angle=l,e.axis=function(e){return e},e.compose=function(e,r,i){return t.setAxisAngle(d,e,l(e)),t.setAxisAngle(h,r,l(r)),t.multiply(d,h,d),c(i,t.getAxisAngle(i,d))},e.copy=function(e,t=o()){return a(e[0],e[1],e[2],e[3],t)},e.create=o,e.fromAxisAndAngle=function(e,t){const r=o();return i.copy(r,e),r[3]=t,r},e.fromPoints=function(e,t,r){return i.cross(r,e,t),i.normalize(r,r),r[3]=s.angle(e,t),r},e.fromValues=a,e.setAngle=c,e.up=u,e.wrap=function(e,t,r,i){return a(e,t,r,i,n.sv4d.get())},e.wrapAxisAngle=function(e,t){return a(e[0],e[1],e[2],t,n.sv4d.get())},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/geometryUtils/ray":function(){define(["exports","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../geometry/support/ray","../../../../geometry/support/vectorStacks"],(function(e,t,r,i,s,n){"use strict";function o(e,r,i){return a(e,e.screenToRender(r,t.castRenderScreenPointArray3(n.sv3d.get())),i)}function a(e,s,o){const a=t.castRenderScreenPointArray3(r.copy(n.sv3d.get(),s));if(a[2]=0,!e.unprojectFromRenderScreen(a,o.origin))return null;const l=t.castRenderScreenPointArray3(r.copy(n.sv3d.get(),s));l[2]=1;const c=e.unprojectFromRenderScreen(l,n.sv3d.get());return null==c?null:(i.subtract(o.direction,c,o.origin),o)}function l(e,t,r){i.copy(r.origin,e.eye);const s=i.set(n.sv3d.get(),t[0],t[1],1),o=e.unprojectFromRenderScreen(s,n.sv3d.get());return null==o?null:(i.subtract(r.direction,o,r.origin),r)}e.fromRender=a,e.fromRenderAtEye=l,e.fromScreen=o,e.fromScreenAtEye=function(e,r,i){return l(e,e.screenToRender(r,t.castRenderScreenPointArray3(n.sv3d.get())),i)},e.fromScreenNormalized=function(e,r,n=s.create()){return o(e,t.screenPointObjectToArray(r),n),i.normalize(n.direction,n.direction),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/geometryUtils/sphere":function(){define(["exports","../../../../geometry/support/ray","../../../../chunks/sphere","./ray"],(function(e,t,r,i){"use strict";const s=t.create();e.intersectScreen=function(e,t,n,o){const a=i.fromScreenAtEye(t,n,s);return r.intersectRay(e,a,o)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/ZoomStepControllerLocal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/time","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../layers/VoxelWasm","./PointToPointAnimationController","../utils/navigationUtils","../../webgl/RenderCamera","../../webgl-engine/lib/Intersector","../../../animation/easing"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v){"use strict";e.ZoomStepControllerLocal=class extends g.PointToPointAnimationController{constructor(){super(...arguments),this._zoomLocation=u.create(),this._tmpCamera=new _,this._tmpRayDir=u.create(),this._tmpCenter=u.create(),this._beginCamera=new _,this._constraintOptions=new h.ConstraintOptions(p.ConstraintTypes.ALL,m.InteractionType.ZOOM,null,this._beginCamera)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const s=new b.Intersector(this.view.state.viewingMode);let n=!1;e>0?(n=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.basemapTerrain.invisible?y.excludeTerrain:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:c.copy(this._zoomLocation,this._tmpCamera.center);const o=.6**e;let a=this.view.stage.renderView.getMinimalDepthForArea(f.getVoxelWasm(this.view),t[0],t[1],this.view.state.camera,60);c.subtract(x,this._tmpCamera.eye,this._zoomLocation),c.normalize(x,x);const l=r.clamp(Math.min(y.zoomDistanceModifier,1/Math.abs(c.dot(w,x)))*Math.abs(this.view.camera.position.z),y.zoomMinDistanceModifier,y.zoomMaxDistanceModifier);if(a=null!=a?a:l,a){const e=u.create();c.subtract(e,this._zoomLocation,this._tmpCamera.eye),(a<c.length(e)||!n)&&(c.normalize(e,e),c.add(this._zoomLocation,this._tmpCamera.eye,c.scale(e,e,a)))}this._updateCamera(this._tmpCamera,o,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:i.Milliseconds(600),easing:v.outExpo}}_updateCamera(e,t,r){c.subtract(this._tmpRayDir,r,e.eye);const i=c.length(this._tmpRayDir);let s=i*t;const n=t<=1,o=Math.max(4,1.01*e.nearFar[0]);0!==s&&(n&&s<o&&(s=o,t=s/i),Math.abs(i-s)<1e-6||(c.scale(this._tmpRayDir,this._tmpRayDir,t),e.eye=c.subtract(S,r,this._tmpRayDir),e.center=c.lerp(S,e.center,r,1-t),d.applyAll(this.view,e,this._constraintOptions)))}},e.ZoomStepControllerLocal=t.__decorate([l.subclass("esri.views.3d.state.controllers.ZoomStepControllerLocal")],e.ZoomStepControllerLocal);const S=u.create(),w=u.fromValues(0,0,1),x=u.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/VoxelWasm":function(){define(["require","exports"],(function(e,t){"use strict";const r=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let i,s=null;const n=new Map;t.addLayerViewToWasm=async function(t){null==s&&(null==i&&(i=new Promise(((t,i)=>e(["../../../layers/VoxelWasmPerSceneView"],(e=>t(r(e))),i)))),s=await i);const o=t.view;let a=n.get(o);return a||(a=new s.default({view:o}),n.set(o,a)),a.addVoxelLayer(t)},t.getVoxelWasm=function(e){return n.get(e)},t.removeLayerViewFromWasm=function(e){const t=e.view,r=n.get(t);r&&r.removeVoxelLayer(e)<1&&(n.delete(t),0===n.size&&(i=null,s=null))},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/handlers/support":function(){define(["exports"],(function(e){"use strict";function t(e,t){switch(t){case"primary":return"touch"===e.pointerType||0===e.button;case"secondary":return"touch"!==e.pointerType&&2===e.button;case"tertiary":return"touch"!==e.pointerType&&1===e.button}}e.eventMatchesMousePointerActions=function(e,t){const{button:r,pointerType:i}=e;return"touch"!==i&&t.some((e=>"primary"===e&&0===r||"secondary"===e&&2===r||"tertiary"===e&&1===r))},e.eventMatchesPointerAction=t,e.eventMatchesPointerActions=function(e,r){return r.some((r=>t(e,r)))},e.getPointerActions=function(e,{dragPrimary:t,dragSecondary:r,dragTertiary:i}){return[{key:"primary",value:t},{key:"secondary",value:r},{key:"tertiary",value:i}].filter((t=>t.value===e)).map((e=>e.key))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/input/handlers/DragRotate":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/RotateController","../../../input/InputHandler","../../../input/handlers/support"],(function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e,t,r,i){super(!0),this._view=e,this.pointerActions=t,this._pivot=r,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){const i=e.data;if(i.pointers.size>1)return;if(!s.eventMatchesMousePointerActions(e.data,this.pointerActions))return;const n=t.createScreenPointArray(i.center.x,i.center.y);switch(i.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new r.RotateController({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(n);break;case"update":this._cameraController&&this._cameraController.update(n);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}Object.defineProperty(e,"PivotPoint",{enumerable:!0,get:()=>r.PivotPoint}),e.DragRotate=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/RotateController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../camera/constraintUtils/TiltMode","../../layers/VoxelWasm","../Constraints","./InteractiveController","../utils/navigationUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x){"use strict";var T;e.PivotPoint=void 0,(T=e.PivotPoint||(e.PivotPoint={}))[T.CENTER=0]="CENTER",T[T.EYE=1]="EYE",e.RotateController=class extends w.InteractiveController{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(t){super(t),this.pivot=e.PivotPoint.CENTER,this._rotScale=0,this._lastPoint=h.create(),this._tmpWorldUp=m.create(),this._tmpViewDir=m.create(),this._tmpRotCurPoint=h.create(),this._tmpTransf=u.create(),this._tmpAxis=m.create(),this._tmpPivotPoint=m.create(),this._pivotPos=m.create(),this._constraintOptions=new g.ConstraintOptions(y.ConstraintTypes.ALL,_.InteractionType.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===e.PivotPoint.CENTER?3:1.5}begin(t){if(this.running){switch(this.pivot){case e.PivotPoint.EYE:p.copy(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=_.InteractionType.LOOK_AROUND,this._constraintOptions.tiltMode=b.TiltMode.LOOK_AROUND,this._constraintOptions.selection=y.ConstraintTypes.NONE;break;case e.PivotPoint.CENTER:{const e=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.basemapTerrain.invisible?x.excludeTerrain:{});e||p.copy(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(t,e),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=_.InteractionType.TUMBLE,this._constraintOptions.tiltMode=b.TiltMode.TUMBLE,this._constraintOptions.selection=y.ConstraintTypes.ALL&~y.ConstraintTypes.DISTANCE;break}}x.normalizeCoordinate(this.startCamera,t,this._lastPoint)}}_constrainPivotPoint(e,t){const r=this.startCamera,s=m.create();p.subtract(s,this._pivotPos,r.eye);const n=p.length(s),o=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(r.eye,P);let a=Math.max(Math.min(x.rotatePivotDistanceModifier,1/Math.abs(p.dot(P,r.viewForward)))*o,x.rotatePivotMinDistanceModifier);t&&(a=Math.min(n,a));const l=i.createScreenPointArray(r.width/r.pixelRatio*.5,r.height/r.pixelRatio*.5),c=x.navigationMode(this.startCamera,l,this.view.renderCoordsHelper,this.view.viewingMode);let u=this.view.stage.renderView.getMinimalDepthForArea(v.getVoxelWasm(this.view),r.fullWidth/r.pixelRatio*.5,r.fullHeight/r.pixelRatio*.5,r,2.5*x.rotateScreenPixelArea,x.rotateScreenPixelArea),d=this.view.stage.renderView.getMinimalDepthForArea(v.getVoxelWasm(this.view),e[0],e[1],r,x.rotateScreenPixelArea);null==u&&null==d||(u=u??d??0,d=null==d||c===x.NavigationMode.Horizontal?u:d,a=u>d?d:u,a=t?Math.min(a,n):a),p.normalize(s,s),p.copy(this._pivotPos,p.add(this._tmpPivotPoint,r.eye,p.scale(this._tmpPivotPoint,s,a)))}update(t){if(this.running){switch(this.pivot){case e.PivotPoint.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,t,this.currentCamera.center,this._pivotPos);break;case e.PivotPoint.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,t,this.currentCamera.eye,this._pivotPos)}f.applyAll(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(t,i,s,n){this.view.renderCoordsHelper.worldUpAtPosition(n,this._tmpWorldUp),x.normalizeCoordinate(t,i,this._tmpRotCurPoint);let o=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;p.subtract(this._tmpViewDir,s,n);const l=p.length(this._tmpViewDir),u=r.acosClamped(p.dot(this._tmpViewDir,this._tmpWorldUp)/l);if(this.pivot===e.PivotPoint.EYE){o*=-.5;const e=.5*Math.PI-u,t=.5*Math.PI*.99;o=e-Math.max(-t,Math.min(t,e+o))}return o=r.clamp(o+u,S.TiltRange.min,S.TiltRange.max)-u,p.cross(this._tmpAxis,t.up,this._tmpViewDir),this.pivot===e.PivotPoint.CENTER&&(a=-a),c.fromRotation(this._tmpTransf,a,this._tmpWorldUp),c.rotate(this._tmpTransf,this._tmpTransf,o,this._tmpAxis),p.transformMat4(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),t.up=p.transformMat4(C,t.up,this._tmpTransf),p.add(C,n,this._tmpViewDir),d.copy(this._lastPoint,this._tmpRotCurPoint),C}},t.__decorate([s.property()],e.RotateController.prototype,"pivot",void 0),e.RotateController=t.__decorate([l.subclass("esri.views.3d.state.controllers.RotateController")],e.RotateController);const C=m.create(),P=m.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/InteractiveController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/clock","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../ViewStateManager","./CameraController","../../webgl/RenderCamera"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.InteractiveController=class extends c.CameraController{constructor(){super(...arguments),this.startCamera=new u,this.currentCamera=new u,this._isInteractive=!1,this._interactingTimeoutHandle=void 0}get isInteractive(){return this._isInteractive}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=c.State.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._isInteractive=!0,this._interactingTimeoutHandle?.remove(),this._interactingTimeoutHandle=r.clock.setTimeout((()=>{this._isInteractive=!1,this._interactingTimeoutHandle=void 0}),l.interactingTimeout),this.view.state.updateCamera((e=>this.stepController(0,e))),this.steppingFinished&&this.finishController()}},t.__decorate([i.property({readOnly:!0})],e.InteractiveController.prototype,"isInteractive",null),t.__decorate([i.property()],e.InteractiveController.prototype,"_isInteractive",void 0),e.InteractiveController=t.__decorate([a.subclass("esri.views.3d.state.controllers.InteractiveController")],e.InteractiveController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/ViewStateManager":function(){define(["exports","../../../chunks/tslib.es6","../../../Camera","../../../Viewpoint","../../../core/Accessor","../../../core/Logger","../../../core/maybe","../../../core/reactiveUtils","../../../core/scheduling","../../../core/screenUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/projectionUtils","../../ViewingMode","../camera/constraintUtils","../camera/intersectionUtils","./ConstraintsManager","./Frustum","./GoToOperation","./controllers/SurfaceCollisionCorrectionController","../support/cameraUtils","../support/viewpointUtils","../webgl/RenderCamera","../webgl-engine/lib/rendererUtils","../webgl-engine/lib/RenderFeature","../../support/PropertiesPool","../../support/RenderState","../../webgl/FramebufferObject"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N){"use strict";e.ViewStateManager=class extends s{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=W,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?W:0}},this._propertiesPool=new F.PropertiesPool({frustum:P.Frustum},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new U}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([a.on((()=>this.view.state.events),"before-camera-change",(({camera:e})=>e&&this._updateElevation(e))),a.watch((()=>this.view.state?.camera),((e,t)=>this._cameraChangedHandler(e,t)),a.sync)]),a.when((()=>this.view.state?.camera),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this.addHandles([l.addFrameTask({prepare:()=>this._prepareFrame()}),a.watch((()=>this.view.state.cameraController),(()=>{this._cameraSetByUser=!0,this.removeHandles(q)})),a.on((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale")))])}destroy(){this.exit(),this._propertiesPool=o.destroyMaybe(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=E.internalToExternal(this.view,this.view.state.camera,k);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableCache(!0),this.setStateCamera(E.externalToInternal(this.view,e),{applyConstraints:!1})||n.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=E.internalToExternal(this.view,this.view.state.contentCamera,k);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=E.externalToInternal(this.view,e);this.view.state.contentCamera=null!=t?t:null}installContentCameraReset(e){if(this.removeHandles(H),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,r=this.view.state.camera.distance**2,i=f.fromArray(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.addHandles([a.watch((()=>this.contentCamera),(()=>{e.sticky||(this.removeHandles(H),this.test.contentCameraResetState.clear())})),a.watch((()=>this.zoom),(e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s))})),a.watch((()=>this.view.state.camera),(e=>{const t=m.squaredDistance(i,e.center);this.test.contentCameraResetState.set("camera.center",t/r),t>r?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}))],H),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():n.getLogger(this).error("#center=","Invalid center",e):n.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):n.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?v.fromExtent(e):null}return E.toArea(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=E.toExtent(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||n.getLogger(this).error("#extent=","Invalid extent",e):n.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):n.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){const e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?E.applyTiltAdjustToScale(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||n.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,r=e.pixelRatio,i=this._get("padding"),s=Math.round(t[I.PaddingSide.TOP]/r),n=Math.round(t[I.PaddingSide.RIGHT]/r),o=Math.round(t[I.PaddingSide.BOTTOM]/r),a=Math.round(t[I.PaddingSide.LEFT]/r);return null!=i&&i.top===s&&i.right===n&&i.bottom===o&&i.left===a?i:{top:s,right:n,bottom:o,left:a}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,j),this.view.state.updateCamera((e=>e.padding=j)))}_paddingToArray(e,t,r){e?g.set(r,e.top||0,e.right||0,e.bottom||0,e.left||0):g.set(r,0,0,0,0);for(let e=0;e<4;e++)r[e]=Math.round(r[e]*t)}get screenCenter(){const e=this.padding;return c.createScreenPoint((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?O.fromCamera(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||n.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const t=null!=e.camera?e.camera.position:e.targetGeometry,r=null!=t&&t.spatialReference;n.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(r?r.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}else n.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?E.scaleToZoom(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||n.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const r=this.view.stage.renderView.renderingContext?.parameters.maxTextureSize;return r&&N.ensureAttachmentMaxSize(this._tmpCanvasSize,r),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?.stage?.renderer.isFeatureEnabled(D.RenderFeature.PhysicalPixelRendering)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?.stage?.renderer;return e&&(e.isFeatureEnabled(D.RenderFeature.PhysicalPixelRendering,L.RenderState.IDLE)||e.isFeatureEnabled(D.RenderFeature.PhysicalPixelRendering,L.RenderState.INTERACTING)||e.isFeatureEnabled(D.RenderFeature.PhysicalPixelRendering,L.RenderState.ANIMATING))}preinit(e){return!(this._isOverridden("center")&&!S.isLoadedOrLoadFor(this.center.spatialReference,e)||this._isOverridden("camera")&&!S.isLoadedOrLoadFor(this.camera.position.spatialReference,e)||this._isOverridden("extent")&&!S.isLoadedOrLoadFor(this.extent.spatialReference,e)||!(!this._isOverridden("viewpoint")||S.isLoadedOrLoadFor(this.viewpoint.targetGeometry?.spatialReference,e)&&S.isLoadedOrLoadFor(this.viewpoint.camera?.position?.spatialReference,e)))}init(){this._constraintsManager=new C.ConstraintsManager({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===w.ViewingMode.Local&&this.addHandles(a.when((()=>this.view.basemapTerrain.ready),(()=>{this.removeHandles(q),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),q)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(q),this._constraintsManager=o.destroyMaybe(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},null!=this._gotoOperation&&this._gotoOperation.abort(t.animate),this._gotoOperation=new M.GoToOperation(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(T.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,r=t?.cameraController;r&&(t.updateCamera((t=>r.stepController(e,t))),r.steppingFinished&&r.finishController())}_cancelGoToOperation(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:r,overrides:i}of B){const s=e.has(r),n=this._isOverridden(r);!s&&n&&t.push({name:r,value:this._get(r)}),this._clearOverride(r),(s||n)&&i.forEach((t=>e.add(t)))}return t}_setInitialView(e){if(null==e||this._cameraSetByUser)return;if(e instanceof r)return void this.setStateCamera(E.externalToInternal(this.view,e),{applyConstraints:!1});if(e instanceof i){if(e.targetGeometry instanceof _){const t=E.fromExtentSync(this.view,e.targetGeometry,0,.5,E.OrientationMode.LOCKED);return void(null!=t&&this.setStateCamera(E.externalToInternal(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,t)}const t=E.fromExtentSync(this.view,e,0,.5,E.OrientationMode.LOCKED);null!=t&&this.setStateCamera(E.externalToInternal(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&V.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return null!=e&&(e instanceof i?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof r?this.isCompatible(e.position):e.spatialReference&&!S.requiresLoad(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=G){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,r=z){const{heading:i,tilt:s}=this._getPreservingHeadingTilt(),n=E.getObserverForPointAtDistanceSync(this.view,i,s,e,t,E.OrientationMode.ADJUST);return null==n?null:(r.copyFrom(this.view.state.camera),r.eye=n.eye,r.center=n.center,r.up=n.up,r)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:e}=this.view.pointsOfInterest;e.runTask(),t=e.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:r}=this._getPreservingHeadingTilt(),i=E.fromExtentSync(this.view,e,t,r,E.OrientationMode.ADJUST,k);return i?E.externalToInternal(this.view,i):null}_scaleToCamera(e){if(null==e)return null;const t=this.view,r=t.pointsOfInterest.centerOnContent;r.runTask();const i=r.renderLocation,s=t.pointsOfInterest.cameraOnSurface.renderLocation,n=E.viewScaleToCameraDistance(t,e,t.state.contentCamera,i,s);return this._centerPointAtDistanceToCamera(i,n)}_zoomToCamera(e){return this._scaleToCamera(E.zoomToScale(this.view,e))}_viewpointToCamera(e){return E.externalToInternal(this.view,O.toCameraSync(this.view,e))}setStateCamera(e,t){return!(null==e||!this.view.state.stopActiveCameraController()||(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((r=>{t.positionAndOrientationOnly?(r.eye=e.eye,r.center=e.center,r.up=e.up,r.fov=e.fov):r.copyFrom(e),t.applyConstraints&&x.applyAll(this.view,r)})),t.applyConstraints||(this.view.state.cameraController=new R.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:e})),0))}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const r=this._computeCanvasSize();if(0!==r.width&&0!==r.height&&(t.width===r.width&&t.height===r.height||(t.width=r.width,t.height=r.height),this.view.state)){const e=this.view.state.camera;e.fullWidth===r.width&&e.fullHeight===r.height&&e.pixelRatio===r.pixelRatio||(z.copyFrom(e),z.pixelRatio!==r.pixelRatio&&(this._paddingToArray(this.padding,r.pixelRatio,j),z.padding=j),z.fullWidth=r.width,z.fullHeight=r.height,z.pixelRatio=r.pixelRatio,this.view.state.camera=z),this._updateViewState()}}_updateElevation(e){const t=this.view.basemapTerrain?.spatialReference,r=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,i=t?T.surfaceElevationBelowRenderLocation(this.view,e.eye):0;e.relativeElevation=r-i}_updateViewState(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=L.RenderState.ANIMATING:this.view.interacting?this.view.state.mode=L.RenderState.INTERACTING:(this.view.state.mode===L.RenderState.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=L.RenderState.INTERACTING:this.view.state.mode=L.RenderState.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}},t.__decorate([u.property({type:r,dependsOn:["view.state.camera","ready"]})],e.ViewStateManager.prototype,"camera",null),t.__decorate([u.property({type:r,dependsOn:["view.state.contentCamera","ready"]})],e.ViewStateManager.prototype,"contentCamera",null),t.__decorate([u.property({type:b})],e.ViewStateManager.prototype,"center",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"visibleArea",null),t.__decorate([u.property({type:_})],e.ViewStateManager.prototype,"extent",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"frustum",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"_constraintsManager",void 0),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"constraintsManager",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"_initialViewpoint",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"hasInitialView",null),t.__decorate([u.property({readOnly:!0,type:Boolean})],e.ViewStateManager.prototype,"ready",void 0),t.__decorate([u.property({type:Number})],e.ViewStateManager.prototype,"scale",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"padding",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"screenCenter",null),t.__decorate([u.property({constructOnly:!0})],e.ViewStateManager.prototype,"view",void 0),t.__decorate([u.property({type:i})],e.ViewStateManager.prototype,"viewpoint",null),t.__decorate([u.property({type:Number})],e.ViewStateManager.prototype,"zoom",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"_rasterPixelRatio",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"_usePhysicalPixelRendering",null),t.__decorate([u.property({readOnly:!0})],e.ViewStateManager.prototype,"_usePhysicalPixelRenderingAny",null),t.__decorate([u.property()],e.ViewStateManager.prototype,"_windowDevicePixelRatio",void 0),t.__decorate([u.property()],e.ViewStateManager.prototype,"_devicePixelRatioOverride",void 0),e.ViewStateManager=t.__decorate([p.subclass("esri.views.3d.state.ViewStateManager")],e.ViewStateManager);class U{constructor(){this.width=0,this.height=0,this.pixelRatio=1}}const V=new Set(["camera","viewpoint","extent","scale","center","zoom"]),B=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],G={heading:0,tilt:0},k=new r,z=new A,j=y.create(),q="pending-initial-view",H="content-camera-reset",W=300;e.interactingTimeout=100,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/ConstraintsManager":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/mathUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../ViewingMode","../camera/constraintUtils","../camera/intersectionUtils","../camera/constraintUtils/ConstraintOptions","../camera/constraintUtils/ConstraintTypes","../camera/constraintUtils/InteractionType","./NearFarHeuristic","./SurfaceCollisionConstraint"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";function _(e,t){t&&(e.near=t.near,e.far=t.far)}e.ConstraintsManager=class extends r{constructor(e){super(e),this.nearFarHeuristic=g.createNearFarHeuristic(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([s.watch((()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far]),(()=>this._clipDistanceNearFarChanged())),s.watch((()=>this.view.constraints?.clipDistance?.mode),(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(({camera:e,sceneDepthRange:t})=>this._updateCameraNearFar(e,t))),s.watch((()=>this.view.stage.renderer.sceneDepthRange.value),(()=>this._updateNearFar()),s.sync),s.watch((()=>this.view.renderDataExtent),(()=>this._updateNearFar()),s.sync),s.watch((()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max]),(()=>this._updateAltitude()),s.sync),s.watch((()=>this.view.constraints?.tilt?.max),(()=>this._updateTiltMax()),s.sync),s.watch((()=>this.view.constraints?.tilt?.mode),(()=>this._updateTilt()),s.sync),s.watch((()=>this.view.state?.camera),(()=>this._updateTiltAutoMax()),s.sync),s.watch((()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled]),(()=>this._updateCollision()),s.sync)]),this.view.state.isLocal&&this.addHandles(s.watch((()=>this.view.renderDataExtent),(e=>this._updateLocalSurfaceDistance(e)),s.initial)),this._updateNearFar(),this.view.state.viewingMode!==u.ViewingMode.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new y.SurfaceCollisionConstraint({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>_(t,e)))}_updateNearFar(){this.view.state.updateCamera((e=>this._updateCameraNearFar(e)))}_updateCameraNearFar(e,t){const r=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(r?r.mode:"auto")?_(e,r):this._updateCameraNearFarAuto(e,r,t)}_updateCameraNearFarAuto(e,t,r){const i=h.surfaceElevationBelowRenderLocation(this.view,e.eye),s=this.nearFarHeuristic.compute(e,this.view.renderDataExtent,r??this.view.stage.renderer.sceneDepthRange.value,i);e.near=s.near,e.far=s.far,t&&t.autoUpdate(e.near,e.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||"stay-above"===e,r=this.view.state.constraints.collision;if(t!==r.enabled){r.enabled=t,t&&this._reapplyConstraints(m.ConstraintTypes.COLLISION);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==u.ViewingMode.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(i.deg2rad(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const r=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(i.rad2deg(r))}}_updateLocalSurfaceDistance(e){if(null==e)return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const r=this.view.state,i=3*t/Math.atan(r.camera.fov/2);i!==r.constraints.distance&&(r.constraints.distance=i)}_reapplyConstraints(e=m.ConstraintTypes.ALL){this.view.state.updateCamera((t=>d.applyAll(this.view,t,new p.ConstraintOptions(e,f.InteractionType.NONE,null))))}},t.__decorate([n.property({constructOnly:!0})],e.ConstraintsManager.prototype,"view",void 0),t.__decorate([n.property({readOnly:!0})],e.ConstraintsManager.prototype,"surfaceCollisionConstraint",void 0),e.ConstraintsManager=t.__decorate([c.subclass("esri.views.3d.state.ConstraintsManager")],e.ConstraintsManager),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/SurfaceCollisionConstraint":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../camera/intersectionUtils","../camera/constraintUtils/surfaceCollision"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";e.SurfaceCollisionConstraint=class extends r{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e))))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;null!=e.spatialReference&&l.eyeWithinExtent(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera((e=>c.applySurfaceCollisionConstraint(this.view,e,c.Mode.EYE_AND_CENTER)))}},t.__decorate([i.property({constructOnly:!0})],e.SurfaceCollisionConstraint.prototype,"view",void 0),e.SurfaceCollisionConstraint=t.__decorate([a.subclass("esri.views.3d.state.SurfaceCollisionConstraint")],e.SurfaceCollisionConstraint),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/GoToOperation":function(){define(["exports","../../../Camera","../../../Viewpoint","../../../core/Error","../../../core/promiseUtils","../../../core/reactiveUtils","../camera/constraintUtils","../camera/constraintUtils/surfaceCollision","./controllers/CameraController","./controllers/PointToPointAnimationController","./controllers/SurfaceCollisionCorrectionController","../support/cameraUtils","../support/viewpointUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.GoToOperation=class{constructor(e,t,r){this._target=e,this._options=t,this.view=r,this.state="pending",this._animationController=null,this.promise=new Promise(((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const r=new AbortController;null!=this._options.signal&&s.onAbort(this._options.signal,(()=>this.abort())),this._abortController=r,this._waitForReady()}))}_resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}_reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject(s.createAbortError())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await n.whenOnce((()=>this.view.ready),this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if("finished"!==this.state){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await h.create(this.view,this._target,this._abortController.signal);if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(null==t)return;if(this._options.animate){if(null==this._animationController)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){const s=!!(this._target instanceof r&&this._target.camera||this._target instanceof t),n=e.camera;if(null==n)return null;if(!this.view.stateManager.isCompatible(n)){const e=n.position,t=e&&e.spatialReference,r=t?t.wkid:"none",s=this.view.spatialReference?.wkid;return this._reject(new i("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${r}, view: ${s})`,{camera:n})),null}const o=d.externalToInternal(this.view,n);return null==o?(this._reject(new i("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:o,isFullySpecified:s}}_startAnimation(e,t){this.state="wait-for-animation-finish";const r=t.viewAnimation;if(null==r)return void this._reject(new i("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(e.viewpoint,"running"),!t.running||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let s;e.isFullySpecified?(s=new u.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:e.camera}),a.applySurfaceCollisionConstraint(this.view,e.camera,a.Mode.EYE_AND_CENTER)):o.applyAll(this.view,e.camera),t.begin(e.camera,this._options);const n=e=>{if(null!=this.view.state)switch(t.state){case l.State.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case l.State.Ready:case l.State.Rejected:case l.State.Running:case l.State.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(e)}}};r.when((()=>{const r=this.view.state.cameraController;s&&(r&&r.running?c.isPointToPointAnimationController(r)&&null!=r.viewAnimation&&r.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&t.state===l.State.Finished&&(this.view.state.cameraController=s))}),(e=>n(e))),t.asyncResult={resolve:()=>n(),reject:e=>n(e)}}_getAnimationController(){let e=null,t=null;const r=this.view.state.cameraController;return c.isPointToPointAnimationController(r)&&(r.updateStateFromViewAnimation(),r.running&&(e=r,t=e.viewAnimation)),null==e&&(e=new c.PointToPointAnimationController({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),e.state===l.State.Rejected)?(t?.stop(),this._reject(new i("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/SurfaceCollisionCorrectionController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../camera/intersectionUtils","../../camera/constraintUtils/surfaceCollision","./CameraController"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";e.SurfaceCollisionCorrectionController=class extends c.CameraController{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=c.State.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e)))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(null==e.spatialReference||a.eyeWithinExtent(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),l.applySurfaceCollisionConstraint(this.view,e,l.Mode.EYE_AND_CENTER)||this.constraintEnabled||(this.state=c.State.Stopped)}))}},t.__decorate([r.property({constructOnly:!0})],e.SurfaceCollisionCorrectionController.prototype,"desiredCamera",null),e.SurfaceCollisionCorrectionController=t.__decorate([o.subclass("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],e.SurfaceCollisionCorrectionController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/viewpointUtils":function(){define(["exports","../../../Camera","../../../Graphic","../../../Viewpoint","../../../core/asyncUtils","../../../core/has","../../../core/Cyclical","../../../core/Error","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/Multipoint","../../../geometry/Point","../../../geometry/projectionUtils","../../../geometry/SpatialReference","../../../geometry/projection/computeTranslationToOriginAndRotation","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToPoint","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/scaleUtils","../camera/intersectionUtils","./cameraUtils","./ElevationProvider"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O){"use strict";function A(e){return 360-o.cyclicalDegrees.normalize(e)}function I(e){return o.cyclicalDegrees.normalize(360-e)}async function D(e,t,r,i){const s=t.camera;if(null!=s)return async function(e,t,r){const i=e.position,s=await _.projectWithZConversion(i,t,{signal:r});l.throwIfAborted(r);const n=e.clone();return n.position=s.clone(),n}(s,E.getViewSR(e),i);const{targetGeometry:n}=t;if(null==n)throw new Error("Viewpoint has no targetGeometry!");const{camera:o,mode:a}=F(e,t.rotation,r);if("point"===n.type)return async function(e,t,r,i,s,n){const o=e.spatialReference,a=await _.projectWithZConversion(r.clone(),o,{signal:n});l.throwIfAborted(n);const c=null!=t.scale?E.scaleToDistance(e,t.scale):e.state.camera.distance;return E.fromCenterDistanceAsync(e,a,c,i,s,n)}(e,t,n,o,a,i);const c=n.extent;if(null==c)throw new Error("Target geometry has no extent!");return E.fromExtentAsync(e,c,o.heading,o.tilt,a,i)}function F(e,t,r){const i=E.internalToExternal(e,e.state.camera);let s=E.OrientationMode.ADJUST;return null!=t&&(i.heading=A(t),s=E.OrientationMode.LOCKED),null!=r&&(i.tilt=r),{camera:i,mode:s}}function L(e,t){return null==t.scale&&null!=t.zoom?E.zoomToScale(e,t.zoom):t.scale}function N(e,t){let r=!1;return null!=t.heading?(e.heading=t.heading,r=!0):null!=t.rotation&&(e.heading=A(t.rotation),r=!0),null!=t.tilt&&(e.tilt=t.tilt,r=!0),null!=t.fov&&(e.fov=t.fov),r}function U(e,t,r,i){const s=e.spatialReference||b.WGS84;if(t??=E.externalToInternal(e,r),null==t)return i;const n=new y({spatialReference:s});return w.projectVectorToPoint(t.center,e.renderSpatialReference,n)?(i.targetGeometry=n,i.scale=E.distanceToScale(e,t.distance),i.rotation=I(r.heading),i.camera=r,i):i}async function V(e,t,r,i){const s=()=>new a("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!t)throw s();"mesh"===t.type&&(t=t.extent);const n=e.basemapTerrain.spatialReference;if(!t.hasZ&&e.basemapTerrain){let r;switch(t.type){case"point":r=t;break;case"multipoint":case"polyline":r=t.extent?.center;break;case"extent":r=t.center;break;case"polygon":r=t.centroid}null!=r&&n&&e.elevationProvider?(r=await _.projectWithZConversion(r,n,{signal:i}),q[2]=O.getElevationAtPoint(e.elevationProvider,r)??0):q[2]=0}const o=ee[t.type],l=new Array;if(o(t,t.hasZ?e=>{l.push([e[0],e[1],e[2]])}:e=>{l.push([e[0],e[1]])},q),0===l.length)throw s();const c=t.spatialReference,u=e.spatialReference,d=await _.projectWithZConversion(new g({spatialReference:c,hasZ:t.hasZ,hasM:!1,points:l}),u,{signal:i});if(t.hasZ&&(r.hasZ=!0),t.hasZ)for(const[e,t,i]of d.points)q[0]=e,q[1]=t,q[2]=i,T.expandWithVec3(r.boundingBox,q);else for(const[e,t]of d.points)q[0]=e,q[1]=t,T.expandWithVec3(r.boundingBox,q)}async function B(e,t,i,n,o){if(Array.isArray(t)&&2===t.length){const r=t[0],i=t[1];if("number"==typeof r&&"number"==typeof i)return J.x=r,J.y=i,J.z=void 0,J.spatialReference=e.spatialReference?.isGeographic?e.spatialReference:b.WGS84,void await V(e,J,n,o)}t&&"map"in t&&"function"==typeof t.map?await Promise.allSettled(t.map((t=>B(e,t,i,n,o)))):t instanceof f?await V(e,t,n,o):t instanceof r&&await async function(e,t,r,i,n){const o=await s.result(e.whenViewForGraphic(t));if(!1===o.ok||null==o.value||!("whenGraphicBounds"in o.value))return void await V(e,t.geometry,i,n);const a=o.value,l=await s.result(a.whenGraphicBounds(t,{minDemResolution:r}));if(!1===l.ok||!l.value)return void await V(e,t.geometry,i,n);const{screenSpaceObjects:c,boundingBox:u}=l.value;T.expandWithAABB(i.boundingBox,u),c&&c.forEach((e=>{i.screenSpaceObjects.push(e)})),isFinite(u[2])&&(i.hasZ=!0)}(e,t,i,n,o)}async function G(e,t,r,i){const s=e.spatialReference,n=await _.projectWithZConversion(t.position,s,{signal:r}),o=t.clone();return o.position=n,U(e,null,o,i)}async function k(e,t,r,i,s,n){n.targetGeometry=r.clone();const o=R.cameraOnContentAlongViewDirection(e);if(t.position)return async function(e,t,r,i,s,n,o){const a=e.renderSpatialReference;return await S.projectPointToVectorAsync(t,X,a,0,{signal:o}),await S.projectPointToVectorAsync(r,Y,a,0,{signal:o}),n.targetGeometry=new y(t),s.position=new y(r),h.subtract(Z,X,Y),E.directionToHeadingTilt(e,Y,Z,i.up,s),n.scale=E.distanceToScale(e,h.distance(Y,X)),n.rotation=I(s.heading),n.camera=s,n}(e,n.targetGeometry,t.position,o,i,n,s);if(t.zoomFactor){const r=o.distance/t.zoomFactor,i=h.scale(q,o.viewForward,-r);o.eye=h.add(q,o.center,i),n.scale=E.distanceToScale(e,r)}E.internalToExternal(e,o,i);const a=N(i,t)?E.OrientationMode.LOCKED:E.OrientationMode.ADJUST;if(!t.zoomFactor){const r=L(e,t);if(null==r){await S.projectPointToVectorAsync(n.targetGeometry,q,e.renderSpatialReference,0,{signal:s});const t=P.intersectsPoint(o.frustum,q)?h.distance(o.eye,q):o.distance;n.camera=await E.fromCenterDistanceAsync(e,n.targetGeometry,t,i,a),n.scale=E.distanceToScale(e,t)}else n.scale=r,n.camera=await E.fromCenterScale(e,n.targetGeometry,n.scale,i,a,s)}return n}function z(e){return null!=e?.camera&&(e.rotation=I(e.camera.heading)),e}class j{constructor(){this.hasZ=!1,this.boundingBox=T.empty(),this.screenSpaceObjects=new Array}}const q=p.create(),H=d.create(),W=u.create(),$=T.create(),Q=C.create(),Z=p.create(),Y=p.create(),X=p.create(),K={heading:0,tilt:0},J=new y,ee={point(e,t,r){r[0]=e.x,r[1]=e.y,null!=e.z&&(r[2]=e.z),t(r)},polygon(e,t,r){const i=e.hasZ;for(let s=0;s<e.rings.length;s++){const n=e.rings[s];for(let e=0;e<n.length;e++)r[0]=n[e][0],r[1]=n[e][1],i&&(r[2]=n[e][2]),t(r)}},polyline(e,t,r){const i=e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s];for(let e=0;e<n.length;e++)r[0]=n[e][0],r[1]=n[e][1],i&&(r[2]=n[e][2]),t(r)}},multipoint(e,t,r){const i=e.points,s=e.hasZ;for(let e=0;e<i.length;e++)r[0]=i[e][0],r[1]=i[e][1],s&&(r[2]=i[e][2]),t(r)},extent(e,t,r){null!=e.zmin&&null!=e.zmax?(t(h.set(r,e.xmin,e.ymin,e.zmin)),t(h.set(r,e.xmax,e.ymin,e.zmin)),t(h.set(r,e.xmin,e.ymax,e.zmin)),t(h.set(r,e.xmax,e.ymax,e.zmin)),t(h.set(r,e.xmin,e.ymin,e.zmax)),t(h.set(r,e.xmax,e.ymin,e.zmax)),t(h.set(r,e.xmin,e.ymax,e.zmax)),t(h.set(r,e.xmax,e.ymax,e.zmax))):(t(h.set(r,e.xmin,e.ymin,r[2])),t(h.set(r,e.xmax,e.ymin,r[2])),t(h.set(r,e.xmin,e.ymax,r[2])),t(h.set(r,e.xmax,e.ymax,r[2])))}};e.create=async function(e,r,s){const n=function(e,t){if(!t||!e.spatialReference)return null;const r={target:void 0};return"declaredClass"in t||Array.isArray(t)?r.target=t:(Object.assign(r,t),!r.target&&"center"in t&&t.center&&(r.target=t.center)),r}(e,r);if(!n)throw new a("viewpointutils-create:no-target","Missing target for creating viewpoint");const o=new t({fov:e.camera.fov}),l=new i({camera:o});if(n.target instanceof i){const t=await async function(e,t,r,i,s){if(t.camera)return G(e,t.camera,i,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=null!=t.targetGeometry?t.targetGeometry.clone():null,s.camera=null,null!=r.heading?s.rotation=I(r.heading):null!=r.rotation&&(s.rotation=r.rotation);const n=L(e,r);return null!=n&&(s.scale=n),s.camera=await D(e,s,r.tilt,i),s}(e,n.target,n,s,l);return z(t)}if(n.target instanceof t)return z(await G(e,n.target,s,l));const u=null!=n.scale||null!=n.zoom;if(n.target instanceof m){const t=n.target.xmin===n.target.xmax||n.target.ymin===n.target.ymax;return z(u||t?await k(e,n,n.target.center,o,s,l):await async function(e,t,r,i,s,n){n.targetGeometry=r.clone();const o=R.cameraOnContentAlongViewDirection(e);E.internalToExternal(e,o,i);const a=N(i,t)?E.OrientationMode.LOCKED:E.OrientationMode.ADJUST;return n.camera=await E.fromExtentAsync(e,r,i.heading,i.tilt,a,s),n}(e,n,n.target,o,s,l))}const d=new j,p=u?function(e,t){const r=L(e,t);return r?M.getResolutionInMetersForScale(r):void 0}(e,n):void 0;if(await B(e,n.target,p,d,s),isFinite(d.boundingBox[0])){let t;if(T.center(d.boundingBox,q),J.x=q[0],J.y=q[1],J.z=q[2],J.spatialReference=e.spatialReference,isFinite(J.z)&&d.hasZ?t=T.isPoint(d.boundingBox):(J.z=void 0,t=C.isPoint(T.toRect(d.boundingBox,Q))),u||t)return z(await k(e,n,J,o,s,l));const r=function(e,t){if(!t.length)return.66;let r=Number.NEGATIVE_INFINITY;for(let e=0;e<t.length;e++){const i=t[e].screenSpaceBoundingRect;r=Math.max(r,Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2]),Math.abs(i[3]))}return.66-r/Math.min(e.width,e.height)*2}(e,d.screenSpaceObjects);return z(await async function(e,t,r,i,s,n,o,a){a.targetGeometry=r.clone();const l=R.cameraOnContentAlongViewDirection(e),u=function(e,t,r,i,s){let n=0;null!=r.z?n=r.z:e.basemapTerrain&&e.elevationProvider&&(n=O.getElevationAtPoint(e.elevationProvider,r)),h.set(q,r.x,r.y,n),v.computeTranslationToOriginAndRotation(e.spatialReference,q,H,e.renderSpatialReference),c.fromMat4(W,H),c.transpose(W,W),T.empty($);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let t=0;t<o.length;t++){const r=o[t];let s=i[r[2]];isFinite(s)||(s=n),h.set(q,i[r[0]],i[r[1]],s),x.projectVectorToVector(q,e.spatialReference,q,e.renderSpatialReference),T.expandWithVec3($,h.transformMat3(q,q,W))}const a=T.width($),l=T.height($),u=T.depth($),d=1/Math.tan(t.fovX/2),p=1/Math.tan(t.fovY/2),m=.5*Math.sqrt(a*a+u*u)*Math.max(p,d)+.5*l,f=.5*l*p+.5*Math.max(a,u);return Math.max(m,f)/s}(e,l,r,i,s);E.internalToExternal(e,l,n);const d=N(n,t)?E.OrientationMode.LOCKED:E.OrientationMode.ADJUST;return a.camera=await E.fromCenterDistanceAsync(e,a.targetGeometry,u,n,d,o),a.scale=E.distanceToScale(e,u),a}(e,n,J,d.boundingBox,r,o,s,l))}return n.position?z(await async function(e,t,r,i,s){const n=R.cameraOnContentAlongViewDirection(e);h.copy(Z,n.viewForward),E.directionToHeadingTilt(e,n.eye,Z,n.up,K);const o=e.spatialReference,{position:a}=t;if(a){const e=await _.projectWithZConversion(a,o,{signal:s});r.position=e}else r.position=new y;return r.heading=null!=t.heading?t.heading:K.heading,r.tilt=null!=t.tilt?t.tilt:K.tilt,U(e,null,r,i)}(e,n,o,l,s)):z(await async function(e,t,r,i,s){if(null!=t.heading||null!=t.rotation||null!=t.scale||null!=t.tilt||null!=t.zoom||null!=t.zoomFactor){const n=R.cameraOnContentAlongViewDirection(e),{spatialReference:o,renderSpatialReference:a}=e,l=new y({spatialReference:o});return w.projectVectorToPoint(n.center,a,l)?k(e,t,l,r,i,s):s}return s.scale=e.scale,s.camera=e.camera.clone(),N(s.camera,t),s}(e,n,o,s,l))},e.fromCamera=function(e,t,r=null){return null==r&&(r=new i),U(e,null,t.clone(),r)},e.toCameraAsync=D,e.toCameraSync=function(e,t,r){const i=t.camera;if(null!=i)return function(e,t){const r=e.position;let i;try{i=_.tryProjectWithZConversion(r,t)}catch(e){return null}if(!i)return null;const s=e.clone();return s.position=i.clone(),s}(i,E.getViewSR(e));const{targetGeometry:s}=t;if(null==s)return null;const{camera:n,mode:o}=F(e,t.rotation,r);if("point"===s.type)return function(e,t,r,i,s){const n=e.spatialReference;let o;try{o=_.tryProjectWithZConversion(r.clone(),n)}catch(e){return null}if(!o)return null;const a=null!=t.scale?E.scaleToDistance(e,t.scale):e.state.camera.distance;return E.fromCenterDistanceSync(e,o,a,i,s)}(e,t,s,n,o);const a=s.extent;return null==a?null:E.fromExtentSync(e,a,n.heading,n.tilt,o)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/RenderFeature":function(){define(["exports","../../../../core/has","../../../../core/NestedMap","../../../support/RenderState"],(function(e,t,r,i){"use strict";var s;e.RenderFeature=void 0,(s=e.RenderFeature||(e.RenderFeature={}))[s.Antialiasing=0]="Antialiasing",s[s.HighQualityTransparency=1]="HighQualityTransparency",s[s.HighResolutionVoxel=2]="HighResolutionVoxel",s[s.HighResolutionAtmosphere=3]="HighResolutionAtmosphere",s[s.SSAO=4]="SSAO",s[s.WaterReflection=5]="WaterReflection",s[s.HighResolutionShadows=6]="HighResolutionShadows",s[s.HighResolutionViewshed=7]="HighResolutionViewshed",s[s.PhysicalPixelRendering=8]="PhysicalPixelRendering",e.setupFeatureDefaults=function(s=!t("disable-feature:high-quality-idle"),n=null){const o=new r.NestedMap;return s?(o.set(i.RenderState.IDLE,e.RenderFeature.Antialiasing,"low"!==n),o.set(i.RenderState.IDLE,e.RenderFeature.HighResolutionAtmosphere,"low"!==n),o.set(i.RenderState.IDLE,e.RenderFeature.HighQualityTransparency,!0),o.set(i.RenderState.IDLE,e.RenderFeature.SSAO,!0),o.set(i.RenderState.IDLE,e.RenderFeature.WaterReflection,!0),o.set(i.RenderState.IDLE,e.RenderFeature.PhysicalPixelRendering,!0)):(o.set(i.RenderState.ANIMATING,e.RenderFeature.HighResolutionShadows,!0),o.set(i.RenderState.ANIMATING,e.RenderFeature.HighResolutionViewshed,!0),o.set(i.RenderState.INTERACTING,e.RenderFeature.HighResolutionShadows,!0),o.set(i.RenderState.INTERACTING,e.RenderFeature.HighResolutionViewshed,!0)),o.set(i.RenderState.IDLE,e.RenderFeature.HighResolutionShadows,!0),o.set(i.RenderState.IDLE,e.RenderFeature.HighResolutionViewshed,!0),o.set(i.RenderState.IDLE,e.RenderFeature.HighResolutionVoxel,!0),o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/NestedMap":function(){define(["exports"],(function(e){"use strict";e.NestedMap=class{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return 0===this._outer.size}get outerSize(){return this._outer.size}get(e,t){return this._outer.get(e)?.get(t)}getInner(e){return this._outer.get(e)}set(e,t,r){const i=this._outer.get(e);i?i.set(t,r):this._outer.set(e,new Map([[t,r]]))}delete(e,t){const r=this._outer.get(e);r&&(r.delete(t),0===r.size&&this._outer.delete(e))}forEach(e){this._outer.forEach(((t,r)=>e(t,r)))}forAll(e){this._outer.forEach(((t,r)=>t.forEach(((t,i)=>e(t,r,i)))))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/input/handlers/DragZoom":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/FovController","../../state/controllers/ZoomControllerGlobal","../../state/controllers/ZoomControllerLocal","../../../input/InputHandler","../../../input/handlers/support"],(function(e,t,r,i,s,n,o){"use strict";class a extends n.InputHandler{constructor(e,t,r){super(!0),this._view=e,this.pointerActions=t,this._fovModifier=r,this.registerIncoming("drag",[r],(e=>this._handleZoom(e))),this.registerIncoming("drag",(e=>this._handleZoom(e)))}_handleZoom(e){const n=e.data;if(n.pointers.size>1)return;if(!o.eventMatchesMousePointerActions(e.data,this.pointerActions))return;const a=t.createScreenPointArray(n.center.x,n.center.y);switch(n.action){case"start":{this._cameraController?.finish();const t=this._view,n=e.modifiers.has(this._fovModifier);this._cameraController=n?new r.FovController({view:t,onStop:()=>this._stopController()}):t.state.isGlobal?new i.ZoomControllerGlobal({view:t}):new s.ZoomControllerLocal({view:t}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(a);break}case"update":this._cameraController?.update(a);break;case"end":this._cameraController instanceof r.FovController?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}}e.DragZoom=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/FovController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../Camera","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","./InteractiveController","../utils/navigationUtils","../../../ui/Component","../../../../widgets/FovOverlay"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";e.FovController=class extends g.InteractiveController{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(v),this.updateTimeout()},this._center=d.create(),this._viewForward=d.create(),this._constraints=new p.ConstraintOptions(m.ConstraintTypes.ALL,f.InteractionType.ZOOM)}begin(e){!function(e){return!Array.isArray(e)}(e)?(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera)):this._showOverlay().fov=e.fov}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(null==this._lastDrag)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,r=this.currentCamera.copyFrom(t.camera),s=i.rad2deg(r.fov)+e,n=i.deg2rad(i.clamp(s,S,w));n!==r.fov?this._setFov(n):this._showOverlay().fov=r.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new _({id:"esri.FovOverlay",node:new b.FovOverlay({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=s.destroyMaybe(this._overlay))}_setFov(e){const t=this.view.state,r=this.currentCamera.copyFrom(t.camera),i=this._ensureStartSize(r)/Math.tan(e/2),s=u.add(x,this._center,u.scale(x,this._viewForward,-i));r.eye=s,r.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=h.pixelDistanceToInteractionFactor(this.currentCamera.height-t.camera.height),h.applyAll(this.view,this.currentCamera,this._constraints),this.begin(r),this.commitCamera()}_ensureStartSize(e){if(null==this._startSize){u.copy(this._viewForward,e.viewForward);const t=this.view.stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,y.screenPixelArea),r=u.distance(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),i=t??r;u.add(this._center,e.eye,u.scale(x,this._viewForward,i)),this._startSize=i*Math.tan(e.fov/2)}return this._startSize}},t.__decorate([n.property()],e.FovController.prototype,"onStop",void 0),e.FovController=t.__decorate([c.subclass("esri.views.3d.state.controllers.FovController")],e.FovController);const v=i.deg2rad((new r).fov),S=10,w=150,x=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/ui/Component":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/domUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";const l="esri-component";let c=class extends t{constructor(){super(...arguments),this.widget=null}destroy(){this.node=null,this.widget?.destroy()}get id(){return this._get("id")??this.widget?.id??this.node?.id}set id(e){this._set("id",e)}set node(e){const t=this._get("node");e!==t&&(e&&e.classList.add(l),t&&t.classList.remove(l),this._set("node",e))}castNode(e){return this.widget?.destroy(),e?"string"==typeof e||function(e){return e&&"nodeType"in e}(e)?(this._set("widget",null),r.byId(e)):(function(e){return e&&"function"==typeof e.render}(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};return e.__decorate([i.property()],c.prototype,"id",null),e.__decorate([i.property()],c.prototype,"node",null),e.__decorate([s.cast("node")],c.prototype,"castNode",null),e.__decorate([i.property({readOnly:!0})],c.prototype,"widget",void 0),c=e.__decorate([a.subclass("esri.views.ui.Component")],c),c}))},"esri/widgets/FovOverlay":function(){define(["exports","../chunks/tslib.es6","../core/mathUtils","../core/unitFormatUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";const p="esri-fov-overlay",m={base:p,outer:`${p}-outer`,reset:`${p}-reset`,text:`${p}-text`};e.FovOverlay=class extends c{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return h.tsx("div",{class:m.outer},h.tsx("div",{class:m.base},h.tsx("p",{class:m.text},this._overlay),h.tsx("p",{class:m.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||null==e)return"";const s=i.formatAngleDegrees(r.rad2deg(e),"degrees","arithmetic","arithmetic",0),n=f/(2*Math.tan(e/2));return`${s} | ${i.formatDecimal(t,n,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&null!=this.fov?"↺":""}},t.__decorate([s.property()],e.FovOverlay.prototype,"onReset",void 0),t.__decorate([s.property(),d.messageBundle("esri/t9n/common")],e.FovOverlay.prototype,"_messagesCommon",void 0),t.__decorate([s.property(),d.messageBundle("esri/core/t9n/Units")],e.FovOverlay.prototype,"_messagesUnits",void 0),t.__decorate([s.property()],e.FovOverlay.prototype,"fov",void 0),t.__decorate([s.property()],e.FovOverlay.prototype,"_overlay",null),t.__decorate([s.property()],e.FovOverlay.prototype,"_reset",null),e.FovOverlay=t.__decorate([l.subclass("esri.widgets.FovOverlay")],e.FovOverlay);const f=Math.sqrt(1872);e.base=p,e.css=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/unitFormatUtils":function(){define(["exports","./ByteSizeUnit","./Cyclical","./mathUtils","./quantityUtils","./string","./unitUtils","../intl/number"],(function(e,t,r,i,s,n,o,a){"use strict";function l(e,t,r){return e.units[t][r]}function c(e,t,r,i=2,s="abbr"){return`${a.formatNumber(t,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:t>0?"never":"exceptZero"})} ${l(e,r,s)}`}function u(e,t,r,i=2,s="abbr"){return`${a.formatNumber(t,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:"exceptZero"})} ${l(e,r,s)}`}const d=new Map;function h(e,t){const r=JSON.stringify(t);let i=d.get(r);return i||(i=new Intl.NumberFormat("en-US",t),d.set(r,i)),/^[-+]?360\.?0*°?$/.test(i.format(e))?0:e}const p=["B","kB","MB","GB","TB"];e.formatAngleDegrees=function(e,t,i,n,l,c=r.cyclicalDegrees,u=!0){let d=c.normalize(s.convertRotationType(o.convertUnit(e,t,"degrees"),i,n),0,u);const p=((e,t)=>({style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:t,minimumFractionDigits:t,signDisplay:e>0?"never":"exceptZero"}))(d,l??2);return d=h(d,p),a.formatNumber(d,p)},e.formatDMS=function(e,t,r=2){let i=o.convertUnit(e,t,"degrees"),s=i-Math.floor(i);i-=s,s*=60;let n=s-Math.floor(s);return s-=n,n*=60,`${i.toFixed()}° ${s.toFixed()}' ${n.toFixed(r)}"`},e.formatDecimal=c,e.formatFileSize=function(e,r){let s=0===(r=Math.round(r))?0:Math.floor(Math.log(r)/Math.log(t.ByteSizeUnit.KILOBYTES));s=i.clamp(s,0,p.length-1);const o=a.formatNumber(r/t.ByteSizeUnit.KILOBYTES**s,{maximumFractionDigits:2});return n.replace(e.units.bytes[p[s]],{fileSize:o})},e.formatImperialArea=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveImperialAreaUnit(t,r);return c(e,o.convertUnit(t,r,n),n,i,s)},e.formatImperialLength=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveImperialLengthUnit(t,r);return c(e,o.convertUnit(t,r,n),n,i,s)},e.formatImperialRelativeLength=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveImperialLengthUnit(t,r);return u(e,o.convertUnit(t,r,n),n,i,s)},e.formatImperialRelativeVerticalLength=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveImperialVerticalLengthUnit(t,r);return u(e,o.convertUnit(t,r,n),n,i,s)},e.formatImperialVerticalLength=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveImperialVerticalLengthUnit(t,r);return c(e,o.convertUnit(t,r,n),n,i,s)},e.formatMetricArea=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveMetricAreaUnit(t,r);return c(e,o.convertUnit(t,r,n),n,i,s)},e.formatMetricLength=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveMetricLengthUnit(t,r);return c(e,o.convertUnit(t,r,n),n,i,s)},e.formatMetricRelativeLength=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveMetricLengthUnit(t,r);return u(e,o.convertUnit(t,r,n),n,i,s)},e.formatMetricRelativeVerticalLength=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveMetricVerticalLengthUnit(t,r);return u(e,o.convertUnit(t,r,n),n,i,s)},e.formatMetricVerticalLength=function(e,t,r,i=2,s="abbr"){const n=o.adaptiveMetricVerticalLengthUnit(t,r);return c(e,o.convertUnit(t,r,n),n,i,s)},e.formatRelativeAngleDegrees=function(e,t,r,i,s=2){r!==i&&(e=-e);const n={style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:s,minimumFractionDigits:s,signDisplay:"exceptZero"};let l=o.convertUnit(e,t,"degrees")%360;return l=h(l,n),a.formatNumber(l,n)},e.formatRelativeDecimal=u,e.unitName=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/ByteSizeUnit":function(){define(["exports"],(function(e){"use strict";var t;e.ByteSizeUnit=void 0,(t=e.ByteSizeUnit||(e.ByteSizeUnit={}))[t.KILOBYTES=1024]="KILOBYTES",t[t.MEGABYTES=1048576]="MEGABYTES",t[t.GIGABYTES=1073741824]="GIGABYTES",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/quantityUtils":function(){define(["exports","./unitUtils"],(function(e,t){"use strict";function r(e,r){return{type:t.unitType(r),value:e,unit:r}}function i(e,r){return{type:t.unitType(r),value:e,unit:r}}function s(e,r){return{type:t.unitType(r),value:e,unit:r}}function n(e,r,i="arithmetic"){return{type:t.unitType(r),value:e,unit:r,rotationType:i}}function o(e,t){const i=a(e,t);return"angle"===e.type?n(i,t,e.rotationType):r(i,t)}function a(e,r){return t.convertUnit(e.value,e.unit,r)}const l=i(0,"meters"),c=s(0,"square-meters"),u=n(0,"radians"),d=n(0,"degrees"),h=n(0,"degrees","geographic");e.convertRotationType=function(e,t,r){if(t===r)return e;switch(r){case"arithmetic":case"geographic":return 90-e}},e.createAngle=n,e.createArea=s,e.createLength=i,e.createQuantity=r,e.createScalar=function(e){return{value:e}},e.isBaseUnit=function(e){return t.isBaseUnit(e.unit)},e.max=function(e,r){return null==e?r:null==r||e.value>t.convertUnit(r.value,r.unit,e.unit)?e:r},e.min=function(e,r){return null==e?r:null==r||e.value<t.convertUnit(r.value,r.unit,e.unit)?e:r},e.scale=function(e,t){return null==e?null:{...e,value:e.value*t}},e.toBaseUnit=function(e){return o(e,t.baseUnitForUnit(e.unit))},e.toUnit=o,e.valueInUnit=a,e.zeroDegrees=d,e.zeroDegreesGeographic=h,e.zeroMeters=l,e.zeroRadians=u,e.zeroSquareMeters=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/ZoomControllerGlobal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/support/axisAngle","../../../../chunks/sphere","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../camera/constraintUtils/surfaceCollision","./InteractiveController","../utils/navigationUtils","../../support/geometryUtils/ray"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x){"use strict";e.ZoomControllerGlobal=class extends S.InteractiveController{constructor(){super(...arguments),this._pickPoint=h.create(),this._tmpP0=u.create(),this._panAxisAngle=m.create(),this._tmpRayDir=h.create(),this._tmpRayDirPick=h.create(),this._targetOnSphere=h.create(),this._navMode=w.NavigationMode.Horizontal,this._tmpRay={origin:h.create(),direction:h.create()},this.dragBeginPoint=i.createScreenPointArray(),this._normalizedAnchorPoint=u.create(),this._constraintOptions=new y.ConstraintOptions(_.ConstraintTypes.ALL_EXCEPT_COLLISION,b.InteractionType.ZOOM,0,this.startCamera),this._sphere=f.create(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;c.copy(this.dragBeginPoint,e),w.normalizeCoordinate(this.startCamera,e,this._normalizedAnchorPoint);const t=p.getReferenceEllipsoid(this.view.spatialReference),i=w.pickPointAndInitSphere(this._intersectionHelper,this.startCamera,e,t.radius,w.SpherePickPointFallback.Ellipsoid,this.view.basemapTerrain.invisible?w.excludeTerrain:{});if(this._navMode=w.navigationMode(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===w.NavigationMode.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let t;x.fromScreenAtEye(this.startCamera,e,this._tmpRay),d.normalize(this._tmpRay.direction,this._tmpRay.direction),null!=i.scenePickPoint&&(d.subtract(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),t=d.length(this._tmpRayDirPick));const s=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,C);let n=r.clamp(Math.min(w.pivotDistanceModifier,1/Math.abs(d.dot(C,this._tmpRay.direction)))*s,w.distanceClampValues[0],w.distanceClampValues[1]);const o=this.view.stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,w.screenPixelArea);n=null!=o?o:n,n=null!=t?Math.min(n,t):n,this._hasPickPoint=!0,d.scale(this._tmpRay.direction,this._tmpRay.direction,n),d.add(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===w.NavigationMode.Horizontal){d.subtract(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=d.length(this._tmpRayDir);w.normalizeCoordinate(this.currentCamera,e,this._tmpP0);const r=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let i=t*2**r;const s=this.view.state.constraints.minimumPoiDistance;if(r<0&&i<s&&(i=s),Math.abs(t-i)<1e-6)return;if(this._hasPickPoint&&i<t){const e=1-(1-i/t)*(1-this._sphere[3]/d.length(this.currentCamera.center));this.currentCamera.center=d.scale(T,this.currentCamera.center,e)}d.scale(this._tmpRayDir,this._tmpRayDir,-i/t),this.currentCamera.eye=d.add(T,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=g.pixelDistanceToInteractionFactor(c.distance(this.dragBeginPoint,e)),g.applyAll(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(w.sphereOrPlanePointFromScreenPoint(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),m.fromPoints(this._pickPoint,this._targetOnSphere,this._panAxisAngle),w.applyRotation(this.currentCamera,f.getCenter(this._sphere),this._panAxisAngle))}else{const t=d.length(this._tmpRay.direction);w.normalizeCoordinate(this.currentCamera,e,this._tmpP0);const r=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let i=t*2**r;const s=this.view.state.constraints.minimumPoiDistance;if(r<0&&i<s&&(i=s),Math.abs(t-i)<1e-6)return;d.scale(this._tmpRayDir,this._tmpRay.direction,1-i/t),this.currentCamera.eye=d.add(T,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=d.add(T,this.currentCamera.center,this._tmpRayDir)}v.applySurfaceCollisionConstraint(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}},e.ZoomControllerGlobal=t.__decorate([l.subclass("esri.views.3d.state.controllers.ZoomControllerGlobal")],e.ZoomControllerGlobal);const T=h.create(),C=h.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/ZoomControllerLocal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/plane","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../layers/VoxelWasm","./InteractiveController","../utils/navigationUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v){"use strict";e.ZoomControllerLocal=class extends b.InteractiveController{constructor(){super(...arguments),this._tmpP=h.create(),this._tmpDir=h.create(),this._tmpN=h.create(),this._tmpP0=u.create(),this._tmpPOI=h.create(),this._tmpRayDir=h.create(),this.dragBeginPoint=i.createScreenPointArray(),this._normalizedAnchorPoint=u.create(),this._constraintOptions=new f.ConstraintOptions(g.ConstraintTypes.ALL,y.InteractionType.ZOOM,0,this.startCamera,h.create()),this._plane=p.create()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;c.copy(this.dragBeginPoint,e),v.normalizeCoordinate(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.basemapTerrain.invisible?v.excludeTerrain:{});d.subtract(this._tmpDir,this._tmpP,this.startCamera.eye);const i=d.length(this._tmpDir);d.normalize(this._tmpDir,this._tmpDir);const s=Math.abs(this.view.camera.position.z);let n=r.clamp(Math.min(v.pivotDistanceModifier,1/Math.abs(d.dot(w,this._tmpDir)))*s,v.distanceClampValues[0],v.distanceClampValues[1]);const o=this.view.stage.renderView.getMinimalDepthForArea(_.getVoxelWasm(this.view),e[0],e[1],this.view.state.camera,v.screenPixelArea);n=null!=o?o:n,n=t?Math.min(n,i):n,d.scale(this._tmpDir,this._tmpDir,n),d.add(this._tmpP,this.startCamera.eye,this._tmpDir),d.subtract(this._tmpN,this.startCamera.eye,this.startCamera.center),d.normalize(this._tmpN,this._tmpN),this._tmpN[1]<0&&d.negate(this._tmpN,this._tmpN),p.fromPositionAndNormal(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;v.intersectPlaneFromScreenPoint(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPOI)||d.copy(this._tmpPOI,this.currentCamera.center),v.normalizeCoordinate(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);c.copy(this._normalizedAnchorPoint,this._tmpP0),d.subtract(this._tmpRayDir,this._tmpPOI,this.currentCamera.eye);const r=d.length(this._tmpRayDir);let i=r*(1-t);this._constraintOptions.interactionDirection&&(d.copy(this._constraintOptions.interactionDirection,this._tmpRayDir),d.scale(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/r));const s=this.view.state.constraints.minimumPoiDistance;t>=0&&i<s&&(i=s,t=-(i-r)/r),Math.abs(r-i)<1e-6||(d.scale(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=d.add(S,this.currentCamera.eye,this._tmpRayDir),d.lerp(S,this.currentCamera.center,this._tmpPOI,t),this._tmpPOI[2]>this.startCamera.center[2]?S[2]=Math.max(this.startCamera.center[2],S[2]):S[2]=Math.min(this.startCamera.center[2],S[2]),this.currentCamera.center=S,this._constraintOptions.interactionFactor=m.pixelDistanceToInteractionFactor(c.distance(this.dragBeginPoint,e)),m.applyAll(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}},e.ZoomControllerLocal=t.__decorate([l.subclass("esri.views.3d.state.controllers.ZoomControllerLocal")],e.ZoomControllerLocal);const S=h.create(),w=h.fromValues(0,0,1);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/input/handlers/GamepadNavigation":function(){define(["exports","../../../../core/Handles","../../../../core/reactiveUtils","../../state/controllers/CameraController","../../state/controllers/GamepadKeyboardController","../../../input/InputHandler"],(function(e,t,r,i,s,n){"use strict";class o extends n.InputHandler{constructor(e){super(!0),this._view=e,this._watchHandles=new t,this._handle=this.registerIncoming("gamepad",(e=>this._handleEventGamepad(e))),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([r.watch((()=>this._view.navigation.gamepad.enabled),(e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))}),r.initial),r.watch((()=>this._view.navigation.gamepad.device),(e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)}))])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const r=this._cameraControllerGamepad?.running;if(r||s.GamepadKeyboardController.activatesFor(this._view,e.data)){if(!r){const t=new s.GamepadKeyboardController({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t),t.state!==i.State.Rejected&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}e.GamepadNavigation=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/GamepadKeyboardController":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/compilerUtils","../../../../core/mathUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/support/ray","../../../../chunks/sphere","../../../../geometry/support/vector","../../../../geometry/support/vectorStacks","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../camera/constraintUtils/TiltMode","../Constraints","./InteractiveController","../utils/navigationUtils","../utils/viewUtils","../../support/cameraUtils","../../support/cameraUtilsInternal","../../webgl/RenderCamera","../../../navigation/gamepadAndKeyboardUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E){"use strict";e.GamepadKeyboardController=class extends x.InteractiveController{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new R,this._headingStart=0,this._constraintOptions=new _.ConstraintOptions(b.ConstraintTypes.ALL,v.InteractionType.NONE,0,new R,null,S.TiltMode.LOOK_AROUND)}handleEventGamepad(e){const t=E.extractTransformation(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||E.isZeroTransformation(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,E.extractTransformationKeyboard(this._keysButtonState,this._transformation)}directionActive(e){return 1===this._keysButtonState[e]}countActiveDirections(){return this._keysButtonState.reduce(((e,t)=>t>0?e+1:e),0)}deactivateDirection(e){this._keysButtonState[e]=0;const t=E.extractTransformationKeyboard(this._keysButtonState,this._transformation);E.isZeroTransformation(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,U),this._applyDisabledMovementTypes(U),this._applyPan(U.pan),this._applyRotate(U.rotate),this._applyZoom(U.zoom),this._applyAscend(U.ascend),this._constraintOptions.interactionType=v.InteractionType.NONE,this._constraintOptions.selection=b.ConstraintTypes.COLLISION,y.applyAll(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;u.subtract(V,t.center,t.eye),u.transformMat4(V,V,e.matrix),t.center=u.add(V,V,t.eye),t.up=u.transformMat4(V,t.up,e.matrix),this._constraintOptions.interactionType=v.InteractionType.LOOK_AROUND,this._constraintOptions.selection=b.ConstraintTypes.ALL_EXCEPT_COLLISION,y.applyAll(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=u.transformMat4(V,t.eye,e.matrix),t.center=u.transformMat4(V,t.center,e.matrix),this.view.state.isGlobal&&(t.up=u.transformMat4(V,t.up,e.matrix)),this._constraintOptions.interactionType=v.InteractionType.PAN,this._constraintOptions.selection=b.ConstraintTypes.ALL,y.applyAll(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=u.add(V,this.currentCamera.eye,u.scale(g.sv3d.get(),t,e)),u.copy(B,t),u.negate(B,B),this._constraintOptions.interactionDirection=B,this._constraintOptions.interactionType=v.InteractionType.ZOOM,this._constraintOptions.selection=b.ConstraintTypes.ALL_EXCEPT_COLLISION,y.applyAll(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,g.sv3d.get());if(this._constraintOptions.interactionDirection=u.copy(B,t),this.view.state.isGlobal){const t=u.length(this.currentCamera.eye),r=(t+e)/t;this.currentCamera.eye=u.scale(V,this.currentCamera.eye,r),this.currentCamera.center=u.scale(V,this.currentCamera.center,r)}else{const r=u.scale(g.sv3d.get(),t,e);this.currentCamera.eye=u.add(V,this.currentCamera.eye,r),this.currentCamera.center=u.add(V,this.currentCamera.center,r)}this._updateCameraCenter(),this._constraintOptions.interactionType=v.InteractionType.ASCEND,this._constraintOptions.selection=b.ConstraintTypes.COLLISION,y.applyAll(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=b.ConstraintTypes.ALL_EXCEPT_COLLISION,y.applyAll(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,r){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,l.identity(e.pan.matrix),e.rotate.enabled=!1,l.identity(e.rotate.matrix)}(r);const i=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(i,t,r):this._calculateControlTransformationGlobal(i,t,r)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,r=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(r,e,V)}_calculateControlTransformationLocal(e,t,s){const{viewRight:n,viewForward:o}=t,a=this._transformation,c=this.view.navigation.gamepad,d=u.set(g.sv3d.get(),o[0],o[1],0);u.normalize(d,d);const h=a.translation[0]*e.pan;if(0!==h){const e=u.scale(g.sv3d.get(),n,h);l.translate(s.pan.matrix,s.pan.matrix,e),s.pan.enabled=!0}switch(c.mode){case"pan":{const t=-a.translation[1]*e.pan;if(0!==t){const e=u.scale(g.sv3d.get(),d,t);l.translate(s.pan.matrix,s.pan.matrix,e),s.pan.enabled=!0}s.zoom=a.zoom*e.zoom;break}case"zoom":s.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:r.neverReached(c.mode)}const p=a.translation[2]*e.ascend;s.ascend=p;const m=-a.heading*e.rotate;0!==m&&(l.rotate(s.rotate.matrix,s.rotate.matrix,m,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,g.sv3d.get())),s.rotate.enabled=!0);const f=a.tilt*e.rotate,y=C.viewAngle(this.view.renderCoordsHelper,t.center,t.eye),_=i.clamp(y+f,w.TiltRange.min,w.TiltRange.max)-y;_&&(l.rotate(s.rotate.matrix,s.rotate.matrix,_,n),s.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,r){const{eye:i,viewRight:s}=t,n=this._transformation,o=this.view.navigation.gamepad,a=u.cross(g.sv3d.get(),s,i);u.normalize(a,a),u.negate(a,a),T.panMotionToRotationMatrix(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,r,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(U.pan,this._tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,d=n.translation[2]*e.ascend;r.ascend=d;const h=-n.heading*e.rotate;0!==h&&(l.rotate(r.rotate.matrix,r.rotate.matrix,h,this._tmpCamera.eye),r.rotate.enabled=!0);const p=n.tilt*e.rotate,m=this._clampTiltDeltaGlobalToValidRange(p,t.ray,c);0!==m&&(l.rotate(r.rotate.matrix,r.rotate.matrix,m,this._tmpCamera.viewRight),r.rotate.enabled=!0),r.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,r){const s=h.getReferenceEllipsoid(this.view.spatialReference),n=T.onSurfaceTiltToEyeTiltGlobal(w.TiltRange.min,t.origin,r,s);let o=0,a=0;const l=g.sv3d.get();if(this.view.renderCoordsHelper.intersectManifold(t,r,l)){const e=C.viewAngle(this.view.renderCoordsHelper,l,t.origin);o=T.onSurfaceTiltToEyeTiltGlobal(e,t.origin,r,s),a=T.onSurfaceTiltToEyeTiltGlobal(w.TiltRange.max,t.origin,r,s)}else{m.closestPointOnSilhouette(m.fromRadius(m.tmpSphere,r+s.radius),t,l);const e=Math.PI+f.angle(t.direction,l);o=T.offSurfaceTiltToEyeTiltGlobal(e,t.origin,r,s),a=T.offSurfaceTiltToEyeTiltGlobal(w.TiltRange.max,t.origin,r,s)}return i.clamp(o+e,n,a)-o}_getPointAbsoluteSurfaceElevation(e,t,r){const{renderCoordsHelper:i}=this.view,s=i.getAltitude(e),n=t+Math.abs(s-t);return i.setAltitude(r,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:r}=this.view,{camera:i}=this.view.state,{direction:s}=P.headingTiltToDirectionUp(this.view,t,0,A,G),n=r.intersectManifoldClosestSilhouette(p.wrap(t,s),e,g.sv3d.get()),o=u.distance(t,n),a=r.intersectManifoldClosestSilhouette(p.wrap(t,u.direction(g.sv3d.get(),t,i.center)),e,g.sv3d.get()),l=u.distance(t,a);return Math.min(o,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:r}=this.view,{camera:s,isGlobal:n}=r,o=t.intersectManifoldClosestSilhouette(s.ray,this._filteredSurfaceElevation,g.sv3d.get());if(n){const t=u.subtract(g.sv3d.get(),e,o),r=u.length(t);u.scale(t,t,1/r);const s=u.normalize(g.sv3d.get(),e),n=i.acosClamped(u.dot(s,t));return r*Math.sin(Math.min(I,n))}{const r=u.copy(g.sv3d.get(),e);return t.setAltitude(r,this._filteredSurfaceElevation),u.distance(o,r)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:F}_computeVelocities(e){const t=this._filteredSurfaceElevation,r=t+h.getReferenceEllipsoid(this.view.spatialReference).radius,{camera:s,isGlobal:n}=this.view.state,o=g.sv3d.get(),a=this._getPointAbsoluteSurfaceElevation(s.eye,t,o),l=this._clampedDistanceToSurface(t,o),c=s.width/2,u=D*s.width,d=D*s.width,p=l*Math.tan(.5*s.fovX)/c,m=p/r,f=p/this._computeHeadingRotateRadius(o),y=a-t;return{pan:(n?m:p)*u*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(u*e/c)*y-y),zoom:2**(u*e/c)*l-l,rotate:i.clamp(f*d,L,N)*e}}_applyDisabledMovementTypes(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&l.identity(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&l.identity(e.rotate.matrix))}static activatesFor(e,t){const r=E.extractTransformation(t,e.navigation.gamepad,O);return!("end"===t.action||E.isZeroTransformation(r))}},t.__decorate([s.property({constructOnly:!0})],e.GamepadKeyboardController.prototype,"gamepadDevice",void 0),t.__decorate([s.property({constructOnly:!0})],e.GamepadKeyboardController.prototype,"disableMovements",void 0),e.GamepadKeyboardController=t.__decorate([a.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],e.GamepadKeyboardController);const O={translation:[0,0,0],heading:0,tilt:0,zoom:0},A=80,I=i.deg2rad(A),D=.75,F=5,L=i.deg2rad(30),N=i.deg2rad(80),U={zoom:0,ascend:0,pan:{enabled:!1,matrix:c.create()},rotate:{enabled:!1,matrix:c.create()}},V=d.create(),B=d.create(),G=M.createDirectionUp();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/navigation/gamepadAndKeyboardUtils":function(){define(["exports","../../chunks/vec32"],(function(e,t){"use strict";function r(e){let t=e*e;return e<0&&(t*=-1),t}e.extractTransformation=function(e,i,s){const n=s,o=e.state,a=e.device,l="forward-down"===i.tiltDirection?1:-1;return"standard"===a.deviceType?(n.translation[0]=r(o.axes[0]),n.translation[1]=r(o.axes[1]),n.translation[2]=r(o.buttons[7])-r(o.buttons[6]),n.heading=r(o.axes[2]),n.tilt=r(o.axes[3])):"spacemouse"===a.deviceType&&(n.translation[0]=1.2*r(o.axes[0]),n.translation[1]=1.2*r(o.axes[1]),n.translation[2]=2*-r(o.axes[2]),n.heading=1.2*r(o.axes[5]),n.tilt=1.2*r(o.axes[3])),n.tilt*=l,t.scale(n.translation,n.translation,1),n},e.extractTransformationKeyboard=function(e,t){const r=t;return r.translation[0]=e[1]-e[0],r.translation[1]=e[3]-e[2],r.translation[2]=e[4]-e[5],r.heading=e[7]-e[6],r.tilt=e[8]-e[9],r.zoom=e[10]-e[11],r},e.isZeroTransformation=function(e){return 0===e.translation[0]&&0===e.translation[1]&&0===e.translation[2]&&0===e.heading&&0===e.tilt&&0===e.zoom},e.resetTransformation=function(e){return e.translation[0]=0,e.translation[1]=0,e.translation[2]=0,e.heading=0,e.tilt=0,e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/input/handlers/KeyboardNavigation":function(){define(["exports","../../../ViewingMode","../../state/controllers/GamepadKeyboardController","../../../input/InputHandler","../../../input/VisibilityChange"],(function(e,t,r,i,s){"use strict";var n;!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(n||(n={}));class o extends i.InputHandler{constructor(e,r){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:t.ViewingMode.Local},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(r),this.registerIncoming("key-down",null,(e=>this._handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this._handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this._handleStop())),this._visibilityHandle=s.onVisibilityChange((e=>e?null:this._handleStop()))}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,n.LEFT),this._addKeyMapping(e.pan.right,n.RIGHT),this._addKeyMapping(e.pan.forward,n.FORWARD),this._addKeyMapping(e.pan.backward,n.BACKWARD),this._addKeyMapping(e.pan.up,n.UP),this._addKeyMapping(e.pan.down,n.DOWN),this._addKeyMapping(e.lookAround.headingLeft,n.HEADINGLEFT),this._addKeyMapping(e.lookAround.headingRight,n.HEADINGRIGHT),this._addKeyMapping(e.lookAround.tiltUp,n.TILTUP),this._addKeyMapping(e.lookAround.tiltDown,n.TILTDOWN),this._addKeyMapping(e.zoom.zoomIn,n.ZOOMIN),this._addKeyMapping(e.zoom.zoomOut,n.ZOOMOUT),this._addKeyAction(e.reset.heading,(()=>this._resetHeading())),this._addKeyAction(e.reset.tilt,(()=>this._resetTilt()))}_addKeyMapping(e,t){for(const r of this._eachKey(e))this._keyToDirection.set(r,t)}*_eachKey(e){"string"==typeof e?yield e:yield*e}_addKeyAction(e,t){for(const r of this._eachKey(e))this._keyToAction.set(r,t)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToAction.get(e.data.key);if(null!=t)return e.stopPropagation(),void t();const i=this._keyToDirection.get(e.data.key);if(null!=i&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new r.GamepadKeyboardController({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(i))return;if(this._cameraControllerKeyboard.activateDirection(i),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(i))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout((()=>{this._stickyKeyTimeoutHandle=void 0,null!=this._stickyDirection&&void 0!==this._stickyDirection&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)}),this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;const t=this._keyToDirection.get(e.data.key);if(null==t)return;e.stopPropagation();const r=void 0===this._stickyKeyTimeoutHandle;void 0===this._stickyKeyTimeoutHandle||1!==this._cameraControllerKeyboard?.countActiveDirections()?(this._cameraControllerKeyboard?.deactivateDirection(t),r&&(this._stickyDirection=void 0)):this._stickyDirection=t}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch((()=>{}))}_resetTilt(){this._view.goTo({tilt:0}).catch((()=>{}))}}e.KeyboardNavigation=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/VisibilityChange":function(){define(["exports","../../core/handleUtils"],(function(e,t){"use strict";e.onVisibilityChange=function(e){const r=()=>e("visible"===document.visibilityState);return document.addEventListener("visibilitychange",r),t.makeHandle((()=>document.removeEventListener("visibilitychange",r)))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/input/handlers/MouseWheelZoom":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/CameraController","../../state/controllers/FovController","../../state/controllers/ZoomStepControllerGlobal","../../state/controllers/ZoomStepControllerLocal","../../../input/InputHandler"],(function(e,t,r,i,s,n,o){"use strict";class a extends o.InputHandler{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],(e=>this._handleFov(e))),this.registerIncoming("mouse-wheel",(e=>this._handleZoom(e)))}_handleZoom(e){if(!this._mouseWheelZoomEnabled)return;const r=e.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new s.ZoomStepControllerGlobal({view:this._view,mode:"interaction"}):new n.ZoomStepControllerLocal({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-r.deltaY/60,t.createScreenPointArray(r.x,r.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new i.FovController({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==r.State.Rejected)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return"zoom"===this._view.navigation.actionMap.mouseWheel}_stopFovController(){this._fovController?.finish(),this._fovController=null}}e.MouseWheelZoom=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/input/handlers/PinchAndPanNavigation":function(){define(["exports","../../state/controllers/PinchAndPanControllerGlobal","../../state/controllers/PinchAndPanControllerLocal","../../../input/InputHandler","../../../input/handlers/support"],(function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e,t,r){super(!0),this._view=e,this.pointerActions=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",r,(e=>this._handleDrag(e)))}_handleDrag(e){if("mouse"===e.data.pointerType&&!s.eventMatchesMousePointerActions(e.data,this.pointerActions))return;const t=e.timestamp-this._lastEndTimestamp,r=this._momentum&&this._momentum.running&&t<40;switch(e.data.action){case"start":case"update":if(r)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller?.running){this._lastEndTimestamp=e.timestamp;const r=this._controller.end(e.data);t&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new t.PinchAndPanControllerGlobal({view:this._view}):new r.PinchAndPanControllerLocal({view:this._view})}}e.PinchAndPanNavigation=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/PinchAndPanControllerGlobal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Cyclical","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/support/axisAngle","../../../../geometry/support/plane","../../../../chunks/sphere","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../input/util","./InteractiveController","./momentum/PanPlanarMomentumController","./momentum/PanSphericalMomentumController","./momentum/RotationMomentumController","./momentum/ZoomPlanarMomentumController","./momentum/ZoomSphericalMomentumController","../utils/navigationUtils","../../webgl/RenderCamera","../../../navigation/PanPlanarMomentumEstimator","../../../navigation/PanSphericalMomentumEstimator","../../../navigation/RotationMomentumEstimator","../../../navigation/ZoomMomentumEstimator"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D){"use strict";e.PinchAndPanControllerGlobal=class extends w.InteractiveController{constructor(){super(...arguments),this._smoothRotation=new S.ExponentialFalloff(.05),this._rotationAxis=h.create(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=f.create(),this._beginRadius=0,this._smoothScaling=new S.ExponentialFalloff(.05),this._zoomCenterScreen=s.createScreenPointArray(),this._zoomMomentumEstimator=new D.ZoomMomentumEstimator,this._rotationMomentumEstimator=new I.RotationMomentumEstimator,this._panSphericalMomentumEstimator=new A.PanSphericalMomentumEstimator,this._panPlanarMomentumEstimator=new O.PanPlanarMomentumEstimator,this._adjustedSphere=g.create(),this._tmp3d=h.create(),this._tmpScreenPointArray=s.createScreenPointArray(),this._beginScreenPoint=s.createScreenPointArray(),this._beginScenePoint=h.create(),this._screenPickPoint=s.createScreenPointArray(),this._scenePickPoint=h.create(),this._navMode=R.NavigationMode.Horizontal,this._sphere=g.create(),this._pointerCount=0,this._tmpInteractionDirection=h.create(),this._beginCamera=new E,this._constraintOptions=new _.ConstraintOptions(b.ConstraintTypes.ALL,v.InteractionType.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-r.cyclicalPI.normalize(i.deg2rad(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),s.screenPointObjectToArray(e.center,this._screenPickPoint),u.copy(this._beginScreenPoint,this._screenPickPoint);const t=R.pickPointAndInitSphere(this._intersectionHelper,this.startCamera,this._screenPickPoint,p.getReferenceEllipsoid(this.view.spatialReference).radius,R.SpherePickPointFallback.Silhouette,this.view.basemapTerrain.invisible?R.excludeTerrain:{});null!=t.scenePickPoint&&(this._scenePickPoint=t.scenePickPoint,this._sphere=t.sphere,d.copy(this._beginScenePoint,this._scenePickPoint),this._navMode=R.navigationMode(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===R.NavigationMode.Vertical&&this._preparePlanarPanMode(e,t.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navMode===R.NavigationMode.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===R.NavigationMode.Horizontal?new M.ZoomSphericalMomentumController({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new P.ZoomPlanarMomentumController({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new C.RotationMomentumController({view:this.view,momentum:r,center:g.getCenter(this._sphere),axis:this._rotationAxis});if(this._navMode===R.NavigationMode.Horizontal){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new T.PanSphericalMomentumController({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new x.PanPlanarMomentumController({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const r=d.negate(this._tmp3d,this.startCamera.viewForward);f.fromPositionAndNormal(this._scenePickPoint,r,this._panningPlane);const i=s.createScreenPointArray(this._screenPickPoint[0],0),n=h.create(),o=d.length(this.startCamera.eye);this._adjustedSphere[3]=o<this._sphere[3]?o-100:this._sphere[3],R.sphereOrPlanePointFromScreenPoint(this._adjustedSphere,this.startCamera,i,n);const a=s.createRenderScreenPointArray3();this.startCamera.projectToRenderScreen(n,a);const l=h.create(),c=h.create(),u=h.create();d.subtract(l,this._scenePickPoint,this.currentCamera.eye);const p=d.length(l);d.normalize(l,l);const m=R.panDistanceModifier*Math.max(Math.abs(this.view.camera.position.z),R.minHeightLimit),g=this.view.stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,R.screenPixelArea);let y=null!=g?g:m;y=t?Math.min(y,p):y,d.copy(u,d.add(c,this.currentCamera.eye,d.scale(c,l,y))),this._panningPlane[3]=-d.dot(f.getNormal(this._panningPlane),u),this.startCamera.center=d.add(c,this.startCamera.eye,d.scale(c,this.startCamera.viewForward,y));const _=s.screenPointObjectToArray(e.center,this._tmpScreenPointArray);R.intersectPlaneFromScreenPointAtEye(this._panningPlane,this.startCamera,_,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),R.applyZoomOnSphere(this._sphere,this.currentCamera,this._smoothScaling.value),s.screenPointObjectToArray(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=v.InteractionType.ZOOM,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(e.radius-this._beginRadius),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=s.screenPointObjectToArray(e.center,this._tmpScreenPointArray);R.sphereOrPlanePointFromScreenPoint(this._sphere,this.currentCamera,t,this._tmp3d),R.shouldPreserveHeading(this._beginScenePoint,d.dot(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(R.applyPanSphericalPreserveHeading(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(R.applyPanSphericalDirectRotation(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=v.InteractionType.PAN,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(u.distance(this._screenPickPoint,t)),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){d.normalize(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||d.negate(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,r=t+R.normalizeRotationDelta(e.angle-t),i=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=i,this._smoothRotation.update(r);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),R.applyRotation(this.currentCamera,g.getCenter(this._sphere),m.wrapAxisAngle(this._rotationAxis,s)),this._constraintOptions.interactionType=v.InteractionType.TUMBLE,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(e.radius*r),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=s.screenPointObjectToArray(e.center,this._tmpScreenPointArray);R.intersectPlaneFromScreenPointAtEye(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(R.applyPanPlanar(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=v.InteractionType.PAN,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(u.distance(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),y.applyAll(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),R.applyZoomToPoint(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=v.InteractionType.ZOOM,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(e.radius-this._beginRadius),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){d.copy(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||d.negate(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let r=e.angle-t;r=R.normalizeRotationDelta(r);const i=t+r,s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(i);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),R.applyRotation(this.currentCamera,g.getCenter(this._sphere),m.wrapAxisAngle(this._rotationAxis,n)),this._constraintOptions.interactionType=v.InteractionType.TUMBLE,this._constraintOptions.interactionFactor=y.pixelDistanceToInteractionFactor(e.radius*n),y.applyAll(this.view,this.currentCamera,this._constraintOptions)}},e.PinchAndPanControllerGlobal=t.__decorate([c.subclass("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],e.PinchAndPanControllerGlobal),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/input/util":function(){define(["exports"],(function(e){"use strict";e.ExponentialFalloff=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/momentum/PanPlanarMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../camera/constraintUtils/InteractionType","./MomentumController"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.PanPlanarMomentumController=class extends u.MomentumController{constructor(e){super(e),this.interactionType=c.InteractionType.PAN,this._tmpPan=l.create()}momentumStep(e,t){const r=this.momentum.value(e);a.scale(this._tmpPan,this.momentum.direction,r),t.eye=a.subtract(d,t.eye,this._tmpPan),t.center=a.subtract(d,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}},t.__decorate([r.property({constructOnly:!0})],e.PanPlanarMomentumController.prototype,"momentum",void 0),e.PanPlanarMomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],e.PanPlanarMomentumController);const d=l.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/momentum/MomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Logger","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../ViewAnimation","../../../camera/constraintUtils","../../../camera/constraintUtils/ConstraintOptions","../../../camera/constraintUtils/ConstraintTypes","../../../camera/constraintUtils/InteractionType","../AnimationController","../../../webgl/RenderCamera"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.MomentumController=class extends h.AnimationController{constructor(){super(...arguments),this._beginCamera=new p,this._elapsedTimeSec=0,this.constraintOptions=new c.ConstraintOptions(u.ConstraintTypes.ALL,d.InteractionType.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new a}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),l.applyAll(this.view,t,this.constraintOptions)}},e.MomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.MomentumController")],e.MomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/momentum/PanSphericalMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../camera/constraintUtils/InteractionType","./MomentumController","../../utils/navigationUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=l.create(),p=l.create();e.PanSphericalMomentumController=class extends u.MomentumController{constructor(e){super(e),this.interactionType=c.InteractionType.PAN}momentumStep(e,t){const r=this.momentum.value1(e),i=this.momentum.value2(e);a.copy(p,t.eye),a.normalize(p,p),a.cross(this.momentum.axis2,p,this.momentum.axis1),d.applyRotationWithTwoAxes(t,h,this.momentum.axis1,r,this.momentum.axis2,i)}},t.__decorate([r.property({constructOnly:!0})],e.PanSphericalMomentumController.prototype,"momentum",void 0),e.PanSphericalMomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],e.PanSphericalMomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/momentum/RotationMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/axisAngle","../../../camera/constraintUtils/InteractionType","./MomentumController","../../utils/navigationUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.RotationMomentumController=class extends u.MomentumController{set center(e){this._set("center",a.clone(e))}set axis(e){this._set("axis",a.clone(e))}constructor(e){super(e),this.interactionType=c.InteractionType.TUMBLE}momentumStep(e,t){const r=this.momentum.value(e);d.applyRotation(t,this.center,l.wrapAxisAngle(this.axis,r))}},t.__decorate([r.property({constructOnly:!0})],e.RotationMomentumController.prototype,"momentum",void 0),t.__decorate([r.property({constructOnly:!0})],e.RotationMomentumController.prototype,"center",null),t.__decorate([r.property({constructOnly:!0})],e.RotationMomentumController.prototype,"axis",null),e.RotationMomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.RotationMomentumController")],e.RotationMomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/momentum/ZoomPlanarMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../camera/constraintUtils/InteractionType","./MomentumController","../../utils/navigationUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.ZoomPlanarMomentumController=class extends u.MomentumController{set zoomCenter(e){this._set("zoomCenter",l.clone(e))}constructor(e){super(e),this.interactionType=c.InteractionType.ZOOM,this.constraintOptions.interactionDirection=l.create()}momentumStep(e,t){const{interactionDirection:r}=this.constraintOptions;if(!r)return;a.copy(r,t.eye);const i=this.momentum.valueDelta(0,e);d.applyZoomToPoint(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),a.direction(r,t.eye,r)}},t.__decorate([r.property({constructOnly:!0})],e.ZoomPlanarMomentumController.prototype,"momentum",void 0),t.__decorate([r.property({constructOnly:!0})],e.ZoomPlanarMomentumController.prototype,"zoomCenter",null),e.ZoomPlanarMomentumController=t.__decorate([o.subclass("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],e.ZoomPlanarMomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/momentum/ZoomSphericalMomentumController":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/axisAngle","../../../../../chunks/sphere","../../../camera/constraintUtils","../../../camera/constraintUtils/InteractionType","./MomentumController","../../utils/navigationUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";e.ZoomSphericalMomentumController=class extends p.MomentumController{set screenCenter(e){this._set("screenCenter",r.createScreenPointArray(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",l.clone(e))}constructor(e){super(e),this.interactionType=h.InteractionType.ZOOM,this.radius=0,this._tmpSceneCenter=l.create(),this._tmpZoomAxisAngle=c.create(),this._sphere=u.create()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const r=this.momentum.valueDelta(0,e);m.applyZoomOnSphere(this._sphere,t,r),this.constraintOptions.interactionType=h.InteractionType.ZOOM,d.applyAll(this.view,t,this.constraintOptions),m.sphereOrPlanePointFromScreenPoint(this._sphere,t,this.screenCenter,this._tmpSceneCenter),c.fromPoints(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),m.applyRotation(t,u.getCenter(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=h.InteractionType.PAN}},t.__decorate([i.property({constructOnly:!0})],e.ZoomSphericalMomentumController.prototype,"momentum",void 0),t.__decorate([i.property({constructOnly:!0})],e.ZoomSphericalMomentumController.prototype,"screenCenter",null),t.__decorate([i.property({constructOnly:!0})],e.ZoomSphericalMomentumController.prototype,"sceneCenter",null),t.__decorate([i.property({constructOnly:!0})],e.ZoomSphericalMomentumController.prototype,"radius",void 0),e.ZoomSphericalMomentumController=t.__decorate([a.subclass("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],e.ZoomSphericalMomentumController),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/navigation/PanPlanarMomentumEstimator":function(){define(["exports","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","./FilteredFiniteDifference","./Momentum"],(function(e,t,r,i,s){"use strict";class n extends s.Momentum{constructor(e,t,r,i,s){super(e,t,r),this._sceneVelocity=i,this.direction=s}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}}e.PanPlanarMomentum=n,e.PanPlanarMomentumEstimator=class{constructor(e=300,t=12,s=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=s,this.enabled=!0,this._time=new i.FilteredFiniteDifference(.6),this._screen=[new i.FilteredFiniteDifference(.4),new i.FilteredFiniteDifference(.4)],this._scene=[new i.FilteredFiniteDifference(.6),new i.FilteredFiniteDifference(.6),new i.FilteredFiniteDifference(.6)],this._tmpDirection=r.create()}add(e,t,r){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(r)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(r)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,r=null==e||null==t?0:Math.sqrt(e*e+t*t),i=this._time.filteredDelta,s=null==i||null==r?0:r/i;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,r,i){t.set(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const s=t.length(this._tmpDirection);s>0&&t.scale(this._tmpDirection,this._tmpDirection,1/s);const o=this._time.filteredDelta;return new n(e,r,i,null==o?0:s/o,this._tmpDirection)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/navigation/FilteredFiniteDifference":function(){define(["exports"],(function(e){"use strict";e.FilteredFiniteDifference=class{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return void 0!==this.lastValue}hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return void 0===this.lastValue?NaN:e-this.lastValue}_updateDelta(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/navigation/Momentum":function(){define(["exports"],(function(e){"use strict";e.Momentum=class{constructor(e,t,r){this._initialVelocity=e,this._stopVelocity=t,this._friction=r,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const r=this.value(e);return this.value(e+t)-r}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const r=1-this.friction;return e*(r**t-1)/Math.log(r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/navigation/PanSphericalMomentumEstimator":function(){define(["exports","../../core/libs/gl-matrix-2/factories/vec2f64","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","../3d/state/utils/navigationUtils","./FilteredFiniteDifference","./FilteredValue","./Momentum"],(function(e,t,r,i,s,n,o,a){"use strict";const l=1e-5;class c extends a.Momentum{constructor(e,t,r,i,s,n=0,o){super(e,t,r),this._angularVelocity1=i,this.axis1=s,this.angularVelocity2=n,this.axis2=o}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}e.PanSphericalMomentum=c,e.PanSphericalMomentumEstimator=class{constructor(e=300,r=12,s=.84){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=s,this.enabled=!0,this._tmpAxis1=i.create(),this._tmpAxis2=i.create(),this._tmpAngles=t.create(),this._time=new n.FilteredFiniteDifference(.3),this._screen=[new n.FilteredFiniteDifference(.4),new n.FilteredFiniteDifference(.4)],this._angle1=new o.FilteredValue(.6),this._angle2=new o.FilteredValue(.6),this._axis1=i.create(),this._axis2=i.create(),this._lastScene=i.create()}addMomentumDirectRotation(e,t,i,n,o,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=s.rotationAngleAndAxisDirectRotation(this._lastScene,t,this._tmpAxis2,n,o,a);this._angle2.update(0),r.squaredLength(this._tmpAxis2)<l?e=0:r.normalize(this._axis1,this._tmpAxis2),this._angle1.update(e),r.copy(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,n,o,a,c){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;s.rotationAnglesAndAxesHeadingPreserving(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,n,o,a,c,!1),r.squaredLength(this._tmpAxis2)<l?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),r.normalize(this._axis1,this._tmpAxis1),r.normalize(this._axis2,this._tmpAxis2)),r.copy(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,r=null==e||null==t?null:Math.sqrt(e*e+t*t),i=this._time.filteredDelta,s=null==r||null==i?0:r/i;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,r){const i=this._time.filteredDelta,s=this._angle1.filteredValue,n=this._angle2.filteredValue,o=null==i||null==n?0:n/i;return new c(e,t,r,null==i||null==s?0:s/i,this._axis1,o,this._axis2)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/navigation/FilteredValue":function(){define(["exports"],(function(e){"use strict";e.FilteredValue=class{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/navigation/RotationMomentumEstimator":function(){define(["exports","./MomentumEstimator"],(function(e,t){"use strict";class r extends t.MomentumEstimator{constructor(e=3,t=.01,r=.95,i=12){super(e,t,r,i)}add(e,t){const r=this.value.lastValue;if(null!=r){let t=e-r;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;e=r+t}super.add(e,t)}}e.RotationMomentumEstimator=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/navigation/MomentumEstimator":function(){define(["exports","../../core/mathUtils","./FilteredFiniteDifference","./Momentum"],(function(e,t,r,i){"use strict";e.MomentumEstimator=class{constructor(e=2.5,t=.01,i=.95,s=12){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this._maxVelocity=s,this.enabled=!0,this.value=new r.FilteredFiniteDifference(.8),this.time=new r.FilteredFiniteDifference(.3)}add(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=t.clamp(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,t,r){return new i.Momentum(e,t,r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/navigation/ZoomMomentumEstimator":function(){define(["exports","./Momentum","./MomentumEstimator"],(function(e,t,r){"use strict";class i extends t.Momentum{constructor(e,t,r){super(e,t,r)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const r=super.value(e),i=super.value(e+t)-r;return Math.exp(i)}}class s extends r.MomentumEstimator{constructor(e=2.5,t=.01,r=.95,i=12){super(e,t,r,i)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,r){return new i(e,t,r)}}e.ZoomMomentum=i,e.ZoomMomentumEstimator=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/controllers/PinchAndPanControllerLocal":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/screenUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/axisAngle","../../../../geometry/support/plane","../../camera/constraintUtils","../../camera/constraintUtils/ConstraintOptions","../../camera/constraintUtils/ConstraintTypes","../../camera/constraintUtils/InteractionType","../../input/util","../../layers/VoxelWasm","./InteractiveController","./momentum/PanPlanarMomentumController","./momentum/RotationMomentumController","./momentum/ZoomPlanarMomentumController","../utils/navigationUtils","../../webgl/RenderCamera","../../../navigation/PanPlanarMomentumEstimator","../../../navigation/RotationMomentumEstimator","../../../navigation/ZoomMomentumEstimator"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M){"use strict";const R=u.fromValues(0,0,1);e.PinchAndPanControllerLocal=class extends b.InteractiveController{constructor(){super(...arguments),this._rotationValueSmooth=new y.ExponentialFalloff(.05),this._scalingValueSmooth=new y.ExponentialFalloff(.05),this._planeHorizontal=h.create(),this._planeVertical=h.create(),this._rotationMomentumEstimator=new P.RotationMomentumEstimator,this._panMomentumEstimator=new C.PanPlanarMomentumEstimator(300,12,.9),this._zoomMomentumEstimator=new M.ZoomMomentumEstimator,this._beginRadius=0,this._beginCenter=u.create(),this._beginAngle=0,this._tmpPoints=[],this._navMode=x.NavigationMode.Horizontal,this._beginCenterScreen=r.createScreenPointArray(),this._tmpCentroid3d=u.create(),this._tmpCentroid2d=r.createScreenPointArray(),this._tmp2d=r.createScreenPointArray(),this._pointerCount=0,this._beginCamera=new T,this._constraintOptions=new m.ConstraintOptions(f.ConstraintTypes.ALL,g.InteractionType.NONE,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),r.screenPointObjectToArray(e.center,this._beginCenterScreen),h.fromNormalAndOffset(R,0,this._planeHorizontal);const i=u.create(),s=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.basemapTerrain.invisible?x.excludeTerrain:{}),n=u.create();c.negate(n,this.startCamera.viewForward);const o=u.create();c.copy(o,R);const a=c.dot(n,o);this._navMode=x.navigationMode(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const l=Math.min(x.panDistanceModifier,1/Math.abs(c.dot(o,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),x.minHeightLimit);h.setOffsetFromPoint(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||h.negate(this._planeHorizontal,this._planeHorizontal);const d=u.create(),p=u.create(),m=u.create();c.subtract(d,i,this.currentCamera.eye);const f=c.length(d);if(c.normalize(d,d),this._navMode===x.NavigationMode.Vertical){c.scale(o,o,a),c.subtract(h.getNormal(this._planeVertical),n,o),c.normalize(h.getNormal(this._planeVertical),h.getNormal(this._planeVertical)),h.setOffsetFromPoint(this._planeVertical,this._planeVertical,i);const t=this.view.stage.renderView.getMinimalDepthForArea(_.getVoxelWasm(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,x.screenPixelArea);let r=null!=t?t:l;r=s?Math.min(r,f):r,c.copy(m,c.add(p,this.currentCamera.eye,c.scale(p,d,r))),this._planeVertical[3]=-c.dot(h.getNormal(this._planeVertical),m),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),x.centroid(this._tmpPoints,this._beginCenter)}else{const t=s?f:l;c.copy(m,c.add(p,this.currentCamera.eye,c.scale(p,d,t))),this._planeHorizontal[3]=-c.dot(h.getNormal(this._planeHorizontal),m),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),x.centroid(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._navMode===x.NavigationMode.Horizontal?this._planeHorizontal:this._planeVertical,s=this._beginCenter;if(t){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=r,this._scalingValueSmooth.update(t),x.applyZoomToPoint(this.currentCamera,s,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=g.InteractionType.ZOOM,this._constraintOptions.interactionFactor=p.pixelDistanceToInteractionFactor(Math.abs(e.radius-this._beginRadius)),p.applyAll(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),x.centroid(this._tmpPoints,this._tmpCentroid3d),r.screenPointObjectToArray(e.center,this._tmpCentroid2d),x.applyPanPlanar(this.currentCamera,s,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=g.InteractionType.PAN,this._constraintOptions.interactionFactor=p.pixelDistanceToInteractionFactor(l.distance(this._beginCenterScreen,this._tmpCentroid2d)),p.applyAll(this.view,this.currentCamera,this._constraintOptions),t){const t=s,r=this._rotationValueSmooth.value,i=r+x.normalizeRotationDelta(e.angle-r),n=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=n,this._rotationValueSmooth.update(i);const o=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(o,.001*e.timestamp);const a=h.getNormal(this._planeHorizontal);x.applyRotation(this.currentCamera,t,d.wrapAxisAngle(a,o)),this._constraintOptions.interactionType=g.InteractionType.TUMBLE,this._constraintOptions.interactionFactor=p.pixelDistanceToInteractionFactor(Math.abs(e.radius*o)),p.applyAll(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new w.ZoomPlanarMomentumController({view:this.view,momentum:t,zoomCenter:this._beginCenter});const r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new S.RotationMomentumController({view:this.view,momentum:r,center:this._beginCenter,axis:h.getNormal(this._planeHorizontal)});const i=this._panMomentumEstimator.evaluateMomentum();return i?new v.PanPlanarMomentumController({view:this.view,momentum:i}):null}_computePlanePoints(e,t,r,i){i.length=e.size;const s=this._tmp2d;let n=0;return e.forEach((e=>{s[0]=e.x,s[1]=e.y,void 0===i[n]&&(i[n]=u.create()),x.intersectPlaneFromScreenPointAtEye(t,r,s,i[n]),n+=1})),i}get _intersectionHelper(){return this.view.sceneIntersectionHelper}},e.PinchAndPanControllerLocal=t.__decorate([a.subclass("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],e.PinchAndPanControllerLocal),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/input/handlers/PointerDownCancelAnimation":function(){define(["exports","../../../input/InputHandler"],(function(e,t){"use strict";class r extends t.InputHandler{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}e.PointerDownCancelAnimation=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/input/handlers/TwoFingerTilt":function(){define(["exports","../../../../core/screenUtils","../../state/controllers/RotateController","../../../input/InputHandler"],(function(e,t,r,i){"use strict";class s extends i.InputHandler{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this._handleTwoFinger(e)))}_handleTwoFinger(e){const i=this._invert?-1:1,s=t.createScreenPointArray(0,e.data.delta*i);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new r.RotateController({view:this._view,pivot:r.PivotPoint.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break;case"update":this._cameraController?.update(s);break;case"end":this._cameraController?.end(),this._cameraController=null}}}e.TwoFingerTilt=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/BrowserEventSource":function(){define(["exports","../../core/has","../../core/maybe","./gamepad/GamepadSource","../support/screenUtils"],(function(e,t,r,i,s){"use strict";const n=t("edge"),o=t("chrome"),a=t("ff"),l=t("safari"),c="esri-view-surface",u={touchNone:`${c}--touch-none`,touchPan:`${c}--touch-pan`};class d{static{this.test={disableSubpixelCoordinates:!1}}constructor(e,t){this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new i.GamepadSource(e,t),this._gamepadSource.onEvent=e=>this._callback("gamepad",e)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach((e=>this._releasePointerCaptureSafe(e))),this._activePointerCaptures.clear(),this._gamepadSource=r.destroyMaybe(this._gamepadSource),this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const t in this._active)if(!e||!e.has(t)){const e=this._active[t];this._element.removeEventListener(h[t],e),delete this._active[t]}e&&e.forEach((e=>{if(!this._active[e]&&h[e]){const t=(this._eventHandlers[e]||this._handleDefault).bind(this,e);this._element.addEventListener(h[e],t),this._active[e]=t}})),this._gamepadSource&&(this._gamepadSource.hasEventListeners=e?.has("gamepad")??!1)}setPointerCapture(e,t){t?this._setPointerCaptureSafe(e.pointerId):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?u.touchNone:u.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?u.touchPan:u.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(u.touchNone),this._element.classList.remove(u.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCaptureSafe(e){try{this._element.setPointerCapture(e),this._activePointerCaptures.add(e)}catch{}}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch(e){}}_updateNormalizedPointerLikeEvent(e,t){const r=s.createScreenPointFromNativeEvent(this._element,e);return d.test.disableSubpixelCoordinates&&(r.x=Math.round(r.x),r.y=Math.round(r.y)),t.x=r.x,t.y=r.y,t}_handleKey(e,t){const{key:r}=t;r&&"key-up"===e&&this._keyDownState.delete(r);const i={native:t,key:r,repeat:!!r&&this._keyDownState.has(r)};r&&"key-down"===e&&this._keyDownState.add(i.key),this._callback(e,i)}_handlePointer(e,t){const r=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});this._callback(e,r)}_handlePointerPreventDefault(e,t){const r=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});t.preventDefault(),this._callback(e,r)}_getDeltaFromTrackpadOrMouseWheel(e){return e.shiftKey&&t("mac")&&0===e.deltaY?e.deltaX:e.deltaY}_handleMouseWheel(e,t){let r=this._getDeltaFromTrackpadOrMouseWheel(t);switch(t.deltaMode){case 0:n&&(r=r/document.documentElement.clientHeight*600);break;case 1:r*=30;break;case 2:r*=900}n?r*=.7:o||l?r*=.6:a&&(r*=1.375);const i=Math.abs(r);i>100&&(r=r/i*200/(1+Math.exp(-.02*(i-100))));const s=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,deltaY:r});this._callback(e,s)}_handlePointerCaptureLost(e,t){this._activePointerCaptures.delete(t.pointerId),this._handleDefault(e,t)}_handleDefault(e,t){const r={native:t};t.preventDefault(),this._callback(e,r)}_preventAltKeyDefault(e){"Alt"===e.key&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}}const h={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};e.BrowserEventSource=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/gamepad/GamepadSource":function(){define(["exports","../../../core/scheduling","./GamepadInputDevice","./GamepadState"],(function(e,t,r,i){"use strict";function s(e){if(!e)return!1;if(!e.connected)return!1;for(let t=0;t<e.axes.length;t++)if(isNaN(e.axes[t]))return!1;return!0}function n(e){for(const t of navigator.getGamepads())s(t)&&e(t)}e.GamepadSource=class{constructor(e,t){this._element=e,this._input=t,this._hasEventListeners=!1,this._onConnectGamepad=e=>{this._connectGamepad(e.gamepad)},this._onDisconnectGamepad=e=>{const t=e.gamepad,r=t.index,s=this._inputDevices[r];s&&(this._emitGamepadEvent(t,i.extractState(s),!1),this._inputDevices.splice(r,1),this._latestUpdate.splice(r,1),this._input.gamepad.devices.remove(s),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const r="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=r&&s,this.supported&&(n((e=>this._connectGamepad(e))),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this._callback=e}_connectGamepad(e){const t=new r(e);"unknown"!==t.deviceType&&(this._inputDevices[e.index]=t,this._input.gamepad.devices.add(t)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){null==this._frameTask&&(this._frameTask=t.addFrameTask({update:()=>this._readGamepadState()}))}_stopPolling(){null!=this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),t=this._element.contains(document.activeElement),r="document"===this._input.gamepad.enabledFocusMode&&!e||"view"===this._input.gamepad.enabledFocusMode&&!t;n((e=>{const t=this._inputDevices[e.index];if(!t)return;const s=this._latestUpdate[e.index],n=i.extractState(t),o=r||i.stateIdle(n);if(s){if(s.timestamp===e.timestamp)return;if(!s.active&&o)return;if(i.stateEqual(s.state,n))return}this._emitGamepadEvent(e,n,!o)}))}_emitGamepadEvent(e,t,r){const i=this._latestUpdate[e.index],s=i&&i.active;if(!s&&!r)return;const n=!s&&r?"start":s&&r?"update":"end";this._latestUpdate[e.index]={timestamp:e.timestamp,state:t,active:r},this._callback&&this._callback({device:this._inputDevices[e.index],state:t,action:n})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/gamepad/GamepadState":function(){define(["exports"],(function(e){"use strict";e.extractState=function(e){const t=e.native;return t?{buttons:t.buttons.map((e=>e.pressed?e.value||1:0)),axes:t.axes.map((t=>function(e,t){const r=Math.abs(e);return r<t?0:Math.sign(e)*(r-t)/(1-t)}(t,e.axisThreshold)))}:{buttons:[],axes:[]}},e.stateEqual=function(e,t){if(e.axes.length!==t.axes.length)return!1;if(e.buttons.length!==t.buttons.length)return!1;for(let r=0;r<e.axes.length;r++)if(e.axes[r]!==t.axes[r])return!1;for(let r=0;r<e.buttons.length;r++)if(e.buttons[r]!==t.buttons[r])return!1;return!0},e.stateIdle=function(e){for(let t=0;t<e.axes.length;t++)if(0!==e.axes[t])return!1;for(let t=0;t<e.buttons.length;t++)if(0!==e.buttons[t])return!1;return!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/handlers/PreventContextMenu":function(){define(["exports","../InputHandler"],(function(e,t){"use strict";class r extends t.InputHandler{constructor(){super(!0),this.registerIncoming("context-menu",(e=>e.data.native.preventDefault()))}}e.PreventContextMenu=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/recognizers/Drag":function(){define(["exports","../../../core/screenUtils","../../../core/time","../InputHandler","./support"],(function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e){super(!1),this._navigationTouch=e,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,t,r,i){return{action:e,pointerType:this._pointerType,button:this._mouseButton,buttons:t.buttons,timestamp:i,pointers:l(this._activePointerMap),pointer:t,angle:r.angle,radius:r.radius,center:r.center}}_addPointer(e){const t=e.native.pointerId,r=a(this._activePointerMap).angle,i={event:e,initialAngle:0,lastAngle:0};this._activePointerMap.set(t,i);const s=c(i,o(this._activePointerMap));i.initialAngle=s,i.lastAngle=s,this._updatePointerAngles(r)}_updatePointer(e){if(e&&null==e.x&&null==e.y)return;const t=e.native.pointerId,r=this._activePointerMap.get(t);r?r.event=e:this._addPointer(e)}_removePointer(e){const t=a(this._activePointerMap).angle;this._activePointerMap.delete(e),this._updatePointerAngles(t)}_updatePointerAngles(e){const t=a(this._activePointerMap);this._activePointerMap.forEach((r=>{r.initialAngle=c(r,t)-e,r.lastAngle=c(r,t)-e}))}_emitEvent(e,t,r){const i=a(this._activePointerMap);this._drag.emit(this._createPayload(e,t,i,r),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const t=e.data.native.pointerId,i=r.Milliseconds(e.timestamp);this._activePointerMap.get(t)&&(1===this._activePointerMap.size?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(t)):(this._removePointer(t),this._emitEvent("removed",e.data,r.Milliseconds(e.timestamp))))}_handlePointerDrag(e){const t=e.data,i=t.currentEvent,s=r.Milliseconds(e.timestamp);switch(t.action){case"start":case"update":this._isDragging?this._activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this._isCurrentDragSuppressed&&this._emitEvent("update",i,s)):(this._addPointer(i),this._emitEvent("added",i,s),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(i),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",i,s))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&"touch"===this._pointerType&&1===this._activePointerMap.size}}function o(e){const r=[];return e.forEach((e=>{r.push(t.createScreenPoint(e.event.x,e.event.y))})),s.fitCircleLSQ(r)}function a(e){const t=o(e);let r=0;return e.forEach((e=>{let i=c(e,t),s=i-e.lastAngle;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;i=e.lastAngle+s,e.lastAngle=i;const n=i-e.initialAngle;r+=n})),r/=e.size||1,{angle:r,radius:t.radius,center:t.center}}function l(e){const t=new Map;return e.forEach(((e,r)=>t.set(r,e.event))),t}function c(e,t){const r=e.event,i=r.x-t.center.x,s=r.y-t.center.y;return Math.atan2(s,i)}var u;e.Button=void 0,(u=e.Button||(e.Button={}))[u.Left=0]="Left",u[u.Middle=1]="Middle",u[u.Right=2]="Right",u[u.Back=3]="Back",u[u.Forward=4]="Forward",u[u.Undefined=-1]="Undefined",e.Drag=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/recognizers/support":function(){define(["exports","../../../core/has","../../../core/screenUtils"],(function(e,t,r){"use strict";e.euclideanDistance=function(e,t){const r=t.x-e.x,i=t.y-e.y;return Math.sqrt(r*r+i*i)},e.fitCircleLSQ=function(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:r.createScreenPoint()},0===e.length)return t;if(1===e.length)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(2===e.length){const[r,i]=e,[s,n]=[i.x-r.x,i.y-r.y];return t.radius=Math.sqrt(s*s+n*n)/2,t.center.x=(r.x+i.x)/2,t.center.y=(r.y+i.y)/2,t}let i=0,s=0;for(let t=0;t<e.length;t++)i+=e[t].x,s+=e[t].y;i/=e.length,s/=e.length;const n=e.map((e=>e.x-i)),o=e.map((e=>e.y-s));let a=0,l=0,c=0,u=0,d=0,h=0,p=0;for(let e=0;e<n.length;e++){const t=n[e],r=o[e],i=t*t,s=r*r;a+=i,l+=s,c+=t*r,u+=i*t,d+=s*r,h+=t*s,p+=r*i}const m=.5*(u+h),f=.5*(d+p),g=a*l-c*c,y=(m*l-f*c)/g,_=(a*f-c*m)/g,b=r.createScreenPoint(y+i,_+s);return{radius:Math.sqrt(y*y+_*_+(a+l)/e.length),center:b}},e.getDoubleClickParameters=(e={})=>({maximumClickDelay:300,maximumDoubleClickDistance:10,maximumDoubleTouchDistance:35,maximumDoubleClickDelay:250,maximumDoubleTouchDelay:350,...e}),e.getHoldAndDragParameters=(e={})=>({maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500,...e}),e.getPointerId=function(e){const{native:t}=e,{pointerId:r,button:i,pointerType:s}=t;return"mouse"===s?`${r}:${i}`:`${s}`},e.manhattanDistance=function(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/recognizers/ImmediateDoubleClick":function(){define(["exports","../../../core/clock","../InputHandler","./support"],(function(e,t,r,i){"use strict";class s extends r.InputHandler{constructor(e={},r=t.clock){super(!1),this._clock=r,this._pointerState=new Map,this._parameters=i.getDoubleClickParameters(e),this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach((e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()})),super.onUninstall()}_handlePointerDown(e){const t=e.data,r=i.getPointerId(t);if(!this._pointerState.has(r)){const e={downButton:t.native.button,x:t.x,y:t.y,immediateDoubleClick:null};this._pointerState.set(r,e),this.startCapturingPointer(t.native)}}_handlePointerUp(e){const t=e.data,r=i.getPointerId(t),s=this._pointerState.get(r);if(s&&s.downButton===t.native.button){const r=s.immediateDoubleClick,n="touch"===e.data.native.pointerType?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;r?(r.timeoutHandle.remove(),i.manhattanDistance(r,e.data)>n?this._startImmediateDoubleClick(e,s):(this._immediateDoubleClick.emit(e.data,void 0,r.modifiers),this._removeState(t))):i.manhattanDistance(s,e.data)>n?this._removeState(t):this._startImmediateDoubleClick(e,s)}}_startImmediateDoubleClick(e,t){const r="touch"===e.data.native.pointerType?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay;t.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout((()=>this._removeState(e.data)),r)}}_removeState(e){const t=i.getPointerId(e);this._pointerState.delete(t),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}}e.ImmediateDoubleClick=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/recognizers/PointerClickHoldAndDrag":function(){define(["exports","../../../core/clock","../../../core/maybe","../InputHandler","./support"],(function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e={},r=t.clock){super(!1),this._clock=r,this._pointerState=new Map,this._parameters=s.getHoldAndDragParameters(e),this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",(e=>this._handlePointerDown(e))),this.registerIncoming("pointer-up",(e=>this._handlePointerLoss(e,"pointer-up"))),this.registerIncoming("pointer-capture-lost",(e=>this._handlePointerLoss(e,"pointer-capture-lost"))),this.registerIncoming("pointer-cancel",(e=>this._handlePointerLoss(e,"pointer-cancel"))),this._moveHandle=this.registerIncoming("pointer-move",(e=>this._handlePointerMove(e))),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach((e=>{e.holdTimeout=r.removeMaybe(e.holdTimeout)})),super.onUninstall()}_handlePointerDown(e){const t=e.data,r=t.native.pointerId;let i=null;0===this._pointerState.size&&(i=this._clock.setTimeout((()=>{const t=this._pointerState.get(r);if(t){if(!t.isDragging){const r=t.previousEvent;this._pointerHold.emit(r,void 0,e.modifiers),t.holdEmitted=!0}t.holdTimeout=null}}),this._parameters.holdDelay));const s={startEvent:t,previousEvent:t,startTimestamp:e.timestamp,isDragging:!1,downButton:t.native.button,holdTimeout:i,modifiers:new Set};this._pointerState.set(r,s),this.startCapturingPointer(t.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_handlePointerMove(e){const t=e.data,r=t.native.pointerId,i=this._pointerState.get(r);i&&(i.isDragging?this._pointerDrag.emit(o("update",i,t),void 0,i.modifiers):s.euclideanDistance(t,i.startEvent)>this._getDragThreshold(t.native.pointerType)&&this._startDragging(e),i.previousEvent=t)}_getDragThreshold(e){switch(e){case"touch":return this._parameters.movementUntilTouchDrag;case"pen":return this._parameters.movementUntilPenDrag;default:return this._parameters.movementUntilMouseDrag}}_startDragging(e){const t=e.data,r=t.native.pointerId;this._pointerState.forEach((i=>{null!=i.holdTimeout&&(i.holdTimeout.remove(),i.holdTimeout=null),i.isDragging||(i.modifiers=e.modifiers,i.isDragging=!0,r===i.startEvent.native.pointerId?this._pointerDrag.emit(o("start",i,t)):this._pointerDrag.emit(o("start",i,i.previousEvent),e.timestamp))}))}_handlePointerLoss(e,t){const r=e.data,i=r.native.pointerId,s=this._pointerState.get(i);s&&(null!=s.holdTimeout&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging?this._pointerDrag.emit(o("end",s,"pointer-up"===t?r:s.previousEvent),void 0,s.modifiers):"pointer-up"===t&&s.downButton===r.native.button&&e.timestamp-s.startTimestamp<=this._parameters.maximumClickDelay&&!s.holdEmitted&&this._immediateClick.emit(r),this._pointerState.delete(i),this.stopCapturingPointer(r.native),0===this._pointerState.size&&this._moveHandle.pause())}}function o(e,t,r){return{action:e,startEvent:t.startEvent,previousEvent:t.previousEvent,currentEvent:r}}e.PointerClickHoldAndDrag=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/recognizers/SingleAndDoubleClick":function(){define(["exports","../../../core/clock","../../../core/maybe","../InputHandler","./support"],(function(e,t,r,i,s){"use strict";class n extends i.InputHandler{constructor(e={},r=t.clock){super(!1),this._clock=r,this._pointerState=new Map,this._parameters=s.getDoubleClickParameters(e),this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",(e=>this._handleImmediateClick(e))),this.registerIncoming("pointer-down",(e=>this._handlePointerDown(e)))}onUninstall(){this._pointerState.forEach((e=>e.doubleClickTimer=r.removeMaybe(e.doubleClickTimer)))}get hasPendingInputs(){for(const e of this._pointerState.values())if(null!=e.doubleClickTimer)return!0;return!1}_clearDoubleClickTimer(e,t){const i=this._pointerState.get(e);i&&(i.doubleClickTimer=r.removeMaybe(i.doubleClickTimer),t&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const t=this._pointerState.get(e);1===t.pointerDownCount&&this._click.emit(t.event.data,void 0,t.event.modifiers),t.doubleClickTimer=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}_handleImmediateClick(e){const t=e.data,{pointerType:r}=t.native,i=function(e){const{pointerId:t,pointerType:r,button:i}=e.native;return"mouse"===r?`${t}:${i}`:`${r}`}(t);if(!this._pointerState.has(i))return void this._startClick(e);const n=this._pointerState.get(i),{data:o,modifiers:a}=n.event,l="touch"===r?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;s.manhattanDistance(o,t)>l?(this._clearDoubleClickTimer(i,!0),this._startClick(e)):(this._clearDoubleClickTimer(i,!1),2===n.pointerDownCount&&this._doubleClick.emit(o,void 0,a))}_handlePointerDown(e){const t=s.getPointerId(e.data),r=this._pointerState.get(t);r&&(r.pointerDownCount+=1)}_startClick(e){const{data:t}=e,{native:{pointerType:r}}=t,i=s.getPointerId(t),n="touch"===r?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay,o=this._clock.setTimeout((()=>this._doubleClickTimeoutExceeded(i)),n);this._pointerState.set(i,{event:e,doubleClickTimer:o,pointerDownCount:1}),this.refreshHasPendingInputs()}}e.SingleAndDoubleClick=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/recognizers/VerticalTwoFingerDrag":function(){define(["exports","../DragEventSeparator","../InputHandler"],(function(e,t,r){"use strict";class i extends r.InputHandler{constructor(e=20,r=40){super(!1),this._threshold=e,this._maxDelta=r,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new t.DragEventSeparator({start:(e,t)=>this._observeStart(e,t),update:(e,t,r)=>this._observeUpdate(e,t,r),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",(e=>this._dragEventSeparator.handle(e)))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,r){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,r.data)?this._checkVerticalThresholdReached(t.data,r.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let r=-1/0,i=1/0,s=-1/0,n=1/0;for(const{x:e,y:o}of t.pointers.values())r=Math.max(r,e),i=Math.min(i,e),s=Math.max(s,o),n=Math.min(n,o);let o=-1/0,a=1/0,l=-1/0,c=1/0;for(const{x:t,y:r}of e.pointers.values())o=Math.max(o,t),a=Math.min(a,t),l=Math.max(l,r),c=Math.min(c,r);const u=r-i,d=s-n,h=o-a,p=l-c;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(h-u)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let r=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,i)=>{const s=t.pointers.get(i);r=Math.min(r,Math.abs(e.y-s.y))})),r>=this._threshold}}e.VerticalTwoFingerDrag=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/input/DragEventSeparator":function(){define(["exports"],(function(e){"use strict";e.DragEventSeparator=class{constructor(e){this._callbacks=e,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(e){const t=e.data,r=t.pointers.size;switch(t.action){case"start":this._currentCount=r,this._emitStart(e);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=r,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=r,this._emitStart(e);break;case"end":this._emitEnd(e),this._currentCount=0}this._previousEvent=e}_emitStart(e){this._startEvent=e,this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.start(this._currentCount,e,this._startEvent)}_emitUpdate(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.update(this._currentCount,e,this._startEvent)}_emitEnd(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.end(this._currentCount,e,this._startEvent),this._startEvent=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/GraphicsDeconflictor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/Error","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/boundedPlane","./Deconflictor","./enums","./LabelDeconflictor","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";function m(e){const t=e.layer;return!(!t?.featureReduction||"selection"!==t.featureReduction.type)}e.GraphicsDeconflictor=class extends u.Deconflictor{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=d.VisibilityGroup.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add((()=>this.view?.state?.camera),(()=>{this._updateViewState(),this.setDirty()})),this._updatingHandles.add((()=>this.view?.slice?.plane),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),i.initial),this.addHandles(i.watch((()=>this.view.basemapTerrain?.updating||this.view.graphicsView?.updating||this.view.allLayerViews.some((e=>e.updating))),((e,t)=>{!e&&t&&this.setDirty()}),i.sync)),this._frameTask=this.view.resourceController.scheduler.registerTask(p.TaskPriority.GRAPHICS_DECONFLICTOR,this),this._labels=new h.LabelDeconflictor({view:this.view,parent:this})}destroy(){this._labels=r.destroyMaybe(this._labels),this._frameTask=r.removeMaybe(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){const t=super.runTask(e);return this.running||this._labels.setDirty(),t}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?.slice?.plane;null!=e&&c.transform(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:r=>this._addGraphic(e,t,r),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labelsEnabledChanged(e,t),featureReductionChange:()=>this._enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,r){const i=r.graphic.uid,s=new u.DeconflictorGraphic(r,e.symbolCreationContext.slicePlaneEnabled);t.set(i,s),this.addToCheckOcclusion(s),m(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&(this._labels.addToCheckOcclusion(s),this._labels.addToActiveGraphics(s));const n=!this._graphicSupportsDeconfliction(r)||!m(e);r.setVisibilityFlag(d.VisibilityGroup.GRAPHIC,d.VisibilityFlag.DECONFLICTION,n)}_removeGraphic(e,t){const r=t.graphic.uid,i=e.get(r);i&&(this.removeFromActiveGraphics(i),this.removeFromCheckOcclusion(i),this._labels.removeFromActiveGraphics(i),this._labels.removeFromCheckOcclusion(i),e.delete(r),this.setDirty())}_enabledChanged(e,t){m(e)?t.forEach((e=>this.addToActiveGraphics(e))):(t.forEach((e=>this.removeFromActiveGraphics(e))),function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.setVisibilityFlag(d.VisibilityGroup.GRAPHIC,d.VisibilityFlag.DECONFLICTION,!0)))}(e))}_labelsEnabledChanged(e,t){e.labelsEnabled?(t.forEach((e=>this._labels.addToCheckOcclusion(e))),t.forEach((e=>this._labels.addToActiveGraphics(e)))):(t.forEach((e=>this._labels.removeFromCheckOcclusion(e))),t.forEach((e=>this._labels.removeFromActiveGraphics(e))))}_slicePlaneEnabledChanged(e,t){const r=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=r)),this.setDirty()}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t?.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const r=new Map;return this._contexts.set(e,r),this.setDirty(),r}},e.GraphicsDeconflictor=t.__decorate([l.subclass("esri.views.3d.layers.graphics.GraphicsDeconflictor")],e.GraphicsDeconflictor),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Deconflictor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../core/support/UpdatingHandles","../../../../geometry/ellipsoidUtils","../../../../geometry/support/aaBoundingRect","../../../../chunks/boundedPlane","../../../../geometry/support/ray","../../../../chunks/sphere","./DeconflictAABR","./deconflictorDebug","./enums","../../webgl/RenderCamera","../../webgl-engine/lib/GPUPointOcclusionQuery","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/HUDMaterial","../../webgl-engine/materials/ScaleInfo","../../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I){"use strict";const D=m.create(),F=m.create(),L=g.create(),N=g.create(),U=m.create(),V=d.create(),B=w.create(),G=S.create(),k=m.create(),z=b.create();class j{constructor(e){this.id=e,this.aabr=b.create(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.culled=!1,this.visible=!1,this.priority=0}}function q(e,t){const r=0!==e.distanceToOccluder&&e.distance>e.distanceToOccluder,i=0!==t.distanceToOccluder&&t.distance>t.distanceToOccluder;return r!==i?+r-+i:e.priority!==t.priority?t.priority-e.priority:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?+t.visible-+e.visible:e.id-t.id}var H;e.State=void 0,(H=e.State||(e.State={}))[H.Idle=0]="Idle",H[H.CheckOcclusion=1]="CheckOcclusion",H[H.WaitOcclusion=2]="WaitOcclusion",H[H.Collect=3]="Collect",H[H.Deconflict=4]="Deconflict",H[H.NumStates=5]="NumStates";class W{constructor(){this.camera=new P,this.slicePlane=v.create(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),v.copy(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}e.Deconflictor=class extends r{get dirty(){return this._dirty}get state(){return this._state}constructor(t){super(t),this._dirty=!1,this._viewState=new W,this._state=e.State.Idle,this._checkOcclusion=new Map,this._active=new Map,this._checkOcclusionIterator=null,this._activeIterator=null,this._occlusionQueryUids=new Array,this._updatingHandles=new y.UpdatingHandles,this._deconflictor=new x.DeconflictAABR(((e,t)=>{e.visible=t,this._setGraphicVisibility(this._active.get(e.id),t)}),((e,t)=>e.id!==t.id),q),this._baseOccludedVisibility=10,this._altitudeFactor=2,this._minAltitudeDifference=100}initialize(){this._updatingHandles.add((()=>(this.view?.map?.ground?.opacity??0)>0),(()=>this.setDirty())),this._updatingHandles.add((()=>this.view.ready),(()=>this._occlusionQuery=null))}destroy(){this._occlusionQuery=null,this._updatingHandles.destroy(),this._deconflictor.destroy(),this._checkOcclusion.clear(),this._active.clear()}setDirty(){!this._dirty&&(this._active.size>0||this._checkOcclusion.size>0)&&(this._dirty=!0,this.notifyChange("updating"))}setPriority(e,t){const r=this._active.get(e.graphic.uid)?.getInfo(this.visibilityGroup);r&&(r.priority=t)}get updating(){return this._state!==e.State.Idle||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const t=this._state/e.State.NumStates;return this._dirty?.5*t:t}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(t){switch(this._state){case e.State.Idle:this._startUpdate(),t.madeProgress();case e.State.CheckOcclusion:if(this._state=e.State.CheckOcclusion,!this._processCheckOcclusion(t))return;case e.State.WaitOcclusion:if(this._state=e.State.WaitOcclusion,this._occlusionQuery&&!this._occlusionQuery.done)return I.Yield;this._readOcclusionQueryResult(),t.madeProgress();case e.State.Collect:if(this._state=e.State.Collect,!this._collectActiveGraphics(t))return;case e.State.Deconflict:if(this._state=e.State.Deconflict,this._deconflictor.run(t),!this._deconflictor.done)return;default:this._state=e.State.Idle,this.notifyChange("updating")}}setGraphicsActive(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e)))}layerSupportsDeconfliction(e){if(null==e||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?.geometries.length??0))return!1;const r=t?.geometries[0],i=r?.material;return i instanceof O.HUDMaterial}_startUpdate(){T.prepare(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._viewState.camera;this._deconflictor.reset(e,t),this._resetIterators(),this._occlusionQueryUids.length=0,this._checkOcclusion.size||(this._occlusionQuery=s.destroyMaybe(this._occlusionQuery))}addToActiveGraphics(e){e.ensureInfo(this.visibilityGroup),this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){!function(e,t){const r=e.graphics3DGraphic;r.destroyed||r.setVisibilityFlag(t,C.VisibilityFlag.DECONFLICTION,!0)}(e,this.visibilityGroup),e.removeInfo(this.visibilityGroup),this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToCheckOcclusion(e){this._checkOcclusion.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromCheckOcclusion(e){this._checkOcclusion.delete(e.graphics3DGraphic.graphic.uid)}_processCheckOcclusion(e){if(0===this._checkOcclusion.size)return!0;const t=this._ensureCheckOcclusionIterator(),r=this._viewState.camera,i=u.transpose(V,r.viewInverseTransposeMatrix),n=this.view.map.ground.opacity>0,o="global"===this.view.viewingMode&&n&&r.relativeElevation>0?B:null;let a=0;null!=o&&(p.transformMat4(w.getCenter(o),m.ZEROS,r.viewMatrix),o[3]=_.getReferenceEllipsoid(this.view.spatialReference).radius,a=w.distanceToSilhouette(o,m.ZEROS));const l=b.create();for(;;){if(e.done)return!1;e.madeProgress();const s=t.next();if(!0===s.done)break;const n=s.value,c=n.graphics3DGraphic;if(c.destroyed)continue;if(!c.isVisible(C.VisibilityGroup.GRAPHIC,C.VisibilityFlag.DECONFLICTION))continue;const u=Z(c,this.visibilityGroup);let d=null,h=!0;for(const e of u){if(!this.layerSupportsDeconfliction(e))continue;d=Y,this._projectHudLayer(e,r,d),b.empty(l);const t=e.stageObject.geometries[0].material;if(this._expandBoundingRect(l,r,e,t,d),d.isOutsideScreen){h=!1;break}if(this._isCulledBySlice(n,d.positionView)){h=!1;break}if(null!=o&&Q(d,o,a)){h=!1;break}p.transformMat4(F,d.positionView,i),d.altitude=this.view.renderCoordsHelper.getAltitude(F);const s=n.ensureInfo(this.visibilityGroup);if(s.altitude=d.altitude,s.distance=d.distance,s.distanceToOccluder=d.distanceToOccluder,s.culled=!1,b.copy(s.aabr,l),t.parameters.occlusionTest)break;this._ensureOcclusionQuery().addPosition(F)===this._occlusionQueryUids.length&&this._occlusionQueryUids.push(c.graphic.uid);break}if(this._active.has(c.graphic.uid)&&(!h||!d)){const e=n.ensureInfo(this.visibilityGroup);e.visible=!d,e.culled=!0}}return this._checkOcclusionIterator=null,this._occlusionQueryUids.length||(this._occlusionQuery=s.destroyMaybe(this._occlusionQuery)),this._occlusionQuery?.start(),!0}_readOcclusionQueryResult(){if(!this._occlusionQuery||!this._occlusionQueryUids.length)return;const e=this._viewState.camera,t=this.view.renderCoordsHelper.getAltitude(e.eye);for(let e=0;e<this._occlusionQueryUids.length;e++){const r=this._occlusionQueryUids[e],i=this._checkOcclusion.get(r);if(!i)continue;const s=this._occlusionQuery.getOcclusion(e)??-1,n=i.getInfo(this.visibilityGroup);n&&(n.distanceToOccluder=s>0?n.distance-s:0);const o=s<=0||this._occludedVisibility(n?.distanceToOccluder??0,n?.distance??s,n?.altitude??0,t);this._active.has(r)?n&&(n.culled=!o,n.visible=o):this._setGraphicVisibility(i,o)}this._occlusionQueryUids.length=0}_collectActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),r=this.visibilityGroup===C.VisibilityGroup.LABEL;for(;!e.done;){e.madeProgress();const i=t.next();if(!0===i.done)return this._activeIterator=null,!0;const s=i.value,n=s.getInfo(this.visibilityGroup);n&&(r&&!s.graphics3DGraphic.isVisible()||n.culled?(T.drawPoly(n.aabr,!1,!0),this._setGraphicVisibility(s,n.visible)):this._deconflictor.add(n))}return!1}_occludedVisibility(e,t,r,i){const s=Math.max(this._minAltitudeDifference,Math.abs(r-i))-this._minAltitudeDifference;return 0===e||t-e<=this._baseOccludedVisibility+this._altitudeFactor*s}_resetIterators(){this._checkOcclusionIterator=null,this._activeIterator=null}_ensureCheckOcclusionIterator(){return this._checkOcclusionIterator??=this._checkOcclusion.values(),this._checkOcclusionIterator}_ensureActiveGraphicsIterator(){return this._activeIterator??=this._active.values(),this._activeIterator}_ensureOcclusionQuery(){return this._occlusionQuery??=new M.GPUPointOcclusionQuery({view:this.view}),this._occlusionQueryUids.length||this._occlusionQuery.init(this._checkOcclusion.size,this._viewState.camera.eye),this._occlusionQuery}_projectHudLayer(e,t,r){const i=e.stageObject,s=i.geometries[0],n=s.material,o=w.getCenter(i.boundingVolumeWorldSpace.bounds);p.transformMat4(D,o,t.viewMatrix);const a=s.attributes,l=a.get(E.VertexAttribute.NORMAL).data,c=a.get(E.VertexAttribute.CENTEROFFSETANDDISTANCE).data;n.applyShaderOffsetsView(D,l,i.transformation,c,t,r.scaleInfo,D),f.set(L,D[0],D[1],D[2],1),f.transformMat4(N,L,t.projectionMatrix),p.scale(r.positionNDC,N,1/N[3]),n.applyShaderOffsetsNDC(r.positionNDC,c,t,r.positionNDC,U),r.distanceWithoutPolygonOffset=t.depthNDCToWorld(U[2]),r.distance=U[2]===r.positionNDC[2]?r.distanceWithoutPolygonOffset:t.depthNDCToWorld(r.positionNDC[2]),f.set(N,r.positionNDC[0],r.positionNDC[1],r.positionNDC[2],1),f.transformMat4(L,N,t.inverseProjectionMatrix),f.scale(L,L,1/L[3]),p.set(r.positionView,D[0],D[1],D[2])}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&v.extrusionContainsPoint(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,r,s,{positionNDC:n,scaleInfo:o}){const a=r.getScreenSize($);R.applyPrecomputedScaleFactor(a,o.factor,a),a[0]*=t.pixelRatio,a[1]*=t.pixelRatio;const l=b.offset(s.calculateRelativeScreenBounds(a,o.factorAlignment.scale*t.pixelRatio,z),i.lerp(0,t.fullWidth,.5+.5*n[0]),i.lerp(0,t.fullHeight,.5+.5*n[1])),c=this.marginFactor;if(0!==c){const e=c*Math.min(b.width(l),b.height(l));l[0]-=e,l[1]-=e,l[2]+=e,l[3]+=e}b.expand(e,l,e)}_setGraphicVisibility(e,t){const r=e?.graphics3DGraphic;r&&!r.destroyed&&(r.setVisibilityFlag(this.visibilityGroup,C.VisibilityFlag.DECONFLICTION,t),this.visibilityGroup===C.VisibilityGroup.LABEL&&this.view.labeler.setLabelGraphicVisibility(r,t))}},t.__decorate([n.property({constructOnly:!0})],e.Deconflictor.prototype,"view",void 0),t.__decorate([n.property({type:Boolean,readOnly:!0})],e.Deconflictor.prototype,"updating",null),t.__decorate([n.property({readOnly:!0})],e.Deconflictor.prototype,"_updatingHandles",void 0),e.Deconflictor=t.__decorate([c.subclass("esri.views.3d.layers.graphics.Deconflictor")],e.Deconflictor);const $=h.create();function Q(e,t,r){return p.copy(G.direction,e.positionView),p.set(G.origin,0,0,0),!!w.intersectRay(t,G,k)&&e.distanceWithoutPolygonOffset>r}function Z(e,t){return t===C.VisibilityGroup.LABEL?e.labelLayers:e.layers}const Y=new class{constructor(){this.positionView=m.create(),this.positionNDC=m.create(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new A.ScaleInfo}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1||e[2]>=1}};e.DeconflictorGraphic=class{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this._info=null,this._labelInfo=null}ensureInfo(e){let t=this.getInfo(e);return t||(t=new j(this.graphics3DGraphic.graphic.uid),this._setInfo(e,t)),t}getInfo(e){return e===C.VisibilityGroup.LABEL?this._labelInfo:this._info}removeInfo(e){this._setInfo(e,null)}_setInfo(e,t){e===C.VisibilityGroup.LABEL?this._labelInfo=t:this._info=t}},e.DeconflictorViewState=W,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/DeconflictAABR":function(){define(["exports","../../../../core/HeapSort","../../../../core/PooledArray","../../../../geometry/support/aaBoundingRect","./deconflictorDebug"],(function(e,t,r,i,s){"use strict";e.DeconflictAABR=class{constructor(e,t,r){this._setVisibility=e,this._canConflict=t,this._compare=r,this.done=!1,this._items=new Array,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null}destroy(){this._generator=null}reset(e,t){this._initBins(e,t),this._items.length=0,this.done=!1,this._generator=null}add(e){this._items.push(e)}run(e){this._generator??=this._run(e),this.done=!!this._generator.next(e).done}*_run(e){yield*this._sort(e),yield*this._deconflict(e),s.drawAccelerationStruct((()=>({bins:this._accBins,numX:this._accBinsNumX,numY:this._accBinsNumY,sizeX:this._accBinsSizeX,sizeY:this._accBinsSizeY,numTests:0,numVisible:this._items.length})))}*_sort(e){for(const r of t.iterableSort(this._items,0,this._items.length,this._compare))e.madeProgress(),e.done&&(e=yield)}_isConflicted(e){let t=!0;return this._forEachBin(e.aabr,(r=>(t=!1,r.some((t=>this._canConflict(t,e)&&i.intersects(t.aabr,e.aabr))))))||t}*_deconflict(e){for(const t of this._items){e.done&&(e=yield);const r=!this._isConflicted(t);this._setVisibility(t,r),s.drawPoly(t.aabr,r),r&&this._addToBins(t),e.madeProgress()}}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new r)}}else for(let e=0;e<this._accBinsNumX;e++)for(let t=0;t<this._accBinsNumY;t++)this._accBins[e][t].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY}_addToBins(e){this._forEachBin(e.aabr,(t=>t.push(e)))}_forEachBin(e,t){if(!this._accBins)return!1;const r=Math.max(Math.floor(e[0]/this._accBinsSizeX),0),i=Math.max(Math.floor(e[1]/this._accBinsSizeY),0),s=Math.min(Math.floor(e[2]/this._accBinsSizeX),this._accBinsNumX-1),n=Math.min(Math.floor(e[3]/this._accBinsSizeY),this._accBinsNumY-1);for(let e=r;e<=s;e++)for(let r=i;r<=n;r++)if(t(this._accBins[e][r]))return!0;return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/deconflictorDebug":function(){define(["exports","../../support/debugFlags"],(function(e,t){"use strict";let r,i,s=!1,n=!1,o=!1,a=!1,l=null;function c(){l&&(l(),l=null)}function u(e,t,s,n,o){c();const a=r.height,l=i;l.beginPath(),l.lineWidth=1,l.strokeStyle=o,l.moveTo(e,a-s),l.lineTo(t,a-s),l.stroke(),l.lineTo(t,a-n),l.stroke(),l.lineTo(e,a-n),l.stroke(),l.lineTo(e,a-s),l.stroke(),l.closePath()}e.drawAccelerationStruct=function(e){const t=n?e():null;if(!t?.bins)return;c();const r=i;let s=0;for(let e=0;e<t.numX;e++)for(let i=0;i<t.numY;i++){const n=t.bins[e][t.numY-1-i];s+=n.length;const o=e*t.sizeX,a=(e+1)*t.sizeX,l=i*t.sizeY,c=(i+1)*t.sizeY;r.fillText(n.length.toFixed(),o+5,l+15),u(o,a,l,c,"blue")}r.fillText("total totalShownLabels: "+s,70,40),r.fillText("total visible labels: "+t.numVisible,70,50),r.fillText("total numTests: "+t.numTests,70,30)},e.drawPoly=function(e,t,r=!1){s&&(t&&o||!t&&a)&&u(e[0],e[2],e[1],e[3],r?t?"pink":"grey":t?"green":"red")},e.prepare=function(e){o=t.debugFlags.DECONFLICTOR_SHOW_VISIBLE,a=t.debugFlags.DECONFLICTOR_SHOW_INVISIBLE,s=o||a,n=t.debugFlags.DECONFLICTOR_SHOW_GRID,l=null,s||n?(i&&r&&i.clearRect(0,0,r.width,r.height),l=()=>function(e){null==r&&(r=document.createElement("canvas"),r.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(r),r.style.position="absolute",r.style.width="100%",r.style.height="100%",r.style.display="block",r.style.pointerEvents="none",i=r.getContext("2d"),i.font="12px Arial");const{width:t,height:s}=e.state.camera;r.width=t,r.height=s}(e)):r&&(r.parentElement.removeChild(r),r=null)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/debugFlags":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";let l=class extends r{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};t.__decorate([i.property()],l.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),t.__decorate([i.property()],l.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),t.__decorate([i.property()],l.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),t.__decorate([i.property()],l.prototype,"DECONFLICTOR_SHOW_GRID",void 0),t.__decorate([i.property()],l.prototype,"LABELS_SHOW_BORDER",void 0),t.__decorate([i.property()],l.prototype,"TEXT_SHOW_BASELINE",void 0),t.__decorate([i.property()],l.prototype,"TEXT_SHOW_BORDER",void 0),t.__decorate([i.property()],l.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),t.__decorate([i.property()],l.prototype,"OVERLAY_SHOW_CENTER",void 0),t.__decorate([i.property()],l.prototype,"SHOW_POI",void 0),t.__decorate([i.property()],l.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),t.__decorate([i.property()],l.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),t.__decorate([i.property()],l.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),t.__decorate([i.property()],l.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),t.__decorate([i.property()],l.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),t.__decorate([i.property()],l.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),t.__decorate([i.property()],l.prototype,"I3S_TREE_SHOW_TILES",void 0),t.__decorate([i.property()],l.prototype,"I3S_SHOW_MODIFICATIONS",void 0),t.__decorate([i.property()],l.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),t.__decorate([i.property()],l.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),t.__decorate([i.property()],l.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),t.__decorate([i.property()],l.prototype,"LINE_WIREFRAMES",void 0),l=t.__decorate([a.subclass("esri.views.3d.support.debugFlags")],l);const c=new l;e.debugFlags=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/enums":function(){define(["exports"],(function(e){"use strict";var t,r;e.VisibilityFlag=void 0,(t=e.VisibilityFlag||(e.VisibilityFlag={}))[t.USER=1]="USER",t[t.SCALE_RANGE=2]="SCALE_RANGE",t[t.FILTER=4]="FILTER",t[t.DECONFLICTION=8]="DECONFLICTION",t[t.ALL_GRAPHIC=15]="ALL_GRAPHIC",t[t.ALL_LABEL=255]="ALL_LABEL",e.VisibilityGroup=void 0,(r=e.VisibilityGroup||(e.VisibilityGroup={}))[r.GRAPHIC=1]="GRAPHIC",r[r.LABEL=16]="LABEL",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/GPUPointOcclusionQuery":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../webgl","../../webgl/RenderNode","../core/FBOCacheFormats","./basicInterfaces","./DefaultVertexAttributeLocations","../../../support/Scheduler","../../../support/Yield","../../../webgl/enums","../../../webgl/renderState","../../../webgl/Sync","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x){"use strict";e.GPUPointOcclusionQuery=class extends p{constructor(e){super(e),this.category=h.RenderCategory.COMPOSITE,this.running=!1,this.done=!0,this._origin=d.create(),this._textureWidth=256,this._uploadBuffer=new Float32Array(3*this._textureWidth),this._counter=0,this._width=0,this._height=0,this._pipeline=v.makePipelineState({colorWrite:v.defaultColorWrite}),this._format=0}initialize(){this.view.resourceController.scheduler.registerTask(y.TaskPriority.GRAPHICS_CORE,this),this.produces="disabled",this.consumes.required=[this.category],this.formatOverride&&(this._format=this.formatOverride)}destroy(){this._program=r.disposeMaybe(this._program);const e=this.gl;this._sync=r.destroyMaybe(this._sync),this._pixelBuffer&&(e.deleteBuffer(this._pixelBuffer),this._pixelBuffer=null),this._texture=r.disposeMaybe(this._texture)}precompile(){this._ensureShader(this.renderingContext)}render(e){const t=e.find((({name:e})=>e===this.category));if(this._sync)return t;this.produces="disabled";const r=this.renderingContext,i=this.gl,s=t.getTexture(i.DEPTH_STENCIL_ATTACHMENT);if(!s)return t;const n=this.view.stage.renderer.fboCache.acquire(this._width,this._height,"hud visibility",m.ColorFormat.R32FLOAT);r.bindFramebuffer(n.fbo),r.setPipelineState(this._pipeline);const o=this._ensureShader(r);return r.useProgram(o),r.bindTexture(s,0),o.setUniform1i("depthTex",0),r.bindTexture(this._texture,1),o.setUniform1i("positionTex",1),l.multiply(M,this.camera.viewMatrix,l.fromTranslation(M,this._origin)),o.setUniformMatrix4fv("view",M),o.setUniformMatrix4fv("proj",this.camera.projectionMatrix),o.setUniform1i("count",this._counter),r.screen.draw(),this._pixelBuffer||(this._pixelBuffer=i.createBuffer()),0===this._format&&(this._format=i.getParameter(i.IMPLEMENTATION_COLOR_READ_FORMAT)===b.PixelFormat.RED&&i.getParameter(i.IMPLEMENTATION_COLOR_READ_TYPE)===b.DataType.FLOAT?b.PixelFormat.RED:b.PixelFormat.RGBA),i.bindBuffer(i.PIXEL_PACK_BUFFER,this._pixelBuffer),i.bufferData(i.PIXEL_PACK_BUFFER,this._width*this._height*(this._format===b.PixelFormat.RED?4:16),i.STREAM_READ),i.readPixels(0,0,this._width,this._height,this._format,b.DataType.FLOAT,0),this._sync=new S.Sync(i),n.release(),setTimeout((()=>this.running=!0),0),t}runTask(){if(!this._sync)return void(this.running=!1);try{if(!this._sync.poll())return _.Yield}catch(e){return this.running=!1,void(this._sync=r.destroyMaybe(this._sync))}this.running=!1,this._sync=r.destroyMaybe(this._sync);const e=this.gl;e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pixelBuffer),this._cpuBuffer=new Float32Array(this._width*this._height*(this._format===b.PixelFormat.RED?1:4)),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this._cpuBuffer),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),this.done=!0}init(e,t){const r=this._textureWidth;if(this._width=r,this._height=Math.ceil(e/r),this._counter=0,this._texture?.dispose(),0===this._height)return;const i=new x.TextureDescriptor(this._width,this._height);i.pixelFormat=b.PixelFormat.RGB,i.dataType=b.PixelType.FLOAT,i.samplingMode=b.TextureSamplingMode.NEAREST,this._texture=new w.Texture(this.renderingContext,i),this.done=!1,u.set(this._origin,Math.fround(t[0]),Math.fround(t[1]),Math.fround(t[2]))}addPosition(e){const t=this._width;if(this._counter>=t*this._height)return-1;const r=this._counter%t;return u.sub(P,e,this._origin),this._uploadBuffer[3*r+0]=P[0],this._uploadBuffer[3*r+1]=P[1],this._uploadBuffer[3*r+2]=P[2],r===t-1&&this._flush(),this._counter++}start(){if(0===this._width||0===this._height)return;const e=this._width;this._counter%e>0&&this._flush(),this.produces=this.category,this.requestRender(f.RenderRequestType.UPDATE)}getOcclusion(e){return this._cpuBuffer?.[this._format===b.PixelFormat.RED?e:4*e]??-1}_flush(){const e=this._width,t=Math.floor(this._counter/e);this._texture?.updateData(0,0,t,e,1,this._uploadBuffer)}_ensureShader(e){return null!=this._program||(this._program=e.programCache.acquire(T,C,g.Default3D)),this._program}},t.__decorate([i.property()],e.GPUPointOcclusionQuery.prototype,"category",void 0),t.__decorate([i.property()],e.GPUPointOcclusionQuery.prototype,"formatOverride",void 0),t.__decorate([i.property()],e.GPUPointOcclusionQuery.prototype,"running",void 0),t.__decorate([i.property()],e.GPUPointOcclusionQuery.prototype,"done",void 0),e.GPUPointOcclusionQuery=t.__decorate([a.subclass("esri.views.3d.webgl-engine.lib.GPUPointOcclusionQuery")],e.GPUPointOcclusionQuery);const T="#version 300 es\nprecision highp float;\nin vec2 position;\n\nvoid main() {\n    gl_Position = vec4(position, 0.0, 1.0);\n}",C="#version 300 es\nprecision highp float;\nout highp vec4 fragColor;\n\nuniform highp mat4 proj;\nuniform highp mat4 view;\n\nuniform highp int count;\n\nuniform highp sampler2D depthTex;\nuniform highp sampler2D positionTex;\n\nfloat linearizeDepth(float depth) {\n  float depthNdc = depth * 2.0 - 1.0;\n  float c1 = proj[3][2];\n  float c2 = proj[2][2];\n  return -c1 / (depthNdc + c2 + 1e-7);\n}\n\nvoid main() {\n  int u = int(floor(gl_FragCoord.x));\n  int v = int(floor(gl_FragCoord.y));\n  if (u + v * textureSize(positionTex, 0).x >= count) {\n    fragColor = vec4(-1);\n    return;\n  }\n  vec4 posWorld = vec4(texelFetch(positionTex, ivec2(u, v), 0).rgb, 1.0);\n\n  vec4 posView = view * posWorld;\n  vec4 projected = proj * posView;\n\n  vec3 clipPos = projected.xyz / projected.w;\n\n  if (clipPos.x < -1.0 || clipPos.x > 1.0 || clipPos.y < -1.0 || clipPos.y > 1.0) {\n    fragColor = vec4(-1);\n    return;\n  }\n\n  vec3 uvDepth = 0.5 * clipPos + vec3(0.5);\n\n  float depth = texture(depthTex, uvDepth.xy).r;\n\n  if (uvDepth.z <= depth) {\n    fragColor = vec4(0);\n    return;\n  }\n\n  fragColor = vec4(linearizeDepth(depth) - linearizeDepth(uvDepth.z));\n}\n",P=d.create(),M=c.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/FBOCacheFormats":function(){define(["exports","../../../webgl/enums","../../../webgl/TextureDescriptor","../../../webgl/textureUtils"],(function(e,t,r,i){"use strict";var s,n;e.ColorFormat=void 0,(s=e.ColorFormat||(e.ColorFormat={}))[s.R8UNORM=0]="R8UNORM",s[s.R8UINT=1]="R8UINT",s[s.RG8UNORM=2]="RG8UNORM",s[s.RG8UINT=3]="RG8UINT",s[s.RGBA4UNORM=4]="RGBA4UNORM",s[s.RGBA8UNORM=5]="RGBA8UNORM",s[s.RGBA8UNORM_MIPMAP=6]="RGBA8UNORM_MIPMAP",s[s.R16FLOAT=7]="R16FLOAT",s[s.RGBA16FLOAT=8]="RGBA16FLOAT",s[s.R32FLOAT=9]="R32FLOAT",s[s.COUNT=10]="COUNT",e.DepthFormat=void 0,(n=e.DepthFormat||(e.DepthFormat={}))[n.DEPTH16=10]="DEPTH16",n[n.DEPTH24_STENCIL8=11]="DEPTH24_STENCIL8";const o={[e.ColorFormat.R8UNORM]:"R8",[e.ColorFormat.R8UINT]:"R8UI",[e.ColorFormat.R16FLOAT]:"R16F",[e.ColorFormat.R32FLOAT]:"R32F",[e.ColorFormat.RG8UNORM]:"RG8",[e.ColorFormat.RG8UINT]:"RG8UI",[e.ColorFormat.RGBA8UNORM]:"RGBA8",[e.ColorFormat.RGBA4UNORM]:"RGBA4",[e.ColorFormat.RGBA8UNORM_MIPMAP]:"RGBA8_MM",[e.ColorFormat.RGBA16FLOAT]:"RGBA16F",[e.DepthFormat.DEPTH16]:"D16",[e.DepthFormat.DEPTH24_STENCIL8]:"D24S8"},a=new r.TextureDescriptor;a.pixelFormat=t.PixelFormat.RED,a.internalFormat=t.SizedPixelFormat.R8,a.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE;const l=new r.TextureDescriptor;l.pixelFormat=t.PixelFormat.RED_INTEGER,l.internalFormat=t.SizedPixelFormat.R8UI,l.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE,l.samplingMode=t.TextureSamplingMode.NEAREST;const c=new r.TextureDescriptor;c.pixelFormat=t.PixelFormat.RG,c.internalFormat=t.SizedPixelFormat.RG8,c.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE;const u=new r.TextureDescriptor;u.pixelFormat=t.PixelFormat.RG_INTEGER,u.internalFormat=t.SizedPixelFormat.RG8UI,u.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE,u.samplingMode=t.TextureSamplingMode.NEAREST;const d=new r.TextureDescriptor;d.internalFormat=t.SizedPixelFormat.RGBA4,d.dataType=t.PixelType.UNSIGNED_SHORT_4_4_4_4,d.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE;const h=new r.TextureDescriptor;h.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE;const p=new r.TextureDescriptor;p.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE,p.samplingMode=t.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,p.hasMipmap=!0,p.maxAnisotropy=8;const m=new r.TextureDescriptor;m.pixelFormat=t.PixelFormat.RED,m.dataType=t.PixelType.HALF_FLOAT,m.internalFormat=t.SizedPixelFormat.R16F,m.samplingMode=t.TextureSamplingMode.NEAREST;const f=new r.TextureDescriptor;f.dataType=t.PixelType.HALF_FLOAT,f.internalFormat=t.SizedPixelFormat.RGBA16F,f.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE;const g=new r.TextureDescriptor;g.pixelFormat=t.PixelFormat.RED,g.dataType=t.PixelType.FLOAT,g.internalFormat=t.SizedPixelFormat.R32F,g.samplingMode=t.TextureSamplingMode.NEAREST;const y={[e.ColorFormat.R8UNORM]:a,[e.ColorFormat.R8UINT]:l,[e.ColorFormat.RG8UNORM]:c,[e.ColorFormat.RG8UINT]:u,[e.ColorFormat.RGBA4UNORM]:d,[e.ColorFormat.RGBA8UNORM]:h,[e.ColorFormat.RGBA8UNORM_MIPMAP]:p,[e.ColorFormat.R16FLOAT]:m,[e.ColorFormat.RGBA16FLOAT]:f,[e.ColorFormat.R32FLOAT]:g,[e.ColorFormat.COUNT]:null},_={[t.SizedDepthFormat.DEPTH_COMPONENT16]:t.PixelType.UNSIGNED_SHORT,[t.SizedDepthFormat.DEPTH_COMPONENT24]:t.PixelType.UNSIGNED_INT,[t.SizedDepthFormat.DEPTH_COMPONENT32F]:t.PixelType.FLOAT,[t.SizedDepthStencilFormat.DEPTH24_STENCIL8]:t.PixelType.UNSIGNED_INT_24_8,[t.SizedDepthStencilFormat.DEPTH32F_STENCIL8]:t.PixelType.FLOAT_32_UNSIGNED_INT_24_8_REV},b={[e.DepthFormat.DEPTH24_STENCIL8]:v(t.SizedDepthStencilFormat.DEPTH24_STENCIL8),[e.DepthFormat.DEPTH16]:v(t.SizedDepthFormat.DEPTH_COMPONENT16)};function v(e){const s=new r.TextureDescriptor;return s.pixelFormat=i.isSizedDepthFormat(e)?t.UnsizedDepthFormat.DEPTH_COMPONENT:t.UnsizedDepthFormat.DEPTH_STENCIL,s.dataType=_[e],s.samplingMode=t.TextureSamplingMode.NEAREST,s.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE,s.internalFormat=e,s.hasMipmap=!1,s.isImmutable=!0,s}e.ColorFormats=y,e.DepthTextureFormats=b,e.format2String=o,e.isDepthFormat=function(t){return t>=e.ColorFormat.COUNT},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/Sync":function(){define(["exports"],(function(e){"use strict";e.Sync=class{constructor(e){this._gl=e,this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)}poll(){const e=this._gl,t=e.clientWaitSync(this._sync,e.SYNC_FLUSH_COMMANDS_BIT,0);if(t===e.WAIT_FAILED)throw new Error("clientWaitSync failed");return t!==e.TIMEOUT_EXPIRED}destroy(){this._gl.deleteSync(this._sync),this._sync=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/HUDMaterial":function(){define(["exports","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../core/libs/gl-matrix-2/types/mat4","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/buffer/BufferView","../../layers/support/FastSymbolUpdates","../../support/debugFlags","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/hud/HUD.glsl","../effects/geometry/olidUtils","../lib/GLTextureMaterial","../lib/Material","../lib/RenderSlot","../lib/screenSizePerspectiveUtils","../lib/Util","../lib/VertexAttribute","./ScaleInfo","./internal/bufferWriterUtils","./internal/MaterialUtil","../../../../chunks/HUDMaterial.glsl","../shaders/HUDMaterialTechnique","../shaders/HUDMaterialTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I){"use strict";class D extends S.Material{constructor(e,t){super(e,ie),this.produces=new Map([[w.RenderSlot.HUD_MATERIAL,e=>y.isColorEmissionHighlightOrOID(e)&&!this.parameters.drawAsLabel],[w.RenderSlot.LABEL_MATERIAL,e=>y.isColorEmissionHighlightOrOID(e)&&this.parameters.drawAsLabel],[w.RenderSlot.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[w.RenderSlot.DRAPED_MATERIAL,e=>this.parameters.draped&&y.isColorEmissionHighlightOrOID(e)]]),this._visible=!0,this._configuration=new A.HUDMaterialTechniqueConfiguration(t)}getConfiguration(e,t){const r=this.parameters.draped;return super.getConfiguration(e,t,this._configuration),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=r,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.hasRotation=this.parameters.hasRotation,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=t.slot===w.RenderSlot.OCCLUSION_PIXELS,this._configuration.occludedFragmentFade=!r&&this.parameters.occludedFragmentFade,this._configuration.horizonCullingEnabled=this.parameters.horizonCullingEnabled,this._configuration.isFocused=this.parameters.isFocused,this._configuration.depthTestEnabled=this.parameters.depthEnabled||t.slot===w.RenderSlot.OCCLUSION_PIXELS,y.isColorOrColorEmission(e)&&(this._configuration.debugDrawLabelBorder=!!f.debugFlags.LABELS_SHOW_BORDER),this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}intersect(e,t,i,n,o,a){const{options:{selectionMode:d,hud:h,excludeLabels:p},point:m,camera:f}=i,{parameters:g}=this;if(!d||!h||p&&g.isLabel||!e.visible||!m||!f)return;const y=e.attributes.get(C.VertexAttribute.FEATUREATTRIBUTE),_=null==y?null:u.fromArray(y.data,X),{scaleX:b,scaleY:v}=ae(_,g,f.pixelRatio);r.fromMat4(H,t),e.attributes.has(C.VertexAttribute.FEATUREATTRIBUTE)&&function(e){const t=e[0],r=e[1],i=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],u=1/Math.sqrt(t*t+r*r+i*i),d=1/Math.sqrt(s*s+n*n+o*o),h=1/Math.sqrt(a*a+l*l+c*c);e[0]=t*u,e[1]=r*u,e[2]=i*u,e[3]=s*d,e[4]=n*d,e[5]=o*d,e[6]=a*h,e[7]=l*h,e[8]=c*h}(H);const S=e.attributes.get(C.VertexAttribute.POSITION),w=e.attributes.get(C.VertexAttribute.SIZE),P=e.attributes.get(C.VertexAttribute.NORMAL),M=e.attributes.get(C.VertexAttribute.ROTATION),R=e.attributes.get(C.VertexAttribute.CENTEROFFSETANDDISTANCE);T.assert(S.size>=3);const O=E.calculateAnchorPosition(g),A="screen"===this.parameters.centerOffsetUnits;for(let e=0;e<S.data.length/S.size;e++){const r=e*S.size;l.set(V,S.data[r],S.data[r+1],S.data[r+2]),l.transformMat4(V,V,t),l.transformMat4(V,V,f.viewMatrix);const n=e*R.size;if(l.set(Z,R.data[n],R.data[n+1],R.data[n+2]),!A&&(V[0]+=Z[0],V[1]+=Z[1],0!==Z[2])){const e=Z[2];l.normalize(Z,V),l.subtract(V,V,l.scale(Z,Z,e))}const o=e*P.size;if(l.set(B,P.data[o],P.data[o+1],P.data[o+2]),L(B,H,f,K),le(this.parameters,V,K,f,U),f.applyProjection(V,G),G[0]>-1){A&&(Z[0]||Z[1])&&(G[0]+=Z[0]*f.pixelRatio,0!==Z[1]&&(G[1]+=x.applyScaleFactor(Z[1],U.factorAlignment)*f.pixelRatio),f.unapplyProjection(G,V)),G[0]+=this.parameters.screenOffset[0]*f.pixelRatio,G[1]+=this.parameters.screenOffset[1]*f.pixelRatio,G[0]=Math.floor(G[0]),G[1]=Math.floor(G[1]);const t=e*w.size;te[0]=w.data[t],te[1]=w.data[t+1],x.applyPrecomputedScaleFactor(te,U.factor,te);const r=J*f.pixelRatio;let n=0;g.textureIsSignedDistanceField&&(n=Math.min(g.outlineSize,.5*te[0])*f.pixelRatio/2),te[0]*=b,te[1]*=v;const o=e*M.size,u=g.rotation+M.data[o];if(N(m,G[0],G[1],te,r,n,u,g,O)){const e=i.ray;if(l.transformMat4(z,V,s.invert($,f.viewMatrix)),G[0]=m[0],G[1]=m[1],f.unprojectFromRenderScreen(G,V)){const t=c.create();l.copy(t,e.direction);const r=1/l.length(t);l.scale(t,t,r),a(l.distance(e.origin,V)*r,t,-1,z)}}}}}intersectDraped(e,t,r,i,s){const n=e.attributes.get(C.VertexAttribute.POSITION),o=e.attributes.get(C.VertexAttribute.SIZE),a=e.attributes.get(C.VertexAttribute.ROTATION),l=this.parameters,c=E.calculateAnchorPosition(l),d=e.attributes.get(C.VertexAttribute.FEATUREATTRIBUTE),h=null==d?null:u.fromArray(d.data,X),{scaleX:p,scaleY:m}=ae(h,l,e.screenToWorldRatio),f=ee*e.screenToWorldRatio;for(let t=0;t<n.data.length/n.size;t++){const u=t*n.size,d=n.data[u],h=n.data[u+1],g=t*o.size;te[0]=o.data[g],te[1]=o.data[g+1];let y=0;l.textureIsSignedDistanceField&&(y=Math.min(l.outlineSize,.5*te[0])*e.screenToWorldRatio/2),te[0]*=p,te[1]*=m;const _=t*a.size,b=l.rotation+a.data[_];N(r,d,h,te,f,y,b,l,c)&&i(s.distance,s.normal,-1)}}createBufferWriter(){return new oe}applyShaderOffsetsView(e,t,r,i,s,n,o){const a=L(t,r,s,K);return this._applyVerticalGroundOffsetView(e,a,s,o),le(this.parameters,o,a,s,n),this._applyPolygonOffsetView(o,a,i[3],s,o),this._applyCenterOffsetView(o,i,o),o}applyShaderOffsetsNDC(e,t,r,i,s){return this._applyCenterOffsetNDC(e,t,r,i),null!=s&&l.copy(s,i),this._applyPolygonOffsetNDC(i,t,r,i),i}_applyPolygonOffsetView(e,r,i,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(i);0===a&&(a=o);const c=o*a;if(this.parameters.shaderPolygonOffset<=0)return l.copy(n,e);const u=t.clamp(Math.abs(r.cosAngle),.01,1),d=1-Math.sqrt(1-u*u)/u/s.viewport[2];return c>0?l.scale(n,e,d):l.scale(n,e,1/d),n}_applyVerticalGroundOffsetView(e,t,r,i){const s=l.length(e),n=r.aboveGround?1:-1,o=r.computeRenderPixelSizeAtDist(s)*_.HUDVerticalPixelOffset,a=l.scale(V,t.normal,n*o);return l.add(i,e,a),i}_applyCenterOffsetView(e,t,r){const i="screen"!==this.parameters.centerOffsetUnits;return r!==e&&l.copy(r,e),i&&(r[0]+=t[0],r[1]+=t[1],t[2]&&(l.normalize(B,r),l.sub(r,r,l.scale(B,B,t[2])))),r}_applyCenterOffsetNDC(e,t,r,i){const s="screen"!==this.parameters.centerOffsetUnits;return i!==e&&l.copy(i,e),s||(i[0]+=t[0]/r.fullWidth*2,i[1]+=t[1]/r.fullHeight*2),i}_applyPolygonOffsetNDC(e,t,r,i){const s=this.parameters.shaderPolygonOffset;if(e!==i&&l.copy(i,e),s){const e=r.aboveGround?1:-1,n=e*Math.sign(t[3]);i[2]-=(n||e)*s}return i}set visible(e){this._visible=e}get visible(){const{color:e,outlineSize:t,outlineColor:r}=this.parameters,i=e[3]>=I.alphaCutoff||t>=I.alphaCutoff&&r[3]>=I.alphaCutoff;return this._visible&&i}createGLMaterial(e){return new F(e)}calculateRelativeScreenBounds(e,t,r=h.create()){return function(e,t,r,i){i[0]=e.anchorPosition[0]*-t[0]+e.screenOffset[0]*r,i[1]=e.anchorPosition[1]*-t[1]+e.screenOffset[1]*r}(this.parameters,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}}class F extends v.GLTextureMaterial{constructor(e){super({...e,...e.material.parameters})}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.getTechnique(O.HUDMaterialTechnique,e)}}function L(e,t,i,s){return d.isMat4(t)&&(t=r.fromMat4(W,t)),l.transformMat3(s.normal,e,t),l.transformMat4(s.normal,s.normal,i.viewInverseTransposeMatrix),s.cosAngle=l.dot(k,re),s}function N(e,r,i,s,n,a,l,c,u){let d=r-n-s[0]*u[0],h=d+s[0]+2*n,p=i-n-s[1]*u[1],m=p+s[1]+2*n;const f=c.distanceFieldBoundingBox;return c.textureIsSignedDistanceField&&null!=f&&(d+=s[0]*f[0],p+=s[1]*f[1],h-=s[0]*(1-f[2]),m-=s[1]*(1-f[3]),d-=a,h+=a,p-=a,m+=a),o.set(q,r,i),o.rotate(j,e,q,t.deg2rad(l)),j[0]>d&&j[0]<h&&j[1]>p&&j[1]<m}const U=new P.ScaleInfo,V=c.create(),B=c.create(),G=u.create(),k=c.create(),z=c.create(),j=a.create(),q=a.create(),H=i.create(),W=i.create(),$=n.create(),Q=u.create(),Z=c.create(),Y=c.create(),X=u.create(),K={normal:k,cosAngle:0},J=1,ee=2,te=a.fromValues(0,0),re=c.fromValues(0,0,1);class ie extends v.GLTextureMaterialBindParameters{constructor(){super(...arguments),this.renderOccluded=S.RenderOccludedFlag.Occlude,this.isDecoration=!1,this.color=u.freeze(1,1,1,1),this.polygonOffset=!1,this.anchorPosition=a.fromValues(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=u.freeze(1,1,1,1),this.outlineSize=0,this.distanceFieldBoundingBox=u.create(),this.rotation=0,this.hasRotation=!1,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!1,this.centerOffsetUnits="world",this.drawAsLabel=!1,this.depthEnabled=!0,this.isFocused=!0,this.focusStyle="bright",this.draped=!1,this.isLabel=!1}}const se=g.newLayout().vec3f(C.VertexAttribute.POSITION).vec3f(C.VertexAttribute.NORMAL).vec2i16(C.VertexAttribute.UVI).vec4u8(C.VertexAttribute.COLOR).vec2f(C.VertexAttribute.SIZE).f32(C.VertexAttribute.ROTATION).vec4f(C.VertexAttribute.CENTEROFFSETANDDISTANCE).vec4f(C.VertexAttribute.FEATUREATTRIBUTE),ne=se.clone().vec4u8(C.VertexAttribute.OLIDCOLOR);class oe{constructor(){this.vertexBufferLayout=b.olidEnabled()?ne:se}elementCount(e){return 6*e.get(C.VertexAttribute.POSITION).indices.length}write(e,t,r,i,s,n){const{position:o,normal:a,uvi:l,color:c,size:u,rotation:d,centerOffsetAndDistance:h,featureAttribute:m}=s;M.writePosition(r.get(C.VertexAttribute.POSITION),e,o,n,6),M.writeNormal(r.get(C.VertexAttribute.NORMAL),t,a,n,6);const f=r.get(C.VertexAttribute.UVI)?.data;let g=0,y=0,_=-1-E.fullUV,b=-1-E.fullUV;f&&f.length>=4&&(g=f[0],y=f[1],_=-1-f[2],b=-1-f[3]);let v=r.get(C.VertexAttribute.POSITION).indices.length,S=n;for(let e=0;e<v;++e)l.set(S,0,g),l.set(S,1,y),S++,l.set(S,0,_),l.set(S,1,y),S++,l.set(S,0,_),l.set(S,1,b),S++,l.set(S,0,_),l.set(S,1,b),S++,l.set(S,0,g),l.set(S,1,b),S++,l.set(S,0,g),l.set(S,1,y),S++;M.writeColor(r.get(C.VertexAttribute.COLOR),4,c,n,6);const{data:w,indices:x}=r.get(C.VertexAttribute.SIZE);v=x.length,S=n;for(let e=0;e<v;++e){const t=w[2*x[e]],r=w[2*x[e]+1];for(let e=0;e<6;++e)u.set(S,0,t),u.set(S,1,r),S++}if(M.writeBufferFloat(r.get(C.VertexAttribute.ROTATION),d,n,6),r.get(C.VertexAttribute.CENTEROFFSETANDDISTANCE)?M.writeBufferVec4(r.get(C.VertexAttribute.CENTEROFFSETANDDISTANCE),h,n,6):M.writeBufferVec4Zeros(h,n,6*v),r.get(C.VertexAttribute.FEATUREATTRIBUTE)?M.writeBufferVec4(r.get(C.VertexAttribute.FEATUREATTRIBUTE),m,n,6):M.writeBufferVec4Zeros(m,n,6*v),null!=i){const e=r.get(C.VertexAttribute.POSITION)?.indices;if(e){const t=e.length,r=s.getField(C.VertexAttribute.OLIDCOLOR,p.BufferViewVec4u8);M.writeOlidColor(i,r,t,n,6)}}return{numVerticesPerItem:6,numItems:v}}intersect(e,t,r,i,n,o,a){const{options:{selectionMode:u,hud:d,excludeLabels:h},point:m,camera:f}=i;if(!u||!d||h&&t.isLabel||!m)return;const g=this.vertexBufferLayout.createView(e),y=g.getField(C.VertexAttribute.POSITION,p.BufferViewVec3f),_=g.getField(C.VertexAttribute.NORMAL,p.BufferViewVec3f),b=g.getField(C.VertexAttribute.ROTATION,p.BufferViewFloat),v=g.getField(C.VertexAttribute.SIZE,p.BufferViewVec2f),S=g.getField(C.VertexAttribute.FEATUREATTRIBUTE,p.BufferViewVec4f),w=g.getField(C.VertexAttribute.CENTEROFFSETANDDISTANCE,p.BufferViewVec4f),T="screen"===t.centerOffsetUnits,P=E.calculateAnchorPosition(t);if(null==y||null==_||null==b||null==v||null==w||null==f)return;const M=null==S?null:S.getVec(0,X),{scaleX:R,scaleY:O}=ae(M,t,f.pixelRatio),A=y.count/6;for(let e=0;e<A;e++){const n=6*e;if(y.getVec(n,V),null!=r&&l.add(V,V,r),l.transformMat4(V,V,f.viewMatrix),w.getVec(n,Q),l.set(Z,Q[0],Q[1],Q[2]),!T&&(V[0]+=Z[0],V[1]+=Z[1],0!==Z[2])){const e=Z[2];l.normalize(Z,V),l.subtract(V,V,l.scale(Z,Z,e))}if(_.getVec(n,B),L(B,H,f,K),le(t,V,K,f,U),f.applyProjection(V,G),G[0]>-1){T&&(Z[0]||Z[1])&&(G[0]+=Z[0]*f.pixelRatio,0!==Z[1]&&(G[1]+=x.applyScaleFactor(Z[1],U.factorAlignment)*f.pixelRatio),f.unapplyProjection(G,V)),G[0]+=t.screenOffset[0]*f.pixelRatio,G[1]+=t.screenOffset[1]*f.pixelRatio,G[0]=Math.floor(G[0]),G[1]=Math.floor(G[1]),v.getVec(n,te),x.applyPrecomputedScaleFactor(te,U.factor,te);const r=J*f.pixelRatio;let o=0;t.textureIsSignedDistanceField&&(o=Math.min(t.outlineSize,.5*te[0])*f.pixelRatio/2),te[0]*=R,te[1]*=O;const u=b.get(n),d=t.rotation+u;if(N(m,G[0],G[1],te,r,o,d,t,P)){const t=i.ray;if(l.transformMat4(z,V,s.invert($,f.viewMatrix)),G[0]=m[0],G[1]=m[1],f.unprojectFromRenderScreen(G,V)){const r=c.create();l.copy(r,t.direction);const i=1/l.length(r);l.scale(r,r,i),a(l.distance(t.origin,V)*i,r,e,z)}}}}}}function ae(e,t,r){return null==e||null==t.vvSize?{scaleX:r,scaleY:r}:(m.evaluateModelTransformScale(Y,t,e),{scaleX:Y[0]*r,scaleY:Y[1]*r})}function le(e,t,r,i,s){if(!e.verticalOffset?.screenLength)return e.screenSizePerspective||e.screenSizePerspectiveAlignment?ce(e,s,l.length(t),r.cosAngle):(s.factor.scale=1,s.factorAlignment.scale=1),t;const n=l.length(t),o=e.screenSizePerspectiveAlignment??e.screenSizePerspective,a=R.verticalOffsetAtDistance(i,n,e.verticalOffset,r.cosAngle,o);return ce(e,s,n,r.cosAngle),l.scale(r.normal,r.normal,a),l.add(t,t,r.normal)}function ce(e,t,r,i){null!=e.screenSizePerspective?x.precomputeScaleFactor(i,r,e.screenSizePerspective,t.factor):(t.factor.scale=1,t.factor.factor=0,t.factor.minScaleFactor=0),null!=e.screenSizePerspectiveAlignment?x.precomputeScaleFactor(i,r,e.screenSizePerspectiveAlignment,t.factorAlignment):(t.factorAlignment.factor=t.factor.factor,t.factorAlignment.scale=t.factor.scale,t.factorAlignment.minScaleFactor=t.factor.minScaleFactor)}e.HUDMaterial=D,e.Parameters=ie,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/libs/gl-matrix-2/types/mat4":function(){define(["exports"],(function(e){"use strict";function t(e){return e instanceof Float32Array&&e.length>=16}function r(e){return Array.isArray(e)&&e.length>=16}e.isMat4=function(e){return t(e)||r(e)},e.isMat4f32=t,e.isMat4f64=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FastSymbolUpdates":function(){define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../renderers/support/lengthUtils","../../../../support/guards","../../support/debugFlags","../../webgl-engine/effects/geometry/olidUtils","../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";var g,y;e.FastSizeType=void 0,(g=e.FastSizeType||(e.FastSizeType={}))[g.Undefined=0]="Undefined",g[g.DefinedSize=1]="DefinedSize",g[g.DefinedScale=2]="DefinedScale",e.FastRotationType=void 0,(y=e.FastRotationType||(e.FastRotationType={}))[y.Undefined=0]="Undefined",y[y.DefinedAngle=1]="DefinedAngle";class _{constructor(e){this.field=e}}class b extends _{constructor(t){super(t),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[e.FastSizeType.Undefined,e.FastSizeType.Undefined,e.FastSizeType.Undefined],this.fallback=[0,0,0]}}class v extends _{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0],this.fallback=[0,0,0,0]}}class S extends _{constructor(e,t=0){super(e),this.fallback=t,this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}}class w{}function x(e){return null!=e}function T(e,t){e&&e.push(t)}function C(t,r,i,s,n){const o=t.minSize,a=t.maxSize;if(t.useSymbolValue){const t=s.symbolSize[i];return r.minSize[i]=t,r.maxSize[i]=t,r.offset[i]=r.minSize[i],r.factor[i]=0,r.type[i]=e.FastSizeType.DefinedSize,!0}if(x(t.field))return x(t.stops)?2===t.stops.length&&h.isNumber(t.stops[0].size)&&h.isNumber(t.stops[1].size)?(P(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,r,i),r.type[i]=e.FastSizeType.DefinedSize,!0):(T(n,"Could not convert size info: stops only supported with 2 elements"),!1):h.isNumber(o)&&h.isNumber(a)&&x(t.minDataValue)&&x(t.maxDataValue)?(P(o,a,t.minDataValue,t.maxDataValue,r,i),r.type[i]=e.FastSizeType.DefinedSize,!0):"unknown"===t.valueUnit?(T(n,"Could not convert size info: proportional size not supported"),!1):null!=d.meterIn[t.valueUnit]?(r.minSize[i]=-1/0,r.maxSize[i]=1/0,r.offset[i]=0,r.factor[i]=1/d.meterIn[t.valueUnit],r.type[i]=e.FastSizeType.DefinedSize,!0):(T(n,"Could not convert size info: scale-dependent size not supported"),!1);if(!x(t.field)){if(t.stops?.[0]&&h.isNumber(t.stops[0].size))return r.minSize[i]=t.stops[0].size,r.maxSize[i]=t.stops[0].size,r.offset[i]=r.minSize[i],r.factor[i]=0,r.type[i]=e.FastSizeType.DefinedSize,!0;if(h.isNumber(o))return r.minSize[i]=o,r.maxSize[i]=o,r.offset[i]=o,r.factor[i]=0,r.type[i]=e.FastSizeType.DefinedSize,!0}return T(n,"Could not convert size info: unsupported variant of sizeInfo"),!1}function P(e,t,r,i,s,n){const o=Math.abs(i-r)>0?(t-e)/(i-r):0;s.minSize[n]=o>0?e:t,s.maxSize[n]=o>0?t:e,s.offset[n]=e-r*o,s.factor[n]=o}function M(e,t,r){e[4*t]=r.r/255,e[4*t+1]=r.g/255,e[4*t+2]=r.b/255,e[4*t+3]=r.a}function R(e,t,r){const i=2===r&&"arithmetic"===e.rotationType;t.offset[r]=i?90:0,t.factor[r]=i?-1:1,t.type[r]=1}function E(t,r,i){if(!t)return null;const s=t.reduce(((e,t)=>{if(!e)return e;if(t.valueExpression)return T(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(t.type){case"size":return r.supports.size?function(e,t,r,i){if(e.normalizationField||e.valueRepresentation)return T(i,"Could not convert size info: unsupported property"),null;if(!h.isStringOrNull(e.field))return T(i,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return T(i,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size=new b(e.field),a.copy(t.size.fallback,r.fallbackSize);let s;switch(e.axis){case"width":return s=C(e,t.size,0,r,i),s?t:null;case"height":return s=C(e,t.size,2,r,i),s?t:null;case"depth":return s=C(e,t.size,1,r,i),s?t:null;case"width-and-depth":return s=C(e,t.size,0,r,i),s&&C(e,t.size,1,r,i),s?t:null;case null:case void 0:case"all":return s=C(e,t.size,0,r,i),s=s&&C(e,t.size,1,r,i),s=s&&C(e,t.size,2,r,i),s?t:null;default:return T(i,`Could not convert size info: unknown axis "${e.axis}""`),null}}(t,e,r,i):e;case"color":return r.supports.color?function(e,t,r,i){if(e.normalizationField)return T(i,"Could not convert color info: unsupported property"),null;if(h.isString(e.field)){if(!e.stops)return T(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return T(i,"Could not convert color info: too many color stops"),null;t.color=new v(e.field);const s=e.stops;for(let e=0;e<8;++e){const r=s[Math.min(e,s.length-1)];t.color.values[e]=r.value,M(t.color.colors,e,r.color)}c.copy(t.color.fallback,r.fallbackColor)}}else{if(!(e.stops&&e.stops.length>=0))return T(i,"Could not convert color info: no field and no colors/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color=new v(null);for(let e=0;e<8;e++)t.color.values[e]=1/0,M(t.color.colors,e,i);c.copy(t.color.fallback,r.fallbackColor)}}return t}(t,e,r,i):e;case"opacity":return r.supports.opacity?function(e,t,r,i){if(e.normalizationField)return T(i,"Could not convert opacity info: unsupported property"),null;if(h.isString(e.field)){if(!e.stops)return T(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return T(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity=new S(e.field,r.fallbackColor[3]);const s=e.stops;for(let e=0;e<8;++e){const r=s[Math.min(e,s.length-1)];t.opacity.values[e]=r.value,t.opacity.opacityValues[e]=r.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return T(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0],fallback:r.fallbackColor[3]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=i}}return t}(t,e,r,i):null;case"rotation":return r.supports.rotation?function(e,t,r){if(!h.isString(e.field))return T(r,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return T(r,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return R(e,t.rotation,0),t;case"roll":return R(e,t.rotation,1),t;case null:case void 0:case"heading":return R(e,t.rotation,2),t;default:return T(r,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}(t,e,i):e;default:return null}}),new w);return!(t.length>0&&s)||s.size||s.color||s.opacity||s.rotation?s?.size&&!function(t,r,i){for(let i=0;i<3;++i){let s=r.unitInMeters;t.type[i]===e.FastSizeType.DefinedSize&&(s*=r.modelSize[i],t.type[i]=e.FastSizeType.DefinedScale),t.minSize[i]=t.minSize[i]/s,t.maxSize[i]=t.maxSize[i]/s,t.offset[i]=t.offset[i]/s,t.factor[i]=t.factor[i]/s}let s;if(t.type[0]!==e.FastSizeType.Undefined)s=0;else if(t.type[1]!==e.FastSizeType.Undefined)s=1;else{if(t.type[2]===e.FastSizeType.Undefined)return T(i,"No size axis contains a valid size or scale"),!1;s=2}for(let r=0;r<3;++r)t.type[r]===e.FastSizeType.Undefined&&(t.minSize[r]=t.minSize[s],t.maxSize[r]=t.maxSize[s],t.offset[r]=t.offset[s],t.factor[r]=t.factor[s],t.type[r]=t.type[s]);return!0}(s.size,r,i)?null:s:null}class O{constructor(e,t,r){this.visualVariables=e,this.materialParameters=t,this.requiresShaderTransformation=r}}function A(e,t,r){if(!!e!=!!t)return!1;if(e&&e.field!==t?.field)return!1;if(e&&"rotation"===r){const r=e,i=t;for(let e=0;e<3;e++)if(r.type[e]!==i.type[e]||r.offset[e]!==i.offset[e]||r.factor[e]!==i.factor[e])return!1}return!0}class I extends f.NoParameters{constructor(e){super(),this.vvSize=e?.size??null,this.vvColor=e?.color??null,this.vvOpacity=e?.opacity??null}}function D(e,t){const r=new I(e);return r.vvSize&&(r.vvSymbolAnchor=t.anchor,n.identity(U),function(e,t,r,i=o.create()){const s=e||0,a=t||0,l=r||0;0!==s&&n.rotateZ(i,i,-s/180*Math.PI),0!==a&&n.rotateX(i,i,a/180*Math.PI),0!==l&&n.rotateY(i,i,l/180*Math.PI)}(t.rotation[2],t.rotation[0],t.rotation[1],U),r.vvSymbolRotationMatrix=r.vvSymbolRotationMatrix||s.create(),i.fromMat4(r.vvSymbolRotationMatrix,U)),r}function F(e,t,i){if(!t.vvSize)return a.set(e,1,1,1),e;if(Number.isNaN(i[0]))return a.copy(e,t.vvSize.fallback);for(let s=0;s<3;++s){const n=t.vvSize.offset[s]+i[0]*t.vvSize.factor[s];e[s]=r.clamp(n,t.vvSize.minSize[s],t.vvSize.maxSize[s])}return e}const L=o.create(),N=l.create(),U=o.create();e.ConvertOptions=class{constructor({supports:e,modelSize:t,symbolSize:r,unitInMeters:i,anchor:s,scale:n,rotation:o,fallbackColor:a,fallbackSize:c}){this.supports=e,this.modelSize=t??l.ones(),this.symbolSize=r??l.ones(),this.unitInMeters=i??1,this.anchor=s??l.zeros(),this.scale=n??l.ones(),this.rotation=o??l.zeros(),this.fallbackColor=a??u.ones(),this.fallbackSize=c??l.ones()}},e.FastColorInfo=v,e.FastOpacityInfo=S,e.FastRotationInfo=class extends _{constructor(e){super(e),this.offset=[0,0,0],this.factor=[1,1,1],this.type=[0,0,0]}},e.FastSizeInfo=b,e.FastSymbolUpdatesState=O,e.FastVisualVariables=w,e.VisualVariablesParameters=I,e.convertVisualVariables=E,e.evaluateModelTransform=function(e,t,r){if(!e.vvSize)return r;n.copy(L,r);const i=e.vvSymbolRotationMatrix;return n.set(U,i[0],i[1],i[2],0,i[3],i[4],i[5],0,i[6],i[7],i[8],0,0,0,0,1),n.multiply(L,L,U),F(N,e,t),n.scale(L,L,N),n.translate(L,L,e.vvSymbolAnchor),L},e.evaluateModelTransformScale=F,e.getAttributeValue=function(e,t){const r=null==e?0:t.attributes[e];return"number"==typeof r&&isFinite(r)?r:NaN},e.getMaterialParameters=D,e.initFastSymbolUpdatesState=function(e,t){if(!e)return null;if(m.olidEnabled())return null;if(p.debugFlags.TESTS_DISABLE_FAST_UPDATES)return null;const r=E(e.visualVariables,t);return r?new O(r,D(r,t),!!r.size):null},e.updateFastSymbolUpdatesState=function(e,t,r){if(!t||!e)return!1;const i=e.visualVariables,s=E(t.visualVariables,r);return!!s&&!!(A(i.size,s.size,"size")&&A(i.color,s.color,"color")&&A(i.rotation,s.rotation,"rotation")&&A(i.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=D(s,r),e.requiresShaderTransformation=!!s.size,!0)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/geometry/olidUtils":function(){define(["exports","../../../../../core/has"],(function(e,t){"use strict";e.olidEnabled=function(){return!!t("enable-feature:objectAndLayerId-rendering")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/hud/HUD.glsl":function(){define(["exports","../attributes/VerticalOffset.glsl","../util/ScreenSizePerspective.glsl","../util/View.glsl","../../shaderModules/Float4BindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../../lib/VertexAttribute"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.HUD=function(e,c){e.include(r.ScreenSizePerspective),e.attributes.add(l.VertexAttribute.POSITION,"vec3"),e.attributes.add(l.VertexAttribute.NORMAL,"vec3"),e.attributes.add(l.VertexAttribute.CENTEROFFSETANDDISTANCE,"vec4");const u=e.vertex;i.addProjViewLocalOrigin(u,c),i.addCameraPosition(u,c),u.uniforms.add(new s.Float4BindUniform("viewport",(e=>e.camera.fullViewport)),new o.FloatPassUniform("polygonOffset",(e=>e.shaderPolygonOffset)),new n.FloatBindUniform("cameraGroundRelative",(e=>e.camera.aboveGround?1:-1))),c.hasVerticalOffset&&t.addVerticalOffset(u),u.code.add(a.glsl`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),u.code.add(a.glsl`
    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
      float pointGroundSign = ${c.terrainDepthTest?a.glsl.float(0):a.glsl`sign(pointGroundDistance)`};
      if (pointGroundSign == 0.0) {
        pointGroundSign = cameraGroundRelative;
      }

      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground
      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise
      float groundRelative = cameraGroundRelative * pointGroundSign;

      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is
      // dropped is instead introduced using the ground-relative position of the symbol and the camera
      if (polygonOffset > .0) {
        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
        float factor = (1.0 - tanAlpha / viewport[2]);

        // same side of the terrain
        if (groundRelative > 0.0) {
          posView *= factor;
        }
        // opposite sides of the terrain
        else {
          posView /= factor;
        }
      }

      return groundRelative;
    }
  `),c.draped&&!c.hasVerticalOffset||i.addViewNormal(u),c.draped||(u.uniforms.add(new n.FloatBindUniform("perDistancePixelRatio",(e=>Math.tan(e.camera.fovY/2)/(e.camera.fullViewport[2]/2)))),u.code.add(a.glsl`
    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
      float distanceToCamera = length(posView);

      // Compute offset in world units for a half pixel shift
      float pixelOffset = distanceToCamera * perDistancePixelRatio * ${a.glsl.float(.5)};

      // Apply offset along normal in the direction away from the ground surface
      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;

      // Apply the same offset also on the view space position
      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;

      posModel += modelOffset;
      posView += viewOffset;
    }
  `)),c.screenCenterOffsetUnitsEnabled&&i.addPixelRatio(u),c.hasScreenSizePerspective&&r.addScreenSizePerspectiveAlignment(u),u.code.add(a.glsl`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      vec3 centerOffset = centerOffsetAndDistance.xyz;
      float pointGroundDistance = centerOffsetAndDistance.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${c.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${c.hasScreenSizePerspective&&(c.hasVerticalOffset||c.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${c.hasVerticalOffset?c.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${c.hasVerticalOffset?a.glsl`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${c.screenCenterOffsetUnitsEnabled?"":a.glsl`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${c.screenCenterOffsetUnitsEnabled?c.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${c.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `)},e.HUDVerticalPixelOffset=.5,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VerticalOffset.glsl":function(){define(["exports","../../../../../../chunks/vec42","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../util/ScreenSizePerspective.glsl","../util/View.glsl","../../shaderModules/Float4PassUniform","../../shaderModules/glsl"],(function(e,t,r,i,s,n,o){"use strict";const a=r.create();function l(e){e.uniforms.add(new n.Float4PassUniform("verticalOffset",((e,r)=>{const{minWorldLength:i,maxWorldLength:s,screenLength:n}=e.verticalOffset,o=Math.tan(.5*r.camera.fovY)/(.5*r.camera.fullViewport[3]),l=r.camera.pixelRatio||1;return t.set(a,n*l,o,i,s)})))}e.VerticalOffset=function(e,t){const r=e.vertex;t.hasVerticalOffset?(l(r),t.hasScreenSizePerspective&&(e.include(i.ScreenSizePerspective),i.addScreenSizePerspectiveAlignment(r),s.addCameraPosition(e.vertex,t)),r.code.add(o.glsl`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${t.spherical?o.glsl`vec3 worldNormal = normalize(worldPos + localOrigin);`:o.glsl`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${t.hasScreenSizePerspective?o.glsl`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:o.glsl`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):r.code.add(o.glsl`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)},e.addVerticalOffset=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/ScreenSizePerspective.glsl":function(){define(["exports","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../shaderModules/Float3PassUniform","../../shaderModules/glsl"],(function(e,t,r,i,s){"use strict";function n(e){return t.set(o,e.parameters.divisor,e.parameters.offset,e.minScaleFactor)}const o=r.create();e.ScreenSizePerspective=function(e){e.vertex.code.add(s.glsl`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),e.vertex.code.add(s.glsl`vec3 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec3 params) {
return vec3(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z
);
}`),e.vertex.code.add(s.glsl`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec3 factor) {
return mix(size * clamp(factor.x, factor.z, 1.0), size, factor.y);
}`),e.vertex.code.add(s.glsl`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),e.vertex.code.add(s.glsl`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec3 factor) {
return mix(size * clamp(factor.x, factor.z, 1.0), size, factor.y);
}`),e.vertex.code.add(s.glsl`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)},e.addScreenSizePerspective=function(e){e.uniforms.add(new i.Float3PassUniform("screenSizePerspective",(e=>n(e.screenSizePerspective))))},e.addScreenSizePerspectiveAlignment=function(e){e.uniforms.add(new i.Float3PassUniform("screenSizePerspectiveAlignment",(e=>n(e.screenSizePerspectiveAlignment||e.screenSizePerspective))))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/View.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../shaderModules/Float3BindUniform","../../shaderModules/Float3DrawUniform","../../shaderModules/FloatBindUniform","../../shaderModules/Matrix4BindUniform","../../shaderModules/Matrix4DrawUniform"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=r.create(),d=s.create();e.addCameraPosition=function(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",s.ZEROS):e.uniforms.add(new o.Float3DrawUniform("cameraPosition",((e,t)=>i.set(d,t.camera.viewInverseTransposeMatrix[3]-e.origin[0],t.camera.viewInverseTransposeMatrix[7]-e.origin[1],t.camera.viewInverseTransposeMatrix[11]-e.origin[2]))))},e.addPixelRatio=function(e){e.uniforms.add(new a.FloatBindUniform("pixelRatio",(e=>e.camera.pixelRatio/e.overlayStretch)))},e.addProjViewLocalOrigin=function(e,r){if(!r.instancedDoublePrecision)return void e.uniforms.add(new l.Matrix4BindUniform("proj",(e=>e.camera.projectionMatrix)),new c.Matrix4DrawUniform("view",((e,r)=>t.translate(u,r.camera.viewMatrix,e.origin))),new o.Float3DrawUniform("localOrigin",(e=>e.origin)));const s=({camera:e})=>i.set(d,e.viewInverseTransposeMatrix[3],e.viewInverseTransposeMatrix[7],e.viewInverseTransposeMatrix[11]);e.uniforms.add(new l.Matrix4BindUniform("proj",(e=>e.camera.projectionMatrix)),new l.Matrix4BindUniform("view",(e=>t.translate(u,e.camera.viewMatrix,s(e)))),new n.Float3BindUniform("localOrigin",(e=>s(e))))},e.addViewNormal=function(e){e.uniforms.add(new l.Matrix4BindUniform("viewNormal",(e=>e.camera.viewInverseTransposeMatrix)))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Float3DrawUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"vec3",t.BindType.Draw,((t,i,s,n)=>t.setUniform3fv(e,r(i,s,n))))}}e.Float3DrawUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/FloatBindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"float",t.BindType.Bind,((t,i)=>t.setUniform1f(e,r(i))))}}e.FloatBindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4DrawUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"mat4",t.BindType.Draw,((t,i,s)=>t.setUniformMatrix4fv(e,r(i,s))))}}e.Matrix4DrawUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Float4PassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"vec4",t.BindType.Pass,((t,i,s)=>t.setUniform4fv(e,r(i,s))))}}e.Float4PassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Float4BindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"vec4",t.BindType.Bind,((t,i)=>t.setUniform4fv(e,r(i))))}}e.Float4BindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/GLTextureMaterial":function(){define(["exports","../../../../core/maybe","../../../../core/promiseUtils","./basicInterfaces","./GLMaterial","../../../webgl/NoParameters"],(function(e,t,r,i,s,n){"use strict";class o extends n.NoParameters{constructor(e=null){super(),this.textureEmissive=e}}class a extends o{constructor(e,t,r,i,s,n,o){super(r),this.texture=e,this.textureNormal=t,this.textureOcclusion=i,this.textureMetallicRoughness=s,this.scale=n,this.normalTextureTransformMatrix=o}}e.GLEmissiveTexturePassParameters=o,e.GLTextureMaterial=class extends s{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textures=e.textures,this.updateTexture(e.textureId),this._acquire(e.normalTextureId,(e=>this._textureNormal=e)),this._acquire(e.emissiveTextureId,(e=>this._textureEmissive=e)),this._acquire(e.occlusionTextureId,(e=>this._textureOcclusion=e)),this._acquire(e.metallicRoughnessTextureId,(e=>this._textureMetallicRoughness=e))}dispose(){super.dispose(),this._texture=t.releaseMaybe(this._texture),this._textureNormal=t.releaseMaybe(this._textureNormal),this._textureEmissive=t.releaseMaybe(this._textureEmissive),this._textureOcclusion=t.releaseMaybe(this._textureOcclusion),this._textureMetallicRoughness=t.releaseMaybe(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return 0===this._numLoading?i.ResourceState.LOADED:i.ResourceState.LOADING}get textureBindParameters(){return new a(this._texture?.glTexture??null,this._textureNormal?.glTexture??null,this._textureEmissive?.glTexture??null,this._textureOcclusion?.glTexture??null,this._textureMetallicRoughness?.glTexture??null)}updateTexture(e){null!=this._texture&&e===this._texture.id||(this._texture=t.releaseMaybe(this._texture),this._acquire(e,(e=>this._texture=e)))}_acquire(e,i){if(null==e)return void i(null);const s=this._textures.acquire(e);if(r.isPromiseLike(s))return++this._numLoading,void s.then((e=>{if(this._disposed)return t.releaseMaybe(e),void i(null);i(e)})).finally((()=>--this._numLoading));i(s)}},e.GLTextureMaterialBindParameters=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/GLMaterial":function(){define(["./basicInterfaces"],(function(e){"use strict";return class{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){}get _stippleTextures(){return this._techniques.context.stippleTextures}get _markerTextures(){return this._techniques.context.markerTextures}getTechnique(e,t){return this._techniques.get(e,this._material.getConfiguration(this._output,t))}ensureResources(t){return e.ResourceState.LOADED}}}))},"esri/views/3d/webgl-engine/lib/RenderSlot":function(){define(["exports"],(function(e){"use strict";var t;e.RenderSlot=void 0,(t=e.RenderSlot||(e.RenderSlot={}))[t.INTEGRATED_MESH=0]="INTEGRATED_MESH",t[t.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",t[t.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",t[t.OPAQUE_MATERIAL_WITHOUT_NORMALS=3]="OPAQUE_MATERIAL_WITHOUT_NORMALS",t[t.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",t[t.TRANSPARENT_MATERIAL_WITHOUT_NORMALS=5]="TRANSPARENT_MATERIAL_WITHOUT_NORMALS",t[t.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",t[t.TRANSPARENT_MATERIAL_WITHOUT_DEPTH=7]="TRANSPARENT_MATERIAL_WITHOUT_DEPTH",t[t.OCCLUDED_GROUND=8]="OCCLUDED_GROUND",t[t.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",t[t.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",t[t.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",t[t.HUD_MATERIAL=12]="HUD_MATERIAL",t[t.LABEL_MATERIAL=13]="LABEL_MATERIAL",t[t.LINE_CALLOUTS=14]="LINE_CALLOUTS",t[t.LINE_CALLOUTS_HUD_DEPTH=15]="LINE_CALLOUTS_HUD_DEPTH",t[t.OVERLAY=16]="OVERLAY",t[t.DRAPED_MATERIAL=17]="DRAPED_MATERIAL",t[t.DRAPED_WATER=18]="DRAPED_WATER",t[t.VOXEL=19]="VOXEL",t[t.MAX_SLOTS=20]="MAX_SLOTS",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/ScaleInfo":function(){define(["exports"],(function(e){"use strict";class t{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}e.ScaleFactor=t,e.ScaleInfo=class{constructor(){this.factor=new t,this.factorAlignment=new t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/internal/bufferWriterUtils":function(){define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../geometry/support/buffer/BufferView","../../lib/Util","../../lib/VertexAttribute"],(function(e,t,r,i,s,n,o){"use strict";function a(e,t,r){const{data:i,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,a=s.length;r*=o;for(let e=0;e<a;++e){const t=2*s[e];n[r]=i[t],n[r+1]=i[t+1],r+=o}}function l(e,t,r,i=1){const{data:s,indices:n}=e,o=t.typedBuffer,a=t.typedBufferStride,l=n.length;if(r*=a,1===i)for(let e=0;e<l;++e){const t=3*n[e];o[r]=s[t],o[r+1]=s[t+1],o[r+2]=s[t+2],r+=a}else for(let e=0;e<l;++e){const t=3*n[e];for(let e=0;e<i;++e)o[r]=s[t],o[r+1]=s[t+1],o[r+2]=s[t+2],r+=a}}function c(e,t,r,i=1){const{data:s,indices:n}=e,o=t.typedBuffer,a=t.typedBufferStride,l=n.length;if(r*=a,1===i)for(let e=0;e<l;++e){const t=4*n[e];o[r]=s[t],o[r+1]=s[t+1],o[r+2]=s[t+2],o[r+3]=s[t+3],r+=a}else for(let e=0;e<l;++e){const t=4*n[e];for(let e=0;e<i;++e)o[r]=s[t],o[r+1]=s[t+1],o[r+2]=s[t+2],o[r+3]=s[t+3],r+=a}}function u(e,t,r,s,n=1){if(!t)return void l(e,r,s,n);const{data:o,indices:a}=e,c=r.typedBuffer,u=r.typedBufferStride,d=a.length,h=t[0],p=t[1],m=t[2],f=t[4],g=t[5],y=t[6],_=t[8],b=t[9],v=t[10],S=t[12],w=t[13],x=t[14];s*=u;let T=0,C=0,P=0;const M=i.hasIdentityRotation(t)?e=>{T=o[e]+S,C=o[e+1]+w,P=o[e+2]+x}:e=>{const t=o[e],r=o[e+1],i=o[e+2];T=h*t+f*r+_*i+S,C=p*t+g*r+b*i+w,P=m*t+y*r+v*i+x};if(1===n)for(let e=0;e<d;++e)M(3*a[e]),c[s]=T,c[s+1]=C,c[s+2]=P,s+=u;else for(let e=0;e<d;++e){M(3*a[e]);for(let e=0;e<n;++e)c[s]=T,c[s+1]=C,c[s+2]=P,s+=u}}function d(e,t,r,s,n=1){if(!t)return void l(e,r,s,n);const{data:o,indices:a}=e,c=t,u=r.typedBuffer,d=r.typedBufferStride,h=a.length,p=c[0],m=c[1],f=c[2],g=c[4],y=c[5],_=c[6],b=c[8],v=c[9],S=c[10],w=!i.isOrthoNormal(c),x=1e-6,T=.999999;s*=d;let C=0,P=0,M=0;const R=i.hasIdentityRotation(c)?e=>{C=o[e],P=o[e+1],M=o[e+2]}:e=>{const t=o[e],r=o[e+1],i=o[e+2];C=p*t+g*r+b*i,P=m*t+y*r+v*i,M=f*t+_*r+S*i};if(1===n)if(w)for(let e=0;e<h;++e){R(3*a[e]);const t=C*C+P*P+M*M;if(t<T&&t>x){const e=1/Math.sqrt(t);u[s]=C*e,u[s+1]=P*e,u[s+2]=M*e}else u[s]=C,u[s+1]=P,u[s+2]=M;s+=d}else for(let e=0;e<h;++e)R(3*a[e]),u[s]=C,u[s+1]=P,u[s+2]=M,s+=d;else for(let e=0;e<h;++e){if(R(3*a[e]),w){const e=C*C+P*P+M*M;if(e<T&&e>x){const t=1/Math.sqrt(e);C*=t,P*=t,M*=t}}for(let e=0;e<n;++e)u[s]=C,u[s+1]=P,u[s+2]=M,s+=d}}function h(e,t,r,s,n=1){if(!t)return void c(e,r,s,n);const{data:o,indices:a}=e,l=t,u=r.typedBuffer,d=r.typedBufferStride,h=a.length,p=l[0],m=l[1],f=l[2],g=l[4],y=l[5],_=l[6],b=l[8],v=l[9],S=l[10],w=!i.isOrthoNormal(l),x=1e-6,T=.999999;if(s*=d,1===n)for(let e=0;e<h;++e){const t=4*a[e],r=o[t],i=o[t+1],n=o[t+2],l=o[t+3];let c=p*r+g*i+b*n,h=m*r+y*i+v*n,C=f*r+_*i+S*n;if(w){const e=c*c+h*h+C*C;if(e<T&&e>x){const t=1/Math.sqrt(e);c*=t,h*=t,C*=t}}u[s]=c,u[s+1]=h,u[s+2]=C,u[s+3]=l,s+=d}else for(let e=0;e<h;++e){const t=4*a[e],r=o[t],i=o[t+1],l=o[t+2],c=o[t+3];let h=p*r+g*i+b*l,C=m*r+y*i+v*l,P=f*r+_*i+S*l;if(w){const e=h*h+C*C+P*P;if(e<T&&e>x){const t=1/Math.sqrt(e);h*=t,C*=t,P*=t}}for(let e=0;e<n;++e)u[s]=h,u[s+1]=C,u[s+2]=P,u[s+3]=c,s+=d}}function p(e,t,r,i,s=1){const{data:n,indices:o}=e,a=r.typedBuffer,l=r.typedBufferStride,c=o.length;if(i*=l,t!==n.length||4!==t)if(1!==s)if(4!==t)for(let e=0;e<c;++e){const t=3*o[e];for(let e=0;e<s;++e)a[i]=n[t],a[i+1]=n[t+1],a[i+2]=n[t+2],a[i+3]=255,i+=l}else for(let e=0;e<c;++e){const t=4*o[e];for(let e=0;e<s;++e)a[i]=n[t],a[i+1]=n[t+1],a[i+2]=n[t+2],a[i+3]=n[t+3],i+=l}else{if(4===t){for(let e=0;e<c;++e){const t=4*o[e];a[i]=n[t],a[i+1]=n[t+1],a[i+2]=n[t+2],a[i+3]=n[t+3],i+=l}return}for(let e=0;e<c;++e){const t=3*o[e];a[i]=n[t],a[i+1]=n[t+1],a[i+2]=n[t+2],a[i+3]=255,i+=l}}else{a[i]=n[0],a[i+1]=n[1],a[i+2]=n[2],a[i+3]=n[3];const e=new Uint32Array(r.typedBuffer.buffer,r.start),t=l/4,o=e[i/=4];i+=t;const u=c*s;for(let r=1;r<u;++r)e[i]=o,i+=t}}function m(e,t,r){const{data:i,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,a=s.length,l=i[0];r*=o;for(let e=0;e<a;++e)n[r]=l,r+=o}const f=r.create();function g(e,t,r,i,s=1){const n=t.typedBuffer,o=t.typedBufferStride;if(i*=o,1===s)for(let t=0;t<r;++t)n[i]=e[0],n[i+1]=e[1],n[i+2]=e[2],n[i+3]=e[3],i+=o;else for(let t=0;t<r;++t)for(let t=0;t<s;++t)n[i]=e[0],n[i+1]=e[1],n[i+2]=e[2],n[i+3]=e[3],i+=o}function y(e,t,r,i,f,g){switch(e){case o.VertexAttribute.POSITION:{n.assert(3===t.size);const i=f.getField(e,s.BufferViewVec3f);n.assert(!!i,`No buffer view for ${e}`),u(t,r,i,g);break}case o.VertexAttribute.NORMAL:{n.assert(3===t.size);const r=f.getField(e,s.BufferViewVec3f);n.assert(!!r,`No buffer view for ${e}`),d(t,i,r,g);break}case o.VertexAttribute.NORMALCOMPRESSED:case o.VertexAttribute.PROFILERIGHT:case o.VertexAttribute.PROFILEUP:{n.assert(2===t.size);const r=f.getField(e,s.BufferViewVec2i16);n.assert(!!r,`No buffer view for ${e}`),a(t,r,g);break}case o.VertexAttribute.UV0:{n.assert(2===t.size);const r=f.getField(e,s.BufferViewVec2f16)??f.getField(e,s.BufferViewVec2f);n.assert(!!r,`No buffer view for ${e}`),a(t,r,g);break}case o.VertexAttribute.UVI:{n.assert(2===t.size);const r=f.getField(e,s.BufferViewVec2i16);n.assert(!!r,`No buffer view for ${e}`),a(t,r,g);break}case o.VertexAttribute.COLOR:case o.VertexAttribute.SYMBOLCOLOR:{const r=f.getField(e,s.BufferViewVec4u8);n.assert(!!r,`No buffer view for ${e}`),n.assert(3===t.size||4===t.size),p(t,t.size,r,g);break}case o.VertexAttribute.COLORFEATUREATTRIBUTE:case o.VertexAttribute.OPACITYFEATUREATTRIBUTE:case o.VertexAttribute.SIZEFEATUREATTRIBUTE:{const r=f.getField(e,s.BufferViewFloat)??f.getField(e,s.BufferViewFloat);n.assert(!!r,`No buffer view for ${e}`),n.assert(1===t.size),m(t,r,g);break}case o.VertexAttribute.TANGENT:{n.assert(4===t.size);const i=f.getField(e,s.BufferViewVec4f);n.assert(!!i,`No buffer view for ${e}`),h(t,r,i,g);break}case o.VertexAttribute.PROFILEVERTEXANDNORMAL:{n.assert(4===t.size);const r=f.getField(e,s.BufferViewVec4f16)??f.getField(e,s.BufferViewVec4f);n.assert(!!r,`No buffer view for ${e}`),c(t,r,g);break}case o.VertexAttribute.PROFILEAUXDATA:{n.assert(3===t.size);const r=f.getField(e,s.BufferViewVec3f16)??f.getField(e,s.BufferViewVec3f);n.assert(!!r,`No buffer view for ${e}`),l(t,r,g);break}}}e.writeBufferFloat=function(e,t,r,i=1){const{data:s,indices:n}=e,o=t.typedBuffer,a=t.typedBufferStride,l=n.length;if(r*=a,1===i)for(let e=0;e<l;++e)o[r]=s[n[e]],r+=a;else for(let e=0;e<l;++e){const t=s[n[e]];for(let e=0;e<i;e++)o[r]=t,r+=a}},e.writeBufferMat3f=function(e,t,r){const{data:i,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,a=s.length;r*=o;for(let e=0;e<a;++e){const t=9*s[e];for(let e=0;e<9;++e)n[r+e]=i[t+e];r+=o}},e.writeBufferMat4f=function(e,t,r){const{data:i,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,a=s.length;r*=o;for(let e=0;e<a;++e){const t=16*s[e];for(let e=0;e<16;++e)n[r+e]=i[t+e];r+=o}},e.writeBufferVec2=a,e.writeBufferVec3=l,e.writeBufferVec4=c,e.writeBufferVec4Zeros=function(e,t,r){const i=e.typedBuffer,s=e.typedBufferStride;t*=s;for(let e=0;e<r;++e)i[t]=0,i[t+1]=0,i[t+2]=0,i[t+3]=0,t+=s},e.writeColor=p,e.writeDefaultAttribute=y,e.writeDefaultAttributes=function(e,t,r,i,n,a,l){let c={numItems:0,numVerticesPerItem:0};for(const u of r.fields.keys()){const r=e.get(u),d=r?.indices;if(r&&d)u===o.VertexAttribute.POSITION&&(c={numItems:1,numVerticesPerItem:d.length}),y(u,r,i,n,a,l);else if(u===o.VertexAttribute.OLIDCOLOR&&null!=t){const r=e.get(o.VertexAttribute.POSITION)?.indices;if(r){const e=r.length;g(t,a.getField(u,s.BufferViewVec4u8),e,l)}}}return c},e.writeDeltaF16Vector=function(e,r,i,s){t.subtract(f,e,r);const n=Math.max(Math.sqrt(t.length(f)),1e-4);t.scale(f,f,1/n),i[s++]=f[0],i[s++]=f[1],i[s++]=f[2],i[s++]=n},e.writeNormal=d,e.writeOlidColor=g,e.writePosition=u,e.writeTangent=h,e.writeVVFeatureAttribute=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/HUDMaterial.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","../core/libs/gl-matrix-2/factories/vec4f64","../geometry/support/Ellipsoid","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/ObjectAndLayerIdColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/AlignPixel.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUD.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUDOcclusionPass.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUDVisibility.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/VisualVariables.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ScreenSizePerspective.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4DrawUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/lib/OITPass","../views/3d/webgl-engine/lib/VertexAttribute","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O){"use strict";function A(e){const r=new E.ShaderBuilder,{signedDistanceFieldEnabled:A,occlusionTestEnabled:L,horizonCullingEnabled:U,pixelSnappingEnabled:V,hasScreenSizePerspective:B,debugDrawLabelBorder:G,vvSize:k,vvColor:z,hasRotation:j,occludedFragmentFade:q,sampleSignedDistanceFieldTexelCenter:H}=e;r.include(c.HUD,e),r.vertex.include(o.RejectBySlice,e);const{occlusionPass:W,output:$,oitPass:Q}=e;if(W)return r.include(u.HUDOcclusionPass,e),r;const{vertex:Z,fragment:Y}=r;r.include(g.ScreenSizePerspective),r.include(p.VisualVariables,e),r.include(a.ObjectAndLayerIdColor,e),L&&r.include(d.HUDVisibility),Y.include(f.RgbaFloatEncoding),Y.include(m.ColorConversion),r.varyings.add("vcolor","vec4"),r.varyings.add("vtc","vec2"),r.varyings.add("vsize","vec2");const X=$===n.ShaderOutput.Highlight,K=X&&L;K&&r.varyings.add("voccluded","float"),Z.uniforms.add(new b.Float4BindUniform("viewport",(e=>e.camera.fullViewport)),new _.Float2PassUniform("screenOffset",((e,r)=>t.set(F,2*e.screenOffset[0]*r.camera.pixelRatio,2*e.screenOffset[1]*r.camera.pixelRatio))),new _.Float2PassUniform("anchorPosition",(e=>D(e))),new S.Float4PassUniform("materialColor",(e=>e.color)),new x.FloatPassUniform("materialRotation",(e=>e.rotation)),new P.Texture2DPassUniform("tex",(e=>e.texture))),y.addPixelRatio(Z),A&&(Z.uniforms.add(new S.Float4PassUniform("outlineColor",(e=>e.outlineColor))),Y.uniforms.add(new S.Float4PassUniform("outlineColor",(e=>I(e)?e.outlineColor:i.ZEROS)),new x.FloatPassUniform("outlineSize",(e=>I(e)?e.outlineSize:0)))),U&&Z.uniforms.add(new v.Float4DrawUniform("pointDistanceSphere",((e,t)=>{const r=t.camera.eye,n=e.origin;return i.fromValues(n[0]-r[0],n[1]-r[1],n[2]-r[2],s.earth.radius)}))),V&&Z.include(l.AlignPixel),B&&(g.addScreenSizePerspective(Z),g.addScreenSizePerspectiveAlignment(Z)),G&&r.varyings.add("debugBorderCoords","vec4"),r.attributes.add(R.VertexAttribute.UVI,"vec2"),r.attributes.add(R.VertexAttribute.COLOR,"vec4"),r.attributes.add(R.VertexAttribute.SIZE,"vec2"),r.attributes.add(R.VertexAttribute.ROTATION,"float"),(k||z)&&r.attributes.add(R.VertexAttribute.FEATUREATTRIBUTE,"vec4"),Z.code.add(U?T.glsl`bool behindHorizon(vec3 posModel) {
vec3 camToEarthCenter = pointDistanceSphere.xyz - localOrigin;
vec3 camToPos = pointDistanceSphere.xyz + posModel;
float earthRadius = pointDistanceSphere.w;
float a = dot(camToPos, camToPos);
float b = dot(camToPos, camToEarthCenter);
float c = dot(camToEarthCenter, camToEarthCenter) - earthRadius * earthRadius;
return b > 0.0 && b < a && b * b  > a * c;
}`:T.glsl`bool behindHorizon(vec3 posModel) { return false; }`),Z.main.add(T.glsl`
    ProjectHUDAux projectAux;
    vec4 posProj = projectPositionHUD(projectAux);
    forwardObjectAndLayerIdColor();

    if (rejectBySlice(projectAux.posModel)) {
      // Project outside of clip plane
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      return;
    }

    if (behindHorizon(projectAux.posModel)) {
      // Project outside of clip plane
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      return;
    }

    vec2 inputSize;
    ${T.If(B,T.glsl`
        inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
        vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);`,T.glsl`
        inputSize = size;
        vec2 screenOffsetScaled = screenOffset;`)}
    ${T.If(k,T.glsl`inputSize *= vvScale(featureAttribute).xx;`)}

    vec2 combinedSize = inputSize * pixelRatio;
    vec4 quadOffset = vec4(0.0);

    ${T.If(L,T.glsl`
    bool visible = testHUDVisibility(posProj);
    if (!visible) {
      vtc = vec2(0.0);
      ${T.If(G,"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);")}
      return;
    }`)}
    ${T.If(K,T.glsl`voccluded = visible ? 0.0 : 1.0;`)}
  `);const J=T.glsl`
      vec2 uvi1 = vec2(uvi.x < 0.0 ? 1.0 : 0.0, uvi.y < 0.0 ? 1.0 : 0.0);
      vec2 uv = abs(uvi + uvi1);
      vec2 texSize = vec2(textureSize(tex, 0));
      uv.x = uv.x >= ${N} ? 1.0 : uv.x / texSize.x;
      uv.y = uv.y >= ${N} ? 1.0 : uv.y / texSize.y;
      quadOffset.xy = (uvi1 - anchorPosition) * 2.0 * combinedSize;

      ${T.If(j,T.glsl`
          float angle = radians(materialRotation + rotation);
          float cosAngle = cos(angle);
          float sinAngle = sin(angle);
          mat2 rotate = mat2(cosAngle, -sinAngle, sinAngle,  cosAngle);

          quadOffset.xy = rotate * quadOffset.xy;
        `)}

      quadOffset.xy = (quadOffset.xy + screenOffsetScaled) / viewport.zw * posProj.w;
  `,ee=V?A?T.glsl`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:T.glsl`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:T.glsl`posProj += quadOffset;`;Z.main.add(T.glsl`
    ${J}
    ${z?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${T.If($===n.ShaderOutput.ObjectAndLayerIdColor,T.glsl`vcolor.a = 1.0;`)}

    bool alphaDiscard = vcolor.a < ${T.glsl.float(O.alphaCutoff)};
    ${T.If(A,`alphaDiscard = alphaDiscard && outlineColor.a < ${T.glsl.float(O.alphaCutoff)};`)}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${ee}
      gl_Position = posProj;
    }

    vtc = uv;

    ${T.If(G,T.glsl`debugBorderCoords = vec4(uv01, 1.5 / combinedSize);`)}
    vsize = inputSize;
  `),Y.uniforms.add(new P.Texture2DPassUniform("tex",(e=>e.texture))),q&&!X&&Y.uniforms.add(new C.Texture2DBindUniform("depthMap",(e=>e.mainDepth)),new w.FloatBindUniform("occludedOpacity",(e=>e.hudOccludedFragmentOpacity)));const te=G?T.glsl`(isBorder > 0.0 ? 0.0 : ${T.glsl.float(O.alphaCutoff)})`:T.glsl.float(O.alphaCutoff),re=T.glsl`
    ${T.If(G,T.glsl`float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`)}

    vec2 samplePos = vtc;

    ${T.If(H,T.glsl`
      float txSize = float(textureSize(tex, 0).x);
      float texelSize = 1.0 / txSize;

      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      samplePos += (vec2(1.0, -1.0) * texelSize) * scaleFactor;`)}

    ${A?T.glsl`
      vec4 fillPixelColor = vcolor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgbaTofloat(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${te} ||
          fillPixelColor.a + outlinePixelColor.a < ${T.glsl.float(O.alphaCutoff)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        ${T.If(!X,T.glsl`fragColor = vec4(compositeColor, compositeAlpha);`)}
      } else {
        if (fillAlphaFactor < ${te}) {
          discard;
        }

        ${T.If(!X,T.glsl`fragColor = premultiplyAlpha(fillPixelColor);`)}
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:T.glsl`
          vec4 texColor = texture(tex, samplePos, -0.5);
          if (texColor.a < ${te}) {
            discard;
          }
          ${T.If(!X,T.glsl`fragColor = texColor * premultiplyAlpha(vcolor);`)}
          `}

    ${T.If(q&&!X,T.glsl`
        float zSample = texelFetch(depthMap, ivec2(gl_FragCoord.xy), 0).x;
        if (zSample < gl_FragCoord.z) {
          fragColor *= occludedOpacity;
        }
        `)}

    ${T.If(!X&&G,T.glsl`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`)}
  `;switch($){case n.ShaderOutput.Color:case n.ShaderOutput.ColorEmission:r.outputs.add("fragColor","vec4",0),$===n.ShaderOutput.ColorEmission&&r.outputs.add("fragEmission","vec4",1),Q===M.OITPass.ColorAlpha&&r.outputs.add("fragAlpha","float",$===n.ShaderOutput.ColorEmission?2:1),Y.main.add(T.glsl`
        ${re}
        ${T.If(Q===M.OITPass.FrontFace,T.glsl`fragColor.rgb /= fragColor.a;`)}
        ${T.If($===n.ShaderOutput.ColorEmission,T.glsl`fragEmission = vec4(0.0);`)}
        ${T.If(Q===M.OITPass.ColorAlpha,T.glsl`fragAlpha = fragColor.a;`)}`);break;case n.ShaderOutput.ObjectAndLayerIdColor:Y.main.add(T.glsl`
        ${re}
        outputObjectAndLayerIdColor();`);break;case n.ShaderOutput.Highlight:r.include(h.OutputHighlight,e),Y.main.add(T.glsl`
        ${re}
        outputHighlight(${T.If(K,T.glsl`voccluded == 1.0`,T.glsl`false`)});`)}return r}function I(e){return e.outlineColor[3]>0&&e.outlineSize>0}function D(e){var r,i,s;return e.textureIsSignedDistanceField?(r=e.anchorPosition,i=e.distanceFieldBoundingBox,s=F,t.set(s,r[0]*(i[2]-i[0])+i[0],r[1]*(i[3]-i[1])+i[1])):t.copy(F,e.anchorPosition),F}const F=r.create(),L=32e3,N=T.glsl.float(L),U=Object.freeze(Object.defineProperty({__proto__:null,build:A,calculateAnchorPosition:D,fullUV:L},Symbol.toStringTag,{value:"Module"}));e.HUDMaterial=U,e.build=A,e.calculateAnchorPosition=D,e.fullUV=L}))},"esri/views/3d/webgl-engine/core/shaderLibrary/Slice.glsl":function(){define(["exports","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../shaderModules/Float3DrawUniform","../shaderModules/Float3PassUniform","../shaderModules/glsl","../../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.NoParameters{constructor(e){super(),this.slicePlaneLocalOrigin=e}}const u=a.glsl`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function d(e,t,...r){t.hasSlicePlane?(e.uniforms.add(...r),e.code.add(u)):e.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function h(e,t,...r){d(e,t,...r),t.hasSlicePlane?e.code.add("\n    void discardBySlice(vec3 pos) {\n      if (sliceByPlane(pos)) {\n        discard;\n      }\n    }\n\n    vec4 applySliceOutline(vec4 color, vec3 pos) {\n      SliceFactors factors = calculateSliceFactors(pos);\n\n      factors.front /= 2.0 * fwidth(factors.front);\n      factors.side0 /= 2.0 * fwidth(factors.side0);\n      factors.side1 /= 2.0 * fwidth(factors.side1);\n      factors.side2 /= 2.0 * fwidth(factors.side2);\n      factors.side3 /= 2.0 * fwidth(factors.side3);\n\n      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth\n      if (sliceByFactors(factors)) {\n        return color;\n      }\n\n      float outlineFactor = (1.0 - step(0.5, factors.front))\n        * (1.0 - step(0.5, factors.side0))\n        * (1.0 - step(0.5, factors.side1))\n        * (1.0 - step(0.5, factors.side2))\n        * (1.0 - step(0.5, factors.side3));\n\n      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);\n    }\n\n    vec4 applySlice(vec4 color, vec3 pos) {\n      return sliceEnabled() ? applySliceOutline(color, pos) : color;\n    }\n  "):e.code.add(a.glsl`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function p(e,t,r){return e.instancedDoublePrecision?i.set(_,r.camera.viewInverseTransposeMatrix[3],r.camera.viewInverseTransposeMatrix[7],r.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function m(e,t){return null!=e?i.subtract(b,t.origin,e):t.origin}function f(e,r,i){return e.hasSliceTranslatedView?null!=r?t.translate(S,i.camera.viewMatrix,r):i.camera.viewMatrix:null}function g(e,t,r){if(null==r.slicePlane)return s.ZEROS;const n=p(e,t,r),o=m(n,r.slicePlane),a=f(e,n,r);return null!=a?i.transformMat4(b,o,a):o}function y(e,t,r,n){if(null==n||null==r.slicePlane)return s.ZEROS;const o=p(e,t,r),a=m(o,r.slicePlane),l=f(e,o,r);return null!=l?(i.add(v,n,a),i.transformMat4(b,a,l),i.transformMat4(v,v,l),i.subtract(v,v,b)):n}const _=s.create(),b=s.create(),v=s.create(),S=r.create();e.RejectBySlice=function(e,t){d(e,t,new n.Float3DrawUniform("slicePlaneOrigin",((e,r)=>g(t,e,r))),new n.Float3DrawUniform("slicePlaneBasis1",((e,r)=>y(t,e,r,r.slicePlane?.basis1))),new n.Float3DrawUniform("slicePlaneBasis2",((e,r)=>y(t,e,r,r.slicePlane?.basis2))))},e.SliceDraw=function(e,t){h(e,t,new n.Float3DrawUniform("slicePlaneOrigin",((e,r)=>g(t,e,r))),new n.Float3DrawUniform("slicePlaneBasis1",((e,r)=>y(t,e,r,r.slicePlane?.basis1))),new n.Float3DrawUniform("slicePlaneBasis2",((e,r)=>y(t,e,r,r.slicePlane?.basis2))))},e.SlicePass=function(e,t){h(e,t,new o.Float3PassUniform("slicePlaneOrigin",((e,r)=>g(t,e,r))),new o.Float3PassUniform("slicePlaneBasis1",((e,r)=>y(t,e,r,r.slicePlane?.basis1))),new o.Float3PassUniform("slicePlaneBasis2",((e,r)=>y(t,e,r,r.slicePlane?.basis2))))},e.SlicePlaneParameters=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/ObjectAndLayerIdColor.glsl":function(){define(["exports","../ShaderOutput","../../shaderModules/glsl","../../../lib/VertexAttribute"],(function(e,t,r,i){"use strict";e.ObjectAndLayerIdColor=function(e,s){if(s.output!==t.ShaderOutput.ObjectAndLayerIdColor)return e.vertex.code.add(r.glsl`void forwardObjectAndLayerIdColor() {}`),void e.fragment.code.add(r.glsl`void outputObjectAndLayerIdColor() {}`);const n=s.objectAndLayerIdColorInstanced;e.varyings.add("objectAndLayerIdColorVarying","vec4"),e.attributes.add(n?i.VertexAttribute.INSTANCEOBJECTANDLAYERIDCOLOR:i.VertexAttribute.OLIDCOLOR,"vec4"),e.vertex.code.add(r.glsl`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${n?"instanceObjectAndLayerIdColor":"objectAndLayerIdColor"} * 0.003921568627451;
    }`),e.fragment.code.add(r.glsl`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/hud/AlignPixel.glsl":function(){define(["exports","../../shaderModules/BooleanBindUniform","../../shaderModules/glsl"],(function(e,t,r){"use strict";e.AlignPixel=function(e){e.uniforms.add(new t.BooleanBindUniform("alignPixelEnabled",(e=>e.alignPixelEnabled))),e.code.add(r.glsl`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`),e.code.add(r.glsl`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/BooleanBindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"bool",t.BindType.Bind,((t,i)=>t.setUniform1b(e,r(i))))}}e.BooleanBindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/hud/HUDOcclusionPass.glsl":function(){define(["exports","./AlignPixel.glsl","../shading/TerrainDepthTest.glsl","../../shaderModules/glsl"],(function(e,t,r,i){"use strict";e.HUDOcclusionPass=function(e,s){const{vertex:n,fragment:o}=e;e.include(r.terrainDepthTest,s),n.include(t.AlignPixel),n.main.add(i.glsl`vec4 posProjCenter;
if (dot(position, position) > 0.0) {
ProjectHUDAux projectAux;
vec4 posProj = projectPositionHUD(projectAux);
posProjCenter = alignToPixelCenter(posProj, viewport.zw);
forwardViewPosDepth(projectAux.posView);
vec3 vpos = projectAux.posModel;
if (rejectBySlice(vpos)) {
posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
}
} else {
posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
}
gl_Position = posProjCenter;
gl_PointSize = 1.0;`),o.main.add(i.glsl`fragColor = vec4(1);
if(discardByTerrainDepth()) {
fragColor.g = 0.5;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl":function(){define(["exports","../output/ReadDepth.glsl","../../shaderModules/glsl","../../shaderModules/Texture2DBindUniform"],(function(e,t,r,i){"use strict";e.terrainDepthTest=function(e,{occlusionPass:s,terrainDepthTest:n,cullAboveTerrain:o}){const{vertex:a,fragment:l,varyings:c}=e;if(!n)return a.code.add("void forwardViewPosDepth(vec3 pos) {}"),void l.code.add(`${s?"bool":"void"} discardByTerrainDepth() { ${r.If(s,"return false;")}}`);c.add("viewPosDepth","float",{invariant:!0}),a.code.add("void forwardViewPosDepth(vec3 pos) {\n    viewPosDepth = pos.z;\n  }"),l.include(t.ReadDepth),l.uniforms.add(new i.Texture2DBindUniform("terrainDepthTexture",(e=>e.terrainDepth?.attachment))).code.add(r.glsl`
    ${s?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${s?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${o?">":"<="} linearDepth) discard;`}
    }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../shaderModules/Float2BindUniform","../../shaderModules/glsl"],(function(e,t,r,i,s){"use strict";const n=r.create();e.ReadDepth=function(e){e.uniforms.add(new i.Float2BindUniform("zProjectionMap",(e=>function(e){const r=e.projectionMatrix;return t.set(n,r[14],r[10])}(e.camera)))),e.code.add(s.glsl`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),e.code.add(s.glsl`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),e.code.add(s.glsl`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Float2BindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"vec2",t.BindType.Bind,((t,i)=>t.setUniform2fv(e,r(i))))}}e.Float2BindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"sampler2D",t.BindType.Bind,((t,i)=>t.bindTexture(e,r(i))))}}e.Texture2DBindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/hud/HUDVisibility.glsl":function(){define(["exports","./AlignPixel.glsl","./HUDRenderStyle","../../shaderModules/Float4BindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../shaderModules/Texture2DBindUniform"],(function(e,t,r,i,s,n,o){"use strict";e.HUDVisibility=function(e){e.vertex.uniforms.add(new s.FloatBindUniform("renderTransparentlyOccludedHUD",(e=>e.hudRenderStyle===r.HUDRenderStyle.Occluded?1:e.hudRenderStyle===r.HUDRenderStyle.NotOccluded?0:.75)),new i.Float4BindUniform("viewport",(e=>e.camera.fullViewport)),new o.Texture2DBindUniform("hudVisibilityTexture",(e=>e.hudVisibility?.getTexture()))),e.vertex.include(t.AlignPixel),e.vertex.code.add(n.glsl`bool testHUDVisibility(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/hud/HUDRenderStyle":function(){define(["exports"],(function(e){"use strict";var t;e.HUDRenderStyle=void 0,(t=e.HUDRenderStyle||(e.HUDRenderStyle={}))[t.Occluded=0]="Occluded",t[t.NotOccluded=1]="NotOccluded",t[t.Both=2]="Both",t[t.COUNT=3]="COUNT",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl":function(){define(["exports","../HighlightReadBitmap.glsl","../ShaderOutput","../../shaderModules/glsl","../../shaderModules/Integer2BindUniform","../../shaderModules/IntegerBindUniform","../../shaderModules/Texture2DBindUniform","../../shaderModules/Texture2DUintBindUniform"],(function(e,t,r,i,s,n,o,a){"use strict";e.OutputHighlight=function(e,l){const{fragment:c}=e,{output:u,draped:d,hasHighlightMixTexture:h}=l;u===r.ShaderOutput.Highlight?(c.uniforms.add(new n.IntegerBindUniform("highlightLevel",(e=>e.highlightLevel??0)),new s.Integer2BindUniform("highlightMixOrigin",(e=>e.highlightMixOrigin))),e.outputs.add("fragHighlight","uvec2",0),e.include(t.HighlightReadBitmap),h?c.uniforms.add(new a.Texture2DUintBindUniform("highlightMixTexture",(e=>e.highlightMixTexture))).code.add(i.glsl`uvec2 getAccumulatedHighlight() {
return texelFetch(highlightMixTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
uvec2 combinedHighlight = getAccumulatedHighlight();
combinedHighlight[li] |= bits;
fragHighlight = combinedHighlight;
}
}`):c.code.add(i.glsl`void outputHighlight(bool occluded) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
}`),d?c.code.add(i.glsl`bool isHighlightOccluded() {
return false;
}`):c.uniforms.add(new o.Texture2DBindUniform("depthTexture",(e=>e.mainDepth))).code.add(i.glsl`bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}`),c.code.add(i.glsl`void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`)):c.code.add(i.glsl`void calculateOcclusionAndOutputHighlight() {}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/HighlightReadBitmap.glsl":function(){define(["exports","../shaderModules/glsl"],(function(e,t){"use strict";e.HighlightReadBitmap=function(e){const{fragment:r}=e;r.code.add(t.glsl`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(uvec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return texel[lic];
}
uint readLevelBits(uvec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Integer2BindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"ivec2",t.BindType.Bind,((t,i)=>t.setUniform2iv(e,r(i))))}}e.Integer2BindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/IntegerBindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"int",t.BindType.Bind,((t,i)=>t.setUniform1i(e,r(i))))}}e.IntegerBindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DUintBindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"usampler2D",t.BindType.Bind,((t,i)=>t.bindTexture(e,r(i))))}}e.Texture2DUintBindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/VisualVariables.glsl":function(){define(["exports","../../shaderModules/Float3PassUniform","../../shaderModules/Float4PassUniform","../../shaderModules/Float4sPassUniform","../../shaderModules/FloatsPassUniform","../../shaderModules/glsl","../../shaderModules/Matrix3PassUniform","../../../lib/VertexAttribute","../../../materials/VisualVariablePassParameters"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.VisualVariables=function(e,c){const{vertex:u,attributes:d}=e;c.hasVvInstancing&&(c.vvSize||c.vvColor)&&d.add(a.VertexAttribute.INSTANCEFEATUREATTRIBUTE,"vec4"),c.vvSize?(u.uniforms.add(new t.Float3PassUniform("vvSizeMinSize",(e=>e.vvSize.minSize))),u.uniforms.add(new t.Float3PassUniform("vvSizeMaxSize",(e=>e.vvSize.maxSize))),u.uniforms.add(new t.Float3PassUniform("vvSizeOffset",(e=>e.vvSize.offset))),u.uniforms.add(new t.Float3PassUniform("vvSizeFactor",(e=>e.vvSize.factor))),u.uniforms.add(new t.Float3PassUniform("vvSizeFallback",(e=>e.vvSize.fallback))),u.uniforms.add(new o.Matrix3PassUniform("vvSymbolRotationMatrix",(e=>e.vvSymbolRotationMatrix))),u.uniforms.add(new t.Float3PassUniform("vvSymbolAnchor",(e=>e.vvSymbolAnchor))),u.code.add(n.glsl`vec3 vvScale(vec4 _featureAttribute) {
if (isnan(_featureAttribute.x)) {
return vvSizeFallback;
}
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),u.code.add(n.glsl`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 scale = max(vvScale(_featureAttribute), eps);
        return vec4(vvSymbolRotationMatrix * _normal / scale, 1.0);
      }

      ${c.hasVvInstancing?n.glsl`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):u.code.add(n.glsl`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),c.vvColor?(u.constants.add("vvColorNumber","int",l.vvColorNumber),u.uniforms.add(new s.FloatsPassUniform("vvColorValues",(e=>e.vvColor.values),l.vvColorNumber),new i.Float4sPassUniform("vvColorColors",(e=>e.vvColor.colors),l.vvColorNumber),new r.Float4PassUniform("vvColorFallback",(e=>e.vvColor.fallback))),u.code.add(n.glsl`
      vec4 interpolateVVColor(float value) {
        if (isnan(value)) {
          return vvColorFallback;
        }

        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${c.hasVvInstancing?n.glsl`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }`:"vec4 vvColor() { return vec4(1.0); }"}
    `)):u.code.add(n.glsl`vec4 vvColor() { return vec4(1.0); }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Float4sPassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r,i){super(e,"vec4",t.BindType.Pass,((t,i,s)=>t.setUniform4fv(e,r(i,s))),i)}}e.Float4sPassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/FloatsPassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r,i){super(e,"float",t.BindType.Pass,((t,i,s)=>t.setUniform1fv(e,r(i,s))),i)}}e.FloatsPassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/VisualVariablePassParameters":function(){define(["exports","../../layers/support/FastSymbolUpdates","../lib/Material"],(function(e,t,r){"use strict";class i extends t.VisualVariablesParameters{constructor(){super(...arguments),this.renderOccluded=r.RenderOccludedFlag.Occlude,this.isDecoration=!1}}e.VisualVariablePassParameters=i,e.vvColorNumber=8,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl":function(){define(["exports","../../shaderModules/glsl"],(function(e,t){"use strict";e.ColorConversion=function(e){e.code.add(t.glsl`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl":function(){define(["exports","../../shaderModules/glsl"],(function(e,t){"use strict";e.RgbaFloatEncoding=function(e){e.code.add(t.glsl`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}`),e.code.add(t.glsl`const vec4 RGBA_TO_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgbaTofloat(vec4 rgba) {
return dot(rgba, RGBA_TO_FLOAT_FACTORS);
}`),e.code.add(t.glsl`const vec4 uninterpolatedRGBAToFloatFactors = vec4(
1.0 / 256.0,
1.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0 / 256.0
);
float uninterpolatedRGBAToFloat(vec4 rgba) {
return (dot(round(rgba * 255.0), uninterpolatedRGBAToFloatFactors) - 0.5) * 2.0;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Float4DrawUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"vec4",t.BindType.Draw,((t,i,s)=>t.setUniform4fv(e,r(i,s))))}}e.Float4DrawUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/webscene/support/AlphaCutoff":function(){define(["exports"],(function(e){"use strict";e.alphaCutoff=1/255.5,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/HUDMaterialTechnique":function(){define(["require","exports","../core/shaderLibrary/ShaderOutput","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/OITPass","../lib/OrderIndependentTransparency","../../../../chunks/HUDMaterial.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends s.ShaderTechnique{constructor(t,r){super(t,r,new i.ReloadableShaderModule(a.HUDMaterial,(()=>new Promise(((t,r)=>e(["./HUDMaterial.glsl"],t,r)))))),this.primitiveType=r.occlusionPass?l.PrimitiveType.POINTS:l.PrimitiveType.TRIANGLES}initializePipeline(e){const{oitPass:t,hasPolygonOffset:i,draped:s,output:a,depthTestEnabled:u,occlusionPass:h}=e,p=t===n.OITPass.NONE,m=t===n.OITPass.ColorAlpha,f=a===r.ShaderOutput.Highlight,g=u&&!s&&!m&&!h&&!f;return c.makePipelineState({blending:r.isColorOrColorEmission(a)?p?c.premultipliedAlpha:o.oitBlending(t):null,depthTest:u&&!s?{func:l.CompareFunction.LEQUAL}:null,depthWrite:g?c.defaultDepthWrite:null,drawBuffers:o.getDrawBuffers(t,a),colorWrite:c.defaultColorWrite,polygonOffset:i?d:null})}}const d={factor:0,units:-4};t.HUDMaterialTechnique=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/OrderIndependentTransparency":function(){define(["exports","../core/shaderLibrary/ShaderOutput","./OITPass","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s){"use strict";const n=s.separateBlendingParams(i.BlendFactor.ONE,i.BlendFactor.ZERO,i.BlendFactor.ONE,i.BlendFactor.ONE_MINUS_SRC_ALPHA),o={factor:-1,units:-2};e.OITPolygonOffset=o,e.OITPolygonOffsetLimit=5e5,e.blending=function(e){switch(e){case r.OITPass.NONE:return s.unpremultipliedAlphaToPremultipliedAlpha;case r.OITPass.ColorAlpha:return n;case r.OITPass.FrontFace:case r.OITPass.COUNT:return null}},e.blendingColorAlpha=n,e.depthWrite=function(e){if(e.draped)return null;switch(e.oitPass){case r.OITPass.NONE:case r.OITPass.FrontFace:return e.writeDepth?s.defaultDepthWrite:null;case r.OITPass.ColorAlpha:case r.OITPass.COUNT:return null}},e.getDrawBuffers=function(e,s){const n=t.isColorEmission(s);return e===r.OITPass.ColorAlpha?n?{buffers:[i.ColorAttachment0,i.ColorAttachment1,i.ColorAttachment2]}:{buffers:[i.ColorAttachment0,i.ColorAttachment1]}:n?{buffers:[i.ColorAttachment0,i.ColorAttachment1]}:null},e.oitBlending=function(e){return e===r.OITPass.FrontFace?null:n},e.oitDepthTest=function(e,t=i.CompareFunction.LESS){return e===r.OITPass.NONE||e===r.OITPass.FrontFace?t:i.CompareFunction.LEQUAL},e.oitPolygonOffset=function({oitPass:e,enableOffset:t}){return t&&e===r.OITPass.ColorAlpha?o:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/HUDMaterialTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../core/shaderLibrary/output/Emissions.glsl","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],(function(e,t,r,i,s,n){"use strict";class o extends n.DefaultTechniqueConfiguration{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hasRotation=!1,this.debugDrawLabelBorder=!1,this.hasPolygonOffset=!1,this.depthTestEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.occlusionPass=!1,this.occludedFragmentFade=!1,this.objectAndLayerIdColorInstanced=!1,this.horizonCullingEnabled=!0,this.isFocused=!0,this.textureCoordinateType=r.TextureCoordinateType.None,this.emissionSource=i.EmissionSource.None,this.discardInvisibleFragments=!0,this.hasVvInstancing=!1,this.snowCover=!1}}t.__decorate([s.parameter()],o.prototype,"screenCenterOffsetUnitsEnabled",void 0),t.__decorate([s.parameter()],o.prototype,"occlusionTestEnabled",void 0),t.__decorate([s.parameter()],o.prototype,"signedDistanceFieldEnabled",void 0),t.__decorate([s.parameter()],o.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),t.__decorate([s.parameter()],o.prototype,"vvSize",void 0),t.__decorate([s.parameter()],o.prototype,"vvColor",void 0),t.__decorate([s.parameter()],o.prototype,"hasVerticalOffset",void 0),t.__decorate([s.parameter()],o.prototype,"hasScreenSizePerspective",void 0),t.__decorate([s.parameter()],o.prototype,"hasRotation",void 0),t.__decorate([s.parameter()],o.prototype,"debugDrawLabelBorder",void 0),t.__decorate([s.parameter()],o.prototype,"hasPolygonOffset",void 0),t.__decorate([s.parameter()],o.prototype,"depthTestEnabled",void 0),t.__decorate([s.parameter()],o.prototype,"pixelSnappingEnabled",void 0),t.__decorate([s.parameter()],o.prototype,"draped",void 0),t.__decorate([s.parameter()],o.prototype,"terrainDepthTest",void 0),t.__decorate([s.parameter()],o.prototype,"cullAboveTerrain",void 0),t.__decorate([s.parameter()],o.prototype,"occlusionPass",void 0),t.__decorate([s.parameter()],o.prototype,"occludedFragmentFade",void 0),t.__decorate([s.parameter()],o.prototype,"objectAndLayerIdColorInstanced",void 0),t.__decorate([s.parameter()],o.prototype,"horizonCullingEnabled",void 0),t.__decorate([s.parameter()],o.prototype,"isFocused",void 0),e.HUDMaterialTechniqueConfiguration=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../../shaderModules/glsl","../../../lib/VertexAttribute"],(function(e,t,r,i){"use strict";var s;e.TextureCoordinateType=void 0,(s=e.TextureCoordinateType||(e.TextureCoordinateType={}))[s.None=0]="None",s[s.Default=1]="Default",s[s.Atlas=2]="Atlas",s[s.COUNT=3]="COUNT",e.TextureCoordinateAttribute=function(s,n){switch(n.textureCoordinateType){case e.TextureCoordinateType.Default:return s.attributes.add(i.VertexAttribute.UV0,"vec2"),s.varyings.add("vuv0","vec2"),void s.vertex.code.add(r.glsl`void forwardTextureCoordinates() { vuv0 = uv0; }`);case e.TextureCoordinateType.Atlas:return s.attributes.add(i.VertexAttribute.UV0,"vec2"),s.attributes.add(i.VertexAttribute.UVREGION,"vec4"),s.varyings.add("vuv0","vec2"),s.varyings.add("vuvRegion","vec4"),void s.vertex.code.add(r.glsl`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:t.neverReached(n.textureCoordinateType);case e.TextureCoordinateType.None:return void s.vertex.code.add(r.glsl`void forwardTextureCoordinates() {}`);case e.TextureCoordinateType.COUNT:return}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/output/Emissions.glsl":function(){define(["exports","../ShaderOutput","../attributes/VertexTextureCoordinates.glsl","../../shaderModules/Float3DrawUniform","../../shaderModules/Float3PassUniform","../../shaderModules/FloatDrawUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DDrawUniform","../../shaderModules/Texture2DPassUniform","../../../lib/GLTextureMaterial","../../../../../webgl/BindType"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";var h;e.EmissionSource=void 0,(h=e.EmissionSource||(e.EmissionSource={}))[h.None=0]="None",h[h.SymbolColor=1]="SymbolColor",h[h.EmissiveColor=2]="EmissiveColor",h[h.Texture=3]="Texture",h[h.COUNT=4]="COUNT";class p extends u.GLEmissiveTexturePassParameters{}e.Emissions=function(u,h){if(!t.isColorOrColorEmission(h.output))return;const{emissionSource:p,hasEmissiveTextureTransform:m,bindType:f}=h,g=p===e.EmissionSource.Texture;g&&(u.include(r.VertexTextureCoordinates,h),u.fragment.uniforms.add(f===d.BindType.Pass?new c.Texture2DPassUniform("texEmission",(e=>e.textureEmissive)):new l.Texture2DDrawUniform("texEmission",(e=>e.textureEmissive))));const y=p===e.EmissionSource.EmissiveColor||g;y&&u.fragment.uniforms.add(f===d.BindType.Pass?new s.Float3PassUniform("emissiveBaseColor",(e=>e.emissiveBaseColor)):new i.Float3DrawUniform("emissiveBaseColor",(e=>e.emissiveBaseColor)));const _=p!==e.EmissionSource.None;_&&u.fragment.uniforms.add(f===d.BindType.Pass?new o.FloatPassUniform("emissiveStrength",(e=>e.emissiveStrength)):new n.FloatDrawUniform("emissiveStrength",(e=>e.emissiveStrength)));const b=p===e.EmissionSource.SymbolColor;u.fragment.code.add(a.glsl`
    vec4 getEmissions(vec3 symbolColor) {
      vec4 emissions = ${y?"vec4(emissiveBaseColor, 1.0)":b?"vec4(symbolColor, 1.0)":"vec4(0.0)"};
      ${a.If(g,`emissions *= textureLookup(texEmission, ${m?"emissiveUV":"vuv0"});\n         emissions.w = emissions.rgb == vec3(0.0) ? 0.0: emissions.w;`)}
      ${a.If(_,"emissions.rgb *= emissiveStrength;")}
      return emissions;
    }
  `)},e.EmissionsParameters=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexTextureCoordinates.glsl":function(){define(["exports","./TextureCoordinateAttribute.glsl","../util/TextureAtlasLookup.glsl","../../shaderModules/glsl"],(function(e,t,r,i){"use strict";e.VertexTextureCoordinates=function(e,s){const{textureCoordinateType:n}=s;if(n===t.TextureCoordinateType.None||n===t.TextureCoordinateType.COUNT)return;e.include(t.TextureCoordinateAttribute,s);const o=n===t.TextureCoordinateType.Atlas;o&&e.include(r.TextureAtlasLookup),e.fragment.code.add(i.glsl`
    vec4 textureLookup(sampler2D tex, vec2 uv) {
      return ${o?"textureAtlasLookup(tex, uv, vuvRegion)":"texture(tex, uv)"};
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/TextureAtlasLookup.glsl":function(){define(["exports","../../shaderModules/glsl"],(function(e,t){"use strict";e.TextureAtlasLookup=function(e){e.fragment.code.add(t.glsl`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/FloatDrawUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"float",t.BindType.Draw,((t,i,s)=>t.setUniform1f(e,r(i,s))))}}e.FloatDrawUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DDrawUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"sampler2D",t.BindType.Draw,((t,i,s)=>t.bindTexture(e,r(i,s))))}}e.Texture2DDrawUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/LabelDeconflictor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./Deconflictor","./enums","../../../support/RenderState","../../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.LabelDeconflictor=class extends a.Deconflictor{constructor(e){super(e),this.visibilityGroup=l.VisibilityGroup.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return u.Yield;const t=performance.now();if(this.view.state.mode!==c.RenderState.IDLE&&t-this._lastDeconfliction<2e3)return u.Yield;const r=super.runTask(e);return this.state===a.State.Idle&&(this._lastDeconfliction=t),r}},t.__decorate([r.property({constructOnly:!0})],e.LabelDeconflictor.prototype,"parent",void 0),e.LabelDeconflictor=t.__decorate([o.subclass("esri.views.3d.layers.graphics.LabelDeconflictor")],e.LabelDeconflictor),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Labeler":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/labelFormatUtils","../../../../symbols/callouts/calloutUtils","./enums","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DLineCalloutSymbolLayer","./graphicSymbolUtils","./LabelInfo","./LabelParameters","./placementUtils","./pointUtils","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/lib/WebGLLayer","../../../support/layerViewUtils","../../../support/Scheduler","../../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A){"use strict";class I{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class D{constructor(e,t,r,i,s){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=r,this.textRenderParameters=i,this.labelFunction=s,this.calloutSymbolLayerIndex=0,this.graphics=new Map,this.scaleVisibility=null}}class F{constructor(e,t,r,i,s,n,o,a){this.layer=t,this.graphics3DCore=r,this.scaleVisibility=i,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=n,this.disablePlacement=o,this.active=a,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new R.WebGLLayer(e,{pickable:!0},r.owner.layerViewUid)}destroy(){this.stageLayer.destroy()}}function L(e,t){e.geometries[0].setAttributeData(M.VertexAttribute.SIZE,[t.displayWidth,t.displayHeight]),e.geometryVertexAttributeUpdated(e.geometries[0],M.VertexAttribute.SIZE)}function N(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function U(e){return!e||0===e.length}function V(e){return"label-3d"===e.symbol?.type?e.symbol:null}function B(e){return!!e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}e.Labeler=class extends r{constructor(e){super(e),this._hudMaterials=new Map,this._calloutMaterials=new Map,this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([l.watch((()=>this.view.state?.camera),(()=>this.setDirty())),l.watch((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),l.watch((()=>this.view.focusAreasView?.polygons),(()=>this._updateFocus())),this.view.resourceController.scheduler.registerTask(O.TaskPriority.LABELER,this)]),E.hasLayerBasedScaleVisibility()&&this.addHandles(l.watch((()=>this.view.scale),(()=>this._updateScaleVisibility()))),this._textTextureAtlas=new P.TextTextureAtlas({view:this.view})}dispose(){this.removeAllHandles(),this._textTextureAtlas=o.disposeMaybe(this._textTextureAtlas),this._hudMaterials.clear(),this._calloutMaterials.clear(),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),G.graphic=null,G.renderingInfo=null,G.layer=null}_updateFocus(){this._labelingContexts.forEach((e=>{e.graphics.forEach((t=>{if(0===t.labelLayers.length)return;const r=x.placePointOnGeometry(t.graphic.geometry);if(null==r)return;const i=this.view.focusAreasView?.containsGeometry(r)??!0;t.labelLayers.forEach((r=>{r.stageObject.geometries.some((e=>e.material.parameters.isFocused!==i))&&(this._removeGraphic(e,t),this._addGraphic(e,t),this.setDirty())}))}))}))}_activateLabelingContext(e){e.graphics.forEach(((t,r)=>{const i=new I(e,t);this._labels.set(r,i),e.labelsToInitialize.set(r,i),t.setVisibilityFlag(g.VisibilityGroup.LABEL,g.VisibilityFlag.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(g.VisibilityGroup.LABEL,g.VisibilityFlag.USER,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t.labelClass)continue;const r=e.textRenderers[t.labelClassContextIndex];r&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(r,(e=>{return i=e,(r=t.stageObject).geometries[0].setAttributeData(M.VertexAttribute.UVI,i),void r.geometryVertexAttributeUpdated(r.geometries[0],M.VertexAttribute.UVI,!0);var r,i}))),L(t.stageObject,r))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach((e=>e.remove())),e.textureAtlasHandles.length=0}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),A.Yield}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(N(t))this._dirty=!0;else if(U(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[r,i]of t.labelsToInitialize)if(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done){this._dirty=!0;break}this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),a.throwIfAborted(t),e.scaleVisibility?.updateScaleRangeActive();const r=e.graphics3DCore,s=r.layer,o=s.labelingInfo?.filter((e=>!!e.symbol));if(!o||0===o.length)return;let l=!1;await i.forEach(o,(async(s,o)=>{const c=s.symbol,u=b.getGraphics3DSymbol(r.getOrCreateGraphics3DSymbol(c));if(null==u)return void n.getLogger(this).error("Failed to create Graphics3DSymbol for label");await u.load(),a.throwIfAborted(t);let d=null;f.hasCalloutSupport(c)&&c.hasVisibleCallout()&&(d=y.make(c,r.symbolCreationContext),await d.load(),a.throwIfAborted(t));const h=await i.result(m.createLabelFunction(s,e.layer.fieldsIndex,this.view.spatialReference));if(a.throwIfAborted(t),!0===h.ok){const r=await this._createTextRenderParameters(u.symbol);a.throwIfAborted(t);const i=new D(s,u,d,r,h.value);this._updateLabelClassContextVisibility(i),e.labelClassContexts[o]=i}else n.getLogger(this).error(`Label expression failed to evaluate: ${h.error}`),l=!0})),a.throwIfAborted(t)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(a.isAbortError(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:C.TextRenderParameters.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,o.abortMaybe(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,r,i,s,n){const o=new S.LabelParameters(r,w.horizontalPlacementFromAnchor(r.anchor),w.verticalPlacementFromAnchor(r.anchor),e.text,h.fromValues(e.displayWidth,e.displayHeight));return G.graphic=t,G.layer=i,G.renderingInfo=null,s.createLabel(G,o,this._hudMaterials,this._textTextureAtlas,(()=>n.placement?.elevationOffset??null))}_createLineCalloutGraphic(e,t,r,i,s){G.graphic=e,G.layer=s;const n=i.screenOffset[0];return G.renderingInfo=new _.LineCalloutSymbolLayerRenderingInfo(null,t,i.translation,i.centerOffset,n,i.centerOffsetUnits,i.elevationOffset),r.createGraphics3DGraphic(G,this._calloutMaterials)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const r=e.labelingContext,i=r.labelClassContexts;if(U(i)||!r.emptySymbolLabelSupported&&0===t.layers.length)return!1;let s=!1;const n=t.graphic,o=r.layer,a=B(r.layer);for(let l=0;l<i.length;l++){const c=e.textRenderers[l],u=e.textLabelPlacements[l];if(null==c||null==u)continue;const d=i[l],h=d.graphics3DSymbol,p=V(h),m=h.symbolLayers[0];if(!m)continue;m.setElevationInfoOverride(r.elevationInfoOverride);const f=new v.LabelInfo(t,p,d.labelClass),y=this._createTextSymbolGraphic(c,n,u,o,m,f);if(null==y)return!1;y.labelClass=d.labelClass,y.labelClassContextIndex=l,t.addLabelGraphic(y,r.stageLayer),this.deconflictor.setPriority(t,d.textRenderParameters?.definition.size??0),t.setVisibilityFlag(g.VisibilityGroup.LABEL,g.VisibilityFlag.USER,a),t.setVisibilityFlag(g.VisibilityGroup.LABEL,g.VisibilityFlag.SCALE_RANGE,d.scaleVisibility??!0),t.setVisibilityFlag(g.VisibilityGroup.LABEL,g.VisibilityFlag.DECONFLICTION,!1),E.hasLayerBasedScaleVisibility()&&d.graphics.set(n.uid,t),s=!0;const _=d.graphics3DCalloutSymbolLayer;if(_&&u.hasLabelVerticalOffset){_.setElevationInfoOverride(r.elevationInfoOverride);const e=this._createLineCalloutGraphic(n,p,_,u,o);null!=e&&(d.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,r.stageLayer))}break}return s&&r.scaleVisibility?.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const r of e.graphics3DGraphic.labelLayers){if(null==r.labelClass)continue;const e=t[r.labelClassContextIndex].graphics3DSymbol.symbolLayers[0];e?.onRemoveGraphic(r)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,r=t.labelClassContexts;if(U(r))return;const i=e.graphics3DGraphic.graphic;for(let s=0;s<r.length;s++){const n=r[s];if(e.textRenderers[s]=null,e.textLabelPlacements[s]=null,null==n?.textRenderParameters)continue;const o=n.labelFunction;let a;if("arcade"===o.type)try{const e=o.needsHydrationToEvaluate()?p.hydrateGraphic(i,t.layer):i;a=o.evaluate(e)}catch(e){a=null}else a=o.evaluate(i);if(null==a||""===a||/^\s+$/.test(a))continue;const l=n.graphics3DSymbol;if(!l.symbolLayers[0])continue;const c=e.graphics3DGraphic,u="label-3d"===l.symbol?.type?l.symbol:null,d=n.labelClass,h=t.disablePlacement,m=new v.LabelInfo(c,u,d,h).placement;if(null==m)continue;const f=w.horizontalPlacementFromAnchor(m.anchor),g=w.textRenderAlignmentFromHorizontalPlacement(f);e.textRenderers[s]=new T.TextRenderer(a,g,n.textRenderParameters,P.TextTextureAtlas.maxSize),e.textLabelPlacements[s]=m}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const r=t.graphic.uid;if(e.graphics.set(r,t),e.active){const i=new I(e,t);this._labels.set(r,i),e.labelsToInitialize.set(r,i)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const r=t.graphic.uid,i=this._labels.get(r);if(!i)return!0;for(const r of i.graphics3DGraphic.labelLayers)if(null!=r.labelClass&&!e.labelClassContexts[r.labelClassContextIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(r,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const r=t.graphic.uid,i=this._labels.get(r);e.graphics.delete(r),i&&(this._destroyGraphic(i,r),e.labelsToInitialize.delete(r),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const r of t){const t=e.graphics.get(r);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const r of t.labelClassContexts){const i=new Map;t.graphics.forEach((e=>i.set(e.graphic.uid,e)));const s=e=>e.labelLayers[0];if(r.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,i,s),r.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[r.calloutSymbolLayerIndex];r.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,i,t)}}}_visibilityInfoChange(e){const t=B(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,r)=>{const i=this._labels.get(r);i&&(this._destroyGraphic(i,r),i.visible=!1,e.labelsToInitialize.set(r,i))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,r){const i=r?.emptySymbolLabelSupported||!1,s=r?.elevationInfoOverride||null,n=r?.disablePlacement||null;if(this._findLabelingContext(e))return;const o=e.layer,a=new F(this.view.stage,o,e,t,i,s,n,B(o));return this._labelingContexts.push(a),this.setDirty(),{addGraphic:e=>this._addGraphic(a,e),removeGraphic:e=>this._removeGraphic(a,e),updateGraphicGeometry:e=>this._updateGraphicGeometry(a,e),layerLabelsEnabled:()=>B(a.layer),labelingInfoChange:e=>this._labelingInfoChange(a,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",a),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",a),visibilityInfoChange:()=>this._visibilityInfoChange(a),reset:()=>this._resetLabels(a),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const r=this._labelingContexts.indexOf(t);this._labelingContexts.splice(r,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}_updateScaleVisibility(){for(const e of this._labelingContexts)if(e.active&&!N(e))for(const t of e.labelClassContexts)this._updateLabelClassContextVisibility(t)}_updateLabelClassContextVisibility(e){if(!E.hasLayerBasedScaleVisibility())return;const{labelClass:t,graphics:r}=e,i={minScale:t.minScale,maxScale:t.maxScale},s=E.isInEffectiveScaleRange(i,this.view.scale),n=null==e.scaleVisibility||e.scaleVisibility!==s;e.scaleVisibility=s,n&&r.size&&(r.forEach((e=>e.setVisibilityFlag(g.VisibilityGroup.LABEL,g.VisibilityFlag.SCALE_RANGE,s))),this.deconflictor.setDirty(),this.setDirty())}setLabelGraphicVisibility(e,t){const r=e.graphic.uid,i=this._labels.get(r);i&&i.visible!==t&&(t&&!i.textureAtlasHandles.length?(this._addLabelTextureToAtlas(i),i.textInitialized||i.labelingContext.labelsToInitialize.set(r,i)):!t&&i.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(i),i.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>N(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(N(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){}},t.__decorate([c.property({constructOnly:!0})],e.Labeler.prototype,"view",void 0),t.__decorate([c.property({constructOnly:!0})],e.Labeler.prototype,"deconflictor",void 0),t.__decorate([c.property()],e.Labeler.prototype,"_textTextureAtlas",void 0),t.__decorate([c.property({type:Boolean,readOnly:!0})],e.Labeler.prototype,"updating",null),e.Labeler=t.__decorate([d.subclass("esri.views.3d.layers.graphics.Labeler")],e.Labeler);const G=new _.LineCalloutCreationContext(null,null,null);e.areLabelsVisible=B,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/hydratedFeatures":function(){define(["exports","../../Graphic","../../core/has","../../core/lang","../../core/typedArrayUtil","../../geometry/SpatialReference","../../geometry/support/jsonUtils","./dehydratedPoint"],(function(e,t,r,i,s,n,o,a){"use strict";function l(e){return"declaredClass"in e}function c(e){return"declaredClass"in e}function u(e){return"declaredClass"in e}function d(e){return null==e?null:l(e)?e:o.fromJSON(function(e){const{wkid:t,wkt:r,wkt2:i,latestWkid:s}=e.spatialReference,n={wkid:t,wkt:r,wkt2:i,latestWkid:s};switch(e.type){case"point":{const{x:t,y:r,z:i,m:s}=e;return{x:t,y:r,z:i,m:s,spatialReference:n}}case"polygon":{const{rings:t,hasZ:r,hasM:i}=e;return{rings:h(t),hasZ:r,hasM:i,spatialReference:n}}case"polyline":{const{paths:t,hasZ:r,hasM:i}=e;return{paths:h(t),hasZ:r,hasM:i,spatialReference:n}}case"extent":{const{xmin:t,xmax:r,ymin:i,ymax:s,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:u,hasM:d}=e;return{xmin:t,xmax:r,ymin:i,ymax:s,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:u,hasM:d,spatialReference:n}}case"multipoint":{const{points:t,hasZ:r,hasM:i}=e;return{points:m(t)?p(t):t,hasZ:r,hasM:i,spatialReference:n}}default:return}}(e))}function h(e){return function(e){for(const t of e)if(0!==t.length)return m(t);return!1}(e)?e.map((e=>p(e))):e}function p(e){return e.map((e=>Array.from(e)))}function m(e){return e.length>0&&(s.isFloat32Array(e[0])||s.isFloat64Array(e[0]))}e.clonePoint=function(e,t){if(!e)return null;let r;if(c(e)){if(null==t)return e.clone();if(c(t))return t.copy(e)}return null!=t?(r=t,r.x=e.x,r.y=e.y,r.spatialReference=e.spatialReference,e.hasZ?(r.z=e.z,r.hasZ=e.hasZ):(r.z=void 0,r.hasZ=!1),e.hasM?(r.m=e.m,r.hasM=!0):(r.m=void 0,r.hasM=!1)):(r=a.makeDehydratedPoint(e.x,e.y,e.z,e.spatialReference),e.hasM&&(r.m=e.m,r.hasM=!0)),r},e.hydrateGeometry=d,e.hydrateGraphic=function(e,r){return e?u(e)?e:new t({layer:r,sourceLayer:r,visible:e.visible,symbol:i.clone(e.symbol),attributes:i.clone(e.attributes),geometry:d(e.geometry)}):null},e.hydratedSpatialReference=function(e){const{wkid:t,wkt:r,wkt2:i,latestWkid:s}=e,o={wkid:t,wkt:r,wkt2:i,latestWkid:s};return n.fromJSON(o)},e.isHydratedGeometry=l,e.isHydratedGraphic=u,e.isHydratedPoint=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/labelFormatUtils":function(){define(["exports","../../core/Error","../../core/Logger","../../core/sql","../../intl/date","../../intl/number","./domainUtils","./fieldUtils","./labelUtils","../../support/ArcadeExpression","../../support/arcadeExpressionUtils"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=()=>r.getLogger("esri.layers.support.labelFormatUtils"),h={type:"simple",evaluate:()=>null},p={getAttribute:(e,t)=>e.field(t)};function m(e,t){if(null==e)return"";const r=t.domain;if(r)if("codedValue"===r.type||"coded-value"===r.type){const t=e;for(const e of r.codedValues)if(e.code===t)return e.name}else if("range"===r.type){const{max:i,min:s}=o.getDomainRange(t),n=+e;if(null!=s&&null!=i&&s<=n&&n<=i)return r.name}let i=e;return a.isDateField(t)?i=s.formatDate(i,s.convertDateFormatToIntlOptions("short-date")):a.isNumericField(t)&&(i=n.formatNumber(+i)),i||""}e.createLabelFunction=async function(e,r,s){if(!e||!e.symbol||!r)return h;const n=e.where,o=l.getLabelExpression(e);let f;if("arcade"===o.type){const e=u.getFieldNameFromSimpleExpression(o.expression),i=r.get(e);if(i&&(a.isIntegerField(i)||a.isNumericField(i)||a.isStringField(i)))f={type:"simple",evaluate(e){const t="attributes"in e?e.attributes?.[i.name]:e.field(i.name);return null==t?"":t.toString()}};else{const e=await c.createLabelExpression(o.expression,s);if(null==e)return h;f={type:"arcade",evaluate(i,s){try{const t="attributes"in i?e.repurposeFeature(i,r):i;t.contextTimeZone=s??null;const n=e.evaluate(t,{$view:{timeZone:s}});if(null!=n)return n.toString()}catch(e){d().error(new t("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:e,feature:i,expression:o}))}return null},needsHydrationToEvaluate:()=>null==l.getSingleFieldArcadeExpression(o.expression)}}}else f={type:"simple",evaluate:e=>o.expression.replaceAll(/{[^}]*}/g,(t=>{const i=t.slice(1,-1),s=r.get(i);if(!s)return t;let n=null;return n="attributes"in e?e?.attributes?.[s.name]:e.field(s.name),null==n?"":m(n,s)}))};if(n){let e;try{e=await i.parseWhereClause(n,r)}catch(e){return d().error(new t("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:n,error:e})),h}const s=f.evaluate;f.evaluate=(r,i)=>{const o="attributes"in r?void 0:p;try{if(e.testFeature(r,o))return s(r,i)}catch(e){d().error(new t("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:n,feature:r,error:e}))}return null}}return f},e.formatField=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DCalloutSymbolLayerFactory":function(){define(["exports","../../../../core/Logger","../../../../symbols/callouts/calloutUtils","./Graphics3DLineCalloutSymbolLayer"],(function(e,t,r,i){"use strict";const s=()=>t.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory"),n={line:i.Graphics3DLineCalloutSymbolLayer};e.make=function(e,t){if(!r.hasCalloutSupport(e))return s().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=n[e.callout.type];return i?new i(e,t):(s().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DLineCalloutSymbolLayer":function(){define(["exports","../../../../Color","../../../../core/has","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../renderers/support/RenderingInfo","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./elevationAlignmentUtils","./ElevationContext","./Graphics3DGraphicCreationContext","./Graphics3DObject3DGraphicLayer","./Graphics3DObjectMetadata","./Graphics3DSymbolLayer","./graphicUtils","./pointUtils","./SymbolComplexity","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/LineCalloutMaterial","../../webgl-engine/lib/IntersectableGeometry"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w){"use strict";class x extends m.Graphics3DSymbolLayer{static{this.elevationModeChangeTypes={definedChanged:c.SymbolUpdateType.UPDATE,staysOnTheGround:c.SymbolUpdateType.UPDATE,onTheGroundChanged:c.SymbolUpdateType.RECREATE}}constructor(e,t){super(e,null,t,P),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new S.LineCalloutMaterial(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new S.Parameters,s=this.symbol,o=s.callout;if(o.color){const r=t.toUnitRGBA(o.color);r[3]*=this._getLayerOpacity(),e.color=r}else e.color=n.ZEROS;if(e.size=i.pt2px(o.size||0),s.verticalOffset){const{screenLength:t,minWorldLength:r,maxWorldLength:n}=s.verticalOffset;e.verticalOffset={screenLength:i.pt2px(t),minWorldLength:r||0,maxWorldLength:null!=n?n:1/0}}e.borderColor=null!=o.border?.color?t.toUnitRGBA(o.border.color):null;const a="object"===s.symbolLayers.at(0).type,l="label-3d"===s.type;return e.occlusionTest=!a&&!r("enable-feature:non-occluded-hud"),a&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=l,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return C}createGraphics3DGraphic(e,t){const r=e.renderingInfo,i=e.graphic,s=this.setGraphicElevationContext(i,new u.ElevationContext,r.elevationOffset||0),n=r.symbol,o="on-the-ground"===this._elevationContext.mode&&("cim"===n.type||!n.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==n.type&&o)return null;if("point-3d"===n.type&&n.symbolLayers.every((e=>"text"===e.type&&!a.textSymbolLayerSupportsVerticalOffset(e))))return null;const l=f.computeCentroid(i.geometry);return null==l?null:this._createAs3DShape(l,s,r,i.uid,t)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,r){const i=this._elevationContext.mode,s=c.elevationModeChangeUpdateType(x.elevationModeChangeTypes,r,i);return s!==c.SymbolUpdateType.UPDATE||e?.forEach((e=>{const r=t(e);null!=r&&this.updateGraphicElevationContext(e.graphic,r)})),s}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,r=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(r),t}updateGraphicElevationContext(e,t){const{elevationContext:r,metadata:i}=t;this.setGraphicElevationContext(e,r,i?.elevationOffset??0),t.needsElevationUpdates=c.needsElevationUpdates2D(r.mode)}computeComplexity(){return new y.SymbolComplexity({verticesPerFeature:6})}_getOrCreateMaterial(e,t){const r=this._perInstanceMaterialParameters(e),i=S.uniqueMaterialIdentifier(r);if(i===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let e=t.get(i);return null==e&&(e=new S.LineCalloutMaterial(r,this._context.spherical),t.set(i,e)),e}return new S.LineCalloutMaterial(r,this._context.spherical)}_createAs3DShape(e,t,r,i,s){const n=this._context.layerViewUid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:n}),a=this._getOrCreateMaterial(r,s),u=new b.Geometry(a,function(e){const{translation:t,centerOffset:r}=e,i=t?new _.Attribute([t[0],t[1],t[2]],T,3,!0):new _.Attribute([0,0,0],T,3,!0),s=r?new _.Attribute([r[0],r[1],r[2],r[3]],T,4,!0):new _.Attribute([0,0,0,1],T,4,!0);return[[v.VertexAttribute.POSITION,i],[v.VertexAttribute.NORMAL,new _.Attribute([0,0,1],T,3,!0)],[v.VertexAttribute.CENTEROFFSETANDDISTANCE,s]]}(r),null,w.GeometryType.Point,o),d=g.createStageObject(this._context,e,u,t,i);if(null==d)return null;const m=new h.Graphics3DObject3DGraphicLayer(this,d.object,null,l.perObjectElevationAligner,t);return m.metadata=new p.Graphics3DObjectMetadata(r.elevationOffset),m.alignedSampledElevation=d.sampledElevation,m.needsElevationUpdates=c.needsElevationUpdates2D(t.mode),g.extendPointGraphicElevationContext(m,e,this._context.elevationProvider),m}}const T=[0],C={mode:"relative-to-ground",offset:0},P={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class M extends o.RenderingInfo{constructor(e,t,r=s.create(),i=n.create(),o=0,a="world",l=0){super(e,t),this.translation=r,this.centerOffset=i,this.horizontalScreenOffset=o,this.centerOffsetUnits=a,this.elevationOffset=l}}class R extends d.Graphics3DGraphicCreationContext{}e.Graphics3DLineCalloutSymbolLayer=x,e.LineCalloutCreationContext=R,e.LineCalloutSymbolLayerRenderingInfo=M,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/renderers/support/RenderingInfo":function(){define(["exports"],(function(e){"use strict";e.RenderingInfo=class{constructor(e,t){this.renderer=e,this.symbol=t,this.color=null,this.size=null,this.opacity=null,this.outlineSize=null,this.heading=null,this.tilt=null,this.roll=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/ElevationAligners":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/projection/projectBuffer","./elevationAlignmentUtils","../../support/debugFlags","../../support/ElevationProvider","../../webgl-engine/lib/GeometryWithMapPositions","../../webgl-engine/lib/VertexAttribute"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=r.create(),p=.01,m=s.create(),f=s.create(),g=s.create(),y=r.create(),_=s.create(),b=new a.SampleElevationInfo;function v(e,t,r,i,s){let n=!1;const a=e.transformation,u=t.requiresSampledElevationInfo;f[0]=a[12],f[1]=a[13],f[2]=a[14],e.invalidateBoundingInfo();const h=e.getMutableAttribute(d.VertexAttribute.POSITION),y=h.data,_=h.size,v=y.length/_,S=new c.SamplePosition(e.mapPositions,r);let w=0,x=0;for(let e=0;e<v;e++){if(g[0]=y[w],g[1]=y[w+1],g[2]=y[w+2],i(S,b),u&&(x+=b.sampledElevation),l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS)y[w]=S.array[S.offset],y[w+1]=S.array[S.offset+1],y[w+2]=b.z,o.projectBuffer(y,r,w,y,s.spatialReference,w,1),y[w]-=f[0],y[w+1]-=f[1],y[w+2]-=f[2],n=!0;else{m[0]=y[w]+f[0],m[1]=y[w+1]+f[1],m[2]=y[w+2]+f[2],s.setAltitude(m,b.z),y[w]=m[0]-f[0],y[w+1]=m[1]-f[1],y[w+2]=m[2]-f[2];const e=p/s.unitInMeters;(Math.abs(g[0]-y[w])>=e||Math.abs(g[1]-y[w+1])>=e||Math.abs(g[2]-y[w+2])>=e)&&(n=!0)}w+=_,S.offset+=3}return x/=v,{update:n,averageGeometrySampledElevation:x}}e.perLodInstanceElevationAligner=function(e,t,r,s,o){const a=e.graphics3DSymbolLayer.lodRenderer;if(null==a)return 0;const c=t.centerPointInElevationSR;s(c,b);const u="absolute-height"!==t.mode?b.sampledElevation:0,d=a.instanceData,h=e.instanceIndex,f=y;d.getGlobalTransform(h,f);const g=i.set(_,f[12],f[13],f[14]);l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(m[0]=c.x,m[1]=c.y,m[2]=b.z,n.computeTranslationToOriginAndRotation(c.spatialReference,m,f,o.spatialReference)&&d.setGlobalTransform(h,f)):o.setAltitudeOfTransformation(b.z,f);const v=p/o.unitInMeters;return(l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(f[12]-g[0])>=v||Math.abs(f[13]-g[1])>=v||Math.abs(f[14]-g[2])>=v)&&d.setGlobalTransform(h,f),u},e.perObjectElevationAligner=function(e,r,s,o,c,u){const d=e.stageObject,f=r.centerPointInElevationSR;let g=0;d.usesVerticalDistanceToGround?(o(f,b),a.updateVertexPointGroundDistance(d,b.verticalDistanceToGround),g=b.sampledElevation):(o(f,b),"absolute-height"!==r.mode&&(g=b.sampledElevation));const y=t.copy(h,u??d.transformation),v=i.set(_,y[12],y[13],y[14]);l.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(m[0]=f.x,m[1]=f.y,m[2]=b.z,n.computeTranslationToOriginAndRotation(f.spatialReference,m,y,c.spatialReference)&&(u?t.copy(u,y):d.transformation=y)):c.setAltitudeOfTransformation(b.z,y);const S=p/c.unitInMeters;return(Math.abs(y[12]-v[0])>=S||Math.abs(y[13]-v[1])>=S||Math.abs(y[14]-v[2])>=S)&&(u?t.copy(u,y):d.transformation=y),g},e.perVertexElevationAligner=function(e,t,r,i,s){const n=e.stageObject,o=n.geometries;let a=0;for(const e of o){if(!u.isGeometryWithMapPositions(e))continue;const{update:o,averageGeometrySampledElevation:l}=v(e,t,r,i,s);a+=l,o&&n.geometryVertexAttributeUpdated(e,d.VertexAttribute.POSITION)}return a/o.length},e.sharedGeometryElevationAligner=function(e,t,r,i,s){const n=e.stageObject,o=n.geometries;if(0===o.length)return 0;let a=0,l=null,c=0,h=!1;for(const e of o){if(!u.isGeometryWithMapPositions(e))continue;const o=e.attributes.get(d.VertexAttribute.POSITION);if(o!==l){const{update:n,averageGeometrySampledElevation:a}=v(e,t,r,i,s);c=a,l=o,h=n}h&&n.geometryVertexAttributeUpdated(e,d.VertexAttribute.POSITION),a+=c}return a/o.length},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/elevationAlignmentUtils":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/computeTranslationToOriginAndRotation","../../../../geometry/projection/projectBuffer","../../../../layers/graphics/dehydratedFeatureUtils","../../support/ElevationProvider","../../webgl-engine/lib/VertexAttribute"],(function(e,t,r,i,s,n,o,a,l){"use strict";function c(e,t,r,i,s){const n=(o.isDehydratedPoint(e)?e.z:a.isSamplePosition(e)?e.array[e.offset+2]:e[2])||0;switch(r.mode){case"on-the-ground":{const r=a.getElevationAtPoint(t,e,"ground")??0;return s.verticalDistanceToGround=0,s.sampledElevation=r,void(s.z=r)}case"relative-to-ground":{const o=a.getElevationAtPoint(t,e,"ground")??0,l=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=l,s.sampledElevation=o,void(s.z=l+o)}case"relative-to-scene":{const o=a.getElevationAtPoint(t,e,"scene")??0,l=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=l,s.sampledElevation=o,void(s.z=l+o)}case"absolute-height":{const o=r.geometryZWithOffset(n,i),l=a.getElevationAtPoint(t,e,"ground")??0;return s.verticalDistanceToGround=o-l,s.sampledElevation=l,void(s.z=o)}default:return void(s.z=0)}}function u(e,t){for(let r=0;r<e.geometries.length;++r){const i=e.geometries[r].getMutableAttribute(l.VertexAttribute.CENTEROFFSETANDDISTANCE);i&&i.data[3]!==t&&(i.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[r],l.VertexAttribute.CENTEROFFSETANDDISTANCE))}}class d{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var h;e.SymbolUpdateType=void 0,(h=e.SymbolUpdateType||(e.SymbolUpdateType={}))[h.NONE=0]="NONE",h[h.UPDATE=1]="UPDATE",h[h.RECREATE=2]="RECREATE";const p={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,r,i,s,n,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;t*=3,i*=3;for(let n=0;n<s;++n){const s=e[t],n=e[t+1],o=e[t+2];r[i]=s,r[i+1]=n,r[i+2]=null==c?o+l:l,t+=3,i+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,r=e.featureExpressionInfoContext;return 0!==t||null!=r}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,s,n){let o=0;const a=n.spatialReference;t*=3,i*=3;for(let l=0;l<s;++l){const s=e[t],l=e[t+1],c=e[t+2],u=n.getElevation(s,l,c,a,"ground")??0;o+=u,r[i]=s,r[i+1]=l,r[i+2]=u,t+=3,i+=3}return o/s},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),u=a.featureExpressionInfoContext,d=n.spatialReference;t*=3,i*=3;for(let o=0;o<s;++o){const s=e[t],o=e[t+1],a=e[t+2],h=n.getElevation(s,o,a,d,"ground")??0;l+=h,r[i]=s,r[i+1]=o,r[i+2]=null==u?a+h+c:h+c,t+=3,i+=3}return l/s},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),u=a.featureExpressionInfoContext,d=n.spatialReference;t*=3,i*=3;for(let o=0;o<s;++o){const s=e[t],o=e[t+1],a=e[t+2],h=n.getElevation(s,o,a,d,"scene")??0;l+=h,r[i]=s,r[i+1]=o,r[i+2]=null==u?a+h+c:h+c,t+=3,i+=3}return l/s},requiresAlignment:()=>!0}},m=r.create(),f=new d,g=i.create();e.SampleElevationInfo=d,e.applyElevationAlignmentForHUD=function(e,r,i,n,o){c(r,i,o,n,f),u(e,f.verticalDistanceToGround);const a=f.sampledElevation,l=t.copy(m,e.transformation);return g[0]=r.x,g[1]=r.y,g[2]=f.z,s.computeTranslationToOriginAndRotation(r.spatialReference,g,l,n.spatialReference)?e.transformation=l:console.warn("Could not locate symbol object properly, it might be misplaced"),a},e.applyPerVertexElevationAlignment=function(e,t,r,i,s,o,a,l,c,u,d){const h=p[d.mode];let m,f,g=0;if(n.projectBuffer(e,t,r,i,c.spatialReference,s,l))return h?.requiresAlignment(d)?(g=h.applyElevationAlignmentBuffer(i,s,o,a,l,c,u,d),m=o,f=a):(m=i,f=s),n.projectBuffer(m,c.spatialReference,f,o,u.spatialReference,a,l)?g:void 0},e.elevationModeChangeUpdateType=function(t,r,i){return"on-the-ground"===r&&"on-the-ground"===i?t.staysOnTheGround:r===i||"on-the-ground"!==r&&"on-the-ground"!==i?null==r||null==i?t.definedChanged:e.SymbolUpdateType.UPDATE:t.onTheGroundChanged},e.evaluateElevationAlignmentAtPoint=function(e,t,r,i){return c(e,t,r,i,f),f.z},e.evaluateElevationInfoAtPoint=c,e.needsElevationUpdates2D=function(e){return"relative-to-ground"===e||"relative-to-scene"===e},e.needsElevationUpdates3D=function(e){return"absolute-height"!==e},e.updateVertexPointGroundDistance=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/GeometryWithMapPositions":function(){define(["exports","./Geometry"],(function(e,t){"use strict";class r extends t.Geometry{}e.GeometryWithMapPositions=r,e.isGeometryWithMapPositions=function(e){return null!=e.mapPositions},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Geometry":function(){define(["exports","../../../../core/uid","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../geometry/support/Indices","./AttributeArray","./BoundingInfo","./geometryDataUtils","./IntersectableGeometry","./Object3DStateID","./Util","./VertexAttribute","../../../webgl/checkWebGLError"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p{constructor(e,r,i=null,n=l.GeometryType.Mesh,o=null,a=-1){this.material=e,this.mapPositions=i,this.type=n,this.objectAndLayerIdColor=o,this.edgeIndicesLength=a,this.highlights=new Set,this._highlightOptionsCounts=new Map,this.id=t.generateUID(),this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[e,t]of r)this._attributes.set(e,{...t,indices:s.compactIndices(t.indices)}),e===d.VertexAttribute.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(e).indices.length:this.edgeIndicesLength)}instantiate(e={}){const t=new p(e.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach(((e,r)=>{e.exclusive=!1,t._attributes.set(r,e)})),t._boundingInfo=this._boundingInfo,t.transformation=e.transformation||this.transformation,t}get attributes(){return this._attributes}getMutableAttribute(e){let t=this._attributes.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:n.cloneAttributeData(t.data)},this._attributes.set(e,t)),t}setAttributeData(e,t){const r=this._attributes.get(e);r?this._attributes.set(e,{...r,exclusive:!0,data:t}):h.webglDebugEnabled()&&console.warn(`Setting undefined attribute ${e} data`)}get indexCount(){const e=this._attributes.values().next().value?.indices;return e?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??=this._calculateBoundingInfo(),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===l.GeometryType.Mesh?this._computeAttachmentOriginTriangles(e):this.type===l.GeometryType.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(null!=this._transformation&&i.transformMat4(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){const t=this.attributes.get(d.VertexAttribute.POSITION);return a.computeAttachmentOriginTriangles(t,e)}_computeAttachmentOriginLines(e){const t=this.attributes.get(d.VertexAttribute.POSITION);return a.computeAttachmentOriginLines(t,function(e,t){return!(!("isClosed"in e)||!e.isClosed)&&t.indices.length>2}(this.material.parameters,t),e)}_computeAttachmentOriginPoints(e){const t=this.attributes.get(d.VertexAttribute.POSITION);return a.computeAttachmentOriginPoints(t,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.attributes.get(d.VertexAttribute.POSITION);if(!e||0===e.indices.length)return null;const t=this.type===l.GeometryType.Mesh?3:1;u.assert(e.indices.length%t===0,"Indexing error: "+e.indices.length+" not divisible by "+t);const r=s.getContinuousIndexArray(e.indices.length/t);return new o.BoundingInfo(r,t,e)}get transformation(){return this._transformation??r.IDENTITY}set transformation(e){this._transformation=e&&e!==r.IDENTITY?r.clone(e):null}get highlightNames(){return this._highlightOptionsCounts}get hasHighlights(){return this._highlightOptionsCounts.size>0}foreachHighlightOptions(e){this._highlightOptionsCounts.forEach(((t,r)=>e(r)))}allocateIdAndHighlight(e){const t=new c.Object3DHighlightStateID(e);return this.addHighlight(t)}addHighlight(e){this.highlights.add(e);const{highlightName:t}=e,r=(this._highlightOptionsCounts.get(t)??0)+1;return this._highlightOptionsCounts.set(t,r),e}removeHighlight(e){if(this.highlights.delete(e)){const{highlightName:t}=e,r=this._highlightOptionsCounts.get(t)??0;r<=1?this._highlightOptionsCounts.delete(t):this._highlightOptionsCounts.set(t,r-1)}}}Object.defineProperty(e,"GeometryType",{enumerable:!0,get:()=>l.GeometryType}),e.Geometry=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/Indices":function(){define(["exports","../../core/typedArrayUtil"],(function(e,t){"use strict";function r(e,r){if(Array.isArray(e)){if(e.length<t.nativeArrayMaxSize)return e}else if(e.length<t.nativeArrayMaxSize)return Array.from(e);let i=!0,s=!0;return e.some(((e,t)=>(i=i&&0===e,s=s&&e===t,!i&&!s))),i?c(e.length):s?o(e.length):t.isTypedArray(e)&&e.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT?e:function(e,r){for(const i of e){if(i>=65536)return t.isTypedArray(e)?e:new Uint32Array(e);i>=256&&(r=!1)}return r?new Uint8Array(e):new Uint16Array(e)}(e,!r)}let i=a(131072);const s=[0],n=(()=>{const e=new Uint16Array(65536);for(let t=0;t<e.length;++t)e[t]=t;return e})();function o(e){return 1===e?s:e<t.nativeArrayMaxSize?Array.from(new Uint16Array(n.buffer,0,e)):e<n.length?new Uint16Array(n.buffer,0,e):(e>i.length&&(i=a(Math.max(2*i.length,e))),new Uint32Array(i.buffer,0,e))}function a(e){const t=new Uint32Array(e);for(let e=0;e<t.length;e++)t[e]=e;return t}let l=new Uint8Array(65536);function c(e){if(1===e)return s;if(e<t.nativeArrayMaxSize)return new Array(e).fill(0);if(e>l.length){const t=Math.max(2*l.length,e);l=new Uint8Array(t)}return new Uint8Array(l.buffer,0,e)}e.compactIndices=r,e.compactMeshIndices=function(e){return r(e,!0)},e.getContinuousIndexArray=o,e.getZeroIndexArray=c,e.newIndexArray=function(e){return e<=t.nativeArrayMaxSize?new Array(e):e<=65536?new Uint16Array(e):new Uint32Array(e)},e.newIntArray=function(e){return e<=t.nativeArrayMaxSize?new Array(e):new Uint32Array(e)},e.pruneIndexArrays=function(){i=a(131072),l=new Uint8Array(65536)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/AttributeArray":function(){define(["exports","../../../../core/typedArrayUtil","../../../../geometry/support/float16"],(function(e,t,r){"use strict";e.cloneAttributeData=function(e){if(e.length<t.nativeArrayMaxSize)return Array.from(e);if(Array.isArray(e))return Float64Array.from(e);if(!("BYTES_PER_ELEMENT"in e))return Array.from(e);switch(e.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(e);case 2:return t.isFloat16Array(e)?r.getFloat16ArrayConstructor().from(e):t.isUint16Array(e)?Uint16Array.from(e):Int16Array.from(e);case 4:return Float32Array.from(e);default:return Float64Array.from(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/BoundingInfo":function(){define(["exports","../../../../core/PooledArray","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./Util"],(function(e,t,r,i,s){"use strict";class n{constructor(e,t,n){this.primitiveIndices=e,this._numIndexPerPrimitive=t,this.position=n,this._children=void 0,s.assert(e.length>=1),s.assert(3===n.size||4===n.size);const{data:a,size:l,indices:c}=n;s.assert(c.length%this._numIndexPerPrimitive===0),s.assert(c.length>=e.length*this._numIndexPerPrimitive);const u=e.length;let d=l*c[this._numIndexPerPrimitive*e[0]];o.clear(),o.push(d);const h=i.fromValues(a[d],a[d+1],a[d+2]),p=i.clone(h);for(let t=0;t<u;++t){const r=this._numIndexPerPrimitive*e[t];for(let e=0;e<this._numIndexPerPrimitive;++e){d=l*c[r+e],o.push(d);let t=a[d];h[0]=Math.min(t,h[0]),p[0]=Math.max(t,p[0]),t=a[d+1],h[1]=Math.min(t,h[1]),p[1]=Math.max(t,p[1]),t=a[d+2],h[2]=Math.min(t,h[2]),p[2]=Math.max(t,p[2])}}this.bbMin=h,this.bbMax=p;const m=r.lerp(i.create(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(p[0]-h[0],p[1]-h[1]),p[2]-h[2]);let f=this.radius*this.radius;for(let e=0;e<o.length;++e){d=o.at(e);const t=a[d]-m[0],r=a[d+1]-m[1],i=a[d+2]-m[2],s=t*t+r*r+i*i;if(s<=f)continue;const n=Math.sqrt(s),l=.5*(n-this.radius);this.radius=this.radius+l,f=this.radius*this.radius;const c=l/n;m[0]+=t*c,m[1]+=r*c,m[2]+=i*c}this.center=m,o.clear()}getChildren(){if(this._children||r.squaredDistance(this.bbMin,this.bbMax)<=1)return this._children;const e=r.lerp(i.create(),this.bbMin,this.bbMax,.5),t=this.primitiveIndices.length,s=new Uint8Array(t),o=new Array(8);for(let e=0;e<8;++e)o[e]=0;const{data:a,size:l,indices:c}=this.position;for(let r=0;r<t;++r){let t=0;const i=this._numIndexPerPrimitive*this.primitiveIndices[r];let n=l*c[i],u=a[n],d=a[n+1],h=a[n+2];for(let e=1;e<this._numIndexPerPrimitive;++e){n=l*c[i+e];const t=a[n],r=a[n+1],s=a[n+2];t<u&&(u=t),r<d&&(d=r),s<h&&(h=s)}u<e[0]&&(t|=1),d<e[1]&&(t|=2),h<e[2]&&(t|=4),s[r]=t,++o[t]}let u=0;for(let e=0;e<8;++e)o[e]>0&&++u;if(u<2)return;const d=new Array(8);for(let e=0;e<8;++e)d[e]=o[e]>0?new Uint32Array(o[e]):void 0;for(let e=0;e<8;++e)o[e]=0;for(let e=0;e<t;++e){const t=s[e];d[t][o[t]++]=this.primitiveIndices[e]}this._children=new Array;for(let e=0;e<8;++e)void 0!==d[e]&&this._children.push(new n(d[e],this._numIndexPerPrimitive,this.position));return this._children}static prune(){o.prune()}}const o=new t({deallocator:null});e.BoundingInfo=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/geometryDataUtils":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/triangle"],(function(e,t,r,i){"use strict";const s=r.create(),n=r.create(),o=r.create(),a=r.create();e.computeAttachmentOriginLines=function(e,r,i){if(!e)return!1;t.set(i,0,0,0),t.set(a,0,0,0);let o=0,l=0;const{size:c,data:u,indices:d}=e,h=d.length-1,p=h+(r?2:0);for(let e=0;e<p;e+=2){const r=e<h?e+1:0,p=d[e<h?e:h]*c,m=d[r]*c;s[0]=u[p],s[1]=u[p+1],s[2]=u[p+2],n[0]=u[m],n[1]=u[m+1],n[2]=u[m+2],t.scale(s,t.add(s,s,n),.5);const f=t.dist(s,n);f>0?(t.add(i,i,t.scale(s,s,f)),o+=f):0===o&&(t.add(a,a,s),l++)}return 0!==o?(t.scale(i,i,1/o),!0):0!==l&&(t.scale(i,a,1/l),!0)},e.computeAttachmentOriginPoints=function(e,r){if(!e)return!1;const{size:i,data:s,indices:n}=e;t.set(r,0,0,0);let o=-1,a=0;for(let e=0;e<n.length;e++){const t=n[e]*i;o!==t&&(r[0]+=s[t],r[1]+=s[t+1],r[2]+=s[t+2],a++),o=t}return a>1&&t.scale(r,r,1/a),a>0},e.computeAttachmentOriginTriangles=function(e,r){if(!e)return!1;const{size:l,data:c,indices:u}=e;t.set(r,0,0,0),t.set(a,0,0,0);let d=0,h=0;for(let e=0;e<u.length-2;e+=3){const p=u[e]*l,m=u[e+1]*l,f=u[e+2]*l;t.set(s,c[p],c[p+1],c[p+2]),t.set(n,c[m],c[m+1],c[m+2]),t.set(o,c[f],c[f+1],c[f+2]);const g=i.areaPoints3d(s,n,o);g?(t.add(s,s,n),t.add(s,s,o),t.scale(s,s,1/3*g),t.add(r,r,s),d+=g):(t.add(a,a,s),t.add(a,a,n),t.add(a,a,o),h+=3)}return!(0===h&&0===d||(0!==d?(t.scale(r,r,1/d),0):0===h||(t.scale(r,a,1/h),0)))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/triangle":function(){define(["exports","../../core/ObjectStack","../../chunks/vec32","../../core/libs/gl-matrix-2/factories/vec3f64","./lineSegment","./vectorStacks"],(function(e,t,r,i,s,n){"use strict";function o(e){return e?{p0:i.clone(e.p0),p1:i.clone(e.p1),p2:i.clone(e.p2)}:{p0:i.create(),p1:i.create(),p2:i.create()}}function a(e,t,i,s=o()){return r.copy(s.p0,e),r.copy(s.p1,t),r.copy(s.p2,i),s}const l=new t.ObjectStack(s.create),c=new t.ObjectStack((()=>o())),u=i.create(),d=i.create();e.areaPoints2d=function(e,t,r){const i=t[0]-e[0],s=t[1]-e[1],n=r[0]-e[0],o=r[1]-e[1];return.5*Math.abs(i*o-s*n)},e.areaPoints3d=function(e,t,i){return r.subtract(u,t,e),r.subtract(d,i,e),.5*r.length(r.cross(u,u,d))},e.copy=function(e,t=o()){return a(e.p0,e.p1,e.p2,t)},e.create=o,e.distance2=function(e,t){const i=e.p0,o=e.p1,a=e.p2,c=r.subtract(n.sv3d.get(),o,i),u=r.subtract(n.sv3d.get(),a,o),d=r.subtract(n.sv3d.get(),i,a),h=r.subtract(n.sv3d.get(),t,i),p=r.subtract(n.sv3d.get(),t,o),m=r.subtract(n.sv3d.get(),t,a),f=r.cross(c,c,d),g=r.dot(r.cross(n.sv3d.get(),c,f),h),y=r.dot(r.cross(n.sv3d.get(),u,f),p),_=r.dot(r.cross(n.sv3d.get(),d,f),m);if(g>0&&y>0&&_>0){const e=r.dot(f,h);return e*e/r.dot(f,f)}const b=s.distance2(s.fromValues(i,c,l.get()),t),v=s.distance2(s.fromValues(o,u,l.get()),t),S=s.distance2(s.fromValues(a,d,l.get()),t);return Math.min(b,v,S)},e.fromValues=a,e.intersectRay=function(e,t,i){const{direction:s,origin:n}=t,{p0:o,p1:a,p2:l}=e,c=a[0]-o[0],u=a[1]-o[1],d=a[2]-o[2],h=l[0]-o[0],p=l[1]-o[1],m=l[2]-o[2],f=s[1]*m-p*s[2],g=s[2]*h-m*s[0],y=s[0]*p-h*s[1],_=c*f+u*g+d*y;if(_>-1e-5&&_<1e-5)return!1;const b=1/_,v=n[0]-o[0],S=n[1]-o[1],w=n[2]-o[2],x=b*(v*f+S*g+w*y);if(x<0||x>1)return!1;const T=S*d-u*w,C=w*c-d*v,P=v*u-c*S,M=b*(s[0]*T+s[1]*C+s[2]*P);if(M<0||x+M>1)return!1;if(i){const e=b*(h*T+p*C+m*P);r.scale(i,s,e),r.add(i,n,i)}return!0},e.wrap=function(e,t,r){const i=c.get();return i.p0=e,i.p1=t,i.p2=r,i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/IntersectableGeometry":function(){define(["exports"],(function(e){"use strict";var t;e.GeometryType=void 0,(t=e.GeometryType||(e.GeometryType={}))[t.Mesh=0]="Mesh",t[t.Point=1]="Point",t[t.Line=2]="Line",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Object3DStateID":function(){define(["exports","../../../../core/uid","./basicInterfaces"],(function(e,t,r){"use strict";class i{constructor(){this.uid=t.generateUID()}}e.Object3DHighlightStateID=class extends i{constructor(e){super(),this.highlightName=e,this.channel=r.Object3DState.Highlight}},e.Object3DOccludeeStateID=class extends i{constructor(){super(...arguments),this.channel=r.Object3DState.MaskOccludee}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/ElevationContext":function(){define(["exports","../../../../symbols/support/unitConversionUtils","./featureExpressionInfoUtils"],(function(e,t,r){"use strict";class i{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=t.getMetersPerUnit(e)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const r=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?r:e+r}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return null!=i&&(t+=r.execute(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=t.supportsUnit(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,t,i){if(null==e)return void(this._featureExpressionInfoContext=null);const s=e?.arcade;s&&null!=t&&null!=i?(this._featureExpressionInfoContext=r.clone(e),r.setContextFeature(this._featureExpressionInfoContext,r.createFeature(s.modules,t,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new i;return null!=e&&t.setFromElevationInfo(e),t}}e.ElevationContext=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/featureExpressionInfoUtils":function(){define(["exports","../../../../core/Logger","../../../../core/promiseUtils","../../../../layers/graphics/hydratedFeatures","../../../../support/loadArcade"],(function(e,t,r,i,s){"use strict";function n(e){return null!=e.cachedResult}function o(e){return"0"===e?0:null}e.clone=function(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}},e.createContext=async function(e,t,i,n){const a=e?.expression;if("string"!=typeof a)return null;const l=o(a);if(null!=l)return{cachedResult:l};const c=await s.loadArcade();r.throwIfAborted(i);const u=c.arcadeUtils,d=u.createSyntaxTree(a);return u.dependsOnView(d)?(null!=n&&n.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:u.createFunction(d),context:u.createExecContext(null,{sr:t}),modules:c}}},e.createContextWithoutExpressionSupport=function(e){const t=e?.expression;if("string"==typeof t){const e=o(t);if(null!=e)return{cachedResult:e}}return null},e.createFeature=function(e,t,r){return e.arcadeUtils.createFeature(t.attributes,t.geometry,r)},e.execute=function(e){if(null!=e){if(n(e))return e.cachedResult;const t=e.arcade;let r=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof r&&(e.cachedResult=0,r=0),r}return 0},e.extractExpressionInfo=function(e,t=!1){let r=e?.featureExpressionInfo;const i=r?.expression;return t||"0"===i||(r=null),r??null},e.setContextFeature=function(e,r){if(null!=e&&!n(e)){if(!r||!e.arcade)return void t.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils").errorOncePerTick("Arcade support required but not provided");const s=r;s._geometry&&(s._geometry=i.hydrateGeometry(s._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,r)}},e.zeroContext={cachedResult:0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DGraphicCreationContext":function(){define(["exports"],(function(e){"use strict";e.Graphics3DGraphicCreationContext=class{constructor(e,t,r){this.graphic=e,this.renderingInfo=t,this.layer=r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DObject3DGraphicLayer":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../chunks/sphere","./elevationAlignmentUtils","./featureExpressionInfoUtils","./graphicUtils","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/edgeRendering/interfaces"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e){return e.transparent?c.Transparency.TRANSPARENT:c.Transparency.OPAQUE}const d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],h=r.create(),p=r.create(),m=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];e.Graphics3DObject3DGraphicLayer=class{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,r,i,s,n=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._sharedResource=r,this.elevationAligner=i,this.elevationContext=s,this._edgeState=n,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}layerOpacityChanged(e,t){const{stageObject:r,_edgeState:i,_stageLayer:s}=this;if(null==i)return;const n=u(i.baseMaterial);i.edgeMaterial.objectTransparency!==n&&(i.edgeMaterial.objectTransparency=n,this.resetEdgeObject(t)),s.stage.renderer.withEdgeView((t=>t.updateAllComponentOpacities(r,[e])))}updateHighlights(e){}slicePlaneEnabledChanged(e,t){const{stageObject:r,_edgeState:i,_stageLayer:s}=this;null!=i&&s.stage.renderer.withEdgeView((s=>{s.updateAllComponentMaterials(r,i.edgeMaterial,e,!t),i.hasSlicePlane=e}))}setVisibility(e){const{_edgeState:t,stageObject:r,_stageLayer:i}=this;null!=i&&this.visible!==e&&(this._visible=e,r.visible=e,e&&!this._addedToStage&&(i.add(r),this._addedToStage=!0),null!=t&&i.stage.renderer.withEdgeView((i=>{i.hasObject(r)?i.updateObjectVisibility(r,e):e&&this._addOrUpdateEdgeObject(t,i,!1)})))}get visible(){return this._visible}alignWithElevation(e,t,r,i){null!=this.elevationAligner&&(null!=r&&o.setContextFeature(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,((r,i)=>n.evaluateElevationInfoAtPoint(r,e,this.elevationContext,t,i)),t),this.resetEdgeObject(i))}alignWithAbsoluteElevation(e,t,r){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,((t,r)=>{r.sampledElevation=e,r.verticalDistanceToGround=0,r.z=e}),t),this.resetEdgeObject(r)}getCenterObjectSpace(e=r.create()){return t.copy(e,s.getCenter(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=i.create()){const t=this.stageObject.boundingVolumeObjectSpace;return i.setMin(e,t.min),i.setMax(e,t.max),e}computeAttachmentOrigin(e){const r=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=r[12],e.render.origin[1]+=r[13],e.render.origin[2]+=r[14],e.render.num++;else for(const i of this.stageObject.geometries)i.computeAttachmentOrigin(p)&&(t.transformMat4(p,p,r),t.add(e.render.origin,e.render.origin,p),e.render.num++)}async getProjectedBoundingBox(e,r,s,n,o){const l=this.getBoundingBoxObjectSpace(o),c=m,u=i.isPoint(l)?1:c.length;for(let e=0;e<u;e++){const r=c[e];h[0]=l[r[0]],h[1]=l[r[1]],h[2]=l[r[2]],t.transformMat4(h,h,this.stageObject.transformation),d[3*e]=h[0],d[3*e+1]=h[1],d[3*e+2]=h[2]}if(!e(d,0,u))return null;i.empty(l);let f=null;this.calculateRelativeScreenBounds&&(f=this.calculateRelativeScreenBounds());for(let e=0;e<3*u;e+=3){for(let t=0;t<3;t++)l[t]=Math.min(l[t],d[e+t]),l[t+3]=Math.max(l[t+3],d[e+t]);f&&s.push({location:d.slice(e,e+3),screenSpaceBoundingRect:f})}if(r?.service&&"absolute-height"!==this.elevationContext.mode){i.center(l,p);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let t=0;if(r.useViewElevation)t=r.service.getElevation(p[0],p[1],e)??0;else try{const i=a.demResolutionForBoundingBox(l,r.service.spatialReference,r);t=await r.service.queryElevation(p[0],p[1],n,i,e)??0}catch(e){}i.offset(l,0,0,-this.alignedSampledElevation+t)}return l}addObjectState(e){e.stateType===l.Object3DState.Highlight&&e.addObject(this.stageObject,this.stageObject.highlight(e.highlightName)),e.stateType===l.Object3DState.MaskOccludee&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeByObject(this.stageObject)}resetEdgeObject(e){const{_edgeState:t,stageObject:r,_stageLayer:i,_visible:s}=this;null!=t&&i.stage.renderer.withEdgeView((i=>{s?this._addOrUpdateEdgeObject(t,i,e):i.removeObject(r)}))}_addOrUpdateEdgeObject(e,t,r){const i=u(e.baseMaterial);e.edgeMaterial.objectTransparency=i,t.addOrUpdateObject3D(this.stageObject,e.edgeMaterial,e.hasSlicePlane,!r).then((()=>this._stageLayer?.sync()))}},e.Object3DEdgeState=class{constructor(e,t,r){this.baseMaterial=e,this.edgeMaterial=t,this.hasSlicePlane=r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/graphicUtils":function(){define(["exports","../../../../core/unitUtils","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/projectionUtils","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/centroid","../../../../geometry/support/coordsUtils","../../../../geometry/support/meshVertexSpaceUtils","../../../../layers/graphics/dehydratedPoint","../../../../layers/graphics/hydratedFeatures"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";function f(e){const t=e.paths[0];if(!t||0===t.length)return null;const r=d.getPointOnPath(t,d.getPathLength(t)/2);return p.makeDehydratedPoint(r[0],r[1],r[2],e.spatialReference)}function g(e,t,r){const i=r?e:m.clonePoint(e);return t&&e?a.projectPoint(e,i,t)?i:null:i}function y(e){const t=e=>null==e||e>=0;return Array.isArray(e)?e.every(t):t(e)}e.computeCentroid=function(e,t){if("point"===e.type)return g(e,t,!1);if(m.isHydratedGeometry(e))switch(e.type){case"extent":return g(e.center,t,!1);case"polygon":return g(e.centroid,t,!1);case"polyline":return g(f(e),t,!0);case"mesh":return g(h.vertexSpaceOriginToPoint(e.vertexSpace,e.spatialReference)??e.extent.center,t,!1);case"multipoint":return}else switch(e.type){case"extent":return g(function(e){return p.makeDehydratedPoint(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),null!=e.zmin&&null!=e.zmax&&isFinite(e.zmin)&&isFinite(e.zmax)?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return g(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const r=u.ringsCentroid(e.rings,!!e.hasZ);return p.makeDehydratedPoint(r[0],r[1],r[2],e.spatialReference)}(e),t,!0);case"polyline":return g(f(e),t,!0);case"multipoint":return}},e.computeMaxZ=function(e){if(!e)return 0;switch(e.type){case"point":return e.z;case"extent":return e.zmax;case"polygon":return e.hasZ?e.rings.reduce(((e,t)=>t.reduce(((e,t)=>Math.max(e,t[2])),e)),-1/0):void 0;case"polyline":return e.hasZ?e.paths.reduce(((e,t)=>t.reduce(((e,t)=>Math.max(e,t[2])),e)),-1/0):void 0;case"mesh":return e.extent.zmax;case"multipoint":return}},e.computeObjectRotation=function(e,t,s,n=i.create()){return e&&r.rotateZ(n,n,-e/180*Math.PI),t&&r.rotateX(n,n,t/180*Math.PI),s&&r.rotateY(n,n,s/180*Math.PI),n},e.computeObjectScale=function(e=s.ONES,t,r,i=1){const n=new Array(3);if(null==t||null==r)n[0]=1,n[1]=1,n[2]=1;else{let i,s=0;for(let o=2;o>=0;o--){const a=e[o],l=null!=a,c=0===o&&!i&&!l,u=r[o];let d;"symbol-value"===a||c?d=0!==u?t[o]/u:1:l&&"proportional"!==a&&isFinite(a)&&(d=0!==u?a/u:1),null!=d&&(n[o]=d,i=d,s=Math.max(s,Math.abs(d)))}for(let e=2;e>=0;e--)null==n[e]?n[e]=i:0===n[e]&&(n[e]=.001*s)}for(let e=2;e>=0;e--)n[e]/=i;return s.fromArray(n)},e.demResolutionForBoundingBox=function(e,r,i){if(null!=i.minDemResolution)return i.minDemResolution;const s=t.getMetersPerUnitForSR(r),n=l.width(e)*s,o=l.depth(e)*s,a=l.height(e)*(r.isGeographic?1:s);return 0===n&&0===o&&0===a?i.minDemResolutionForPoints:.01*Math.max(n,o,a)},e.enlargeExtent=function(e,t,r,i=0){if(e){t||(t=c.create());const s=e;let o=.5*s.width*(r-1),a=.5*s.height*(r-1);return s.width<1e-7*s.height?o+=a/20:s.height<1e-7*s.width&&(a+=o/20),n.set(t,s.xmin-o-i,s.ymin-a-i,s.xmax+o+i,s.ymax+a+i),t}return null},e.isValidSize=y,e.mixinColorAndOpacity=function(e,t,r=null){const i=o.clone(o.ONES);return null!=e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),null!=t?i[3]=t:null!=e&&e.length>3&&(i[3]=e[3]),r&&(i[0]*=r,i[1]*=r,i[2]*=r,i[3]*=r),i},e.overrideColor=function(e,t,r,i,s,n){for(let t=0;t<3;++t)n[t]=null!=e?.[t]?e[t]:null!=r?.[t]?r[t]:s[t];return n[3]=null!=t?t:null!=i?i:s[3],n},e.validateSymbolLayerSize=function(e){return y(null!=e.isPrimitive?[e.width,e.depth,e.height]:e)?null:"Symbol sizes may not be negative values"},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/edgeRendering/interfaces":function(){define(["exports"],(function(e){"use strict";var t;e.Transparency=void 0,(t=e.Transparency||(e.Transparency={}))[t.TRANSPARENT=0]="TRANSPARENT",t[t.OPAQUE=1]="OPAQUE",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DObjectMetadata":function(){define(["exports"],(function(e){"use strict";e.Graphics3DObjectMetadata=class{constructor(e,t=null){this.labelText=t,this.elevationOffset=e??0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DSymbolLayer":function(){define(["exports","../../../../Color","../../../../core/has","../../../../core/Logger","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/coordsUtils","./defaultSymbolComplexity","./elevationAlignmentUtils","./ElevationContext","./featureExpressionInfoUtils","./graphicUtils","./interfaces","./Loadable","../support/FastSymbolUpdates"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";const f=()=>i.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class g extends p.Loadable{constructor(e,t,r,i,s=!0){super(r.schedule),this.symbol=e,this.symbolLayer=t,this._context=r,this._drivenOpacityFallbackAlwaysOpaque=s,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1},this._materials=[],this.logger=f(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=i.renderPriority,this._renderPriorityStep=i.renderPriorityStep,this._elevationContext=new c.ElevationContext,this.updateComplexity(),this.ignoreDrivers=i.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=y(this._context.renderer,s)),this._updateElevationContext()}get view(){return this._context.stage.view}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}get usedMemory(){const e=this.complexity;return null==e?0:(this.draped?e.memory.draped:e.memory).bytesPerFeature}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,r=y(e,this._drivenOpacityFallbackAlwaysOpaque);return r.color!==t.color||r.opacity!==t.opacity||r.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||r.size!==t.size||r.rotation!==t.rotation}get needsDrivenTransparentPass(){return(this._drivenProperties.color||this._drivenProperties.opacity)&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,r,i){const s=e.projectionSuccess,n="polygons"in e?e.polygons:null,o=`${i} geometry failed to be created`;s?!this._logGeometryValidationWarnings(t,r,i)&&n&&0===n.length&&"rings"===r&&t.length>0&&t[0].length>2&&f().warnOncePerTick(`${o} (filled rings should use clockwise winding - try reversing the order of vertices)`):f().warnOncePerTick(`${o} (failed to project geometry to view spatial reference)`)}updateFocus(e,t){}_logGeometryValidationWarnings(e,t,r){const i=`${r} geometry failed to be created`;return!e.length||1===e.length&&!e[0].length?(f().warnOncePerTick(`${i} (no ${t} were defined)`),!0):!(Array.isArray(e)&&Array.isArray(e[0])||(f().warnOncePerTick(`${i} (${t} should be defined as a 2D array)`),0))}_validateGeometry(e,t=null,r=null){if(null!=t&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${e.type}`),!1;switch(e.type){case"point":{const t=e;if(!isFinite(t.x)||!isFinite(t.y))return f().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":o.closeRings(e)}return!0}_defaultElevationInfoNoZ(){return _}_defaultElevationInfoZ(){return b}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t=new c.ElevationContext){const r=e.geometry,i=this.getDefaultElevationInfo(r);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:i.unit,t.mode=this.getGeometryElevationMode(r,i),t.offsetMeters=this._elevationContext.meterUnitOffset??i.offset??0;const s=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;s&&(t.mode="relative-to-ground",t.offsetMeters=0);const n=s?u.zeroContext:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(n,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}updateTransform(e,t,r,i){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=v){const r=this.draped?1:this._getLayerOpacity();return this._drivenProperties.opacity||this._drivenProperties.color?r:e?r*e.a:t.hasIntrinsicColor?r:0}_getCombinedOpacityAndColor(e,r=v){const i=this._getCombinedOpacity(e,r);if(this._drivenProperties.color)return d.mixinColorAndOpacity(null,i);const n=null!=e?t.toUnitRGB(e):s.ONES;return d.mixinColorAndOpacity(n,i)}_getVertexOpacityAndColor(e,t,r=null){const i=this._drivenProperties.color?e.color??t:null,s=this._drivenProperties.opacity?e.opacity??t[3]:null,n=d.mixinColorAndOpacity(i,s);return r&&(n[0]*=r,n[1]*=r,n[2]*=r,n[3]*=r),n}isFastUpdatesEnabled(){return null!=this._fastUpdates}updateComplexity(){this.complexity=this.computeComplexity()}computeComplexity(){return a.defaultSymbolLayerComplexity(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,r){switch(e){case"opacity":return this.layerOpacityChanged(t,r),!0;case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,r,e)!==l.SymbolUpdateType.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,r){let i=l.SymbolUpdateType.UPDATE;return e?.forEach((e=>{const s=t(e);if(null!=s){const t=e.graphic;this.setGraphicElevationContext(t,s.elevationContext),s.needsElevationUpdates=r(s.elevationContext.mode)}else i=l.SymbolUpdateType.RECREATE})),i}applyRendererDiff(e,t){return h.ApplyRendererDiffResult.RecreateSymbol}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,r=t.size?m.getAttributeValue(t.size.field,e):0,i=t.color?m.getAttributeValue(t.color.field,e):0,s=t.opacity?m.getAttributeValue(t.opacity.field,e):0;return n.fromValues(r,i,s,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&f().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null})}}}function y(e,t){const r={color:!1,opacity:!1,opacityAlwaysOpaque:t,size:!1,rotation:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach((e=>{switch(e.type){case"color":if(r.color=!0,e.stops)for(let t=0;t<e.stops.length;t++){const i=e.stops[t].color;i&&i.a<1&&(r.opacityAlwaysOpaque=!1)}break;case"opacity":r.opacity=!0,r.opacityAlwaysOpaque=!1;break;case"size":r.size=!0;break;case"rotation":r.rotation=!0}})),r}const _={mode:"on-the-ground",offset:0,unit:"meters"},b={mode:"absolute-height",offset:0,unit:"meters"},v={hasIntrinsicColor:!1};e.Graphics3DSymbolLayer=g,e.getDrivenProperties=y,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/defaultSymbolComplexity":function(){define(["exports","../../../../core/compilerUtils","../../../../symbols/support/ObjectSymbol3DLayerResource","./Graphics3DPathSymbolLayerConstants","./primitiveObjectSymbolUtils","./SymbolComplexity","../support/edgeUtils","../../webgl-engine/materials/DefaultMaterial"],(function(e,t,r,i,s,n,o,a){"use strict";const l=new n.EstimatedSymbolComplexity({});function c(e){let t=0,r=0,i=0,s=!1,o=0;const a=new n.SymbolComplexityMemory;for(const n of e)null!=n&&(t+=n.verticesPerFeature,r+=n.verticesPerCoordinate,i+=n.drawCallsPerFeature,a.bytesPerFeature+=n.memory.bytesPerFeature,a.bytesPerFeatureLabel+=n.memory.bytesPerFeatureLabel,a.resourceBytes+=n.memory.resourceBytes,a.draped.bytesPerFeature+=n.memory.bytesPerFeature,a.draped.bytesPerFeatureLabel+=n.memory.bytesPerFeatureLabel,s=s||n.estimated,++o);return s?new n.EstimatedAggregateSymbolComplexity(o,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:i,memory:a}):new n.AggregateSymbolComplexity(o,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:i,memory:a})}const u={};function d(e,s){const a=h(e,s),l=o.hasEdges(s)?2:0;switch(s.type){case"extrude":return new n.SymbolComplexity({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:l,memory:a});case"fill":if("mesh-3d"===e.type)return new n.SymbolComplexity({drawCallsPerFeature:l,memory:a});if(null!=s.outline&&s.outline.size>0)return new n.SymbolComplexity({verticesPerFeature:-12,verticesPerCoordinate:9,memory:a});case"water":return new n.SymbolComplexity({verticesPerFeature:-6,verticesPerCoordinate:3,memory:a});case"line":return new n.SymbolComplexity({verticesPerFeature:-6,verticesPerCoordinate:6,memory:a});case"object":return s.resource?.href?new n.EstimatedSymbolComplexity({verticesPerFeature:100,memory:a}):{...p(s.resource?.primitive??r.defaultPrimitive),memory:a};case"path":{let e=0,r=0;switch(s.profile){case"circle":e=i.pathNumCircleProfileSubdivisions;break;case"quad":e=4;break;default:return void t.neverReached(s.profile)}switch(s.join){case"round":r=i.pathNumRoundJoinSubdivisions;break;case"miter":case"bevel":r=1;break;default:return}const o=2*e,l=e*r*2,c=l+o;let u=-2*l-o;switch(s.cap){case"none":break;case"butt":case"square":u+=2*(e-1);break;case"round":u+=2*(e*(i.pathNumRoundCapExtrusionSubdivisions-1)*2+e);break;default:return}return new n.SymbolComplexity({verticesPerFeature:u,verticesPerCoordinate:c,memory:a})}case"text":{const t="label-3d"===e.type?0:2;return new n.SymbolComplexity({verticesPerFeature:6,memory:a,drawCallsPerFeature:t})}case"icon":return new n.SymbolComplexity({verticesPerFeature:6,memory:a});default:return}}function h(e,r){const i="point-3d"===e.type;switch(r.type){case"extrude":return r.edges&&r.edges.size>0?f.EXTRUDE_EDGES:f.EXTRUDE;case"fill":return null!=r.outline&&r.outline.size>0?f.FILL_OUTLINE:f.FILL;case"water":return f.FILL;case"line":return"round"===r.join?f.LINE_ROUND:f.LINE_MITER;case"path":switch(r.join){case"round":switch(r.profile){case"circle":return f.PATH_ROUND_CIRCLE;case"quad":return f.PATH_ROUND_QUAD;default:return void t.neverReached(r.profile)}case"miter":case"bevel":switch(r.profile){case"circle":return f.PATH_MITER_CIRCLE;case"quad":return f.PATH_MITER_QUAD;default:return void t.neverReached(r.profile)}default:return}case"object":return i?f.OBJECT_POINT:f.OBJECT_POLYGON;case"icon":case"text":return i?f.ICON_POINT:f.ICON_POLYGON;default:return}}function p(e){const t=u[e];if(t)return t;const r=m(s.primitiveLodResources(e,new a.DefaultMaterial({},{spherical:!0})).levels);return u[e]=new n.SymbolComplexity({verticesPerFeature:r}),u[e]}function m(e){return e.reduce(((e,t,r)=>e+t.numVertices*(1/10**r)),0)/e.reduce(((e,t,r)=>e+1/10**r),0)}const f={ICON_POINT:{bytesPerFeature:3062.2534325974652,bytesPerFeatureLabel:3605.891255,resourceBytes:0,draped:{bytesPerFeature:2029.6324697040875,bytesPerFeatureLabel:3844.951315}},ICON_POLYGON:{bytesPerFeature:3379.2552364427283,bytesPerFeatureLabel:3144.1341316666667,resourceBytes:0,draped:{bytesPerFeature:2594.5439970589305,bytesPerFeatureLabel:3391.0192816666668}},OBJECT_POINT:{bytesPerFeature:755.5754513856272,bytesPerFeatureLabel:3229.7766,resourceBytes:0,draped:{bytesPerFeature:755.5754513856272,bytesPerFeatureLabel:3229.7766}},OBJECT_POLYGON:{bytesPerFeature:1235.9612556276838,bytesPerFeatureLabel:2710.5796950000004,resourceBytes:0,draped:{bytesPerFeature:1235.9612556276838,bytesPerFeatureLabel:2710.5796950000004}},LINE_MITER:{bytesPerFeature:2343.0098144295366,bytesPerFeatureLabel:2863.2415183333333,resourceBytes:0,draped:{bytesPerFeature:2118.062960542706,bytesPerFeatureLabel:2993.8707950000003}},LINE_ROUND:{bytesPerFeature:3180.281669156425,bytesPerFeatureLabel:2884.062711666667,resourceBytes:0,draped:{bytesPerFeature:2687.1048133674676,bytesPerFeatureLabel:2965.844025}},PATH_MITER_CIRCLE:{bytesPerFeature:26642.015762630304,bytesPerFeatureLabel:3147.8341749999995,resourceBytes:0,draped:{bytesPerFeature:26642.015762630304,bytesPerFeatureLabel:3147.8341749999995}},PATH_ROUND_CIRCLE:{bytesPerFeature:21137.659435445064,bytesPerFeatureLabel:2827.1294000000003,resourceBytes:0,draped:{bytesPerFeature:21137.659435445064,bytesPerFeatureLabel:2827.1294000000003}},PATH_MITER_QUAD:{bytesPerFeature:25592.283303929427,bytesPerFeatureLabel:3354.641775,resourceBytes:0,draped:{bytesPerFeature:25592.283303929427,bytesPerFeatureLabel:3354.641775}},PATH_ROUND_QUAD:{bytesPerFeature:23212.92773696872,bytesPerFeatureLabel:3173.6644499999998,resourceBytes:0,draped:{bytesPerFeature:23212.92773696872,bytesPerFeatureLabel:3173.6644499999998}},FILL:{bytesPerFeature:3069.6014181747005,bytesPerFeatureLabel:3050.617135,resourceBytes:0,draped:{bytesPerFeature:2547.9765396831167,bytesPerFeatureLabel:3166.2821483333337}},FILL_OUTLINE:{bytesPerFeature:3653.779598313774,bytesPerFeatureLabel:2787.5897050000003,resourceBytes:0,draped:{bytesPerFeature:2884.528596112384,bytesPerFeatureLabel:2907.420548333333}},EXTRUDE:{bytesPerFeature:5785.658350054202,bytesPerFeatureLabel:2787.498365,resourceBytes:0,draped:{bytesPerFeature:5785.658350054202,bytesPerFeatureLabel:2787.498365}},EXTRUDE_EDGES:{bytesPerFeature:3380.451670091342,bytesPerFeatureLabel:2245.881308333333,resourceBytes:0,draped:{bytesPerFeature:3380.451670091342,bytesPerFeatureLabel:2245.881308333333}}};e.averageSymbolComplexities=function(e){const t=c(e);return t.numComplexities>0&&(t.verticesPerFeature/=t.numComplexities,t.verticesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities),t},e.defaultSymbolComplexity=function(e){return"web-style"===e.type?l:c(e.symbolLayers.toArray().map((t=>d(e,t))))},e.defaultSymbolLayerComplexity=d,e.defaultSymbolLayerMemoryComplexity=h,e.emptySymbolComplexity=l,e.estimateNumVerticesForLods=m,e.totalSymbolComplexities=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DPathSymbolLayerConstants":function(){define(["exports"],(function(e){"use strict";e.pathNumCircleProfileSubdivisions=10,e.pathNumRoundCapExtrusionSubdivisions=3,e.pathNumRoundJoinSubdivisions=3,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/primitiveObjectSymbolUtils":function(){define(["exports","../../../../core/has","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/lodRendering/LodResources"],(function(e,t,r,i){"use strict";const s=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];e.isValidPrimitive=function(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1},e.primitiveLodResources=function(e,t){const n=(e,t,s=!1)=>new i.LodResources(e.map((e=>{const n=t(e.tesselation);return s&&r.cgToGIS(n),new i.LodLevelResources([new i.LodComponentResources(new i.LodComponentEngineGeometry(n))],e.minScreenSpaceRadius)})));switch(e){case"sphere":return n([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(e=>r.createPolySphereGeometry(t,.5,e,!0)));case"cube":return n([{tesselation:0,minScreenSpaceRadius:0}],(()=>r.createBoxGeometry(t,1)));case"cone":return n(s,(e=>r.createConeGeometry(t,1,.5,e,!1)),!0);case"inverted-cone":return n(s,(e=>r.createConeGeometry(t,1,.5,e,!0)),!0);case"cylinder":return n(s,(e=>r.createCylinderGeometry(t,1,.5,e,[0,0,1],[0,0,.5])));case"tetrahedron":return n([{tesselation:0,minScreenSpaceRadius:0}],(()=>r.createTetrahedronGeometry(t,1)),!0);case"diamond":return n([{tesselation:0,minScreenSpaceRadius:0}],(()=>r.createDiamondGeometry(t,1)),!0);default:return}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/GeometryUtil":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/DoubleArray","../../../../geometry/support/FloatArray","../../../../geometry/support/Indices","../../../../geometry/support/plane","../../../../geometry/support/ray","./Attribute","./BufferVectorMath","./Geometry","./Util","./VertexAttribute","./IntersectableGeometry"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";const f=u.Vec3Compact,g=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],y=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],_=[0,0,1,0,1,1,0,1],b=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],v=new Array(36);for(let e=0;e<6;e++)for(let t=0;t<6;t++)v[6*e+t]=e;const S=new Array(36);for(let e=0;e<6;e++)S[6*e]=0,S[6*e+1]=1,S[6*e+2]=2,S[6*e+3]=2,S[6*e+4]=3,S[6*e+5]=0;const w=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],x=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],T=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],C=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7],P=r.fromValues(-.5,0,-.5),M=r.fromValues(.5,0,-.5),R=r.fromValues(0,0,.5),E=r.fromValues(0,.5,0),O=r.create(),A=r.create(),I=r.create(),D=r.create(),F=r.create();t.subtract(O,P,E),t.subtract(A,P,M),t.cross(I,O,A),t.normalize(I,I),t.subtract(O,M,E),t.subtract(A,M,R),t.cross(D,O,A),t.normalize(D,D),t.subtract(O,R,E),t.subtract(A,R,P),t.cross(F,O,A),t.normalize(F,F);const L=[P,M,R,E],N=[0,-1,0,I[0],I[1],I[2],D[0],D[1],D[2],F[0],F[1],F[2]],U=[0,1,2,3,1,0,3,2,1,3,0,2],V=[0,0,0,1,1,1,2,2,2,3,3,3];function B(e,t,r){const i=e;let s,o;if(r)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],o=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const e=i*(1+Math.sqrt(5))/2;s=[-i,e,0,i,e,0,-i,-e,0,i,-e,0,0,-i,e,0,i,e,0,-i,-e,0,i,-e,e,0,-i,e,0,i,-e,0,-i,-e,0,i],o=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let t=0;t<s.length;t+=3)f.scale(s,t,e/f.length(s,t));let a={};function l(t,r){t>r&&([t,r]=[r,t]);const i=t.toString()+"."+r.toString();if(a[i])return a[i];let n=s.length;return s.length+=3,f.add(s,3*t,s,3*r,s,n),f.scale(s,n,e/f.length(s,n)),n/=3,a[i]=n,n}for(let e=0;e<t;e++){const e=o.length,t=new Array(4*e);for(let r=0;r<e;r+=3){const e=o[r],i=o[r+1],s=o[r+2],n=l(e,i),a=l(i,s),c=l(s,e),u=4*r;t[u]=e,t[u+1]=n,t[u+2]=c,t[u+3]=i,t[u+4]=a,t[u+5]=n,t[u+6]=s,t[u+7]=c,t[u+8]=a,t[u+9]=n,t[u+10]=a,t[u+11]=c}o=t,a={}}const u=n.floatArrayFrom(s);for(let e=0;e<u.length;e+=3)f.normalize(u,e);return[[p.VertexAttribute.POSITION,new c.Attribute(n.floatArrayFrom(s),o,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute(u,o,3,!0)]]}const G=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function k(e,t,i,s,o=!0,a=!0){let l=0;const u=t,d=e;let h=r.fromValues(0,l,0),m=r.fromValues(0,l+d,0),f=r.fromValues(0,-1,0),g=r.fromValues(0,1,0);s&&(l=d,m=r.fromValues(0,0,0),h=r.fromValues(0,l,0),f=r.fromValues(0,1,0),g=r.fromValues(0,-1,0));const y=[m,h],_=[f,g],b=i+2,v=Math.sqrt(d*d+u*u);if(s)for(let e=i-1;e>=0;e--){const t=e*(2*Math.PI/i),s=r.fromValues(Math.cos(t)*u,l,Math.sin(t)*u);y.push(s);const n=r.fromValues(d*Math.cos(t)/v,-u/v,d*Math.sin(t)/v);_.push(n)}else for(let e=0;e<i;e++){const t=e*(2*Math.PI/i),s=r.fromValues(Math.cos(t)*u,l,Math.sin(t)*u);y.push(s);const n=r.fromValues(d*Math.cos(t)/v,u/v,d*Math.sin(t)/v);_.push(n)}const S=new Array,w=new Array;if(o){for(let e=3;e<y.length;e++)S.push(1),S.push(e-1),S.push(e),w.push(0),w.push(0),w.push(0);S.push(y.length-1),S.push(2),S.push(1),w.push(0),w.push(0),w.push(0)}if(a){for(let e=3;e<y.length;e++)S.push(e),S.push(e-1),S.push(0),w.push(e),w.push(e-1),w.push(1);S.push(0),S.push(2),S.push(y.length-1),w.push(1),w.push(2),w.push(_.length-1)}const x=n.newFloatArray(3*b);for(let e=0;e<b;e++)x[3*e]=y[e][0],x[3*e+1]=y[e][1],x[3*e+2]=y[e][2];const T=n.newFloatArray(3*b);for(let e=0;e<b;e++)T[3*e]=_[e][0],T[3*e+1]=_[e][1],T[3*e+2]=_[e][2];return[[p.VertexAttribute.POSITION,new c.Attribute(x,S,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute(T,w,3,!0)]]}function z(e,s,o,u,h,m,f=r.fromValues(0,0,0)){const g=s.length,y=n.newFloatArray(o.length*g*3+(6*u.length||0)),_=n.newFloatArray(o.length*g*3+(u?6:0)),b=new Array,v=new Array;let S=0,w=0;const x=i.create(),T=i.create(),C=i.create(),P=i.create(),M=i.create(),R=i.create(),E=i.create(),O=i.create(),A=i.create(),I=i.create(),D=i.create(),F=i.create(),L=i.create(),N=a.create();t.set(A,0,1,0),t.subtract(T,o[1],o[0]),t.normalize(T,T),m?(t.add(O,o[0],f),t.normalize(C,O)):t.set(C,0,0,1),q(T,C,A,A,M,C,H),t.copy(P,C),t.copy(F,M);for(let e=0;e<u.length;e++)t.scale(R,M,u[e][0]),t.scale(O,C,u[e][2]),t.add(R,R,O),t.add(R,R,o[0]),y[S++]=R[0],y[S++]=R[1],y[S++]=R[2];_[w++]=-T[0],_[w++]=-T[1],_[w++]=-T[2];for(let e=0;e<h.length;e++)b.push(h[e][0]>0?h[e][0]:-h[e][0]-1+u.length),b.push(h[e][1]>0?h[e][1]:-h[e][1]-1+u.length),b.push(h[e][2]>0?h[e][2]:-h[e][2]-1+u.length),v.push(0),v.push(0),v.push(0);let U=u.length;const V=u.length-1;for(let e=0;e<o.length;e++){let r=!1;e>0&&(t.copy(x,T),e<o.length-1?(t.subtract(T,o[e+1],o[e]),t.normalize(T,T)):r=!0,t.add(I,x,T),t.normalize(I,I),t.add(D,o[e-1],P),a.fromPositionAndNormal(o[e],I,N),a.intersectRay(N,l.wrap(D,x),O)?(t.subtract(O,O,o[e]),t.normalize(C,O),t.cross(M,I,C),t.normalize(M,M)):q(I,P,F,A,M,C,H),t.copy(P,C),t.copy(F,M)),m&&(t.add(O,o[e],f),t.normalize(L,O));for(let i=0;i<g;i++)if(t.scale(R,M,s[i][0]),t.scale(O,C,s[i][1]),t.add(R,R,O),t.normalize(E,R),_[w++]=E[0],_[w++]=E[1],_[w++]=E[2],t.add(R,R,o[e]),y[S++]=R[0],y[S++]=R[1],y[S++]=R[2],!r){const e=(i+1)%g;b.push(U+i),b.push(U+g+i),b.push(U+e),b.push(U+e),b.push(U+g+i),b.push(U+g+e);for(let e=0;e<6;e++){const t=b.length-6;v.push(b[t+e]-V)}}U+=g}const B=o[o.length-1];for(let e=0;e<u.length;e++)t.scale(R,M,u[e][0]),t.scale(O,C,u[e][1]),t.add(R,R,O),t.add(R,R,B),y[S++]=R[0],y[S++]=R[1],y[S++]=R[2];const G=w/3;_[w++]=T[0],_[w++]=T[1],_[w++]=T[2];const k=U-g;for(let e=0;e<h.length;e++)b.push(h[e][0]>=0?U+h[e][0]:-h[e][0]-1+k),b.push(h[e][2]>=0?U+h[e][2]:-h[e][2]-1+k),b.push(h[e][1]>=0?U+h[e][1]:-h[e][1]-1+k),v.push(G),v.push(G),v.push(G);const z=[[p.VertexAttribute.POSITION,new c.Attribute(y,b,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute(_,v,3,!0)]];return new d.Geometry(e,z)}function j(e,r,i,s,n){return!(Math.abs(t.dot(r,e))>n||(t.cross(i,e,r),t.normalize(i,i),t.cross(s,i,e),t.normalize(s,s),0))}function q(e,t,r,i,s,n,o){return j(e,t,s,n,o)||j(e,r,s,n,o)||j(e,i,s,n,o)}const H=.99619469809,W=i.create();e.cgToGIS=function(e,t=e){const r=e.attributes,i=r.get(p.VertexAttribute.POSITION).data,s=r.get(p.VertexAttribute.NORMAL).data;if(s){const e=t.getMutableAttribute(p.VertexAttribute.NORMAL).data;for(let t=0;t<s.length;t+=3){const r=s[t+1];e[t+1]=-s[t+2],e[t+2]=r}}if(i){const e=t.getMutableAttribute(p.VertexAttribute.POSITION).data;for(let t=0;t<i.length;t+=3){const r=i[t+1];e[t+1]=-i[t+2],e[t+2]=r}}},e.createBoxGeometry=function(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(24);for(let e=0;e<8;e++)r[3*e]=g[e][0]*t[0],r[3*e+1]=g[e][1]*t[1],r[3*e+2]=g[e][2]*t[2];return new d.Geometry(e,[[p.VertexAttribute.POSITION,new c.Attribute(r,b,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute(y,v,3)],[p.VertexAttribute.UV0,new c.Attribute(_,S,2)]])},e.createConeGeometry=function(e,t,r,i,s,n=!0,o=!0){return new d.Geometry(e,k(t,r,i,s,n,o))},e.createConeGeometryData=k,e.createCylinderGeometry=function(e,i,s,o,a,l,u){const h=a?r.clone(a):r.fromValues(1,0,0),m=l?r.clone(l):r.fromValues(0,0,0);u??=!0;const f=r.create();t.normalize(f,h);const g=r.create();t.scale(g,f,Math.abs(i));const y=r.create();t.scale(y,g,-.5),t.add(y,y,m);const _=r.fromValues(0,1,0);Math.abs(1-t.dot(f,_))<.2&&t.set(_,0,0,1);const b=r.create();t.cross(b,f,_),t.normalize(b,b),t.cross(_,b,f);const v=2*o+(u?2:0),S=o+(u?2:0),w=n.newFloatArray(3*v),x=n.newFloatArray(3*S),T=n.newFloatArray(2*v),C=new Array(3*o*(u?4:2)),P=new Array(3*o*(u?4:2));u&&(w[3*(v-2)]=y[0],w[3*(v-2)+1]=y[1],w[3*(v-2)+2]=y[2],T[2*(v-2)]=0,T[2*(v-2)+1]=0,w[3*(v-1)]=w[3*(v-2)]+g[0],w[3*(v-1)+1]=w[3*(v-2)+1]+g[1],w[3*(v-1)+2]=w[3*(v-2)+2]+g[2],T[2*(v-1)]=1,T[2*(v-1)+1]=1,x[3*(S-2)]=-f[0],x[3*(S-2)+1]=-f[1],x[3*(S-2)+2]=-f[2],x[3*(S-1)]=f[0],x[3*(S-1)+1]=f[1],x[3*(S-1)+2]=f[2]);const M=(e,t,r)=>{C[e]=t,P[e]=r};let R=0;const E=r.create(),O=r.create();for(let e=0;e<o;e++){const r=e*(2*Math.PI/o);t.scale(E,_,Math.sin(r)),t.scale(O,b,Math.cos(r)),t.add(E,E,O),x[3*e]=E[0],x[3*e+1]=E[1],x[3*e+2]=E[2],t.scale(E,E,s),t.add(E,E,y),w[3*e]=E[0],w[3*e+1]=E[1],w[3*e+2]=E[2],T[2*e]=e/o,T[2*e+1]=0,w[3*(e+o)]=w[3*e]+g[0],w[3*(e+o)+1]=w[3*e+1]+g[1],w[3*(e+o)+2]=w[3*e+2]+g[2],T[2*(e+o)]=e/o,T[2*e+1]=1;const i=(e+1)%o;M(R++,e,e),M(R++,e+o,e),M(R++,i,i),M(R++,i,i),M(R++,e+o,e),M(R++,i+o,i)}if(u){for(let e=0;e<o;e++){const t=(e+1)%o;M(R++,v-2,S-2),M(R++,e,S-2),M(R++,t,S-2)}for(let e=0;e<o;e++){const t=(e+1)%o;M(R++,e+o,S-1),M(R++,v-1,S-1),M(R++,t+o,S-1)}}const A=[[p.VertexAttribute.POSITION,new c.Attribute(w,C,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute(x,P,3,!0)],[p.VertexAttribute.UV0,new c.Attribute(T,C,2,!0)]];return new d.Geometry(e,A)},e.createDiamondGeometry=function(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(18);for(let e=0;e<6;e++)r[3*e]=w[e][0]*t[0],r[3*e+1]=w[e][1]*t[1],r[3*e+2]=w[e][2]*t[2];return new d.Geometry(e,[[p.VertexAttribute.POSITION,new c.Attribute(r,T,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute(x,C,3)]])},e.createExtrudedTriangle=function(e,t,r,i,s,n=0){const o=new Array(18),a=[[-r,n,s/2],[i,n,s/2],[0,t+n,s/2],[-r,n,-s/2],[i,n,-s/2],[0,t+n,-s/2]];for(let e=0;e<6;e++)o[3*e]=a[e][0],o[3*e+1]=a[e][1],o[3*e+2]=a[e][2];return new d.Geometry(e,[[p.VertexAttribute.POSITION,new c.Attribute(o,[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5],3,!0)]])},e.createPathExtrusionGeometry=z,e.createPointGeometry=function(e,{normal:t,position:r,color:s,rotation:n,size:a,centerOffsetAndDistance:l,uvi:u,featureAttribute:h,objectAndLayerIdColor:f=null}={}){const g=r?i.clone(r):i.create(),y=t?i.clone(t):i.fromValues(0,0,1),_=s?[255*s[0],255*s[1],255*s[2],s.length>3?255*s[3]:255]:[255,255,255,255],b=null!=a&&2===a.length?a:[1,1],v=null!=n?[n]:[0],S=o.getZeroIndexArray(1),w=[[p.VertexAttribute.POSITION,new c.Attribute(g,S,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute(y,S,3,!0)],[p.VertexAttribute.COLOR,new c.Attribute(_,S,4,!0)],[p.VertexAttribute.SIZE,new c.Attribute(b,S,2)],[p.VertexAttribute.ROTATION,new c.Attribute(v,S,1,!0)]];if(u&&w.push([p.VertexAttribute.UVI,new c.Attribute(u,S,u.length)]),null!=l){const e=[l[0],l[1],l[2],l[3]];w.push([p.VertexAttribute.CENTEROFFSETANDDISTANCE,new c.Attribute(e,S,4)])}if(h){const e=[h[0],h[1],h[2],h[3]];w.push([p.VertexAttribute.FEATUREATTRIBUTE,new c.Attribute(e,S,4)])}return new d.Geometry(e,w,null,m.GeometryType.Point,f)},e.createPolySphereData=B,e.createPolySphereGeometry=function(e,t,r,i){const s=B(t,r,i);return new d.Geometry(e,s)},e.createPolylineGeometry=function(e,t,r,i){h.assert(t.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),h.assert(3===t[0].length,"createPolylineGeometry(): malformed vertex"),h.assert(null==r||r.length===t.length,"createPolylineGeometry: need same number of points and normals"),h.assert(null==r||3===r[0].length,"createPolylineGeometry(): malformed normal");const a=s.newDoubleArray(3*t.length),l=new Array(2*(t.length-1));let u=0,f=0;for(let e=0;e<t.length;e++){for(let r=0;r<3;r++)a[u++]=t[e][r];e>0&&(l[f++]=e-1,l[f++]=e)}const g=[[p.VertexAttribute.POSITION,new c.Attribute(a,l,3,!0)]];if(r){const e=n.newFloatArray(3*r.length);let i=0;for(let s=0;s<t.length;s++)for(let t=0;t<3;t++)e[i++]=r[s][t];g.push([p.VertexAttribute.NORMAL,new c.Attribute(e,l,3,!0)])}return i&&g.push([p.VertexAttribute.COLOR,new c.Attribute(i,o.getContinuousIndexArray(i.length/4),4)]),new d.Geometry(e,g,null,m.GeometryType.Line)},e.createSphereGeometry=function(e,t,r,i,s={uv:!0}){const a=-Math.PI,l=2*Math.PI,u=-Math.PI/2,h=Math.PI,m=Math.max(3,Math.floor(r)),f=Math.max(2,Math.floor(i)),g=(m+1)*(f+1),y=n.newFloatArray(3*g),_=n.newFloatArray(3*g),b=n.newFloatArray(2*g),v=[];let S=0;for(let e=0;e<=f;e++){const r=[],i=e/f,s=u+i*h,n=Math.cos(s);for(let e=0;e<=m;e++){const o=e/m,c=a+o*l,u=Math.cos(c)*n,d=Math.sin(s),h=-Math.sin(c)*n;y[3*S]=u*t,y[3*S+1]=d*t,y[3*S+2]=h*t,_[3*S]=u,_[3*S+1]=d,_[3*S+2]=h,b[2*S]=o,b[2*S+1]=i,r.push(S),++S}v.push(r)}const w=new Array;for(let e=0;e<f;e++)for(let t=0;t<m;t++){const r=v[e][t],i=v[e][t+1],s=v[e+1][t+1],n=v[e+1][t];0===e?(w.push(r),w.push(s),w.push(n)):e===f-1?(w.push(r),w.push(i),w.push(s)):(w.push(r),w.push(i),w.push(s),w.push(s),w.push(n),w.push(r))}const x=[[p.VertexAttribute.POSITION,new c.Attribute(y,w,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute(_,w,3,!0)]];return s.uv&&x.push([p.VertexAttribute.UV0,new c.Attribute(b,w,2,!0)]),s.offset&&(x[0][0]=p.VertexAttribute.OFFSET,x.push([p.VertexAttribute.POSITION,new c.Attribute(Float64Array.from(s.offset),o.getZeroIndexArray(w.length),3,!0)])),new d.Geometry(e,x)},e.createSquareGeometry=function(e,t=G){const r=new Array(12);for(let e=0;e<4;e++)for(let i=0;i<3;i++)r[3*e+i]=t[e][i];const i=[0,1,2,2,3,0],s=[0,0,0,0,0,0],n=[[p.VertexAttribute.POSITION,new c.Attribute(r,i,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute([0,0,1],s,3,!0)],[p.VertexAttribute.UV0,new c.Attribute([0,0,1,0,1,1,0,1],i,2,!0)],[p.VertexAttribute.COLOR,new c.Attribute([255,255,255,255],s,4,!0)]];return new d.Geometry(e,n)},e.createTetrahedronGeometry=function(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(12);for(let e=0;e<4;e++)r[3*e]=L[e][0]*t[0],r[3*e+1]=L[e][1]*t[1],r[3*e+2]=L[e][2]*t[2];return new d.Geometry(e,[[p.VertexAttribute.POSITION,new c.Attribute(r,U,3,!0)],[p.VertexAttribute.NORMAL,new c.Attribute(N,V,3)]])},e.createTubeGeometry=function(e,t,r,i,s,n){i=i||10,s=null==s||s,h.assert(t.length>1);const o=[],a=[];for(let e=0;e<i;e++){o.push([0,-e-1,-(e+1)%i-1]);const t=e/i*2*Math.PI;a.push([Math.cos(t)*r,Math.sin(t)*r])}return z(e,a,t,[[0,0,0]],o,s,n)},e.makeOrthoBasisDirUpFallback=q,e.transformInPlace=function(e,r){const i=e.getMutableAttribute(p.VertexAttribute.POSITION).data;for(let e=0;e<i.length;e+=3){const s=i[e],n=i[e+1],o=i[e+2];t.set(W,s,n,o),t.transformMat4(W,W,r),i[e]=W[0],i[e+1]=W[1],i[e+2]=W[2]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/FloatArray":function(){define(["exports","../../core/typedArrayUtil"],(function(e,t){"use strict";e.compactFloatArray=function(e){return Array.isArray(e)?e.length<t.nativeArrayMaxSize?e:new Float32Array(e):e.length<t.nativeArrayMaxSize?Array.from(e):e},e.floatArrayFrom=function(e){return(Array.isArray(e)?e.length:e.byteLength/8)<=t.nativeArrayMaxSize?Array.from(e):new Float32Array(e)},e.floatSubArray=function(e,t,r){return Array.isArray(e)?e.slice(t,t+r):e.subarray(t,t+r)},e.newFloatArray=function(e,r=!1){return e<=t.nativeArrayMaxSize?r?new Array(e).fill(0):new Array(e):new Float32Array(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/BufferVectorMath":function(){define(["exports"],(function(e){"use strict";var t;e.Vec3Compact=void 0,(t=e.Vec3Compact||(e.Vec3Compact={})).length=function(e,t){const r=e[t],i=e[t+1],s=e[t+2];return Math.sqrt(r*r+i*i+s*s)},t.normalize=function(e,t){const r=e[t],i=e[t+1],s=e[t+2],n=1/Math.sqrt(r*r+i*i+s*s);e[t]*=n,e[t+1]*=n,e[t+2]*=n},t.scale=function(e,t,r){e[t]*=r,e[t+1]*=r,e[t+2]*=r},t.add=function(e,t,r,i,s,n=t){(s=s||e)[n]=e[t]+r[i],s[n+1]=e[t+1]+r[i+1],s[n+2]=e[t+2]+r[i+2]},t.subtract=function(e,t,r,i,s,n=t){(s=s||e)[n]=e[t]-r[i],s[n+1]=e[t+1]-r[i+1],s[n+2]=e[t+2]-r[i+2]},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/lodRendering/LodResources":function(){define(["exports","../../../../../core/arrayUtils","../../../../../core/memoryEstimations","../IntersectorInterfaces","../IntersectorResult","../IntersectorType","../VertexAttribute","./Intersector"],(function(e,t,r,i,s,n,o,a){"use strict";class l{constructor(e,t,r,i){this.material=e,this.bufferWriter=e.createBufferWriter(),this.vertexBufferLayout=this.bufferWriter.vertexBufferLayout,this.buffer=t,this.elementCount=r,this.boundingInfo=i}get numTriangles(){return this.elementCount/3}get numVertices(){return this.elementCount}computeUsedMemory(){return this.buffer.byteLength+r.baseTypedArrayMemory}getRenderGeometry(){return this}intersect(e,t,r,i,s,n,o,a){const l=this.bufferWriter,u=this.buffer;l.intersect(u,this.material.parameters,null,e,r,i,((r,i,l)=>c(r,i,l,e,t,n,o,s,a)))}}function c(e,t,r,o,l,c,u,d,h){if(e<0)return;if(l&&!l(o.rayBegin,o.rayEnd,e))return;const p=new a.LodTarget(c.layerViewUid,c.graphicUid(d),r,u,h);if((null==o.results.min.distance||e<o.results.min.distance)&&o.results.min.set(n.IntersectorType.LOD,p,e,t,o.transform.transform),(null==o.results.max.distance||e>o.results.max.distance)&&o.results.max.set(n.IntersectorType.LOD,p,e,t,o.transform.transform),o.options.store===i.StoreResults.ALL){const r=new s.IntersectorResult(o.results.min.ray);r.set(n.IntersectorType.LOD,p,e,t,o.transform.transform),o.results.all.push(r)}}e.LodComponentEngineGeometry=class{constructor(e){this.engineGeometry=e}get material(){return this.engineGeometry.material}get numVertices(){return this.engineGeometry.attributes.get(o.VertexAttribute.POSITION).indices.length}get numTriangles(){return this.engineGeometry.indexCount/3}get boundingInfo(){return this.engineGeometry.boundingInfo}computeUsedMemory(){return Array.from(this.engineGeometry.attributes.values()).reduce(((e,t)=>e+r.estimateNumberArrayMemory(t.data,t.indices)),0)}getRenderGeometry(){const e=this.material,t=this.engineGeometry,r=t.attributes,i=t.boundingInfo,s=e.createBufferWriter(),n=s.vertexBufferLayout,o=s.elementCount(r),a=n.createBuffer(o);return s.write(null,null,r,null,a,0),new l(e,a.buffer,o,i)}intersect(e,t,r,i,s,n,o,a){const l=this.engineGeometry;this.material.intersect(l,e.transform.transform,e,r,i,((r,i,l)=>c(r,i,l,e,t,n,o,s,a)))}},e.LodComponentRenderGeometry=l,e.LodComponentResources=class{constructor(e,t=null){this.geometry=e,this.textures=t}get material(){return this.geometry.material}get numTriangles(){return this.geometry.numTriangles}},e.LodLevelResources=class{constructor(e,r,i){this.components=e,this.minScreenSpaceRadius=r,this.pivotOffset=i;const s=t.unique(this.components.map((e=>e.geometry)));this.numVertices=s.reduce(((e,t)=>e+t.numVertices),0)}},e.LodResources=class{constructor(e){this.levels=e,this.levels.sort(((e,t)=>e.minScreenSpaceRadius===t.minScreenSpaceRadius?e.numVertices-t.numVertices:e.minScreenSpaceRadius-t.minScreenSpaceRadius))}getMaterials(){const e=[];return this.levels.forEach((t=>t.components.forEach((t=>e.push(t.geometry.material))))),t.unique(e)}getTextures(){const e=new Array;return this.levels.forEach((t=>t.components.forEach((t=>{null!=t.textures&&e.push(...t.textures)})))),t.unique(e)}getGeometries(){const e=new Array;return this.levels.forEach((t=>t.components.forEach((t=>{e.push(t.geometry)})))),t.unique(e)}getEngineGeometries(){return this.getGeometries().map((e=>e.engineGeometry)).filter((e=>null!=e))}computeUsedMemory(){const e=this.getGeometries(),t=this.getTextures(),r=e.reduce(((e,t)=>e+t.computeUsedMemory()),0);return t.reduce(((e,t)=>e+t.usedMemory),0)+r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/lodRendering/Intersector":function(){define(["exports","../IntersectorResult","../IntersectorTarget","../IntersectorType"],(function(e,t,r,i){"use strict";class s extends r.Graphic3DTarget{constructor(e,t,r,i,s){super(e,t),this.layerViewUid=e,this.graphicUid=t,this.triangleNr=r,this.baseBoundingSphere=i,this.numLodLevels=s}}e.LodTarget=s,e.isLodIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&e.intersector===i.IntersectorType.LOD&&!!e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/IntersectorTarget":function(){define(["exports"],(function(e){"use strict";class t{constructor(e){this.layerViewUid=e}}e.Graphic3DTarget=class extends t{constructor(e,t){super(e),this.graphicUid=t}},e.LayerTarget=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/SymbolComplexity":function(){define(["exports"],(function(e){"use strict";class t{constructor(e){this.estimated=!1,this.verticesPerFeature=e.verticesPerFeature??0,this.verticesPerCoordinate=e.verticesPerCoordinate??0,this.drawCallsPerFeature=e.drawCallsPerFeature??0,this.memory=e.memory??new i}}class r extends t{constructor(e){super(e),this.estimated=!0}}class i{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}e.AggregateSymbolComplexity=class extends t{constructor(e,t){super(t),this.numComplexities=e}},e.EstimatedAggregateSymbolComplexity=class extends r{constructor(e,t){super(t),this.numComplexities=e}},e.EstimatedSymbolComplexity=r,e.SymbolComplexity=t,e.SymbolComplexityMemory=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/edgeUtils":function(){define(["exports","../../../../Color","../../../../core/has","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec4f64","./layerUtils","../../webgl-engine/lib/edgeRendering/interfaces","../../webgl-engine/shaders/sources/edgeRenderer/EdgeUtil.glsl"],(function(e,t,r,i,s,n,o,a){"use strict";function l(e,r){if(null==e)return null;const n=null!=e.color?s.fromArray(t.toUnitRGBA(e.color)):s.fromValues(0,0,0,0),o=i.pt2px(e.size),l=i.pt2px(e.extensionLength);switch(e.type){case"solid":return c({color:n,size:o,extensionLength:l,...r});case"sketch":return function(e){return{...d,...e,type:a.EdgeType.Sketch}}({color:n,size:o,extensionLength:l,...r});default:return}}function c(e){return{...u,...e,type:a.EdgeType.Solid}}const u={color:s.fromValues(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:o.Transparency.OPAQUE,hasSlicePlane:!1},d={color:s.fromValues(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:o.Transparency.OPAQUE,hasSlicePlane:!1};e.createMaterial=function(e,t){return l(function(e){return e&&e.enabled&&e.edges||null}(e),t)},e.createMaterialFromEdges=l,e.createSolidEdgeMaterial=c,e.hasEdges=function(e){return e&&e.enabled&&(n.isExtrudeSymbol3DLayer(e)||n.isFillSymbol3DLayer(e))&&null!=e.edges},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/layerUtils":function(){define(["exports"],(function(e){"use strict";e.isExtrudeSymbol3DLayer=function(e){return"extrude"===e.type},e.isFillSymbol3DLayer=function(e){return"fill"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/sources/edgeRenderer/EdgeUtil.glsl":function(){define(["exports","../../../collections/Component/Material/shader/ComponentData.glsl","../../../core/shaderLibrary/attributes/NormalAttribute.glsl","../../../core/shaderLibrary/util/DoublePrecision.glsl","../../../core/shaderLibrary/util/RgbaFloatEncoding.glsl","../../../core/shaderModules/Float3DrawUniform","../../../core/shaderModules/Float3PassUniform","../../../core/shaderModules/glsl","../../../core/shaderModules/Matrix3DrawUniform","../../../core/shaderModules/Matrix3PassUniform","../../../core/shaderModules/Matrix4BindUniform","../../../core/shaderModules/Texture2DDrawUniform","../../../lib/VertexAttribute"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";var p,m;e.EdgeType=void 0,(p=e.EdgeType||(e.EdgeType={}))[p.Solid=0]="Solid",p[p.Sketch=1]="Sketch",p[p.Mixed=2]="Mixed",p[p.COUNT=3]="COUNT",e.EdgeSilhouette=void 0,(m=e.EdgeSilhouette||(e.EdgeSilhouette={}))[m.REGULAR=0]="REGULAR",m[m.SILHOUETTE=1]="SILHOUETTE",e.EdgeUtil=function(e,p){const{vertex:m}=e;m.include(s.RgbaFloatEncoding),e.include(r.NormalAttribute,p);const{silhouette:f,legacy:g,spherical:y}=p;m.uniforms.add(new d.Texture2DDrawUniform("componentDataTex",(e=>e.componentDataTexture))),e.attributes.add(h.VertexAttribute.COMPONENTINDEX,"float"),m.constants.add("lineWidthFractionFactor","float",8),m.constants.add("extensionLengthOffset","float",128),m.code.add(a.glsl`
    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
      float fieldIndex = ${a.glsl.float(3)}  * componentIndex + fieldOffset;
      float texSize = float(textureSize(componentDataTex, 0).x);
      float colIndex = mod(fieldIndex, texSize);
      float rowIndex = floor(fieldIndex / texSize);

      return vec2(colIndex, rowIndex) + 0.5;
    }

    struct ComponentData {
      vec4 color;
      vec3 normal;
      vec3 normal2;
      float lineWidth;
      float extensionLength;
      float type;
      float verticalOffset;
    };

    ComponentData readComponentData() {
      vec2 colorIndex = _componentTextureCoords(componentIndex, ${a.glsl.float(0)});
      vec2 otherIndex = _componentTextureCoords(componentIndex, ${a.glsl.float(1)});
      vec2 verticalOffsetIndex = _componentTextureCoords(float(componentIndex), ${a.glsl.float(2)} );
      vec3 normal = normalModel();
      vec3 normal2 = ${f?a.glsl`decompressNormal(normal2Compressed)`:a.glsl`normal`};

      vec4 colorValue = texelFetch(componentDataTex, ivec2(colorIndex), 0);
      vec4 otherValue = texelFetch(componentDataTex, ivec2(otherIndex), 0);
      float verticalOffset = uninterpolatedRGBAToFloat(texelFetch(componentDataTex, ivec2(verticalOffsetIndex), 0)) * ${a.glsl.float(t.maxElevationOffset)};

      return ComponentData(
        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity
        normal, normal2,
        otherValue.x * (255.0 / ${a.glsl.float(8)} ),
        otherValue.y * 255.0 - ${a.glsl.float(128)},
        -(otherValue.z * 255.0) + 0.5, // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;
        verticalOffset
      );
    }
  `),g?m.code.add(a.glsl`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(m.uniforms.add(new l.Matrix3DrawUniform("transformNormalGlobalFromModel",(e=>e.transformNormalGlobalFromModel))),m.code.add(a.glsl`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),f?(e.attributes.add(h.VertexAttribute.NORMAL2COMPRESSED,"vec2"),m.code.add(a.glsl`vec3 worldNormal(ComponentData data) {
return _modelToWorldNormal(normalize(data.normal + data.normal2));
}`)):m.code.add(a.glsl`vec3 worldNormal(ComponentData data) {
return _modelToWorldNormal(data.normal);
}`),g?m.code.add(a.glsl`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(m.include(i.DoublePrecision,p),m.uniforms.add(new c.Matrix3PassUniform("transformViewFromCameraRelativeRS",(e=>e.transformViewFromCameraRelativeRS)),new l.Matrix3DrawUniform("transformWorldFromModelRS",(e=>e.transformWorldFromModelRS)),new n.Float3DrawUniform("transformWorldFromModelTL",(e=>e.transformWorldFromModelTL)),new n.Float3DrawUniform("transformWorldFromModelTH",(e=>e.transformWorldFromModelTH)),new o.Float3PassUniform("transformWorldFromViewTL",(e=>e.transformWorldFromViewTL)),new o.Float3PassUniform("transformWorldFromViewTH",(e=>e.transformWorldFromViewTH))),m.code.add(a.glsl`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${y?"normalize(transformWorldFromModelTL + rotatedModelPosition);":"vec3(0.0, 0.0, 1.0);"}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),m.uniforms.add(new u.Matrix4BindUniform("transformProjFromView",(e=>e.camera.projectionMatrix))).code.add(a.glsl`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),m.code.add(a.glsl`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)},e.usesSketchLogic=function(t){return t===e.EdgeType.Sketch||t===e.EdgeType.Mixed},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/Material/shader/ComponentData.glsl":function(){define(["exports","../../../../../../../core/compilerUtils","../../../../../../../core/floatRGBA","./DecodeSymbolColor.glsl","../../../../core/shaderLibrary/ShaderOutput","../../../../core/shaderLibrary/util/RgbaFloatEncoding.glsl","../../../../core/shaderModules/Float4DrawUniform","../../../../core/shaderModules/glsl","../../../../core/shaderModules/IntegerDrawUniform","../../../../core/shaderModules/Texture2DDrawUniform","../../../../effects/geometry/olidUtils","../../../../lib/VertexAttribute"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";var h;e.ComponentDataType=void 0,(h=e.ComponentDataType||(e.ComponentDataType={}))[h.Uniform=0]="Uniform",h[h.Varying=1]="Varying",h[h.COUNT=2]="COUNT";const p=429496.7296;e.ComponentData=function(r,h){switch(h.componentData){case e.ComponentDataType.Varying:return function(e,t){const{vertex:r,fragment:o}=e;r.include(n.RgbaFloatEncoding),r.uniforms.add(new c.Texture2DDrawUniform("componentColorTex",(e=>e.componentParameters.texture.texture))),e.attributes.add(d.VertexAttribute.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4");const l=t.output===s.ShaderOutput.ObjectAndLayerIdColor;l&&e.varyings.add("vObjectAndLayerIdColor","vec4"),e.include(i.DecodeSymbolColor),r.constants.add("stride","float",u.olidEnabled()?3:2),r.code.add(a.glsl`vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
float index = componentIndex * stride + typeOffset;
float texSize = float(textureSize(componentColorTex, 0).x);
float coordX = mod(index, texSize);
float coordY = floor(index / texSize);
return vec2(coordX, coordY) + 0.5;
}`),r.code.add(a.glsl`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);
    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
   }

  float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);
    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
    return uninterpolatedRGBAToFloat(encodedElevation) * ${a.glsl.float(p)};
  }

  ${l?a.glsl`
          void forwardObjectAndLayerIdColor() {
            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);
            vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
          }`:a.glsl`void forwardObjectAndLayerIdColor() {}`}

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),o.code.add(a.glsl`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${l?a.glsl`fragColor = vObjectAndLayerIdColor;`:""}
  }
`)}(r,h);case e.ComponentDataType.Uniform:return function(e,t){const{vertex:r,fragment:i}=e;e.varyings.add("vExternalColor","vec4"),r.uniforms.add(new o.Float4DrawUniform("externalColor",(e=>e.componentParameters.externalColor))).code.add(a.glsl`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`);const n=t.output===s.ShaderOutput.ObjectAndLayerIdColor;i.uniforms.add(new l.IntegerDrawUniform("externalColorMixMode",(e=>e.componentParameters.externalColorMixMode))).code.add(a.glsl`
    void readExternalColor(out vec4 color, out int colorMixMode) {
      color = vExternalColor;
      colorMixMode = externalColorMixMode;
    }

    void outputObjectAndLayerIdColor() {
      ${a.If(n,"fragColor = vec4(0, 0, 0, 0);")}
    }
  `)}(r,h);case e.ComponentDataType.COUNT:return;default:t.neverReached(h.componentData)}},e.encodeElevationOffset=function(e,t){r.packFloatRGBA(e/p*.5+.5,t)},e.maxElevationOffset=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/floatRGBA":function(){define(["exports","./mathUtils"],(function(e,t){"use strict";function r(e,t=0){let r=0;for(let i=0;i<4;i++)r+=e[t+i]*s[i];return r}const i=[1,256,65536,16777216],s=[1/256,1/65536,1/16777216,1/4294967296],n=r(new Uint8ClampedArray([255,255,255,255]));e.packFloatRGBA=function(e,r,s=0){const o=t.clamp(e,0,n);for(let e=0;e<4;e++)r[s+e]=Math.floor(256*((a=o*i[e])-Math.floor(a)));var a},e.unpackFloatRGBA=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/Material/shader/DecodeSymbolColor.glsl":function(){define(["exports","../../../../../layers/support/symbolColorUtils","../../../../core/shaderModules/glsl"],(function(e,t,r){"use strict";e.DecodeSymbolColor=function(e){e.vertex.code.add(r.glsl`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${r.glsl.int(t.ColorMixModeEnum.Multiply)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${r.glsl.int(t.ColorMixModeEnum.Replace)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${r.glsl.int(t.ColorMixModeEnum.Tint)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${r.glsl.int(t.ColorMixModeEnum.Multiply)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/symbolColorUtils":function(){define(["exports","../../../../core/mathUtils"],(function(e,t){"use strict";var r;e.ColorMixModeEnum=void 0,(r=e.ColorMixModeEnum||(e.ColorMixModeEnum={}))[r.Multiply=1]="Multiply",r[r.Ignore=2]="Ignore",r[r.Replace=3]="Replace",r[r.Tint=4]="Tint";const i=255;e.encodeSymbolColor=function(r,s,n){if(null==r||s===e.ColorMixModeEnum.Ignore)return n[0]=255,n[1]=255,n[2]=255,void(n[3]=255);const o=t.clamp(Math.round(85*r[3]),0,85),a=0===o||s===e.ColorMixModeEnum.Tint?0:s===e.ColorMixModeEnum.Replace?85:170;n[0]=t.clamp(Math.round(r[0]*i),0,i),n[1]=t.clamp(Math.round(r[1]*i),0,i),n[2]=t.clamp(Math.round(r[2]*i),0,i),n[3]=o+a},e.parseColorMixMode=function(t){switch(t){case"multiply":default:return e.ColorMixModeEnum.Multiply;case"ignore":return e.ColorMixModeEnum.Ignore;case"replace":return e.ColorMixModeEnum.Replace;case"tint":return e.ColorMixModeEnum.Tint}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/IntegerDrawUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"int",t.BindType.Draw,((t,i,s)=>t.setUniform1i(e,r(i,s))))}}e.IntegerDrawUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../../shaderModules/glsl","../../../lib/VertexAttribute"],(function(e,t,r,i){"use strict";var s;e.NormalType=void 0,(s=e.NormalType||(e.NormalType={}))[s.Attribute=0]="Attribute",s[s.Compressed=1]="Compressed",s[s.ScreenDerivative=2]="ScreenDerivative",s[s.COUNT=3]="COUNT",e.NormalAttribute=function(s,n){switch(n.normalType){case e.NormalType.Compressed:s.attributes.add(i.VertexAttribute.NORMALCOMPRESSED,"vec2"),s.vertex.code.add(r.glsl`vec3 decompressNormal(vec2 normal) {
float z = 1.0 - abs(normal.x) - abs(normal.y);
return vec3(normal + sign(normal) * min(z, 0.0), z);
}
vec3 normalModel() {
return decompressNormal(normalCompressed);
}`);break;case e.NormalType.Attribute:s.attributes.add(i.VertexAttribute.NORMAL,"vec3"),s.vertex.code.add(r.glsl`vec3 normalModel() {
return normal;
}`);break;case e.NormalType.ScreenDerivative:s.fragment.code.add(r.glsl`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`);break;default:t.neverReached(n.normalType);case e.NormalType.COUNT:}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/DoublePrecision.glsl":function(){define(["exports","../../shaderModules/FloatBindUniform","../../shaderModules/glsl"],(function(e,t,r){"use strict";e.DoublePrecision=function({code:e,uniforms:i},s){i.add(new t.FloatBindUniform("dpDummy",(()=>1))),e.add(r.glsl`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 hiD = hiA + hiB;
vec3 loD = loA + loB;
return  dpDummy * hiD + loD;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Matrix3DrawUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"mat3",t.BindType.Draw,((t,i,s)=>t.setUniformMatrix3fv(e,r(i,s))))}}e.Matrix3DrawUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/DefaultMaterial":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../symbols/support/materialUtils","../../../ViewingMode","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/attributes/NormalAttribute.glsl","../core/shaderLibrary/output/Emissions.glsl","../core/shaderLibrary/shading/Normals.glsl","../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../effects/geometry/olidUtils","../lib/basicInterfaces","../lib/GLTextureMaterial","../lib/Material","../lib/OrderIndependentTransparency","../lib/RayIntersections","../lib/RenderSlot","../lib/VertexAttribute","../lib/verticalOffsetUtils","./DefaultBufferWriter","./internal/MaterialUtil","../shaders/DefaultMaterialTechnique","../shaders/DefaultMaterialTechniqueConfiguration","../shaders/RealisticTreeTechnique","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C){"use strict";class P extends m.Material{constructor(e,t){super(e,R),this.materialType="default",this.supportsEdges=!0,this.intersectDraped=void 0,this.produces=new Map([[y.RenderSlot.OPAQUE_MATERIAL,e=>(o.is3DGeometryOutputMRT(e)||o.isShadowRelatedOutput(e))&&!this.transparent],[y.RenderSlot.TRANSPARENT_MATERIAL,e=>(o.is3DGeometryOutputMRT(e)||o.isShadowRelatedOutput(e))&&this.transparent&&this.parameters.writeDepth],[y.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,e=>(o.is3DGeometryOutput(e)||o.isShadowRelatedOutput(e))&&this.transparent&&!this.parameters.writeDepth]]),this._vertexBufferLayout=function(e){const t=n.newLayout().vec3f(_.VertexAttribute.POSITION);return e.normalType===a.NormalType.Compressed?t.vec2i16(_.VertexAttribute.NORMALCOMPRESSED,{glNormalized:!0}):t.vec3f(_.VertexAttribute.NORMAL),e.hasVertexTangents&&t.vec4f(_.VertexAttribute.TANGENT),(e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId)&&t.vec2f16(_.VertexAttribute.UV0),e.hasVertexColors&&t.vec4u8(_.VertexAttribute.COLOR),e.hasSymbolColors&&t.vec4u8(_.VertexAttribute.SYMBOLCOLOR),d.olidEnabled()&&t.vec4u8(_.VertexAttribute.OLIDCOLOR),t}(this.parameters),this._configuration=new x.DefaultMaterialTechniqueConfiguration(t.spherical)}isVisibleForOutput(e){return e!==o.ShaderOutput.Shadow&&e!==o.ShaderOutput.ShadowExcludeHighlight&&e!==o.ShaderOutput.ShadowHighlight||this.parameters.castShadows}get visible(){const{layerOpacity:e,colorMixMode:t,opacity:r,externalColor:i}=this.parameters;return e*("replace"===t?1:r)*("ignore"===t?1:i[3])>=C.alphaCutoff}get _hasEmissiveBase(){return!!this.parameters.emissiveTextureId||!t.exactEquals(this.parameters.emissiveBaseColor,r.ZEROS)}get hasEmissions(){return this.parameters.emissiveStrength>0&&(this.parameters.emissiveSource===i.EmissiveSourceMode.Emissive&&this._hasEmissiveBase||this.parameters.emissiveSource===i.EmissiveSourceMode.Color)}getConfiguration(e,t){const{parameters:r,_configuration:s}=this,{treeRendering:n,doubleSided:d,doubleSidedType:p}=r;return super.getConfiguration(e,t,this._configuration),s.hasNormalTexture=!n&&!!r.normalTextureId,s.hasColorTexture=!!r.textureId,s.hasVertexTangents=!n&&r.hasVertexTangents,s.instanced=r.isInstanced,s.instancedDoublePrecision=r.instancedDoublePrecision,s.vvSize=!!r.vvSize,s.hasVerticalOffset=null!=r.verticalOffset,s.hasScreenSizePerspective=null!=r.screenSizePerspective,s.hasSlicePlane=r.hasSlicePlane,s.alphaDiscardMode=r.textureAlphaMode,s.normalType=n?a.NormalType.Attribute:r.normalType,s.transparent=this.transparent,s.writeDepth=r.writeDepth,s.customDepthTest=r.customDepthTest??h.DepthTestFunction.Less,s.hasOccludees=t.hasOccludees,s.cullFace=r.hasSlicePlane?h.CullFaceOptions.None:r.cullFace,s.cullAboveTerrain=t.cullAboveTerrain,s.hasModelTransformation=!n&&null!=r.modelTransformation,s.hasVertexColors=r.hasVertexColors,s.hasSymbolColors=r.hasSymbolColors,s.doubleSidedMode=n?c.NormalsDoubleSidedMode.WindingOrder:d&&"normal"===p?c.NormalsDoubleSidedMode.View:d&&"winding-order"===p?c.NormalsDoubleSidedMode.WindingOrder:c.NormalsDoubleSidedMode.None,s.instancedColor=r.hasInstancedColor,o.isColorOrColorEmission(e)?(s.terrainDepthTest=t.terrainDepthTest,s.receiveShadows=r.receiveShadows,s.receiveAmbientOcclusion=r.receiveAmbientOcclusion&&null!=t.ssao):(s.terrainDepthTest=!1,s.receiveShadows=s.receiveAmbientOcclusion=!1),s.vvColor=!!r.vvColor,s.textureAlphaPremultiplied=!!r.textureAlphaPremultiplied,s.pbrMode=r.usePBR?r.isSchematic?u.PBRMode.Schematic:u.PBRMode.Normal:u.PBRMode.Disabled,s.hasMetallicRoughnessTexture=!n&&!!r.metallicRoughnessTextureId,s.emissionSource=n?l.EmissionSource.None:null!=r.emissiveTextureId&&r.emissiveSource===i.EmissiveSourceMode.Emissive?l.EmissionSource.Texture:r.usePBR?r.emissiveSource===i.EmissiveSourceMode.Emissive?l.EmissionSource.EmissiveColor:l.EmissionSource.SymbolColor:l.EmissionSource.None,s.hasOcclusionTexture=!n&&!!r.occlusionTextureId,s.offsetBackfaces=!(!this.transparent||!r.offsetTransparentBackfaces),s.oitPass=t.oitPass,s.enableOffset=t.camera.relativeElevation<f.OITPolygonOffsetLimit,s.snowCover=t.snowCover,s.hasBloom=o.isColorEmission(e),s.hasColorTextureTransform=!!r.colorTextureTransformMatrix,s.hasNormalTextureTransform=!!r.normalTextureTransformMatrix,s.hasEmissionTextureTransform=!!r.emissiveTextureTransformMatrix,s.hasOcclusionTextureTransform=!!r.occlusionTextureTransformMatrix,s.hasMetallicRoughnessTextureTransform=!!r.metallicRoughnessTextureTransformMatrix,s}intersect(e,r,i,n,o,a){if(null!=this.parameters.verticalOffset){const e=i.camera;t.set(L,r[12],r[13],r[14]);let a=null;switch(i.viewingMode){case s.ViewingMode.Global:a=t.normalize(D,L);break;case s.ViewingMode.Local:a=t.copy(D,I)}let l=0;const c=t.subtract(N,L,e.eye),u=t.length(c),d=t.scale(c,c,1/u);let h=null;this.parameters.screenSizePerspective&&(h=t.dot(a,d)),l+=S.verticalOffsetAtDistance(e,u,this.parameters.verticalOffset,h??0,this.parameters.screenSizePerspective),t.scale(a,a,l),t.transformMat3(F,a,i.transform.inverseRotation),n=t.subtract(O,n,F),o=t.subtract(A,o,F)}g.intersectTriangleGeometry(e,i,n,o,b.getVerticalOffsetObject3D(i.verticalOffset),a)}createGLMaterial(e){return new M(e)}createBufferWriter(){return new v.DefaultBufferWriter(this._vertexBufferLayout)}get transparent(){return E(this.parameters)}}class M extends p.GLTextureMaterial{constructor(e){super({...e,...e.material.parameters})}beginSlot(e){this._material.setParameters({receiveShadows:e.shadowMap.enabled});const r=this._material.parameters;this.updateTexture(r.textureId);const i=e.camera.viewInverseTransposeMatrix;return t.set(r.origin,i[3],i[7],i[11]),this._material.setParameters(this.textureBindParameters),this.getTechnique(r.treeRendering?T.RealisticTreeTechnique:w.DefaultMaterialTechnique,e)}}class R extends w.DefaultMaterialPassParameters{constructor(){super(...arguments),this.treeRendering=!1,this.hasVertexTangents=!1}}function E(e){const{drivenOpacity:t,opacity:r,externalColor:[i,s,n,o],layerOpacity:a,texture:l,textureId:c,textureAlphaMode:u,colorMixMode:d}=e;return t||r<1&&"replace"!==d||o<1&&"ignore"!==d||a<1||(null!=l||null!=c)&&u!==h.AlphaDiscardMode.Opaque&&u!==h.AlphaDiscardMode.Mask&&"replace"!==d}const O=r.create(),A=r.create(),I=r.fromValues(0,0,1),D=r.create(),F=r.create(),L=r.create(),N=r.create();e.DefaultGLMaterial=M,e.DefaultMaterial=P,e.DefaultMaterialParameters=R,e.isTransparent=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/Normals.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../../shaderModules/glsl"],(function(e,t,r){"use strict";var i;e.NormalsDoubleSidedMode=void 0,(i=e.NormalsDoubleSidedMode||(e.NormalsDoubleSidedMode={}))[i.None=0]="None",i[i.View=1]="View",i[i.WindingOrder=2]="WindingOrder",i[i.COUNT=3]="COUNT",e.Normals=function(i,s){const n=i.fragment;switch(n.code.add(r.glsl`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),s.doubleSidedMode){case e.NormalsDoubleSidedMode.None:n.code.add(r.glsl`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case e.NormalsDoubleSidedMode.View:n.code.add(r.glsl`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case e.NormalsDoubleSidedMode.WindingOrder:n.code.add(r.glsl`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:t.neverReached(s.doubleSidedMode);case e.NormalsDoubleSidedMode.COUNT:}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl":function(){define(["exports","../attributes/VertexTextureCoordinates.glsl","../../shaderModules/Float3DrawUniform","../../shaderModules/Float3PassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DDrawUniform","../../shaderModules/Texture2DPassUniform","../../../materials/pbrUtils","../../../../../webgl/BindType","../../../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";var u;e.PBRMode=void 0,(u=e.PBRMode||(e.PBRMode={}))[u.Disabled=0]="Disabled",u[u.Normal=1]="Normal",u[u.Schematic=2]="Schematic",u[u.Water=3]="Water",u[u.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",u[u.Simplified=5]="Simplified",u[u.TerrainWithWater=6]="TerrainWithWater",u[u.COUNT=7]="COUNT";class d extends c.NoParameters{constructor(e,t){super(),this.textureOcclusion=e,this.textureMetallicRoughness=t,this.mrrFactors=a.schematicMRRFactors}}e.PBRRenderingParameters=d,e.PhysicallyBasedRenderingParameters=function(a,c){const u=c.pbrMode,d=a.fragment;if(u!==e.PBRMode.Schematic&&u!==e.PBRMode.Disabled&&u!==e.PBRMode.Normal)return void d.code.add(s.glsl`void applyPBRFactors() {}`);if(u===e.PBRMode.Disabled)return void d.code.add(s.glsl`void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`);if(u===e.PBRMode.Schematic)return void d.code.add(s.glsl`vec3 mrr = vec3(0.0, 0.6, 0.2);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`);const{hasMetallicRoughnessTexture:h,hasMetallicRoughnessTextureTransform:p,hasOcclusionTexture:m,hasOcclusionTextureTransform:f,bindType:g}=c;(h||m)&&a.include(t.VertexTextureCoordinates,c),d.code.add(s.glsl`vec3 mrr;
float occlusion;`),h&&d.uniforms.add(g===l.BindType.Pass?new o.Texture2DPassUniform("texMetallicRoughness",(e=>e.textureMetallicRoughness)):new n.Texture2DDrawUniform("texMetallicRoughness",(e=>e.textureMetallicRoughness))),m&&d.uniforms.add(g===l.BindType.Pass?new o.Texture2DPassUniform("texOcclusion",(e=>e.textureOcclusion)):new n.Texture2DDrawUniform("texOcclusion",(e=>e.textureOcclusion))),d.uniforms.add(g===l.BindType.Pass?new i.Float3PassUniform("mrrFactors",(e=>e.mrrFactors)):new r.Float3DrawUniform("mrrFactors",(e=>e.mrrFactors))),d.code.add(s.glsl`
    ${s.If(h,s.glsl`void applyMetallicRoughness(vec2 uv) {
            vec3 metallicRoughness = textureLookup(texMetallicRoughness, uv).rgb;
            mrr[0] *= metallicRoughness.b;
            mrr[1] *= metallicRoughness.g;
          }`)}

    ${s.If(m,"void applyOcclusion(vec2 uv) { occlusion *= textureLookup(texOcclusion, uv).r; }")}

    float getBakedOcclusion() {
      return ${m?"occlusion":"1.0"};
    }

    void applyPBRFactors() {
      mrr = mrrFactors;
      occlusion = 1.0;

      ${s.If(h,`applyMetallicRoughness(${p?"metallicRoughnessUV":"vuv0"});`)}
      ${s.If(m,`applyOcclusion(${f?"occlusionUV":"vuv0"});`)}
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/pbrUtils":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t,r){"use strict";const i=r.freeze(1,1,.5),s=r.freeze(0,.6,.2),n=r.freeze(0,1,.2);e.advancedMRRFactors=i,e.esriSymbologyMRRFactors=n,e.schematicMRRFactors=s,e.useSchematicPBR=function({normalTexture:e,metallicRoughnessTexture:i,metallicFactor:s,roughnessFactor:n,emissiveTexture:o,emissiveFactor:a,occlusionTexture:l}){return null==e&&null==i&&null==o&&(null==a||t.exactEquals(a,r.ZEROS))&&null==l&&(null==n||1===n)&&(null==s||1===s)},e.useSchematicPBRI3S=function({normalTexture:e,metallicRoughnessTexture:i,metallicFactor:s,roughnessFactor:n,emissiveTexture:o,emissiveFactor:a,occlusionTexture:l}){return null==e&&null==i&&null==o&&(null==a||t.exactEquals(a,r.ZEROS))&&null==l&&(null==n||1===n)&&(null==s||1===s||0===s)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/RayIntersections":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","./IntersectableGeometry","./Util","./VertexAttribute"],(function(e,t,r,i,s,n,o){"use strict";class a{constructor(e=!1,t=!0){this.isVerticalRay=e,this.normalRequired=t}}const l=i.create(),c=r.create();function u(e,t,r,s,n,o,a){if(null==e)return;const h=v(r,c);if(i.setMin(l,e.bbMin),i.setMax(l,e.bbMax),null!=n&&n.applyToAabb(l),S(l,t,h,s)){const{primitiveIndices:i,position:l}=e,c=i?i.length:l.indices.length/3;if(c>x){const i=e.getChildren();if(void 0!==i){for(const e of i)u(e,t,r,s,n,o,a);return}}!function(e,t,r,i,s,n,o,a,l,c,u){const h=e[0],p=e[1],m=e[2],f=t[0],y=t[1],_=t[2],{normalRequired:b}=c;for(let e=0;e<i;++e){const t=a[e],r=3*t,i=o*s[r];let c=n[i],v=n[i+1],S=n[i+2];const w=o*s[r+1];let x=n[w],C=n[w+1],P=n[w+2];const M=o*s[r+2];let R=n[M],E=n[M+1],O=n[M+2];null!=l&&([c,v,S]=l.applyToVertex(c,v,S,e),[x,C,P]=l.applyToVertex(x,C,P,e),[R,E,O]=l.applyToVertex(R,E,O,e));const A=x-c,I=C-v,D=P-S,F=R-c,L=E-v,N=O-S,U=y*N-L*_,V=_*F-N*f,B=f*L-F*y,G=A*U+I*V+D*B;if(Math.abs(G)<=T)continue;const k=h-c,z=p-v,j=m-S,q=k*U+z*V+j*B;if(G>0){if(q<0||q>G)continue}else if(q>0||q<G)continue;const H=z*D-I*j,W=j*A-D*k,$=k*I-A*z,Q=f*H+y*W+_*$;if(G>0){if(Q<0||q+Q>G)continue}else if(Q>0||q+Q<G)continue;const Z=(F*H+L*W+N*$)/G;Z>=0&&u(Z,t,b?g(A,I,D,F,L,N,d):null)}}(t,r,0,c,l.indices,l.data,l.stride,i,n,o,a)}}const d=r.create();function h(e,r,i,s,n,o,a,l,c,u){const d=r,h=P,g=Math.abs(d[0]),_=Math.abs(d[1]),b=Math.abs(d[2]),v=g>=_?g>=b?0:2:_>=b?1:2,S=v,w=d[S]<0?2:1,x=(v+w)%3,T=(v+(3-w))%3,C=d[x]/d[S],M=d[T]/d[S],R=1/d[S],E=p,O=m,A=f,{normalRequired:I}=c;for(let r=i;r<s;++r){const i=3*r,s=a*n[i];t.set(h[0],o[s+0],o[s+1],o[s+2]);const c=a*n[i+1];t.set(h[1],o[c+0],o[c+1],o[c+2]);const d=a*n[i+2];t.set(h[2],o[d+0],o[d+1],o[d+2]),l&&(t.copy(h[0],l.applyToVertex(h[0][0],h[0][1],h[0][2],r)),t.copy(h[1],l.applyToVertex(h[1][0],h[1][1],h[1][2],r)),t.copy(h[2],l.applyToVertex(h[2][0],h[2][1],h[2][2],r))),t.sub(E,h[0],e),t.sub(O,h[1],e),t.sub(A,h[2],e);const p=E[x]-C*E[S],m=E[T]-M*E[S],f=O[x]-C*O[S],g=O[T]-M*O[S],_=A[x]-C*A[S],b=A[T]-M*A[S],v=_*g-b*f,w=p*b-m*_,P=f*m-g*p;if((v<0||w<0||P<0)&&(v>0||w>0||P>0))continue;const D=v+w+P;if(0===D)continue;const F=v*(R*E[S])+w*(R*O[S])+P*(R*A[S]);if(F*Math.sign(D)<0)continue;const L=F/D;L>=0&&u(L,r,I?y(h):null)}}const p=r.create(),m=r.create(),f=r.create();function g(e,r,i,s,n,o,a){return t.set(_,e,r,i),t.set(b,s,n,o),t.cross(a,_,b),t.normalize(a,a),a}function y(e){return t.sub(_,e[1],e[0]),t.sub(b,e[2],e[0]),t.cross(d,_,b),t.normalize(d,d),d}const _=r.create(),b=r.create();function v(e,r){return t.set(r,1/e[0],1/e[1],1/e[2])}function S(e,t,r,i){return w(e,t,r,i,1/0)}function w(e,t,r,i,s){const n=(e[0]-i-t[0])*r[0],o=(e[3]+i-t[0])*r[0];let a=Math.min(n,o),l=Math.max(n,o);const c=(e[1]-i-t[1])*r[1],u=(e[4]+i-t[1])*r[1];if(l=Math.min(l,Math.max(c,u)),l<0)return!1;if(a=Math.max(a,Math.min(c,u)),a>l)return!1;const d=(e[2]-i-t[2])*r[2],h=(e[5]+i-t[2])*r[2];return l=Math.min(l,Math.max(d,h)),!(l<0)&&(a=Math.max(a,Math.min(d,h)),!(a>l)&&a<s)}const x=1e3,T=1e-7,C=r.create(),P=[r.create(),r.create(),r.create()];e.MeshIntersectionOptions=a,e.computeInvDir=function(e,r,i){return t.set(i,1/(r[0]-e[0]),1/(r[1]-e[1]),1/(r[2]-e[2]))},e.computeInvDirFromDirection=v,e.computeNormalFromBarycentric=g,e.intersectAabbInvDir=S,e.intersectAabbInvDirBefore=w,e.intersectRayTriangles=function(e,t,r,i,s,n,o,a,l,c=null,u=0){const h=e[0],p=e[1],m=e[2],f=t[0],y=t[1],_=t[2];for(let e=r;e<i;++e){const t=u+(c?c[e]:e),r=3*t,i=o*s[r],b=n[i],v=n[i+1],S=n[i+2],w=o*s[r+1],x=n[w],C=n[w+1],P=n[w+2],M=o*s[r+2],R=x-b,E=C-v,O=P-S,A=n[M]-b,I=n[M+1]-v,D=n[M+2]-S,F=y*D-I*_,L=_*A-D*f,N=f*I-A*y,U=R*F+E*L+O*N;if(Math.abs(U)<=T)continue;const V=h-b,B=p-v,G=m-S,k=V*F+B*L+G*N;if(U>0){if(k<0||k>U)continue}else if(k>0||k<U)continue;const z=B*O-E*G,j=G*R-O*V,q=V*E-R*B,H=f*z+y*j+_*q;if(U>0){if(H<0||k+H>U)continue}else if(H>0||k+H<U)continue;const W=(A*z+I*j+D*q)/U;W>=0&&l(W,t,a?g(R,E,O,A,I,D,d):null)}},e.intersectRayTrianglesWithDisplacementWatertight=h,e.intersectRayTrianglesWithVerticalOffsetENUGlobal=function(e,t,r,i,s,n,o,a,l,c,u,h=null,p=0){const m=e[0],f=e[1],y=e[2],_=t[0],b=t[1],v=t[2];for(let e=r;e<i;++e){const t=p+(h?h[e]:e),r=3*t,i=o*s[r],S=n[i],w=n[i+1],x=n[i+2],C=o*s[r+1],P=n[C],M=n[C+1],R=n[C+2],E=o*s[r+2],O=n[E],A=n[E+1],I=n[E+2],D=x-l,F=a/Math.sqrt(S*S+w*w+D*D),L=S+S*F,N=w+w*F,U=x+D*F,V=R-l,B=a/Math.sqrt(P*P+M*M+V*V),G=P+P*B,k=M+M*B,z=R+V*B,j=I-l,q=a/Math.sqrt(O*O+A*A+j*j),H=G-L,W=k-N,$=z-U,Q=O+O*q-L,Z=A+A*q-N,Y=I+j*q-U,X=b*Y-Z*v,K=v*Q-Y*_,J=_*Z-Q*b,ee=H*X+W*K+$*J;if(Math.abs(ee)<=T)continue;const te=m-L,re=f-N,ie=y-U,se=te*X+re*K+ie*J;if(ee>0){if(se<0||se>ee)continue}else if(se>0||se<ee)continue;const ne=re*$-W*ie,oe=ie*H-$*te,ae=te*W-H*re,le=_*ne+b*oe+v*ae;if(ee>0){if(le<0||se+le>ee)continue}else if(le>0||se+le<ee)continue;const ce=(Q*ne+Z*oe+Y*ae)/ee;ce>=0&&u(ce,t,c?g(H,W,$,Q,Z,Y,d):null)}},e.intersectRenderGeometryTriangles=function(e,t,r,i,s,n,o,a){const l=e[0],c=e[1],u=e[2],h=t[0],p=t[1],m=t[2];for(let e=r;e<i;++e){const t=3*e,r=t+1,i=t+2,f=n*t,y=s[f],_=s[f+1],b=s[f+2],v=n*r,S=n*i,w=s[v]-y,x=s[v+1]-_,C=s[v+2]-b,P=s[S]-y,M=s[S+1]-_,R=s[S+2]-b,E=p*R-M*m,O=m*P-R*h,A=h*M-P*p,I=w*E+x*O+C*A;if(Math.abs(I)<=T)continue;const D=l-y,F=c-_,L=u-b,N=D*E+F*O+L*A;if(I>0){if(N<0||N>I)continue}else if(N>0||N<I)continue;const U=F*C-x*L,V=L*w-C*D,B=D*x-w*F,G=h*U+p*V+m*B;if(I>0){if(G<0||N+G>I)continue}else if(G>0||N+G<I)continue;const k=(P*U+M*V+R*B)/I;k>=0&&a(k,e,o?g(w,x,C,P,M,R,d):null)}},e.intersectTriangleGeometry=function(e,r,i,l,c,d){if(!e.visible)return;const p=t.sub(C,l,i),m=(e,t,r)=>{d(e,r,t)},f=new a(!1,r.options.normalRequired);if(e.boundingInfo){n.assert(e.type===s.GeometryType.Mesh);const t=r.tolerance;u(e.boundingInfo,i,p,t,c,f,m)}else{const t=e.attributes.get(o.VertexAttribute.POSITION),r=t.indices;h(i,p,0,r.length/3,r,t.data,t.stride,c,f,m)}},e.intersectTriangles=function(e,r,i,s,n,o,a,l,c){const{data:u,stride:d}=o;h(e,t.sub(C,r,e),i,s,n,u,d,a,l,c)},e.triangleRayParallelTolerance=T,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/DefaultBufferWriter":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/buffer/BufferView","../lib/RayIntersections","../lib/VertexAttribute","./internal/bufferWriterUtils"],(function(e,t,r,i,s,n,o){"use strict";const a=r.create();e.DefaultBufferWriter=class{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.get(n.VertexAttribute.POSITION).indices.length}write(e,t,r,i,s,n){return o.writeDefaultAttributes(r,i,this.vertexBufferLayout,e,t,s,n)}intersect(e,r,o,l,c,u,d){const h=this.vertexBufferLayout.createView(e).getField(n.VertexAttribute.POSITION,i.BufferViewVec3f);if(null==h)return;const p=t.sub(a,u,c),m=h.count/3,f=l.options.normalRequired;s.intersectRenderGeometryTriangles(c,p,0,m,h.typedBuffer,h.typedBufferStride,f,((e,t,r)=>{d(e,r,t)}))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/DefaultMaterialTechnique":function(){define(["require","exports","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../symbols/support/materialUtils","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/attributes/NormalAttribute.glsl","../core/shaderLibrary/attributes/VertexNormal.glsl","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/basicInterfaces","../lib/Material","../lib/OrderIndependentTransparency","../lib/StencilUtils","../materials/pbrUtils","../../../../chunks/DefaultMaterial.glsl","../../../webgl/enums","../../../webgl/renderState","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_){"use strict";class b extends a.VertexNormalPassParameters{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=m.advancedMRRFactors,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=u.CullFaceOptions.Back,this.isInstanced=!1,this.hasInstancedColor=!1,this.emissiveStrength=0,this.emissiveSource=s.EmissiveSourceMode.Color,this.emissiveBaseColor=r.ZEROS,this.instancedDoublePrecision=!1,this.normalType=o.NormalType.Attribute,this.receiveShadows=!0,this.receiveAmbientOcclusion=!0,this.castShadows=!0,this.ambient=r.freeze(.2,.2,.2),this.diffuse=r.freeze(.8,.8,.8),this.externalColor=i.fromValues(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=r.create(),this.hasSlicePlane=!1,this.offsetTransparentBackfaces=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.modelTransformation=null,this.drivenOpacity=!1,this.writeDepth=!0,this.customDepthTest=u.DepthTestFunction.Less,this.textureAlphaMode=u.AlphaDiscardMode.Blend,this.textureAlphaCutoff=_.alphaCutoff,this.textureAlphaPremultiplied=!1,this.renderOccluded=d.RenderOccludedFlag.Occlude,this.isDecoration=!1}}class v extends a.VertexNormalDrawParameters{constructor(){super(...arguments),this.origin=r.create(),this.slicePlaneLocalOrigin=this.origin}}class S extends c.ShaderTechnique{constructor(t,r,i=new l.ReloadableShaderModule(f.DefaultMaterial,(()=>new Promise(((t,r)=>e(["./DefaultMaterial.glsl"],t,r)))))){super(t,r,i),this.type="DefaultMaterialTechnique"}_makePipeline(e,t){const{oitPass:r,output:i,transparent:s,cullFace:o,customDepthTest:a,hasOccludees:l}=e;return y.makePipelineState({blending:n.isColorOrColorEmission(i)&&s?h.blending(r):null,culling:(d=e,d.cullFace===u.CullFaceOptions.None&&(d.hasSlicePlane||d.transparent||d.doubleSidedMode)?null:y.cullingParams(o)),depthTest:{func:h.oitDepthTest(r,(m=a,m===u.DepthTestFunction.Lequal?g.CompareFunction.LEQUAL:g.CompareFunction.LESS))},depthWrite:h.depthWrite(e),drawBuffers:c.depthOnlyOutputBuffersOr(i,h.getDrawBuffers(r,i)),colorWrite:y.defaultColorWrite,stencilWrite:l?p.stencilWriteMaskOn:null,stencilTest:l?t?p.stencilToolMaskBaseParams:p.stencilBaseAllZerosParams:null,polygonOffset:h.oitPolygonOffset(e)});var d,m}initializePipeline(e){return this._occludeePipelineState=this._makePipeline(e,!0),this._makePipeline(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}t.DefaultMaterialDrawParameters=v,t.DefaultMaterialPassParameters=b,t.DefaultMaterialTechnique=S,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexNormal.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","./NormalAttribute.glsl","./VertexPosition.glsl","../../shaderModules/glsl","../../shaderModules/Matrix3DrawUniform","../../shaderModules/Matrix3PassUniform"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends n.VertexPositionPassParameters{constructor(){super(...arguments),this.transformNormalViewFromGlobal=r.create()}}class u extends n.VertexPositionDrawParameters{constructor(){super(...arguments),this.transformNormalGlobalFromModel=r.create(),this.toMapSpace=i.create()}}e.VertexNormal=function(e,r){switch(r.normalType){case s.NormalType.Attribute:case s.NormalType.Compressed:e.include(s.NormalAttribute,r),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add(new a.Matrix3DrawUniform("transformNormalGlobalFromModel",(e=>e.transformNormalGlobalFromModel)),new l.Matrix3PassUniform("transformNormalViewFromGlobal",(e=>e.transformNormalViewFromGlobal))),e.vertex.code.add(o.glsl`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`);break;case s.NormalType.ScreenDerivative:e.vertex.code.add(o.glsl`void forwardNormal() {}`);break;default:t.neverReached(r.normalType);case s.NormalType.COUNT:}},e.VertexNormalDrawParameters=u,e.VertexNormalPassParameters=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexPosition.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../util/DoublePrecision.glsl","../../shaderModules/Float3DrawUniform","../../shaderModules/Float3PassUniform","../../shaderModules/glsl","../../shaderModules/Matrix3DrawUniform","../../shaderModules/Matrix3PassUniform","../../shaderModules/Matrix4PassUniform","../../../lib/VertexAttribute","../../../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p extends h.NoParameters{constructor(){super(...arguments),this.transformWorldFromViewTH=i.create(),this.transformWorldFromViewTL=i.create(),this.transformViewFromCameraRelativeRS=t.create(),this.transformProjFromView=r.create()}}class m extends h.NoParameters{constructor(){super(...arguments),this.transformWorldFromModelRS=t.create(),this.transformWorldFromModelTH=i.create(),this.transformWorldFromModelTL=i.create()}}e.VertexPosition=function(e,t){const{attributes:r,vertex:i,varyings:h,fragment:p}=e;i.include(s.DoublePrecision,t),r.add(d.VertexAttribute.POSITION,"vec3"),h.add("vPositionWorldCameraRelative","vec3"),h.add("vPosition_view","vec3",{invariant:!0}),i.uniforms.add(new o.Float3PassUniform("transformWorldFromViewTH",(e=>e.transformWorldFromViewTH)),new o.Float3PassUniform("transformWorldFromViewTL",(e=>e.transformWorldFromViewTL)),new c.Matrix3PassUniform("transformViewFromCameraRelativeRS",(e=>e.transformViewFromCameraRelativeRS)),new u.Matrix4PassUniform("transformProjFromView",(e=>e.transformProjFromView)),new l.Matrix3DrawUniform("transformWorldFromModelRS",(e=>e.transformWorldFromModelRS)),new n.Float3DrawUniform("transformWorldFromModelTH",(e=>e.transformWorldFromModelTH)),new n.Float3DrawUniform("transformWorldFromModelTL",(e=>e.transformWorldFromModelTL))),i.code.add(a.glsl`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}`),i.code.add(a.glsl`
    void forwardPosition(float fOffset) {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      if (fOffset != 0.0) {
        vPositionWorldCameraRelative += fOffset * ${t.spherical?a.glsl`normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)`:a.glsl`vec3(0.0, 0.0, 1.0)`};
      }

      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;
      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
    }
  `),p.uniforms.add(new o.Float3PassUniform("transformWorldFromViewTL",(e=>e.transformWorldFromViewTL))),i.code.add(a.glsl`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),p.code.add(a.glsl`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)},e.VertexPositionDrawParameters=m,e.VertexPositionPassParameters=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4PassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"mat4",t.BindType.Pass,((t,i,s)=>t.setUniformMatrix4fv(e,r(i,s))))}}e.Matrix4PassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/StencilUtils":function(){define(["exports","./basicInterfaces","../../../webgl/enums"],(function(e,t,r){"use strict";const i={func:r.CompareFunction.LESS},s={func:r.CompareFunction.ALWAYS},n={function:{func:r.CompareFunction.ALWAYS,ref:t.StencilBits.OutlineVisualElementMask,mask:t.StencilBits.OutlineVisualElementMask},operation:{fail:r.StencilOperation.KEEP,zFail:r.StencilOperation.KEEP,zPass:r.StencilOperation.ZERO}},o={function:{func:r.CompareFunction.ALWAYS,ref:t.StencilBits.OutlineVisualElementMask,mask:t.StencilBits.OutlineVisualElementMask},operation:{fail:r.StencilOperation.KEEP,zFail:r.StencilOperation.KEEP,zPass:r.StencilOperation.REPLACE}},a={function:{func:r.CompareFunction.EQUAL,ref:t.StencilBits.OutlineVisualElementMask,mask:t.StencilBits.OutlineVisualElementMask},operation:{fail:r.StencilOperation.KEEP,zFail:r.StencilOperation.KEEP,zPass:r.StencilOperation.KEEP}},l={function:{func:r.CompareFunction.NOTEQUAL,ref:t.StencilBits.OutlineVisualElementMask,mask:t.StencilBits.OutlineVisualElementMask},operation:{fail:r.StencilOperation.KEEP,zFail:r.StencilOperation.KEEP,zPass:r.StencilOperation.KEEP}};e.depthCompareAlways=s,e.depthCompareLess=i,e.renderWhenBitIsNotSet=e=>({function:{func:r.CompareFunction.NOTEQUAL,ref:e,mask:e},operation:{fail:r.StencilOperation.KEEP,zFail:r.StencilOperation.KEEP,zPass:r.StencilOperation.KEEP}}),e.replaceBitWhenDepthTestPasses=e=>({function:{func:r.CompareFunction.ALWAYS,ref:e,mask:e},operation:{fail:r.StencilOperation.KEEP,zFail:r.StencilOperation.KEEP,zPass:r.StencilOperation.REPLACE}}),e.stencilBaseAllZerosParams=n,e.stencilToolMaskBaseParams=o,e.stencilToolMaskOccluderParams=a,e.stencilToolTransparentOccluderParams=l,e.stencilWriteMaskOff={mask:0},e.stencilWriteMaskOn={mask:255},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/DefaultMaterial.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec4f64","../views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/Offset.glsl","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/InstancedDoublePrecision.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/SymbolColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexNormal.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VerticalOffset.glsl","../views/3d/webgl-engine/core/shaderLibrary/default/DefaultMaterialAuxiliaryPasses.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ComputeNormalTexture.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientOcclusion.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Normals.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRendering.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TextureTransformUV.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/VisualVariables.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/DiscardOrAdjustAlpha.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/MixExternalColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/effects/weather/SnowCover.glsl","../views/3d/webgl-engine/lib/VertexAttribute","../views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V){"use strict";function B(e){const B=new U.ShaderBuilder,{attributes:G,vertex:k,fragment:z,varyings:j}=B,{output:q,normalType:H,offsetBackfaces:W,instancedColor:$,spherical:Q,receiveShadows:Z,snowCover:Y,pbrMode:X,textureAlphaPremultiplied:K,instancedDoublePrecision:J,hasVertexColors:ee,hasVertexTangents:te,hasColorTexture:re,hasNormalTexture:ie,hasNormalTextureTransform:se,hasColorTextureTransform:ne,hasBloom:oe}=e;if(R.addProjViewLocalOrigin(k,e),G.add(L.VertexAttribute.POSITION,"vec3"),j.add("vpos","vec3",{invariant:!0}),B.include(C.VisualVariables,e),B.include(a.InstancedDoublePrecision,e),B.include(p.VerticalOffset,e),B.include(T.colorTextureUV,e),!s.isColorOrColorEmission(q))return B.include(m.DefaultMaterialAuxiliaryPasses,e),B;B.include(T.normalTextureUV,e),B.include(T.emissiveTextureUV,e),B.include(T.occlusionTextureUV,e),B.include(T.metallicRoughnessTextureUV,e),R.addCameraPosition(k,e),B.include(l.NormalAttribute,e),B.include(o.Transform,e);const ae=H===l.NormalType.Attribute||H===l.NormalType.Compressed;return ae&&W&&B.include(i.Offset),B.include(f.ComputeNormalTexture,e),B.include(h.VertexNormal,e),$&&B.attributes.add(L.VertexAttribute.INSTANCECOLOR,"vec4"),j.add("vPositionLocal","vec3"),B.include(u.TextureCoordinateAttribute,e),B.include(r.ForwardLinearDepth,e),B.include(c.SymbolColor,e),B.include(d.VertexColor,e),k.uniforms.add(new O.Float4PassUniform("externalColor",(e=>"ignore"===e.colorMixMode?t.ONES:e.externalColor))),j.add("vcolorExt","vec4"),B.include(x.terrainDepthTest,e),k.main.add(I.glsl`
    forwardNormalizedVertexColor();
    vcolorExt = externalColor;
    ${I.If($,"vcolorExt *= instanceColor * 0.003921568627451;")}
    vcolorExt *= vvColor();
    vcolorExt *= getSymbolColor();
    forwardColorMixMode();

    vpos = getVertexInLocalOriginSpace();
    vPositionLocal = vpos - view[3].xyz;
    vpos = subtractOrigin(vpos);
    ${I.If(ae,"vNormalWorld = dpNormal(vvLocalNormal(normalModel()));")}
    vpos = addVerticalOffset(vpos, localOrigin);
    ${I.If(te,"vTangent = dpTransformVertexTangent(tangent);")}
    gl_Position = transformPosition(proj, view, vpos);
    ${I.If(ae&&W,"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);")}

    forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
    forwardLinearDepth();
    forwardTextureCoordinates();
    forwardColorUV();
    forwardNormalUV();
    forwardEmissiveUV();
    forwardOcclusionUV();
    forwardMetallicRoughnessUV();

    if (vcolorExt.a < ${I.glsl.float(V.alphaCutoff)}) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
    }
  `),B.include(y.EvaluateSceneLighting,e),z.include(g.EvaluateAmbientOcclusion,e),B.include(P.DiscardOrAdjustAlphaPass,e),B.include(J?w.ReadShadowMapPass:w.ReadShadowMapDraw,e),z.include(n.SliceDraw,e),B.include(N.outputColorHighlightOID,e),R.addCameraPosition(z,e),z.uniforms.add(k.uniforms.get("localOrigin"),new E.Float3PassUniform("ambient",(e=>e.ambient)),new E.Float3PassUniform("diffuse",(e=>e.diffuse)),new A.FloatPassUniform("opacity",(e=>e.opacity)),new A.FloatPassUniform("layerOpacity",(e=>e.layerOpacity))),re&&z.uniforms.add(new D.Texture2DPassUniform("tex",(e=>e.texture))),B.include(S.PhysicallyBasedRenderingParameters,e),z.include(v.PhysicallyBasedRendering,e),z.include(M.MixExternalColor),B.include(b.Normals,e),z.include(F.SnowCover,e),y.addAmbientBoostFactor(z),y.addLightingGlobalFactor(z),_.addMainLightIntensity(z),z.main.add(I.glsl`
    discardBySlice(vpos);
    discardByTerrainDepth();
    ${re?I.glsl`
            vec4 texColor = texture(tex, ${ne?"colorUV":"vuv0"});
            ${I.If(K,"texColor.rgb /= texColor.a;")}
            discardOrAdjustAlpha(texColor);`:I.glsl`vec4 texColor = vec4(1.0);`}
    shadingParams.viewDirection = normalize(vpos - cameraPosition);
    ${H===l.NormalType.ScreenDerivative?I.glsl`vec3 normal = screenDerivativeNormal(vPositionLocal);`:I.glsl`shadingParams.normalView = vNormalWorld;
                vec3 normal = shadingNormal(shadingParams);`}
    applyPBRFactors();
    float ssao = evaluateAmbientOcclusionInverse() * getBakedOcclusion();

    vec3 posWorld = vpos + localOrigin;

      float additionalAmbientScale = additionalDirectedAmbientLight(posWorld);
      float shadow = ${Z?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":I.If(Q,"lightingGlobalFactor * (1.0 - additionalAmbientScale)","0.0")};

    vec3 matColor = max(ambient, diffuse);
    vec3 albedo = mixExternalColor(${I.If(ee,"vColor.rgb *")} matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
    float opacity_ = layerOpacity * mixExternalOpacity(${I.If(ee,"vColor.a * ")} opacity, texColor.a, vcolorExt.a, int(colorMixMode));
    ${ie?`mat3 tangentSpace = computeTangentSpace(${te?"normal":"normal, vpos, vuv0"});\n            vec3 shadingNormal = computeTextureNormal(tangentSpace, ${se?"normalUV":"vuv0"});`:"vec3 shadingNormal = normal;"}
    vec3 normalGround = ${Q?"normalize(posWorld);":"vec3(0.0, 0.0, 1.0);"}

    ${I.If(Y,I.glsl`
          float snow = getSnow(normal, normalGround);
          albedo = mix(albedo, vec3(1), snow);
          shadingNormal = mix(shadingNormal, normal, snow);
          ssao = mix(ssao, 1.0, snow);`)}

    vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

    ${X===S.PBRMode.Normal||X===S.PBRMode.Schematic?I.glsl`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
            vec4 emission = ${oe?"vec4(0.0)":"getEmissions(albedo)"};
            ${I.If(Y,"mrr = applySnowToMRR(mrr, snow);\n                 emission = snowCoverForEmissions(emission, snow);")}
            vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:I.glsl`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
    vec4 finalColor = vec4(shadedColor, opacity_);
    outputColorHighlightOID(finalColor, vpos, albedo ${I.If(Y,", snow")});
  `),B}const G=Object.freeze(Object.defineProperty({__proto__:null,build:B},Symbol.toStringTag,{value:"Module"}));e.DefaultMaterial=G,e.build=B}))},"esri/views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepth.glsl":function(){define(["exports","./ShaderOutput","./attributes/VertexPosition.glsl","../shaderModules/Float2BindUniform","../shaderModules/glsl"],(function(e,t,r,i,s){"use strict";function n(e){e.varyings.add("linearDepth","float",{invariant:!0})}function o(e){e.vertex.uniforms.add(new i.Float2BindUniform("nearFar",(e=>e.camera.nearFar)))}function a(e){e.vertex.code.add(s.glsl`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}e.ForwardLinearDepth=function(e,i){const{vertex:l}=e;switch(i.output){case t.ShaderOutput.Color:case t.ShaderOutput.ColorEmission:if(i.receiveShadows)return n(e),void l.code.add(s.glsl`void forwardLinearDepth() { linearDepth = gl_Position.w; }`);break;case t.ShaderOutput.Shadow:case t.ShaderOutput.ShadowHighlight:case t.ShaderOutput.ShadowExcludeHighlight:case t.ShaderOutput.ViewshedShadow:return e.include(r.VertexPosition,i),n(e),o(e),a(e),void l.code.add(s.glsl`void forwardLinearDepth() {
linearDepth = calculateLinearDepth(nearFar, vPosition_view.z);
}`)}l.code.add(s.glsl`void forwardLinearDepth() {}`)},e.addCalculateLinearDepth=a,e.addLinearDepth=n,e.addNearFar=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/Offset.glsl":function(){define(["exports","../shaderModules/glsl"],(function(e,t){"use strict";e.Offset=function(e){e.vertex.code.add(t.glsl`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/Transform.glsl":function(){define(["exports","./ForwardLinearDepth.glsl","../shaderModules/glsl"],(function(e,t,r){"use strict";e.Transform=function(e){t.addCalculateLinearDepth(e),e.vertex.code.add(r.glsl`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),e.vertex.code.add(r.glsl`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/InstancedDoublePrecision.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../ShaderOutput","../util/DoublePrecision.glsl","../util/View.glsl","../../shaderModules/Float3BindUniform","../../shaderModules/glsl","../../shaderModules/Matrix3PassUniform","../../shaderModules/Matrix4PassUniform","../../../lib/VertexAttribute","../../../../../webgl/doublePrecisionUtils","../../../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";class g extends f.NoParameters{constructor(){super(...arguments),this.modelTransformation=null}}const y=r.create(),_=n.create();e.InstancedDoublePassParameters=g,e.InstancedDoublePrecision=function(e,r){const{hasModelTransformation:n,instancedDoublePrecision:f,instanced:g,output:b,hasVertexTangents:v}=r;n&&(e.vertex.uniforms.add(new h.Matrix4PassUniform("model",(e=>e.modelTransformation??i.IDENTITY))),e.vertex.uniforms.add(new d.Matrix3PassUniform("normalLocalOriginFromModel",(e=>(t.normalFromMat4(y,e.modelTransformation??i.IDENTITY),y))))),g&&f&&(e.attributes.add(p.VertexAttribute.INSTANCEMODELORIGINHI,"vec3"),e.attributes.add(p.VertexAttribute.INSTANCEMODELORIGINLO,"vec3"),e.attributes.add(p.VertexAttribute.INSTANCEMODEL,"mat3"),e.attributes.add(p.VertexAttribute.INSTANCEMODELNORMAL,"mat3"));const S=e.vertex;f&&(S.include(a.DoublePrecision,r),S.uniforms.add(new c.Float3BindUniform("viewOriginHi",(e=>m.encodeDoubleHi(s.set(_,e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]),_))),new c.Float3BindUniform("viewOriginLo",(e=>m.encodeDoubleLo(s.set(_,e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]),_))))),S.code.add(u.glsl`
    vec3 getVertexInLocalOriginSpace() {
      return ${n?f?"(model * vec4(instanceModel * localPosition().xyz, 1.0)).xyz":"(model * localPosition()).xyz":f?"instanceModel * localPosition().xyz":"localPosition().xyz"};
    }

    vec3 subtractOrigin(vec3 _pos) {
      ${f?u.glsl`
          // Issue: (should be resolved now with invariant position) https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/56280
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -instanceModelOriginHi, -instanceModelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `),S.code.add(u.glsl`
    vec3 dpNormal(vec4 _normal) {
      return normalize(${n?f?"normalLocalOriginFromModel * (instanceModelNormal * _normal.xyz)":"normalLocalOriginFromModel * _normal.xyz":f?"instanceModelNormal * _normal.xyz":"_normal.xyz"});
    }
    `),b===o.ShaderOutput.Normal&&(l.addViewNormal(S),S.code.add(u.glsl`
    vec3 dpNormalView(vec4 _normal) {
      return normalize((viewNormal * ${n?f?"vec4(normalLocalOriginFromModel * (instanceModelNormal * _normal.xyz), 1.0)":"vec4(normalLocalOriginFromModel * _normal.xyz, 1.0)":f?"vec4(instanceModelNormal * _normal.xyz, 1.0)":"_normal"}).xyz);
    }
    `)),v&&S.code.add(u.glsl`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${n?f?"return vec4(normalLocalOriginFromModel * (instanceModelNormal * _tangent.xyz), _tangent.w);":"return vec4(normalLocalOriginFromModel * _tangent.xyz, _tangent.w);":f?"return vec4(instanceModelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}
    }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/doublePrecisionUtils":function(){define(["exports"],(function(e){"use strict";const t=new Float32Array(2);e.decodeDoubleArray=function(e,t,r){for(let i=0;i<r;++i)t[i]=e[2*i]+e[2*i+1]},e.encodeDoubleArray=function(e,t,r){for(let i=0;i<r;++i)t[2*i]=e[i],t[2*i+1]=e[i]-t[2*i]},e.encodeDoubleHi=function(e,r){const i=e.length;for(let s=0;s<i;++s)t[0]=e[s],r[s]=t[0];return r},e.encodeDoubleLo=function(e,r){const i=e.length;for(let s=0;s<i;++s)t[0]=e[s],t[1]=e[s]-t[0],r[s]=t[1];return r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/SymbolColor.glsl":function(){define(["exports","../../../collections/Component/Material/shader/DecodeSymbolColor.glsl","../../shaderModules/glsl","../../shaderModules/IntegerPassUniform","../../../lib/VertexAttribute","../../../materials/internal/MaterialUtil"],(function(e,t,r,i,s,n){"use strict";e.SymbolColor=function(e,o){o.hasSymbolColors?(e.include(t.DecodeSymbolColor),e.attributes.add(s.VertexAttribute.SYMBOLCOLOR,"vec4"),e.varyings.add("colorMixMode","mediump float"),e.vertex.code.add(r.glsl`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`)):(e.fragment.uniforms.add(new i.IntegerPassUniform("colorMixMode",(e=>n.colorMixModes[e.colorMixMode]))),e.vertex.code.add(r.glsl`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/IntegerPassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"int",t.BindType.Pass,((t,i,s)=>t.setUniform1i(e,r(i,s))))}}e.IntegerPassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexColor.glsl":function(){define(["exports","../../shaderModules/glsl","../../../lib/VertexAttribute"],(function(e,t,r){"use strict";e.VertexColor=function(e,i){i.hasVertexColors?(e.attributes.add(r.VertexAttribute.COLOR,"vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(t.glsl`void forwardVertexColor() { vColor = color; }`),e.vertex.code.add(t.glsl`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):e.vertex.code.add(t.glsl`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/default/DefaultMaterialAuxiliaryPasses.glsl":function(){define(["exports","../ForwardLinearDepth.glsl","../ShaderOutput","../Slice.glsl","../Transform.glsl","../attributes/NormalAttribute.glsl","../attributes/ObjectAndLayerIdColor.glsl","../attributes/TextureCoordinateAttribute.glsl","../attributes/VertexNormal.glsl","../output/OutputDepth.glsl","../output/OutputHighlight.glsl","../shading/VisualVariables.glsl","../util/DiscardOrAdjustAlpha.glsl","../util/View.glsl","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform","../../../lib/basicInterfaces"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g){"use strict";e.DefaultMaterialAuxiliaryPasses=function(e,y){const{vertex:_,fragment:b,varyings:v}=e,{hasColorTexture:S,alphaDiscardMode:w}=y,x=S&&w!==g.AlphaDiscardMode.Opaque,{output:T,normalType:C,hasColorTextureTransform:P}=y;switch(T){case r.ShaderOutput.Depth:p.addProjViewLocalOrigin(_,y),e.include(s.Transform,y),b.include(i.SliceDraw,y),e.include(a.TextureCoordinateAttribute,y),x&&b.uniforms.add(new f.Texture2DPassUniform("tex",(e=>e.texture))),_.main.add(m.glsl`vpos = getVertexInLocalOriginSpace();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPosition(proj, view, vpos);
forwardTextureCoordinates();`),e.include(h.DiscardOrAdjustAlphaPass,y),b.main.add(m.glsl`
        discardBySlice(vpos);
        ${m.If(x,m.glsl`vec4 texColor = texture(tex, ${P?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}`);break;case r.ShaderOutput.Shadow:case r.ShaderOutput.ShadowHighlight:case r.ShaderOutput.ShadowExcludeHighlight:case r.ShaderOutput.ViewshedShadow:case r.ShaderOutput.ObjectAndLayerIdColor:p.addProjViewLocalOrigin(_,y),e.include(s.Transform,y),e.include(a.TextureCoordinateAttribute,y),e.include(d.VisualVariables,y),e.include(c.OutputDepth,y),b.include(i.SliceDraw,y),e.include(o.ObjectAndLayerIdColor,y),t.addNearFar(e),v.add("depth","float",{invariant:!0}),x&&b.uniforms.add(new f.Texture2DPassUniform("tex",(e=>e.texture))),_.main.add(m.glsl`vpos = getVertexInLocalOriginSpace();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
forwardTextureCoordinates();
forwardObjectAndLayerIdColor();`),e.include(h.DiscardOrAdjustAlphaPass,y),b.main.add(m.glsl`
        discardBySlice(vpos);
        ${m.If(x,m.glsl`vec4 texColor = texture(tex, ${P?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}
        ${T===r.ShaderOutput.ObjectAndLayerIdColor?m.glsl`outputObjectAndLayerIdColor();`:m.glsl`outputDepth(depth);`}`);break;case r.ShaderOutput.Normal:{p.addProjViewLocalOrigin(_,y),e.include(s.Transform,y),e.include(n.NormalAttribute,y),e.include(l.VertexNormal,y),e.include(a.TextureCoordinateAttribute,y),e.include(d.VisualVariables,y),x&&b.uniforms.add(new f.Texture2DPassUniform("tex",(e=>e.texture))),C===n.NormalType.ScreenDerivative&&v.add("vPositionView","vec3",{invariant:!0});const t=C===n.NormalType.Attribute||C===n.NormalType.Compressed;_.main.add(m.glsl`
        vpos = getVertexInLocalOriginSpace();
        ${t?m.glsl`vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:m.glsl`vPositionView = (view * vec4(vpos, 1.0)).xyz;`}
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, vpos);
        forwardTextureCoordinates();`),b.include(i.SliceDraw,y),e.include(h.DiscardOrAdjustAlphaPass,y),b.main.add(m.glsl`
        discardBySlice(vpos);
        ${m.If(x,m.glsl`vec4 texColor = texture(tex, ${P?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}

        ${C===n.NormalType.ScreenDerivative?m.glsl`vec3 normal = screenDerivativeNormal(vPositionView);`:m.glsl`vec3 normal = normalize(vNormalWorld);
                    if (gl_FrontFacing == false){
                      normal = -normal;
                    }`}
        fragColor = vec4(0.5 + 0.5 * normal, 1.0);`);break}case r.ShaderOutput.Highlight:p.addProjViewLocalOrigin(_,y),e.include(s.Transform,y),e.include(a.TextureCoordinateAttribute,y),e.include(d.VisualVariables,y),x&&b.uniforms.add(new f.Texture2DPassUniform("tex",(e=>e.texture))),_.main.add(m.glsl`vpos = getVertexInLocalOriginSpace();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPosition(proj, view, vpos);
forwardTextureCoordinates();`),b.include(i.SliceDraw,y),e.include(h.DiscardOrAdjustAlphaPass,y),e.include(u.OutputHighlight,y),b.main.add(m.glsl`
        discardBySlice(vpos);
        ${m.If(x,m.glsl`vec4 texColor = texture(tex, ${P?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}
        calculateOcclusionAndOutputHighlight();`)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/output/OutputDepth.glsl":function(){define(["exports","../ShaderOutput","../../shaderModules/glsl"],(function(e,t,r){"use strict";e.OutputDepth=function(e,i){switch(i.output){case t.ShaderOutput.Shadow:case t.ShaderOutput.ShadowHighlight:case t.ShaderOutput.ShadowExcludeHighlight:case t.ShaderOutput.ViewshedShadow:e.fragment.code.add(r.glsl`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 20.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
return depth + SLOPE_SCALE * m + BIAS;
}
void outputDepth(float _linearDepth){
float fragDepth = _calculateFragDepth(_linearDepth);
gl_FragDepth = fragDepth;
}`)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/DiscardOrAdjustAlpha.glsl":function(){define(["exports","../../shaderModules/FloatDrawUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../../lib/basicInterfaces","../../../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n){"use strict";function o(e,t,r){const o=e.fragment,a=t.alphaDiscardMode,l=a===s.AlphaDiscardMode.Blend;a!==s.AlphaDiscardMode.Mask&&a!==s.AlphaDiscardMode.MaskBlend||o.uniforms.add(r),o.code.add(i.glsl`
    void discardOrAdjustAlpha(inout vec4 color) {
      ${a===s.AlphaDiscardMode.Opaque?"color.a = 1.0;":`if (color.a < ${l?i.glsl.float(n.alphaCutoff):"textureAlphaCutoff"}) {\n              discard;\n             } ${i.If(a===s.AlphaDiscardMode.Mask,"else { color.a = 1.0; }")}`}
    }
  `)}e.DiscardOrAdjustAlphaDraw=function(e,r){o(e,r,new t.FloatDrawUniform("textureAlphaCutoff",(e=>e.textureAlphaCutoff)))},e.DiscardOrAdjustAlphaPass=function(e,t){o(e,t,new r.FloatPassUniform("textureAlphaCutoff",(e=>e.textureAlphaCutoff)))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ComputeNormalTexture.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../core/libs/gl-matrix-2/factories/vec2f64","../attributes/TextureCoordinateAttribute.glsl","../attributes/VertexTextureCoordinates.glsl","./Normals.glsl","../../shaderModules/Float2PassUniform","../../shaderModules/glsl","../../shaderModules/Matrix3PassUniform","../../shaderModules/Texture2DDrawUniform","../../shaderModules/Texture2DPassUniform","../../../lib/VertexAttribute","../../../../../webgl/BindType"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.ComputeNormalTexture=function(e,p){const m=e.fragment,{hasVertexTangents:f,doubleSidedMode:g,hasNormalTexture:y,textureCoordinateType:_,bindType:b,hasNormalTextureTransform:v}=p;f?(e.attributes.add(d.VertexAttribute.TANGENT,"vec4"),e.varyings.add("vTangent","vec4"),g===n.NormalsDoubleSidedMode.WindingOrder?m.code.add(a.glsl`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):m.code.add(a.glsl`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):m.code.add(a.glsl`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`),y&&_!==i.TextureCoordinateType.None&&(e.include(s.VertexTextureCoordinates,p),m.uniforms.add(b===h.BindType.Pass?new u.Texture2DPassUniform("normalTexture",(e=>e.textureNormal)):new c.Texture2DDrawUniform("normalTexture",(e=>e.textureNormal))),v&&(m.uniforms.add(new o.Float2PassUniform("scale",(e=>e.scale??r.ONES))),m.uniforms.add(new l.Matrix3PassUniform("normalTextureTransformMatrix",(e=>e.normalTextureTransformMatrix??t.IDENTITY)))),m.code.add(a.glsl`vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
vec3 rawNormal = textureLookup(normalTexture, uv).rgb * 2.0 - 1.0;`),v&&m.code.add(a.glsl`mat3 normalRotation = mat3(normalTextureTransformMatrix[0][0]/scale[0], normalTextureTransformMatrix[0][1]/scale[1], 0.0,
normalTextureTransformMatrix[1][0]/scale[0], normalTextureTransformMatrix[1][1]/scale[1], 0.0,
0.0, 0.0, 0.0 );
rawNormal.xy = (normalRotation * vec3(rawNormal.x, rawNormal.y, 1.0)).xy;`),m.code.add(a.glsl`return tangentSpace * rawNormal;
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientOcclusion.glsl":function(){define(["exports","../../shaderModules/glsl","../../shaderModules/Texture2DBindUniform","../../../effects/ssao/SSAO"],(function(e,t,r,i){"use strict";e.EvaluateAmbientOcclusion=function(e,s){s.receiveAmbientOcclusion?(e.uniforms.add(new r.Texture2DBindUniform("ssaoTex",(e=>e.ssao?.getTexture()))),e.constants.add("blurSizePixelsInverse","float",1/i.blurSizePixels),e.code.add(t.glsl`float evaluateAmbientOcclusionInverse() {
vec2 ssaoTextureSizeInverse = 1.0 / vec2(textureSize(ssaoTex, 0));
return texture(ssaoTex, gl_FragCoord.xy * blurSizePixelsInverse * ssaoTextureSizeInverse).r;
}
float evaluateAmbientOcclusion() {
return 1.0 - evaluateAmbientOcclusionInverse();
}`)):e.code.add(t.glsl`float evaluateAmbientOcclusionInverse() { return 1.0; }
float evaluateAmbientOcclusion() { return 0.0; }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/ssao/SSAO":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/time","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl","../../../webgl/RenderNode","../../core/FBOCacheFormats","../../core/shaderLibrary/shading/ScreenSpaceConstants","./SSAOBlurTechnique","./SSAONoiseData","./SSAOParameters","./SSAOTechnique","../../lib/basicInterfaces","../../../../../chunks/SSAO.glsl","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T){"use strict";e.SSAO=class extends p{constructor(e){super(e),this.consumes={required:["normals"]},this.produces=h.InternalRenderCategory.SSAO,this.isEnabled=()=>!1,this._enableTime=n.Milliseconds(0),this._passParameters=new _.SSAOPassParameters,this._drawParameters=new _.BlurDrawParameters}initialize(){const e=Uint8Array.from(atob(y.noiseData),(e=>e.charCodeAt(0))),t=new T.TextureDescriptor;t.wrapMode=w.TextureWrapMode.CLAMP_TO_EDGE,t.pixelFormat=w.PixelFormat.RGB,t.wrapMode=w.TextureWrapMode.REPEAT,t.hasMipmap=!0,t.width=32,t.height=32,this._passParameters.noiseTexture=new x.Texture(this.renderingContext,t,e),this.techniques.precompile(b.SSAOTechnique),this.techniques.precompile(g.SSAOBlurTechnique),this.addHandles(s.watch((()=>this.isEnabled()),(()=>this._enableTime=n.Milliseconds(0))))}destroy(){this._passParameters.noiseTexture=i.disposeMaybe(this._passParameters.noiseTexture)}render(e){const t=e.find((({name:e})=>"normals"===e)),i=t?.getTexture(),s=t?.getTexture(w.DepthStencilAttachment);if(!i||!s)return;const o=this.techniques.get(b.SSAOTechnique),a=this.techniques.get(g.SSAOBlurTechnique);if(!o.compiled||!a.compiled)return this._enableTime=n.Milliseconds(performance.now()),void this.requestRender(v.RenderRequestType.UPDATE);0===this._enableTime&&(this._enableTime=n.Milliseconds(performance.now()));const l=this.renderingContext,c=this.view.qualitySettings.fadeDuration,u=this.bindParameters,p=u.camera,y=p.relativeElevation,_=r.clamp((f.distanceFadeEnd-y)/(f.distanceFadeEnd-f.distanceFadeStart),0,1),x=c>0?Math.min(c,performance.now()-this._enableTime)/c:1,T=x*_;this._passParameters.normalTexture=i,this._passParameters.depthTexture=s,this._passParameters.projScale=1/p.computeScreenPixelSizeAtDist(1),this._passParameters.intensity=4*C/S.getRadius(p)**6*T;const P=p.fullViewport[2],M=p.fullViewport[3],R=this.fboCache.acquire(P,M,"ssao input",m.ColorFormat.RG8UNORM);l.bindFramebuffer(R.fbo),l.setViewport(0,0,P,M),l.bindTechnique(o,u,this._passParameters,this._drawParameters),l.screen.draw();const E=Math.round(P/2),O=Math.round(M/2),A=this.fboCache.acquire(E,O,"ssao blur",m.ColorFormat.R8UNORM);l.bindFramebuffer(A.fbo),this._drawParameters.colorTexture=R.getTexture(),d.set(this._drawParameters.blurSize,0,2/M),l.bindTechnique(a,u,this._passParameters,this._drawParameters),l.setViewport(0,0,E,O),l.screen.draw(),R.release();const I=this.fboCache.acquire(E,O,h.InternalRenderCategory.SSAO,m.ColorFormat.R8UNORM);return l.bindFramebuffer(I.fbo),l.setViewport(0,0,P,M),l.setClearColor(1,1,1,0),l.clear(w.FramebufferBit.COLOR),this._drawParameters.colorTexture=A.getTexture(),d.set(this._drawParameters.blurSize,2/P,0),l.bindTechnique(a,u,this._passParameters,this._drawParameters),l.setViewport(0,0,E,O),l.screen.draw(),l.setViewport4fv(p.fullViewport),A.release(),x<1&&this.requestRender(v.RenderRequestType.UPDATE),I}},t.__decorate([o.property()],e.SSAO.prototype,"consumes",void 0),t.__decorate([o.property()],e.SSAO.prototype,"produces",void 0),t.__decorate([o.property({constructOnly:!0})],e.SSAO.prototype,"isEnabled",void 0),e.SSAO=t.__decorate([u.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],e.SSAO);const C=.5;e.blurSizePixels=2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ScreenSpaceConstants":function(){define(["exports"],(function(e){"use strict";e.distanceFadeEnd=5e5,e.distanceFadeStart=3e5,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/ssao/SSAOBlurTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/SSAOBlur.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.SSAOBlur,(()=>new Promise(((t,r)=>e(["../../shaders/SSAOBlur.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.SSAOBlurTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/SSAOBlur.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderModules/Float2DrawUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DDrawUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l){"use strict";function c(){const e=new l.ShaderBuilder,c=e.fragment;return e.include(t.ScreenSpacePass),c.include(r.ReadDepth),c.uniforms.add(new a.Texture2DPassUniform("depthMap",(e=>e.depthTexture)),new o.Texture2DDrawUniform("tex",(e=>e.colorTexture)),new i.Float2DrawUniform("blurSize",(e=>e.blurSize)),new s.FloatPassUniform("projScale",((e,t)=>{const r=t.camera.distance;return r>5e4?Math.max(0,e.projScale-(r-5e4)):e.projScale}))),c.code.add(n.glsl`
    void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
      float c = texture(tex, uv).r;
      float d = linearDepthFromTexture(depthMap, uv);

      float ddiff = d - center_d;

      float w = exp(-r * r * ${n.glsl.float(.08)} - ddiff * ddiff * sharpness);
      wTotal += w;
      bTotal += w * c;
    }
  `),e.outputs.add("fragBlur","float"),c.main.add(n.glsl`
    float b = 0.0;
    float w_total = 0.0;

    float center_d = linearDepthFromTexture(depthMap, uv);

    float sharpness = -0.05 * projScale / center_d;
    for (int r = -${n.glsl.int(4)}; r <= ${n.glsl.int(4)}; ++r) {
      float rf = float(r);
      vec2 uvOffset = uv + rf * blurSize;
      blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
    }
    fragBlur = b / w_total;`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}));e.SSAOBlur=u,e.build=c}))},"esri/views/3d/webgl-engine/core/shaderModules/Float2DrawUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"vec2",t.BindType.Draw,((t,i,s,n)=>t.setUniform2fv(e,r(i,s,n))))}}e.Float2DrawUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/ssao/SSAONoiseData":function(){define(["exports"],(function(e){"use strict";e.noiseData="eXKEvZaUc66cjIKElE1jlJ6MjJ6Ufkl+jn2fcXp5jBx7c6KEflSGiXuXeW6OWs+tfqZ2Yot2Y7Zzfo2BhniEj3xoiXuXj4eGZpqEaHKDWjSMe7palFlzc3BziYOGlFVzg6Zzg7CUY5JrjFF7eYJ4jIKEcyyEonSXe7qUfqZ7j3xofqZ2c4R5lFZ5Y0WUbppoe1l2cIh2ezyUho+BcHN2cG6DbpqJhqp2e1GcezhrdldzjFGUcyxjc3aRjDyEc1h7Sl17c6aMjH92pb6Mjpd4dnqBjMOEhqZleIOBYzB7gYx+fnqGjJuEkWlwnCx7fGl+c4hjfGyRe5qMlNOMfnqGhIWHc6OMi4GDc6aMfqZuc6aMzqJzlKZ+lJ6Me3qRfoFue0WUhoR5UraEa6qMkXiPjMOMlJOGe7JrUqKMjK6MeYRzdod+Sl17boiPc6qEeYBlcIh2c1WEe7GDiWCDa0WMjEmMdod+Y0WcdntzhmN8WjyMjKJjiXtzgYxYaGd+a89zlEV7e2GJfnd+lF1rcK5zc4p5cHuBhL6EcXp5eYB7fnh8iX6HjIKEeaxuiYOGc66RfG2Ja5hzjlGMjEmMe9OEgXuPfHyGhPeEdl6JY02McGuMfnqGhFiMa3WJfnx2l4hwcG1uhmN8c0WMc39og1GBbrCEjE2EZY+JcIh2cIuGhIWHe0mEhIVrc09+gY5+eYBlnCyMhGCDl3drfmmMgX15aGd+gYx+fnuRfnhzY1SMsluJfnd+hm98WtNrcIuGh4SEj0qPdkqOjFF7jNNjdnqBgaqUjMt7boeBhnZ4jDR7c5pze4GGjEFrhLqMjHyMc0mUhKZze4WEa117kWlwbpqJjHZ2eX2Bc09zeId+e0V7WlF7jHJ2l72BfId8l3eBgXyBe897jGl7c66cgW+Xc76EjKNbgaSEjGx4fId8jFFjgZB8cG6DhlFziZhrcIh2fH6HgUqBgXiPY8dahGFzjEmMhEFre2dxhoBzc5SGfleGe6alc7aUeYBlhKqUdlp+cH5za4OEczxza0Gcc4J2jHZ5iXuXjH2Jh5yRjH2JcFx+hImBjH+MpddCl3dreZeJjIt8ZW18bm1zjoSEeIOBlF9oh3N7hlqBY4+UeYFwhLJjeYFwaGd+gUqBYxiEYot2fqZ2ondzhL6EYyiEY02Ea0VjgZB8doaGjHxoc66cjEGEiXuXiXWMiZhreHx8frGMe75rY02Ec5pzfnhzlEp4a3VzjM+EhFFza3mUY7Zza1V5e2iMfGyRcziEhDyEkXZ2Y4OBnCx7g5t2eyBjgV6EhEFrcIh2dod+c4Z+nJ5zjm15jEmUeYxijJp7nL6clIpjhoR5WrZraGd+fnuRa6pzlIiMg6ZzfHx5foh+eX1ufnB5eX1ufnB5aJt7UqKMjIh+e3aBfm5lbYSBhGFze6J4c39oc0mUc4Z+e0V7fKFVe0WEdoaGY02Ec4Z+Y02EZYWBfH6HgU1+gY5+hIWUgW+XjJ57ebWRhFVScHuBfJ6PhBx7WqJzlM+Ujpd4gHZziX6HjHmEgZN+lJt5boiPe2GJgX+GjIGJgHZzeaxufnB5hF2JtdN7jJ57hp57hK6ElFVzg6ZzbmiEbndzhIWHe3uJfoFue3qRhJd2j3xoc65zlE1jc3p8lE1jhniEgXJ7e657vZaUc3qBh52BhIF4aHKDa9drgY5+c52GWqZzbpqJe8tjnM+UhIeMfo2BfGl+hG1zSmmMjKJjZVaGgX15c1lze0mEp4OHa3mUhIWHhDyclJ6MeYOJkXiPc0VzhFiMlKaEboSJa5Jze41re3qRhn+HZYWBe0mEc4p5fnORbox5lEp4hGFjhGGEjJuEc1WEhLZjeHeGa7KlfHx2hLaMeX1ugY5+hIWHhKGPjMN7c1WEho1zhoBzZYx7fnhzlJt5exyUhFFziXtzfmmMa6qMYyiEiXxweV12kZSMeWqXSl17fnhzxmmMrVGEe1mcc4p5eHeGjK6MgY5+doaGa6pzlGV7g1qBh4KHkXiPeW6OaKqafqZ2eXZ5e1V7jGd7boSJc3BzhJd2e0mcYot2h1RoY8dahK6EQmWEWjx7e1l2lL6UgXyBdnR4eU9zc0VreX1umqaBhld7fo2Bc6KEc5Z+hDyEcIeBWtNrfHyGe5qMhMuMe5qMhEGEbVVupcNzg3aHhIF4boeBe0mEdlptc39ofFl5Y8uUlJOGiYt2UmGEcyxjjGx4jFF7a657ZYWBnElzhp57iXtrgZN+tfOEhIOBjE2HgU1+e8tjjKNbiWCDhE15gUqBgYN7fnqGc66ce9d7iYSBj0qPcG6DnGGcT3eGa6qMZY+JlIiMl4hwc3aRdnqBlGV7eHJ2hLZjfnuRhDyEeX6MSk17g6Z+c6aUjHmEhIF4gXyBc76EZW18fGl+fkl+jCxrhoVwhDyUhIqGlL2DlI6EhJd2tdN7eYORhEGMa2Faa6pzc3Bzc4R5lIRznM+UY9eMhDycc5Z+c4p5c4iGY117pb6MgXuPrbJafnx2eYOJeXZ5e657hDyEcziElKZjfoB5eHeGj4WRhGGEe6KGeX1utTStc76EhFGJnCyMa5hzfH6HnNeceYB7hmN8gYuMhIVrczSMgYF8h3N7c5pza5hzjJqEYIRdgYuMlL2DeYRzhGGEeX1uhLaEc4iGeZ1zdl6JhrVteX6Me2iMfm5lWqJzSpqEa6pzdnmchHx2c6OMhNdrhoR5g3aHczxzeW52gV6Ejm15frGMc0Vzc4Z+l3drfniJe+9rWq5rlF1rhGGEhoVwe9OEfoh+e7pac09+c3qBY0lrhDycdnp2lJ6MiYOGhGCDc3aRlL2DlJt5doaGdnp2gYF8gWeOjF2Uc4R5c5Z+jEmMe7KEc4mEeYJ4dmyBe0mcgXiPbqJ7eYB7fmGGiYSJjICGlF1reZ2PnElzbpqJfH6Hc39oe4WEc5eJhK6EhqyJc3qBgZB8c09+hEmEaHKDhFGJc5SGiXWMUpaEa89zc6OMnCyMiXtrho+Be5qMc7KEjJ57dmN+hKGPjICGbmiEe7prdod+hGCDdnmchBx7eX6MkXZ2hGGEa657hm98jFFjY5JreYOJgY2EjHZ2a295Y3FajJ6Mc1J+YzB7e4WBjF2Uc4R5eV12gYxzg1qBeId+c9OUc5pzjFFjgY5+hFiMlIaPhoR5lIpjjIKBlNdSe7KEeX2BfrGMhIqGc65zjE2UhK6EklZ+QmWEeziMWqZza3VzdnR4foh+gYF8n3iJiZhrnKp7gYF8eId+lJ6Me1lrcIuGjKJjhmN8c66MjFF7a6prjJ6UnJ5zezyUfruRWlF7nI5zfHyGe657h4SEe8tjhBx7jFFjc09+c39ojICMeZeJeXt+YzRzjHZ2c0WEcIeBeXZ5onSXkVR+gYJ+eYFwdldzgYF7eX2BjJ6UiXuXlE1jh4SEe1mchLJjc4Z+hqZ7eXZ5bm1zlL6Ue5p7iWeGhKqUY5pzjKJjcIeBe8t7gXyBYIRdlEp4a3mGnK6EfmmMZpqEfFl5gYxzjKZuhGFjhoKGhHx2fnx2eXuMe3aBiWeGvbKMe6KGa5hzYzB7gZOBlGV7hmN8hqZlYot2Y117a6pzc6KEfId8foB5rctrfneJfJ6PcHN2hFiMc5pzjH92c0VzgY2EcElzdmCBlFVzg1GBc65zY4OBboeBcHiBeYJ4ewxzfHx5lIRzlEmEnLKEbk1zfJ6PhmN8eYBljBiEnMOEiXxwezyUcIeBe76EdsKEeX2BdnR4jGWUrXWMjGd7fkl+j4WRlEGMa5Jzho+BhDyEfnqMeXt+g3aHlE1jczClhNN7ZW18eHx8hGFjZW18iXWMjKJjhH57gYuMcIuGWjyMe4ZtjJuExmmMj4WRdntzi4GDhFFzYIRdnGGcjJp7Y0F7e4WEkbCGiX57fnSHa657a6prhBCMe3Z+SmmMjH92eHJ2hK6EY1FzexhrvbKMnI5za4OEfnd+eXuMhImBe897hLaMjN+EfG+BeIOBhF1+eZeJi4GDkXZ2eXKEgZ6Ejpd4c2GHa1V5e5KUfqZuhCx7jKp7lLZrg11+hHx2hFWUoot2nI5zgbh5mo9zvZaUe3qRbqKMfqZ2kbCGhFiM",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/ssao/SSAOParameters":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../webgl/NoParameters"],(function(e,t,r){"use strict";class i extends r.NoParameters{constructor(){super(...arguments),this.projScale=1}}class s extends r.NoParameters{}e.BlurDrawParameters=class extends s{constructor(){super(...arguments),this.blurSize=t.create()}},e.BlurPassParameters=i,e.SSAODrawParameters=s,e.SSAOPassParameters=class extends i{constructor(){super(...arguments),this.intensity=1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/ssao/SSAOTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/SSAO.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.SSAO,(()=>new Promise(((t,r)=>e(["../../shaders/SSAO.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.SSAOTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/SSAO.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/CameraSpace.glsl","../views/3d/webgl-engine/core/shaderModules/Float2BindUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";function p(){const e=new h.ShaderBuilder,r=e.fragment;return e.include(i.ScreenSpacePass),e.include(n.CameraSpace),r.include(s.ReadDepth),r.uniforms.add(new l.FloatBindUniform("radius",(e=>m(e.camera)))).code.add(u.glsl`vec3 sphere[16] = vec3[16](
vec3(0.186937, 0.0, 0.0),
vec3(0.700542, 0.0, 0.0),
vec3(-0.864858, -0.481795, -0.111713),
vec3(-0.624773, 0.102853, -0.730153),
vec3(-0.387172, 0.260319, 0.007229),
vec3(-0.222367, -0.642631, -0.707697),
vec3(-0.01336, -0.014956, 0.169662),
vec3(0.122575, 0.1544, -0.456944),
vec3(-0.177141, 0.85997, -0.42346),
vec3(-0.131631, 0.814545, 0.524355),
vec3(-0.779469, 0.007991, 0.624833),
vec3(0.308092, 0.209288,0.35969),
vec3(0.359331, -0.184533, -0.377458),
vec3(0.192633, -0.482999, -0.065284),
vec3(0.233538, 0.293706, -0.055139),
vec3(0.417709, -0.386701, 0.442449)
);
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn - bias, 0.0);
}`),r.code.add(u.glsl`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),e.outputs.add("fragOcclusion","float"),r.uniforms.add(new d.Texture2DPassUniform("normalMap",(e=>e.normalTexture)),new d.Texture2DPassUniform("depthMap",(e=>e.depthTexture)),new c.FloatPassUniform("projScale",(e=>e.projScale)),new d.Texture2DPassUniform("rnm",(e=>e.noiseTexture)),new a.Float2PassUniform("rnmScale",((e,r)=>t.set(f,r.camera.fullWidth/e.noiseTexture.descriptor.width,r.camera.fullHeight/e.noiseTexture.descriptor.height))),new c.FloatPassUniform("intensity",(e=>e.intensity)),new o.Float2BindUniform("screenSize",(e=>t.set(f,e.camera.fullWidth,e.camera.fullHeight)))).main.add(u.glsl`
    float depth = depthFromTexture(depthMap, uv);

    // Early out if depth is out of range, such as in the sky
    if (depth >= 1.0 || depth <= 0.0) {
      fragOcclusion = 1.0;
      return;
    }

    // get the normal of current fragment
    ivec2 iuv = ivec2(uv * vec2(textureSize(normalMap, 0)));
    vec4 norm4 = texelFetch(normalMap, iuv, 0);
    if(norm4.a != 1.0) {
      fragOcclusion = 1.0;
      return;
    }
    vec3 norm = normalize(norm4.xyz * 2.0 - 1.0);

    float currentPixelDepth = linearizeDepth(depth);
    vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy, currentPixelDepth);

    float sum = 0.0;
    vec3 tapPixelPos;

    vec3 fres = normalize(2.0 * texture(rnm, uv * rnmScale).xyz - 1.0);

    // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
    // bug or deviation from CE somewhere else?
    float ps = projScale / (2.0 * currentPixelPos.z * zScale.x + zScale.y);

    for(int i = 0; i < ${u.glsl.int(16)}; ++i) {
      vec2 unitOffset = reflect(sphere[i], fres).xy;
      vec2 offset = vec2(-unitOffset * radius * ps);

      // don't use current or very nearby samples
      if( abs(offset.x) < 2.0 || abs(offset.y) < 2.0){
        continue;
      }

      vec2 tc = vec2(gl_FragCoord.xy + offset);
      if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenSize.x || tc.y > screenSize.y) continue;
      vec2 tcTap = tc / screenSize;
      float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap);

      tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

      sum += aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
    }

    // output the result
    float A = max(1.0 - sum * intensity / float(${u.glsl.int(16)}), 0.0);

    // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4) / 2.2
    A = (pow(A, 0.2) + 1.2 * A * A * A * A) / 2.2;

    fragOcclusion = A;
  `),e}function m(e){return Math.max(10,20*e.computeScreenPixelSizeAtDist(Math.abs(4*e.relativeElevation)))}const f=r.create(),g=Object.freeze(Object.defineProperty({__proto__:null,build:p,getRadius:m},Symbol.toStringTag,{value:"Module"}));e.SSAO=g,e.build=p,e.getRadius=m}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/CameraSpace.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../../../chunks/vec42","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../shaderModules/Float2BindUniform","../../shaderModules/Float4BindUniform","../../shaderModules/glsl"],(function(e,t,r,i,s,n,o,a){"use strict";function l(e){const t=e.projectionMatrix;return 0===t[11]?i.set(c,2/(e.fullWidth*t[0]),2/(e.fullHeight*t[5]),(1+t[12])/t[0],(1+t[13])/t[5]):i.set(c,-2/(e.fullWidth*t[0]),-2/(e.fullHeight*t[5]),(1-t[8])/t[0],(1-t[9])/t[5])}const c=s.create();function u(e){return 0===e.projectionMatrix[11]?t.set(d,0,1):t.set(d,1,0)}const d=r.create();e.CameraSpace=function(e){e.fragment.uniforms.add(new o.Float4BindUniform("projInfo",(e=>l(e.camera)))),e.fragment.uniforms.add(new n.Float2BindUniform("zScale",(e=>u(e.camera)))),e.fragment.code.add(a.glsl`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)},e.getProjectionInfo=l,e.getZScale=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl":function(){define(["exports","../../../../../../colorUtils","../../../../../../core/has","./EvaluateAmbientLighting.glsl","./EvaluateAmbientOcclusion.glsl","./MainLighting.glsl","./PhysicallyBasedRendering.glsl","./PhysicallyBasedRenderingParameters.glsl","./PiUtils.glsl","../../shaderModules/BooleanBindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../../lighting/SceneLighting","../../../shaders/BlackLevelLightSoftCompression.glsl","../../../shaders/ToneMapping.glsl"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";function f(e){e.constants.add("ambientBoostFactor","float",h.ambientBoost)}function g(e){e.uniforms.add(new u.FloatBindUniform("lightingGlobalFactor",(e=>e.lighting.globalFactor)))}e.EvaluateSceneLighting=function(e,r){const h=e.fragment,{pbrMode:y,spherical:_,hasColorTexture:b}=r;h.include(s.EvaluateAmbientOcclusion,r),y!==a.PBRMode.Disabled&&h.include(o.PhysicallyBasedRendering,r),e.include(i.EvaluateAmbientLighting,r),h.include(l.PiUtils),h.include(m.ToneMapping,r);const v=!(y===a.PBRMode.Schematic&&!b);switch(v&&h.include(p.BlackLevelLightSoftCompression),h.code.add(d.glsl`
    const float GAMMA_SRGB = ${d.glsl.float(t.colorGamma)};
    const float INV_GAMMA_SRGB = 0.4761904;
    ${d.If(y!==a.PBRMode.Disabled,"const float GROUND_REFLECTANCE = 0.2;")}
  `),f(h),g(h),n.addMainLightDirection(h),h.code.add(d.glsl`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${_?d.glsl`normalize(vPosWorld)`:d.glsl`vec3(0.0, 0.0, 1.0)`}, mainLightDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),n.addMainLightIntensity(h),h.code.add(d.glsl`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * mainLightIntensity;
}`),y){case a.PBRMode.Disabled:case a.PBRMode.WaterOnIntegratedMesh:case a.PBRMode.Water:e.include(n.applyShading),h.code.add(d.glsl`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight) {
vec3 mainLighting = applyShading(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`);break;case a.PBRMode.Normal:case a.PBRMode.Schematic:h.code.add(d.glsl`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight,
vec3 viewDir, vec3 groundNormal, vec3 mrr, vec4 _emission,
float additionalAmbientIrradiance) {
vec3 viewDirection = -viewDir;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotNG = clamp(dot(normal, groundNormal), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, groundNormal), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),h.code.add(d.glsl`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),r.useFillLights?h.uniforms.add(new c.BooleanBindUniform("hasFillLights",(e=>e.enableFillLights))):h.constants.add("hasFillLights","bool",!1),h.code.add(d.glsl`vec3 ambientDir = vec3(5.0 * groundNormal[1] - groundNormal[0] * groundNormal[2], - 5.0 * groundNormal[0] - groundNormal[2] * groundNormal[1], groundNormal[1] * groundNormal[1] + groundNormal[0] * groundNormal[0]);
ambientDir = ambientDir != vec3(0.0) ? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
float NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
vec3 mainLightIrradianceComponent = NdotL * (1.0 - shadow) * mainLightIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * mainLightIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),h.uniforms.add(new u.FloatBindUniform("lightingSpecularStrength",(e=>e.lighting.mainLight.specularStrength)),new u.FloatBindUniform("lightingEnvironmentStrength",(e=>e.lighting.mainLight.environmentStrength))).code.add(d.glsl`vec3 horizonRingDir = inputs.RdotNG * groundNormal - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
float NdotH = clamp(dot(normal, h), 0.0, 1.0);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(NdotH, inputs.roughness) * mainLightIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * mainLightIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
float normalDirectionModifier = mix(1., min(mix(0.1, 2.0, (inputs.NdotNG + 1.) * 0.5), 1.0), clamp(inputs.roughness * 5.0, 0.0 , 1.0));
inputs.skyRadianceToSurface = (ambientLightRadianceComponent + horizonLightRadianceComponent) * normalDirectionModifier + mainLightRadianceComponent;
inputs.groundRadianceToSurface = 0.5 * GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) * normalDirectionModifier + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE);`),h.code.add(d.glsl`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = _emission.rgb == vec3(0.0) ? _emission.rgb : tonemapACES(pow(_emission.rgb, vec3(GAMMA_SRGB)));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${v?d.glsl`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:d.glsl`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `);break;case a.PBRMode.Simplified:case a.PBRMode.TerrainWithWater:n.addMainLightDirection(h),n.addMainLightIntensity(h),h.code.add(d.glsl`const float roughnessTerrain = 0.5;
const float specularityTerrain = 0.5;
const vec3 fresnelReflectionTerrain = vec3(0.04);
vec3 evaluatePBRSimplifiedLighting(vec3 n, vec3 c, float shadow, float ssao, vec3 al, vec3 vd, vec3 nup) {
vec3 viewDirection = -vd;
vec3 h = normalize(viewDirection + mainLightDirection);
float NdotL = clamp(dot(n, mainLightDirection), 0.001, 1.0);
float NdotV = clamp(abs(dot(n, viewDirection)), 0.001, 1.0);
float NdotH = clamp(dot(n, h), 0.0, 1.0);
float NdotNG = clamp(dot(n, nup), -1.0, 1.0);
vec3 albedoLinear = pow(c, vec3(GAMMA_SRGB));
float lightness = 0.3 * albedoLinear[0] + 0.5 * albedoLinear[1] + 0.2 * albedoLinear[2];
vec3 f0 = (0.85 * lightness + 0.15) * fresnelReflectionTerrain;
vec3 f90 =  vec3(clamp(dot(f0, vec3(50.0 * 0.33)), 0.0, 1.0));
vec3 mainLightIrradianceComponent = (1. - shadow) * NdotL * mainLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(n, ssao) + al;
vec3 ambientSky = ambientLightIrradianceComponent + mainLightIrradianceComponent;
vec3 indirectDiffuse = ((1.0 - NdotNG) * mainLightIrradianceComponent + (1.0 + NdotNG ) * ambientSky) * 0.5;
vec3 outDiffColor = albedoLinear * (1.0 - f0) * indirectDiffuse / PI;
vec3 mainLightRadianceComponent = normalDistribution(NdotH, roughnessTerrain) * mainLightIntensity;
vec2 dfg = prefilteredDFGAnalytical(roughnessTerrain, NdotV);
vec3 specularColor = f0 * dfg.x + f90 * dfg.y;
vec3 specularComponent = specularityTerrain * specularColor * mainLightRadianceComponent;
vec3 outColorLinear = outDiffColor + specularComponent;
vec3 outColor = pow(outColorLinear, vec3(INV_GAMMA_SRGB));
return outColor;
}`);default:case a.PBRMode.COUNT:}},e.addAmbientBoostFactor=f,e.addLightingGlobalFactor=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientLighting.glsl":function(){define(["exports","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../chunks/vec42","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","./PhysicallyBasedRenderingParameters.glsl","../../shaderModules/Float3BindUniform","../../shaderModules/Float4BindUniform","../../shaderModules/glsl"],(function(e,t,r,i,s,n,o,a,l){"use strict";const c=r.create(),u=s.create();e.EvaluateAmbientLighting=function(e,r){const s=e.fragment,d=void 0!==r.lightingSphericalHarmonicsOrder?r.lightingSphericalHarmonicsOrder:2;0===d?(s.uniforms.add(new o.Float3BindUniform("lightingAmbientSH0",(({lighting:e})=>t.set(c,e.sh.r[0],e.sh.g[0],e.sh.b[0])))),s.code.add(l.glsl`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):1===d?(s.uniforms.add(new a.Float4BindUniform("lightingAmbientSH_R",(({lighting:e})=>i.set(u,e.sh.r[0],e.sh.r[1],e.sh.r[2],e.sh.r[3]))),new a.Float4BindUniform("lightingAmbientSH_G",(({lighting:e})=>i.set(u,e.sh.g[0],e.sh.g[1],e.sh.g[2],e.sh.g[3]))),new a.Float4BindUniform("lightingAmbientSH_B",(({lighting:e})=>i.set(u,e.sh.b[0],e.sh.b[1],e.sh.b[2],e.sh.b[3])))),s.code.add(l.glsl`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):2===d&&(s.uniforms.add(new o.Float3BindUniform("lightingAmbientSH0",(({lighting:e})=>t.set(c,e.sh.r[0],e.sh.g[0],e.sh.b[0]))),new a.Float4BindUniform("lightingAmbientSH_R1",(({lighting:e})=>i.set(u,e.sh.r[1],e.sh.r[2],e.sh.r[3],e.sh.r[4]))),new a.Float4BindUniform("lightingAmbientSH_G1",(({lighting:e})=>i.set(u,e.sh.g[1],e.sh.g[2],e.sh.g[3],e.sh.g[4]))),new a.Float4BindUniform("lightingAmbientSH_B1",(({lighting:e})=>i.set(u,e.sh.b[1],e.sh.b[2],e.sh.b[3],e.sh.b[4]))),new a.Float4BindUniform("lightingAmbientSH_R2",(({lighting:e})=>i.set(u,e.sh.r[5],e.sh.r[6],e.sh.r[7],e.sh.r[8]))),new a.Float4BindUniform("lightingAmbientSH_G2",(({lighting:e})=>i.set(u,e.sh.g[5],e.sh.g[6],e.sh.g[7],e.sh.g[8]))),new a.Float4BindUniform("lightingAmbientSH_B2",(({lighting:e})=>i.set(u,e.sh.b[5],e.sh.b[6],e.sh.b[7],e.sh.b[8])))),s.code.add(l.glsl`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),r.pbrMode!==n.PBRMode.Normal&&r.pbrMode!==n.PBRMode.Schematic||s.code.add(l.glsl`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl":function(){define(["exports","../../shaderModules/Float3BindUniform","../../shaderModules/glsl"],(function(e,t,r){"use strict";function i(e){e.uniforms.add(new t.Float3BindUniform("mainLightDirection",(e=>e.lighting.mainLight.direction)))}function s(e){e.uniforms.add(new t.Float3BindUniform("mainLightIntensity",(e=>e.lighting.mainLight.intensity)))}e.addMainLightDirection=i,e.addMainLightIntensity=s,e.applyShading=function(e){i(e.fragment),s(e.fragment),e.fragment.code.add(r.glsl`vec3 applyShading(vec3 shadingNormal, float shadow) {
float dotVal = clamp(dot(shadingNormal, mainLightDirection), 0.0, 1.0);
return mainLightIntensity * ((1.0 - shadow) * dotVal);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRendering.glsl":function(){define(["exports","./AnalyticalSkyModel.glsl","./PhysicallyBasedRenderingParameters.glsl","./PiUtils.glsl","../../shaderModules/glsl"],(function(e,t,r,i,s){"use strict";e.PhysicallyBasedRendering=function(e,n){e.include(i.PiUtils),n.pbrMode!==r.PBRMode.Normal&&n.pbrMode!==r.PBRMode.Schematic&&n.pbrMode!==r.PBRMode.Simplified&&n.pbrMode!==r.PBRMode.TerrainWithWater||(e.code.add(s.glsl`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),e.code.add(s.glsl`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`)),n.pbrMode!==r.PBRMode.Normal&&n.pbrMode!==r.PBRMode.Schematic||(e.include(t.AnalyticalSkyModel),e.code.add(s.glsl`struct PBRShadingInfo
{
float NdotV;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),e.code.add(s.glsl`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`))},e.PhysicallyBasedRenderingWater=function(e,t){e.include(i.PiUtils),e.code.add(s.glsl`
  struct PBRShadingWater {
      float NdotL;   // cos angle between normal and light direction
      float NdotV;   // cos angle between normal and view direction
      float NdotH;   // cos angle between normal and half vector
      float VdotH;   // cos angle between view direction and half vector
      float LdotH;   // cos angle between light direction and half vector
      float VdotN;   // cos angle between view direction and normal vector
  };

  float dtrExponent = ${t.useCustomDTRExponentForWater?"2.2":"2.0"};
  `),e.code.add(s.glsl`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),e.code.add(s.glsl`float normalDistributionWater(float NdotH, float roughness) {
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),e.code.add(s.glsl`float geometricOcclusionKelemen(float LoH) {
return 0.25 / (LoH * LoH);
}`),e.code.add(s.glsl`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max) {
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze) * strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/AnalyticalSkyModel.glsl":function(){define(["exports","../../shaderModules/glsl"],(function(e,t){"use strict";e.AnalyticalSkyModel=function(e){e.code.add(t.glsl`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG) {
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),e.code.add(t.glsl`float integratedRadiance(float cosTheta2, float roughness) {
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),e.code.add(t.glsl`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness) {
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/PiUtils.glsl":function(){define(["exports"],(function(e){"use strict";e.PiUtils=function(e){const t=.3183098861837907;e.constants.add("PI","float",3.141592653589793),e.constants.add("LIGHT_NORMALIZATION","float",t),e.constants.add("INV_PI","float",t),e.constants.add("HALF_PI","float",1.570796326794897),e.constants.add("TWO_PI","float",6.28318530717958)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lighting/SceneLighting":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","./Lightsources","./SphericalHarmonics"],(function(e,t,r,i,s,n){"use strict";class o{constructor(){this.color=i.create(),this.intensity=1}}class a{constructor(){this.direction=i.create(),this.ambient=new o,this.diffuse=new o}}const l=i.create();e.SceneLighting=class{constructor(){this._shOrder=2,this._legacy=new a,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new s.SphericalHarmonicsAmbientLight,this._mainLight=new s.MainLight(i.create(),i.fromValues(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){n.combineLights(e,this._shOrder,this._mainLight,this._sphericalHarmonics),r.copy(this._legacy.direction,this._mainLight.direction);const t=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,r.scale(this._legacy.diffuse.color,this._mainLight.intensity,t),r.copy(l,this._legacy.diffuse.color),r.scale(l,l,.4*this.globalFactor),r.add(this._legacy.ambient.color,this._legacy.ambient.color,l)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),r.copy(this._mainLight.direction,e.mainLight.direction),r.copy(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,i,s){if(r.lerp(this._mainLight.intensity,e.mainLight.intensity,i.mainLight.intensity,s),this._mainLight.environmentStrength=t.lerp(e.mainLight.environmentStrength,i.mainLight.environmentStrength,s),this._mainLight.specularStrength=t.lerp(e.mainLight.specularStrength,i.mainLight.specularStrength,s),r.copy(this._mainLight.direction,i.mainLight.direction),this._mainLight.castShadows=i.mainLight.castShadows,this.globalFactor=t.lerp(e.globalFactor,i.globalFactor,s),this.noonFactor=t.lerp(e.noonFactor,i.noonFactor,s),e.sh.r.length===i.sh.r.length)for(let r=0;r<i.sh.r.length;r++)this._sphericalHarmonics.r[r]=t.lerp(e.sh.r[r],i.sh.r[r],s),this._sphericalHarmonics.g[r]=t.lerp(e.sh.g[r],i.sh.g[r],s),this._sphericalHarmonics.b[r]=t.lerp(e.sh.b[r],i.sh.b[r],s);else for(let e=0;e<i.sh.r.length;e++)this._sphericalHarmonics.r[e]=i.sh.r[e],this._sphericalHarmonics.g[e]=i.sh.g[e],this._sphericalHarmonics.b[e]=i.sh.b[e]}},e.SunLight=a,e.ambientBoost=.4,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lighting/SphericalHarmonics":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../lib/LongVectorMath","./Lightsources"],(function(e,t,r,i,s,n){"use strict";function o(e){return(e+1)*(e+1)}function a(e){return t.clamp(Math.floor(Math.sqrt(e)-1),0,2)}function l(e,t,r){const i=e[0],s=e[1],n=e[2],a=r||[];return a.length=o(t),t>=0&&(a[0]=.28209479177),t>=1&&(a[1]=.4886025119*i,a[2]=.4886025119*n,a[3]=.4886025119*s),t>=2&&(a[4]=1.09254843059*i*s,a[5]=1.09254843059*s*n,a[6]=.31539156525*(3*n*n-1),a[7]=1.09254843059*i*n,a[8]=.54627421529*(i*i-s*s)),a}function c(e,t){const r=o(e),i=t||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=r;for(let e=0;e<r;e++)i.r[e]=i.g[e]=i.b[e]=0;return i}function u(e,t){const i=a(t.r.length);for(const n of e)r.negate(y,n.direction),l(y,i,f),s.elementwiseProduct(f,_),s.scalarProduct(f,n.intensity[0],g),s.add(t.r,g),s.scalarProduct(f,n.intensity[1],g),s.add(t.g,g),s.scalarProduct(f,n.intensity[2],g),s.add(t.b,g);return t}function d(e,t){l(y,0,f);for(const r of e)t.r[0]+=f[0]*_[0]*r.intensity[0]*4*Math.PI,t.g[0]+=f[0]*_[0]*r.intensity[1]*4*Math.PI,t.b[0]+=f[0]*_[0]*r.intensity[2]*4*Math.PI;return t}const h=[],p=[],m=[],f=[0],g=[0],y=i.create(),_=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];e.combineLights=function(e,t,i,o){c(t,o),r.set(i.intensity,0,0,0);let a=!1;const l=h,f=p,g=m;l.length=0,f.length=0,g.length=0;for(const t of e)t instanceof n.MainLight&&!a?(r.copy(i.direction,t.direction),r.copy(i.intensity,t.intensity),i.specularStrength=t.specularStrength,i.environmentStrength=t.environmentStrength,i.castShadows=t.castShadows,a=!0):t instanceof n.MainLight||t instanceof n.FillLight?l.push(t):t instanceof n.AmbientLight?f.push(t):t instanceof n.SphericalHarmonicsAmbientLight&&g.push(t);u(l,o),d(f,o);for(const e of g)s.add(o.r,e.r),s.add(o.g,e.g),s.add(o.b,e.b)},e.computeCoefficients=l,e.initSHCoefficients=c,e.numberOfCoefficients=o,e.orderFromNumberOfCoefficients=a,e.projectAmbientLights=d,e.projectFillLights=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/LongVectorMath":function(){define(["exports"],(function(e){"use strict";e.add=function(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]+t[i];return r},e.dotProduct=function(e,t){let r=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i];return r},e.elementwiseProduct=function(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]*t[i];return r},e.scalarProduct=function(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]*t;return r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/BlackLevelLightSoftCompression.glsl":function(){define(["exports","../core/shaderModules/glsl"],(function(e,t){"use strict";e.BlackLevelLightSoftCompression=function(e){e.code.add(t.glsl`float mapChannel(float x, vec2 p) {
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),e.code.add(t.glsl`vec3 blackLevelSoftCompression(vec3 color, float averageAmbientRadiance) {
vec2 p = vec2(0.02, 0.0075) * averageAmbientRadiance;
return vec3(mapChannel(color.x, p), mapChannel(color.y, p), mapChannel(color.z, p));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/ToneMapping.glsl":function(){define(["exports","../core/shaderModules/glsl"],(function(e,t){"use strict";e.ToneMapping=function(e){e.code.add(t.glsl`vec3 tonemapACES(vec3 x) {
return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","./calculateUVZShadow.glsl","./ShadowmapFiltering.glsl","../../shaderModules/glsl","../../shaderModules/Texture2DShadowBindUniform","../../../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o){"use strict";class a extends r.ReadShadowMapOrigin{}class l extends o.NoParameters{constructor(){super(...arguments),this.origin=t.create()}}function c(e){e.include(i.ShadowmapFiltering);const{fragment:t}=e;t.uniforms.add(new n.Texture2DShadowBindUniform("shadowMap",(e=>e.shadowMap.depthTexture))),t.code.add(s.glsl`float readShadowMap(const in vec3 _worldPos, float _linearDepth) {
vec3 uvzShadow = calculateUVZShadow(_worldPos, _linearDepth, textureSize(shadowMap,0));
if (uvzShadow.z < 0.0) {
return 0.0;
}
return readShadowMapUVZ(uvzShadow, shadowMap);
}`)}e.ReadShadowMapDraw=function(e,t){t.receiveShadows&&(e.include(r.calculateUVZShadowDraw),c(e))},e.ReadShadowMapDrawParameters=a,e.ReadShadowMapPass=function(e,t){t.receiveShadows&&(e.include(r.calculateUVZShadowPass),c(e))},e.ReadShadowMapPassParameters=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/calculateUVZShadow.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../shaderModules/Float4BindUniform","../../shaderModules/glsl","../../shaderModules/IntegerBindUniform","../../shaderModules/Matrix4sDrawUniform","../../shaderModules/Matrix4sPassUniform","../../../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends a.NoParameters{constructor(){super(...arguments),this.origin=t.create()}}function c(e){const{fragment:t}=e;t.uniforms.add(new r.Float4BindUniform("cascadeDistances",(e=>e.shadowMap.cascadeDistances)),new s.IntegerBindUniform("numCascades",(e=>e.shadowMap.numCascades))),t.code.add(i.glsl`const vec3 invalidShadowmapUVZ = vec3(0.0, 0.0, -1.0);
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, ivec2 textureSize, vec3 lvpos) {
float xScale = float(textureSize.y) / float(textureSize.x);
return vec2((float(i) + lvpos.x) * xScale, lvpos.y);
}
vec3 calculateUVZShadow(in vec3 _worldPos, in float _linearDepth, in ivec2 shadowMapSize) {
int i = _linearDepth < cascadeDistances[1] ? 0 : _linearDepth < cascadeDistances[2] ? 1 : _linearDepth < cascadeDistances[3] ? 2 : 3;
if (i >= numCascades) {
return invalidShadowmapUVZ;
}
mat4 shadowMatrix = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];
vec3 lvpos = lightSpacePosition(_worldPos, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
return invalidShadowmapUVZ;
}
vec2 uvShadow = cascadeCoordinates(i, shadowMapSize, lvpos);
return vec3(uvShadow, lvpos.z);
}`)}e.ReadShadowMapOrigin=l,e.calculateUVZShadowDraw=function(e){e.fragment.uniforms.add(new n.Matrix4sDrawUniform("shadowMapMatrix",((e,t)=>t.shadowMap.getShadowMapMatrices(e.origin)),4)),c(e)},e.calculateUVZShadowPass=function(e){e.fragment.uniforms.add(new o.Matrix4sPassUniform("shadowMapMatrix",((e,t)=>t.shadowMap.getShadowMapMatrices(e.origin)),4)),c(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4sDrawUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r,i){super(e,"mat4",t.BindType.Draw,((t,i,s,n)=>t.setUniformMatrix4fv(e,r(i,s,n))),i)}}e.Matrix4sDrawUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Matrix4sPassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r,i){super(e,"mat4",t.BindType.Pass,((t,i,s)=>t.setUniformMatrix4fv(e,r(i,s))),i)}}e.Matrix4sPassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ShadowmapFiltering.glsl":function(){define(["exports","./calculateUVZShadow.glsl","../../shaderModules/glsl"],(function(e,t,r){"use strict";class i extends t.ReadShadowMapOrigin{}e.ReadShadowMapDrawParameters=i,e.ShadowmapFiltering=function(e){e.fragment.code.add(r.glsl`float readShadowMapUVZ(vec3 uvzShadow, sampler2DShadow _shadowMap) {
return texture(_shadowMap, uvzShadow);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DShadowBindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"sampler2DShadow",t.BindType.Bind,((t,i)=>t.bindTexture(e,r(i))))}}e.Texture2DShadowBindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/TextureTransformUV.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../attributes/TextureCoordinateAttribute.glsl","../../shaderModules/glsl","../../shaderModules/Matrix3PassUniform"],(function(e,t,r,i,s){"use strict";e.colorTextureUV=function(e,r){r.hasColorTextureTransform?(e.varyings.add("colorUV","vec2"),e.vertex.uniforms.add(new s.Matrix3PassUniform("colorTextureTransformMatrix",(e=>e.colorTextureTransformMatrix??t.IDENTITY))).code.add(i.glsl`void forwardColorUV(){
colorUV = (colorTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(i.glsl`void forwardColorUV(){}`)},e.emissiveTextureUV=function(e,n){n.hasEmissionTextureTransform&&n.textureCoordinateType!==r.TextureCoordinateType.None?(e.varyings.add("emissiveUV","vec2"),e.vertex.uniforms.add(new s.Matrix3PassUniform("emissiveTextureTransformMatrix",(e=>e.emissiveTextureTransformMatrix??t.IDENTITY))).code.add(i.glsl`void forwardEmissiveUV(){
emissiveUV = (emissiveTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(i.glsl`void forwardEmissiveUV(){}`)},e.metallicRoughnessTextureUV=function(e,n){n.hasMetallicRoughnessTextureTransform&&n.textureCoordinateType!==r.TextureCoordinateType.None?(e.varyings.add("metallicRoughnessUV","vec2"),e.vertex.uniforms.add(new s.Matrix3PassUniform("metallicRoughnessTextureTransformMatrix",(e=>e.metallicRoughnessTextureTransformMatrix??t.IDENTITY))).code.add(i.glsl`void forwardMetallicRoughnessUV(){
metallicRoughnessUV = (metallicRoughnessTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(i.glsl`void forwardMetallicRoughnessUV(){}`)},e.normalTextureUV=function(e,n){n.hasNormalTextureTransform&&n.textureCoordinateType!==r.TextureCoordinateType.None?(e.varyings.add("normalUV","vec2"),e.vertex.uniforms.add(new s.Matrix3PassUniform("normalTextureTransformMatrix",(e=>e.normalTextureTransformMatrix??t.IDENTITY))).code.add(i.glsl`void forwardNormalUV(){
normalUV = (normalTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(i.glsl`void forwardNormalUV(){}`)},e.occlusionTextureUV=function(e,n){n.hasOcclusionTextureTransform&&n.textureCoordinateType!==r.TextureCoordinateType.None?(e.varyings.add("occlusionUV","vec2"),e.vertex.uniforms.add(new s.Matrix3PassUniform("occlusionTextureTransformMatrix",(e=>e.occlusionTextureTransformMatrix??t.IDENTITY))).code.add(i.glsl`void forwardOcclusionUV(){
occlusionUV = (occlusionTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(i.glsl`void forwardOcclusionUV(){}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/MixExternalColor.glsl":function(){define(["exports","../../../../layers/support/symbolColorUtils","./ColorConversion.glsl","../../shaderModules/glsl"],(function(e,t,r,i){"use strict";e.MixExternalColor=function(e){e.include(r.ColorConversion),e.code.add(i.glsl`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in macOS using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${i.glsl.int(t.ColorMixModeEnum.Multiply)}) {
        return allMixed;
      }
      if (mode == ${i.glsl.int(t.ColorMixModeEnum.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${i.glsl.int(t.ColorMixModeEnum.Replace)}) {
        return externalColor;
      }

      // tint (or something invalid)
      float vIn = rgb2v(internalMixed);
      vec3 hsvTint = rgb2hsv(externalColor);
      vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
      return hsv2rgb(hsvOut);
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in macOS using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${i.glsl.int(t.ColorMixModeEnum.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${i.glsl.int(t.ColorMixModeEnum.Replace)}) {
        return externalOpacity;
      }

      // multiply or tint (or something invalid)
      return allMixed;
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/weather/SnowCover.glsl":function(){define(["exports","../../core/shaderModules/glsl"],(function(e,t){"use strict";e.SnowCover=function(e,r){r.snowCover&&(e.code.add(t.glsl`float getSnow(vec3 normal, vec3 normalGround) {
return smoothstep(0.5, 0.55, dot(normal, normalGround));
}`),e.code.add(t.glsl`vec3 applySnowToMRR(vec3 mrr, float snow) {
return mix(mrr, vec3(0.0, 1.0, 0.04), snow);
}
vec4 snowCoverForEmissions(vec4 emission, float snow) {
return mix(emission, vec4(0.0), snow);
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl":function(){define(["exports","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/output/Emissions.glsl","../core/shaderLibrary/output/OutputHighlight.glsl","../core/shaderLibrary/util/ColorConversion.glsl","../core/shaderModules/glsl","../lib/OITPass","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a){"use strict";e.outputColorHighlightOID=function(e,l){e.include(i.OutputHighlight,l),e.include(r.Emissions,l),e.fragment.include(s.ColorConversion);const{output:c,oitPass:u,discardInvisibleFragments:d,snowCover:h}=l,p=c===t.ShaderOutput.ObjectAndLayerIdColor,m=t.isColorEmission(c),f=t.isColorOrColorEmission(c)&&u===o.OITPass.ColorAlpha,g=t.isColorOrColorEmission(c)&&u!==o.OITPass.ColorAlpha;let y=0;(g||m||f)&&e.outputs.add("fragColor","vec4",y++),m&&e.outputs.add("fragEmission","vec4",y++),f&&e.outputs.add("fragAlpha","float",y++),e.fragment.code.add(n.glsl`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition, vec3 emissiveBaseColor ${n.If(h,", float snow")}) {
      ${n.If(p,"finalColor.a = 1.0;")}

      ${n.If(d,`if (finalColor.a < ${n.glsl.float(a.alphaCutoff)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${n.If(f,n.glsl`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${n.If(g,"fragColor = finalColor;")}
      ${n.If(m,`fragEmission = ${n.If(h,"mix(finalColor.a * getEmissions(emissiveBaseColor), vec4(0.0), snow);","finalColor.a * getEmissions(emissiveBaseColor);")}`)}
      calculateOcclusionAndOutputHighlight();
      ${n.If(p,"outputObjectAndLayerIdColor();")}
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/DefaultMaterialTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderLibrary/attributes/NormalAttribute.glsl","../core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../core/shaderLibrary/output/Emissions.glsl","../core/shaderLibrary/shading/Normals.glsl","../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../core/shaderTechnique/ShaderTechniqueConfiguration","../lib/basicInterfaces","../materials/DefaultTechniqueConfiguration"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends c.DefaultTechniqueConfiguration{constructor(e){super(),this.spherical=e,this.alphaDiscardMode=l.AlphaDiscardMode.Opaque,this.doubleSidedMode=n.NormalsDoubleSidedMode.None,this.pbrMode=o.PBRMode.Disabled,this.cullFace=l.CullFaceOptions.None,this.normalType=r.NormalType.Attribute,this.customDepthTest=l.DepthTestFunction.Less,this.emissionSource=s.EmissionSource.None,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.snowCover=!1,this.hasBloom=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1,this.occlusionPass=!1,this.hasVvInstancing=!0,this.useCustomDTRExponentForWater=!1,this.useFillLights=!0,this.draped=!1}get textureCoordinateType(){return this.hasColorTexture||this.hasMetallicRoughnessTexture||this.emissionSource===s.EmissionSource.Texture||this.hasOcclusionTexture||this.hasNormalTexture?i.TextureCoordinateType.Default:i.TextureCoordinateType.None}get objectAndLayerIdColorInstanced(){return this.instanced}get discardInvisibleFragments(){return this.transparent}}t.__decorate([a.parameter({count:l.AlphaDiscardMode.COUNT})],u.prototype,"alphaDiscardMode",void 0),t.__decorate([a.parameter({count:n.NormalsDoubleSidedMode.COUNT})],u.prototype,"doubleSidedMode",void 0),t.__decorate([a.parameter({count:o.PBRMode.COUNT})],u.prototype,"pbrMode",void 0),t.__decorate([a.parameter({count:l.CullFaceOptions.COUNT})],u.prototype,"cullFace",void 0),t.__decorate([a.parameter({count:r.NormalType.COUNT})],u.prototype,"normalType",void 0),t.__decorate([a.parameter({count:l.DepthTestFunction.COUNT})],u.prototype,"customDepthTest",void 0),t.__decorate([a.parameter({count:s.EmissionSource.COUNT})],u.prototype,"emissionSource",void 0),t.__decorate([a.parameter()],u.prototype,"hasVertexColors",void 0),t.__decorate([a.parameter()],u.prototype,"hasSymbolColors",void 0),t.__decorate([a.parameter()],u.prototype,"hasVerticalOffset",void 0),t.__decorate([a.parameter()],u.prototype,"hasColorTexture",void 0),t.__decorate([a.parameter()],u.prototype,"hasMetallicRoughnessTexture",void 0),t.__decorate([a.parameter()],u.prototype,"hasOcclusionTexture",void 0),t.__decorate([a.parameter()],u.prototype,"hasNormalTexture",void 0),t.__decorate([a.parameter()],u.prototype,"hasScreenSizePerspective",void 0),t.__decorate([a.parameter()],u.prototype,"hasVertexTangents",void 0),t.__decorate([a.parameter()],u.prototype,"hasOccludees",void 0),t.__decorate([a.parameter()],u.prototype,"instancedDoublePrecision",void 0),t.__decorate([a.parameter()],u.prototype,"hasModelTransformation",void 0),t.__decorate([a.parameter()],u.prototype,"offsetBackfaces",void 0),t.__decorate([a.parameter()],u.prototype,"vvSize",void 0),t.__decorate([a.parameter()],u.prototype,"vvColor",void 0),t.__decorate([a.parameter()],u.prototype,"receiveShadows",void 0),t.__decorate([a.parameter()],u.prototype,"receiveAmbientOcclusion",void 0),t.__decorate([a.parameter()],u.prototype,"textureAlphaPremultiplied",void 0),t.__decorate([a.parameter()],u.prototype,"instanced",void 0),t.__decorate([a.parameter()],u.prototype,"instancedColor",void 0),t.__decorate([a.parameter()],u.prototype,"writeDepth",void 0),t.__decorate([a.parameter()],u.prototype,"transparent",void 0),t.__decorate([a.parameter()],u.prototype,"enableOffset",void 0),t.__decorate([a.parameter()],u.prototype,"terrainDepthTest",void 0),t.__decorate([a.parameter()],u.prototype,"cullAboveTerrain",void 0),t.__decorate([a.parameter()],u.prototype,"snowCover",void 0),t.__decorate([a.parameter()],u.prototype,"hasBloom",void 0),t.__decorate([a.parameter()],u.prototype,"hasColorTextureTransform",void 0),t.__decorate([a.parameter()],u.prototype,"hasEmissionTextureTransform",void 0),t.__decorate([a.parameter()],u.prototype,"hasNormalTextureTransform",void 0),t.__decorate([a.parameter()],u.prototype,"hasOcclusionTextureTransform",void 0),t.__decorate([a.parameter()],u.prototype,"hasMetallicRoughnessTextureTransform",void 0),e.DefaultMaterialTechniqueConfiguration=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/RealisticTreeTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","./DefaultMaterialTechnique","../../../../chunks/RealisticTree.glsl"],(function(e,t,r,i,s){"use strict";class n extends i.DefaultMaterialTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.RealisticTree,(()=>new Promise(((t,r)=>e(["./RealisticTree.glsl"],t,r)))))),this.type="RealisticTreeTechnique"}}t.RealisticTreeTechnique=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/RealisticTree.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/Offset.glsl","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/InstancedDoublePrecision.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/SymbolColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VerticalOffset.glsl","../views/3d/webgl-engine/core/shaderLibrary/default/DefaultMaterialAuxiliaryPasses.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientOcclusion.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRendering.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/VisualVariables.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/DiscardOrAdjustAlpha.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/MixExternalColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/lib/VertexAttribute","../views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I){"use strict";function D(e){const D=new A.ShaderBuilder,{attributes:F,vertex:L,fragment:N,varyings:U}=D,{output:V,offsetBackfaces:B,instancedColor:G,pbrMode:k,snowCover:z,spherical:j,hasBloom:q}=e,H=k===y.PBRMode.Normal||k===y.PBRMode.Schematic;if(x.addProjViewLocalOrigin(L,e),F.add(E.VertexAttribute.POSITION,"vec3"),U.add("vpos","vec3",{invariant:!0}),D.include(v.VisualVariables,e),D.include(o.InstancedDoublePrecision,e),D.include(d.VerticalOffset,e),D.include(b.terrainDepthTest,e),i.isColorOrColorEmission(V)&&(x.addCameraPosition(D.vertex,e),D.include(a.NormalAttribute,e),D.include(n.Transform,e),B&&D.include(r.Offset),G&&D.attributes.add(E.VertexAttribute.INSTANCECOLOR,"vec4"),U.add("vNormalWorld","vec3"),U.add("localvpos","vec3",{invariant:!0}),D.include(c.TextureCoordinateAttribute,e),D.include(t.ForwardLinearDepth,e),D.include(l.SymbolColor,e),D.include(u.VertexColor,e),L.uniforms.add(new C.Float4PassUniform("externalColor",(e=>e.externalColor))),U.add("vcolorExt","vec4"),L.main.add(M.glsl`
      forwardNormalizedVertexColor();
      vcolorExt = externalColor;
      ${M.If(G,"vcolorExt *= instanceColor * 0.003921568627451;")}
      vcolorExt *= vvColor();
      vcolorExt *= getSymbolColor();
      forwardColorMixMode();

      bool alphaCut = vcolorExt.a < ${M.glsl.float(I.alphaCutoff)};
      vpos = getVertexInLocalOriginSpace();
      localvpos = vpos - view[3].xyz;
      vpos = subtractOrigin(vpos);
      vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
      vpos = addVerticalOffset(vpos, localOrigin);
      vec4 basePosition = transformPosition(proj, view, vpos);

      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
      forwardLinearDepth();
      forwardTextureCoordinates();

      gl_Position = alphaCut ? vec4(1e38, 1e38, 1e38, 1.0) :
      ${M.If(B,"offsetBackfacingClipPosition(basePosition, vpos, vNormalWorld, cameraPosition);","basePosition;")}
    `)),i.isColorOrColorEmission(V)){const{hasColorTexture:t,hasColorTextureTransform:r,receiveShadows:i}=e;D.include(m.EvaluateSceneLighting,e),N.include(p.EvaluateAmbientOcclusion,e),D.include(S.DiscardOrAdjustAlphaPass,e),D.include(e.instancedDoublePrecision?_.ReadShadowMapPass:_.ReadShadowMapDraw,e),N.include(s.SliceDraw,e),D.include(O.outputColorHighlightOID,e),x.addCameraPosition(N,e),f.addMainLightDirection(N),m.addAmbientBoostFactor(N),m.addLightingGlobalFactor(N),N.uniforms.add(L.uniforms.get("localOrigin"),L.uniforms.get("view"),new T.Float3PassUniform("ambient",(e=>e.ambient)),new T.Float3PassUniform("diffuse",(e=>e.diffuse)),new P.FloatPassUniform("opacity",(e=>e.opacity)),new P.FloatPassUniform("layerOpacity",(e=>e.layerOpacity))),t&&N.uniforms.add(new R.Texture2DPassUniform("tex",(e=>e.texture))),D.include(y.PhysicallyBasedRenderingParameters,e),N.include(g.PhysicallyBasedRendering,e),N.include(w.MixExternalColor),f.addMainLightIntensity(N),N.main.add(M.glsl`
      discardBySlice(vpos);
      discardByTerrainDepth();
      vec4 texColor = ${t?`texture(tex, ${r?"colorUV":"vuv0"})`:" vec4(1.0)"};
      ${M.If(t,`${M.If(e.textureAlphaPremultiplied,"texColor.rgb /= texColor.a;")}\n        discardOrAdjustAlpha(texColor);`)}
      vec3 viewDirection = normalize(vpos - cameraPosition);
      applyPBRFactors();
      float ssao = evaluateAmbientOcclusionInverse();
      ssao *= getBakedOcclusion();

      float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
      vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
      float shadow = ${i?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":j?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};
      vec3 matColor = max(ambient, diffuse);
      ${e.hasVertexColors?M.glsl`vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
             float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:M.glsl`vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
             float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
      ${M.If(z,"albedo = mix(albedo, vec3(1), 0.9);")}
      ${M.glsl`vec3 shadingNormal = normalize(vNormalWorld);
             albedo *= 1.2;
             vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
             float alignmentLightView = clamp(dot(viewForward, -mainLightDirection), 0.0, 1.0);
             float transmittance = 1.0 - clamp(dot(viewForward, shadingNormal), 0.0, 1.0);
             float treeRadialFalloff = vColor.r;
             float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
             additionalLight += backLightFactor * mainLightIntensity;`}
      ${M.If(H,`vec3 normalGround = ${j?"normalize(vpos + localOrigin)":"vec3(0.0, 0.0, 1.0)"};`)}
      ${H?M.glsl`float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
                 ${M.If(z,M.glsl`mrr = applySnowToMRR(mrr, 1.0)`)}
            vec4 emission = ${z||q?"vec4(0.0)":"getEmissions(albedo)"};
            vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:M.glsl`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
      vec4 finalColor = vec4(shadedColor, opacity_);
      outputColorHighlightOID(finalColor, vpos, albedo ${M.If(z,", 1.0")});`)}return D.include(h.DefaultMaterialAuxiliaryPasses,e),D}const F=Object.freeze(Object.defineProperty({__proto__:null,build:D},Symbol.toStringTag,{value:"Module"}));e.RealisticTree=F,e.build=D}))},"esri/views/3d/layers/graphics/interfaces":function(){define(["exports"],(function(e){"use strict";var t,r;e.ApplyRendererDiffResult=void 0,(t=e.ApplyRendererDiffResult||(e.ApplyRendererDiffResult={}))[t.RecreateSymbol=0]="RecreateSymbol",t[t.RecreateGraphics=1]="RecreateGraphics",t[t.FastUpdate=2]="FastUpdate",e.FastUpdateStatus=void 0,(r=e.FastUpdateStatus||(e.FastUpdateStatus={}))[r.Slow=0]="Slow",r[r.Fast=1]="Fast",r[r.Mixed=2]="Mixed",r[r.Loading=3]="Loading",r[r.Undefined=4]="Undefined",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Loadable":function(){define(["exports","../../../../core/maybe","../../../../core/promiseUtils"],(function(e,t,r){"use strict";var i;e.LoadStatus=void 0,(i=e.LoadStatus||(e.LoadStatus={}))[i.LOADING=0]="LOADING",i[i.LOADED=1]="LOADED",i[i.FAILED=2]="FAILED",e.Loadable=class{constructor(t){this.schedule=t,this._abortController=null,this._loadStatus=e.LoadStatus.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(t,i){return this._loadStatus===e.LoadStatus.LOADED?(t&&t(),this._loader??Promise.resolve()):this._loadStatus===e.LoadStatus.FAILED?(i&&i(this._loadError),this._loader??Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=e.LoadStatus.LOADED}),(t=>{throw this._loadError=t,this._abortController=null,this._loadStatus=e.LoadStatus.FAILED,!r.isAbortError(t)&&this.logger&&t.message&&this.logger.warn(t.message),t}))),this._loader.then(t,i).catch((()=>{})),this._loader)}abortLoad(){null!=this._abortController?this._abortController=t.abortMaybe(this._abortController):this._loadStatus===e.LoadStatus.LOADING&&(this._loadStatus=e.LoadStatus.FAILED),this._loader=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/pointUtils":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectPointToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/coordsUtils","../../../../layers/graphics/dehydratedPoint","./elevationAlignmentUtils","./graphicUtils","../../webgl-engine/lib/Object3D"],(function(e,t,r,i,s,n,o,a,l){"use strict";function c(e,t){const s=e.clippingExtent;return!!s&&(r.projectPointToVector(t,d,e.elevationProvider.spatialReference),!i.containsPoint(s,d))}function u(e,t){return r.projectPointToVector(t,d,e.renderCoordsHelper.spatialReference),e.localOriginFactory.getOrigin(d)}const d=t.create();e.createStageObject=function(e,t,r,i,s){if(c(e,t))return null;r.localOrigin=u(e,t);const n=new l.Object3D({geometries:[r],castShadow:!1,layerViewUid:e.layerViewUid,graphicUid:s,usesVerticalDistanceToGround:!0});return{object:n,sampledElevation:o.applyElevationAlignmentForHUD(n,t,e.elevationProvider,e.renderCoordsHelper,i)}},e.extendPointGraphicElevationContext=function(e,t,i){const s=e.elevationContext,o=i.spatialReference;r.projectPointToVector(t,d,o),s.centerPointInElevationSR=n.makeDehydratedPoint(d[0],d[1],t.hasZ?d[2]:0,null!=o?o:null)},e.getLocalOriginForPoint=u,e.placePointOnGeometry=function(e){switch(e.type){case"point":return e;case"polygon":case"extent":return a.computeCentroid(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const r=s.getPointOnPath(t,s.getPathLength(t)/2);return n.makeDehydratedPoint(r[0],r[1],r[2],e.spatialReference)}case"mesh":return e.extent.center}return null},e.updateStageObjectGeometry=function(e,t,r,i){return c(t,r)?null:o.applyElevationAlignmentForHUD(e,r,t.elevationProvider,t.renderCoordsHelper,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Object3D":function(){define(["exports","../../../../core/has","../../../../core/uid","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/sphere","../../support/mathUtils","./basicInterfaces","./Object3DStateID","./Util","./VertexAttribute","../materials/renderers/utils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class m{constructor(){this.min=o.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=o.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class f extends m{constructor(){super(...arguments),this.bounds=a.create()}}function g(e,t,r){const s=e.bbMin,o=e.bbMax;if(i.hasIdentityRotation(r)){const e=n.set(y,r[12],r[13],r[14]);n.add(_,s,e),n.add(b,o,e);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],_[e]),t.max[e]=Math.max(t.max[e],b[e])}else if(n.transformMat4(_,s,r),n.exactEquals(s,o))for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],_[e]),t.max[e]=Math.max(t.max[e],_[e]);else{n.transformMat4(b,o,r);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],_[e],b[e]),t.max[e]=Math.max(t.max[e],_[e],b[e]);for(let e=0;e<3;++e){n.copy(_,s),n.copy(b,o),_[e]=o[e],b[e]=s[e],n.transformMat4(_,_,r),n.transformMat4(b,b,r);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],_[e],b[e]),t.max[e]=Math.max(t.max[e],_[e],b[e])}}}const y=o.create(),_=o.create(),b=o.create(),v=o.create();var S;!function(e){e[e.WorldSpace=0]="WorldSpace",e[e.ObjectSpace=1]="ObjectSpace"}(S||(S={})),e.BoundingVolume=f,e.Object3D=class{constructor(e={}){this.id=r.generateUID(),this._highlightIds=new Set,this._shaderTransformation=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerViewUid=e.layerViewUid,e.isElevationSource&&(this.lastValidElevationBB=new m),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get layer(){return this._layer}set layer(e){d.assert(null==this._layer||null==e,"Object3D can only be added to a single Layer"),this._layer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e);for(const t of this._highlightIds)e.addHighlight(t);this._emit("geometryAdded",{object:this,geometry:e}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];if(t){for(const e of this._highlightIds)t.removeHighlight(e);this._emit("geometryRemoved",{object:this,geometry:t}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,r=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:r}),h.affectsGeometry(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometries)e.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new u.Object3DOccludeeStateID;for(const t of this._geometries)t.occludees=p.addObject3DStateID(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=p.removeObject3DStateID(t.occludees,e);this._emit("occlusionChanged",this)}highlight(e){const t=new u.Object3DHighlightStateID(e);for(const e of this._geometries)e.addHighlight(t);return this._emit("highlightChanged",this),this._highlightIds.add(t),t}removeHighlight(e){this._highlightIds.delete(e);for(const t of this._geometries)t.removeHighlight(e);this._emit("highlightChanged",this)}removeStateID(e){e.channel===c.Object3DState.Highlight?this.removeHighlight(e):this.removeOcclude(e)}getCombinedStaticTransformation(e,t){return i.multiply(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=s.create()){return i.multiply(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new f,this._validateBoundingVolume(this._bvWorldSpace,S.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new f,this._validateBoundingVolume(this._bvObjectSpace,S.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,t){const r=t===S.ObjectSpace;for(const t of this._geometries){const i=t.boundingInfo;i&&g(i,e,r?t.transformation:this.getCombinedShaderTransformation(t))}n.lerp(a.getCenter(e.bounds),e.min,e.max,.5);for(const t of this._geometries){const i=t.boundingInfo;if(null==i)continue;const s=r?t.transformation:this.getCombinedShaderTransformation(t),o=l.maxScale(s);n.transformMat4(v,i.center,s);const c=n.distance(v,a.getCenter(e.bounds)),u=i.radius*o;e.bounds[3]=Math.max(e.bounds[3],c+u)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this.layer&&e&&this.layer.notifyObjectBBChanged(this,e)}_emit(e,t){this.layer?.events.emit(e,t)}get geometries(){return this._geometries}get transformation(){return this._transformation??s.IDENTITY}set transformation(e){this._transformation=i.copy(this._transformation??s.create(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?i.copy(this._shaderTransformation??s.create(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/renderers/utils":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../webgl/doublePrecisionUtils"],(function(e,t,r){"use strict";const i=t.create(),s=new Float32Array(6);e.addObject3DStateID=function(e,t){return null==e&&(e=[]),e.push(t),e},e.encodeDoubleVec3=function(e,t,n,o,a){i[0]=e.get(t,0),i[1]=e.get(t,1),i[2]=e.get(t,2),r.encodeDoubleArray(i,s,3),n.set(a,0,s[0]),o.set(a,0,s[1]),n.set(a,1,s[2]),o.set(a,1,s[3]),n.set(a,2,s[4]),o.set(a,2,s[5])},e.removeObject3DStateID=function(e,t){if(null==e)return null;const r=e.filter((e=>e!==t));return 0===r.length?null:r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/LineCalloutMaterial":function(){define(["exports","../../../../core/string","../../../../core/libs/gl-matrix-2/factories/vec2f32","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/VertexAttribute","./internal/bufferWriterUtils","../shaders/LineCalloutTechnique","../shaders/LineCalloutTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class m extends a.Material{constructor(e,t){super(e,y),this.intersectDraped=void 0,this.produces=new Map([[l.RenderSlot.LINE_CALLOUTS,e=>n.isColorOrColorEmission(e)],[l.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,e=>n.isColorOrColorEmission(e)]]),this._configuration=new h.LineCalloutTechniqueConfiguration(t),this._uniqueMaterialIdentifier=f(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.hudDepth=t.slot===l.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=p.alphaCutoff||(this.parameters.borderColor?.[3]??0)>=p.alphaCutoff}intersect(){}createGLMaterial(e){return new g(e)}createBufferWriter(){return new v}validateParameters(e){this._uniqueMaterialIdentifier=f(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}}function f({renderOccluded:e,isDecoration:r,horizontalScreenOffset:i,color:s,size:n,occlusionTest:o,shaderPolygonOffset:a,hudDepthAlignStart:l,centerOffsetUnits:c,hasSlicePlane:u,screenSizePerspective:d,verticalOffset:h,borderColor:p}){return t.safeToString`${e}:${r}:${i}:[${s}]:${n}:${o}:${a}:${l}:${c}:${u}:${null!=d}:{${h.screenLength}:${h.minWorldLength}:${h.maxWorldLength}}:[${p}]`}class g extends o{beginSlot(e){return this.getTechnique(d.LineCalloutTechnique,e)}}class y extends a.MaterialParameters{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=i.fromValues(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const _=s.newLayout().vec3f(c.VertexAttribute.POSITION).vec3f(c.VertexAttribute.NORMAL).vec2f16(c.VertexAttribute.UV0).vec4f(c.VertexAttribute.CENTEROFFSETANDDISTANCE),b=[r.fromValues(0,0),r.fromValues(1,0),r.fromValues(0,1),r.fromValues(1,0),r.fromValues(1,1),r.fromValues(0,1)];class v{constructor(){this.vertexBufferLayout=_}elementCount(e){return 6*e.get(c.VertexAttribute.POSITION).indices.length}write(e,t,r,i,s,n){u.writePosition(r.get(c.VertexAttribute.POSITION),e,s.position,n,6),u.writeNormal(r.get(c.VertexAttribute.NORMAL),t,s.normal,n,6),u.writeBufferVec4(r.get(c.VertexAttribute.CENTEROFFSETANDDISTANCE),s.centerOffsetAndDistance,n,6);for(let e=0;e<b.length;++e)s.uv0.setVec(n+e,b[e]);return null}}e.LineCalloutMaterial=m,e.Parameters=y,e.uniqueMaterialIdentifier=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/libs/gl-matrix-2/factories/vec2f32":function(){define(["exports"],(function(e){"use strict";function t(){return new Float32Array(2)}function r(e){const t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t}function i(e,t){const r=new Float32Array(2);return r[0]=e,r[1]=t,r}function s(){return t()}function n(){return i(1,1)}function o(){return i(1,0)}function a(){return i(0,1)}const l=s(),c=n(),u=o(),d=a(),h=Object.freeze(Object.defineProperty({__proto__:null,ONES:c,UNIT_X:u,UNIT_Y:d,ZEROS:l,clone:r,create:t,fromValues:i,ones:n,unitX:o,unitY:a,zeros:s},Symbol.toStringTag,{value:"Module"}));e.ONES=c,e.UNIT_X=u,e.UNIT_Y=d,e.ZEROS=l,e.clone=r,e.create=t,e.fromValues=i,e.ones=n,e.unitX=o,e.unitY=a,e.vec2f32=h,e.zeros=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/LineCalloutTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../../chunks/LineCallout.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.LineCallout,(()=>new Promise(((t,r)=>e(["./LineCallout.glsl"],t,r))))))}initializePipeline(e){const{hudDepth:t,terrainDepthTest:r}=e,i={func:r?n.CompareFunction.ALWAYS:n.CompareFunction.LESS};return o.makePipelineState(t?{depthTest:i,depthWrite:o.defaultDepthWrite}:{blending:o.separateBlendingParams(n.BlendFactor.ONE,n.BlendFactor.SRC_ALPHA,n.BlendFactor.ONE_MINUS_SRC_ALPHA,n.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:i,colorWrite:o.defaultColorWrite})}}t.LineCalloutTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/LineCallout.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","../core/libs/gl-matrix-2/factories/vec4f64","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/AlignPixel.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUD.glsl","../views/3d/webgl-engine/core/shaderLibrary/hud/HUDVisibility.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MultipassGeometryTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ScreenSizePerspective.glsl","../views/3d/webgl-engine/core/shaderModules/Float2BindUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/lib/VertexAttribute","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";function _(e){const r=new y.ShaderBuilder,{vertex:_,fragment:v}=r,{terrainDepthTest:S}=e;return _.include(n.AlignPixel),r.include(o.HUD,e),r.vertex.include(s.RejectBySlice,e),r.attributes.add(g.VertexAttribute.UV0,"vec2"),_.uniforms.add(new h.Float4BindUniform("viewport",(e=>e.camera.fullViewport)),new m.FloatPassUniform("lineSize",((e,t)=>e.size>0?Math.max(1,e.size)*t.camera.pixelRatio:0)),new u.Float2BindUniform("pixelToNDC",(e=>t.set(b,2/e.camera.fullViewport[2],2/e.camera.fullViewport[3]))),new m.FloatPassUniform("borderSize",((e,t)=>e.borderColor?t.camera.pixelRatio:0)),new d.Float2PassUniform("screenOffset",((e,r)=>t.set(b,e.horizontalScreenOffset*r.camera.pixelRatio,0)))),r.varyings.add("coverageSampling","vec4"),r.varyings.add("lineSizes","vec2"),S&&r.varyings.add("depth","float"),e.occlusionTestEnabled&&r.include(a.HUDVisibility),e.hasScreenSizePerspective&&c.addScreenSizePerspectiveAlignment(_),_.main.add(f.glsl`
    ProjectHUDAux projectAux;
    vec4 endPoint = projectPositionHUD(projectAux);

    vec3 vpos = projectAux.posModel;
    if (rejectBySlice(vpos)) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
    ${f.If(e.occlusionTestEnabled,f.glsl`if (!testHUDVisibility(endPoint)) {
             gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
             return;
           }`)}

    ${e.hasScreenSizePerspective?f.glsl`vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
               vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);`:"vec2 screenOffsetScaled = screenOffset;"}
    // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
    // correct depth value
    vec3 posView = (view * vec4(position, 1.0)).xyz;
    ${f.If(S,"depth = posView.z;")}

    applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);
    vec4 startPoint = proj * vec4(posView, 1.0);

    // Apply screen offset to both start and end point
    vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
    startPoint.xy += screenOffsetNorm * startPoint.w;
    endPoint.xy += screenOffsetNorm * endPoint.w;

    // Align start and end to pixel origin
    vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
    vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${f.If(e.hudDepth,e.hudDepthAlignStart?"endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);":"startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);")}
    vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);

    // The direction of the line in screen space
    vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
    vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.hasScreenSizePerspective?f.glsl`float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
               float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);`:f.glsl`float lineSizeScaled = lineSize;
               float borderSizeScaled = borderSize;`}
    float halfPixelSize = lineSizeScaled * 0.5;

    // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
    float padding = 1.0 + borderSizeScaled;
    vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

    // Offset x/y from the center of the line in screen space
    projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

    // Compute a coverage varying which we can use in the fragment shader to determine
    // how much a pixel is actually covered by the line (i.e. to anti alias the line).
    // This works by computing two coordinates that can be linearly interpolated and then
    // subtracted to find out how far away from the line edge we are.
    float edgeDirection = (uv0.x * 2.0 - 1.0);

    float halfBorderSize = 0.5 * borderSizeScaled;
    float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
    float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

    float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

    coverageSampling = vec4(
      // Edge coordinate
      outerEdgeCoverageSampler,

      // Border edge coordinate
      outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

      // Line offset
      halfPixelSize - 0.5,

      // Border offset
      halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
    );

    lineSizes = vec2(lineSizeScaled, borderSizeScaled);
    gl_Position = projectedPosition;`),v.uniforms.add(new p.Float4PassUniform("uColor",(e=>e.color??i.ZEROS)),new p.Float4PassUniform("borderColor",(e=>e.borderColor??i.ZEROS))),S&&(v.include(l.multipassGeometryTest,e),v.uniforms.add(new u.Float2BindUniform("inverseViewport",(e=>e.inverseViewport)))),v.main.add(f.glsl`
    ${f.If(S,"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }")}

    vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

    float borderAlpha = uColor.a * borderColor.a * coverage.y;
    float colorAlpha = uColor.a * coverage.x;

    float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);
    ${f.If(!e.hudDepth,f.glsl`vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
           fragColor = vec4(finalRgb, finalAlpha);`)}`),r}const b=r.create(),v=Object.freeze(Object.defineProperty({__proto__:null,build:_},Symbol.toStringTag,{value:"Module"}));e.LineCallout=v,e.build=_}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/MultipassGeometryTest.glsl":function(){define(["exports","../output/ReadDepth.glsl","../../shaderModules/glsl","../../shaderModules/Texture2DBindUniform"],(function(e,t,r,i){"use strict";e.multipassGeometryTest=function(e){e.include(t.ReadDepth),e.uniforms.add(new i.Texture2DBindUniform("geometryDepthTexture",(e=>e.geometryDepth?.attachment))),e.code.add(r.glsl`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/LineCalloutTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],(function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}}t.__decorate([r.parameter()],s.prototype,"screenCenterOffsetUnitsEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"occlusionTestEnabled",void 0),t.__decorate([r.parameter()],s.prototype,"hasVerticalOffset",void 0),t.__decorate([r.parameter()],s.prototype,"hasScreenSizePerspective",void 0),t.__decorate([r.parameter()],s.prototype,"hudDepth",void 0),t.__decorate([r.parameter()],s.prototype,"hudDepthAlignStart",void 0),t.__decorate([r.parameter()],s.prototype,"terrainDepthTest",void 0),e.LineCalloutTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/graphicSymbolUtils":function(){define(["exports","./Graphics3DSymbol","./Graphics3DWebStyleSymbol"],(function(e,t,r){"use strict";e.getGraphics3DSymbol=function(e){return e instanceof r.Graphics3DWebStyleSymbol?e.graphics3DSymbol:e instanceof t.Graphics3DSymbol?e:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DSymbol":function(){define(["require","exports","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/has","../../../../core/promiseUtils","./defaultSymbolComplexity","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCreationContext","./interfaces","./Loadable","./symbolMemory"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p extends d.Loadable{set symbol(e){this._symbol=e,e.symbolLayers.forEach(((t,r)=>{const i=this.symbolLayers[r];null!=i&&(i.symbol=e,i.symbolLayer=t)}))}get symbol(){return this._symbol}constructor(e,t,r){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(t){let r=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(r=this._backgroundLayers.concat(r));const s=r.length;for(;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);this.symbolLayers.length=r.length;const o=[];if(!m){const{make:t}=await new Promise(((t,r)=>e(["./Graphics3DSymbolLayerFactory"],t,r)));m=t}for(let e=0;e<s;e++){const i=r.at(e);if(!1===i.enabled)continue;f.renderPriority=1-(1+e)/s,f.renderPriorityStep=1/s,f.ignoreDrivers=i.ignoreDrivers;const a=m(this.symbol,i,this._context,f),l=n.onAbortOrThrow(t,(()=>{this.symbolLayers[e]=null,a.destroy()}));l&&o.push(l),this.symbolLayers[e]=a}if(await i.forEach(this.symbolLayers,(async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}})),o.forEach((e=>e.remove())),n.throwIfAborted(t),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((e=>e?.queryForSnapping))}updateFocus(e,t){this.symbolLayers.forEach((r=>r?.updateFocus(e,t)))}createGraphics3DGraphic(e,t){const r=e.graphic,i=this.symbolLayers.map((t=>t?.createGraphics3DGraphic(e)??null)),s=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new a.Graphics3DGraphic(r,t||this,i,e.layer,s)}get complexity(){return o.totalSymbolComplexities(this.symbolLayers.map((e=>null!=e?e.complexity:null)))}globalPropertyChanged(e,t){const r=this.symbolLayers.length;for(let i=0;i<r;i++){const r=this.symbolLayers[i],s=e=>{const t=e.layers[i];return t instanceof l.Graphics3DObject3DGraphicLayer?t:null};if(null!=r&&!r.globalPropertyChanged(e,t,s))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==d.LoadStatus.LOADED?u.ApplyRendererDiffResult.RecreateSymbol:this.symbolLayers.reduce(((r,i)=>r!==u.ApplyRendererDiffResult.RecreateSymbol&&null!=i?Math.min(r,i.applyRendererDiff(e,t)):r),u.ApplyRendererDiffResult.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===d.LoadStatus.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const r=t.symbolLayers.diff;this.symbolLayers.forEach(((t,i)=>{if(null==t)return;const s=r[i];if(s){const r={diff:s,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(r),e.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const s=e.layers[i];null!=s&&r.graphics3DGraphicPatches.forEach((e=>e(s,t)))}))}}))}updateGeometry(e,t){return this._updateGeometryOrTransform(e,((e,r)=>e.updateGeometry(r,t)))}updateTransform(e,t,r,i){return this._updateGeometryOrTransform(e,((e,s)=>e.updateTransform(s,t,r,i)))}_updateGeometryOrTransform(e,t){for(let r=0;r<this.symbolLayers.length;r++){const i=this.symbolLayers[r];if(null==i)continue;const s=e.layers[r];if(!s||!t(i,s))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const r=this.symbolLayers[t];if(null==r)continue;const i=e.layers[t];null!=i&&r.onRemoveGraphic(i)}}getFastUpdateStatus(){let e=!1,t=!1;for(const r of this.symbolLayers)if(null!=r){if(r.loadStatus===d.LoadStatus.LOADING)return u.FastUpdateStatus.Loading;r.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?u.FastUpdateStatus.Mixed:u.FastUpdateStatus.Fast:e?u.FastUpdateStatus.Slow:u.FastUpdateStatus.Undefined}async queryForSnapping(e,t,i,s){const o=this.symbolLayers.filter(r.isSome).filter((e=>null!=e.queryForSnapping)).map((r=>r.queryForSnapping(e,t,i,s))),a=await Promise.all(o);return n.throwIfAborted(s),a.flat()}destroy(){if(!this.destroyed){super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get cachedMemory(){return h.getSymbolMemorySize(this)}}let m=null;const f=new c.Graphics3DSymbolLayerCreationContext;t.Graphics3DSymbol=p,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DGraphic":function(){define(["exports","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/has","../../../../core/memoryEstimations","../../../../core/ObjectPool","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Polygon","../../../../geometry/projection/projectBoundingRect","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./enums","./featureExpressionInfoUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_){"use strict";const b=new n(Array,(e=>h.set(e,h.zero)),null,10,5),v=p.create();e.Graphics3DGraphic=class{get labelLayers(){return this._labelLayers||t.emptyArray}get extent(){return this._extent}get isElevationSource(){return this.layers.some((e=>e?.isElevationSource))}constructor(e,t,r,i,s){this.graphic=e,this.graphics3DSymbol=t,this.layers=r,this._visibleFlags=y.VisibilityFlag.ALL_LABEL,++t.referenced,this._featureExpressionFeature=s?_.createFeature(s,e,i):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic((t=>{t.initialize(e),t.setVisibility(this.isVisible())}))}destroy(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic((e=>e.destroy())),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(y.VisibilityGroup.LABEL))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(e=y.VisibilityGroup.GRAPHIC,t){const r=t?this._visibleFlags|t|y.VisibilityGroup.LABEL*t:this._visibleFlags;return e===y.VisibilityGroup.GRAPHIC?(r&y.VisibilityFlag.ALL_GRAPHIC)===y.VisibilityFlag.ALL_GRAPHIC:(r&y.VisibilityFlag.ALL_LABEL)===y.VisibilityFlag.ALL_LABEL}setVisibilityFlag(e,t,r){const i=this.isVisible(e);r?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const s=this.isVisible(e);if(i===s)return!1;if(e===y.VisibilityGroup.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(s)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(y.VisibilityGroup.LABEL);this._forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}getVisibilityFlag(e,t){return 0!==(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(null==t)return!1;this._extent=p.create(),f.computeAABR(t,this._extent);const r=t.spatialReference;if(!m.equals(r,e)&&!d.projectBoundingRect(this._extent,r,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,r){let i=e.geometry;return"mesh"!==i.type&&"extent"!==i.type||(i=u.fromExtent("mesh"===i.type?i.extent:i)),g.convertFromGeometry(i,t,r)}get usedMemory(){let e=s.estimateAttributesMemory(this.graphic.attributes);return this._forEachSymbolLayerGraphic((t=>e+=t.usedMemory)),e}computeAttachmentOrigin(){const e={render:{origin:c.create(),num:0},draped:{origin:a.create(),num:0}};for(const t of this.layers)null!=t&&t.computeAttachmentOrigin(e);return e.render.num>1&&l.scale(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&o.scale(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?h.empty(n.boundingBox):n.boundingBox=h.empty(),n.requiresDrapedElevation=!1,await r.forEach(this.layers,(async r=>{if(null==r)return;const o="draped"===r.type?t:e,a=b.acquire(),l=await r.getProjectedBoundingBox(o,i,n.screenSpaceObjects,s,a);isFinite(l[2])&&isFinite(l[5])||(n.requiresDrapedElevation=!0),l&&h.expandWithAABB(n.boundingBox,a),b.release(a)})),h.allFinite(n.boundingBox)||p.allFinite(h.toRect(n.boundingBox,v))?n:null}needsElevationUpdates(){for(const e of this.layers)if(null!=e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some((e=>e?.needsElevationUpdates??!1))??!1}alignWithElevation(e,t,r){this._forEachRenderedGraphic((i=>{"object3d"!==i.type&&"lod-instance"!==i.type||i.alignWithElevation(e,t,this._featureExpressionFeature,r)}))}alignWithAbsoluteElevation(e,t,r){this._forEachRenderedGraphic((i=>{"object3d"===i.type&&i.alignWithAbsoluteElevation(e,t,r)}))}addObjectStateSet(e){this._forEachSymbolLayerGraphic((t=>t.addObjectState(e)))}removeObjectState(e){this._forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}updateHighlights(e){this._forEachSymbolLayerGraphic((t=>t.updateHighlights(e)))}_forEachGraphicList(e,t){e?.forEach((e=>e&&t(e)))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/dehydratedFeatures":function(){define(["exports","../../core/has","../../core/memoryEstimations","../../core/uid","../../geometry/SpatialReference","../../geometry/support/aaBoundingBox","../../geometry/support/aaBoundingRect","../../geometry/support/quantizationUtils","../../geometry/support/typeUtils","../support/Field","../../views/2d/layers/graphics/densificationConstants","./dehydratedFeatureComparison"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e,t,r){if(null==e)return null;switch(t){case"point":{const t=e;return{x:t.x,y:t.y,z:t.z,m:t.m,hasZ:null!=t.z,hasM:null!=t.m,type:"point",spatialReference:r}}case"polyline":{const t=e;return{paths:t.paths,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"polyline",spatialReference:r}}case"polygon":{const t=e;return{rings:t.rings,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"polygon",spatialReference:r}}case"multipoint":{const t=e;return{points:t.points,hasZ:!!t.hasZ,hasM:!!t.hasM,type:"multipoint",spatialReference:r}}}}function p(e){if(null==e)return 0;switch(e.type){case"point":return r.baseObjectMemory+10+8+24;case"polyline":case"polygon":{let t=0;const i=2+(e.hasZ?1:0)+(e.hasM?1:0),s="polyline"===e.type?e.paths:e.rings,n="polyline"===e.type?e.curvePaths:e.curveRings;if(n?.length){const e=3*u.getApproximateMaxDensificationSegments()*128;t=8*e*i+128*e+32*(s.length+1)}else t=r.estimateNestedObjectMemory(s);return r.baseObjectMemory+64+t+34}case"multipoint":{const t=r.estimateNestedObjectMemory(e.points);return r.baseObjectMemory+t+64+34+32}case"extent":return r.baseObjectMemory+10+64+34;case"mesh":{const t=e.vertexAttributes;return r.baseObjectMemory+r.estimateNumberArrayMemory(t.position,t.normal,t.uv,t.tangent)}default:return r.baseObjectMemory}}function m(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}function f(e,t,r,i){if(t?.size&&null!=r&&e)for(const s in e){if(!t.has(s))continue;const n=e[s];"string"==typeof n&&n.length>r&&(i(s),e[s]="")}}e.equals=d.equals,e.DehydratedFeatureClass=class{constructor(e,t,r){this.uid=e,this.geometry=t,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null}},e.DehydratedFeatureSetClass=class{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}},e.computeAABB=function(e,t){switch(n.empty(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let r=0;r<e.paths.length;r++)n.expandWithNestedArray(t,e.paths[r],!!e.hasZ);break;case"polygon":for(let r=0;r<e.rings.length;r++)n.expandWithNestedArray(t,e.rings[r],!!e.hasZ);break;case"multipoint":n.expandWithNestedArray(t,e.points,!!e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}return t},e.computeAABR=function(e,t){switch(o.empty(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let r=0;r<e.paths.length;r++)o.expandWithNestedArray(t,e.paths[r]);break;case"polygon":for(let r=0;r<e.rings.length;r++)o.expandWithNestedArray(t,e.rings[r]);break;case"multipoint":o.expandWithNestedArray(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}},e.estimateGeometryMemory=p,e.estimateSize=function(e){let t=32;return t+=r.estimateAttributesMemory(e.attributes),t+=3,t+=8+p(e.geometry),t},e.fromFeatureSetJSON=function(e,t){const r=l.featureGeometryTypeKebabDictionary.fromJSON(e.geometryType),n=s.fromJSON(e.spatialReference),o=e.transform,u=e.objectIdFieldName,d=t?.maxStringAttributeLength,p=t?.maxStringAttributeFields;let g;const y=e.features.map((t=>{const s=function(e,t,r,s){return{uid:i.generateUID(),objectId:s&&e.attributes?e.attributes[s]:null,attributes:e.attributes,geometry:h(e.geometry,t,r),visible:!0}}(t,r,n,e.objectIdFieldName),l=s.geometry;if(f(s.attributes,p,d,(e=>{g??=[];const t=m(s,u);null!=t&&g.push({objectId:t,attribute:e})})),null!=l&&o)switch(l.type){case"point":s.geometry=a.unquantizePoint(o,l,l);break;case"multipoint":s.geometry=a.unquantizeMultipoint(o,l,l);break;case"polygon":s.geometry=a.unquantizePolygon(o,l,l);break;case"polyline":s.geometry=a.unquantizePolyline(o,l,l);break;case"extent":case"mesh":s.geometry=l}return s}));return{geometryType:r,features:y,spatialReference:n,fields:e.fields?.map((e=>c.fromJSON(e)))??[],objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null,missingAttributes:g}},e.fromJSONGeometry=h,e.getObjectId=m,e.hasGeometry=function(e){return null!=e.geometry},e.hasVertices=function(e){if(null==e)return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":for(const t of e.paths)if(t.length>0)return!0;return!1;case"polygon":for(const t of e.rings)if(t.length>0)return!0;return!1;case"multipoint":return e.points.length>0;case"mesh":return!e.loaded||e.vertexAttributes.position.length>0}},e.numVertices=function(e){if(null==e)return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const r of e.paths)t+=r.length;return t}case"polygon":{let t=0;for(const r of e.rings)t+=r.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}},e.removeLargeStringAttributes=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/quantizationUtils":function(){define(["exports","./jsonUtils"],(function(e,t){"use strict";function r(e){if(function(e){return"lowerLeft"===e.originPosition&&4===e.scale.length&&4===e.translate.length}(e))return e;const{originPosition:t,scale:r,translate:i}=e,s=r[0]??1,n=r[1]??1;return{originPosition:"lowerLeft",scale:[s,"lowerLeft"===t?n:-n,r[2]??1,r[3]??1],translate:[i[0]??0,i[1]??0,i[2]??0,i[3]??0]}}function i({scale:e,translate:t},r){return Math.round((r-t[0])/e[0])}function s({scale:e,translate:t},r){return Math.round((r-t[1])/e[1])}function n({scale:e,translate:t},r){return Math.round(((r??0)-t[2])/e[2])}function o({scale:e,translate:t},r){return r?Math.round((r-t[3])/e[3]):0}function a(e,t){return e&&t?d:e&&!t?c:!e&&t?u:l}const l=(e,t)=>{const r=[];if(!t.length)return null;const n=t[0];let o=i(e,n[0]),a=s(e,n[1]);r.push([o,a]);for(let n=1;n<t.length;n++){const[l,c]=t[n],u=i(e,l),d=s(e,c);u===o&&d===a||r.push([u-o,d-a]),o=u,a=d}return r},c=(e,t)=>{const r=[];if(!t.length)return null;const o=t[0];let a=i(e,o[0]),l=s(e,o[1]),c=n(e,o[2]);r.push([a,l,c]);for(let o=1;o<t.length;o++){const[u,d,h]=t[o],p=i(e,u),m=s(e,d),f=n(e,h);p===a&&m===l&&f===c||r.push([p-a,m-l,f]),a=p,l=m,c=f}return r},u=(e,t)=>{const r=[];if(!t.length)return null;const n=t[0];let a=i(e,n[0]),l=s(e,n[1]),c=o(e,n[2]);r.push([a,l,c]);for(let n=1;n<t.length;n++){const[u,d,h]=t[n],p=i(e,u),m=s(e,d),f=o(e,h);p===a&&m===l&&f===c||r.push([p-a,m-l,f]),a=p,l=m,c=f}return r},d=(e,t)=>{const r=[];if(!t.length)return null;const a=t[0];let l=i(e,a[0]),c=s(e,a[1]),u=n(e,a[2]),d=o(e,a[3]);r.push([l,c,u,d]);for(let a=1;a<t.length;a++){const[h,p,m,f]=t[a],g=i(e,h),y=s(e,p),_=n(e,m),b=o(e,f);g===l&&y===c&&_===u&&b===d||r.push([g-l,y-c,_,b]),l=g,c=y,u=_,d=b}return r};function h({scale:e,translate:t},r){return r*e[0]+t[0]}function p({scale:e,translate:t},r){return r*e[1]+t[1]}function m({scale:e,translate:t},r){return(r??0)*e[2]+t[2]}function f({scale:e,translate:t},r){return r?r*e[3]+t[3]:0}function g(e,t){return e&&t?v:e&&!t?_:!e&&t?b:y}const y=(e,t)=>{const r=new Array(t.length);if(!t.length)return r;const i=t[0];let s=h(e,i[0]),n=p(e,i[1]);r[0]=[s,n];const{scale:o,originPosition:a}=e,l=o[0],c="lowerLeft"===a?o[1]:-o[1];for(let e=1;e<t.length;e++){const[i,o]=t[e];s+=l*i,n+=c*o,r[e]=[s,n]}return r},_=(e,t)=>{const r=new Array(t.length);if(!t.length)return r;const i=t[0];let s=h(e,i[0]),n=p(e,i[1]);r[0]=[s,n,m(e,i[2])];const{scale:o,originPosition:a}=e,l=o[0],c="lowerLeft"===a?o[1]:-o[1];for(let i=1;i<t.length;i++){const[o,a,u]=t[i];s+=l*o,n+=c*a,r[i]=[s,n,m(e,u)]}return r},b=(e,t)=>{const r=new Array(t.length);if(!t.length)return r;const i=t[0];let s=h(e,i[0]),n=p(e,i[1]);r[0]=[s,n,f(e,i[2])];const{scale:o,originPosition:a}=e,l=o[0],c="lowerLeft"===a?o[1]:-o[1];for(let i=1;i<t.length;i++){const[o,a,u]=t[i];s+=l*o,n+=c*a,r[i]=[s,n,f(e,u)]}return r},v=(e,t)=>{const r=new Array(t.length);if(!t.length)return r;const i=t[0];let s=h(e,i[0]),n=p(e,i[1]);r[0]=[s,n,m(e,i[2]),f(e,i[3])];const{scale:o,originPosition:a}=e,l=o[0],c="lowerLeft"===a?o[1]:-o[1];for(let i=1;i<t.length;i++){const[o,a,u,d]=t[i];s+=l*o,n+=c*a,r[i]=[s,n,m(e,u),f(e,d)]}return r};function S(e,t,r){const i=new Array(r.length);for(let s=0;s<r.length;s++)i[s]=t(e,r[s]);return i}function w(e,t,r){let[i,s]=r[0],n=Math.min(i,t[0]),o=Math.min(s,t[1]),a=Math.max(i,t[2]),l=Math.max(s,t[3]);for(let e=1;e<r.length;e++){const[t,c]=r[e];i+=t,s+=c,t<0&&(n=Math.min(n,i)),t>0&&(a=Math.max(a,i)),c<0?o=Math.min(o,s):c>0&&(l=Math.max(l,s))}return e[0]=n,e[1]=o,e[2]=a,e[3]=l,e}function x(e,t){if(!t.length)return null;e[0]=e[1]=Number.POSITIVE_INFINITY,e[2]=e[3]=Number.NEGATIVE_INFINITY;for(let r=0;r<t.length;r++)w(e,e,t[r]);return e}function T(e,t,a){const l=r(e);return t.xmin=i(l,a.xmin),t.ymin=s(l,a.ymin),t.xmax=i(l,a.xmax),t.ymax=s(l,a.ymax),a.hasZ&&(t.zmin=n(l,a.zmin),t.zmax=n(l,a.zmax)),a.hasM&&(t.mmin=o(l,a.mmin),t.mmax=o(l,a.mmax)),t.hasZ=a.hasZ??!1,t.hasM=a.hasM??!1,t}function C(e,t,i){const s=r(e);return t.points=a(i.hasZ,i.hasM)(s,i.points)??[],t.hasZ=i.hasZ??!1,t.hasM=i.hasM??!1,t}function P(e,t,a){const l=r(e);return t.x=i(l,a.x),t.y=s(l,a.y),null!=a.z&&(t.z=n(l,a.z)),null!=a.m&&(t.m=o(l,a.m)),t}function M(e,t,i){const s=function(e,t,r,i){const s=[],n=a(r,i);for(let r=0;r<t.length;r++){const i=n(e,t[r]);i&&i.length>=3&&s.push(i)}return s.length?s:null}(r(e),i.rings,i.hasZ,i.hasM);return s?(t.rings=s,t.hasZ=i.hasZ??!1,t.hasM=i.hasM??!1,t):null}function R(e,t,i){const s=function(e,t,r,i){const s=[],n=a(r,i);for(let r=0;r<t.length;r++){const i=n(e,t[r]);i&&i.length>=2&&s.push(i)}return s.length?s:null}(r(e),i.paths,i.hasZ,i.hasM);return s?(t.paths=s,t.hasZ=i.hasZ??!1,t.hasM=i.hasM??!1,t):null}e.getQuantizedBoundsCoordsArray=w,e.getQuantizedBoundsCoordsArrayArray=x,e.getQuantizedBoundsPaths=function(e){return x([0,0,0,0],e)},e.getQuantizedBoundsPoints=function(e){const t=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];return w(t,t,e)},e.getQuantizedBoundsRings=function(e){return x([0,0,0,0],e)},e.normalizeTransform=r,e.quantizeBounds=function(e,t,n){const o=r(e);return t[0]=i(o,n[0]),t[3]=s(o,n[1]),t[2]=i(o,n[2]),t[1]=s(o,n[3]),t},e.quantizeCoordsArrayXY=l,e.quantizeCoordsArrayXYM=u,e.quantizeCoordsArrayXYZ=c,e.quantizeCoordsArrayXYZM=d,e.quantizeExtent=T,e.quantizeGeometry=function(e,r){return e&&r?t.isPoint(r)?P(e,{},r):t.isPolyline(r)?R(e,{},r):t.isPolygon(r)?M(e,{},r):t.isMultipoint(r)?C(e,{},r):t.isExtent(r)?T(e,{},r):null:null},e.quantizeM=o,e.quantizeMultipoint=C,e.quantizePoint=P,e.quantizePolygon=M,e.quantizePolyline=R,e.quantizeX=i,e.quantizeY=s,e.quantizeZ=n,e.toQuantizationTransform=function(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance,1,1]:[1,1,1,1],translate:null!=e.extent?[e.extent.xmin,e.extent.ymax,e.extent.zmin??0,e.extent.mmin??0]:[0,0,0,0]}:null},e.unquantizeBounds=function(e,t,i){const s=r(e);return i?(t[0]=h(s,i[0]),t[1]=p(s,i[3]),t[2]=h(s,i[2]),t[3]=p(s,i[1]),t):[h(s,t[0]),p(s,t[3]),h(s,t[2]),p(s,t[1])]},e.unquantizeCoordsArrayArray=S,e.unquantizeCoordsArrayXY=y,e.unquantizeCoordsArrayXYM=b,e.unquantizeCoordsArrayXYZ=_,e.unquantizeCoordsArrayXYZM=v,e.unquantizeExtent=function(e,t,i,s=i.hasZ??!1,n=i.hasM??!1){const o=r(e);return t.xmin=h(o,i.xmin),t.xmax=h(o,i.xmax),t.ymin=p(o,i.ymin),t.ymax=p(o,i.ymax),s&&(t.zmin=m(o,i.zmin),t.zmax=m(o,i.zmax)),n&&(t.mmin=f(o,i.mmin),t.mmax=f(o,i.mmax)),t.hasZ=s,t.hasM=n,t},e.unquantizeM=f,e.unquantizeMultipoint=function(e,t,i,s=i?.hasZ??!1,n=i?.hasM??!1){if(null!=i){const o=r(e);t.points=g(s,n)(o,i.points),t.hasZ=s,t.hasM=n}return t},e.unquantizePoint=function(e,t,i,s=null!=i?.z,n=null!=i?.m){if(null==i)return t;const o=r(e);return t.x=h(o,i.x),t.y=p(o,i.y),s&&(t.z=m(o,i.z)),n&&(t.m=f(o,i.m)),t},e.unquantizePolygon=function(e,t,i,s=i?.hasZ??!1,n=i?.hasM??!1){if(null!=i){const o=r(e);t.rings=S(o,g(s,n),i.rings),t.hasZ=s,t.hasM=n}return t},e.unquantizePolyline=function(e,t,i,s=i?.hasZ??!1,n=i?.hasM??!1){if(null!=i){const o=r(e);t.paths=S(o,g(s,n),i.paths),t.hasZ=s,t.hasM=n}return t},e.unquantizeX=h,e.unquantizeY=p,e.unquantizeZ=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/layers/graphics/densificationConstants":function(){define(["exports","../../../../core/has"],(function(e,t){"use strict";e.getApproximateMaxDensificationSegments=function(){return t("curve-densification-max-segments")},e.getCoarseSegmentsPerCurve=function(){return t("curve-densification-coarse-segments")},e.getMaxDeviationInPixels=function(){return t("curve-densification-pixel-deviation")},e.getMinSegmentsPerCurve=function(){return t("curve-densification-min-segments")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/dehydratedFeatureComparison":function(){define(["exports","../../core/has","../../core/mathUtils","../../geometry/support/spatialReferenceUtils"],(function(e,t,r,i){"use strict";function s(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++){const i=e[r],s=t[r];if(i.length!==s.length)return!1;for(let e=0;e<i.length;e++)if(i[e]!==s[e])return!1}return!0}function n(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!s(e[r],t[r]))return!1;return!0}function o(e,t){return e===t||null!=e&&null!=t&&i.equals(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}e.equals=function(e,t){return e===t||null!=e&&null!=t&&e.objectId===t.objectId&&!!function(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.type!==t.type)return!1;switch(e.type){case"point":return o(e,t);case"extent":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!i.equals(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}(e,t);case"polyline":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!i.equals(e.spatialReference,t.spatialReference)&&n(e.paths,t.paths)}(e,t);case"polygon":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!i.equals(e.spatialReference,t.spatialReference)&&n(e.rings,t.rings)}(e,t);case"multipoint":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!i.equals(e.spatialReference,t.spatialReference)&&s(e.points,t.points)}(e,t);case"mesh":return!1;default:return}}(e.geometry,t.geometry)&&!!function(e,t){if(e===t)return!0;if(!e||!t)return!1;const r=Object.keys(e),i=Object.keys(t);if(r.length!==i.length)return!1;for(const i of r)if(e[i]!==t[i])return!1;return!0}(e.attributes,t.attributes)},e.pointEquals=o,e.pointNear=function(e,t,s){return e===t||null!=e&&null!=t&&i.equals(e.spatialReference,t.spatialReference)&&r.floatEqualAbsolute(e.x,t.x,s)&&r.floatEqualAbsolute(e.y,t.y,s)&&r.floatEqualAbsolute(e.z??0,t.z??0,s)&&r.floatEqualAbsolute(e.m??0,t.m??0,s)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DSymbolCreationContext":function(){define(["exports","../../../ViewingMode"],(function(e,t){"use strict";e.Graphics3DSymbolCreationContext=class{constructor(e,t,r,i){this.scheduler=e,this.schedule=t,this.layerViewUid=r,this.compressionTracker=i,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===t.ViewingMode.Global}},e.Graphics3DSymbolLayerCreationContext=class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/symbolMemory":function(){define(["exports"],(function(e){"use strict";e.getSymbolMemorySize=function(e){return 2216+4096*e.symbolLayers.length+e.complexity.memory.resourceBytes},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DWebStyleSymbol":function(){define(["exports","./defaultSymbolComplexity","./interfaces","./Loadable","./symbolMemory"],(function(e,t,r,i,s){"use strict";class n extends i.Loadable{constructor(e,t,r){super(t),this.symbol=e,this._convert=r,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),null!=this.graphics3DSymbol&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:t.emptySymbolComplexity}globalPropertyChanged(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(e,t):r.ApplyRendererDiffResult.RecreateSymbol}prepareSymbolPatch(e){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(e,t)}updateTransform(e,t,r,i){return this.graphics3DSymbol?.updateTransform(e,t,r,i)??!1}onRemoveGraphic(){}updateFocus(){}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??r.FastUpdateStatus.Loading}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}get cachedMemory(){return s.getSymbolMemorySize(this)}}e.Graphics3DWebStyleSymbol=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/LabelInfo":function(){define(["exports","../../../../core/has","../../../../core/Logger","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","./constants","./graphicSymbolUtils","./LabelParameters","../../webgl-engine/lib/TextRenderer","../../webgl-engine/materials/HUDMaterial"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=()=>r.getLogger("esri.views.3d.layers.graphics.labelPlacement");function h(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function p(e,t,r){const n=null!=r?r.getBoundingBoxObjectSpace(y):y,o=s.fromValues(n[3]-n[0],n[4]-n[1],n[5]-n[2]),a=Math.sqrt(o[0]*o[0]+o[1]*o[1]);e.centerOffset[0]=a/2*t.normalizedOffset[0];const l=e.translation[2],c=o[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=l+c;const u=i.length(o);e.centerOffset[2]=u/2*t.normalizedOffset[2]}const m={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},f={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in f){const t=f[e],r=m[e];t.forEach((e=>{m[e]=r}))}Object.freeze&&(Object.freeze(m),Object.keys(m).forEach((e=>{Object.freeze(m[e]),Object.freeze(m[e]?.normalizedOffset)})));const g=[0,0],y=n.create();e.LabelInfo=class{constructor(e,t,r,i=null){this._graphic=e,this._symbol=t,this._class=r,this._disablePlacement=i}get placement(){const e=this._verticalOffsetPlacement;if(null==e)return null;const t=this._getPlacementInfo(e);if(null==t)return null;const r=t.anchor,i=!!e.hasLabelVerticalOffset,s=e.verticalOffset,n=new l.LabelPlacement(s,r,i);return this._calculatePlacementOffsets(n,t)}get _verticalOffsetPlacement(){const e=this._class.labelPlacement,{_symbol:t,_graphic:r}=this,i=a.getGraphics3DSymbol(r.graphics3DSymbol),s="point-3d"===i?.symbol.type?i.symbol:null,n=m[e]||this._defaultPlacementInfo;return s?.supportsCallout()&&s.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:s.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t?.hasVisibleVerticalOffset()||null!=s&&s.supportsCallout()&&s.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:n&&"above-center"===n.placement?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(d().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}_getPlacementInfo(e){if(e.anchor)return e;const t=this._class.labelPlacement,r=m[t],i=r||this._defaultPlacementInfo;return t&&!r&&d().warnOnce(`the requested label placement '${t}' is currently unsupported in SceneView.`),this._validatePlacementInfo(i)}_calculatePlacementOffsets(e,t){const r=this._graphic.graphic.geometry;if(null==r)return null;switch(r.type){case"point":this._setPointSpecificPlacement(e,t);break;case"mesh":this._setMeshSpecificPlacement(e,t);break;case"polygon":this._setPolygonSpecificPlacement(e,t)}const i=o.labelMarginPx-c.textVerticalPaddingPx;return e.screenOffset[0]+=i*t.normalizedOffset[0],e.screenOffset[1]+=i*t.normalizedOffset[1],e}get _defaultPlacementInfo(){const e=this._graphic.graphic.geometry;if(null==e)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:s.ZEROS,anchor:"center"};case"polygon":{const e=this._firstSymbolLayer;return"extrude"===e?.type?m["above-center"]:{placement:"center-center",normalizedOffset:s.ZEROS,anchor:"center"}}case"point":case"mesh":return m["above-center"];default:return}}_validatePlacementInfo(e){const t=this._graphic.graphic.geometry;if(null==t)return null;if(null!=this._disablePlacement){const t=this._class.labelPlacement;return t?(d().warnOncePerTick(h(t,this._disablePlacement.logEntityDescription)),this._defaultPlacementInfo):e}const r=t.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":{const e=this._class.labelPlacement;if(e)return m[e]&&d().warnOnce(h(e,`'${r}' geometries`)),this._defaultPlacementInfo;break}case"point":case"mesh":return e}return e}_setPointSpecificPlacement(e,t){const r=this._firstSymbolLayer;if(null==r)return;const s=this._graphic.layers[0];switch(null!=s?s.getCenterObjectSpace(e.translation):i.set(e.translation,0,0,0),r.type){case"icon":case"text":this._setHUDSpecificPlacement(e,t,s);break;case"object":p(e,t,s)}}_setMeshSpecificPlacement(e,t){const r=this._firstSymbolLayer;null!=r&&"fill"===r.type&&p(e,t,this._graphic.layers[0])}_setPolygonSpecificPlacement(e,t){const r=this._firstSymbolLayer;if(null!=r)switch(r.type){case"extrude":{const r=this._graphic.layers[0];null!=r?(r.getBoundingBoxObjectSpace(y),n.center(y,e.translation),e.translation[2]=n.height(y)/2):i.set(e.translation,0,0,0),p(e,t,r);break}}}_setHUDSpecificPlacement(e,t,r){const{_graphic:i}=this,s=null!=r?r.getScreenSize():null;if(i.isDraped||null==s)e.hasLabelVerticalOffset||"center"===e.anchor||(m[this._class.labelPlacement]&&d().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const r=this._normalizedSymbolAnchorPos;e.screenOffset[0]=s[0]/2*(t.normalizedOffset[0]-r[0]);const i=s[1]/2*(t.normalizedOffset[1]-r[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=i,e.centerOffsetUnits="screen"):e.screenOffset[1]=i}}get _firstSymbolLayer(){const e=this._graphic.graphics3DSymbol,t=a.getGraphics3DSymbol(e);return null!=t?t.symbol.symbolLayers.at(0):null}get _normalizedSymbolAnchorPos(){const e=this._graphic.layers[0],t=e?.stageObject.geometries[0].material??null;if(t&&t instanceof u.HUDMaterial){const e=t.parameters.anchorPosition;g[0]=2*(e[0]-.5),g[1]=2*(e[1]-.5)}else g[0]=0,g[1]=0;return g}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/constants":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec4f64"],(function(e,t){"use strict";const r=t.ZEROS;e.labelMarginPx=4,e.suspendResumeExtentOptimism=1.2,e.transparentUnit=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/LabelParameters":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64"],(function(e,t,r,i){"use strict";e.LabelParameters=class{constructor(e,r="center",i="center",s=null,n=t.create(),o=!0){this.placement=e,this.horizontalPlacement=r,this.verticalPlacement=i,this.text=s,this.displaySize=n,this.isFocused=o}},e.LabelPlacement=class{constructor(e,s="center",n=!1,o=t.create(),a=i.fromValues(0,0,0,-1),l="world",c=r.create(),u=0){this.verticalOffset=e,this.anchor=s,this.hasLabelVerticalOffset=n,this.screenOffset=o,this.centerOffset=a,this.centerOffsetUnits=l,this.translation=c,this.elevationOffset=u}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextRenderer":function(){define(["exports","../../../../core/mathUtils","../../support/debugFlags","./FontMetrics","./TextHelperCanvas"],(function(e,t,r,i,s){"use strict";const n=[];{const e=16;for(let t=0;t<360;t+=360/e)n.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var o;e.TextRenderAlignment=void 0,(o=e.TextRenderAlignment||(e.TextRenderAlignment={}))[o.Left=0]="Left",o[o.Center=1]="Center",o[o.Right=2]="Right";const a={canvas:null},l=512,c="rgb(255, 0, 255, 0.5)";class u{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(e,t,r,i,s){this.firstLineAscent=e,this.lastLineDescent=t,this.maxLineAscent=r,this.maxLineDescent=i,this.displayWidth=s}}e.TextRenderer=class{constructor(e,t,r,i){this.text=e,this._alignment=t,this._parameters=r,this._maxSize=i,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${e}--${this._parameters.key}-${this._alignment}`,this._lines=e.replaceAll(" "," ").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let e=this._metrics.firstLineAscent;for(let t=0;t<this._lines.length-1;t++)e+=this._lineSpacing;return e+=this._metrics.lastLineDescent,Math.ceil(e+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const e=s.getTextHelperCanvas(a,l,l).getContext("2d"),t=this._parameters.definition.pixelRatio,r=this._fontSize*t;this._parameters.setFontProperties(e,r);let n=2*this._haloSize;const o=this._parameters.definition.font;"italic"!==o.style&&"oblique"!==o.style&&"bold"!==o.weight&&"bolder"!==o.weight||(n+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let c=0,d=0,h=0,p=0,m=0;this._lines.forEach(((r,i)=>{const s=e.measureText(r),o=s.width/t,a=o+n;this._textWidths.push(o),this._lineWidths.push(a),c=Math.max(c,a),p=Math.max(p,s.actualBoundingBoxAscent/t),m=Math.max(m,s.actualBoundingBoxDescent/t),0===i&&(d=s.actualBoundingBoxAscent/t),i===this._lines.length-1&&(h=s.actualBoundingBoxDescent/t)}));const f=i.getFontMetrics(this._parameters),g=Math.max(p,f.maxAscent),y=Math.max(m,f.maxDescent),_=d,b="underline"===this._parameters.definition.font.decoration?y:h,v=c;this._metricsCached=new u(_,b,g,y,v)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return.2*this._midLineHeight}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,1)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const e=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(e,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case e.TextRenderAlignment.Left:return this._horizontalPadding;case e.TextRenderAlignment.Center:return(this.displayWidth-this._lineWidths[t])/2;case e.TextRenderAlignment.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[t]}}render(e,t,i){e.save();const s=t/=this.renderPixelRatio,n=i/=this.renderPixelRatio,o=this._haloSize,a=this._firstLineYOffset+this._metrics.firstLineAscent;t+=o,i+=a;const l=this._haloSize>0;l&&this._renderHalo(e,s,n,o,a),this._parameters.setFontProperties(e,this._renderedFontSize);for(let r=0;r<this._lines.length;++r){const s=this._lines[r],n=this._getLineXOffset(r);l&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,s,t+n,i),this._renderLineDecoration(e,t+n,i,this._textWidths[r])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,s,t+this._getLineXOffset(r),i),this._renderLineDecoration(e,t+n,i,this._textWidths[r]),i+=this._lineSpacing}if(r.debugFlags.TEXT_SHOW_BASELINE){e.strokeStyle=c,e.setLineDash([2,2]),e.lineWidth=1;let t=n+a;for(let r=0;r<this._lines.length;++r)this._drawLine(e,[s,t],[s+this.displayWidth,t]),t+=this._lineSpacing}if(r.debugFlags.TEXT_SHOW_BORDER&&(e.strokeStyle=c,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[s,n],[this.displayWidth,this.displayHeight])),this._hasBackground){const t=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,s,n,t),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,r,i,s=!1){if("none"===this._parameters.definition.font.decoration||0===i)return;const n=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":r+=2*n;break;case"line-through":r-=.33*this._midLineAscent}const o=s?this._haloSize:0;e.strokeStyle=s?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(n+2*o),e.beginPath(),e.moveTo(this._toRenderUnit(t-o),this._toRenderUnit(r)),e.lineTo(this._toRenderUnit(t+i+o),this._toRenderUnit(r)),e.stroke()}_roundedRect(e,r,i,s){r=this._toRenderUnit(r),i=this._toRenderUnit(i);const n=this.renderedWidth,o=this.renderedHeight;0!==s?(s=t.clamp(s,0,Math.floor(o/2)),e.beginPath(),e.moveTo(r,i+s),e.arcTo(r,i,r+s,i,s),e.lineTo(r+n-s,i),e.arcTo(r+n,i,r+n,i+s,s),e.lineTo(r+n,i+o-s),e.arcTo(r+n,i+o,r+n-s,i+o,s),e.lineTo(r+s,i+o),e.arcTo(r,i+o,r,i+o-s,s),e.closePath()):e.rect(r,i,n,o)}_renderHalo(e,t,r,i,n){const o=this.renderedWidth,c=this.renderedHeight,u=s.getTextHelperCanvas(a,Math.max(o,l),Math.max(c,l)),d=u.getContext("2d");d.clearRect(0,0,o,c),this._parameters.setFontProperties(d,this._renderedFontSize),d.fillStyle=this._parameters.haloStyle,d.strokeStyle=this._parameters.haloStyle;const h=this._renderedHaloSize<3;d.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(d,i,n):this._renderHaloNative(d,i,n);let p=n;for(let e=0;e<this._lines.length;++e){const t=this._getLineXOffset(e);this._renderLineDecoration(d,i+t,p,this._textWidths[e],!0),p+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(u,0,0,o,c,this._toRenderUnit(t),this._toRenderUnit(r),o,c),e.globalAlpha=1}_renderHaloEmulated(e,t,r){for(let i=0;i<this._lines.length;++i){const s=this._lines[i],o=this._getLineXOffset(i);for(const[i,a]of n)this._fillText(e,s,t+o+this._haloSize*i,r+this._haloSize*a);r+=this._lineSpacing}}_renderHaloNative(e,t,r){const i=2*this._haloSize;for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s),a=5,l=.1;for(let s=0;s<a;s++){const c=1-(a-1)*l+s*l;e.lineWidth=this._toRenderUnit(c*i),this._strokeText(e,n,t+o,r)}r+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,r,i){e.fillText(t,this._toRenderUnit(r),this._toRenderUnit(i))}_strokeText(e,t,r,i){e.strokeText(t,this._toRenderUnit(r),this._toRenderUnit(i))}_drawLine(e,t,r){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),e.stroke()}_drawBox(e,t,r){const i=this._toRenderUnit(t[0]),s=this._toRenderUnit(t[1]),n=this._toRenderUnit(r[0]),o=this._toRenderUnit(r[1]),a=Math.floor(i)+.5,l=Math.ceil(i+n)-.5,c=Math.floor(s)+.5,u=Math.ceil(s+o)-.5;e.beginPath(),e.moveTo(a,c),e.lineTo(l,c),e.lineTo(l,u),e.lineTo(a,u),e.lineTo(a,c),e.stroke()}},e.textVerticalPaddingPx=1,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/FontMetrics":function(){define(["exports","./TextHelperCanvas"],(function(e,t){"use strict";const r=new Map;class i{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(e,t){this.maxAscent=e,this.maxDescent=t}}const s={canvas:null},n=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})();e.getFontMetrics=function(e){const{size:o}=e.definition,a=e.fontString(o);let l=r.get(a);if(!l){const c=t.getTextHelperCanvas(s,0,0).getContext("2d");e.setFontProperties(c,o);const u=c.measureText(n);l=new i(u.actualBoundingBoxAscent,u.actualBoundingBoxDescent),r.set(a,l)}return l},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextHelperCanvas":function(){define(["exports"],(function(e){"use strict";e.getTextHelperCanvas=function(e,t,r){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=r,e.canvas},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/placementUtils":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../webgl-engine/lib/TextRenderer"],(function(e,t,r,i){"use strict";const s=Object.freeze({left:0,center:.5,right:1}),n=Object.freeze({"bottom-left":r.fromValues(0,0),bottom:r.fromValues(.5,0),"bottom-right":r.fromValues(1,0),left:r.fromValues(0,.5),center:r.fromValues(.5,.5),right:r.fromValues(1,.5),"top-left":r.fromValues(0,1),top:r.fromValues(.5,1),"top-right":r.fromValues(1,1)});e.anchorFromPlacements=function(e,t){switch(t){case"bottom":return"left"===e?"bottom-left":"right"===e?"bottom-right":"bottom";case"center":return e;case"top":return"left"===e?"top-left":"right"===e?"top-right":"top"}},e.horizontalPlacementFromAnchor=function(e){switch(e){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}},e.horizontalPlacementToAnchorX=s,e.namedAnchorToHUDMaterialAnchorPos=n,e.textRenderAlignmentFromHorizontalPlacement=function(e){switch(e){case"left":return i.TextRenderAlignment.Left;case"right":return i.TextRenderAlignment.Right;default:return i.TextRenderAlignment.Center}},e.verticalPlacementFromAlignment=function(e){return"middle"===e?"center":e},e.verticalPlacementFromAnchor=function(e){switch(e){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}},e.verticalScreenOffsetFromAlignment=function(e,s){switch(e){case"top":return t.set(s,0,i.textVerticalPaddingPx);case"bottom":return t.set(s,0,-1);default:return t.copy(s,r.ZEROS)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextRenderParameters":function(){define(["exports","../../../../Color","../../../../core/fontUtils","../../../../core/Logger","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/factories/vec4f64"],(function(e,t,r,i,s,n){"use strict";class o{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=a(e.color),this.haloStyle=`rgb(${e.halo.color.slice(0,3).map((e=>Math.floor(255*e))).toString()})`,this.backgroundStyle=0!==e.background.color[3]?a(e.background.color):null}fontString(e){const t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}static async fromSymbol(e,a){const c=e?.material?.color,u=t.toUnitRGBA(c)??n.ZEROS,d=null!=e.size?s.pt2px(e.size):12,h=e.lineHeight,p=null!=e.background?t.toUnitRGBA(e.background.color):n.ZEROS,m={family:e.font?.family??"sans-serif",decoration:e.font?.decoration??"none",weight:e.font?.weight??"normal",style:e.font?.style??"normal"},f=e.halo,g=null!=f?.color&&f.size>0?{size:s.pt2px(f.size),color:t.toUnitRGBA(f.color)}:{size:0,color:n.ZEROS},y=new o({color:u,size:d,background:{color:p,padding:null!=e.background?[.65*d,.5*d]:[0,0],borderRadius:null!=e.background?d*(6/16):0},lineSpacingFactor:h,font:m,halo:g,pixelRatio:a});if(e.font){let t=!1;const s=y.fontString(d);try{t=(await document.fonts.load(s)).some((e=>!r.isCachedFontFace(e)))}catch(e){i.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${s}'. Some text symbology may be rendered using the default browser font.`)}if(!t&&!l.has(e.font.family))try{await r.loadFont(e.font)}catch(e){}}return y}}function a(e){return`rgba(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()},${e[3]})`}const l=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]);e.TextRenderParameters=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/fontUtils":function(){define(["exports","../config"],(function(e,t){"use strict";const r="arial-unicode-ms",i="woff2",s=new Map,n=new Set;class o{constructor(e,t){this.fontFace=e,this.promise=t}}function a(e){if(!e)return r;const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function l(e){const t=c(e)+u(e);return a(e.family)+(t.length>0?t:"-regular")}function c(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function u(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}e.clearFonts=function(){const e=document.fonts;s.forEach((t=>{e.delete(t.fontFace)})),s.clear(),n.clear()},e.defaultFontFamily=r,e.getFontFamily=a,e.getFullyQualifiedFontName=l,e.isCachedFontFace=function(e){return n.has(e)},e.loadFont=async function(e){const a=function(e){const t=c(e)+u(e);return(e.family||r)+(t.length>0?t:"-regular")}(e),d=l(e),h=s.get(a);if(h)return h.promise;const p=new FontFace(e.family,`url('${t.fontsUrl}/woff2/${d}.${i}') format('${i}')`,{style:e.style,weight:e.weight}),m=document.fonts;if(m.has(p)&&"loading"===p.status)return p.loaded;const f=p.load().then((()=>(m.add(p),p)));return s.set(a,new o(p,f)),n.add(p),f},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextTextureAtlas":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/has","../../../../core/maybe","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","./testUtils","./textureUtils","../../../support/Scheduler","../../../support/Yield","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";const v=4096;e.TextTextureAtlas=class extends r{constructor(e){super(e),this.id=o.generateUID(),this.events=new i,this._glTexture=null,this._atlas=new T(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=n.disposeMaybe(this._glTexture),this._frameWorker=n.removeMaybe(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get loaded(){return null!=this._glTexture}get glTexture(){return this._glTexture}static get maxSize(){return P=p.textTextureAtlas.stableRendering?S:0,[v-S-P,v-S-P-w]}load(e){if(this._glTexture)return this._glTexture;const t=new b.TextureDescriptor;return t.wrapMode=y.TextureWrapMode.CLAMP_TO_EDGE,t.samplingMode=y.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new _.Texture(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(f.TaskPriority.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=n.removeMaybe(this._frameWorker),this._glTexture&&(this._stage.removeTexture(this),this._glTexture=n.disposeMaybe(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){const{width:r,height:i}=this._atlas;r===e&&i===t||(this._atlas.width=e,this._atlas.height=t,this._glTexture?.resize(e,t),this._glTexture?.updateData(0,0,0,r,i,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach((e=>this._uvCallbacks.get(e.textRenderer.key)?.forEach((t=>t(e.uv))))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,r,i){const s=this._atlas;if(s.width<r||s.height<i)return!1;let n=s.cursors.get(i);if(!n){if(s.height<s.nextY+i)return!1;n=[new C(s.nextY)],s.cursors.set(i,n),s.nextY+=i}let o=n.find((e=>s.width>=e.x+r));if(null==o){if(s.height<s.nextY+i)return!1;o=new C(s.nextY),s.nextY+=i,n.push(o)}return e.setNewPosition(o),this._elements.set(t,e),this._elementsToRender.set(t,e),o.x+=r,!0}_ensureCallbacks(e){const t=this._uvCallbacks.get(e);if(t)return t;const r=new Set;return this._uvCallbacks.set(e,r),r}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){const r=this._uvCallbacks.get(e);return!(!r?.delete(t)||0!==r.size||(this._uvCallbacks.delete(e),0))}_processAddition(e){const t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);const r=this._atlas,i=e.textRenderer.renderedWidth,s=e.textRenderer.renderedHeight,n=i+S,o=s+S+w;if(!this._addAtlasElement(e,t,n,o)){if(this._canRepack)this._reset();else if(r.width<n){const e=m.applyTextureResizeModuloCeil(Math.max(n,1.5*r.width),v);this._resizeAtlas(e,r.height)}else{const e=r.nextY+o,t=m.applyTextureResizeModuloCeil(Math.max(e,1.5*r.height),v);if(t>r.height)this._resizeAtlas(r.width,t);else if(r.width<v){const e=m.applyTextureResizeModuloCeil(1.5*r.width,v);this._resizeAtlas(e,r.height)}}this._elements.set(t,e)}}_renderElement(e){const t=e.commitNewPosition(),r=e.textRenderer;this._ctx.clearRect(t[0]-S,t[1]-S,r.renderedWidth+2*S,r.renderedHeight+2*S),r.render(this._ctx,t[0],t[1]),this._uvCallbacks.get(r.key)?.forEach((t=>t(e.uv)))}get running(){return this.updating}runTask(e){if(null==this._glTexture)return g.Yield;for(;this._needsRepack&&(this._canRepack||this._atlas.height<v&&this._atlas.height<v);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach((e=>this._processAddition(e))),e.madeProgress()}if(this._elementsToRender.size>0){for(const[t,r]of this._elementsToRender){if(e.done)break;this._renderElement(r),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){const r=e.key;this._addCallback(r,t);let i=this._elements.get(r);return i?d.exactEquals(i.uv,h.ZEROS)||t(i.uv):(i=new x(e),this._processAddition(i),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){const r=e.key;this._elements.get(r)&&this._removeCallback(r,t)&&(this._elements.delete(r),this._elementsToRender.delete(r),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}},t.__decorate([a.property({constructOnly:!0})],e.TextTextureAtlas.prototype,"view",void 0),t.__decorate([a.property({type:Boolean})],e.TextTextureAtlas.prototype,"updating",void 0),e.TextTextureAtlas=t.__decorate([u.subclass("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],e.TextTextureAtlas);const S=2,w=2;class x{constructor(e){this.textRenderer=e,this._uv=h.create(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return h.ZEROS;const{renderedWidth:e,renderedHeight:t}=this.textRenderer;return d.set(this._uv,this._xOffset,this._yOffset+t,this._xOffset+e,this._yOffset)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class T{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=P}}class C{constructor(e){this.y=e,this.x=P}}let P=0;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/testUtils":function(){define(["exports"],(function(e){"use strict";e.gridLocalOriginFactory={rootOrigin:null},e.textTextureAtlas={stableRendering:!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/textureUtils":function(){define(["exports","../../../../core/Error"],(function(e,t){"use strict";const r=16;function i(e,t){return t=Math.floor(t/r)*r,Math.min(Math.round(e/r)*r,t)}function s({width:e,height:t},{maxPreferredTexturePixels:r,maxTextureSize:s}){const n=Math.max(e,t),o=e*t;if(n<=s&&o<=r)return[e,t];const a=Math.min(Math.sqrt(r/o),s/n);return[i(Math.round(e*a),s),i(Math.round(t*a),s)]}function n(e,r,i){if(e instanceof ImageData)return n(function(e){const r=document.createElement("canvas");r.width=e.width,r.height=e.height;const i=r.getContext("2d");if(null==i)throw new t("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return i.putImageData(e,0,0),r}(e),r,i);const s=document.createElement("canvas");return s.width=r,s.height=i,s.getContext("2d").drawImage(e,0,0,s.width,s.height),s}e.applyTextureResizeModulo=i,e.applyTextureResizeModuloCeil=function(e,t){return t=Math.floor(t/r)*r,Math.min(Math.ceil(e/r)*r,t)},e.ensureImageMaxSize=function(e,t){const[r,i]=s(e,t);return e.width===r&&e.height===i?e:n(e,r,i)},e.ensureTextureSize=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/WebGLLayer":function(){define(["exports","../../../../core/arrayUtils","../../../../core/compilerUtils","../../../../core/Evented","../../../../core/Handles","../../../../core/has","../../../../core/maybe","../../../../core/uid","./DirtyEvents","./Octree","./UpdatePolicy"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.WebGLLayer=class{constructor(e,t,r=""){this.stage=e,this.apiLayerViewUid=r,this.id=a.generateUID(),this.events=new i,this.visible=!0,this.sliceable=!1,this._objectsAdded=new Array,this._handles=new s,this._objects=new Map,this._pickable=!0,this.visible=t?.visible??!0,this._pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??u.UpdatePolicy.ASYNC,e.addLayer(this);for(const t of l.DirtyEventNames)this._handles.add(this.events.on(t,(r=>e.handleEvent(t,r))))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.removeLayer(this),this.invalidateSpatialQueryAccelerator())}get objects(){return this._objects}getObject(e){return r.toConst(this._objects.get(e))}set pickable(e){this._pickable=e}get pickable(){return this._pickable&&this.visible}add(e){this._objects.set(e.id,e),e.layer=this,this.events.emit("layerObjectAdded",e),null!=this._octree&&this._objectsAdded.push(e)}remove(e){this._objects.delete(e.id)&&(this.events.emit("layerObjectRemoved",e),e.layer=null,null!=this._octree&&(t.removeUnordered(this._objectsAdded,e)||this._octree.remove([e])))}addMany(e){for(const t of e)this._objects.set(t.id,t),t.layer=this;this.events.emit("layerObjectsAdded",e),null!=this._octree&&this._objectsAdded.push(...e)}removeMany(e){const r=new Array;for(const t of e)this._objects.delete(t.id)&&r.push(t);if(0!==r.length&&(this.events.emit("layerObjectsRemoved",r),r.forEach((e=>e.layer=null)),null!=this._octree)){for(let e=0;e<r.length;)t.removeUnordered(this._objectsAdded,r[e])?(r[e]=r[r.length-1],r.length-=1):++e;this._octree.remove(r)}}sync(){this.updatePolicy!==u.UpdatePolicy.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){null==this._octree||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return null==this._octree&&this._objects.size>50?(this._octree=new c((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.values())):null!=this._octree&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded),this._objectsAdded.length=0),this._octree}invalidateSpatialQueryAccelerator(){this._octree=o.destroyMaybe(this._octree),this._objectsAdded.length=0}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/DirtyEvents":function(){define(["exports"],(function(e){"use strict";e.DirtyEventNames=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"],Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Octree":function(){define(["../../../../core/ObjectPool","../../../../core/PooledArray","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/frustum","../../../../geometry/support/ray","../../../../chunks/sphere","./Util"],(function(e,t,r,i,s,n,o,a){"use strict";class l{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new c,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),c.clearPool(),x[0]=null,R.prune(),F.prune()}add(e){const t=Array.from(e);this._grow(t);const r=c.acquire();for(const e of t)++this._objectCount,this._isDegenerate(e)?this._degenerateObjects.add(e):(r.init(this._root),this._add(e,r));c.release(r)}remove(e,t=null){this._objectCount-=e.length;const r=c.acquire();for(const i of e){const e=t??o.copy(this.objectToBoundingSphere(i),E);b(e[3])?(r.init(this._root),h(i,e,r)):this._degenerateObjects.delete(i)}c.release(r),this._shrink()}update(e,t){if(!b(t[3])&&this._isDegenerate(e))return;const r=function(e){return x[0]=e,x}(e);this.remove(r,t),this.add(r)}forEachAlongRay(e,t,r){const i=n.wrap(e,t);u(this._root,(e=>{if(!function(e,t){return f(o.getCenter(t.bounds),2*-t.halfSize,P),f(o.getCenter(t.bounds),2*t.halfSize,M),a.rayBoxTest(e.origin,e.direction,P,M)}(i,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,r,i){const s=n.wrap(e,t);u(this._root,(e=>{if(!function(e,t,r){return f(o.getCenter(t.bounds),2*-t.halfSize,P),f(o.getCenter(t.bounds),2*t.halfSize,M),r.applyToMinMax(P,M),a.rayBoxTest(e.origin,e.direction,P,M)}(s,e,i))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(s,e,i)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(s,e,i)&&r(e)})),!0}))}forEach(e){u(this._root,(t=>{const r=t.node;return r.terminals.forAll(e),null!==r.residents&&r.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,i,n=()=>!0,a=1/0){let l=1/0,c=1/0,u=null;const h=y(e,t),p=r=>{if(--a,!n(r))return;const d=this.objectToBoundingSphere(r);if(!s.intersectsSphere(i,d))return;const h=_(e,t,o.getCenter(d)),p=h-d[3],m=h+d[3];p<l&&(l=p,c=m,u=r)};return d(this._root,(n=>{if(a<=0||!s.intersectsSphere(i,n.bounds))return!1;if(r.scale(C,h,n.halfSize),r.add(C,C,o.getCenter(n.bounds)),_(e,t,C)>c)return!1;const l=n.node;return l.terminals.forAll((e=>p(e))),null!==l.residents&&l.residents.forAll((e=>p(e))),!0}),e,t),u}forEachInDepthRange(e,t,i,n,a,c,u){let h=-1/0,p=1/0;const m={setRange:e=>{i===l.DepthOrder.FRONT_TO_BACK?(h=Math.max(h,e.near),p=Math.min(p,e.far)):(h=Math.max(h,-e.far),p=Math.min(p,-e.near))}};m.setRange(n);const f=_(t,i,e),g=y(t,i),b=y(t,-i),v=e=>{if(!u(e))return;const r=this.objectToBoundingSphere(e),n=o.getCenter(r),l=_(t,i,n)-f,d=l-r[3],g=l+r[3];d>p||g<h||!s.intersectsSphere(c,r)||a(e,m)};d(this._root,(e=>{if(!s.intersectsSphere(c,e.bounds))return!1;if(r.scale(C,g,e.halfSize),r.add(C,C,o.getCenter(e.bounds)),_(t,i,C)-f>p)return!1;if(r.scale(C,b,e.halfSize),r.add(C,C,o.getCenter(e.bounds)),_(t,i,C)-f<h)return!1;const n=e.node;return n.terminals.forAll((e=>v(e))),null!==n.residents&&n.residents.forAll((e=>v(e))),!0}),t,i)}forEachNode(e){u(this._root,(t=>e(t.node,t.bounds,t.halfSize,t.depth)))}forEachNeighbor(e,t){const i=o.getRadius(t),s=o.getCenter(t),n=t=>{const n=this.objectToBoundingSphere(t),a=o.getRadius(n),l=i+a;return!(r.squaredDistance(o.getCenter(n),s)-l*l<=0)||e(t)};let a=!0;const l=e=>{a&&(a=n(e))};u(this._root,(e=>{const t=o.getRadius(e.bounds),n=i+t;if(r.squaredDistance(o.getCenter(e.bounds),s)-n*n>0)return!1;const c=e.node;return c.terminals.forAll(l),a&&null!==c.residents&&c.residents.forAll(l),a})),a&&this.forEachDegenerateObject(l)}_intersectsObject(e,t){const r=this.objectToBoundingSphere(t);return!(r[3]>0)||o.intersectsRay(r,e)}_intersectsObjectWithOffset(e,t,r){const i=this.objectToBoundingSphere(t);return!(i[3]>0)||o.intersectsRay(r.applyToBoundingSphere(i),e)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let r=0;r<t.length;r++){const i=c.acquire().init(e);this._add(t.at(r),i),c.release(i)}}_grow(e){if(g(e,(e=>this.objectToBoundingSphere(e)),O),b(O[3])&&!this._fitsInsideTree(O))if(p(this._root.node))o.copy(O,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const e=this._rootBoundsForRootAsSubNode(O);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(O,e):this._growRootAsSubNode(e),c.release(e)}}_rebuildTree(e,t){r.copy(o.getCenter(A),o.getCenter(t.bounds)),A[3]=t.halfSize,g([e,A],(e=>e),I);const i=c.acquire().init(this._root);this._root.initFrom(null,I,I[3]),this._root.increaseHalfSize(1.25),u(i,(e=>(this.add(e.node.terminals.data),null!==e.node.residents&&this.add(e.node.residents.data),!0))),c.release(i)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return u(this._root,(e=>(r=Math.max(r,e.depth),r+t<=this._maximumDepth))),r+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],r=e;let i=-1/0;const s=this._root.bounds,n=this._root.halfSize;for(let e=0;e<3;e++){const o=s[e]-n-(r[e]-t),a=r[e]+t-(s[e]+n),l=Math.max(0,Math.ceil(o/(2*n))),c=Math.max(0,Math.ceil(a/(2*n)))+1,u=2**Math.ceil(Math.log(l+c)*Math.LOG2E);i=Math.max(i,u),D[e].min=l,D[e].max=c}for(let e=0;e<3;e++){let t=D[e].min,r=D[e].max;const o=(i-(t+r))/2;t+=Math.ceil(o),r+=Math.floor(o);const a=s[e]-n-t*n*2;T[e]=a+(r+t)*n}const o=i*n;return T[3]=o*w,c.acquire().initFrom(null,T,o,0)}_growRootAsSubNode(e){const t=this._root.node;r.copy(o.getCenter(O),o.getCenter(this._root.bounds)),O[3]=this._root.halfSize,this._root.init(e),e.advanceTo(O,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let r=0,i=0;for(;i<t.length&&null==e;)r=i++,e=t[r];for(;i<t.length;)if(t[i++])return-1;return r}_isDegenerate(e){return!b(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,r=this._root.halfSize;return e[3]<=r&&e[0]>=t[0]-r&&e[0]<=t[0]+r&&e[1]>=t[1]-r&&e[1]<=t[1]+r&&e[2]>=t[2]-r&&e[2]<=t[2]+r}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:r}=this,i=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:r,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:i}}}_nodeToJSON(e){const t=e.children.map((e=>e?this._nodeToJSON(e):null)),r=e.residents?.map((e=>this.objectToBoundingSphere(e))),i=e.terminals?.map((e=>this.objectToBoundingSphere(e)));return{children:t,residents:r,terminals:i}}static fromJSON(e){const t=new l((e=>e),{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}}class c{constructor(){this.bounds=o.create(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,r,i=this.depth){return this.node=null!=e?e:c.createEmptyNode(),t&&o.copy(t,this.bounds),this.halfSize=r,this.depth=i,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*w}advance(e){let t=this.node.children[e];t||(t=c.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const r=v[e];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,r=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!r)return t&&t(this,-1),!1;this.node.residents=null}const i=this._childIndex(e);t&&t(this,i),this.advance(i)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new t({shrink:!0}),residents:new t({shrink:!0})}}static{this._pool=new e(c)}static acquire(){return c._pool.acquire()}static release(e){c._pool.release(e)}static clearPool(){c._pool.prune()}}function u(e,t){let r=c.acquire().init(e);const i=[r];for(;0!==i.length;){if(r=i.pop(),t(r)&&!r.isLeaf())for(let e=0;e<r.node.children.length;e++)r.node.children[e]&&i.push(c.acquire().init(r).advance(e));c.release(r)}}function d(e,t,r,i=l.DepthOrder.FRONT_TO_BACK){let s=c.acquire().init(e);const n=[s];for(function(e,t,r){if(!F.length)for(let e=0;e<8;++e)F.push({index:0,distance:0});for(let r=0;r<8;++r){const i=v[r];F.data[r].index=r,F.data[r].distance=_(e,t,i)}F.sort(((e,t)=>e.distance-t.distance));for(let e=0;e<8;++e)r[e]=F.data[e].index}(r,i,L);0!==n.length;){if(s=n.pop(),t(s)&&!s.isLeaf())for(let e=7;e>=0;--e){const t=L[e];s.node.children[t]&&n.push(c.acquire().init(s).advance(t))}c.release(s)}}function h(e,r,i){R.clear();const s=i.advanceTo(r,((e,t)=>{R.push(e.node),R.push(t)}))?i.node.terminals:i.node.residents;if(s.removeUnordered(e),0===s.length)for(let e=R.length-2;e>=0&&(n=R.data[e],(o=R.data[e+1])>=0&&(n.children[o]=null),p(n)&&(null===n.residents&&(n.residents=new t({shrink:!0})),1));e-=2);var n,o}function p(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}function m(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function f(e,t,r){r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t}function g(e,t,i){P[0]=1/0,P[1]=1/0,P[2]=1/0,M[0]=-1/0,M[1]=-1/0,M[2]=-1/0;for(const r of e){const e=t(r);b(e[3])&&(n=e,(s=P)[0]=Math.min(s[0],n[0]-n[3]),s[1]=Math.min(s[1],n[1]-n[3]),s[2]=Math.min(s[2],n[2]-n[3]),m(M,e))}var s,n;r.lerp(o.getCenter(i),P,M,.5),i[3]=Math.max(M[0]-P[0],M[1]-P[1],M[2]-P[2])/2}function y(e,t){let r,i=1/0;for(let s=0;s<8;++s){const n=_(e,t,S[s]);n<i&&(i=n,r=S[s])}return r}function _(e,t,r){return t*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])}function b(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}!function(e){var t;(t=e.DepthOrder||(e.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(l||(l={}));const v=[i.fromValues(-1,-1,-1),i.fromValues(1,-1,-1),i.fromValues(-1,1,-1),i.fromValues(1,1,-1),i.fromValues(-1,-1,1),i.fromValues(1,-1,1),i.fromValues(-1,1,1),i.fromValues(1,1,1)],S=[i.fromValues(-1,-1,-1),i.fromValues(-1,-1,1),i.fromValues(-1,1,-1),i.fromValues(-1,1,1),i.fromValues(1,-1,-1),i.fromValues(1,-1,1),i.fromValues(1,1,-1),i.fromValues(1,1,1)],w=Math.sqrt(3),x=[null],T=o.create(),C=i.create(),P=i.create(),M=i.create(),R=new t,E=o.create(),O=o.create(),A=o.create(),I=o.create(),D=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],F=new t,L=[0,0,0,0,0,0,0,0];return l}))},"esri/views/3d/webgl-engine/lib/UpdatePolicy":function(){define(["exports"],(function(e){"use strict";var t;e.UpdatePolicy=void 0,(t=e.UpdatePolicy||(e.UpdatePolicy={}))[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FeatureTileTree3D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Collection","../../../../core/handleUtils","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/PooledArray","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/aaBoundingRect","./FeatureTileDescriptor","./FeatureTileMeasurements3D","./FeatureTileVisibility3D","../../support/extentUtils","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v){"use strict";function S(e,t){return e.lodLevelDelta-t.lodLevelDelta||e.measures.splitPriority-t.measures.splitPriority||t.measures.distance-e.measures.distance}e.FeatureTileTree3D=class extends r{constructor(e){super(e),this.tiles=new i,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=u.signal(!1),this._pendingTiles=u.signal(null),this._newTiles=new l,this._tests=!1,this._measurements=new y.FeatureTileMeasurements3D(e.renderCoordsHelper,e.tilingSchemeOwner.tilingScheme,this._opaqueGround)}initialize(){const e=()=>this._setDirty();this.addHandles([c.watch((()=>this.tileSize),(()=>this._reset()),c.syncAndInitial),c.watch((()=>this.cameraOnSurface?.location),e,c.syncAndInitial),c.watch((()=>this.viewState?.contentCamera),e,c.syncAndInitial),c.watch((()=>this.focus?.location),e,c.syncAndInitial),c.watch((()=>this.terrain?.baseOpacity??1),e),c.watch((()=>this.tilingScheme),(e=>{this._reset(),this._measurements=new y.FeatureTileMeasurements3D(this.renderCoordsHelper,e,this._opaqueGround)}),c.sync),c.watch((()=>this._opaqueGround),(e=>this._measurements.opaqueGround=e),c.sync)]),this._frameWorker=this.scheduler?.registerTask(v.TaskPriority.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=a.removeMaybe(this._frameWorker)}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void o.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const r=null!=e?e.clone():null;this._set("filterExtent",r),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=f.create();return b.toBoundingRect(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}addClient(){const e=d.generateUID();return this._clients.add(e),1===this._clients.size&&this._setDirty(),s.makeHandle((()=>this._removeClient(e)))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}get _opaqueGround(){return 1===(this.terrain?.baseOpacity??1)}_setDirty(){this._hasClients&&!this.suspended&&(this._frameWorker?this._dirty.value=!0:this.runTask(v.noBudget))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty.value=!1}get running(){return this.updating}_reset(){this._newTiles.clear(),this._pendingTiles.value=null,this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map((t=>new g.FeatureTileDescriptor(t[0],t[1],t[2],e)))}runTask(e){e=this._tests?v.noBudget:e,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(e),null!=this._frameWorker&&(this._frameWorker.priority=v.TaskPriority.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(e),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=v.TaskPriority.FEATURE_TILE_TREE)}_startUpdate(e){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:t,_filterExtentRect:r,_newTiles:i}=this;t.setup(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter((e=>{if(t.update(e),e.measures.visible&&(!r||f.intersects(e.extent,r))){if(e.measures.splitPriority>0)return!0;i.push(e)}return!1})).sort(S),this._newTiles.clear(),e.madeProgress()}_splitPendingTiles(e){const t=this._pendingTiles.value;if(!t)return;const{tilingScheme:r,_filterExtentRect:i,_newTiles:s,_measurements:n}=this;for(;t.length>0&&this._tileBudgetRatio<=2;){const o=t.pop();if(e.madeProgress(),o.measures.splitPriority>0){r.ensureMaxLod(o.level+1);const e=o.createChildren();for(const r of e)n.update(r),!r.measures.visible||i&&!f.intersects(r.extent,i)||(r.measures.splitPriority>0?t.push(r):s.push(r));t.sort(S),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else s.push(o);if(e.done)return}s.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),s.clear(),n.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/60}_mergeNewTiles(e,t=!1){if(this._tileBudgetRatio<=e)return;const{_newTiles:r,_measurements:i}=this;r.sort(((e,t)=>t.measures.distance-e.measures.distance));const s=new Map(r.map((e=>[e.id,e]))),n=r.length;for(const n of s.values()){const{lij:o,measures:a}=n;if(!a.mergeable||o[1]%2!=0||o[2]%2!=0||o[0]<=1||n.lodLevelDelta>=_.maxLODLevelDelta)continue;const l=a.lodLevel;let c=l,u=!0;const d=s.get(g.getFeatureTileId(o[0],o[1]+1,o[2]));let h=Math.abs((d?.measures.lodLevel??0)-l),p=0===h||t&&d?.measures.mergeable&&h<=1;if(!d||!p)continue;c+=d.measures.lodLevel,u&&=0===h;const m=s.get(g.getFeatureTileId(o[0],o[1],o[2]+1));if(h=Math.abs((m?.measures.lodLevel??0)-l),p=0===h||t&&m?.measures.mergeable&&h<=1,!m||!p)continue;c+=m.measures.lodLevel,u&&=0===h;const f=s.get(g.getFeatureTileId(o[0],o[1]+1,o[2]+1));if(h=Math.abs((f?.measures.lodLevel??0)-l),p=0===h||t&&f?.measures.mergeable&&h<=1,!f||!p)continue;c+=f.measures.lodLevel,u&&=0===h,r.removeUnordered(n),r.removeUnordered(d),r.removeUnordered(m),r.removeUnordered(f),s.delete(n.id),s.delete(d.id),s.delete(m.id),s.delete(f.id);const y=new g.FeatureTileDescriptor(o[0]-1,o[1]/2,o[2]/2,this.tilingScheme);if(i.update(y),y.measures.visible=!0,y.measures.lodLevel=c/4,y.measures.mergeable=u,r.push(y),s.set(y.id,y),this._tileBudgetRatio<=e)return}r.length<n&&this._mergeNewTiles(e,t)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const e of this.tiles.items)e.used=!1;let e=!1;const t=this._newTiles.filter((t=>{const r=this._idToTile.get(t.id);return r?(e||=r.measures.lodLevel!==t.measures.lodLevel,r.measures={...t.measures},r.used=!0):this._idToTile.set(t.id,t),!r})),r=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(r),this.tiles.addMany(t),this._sortTiles(),!e||r.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}},t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"scheduler",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"renderCoordsHelper",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"tilingSchemeOwner",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"cameraOnSurface",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"focus",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"viewState",void 0),t.__decorate([h.property({constructOnly:!0})],e.FeatureTileTree3D.prototype,"terrain",void 0),t.__decorate([h.property()],e.FeatureTileTree3D.prototype,"tiles",void 0),t.__decorate([h.property()],e.FeatureTileTree3D.prototype,"tileSize",void 0),t.__decorate([h.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"tilingScheme",null),t.__decorate([h.property()],e.FeatureTileTree3D.prototype,"filterExtent",null),t.__decorate([h.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"_filterExtentRect",null),t.__decorate([h.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"_rootTileIds",null),t.__decorate([h.property({value:!1})],e.FeatureTileTree3D.prototype,"suspended",null),t.__decorate([h.property({readOnly:!0})],e.FeatureTileTree3D.prototype,"updating",null),e.FeatureTileTree3D=t.__decorate([m.subclass("esri.views.3d.layers.support.FeatureTileTree3D")],e.FeatureTileTree3D),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FeatureTileDescriptor":function(){define(["exports","../../../../geometry/ellipsoidUtils","../../../../geometry/support/aaBoundingRect"],(function(e,t,r){"use strict";class i{constructor(e,t,i,o,a=n(e,t,i)){this._tilingScheme=o,this.id=a,this.lij=[0,0,0],this.extent=r.create(),this.measures=new s,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=e,this.lij[1]=t,this.lij[2]=i,o.getExtent(e,t,i,this.extent)}get planetRadius(){return t.getReferenceEllipsoid(this.spatialReference).radius}get spatialReference(){return this._tilingScheme.spatialReference}get resolution(){return this._tilingScheme.resolutionAtLevel(this.measures.lodLevel)}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){const e=this.lij[0]+1,t=2*this.lij[1],r=2*this.lij[2];return[new i(e,t,r,this._tilingScheme),new i(e,t+1,r,this._tilingScheme),new i(e,t,r+1,this._tilingScheme),new i(e,t+1,r+1,this._tilingScheme)]}}class s{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}}function n(e,t,r){return`${e}/${t}/${r}`}e.FeatureTileDescriptor=i,e.getFeatureTileId=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FeatureTileMeasurements3D":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/frustum","../../../../geometry/support/ray","../../../ViewingMode","./FeatureTileVisibility3D","../../webgl/RenderCamera"],(function(e,t,r,i,s,n,o,a,l){"use strict";const c=[r.create(),r.create(),r.create(),r.create()],u=r.create(),d=r.create(),h=r.create(),p=r.freeze(0,0,1),m=n.fromValues(r.ZEROS,p);e.FeatureTileMeasurements3D=class{constructor(e,t,r){this._renderCoordsHelper=e,this._tilingScheme=t,this._camera=new l,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new a.FeatureTileVisibility3D(e,r)}set opaqueGround(e){this._visibility.opaqueGround=e}setup(e,t,r){this._camera.copyFrom(e),this._surfaceElevation=r,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(e){const{measures:t,extent:r,level:s}=e;t.visible=this._visibility.compute(e),t.distance=i.distance(r,this._focusOnMap),t.mergeable=!0,t.lodLevel=a.minTileLOD,t.splitPriority=Math.max(0,a.minTileLOD-s),t.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(e):this._updateSplitAndLodLocal(e))}_updateSplitAndLodGlobal(e){const r=e.level,i=this._renderCoordsHelper,{eye:s,fov:n}=this._camera,o=i.referenceEllipsoid.radius,l=t.len(s)-o;if(2*Math.atan(o/l)<n&&l>0)return void(e.measures.lodLevel=Math.max(r,a.minTileLOD));const d=c,{extent:p}=e,{_surfaceElevation:f}=this;t.set(d[0],p[0],p[1],f),t.set(d[1],p[2],p[1],f),t.set(d[2],p[2],p[3],f),t.set(d[3],p[0],p[3],f);const g=t.set(u,.5*(p[0]+p[2]),.5*(p[1]+p[3]),f),y=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)i.toRenderCoords(d[e],y,d[e]);i.toRenderCoords(g,y,g);const _=t.normalize(m.direction,g),b=t.dot(s,_),v=t.scale(h,_,b);this._updateSplitAndLod(e,d,g,v)}_updateSplitAndLodLocal(e){const r=c,{extent:i}=e,{_surfaceElevation:s}=this;t.set(r[0],i[0],i[1],s),t.set(r[1],i[2],i[1],s),t.set(r[2],i[2],i[3],s),t.set(r[3],i[0],i[3],s);const n=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)this._renderCoordsHelper.toRenderCoords(r[e],n,r[e]);const o=t.set(u,.5*(r[0][0]+r[2][0]),.5*(r[0][1]+r[2][1]),.25*(r[0][2]+r[1][2]+r[2][2]+r[3][2])),a=t.set(d,o[0],o[1],0),{eye:l,far:f}=this._camera,g=t.set(h,a[0],a[1],l[2]);t.set(m.origin,a[0],a[1],l[2]-2*f),t.copy(m.direction,p),this._updateSplitAndLod(e,r,o,g)}_updateSplitAndLod(e,r,i,n){const o=Math.max(t.dist(r[0],r[2]),t.dist(r[1],r[3]),t.dist(r[0],i)+t.dist(i,r[2]),t.dist(r[1],i)+t.dist(i,r[3])),{eye:a,near:l,fov:c,viewForward:u,width:d,height:h,pixelRatio:p,frustum:m}=this._camera,f=t.dot(a,u),g=t.dot(i,u)-f,y=t.dist(i,a);let _=g,b=g,v=y,S=y;const w=(e,t)=>t<l?1:Math.sqrt(e*e-t*t)/t;let x=w(y,g);for(const e of r){const r=t.dot(e,u)-f;_=Math.min(_,r),b=Math.max(b,r);const i=t.dist(e,a);S=Math.max(S,i),v=Math.min(v,i);const s=w(i,r);x=Math.min(x,s)}if(b<l)return void(e.measures.lodLevel=0);const T=Math.cos(.5*c),C=t.dist(a,n);x>T&&C>.5*o&&(b=2*S,_=2*v);const P=.5*Math.sqrt(d*d+h*h)/p,M=2*Math.tan(.5*c),R=e=>312*Math.max(l,e)/P*M,E=e.level,O=o*2**E*Math.max(1,M),A=R(_),I=Math.ceil(Math.log2(Math.max(1,O/A)));if(e.measures.lodLevel=Math.max(I,e.measures.lodLevel),e.measures.splitPriority+=e.measures.lodLevel-E,E<I){const t=+s.intersectsPoint(m,r[0])+ +s.intersectsPoint(m,r[1])+ +s.intersectsPoint(m,r[2])+ +s.intersectsPoint(m,r[3]);e.measures.splitPriority+=t}const D=R(b)/A;D>2.5&&(e.measures.splitPriority+=D)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===o.ViewingMode.Global}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FeatureTileVisibility3D":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/spatialReferenceEllipsoidUtils","../../../../geometry/projection/projectBuffer","../../../../geometry/projection/projectVec3Array","../../../../geometry/support/frustum","../../../../geometry/support/plane","../../../ViewingMode","../../state/Frustum"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(e,r,i){return t.cross(e,r,i),t.normalize(e,e),e}function h(e,r,i){return t.sub(e,r,i),t.normalize(e,e),e}function p(e,r){return t.scale(e,e,r/t.len(e)),e}const m=[a.PlaneIndex.LEFT,a.PlaneIndex.RIGHT,a.PlaneIndex.BOTTOM,a.PlaneIndex.TOP,a.PlaneIndex.FAR];function f(e,t,r){for(let i=0;i<r;++i)if(l.signedDistance(e,t[i])<=0)return!1;return!0}function g(e,t,r){for(const i of m)if(f(e[i],t,r))return!0;return!1}function y(e,t,r=t.length){for(let i=0;i<r;++i){const r=t[i];let s=!0;for(const t of e)if(l.signedDistance(t,r)>0){s=!1;break}if(s)return!0}return!1}function _(e,r,i){for(const s of r)if(t.dot(s,e)<i)return!1;return!0}const b=[r.create(),r.create(),r.create(),r.create(),r.create(),r.create(),r.create(),r.create()],v=[0,0,0,0,0,0],S=[r.create(),r.create(),r.create(),r.create(),r.create(),r.create()],w=r.create(),x=r.create(),T=r.create(),C=r.create(),P=r.create(),M=r.create(),R=r.create(),E=r.create(),O=r.create(),A=r.create(),I=r.create(),D=r.freeze(0,0,0),F=r.create(),L=[r.create(),r.create(),r.create(),r.create(),r.create(),r.create(),r.create(),r.create()],N=[r.create(),r.create(),r.create(),r.create(),r.create()],U=r.create(),V=r.create(),B=r.create(),G=r.create(),k=r.create(),z=r.create(),j=r.create(),q=r.create(),H=r.create(),W=r.create(),$=[0,1,2,3],Q=[0,1,2,3],Z=[0,1,3],Y=[0,1,3],X=[1,2,3],K=[1,2,3],J=r.create(),ee=[0,0];function te(e,r,i,s){const n=i.length,o=s.length;if(0===n||0===o)return!0;const a=W;d(a,e,r);const l=o<n,c=l?i:s,u=ee;return function(e,r,i){let s=1/0,n=-1/0;for(const e of i){const i=t.dot(r,e);s=Math.min(s,i),n=Math.max(n,i)}e[0]=s,e[1]=n}(u,a,l?s:i),function(e,r,i,s){let n=1/0,o=-1/0;for(const a of s){const s=t.dot(i,a);if(n=Math.min(n,s),o=Math.max(o,s),n<=r&&o>=e)return!1}return!0}(u[0],u[1],a,c)}const re=430,ie=r.create(),se=r.create(),ne=Math.cos(.25*Math.PI),oe=r.fromValues(0,0,1),ae=r.create();function le(e,t,r){const i={t0:0,t1:1};for(const s of m)if(!ue(e[s],t,r,i))return!1;return i.t0<i.t1}function ce(e,t,r){const i={t0:0,t1:1};for(const s of e)if(!ue(s,t,r,i))return!1;return i.t0<i.t1}function ue(e,t,r,i){let{t0:s,t1:n}=i;const o=l.signedDistance(e,t),a=l.signedDistance(e,r);if(o>=0&&a>=0)return!1;if(o<0&&a>=0){const e=-o/(a-o);if(e<s)return!1;e<n&&(n=e)}else if(o>=0&&a<0){const e=o/(o-a);if(e>n)return!1;e>s&&(s=e)}return i.t0=s,i.t1=n,!0}const de=[l.fromValues(-1,0,0,1),l.fromValues(1,0,0,-1),l.fromValues(0,-1,0,1),l.fromValues(0,1,0,-1),l.fromValues(0,0,-1,1),l.fromValues(0,0,1,-1)],he=r.freeze(0,0,1);e.FeatureTileVisibility3D=class{constructor(e,t){this._renderCoordsHelper=e,this.opaqueGround=t,this._cache=new Map,this._cameraForward=r.create(),this._cameraEye=r.create(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=r.create(),this._frustumBoundingSphereRadius=0,this._frustum=new u.Frustum(e),this._renderSR=e.spatialReference;const n=s.getSphericalPCPF(this._renderSR);this._renderSREllipsoidRadius=i.getReferenceEllipsoid(n).radius}setup(e){this._aboveGround=e.aboveGround,this._frustum.update(e),t.normalize(this._cameraForward,e.viewForward),t.copy(this._cameraEye,e.eye),this._cameraFovY=e.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(e){if(this._cache.has(e.id))return this._cache.get(e.id);const t=this._isVisibleInFrustum(e);return this._cache.set(e.id,t),t}_isVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===c.ViewingMode.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,r=e.origin,i=E;t.normalize(i,e.direction);const s=e.points,n=O;t.sub(n,s[4],r);const o=.5*t.dot(n,n)/t.dot(i,n),a=this._frustumBoundingSphereCenter;t.scaleAndAdd(a,r,i,o);const l=1+o;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(e){const r=e.spatialReference,i=e.extent,s=this._renderSR;if(v[0]=i[0],v[1]=i[1],v[2]=0,v[3]=i[2],v[4]=i[3],v[5]=0,!n.projectBuffer(v,r,0,v,s,0))return!1;t.set(S[0],v[0],v[1],0),t.set(S[1],v[3],v[1],0),t.set(S[2],v[3],v[4],0),t.set(S[3],v[0],v[4],0),t.set(w,.5*(v[0]+v[3]),.5*(v[1]+v[4]),.5*(v[2]+v[5]));const o=oe,a=.5*t.dist(S[0],S[2]),l=this._frustum,c=this._frustumBoundingSphereRadius,u=this._frustumBoundingSphereCenter,d=I;t.sub(d,u,w);const h=t.dot(o,d),p=A;if(t.scaleAndAdd(p,w,o,h),t.dist(p,u)>a+c)return!1;const m=this._cameraForward,f=oe,_=t.dot(m,f),x=this._cameraFovY,T=this._cameraEye;if(Math.abs(_)<Math.abs(Math.cos(.5*x))){let e=!0;const r=t.set(ae,m[0],m[1],0),i=t.dot(T,r);for(let s=0;s<4;++s){const n=S[s];if(t.dot(n,r)-i>0){e=!1;break}}if(e)return!1}{const e=S[0],t=S[2];if(e[0]<=T[0]&&T[0]<=t[0]&&e[1]<=T[1]&&T[1]<=t[1])return!0}const C=b,P=this.opaqueGround&&this._aboveGround,M=this.opaqueGround&&!this._aboveGround,R=Math.min(M?re:1/0,h+c),E=Math.max(P?-430:-1/0,h-c);for(let e=0;e<4;++e)t.scaleAndAdd(C[e],S[e],o,R),t.scaleAndAdd(C[e+4],S[e],o,E);if(g(l.planes,C,8))return!1;if(y(l.planes,C,8))return!0;for(let e=0;e<4;++e){const t=C[e],r=C[e+4];if(le(l.planes,t,r))return!0;const i=C[(e+1)%4];if(le(l.planes,t,i))return!0;const s=C[4+(e+1)%4];if(le(l.planes,r,s))return!0}if(de[0][3]=+S[0][0],de[1][3]=-S[2][0],de[2][3]=+S[0][1],de[3][3]=-S[2][1],de[4][3]=+E,de[5][3]=-R,y(de,l.points))return!0;if(y(de,l.points))return!0;for(let e=0;e<4;++e){const t=T,r=l.points[e+4];if(ce(de,t,r))return!0;const i=l.points[4+(e+1)%4];if(ce(de,r,i))return!0}return!1}_isTileVisibleInFrustumGlobal(e){if(e.level<2)return!0;const i=e.spatialReference,s=e.extent,n=this.opaqueGround&&this._aboveGround,a=this.opaqueGround&&!this._aboveGround,c=S,u=.5*(s[0]+s[2]);if(t.set(c[0],s[0],s[1],0),t.set(c[1],s[2],s[1],0),t.set(c[2],s[2],s[3],0),t.set(c[3],s[0],s[3],0),t.set(c[4],u,s[1],0),t.set(c[5],u,s[3],0),!o.projectVec3Array(c,i,0,c,this._renderSR,0,6))return!1;const m=c[0][2]>0,f=c[3][2]<0,y=m||f,b=this._renderSREllipsoidRadius;if(y){const e=T;d(e,he,c[0]);const r=C;if(d(r,he,c[1]),m){const i=x,s=c[4],n=P;d(n,s,he),d(i,n,s);const o=c[0];t.cross(o,e,i),p(o,b);const a=c[1];t.cross(a,r,i),p(a,b)}else if(f){const i=x,s=c[5],n=P;d(n,s,he),d(i,s,n);const o=c[3];t.cross(o,i,e),p(o,b);const a=c[2];t.cross(a,i,r),p(a,b)}}const v=w,E=t.sub(U,c[3],c[0]);t.normalize(E,E);const O=t.add(V,c[0],c[3]);t.scale(O,O,.5);const A=-t.dot(O,E),I=t.add(B,c[0],c[1]);t.scale(I,I,.5);const W=t.add(G,c[2],c[3]);t.scale(W,W,.5);const ee=t.sub(k,W,I);t.normalize(ee,ee);const oe=-(A+t.dot(E,I))/t.dot(E,ee);t.scaleAndAdd(v,I,ee,oe),p(v,b);const ae=this._frustumBoundingSphereRadius,le=this._frustumBoundingSphereCenter,ce=this._frustum,ue=ce.planes,de=M;t.normalize(de,v);const pe=t.dot(c[0],de)/t.len(c[0]),me=ce.origin,fe=ce.points;let ge=!1;if(n){{ge=!0;const e=t.normalize(ie,me);for(let i=0;i<4;++i){const s=fe[4+i],n=t.sub(r.create(),s,me);t.normalize(n,n);const o=t.cross(r.create(),e,n);t.normalize(o,o);const a=t.cross(r.create(),n,o);if(t.normalize(a,a),t.dot(me,a)>b){ge=!1;break}}}if(ge&&t.dot(me,de)<b*pe-re)return!1;const e=t.normalize(ie,ce.origin);if(t.dot(e,de)<0)return!1;{const e=t.normalize(se,ce.direction);if(t.dot(e,de)>ne)return!1}}const ye=Math.sqrt(1-pe*pe);if(ye>.9)return!0;let _e=!1;const be=t.dot(de,le),ve=t.len(le);if(ve<=ae&&!ue.some((e=>l.signedDistance(e,D)>0))){if(!n)return!0;_e=!0}const Se=be/ve;if(!_e&&be<=0&&-be>ae)return!1;const we=ae/ve;if(Math.sqrt(1-Se*Se)*Math.sqrt(1-we*we)-we*Se>ye)return!1;if(!ge){if(c.some((e=>ce.intersectsPoint(e))))return!0;if(ce.intersectsPoint(v))return!0}const xe=F;t.sub(xe,le,D);const Te=t.dot(xe,de),Ce=R;t.scale(Ce,de,Te);const Pe=t.dist(Ce,le),Me=i.isWGS84,Re=e.lij,Ee=Me&&Re[2]===2**Re[0]-1,Oe=Me&&0===Re[2],Ae=Oe?X:Ee?Z:$,Ie=Oe?K:Ee?Y:Q;if(!_e){const e=c,t=J,r=z,i=j,s=D;for(const n of Ae){const o=e[n];if(h(r,e[(n+1)%4],o),h(i,s,o),d(t,i,r),_(t,fe,1))return!1}}let De=null;if(!n&&Te<1.01*ae){const e=2.5*ae;if(Pe>pe*e+ae)return!1;const r=N,i=e/pe;for(let e=0;e<4;++e)t.scale(r[e],c[e],i/b);t.set(r[4],0,0,0),De=r}else{const e=(a?b+re:Te+ae)/pe,r=n?b-re:(Te-ae)/pe,i=L;for(let s=0;s<4;++s){const n=c[s];t.scale(i[s],n,r/b),t.scale(i[s+4],n,e/b)}De=i}if(g(ue,De,De.length))return!1;const Fe=ce.lines,Le=q,Ne=H;for(const e of Fe){t.normalize(Ne,e.direction);for(const e of Ie){const r=De[e];if(t.normalize(Le,r),te(Ne,Le,De,fe))return!1;const i=(e+1)%4;if(n){const e=De[i];if(t.sub(Le,e,r),t.normalize(Le,Le),te(Ne,Le,De,fe))return!1}if(a){const r=De[4+e],s=De[4+i];if(t.sub(Le,s,r),t.normalize(Le,Le),te(Ne,Le,De,fe))return!1}}}return!0}},e.isAnyVertexInPolyhedron=y,e.isConvexHullOutsideOfFrustum=g,e.maxLODLevelDelta=4,e.minTileLOD=2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/projection/projectVec3Array":function(){define(["exports","../../chunks/vec32","./projectors"],(function(e,t,r){"use strict";e.projectVec3Array=function(e,i,s,n,o,a,l=1){const c=r.getProjector(i,o);if(null==c)return!1;if(c===r.copy3){if(e===n&&s===a)return!0;const r=s+l;for(let i=s,o=a;i<r;++i,++o)t.copy(n[o],e[i]);return!0}const u=s+l;for(let t=s,r=a;t<u;++t,++r)c(e[t],0,n[r],0);return!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/extentUtils":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projection/projectBuffer"],(function(e,t,r){"use strict";const i=t.create();e.projectToBoundingBox=function(e,t,s){if(null==e||null==s)return!1;let n=!0;return i[0]=null!=e.xmin?e.xmin:0,i[1]=null!=e.ymin?e.ymin:0,i[2]=null!=e.zmin?e.zmin:0,n=n&&r.projectBuffer(i,e.spatialReference,0,t,s,0),i[0]=null!=e.xmax?e.xmax:0,i[1]=null!=e.ymax?e.ymax:0,i[2]=null!=e.zmax?e.zmax:0,n=n&&r.projectBuffer(i,e.spatialReference,0,t,s,3),null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.zmin&&(t[2]=-1/0),null==e.xmax&&(t[3]=1/0),null==e.ymax&&(t[4]=1/0),null==e.zmax&&(t[5]=1/0),n},e.toBoundingRect=function(e,t,s){if(null==e||null==s)return!1;let n=!0;return i[0]=null!=e.xmin?e.xmin:0,i[1]=null!=e.ymin?e.ymin:0,i[2]=null!=e.zmin?e.zmin:0,n=n&&r.projectBuffer(i,e.spatialReference,0,i,s,0),t[0]=i[0],t[1]=i[1],i[0]=null!=e.xmax?e.xmax:0,i[1]=null!=e.ymax?e.ymax:0,i[2]=null!=e.zmax?e.zmax:0,n=n&&r.projectBuffer(i,e.spatialReference,0,i,s,0),t[2]=i[0],t[3]=i[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/state/ViewState":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/watch","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../ViewAnimation","../../ViewingMode","./Constraints","./controllers/AnimationController","./controllers/CameraController","../webgl/RenderCamera","../webgl-engine/lib/DepthRange","../webgl-engine/lib/rendererUtils","../../support/HighlightDefaults","../../support/PropertiesPool","../../support/RenderState"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w){"use strict";let x=class extends t{constructor(e){super(e),this._propertiesPool=new S.PropertiesPool({camera:y},this),this._lastSeenCameraProjectionValues=new y,this.mode=w.RenderState.ANIMATING,this._cssCamera=new y,this._camera=new y,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new m.Constraints({state:this}),this.events=new r,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new S.PropertiesPool({camera:y},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===p.ViewingMode.Global){const e=d.getReferenceEllipsoid(this.spatialReference).radius;this.camera=new y({eye:u.fromValues(4*e,0,0),center:u.fromValues(e,0,0),up:u.fromValues(0,0,1)})}else this.camera=new y({eye:u.fromValues(0,0,100),center:u.fromValues(0,0,0),up:u.fromValues(0,1,0)})}get animation(){return this.cameraController instanceof f.AnimationController&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:r,pixelRatio:i}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/i),e.width=Math.round(r/i),e}get camera(){return this._camera}set camera(e){e!==C&&C.copyFrom(e),C.computeUp(this.viewingMode),this.events.emit("before-camera-change",{camera:C});const t=this._camera;if(r=this._lastSeenCameraProjectionValues,i=C,(r.fov!==i.fov||r.fullViewport[0]!==i.fullViewport[0]||r.fullViewport[1]!==i.fullViewport[1]||r.fullViewport[2]!==i.fullViewport[2]||r.fullViewport[3]!==i.fullViewport[3]||r.padding[b.PaddingSide.TOP]!==i.padding[b.PaddingSide.TOP]||r.padding[b.PaddingSide.RIGHT]!==i.padding[b.PaddingSide.RIGHT]||r.padding[b.PaddingSide.BOTTOM]!==i.padding[b.PaddingSide.BOTTOM]||r.padding[b.PaddingSide.LEFT]!==i.padding[b.PaddingSide.LEFT])&&(this._lastSeenCameraProjectionValues.copyFrom(C),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(C)&&(this._camera=this._propertiesPool.get("camera").copyFrom(C),this._cameraChanged=!t.almostEquals(C),this._cameraChanged)){const e=c.afterDispatch((()=>{this._cameraChanged=!1,e.remove()}))}var r,i}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===w.RenderState.IDLE}get updating(){return this.mode!==w.RenderState.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){if(null==e)return void(this._contentCamera=null);const t=e.clone();this.events.emit("before-camera-change",{camera:t,sceneDepthRange:_.DepthRange.infinite}),this._contentCamera=t}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return this.viewingMode===p.ViewingMode.Global}get isLocal(){return this.viewingMode===p.ViewingMode.Local}get viewingMode(){return p.viewingModeFromString(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,v.maximumHighlights);for(let t=0;t<e.length;){const r=e[t],i=e.findIndex((e=>e.name===r.name));i>=0&&t>i?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach(((t,r)=>e.set(t.name,r))),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(P),this.addHandles(i.when((()=>e.state===g.State.Finished||e.state===g.State.Stopped),(()=>{this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t)))}),{sync:!0,once:!0}),P),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=g.State.Rejected)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();C.copyFrom(this._get("camera")),e(C),this.camera=C,this._processingUpdates=!1,this._processUpdateQueue()}};e.__decorate([s.property({constructOnly:!0})],x.prototype,"view",void 0),e.__decorate([s.property()],x.prototype,"mode",void 0),e.__decorate([s.property({readOnly:!0,type:h})],x.prototype,"animation",null),e.__decorate([s.property({type:y})],x.prototype,"cssCamera",null),e.__decorate([s.property()],x.prototype,"_cssCamera",void 0),e.__decorate([s.property({type:y})],x.prototype,"camera",null),e.__decorate([s.property()],x.prototype,"_camera",void 0),e.__decorate([s.property({readOnly:!0})],x.prototype,"pixelRatio",null),e.__decorate([s.property()],x.prototype,"rasterPixelRatio",void 0),e.__decorate([s.property()],x.prototype,"contentPixelRatio",void 0),e.__decorate([s.property({readOnly:!0})],x.prototype,"alignPixelEnabled",null),e.__decorate([s.property({readOnly:!0})],x.prototype,"updating",null),e.__decorate([s.property({})],x.prototype,"_contentCamera",void 0),e.__decorate([s.property({type:y})],x.prototype,"contentCamera",null),e.__decorate([s.property({readOnly:!0})],x.prototype,"fixedContentCamera",null),e.__decorate([s.property({readOnly:!0})],x.prototype,"events",void 0),e.__decorate([s.property({readOnly:!0})],x.prototype,"isGlobal",null),e.__decorate([s.property({readOnly:!0})],x.prototype,"isLocal",null),e.__decorate([s.property({readOnly:!0})],x.prototype,"viewingMode",null),e.__decorate([s.property({readOnly:!0})],x.prototype,"highlights",null),e.__decorate([s.property({readOnly:!0})],x.prototype,"highlightOrderMap",null),e.__decorate([s.property({readOnly:!0})],x.prototype,"navigating",null),e.__decorate([s.property({readOnly:!0})],x.prototype,"stationary",null),e.__decorate([s.property()],x.prototype,"_cameraChanged",void 0),e.__decorate([s.property()],x.prototype,"cameraController",null),x=e.__decorate([l.subclass("esri.views.3d.state.ViewState")],x);const T=x,C=new y,P="ViewStateHandles";return T}))},"esri/views/3d/state/helpers/SceneIntersectionHelper":function(){define(["exports","../../../../core/has","../../../../core/PooledArray","../../../../core/screenUtils","../../../../core/unitUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/ray","../../../../geometry/support/vectorStacks","../../../../support/elevationInfoUtils","../../../ViewingMode","../../support/hitTest","../../support/geometryUtils/ray","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/IntersectorType","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/materials/HUDMaterial"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";const v=(()=>{const e=[];for(let t=-1;t<=1;t++)for(let r=-1;r<=1;r++)e.push([r+1,t+1]);return e})();class S{constructor(e){this.result=e,this.screenPoint=i.createRenderScreenPointArray3()}}let w;function x(e){return w&&w.viewingMode===e||(w=new m.Intersector(e)),w}class T{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t((e=>{e.pickable&&this.filterLayerViewUid(e.apiLayerViewUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)}))}filterLayerViewUid(e){const{include:t,exclude:r}=this;return null==e?null==t&&null==r:(null==t||t.has(e))&&(null==r||!r.has(e))}filterRenderGeometry(e){return this.filterLayerViewUid(e.layerViewUid)}}const C=o.create(),P=o.create(),M=i.createRenderScreenPointArray3();e.SceneIntersectionHelper=class{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new r,this._tolerance=m.defaultTolerance,this._tmpRay=l.create(),this._tmpRegion=a.create(),this._validateHUDIntersector=new m.Intersector(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,r){return this.intersectRay(this._getPickRay(e,this._tmpRay),x(this.viewingMode),t,r)}intersectScreenFreePointFallback(e,t,r){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,r)}intersectRayFreePointFallback(e,t,r){return this.intersectRay(e,x(this.viewingMode),t,r)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,r,i){return t.options.selectionMode=!1,t.options.store=f.StoreResults.MIN,this.computeIntersection(e,t,!1,i),!!t.results.min&&t.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(e,t,r=.5,i=.5){return e.getRenderCenter(M,r,i),M[0]+=.0466,M[1]-=.0123,p.fromRenderAtEye(e,M,t)}intersectIntersectorScreen(e,t,r){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,!1,r)}intersectToolIntersectorScreen(e,t,r){const i=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(i,t,r)}intersectToolIntersectorRay(e,t,r){t.options.selectionMode=!0,this.computeIntersection(e,t,!1,r);const i=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||g.isValidIntersectorResult(i)&&i.intersector!==y.IntersectorType.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,!1,r))}setTolerance(e=m.defaultTolerance){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort(((e,t)=>e.type===y.IntersectorType.TERRAIN?1:t.type===y.IntersectorType.TERRAIN?-1:0))}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort(((e,t)=>e.type===y.IntersectorType.TERRAIN?1:t.type===y.IntersectorType.TERRAIN?-1:0))}_getPickRay(e,t){const r=this._view.state.camera;return p.fromScreen(r,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==d.ViewingMode.Local||null==e||n.add(t,e.origin,n.normalize(c.sv3d.get(),e.direction)),!1}intersectElevationFromScreen(e,t,r=0,i=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,r,i)}_intersectElevation(e,t,r=0,o=null){if(null==e)return null;const a=this._view,{renderCoordsHelper:l}=a,d=s.getMetersPerVerticalUnitForSR(a.spatialReference),p=null!=t?t.mode:"absolute-height",g=u.getElevationOffsetInMeters(t)/d,b=("on-the-ground"!==p?g+r:0)*d/l.unitInMeters,{camera:v}=a.state;if("absolute-height"===p){const t=l?.getAltitude(v.eye),r=n.dot(n.normalize(C,e.direction),l.worldUpAtPosition(v.eye,P));if(t<b&&r<0||t>=b&&r>0)return null;if(l.intersectInfiniteManifold(e,b,C)){const e=h.computeMapPointFromVec3d(a,C);return e.z??=0,e.z-=g,e}return null}const S=i.castRenderScreenPointArray3(c.sv3d.get());v.projectToRenderScreen(e.origin,S);const w=new T(null,this._forEachLayer),{slice:{plane:x}}=a,M=null!=x?_.sliceFilterPredicate(x):null,R=new m.Intersector(this.viewingMode);R.options.store=f.StoreResults.MIN,R.options.verticalOffset=b,R.options.normalRequired=!1;const E=e.origin,O=n.add(c.sv3d.get(),E,e.direction);R.reset(E,O,v),R.point=S;let A=null;if(o&&"type"in o&&"graphics"===o.type){const e=a.allLayerViews.find((e=>e.layer===o))?.uid;A=e?t=>t.layerViewUid===e:null}else o&&(A=e=>e.graphicUid!==o.uid);switch(p){case"relative-to-scene":{const e=e=>(!A||A(e))&&!!e.lastValidElevationBB;R.intersect(w.layers,S,this._tolerance,null,e),this._externalIntersectionHandlers.forAll((e=>{if(e.type===y.IntersectorType.I3S||e.type===y.IntersectorType.TERRAIN||e.type===y.IntersectorType.TILES3D){const t=e.slicePlaneEnabled?M:null;e.intersect(R,t,R.rayBegin,R.rayEnd,S,!1)}}));break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?M:null;e.intersect(R,t,R.rayBegin,R.rayEnd,S,!1)}}))}if(R.results.min.getIntersectionPoint(C)){const e=h.computeMapPointFromVec3d(a,C);return e.z=r,e}return null}computeIntersection(e,t,r,s){if(null==e)return;const o=this._view.state.camera,a=i.castRenderScreenPointArray3(c.sv3d.get());o.projectToRenderScreen(e.origin,a);const l=new T(s,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!s||!("include"in s||"exclude"in s);const u=e.origin,d=n.add(c.sv3d.get(),e.origin,e.direction);t.reset(u,d,o),t.intersect(l.layers,a,this._tolerance);const h=this._view.slice.plane,p=null!=h?_.sliceFilterPredicate(h):null;t.intersect(l.sliceableLayers,a,this._tolerance,p);const m=s&&(s.requiresGroundFeedback||s.enableDraped);this._externalIntersectionHandlers.forAll((e=>{const i=e.layerViewUid,s=Array.isArray(i),n=s?i:[i];s&&(t.options.filteredLayerViewUids=[]);let o=!1;for(const e of n)l.filterLayerViewUid(e)?o=!0:s&&t.options.filteredLayerViewUids.push(e);if(t.options.isFiltered=!o,e.isGround&&m||!t.options.isFiltered){const i=e.slicePlaneEnabled?p:null;e.intersect(t,i,u,d,a,r)}}));const f=c.sv3d.get(),g=this._view.basemapTerrain;if(s&&s.enableDraped&&null!=g.spatialReference&&t.results.ground.getIntersectionPoint(f)){const e=g.overlayManager.renderer,r=this._view.renderCoordsHelper.spatialReference,i=c.sv3d.get();this._view.renderCoordsHelper.fromRenderCoords(f,i,g.spatialReference),i[2]=this._view.elevationProvider?.getElevation(f[0],f[1],f[2],r,"ground")??0,e.intersect(t,i,t.results.ground,(e=>l.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;a.copy(this._tmpRegion,a.negativeInfinity);const r=this._view.state.camera,i=[],s=this._tmpRegion,n=e=>{const t=new S(e),n=t.result.target.object.geometries.every((e=>e.material instanceof b.HUDMaterial&&e.material.parameters.occlusionTest));i.push({item:t,occlusionTest:n}),n&&(r.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),a.expandPointInPlace(s,t.screenPoint))};e.sortResults(t.all),null!=t.min.distance&&n(t.min);for(const e of t.all)t.min.target.object!==e.target.object&&t.max.target.object!==e.target.object&&n(e);if(null!=t.max.distance&&t.max.target.object!==t.min.target.object&&n(t.max),!i.length)return;s[0]===s[2]&&(s[2]+=1),s[1]===s[3]&&(s[3]+=1);const o=r.fullWidth,l=r.fullHeight,c=Math.max(0,s[0]-1),u=Math.max(0,s[1]-1),d=Math.min(a.width(s)+2,o-c),h=Math.min(a.height(s)+2,l-u),p=d>0&&h>0?new Uint8Array(d*h*4):null;p&&this._view.stage.renderer.readHUDVisibility(c,u,d,h,p);let m=!0;const g=null==e.results.max.distance;let y=0;for(const{item:t,occlusionTest:r}of i){let i=!r;if(r&&p)for(const e of v){const r=4*(Math.min(t.screenPoint[0]+e[0],o)-s[0]+(Math.min(t.screenPoint[1]+e[1],l)-s[1])*d);if(r>=0&&r<p.length&&p[r]){i=!0;break}}i&&(m&&(e.results.min.copy(t.result),m=!1),g&&e.results.max.copy(t.result),e.options.store===f.StoreResults.ALL&&e.results.all.splice(y++,0,t.result))}}},e.isIntersectionHandler=function(e){return"object"==typeof e&&"intersect"in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/support/elevationInfoUtils":function(){define(["exports","../core/unitUtils","../symbols/support/unitConversionUtils"],(function(e,t,r){"use strict";function i(e){return e?f:g}function s(e,t){return t?.mode?t.mode:i(e).mode}function n(e,t){return null!=t?t:i(e)}function o(e,t){return s(null==e||(e.hasZ??!1),t)}function a(e){const t=u(e),r=o(e.geometry,t),i=null!=t&&"on-the-ground"!==r?m(t):0,s=t?.featureExpressionInfo;return{mode:r,offset:i,featureExpressionInfo:s}}function l(e){return"0"===e?.featureExpressionInfo?.expression}function c(e){if(!e)return!1;if("on-the-ground"===e.mode)return!1;const t=e?.featureExpressionInfo?e.featureExpressionInfo.expression:null;return!(!t||"0"===t)}function u(e){return e.layer&&"elevationInfo"in e.layer?e.layer.elevationInfo:null}function d(e,r){if(!e?.offset)return 0;const{offset:i,unit:s}=e;if("decimal-degrees"===s)return 0;const n="unknown"!==s&&s?s:"meters",o=t.verticalLengthUnitFromSpatialReference(r);return o?t.convertUnit(i,n,o):0}function h(e,t,r,i,s,n,o=null){if(null==n)return;const a=null!=o?o.mode:"absolute-height";if("on-the-ground"===a)return 0;const{absoluteZ:l}=p(t,r,i,s,e,n);return function(e,t,r,i,s,n,o,a){const l=d(o,s);switch(a){case"absolute-height":return e-l;case"relative-to-ground":return e-((n.elevationProvider.getElevation(t,r,i,s,"ground")??0)+l);case"relative-to-scene":return e-((n.elevationProvider.getElevation(t,r,i,s,"scene")??0)+l)}}(l,t,r,i,s,e,o,a)}function p(e,t,r,i,s,n){const o=d(n,i);switch(n.mode){case"absolute-height":return{absoluteZ:r+o,elevation:0};case"on-the-ground":{const r=s.elevationProvider.getElevation(e,t,0,i,"ground")??0;return{absoluteZ:r,elevation:r}}case"relative-to-ground":{const n=s.elevationProvider.getElevation(e,t,r,i,"ground")??0;return{absoluteZ:r+n+o,elevation:n}}case"relative-to-scene":{const n=s.elevationProvider.getElevation(e,t,r,i,"scene")??0;return{absoluteZ:r+n+o,elevation:n}}}}function m(e){return(e?.offset??0)*r.getMetersPerUnit(e?.unit)}const f={mode:"absolute-height",offset:0},g={mode:"on-the-ground",offset:null};e.absoluteHeightElevationInfo=f,e.elevationContextAffectsAlignment=function(e,t){if(null==t)return!1;const{mode:r}=t;return null!=r&&("scene"===e&&"relative-to-scene"===r||"ground"===e&&"absolute-height"!==r)},e.elevationModeRequiredMessage=function(e,t,r){return r&&r.mode!==t?`${e} only support ${t} elevation mode`:null},e.elevationModeUnsupportedMessage=function(e,t,r){return r?.mode===t?`${e} do not support ${t} elevation mode`:null},e.featureExpressionInfoIsZero=l,e.featureExpressionUnsupportedMessage=function(e,t){return null!=t?.featureExpressionInfo&&"0"!==t.featureExpressionInfo.expression?`${e} do not support featureExpressionInfo`:null},e.getConvertedElevation=function(e,t,r,i=null){return h(e,t.x,t.y,t.hasZ?t.z:0,t.spatialReference,r,i)},e.getConvertedElevationFromVector=function(e,t,r,i,s=null){return h(e,t[0],t[1],t.length>2?t[2]:0,r,i,s)},e.getConvertedElevationFromXYZ=h,e.getEffectiveElevationInfo=n,e.getEffectiveElevationMode=s,e.getElevationOffset=d,e.getElevationOffsetInMeters=m,e.getGeometryEffectiveElevationInfo=function(e,t){return n(null==e||(e.hasZ??!1),t)},e.getGeometryEffectiveElevationMode=o,e.getGraphicEffectiveElevationInfo=a,e.getGraphicEffectiveElevationMode=function(e){const t=u(e);return o(e.geometry,t)},e.getZForElevationMode=function(e,t,r){if(!r?.mode)return;const i=e.hasZ?e.z:0,s=d(r,e.spatialReference);switch(r.mode){case"absolute-height":return i-s;case"on-the-ground":return 0;case"relative-to-ground":return i-((t.elevationProvider.getElevation(e.x,e.y,i,e.spatialReference,"ground")??0)+s);case"relative-to-scene":return i-((t.elevationProvider.getElevation(e.x,e.y,i,e.spatialReference,"scene")??0)+s)}},e.hasEffectiveFeatureExpressionInfo=c,e.hasFeatureExpressionInfo=function(e){return c(e)||l(e)},e.hasGraphicFeatureExpressionInfo=function(e){return c(a(e))},e.logInvalidElevationInfoWarning=function(e,t){t&&e.warn(".elevationInfo=",t)},e.onTheGroundElevationInfo=g,e.zValueInAbsoluteHeightMode=p,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/hitTest":function(){define(["exports","../../../Graphic","../../../core/iteratorUtils","../../../core/screenUtils","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/projection/projectVectorToVector","../../../layers/LayerConstants","../../../layers/support/layerUtils","./debugFlags","./ElevationProvider","../webgl-engine/lib/Intersector","../webgl-engine/lib/IntersectorInterfaces","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/IntersectorType","../webgl-engine/lib/intersectorUtilsConversions","../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";function _(e,t,r){return t.getIntersectionPoint(M)?(r=w(e,M,r),t.intersector===f.IntersectorType.TERRAIN&&e.basemapTerrain&&(r.z=d.getElevationAtPoint(e.basemapTerrain,r)??0),r):null}function b(e){const t=e.sourceLayer,r=e.layer,i=t&&"objectIdField"in t?t:r&&"objectIdField"in r?r:t;if(i){const t=i.objectIdField??l.fallbackObjectIDAttribute,r=e.attributes?.[t];if(r)return`o-${i.id}-${r}`}return`u-${e.uid}`}function v(e,t){return S(e,b(t))}function S(e,t){return null==e||(null==e.include||e.include.has(t))&&(null==e.exclude||!e.exclude.has(t))}function w(e,t,r){let i=e.spatialReference||o.WGS84;return a.projectVectorToVector(t,e.renderSpatialReference,M,i)?t=M:(i=o.WGS84,a.projectVectorToVector(t,e.renderSpatialReference,M,i)&&(t=M)),r?(r.x=t[0],r.y=t[1],r.z=t[2],r.spatialReference=i):r=new n(t,i),r}function x(e,t){const r=T(e,t.include,R.INCLUDE),i=T(e,t.exclude,R.EXCLUDE);return{include:r.layerViewUids,exclude:i.layerViewUids,graphics:{include:r.graphicUids,exclude:i.graphicUids},mediaElements:{include:r.mediaElements,exclude:i.mediaElements}}}function T(e,i,s,n={layerViewUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!i)return n;if(i instanceof t)!function(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}(n,b(i)),s===R.INCLUDE&&(null!=e.graphicsView&&i.layer===e?P(n,e.graphicsView.uid):i.layer&&C(n,e,i.layer.uid));else if("layer"in i&&"element"in i)!function(e,t){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(t)}(n,i.element),s===R.INCLUDE&&C(n,e,i.layer.uid);else if(r.isIterable(i))for(const t of i)t===e.graphics&&null!=e.graphicsView?P(n,e.graphicsView.uid):t===e.map.ground?P(n,y.terrainId):T(e,t,s,n);else"uid"in i&&C(n,e,i.uid);return n}function C(e,t,r){const i=t.allLayerViews.find((e=>e.layer.uid===r));i&&P(e,i.uid)}function P(e,t){e.layerViewUids||(e.layerViewUids=new Set),e.layerViewUids.add(t)}const M=s.create();var R;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(R||(R={})),e.computeMapPointFromVec3d=w,e.externalToInternalIntersectOptions=x,e.getGraphicFilterUid=b,e.hitTest=async function(e,t,r,s){const n=r?x(e,r):s,o=i.createScreenPointArray(t.x,t.y);n.requiresGroundFeedback=!0,n.enableDraped=!0;const a=new h.Intersector(e.state.viewingMode);a.options.selectionMode=!0,a.options.store=p.StoreResults.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(o,a,n);const l=await async function(e,t,r){const i=new Array;let s,n=null;const o={defer(e){s=e()}};for(let a=0;a<t.length;a++){const l=t[a],u=g.toOwner(l,e);if(null!=u&&(u===e.map.ground||"type"in u&&c.isIntegratedMeshLayer(u.type)))break;const d=g.toHit(l,e,o)??await s;if(s=null,null==d)continue;if("graphic"===d.type){if(null==n&&a!==t.length-1&&(n=new Set),null!=n){const e=b(d.graphic);if(n.has(e))continue;n.add(e)}if(!v(r,d.graphic))continue}const h=_(e,l),p=l.distanceInRenderSpace;if("media"===d.type){const e=d.element.toSource(h);i.push({...d,mapPoint:h,distance:p,sourcePoint:e})}else i.push({...d,mapPoint:h,distance:p})}return i}(e,a.results.all,n.graphics),d=a.results.ground,f=g.toOwner(d,e),y=null!=f&&"type"in f&&c.isIntegratedMeshLayer(f.type)?f:null,S={screenPoint:t,results:l,ground:{mapPoint:_(e,d),distance:m.isValidIntersectorResult(d)?d.distanceInRenderSpace:0,layer:y}};return u.debugFlags.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(S.intersector=a),S},e.intersectResultToMapPoint=_,e.toMap=function(e,t,r,s){const n=r?x(e,r):s,o=!(!n.graphics?.include&&!n.graphics?.exclude),a=!(!n.mediaElements?.include&&!n.mediaElements?.exclude),l=i.screenPointObjectToArray(t);n.enableDraped=n.include&&!n.include.has(y.terrainId)||n.exclude?.has(y.terrainId);const c=e.sceneIntersectionHelper,u=new h.Intersector(e.state.viewingMode);if(u.options.selectionMode=!0,u.options.store=o||a?p.StoreResults.ALL:p.StoreResults.MIN,u.options.excludeLabels=r?.excludeLabels??!1,c.intersectIntersectorScreen(l,u,n),o||a){for(const t of u.results.all){const r=g.toHit(t,e);if(null==r)return _(e,t);if(o&&("graphic"!==r.type||v(n.graphics,r.graphic)))return _(e,t);if(a&&("media"!==r.type||S(n.mediaElements,r.element)))return _(e,t)}return null}return _(e,u.results.min)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/LayerConstants":function(){define(["exports"],(function(e){"use strict";e.fallbackObjectIDAttribute="OBJECTID",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/intersectorUtilsConversions":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../chunks/sphere","../../layers/i3s/Intersector","../../terrain/Intersector","./HUDIntersectorResult","./ObjectIntersectorResult","./lodRendering/Intersector"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e,t,r={}){if(null==e)return null;if(l.isObjectIntersectorResult(e)||a.isHUDIntersectorResult(e))return d(e.target?.object,t,r);if(n.isPclIntersectorResult(e)){const t=e.target.createGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if(n.isVoxelIntersectorResult(e)){const t=e.target.createVoxelGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if(n.isTiles3DIntersectorResult(e)){const t=e.target.createTiles3DGraphic();return{type:"graphic",graphic:t,layer:t.layer}}return o.isOverlayIntersectorResult(e)||c.isLodIntersectorResult(e)?d(e.target,t,r):n.isI3sIntersectorResult(e)?function(e,t,r){const i=p(e,t);if(null==i)return null;const s=t.allLayerViews.find((e=>e.layer===i));if(!s||s.suspended||!("getGraphicFromIntersectorTarget"in s))return null;const n=r.defer;return h(s.getGraphicFromIntersectorTarget(e,{defer:n?async e=>n((async()=>h(await e()))):void 0}))}(e.target,t,r):null}function d(e,t,r){if(null==e?.graphicUid)return null;const i=p(e,t);if(null==i)return null;if(i===t.graphics)return null==t.graphicsView||"number"!=typeof e.graphicUid?null:t.graphicsView.getHit(e.graphicUid,r);const s=t.allLayerViews.find((e=>e.layer===i));return!s||s.suspended||null==e.graphicUid?null:"getHit"in s?s.getHit(e.graphicUid,r):null}function h(e){return null!=e?{type:"graphic",graphic:e,layer:e.layer}:null}function p(e,t){return null==e?.layerViewUid?null:null!=t.graphicsView&&e.layerViewUid===t.graphicsView.uid?t.graphics:t.allLayerViews.find((t=>t.uid===e.layerViewUid))?.layer}const m=r.create();e.getIntersectedFeatureBSRadius=function(e,r){if(l.isObjectIntersectorResult(e)||a.isHUDIntersectorResult(e))return s.getRadius(e.target.object.boundingVolumeWorldSpace.bounds);if(c.isLodIntersectorResult(e)){t.getScale(m,e.transformation);const r=Math.max(m[0],m[1],m[2]);return e.target.baseBoundingSphere.radius*r}if(n.isI3sIntersectorResult(e)){const t=function(e,t){const r=p(e,t);if(null==r)return null;const i=t.allLayerViews.find((e=>e.layer===r));return i&&!i.suspended&&"getAABBFromIntersectorTarget"in i?i.getAABBFromIntersectorTarget(e):null}(e.target,r);return t?.5*i.diameter(t):null}return null},e.hasLod=function(e){return!l.isObjectIntersectorResult(e)&&!a.isHUDIntersectorResult(e)&&(c.isLodIntersectorResult(e)?e.target.numLodLevels>1:!!n.isI3sIntersectorResult(e))},e.toGraphic=function(e,t){const r=u(e,t);return"graphic"===r?.type?r.graphic:null},e.toHit=u,e.toOwner=function(e,t){return l.isObjectIntersectorResult(e)||a.isHUDIntersectorResult(e)?p(e.target?.object,t):o.isTerrainIntersectorResult(e)?t.map?.ground:n.isPclIntersectorResult(e)||n.isI3sIntersectorResult(e)||o.isOverlayIntersectorResult(e)||n.isVoxelIntersectorResult(e)?p(e.target,t):null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/Intersector":function(){define(["exports","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/IntersectorTarget","../../webgl-engine/lib/IntersectorType"],(function(e,t,r,i){"use strict";class s extends r.Graphic3DTarget{constructor(e,t,r,i){super(t,r),this.point=e,this.createGraphic=i}}class n extends r.LayerTarget{constructor(e,t,r,i,s){super(e),this.layerViewUid=e,this.sublayerId=t,this.nodeIndex=r,this.componentIndex=i,this.triangleNr=s}}class o extends r.Graphic3DTarget{constructor(e,t,r){super(t,null),this.point=e,this.createVoxelGraphic=r}}class a extends r.Graphic3DTarget{constructor(e,t){super(e,null),this.createTiles3DGraphic=t}}e.I3sTarget=n,e.PclTarget=s,e.Tiles3DTarget=a,e.VoxelTarget=o,e.isI3sIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&e.intersector===i.IntersectorType.I3S&&!!e.target},e.isPclIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&e.intersector===i.IntersectorType.PCL&&!!e.target},e.isTiles3DIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&e.intersector===i.IntersectorType.TILES3D&&!!e.target},e.isVoxelIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&e.intersector===i.IntersectorType.VOXEL&&!!e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/Intersector":function(){define(["exports","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/IntersectorTarget","../webgl-engine/lib/IntersectorType"],(function(e,t,r,i){"use strict";class s extends r.Graphic3DTarget{constructor(e,t,r){super(e,t),this.triangleNr=r}}e.OverlayTarget=s,e.isOverlayIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&e.intersector===i.IntersectorType.OVERLAY&&!!e.target},e.isTerrainIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&e.intersector===i.IntersectorType.TERRAIN&&!!e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ObjectIntersectorResult":function(){define(["exports","./IntersectorResult","./IntersectorType"],(function(e,t,r){"use strict";e.isObjectIntersectorResult=function(e){return t.isValidIntersectorResult(e)&&e.intersector===r.IntersectorType.OBJECT&&!!e.target},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/intersectorUtils":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/boundedPlane"],(function(e,t,r,i){"use strict";const s=r.create();e.sliceFilterPredicate=function(e){return(r,n,o)=>!i.extrusionContainsPoint(e,t.lerp(s,r,n,o))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/CombinedElevationProvider":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Evented","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/SpatialReference","../../../geometry/support/spatialReferenceUtils","../layers/graphics/ElevationQuery","./ElevationRange"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";function f(e,t,r,i,s,n,o){for(const a of t){const t=a.getElevation(r,i,s,n,o);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}e.CombinedElevationProvider=class extends(i.EventedMixin(r)){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=s.destroyMaybe(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,r,i,s){if(this._cacheEnabled&&null!=this.lastElevationQuery){const n=this.lastElevationQuery;if(e===n.x&&t===n.y&&r===n.z&&h.equals(i,n.spatialReference)&&s===n.queryContext)return n.result}let n=null;return n=f(n,this._im,e,t,r,i,s),null==n&&(n=f(n,this._ground,e,t,r,i,s)),"scene"===s&&(n=f(n,this._scene,e,t,r,i,s)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:r,spatialReference:i,queryContext:s,result:n}),n}getSphereElevationBounds(e,t,r){const i=new m.ElevationRange;function s(s){for(const n of s)if(n.getSphereElevationBounds){const s=n.getSphereElevationBounds(e,t,r);null!=s&&i.expandElevationRangeValues(s.elevationRangeMin,s.elevationRangeMax)}}return s(this._ground),s(this._im),"scene"===r&&s(this._scene),i}getRootElevationBounds(){const e=new m.ElevationRange;for(const t of[this._im,this._ground,this._scene])t.forEach((t=>{if(t.getRootElevationBounds){const r=t.getRootElevationBounds();null!=r&&e.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}}));return e}async queryElevation(e,t,r,i,s,o=null,a=0){const l=this._getElevationQuery(i);try{const n=await l.queryElevation(e,t,o,a);return"scene"===s?f(n,this._scene,e,t,r,i,s):n}catch(o){return n.throwIfAbortError(o),this.getElevation(e,t,r,i,s)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const r=t.indexOf(e);r>-1&&t.splice(r,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(null!=t&&h.equals(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:r,wkt:i,wkt2:s,latestWkid:n}=e,o=new p.ElevationQuery(this.view.resourceController.scheduler,new d({wkid:r,wkt:i,wkt2:s,latestWkid:n}),(()=>this.view.map?.ground),{maximumAutoTileRequests:4});return this._cachedQuery=o,o}},t.__decorate([o.property({constructOnly:!0})],e.CombinedElevationProvider.prototype,"view",void 0),t.__decorate([o.property()],e.CombinedElevationProvider.prototype,"spatialReference",null),e.CombinedElevationProvider=t.__decorate([u.subclass("esri.views.3d.support.CombinedElevationProvider")],e.CombinedElevationProvider),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/ElevationQuery":function(){define(["exports","../../../../core/arrayUtils","../../../../core/has","../../../../core/promiseUtils","../../../../geometry/Multipoint","../../../support/Scheduler"],(function(e,t,r,i,s,n){"use strict";e.ElevationQuery=class{constructor(e,t,r,i){this.spatialReference=t,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions={...i,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(n.TaskPriority.ELEVATION_QUERY,this)}destroy({completeTasks:e}={completeTasks:!1}){if(this._frameTask.remove(),this.running)if(e)this.runTask(n.noBudget);else for(const e of this._queries)e.result.reject(i.createAbortError())}queryElevation(e,r,s,n=0){const o=i.createResolver(),a={x:e,y:r,minDemResolution:n,result:o,signal:s};return this._queries.push(a),i.onAbort(s,(()=>{t.remove(this._queries,a),o.reject(i.createAbortError())})),o.promise}get running(){return this._queries.length>0}runTask(e){const t=this._queries;this._queries=[];const r=this._getElevationQueryProvider();if(!r)return t.forEach((e=>e.result.reject())),void e.madeProgress();const n=t.map((e=>[e.x,e.y])),o=t.reduce(((e,t)=>Math.min(e,t.minDemResolution)),1/0),a=new s({points:n,spatialReference:this.spatialReference}),l=t.length>1&&t.some((e=>!!e.signal))?new AbortController:null,c=null!=l?l.signal:t[0].signal;if(null!=l){let e=0;t.forEach((r=>i.onAbort(r.signal,(()=>{e++,r.result.reject(i.createAbortError()),e===t.length&&l.abort()}))))}const u={...this._queryOptions,minDemResolution:o,signal:c};r.queryElevation(a,u).then((e=>{t.forEach(((t,r)=>{null!=t.signal&&t.signal.aborted?t.result.reject(i.createAbortError()):t.result.resolve(e.geometry.points[r][2])}))})).catch((e=>{t.forEach((t=>t.result.reject(e)))})),e.madeProgress()}get test(){}},e.ViewElevationProvider=class{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,r){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}async queryElevation(e,t,r,i,s){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,s,r,i)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/ElevationRange":function(){define(["exports"],(function(e){"use strict";e.ElevationRange=class{constructor(e=1/0,t=-1/0){this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/DisplayQualityProfile":function(){define(["../../../core/has","../../../core/time"],(function(e,t){"use strict";class r{static isValidProfile(e){return e in r.profiles}static getDefaultProfile(){return e("esri-iPhone")?"low":"medium"}static apply(e,t){const i=r.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const s=t.sceneService.object,n=i.sceneService.object;s.lodFactor=n.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.maxTexturePixels=i.maxTexturePixels,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}static{this.test={reset(){const e=s();for(const t of Object.keys(e))r.profiles[t]=e[t]}}}}const i={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function s(){const r=!!e("esri-mobile"),s=!!e("ios"),n=t.Milliseconds(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5}},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:t.Milliseconds(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:r?1048576:4194304,memoryLimit:200+i.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:r?.8:1,polylineLodFactor:r?1.2:1.5,snapshotAvailable:!s,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!e("disable-feature:reduce-map-tile-levels")},fadeDuration:n,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:r?4194304:4096**2,memoryLimit:r?600+i.GalaxyS20:750+i.FullHD,additionalCacheMemory:r?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:r?1.2:2,polylineLodFactor:r?1.2:2,snapshotAvailable:!s,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!e("disable-feature:reduce-map-tile-levels")},fadeDuration:n,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,maxTexturePixels:r?4096**2:1/0,memoryLimit:r?900+i.SurfacePro7:1500+i.FullHDRetina,additionalCacheMemory:r?-150:0,frameRate:0,maximumPixelRatio:r?1:1/0}}}return function(e){e.profiles=s()}(r||(r={})),r}))},"esri/views/3d/support/popupHitTest":function(){define(["exports","../../../layers/support/layerUtils","../terrain/LayerClass","../../support/hitTestSelectUtils"],(function(e,t,r,i){"use strict";const s={layerUids:new Set,layerViews:[]};e.popupHitTest=async function(e,n){const{results:o,ground:a}=await i.hitTestSelectSimilarDistance(e,n),l=(!a.layer||!t.isIntegratedMeshLayer(a.layer.type))&&a.mapPoint,c=[],u=function(e){const t=new Map;for(const r of e.allLayerViews){const e=r.layer.uid;t.set(e,r)}return t}(e),d=l?function(e,t){const i=new Set,s=new Set;for(let t=e.basemapTerrain.numLayers(r.LayerClass.MAP)-1;t>=0;t--){const n=e.basemapTerrain.layerViewByIndex(t,r.LayerClass.MAP);i.add(n.layer.uid),s.add(n)}const n=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:e}of n){const r=t.get(e);r&&(i.add(e),s.add(r))}return{layerUids:i,layerViews:Array.from(s).reverse()}}(e,u):s;let h=0,p=0;const m=()=>{const e=d.layerViews[p];l&&e&&"fetchPopupFeaturesAtLocation"in e&&c.push({mapPoint:a.mapPoint,layerView:e}),++p};let f=null;for(;h<o.length||p<d.layerViews.length;){const t=o[h];if(t&&"graphic"!==t.type)++h;else if("scene"!==t?.layer?.type||t?.layer?.parent!==e?.map?.basemap)if(t){const e=t.layer?.uid,r=d.layerUids.has(e)&&t.distance===a.distance,i=u.get(t.layer?.uid);if(f??=t.mapPoint,p<d.layerViews.length&&(r||(t.distance??0)>a.distance)&&d.layerViews[p]!==i){m();continue}c.push({graphic:t.graphic,layerView:i}),++h}else m();else++h}return f??=a.mapPoint,{hits:c,location:f}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/LayerClass":function(){define(["exports"],(function(e){"use strict";var t;e.LayerClass=void 0,(t=e.LayerClass||(e.LayerClass={}))[t.ELEVATION=0]="ELEVATION",t[t.MAP=1]="MAP";const r=[e.LayerClass.ELEVATION,e.LayerClass.MAP];e.LayerClasses=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/hitTestSelectUtils":function(){define(["exports"],(function(e){"use strict";function t(e){return"graphic"===e?.type}e.filterGraphicHits=function(e){return e.filter(t)},e.findFirstGraphicHit=function(e){return e.find(t)??null},e.hitTestSelectSimilarDistance=async function(e,t){if("2d"===e.type)return e.hitTest(t);const r=await e.hitTest(t);if(0===r.results.length)return r;const i=r.results[0],s=1.05*(i.distance??0),n=r.results.findIndex((e=>(e.distance??0)>s));return-1!==n&&(r.results=r.results.slice(0,n)),i&&r.ground.distance>s&&(r.ground.mapPoint=null),r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/QualitySettings":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";let l=class extends t{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};e.__decorate([i.property()],l.prototype,"minTotalNumberOfFeatures",void 0),e.__decorate([i.property()],l.prototype,"maxTotalNumberOfFeatures",void 0),e.__decorate([i.property()],l.prototype,"maxNumberOfDrawCalls",void 0),e.__decorate([i.property()],l.prototype,"maxTotalNumberOfVertices",void 0),e.__decorate([i.property()],l.prototype,"snapshotAvailable",void 0),e.__decorate([i.property()],l.prototype,"polygonLodFactor",void 0),e.__decorate([i.property()],l.prototype,"polylineLodFactor",void 0),e.__decorate([i.property()],l.prototype,"skipHighSymbolLods",void 0),l=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.Graphics3DSettings")],l);let c=class extends t{constructor(){super(...arguments),this.lodFactor=1}};e.__decorate([i.property()],c.prototype,"lodFactor",void 0),c=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.LoDFactorSettings")],c);let u=class extends t{constructor(){super(...arguments),this.object=new c,this.point=new c,this.integratedMesh=new c,this.pointCloud=new c}};e.__decorate([i.property({type:c})],u.prototype,"object",void 0),e.__decorate([i.property({type:c})],u.prototype,"point",void 0),e.__decorate([i.property({type:c})],u.prototype,"integratedMesh",void 0),e.__decorate([i.property({type:c})],u.prototype,"pointCloud",void 0),u=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.SceneServiceSettings")],u);let d=class extends t{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};e.__decorate([i.property()],d.prototype,"lodBias",void 0),e.__decorate([i.property()],d.prototype,"angledSplitBias",void 0),e.__decorate([i.property()],d.prototype,"vtlContentZoom",void 0),e.__decorate([i.property()],d.prototype,"elevationLevelDelta",void 0),e.__decorate([i.property()],d.prototype,"reduceTileLevelDifferences",void 0),d=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],d);let h=class extends t{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};e.__decorate([i.property()],h.prototype,"pixelRatio",void 0),e.__decorate([i.property()],h.prototype,"maxTotalNumberOfFeatures",void 0),h=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings.HeatmapSettings")],h);let p=class extends t{constructor(){super(...arguments),this.graphics3D=new l,this.sceneService=new u,this.tiledSurface=new d,this.heatmap=new h,this.fadeDuration=r.Milliseconds(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.bloom=!1,this.maxTexturePixels=1/0,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};return e.__decorate([i.property({type:l})],p.prototype,"graphics3D",void 0),e.__decorate([i.property({type:u})],p.prototype,"sceneService",void 0),e.__decorate([i.property({type:d})],p.prototype,"tiledSurface",void 0),e.__decorate([i.property({type:h})],p.prototype,"heatmap",void 0),e.__decorate([i.property()],p.prototype,"fadeDuration",void 0),e.__decorate([i.property()],p.prototype,"antialiasingEnabled",void 0),e.__decorate([i.property()],p.prototype,"physicallyBasedRenderingEnabled",void 0),e.__decorate([i.property()],p.prototype,"highQualityTransparency",void 0),e.__decorate([i.property()],p.prototype,"highResolutionAtmosphere",void 0),e.__decorate([i.property()],p.prototype,"reflections",void 0),e.__decorate([i.property()],p.prototype,"ambientOcclusion",void 0),e.__decorate([i.property()],p.prototype,"bloom",void 0),e.__decorate([i.property()],p.prototype,"maxTexturePixels",void 0),e.__decorate([i.property()],p.prototype,"memoryLimit",void 0),e.__decorate([i.property()],p.prototype,"additionalCacheMemory",void 0),e.__decorate([i.property()],p.prototype,"frameRate",void 0),e.__decorate([i.property()],p.prototype,"maximumPixelRatio",void 0),p=e.__decorate([a.subclass("esri.views.3d.support.QualitySettings")],p),p}))},"esri/views/3d/support/RenderCoordsHelper":function(){define(["exports","../../../core/mathUtils","../../../core/unitUtils","../../../core/libs/gl-matrix-2/math/mat4","../../../chunks/vec32","../../../geometry/ellipsoidUtils","../../../geometry/spatialReferenceEllipsoidUtils","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToPoint","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingRect","../../../geometry/support/Axis","../../../geometry/support/coordinateSystem","../../../geometry/support/plane","../../../geometry/support/vector","../../../geometry/support/vectorStacks","../../../layers/graphics/dehydratedFeatureUtils","../../ViewingMode"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";class _{constructor(e,t,r,i){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=r,this._coordinateSystem=i,this._tmpCoordinateSystem=h.create(i),this.referenceEllipsoid=n.getReferenceEllipsoid(t),this.sphericalPCPF=o.getSphericalPCPF(t)}set extent(e){e&&h.setExtent(this._coordinateSystem,e,this._coordinateSystem)}get extent(){return h.getExtent(this._coordinateSystem,u.create())}getAltitude(e){return h.altitudeAt(this._coordinateSystem,e)}setAltitude(e,t,r=e){return h.setAltitudeAt(this._coordinateSystem,r,t,e)}setAltitudeOfTransformation(e,t){h.setAltitudeOfTransformation(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return h.normalAt(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,r){return h.axisAt(this._coordinateSystem,e,t,r)}basisMatrixAtPosition(e,t){const r=this.worldBasisAtPosition(e,d.Axis.X,f.sv3d.get()),s=this.worldBasisAtPosition(e,d.Axis.Y,f.sv3d.get()),n=this.worldBasisAtPosition(e,d.Axis.Z,f.sv3d.get());return i.set(t,r[0],r[1],r[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),t}headingAtPosition(e,r){const i=this.worldUpAtPosition(e,f.sv3d.get()),s=this.worldBasisAtPosition(e,d.Axis.Y,f.sv3d.get()),n=m.angleAroundAxis(r,s,i);return t.rad2deg(n)}intersectManifoldClosestSilhouette(e,t,r){return h.elevate(this._coordinateSystem,t,this._tmpCoordinateSystem),h.intersectRayClosestSilhouette(this._tmpCoordinateSystem,e,r),r}intersectManifold(e,t,r){h.elevate(this._coordinateSystem,t,this._tmpCoordinateSystem);const i=f.sv3d.get();return h.intersectRay(this._tmpCoordinateSystem,e,i)?s.copy(r,i):null}intersectInfiniteManifold(e,t,r){if(this.viewingMode===y.ViewingMode.Global)return this.intersectManifold(e,t,r);h.elevate(this._coordinateSystem,t,this._tmpCoordinateSystem);const i=this._tmpCoordinateSystem.value,n=f.sv3d.get();return p.intersectRay(i.plane,e,n)?s.copy(r,n):null}toRenderCoords(e,t,r){return g.isDehydratedPoint(e)?a.projectPointToVector(e,t,this.spatialReference):c.projectVectorToVector(e,t,r,this.spatialReference)}fromRenderCoords(e,t,r=null){return g.isDehydratedPoint(t)?(null!=r&&(t.spatialReference=r),l.projectVectorToPoint(e,this.spatialReference,t)?t:null):c.projectVectorToVector(e,this.spatialReference,t,r)?t:null}static create(e,t){switch(e){case y.ViewingMode.Local:return new _(y.ViewingMode.Local,t,r.getMetersPerUnitForSR(t),h.createLocal());case y.ViewingMode.Global:return new _(y.ViewingMode.Global,t,1,h.createGlobal(t))}}static renderUnitScaleFactor(e,t){return r.getMetersPerCartesianUnitForSR(e)/r.getMetersPerCartesianUnitForSR(t)}}e.RenderCoordsHelper=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/ResourceController":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/handleUtils","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/scheduling","../../../core/signal","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./index","./MemoryController","./StreamDataLoader","../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";let _=class extends r{constructor(){super(...arguments),this.updating=!1}};t.__decorate([u.property({readOnly:!0})],_.prototype,"updating",void 0),_=t.__decorate([p.subclass("esri.views.3d.support.ResourceController.ResourceControllerMain")],_);let b=class extends _{constructor(){super(...arguments),this._immediateTask=y.ImmediateTask,this._normalTask=y.ImmediateTask,this._updatingObjects=l.signal([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=y.newScheduler(),this._memoryController=f.newMemoryController(this.view),this._streamDataLoader=new g.StreamDataLoader,this._streamDataLoader.setup(m.maxDownloadSlots,m.downloadSlotsPerClient,this._scheduler),this.addHandles([o.watch((()=>this.view.state?.mode),(e=>{null!=e&&(this._scheduler.state=e)}),o.sync),o.watch((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=a.addFrameTask({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(y.TaskPriority.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(y.TaskPriority.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=n.removeMaybe(this._frameTask),this._streamDataLoader=n.destroyMaybe(this._streamDataLoader),this._memoryController=n.destroyMaybe(this._memoryController),this._scheduler=n.destroyMaybe(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some((e=>e.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(r,i,s)=>t.request(r,i,e,s),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],i.makeHandle((()=>{t.value=t.value.filter((t=>t!==e))}))}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(c.secondsFromMilliseconds(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};t.__decorate([u.property()],b.prototype,"view",void 0),t.__decorate([u.property()],b.prototype,"_scheduler",void 0),t.__decorate([u.property()],b.prototype,"_memoryController",void 0),t.__decorate([u.property()],b.prototype,"_streamDataLoader",void 0),t.__decorate([u.property()],b.prototype,"_immediateTask",void 0),t.__decorate([u.property()],b.prototype,"_normalTask",void 0),t.__decorate([u.property({readOnly:!0})],b.prototype,"updating",null),b=t.__decorate([p.subclass("esri.views.3d.support.ResourceController")],b),e.newResourceController=function(e){return new b({view:e})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/index":function(){define(["exports"],(function(e){"use strict";var t;e.ClientType=void 0,(t=e.ClientType||(e.ClientType={}))[t.ELEVATION=0]="ELEVATION",t[t.BASEMAP=1]="BASEMAP",t[t.I3S_INDEX=2]="I3S_INDEX",t[t.I3S_DATA=3]="I3S_DATA",t[t.SYMBOLOGY=4]="SYMBOLOGY";const r=(()=>{const t=new Array;return t[e.ClientType.ELEVATION]=10,t[e.ClientType.BASEMAP]=10,t[e.ClientType.I3S_INDEX]=10,t[e.ClientType.I3S_DATA]=10,t[e.ClientType.SYMBOLOGY]=5,t})();e.downloadSlotsPerClient=r,e.maxDownloadSlots=30,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/MemoryController":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/Logger","../../../core/MemCache","../../../core/scheduling","../../../core/time","../../../core/accessorSupport/decorators/property","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./MemoryManagedView","../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";let p=class extends r{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._predictedMemory=0,this._cacheStorage=new n.MemCacheStorage,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles(o.addFrameTask({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t,r){return new n.MemCache(e,this._cacheStorage,t,r)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._predictedMemory<=0&&!this._updating)return;let e=this._layersUpdating();if(this._predictedMemory<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e){if(this._predictedMemory>1.1||this._usedMemory>1)if(this._stableQuality>0)this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality);else if(this._quality>.1&&this._downscaleMemoryUsed<this._usedMemory){if(this._compactAndUpdate())return;this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1}}else if(this._downscaleMemoryUsed=0,this._usedMemory>1){if(this._compactAndUpdate())return;this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._predictedMemory}else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_compactAndUpdate(){const e=h.makeBudget(a.Milliseconds(100)),t=this.view.stage.compact(e);return this.view.basemapTerrain.overlayManager.renderer.compact(e)||t}_updateQuality(e){return(e=Math.min(Math.max(e,.1),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){if(!this.view)return;this.view.stage?.renderer?.tick();const e=this.view.stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0),r=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(d.isMemoryManagedView(e)){const i=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*i,r+=e.unloadedMemory*i}}));const i=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),n=1048576*this.maxMemory;if(t>n&&i){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",i=Math.round(100*this._quality);s.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(n)} Current: ${e(t)} Projected: ${e(t+r)} Quality: ${i}%`)}this._usedMemory=t/n,this._predictedMemory=(t+r)/n;const o=n-t;this._cacheStorage.maxSize=Math.max(0,o+1048576*this.additionalCacheMemory)}get test(){}};t.__decorate([l.property({constructOnly:!0})],p.prototype,"view",void 0),t.__decorate([l.property()],p.prototype,"maxMemory",null),t.__decorate([l.property()],p.prototype,"additionalCacheMemory",null),t.__decorate([l.property({readOnly:!0})],p.prototype,"memoryFactor",null),t.__decorate([l.property({readOnly:!0})],p.prototype,"updating",null),t.__decorate([l.property({readOnly:!0})],p.prototype,"usedMemory",null),t.__decorate([l.property({readOnly:!0})],p.prototype,"usedCacheMemory",null),t.__decorate([l.property()],p.prototype,"_quality",void 0),t.__decorate([l.property()],p.prototype,"_usedMemory",void 0),t.__decorate([l.property()],p.prototype,"_updating",void 0),t.__decorate([l.property()],p.prototype,"_stableQuality",void 0),t.__decorate([l.property()],p.prototype,"_maxMemory",void 0),t.__decorate([l.property()],p.prototype,"_additionalCacheMemory",void 0),p=t.__decorate([u.subclass("esri.views.3d.support.MemoryController")],p),e.minQuality=.1,e.newMemoryController=function(e){return new p({view:e})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/MemoryManagedView":function(){define(["exports"],(function(e){"use strict";e.isMemoryManagedView=function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/StreamDataLoader":function(){define(["exports","../../../chunks/tslib.es6","../../../request","../../../core/Accessor","../../../core/arrayUtils","../../../core/Error","../../../core/has","../../../core/lang","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","./AsyncWorkerQueue","./ImageWithType","../terrain/TerrainData","../webgl-engine/lib/Util","../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";e.StreamDataLoader=class extends i{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,r){this._loadQueue=new p.AsyncWorkerQueue(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),r&&(this._frameTask=r.registerTask(y.TaskPriority.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=l.removeMaybe(this._frameTask),this._tasks.forEach((e=>l.abortMaybe(e.abortController))),this._loadQueue=l.destroyMaybe(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,r,i={}){const s=c.createResolver();s.__signal=null!=i?i.signal:null;const n=this._createOrUpdateTask(e,t,r,i,s);return c.onAbort(i,(()=>this._cancelRequest(n,s))),s.promise}_createTask(e,t,r,i,s,n){const o=new b(e,t,r,i,s);return this._updateTask(o,n),this._tasks.set(s,o),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(t,r){s.removeUnordered(t.resolvers,r),r.reject(c.createAbortError()),0===t.resolvers.length&&(t.status===e.TaskStatus.DOWNLOADING&&(t.status=e.TaskStatus.CANCELLED,this._loadQueue.cancel(t),t.abortController?.abort(),t.request=null,t.abortController=null),t.status=e.TaskStatus.CANCELLED,this._tasks.delete(t.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,r,i,s){const n=function(e,t,r){return`${e}:${t}:${r}`}(i?.uid||e,t,r),o=this._tasks.get(n);return o?(this._updateTask(o,s),o):this._createTask(e,i,t,r,n,s)}_doneLoadingCB(t,r){this._loadQueue&&(g.assert(t.status===e.TaskStatus.DOWNLOADING),t.status=e.TaskStatus.DOWNLOADED,this._frameTask?this._doneQueue.push({task:t,err:r}):this._doneLoading(t,r))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(t){for(;!t.done&&this._onLoadQueue.length>0;){const e=this._onLoadQueue.shift();c.throwIfAborted(e.task.abortController),e.task.abortController=null,e.callback(e.task),t.madeProgress()}for(;!t.done&&this._doneQueue.length>0;){const r=this._doneQueue.shift();r.task.status!==e.TaskStatus.DOWNLOADED&&(r.err=r.err||c.createAbortError()),this._doneLoading(r.task,r.err),t.madeProgress()}}_doneLoading(e,t){if(t&&!c.isAbortError(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let r=f.isImageWithType(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const i of e.resolvers)if(t)c.isAbortError(t)?i.reject(t):i.reject(new n("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--r;const t=r>0?a.clone(e.result):e.result;i.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(t,i){if(t.status===e.TaskStatus.CANCELLED)return!1;let s,n;switch(t.startTime=performance.now(),t.status=e.TaskStatus.DOWNLOADING,t.docType){case"binary":n="array-buffer",s=0;break;case"image":n="image";break;case"image+type":n="array-buffer";break;default:n="json"}t.abortController=new AbortController;const o=t.abortController.signal;t.request=r(t.url,{...t.options,responseType:n,timeout:s,signal:o});const a=e=>{t.duration=performance.now()-t.startTime,t.size=e instanceof ArrayBuffer?e.byteLength:t.size||0,t.result=e,this._frameTask?this._onLoadQueue.push({callback:i,task:t}):(t.abortController=null,i(t))},l=r=>{t.status===e.TaskStatus.DOWNLOADING&&i(t,r)};return"image+type"!==t.docType?(t.request.then((e=>a(e.data)),l),!0):(t.request.then((e=>{const i=e.data,c=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(i);if(n="image",t.size=i.byteLength,"unknown"===c)return t.request=r(t.url,{responseType:n,timeout:s,signal:o}),void t.request.then((e=>a(e.data)),l);const u=new Blob([i],{type:c}),d=window.URL.createObjectURL(u);t.request=r(d,{responseType:n,timeout:s,signal:o}),t.request.then((e=>a(new m.ImageWithType(e.data,c))),l).finally((()=>window.URL.revokeObjectURL(d)))}),l),!0)}get test(){}},t.__decorate([u.property({readOnly:!0})],e.StreamDataLoader.prototype,"updating",void 0),e.StreamDataLoader=t.__decorate([h.subclass("esri.views.3d.support.StreamDataLoader")],e.StreamDataLoader);const _={numRetries:0};class b extends p.BaseTask{constructor(t,r,i,s,n){super(s),this.url=t,this.options=r,this.docType=i,this.key=n,this.result=null,this.status=e.TaskStatus.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=_.numRetries}}var v;e.TaskStatus=void 0,(v=e.TaskStatus||(e.TaskStatus={}))[v.QUEUED=1]="QUEUED",v[v.DOWNLOADING=2]="DOWNLOADING",v[v.DOWNLOADED=3]="DOWNLOADED",v[v.CANCELLED=4]="CANCELLED",e.test=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/AsyncWorkerQueue":function(){define(["exports","../../../core/has","../webgl-engine/lib/Util"],(function(e,t,r){"use strict";class i{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new s}}class s{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}e.AsyncWorkerQueue=class{constructor(e,t,r,s){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=s.map((e=>new i(e)))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,r.assert(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}},e.BaseTask=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/ImageWithType":function(){define(["exports"],(function(e){"use strict";e.ImageWithType=class{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque="image/jpeg"===t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TerrainData":function(){define(["exports"],(function(e){"use strict";e.isImageWithType=function(e){return null!=e&&"type"in e&&"image+type"===e.type},e.isRasterTile=function(e){return null!=e&&"type"in e&&"raster-tile"===e.type},e.isTileTexture=function(e){return null!=e&&"type"in e&&"tile-texture"===e.type},e.isVectorTile=function(e){return null!=e&&"type"in e&&"vector-tile"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/SceneViewPerformanceInfo":function(){define(["../../../core/ByteSizeUnit","../layers/support/LayerViewPerformanceInfo","./LayerPerformanceInfo"],(function(e,t,r){"use strict";return class{constructor(i){if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,null!=i.resourceController){const t=i.resourceController.memoryController;this.totalMemory=(t.maxMemory??0)*e.ByteSizeUnit.MEGABYTES,this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=i.quality,this.load=i.resourceController.scheduler.load,this.cachedMemory=t.usedCacheMemory}this.terrainMemory=i.basemapTerrain?.usedMemory??0,this.edgesMemory=i.stage?.renderer.usedMemory.edges??0,this.fboMemory=i.stage?.renderer.usedMemory.fbos??0,i.allLayerViews?.items.forEach((e=>{t.isPerformanceInfoLayerView(e)&&this.layerPerformanceInfos.push(new r(e))})),this.layerPerformanceInfos.sort(((e,t)=>t.memory-e.memory))}}}))},"esri/views/3d/layers/support/LayerViewPerformanceInfo":function(){define(["exports"],(function(e){"use strict";e.LayerViewPerformanceInfo=class{constructor(e,t=0,r=0,i=0,s=0,n=null){this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=r,this.maximumFeatures=i,this.nodes=s,this.core=n}},e.isPerformanceInfoLayerView=function(e){return"performanceInfo"in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/LayerPerformanceInfo":function(){define((function(){"use strict";return class{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}}}))},"esri/views/3d/support/SharedSymbolResources":function(){define(["exports","../../../core/arrayUtils","../../../core/Handles","../../../core/handleUtils","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../geometry/ellipsoidUtils","../layers/graphics/ObjectResourceCache","./index","./StreamTextureCollection","../webgl-engine/lib/screenSizePerspectiveUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h={distance:0,fovY:0};e.SharedSymbolResources=class{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(c.ClientType.SYMBOLOGY),this.objectResourceCache=new l.ObjectResourceCache(((t,r)=>e.resourceController.memoryController.newCache(t,r))),this.textures=new u.StreamTextureCollection(this.streamDataRequester,e.view.stage,e.resourceController.scheduler);const t=a.getReferenceEllipsoid(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=d.getSettings(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=d.getLabelSettings(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return i.makeHandle();this._graphicsOwners.push(e);const r=o.watch((()=>e.layer?.screenSizePerspectiveEnabled),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),i.makeHandle((()=>{r.remove(),t.removeUnordered(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some((e=>!0===e.layer?.screenSizePerspectiveEnabled));if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new r;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([o.watch((()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance),e,o.sync),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=n.destroyMaybe(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;h.distance=e.centerOnSurfaceInfrequent.distance,h.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(h),this.screenSizePerspectiveSettingsLabels.update(h),this._view.stage.renderView.requestRender()}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/ObjectResourceCache":function(){define(["require","exports","../../../../core/maybe","../../../../core/promiseUtils","../../glTF/DefaultLoadingContext","./wosrLoader"],(function(e,t,r,i,s,n){"use strict";async function o(e,t,s,n,o){i.throwIfAborted(o);const a=i.onAbort(o,(()=>function(e,t){const r=e.get(t);null!=r&&--r.refCount>0||(e.delete(t),null!=r&&r.abortController.abort())}(e,s)));let l=e.get(s);if(l)l.refCount++;else{const t=new AbortController;l={refCount:1,abortController:t,promise:n({...o,signal:t.signal})},e.set(s,l)}try{const r=await l.promise;return t.put(s,r),e.delete(s),i.throwIfAborted(o),r}finally{r.removeMaybe(a)}}t.ObjectResourceCache=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",(()=>{})),this._wosrMemCache=e("wosr-resources",(()=>{}))}destroy(){this._gltfLoading.forEach((e=>e.abortController.abort())),this._wosrLoading.forEach((e=>e.abortController.abort())),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(t,r,i){const n=i?`gltfPBR:${t}`:`gltf:${t}`,a=this._gltfMemCache.get(n);return null!=a?Promise.resolve(a):o(this._gltfLoading,this._gltfMemCache,n,(async r=>{const{loadGLTF:n}=await new Promise(((t,r)=>e(["../../glTF/loader"],t,r)));return n(new s.DefaultLoadingContext(r.streamDataRequester),t,r,i)}),r)}loadWOSR(e,t){const r=`wosr:${e}:${t.disableTextures}`,i=this._wosrMemCache.get(r);return null!=i?Promise.resolve(i):o(this._wosrLoading,this._wosrMemCache,r,(t=>n.load(e,t)),t)}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/glTF/DefaultLoadingContext":function(){define(["exports","../../../request","../../../core/asyncUtils","../../../core/Error","../../../core/promiseUtils","../../../core/urlUtils"],(function(e,t,r,i,s,n){"use strict";const o={image:"image",binary:"array-buffer",json:"json","image+type":void 0};e.DefaultLoadingContext=class{constructor(e){this._streamDataRequester=e}async loadJSON(e,t){return this._load("json",e,t)}async loadBinary(e,t){return n.isDataProtocol(e)?(s.throwIfAborted(t),n.dataToArrayBuffer(e)):this._load("binary",e,t)}async loadImage(e,t){return this._load("image",e,t)}async _load(e,n,a){if(null==this._streamDataRequester)return(await t(n,{responseType:o[e]})).data;const l=await r.result(this._streamDataRequester.request(n,e,a));if(!0===l.ok)return l.value;throw s.throwIfAbortError(l.error),new i("glt-loader-request-error",`Request for resource failed: ${l.error}`)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/wosrLoader":function(){define(["exports","../../../../request","../../../../core/asyncUtils","../../../../core/Error","../../../../core/Logger","../../../../core/memoryEstimations","../../../../core/NestedMap","../../../../core/promiseUtils","../../../../core/Version","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/Indices","../../../../support/requestImageUtils","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Texture","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/DefaultMaterial","../../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";const v=()=>s.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class S{constructor(e,t,r){this.resource=e,this.textures=t,this.cachedMemory=r}}function w(e){throw new i("",`Request for object resource failed: ${e}`)}function x(e){const t=e.params,r=t.topology;let i=!0;switch(t.vertexAttributes||(v().warn("Geometry must specify vertex attributes"),i=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const e=t.faces;if(e){if(t.vertexAttributes)for(const r in t.vertexAttributes){const t=e[r];t?.values?(null!=t.valueType&&"UInt32"!==t.valueType&&(v().warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),i=!1),null!=t.valuesPerElement&&1!==t.valuesPerElement&&(v().warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),i=!1)):(v().warn(`Indexed geometry does not specify face indices for '${r}' attribute`),i=!1)}}else v().warn("Indexed geometries must specify faces"),i=!1;break}default:v().warn(`Unsupported topology '${r}'`),i=!1}e.params.material||(v().warn("Geometry requires material"),i=!1);const s=e.params.vertexAttributes;for(const e in s)s[e].values||(v().warn("Geometries with externally defined attributes are not yet supported"),i=!1);return i}function T(e){const t=u.empty();return e.forEach((e=>{const r=e.boundingInfo;null!=r&&(u.expandWithVec3(t,r.bbMin),u.expandWithVec3(t,r.bbMax))})),t}async function C(e,t){const r=new Array;for(const i in e){const s=e[i],n=s.images[0].data;if(!n){v().warn("Externally referenced texture data is not yet supported");continue}const o=s.encoding+";base64,"+n,a="/textureDefinitions/"+i,l="rgba"===s.channels?s.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:b.TextureWrapMode.REPEAT,t:b.TextureWrapMode.REPEAT},preMultiplyAlpha:P(l)!==m.AlphaDiscardMode.Opaque},u=t?.disableTextures?Promise.resolve(null):h.requestImage(o,t);r.push(u.then((e=>({refId:a,image:e,parameters:c,alphaChannelUsage:l}))))}const i=await Promise.all(r),s={};for(const e of i)s[e.refId]=e;return s}function P(e){switch(e){case"mask":return m.AlphaDiscardMode.Mask;case"maskAndTransparency":return m.AlphaDiscardMode.MaskBlend;case"none":return m.AlphaDiscardMode.Opaque;default:return m.AlphaDiscardMode.Blend}}function M(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const R=new l.Version(1,2,"wosr");e.LoaderResultWOSR=S,e.createTextureResources=C,e.load=async function(e,i){const s=await async function(e,i){const s=i?.streamDataRequester;if(s)return async function(e,t,i){const s=await r.result(t.request(e,"json",i));return!0===s.ok?s.value:(a.throwIfAbortError(s.error),void w(s.error.details.url))}(e,s,i);const n=await r.result(t(e,i));return!0===n.ok?n.value.data:(a.throwIfAbortError(n.error),void w(n.error))}(e,i),o=await C(s.textureDefinitions??{},i);let l=0;for(const e in o)if(o.hasOwnProperty(e)){const t=o[e];l+=t?.image?t.image.width*t.image.height*4:0}return new S(s,o,l+n.estimateNestedObjectMemory(s))},e.processLoadResult=function(e,t){const r=new Array,i=new Array,s=new Array,n=new o.NestedMap,a=e.resource,u=l.Version.parse(a.version||"1.0","wosr");R.validate(u);const h=a.model.name,b=a.model.geometries,v=a.materialDefinitions??{},S=e.textures;let w=0;const C=new Map;for(let e=0;e<b.length;e++){const o=b[e];if(!x(o))continue;const a=M(o),l=o.params.vertexAttributes,u=[],h=e=>{if("PerAttributeArray"===o.params.topology)return null;const t=o.params.faces;for(const r in t)if(r===e)return t[r].values;return null},T=l[y.VertexAttribute.POSITION],R=T.values.length/T.valuesPerElement;for(const e in l){const t=l[e],r=t.values,i=h(e)??d.getContinuousIndexArray(R);u.push([e,new p.Attribute(r,i,t.valuesPerElement,!0)])}const E=a.texture,O=S&&S[E];if(O&&!C.has(E)){const{image:e,parameters:t}=O,r=new g.Texture(e,t);i.push(r),C.set(E,r)}const A=C.get(E),I=A?A.id:void 0,D=a.material;let F=n.get(D,E);if(null==F){const e=v[D.slice(D.lastIndexOf("/")+1)].params;1===e.transparency&&(e.transparency=0);const r=O?P(O.alphaChannelUsage):void 0,i={ambient:c.fromArray(e.diffuse),diffuse:c.fromArray(e.diffuse),opacity:1-(e.transparency||0),textureAlphaMode:r,textureAlphaCutoff:.33,textureId:I,doubleSided:!0,cullFace:m.CullFaceOptions.None,colorMixMode:e.externalColorMixMode||"tint",textureAlphaPremultiplied:O?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(i,t.materialParameters),F=new _.DefaultMaterial(i,t),n.set(D,E,F)}s.push(F);const L=new f.Geometry(F,u);w+=u.find((e=>e[0]===y.VertexAttribute.POSITION))?.[1]?.indices.length??0,r.push(L)}return{engineResources:[{name:h,stageResources:{textures:i,materials:s,geometries:r},pivotOffset:a.model.pivotOffset,numberOfVertices:w,lodThreshold:null}],referenceBoundingBox:T(r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/support/requestImageUtils":function(){define(["exports","../request"],(function(e,t){"use strict";e.requestImage=async function(e,r){const{data:i}=await t(e,{responseType:"image",...r});return i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Texture":function(){define(["exports","../../../../core/has","../../../../core/Error","../../../../core/Evented","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/typedArrayUtil","../../../../core/uid","../../../../core/urlUtils","../../../../layers/support/videoUtils","../../../../support/requestImageUtils","../../../../support/requestUtils","./basicInterfaces","./BasisUtil","./DDSUtil","./textureUtils","./Util","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";function v(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}const S={wrap:{s:y.TextureWrapMode.REPEAT,t:y.TextureWrapMode.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};e.Texture=class{constructor(e,t){this._data=e,this.id=a.generateUID(),this.events=new i,this._parameters={...S,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(l.isBlobProtocol(e.src)||"auto"===e.preload&&e.crossOrigin)&&(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src,e.paused&&e.autoplay)){const t=[];c.whenVideoPlayable(e,(e=>t.push(e))).then((()=>{e.play()})).finally((()=>t.forEach((e=>e.remove()))))}}_startPreloadImageElement(e){l.isDataProtocol(e.src)||l.isBlobProtocol(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new b.TextureDescriptor;return t.wrapMode=this._parameters.wrap??y.TextureWrapMode.REPEAT,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?y.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:y.TextureSamplingMode.LINEAR,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return null!=this._glTexture}get usedMemory(){return this._glTexture?.usedMemory||function(e,t){if(null==e)return 0;if(o.isArrayBuffer(e)||o.isUint8Array(e))return t.encoding===h.TextureEncodingMimeType.KTX2_ENCODING?p.estimateMemoryKTX2(e,!!t.mipmap):t.encoding===h.TextureEncodingMimeType.BASIS_ENCODING?p.estimateMemoryBasis(e,!!t.mipmap):e.byteLength;const{width:r,height:i}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?v(e):t;return(t.mipmap?4/3:1)*r*i*(t.components||4)||0}(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const t=this._data;return null==t?(this._glTexture=new _.Texture(e,this._createDescriptor(e),null),this._glTexture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),"string"==typeof t?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):o.isUint8Array(t)&&this._parameters.encoding===h.TextureEncodingMimeType.DDS_ENCODING?this._loadFromDDSData(e,t):o.isArrayBuffer(t)&&this._parameters.encoding===h.TextureEncodingMimeType.DDS_ENCODING?this._loadFromDDSData(e,new Uint8Array(t)):(o.isArrayBuffer(t)||o.isUint8Array(t))&&this._parameters.encoding===h.TextureEncodingMimeType.KTX2_ENCODING?this._loadFromKTX2(e,t):(o.isArrayBuffer(t)||o.isUint8Array(t))&&this._parameters.encoding===h.TextureEncodingMimeType.BASIS_ENCODING?this._loadFromBasis(e,t):o.isUint8Array(t)?this._loadFromPixelData(e,t):o.isArrayBuffer(t)?this._loadFromPixelData(e,new Uint8Array(t)):null)}_update(e,t){return null==this._glTexture||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=m.createDDSTexture(e,this._createDescriptor(e),t),this._emptyTexture=null,this._glTexture}_loadFromKTX2(e,t){return this._loadAsync((()=>p.createTextureKTX2(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromBasis(e,t){return this._loadAsync((()=>p.createTextureBasis(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromPixelData(e,t){g.assert(this._parameters.width>0&&this._parameters.height>0);const r=this._createDescriptor(e);return r.pixelFormat=1===this._parameters.components?y.PixelFormat.LUMINANCE:3===this._parameters.components?y.PixelFormat.RGB:y.PixelFormat.RGBA,r.pixelFormat!==y.PixelFormat.RGB&&r.pixelFormat!==y.PixelFormat.RGBA||(r.compress=this._parameters.compressionOptions),r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new _.Texture(e,r,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync((async r=>{const i=await u.requestImage(t,{signal:r});return n.throwIfAborted(r),this._loadFromImage(e,i)}))}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync((async r=>{const i=await d.loadImageAsync(t,t.src,!1,r);return n.throwIfAborted(r),this._loadFromImage(e,i)}))}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync((i=>new Promise(((o,a)=>{const l=()=>{t.removeEventListener("loadeddata",c),t.removeEventListener("error",u),s.removeMaybe(d)},c=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(l(),o(this._loadFromImage(e,t)))},u=e=>{l(),a(e||new r("texture:load-error","Failed to load video"))};t.addEventListener("loadeddata",c),t.addEventListener("error",u);const d=n.onAbort(i,(()=>u(n.createAbortError())))}))))}_loadFromImage(e,t){let r=t;r instanceof HTMLVideoElement||(r=f.ensureImageMaxSize(r,e.parameters));const i=v(r);this._parameters.width=i.width,this._parameters.height=i.height;const s=this._createDescriptor(e);return s.pixelFormat=3===this._parameters.components?y.PixelFormat.RGB:y.PixelFormat.RGBA,s.width=i.width,s.height=i.height,s.compress=this._parameters.compressionOptions,this._glTexture=new _.Texture(e,s,r),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const r=e(t.signal);this._loadingPromise=r;const i=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null),this._emptyTexture=null};return r.then(i,i),r}unload(){if(this._glTexture=s.disposeMaybe(this._glTexture),this._emptyTexture=null,null!=this._loadingController){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/videoUtils":function(){define(["exports","../../core/events"],(function(e,t){"use strict";e.whenVideoPlayable=function(e,r){return new Promise(((i,s)=>{e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?i():(r(t.once(e,"canplay",i)),r(t.once(e,"error",s)))}))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/BasisUtil":function(){define(["exports","../../../../libs/basisu/BasisUTranscoder","../../../../libs/basisu/TextureFormat","../../../webgl/enums","../../../webgl/Texture","../../../webgl/Util"],(function(e,t,r,i,s,n){"use strict";let o=null,a=null;async function l(){return null==a&&(a=t.getBasisTranscoder(),o=await a),a}function c(e,t,r,s,o){const a=n.getBytesPerElementFormat(t?i.CompressedTextureFormat.COMPRESSED_RGBA8_ETC2_EAC:i.CompressedTextureFormat.COMPRESSED_RGB8_ETC2),l=o&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*s*a*l)}function u(e){return e.getNumImages()>=1&&!e.isUASTC()}function d(e){return e.getFaces()>=1&&e.isETC1S()}function h(e,t,n,o,a,l,c,u){const{compressedTextureETC:d,compressedTextureS3TC:h}=e.capabilities,[p,m]=d?o?[r.TextureFormat.ETC2_RGBA,i.CompressedTextureFormat.COMPRESSED_RGBA8_ETC2_EAC]:[r.TextureFormat.ETC1_RGB,i.CompressedTextureFormat.COMPRESSED_RGB8_ETC2]:h?o?[r.TextureFormat.BC3_RGBA,i.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[r.TextureFormat.BC1_RGB,i.CompressedTextureFormat.COMPRESSED_RGB_S3TC_DXT1_EXT]:[r.TextureFormat.RGBA32,i.PixelFormat.RGBA],f=t.hasMipmap?n:Math.min(1,n),g=[];for(let e=0;e<f;e++)g.push(new Uint8Array(c(e,p))),u(e,p,g[e]);return t.internalFormat=m,t.hasMipmap=g.length>1,t.samplingMode=t.hasMipmap?i.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:i.TextureSamplingMode.LINEAR,t.width=a,t.height=l,new s.Texture(e,t,{type:"compressed",levels:g})}e.checkKTX2=d,e.createTextureBasis=async function(e,t,r){null==o&&(o=await l());const i=new o.BasisFile(new Uint8Array(r));if(!u(i))return null;i.startTranscoding();const s=h(e,t,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),((e,t)=>i.getImageTranscodedSizeInBytes(0,e,t)),((e,t,r)=>i.transcodeImage(r,0,e,t,0,0)));return i.close(),i.delete(),s},e.createTextureKTX2=async function(e,t,r){null==o&&(o=await l());const i=new o.KTX2File(new Uint8Array(r));if(!d(i))return null;i.startTranscoding();const s=h(e,t,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),((e,t)=>i.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,r)=>i.transcodeImage(r,e,0,0,t,0,-1,-1)));return i.close(),i.delete(),s},e.estimateMemoryBasis=function(e,t){if(null==o)return e.byteLength;const r=new o.BasisFile(new Uint8Array(e)),i=u(r)?c(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),t):0;return r.close(),r.delete(),i},e.estimateMemoryKTX2=function(e,t){if(null==o)return e.byteLength;const r=new o.KTX2File(new Uint8Array(e)),i=d(r)?c(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),t):0;return r.close(),r.delete(),i},e.loadBasisTranscoder=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/libs/basisu/BasisUTranscoder":function(){define(["require","exports","../../assets"],(function(e,t,r){"use strict";let i;t.getBasisTranscoder=function(){return i??=(async()=>{const t=await new Promise(((t,r)=>e(["../../chunks/basis_transcoder"],t,r))),i=await t.default({locateFile:e=>r.getAssetUrl(`esri/libs/basisu/${e}`)});return i.initializeBasis(),i})(),i},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/libs/basisu/TextureFormat":function(){define(["exports"],(function(e){"use strict";var t;e.TextureFormat=void 0,(t=e.TextureFormat||(e.TextureFormat={}))[t.ETC1_RGB=0]="ETC1_RGB",t[t.ETC2_RGBA=1]="ETC2_RGBA",t[t.BC1_RGB=2]="BC1_RGB",t[t.BC3_RGBA=3]="BC3_RGBA",t[t.BC4_R=4]="BC4_R",t[t.BC5_RG=5]="BC5_RG",t[t.BC7_M6_RGB=6]="BC7_M6_RGB",t[t.BC7_M5_RGBA=7]="BC7_M5_RGBA",t[t.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",t[t.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",t[t.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",t[t.ATC_RGB=11]="ATC_RGB",t[t.ATC_RGBA=12]="ATC_RGBA",t[t.FXT1_RGB=17]="FXT1_RGB",t[t.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",t[t.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",t[t.ETC2_EAC_R11=20]="ETC2_EAC_R11",t[t.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",t[t.RGBA32=13]="RGBA32",t[t.RGB565=14]="RGB565",t[t.BGR565=15]="BGR565",t[t.RGBA4444=16]="RGBA4444",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/DDSUtil":function(){define(["exports","../../../../core/Logger","../../../webgl/enums","../../../webgl/Texture"],(function(e,t,r,i){"use strict";const s=()=>t.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function n(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const o=n("DXT1"),a=n("DXT3"),l=n("DXT5");function c(e,t){const i=new Int32Array(e.buffer,e.byteOffset,31);if(542327876!==i[0])return s().error("Invalid magic number in DDS header"),null;if(!(4&i[20]))return s().error("Unsupported format, must contain a FourCC code"),null;const n=i[21];let c,u;switch(n){case o:c=8,u=r.CompressedTextureFormat.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case a:c=16,u=r.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case l:c=16,u=r.CompressedTextureFormat.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return s().error("Unsupported FourCC code:",(d=n,String.fromCharCode(255&d,d>>8&255,d>>16&255,d>>24&255))),null}var d;let h=1,p=i[4],m=i[3];(3&p||3&m)&&(s().warn("Rounding up compressed texture size to nearest multiple of 4."),p=p+3&-4,m=m+3&-4);const f=p,g=m;let y,_;131072&i[2]&&!1!==t&&(h=Math.max(1,i[7]));let b=e.byteOffset+i[1]+4;const v=[];for(let t=0;t<h;++t)_=(p+3>>2)*(m+3>>2)*c,y=new Uint8Array(e.buffer,b,_),v.push(y),b+=_,p=Math.max(1,p>>1),m=Math.max(1,m>>1);return{textureData:{type:"compressed",levels:v},internalFormat:u,width:f,height:g}}e.createDDSTexture=function(e,t,s){const n=c(s,t.hasMipmap??!1);if(null==n)throw new Error("DDS texture data is null");const{textureData:o,internalFormat:a,width:l,height:u}=n;return t.samplingMode=o.levels.length>1?r.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:r.TextureSamplingMode.LINEAR,t.hasMipmap=o.levels.length>1,t.internalFormat=a,t.width=l,t.height=u,new i.Texture(e,t,o)},e.createDDSTextureData=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/StreamTextureCollection":function(){define(["exports","../../../core/promiseUtils","../../../core/urlUtils","./TextureCollection","../webgl-engine/lib/Texture","../../webgl/enums"],(function(e,t,r,i,s,n){"use strict";class o extends i.TextureCollection{constructor(e,t,r){super(t,r),this._streamDataRequester=e}async fromUrl(e,r,s){t.throwIfAborted(s);const n=s?.signal,o=this.makeUid(e,r);let a=this._textureRequests.get(o);if(!a){const t=new AbortController,s=this._streamDataRequester.request(e,"image",{uid:o,signal:t.signal});a=new i.TextureRequest,a.abortController=t;const n=a;this._textureRequests.set(o,a),a.textureAsync=s.then((async t=>{const s=this._createTexture(e,t,r);return n.texture=s,n.abortController=null,await s.load(this._stage.renderView.renderingContext),this._stage.addTexture(s),new i.TextureHandle(o,s,(()=>this._release(o)))}),(e=>{throw n.abortController=null,e}))}a.referenceCount++;try{return await t.whenOrAbort(a.textureAsync,n)}catch(e){throw this._release(o),e}}_createTexture(e,t,i){const o={width:t.width,height:t.height,wrap:{s:n.TextureWrapMode.CLAMP_TO_EDGE,t:n.TextureWrapMode.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if(r.isSVG(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(o.preMultiplyAlpha=!1)}return new s.Texture(t,o)}}e.StreamTextureCollection=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/TextureCollection":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.TextureCollection=class extends r{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(l.TaskPriority.TEXTURE_UNLOAD)??l.ImmediateTask}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach((e=>this._releaseTextureRequest(e))),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const r=this.makeUid(e);let i=this._textureRequests.get(r);if(!i){const e=new u;e.texture=t(),this._stage&&(e.texture.load(this._stage.renderView.renderingContext),this._stage.addTexture(e.texture)),this._textureRequests.set(r,e),i=e}return i.referenceCount++,new c(r,i.texture,(()=>this._release(r)))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.removeTexture(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return null!=t?`${e}.${t}px`:e}},t.__decorate([s.property()],e.TextureCollection.prototype,"_frameTask",void 0),t.__decorate([s.property()],e.TextureCollection.prototype,"updating",null),e.TextureCollection=t.__decorate([a.subclass("esri.views.3d.support.TextureCollection")],e.TextureCollection);class c{constructor(e,t,r){this.uid=e,this.texture=t,this.release=r}}class u{constructor(){this.referenceCount=0}}e.TextureHandle=c,e.TextureRequest=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/ViewSlice":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/handleUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/boundedPlane","../../support/PropertiesPool"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.ViewSlice=class extends r{constructor(){super(),this._propertiesPool=new u.PropertiesPool({plane:c.BoundedPlaneClass},this),this.isDecoration=!0,this.addHandles(i.destroyHandle(this._propertiesPool))}set plane(e){if(!e)return void this._set("plane",e);const t=this._propertiesPool.get("plane");c.copy(e,t),this._set("plane",t)}},t.__decorate([s.property()],e.ViewSlice.prototype,"plane",null),t.__decorate([s.property()],e.ViewSlice.prototype,"isDecoration",void 0),e.ViewSlice=t.__decorate([l.subclass("esri.views.3d.support.ViewSlice")],e.ViewSlice),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/pointsOfInterest/PointsOfInterest":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/support/UpdatingHandles","../../../../geometry/support/ray","../debugFlags","../debugUtils","../geometryUtils/ray","./CameraOnSurface","./CenterOnSurface","./ContentGeometryUpdates","./Focus","./StableSurfaceCenter","./SurfaceGeometryUpdates","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/verticalOffsetUtils","../../../support/PropertiesPool","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P){"use strict";e.PointsOfInterest=class extends r{constructor(e){super(e),this.renderPointOfView=u.create(),this._pois=new Array,this._updatingHandles=new d.UpdatingHandles,this._debugCenters=null,this._tmpRay=h.create(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new C.PropertiesPool({renderPointOfView:M},this),this._contentIntersector=new w.Intersector(e.view.state.viewingMode),this._surfaceIntersector=new w.Intersector(e.view.state.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=x.StoreResults.MIN}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:r,map:i}=this.view,n=()=>this._estimateSurfaceAltitudeAtCenter(),o=this.view.resourceController.scheduler,a=t?.elevationQueryCache,l={state:e,scheduler:o,surface:t,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new y.CenterOnSurface({...l,task:P.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new y.CenterOnSurface({...l,task:P.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new y.CenterOnSurface({...l,task:P.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new g.CameraOnSurface({...l,cache:a,task:P.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:i})),this._set("surfaceGeometryUpdates",new S.SurfaceGeometryUpdates({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new _.ContentGeometryUpdates(this.view.allLayerViews)),this._set("surfaceOrigin",new v.StableSurfaceCenter({cache:a,view:this.view})),this._set("focus",new b.Focus({state:e,scheduler:o,surface:t,renderCoordsHelper:r,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([s.watch((()=>e.contentCamera),(e=>this._cameraChanged(e)),s.sync),this._updatingHandles.add((()=>t.extent),(()=>this._updateCenterPointsOfInterest())),this._updatingHandles.add((()=>this.view.map?.ground?.navigationConstraint?.type),(e=>{this._surfaceIntersector.options.backfacesTerrain="none"===e}),s.initial),s.when((()=>!t.updating),(()=>this._updateCenterPointsOfInterest()),s.sync),s.on((()=>this.surfaceGeometryUpdates.events),"request-update",(()=>this._updateCenterPointsOfInterest())),s.on((()=>this.contentGeometryUpdates.events),"request-update",(()=>this._updateCenterOnContent())),this._updatingHandles.add((()=>p.debugFlags.SHOW_POI),(e=>this._setDebug(e)),s.initial)]),this._cameraChanged(this.view.state.contentCamera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy(),this._updatingHandles.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some((e=>e.updating)))||this._updatingHandles.updating}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,R,O)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(R):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;const t=e.origin,r=c.add(R,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,r),this._surfaceIntersector.results.min.getIntersectionPoint(R)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(R)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,r){const i=f.fromRenderAtEye(t,e,E);if(null==i)return null;const s=i.origin,n=c.add(R,i.origin,i.direction);return this._surfaceIntersector.resetWithRay(i,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(r)?r:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;c.exactEquals(this.renderPointOfView,t)||this._set("renderPointOfView",c.copy(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters?.forEach((e=>e.hide())),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const e=this.view.graphics;this._debugCenters.set(this.centerOnContent,new m.DebugPoint(e,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new m.DebugPoint(e,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new m.DebugPoint(e,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new m.DebugPoint(e,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new m.DebugPoint(e,"green","Focus"))}for(const e of this._pois)this.addHandles(this._updatingHandles.add((()=>e.renderLocation),(t=>this._debugCenters?.get(e)?.show(t,e.renderCoordsHelper.spatialReference)),s.initial),"debug")}get test(){}},t.__decorate([n.property()],e.PointsOfInterest.prototype,"centerOnContent",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"centerOnSurfaceInfrequent",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"cameraOnSurface",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"focus",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"renderPointOfView",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"surfaceOrigin",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"contentGeometryUpdates",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"surfaceGeometryUpdates",void 0),t.__decorate([n.property({constructOnly:!0})],e.PointsOfInterest.prototype,"view",void 0),t.__decorate([n.property()],e.PointsOfInterest.prototype,"updating",null),e.PointsOfInterest=t.__decorate([l.subclass("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],e.PointsOfInterest);const M=Array,R=u.create(),E=h.create(),O={exclude:new Set([T.terrainId])};Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/debugUtils":function(){define(["exports","../../../Graphic","../../../core/Collection","../../../geometry/Point","../../../geometry/Polyline","../../../symbols/IconSymbol3DLayer","../../../symbols/LineSymbol3D","../../../symbols/LineSymbol3DLayer","../../../symbols/PointSymbol3D","../../../symbols/TextSymbol3DLayer"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";class u{constructor(e){this.destination=e}hide(){null!=this.graphic&&(this.destination.remove(this.graphic),this.graphic=null)}}class d extends u{constructor(e,t,i=""){super(e),this._symbol=new l({symbolLayers:new r([new n({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new c({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,r){if(!r)return;this.hide();const s=new i({x:e[0],y:e[1],z:e[2],spatialReference:r});this.graphic=new t({geometry:s,symbol:this._symbol}),this.destination.add(this.graphic)}}class h extends u{constructor(e,t){super(e),this._symbol=new o({symbolLayers:new r([new a({material:{color:t},size:2})])})}show(e,r){if(!r)return;this.hide();const i=new s({paths:e,spatialReference:r});this.graphic=new t({geometry:i,symbol:this._symbol}),this.destination.add(this.graphic)}}e.DebugGraphics=class{constructor(e){this.destination=e,this._graphics=new Map}showPoint(e,t,r,i){const s=new d(this.destination,i,e);this._graphics.get(e)?.hide(),this._graphics.set(e,s),s.show(t,r)}showSegment(e,t,r,i,s){const n=[[[t[0],t[1],t[2]],[r[0],r[1],r[2]]]],o=new h(this.destination,s);this._graphics.get(e)?.hide(),this._graphics.set(e,o),o.show(n,i)}showVector(e,t,r,i,s){const n=[[[t[0],t[1],t[2]],[t[0]+r[0],t[1]+r[1],t[2]+r[2]]]],o=new h(this.destination,s);this._graphics.get(e)?.hide(),this._graphics.set(e,o),o.show(n,i)}hide(){this._graphics.forEach((e=>e.hide))}},e.DebugPoint=d,e.DebugSegment=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/pointsOfInterest/CameraOnSurface":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../ViewingMode","../cameraUtils","./PointOfInterest","../../../support/PropertiesPool","../../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";const _=Array;e.CameraOnSurface=class extends f.PointOfInterest{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new g.PropertiesPool({location:h,renderLocation:_},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=d.create(),this._tmpPoint=new h}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(s.on((()=>this.map?.ground?.layers),"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=r.destroyMaybe(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=u.distance(e.eye,this.renderLocation),r={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return m.distanceToScale(r,t)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),y.Yield;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>v&&this.renderCoordsHelper.viewingMode===p.ViewingMode.Global&&(e.isWGS84||e.isWebMercator);let r=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:r.signal,cache:this.cache,minDemResolution:t?S:0}).then((e=>this._updateSurfaceAltitude(e.geometry.z??0))).catch((e=>{i.isAbortError(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===r&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),r=null})),this._pendingElevationQueryController=r,y.Yield}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(b,this._estimatedSurfaceAltitude,this._camera.eye),u.exactEquals(this._get("renderLocation"),b)||(this._set("renderLocation",u.copy(this._propertiesPool.get("renderLocation"),b)),this.notifyChange("renderLocation"))}},t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"scheduler",void 0),t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"cache",void 0),t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"task",void 0),t.__decorate([n.property()],e.CameraOnSurface.prototype,"location",null),t.__decorate([n.property({constructOnly:!0})],e.CameraOnSurface.prototype,"map",void 0),t.__decorate([n.property()],e.CameraOnSurface.prototype,"renderLocation",void 0),t.__decorate([n.property()],e.CameraOnSurface.prototype,"scale",null),t.__decorate([n.property()],e.CameraOnSurface.prototype,"updating",null),e.CameraOnSurface=t.__decorate([c.subclass("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],e.CameraOnSurface);const b=d.create(),v=1e5,S=1e6;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/pointsOfInterest/PointOfInterest":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";e.PointOfInterest=class extends r{constructor(e){super(e)}},t.__decorate([i.property({constructOnly:!0})],e.PointOfInterest.prototype,"renderCoordsHelper",void 0),t.__decorate([i.property({constructOnly:!0})],e.PointOfInterest.prototype,"surface",void 0),t.__decorate([i.property({constructOnly:!0})],e.PointOfInterest.prototype,"state",void 0),e.PointOfInterest=t.__decorate([a.subclass("esri.views.3d.support.pointsOfInterest.PointOfInterest")],e.PointOfInterest),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/pointsOfInterest/CenterOnSurface":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/Point","../../../../geometry/projection/projectBoundingRect","../../../../geometry/support/aaBoundingRect","../debugFlags","./PointOfInterest","../../../support/PropertiesPool","../../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_){"use strict";const b=Array;e.CenterOnSurface=class extends g.PointOfInterest{constructor(e){super(e),this._propertiesPool=new y.PropertiesPool({location:h,renderLocation:b},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=u.create(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=i.removeMaybe(this._frameWorker),this._propertiesPool=i.destroyMaybe(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,_.Yield}_updateRenderLocation(){const e=S;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&r&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const i=w;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,i)&&(c.copy(e,i),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=c.distance(this._camera.eye,e):(c.scale(e,this._camera.viewForward,this._get("distance")),c.add(e,e,this._camera.eye)),c.exactEquals(this._get("renderLocation"),e)||this._set("renderLocation",c.copy(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=d.getReferenceEllipsoid(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=c.squaredLength(i.eye),o=n<s*s,a=c.distance(i.eye,t);if(o&&a>r/4){const e=s-Math.sqrt(n);return c.scale(t,i.viewForward,e),c.add(t,t,i.eye),!0}}else{const e=this.surface?.ready?this.surface.extent:null;null!=e&&p.projectBoundingRect(e,this.surface?.spatialReference,x,this.renderCoordsHelper.spatialReference)&&(t[0]=r.clamp(t[0],x[0],x[2]),t[1]=r.clamp(t[1],x[1],x[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(f.debugFlags.TESTS_DISABLE_OPTIMIZATIONS)return!0;const r=this._camera.eye,i=c.distance(r,e),s=c.distance(r,t);if(Math.abs(s-i)/i>v)return!0}return!1}},t.__decorate([s.property({constructOnly:!0})],e.CenterOnSurface.prototype,"scheduler",void 0),t.__decorate([s.property({constructOnly:!0})],e.CenterOnSurface.prototype,"task",void 0),t.__decorate([s.property()],e.CenterOnSurface.prototype,"distance",void 0),t.__decorate([s.property({constructOnly:!0})],e.CenterOnSurface.prototype,"estimateSurfaceAltitudeAtCenter",void 0),t.__decorate([s.property({readOnly:!0})],e.CenterOnSurface.prototype,"location",null),t.__decorate([s.property({readOnly:!0})],e.CenterOnSurface.prototype,"renderLocation",void 0),t.__decorate([s.property()],e.CenterOnSurface.prototype,"updating",void 0),e.CenterOnSurface=t.__decorate([l.subclass("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],e.CenterOnSurface);const v=.05,S=u.create(),w=u.create(),x=m.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/pointsOfInterest/ContentGeometryUpdates":function(){define(["exports","../../../../core/Evented","../../../../core/mapCollectionUtils"],(function(e,t,r){"use strict";e.ContentGeometryUpdates=class{constructor(e){this.events=new t,this._handles=r.mapCollection((()=>e),(e=>e.on("visible-geometry-changed",(e=>this.events.emit("request-update",e)))))}destroy(){this._handles.destroy()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/mapCollectionUtils":function(){define(["exports","./asyncUtils","./Collection","./handleUtils","./promiseUtils","./reactiveUtils"],(function(e,t,r,i,s,n){"use strict";function o(e,t,i){const s=i?.createCollection?.()??new r,o=i?.recycleItems?new a:null,l=(e,t=0)=>{if(!e?.length)return;const r=s.splice(t,e.length);o?o.processRemoved(e):r.forEach(c)},u=(e,r=0)=>{if(!e?.length)return;const i=[];for(const r of e){const e=o?.use(r);if(e)i.push(e);else{const e=t(r);o?.register(r,e),i.push(e)}}s.addMany(i,r)},d=n.on(e,"after-splice",(({added:e,start:t,removed:r})=>{l(r,t),u(e,t)}),{sync:!0,onListenerRemove:e=>l(e.items),onListenerAdd:e=>u(e.items)});return s.addHandles(d),s}class a{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;const{_removedItemCandidates:t}=this;for(const r of e)this._getItem(r)?.markRemoved()&&(t.add(r),this._queueGarbageCollection())}use(e){const t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new l(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask((()=>this._garbageCollectCandidates())))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach((e=>this._garbageCollectIfRemoved(e)))}_garbageCollectIfRemoved(e){const{_originalToMapped:t}=this,r=this._getItem(e);r?.removed&&(c(r.item),t.delete(e))}}class l{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}}function c(e){"object"==typeof e&&e&&("destroy"in e&&"function"==typeof e.destroy?e.destroy():i.removeIfHandle(e))}e.mapCollection=o,e.mapCollectionAsync=function(e,n,a){const l=new r,u=o(e,(e=>t.createTask((async t=>{const r=await n(e,t);if(s.isAborted(t))throw c(r),s.createAbortError();return r}))),a),d=()=>null,h=async e=>{const t=await e.promise,r=u.indexOf(e);r<0||l.splice(r,1,t)};l.addMany(u.items.map(d));for(const e of u)s.ignoreAbortErrors(h(e));const p=u.on("after-splice",(({added:e,start:t,deleteCount:r})=>{const i=l.splice(t,r);for(const e of i)c(e);if(e?.length){l.addMany(e.map(d),t);for(const t of e)s.ignoreAbortErrors(h(t))}}));return l.addHandles([i.destroyHandle(u),p]),l},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/pointsOfInterest/Focus":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../../geometry/support/ray","./PointOfInterest","../../webgl-engine/lib/rendererUtils","../../../support/PropertiesPool","../../../support/Scheduler","../../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";const v=Array;e.Focus=class extends f.PointOfInterest{constructor(e){super(e),this._propertiesPool=new y.PropertiesPool({location:p,renderLocation:v},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([s.watch((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),s.watch((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.addHandles(this.scheduler.registerTask(_.TaskPriority.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=i.destroyMaybe(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,S);const n=Math.max(0,(Math.acos(d.dot(S,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!d.equals(e,t)){const e=this._propertiesPool.get("renderLocation");d.copy(e,t),this._set("renderLocation",e)}return b.Yield}const o=1-r.clamp(n/(.5*Math.PI),0,1),a=o*o*o;this._calculateScreenHorizontalEdgeOnSurface(x);const l=this._propertiesPool.get("renderLocation");return d.lerp(l,t,x,a),e&&d.equals(e,l)||this._set("renderLocation",l),b.Yield}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,r=t.getRenderCenter(n.createRenderScreenPointArray3());if(r[1]=t.aboveGround?t.padding[g.PaddingSide.BOTTOM]:t.fullHeight-t.padding[g.PaddingSide.TOP],this.estimateSurfaceIntersectionAtRenderPoint(r,e))return e;const i=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(r,w)){d.subtract(w,w,t.eye);const r=d.normalize(w,w);if(this.renderCoordsHelper.intersectInfiniteManifold(m.wrap(t.eye,r),i,e))return e}return this.renderCoordsHelper.setAltitude(e,i,t.eye)}updateRenderLocation(){this._dirty=!0}},t.__decorate([o.property()],e.Focus.prototype,"_dirty",void 0),t.__decorate([o.property({constructOnly:!0})],e.Focus.prototype,"scheduler",void 0),t.__decorate([o.property({constructOnly:!0})],e.Focus.prototype,"centerOnSurface",void 0),t.__decorate([o.property({constructOnly:!0})],e.Focus.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),t.__decorate([o.property()],e.Focus.prototype,"updating",null),t.__decorate([o.property()],e.Focus.prototype,"location",null),t.__decorate([o.property()],e.Focus.prototype,"renderLocation",void 0),t.__decorate([o.property()],e.Focus.prototype,"worldUnitsPerContentPixel",null),e.Focus=t.__decorate([u.subclass("esri.views.3d.support.pointsOfInterest.Focus")],e.Focus);const S=h.create(),w=h.create(),x=h.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/pointsOfInterest/StableSurfaceCenter":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/Error","../../../../core/Logger","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Point","../../../../geometry/support/aaBoundingRect"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.StableSurfaceCenter=class extends r{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=u.create();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([o.watch((()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent]),(()=>this._update())),o.on((()=>this.surface?.layers),"change",(()=>this._update()))]),this._update())}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),null==this.surfaceView?.extent||null==this.surfaceView.spatialReference)return void this._set("location",null);const e=h.center(this.surfaceView.extent),t=new d({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{}))):this._set("location",t)}},t.__decorate([a.property({constructOnly:!0})],e.StableSurfaceCenter.prototype,"view",void 0),t.__decorate([a.property({constructOnly:!0})],e.StableSurfaceCenter.prototype,"cache",void 0),t.__decorate([a.property()],e.StableSurfaceCenter.prototype,"surface",null),t.__decorate([a.property()],e.StableSurfaceCenter.prototype,"surfaceView",null),t.__decorate([a.property({readOnly:!0})],e.StableSurfaceCenter.prototype,"location",void 0),t.__decorate([a.property({readOnly:!0})],e.StableSurfaceCenter.prototype,"renderLocation",null),e.StableSurfaceCenter=t.__decorate([c.subclass("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],e.StableSurfaceCenter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/pointsOfInterest/SurfaceGeometryUpdates":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingRect","../../../support/Scheduler","../../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.SurfaceGeometryUpdates=class extends r{constructor(e){super(e),this._tileGeometryUpdateExtent=u.empty(),this._tileGeometryUpdateSpatialReference=null,this.events=new i,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(d.TaskPriority.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",p),u.empty(this._tileGeometryUpdateExtent),this._set("updating",!1),h.Yield):h.Yield}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,u.expand(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const r=this.centerOnSurfaces[t];r.distance>e.distance&&(e=r)}return e}_centerIntersectsExtent(e,t){const r=this.state.contentCamera.eye,i=g,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(r,m,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,f,t),m[0]<f[0]?(i[0]=m[0],i[2]=f[0]):(i[0]=f[0],i[2]=m[0]),m[1]<f[1]?(i[1]=m[1],i[3]=f[1]):(i[1]=f[1],i[3]=m[1]),u.intersects(i,e)}},t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"state",void 0),t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"centerOnSurfaces",void 0),t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"renderCoordsHelper",void 0),t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"scheduler",void 0),t.__decorate([s.property({constructOnly:!0})],e.SurfaceGeometryUpdates.prototype,"surface",void 0),t.__decorate([s.property({readOnly:!0})],e.SurfaceGeometryUpdates.prototype,"updating",void 0),e.SurfaceGeometryUpdates=t.__decorate([l.subclass("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],e.SurfaceGeometryUpdates);const p={},m=c.create(),f=c.create(),g=u.empty();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TerrainSurface":function(){define(["require","../../../chunks/tslib.es6","../../../Color","../../../core/Accessor","../../../core/arrayUtils","../../../core/CollectionFlattener","../../../core/Evented","../../../core/has","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/MemCachePool","../../../core/ObjectPool","../../../core/PooledArray","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/unitUtils","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/support/UpdatingHandles","../../../geometry/ellipsoidUtils","../../../geometry/SpatialReference","../../../geometry/projection/projectors","../../../geometry/projection/projectPointToVector","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/spatialReferenceUtils","../../../chunks/sphere","../../../layers/support/ElevationQueryTileCache","../../../layers/support/layerUtils","../support/debugFlags","../support/ElevationRange","../support/ElevationUpdateEvent","../support/extentUtils","../support/index","../support/updatingProperties","./ElevationBounds","./ElevationData","./ExtentHelper","./interfaces","./LayerClass","./OverlayManager","./PlanarPatch","./RenderOrder","./ScaleRangeQueries","./SphericalPatch","./SplitLimits","./TerrainConst","./TerrainRenderer","./TerrainSurfacePerformanceInfo","./terrainUtils","./Tile","./TilePerLayerInfo","./TileUpdate","./tileUtils","./TilingSchemeLogic","./TransparencyMode","./UpsampleInfo","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../webgl-engine/lib/basicInterfaces","../../support/layerViewUtils","../../support/RenderState","../../support/Scheduler","../../support/TextureCompressionTracker","../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z,Y,X,K,J,ee,te,re,ie,se,ne,oe,ae,le,ce,ue,de,he,pe,me){"use strict";var fe;let ge=class extends(o.EventedMixin(i)){static{fe=this}get allTiles(){return this._allTiles}get demResolution(){const{_allTiles:e,tilingScheme:t}=this;if(0===e.length)return{min:1,max:1};const r=g.getMetersPerUnitForSR(t.spatialReference);let i=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(const n of e){const e=t.resolutionAtLevel(n.level)*r;i=Math.min(i,e),s=Math.max(s,e)}return{min:i,max:s}}constructor(e){super(e),this.terrainTextureCompressionTracker=new pe.TextureCompressionTracker,this._iteratorPool=new h(ie.IteratorPreorder,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new ie.IteratorPostorder,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new K,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=v.create(),this._eyePosSurfaceSR=v.create(),this._splitLimits=new Z.SplitLimits,this._frustum=R.create(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new S.UpdatingHandles,this._frameTask=he.ImmediateTask,this._allTiles=new p,this._upsampleInfoPool=new h(oe.UpsampleInfo),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=M.create(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=x.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new B.ElevationBounds(1/0,-1/0),this.rootTileElevationBounds=new B.ElevationBounds(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1;const t=e.view;this.overlayManager=new q.OverlayManager({...e,surface:this}),this._isGlobal=!t.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?Q.SphericalPatch:H.PlanarPatch,this._ellipsoid=w.getReferenceEllipsoid(t.spatialReference),this._renderer=new X.TerrainRenderer(this.overlayManager.renderer,t.stage,this._allTiles,this._ellipsoid.radius,this.terrainTextureCompressionTracker,t.resourceController.memoryController),ue.hasLayerBasedScaleVisibility()||(this._scaleRangeQueries=new $.ScaleRangeQueries)}initialize(){const t=this.view,r=t.resourceController,i=r.memoryController;this._tileCache=new d.MemCachePool(((e,t)=>i.newCache(e,t)),"terrain-tile"),this._upsampleMapCache=i.newCache("terrain-upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new A.ElevationQueryTileCache(i.newCache("elevation-query"));const s=this.overlayManager;this.addHandles([f.watch((()=>s.renderer.isEmpty),(()=>this._evaluateTransparency())),f.watch((()=>this.renderer.visible),(e=>this.suspended=!e)),f.watch((()=>this.heading),(e=>{this._renderer.updateHeading(e),this._updateTileTextures(z.TextureUpdate.FADING)})),f.watch((()=>({heading:t.camera?.heading,state:t.state?.mode})),(({heading:e,state:t})=>{if(null==e)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(e/90)%360);const r=Math.round(e)%360,i=Math.abs(r-this.heading);(t===de.RenderState.IDLE||Math.min(i,360-i)>=30)&&(this.heading=r)}))],"overlayManager"),this.addHandles([f.watch((()=>this.baseOpacity),(()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?z.TextureUpdate.UNFADED:z.TextureUpdate.IMMEDIATE)}),f.syncAndInitial),f.watch((()=>this.hasCompositeBlendMode),(()=>this._updateTileTextures(this._evaluateTransparency()?z.TextureUpdate.UNFADED:z.TextureUpdate.IMMEDIATE)),f.syncAndInitial),f.watch((()=>this.backgroundColor),((e,t)=>{e?.equals(t)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))}),f.sync),f.watch((()=>this.snapLevel),(()=>this._viewChanged=!0),f.sync),f.watch((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>this._allTilesSorted=!1))})),f.watch((()=>D.debugFlags.TERRAIN_TILE_TREE_SHOW_TILES),(r=>{r&&!this._treeDebugger?new Promise(((t,r)=>e(["../layers/support/TerrainTileTree3DDebugger"],t,r))).then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&D.debugFlags.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:t}))})):r||(this._treeDebugger=u.destroyMaybe(this._treeDebugger))}),f.initial)]);const{spatialReference:o}=t;this._extentHelper=k.create(this.viewingMode,{layers:t.map.allLayers,layerViews:t.allLayerViews,viewSpatialReference:o});const a=new n({getCollections:()=>t.defaultsFromMap?.mapCollections?.map((({layers:e})=>e)),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),l=new se.TilingSchemeLogic({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:o});this._set("tilingSchemeLogic",l),this._updateTilingScheme(),this._elevationDataRequester=r.createStreamDataRequester(U.ClientType.ELEVATION),this._mapDataRequester=r.createStreamDataRequester(U.ClientType.BASEMAP);const c=r.scheduler;this._frameTask=c.registerTask(he.TaskPriority.TERRAIN_SURFACE,this),this.addHandles([f.watch((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),f.initial),f.watch((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),f.sync),f.watch((()=>this.extent),(()=>this._updateRootTiles()),f.initial),t.on("resize",(()=>this._viewChangeUpdate())),f.watch((()=>{const e=t.state;return[this._lodBias,this.lodSnappingEnabled,t.quality,e.camera,e.contentCamera,e.fixedContentCamera]}),(()=>this._viewChangeUpdate()),f.syncAndInitial),f.watch((()=>t.qualitySettings?.fadeDuration),(e=>this._renderer.textureFadingEnabled=e>0),f.initial),f.watch((()=>t.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._renderer.pbrMode=e?le.PBRMode.Simplified:le.PBRMode.Disabled),f.initial),f.watch((()=>t.qualitySettings?.tiledSurface.elevationLevelDelta),(()=>this._updateAllTileGeometries())),f.watch((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),f.sync)]),this.addHandles(t.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",u.destroyMaybe(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",u.destroyMaybe(this.overlayManager)),this._tileCache=u.destroyMaybe(this._tileCache),ee.Tile.prune(),this._treeDebugger=u.destroyMaybe(this._treeDebugger),this._renderer.destroy(),this._iteratorPool=u.destroyMaybe(this._iteratorPool),this._upsampleMapCache=u.destroyMaybe(this._upsampleMapCache),this._elevationQueryCache=u.destroyMaybe(this._elevationQueryCache),this._set("view",null),this._extentHelper=u.destroyMaybe(this._extentHelper),this._upsampleInfoPool=u.destroyMaybe(this._upsampleInfoPool),te.printAllocations()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){const{view:e,tilingScheme:t}=this,r=e.scale;if(t&&r){const i=t.levelAtScale(r)+e.qualitySettings.tiledSurface.lodBias,s=t.getMaxLod();return i<=0?null:Math.min(i,s||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(null==t||null==e)return null;const r=M.create(),i=N.toBoundingRect(t,r,e)?r:null,s=this._get("extent");return M.equals(i,s)?s:i}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=M.intersection(this.groundExtent,this._userClippingExtent,M.create()),t=this._get("extent");return M.equals(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.terrainTextureCompressionTracker.compressing)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries?.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===ne.TransparencyMode.Opaque}get invisible(){return this._renderer.transparency===ne.TransparencyMode.Invisible}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,r,i){this._renderer.intersect(e,t,r,i)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(e,t,r,i){const s=this._rootTiles;if(!s?.length)return null;if(0===s[0].layerInfo[j.LayerClass.ELEVATION].length)return null;let n=this._elevationProjectorCache.get(i);if(void 0===n&&(n=T.getProjector(i,this._spatialReference)??null,this._elevationProjectorCache.set(i,n)),null==n)return l.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const o=b.set(_e,e,t,r);return n(o,0,o,0),xe(s,o[0],o[1])}getElevations(e,t,r){const i=this._rootTiles,s=i?i[0].layerInfo[j.LayerClass.ELEVATION].length:0;if(i?.length&&0!==s)for(let s=0;s<t;++s){const t=3*s;r(s,xe(i,e[t],e[t+1]))}else for(let e=0;e<t;++e)r(e,null)}getScale(e){if(!this.tilingScheme)return null;if(!C.projectPointToVector(e,_e,this.spatialReference))return l.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const e of t)if(e?.containsPoint(_e)){let t=e;for(;t.children[0]&&!t.rendered;){const e=t.children[0].extent;let r=0;_e[0]>e[2]&&(r+=1),_e[1]<e[1]&&(r+=2),t=t.children[r]}return this._getLodBiasCorrectedScale(t.level)}return 1/0}_ensureProjector(e){const t=this._projectorCache.get(e);if(t)return t;const r=T.getProjector(e,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(e,r),r}getSphereElevationBounds(e,t){const r=this._ensureProjector(t);if(null==r)return l.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;O.copy(e,be);const i=O.getCenter(be);r(i,0,i,0);const s=new F.ElevationRange,n=this._rootTiles;if(null!=n){const e=[];for(const t of n)e.push(t);let t=0;for(;t<e.length;){const r=e[t];if(++t,!M.intersectsSphere(r.extent,be))continue;const i=r.children;if(null==i[0]||r.rendered)s.expandElevationRangeValues(r.elevationBoundsMin,r.elevationBoundsMax);else for(const t of i)e.push(t)}}return s}getRootElevationBounds(){return new F.ElevationRange(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){const e=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(e,this._ellipsoid.radius)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!C.projectPointToVector(e,O.getCenter(be),this.spatialReference))return l.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;be[3]=t;let r=null;const i=e=>{if(e&&M.intersectsSphere(e.extent,be)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)i(e);else{const t=this._getLodBiasCorrectedScale(e.level);r=null==r?t:Math.min(r,t)}}},s=this._rootTiles;if(null!=s)for(const e of s)i(e);return r}queryVisibleScaleRange(e,t,r,i){if(!this._scaleRangeQueries)return;const s=t?this.tilingScheme.levelAtScale(t):0,n=r?this.tilingScheme.levelAtScale(r):1/0,o=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,s+o,n+o,i)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,r=this._renderer.transparency,i=this._isFullyTransparent?t?ne.TransparencyMode.Invisible:ne.TransparencyMode.InvisibleWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?ne.TransparencyMode.Opaque:ne.TransparencyMode.Transparent;return this._renderer.transparency=i,r!==i}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;J.weakAssert(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??x.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&E.isPlateCarree(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.tileSize=e.pixelSize,this.overlayManager.spatialReference=e.spatialReference,this._updateRootTiles())}static{this._tileMemcacheKey="TerrainTileMemcache"}_acquireTile(e,t,r,i){const s=this._tileCache.pop(fe._tileMemcacheKey);return s?(s.init(e,t,r,i,this),s):new this._tileConstructor(e,t,r,i,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const r=ve;let i=t.rootTilesInExtent(e,r,5*Y.maxRootTiles);if(null!=this._rootTiles){if(i.length>Y.maxRootTiles)return void l.getLogger(this).warn(Y.tooManyRootTilesAfterChangeError);const e=this._rootTiles.map((e=>e.lij)),t=s.difference(e,i,ee.lijEquals);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter((e=>!(t.removed.findIndex((t=>ee.lijEquals(t,e.lij)))>-1&&(this._purgeTile(e),1))));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,i.length>Y.maxRootTiles&&(l.getLogger(this).warn(Y.tooManyRootTilesForLayerError),i=t.rootTilesInExtent(e,r,Y.maxRootTiles)),this._setRootTiles(i.map((e=>this._newRootTile(e))));M.equals(r,this._rootTilesExtent)||(this._rootTilesExtent=M.create(r)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter((e=>e.loaded&&e.intersectsClippingArea));e.sort(ie.compareTilesByLij),e.forEach((e=>this._renderer.updateTileGeometryState(e))),e.forEach((e=>e.renderData.updateNeighborData())),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(ie.compareTilesByLij);const t=this.renderer;e.forEach((e=>t.updateGeometryIfNeeded(e))),e.forEach((e=>this._pendingTilesForElevationUpdateEvent.add(e)))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===re.TileUpdate.SPLIT}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(re.TileUpdate.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e),this.notifyChange("demResolution")}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(re.TileUpdate.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=ie.hasLoadableSiblings(e),r=this.visibleElevationBounds;let i=t?r.min:1/0,s=t?r.max:-1/0;const n=this.extent,o=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const a=this._iteratorPool.acquire();for(a.reset(e);!a.done;){const e=a.next();e.updateClippingStatus(n)&&e.resetPendingUpdate(re.TileUpdate.GEOMETRY)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(o),e.renderData&&(i=Math.min(e.elevationBoundsMin,i),s=Math.max(e.elevationBoundsMax,s))}a.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(i)&&isFinite(s)&&(r.min!==i||r.max!==s)&&(this.visibleElevationBounds=new B.ElevationBounds(i,s))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const r=this._rootTiles;null!=r&&r.forEach((({elevationBoundsMin:r,elevationBoundsMax:i})=>{e=Math.min(e,r),t=Math.max(t,i)}));const i=this.rootTileElevationBounds;i.min===e&&i.max===t||(this.rootTileElevationBounds=new B.ElevationBounds(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,r=Math.tan(.5*t.fovX),i=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=r,this._splitLimits.fovY=i,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=R.copy(this._splitLimits.frustum??R.create(),t.frustum):this._splitLimits.frustum=null,R.copy(this._frustum,e.frustum),b.copy(this._eyePosRenderSR,t.eye),P.projectVectorToVector(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor((e=>{this._layerViews[j.LayerClass.MAP].some(J.isVectorTileLayerView)&&e.setPendingUpdate(re.TileUpdate.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)}))}_updateTileTexture(e,t){const r=e.resetPendingUpdate(re.TileUpdate.TEXTURE_FADING)?re.TileUpdate.TEXTURE_FADING:!!e.resetPendingUpdate(re.TileUpdate.TEXTURE_NOFADING)&&re.TileUpdate.TEXTURE_NOFADING;r&&(this._renderer.updateTileTexture(e,r),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=Se.extent;M.empty(e),this._pendingTilesForElevationUpdateEvent.forEach((t=>M.expand(e,t.extent,e))),this._pendingTilesForElevationUpdateEvent.clear(),Se.spatialReference=this.spatialReference,this.emit("elevation-change",Se),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),J.enableTerrainInternalChecks&&this._checkTileInvariant(),!e.hasProgressed)return me.Yield}_checkTileInvariant(){const e=new Map;this._allTiles.forAll((t=>e.set(t,new Set))),this._allTiles.forAll((t=>{if(J.weakAssert(t.rendered===t.leaf,` rendered ${t.rendered} != ${t.leaf} leaf`),!t.leaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,r=t.children.reduce(((t,r)=>t+(e(r)?0:1)),0);if(J.weakAssert(t.unmergableChildCount===r,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${r}`),t.hasPendingUpdate(re.TileUpdate.MERGE)){J.weakAssert(!t.hasPendingUpdate(re.TileUpdate.SPLIT),"Tile can be both split and merge at the same time");for(const e of t.children)J.weakAssert(e.leaf||e.hasPendingUpdate(re.TileUpdate.MERGE),"Child of tile to merge must also merge")}}for(let r=0;r<4;++r){if(t.rendered){const e=t.renderData?.geometryState.edgePeerNeighbors[r];if(null!=e){{const i=t.level-e.level<=Y.maxTileNeighborLevelDelta;i||(console.log(`tile level delta [${t.lij.toString()}] vs [${e.lij.toString()}] > ${Y.maxTileNeighborLevelDelta}  (edge[${r}])`),J.weakAssert(i,`tile level delta [${t.level}] vs [${e.level}] > ${Y.maxTileNeighborLevelDelta}`))}J.weakAssert(t.level-e.level<=Y.maxTileNeighborLevelDelta,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${e.lij.toString()}]`)}}const i=t.level-Y.maxTileNeighborLevelDelta,s=e=>e.leaf||e.level===t.level,n=t.findNeighborTile(J.neighborEdgeIndices[r],s);if(null!=n){if(t.leaf&&t.level>=Y.maxTileNeighborLevelDelta){let r=n;for(;t.level-r.level<Y.maxTileNeighborLevelDelta;)r=r.parent;const s=[i,t.lij[1]>>Y.maxTileNeighborLevelDelta,t.lij[2]>>Y.maxTileNeighborLevelDelta];if(!ee.lijEquals(s,r.lij)){const i=e.get(r);J.weakAssert(!i.has(t),"Cannot already have neighbor"),i.add(t)}}J.weakAssert(n.rendered||n.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),J.weakAssert(t.level-n.level<=Y.maxTileNeighborLevelDelta,`Tile level delta [${t.level}] vs [${n.level}] > ${Y.maxTileNeighborLevelDelta}`)}}})),this._allTiles.forAll((t=>{const r=t.maxLevelDeltaNeighborCount,i=e.get(t);J.weakAssert(r===i.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${r} vs ${i.size}`)}))}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new Te(this._allTiles.length);t.pushAll(this._rootTiles);const r=this.snapLevel,i=this._splitLimits,s=this._eyePosRenderSR;this._allTiles.forAll((e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0}));const n=this.view.state.contentCamera.viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),o=e.parent,a=null!=o&&o.hasPendingUpdate(re.TileUpdate.MERGE),l=a?re.TileUpdate.MERGE:e.shouldSplit(i,s,r),c=l===re.TileUpdate.SPLIT;e.leaf?Ce(e,c):t.pushAll(e.children),a?(e.resetPendingUpdate(re.TileUpdate.SPLIT),e.leaf||e.setPendingUpdate(re.TileUpdate.MERGE),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(n)):c?(e.resetPendingUpdate(re.TileUpdate.MERGE),e.leaf&&e.setPendingUpdate(re.TileUpdate.SPLIT)):(e.resetPendingUpdate(re.TileUpdate.SPLIT)&&e.updateAgentSuspension(),l===re.TileUpdate.ELEVATION&&e.updateAgents(j.LayerClass.ELEVATION),e.leaf||(e.setPendingUpdate(re.TileUpdate.MERGE),e.resetPendingUpdate(re.TileUpdate.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(ie.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){J.internalAssert(e.loaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter((e=>e.loaded&&e.intersectsClippingArea));if(0===t.length)return void e.clear();const r=(r,i)=>{!i?.loaded||!i.intersectsClippingArea||i.level<r.level||e.has(i)||(e.add(i),t.push(i),i.renderData.updateNeighborData())};t.sort(ie.compareTilesByLij);const i=t.length;for(let s=0;s<i;++s){const i=t[s];J.internalAssert(i.loaded),J.internalAssert(i.intersectsClippingArea);const n=i.renderData;n.updateNeighborData();const o=n.dirtyEdgeResolutions,a=n.geometryState,l=e=>{const t=J.neighborCornerIndices[e];r(i,a.cornerPeerNeighbors[e]?.findCorner(J.oppositeCorner(t),(e=>e.loaded)))};for(let t=0;t<4;++t)if(o&1<<t){const s=n.geometryState.edgePeerNeighbors[t];s&&s?.level>=i.level&&s.forAllSubtreeOnSide(J.oppositeEdge(J.neighborEdgeIndices[t]),(t=>!(!t.loaded||!t.intersectsClippingArea||(J.internalAssert(e.has(t)||ie.compareTilesByLij(i,t)<0),r(i,t),0)))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,J.enableTerrainInternalChecks&&J.enableWaterproofTests&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let r=!1;const i=this.view.state.fixedContentCamera;let s=!1;for(;!e.done;){s=!0;let n=!1;const o=!this._allTiles.some((s=>{if(!r&&!i&&!s.visible)return e.done;let o=s;if(s.hasPendingUpdate(re.TileUpdate.MERGE)){if(!t||s.unmergableChildCount>0)return e.done;for(s.resetPendingUpdate(re.TileUpdate.MERGE);null!=o.parent&&0===o.parent.unmergableChildCount&&o.parent.resetPendingUpdate(re.TileUpdate.MERGE);)o=o.parent;this._mergeTile(o),n=!0,e.madeProgress()}else if(s.resetPendingUpdate(re.TileUpdate.SPLIT)){let t=!0;const r=s.level;if(r>=Y.maxTileNeighborLevelDelta){const e=e=>e.leaf||r-e.level<Y.maxTileNeighborLevelDelta;for(let i=0;i<4;++i){const n=s.findNeighborTile(J.neighborEdgeIndices[i],e);null!=n&&r-n.level===Y.maxTileNeighborLevelDelta&&(t=!1,J.enableTerrainInternalChecks&&(J.internalAssert(n.leaf),J.internalAssert(n.hasPendingUpdate(re.TileUpdate.SPLIT))))}}t?(this._splitTile(s),e.madeProgress(),n=!0):s.setPendingUpdate(re.TileUpdate.SPLIT)}return e.done}));if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),o){if(!r){r=!0;continue}if(!n)break}else this._allTilesDirty=!0}s?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some((t=>(t.resetPendingUpdate(re.TileUpdate.GEOMETRY)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done))),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done)))}_updateClippingExtent(){this.spatialReference&&(this.overlayManager?.updateOverlayParameters(ce.RenderRequestType.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Y.maxMemoryLodBias}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,r=c.clamp(e-this._lodBias,0,t.length-1),i=r-Math.floor(r);return t[Math.floor(r)].scale*(1-i)+t[Math.ceil(r)].scale*i}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.notifyChange("demResolution"),this.renderer.visible=!1}_purgeSubtree(e){const t=e.children;t[0]&&(this._purgeTile(t[0]),this._purgeTile(t[1]),this._purgeTile(t[2]),this._purgeTile(t[3]),e.clearChildren())}_purgeTile(e){e.leaf?Me(e):this._purgeSubtree(e),this._allTiles.removeUnordered(e),this._unloadTile(e),e.dispose(),this._tileCache.put(fe._tileMemcacheKey,e),this.notifyChange("demResolution")}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload()}_splitTile(e){J.weakAssert(e.leaf,"Tile that is already split should not be split again!"),J.weakAssert(e.rendered,"Tile marked to split is not rendered"),Me(e);const t=e.createChildren();this._allTiles.pushArray(t),this.notifyChange("demResolution"),e.updateAgentSuspension(),J.weakAssert(e.rendered,"parent should be rendered"),t.forEach((e=>this._loadTile(e))),t.forEach((e=>this._pendingTilesToUpdate.add(e))),this._unloadTile(e),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),t.forEach((e=>Ce(e,e.hasPendingUpdate(re.TileUpdate.SPLIT)))),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){we.spatialReference=this.spatialReference,we.extent=e.extent,we.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",we)}createTile(e,t,r,i){J.weakAssert(!!i,"createTile sanity check");const s=this._acquireTile(e,t,r,i);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(re.TileUpdate.SPLIT),s}get _shortBatches(){return this.view.state.mode!==de.RenderState.IDLE}_mergeTile(e){J.weakAssert(!e.hasPendingUpdate(re.TileUpdate.SPLIT),"_mergeTile sanity check"),J.weakAssert(!e.leaf,"Cannot merge a leaf"),e.leaf||(this._purgeSubtree(e),J.weakAssert(!e.renderData,"Merging tile with existing render data?"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),Ce(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&this.overlayManager.updateTileOverlayParameters(e)}_handleLayerViewChanges(e=he.noBudget){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const r=new Set;let i=-1;for(let e=this.view.allLayerViews.length-1;e>=0;e--){const s=this.view.allLayerViews.items[e];if(r.add(s.uid),J.isSurfaceLayerView(s)||J.isGroupLayerView(s))if(this._basemapLayerViewHandles.has(s.uid)&&!J.isGroupLayerView(s)){const e=this._layerClassFromLayerView(s),r=this._getLayerIdxByUID(e,s.uid);null!=r&&((r<i||null==i)&&(t=!0),i=r)}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach(((e,i)=>{r.has(i)||(this._unregisterTiledLayerView(i),t=!0)})),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}get _isFullyTransparent(){if(this.view.map?.ground?.opacity>0)return!1;for(const e of this.view.allLayerViews.items)if(J.isMapTileLayerView(e)&&!I.isBaseLayer(e.layer)&&0!==e.fullOpacity)return!1;return!0}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if((J.isBlendableLayerView(e)||J.isGroupLayerView(e))&&ae.isCompositeBlendMode(ae.blendModeFromString[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return J.isElevationLayerView(e)?j.LayerClass.ELEVATION:j.LayerClass.MAP}_registerTiledLayerView(e){const t=[];if((J.isBlendableLayerView(e)||J.isGroupLayerView(e))&&t.push(f.watch((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(z.TextureUpdate.UNFADED)}))),!J.isGroupLayerView(e)){const r=this._layerClassFromLayerView(e);t.push(f.watch((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push(f.watch((()=>e.fullOpacity),(()=>this._updateTileTextures(z.TextureUpdate.UNFADED)))),t.push(f.watch((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(r)))),t.push(e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(r,e.uid);null!=t&&this._invalidateLayerData(t,r)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let r=null;e.forEach((e=>{if(!e.layer||e.suspended||!J.isSurfaceLayerView(e)||!e.fullExtent)return;const i=this._layerClassFromLayerView(e);if(i===j.LayerClass.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===r||t>r)&&(r=t)}t[i].push(e)}));for(const e of j.LayerClasses){const r=this._layerViews[e],i=t[e];i.reverse();const s=i.length;let n=r.length!==s;const o=new Array(s),a=new Array(r.length);this._layerIndexByUid[e].clear();for(let t=0;t<s;t++){const s=i[t].uid;this._layerIndexByUid[e].set(s,t);const l=r.indexOf(i[t]);o[t]=l,t!==l&&(n=!0),l>-1&&(a[l]=t)}if(n){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;)t.next().modifyLayers(a,o,e);this._layerViews[e]=i,this._restartAllAgents(e),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(r)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const r=t.next();r.restartAgents(e),e===j.LayerClass.ELEVATION&&r.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(j.LayerClass.MAP),e===z.TextureUpdate.IMMEDIATE?this.renderer.updateTileTexture(t,re.TileUpdate.TEXTURE_NOFADING):t.updateRenderData(j.LayerClass.MAP,e)})),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll((r=>r.removeLayerAgent(e,t))),this._allTiles.forAll((r=>r.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=ce.RenderRequestType.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){1===++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,r,i){const s=this.layerViewByIndex(t,r),n=s.layer;return!n.tilemapCache||J.isVectorTileLayerView(s)?this._requestTileData(e,r,s,i):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.level,e.lij[1],e.lij[2],{...i,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,m.throwIfAborted(i),m.isAbortError(t)||this._dataMissing(e,r,s),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,r,s,i)),i.signal))))}_requestTileData(e,t,r,i){if(this.destroying)return Promise.resolve();const s=t===j.LayerClass.ELEVATION;return i.requester??=s?this._elevationDataRequester:this._mapDataRequester,s?J.isElevationLayerView(r)?this._requestElevationTileData(e,r,i):Promise.reject():J.isMapTileLayerView(r)?this._requestMapTileData(e,r,i):Promise.reject()}_requestElevationTileData(e,t,r){++this._asyncWorkItems;const i=i=>{!m.isAborted(r)&&i&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(e,t,i))};return t.fetchElevationTile(e,r).then((e=>this._frameTask.schedule((()=>i(e)))),(r=>{m.isAbortError(r)||(l.getLogger(this).error(`Tile ${e.lij.toString()} layer ${j.LayerClass.ELEVATION}/${t.uid} error ${r}`),this._dataMissing(e,j.LayerClass.ELEVATION,t),this.requestUpdate())})).finally((()=>--this._asyncWorkItems))}_elevationDataArrived(e,t,r){const i=this._layerIndexByUid[j.LayerClass.ELEVATION].get(t.uid);if(null==i)return void l.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",j.LayerClass.ELEVATION,e.lij.toString());const s=new G.ElevationData(e.lij,e.extent,r);e.dataArrived(i,j.LayerClass.ELEVATION,s);const n=[e],o=e.level,a=this._iteratorPool.acquire();for(a.reset(n);!a.done;){const e=a.next();e.findElevationBoundsForLayer(i,o),e.computeElevationBounds()}0===o&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(n)}_requestMapTileData(e,t,r){++this._asyncWorkItems;const i=(i,s)=>{J.releaseTerrainData(s),m.isAborted(r)||(console.error(`Tile ${e.lij.toString()} layer ${j.LayerClass.MAP}/${t.uid} error ${i}`),this._dataMissing(e,j.LayerClass.MAP,t),this.requestUpdate())},s=e=>t=>i(t,e);return t.fetchTile(e.lij,r).then((i=>this._frameTask.schedule((()=>{this.requestUpdate(),m.isAborted(r)?J.releaseTerrainData(i):this._mapTileDataArrived(e,t,i)}),r.signal,s(i)).catch(s(i))),((e,t=null)=>this._frameTask.schedule((()=>i(e,t))))).finally((()=>--this._asyncWorkItems))}_mapTileDataArrived(e,t,r){const i=this._getLayerIdxByUID(j.LayerClass.MAP,t.uid);if(null==i)return J.releaseTerrainData(r),void l.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(i,j.LayerClass.MAP,r)}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,r){const i=this._getLayerIdxByUID(t,r.uid);null!=i?e.dataMissing(i,t):l.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.leaf&&e.numLeaves++;const r=t.level;t.renderData&&(e.numLoadedPerLevel[r]=(e.numLoadedPerLevel[r]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[r]=(e.numRenderedPerLevel[r]||0)+1,e.numRendered++))})),e}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce(((e,t)=>e+t.usedMemory),0)):null}getUsedMemoryForLayerView(e){let t=0;const r=this._layerClassFromLayerView(e),i=this._getLayerIdxByUID(r,e.uid);return null!=i&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(r,i))),t}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!J.enableWaterproofTests)return;const e=this._rootTiles;if(null==e)return;const t=e=>e?.renderData?.geometry?.indices?.length>0,r=(e,r)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",r.lij,"] has geom")},i=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometry||(e.renderData.geometry.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)r(t,e)}else if(e.leaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)i(t)},s=e=>{const t=e.parent?.visible??!0,r=e.visible;e.computeVisibility();const i=e.visible;if(r!==i&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",r," instead of ",i),!e.leaf)for(const t of e.children)s(t)};for(const t of e)i(t),s(t)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),r=e[2];if(0<=r&&r<t)return e;if(!this._isGlobal)return null;const i=(r+(r<0?t:0))%t;return[e[0],e[1],i]}enableInternalChecks(e){J.enableInternalTerrainChecks(e)}enableWaterproofnessChecks(e){J.enableTerrainWaterproofChecks(e)}};t.__decorate([y.property()],ge.prototype,"_renderer",void 0),t.__decorate([y.property({constructOnly:!0})],ge.prototype,"_scaleRangeQueries",void 0),t.__decorate([y.property({constructOnly:!0})],ge.prototype,"view",void 0),t.__decorate([y.property({constructOnly:!0})],ge.prototype,"overlayManager",void 0),t.__decorate([y.property({constructOnly:!0})],ge.prototype,"terrainTextureCompressionTracker",void 0),t.__decorate([y.property()],ge.prototype,"_hasPendingUpdates",void 0),t.__decorate([y.property()],ge.prototype,"_asyncWorkItems",void 0),t.__decorate([y.property()],ge.prototype,"_allTilesDirty",void 0),t.__decorate([y.property()],ge.prototype,"_allTilesSorted",void 0),t.__decorate([y.property()],ge.prototype,"_viewChanged",void 0),t.__decorate([y.property({type:Number})],ge.prototype,"heading",void 0),t.__decorate([y.property()],ge.prototype,"_splitLimits",void 0),t.__decorate([y.property({readOnly:!0})],ge.prototype,"_watchUpdatingTracking",void 0),t.__decorate([y.property()],ge.prototype,"_frameTask",void 0),t.__decorate([y.property()],ge.prototype,"demResolution",null),t.__decorate([y.property({readOnly:!0})],ge.prototype,"snapLevel",null),t.__decorate([y.property({readOnly:!0})],ge.prototype,"lodSnappingEnabled",null),t.__decorate([y.property()],ge.prototype,"_userClippingExtent",null),t.__decorate([y.property()],ge.prototype,"_rootTilesExtent",void 0),t.__decorate([y.property({readOnly:!0})],ge.prototype,"extent",null),t.__decorate([y.property({readOnly:!0})],ge.prototype,"groundExtent",null),t.__decorate([y.property({readOnly:!0})],ge.prototype,"_tilingSchemeExtent",null),t.__decorate([y.property({readOnly:!0})],ge.prototype,"updating",null),t.__decorate([y.property({readOnly:!0})],ge.prototype,"running",null),t.__decorate([y.property(V.updatingProgress)],ge.prototype,"updatingProgress",void 0),t.__decorate([y.property({readOnly:!0})],ge.prototype,"updatingProgressValue",null),t.__decorate([y.property()],ge.prototype,"_maxNumUpdating",void 0),t.__decorate([y.property()],ge.prototype,"baseOpacity",null),t.__decorate([y.property()],ge.prototype,"hasCompositeBlendMode",void 0),t.__decorate([y.property({readOnly:!0})],ge.prototype,"viewingMode",null),t.__decorate([y.property()],ge.prototype,"maxTextureScale",void 0),t.__decorate([y.property({readOnly:!0})],ge.prototype,"ready",null),t.__decorate([y.property({value:W.RenderOrder.FRONT_TO_BACK})],ge.prototype,"renderOrder",null),t.__decorate([y.property({readOnly:!0})],ge.prototype,"rootTiles",null),t.__decorate([y.property()],ge.prototype,"_rootTiles",void 0),t.__decorate([y.property({readOnly:!0})],ge.prototype,"spatialReference",null),t.__decorate([y.property({type:r})],ge.prototype,"backgroundColor",null),t.__decorate([y.property({value:!1})],ge.prototype,"slicePlaneEnabled",null),t.__decorate([y.property({readOnly:!0})],ge.prototype,"tilingScheme",void 0),t.__decorate([y.property({readOnly:!0})],ge.prototype,"tilingSchemeLocked",null),t.__decorate([y.property({readOnly:!0})],ge.prototype,"tilingSchemeLogic",void 0),t.__decorate([y.property()],ge.prototype,"wireframe",null),t.__decorate([y.property({value:!1})],ge.prototype,"suspended",null),t.__decorate([y.property()],ge.prototype,"fadeDuration",null),t.__decorate([y.property()],ge.prototype,"visibleElevationBounds",void 0),t.__decorate([y.property()],ge.prototype,"rootTileElevationBounds",void 0),t.__decorate([y.property()],ge.prototype,"_layerViewsDirty",void 0),t.__decorate([y.property()],ge.prototype,"renderPatchBorders",null),t.__decorate([y.property()],ge.prototype,"visualizeNormals",null),t.__decorate([y.property()],ge.prototype,"renderingDisabled",null),ge=fe=t.__decorate([_.subclass("esri.views.3d.terrain.TerrainSurface")],ge);const ye=ge,_e=v.create(),be=O.create(),ve=M.create();new p;const Se=new L.ElevationUpdateEvent("ground"),we={spatialReference:null,extent:null,scale:0};function xe(e,t,r){for(const i of e){if(!i.containsPointXY(t,r))continue;let e=i;for(;e&&!e.renderData;){const i=(t>e.extentMidX?1:0)+(r<e.extentMidY?2:0);e=e.children[i]}const s=e?.renderData?.geometryState.samplerData??null;return G.sampleElevation(t,r,s)}return null}class Te{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const r=this._tail;if(!(r+t<=this.capacity))throw new Error("Queue full");for(let i=0;i<t;++i)this._data[r+i]=e[i];this._tail=r+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function Ce(e,t){!e.leaf||e.level<Y.maxTileNeighborLevelDelta||Ee(e,(e=>{t&&Pe(e);const r=Re(e);if(e.maxLevelDeltaNeighborCount++,r){let t=e.parent;for(;t;){const e=Re(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}}))}function Pe(e){if(e.hasPendingUpdate(re.TileUpdate.SPLIT))return;let t=e.parent;for(;t?.resetPendingUpdate(re.TileUpdate.MERGE);)t=t.parent;e.resetPendingUpdate(re.TileUpdate.MERGE),e.leaf&&e.setPendingUpdate(re.TileUpdate.SPLIT),e.level<Y.maxTileNeighborLevelDelta||Ee(e,(e=>{Pe(e)}))}function Me(e){e.level<Y.maxTileNeighborLevelDelta||Ee(e,(e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,Re(t));)t=t.parent}}))}function Re(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function Ee(e,t){if(e.level<Y.maxTileNeighborLevelDelta)return;const r=e.level-Y.maxTileNeighborLevelDelta,i=e.lij[1]>>Y.maxTileNeighborLevelDelta,s=e.lij[2]>>Y.maxTileNeighborLevelDelta,n=e=>e.leaf||e.level===r;for(let o=0;o<4;++o){const a=e.findNeighborTile(J.neighborEdgeIndices[o],n);if(!a||a.level!==r)continue;const l=a.lij;l[1]===i&&l[2]===s||t(a)}}return ye}))},"esri/core/MemCachePool":function(){define(["exports","./Logger","./MemCache"],(function(e,t,r){"use strict";class i extends Array{constructor(e){super(),this.item=e,this.cachedMemory=e.cachedMemory,this.push(e)}}e.MemCachePool=class{constructor(e,i){this._cache=e(i,((e,i,s)=>{switch(i){case r.RemoveMode.ALL:return e.forEach((e=>e.dispose())),0;case r.RemoveMode.SOME:{const r=e.shift();return r?(s-=Math.round(r.cachedMemory),r.dispose()):s>0&&(t.getLogger("esri/core/MemCachePool").warn("Encountered empty MemCachePool with non-zero memory."),s=0),s}}}))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const r=t.pop();return t.length>0?r&&(t.cachedMemory=this._cache.getSize(e)-Math.round(r.cachedMemory),this._cache.updateSize(e,t)):this._cache.pop(e),r}put(e,t,s=r.NoPriority){const n=this._cache.peek(e);if(n)n.push(t),n.cachedMemory=this._cache.getSize(e)+Math.round(t.cachedMemory),this._cache.updateSize(e,n);else{const r=new i(t);this._cache.put(e,r,s)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/ElevationQueryTileCache":function(){define(["exports"],(function(e){"use strict";e.ElevationQueryTileCache=class{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,t){this._store.put(e,t)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/ElevationUpdateEvent":function(){define(["exports","../../../geometry/support/aaBoundingRect"],(function(e,t){"use strict";e.ElevationUpdateEvent=class{constructor(e="scene"){this.context=e,this.extent=t.empty()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/updatingProperties":function(){define(["exports"],(function(e){"use strict";const t={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};e.updatingProgress=t,e.updatingProgressValue={value:.5,readOnly:!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/ElevationBounds":function(){define(["exports"],(function(e){"use strict";e.ElevationBounds=class{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/ElevationData":function(){define(["exports","../../../core/mathUtils","../../../layers/support/ElevationSamplerData","../support/mathUtils","./TerrainConst"],(function(e,t,r,i,s){"use strict";const n=.5*s.elevationNoDataValue;e.ElevationData=class{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new r.ElevationSamplerData(i,t)}computeMinMaxValue(e,t,r,n){n.min=1/0,n.max=-1/0,n.hasNoDataValues=!1;const o=e-this.level;if(o<=0)return n;const a=2**o;if(Math.floor(t/a)!==this.i||Math.floor(r/a)!==this.j)return n;let l=1/0,c=-1/0;const u=this.samplerData.data.width,d=this.samplerData.data.values,h=.5*s.elevationNoDataValue;let p=(u-1)/a,m=(r-this.j*a)*p,f=(t-this.i*a)*p;if(p<1){const e=Math.floor(m),t=Math.floor(f),r=e+t*u,s=d[r],o=d[r+1],a=d[r+u],l=d[r+u+1];if(s+o+a+l<h){const r=m-e,c=f-t,u=i.bilerp(s,o,a,l,r,c),d=i.bilerp(s,o,a,l,r+p,c),h=i.bilerp(s,o,a,l,r,c+p),g=i.bilerp(s,o,a,l,r+p,c+p);return n.min=Math.min(u,d,h,g),n.max=Math.max(u,d,h,g),n}m=e,f=t,p=1}else m=Math.floor(m),f=Math.floor(f),p=Math.ceil(p);for(let e=m;e<=m+p;e++)for(let t=f;t<=f+p;t++){const r=d[e+t*u];r<h?(l=Math.min(l,r),c=Math.max(c,r)):n.hasNoDataValues=!0}return n.min=l,n.max=c,n}},e.sampleElevation=function(e,r,i){if(null==i)return null;for(const s of i){if(!s)continue;const i=s.safeWidth;let o=t.clamp(s.dy*(s.y1-r),0,i),a=t.clamp(s.dx*(e-s.x0),0,i);const l=Math.floor(o),c=Math.floor(a),u=s.data.width,d=l*u+c,h=s.data.values,p=h[d],m=h[d+1],f=d+u,g=h[f],y=h[f+1];if(p+g+m+y<n){o-=l,a-=c;const e=p+(m-p)*a;return e+(g+(y-g)*a-e)*o}}return null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/ElevationSamplerData":function(){define(["exports"],(function(e){"use strict";e.ElevationSamplerData=class{constructor(e,t){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(t[2]-t[0]),this.dy=(e.width-1)/(t[3]-t[1]),this.x0=t[0],this.y1=t[3]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/ExtentHelper":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/projectionUtils","../../../geometry/support/aaBoundingRect","../../../layers/support/layerUtils","../../ViewingMode","./TerrainConst","./terrainUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.ExtentHelper=class extends r{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const r=t.layer;if("operationalLayerType"in r&&u.isIntegratedMeshOperationalLayer(r.operationalLayerType)&&null!=this.viewSpatialReference){const t=g(r.fullExtent,this.viewSpatialReference);null!=t&&e.push(c.fromExtent(t))}})),e}},t.__decorate([i.property({readOnly:!0})],e.ExtentHelper.prototype,"layerViewsExtent",null),t.__decorate([i.property({readOnly:!0})],e.ExtentHelper.prototype,"tiledLayersExtent",null),t.__decorate([i.property({readOnly:!0})],e.ExtentHelper.prototype,"stencilEnabledExtents",null),t.__decorate([i.property()],e.ExtentHelper.prototype,"viewSpatialReference",void 0),t.__decorate([i.property()],e.ExtentHelper.prototype,"tilingScheme",void 0),t.__decorate([i.property()],e.ExtentHelper.prototype,"defaultTiledLayersExtent",void 0),t.__decorate([i.property({constructOnly:!0})],e.ExtentHelper.prototype,"layers",void 0),t.__decorate([i.property({constructOnly:!0})],e.ExtentHelper.prototype,"layerViews",void 0),e.ExtentHelper=t.__decorate([a.subclass("esri.views.3d.terrain.ExtentHelper")],e.ExtentHelper);let m=class extends e.ExtentHelper{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?h.webMercatorWorldExtent:h.geographicWorldExtent}};m=t.__decorate([a.subclass("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],m);let f=class extends e.ExtentHelper{_computeLayerViewsExtent(){const e=c.empty(),t=this.viewSpatialReference;this.layerViews.forEach((r=>{const i=r.layer;if(r.isResolved()&&("graphics"!==i.type||!i.internal)){const i=g("fullExtentInLocalViewSpatialReference"in r&&r.fullExtentInLocalViewSpatialReference||r.layer.fullExtent,t);c.expand(e,i,e)}}));const r=c.allFinite(e)?e:null,i=this._get("layerViewsExtent");return c.equals(r,i)?i:r}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,r=c.empty();this.layers.forEach((i=>{if(i.loaded&&u.isTiledLayer(i)){const s=p.getTiledLayerInfo(i,t,d.ViewingMode.Local);if(null==s)return;const{tileInfo:n,fullExtent:o}=s,a="tilemapCache"in i?i.tilemapCache?.effectiveMaxLOD:void 0;null!=n&&null!=o&&(p.isProjectableRasterLayer(i)||e.compatibleWith(n,a)&&o.spatialReference.equals(e.spatialReference))&&c.expand(r,o,r)}})),c.expand(r,this.defaultTiledLayersExtent,r);const i=c.allFinite(r)?r:null,s=this._get("tiledLayersExtent");return c.equals(i,s)?s:i}};function g(e,t){return null==e||e.spatialReference.equals(t)?e:l.projectWithoutEngine(e,e.spatialReference,t)}f=t.__decorate([a.subclass("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],f),e.create=function(e,t){return e===d.ViewingMode.Global?new m(t):new f(t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/terrainUtils":function(){define(["exports","../../../core/Collection","../../../geometry/support/spatialReferenceUtils","../../../layers/support/layerUtils","../../ViewingMode","./NeighborIndex","./TerrainData","../../../chunks/terrainUtilsPlanar","../../../chunks/terrainUtilsSpherical"],(function(e,t,r,i,s,n,o,a,l){"use strict";const c={[s.ViewingMode.Global]:l.terrainUtilsSpherical,[s.ViewingMode.Local]:a.terrainUtilsPlanar};function u(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function d(e){return"imagery-tile-3d"===e?.type}function h(e){return"tile-3d"===e?.type}function p(e){return"vector-tile-3d"===e?.type}function m(e){return"wmts-3d"===e?.type}function f(e){return"elevation-3d"===e?.type}function g(e){return e&&(h(e)||d(e)||p(e)||m(e))}function y(e){return o.isVectorTile(e?.data)}function _(e,t,r,i,s){return c[i].checkIfTileInfoSupportedForViewSR(e,r,t,s)}function b(e,r,s){const n=i.getTileMaxtrixSetFromActiveLayer(e);if(null!=n){if(!t.isCollection(n))return{tileInfo:n.tileInfo,fullExtent:n.fullExtent};{const e=n.find((e=>null==_(e.tileInfo,e.fullExtent,r,s)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function v(e){return e.isWGS84||e.isWebMercator||r.isCGCS2000(e)||!r.isEarth(e)}e.enableTerrainInternalChecks=!1,e.enableWaterproofTests=!1;const S={force512VTL:!1},w=[n.NeighborIndex.NORTH,n.NeighborIndex.EAST,n.NeighborIndex.SOUTH,n.NeighborIndex.WEST],x=[n.NeighborIndex.NORTH_EAST,n.NeighborIndex.SOUTH_EAST,n.NeighborIndex.SOUTH_WEST,n.NeighborIndex.NORTH_WEST],T=1e-5;e.almostEquals=function(e,t,r=T){return Math.abs(e-t)<r},e.checkIfTileInfoSupportedForView=_,e.enableInternalTerrainChecks=function(t){e.enableTerrainInternalChecks=t},e.enableTerrainWaterproofChecks=function(t){e.enableWaterproofTests=t,e.enableTerrainInternalChecks=e.enableTerrainInternalChecks||t},e.eps=T,e.getTileInfoAndExtentFromWMTSLayer=b,e.getTiledLayerInfo=function(e,t,r){let i=null,n=null;if("wmts"===e?.type){const s=b(e,t,r);i=s.tileInfo,n=s.fullExtent}else{n=u(e)?e.getCompatibleFullExtent(t):e.fullExtent;const o=r===s.ViewingMode.Local;i=u(e)?e.getCompatibleTileInfo(t,n,o):"vector-tile"===e?.type?o&&!v(t)||S.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):e.tileInfo}const o="tilemapCache"in e?e.tilemapCache?.effectiveMaxLOD:void 0;return null!=i&&null!=n&&null==_(i,n,t,r,o)?{tileInfo:i,fullExtent:n}:null},e.internalAssert=function(t,r){if(e.enableTerrainInternalChecks&&!t){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(r??"")+" at "+e),new Error("Assertion failed"+(r?": "+r:""))}},e.isBlendableLayerView=function(e){return e&&(h(e)||m(e)||d(e)||p(e))},e.isEast=function(e){return e===n.NeighborIndex.NORTH_EAST||e===n.NeighborIndex.EAST||e===n.NeighborIndex.SOUTH_EAST},e.isElevationLayer=function(e){return"elevation"===e?.type},e.isElevationLayerView=f,e.isGroupLayerView=function(e){return"group"===e?.type},e.isImageSourceRenderInfo=function(e){const t=e?.sourceLayerInfo?.data;return o.isImageWithType(t)||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData},e.isImageryTileLayerView=d,e.isImageryTileRenderInfo=function(e){return o.isRasterTile(e?.sourceLayerInfo?.data)},e.isMapTileLayerView=g,e.isNorth=function(e){return e===n.NeighborIndex.NORTH_EAST||e===n.NeighborIndex.NORTH||e===n.NeighborIndex.NORTH_WEST},e.isNorthCorner=function(e){return e===n.NeighborIndex.NORTH_WEST||e===n.NeighborIndex.NORTH_EAST},e.isProjectableRasterLayer=u,e.isSouth=function(e){return e===n.NeighborIndex.SOUTH_EAST||e===n.NeighborIndex.SOUTH||e===n.NeighborIndex.SOUTH_WEST},e.isSurfaceLayerView=function(e){return g(e)||f(e)},e.isTextureTileRenderInfo=function(e){return o.isTileTexture(e?.sourceLayerInfo?.data)},e.isTileLayerView=h,e.isVectorTileLayerView=p,e.isVectorTilePerLayerInfo=y,e.isVectorTileRenderInfo=function(e){return y(e?.sourceLayerInfo)||!!e?.isVTLBackground},e.isWMTSLayerView=m,e.isWest=function(e){return e===n.NeighborIndex.NORTH_WEST||e===n.NeighborIndex.WEST||e===n.NeighborIndex.SOUTH_WEST},e.isWestCorner=function(e){return e===n.NeighborIndex.NORTH_WEST||e===n.NeighborIndex.SOUTH_WEST},e.lij2s=function(e){return"["+e[0]+","+e[1]+","+e[2]+"]"},e.neighborCornerIndices=x,e.neighborEdgeIndices=w,e.oppositeCorner=function(e){return e===n.NeighborIndex.NORTH_EAST?n.NeighborIndex.SOUTH_WEST:e===n.NeighborIndex.NORTH_WEST?n.NeighborIndex.SOUTH_EAST:e===n.NeighborIndex.SOUTH_WEST?n.NeighborIndex.NORTH_EAST:n.NeighborIndex.NORTH_WEST},e.oppositeEdge=function(e){return e===n.NeighborIndex.NORTH?n.NeighborIndex.SOUTH:e===n.NeighborIndex.EAST?n.NeighborIndex.WEST:e===n.NeighborIndex.SOUTH?n.NeighborIndex.NORTH:n.NeighborIndex.EAST},e.releaseTerrainData=function(e){return null!=e&&"release"in e&&e.release(),null},e.test=S,e.useFetchTileForLayer=function(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile},e.v32s=function(e){return"("+e[0]+","+e[1]+","+e[2]+")"},e.vtlAssumes256PixelSizeAsDefault=v,e.weakAssert=function(e,t){e||console.warn("Terrain: "+t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/NeighborIndex":function(){define(["exports"],(function(e){"use strict";var t;e.NeighborIndex=void 0,(t=e.NeighborIndex||(e.NeighborIndex={}))[t.NORTH=0]="NORTH",t[t.NORTH_EAST=1]="NORTH_EAST",t[t.EAST=2]="EAST",t[t.SOUTH_EAST=3]="SOUTH_EAST",t[t.SOUTH=4]="SOUTH",t[t.SOUTH_WEST=5]="SOUTH_WEST",t[t.WEST=6]="WEST",t[t.NORTH_WEST=7]="NORTH_WEST",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/terrainUtilsPlanar":function(){define(["exports","../core/Error","../geometry/support/aaBoundingRect","../views/3d/support/supportedSpatialReference","../views/3d/terrain/TerrainConst","../views/3d/terrain/TilingScheme"],(function(e,t,r,i,s,n){"use strict";function o(e,o,a,l){if(null==e)return n.getMissingTileInfoError();const c=e.spatialReference;if(c.isGeographic&&!i.isSupportedEarthGCS(c))return new t("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const u=n.TilingScheme.checkUnsupported(e);if(null!=u)return u;if(null==a)return new t("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const d=function(e,i){const o=e.lods,a=o[0].resolution*2**o[0].level,l=[a*e.size[0],a*e.size[1]],c=[e.origin.x,e.origin.y],u=r.fromExtent(i),d=r.create();n.TilingScheme.computeRowColExtent(u,l,c,d);const h=(d[2]-d[0])*(d[3]-d[1]);if(h>s.maxRootTiles){const r=o[0].scale*2**o[0].level;let i=Math.max((u[3]-u[1])/e.size[1],(u[2]-u[0])/e.size[0])*r/a;const n=Math.floor(Math.log(i)/Math.log(10));return i=Math.ceil(i/10**n)*10**n,new t("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(r).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+i.toLocaleString()+".",{level0Scale:r,suggestedLevel0Scale:i,requiredNumRootTiles:h,allowedNumRootTiles:s.maxRootTiles})}return null}(e,a);return d||(null==o||c.equals(o)||o.isWGS84&&c.isWebMercator?null:new t("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"))}const a=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:o},Symbol.toStringTag,{value:"Module"}));e.checkIfTileInfoSupportedForViewSR=o,e.terrainUtilsPlanar=a}))},"esri/views/3d/support/supportedSpatialReference":function(){define(["exports","../../../geometry/support/spatialReferenceUtils"],(function(e,t){"use strict";function r(e){return t.isWGS84(e)||t.isCGCS2000(e)}e.isSupportedEarthGCS=r,e.isSupportedGCSOnGlobe=function(e){return r(e)||t.isMars(e)||t.isMoon(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/terrainUtilsSpherical":function(){define(["exports","../core/Error","../views/3d/support/supportedSpatialReference","../views/3d/terrain/TilingScheme"],(function(e,t,r,i){"use strict";function s(e,s,n,o){if(null==e)return i.getMissingTileInfoError();const a=e?.lods.length-1,l=e.spatialReference;if(l.isWebMercator){if(!i.TilingScheme.makeWebMercatorAuxiliarySphere(a).compatibleWith(e,o))return new t("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!r.isSupportedGCSOnGlobe(l))return new t("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!i.TilingScheme.makeGCSWithTileSize(e.spatialReference,e.size[0],a).compatibleWith(e,o))return e.spatialReference.isWGS84?new t("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new t("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==s||e.spatialReference.equals(s)?null:new t("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}const n=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:s},Symbol.toStringTag,{value:"Module"}));e.checkIfTileInfoSupportedForViewSR=s,e.terrainUtilsSpherical=n}))},"esri/views/3d/terrain/interfaces":function(){define(["exports"],(function(e){"use strict";var t,r,i;e.OverlayIndex=void 0,(t=e.OverlayIndex||(e.OverlayIndex={}))[t.INNER=0]="INNER",t[t.OUTER=1]="OUTER",e.PatchType=void 0,(r=e.PatchType||(e.PatchType={}))[r.REGULAR=0]="REGULAR",r[r.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",r[r.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",r[r.HAS_BOTH_POLES=3]="HAS_BOTH_POLES",e.TextureUpdate=void 0,(i=e.TextureUpdate||(e.TextureUpdate={}))[i.FADING=0]="FADING",i[i.IMMEDIATE=1]="IMMEDIATE",i[i.UNFADED=2]="UNFADED",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/OverlayManager":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/Cyclical","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/ellipsoidUtils","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingRect","../../../geometry/support/ray","../../../chunks/sphere","../../../geometry/support/vector","../../../geometry/support/webMercatorUtils","../state/utils/viewUtils","../support/debugFlags","../support/debugUtils","./interfaces","./OverlayRenderer","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/Intersector","../webgl-engine/lib/LocalOriginFactory","../webgl-engine/lib/SortedRenderGeometryRenderer","../webgl-engine/lib/textureUtils","../webgl-engine/parts/renderUtils","../../support/Scheduler","../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N){"use strict";const U=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let V;e.OverlayManager=class extends r{constructor(e){super(e),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0}initialize(){const e=this.view;this.renderer=new R.OverlayRenderer({parent:this}),e.stage.renderer.plugins.add(this.renderer);const t=()=>this.requestRender();this._groundIntersector=new O.Intersector(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([a.watch((()=>this.renderer.hasHighlights),t),this.renderer.events.on("has-water",(()=>e.stage?.renderer.updateHasFlags())),this.renderer.events.on("content-changed",t),a.watch((()=>e.state.camera.pixelRatio),t),a.watch((()=>e.state.alignPixelEnabled),t),this.renderer.events.on("textures-disposed",(()=>this.surface.requestRender())),a.watch((()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location]),(()=>this.setPlacementDirty())),a.watch((()=>[e.state?.pixelRatio,e.state?.contentPixelRatio]),(()=>this.setPlacementDirty()),a.sync),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(L.TaskPriority.OVERLAY,this),e.stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(L.noBudget,e.camera,E.RenderRequestType.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(E.RenderRequestType.BACKGROUND,e)}))]),e.stage.renderer.overlay=this}destroy(){this.view?.stage&&(this.view.stage.renderer.plugins.remove(this.renderer),this.view.stage.renderer.overlay=null),V&&(V.hide(),V=null),this.renderer=o.destroyMaybe(this.renderer)}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.renderer.longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=e.isWebMercator?new i.Cyclical(-20037508.342787,20037508.342787):new i.Cyclical(-180,180))):this.renderer.disposeOverlays()}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||C.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?y.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return 1.3/this.view.resolutionScale}get _longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}render(){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._precompileShaders()?this._drawOverlays(E.RenderRequestType.UPDATE):null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(e,t){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.registerDrapeSource(e,t),this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running")}registerGeometryDrapeSource(e){const t=new I.SortedRenderGeometryRenderer({stage:this.view.stage,drapeSource:e,rendererContext:this.renderer});return this.registerDrapeSource(e,t),t}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,E.RenderRequestType.UPDATE)}_updateOverlays(e,t,r){if(!this._spatialReference)return N.Yield;const i=this._computeOverlayHeight(t);this._computeOverlayExtents(t,i,k),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,k.stretch);const s=this._updateOverlay(M.OverlayIndex.INNER,k.inner,i,1*k.pixelRatioAdjustment,k.mapUnitsPerPixel),n=b.width(k.inner)/b.width(k.outer),o=this._updateOverlay(M.OverlayIndex.OUTER,k.outer,i,n*k.pixelRatioAdjustment,k.mapUnitsPerPixel);s!==H.EXTENT&&o!==H.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.updateOverlayParameters(r)),s===H.NONE&&o===H.NONE||this.requestRender(),this._placementDirty=!1,e.madeProgress()}_computeOverlayHeight(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,r=e.fullWidth/e.pixelRatio*t,i=e.fullHeight/e.pixelRatio*t,s=Math.ceil(1.5*Math.max(r,i)),{maxPreferredTexturePixels:n,maxTextureSize:o}=this.view.stage.renderView.renderingContext.parameters,a=.5*o;return D.applyTextureResizeModulo(D.ensureTextureSize({width:s,height:s},{maxPreferredTexturePixels:2*n,maxTextureSize:a})[1],a)}_updateOverlay(e,t,r,i,s){if(0===this.renderer.overlays.length)return H.NONE;const n=this.renderer.overlays[e],o=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=i,function(e,t){const r=C.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}(t,n.extent)&&r===n.resolution)return o===s?H.NONE:H.RERENDER_ONLY;b.copy(n.extent,t),n.resolution=r;const a=b.center(n.extent);return n.renderLocalOrigin=A.fromValues(a[0],a[1],0,"OV_"+this._latestOriginId++),H.EXTENT}updateOverlayParameters(e){this.surface.allTiles.forAll((e=>this.updateTileOverlayParameters(e))),this.surface.requestRender(e)}updateTileOverlayParameters(e){if(!e.renderData)return;const t=e.renderData.overlay;if(0===this.renderer.overlays.length)this._clearTileOverlayData(M.OverlayIndex.INNER,t),this._clearTileOverlayData(M.OverlayIndex.OUTER,t);else{const[r,i]=this.renderer.overlays,s=e.extent;this._rectInsideRect(r.extent,s)||this._rectanglesOverlap(s,r.extent)||this._rectanglesOverlap(s,i.extent)?(this._setTileOverlayData(s,M.OverlayIndex.INNER,t),this._setTileOverlayData(s,M.OverlayIndex.OUTER,t)):(this._clearTileOverlayData(M.OverlayIndex.INNER,t),this._clearTileOverlayData(M.OverlayIndex.OUTER,t))}}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const r=this.renderer.overlays[M.OverlayIndex.INNER],i=this.renderer.overlays[M.OverlayIndex.OUTER],s=this._pointIsInExtent(e,r.extent)?r:i;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,t,r){if(0===this.renderer.overlays.length)return;const i=this.renderer.overlays[t].extent,s=b.width(i),n=b.height(i);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(i[0],o);const t=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);o>t&&(o=t-(e[2]-e[0]))}r.setScale(t,b.width(e)/s,b.height(e)/n),r.setOffset(t,(o-i[0])/s,(e[1]-i[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}reloadShaders(){F.removeLoadedShaderModules(),this.requestRender(),this.runTask(L.noBudget)}requestRender(e=E.RenderRequestType.UPDATE){this.renderer.hasOverlays?(e===E.RenderRequestType.UPDATE?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view.stage.renderView.requestRender(e)):this.setPlacementDirty()}_intersectGroundFromView(e,t,r,i,s){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,q,t,r);if(null==n)return!1;const o=n.origin,a=p.add(G,n.origin,n.direction);this._groundIntersector.reset(o,a,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,o,a);const l=this._groundIntersector.results.min;return l.getIntersectionPoint(s)&&l.withinDistance(i)}_findHorizonBasedPointOfInterest(e,t){let r=.5;const s=.55,o=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,l=1e-5,c=n.clamp(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:o+l,e.aboveGround?o-l:1/0),u=e.aboveGround;if("global"===this.view.viewingMode){const t=G;S.closestPointOnSilhouette(S.fromRadius(S.tmpSphere,y.getReferenceEllipsoid(this.view.spatialReference).radius+c),v.wrap(e.eye,e.viewForward),t),p.subtract(t,t,e.eye);const n=i.cyclicalPI.normalize(w.angleAroundAxis(e.viewForward,t,e.viewRight))/e.fovY+.5,o=n<=0||n>=1?.5:s;r=u?o*n:n+o*(1-n)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),i=Math.tan(t),o=g.fromValues(0,i,1,0),a=f.transformMat4(o,o,e.projectionMatrix)[1],l=n.clamp(.5+.5*a,0,1);r=1===l||0===l?.5:u?l*s:1-(1-l)*s}return this._intersectGroundFromView(e,.5,r,a.distance,t)}_computeOverlayExtents(e,t,r){const i=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=m.create();this._findHorizonBasedPointOfInterest(e,s)||p.copy(s,i),C.debugFlags.OVERLAY_SHOW_CENTER?(null==V&&(V=new P.DebugPoint(this.view.graphics,"red")),V.show(s,this._renderSR)):null!=V&&V.hide();const o=Math.max(.1,p.distance(e.eye,s)),a=T.viewAngle(this.view.renderCoordsHelper,i,e.eye);this._overlaySREqualsRenderSR||_.projectVectorToVector(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&this._spatialReference?.isGeographic,u=c&&this._spatialReference?1/y.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1,d=this.view.state.contentPixelRatio,g=e.perScreenPixelRatio/d*o*u;r.mapUnitsPerPixel=g/this.worldToPCSRatio,r.stretch=this._overlayStretch;let v=t*g/2*r.stretch,S=!1,w=c?90:1/0;this._isSpherical&&l&&this._spatialReference&&(this._spatialReference.isWebMercator?(v/=Math.cos(x.y2lat(s[1])),w=l[3]):(S=!0,v/=y.getReferenceEllipsoid(this._spatialReference).metersPerDegree,w=90),v>=w&&(v=w,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let M=1;S&&(M=1/Math.max(.2,Math.cos(Math.abs(n.deg2rad(s[1])))),v*M>180&&(M=180/v),r.mapUnitsPerPixel*=M);const R=Math.log(2)/12;v=Math.exp(Math.round(Math.log(v)/R)*R);const E=v*M,O=.5*t/(32*E),A=.5*t/(32*v);s[0]=Math.round(s[0]*O)/O,s[1]=Math.round(s[1]*A)/A;const I=r.inner;I[0]=s[0]-E,I[1]=s[1]-v,I[2]=s[0]+E,I[3]=s[1]+v,this._isSpherical&&this._shiftExtentToFitBounds(I,1/0,w);const D=r.outer;if(6*E>b.width(l))b.copy(D,l);else if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)D[0]=I[0]-E,D[1]=I[1]-v,D[2]=I[2]+E,D[3]=I[3]+v;else{_.projectVectorToVector(e.eye,this._renderSR,G,this._spatialReference),h.subtract(B,s,G);let t=-Math.atan2(B[1],B[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const r=Math.floor(t/(.25*Math.PI));f.scale(B,U[r],2*v),B[0]*=M,B[2]*=M,f.add(D,I,B)}if(this._isSpherical)D[0]=this._longitudeCyclical.clamp(D[0]),D[2]=this._longitudeCyclical.clamp(D[2]),D[1]=Math.max(D[1],-w),D[3]=Math.min(D[3],w);else{const e=b.intersection(I,l,z),t=b.intersection(D,l,j);b.contains(e,t)&&(D[2]=D[0],D[3]=D[1])}const F=Math.abs(I[2]-I[0])/t;r.mapUnitsPerPixel=Math.max(r.mapUnitsPerPixel,F),r.pixelRatioAdjustment=r.mapUnitsPerPixel/F}_precompileShaders(){return!!this.renderer.hasOverlays&&(this.renderer.precompileShaders(this.view.state),!0)}_drawOverlays(e,t=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const r=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const i=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),i!==this.renderer.computeValidity()&&this.updateOverlayParameters(E.RenderRequestType.UPDATE),r?(this.surface.requestRender(e),e===E.RenderRequestType.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(E.RenderRequestType.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):b.intersects(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:b.contains(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]}_shiftExtentToFitBounds(e,t,r){let i=0,s=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?s=e[1]+r:e[3]>r&&(s=r-e[3]),b.offset(e,i,s)}get test(){}},t.__decorate([l.property()],e.OverlayManager.prototype,"_spatialReference",void 0),t.__decorate([l.property({readOnly:!0})],e.OverlayManager.prototype,"running",null),t.__decorate([l.property()],e.OverlayManager.prototype,"_placementDirty",void 0),t.__decorate([l.property()],e.OverlayManager.prototype,"_contentUpdated",void 0),t.__decorate([l.property()],e.OverlayManager.prototype,"_isSpherical",null),t.__decorate([l.property()],e.OverlayManager.prototype,"worldToPCSRatio",null),t.__decorate([l.property()],e.OverlayManager.prototype,"renderer",void 0),t.__decorate([l.property({constructOnly:!0})],e.OverlayManager.prototype,"view",void 0),t.__decorate([l.property({constructOnly:!0})],e.OverlayManager.prototype,"surface",void 0),t.__decorate([l.property()],e.OverlayManager.prototype,"suspended",null),t.__decorate([l.property()],e.OverlayManager.prototype,"updating",null),t.__decorate([l.property({type:Boolean})],e.OverlayManager.prototype,"rendersOccludedDraped",null),e.OverlayManager=t.__decorate([d.subclass("esri.views.3d.terrain.OverlayManager")],e.OverlayManager);const B=g.create(),G=m.create(),k=new class{constructor(){this.inner=b.create(),this.outer=b.create(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3}},z=b.create(),j=b.create(),q=v.create();var H;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(H||(H={})),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/OverlayRenderer":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Evented","../../../core/has","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/reactiveUtils","../../../core/SetUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat4","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../layers/interfaces","../support/debugFlags","./interfaces","./Overlay","./OverlayContent","./OverlayRenderTargets","../webgl/RenderCamera","../webgl-engine/core/shaderLibrary/ShaderOutput","../webgl-engine/core/shaderLibrary/terrain/Overlay.glsl","../../../chunks/TextureOnly.glsl","../webgl-engine/effects/RenderPlugin","../webgl-engine/effects/highlight/Highlight","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/GLMaterialRepository","../webgl-engine/lib/GridLocalOriginFactory","../webgl-engine/lib/Material","../webgl-engine/lib/OITPass","../webgl-engine/lib/RenderContext","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/ShadowMap","../webgl-engine/lib/TextureTechnique","../webgl-engine/lib/TextureTechniqueConfiguration","../webgl-engine/lib/Update","../webgl-engine/lib/UpdatePolicy","../webgl-engine/lighting/Lightsources","../../../chunks/OverlayCompositing.glsl","../webgl-engine/shaders/OverlayCompositingTechnique","../../support/Scheduler","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W){"use strict";e.OverlayRenderer=class extends P.SyncRenderPlugin{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new k.OverlayCompositingPassParameters,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new o,this._passParameters=new C.TextureOnlyPassParameters,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new w,this.events=new r,this.longitudeCyclical=null,this.produces=new Map([[F.RenderSlot.DRAPED_MATERIAL,e=>e!==x.ShaderOutput.Highlight||this.hasHighlights],[F.RenderSlot.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this._view,t=e.stage,r=t.renderer.fboCache,{waterTextures:i,techniques:s}=t.renderView;this._renderContext=new D.RenderContext(this._rctx,new L.ShadowMap(r,e.state.viewingMode),s),this.addHandles([a.watch((()=>i.updating),(()=>this.events.emit("content-changed")),a.syncAndInitial),a.watch((()=>this.spatialReference),(e=>this._localOriginFactory=new O.GridLocalOriginFactory(e)),a.syncAndInitial),a.on((()=>e.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0)),a.watch((()=>M.trackHighlightOptions(e.state.highlights)),(()=>this._sortedDrapeSourceRenderersDirty=!0),a.initial),a.watch((()=>e.state.highlights),(t=>{this._bindParameters.highlights=t,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap}),a.initial),e.resourceController.scheduler.registerTask(j.TaskPriority.OVERLAY_RENDERER,this)]);const{_bindParameters:n,_camera:o}=this;o.near=1,o.far=1e4,o.relativeElevation=null,n.slot=F.RenderSlot.DRAPED_MATERIAL,n.mainDepth=null,n.camera=o,n.oitPass=I.OITPass.NONE,n.updateLighting([new G.AmbientLight(f.ones())],0,0,V.Update.Immediate)}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._passParameters.texture=n.disposeMaybe(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new E.GLMaterialRepository(this._view.stage.renderView.textures,this._techniques,(()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed")));this._pluginContext={...e,materials:t},this._techniques.precompile(z.OverlayCompositingTechnique)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||s.someMap(this._renderers,(e=>e.updating||e.canCompact))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map((e=>e.drapeSource.layer)).filter((e=>!!e))}registerDrapeSource(e,t){const r=this._renderers.get(e);null!=r&&r.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(a.watch((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e)}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&l.someSet(e,(e=>e.drapeTargetType===g.DrapeTargetType.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=l.someSet(e,(e=>e.drapeSourceType===g.DrapeSourceType.Features)),this._hasDrapedRasterSource=l.someSet(e,(e=>e.drapeSourceType===g.DrapeSourceType.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new S.OverlayRenderTargets(this._stage.renderer.fboCache),this._overlays=[new b.Overlay,new b.Overlay]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=n.disposeMaybe(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){return e===v.OverlayContent.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(v.OverlayContent.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let r=!1;for(const[i,s]of this._renderers){if(e.done)break;(i.destroyed||t(i))&&s.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),r&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=s.someMap(this._renderers,(e=>e.hasHighlights)),this.notifyChange("rendersOccludedDraped"))}compact(e){let t=!1;for(const r of this._renderers.values()){if(e.done)break;t=r.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return s.someMap(this._renderers,(t=>t.hasHighlight(e)))}processSyncDrapeSources(){this._processDrapeSources(j.noBudget,(e=>e.updatePolicy===B.UpdatePolicy.SYNC))}get isEmpty(){return!y.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&!s.someMap(this._renderers,(e=>!e.isEmpty))}get hasWater(){const e=s.someMap(this._renderers,(({hasWater:e})=>e));return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=Z,++this._techniques.precompiling;const t=this._sortedRenderers.some((({renderer:e})=>e.precompile(this._renderContext)));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=e,t}renders(e){if(y.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==v.OverlayContent.Occluded&&e!==v.OverlayContent.Highlight)return!0;if(!this._overlays)return!1;const t=this._overlays[_.OverlayIndex.INNER];for(const e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;const r=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find((t=>t.content===e))?.output??x.ShaderOutput.Color,++this._techniques.precompiling;const i=this._sortedRenderers.some((({renderer:e})=>e.precompile(this._renderContext)));return--this._techniques.precompiling,this._renderContext.output=r,i}get mode(){return this.isEmpty?T.OverlayMode.Disabled:this.hasWater&&this.renders(v.OverlayContent.WaterNormal)?T.OverlayMode.EnabledWithWater:this._renderTargets?.getTexture(v.OverlayContent.Color)?T.OverlayMode.Enabled:T.OverlayMode.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach((r=>t=r.updateAnimation(e)||t)),t&&this.parent.requestRender(R.RenderRequestType.BACKGROUND),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const e of this._renderTargets.targets){if(e.content===v.OverlayContent.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=e.output;this._renderContext.output=r,t.slot=r===x.ShaderOutput.Normal?F.RenderSlot.DRAPED_WATER:F.RenderSlot.DRAPED_MATERIAL,r===x.ShaderOutput.Highlight&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null),e.content===v.OverlayContent.Occluded&&(this._renderContext.renderOccludedMask=Z),this._sortedRenderers.forAll((({drapeSource:t,renderer:r})=>{e.content===v.OverlayContent.ColorNoRasterImage&&t.drapeSourceType===g.DrapeSourceType.RasterImage||r.precompile(this._renderContext)})),this._renderContext.renderOccludedMask=D.defaultRenderOccludedMask,t.highlightMixTexture=null}--this._techniques.precompiling}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;for(const e of this._renderTargets.targets){if(e.content===v.OverlayContent.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const t=this._drawTarget(_.OverlayIndex.INNER,e),r=this._drawTarget(_.OverlayIndex.OUTER,e);(t||r)&&e.fbo.generateMipMap()}}}_drawTarget(e,t){const r=this._overlays[e],i=r.canvasGeometries;if(0===i.numViews)return!1;const s=this._view.state.contentPixelRatio;this._screenToWorldRatio=s*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:n}=t;if(this.isEmpty||n===x.ShaderOutput.Normal&&!this.hasWater||!r.hasSomeSizedView())return!1;const{_rctx:o,_camera:a,_renderContext:l,_bindParameters:c}=this;if(a.pixelRatio=r.pixelRatio*s,l.output=n,c.screenToWorldRatio=this._screenToWorldRatio,c.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,c.slot=n===x.ShaderOutput.Normal?F.RenderSlot.DRAPED_WATER:F.RenderSlot.DRAPED_MATERIAL,t.content===v.OverlayContent.Occluded&&(l.renderOccludedMask=Z),!this.renders(t.content))return l.renderOccludedMask=D.defaultRenderOccludedMask,!1;const{resolution:u}=r,d=e===_.OverlayIndex.INNER,h=d?0:u;if(o.setViewport(h,0,u,u),this._bindTargetFBO(t),d)if(t.output!==x.ShaderOutput.Highlight)o.setClearColor(0,0,0,0),o.clear(q.FramebufferBit.COLOR);else{const{gl:e}=o;e.clearBufferuiv(e.COLOR,0,[0,0,0,0])}if(y.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==v.OverlayContent.Occluded&&t.content!==v.OverlayContent.Highlight){this._techniques.precompile(N.TextureTechnique,Y);const t=this._techniques.get(N.TextureTechnique,Y);for(let s=0;s<i.numViews;s++)this._setViewParameters(i.extents[s],r),this._ensureDebugPatternResources(r.resolution,Q[e]),o.bindTechnique(t,c,this._passParameters),o.screen.draw()}if(t.output===x.ShaderOutput.Highlight){const{fboCache:r}=this._stage.renderer,i=this._resolution;this._bindTargetFBO(t),M.renderHighlightBuffer(o,r,{width:i,height:i},c,(()=>this._renderAllGeometry(e,t)),h)}else this._renderAllGeometry(e,t);return o.bindFramebuffer(null),l.renderOccludedMask=D.defaultRenderOccludedMask,!0}_renderAllGeometry(e,t){const r=this._overlays[e],i=r.canvasGeometries;this._sortedRenderers.forAll((({drapeSource:s,renderer:n})=>{if(t.content===v.OverlayContent.ColorNoRasterImage&&s.drapeSourceType===g.DrapeSourceType.RasterImage)return;const{fullOpacity:o}=s,a=null!=o&&o<1&&t.output===x.ShaderOutput.Color&&this._bindTemporaryFBO();for(let e=0;e<i.numViews;e++)this._setViewParameters(i.extents[e],r),n.render(this._renderContext);if(a){this._bindTargetFBO(t),this._overlayParameters.texture=a.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;const r=this._techniques.get(z.OverlayCompositingTechnique);this._rctx.bindTechnique(r,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),a.release()}}))}_bindTargetFBO(e){const t=this._resolution,r=2*t;e.fbo.bind(this._rctx,r,t)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,r=this._stage.renderer.fboCache,i=r.acquire(t,e,"overlay tmp");return r.rctx.bindFramebuffer(i.fbo),r.rctx.clear(q.FramebufferBit.COLOR),i}get _resolution(){return this._overlays?.[_.OverlayIndex.INNER].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,i){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(const{renderer:n}of this._sortedRenderers)s=n.intersect?.(e,t,r,i,s)??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this._view.map.allLayers,t=e.length;this._renderers.forEach(((r,i)=>{const s=e.indexOf(i.layer),n=s>=0,o=i.renderGroup??(n?g.DrapedRenderGroup.MapLayer:g.DrapedRenderGroup.ViewLayer),a=i.drapeSourcePriorityOffset??0,l=t*o+(n?s:0)+a;this._sortedRenderers.push(new $(i,r,l))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],p.ortho(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),p.fromTranslation(r.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(m.set(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let i=0;for(let t=0;t<e;t++)for(let s=0;s<e;s++){const n=Math.floor(s/10),o=Math.floor(t/10);n<2||o<2||10*n>e-20||10*o>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&n&&1&o?1&s^1&t?0:255:1&n^1&o?0:128)}const s=new W.TextureDescriptor(e);s.samplingMode=q.TextureSamplingMode.NEAREST,this._passParameters.texture=new H.Texture(this._rctx,s,r)}get test(){}},t.__decorate([c.property()],e.OverlayRenderer.prototype,"hasHighlights",void 0),t.__decorate([c.property()],e.OverlayRenderer.prototype,"_sortedDrapeSourceRenderersDirty",void 0),t.__decorate([c.property({constructOnly:!0})],e.OverlayRenderer.prototype,"parent",void 0),t.__decorate([c.property({readOnly:!0})],e.OverlayRenderer.prototype,"_techniques",null),t.__decorate([c.property({type:Boolean,readOnly:!0})],e.OverlayRenderer.prototype,"updating",null),t.__decorate([c.property()],e.OverlayRenderer.prototype,"isEmpty",null),t.__decorate([c.property({readOnly:!0})],e.OverlayRenderer.prototype,"rendersOccludedDraped",null),e.OverlayRenderer=t.__decorate([h.subclass("esri.views.3d.terrain.OverlayRenderer")],e.OverlayRenderer);class ${constructor(e,t,r){this.drapeSource=e,this.renderer=t,this.index=r}}const Q=[[1,.5,.5],[.5,.5,1]],Z=A.RenderOccludedFlag.OccludeAndTransparent,Y=new U.TextureTechniqueConfiguration;Y.hasAlpha=!0,e.drapedZ=-2,e.overlayRenderOccludedFlag=Z,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/interfaces":function(){define(["exports"],(function(e){"use strict";var t,r,i;e.DrapeSourceType=void 0,(t=e.DrapeSourceType||(e.DrapeSourceType={}))[t.RasterImage=0]="RasterImage",t[t.Features=1]="Features",e.DrapedRenderGroup=void 0,(r=e.DrapedRenderGroup||(e.DrapedRenderGroup={}))[r.MapLayer=0]="MapLayer",r[r.ViewLayer=1]="ViewLayer",r[r.Outline=2]="Outline",r[r.SnappingHint=3]="SnappingHint",e.DrapeTargetType=void 0,(i=e.DrapeTargetType||(e.DrapeTargetType={}))[i.WithRasterImage=0]="WithRasterImage",i[i.WithoutRasterImage=1]="WithoutRasterImage",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/Overlay":function(){define(["exports","../../../geometry/support/aaBoundingRect","../webgl-engine/lib/LocalOriginFactory"],(function(e,t,r){"use strict";class i{constructor(){this.extents=[t.create(),t.create(),t.create()],this.numViews=0}}e.Overlay=class{constructor(){this._extent=t.create(),this.resolution=0,this.renderLocalOrigin=r.fromValues(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new i}get extent(){return this._extent}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const r=.001*e.range;if(this._extent[0]-r<=e.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];t.offset(this._extent,e.range,0,r)}if(this._extent[2]+r>=e.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];t.offset(this._extent,-e.range,0,r)}}_setupGeometryView(){this.canvasGeometries.numViews=1,t.copy(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/LocalOriginFactory":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t){"use strict";class r{constructor(e,t){this.vec3=e,this.id=t}}e.LocalOrigin=r,e.fromValues=function(e,i,s,n){return new r(t.fromValues(e,i,s),n)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/OverlayContent":function(){define(["exports"],(function(e){"use strict";var t;e.OverlayContent=void 0,(t=e.OverlayContent||(e.OverlayContent={}))[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.WaterNormal=3]="WaterNormal",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/OverlayRenderTargets":function(){define(["exports","./OverlayContent","./OverlayFramebufferObject","../webgl-engine/core/FBOCacheFormats","../webgl-engine/core/shaderLibrary/ShaderOutput","../webgl-engine/effects/geometry/olidUtils"],(function(e,t,r,i,s,n){"use strict";class o{constructor(e,t,s,n,o=i.ColorFormat.RGBA8UNORM_MIPMAP){this.output=s,this.content=n,this.fbo=new r.OverlayFramebufferObject(e,o,t)}get valid(){return this.fbo.valid}}e.OverlayRenderTargets=class{constructor(e){this.targets=[new o(e,"overlay color",s.ShaderOutput.Color,t.OverlayContent.Color),new o(e,"overlay IM color",s.ShaderOutput.Color,t.OverlayContent.ColorNoRasterImage),new o(e,"overlay highlight",s.ShaderOutput.Highlight,t.OverlayContent.Highlight,i.ColorFormat.RG8UINT),new o(e,"overlay water",s.ShaderOutput.Normal,t.OverlayContent.WaterNormal),new o(e,"overlay occluded",s.ShaderOutput.Color,t.OverlayContent.Occluded)],n.olidEnabled()&&this.targets.push(new o(e,"overlay olid",s.ShaderOutput.ObjectAndLayerIdColor,t.OverlayContent.ObjectAndLayerIdColor,i.ColorFormat.RGBA8UNORM))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce(((e,t,r)=>t.valid?e|=1<<r:e),0)}},e.RenderTargetDescriptor=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/OverlayFramebufferObject":function(){define(["exports","../../../core/maybe"],(function(e,t){"use strict";e.OverlayFramebufferObject=class{constructor(e,t,r){this._fbos=e,this._format=t,this._name=r}get valid(){return null!=this._handle?.getTexture()}dispose(){this._handle=t.releaseMaybe(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,t,r){this._handle&&this._handle.fbo?.width===t&&this._handle.fbo?.height===r||(this._handle?.release(),this._handle=this._fbos.acquire(t,r,this._name,this._format)),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/Overlay.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../../../geometry/support/aaBoundingRect","../../../../terrain/interfaces","../../../../terrain/OverlayContent","../../renderPasses/RenderPassIdentifier","../ShaderOutput","../shading/MainLighting.glsl","../shading/PhysicallyBasedRenderingParameters.glsl","../shading/Water.glsl","../../shaderModules/Float4DrawUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform","../../shaderModules/Texture2DUintPassUniform","../../../../../webgl/Uniform"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";var g;function y(e,t){const r=t.pbrMode===l.PBRMode.Water||t.pbrMode===l.PBRMode.WaterOnIntegratedMesh||t.pbrMode===l.PBRMode.TerrainWithWater;r&&e.include(c.Water,t);const{vertex:i,fragment:n,varyings:u}=e;u.add("vtcOverlay","vec4");const{output:d}=t,p=d===o.ShaderOutput.Highlight;i.code.add(h.glsl`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),n.code.add(h.glsl`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),p?n.uniforms.add(new m.Texture2DUintPassUniform("overlayHighlightTexture",((e,t)=>t.overlay?.getTexture(s.OverlayContent.Highlight)))).code.add(h.glsl`uvec2 getAllOverlayHighlightValuesEncoded() {
vec4 texCoords = vtcOverlay;
vec2 uvInner = texCoords.xy;
vec2 uvOuter = texCoords.zw;
bool isValidInner = isValid(uvInner, fwidth(uvInner));
bool isValidOuter = isValid(uvOuter, vec2(0.0, 0.0));
vec2 texelCoordInner = uvInner * vec2(0.5, 1.0);
vec2 texelCoordOuter = uvOuter * vec2(0.5, 1.0) + vec2(0.5,0.0);
vec2 texDim =  vec2(textureSize(overlayHighlightTexture, 0));
uvec2 texelValueInner = texelFetch(overlayHighlightTexture, ivec2(texelCoordInner * texDim), 0).rg;
uvec2 texelValueOuter = texelFetch(overlayHighlightTexture, ivec2(texelCoordOuter * texDim), 0).rg;
return
isValidInner ? texelValueInner :
isValidOuter ? texelValueOuter :
uvec2(0);
}`):(n.code.add(h.glsl`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),n.code.add(h.glsl`vec4 getOverlayColorTexel() {
vec4 texCoords = vtcOverlay;
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y) * texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w) * texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`)),r&&(a.addMainLightDirection(n),a.addMainLightIntensity(n),n.code.add(h.glsl`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function _(e,t){return e.identifier===n.RenderPassIdentifier.Material&&o.isColorOrColorEmission(e.output)?e.occludedGround?t.overlay?.getTexture(s.OverlayContent.Occluded):t.overlay?.getTexture(s.OverlayContent.ColorNoRasterImage):e.identifier===n.RenderPassIdentifier.Material&&e.output===o.ShaderOutput.ObjectAndLayerIdColor?t.overlay?.getTexture(s.OverlayContent.ObjectAndLayerIdColor):e.identifier===n.RenderPassIdentifier.Highlight?t.overlay?.getTexture(s.OverlayContent.Highlight):null}e.OverlayMode=void 0,(g=e.OverlayMode||(e.OverlayMode={}))[g.Disabled=0]="Disabled",g[g.Enabled=1]="Enabled",g[g.EnabledWithWater=2]="EnabledWithWater",g[g.COUNT=3]="COUNT";const b=t.create();class v extends f.Uniform{constructor(e){super(e,"vec4")}}e.OverlayIM=function(e,t){const{vertex:s,fragment:n}=e;s.uniforms.add(new u.Float4DrawUniform("overlayTexOffset",((e,t)=>function(e,t){const s=t.overlay?.overlays[i.OverlayIndex.INNER]?.extent;r.hasArea(s)&&(b[0]=e.toMapSpace[0]/r.width(s)-s[0]/r.width(s),b[1]=e.toMapSpace[1]/r.height(s)-s[1]/r.height(s));const n=t.overlay?.overlays[i.OverlayIndex.OUTER]?.extent;return r.hasArea(n)&&(b[2]=e.toMapSpace[0]/r.width(n)-n[0]/r.width(n),b[3]=e.toMapSpace[1]/r.height(n)-n[1]/r.height(n)),b}(e,t))),new u.Float4DrawUniform("overlayTexScale",((e,t)=>function(e,t){const s=t.overlay?.overlays[i.OverlayIndex.INNER]?.extent;r.hasArea(s)&&(b[0]=e.toMapSpace[2]/r.width(s),b[1]=e.toMapSpace[3]/r.height(s));const n=t.overlay?.overlays[i.OverlayIndex.OUTER]?.extent;return r.hasArea(n)&&(b[2]=e.toMapSpace[2]/r.width(n),b[3]=e.toMapSpace[3]/r.height(n)),b}(e,t)))),n.constants.add("overlayOpacity","float",1),n.uniforms.add(new p.Texture2DPassUniform("ovColorTex",((e,t)=>_(e,t)))),y(e,t)},e.OverlayTerrain=function(e,t){const{vertex:r,fragment:i}=e,{output:s}=t;r.uniforms.add(new v("overlayTexOffset"),new v("overlayTexScale")),i.uniforms.add(new d.FloatPassUniform("overlayOpacity",(e=>e.overlayOpacity))),s!==o.ShaderOutput.Highlight&&i.uniforms.add(new p.Texture2DPassUniform("ovColorTex",((e,t)=>t.overlay?.getTexture(e.overlayContent)))),y(e,t)},e.getIMColorTexture=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/renderPasses/RenderPassIdentifier":function(){define(["exports"],(function(e){"use strict";var t;e.RenderPassIdentifier=void 0,(t=e.RenderPassIdentifier||(e.RenderPassIdentifier={}))[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight",t[t.ViewshedShadowMap=3]="ViewshedShadowMap",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/Water.glsl":function(){define(["exports","./FoamRendering.glsl","./Gamma.glsl","./PhysicallyBasedRendering.glsl","./ScreenSpaceConstants","./ScreenSpaceReflections.glsl","../util/CloudsParallaxShading.glsl","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../shaderModules/Matrix4BindUniform","../../shaderModules/Texture2DBindUniform","../../../shaders/ToneMapping.glsl"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.Water=function(e,h){const p=e.fragment;p.include(i.PhysicallyBasedRenderingWater,h),p.include(r.Gamma),p.include(t.FoamColor),h.cloudReflections&&e.include(o.CloudsParallaxShading),e.include(n.ScreenSpaceReflections,h),p.include(d.ToneMapping,h),p.constants.add("fresnelSky","vec3",[.02,1,15]),p.constants.add("fresnelMaterial","vec2",[.02,.1]),p.constants.add("roughness","float",.015),p.constants.add("foamIntensityExternal","float",1.7),p.constants.add("ssrIntensity","float",.65),p.constants.add("ssrHeightFadeStart","float",s.distanceFadeStart),p.constants.add("ssrHeightFadeEnd","float",s.distanceFadeEnd),p.constants.add("waterDiffusion","float",.92),p.constants.add("waterSeaColorMod","float",.8),p.constants.add("correctionViewingPowerFactor","float",.4),p.constants.add("skyZenitColor","vec3",[.52,.68,.9]),p.constants.add("skyColor","vec3",[.67,.79,.9]),p.constants.add("cloudFresnelModifier","vec2",[1.2,.01]),p.code.add(l.glsl`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),p.uniforms.add(new a.FloatBindUniform("lightingSpecularStrength",(e=>e.lighting.mainLight.specularStrength)),new a.FloatBindUniform("lightingEnvironmentStrength",(e=>e.lighting.mainLight.environmentStrength))),p.code.add(l.glsl`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
float NdotL = clamp(dot(n, l), 0.0, 1.0);
specular = lightingSpecularStrength * NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),h.cloudReflections&&p.uniforms.add(new a.FloatBindUniform("cloudsOpacity",(e=>e.clouds.opacity))).code.add(l.glsl`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * cloudsOpacity;`),h.screenSpaceReflections?p.uniforms.add(new c.Matrix4BindUniform("view",(e=>e.camera.viewMatrix)),new u.Texture2DBindUniform("lastFrameColorTexture",(e=>e.ssr.lastFrameColor?.getTexture())),new a.FloatBindUniform("fadeFactorSSR",(e=>e.ssr.fadeFactor))).code.add(l.glsl`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view * vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`):p.code.add(l.glsl`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),h.cloudReflections?h.screenSpaceReflections?p.code.add(l.glsl`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):p.code.add(l.glsl`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):p.code.add(l.glsl`return waterRenderedColor;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/FoamRendering.glsl":function(){define(["exports","../../shaderModules/glsl"],(function(e,t){"use strict";e.FoamColor=function(e){e.code.add(t.glsl`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)},e.FoamIntensity=function(e){e.code.add(t.glsl`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl":function(){define(["exports","../../../../../../colorUtils","../../shaderModules/glsl"],(function(e,t,r){"use strict";e.Gamma=function(e){e.code.add(r.glsl`
    const float GAMMA = ${r.glsl.float(t.colorGamma)};
    const float INV_GAMMA = ${r.glsl.float(1/t.colorGamma)};

    vec4 delinearizeGamma(vec4 color) {
      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.a);
    }

    vec3 linearizeGamma(vec3 color) {
      return pow(color, vec3(GAMMA));
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ScreenSpaceReflections.glsl":function(){define(["exports","../output/ReadDepth.glsl","../../shaderModules/Float2BindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../shaderModules/Matrix4BindUniform","../../shaderModules/Texture2DBindUniform"],(function(e,t,r,i,s,n,o){"use strict";e.ScreenSpaceReflections=function(e,a){if(!a.screenSpaceReflections)return;const l=e.fragment;l.include(t.ReadDepth),l.uniforms.add(new r.Float2BindUniform("nearFar",(e=>e.camera.nearFar)),new o.Texture2DBindUniform("depthMap",(e=>e.depth?.attachment)),new n.Matrix4BindUniform("proj",(e=>e.camera.projectionMatrix)),new i.FloatBindUniform("invResolutionHeight",(e=>1/e.camera.height)),new n.Matrix4BindUniform("reprojectionMatrix",(e=>e.ssr.reprojectionMatrix))).code.add(s.glsl`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${a.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);
    float dDepthBefore = 0.0;

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        float weight = dDepth / (dDepth - dDepthBefore);
        vec2 Pf = mix(P - dP, P, 1.0 - weight);
        if (abs(Pf.y - projectedCoordStart.y) > invResolutionHeight) {
          return vec3(Pf, depth);
        }
        else {
          return vec3(P, depth);
        }
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
      dDepthBefore = dDepth;
    }
    return vec3(P, 0.0);
  }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/CloudsParallaxShading.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../geometry/support/Ellipsoid","../../../../environment/Clouds","../../../../environment/CloudsParameters","../../../../environment/weather","../shading/MainLighting.glsl","./LookupCloudsFromTextureArray.glsl","../../shaderModules/BooleanBindUniform","../../shaderModules/Float3BindUniform","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../shaderModules/Matrix4BindUniform","../../shaderModules/Texture2DArrayBindUniform"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const m=(r.earth.radius+n.cloudsHeight)**2;e.CloudsParallaxShading=function(e){const r=e.fragment;r.constants.add("radiusCloudsSquared","float",m).code.add(d.glsl`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
return (cameraPosition + dir * pointIntDist) - spherePos;
}`),r.uniforms.add(new u.FloatBindUniform("radiusCurvatureCorrection",(({clouds:e})=>e.parallax.radiusCurvatureCorrection))).code.add(d.glsl`vec3 correctForPlanetCurvature(vec3 dir) {
dir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;
return dir;
}`),r.code.add(d.glsl`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),o.addMainLightDirection(r),o.addMainLightIntensity(r);const n=t.fromValues(.28,.175,.035);r.constants.add("RIM_COLOR","vec3",n),r.code.add(d.glsl`
    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {
      float upDotLight = dot(cameraPosition, mainLightDirection);
      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);
      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ${d.glsl.float(.3)}), 0.0, 1.0);

      // Base color of the clouds that depends on lighting of the sun and sky
      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);
      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));

      // Rim light around the edge of the clouds simulating scattering of the direct lun light
      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);
      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ${d.glsl.float(140)})) * scatteringMod;

      // Brighten the clouds around the sun at the sunsets
      float additionalLight = ${d.glsl.float(.2)} * pow(dirDotLight, ${d.glsl.float(10)}) * (1. - pow(sunsetTransition, ${d.glsl.float(.3)})) ;

      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);
    }
  `),e.include(a.LookupCloudsFromTextureArray),r.uniforms.add(new l.BooleanBindUniform("readChannelsRG",(e=>e.clouds.readChannels===i.CloudsTextureChannels.RG)),new p.Texture2DArrayBindUniform("cubeMap",(e=>e.clouds.data?.cubeMap?.colorTexture))).code.add(d.glsl`vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {
vec4 s = lookupCloudsFromTextureArray(cubeMap, rayDir);
bool readRG = readChannelsRG ^^ readOtherChannel;
s = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);
return length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;
}`),r.uniforms.add(new c.Float3BindUniform("anchorPoint",(e=>e.clouds.parallax.anchorPoint)),new c.Float3BindUniform("anchorPointNew",(e=>e.clouds.parallaxNew.anchorPoint)),new h.Matrix4BindUniform("rotationClouds",(e=>e.clouds.parallax.transform)),new h.Matrix4BindUniform("rotationCloudsNew",(e=>e.clouds.parallaxNew.transform)),new u.FloatBindUniform("cloudsOpacity",(e=>e.clouds.opacity)),new u.FloatBindUniform("fadeFactor",(e=>e.clouds.fadeFactor)),new l.BooleanBindUniform("crossFade",(e=>e.clouds.fadeState===s.FadeState.CROSS_FADE))).code.add(d.glsl`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {
vec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);
vec3 cameraPositionN = normalize(cameraPosition);
vec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
if(crossFade) {
intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);
worldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = sampleCloud(worldRayRotatedCorrected, false);
vec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorNew, fadeFactor);
}
float totalTransmittance = length(cloudColor.rgb) == 0.0 ?
1.0 :
clamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);
return vec4(cloudColor.rgb, totalTransmittance);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/CloudsParameters":function(){define(["exports","../../../core/compilerUtils","../../../core/mathUtils","../../../core/signal","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/axisAngleDegrees","../../../geometry/support/Ellipsoid","./Clouds","./weather"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";var h;e.FadeState=void 0,(h=e.FadeState||(e.FadeState={}))[h.HIDE=0]="HIDE",h[h.FADE_IN=1]="FADE_IN",h[h.SHOW=2]="SHOW",h[h.CROSS_FADE=3]="CROSS_FADE",h[h.FADE_OUT=4]="FADE_OUT";class p{constructor(){this.anchorPoint=a.create(),this.radiusCurvatureCorrection=0,this.transform=n.create()}}const m=a.fromValues(0,0,1),f=l.create(),g=a.create();e.CloudsParameters=class{constructor(){this.startTime=0,this._data=i.signal(null),this.coverage=0,this.absorption=0,this._readChannels=u.CloudsTextureChannels.RG,this.parallax=new p,this.parallaxNew=new p,this._anchorPoint=a.create(),this._fadeState=i.signal(e.FadeState.HIDE),this._fadeFactor=i.signal(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case e.FadeState.HIDE:return 0;case e.FadeState.FADE_OUT:return 1-this.fadeFactor;case e.FadeState.FADE_IN:return this.fadeFactor;case e.FadeState.SHOW:case e.FadeState.CROSS_FADE:return 1}}fade(e,t,i){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=i?r.clamp((t-this.startTime)/(1.25*i),0,1):1,1===this.fadeFactor&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(t,r){const i=t.relativeElevation,s=this._updateAnchorPoint(t);(i>1.7*d.heightLimit||i<-1e4||s>2e5)&&this.opacity>0?this._startFade(e.FadeState.HIDE,r):this.isFading||(i>d.heightLimit||i<-.35*d.heightLimit||s>1e5?this.opacity>0&&this._startFade(e.FadeState.FADE_OUT,r):u.ensureClouds(this.data)&&(0===this.opacity?this._startFade(e.FadeState.FADE_IN,r):this.data.state===u.CubeMapState.Ready&&(this.fadeState===e.FadeState.SHOW?this._startFade(e.FadeState.CROSS_FADE,r):this._startFade(e.FadeState.SHOW,r))))}_updateParallax(e){const t=o.squaredLength(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-c.earth.radius*c.earth.radius,0))/Math.sqrt(t),l.fromPoints(m,this.parallax.anchorPoint,f),s.rotate(this.parallax.transform,n.IDENTITY,f[3],l.axis(f)),l.fromPoints(m,this.parallaxNew.anchorPoint,f),s.rotate(this.parallaxNew.transform,n.IDENTITY,f[3],l.axis(f))}_updateAnchorPoint(t){return o.normalize(this._anchorPoint,t.eye),o.scale(this._anchorPoint,this._anchorPoint,c.earth.radius),this.fadeState===e.FadeState.HIDE&&this.data?.state===u.CubeMapState.Ready?(o.copy(this.parallax.anchorPoint,this._anchorPoint),0):o.length(o.subtract(g,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(t,r){switch(this._fadeState.value=t,this.startTime=r,t){case e.FadeState.CROSS_FADE:this.requestFade(),this._switchReadChannels(),o.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case e.FadeState.FADE_IN:this.requestFade(),this._switchReadChannels(),o.copy(this.parallax.anchorPoint,this._anchorPoint),o.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case e.FadeState.FADE_OUT:this.requestFade();break;case e.FadeState.SHOW:this._switchReadChannels(),o.copy(this.parallax.anchorPoint,this._anchorPoint),o.copy(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case e.FadeState.HIDE:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==u.CubeMapState.Ready&&(this.data.state=u.CubeMapState.Idle),this.fadeState){case e.FadeState.CROSS_FADE:o.copy(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=e.FadeState.SHOW;break;case e.FadeState.FADE_IN:this._fadeState.value=e.FadeState.SHOW;break;case e.FadeState.FADE_OUT:this._fadeState.value=e.FadeState.HIDE;break;case e.FadeState.SHOW:case e.FadeState.HIDE:break;default:t.neverReached(this.fadeState)}}_switchReadChannels(){this.data?.state===u.CubeMapState.Ready&&(this._readChannels=1-this._readChannels,this.data.state=u.CubeMapState.Fading)}get isFading(){return this.fadeState===e.FadeState.FADE_OUT||this.fadeState===e.FadeState.FADE_IN||this.fadeState===e.FadeState.CROSS_FADE}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/LookupCloudsFromTextureArray.glsl":function(){define(["exports","../../shaderModules/FloatBindUniform","../../shaderModules/glsl"],(function(e,t,r){"use strict";e.LookupCloudsFromTextureArray=function(e){e.fragment.uniforms.add(new t.FloatBindUniform("cloudAbsorption",(e=>e.clouds.absorption)),new t.FloatBindUniform("cloudCoverage",(e=>e.clouds.coverage))).code.add(r.glsl`vec4 lookupCloudsFromTextureArray(sampler2DArray cubeMap, vec3 rayDir) {
int faceIndex;
vec2 uv;
if(rayDir.z <= 0.0) {
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudCoverage), abs(dot(rayDir, vec3(0, 0, 1))));
float shading = clamp(1.0 - cloudAbsorption, 0.6, 1.0) * (1.0 - hazeFactor);
float totalTransmittance = hazeFactor;
return vec4(shading, totalTransmittance, shading, totalTransmittance);
}
if (abs(rayDir.x) >= abs(rayDir.y) && abs(rayDir.x) >= abs(rayDir.z)) {
if(rayDir.x > 0.0) {
faceIndex = 0;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, uv.y);
} else {
faceIndex = 1;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, -uv.y);
}
} else if (abs(rayDir.y) >= abs(rayDir.x) && abs(rayDir.y) >= abs(rayDir.z)) {
if(rayDir.y > 0.0) {
faceIndex = 2;
uv = rayDir.xz / rayDir.y;
} else {
faceIndex = 3;
uv = rayDir.xz / rayDir.y;
uv = vec2(uv.x, -uv.y);
}
} else {
if(rayDir.y < 0.0) {
faceIndex = 4;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
} else {
faceIndex = 5;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
}
}
uv = 0.5 * (uv + 1.0);
if(faceIndex != 5) {
uv.y = uv.y - 0.5;
}
uv.y = uv.y * 2.0;
vec4 s = texture(cubeMap, vec3(uv, float(faceIndex)));
return s;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DArrayBindUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"sampler2DArray",t.BindType.Bind,((t,i)=>t.bindTexture(e,r(i))))}}e.Texture2DArrayBindUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"usampler2D",t.BindType.Pass,((t,i,s)=>t.bindTexture(e,r(i,s))))}}e.Texture2DUintPassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/TextureOnly.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends o.NoParameters{constructor(){super(...arguments),this.color=t.fromValues(1,1,1)}}function c(){const e=new a.ShaderBuilder;return e.include(r.ScreenSpacePass),e.fragment.uniforms.add(new n.Texture2DPassUniform("tex",(e=>e.texture)),new i.Float3PassUniform("uColor",(e=>e.color))),e.fragment.main.add(s.glsl`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:l,build:c},Symbol.toStringTag,{value:"Module"}));e.TextureOnly=u,e.TextureOnlyPassParameters=l,e.build=c}))},"esri/views/3d/webgl-engine/effects/highlight/Highlight":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/has","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../webgl","../../../webgl/RenderNode","../../core/FBOCacheFormats","./HighlightApplyTechnique","./HighlightBlurTechnique","./HighlightDownsampleTechnique","./HighlightPassParameters","./HighlightToSingleTechnique","../../lib/basicInterfaces","../../lib/DefaultVertexAttributeLocations","../../lib/DefaultVertexBufferLayouts","../../lib/VertexArrayObject","../../../../../chunks/HighlightBlur.glsl","../../../../../chunks/HighlightDownsample.glsl","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M){"use strict";e.Highlight=class extends d{constructor(){super(...arguments),this.produces=u.InternalRenderCategory.HIGHLIGHTS,this.consumes={required:[u.InternalRenderCategory.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new x.HighlightDownsampleDrawParameters,this._passParameters=new g.HighlightPassParameters,this._highlightBlurDrawParameters=new w.HighlightBlurDrawParameters,this._grid=new R}initialize(){this.addHandles([s.watch((()=>this._updateOptionsTexture()),(()=>{}),s.initial)])}destroy(){this._grid.coverage=i.releaseMaybe(this._grid.coverage),this._grid.vao=i.disposeMaybe(this._grid.vao),this._passParameters.highlightOptionsTexture=i.releaseMaybe(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(null==this._passParameters.highlightOptionsTexture){const e=new M.TextureDescriptor(16,2);e.internalFormat=C.PixelFormat.RGBA,e.samplingMode=C.TextureSamplingMode.NEAREST,this._passParameters.highlightOptionsTexture=new P.Texture(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(function(e){const t=new Uint8Array(128);let r=0;for(const i of e){const e=4*r,s=4*r+64;++r;const{color:n}=i,o=i.haloColor??n;t[e+0]=n.r,t[e+1]=n.g,t[e+2]=n.b,t[e+3]=i.fillOpacity*n.a*255,t[s+0]=o.r,t[s+1]=o.g,t[s+2]=o.b,t[s+3]=i.haloOpacity*o.a*255}return t}(this.view.state.highlights)),this.requestRender(_.RenderRequestType.UPDATE)}precompile(){this.techniques.precompile(f.HighlightDownsampleTechnique),this.techniques.precompile(y.HighlightToSingleTechnique),this.techniques.precompile(m.HighlightBlurTechnique),this.techniques.precompile(p.HighlightApplyTechnique)}render(e){const t=e.find((({name:e})=>e===u.InternalRenderCategory.HIGHLIGHTS)),{techniques:r,bindParameters:i,_passParameters:s,renderingContext:n}=this;if(!i.decorations)return t;const o=r.get(f.HighlightDownsampleTechnique);if(!o.compiled)return this.requestRender(_.RenderRequestType.UPDATE),t;const a=e.find((({name:e})=>"highlights"===e)).getTexture();s.highlightTexture=a;const{camera:l}=i;return this._renderHighlightPostprocess(a,(()=>{this._gridUpdateResources(a);const e=this._gridComputeCoverage(o,a,i),{horizontalCellCount:t,verticalCellCount:r}=e;return s.horizontalCellCount=t,s.verticalCellCount=r,s.coverageTexture=e.coverage?.getTexture(),e}),(e=>{const t=e.verticalCellCount*e.horizontalCellCount;n.bindVAO(e.vao),n.drawElementsInstanced(C.PrimitiveType.TRIANGLES,6,C.DataType.UNSIGNED_BYTE,0,t)}),(()=>{n.bindFramebuffer(t.fbo),n.setViewport4fv(l.fullViewport)})),s.highlightTexture=null,s.coverageTexture=null,t}_renderHighlightPostprocess(e,t,r,i){const{fboCache:s,techniques:n,bindParameters:o,_passParameters:a,renderingContext:l}=this,u=n.get(y.HighlightToSingleTechnique),d=n.get(m.HighlightBlurTechnique),f=n.get(p.HighlightApplyTechnique);if(!f.compiled||!d.compiled||!u.compiled)return void this.requestRender(_.RenderRequestType.UPDATE);a.highlightTexture=e;const g=t(),{width:b,height:v}=e.descriptor;a.highlightTexture=e;const{camera:S}=o,{fullWidth:w,fullHeight:x,pixelRatio:T}=S,P=Math.ceil(w/T),M=Math.ceil(x/T),{_highlightBlurDrawParameters:R}=this,E=this.view.stage.renderView.renderer,{highlights:O}=o;for(let e=0;e<O.length;++e){const{name:t}=O[e];if(!E.hasHighlight(t))continue;a.highlightLevel=e,l.setClearColor(0,0,0,0);const n=s.acquire(b,v,"single highlight",h.ColorFormat.RG8UNORM);l.bindFramebuffer(n.fbo),l.setViewport(0,0,b,v),l.clear(C.FramebufferBit.COLOR),l.bindTechnique(u,o,a),r(g),R.blurInput=n.getTexture(),c.set(R.blurSize,1/P,0);const p=s.acquire(P,M,"single highlight blur h",h.ColorFormat.RG8UNORM);l.unbindTexture(p.fbo?.colorTexture),l.bindFramebuffer(p.fbo),l.setViewport(0,0,P,M),l.clear(C.FramebufferBit.COLOR),l.bindTechnique(d,o,a,R),r(g),n.release(),c.set(R.blurSize,0,1/M),a.highlightBlurTexture=p.getTexture(),i(),l.bindTechnique(f,o,a,R),r(g),p.release()}}_gridUpdateResources(e){const t=this._grid,{width:r,height:i}=e.descriptor;if(t.horizontalCellCount=Math.ceil(r/x.gridCellPixelSize),t.verticalCellCount=Math.ceil(i/x.gridCellPixelSize),t.vao)return;const s=this.renderingContext,n=T.BufferObject.createIndex(s,C.Usage.STATIC_DRAW,O);t.vao=new S.VertexArrayObject(s,b.Default3D,new Map([["geometry",v.NoVertex]]),new Map([["geometry",T.BufferObject.createVertex(s,C.Usage.STATIC_DRAW)]]),n)}_gridComputeCoverage(e,t,r){const i=this.renderingContext,s=this._grid,n=t.descriptor,o=Math.ceil(n.width/x.gridCellPixelSize),a=Math.ceil(n.height/x.gridCellPixelSize);this._downsampleDrawParameters.input=t;const{highlights:l}=r;s.coverage?.release();const c=this.fboCache.acquire(o,a,"highlight coverage",l.length>A?h.ColorFormat.RG8UINT:h.ColorFormat.R8UINT);return s.coverage=c,i.bindFramebuffer(c.fbo),i.bindTechnique(e,r,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,o,a),i.screen.draw(),s}get test(){}},t.__decorate([n.property()],e.Highlight.prototype,"produces",void 0),t.__decorate([n.property()],e.Highlight.prototype,"consumes",void 0),e.Highlight=t.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.highlight.Highlight")],e.Highlight);class R{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}}let E=0;const O=new Uint8Array([0,1,2,2,1,3]),A=4;e.maxHighlightsPerChannel=A,e.renderHighlightBuffer=function(e,t,r,i,s,n=0){const{highlights:o}=i,a=o.length>1?t.acquire(r.width,r.height,"highlight mix",o.length>A?h.ColorFormat.RG8UINT:h.ColorFormat.R8UINT):null,{gl:l}=e;if(a){const t=e.getBoundFramebufferObject();e.bindFramebuffer(a.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}const u=a?.getTexture();i.highlightMixTexture=u,c.set(i.highlightMixOrigin,n,0),o.forEach(((t,o)=>{if(o>0){const t=P.Texture.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(u,t),e.setActiveTexture(t),l.copyTexSubImage2D(C.TextureType.TEXTURE_2D,0,0,0,n,0,r.width,r.height),e.bindTexture(null,t)}e.clear(C.FramebufferBit.DEPTH),i.highlightLevel=o,s()})),i.highlightLevel=null,i.highlightMixTexture=null,a?.release()},e.trackHighlightOptions=function(e){let t=0;for(const r of e){const{name:e}=r;t+=e.length;const{color:i,fillOpacity:s,haloColor:n,haloOpacity:o}=r;t+=i.r+i.g+i.b+i.a+s,t+=n?n.r+n.g+n.b+n.a+o:0}const r=e.at(0);if(r){const{shadowOpacity:e,shadowDifference:i,shadowColor:s}=r;t+=e+i+s.r+s.g+s.b+s.a}return E+++(t>=0?0:1)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/highlight/HighlightApplyTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/HighlightApply.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.HighlightApply,(()=>new Promise(((t,r)=>e(["../../shaders/HighlightApply.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({blending:n.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:n.defaultColorWrite})}}t.HighlightApplyTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/HighlightApply.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/HighlightCellGridScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/HighlightReadBitmap.glsl","../views/3d/webgl-engine/core/shaderModules/Float2DrawUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform","./HighlightDownsample.glsl","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(){const e=new u.ShaderBuilder;e.include(t.HighlightCellGridScreenSpacePass);const{fragment:d}=e;return d.uniforms.add(new a.Texture2DPassUniform("blurInput",(e=>e.highlightBlurTexture)),new i.Float2DrawUniform("blurSize",(e=>e.blurSize)),new l.Texture2DUintPassUniform("highlightTexture",(e=>e.highlightTexture)),new a.Texture2DPassUniform("highlightOptionsTexture",(e=>e.highlightOptionsTexture)),new o.IntegerPassUniform("highlightLevel",(e=>e.highlightLevel)),new s.FloatPassUniform("occludedIntensityFactor",(e=>e.occludedFactor))),d.constants.add("inner","float",1-(c.outlineSize-c.blurSize)/c.outlineSize),e.include(r.HighlightReadBitmap),d.main.add(n.glsl`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),e}const h=Object.freeze(Object.defineProperty({__proto__:null,build:d},Symbol.toStringTag,{value:"Module"}));e.HighlightApply=h,e.build=d}))},"esri/views/3d/webgl-engine/core/shaderLibrary/HighlightCellGridScreenSpacePass.glsl":function(){define(["exports","../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../core/libs/gl-matrix-2/factories/vec2f64","../shaderModules/glsl","../shaderModules/Integer2PassUniform","../shaderModules/IntegerPassUniform","../shaderModules/Texture2DUintPassUniform","../../../../../chunks/HighlightDownsample.glsl"],(function(e,t,r,i,s,n,o,a){"use strict";const l=r.create();e.HighlightCellGridScreenSpacePass=function(e){const{vertex:r}=e;r.uniforms.add(new o.Texture2DUintPassUniform("coverageTexture",(e=>e.coverageTexture)),new s.Integer2PassUniform("highlightRenderCellCount",(e=>t.set(l,e.horizontalCellCount,e.verticalCellCount))),new s.Integer2PassUniform("highlightTextureResolution",(({highlightTexture:e})=>t.set(l,e.descriptor.width,e.descriptor.height))),new n.IntegerPassUniform("highlightLevel",(e=>e.highlightLevel))).constants.add("cellSize","int",a.gridCellPixelSize),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),r.code.add(i.glsl`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),r.main.add(i.glsl`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderModules/Integer2PassUniform":function(){define(["exports","../../../../webgl/BindType","../../../../webgl/Uniform"],(function(e,t,r){"use strict";class i extends r.Uniform{constructor(e,r){super(e,"ivec2",t.BindType.Pass,((t,i,s)=>t.setUniform2iv(e,r(i,s))))}}e.Integer2PassUniform=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/HighlightDownsample.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n){"use strict";class o extends s.NoParameters{}function a(){const e=new n.ShaderBuilder,{outputs:s,fragment:o}=e;return e.include(t.ScreenSpacePass),o.uniforms.add(new i.Texture2DUintPassUniform("highlightTexture",(e=>e.highlightTexture))),o.constants.add("outlineWidth","int",Math.ceil(c)),o.constants.add("cellSize","int",l),s.add("fragGrid","uvec2"),o.main.add(r.glsl`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),e}const l=32,c=9,u=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:o,blurSize:.4,build:a,gridCellPixelSize:l,outlineSize:c},Symbol.toStringTag,{value:"Module"}));e.HighlightDownsample=u,e.HighlightDownsampleDrawParameters=o,e.blurSize=.4,e.build=a,e.gridCellPixelSize=l,e.outlineSize=c}))},"esri/views/3d/webgl-engine/effects/highlight/HighlightBlurTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/HighlightBlur.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.HighlightBlur,(()=>new Promise(((t,r)=>e(["../../shaders/HighlightBlur.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.HighlightBlurTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/HighlightBlur.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec2f64","../views/3d/webgl-engine/core/shaderLibrary/HighlightCellGridScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/Float2DrawUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DDrawUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends o.NoParameters{constructor(){super(...arguments),this.blurSize=t.create()}}function c(){const e=new a.ShaderBuilder;return e.include(r.HighlightCellGridScreenSpacePass),e.outputs.add("fragHighlight","vec2",0),e.fragment.uniforms.add(new i.Float2DrawUniform("blurSize",(e=>e.blurSize)),new n.Texture2DDrawUniform("blurInput",(e=>e.blurInput))).main.add(s.glsl`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:l,build:c},Symbol.toStringTag,{value:"Module"}));e.HighlightBlur=u,e.HighlightBlurDrawParameters=l,e.build=c}))},"esri/views/3d/webgl-engine/effects/highlight/HighlightDownsampleTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/HighlightDownsample.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.HighlightDownsample,(()=>new Promise(((t,r)=>e(["../../shaders/HighlightDownsample.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.HighlightDownsampleTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/highlight/HighlightPassParameters":function(){define(["exports","../../../../support/HighlightDefaults","../../../../webgl/NoParameters"],(function(e,t,r){"use strict";class i extends r.NoParameters{constructor(){super(...arguments),this.occludedFactor=t.defaultOccludedFactor,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}}e.HighlightPassParameters=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/highlight/HighlightToSingleTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/HighlightToSingle.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.HighlightToSingle,(()=>new Promise(((t,r)=>e(["../../shaders/HighlightToSingle.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.HighlightToSingleTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/HighlightToSingle.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/HighlightCellGridScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/HighlightReadBitmap.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o){"use strict";function a(){const e=new o.ShaderBuilder;e.include(t.HighlightCellGridScreenSpacePass),e.include(r.HighlightReadBitmap);const{fragment:a}=e;return e.outputs.add("fragSingleHighlight","vec2",0),a.uniforms.add(new n.Texture2DUintPassUniform("highlightTexture",(e=>e.highlightTexture)),new s.IntegerPassUniform("highlightLevel",(e=>e.highlightLevel))),a.main.add(i.glsl`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),e}const l=Object.freeze(Object.defineProperty({__proto__:null,build:a},Symbol.toStringTag,{value:"Module"}));e.HighlightToSingle=l,e.build=a}))},"esri/views/3d/webgl-engine/lib/DefaultVertexBufferLayouts":function(){define(["exports","./VertexAttribute","../../../webgl/enums","../../../webgl/VertexElementDescriptor"],(function(e,t,r,i){"use strict";const s=[new i.VertexElementDescriptor(t.VertexAttribute.POSITION,3,r.DataType.FLOAT,0,12)],n=[new i.VertexElementDescriptor(t.VertexAttribute.POSITION,2,r.DataType.FLOAT,0,8)],o=[new i.VertexElementDescriptor(t.VertexAttribute.POSITION,2,r.DataType.FLOAT,0,12),new i.VertexElementDescriptor(t.VertexAttribute.UV0,2,r.DataType.HALF_FLOAT,8,12)],a=[new i.VertexElementDescriptor(t.VertexAttribute.POSITION,2,r.DataType.FLOAT,0,16),new i.VertexElementDescriptor(t.VertexAttribute.UV0,2,r.DataType.FLOAT,8,16)];e.NoVertex=[],e.Pos2=n,e.Pos2TexF16=o,e.Pos2TexF32=a,e.Pos3=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/GLMaterialRepository":function(){define(["exports","../../../../core/Logger","../../../../core/maybe","../../../../core/NestedMap","./GLMaterialParameters","./Util"],(function(e,t,r,i,s,n){"use strict";class o{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,n.assert(this._refCnt>=0)}get referenced(){return this._refCnt>0}}e.GLMaterialRepository=class{constructor(e,t,r,s){this._textures=e,this._techniques=t,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new i.NestedMap}dispose(){this._textures.destroy()}acquire(e,t,r){this._ownMaterial(e);const i=e.produces.get(t);if(!i?.(r))return null;let n=this._id2glMaterialRef.get(r,e.id);if(null==n){const t=e.createGLMaterial(new s.GLMaterialParameters(e,r,this._techniques,this._textures));n=new o(t),this._id2glMaterialRef.set(r,e.id,n)}return n.ref(),n.glMaterial}release(e,t){const i=this._id2glMaterialRef.get(t,e.id);null!=i&&(i.unref(),i.referenced||(r.disposeMaybe(i.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&t.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/GLMaterialParameters":function(){define(["exports"],(function(e){"use strict";e.GLMaterialParameters=class{constructor(e,t,r,i){this.material=e,this.output=t,this.techniques=r,this.textures=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/GridLocalOriginFactory":function(){define(["exports","../../../../core/has","../../../../core/uid","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/projection/projectBuffer","./Attribute","./Geometry","./LocalOriginFactory","./Object3D","./testUtils","./VertexAttribute","./WebGLLayer","../materials/RibbonLineMaterial","./IntersectableGeometry"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";const g=s.create();e.GridLocalOriginFactory=class{constructor(e){this._originSR=e,this._rootOriginId="root/"+r.generateUID(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=d.gridLocalOriginFactory.rootOrigin;if(null!=t)return this._origins.set(this._rootOriginId,c.fromValues(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);const r=c.fromValues(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,r),r}const r=this._gridSize,s=Math.round(e[0]/r),n=Math.round(e[1]/r),o=Math.round(e[2]/r),a=`${s}/${n}/${o}`;let l=this._origins.get(a);const u=.5*r;if(i.subtract(g,e,t.vec3),g[0]=Math.abs(g[0]),g[1]=Math.abs(g[1]),g[2]=Math.abs(g[2]),g[0]<u&&g[1]<u&&g[2]<u){if(l){const t=Math.max(...g);if(i.subtract(g,e,l.vec3),g[0]=Math.abs(g[0]),g[1]=Math.abs(g[1]),g[2]=Math.abs(g[2]),Math.max(...g)<t)return l}return t}return l||(l=c.fromValues(s*r,n*r,o*r,a),this._origins.set(a,l)),l}_drawOriginBox(e,t=n.fromValues(1,1,0,1)){const r=window.view,i=r.stage,s=t.toString();if(!this._objects.has(s)){this._material=new m.RibbonLineMaterial({width:2,color:t});const e=new p.WebGLLayer(i,{pickable:!1}),r=new u.Object3D({castShadow:!1});e.add(r),this._objects.set(s,r)}const c=this._objects.get(s),d=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],g=d.length,y=new Array(3*g),_=new Array,b=.5*this._gridSize;for(let t=0;t<g;t++)y[3*t]=e[0]+(1&d[t]?b:-b),y[3*t+1]=e[1]+(2&d[t]?b:-b),y[3*t+2]=e[2]+(4&d[t]?b:-b),t>0&&_.push(t-1,t);o.projectBuffer(y,this._originSR,0,y,r.renderSpatialReference,0,g);const v=new l.Geometry(this._material,[[h.VertexAttribute.POSITION,new a.Attribute(y,_,3,!0)]],null,f.GeometryType.Line);c.addGeometry(v)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/RibbonLineMaterial":function(){define(["exports","../../../../core/Logger","../../../../core/mathUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/math/vec2","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/float16","../../../../geometry/support/frustum","../../../../geometry/support/lineSegment","../../../../geometry/support/plane","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../effects/geometry/olidUtils","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/Util","../lib/VertexAttribute","./VisualVariablePassParameters","./internal/bufferWriterUtils","../shaders/LineMarkerTechniqueConfiguration","../../../../chunks/RibbonLine.glsl","../shaders/RibbonLineTechnique","../shaders/RibbonLineTechniqueConfiguration","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P){"use strict";var M;!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(M||(M={}));class R extends g.Material{constructor(e){super(e,O),this._configuration=new C.RibbonLineTechniqueConfiguration,this.vertexAttributeLocations=T.vertexAttributeLocations,this.produces=new Map([[y.RenderSlot.OPAQUE_MATERIAL,e=>p.isHighlightOrOID(e)||p.isColorOrColorEmission(e)&&this.parameters.renderOccluded===g.RenderOccludedFlag.OccludeAndTransparentStencil],[y.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS,e=>p.isDepth(e)],[y.RenderSlot.OCCLUDER_MATERIAL,e=>p.isColorEmissionHighlightOIDOrDepth(e)&&this.parameters.renderOccluded===g.RenderOccludedFlag.OccludeAndTransparentStencil],[y.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,e=>p.isColorEmissionHighlightOIDOrDepth(e)&&this.parameters.renderOccluded===g.RenderOccludedFlag.OccludeAndTransparentStencil],[y.RenderSlot.TRANSPARENT_MATERIAL,e=>p.isColorOrColorEmission(e)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==g.RenderOccludedFlag.OccludeAndTransparentStencil],[y.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,e=>p.isColorOrColorEmission(e)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==g.RenderOccludedFlag.OccludeAndTransparentStencil],[y.RenderSlot.DRAPED_MATERIAL,e=>p.is2DGeometryOutput(e)]])}getConfiguration(e,t){super.getConfiguration(e,t,this._configuration),this._configuration.oitPass=t.oitPass,this._configuration.draped=t.slot===y.RenderSlot.DRAPED_MATERIAL;const r=null!=this.parameters.stipplePattern&&e!==p.ShaderOutput.Highlight;var i;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&null!=this.parameters.stippleOffColor,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&(i=this.parameters.markerParameters).anchor===w.LineMarkerAnchor.Tip&&i.hideOnShortSegments&&"begin-end"===i.placement&&i.worldSpace,this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.hasOccludees=t.hasOccludees,this._configuration.occluder=this.parameters.renderOccluded===g.RenderOccludedFlag.OccludeAndTransparentStencil,this._configuration.terrainDepthTest=t.terrainDepthTest&&p.isColorOrColorEmission(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.wireframe=this.parameters.wireframe,this._configuration}get visible(){return this.parameters.color[3]>=P.alphaCutoff||null!=this.parameters.stipplePattern&&(this.parameters.stippleOffColor?.[3]??0)>P.alphaCutoff}intersectDraped({attributes:e,screenToWorldRatio:t},i,s,n,o){if(!i.options.selectionMode)return;const a=e.get(b.VertexAttribute.SIZE);let l=this.parameters.width;if(this.parameters.vvSize){const t=e.get(b.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];Number.isNaN(t)?l*=this.parameters.vvSize.fallback[0]:l*=r.clamp(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else a&&(l*=a.data[0]);const c=s[0],u=s[1],d=(l/2+4)*t;let h=Number.MAX_VALUE,p=0;const m=e.get(b.VertexAttribute.POSITION).data,f=D(this.parameters,e)?m.length-2:m.length-5;for(let e=0;e<f;e+=3){const t=m[e],i=m[e+1],s=(e+3)%m.length,n=c-t,o=u-i,a=m[s]-t,l=m[s+1]-i,d=a*n+l*o,f=a*a+l*l,g=r.clamp(d/f,0,1),y=a*g-n,_=l*g-o,b=y*y+_*_;b<h&&(h=b,p=e/3)}h<d*d&&n(o.distance,o.normal,p)}intersect(e,i,o,a,l,h){const{options:p,camera:m,rayBegin:f,rayEnd:g}=o;if(!p.selectionMode||!e.visible||!m)return;if(!_.isTranslationMatrix(i))return void t.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const y=e.attributes,v=y.get(b.VertexAttribute.POSITION).data;let S=this.parameters.width;if(this.parameters.vvSize){const e=y.get(b.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];Number.isNaN(e)||(S*=r.clamp(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0]))}else y.has(b.VertexAttribute.SIZE)&&(S*=y.get(b.VertexAttribute.SIZE).data[0]);const w=V;s.copy(w,o.point);const x=S*m.pixelRatio/2+4*m.pixelRatio;n.set(Q[0],w[0]-x,w[1]+x,0),n.set(Q[1],w[0]+x,w[1]+x,0),n.set(Q[2],w[0]+x,w[1]-x,0),n.set(Q[3],w[0]-x,w[1]-x,0);for(let e=0;e<4;e++)if(!m.unprojectFromRenderScreen(Q[e],Z[e]))return;d.fromPoints(m.eye,Z[0],Z[1],Y),d.fromPoints(m.eye,Z[1],Z[2],X),d.fromPoints(m.eye,Z[2],Z[3],K),d.fromPoints(m.eye,Z[3],Z[0],J);let T=Number.MAX_VALUE,C=0;const P=D(this.parameters,y)?v.length-2:v.length-5;for(let e=0;e<P;e+=3){F[0]=v[e]+i[12],F[1]=v[e+1]+i[13],F[2]=v[e+2]+i[14];const t=(e+3)%v.length;if(L[0]=v[t]+i[12],L[1]=v[t+1]+i[13],L[2]=v[t+2]+i[14],d.signedDistance(Y,F)<0&&d.signedDistance(Y,L)<0||d.signedDistance(X,F)<0&&d.signedDistance(X,L)<0||d.signedDistance(K,F)<0&&d.signedDistance(K,L)<0||d.signedDistance(J,F)<0&&d.signedDistance(J,L)<0)continue;if(m.projectToRenderScreen(F,B),m.projectToRenderScreen(L,G),B[2]<0&&G[2]>0){n.subtract(N,F,L);const e=m.frustum,t=-d.signedDistance(e[c.PlaneIndex.NEAR],F)/n.dot(N,d.getNormal(e[c.PlaneIndex.NEAR]));n.scale(N,N,t),n.add(F,F,N),m.projectToRenderScreen(F,B)}else if(B[2]>0&&G[2]<0){n.subtract(N,L,F);const e=m.frustum,t=-d.signedDistance(e[c.PlaneIndex.NEAR],L)/n.dot(N,d.getNormal(e[c.PlaneIndex.NEAR]));n.scale(N,N,t),n.add(L,L,N),m.projectToRenderScreen(L,G)}else if(B[2]<0&&G[2]<0)continue;B[2]=0,G[2]=0;const r=u.distance2(u.fromPoints(B,G,j),w);r<T&&(T=r,n.copy(k,F),n.copy(z,L),C=e/3)}if(T<x*x){let e=Number.MAX_VALUE;if(u.closestLineSegmentPoint(u.fromPoints(k,z,j),u.fromPoints(f,g,q),U)){n.subtract(U,U,f);const t=n.length(U);n.scale(U,U,1/t),e=t/n.distance(f,g)}h(e,U,C)}}get _layout(){const e=h.newLayout().vec3f(b.VertexAttribute.POSITION).vec4f16(b.VertexAttribute.PREVIOUSDELTA).vec4f16(b.VertexAttribute.NEXTDELTA).f32(b.VertexAttribute.U0).vec2f16(b.VertexAttribute.LINEPARAMETERS);return this.parameters.vvColor?e.f32(b.VertexAttribute.COLORFEATUREATTRIBUTE):e.vec4u8(b.VertexAttribute.COLOR,{glNormalized:!0}),this.parameters.vvSize?e.f32(b.VertexAttribute.SIZEFEATUREATTRIBUTE):e.f32(b.VertexAttribute.SIZE),this.parameters.vvOpacity&&e.f32(b.VertexAttribute.OPACITYFEATUREATTRIBUTE),m.olidEnabled()&&e.vec4u8(b.VertexAttribute.OLIDCOLOR),e}createBufferWriter(){return new A(this._layout,this.parameters)}createGLMaterial(e){return new E(e)}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)}}class E extends f{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures.release(this._stipplePattern),this._stipplePattern=null}beginSlot(e){const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.getTechnique(T.RibbonLineTechnique,e)}}class O extends v.VisualVariablePassParameters{constructor(){super(...arguments),this.width=0,this.color=a.ONES,this.join="miter",this.cap=C.CapType.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.wireframe=!1}get transparent(){return this.color[3]<1||null!=this.stipplePattern&&(this.stippleOffColor?.[3]??0)<1}}class A{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t;const r=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=x.ribbonlineNumRoundJoinSubdivisions+r}}_isClosed(e){return D(this._parameters,e)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.get(b.VertexAttribute.POSITION).indices.length/2+1,r=this._isClosed(e);let i=r?2:4;return i+=((r?t:t-1)-(r?0:1))*(2*this.numJoinSubdivisions+4),i+=2,this._parameters.wireframe&&(i=2+4*(i-2)),i}write(e,t,r,i,s,o){const a=r.get(b.VertexAttribute.POSITION),c=a.indices,u=a.data.length/3,d=r.get(b.VertexAttribute.DISTANCETOSTART)?.data;c&&c.length!==2*(u-1)&&console.warn("RibbonLineMaterial does not support indices");const h=(this.vertexBufferLayout.fields.has(b.VertexAttribute.SIZEFEATUREATTRIBUTE)?r.get(b.VertexAttribute.SIZEFEATUREATTRIBUTE)?.data[0]:r.get(b.VertexAttribute.SIZE)?.data[0])??1;let p=[1,1,1,1],f=0;const g=this.vertexBufferLayout.fields.has(b.VertexAttribute.COLORFEATUREATTRIBUTE);g?f=r.get(b.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:r.has(b.VertexAttribute.COLOR)&&(p=r.get(b.VertexAttribute.COLOR).data);const y=this.vertexBufferLayout.fields.has(b.VertexAttribute.OPACITYFEATUREATTRIBUTE),_=y?r.get(b.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]:0,v=new Float32Array(s.buffer),w=l.makeFloat16Array(s.buffer),x=new Uint8Array(s.buffer),T=this.vertexBufferLayout.stride/4;let C=o*T;const P=C;let R=0;const E=d?(e,t,r)=>R=d[r]:(e,t,r)=>R+=n.distance(e,t),O=v.BYTES_PER_ELEMENT/w.BYTES_PER_ELEMENT,A=4/O,D=(e,t,r,s,n,o,a)=>{v[C++]=t[0],v[C++]=t[1],v[C++]=t[2],S.writeDeltaF16Vector(e,t,w,C*O),C+=A,S.writeDeltaF16Vector(r,t,w,C*O),C+=A,v[C++]=a;let l=C*O;if(w[l++]=s,w[l++]=n,C=Math.ceil(l/O),g)v[C]=f;else{const e=Math.min(4*o,p.length-4),t=4*C;x[t]=255*p[e],x[t+1]=255*p[e+1],x[t+2]=255*p[e+2],x[t+3]=255*p[e+3]}if(C++,v[C++]=h,y&&(v[C++]=_),m.olidEnabled()){let e=4*C;i?(x[e++]=i[0],x[e++]=i[1],x[e++]=i[2],x[e++]=i[3]):(x[e++]=0,x[e++]=0,x[e++]=0,x[e++]=0),C=Math.ceil(.25*e)}};C+=T,n.set(W,a.data[0],a.data[1],a.data[2]),e&&n.transformMat4(W,W,e);const F=this._isClosed(r);if(F){const t=a.data.length-3;n.set(H,a.data[t],a.data[t+1],a.data[t+2]),e&&n.transformMat4(H,H,e)}else n.set($,a.data[3],a.data[4],a.data[5]),e&&n.transformMat4($,$,e),D(W,W,$,1,M.LEFT_CAP_START,0,0),D(W,W,$,1,M.RIGHT_CAP_START,0,0),n.copy(H,W),n.copy(W,$);const L=F?0:1,N=F?u:u-1;for(let t=L;t<N;t++){const r=(t+1)%u*3;n.set($,a.data[r],a.data[r+1],a.data[r+2]),e&&n.transformMat4($,$,e),E(H,W,t),D(H,W,$,0,M.LEFT_JOIN_END,t,R),D(H,W,$,0,M.RIGHT_JOIN_END,t,R);const i=this.numJoinSubdivisions;for(let e=0;e<i;++e){const r=(e+1)/(i+1);D(H,W,$,r,M.LEFT_JOIN_END,t,R),D(H,W,$,r,M.RIGHT_JOIN_END,t,R)}D(H,W,$,1,M.LEFT_JOIN_START,t,R),D(H,W,$,1,M.RIGHT_JOIN_START,t,R),n.copy(H,W),n.copy(W,$)}return F?(n.set($,a.data[3],a.data[4],a.data[5]),e&&n.transformMat4($,$,e),R=E(H,W,N),D(H,W,$,0,M.LEFT_JOIN_END,L,R),D(H,W,$,0,M.RIGHT_JOIN_END,L,R)):(R=E(H,W,N),D(H,W,W,0,M.LEFT_CAP_END,N,R),D(H,W,W,0,M.RIGHT_CAP_END,N,R)),I(v,P+T,v,P,T),C=I(v,C-T,v,C,T),this._parameters.wireframe&&this._addWireframeVertices(s,P,C,T),null}_addWireframeVertices(e,t,r,i){const s=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t);let o=0;const a=e=>o=I(n,e,s,o,i);for(let e=0;e<n.length-1;e+=2*i)a(e),a(e+2*i),a(e+1*i),a(e+2*i),a(e+1*i),a(e+3*i)}}function I(e,t,r,i,s){for(let n=0;n<s;n++)r[i++]=e[t++];return i}function D(e,t){return!!e.isClosed&&t.get(b.VertexAttribute.POSITION).indices.length>2}const F=o.create(),L=o.create(),N=o.create(),U=o.create(),V=o.create(),B=i.createRenderScreenPointArray3(),G=i.createRenderScreenPointArray3(),k=o.create(),z=o.create(),j=u.create(),q=u.create(),H=o.create(),W=o.create(),$=o.create(),Q=[i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3(),i.createRenderScreenPointArray3()],Z=[o.create(),o.create(),o.create(),o.create()],Y=d.create(),X=d.create(),K=d.create(),J=d.create();e.Parameters=O,e.RibbonLineMaterial=R,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/LineMarkerTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../core/shaderLibrary/output/Emissions.glsl","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],(function(e,t,r,i,s,n){"use strict";var o,a;e.LineMarkerSpace=void 0,(o=e.LineMarkerSpace||(e.LineMarkerSpace={}))[o.Draped=0]="Draped",o[o.Screen=1]="Screen",o[o.World=2]="World",o[o.COUNT=3]="COUNT",e.LineMarkerAnchor=void 0,(a=e.LineMarkerAnchor||(e.LineMarkerAnchor={}))[a.Center=0]="Center",a[a.Tip=1]="Tip",a[a.COUNT=2]="COUNT";class l extends n.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.space=e.LineMarkerSpace.Screen,this.anchor=e.LineMarkerAnchor.Center,this.occluder=!1,this.writeDepth=!1,this.hideOnShortSegments=!1,this.hasCap=!1,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=r.TextureCoordinateType.None,this.emissionSource=i.EmissionSource.None,this.discardInvisibleFragments=!0,this.occlusionPass=!1,this.hasVvInstancing=!0,this.hasSliceTranslatedView=!0,this.objectAndLayerIdColorInstanced=!1,this.overlayEnabled=!1,this.snowCover=!1}get draped(){return this.space===e.LineMarkerSpace.Draped}}t.__decorate([s.parameter({count:e.LineMarkerSpace.COUNT})],l.prototype,"space",void 0),t.__decorate([s.parameter({count:e.LineMarkerAnchor.COUNT})],l.prototype,"anchor",void 0),t.__decorate([s.parameter()],l.prototype,"occluder",void 0),t.__decorate([s.parameter()],l.prototype,"writeDepth",void 0),t.__decorate([s.parameter()],l.prototype,"hideOnShortSegments",void 0),t.__decorate([s.parameter()],l.prototype,"hasCap",void 0),t.__decorate([s.parameter()],l.prototype,"hasTip",void 0),t.__decorate([s.parameter()],l.prototype,"vvSize",void 0),t.__decorate([s.parameter()],l.prototype,"vvColor",void 0),t.__decorate([s.parameter()],l.prototype,"vvOpacity",void 0),t.__decorate([s.parameter()],l.prototype,"hasOccludees",void 0),t.__decorate([s.parameter()],l.prototype,"terrainDepthTest",void 0),t.__decorate([s.parameter()],l.prototype,"cullAboveTerrain",void 0),e.LineMarkerTechniqueConfiguration=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/RibbonLine.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/ObjectAndLayerIdColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/RibbonVertexPosition.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/LineStipple.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MarkerSizing.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PiUtils.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float2BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform","../views/3d/webgl-engine/lib/VertexAttribute","../views/3d/webgl-engine/shaders/LineMarkerTechniqueConfiguration","../views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl","../views/3d/webgl-engine/shaders/RibbonLineTechniqueConfiguration","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x){"use strict";function T(e){const T=new w.ShaderBuilder,{attributes:C,varyings:P,vertex:M,fragment:R}=T,{applyMarkerOffset:E,draped:O,output:A,capType:I,stippleEnabled:D,falloffEnabled:F,roundJoins:L,wireframe:N,innerColorEnabled:U}=e;R.include(a.PiUtils),T.include(s.RibbonVertexPosition,e),T.include(n.LineStipple,e),T.include(i.ObjectAndLayerIdColor,e),T.include(l.terrainDepthTest,e);const V=E&&!O;V&&(M.uniforms.add(new f.FloatPassUniform("markerScale",(e=>e.markerScale))),T.include(o.MarkerSizing,{space:b.LineMarkerSpace.World})),u.addProjViewLocalOrigin(M,e),M.uniforms.add(new y.Matrix4BindUniform("inverseProjectionMatrix",(e=>e.camera.inverseProjectionMatrix)),new d.Float2BindUniform("nearFar",(e=>e.camera.nearFar)),new f.FloatPassUniform("miterLimit",(e=>"miter"!==e.join?0:e.miterLimit)),new h.Float4BindUniform("viewport",(e=>e.camera.fullViewport))),M.constants.add("LARGE_HALF_FLOAT","float",65500),C.add(_.VertexAttribute.POSITION,"vec3"),C.add(_.VertexAttribute.PREVIOUSDELTA,"vec4"),C.add(_.VertexAttribute.NEXTDELTA,"vec4"),C.add(_.VertexAttribute.LINEPARAMETERS,"vec2"),C.add(_.VertexAttribute.U0,"float"),P.add("vColor","vec4"),P.add("vpos","vec3",{invariant:!0}),P.add("vLineDistance","float"),P.add("vLineWidth","float");const B=D;B&&P.add("vLineSizeInv","float");const G=I===S.CapType.ROUND,k=D&&G,z=F||k;z&&P.add("vLineDistanceNorm","float"),G&&(P.add("vSegmentSDF","float"),P.add("vReverseSegmentSDF","float")),M.code.add(g.glsl`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),M.code.add(g.glsl`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),M.code.add(g.glsl`void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
float vnp = nearFar[0] * 0.99;
if(pos.z > -nearFar[0]) {
if (!isStartVertex) {
if(prev.z < -nearFar[0]) {
pos = mix(prev, pos, interp(vnp, prev, pos));
next = pos;
} else {
pos = vec4(0.0, 0.0, 0.0, 1.0);
}
} else {
if(next.z < -nearFar[0]) {
pos = mix(pos, next, interp(vnp, pos, next));
prev = pos;
} else {
pos = vec4(0.0, 0.0, 0.0, 1.0);
}
}
} else {
if (prev.z > -nearFar[0]) {
prev = mix(pos, prev, interp(vnp, pos, prev));
}
if (next.z > -nearFar[0]) {
next = mix(next, pos, interp(vnp, next, pos));
}
}
forwardViewPosDepth(pos.xyz);
pos = projectAndScale(pos);
next = projectAndScale(next);
prev = projectAndScale(prev);
}`),u.addPixelRatio(M),M.constants.add("aaWidth","float",D?0:1).main.add(g.glsl`
    // unpack values from vertex type
    bool isStartVertex = abs(abs(lineParameters.y)-3.0) == 1.0;
    vec3 prevPosition = position + previousDelta.xyz * previousDelta.w;
    vec3 nextPosition = position + nextDelta.xyz * nextDelta.w;

    float coverage = 1.0;

    // Check for special value of lineParameters.y which is used by the Renderer when graphics are removed before the
    // VBO is recompacted. If this is the case, then we just project outside of clip space.
    if (lineParameters.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(lineParameters.y) < 3.0;
      float lineSize = getSize();

      if (lineSize < 1.0) {
        coverage = lineSize; // convert sub-pixel coverage to alpha
        lineSize = 1.0;
      }
      lineSize += aaWidth;

      float lineWidth = lineSize * pixelRatio;
      vLineWidth = lineWidth;
      ${B?g.glsl`vLineSizeInv = 1.0 / lineSize;`:""}

      vec4 pos  = view * vec4(position, 1.0);
      vec4 prev = view * vec4(prevPosition, 1.0);
      vec4 next = view * vec4(nextPosition, 1.0);
  `),V&&M.main.add(g.glsl`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),M.main.add(g.glsl`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(D||G)&&M.main.add(g.glsl`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${G?g.glsl`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),M.main.add(g.glsl`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * lineParameters.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = perpendicular(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
float subdivisionFactor = lineParameters.x;
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),L?M.main.add(g.glsl`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = perpendicular(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = perpendicular(endDir);

        float factor = ${D?g.glsl`min(1.0, subdivisionFactor * ${g.glsl.float(1.5)})`:g.glsl`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(lineParameters.y) * factor * rotationAngle);
      `):M.main.add(g.glsl`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = perpendicular(joinDisplacementDir);`);const j=I!==S.CapType.BUTT;return M.main.add(g.glsl`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = perpendicular(joinDisplacementDir);

      ${j?g.glsl`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),M.main.add(g.glsl`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(lineParameters.y) * displacementLen + capDisplacementDir * displacementLen;
    float lineDistNorm = sign(lineParameters.y) * pos.w;

    vLineDistance =  lineWidth * lineDistNorm;
    ${z?g.glsl`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),G&&M.main.add(g.glsl`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),D&&(O?M.uniforms.add(new m.FloatBindUniform("worldToScreenRatio",(e=>1/e.screenToPCSRatio))):M.main.add(g.glsl`vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),M.main.add(g.glsl`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),O?M.main.add(g.glsl`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = u0 * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):M.main.add(g.glsl`float startPseudoScreen = mix(u0, u0 - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),M.uniforms.add(new f.FloatPassUniform("stipplePatternPixelSize",(e=>n.computePixelSize(e)))),M.main.add(g.glsl`float patternLength = lineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits *= pos.w;
vStippleDistance *= pos.w;
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),M.main.add(g.glsl`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${N&&!O?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }`),T.fragment.include(r.SliceDraw,e),T.include(v.outputColorHighlightOID,e),R.include(c.ColorConversion),R.main.add(g.glsl`discardBySlice(vpos);
discardByTerrainDepth();`),N?R.main.add(g.glsl`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(G&&R.main.add(g.glsl`
        float sdf = min(vSegmentSDF, vReverseSegmentSDF);
        vec2 fragmentPosition = vec2(
          min(sdf, 0.0),
          vLineDistance
        ) * gl_FragCoord.w;

        float fragmentRadius = length(fragmentPosition);
        float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

        if (capCoverage < ${g.glsl.float(x.alphaCutoff)}) {
          discard;
        }
      `),k?R.main.add(g.glsl`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${g.glsl.float(x.alphaCutoff)}, stippleCoverage);
      `):R.main.add(g.glsl`float stippleAlpha = getStippleAlpha();`),A!==t.ShaderOutput.ObjectAndLayerIdColor&&R.main.add(g.glsl`discardByStippleAlpha(stippleAlpha, ${g.glsl.float(x.alphaCutoff)});`),R.uniforms.add(new p.Float4PassUniform("intrinsicColor",(e=>e.color))),R.main.add(g.glsl`vec4 color = intrinsicColor * vColor;`),U&&(R.uniforms.add(new p.Float4PassUniform("innerColor",(e=>e.innerColor??e.color)),new f.FloatPassUniform("innerWidth",((e,t)=>e.innerWidth*t.camera.pixelRatio))),R.main.add(g.glsl`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),R.main.add(g.glsl`vec4 finalColor = blendStipple(color, stippleAlpha);`),F&&(R.uniforms.add(new f.FloatPassUniform("falloff",(e=>e.falloff))),R.main.add(g.glsl`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),D||R.main.add(g.glsl`float featherStartDistance = max(vLineWidth - 2.0, 0.0);
float value = abs(vLineDistance) * gl_FragCoord.w;
float feather = (value - featherStartDistance) / (vLineWidth - featherStartDistance);
finalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);`)),R.main.add(g.glsl`outputColorHighlightOID(finalColor, vpos, finalColor.rgb);`),T}const C=Object.freeze(Object.defineProperty({__proto__:null,build:T,ribbonlineNumRoundJoinSubdivisions:1},Symbol.toStringTag,{value:"Module"}));e.RibbonLine=C,e.build=T,e.ribbonlineNumRoundJoinSubdivisions=1}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/RibbonVertexPosition.glsl":function(){define(["exports","../shading/VisualVariables.glsl","../../shaderModules/Float3PassUniform","../../shaderModules/FloatPassUniform","../../shaderModules/FloatsPassUniform","../../shaderModules/glsl","../../../lib/VertexAttribute"],(function(e,t,r,i,s,n,o){"use strict";e.RibbonVertexPosition=function(e,a){const{vertex:l,attributes:c}=e;l.uniforms.add(new i.FloatPassUniform("intrinsicWidth",(e=>e.width))),a.vvSize?(c.add(o.VertexAttribute.SIZEFEATUREATTRIBUTE,"float"),l.uniforms.add(new r.Float3PassUniform("vvSizeMinSize",(e=>e.vvSize.minSize)),new r.Float3PassUniform("vvSizeMaxSize",(e=>e.vvSize.maxSize)),new r.Float3PassUniform("vvSizeOffset",(e=>e.vvSize.offset)),new r.Float3PassUniform("vvSizeFactor",(e=>e.vvSize.factor)),new r.Float3PassUniform("vvSizeFallback",(e=>e.vvSize.fallback))),l.code.add(n.glsl`float getSize() {
if (isnan(sizeFeatureAttribute)) {
return vvSizeFallback.x;
}
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(c.add(o.VertexAttribute.SIZE,"float"),l.code.add(n.glsl`float getSize(){
return intrinsicWidth * size;
}`)),a.vvOpacity?(c.add(o.VertexAttribute.OPACITYFEATUREATTRIBUTE,"float"),l.constants.add("vvOpacityNumber","int",8),l.uniforms.add(new s.FloatsPassUniform("vvOpacityValues",(e=>e.vvOpacity.values),8),new s.FloatsPassUniform("vvOpacityOpacities",(e=>e.vvOpacity.opacityValues),8),new i.FloatPassUniform("vvOpacityFallback",(e=>e.vvOpacity.fallback))),l.code.add(n.glsl`float interpolateOpacity(float value){
if (isnan(value)) {
return vvOpacityFallback;
}
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):l.code.add(n.glsl`vec4 applyOpacity( vec4 color ){
return color;
}`),a.vvColor?(e.include(t.VisualVariables,a),c.add(o.VertexAttribute.COLORFEATUREATTRIBUTE,"float"),l.code.add(n.glsl`vec4 getColor(){
return applyOpacity(interpolateVVColor(colorFeatureAttribute));
}`)):(c.add(o.VertexAttribute.COLOR,"vec4"),l.code.add(n.glsl`vec4 getColor(){
return applyOpacity(color);
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/LineStipple.glsl":function(){define(["exports","../util/RgbaFloatEncoding.glsl","../util/View.glsl","../../shaderModules/Float4PassUniform","../../shaderModules/FloatBindUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform","../../../materials/stippleTextureRepository","../../../shaders/ensureColor4"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e){const t=e.stipplePattern;return t?l.computeTextureSize(e.stipplePattern)/t.pixelRatio:1}e.LineStipple=function(e,d){if(!d.stippleEnabled)return void e.fragment.code.add(o.glsl`float getStippleAlpha() { return 1.0; }
void discardByStippleAlpha(float stippleAlpha, float threshold) {}
vec4 blendStipple(vec4 color, float stippleAlpha) { return color; }`);const h=!(d.draped&&d.stipplePreferContinuous),{vertex:p,fragment:m}=e;m.include(t.RgbaFloatEncoding),d.draped||(r.addCameraPosition(p,d),p.uniforms.add(new s.FloatBindUniform("worldToScreenPerDistanceRatio",(({camera:e})=>1/e.perScreenPixelRatio))).code.add(o.glsl`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),e.varyings.add("vStippleDistanceLimits","vec2"),e.varyings.add("vStipplePatternStretch","float"),p.code.add(o.glsl`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${o.glsl.float(.4)};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),p.code.add(o.glsl`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),p.code.add(o.glsl`
    if (segmentLengthPseudoScreen >= ${h?"patternLength":"1e4"}) {
  `),r.addPixelRatio(p),p.code.add(o.glsl`float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
float segmentLengthScreenRounded = flooredRepetitions * patternLength;
float stretch = repetitions / flooredRepetitions;
vStipplePatternStretch = max(0.75, stretch);
return vec2(0.0, segmentLengthScreenRounded);
}
return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
}`),m.uniforms.add(new a.Texture2DPassUniform("stipplePatternTexture",(e=>e.stippleTexture)),new n.FloatPassUniform("stipplePatternSDFNormalizer",(e=>{return(t=e.stipplePattern)?(Math.floor(.5*(l.computeLongestPattern(t)-1))+.5)/t.pixelRatio:1;var t})),new n.FloatPassUniform("stipplePatternPixelSizeInv",(e=>1/u(e)))),d.stippleOffColorEnabled&&m.uniforms.add(new i.Float4PassUniform("stippleOffColor",(e=>c.ensureColor4(e.stippleOffColor)))),m.code.add(o.glsl`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;
u = fract(u);
float encodedSDF = rgbaTofloat(texture(stipplePatternTexture, vec2(u, 0.5)));
float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha() {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),m.code.add(o.glsl`
    void discardByStippleAlpha(float stippleAlpha, float threshold) {
     ${o.If(!d.stippleOffColorEnabled,"if (stippleAlpha < threshold) { discard; }")}
    }

    vec4 blendStipple(vec4 color, float stippleAlpha) {
      return ${d.stippleOffColorEnabled?"mix(color, stippleOffColor, stippleAlpha)":"vec4(color.rgb, color.a * stippleAlpha)"};
    }
  `)},e.computePixelSize=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/stippleTextureRepository":function(){define(["exports","../../../../core/floatRGBA","./ProceduralTextureRepository","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n){"use strict";function o(e){return e.pattern.map((t=>Math.round(t*e.pixelRatio)))}function a(e){if(null==e)return 1;const t=o(e);return Math.floor(t.reduce(((e,t)=>e+t)))}function l(e){return o(e).reduce(((e,t)=>Math.max(e,t)))}e.computeLongestPattern=l,e.computeTextureSize=a,e.createStippleTextureRepository=function(e,c){return new r.ProceduralTextureRepository((r=>{const{encodedData:c,textureSize:u}=function(e){const r=o(e),i=1/e.pixelRatio,s=a(e),n=l(e),c=(Math.floor(.5*(n-1))+.5)*i,u=[];let d=1;for(const e of r){for(let t=0;t<e;t++){const r=d*(Math.min(t,e-1-t)+.5)*i/c*.5+.5;u.push(r)}d=-d}const h=Math.round(r[0]/2),p=[...u.slice(h),...u.slice(0,h)],m=new Uint8Array(4*s);let f=0;for(const e of p)t.packFloatRGBA(e,m,f),f+=4;return{encodedData:m,textureSize:s}}(r),d=new n.TextureDescriptor;return d.internalFormat=i.PixelFormat.RGBA,d.width=u,d.height=1,d.wrapMode=i.TextureWrapMode.REPEAT,new s.Texture(e,d,c)}),(e=>`${e.pattern.join(",")}-r${e.pixelRatio}`),c)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/ProceduralTextureRepository":function(){define(["exports","../../../../core/uid"],(function(e,t){"use strict";class r{constructor(e){this.texture=e,this.refCount=1}}e.ProceduralTextureRepository=class{constructor(e,r,i){this._createTexture=e,this._parametersKey=r,this._repository=new Map,this._orphanCache=i.newCache(`procedural-texture-repository:${t.generateUID()}`,(e=>e.dispose()))}destroy(){for(const{texture:e}of this._repository.values())e.dispose();this._repository.clear(),this._orphanCache.destroy()}swap(e,t=null){const r=this._acquire(e);return this.release(t),r}release(e){if(null==e)return;const t=this._parametersKey(e),r=this._repository.get(t);if(r&&(r.refCount--,0===r.refCount)){this._repository.delete(t);const{texture:e}=r;this._orphanCache.put(t,e)}}_acquire(e){if(null==e)return null;const t=this._parametersKey(e),i=this._repository.get(t);if(i)return i.refCount++,i.texture;const s=this._orphanCache.pop(t)??this._createTexture(e),n=new r(s);return this._repository.set(t,n),s}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/ensureColor4":function(){define(["exports","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64"],(function(e,t,r){"use strict";const i=r.create();e.ensureColor4=function(e){return null==e?r.ZEROS:4===e.length?e:t.set(i,e[0],e[1],e[2],1)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/MarkerSizing.glsl":function(){define(["exports","../../../../support/engineContent/marker","../util/View.glsl","../../shaderModules/FloatBindUniform","../../shaderModules/glsl","../../../shaders/LineMarkerTechniqueConfiguration"],(function(e,t,r,i,s,n){"use strict";e.MarkerSizing=function(e,o){const a=e.vertex;r.addPixelRatio(a),null==a.uniforms.get("markerScale")&&a.constants.add("markerScale","float",1),a.constants.add("markerSizePerLineWidth","float",t.markerSizePerLineWidth).code.add(s.glsl`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),o.space===n.LineMarkerSpace.World&&(a.constants.add("maxSegmentLengthFraction","float",.45),a.uniforms.add(new i.FloatBindUniform("perRenderPixelRatio",(e=>e.camera.perRenderPixelRatio))),a.code.add(s.glsl`bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}
float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}`))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/engineContent/marker":function(){define(["exports","./sdfPrimitives","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,r,i,s){"use strict";e.createMarkerTexture=function(e,n){const o=t.createPrimitive(e,64,32,6.4),a=new s.TextureDescriptor;return a.internalFormat=r.PixelFormat.RGBA,a.width=64,a.height=64,a.wrapMode=r.TextureWrapMode.CLAMP_TO_EDGE,new i.Texture(n,a,o)},e.markerSizePerLineWidth=10,e.markerSymbolSize=32,e.markerTextureSize=64,e.markerThickness=6.4,e.markerTipThicknessFactor=.25,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/engineContent/sdfPrimitives":function(){define(["exports","../../../../core/has","../../../../core/floatRGBA","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../webgl-engine/lib/Texture","../../../webgl/enums"],(function(e,t,r,i,s,n){"use strict";const o=.5,a=i.freeze(.25,.25,.75,.75);function l(e,t=128,r=t*o,i=0){return{data:c(e,t,r,i),parameters:{mipmap:!1,wrap:{s:n.TextureWrapMode.CLAMP_TO_EDGE,t:n.TextureWrapMode.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0,reloadable:!0}}}function c(e,t=128,r=t*o,i=0){switch(e){case"circle":default:return u(t,r);case"square":return d(t,r);case"cross":return p(t,r,i);case"x":return m(t,r,i);case"kite":return h(t,r);case"triangle":return f(t,r);case"arrow":return g(t,r)}}function u(e,t){const r=e/2-.5;return S(e,b(r,r,t/2))}function d(e,t){return y(e,t,!1)}function h(e,t){return y(e,t,!0)}function p(e,t,r=0){return _(e,t,!1,r)}function m(e,t,r=0){return _(e,t,!0,r)}function f(e,t){return S(e,v(e/2,t,t/2))}function g(e,t){const r=t,i=t/2,s=e/2,n=.8*r,o=b(s,(e-t)/2-n,Math.sqrt(n*n+i*i)),a=v(s,r,i);return S(e,((e,t)=>Math.max(a(e,t),-o(e,t))))}function y(e,t,r){return r&&(t/=Math.SQRT2),S(e,((i,s)=>{let n=i-.5*e+.25,o=.5*e-s-.75;if(r){const e=(n+o)/Math.SQRT2;o=(o-n)/Math.SQRT2,n=e}return Math.max(Math.abs(n),Math.abs(o))-.5*t}))}function _(e,t,r,i=0){t-=i,r&&(t*=Math.SQRT2);const s=.5*t;return S(e,((t,n)=>{let o,a=t-.5*e,l=.5*e-n-1;if(r){const e=(a+l)/Math.SQRT2;l=(l-a)/Math.SQRT2,a=e}return a=Math.abs(a),l=Math.abs(l),o=a>l?a>s?Math.sqrt((a-s)*(a-s)+l*l):l:l>s?Math.sqrt(a*a+(l-s)*(l-s)):a,o-=i/2,o}))}function b(e,t,r){return(i,s)=>{const n=i-e,o=s-t;return Math.sqrt(n*n+o*o)-r}}function v(e,t,r){const i=Math.sqrt(t*t+r*r);return(s,n)=>{const o=Math.abs(s-e)-r,a=n-e+t/2+.75,l=(t*o+r*a)/i,c=-a;return Math.max(l,c)}}function S(e,t){const i=new Uint8Array(4*e*e);for(let s=0;s<e;s++)for(let n=0;n<e;n++){const o=n+e*s;let a=t(n,s);a=a/e+.5,r.packFloatRGBA(a,i,4*o)}return i}e.createArrow=g,e.createCircle=u,e.createCross=p,e.createKite=h,e.createPrimitive=c,e.createSquare=d,e.createTexture=function(e,t=128,r=t*o,i=0){const{data:n,parameters:a}=l(e,t,r,i);return new s.Texture(n,a)},e.createTextureInfo=l,e.createTriangle=f,e.createX=m,e.defaultBoundingBox=a,e.defaultSymbolSizeRatio=o,e.defaultTexSize=128,e.requiresHalfTexelOffset=function(e){return"cross"===e||"x"===e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/RibbonLineTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../core/shaderLibrary/output/Emissions.glsl","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],(function(e,t,r,i,s,n){"use strict";var o;e.CapType=void 0,(o=e.CapType||(e.CapType={}))[o.BUTT=0]="BUTT",o[o.SQUARE=1]="SQUARE",o[o.ROUND=2]="ROUND",o[o.COUNT=3]="COUNT";class a extends n.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.capType=e.CapType.BUTT,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.occluder=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.wireframe=!1,this.discardInvisibleFragments=!1,this.objectAndLayerIdColorInstanced=!1,this.textureCoordinateType=r.TextureCoordinateType.None,this.emissionSource=i.EmissionSource.None,this.occlusionPass=!1,this.hasVvInstancing=!0,this.hasSliceTranslatedView=!0,this.overlayEnabled=!1,this.snowCover=!1}}t.__decorate([s.parameter({count:e.CapType.COUNT})],a.prototype,"capType",void 0),t.__decorate([s.parameter()],a.prototype,"hasPolygonOffset",void 0),t.__decorate([s.parameter()],a.prototype,"writeDepth",void 0),t.__decorate([s.parameter()],a.prototype,"draped",void 0),t.__decorate([s.parameter()],a.prototype,"stippleEnabled",void 0),t.__decorate([s.parameter()],a.prototype,"stippleOffColorEnabled",void 0),t.__decorate([s.parameter()],a.prototype,"stipplePreferContinuous",void 0),t.__decorate([s.parameter()],a.prototype,"roundJoins",void 0),t.__decorate([s.parameter()],a.prototype,"applyMarkerOffset",void 0),t.__decorate([s.parameter()],a.prototype,"vvSize",void 0),t.__decorate([s.parameter()],a.prototype,"vvColor",void 0),t.__decorate([s.parameter()],a.prototype,"vvOpacity",void 0),t.__decorate([s.parameter()],a.prototype,"falloffEnabled",void 0),t.__decorate([s.parameter()],a.prototype,"innerColorEnabled",void 0),t.__decorate([s.parameter()],a.prototype,"hasOccludees",void 0),t.__decorate([s.parameter()],a.prototype,"occluder",void 0),t.__decorate([s.parameter()],a.prototype,"terrainDepthTest",void 0),t.__decorate([s.parameter()],a.prototype,"cullAboveTerrain",void 0),t.__decorate([s.parameter()],a.prototype,"wireframe",void 0),t.__decorate([s.parameter()],a.prototype,"discardInvisibleFragments",void 0),t.__decorate([s.parameter()],a.prototype,"objectAndLayerIdColorInstanced",void 0),e.RibbonLineTechniqueConfiguration=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/RibbonLineTechnique":function(){define(["require","exports","../../../../core/has","../core/shaderLibrary/ShaderOutput","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/OITPass","../lib/OrderIndependentTransparency","../lib/RenderSlot","../lib/StencilUtils","../lib/VertexAttribute","../../../../chunks/RibbonLine.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class m extends n.ShaderTechnique{constructor(t,r){super(t,r,new s.ReloadableShaderModule(d.RibbonLine,(()=>new Promise(((t,r)=>e(["./RibbonLine.glsl"],t,r))))),g),this.primitiveType=r.wireframe?h.PrimitiveType.LINES:h.PrimitiveType.TRIANGLE_STRIP}_makePipelineState(e,t){const{oitPass:r,output:s,hasOccludees:l,hasPolygonOffset:u}=e,d=r===o.OITPass.NONE,h=r===o.OITPass.FrontFace;return p.makePipelineState({blending:i.isColorOrColorEmission(s)?a.blending(r):null,depthTest:{func:a.oitDepthTest(r)},depthWrite:a.depthWrite(e),drawBuffers:n.depthOnlyOutputBuffersOr(s,a.getDrawBuffers(r,s)),colorWrite:p.defaultColorWrite,stencilWrite:l?c.stencilWriteMaskOn:null,stencilTest:l?t?c.stencilToolMaskBaseParams:c.stencilBaseAllZerosParams:null,polygonOffset:d||h?u?f:null:a.OITPolygonOffset})}initializePipeline(e){if(e.occluder){const t=e.hasPolygonOffset?f:null,{output:r,hasOccludees:i}=e;this._occluderPipelineTransparent=p.makePipelineState({blending:p.unpremultipliedAlphaToPremultipliedAlpha,polygonOffset:t,depthTest:c.depthCompareAlways,depthWrite:null,colorWrite:p.defaultColorWrite,stencilWrite:null,stencilTest:i?c.stencilToolTransparentOccluderParams:null,drawBuffers:n.depthOnlyOutputBuffersOr(r)}),this._occluderPipelineOpaque=p.makePipelineState({blending:p.unpremultipliedAlphaToPremultipliedAlpha,polygonOffset:t,depthTest:i?c.depthCompareAlways:c.depthCompareLess,depthWrite:null,colorWrite:p.defaultColorWrite,stencilWrite:i?c.stencilWriteMaskOff:null,stencilTest:i?c.stencilToolMaskOccluderParams:null,drawBuffers:n.depthOnlyOutputBuffersOr(r)}),this._occluderPipelineMaskWrite=p.makePipelineState({blending:null,polygonOffset:t,depthTest:c.depthCompareLess,depthWrite:null,colorWrite:null,stencilWrite:i?c.stencilWriteMaskOn:null,stencilTest:i?c.stencilToolMaskBaseParams:null,drawBuffers:n.depthOnlyOutputBuffersOr(r)})}return this._occludeePipeline=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){if(e)return this._occludeePipeline;switch(t){case l.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL:return this._occluderPipelineTransparent??super.getPipeline();case l.RenderSlot.OCCLUDER_MATERIAL:return this._occluderPipelineOpaque??super.getPipeline();default:return this._occluderPipelineMaskWrite??super.getPipeline()}}}const f={factor:0,units:-4},g=new Map([[u.VertexAttribute.POSITION,0],[u.VertexAttribute.PREVIOUSDELTA,1],[u.VertexAttribute.NEXTDELTA,2],[u.VertexAttribute.U0,3],[u.VertexAttribute.LINEPARAMETERS,4],[u.VertexAttribute.COLOR,5],[u.VertexAttribute.COLORFEATUREATTRIBUTE,5],[u.VertexAttribute.SIZE,6],[u.VertexAttribute.SIZEFEATUREATTRIBUTE,6],[u.VertexAttribute.OPACITYFEATUREATTRIBUTE,7],[u.VertexAttribute.OLIDCOLOR,8]]);t.RibbonLineTechnique=m,t.vertexAttributeLocations=g,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/RenderContext":function(){define(["exports","../../../../core/time","../../webgl/RenderCamera","../core/shaderLibrary/ShaderOutput","./BindParameters","./Material"],(function(e,t,r,i,s,n){"use strict";const o=n.RenderOccludedFlag.Occlude|n.RenderOccludedFlag.OccludeAndTransparent|n.RenderOccludedFlag.OccludeAndTransparentStencil;e.RenderContext=class{constructor(e,n,a){this.rctx=e,this.techniques=a,this.lastFrameCamera=new r,this.output=i.ShaderOutput.Color,this.renderOccludedMask=o,this.time=t.Milliseconds(0),this.bind=new s.BindParameters(n),this.bind.alignPixelEnabled=!0}},e.defaultRenderOccludedMask=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/BindParameters":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../environment/CloudsParameters","../../webgl/RenderCamera","../core/shaderLibrary/hud/HUDRenderStyle","./OITPass","./RenderSlot","./Update","../lighting/SceneLighting"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";class u{constructor(){this.fadeFactor=1,this.reprojectionMatrix=t.create()}}e.BindParameters=class{constructor(e){this.shadowMap=e,this.slot=a.RenderSlot.OPAQUE_MATERIAL,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=o.OITPass.NONE,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new s,this._inverseViewport=r.create(),this._oldLighting=new c.SceneLighting,this._newLighting=new c.SceneLighting,this._fadedLighting=new c.SceneLighting,this._lighting=this._newLighting,this.ssr=new u,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=r.create(),this.highlightMixTexture=null,this.hudRenderStyle=n.HUDRenderStyle.Occluded,this.hudOccludedFragmentOpacity=1,this.snowCover=!1,this.clouds=new i.CloudsParameters,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,r,i){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=r,this._newLighting.set(e),i===l.Update.FadeWithWeather&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return null==this.highlightLevel?null:this.highlights[this.highlightLevel]}},e.ViewportSize=class{constructor(e,t){this.width=e,this.height=t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ShadowMap":function(){define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../ViewingMode","../core/FBOCacheFormats","./CascadeCamera","./textureUtils","./Util","../../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_){"use strict";var b;e.SnapshotSlot=void 0,(b=e.SnapshotSlot||(e.SnapshotSlot={}))[b.Highlight=0]="Highlight",b[b.ExcludeHighlight=1]="ExcludeHighlight";class v{constructor(){this.camera=new f.CascadeCamera,this.lightMat=o.create()}}class S{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}const w=o.create(),x=h.create(),T=[];for(let e=0;e<8;++e)T.push(h.create());const C=l.create(),P=l.create(),M=l.create(),R=l.create(),E=l.create(),O=u.create(),A=[],I=o.create(),D=o.IDENTITY.concat(o.IDENTITY,o.IDENTITY,o.IDENTITY,o.IDENTITY),F=l.create(),L=l.create(),N=[l.create(),l.create(),l.create(),l.create()],U=l.create(),V=l.create(),B=l.create(),G=l.create(),k=l.create(),z=l.create(),j=l.create();function q(e,t){return 3*t+e}const H=l.create();function W(e,t){return a.set(H,e[t],e[t+3]),H}const $=l.create(),Q=s.create();e.ShadowMap=class{constructor(e,r){this._fbos=e,this._viewingMode=r,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new S,this._projectionView=o.create(),this._projectionViewInverse=o.create(),this._modelViewLight=o.create(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=h.create(),this._cascades=[new v,new v,new v,new v],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(t("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(_.DepthStencilAttachment)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return d.set(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=i.releaseMaybe(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=r.clamp(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)A[e]=this._cascades[e];return A.length=this._numCascades,A}start(e,t,r,i,s){y.assert(this.enabled);const{near:n,far:o}=function(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}(r);this._computeCascadeDistances(n,o,i),this._textureHeight=this._computeTextureHeight(e,s,i),this._setupMatrices(e,t);const{viewMatrix:a,projectionMatrix:l}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,l,a,t);this._lastOrigin=null,this.clear()}finish(){y.assert(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!c.exactEquals(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||u.create(),c.copy(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){n.translate(I,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)D[16*t+e]=I[e]}}return D}moveSnapshot(t){y.assert(this.enabled),this._snapshots[t]?.release(),this._snapshots[t]=this._handle,this._handle?.setName(t===e.SnapshotSlot.Highlight?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(t){if(!this.enabled)return;const r=this._handle?.getTexture(_.DepthStencilAttachment)?.descriptor;if(!r)return;this._snapshots[t]?.release();const i=t===e.SnapshotSlot.Highlight?"shadow map highlight":"shadow map excluding highlight",s=this._acquireFBO(i);this._snapshots[t]=s;const n=this._handle?.fbo;if(!n||!s?.fbo)return void console.error("No FBO");const{rctx:o}=this._fbos;o.blitFramebuffer(n,s.fbo,_.FramebufferBit.DEPTH)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(_.DepthStencilAttachment):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(_.FramebufferBit.DEPTH)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:r},i,s){const n=Math.min(window.devicePixelRatio,i)/e,o=s?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return g.applyTextureResizeModulo(Math.max(t,r)*n*o,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){const t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,m.DepthFormat.DEPTH16);return t.getTexture(_.DepthStencilAttachment)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=i.releaseMaybe(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,i,s){const o=this._cascades[e],l=-this._cascadeDistances[e],u=-this._cascadeDistances[e+1],h=(t[10]*l+t[14])/Math.abs(t[11]*l+t[15]),p=(t[10]*u+t[14])/Math.abs(t[11]*u+t[15]);y.assert(h<p);for(let e=0;e<8;++e){d.set(x,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?h:p,1);const t=T[e];d.transformMat4(t,x,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}c.negate(O,T[0]),o.camera.viewMatrix=n.translate(w,this._modelViewLight,O);for(let e=0;e<8;++e)c.transformMat4(T[e],T[e],o.camera.viewMatrix);let m=T[0][2],f=T[0][2];for(let e=1;e<8;++e)m=Math.min(m,T[e][2]),f=Math.max(f,T[e][2]);m-=200,f+=200,o.camera.near=-f,o.camera.far=-m,function(e,t,i,s,n){const o=1/T[0][3],l=1/T[4][3];y.assert(o<l);let c=o+Math.sqrt(o*l);const u=Math.sin(r.acosClamped(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));c/=u,function(e,t,r,i,s,n,o,l){a.set(F,0,0);for(let t=0;t<4;++t)a.add(F,F,e[t]);a.scale(F,F,.25),a.set(L,0,0);for(let t=4;t<8;++t)a.add(L,L,e[t]);a.scale(L,L,.25),a.lerp(N[0],e[4],e[5],.5),a.lerp(N[1],e[5],e[6],.5),a.lerp(N[2],e[6],e[7],.5),a.lerp(N[3],e[7],e[4],.5);let c=0,u=a.squaredDistance(N[0],F);for(let e=1;e<4;++e){const t=a.squaredDistance(N[e],F);t<u&&(u=t,c=e)}a.subtract(U,N[c],e[c+4]);const d=U[0];let h,p;U[0]=-U[1],U[1]=d,a.subtract(V,L,F),a.dot(V,U)<0&&a.negate(U,U),a.lerp(U,U,V,r),a.normalize(U,U),h=p=a.dot(a.subtract(B,e[0],F),U);for(let t=1;t<8;++t){const r=a.dot(a.subtract(B,e[t],F),U);r<h?h=r:r>p&&(p=r)}a.copy(i,F),a.scale(B,U,h-t),a.add(i,i,B);let m=-1,f=1,g=0,_=0;for(let t=0;t<8;++t){a.subtract(G,e[t],i),a.normalize(G,G);const r=U[0]*G[1]-U[1]*G[0];r>0?r>m&&(m=r,g=t):r<f&&(f=r,_=t)}y.verify(m>0,"leftArea"),y.verify(f<0,"rightArea"),a.scale(k,U,h),a.add(k,k,F),a.scale(z,U,p),a.add(z,z,F),j[0]=-U[1],j[1]=U[0];const b=y.rayRay2D(i,e[_],z,a.add(B,z,j),1,s),v=y.rayRay2D(i,e[g],z,B,1,n),S=y.rayRay2D(i,e[g],k,a.add(B,k,j),1,o),w=y.rayRay2D(i,e[_],k,B,1,l);y.verify(b,"rayRay"),y.verify(v,"rayRay"),y.verify(S,"rayRay"),y.verify(w,"rayRay")}(T,c,u,C,P,M,R,E),function(e,t,r,i,s){a.subtract($,r,i),a.scale($,$,.5),Q[0]=$[0],Q[1]=$[1],Q[2]=0,Q[3]=$[1],Q[4]=-$[0],Q[5]=0,Q[6]=$[0]*$[0]+$[1]*$[1],Q[7]=$[0]*$[1]-$[1]*$[0],Q[8]=1,Q[q(0,2)]=-a.dot(W(Q,0),e),Q[q(1,2)]=-a.dot(W(Q,1),e);let n=a.dot(W(Q,0),r)+Q[q(0,2)],o=a.dot(W(Q,1),r)+Q[q(1,2)],l=a.dot(W(Q,0),i)+Q[q(0,2)],c=a.dot(W(Q,1),i)+Q[q(1,2)];n=-(n+l)/(o+c),Q[q(0,0)]+=Q[q(1,0)]*n,Q[q(0,1)]+=Q[q(1,1)]*n,Q[q(0,2)]+=Q[q(1,2)]*n,n=1/(a.dot(W(Q,0),r)+Q[q(0,2)]),o=1/(a.dot(W(Q,1),r)+Q[q(1,2)]),Q[q(0,0)]*=n,Q[q(0,1)]*=n,Q[q(0,2)]*=n,Q[q(1,0)]*=o,Q[q(1,1)]*=o,Q[q(1,2)]*=o,Q[q(2,0)]=Q[q(1,0)],Q[q(2,1)]=Q[q(1,1)],Q[q(2,2)]=Q[q(1,2)],Q[q(1,2)]+=1,n=a.dot(W(Q,1),t)+Q[q(1,2)],o=a.dot(W(Q,2),t)+Q[q(2,2)],l=a.dot(W(Q,1),r)+Q[q(1,2)],c=a.dot(W(Q,2),r)+Q[q(2,2)],n=-.5*(n/o+l/c),Q[q(1,0)]+=Q[q(2,0)]*n,Q[q(1,1)]+=Q[q(2,1)]*n,Q[q(1,2)]+=Q[q(2,2)]*n,n=a.dot(W(Q,1),t)+Q[q(1,2)],o=a.dot(W(Q,2),t)+Q[q(2,2)],l=-o/n,Q[q(1,0)]*=l,Q[q(1,1)]*=l,Q[q(1,2)]*=l,s[0]=Q[0],s[1]=Q[1],s[2]=0,s[3]=Q[2],s[4]=Q[3],s[5]=Q[4],s[6]=0,s[7]=Q[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=Q[6],s[13]=Q[7],s[14]=0,s[15]=Q[8]}(C,P,R,E,n.projectionMatrix),n.projectionMatrix[10]=2/(i-s),n.projectionMatrix[14]=-(i+s)/(i-s)}(i,s,m,f,o.camera),n.multiply(o.lightMat,o.camera.projectionMatrix,o.camera.viewMatrix);const g=this._textureHeight;o.camera.viewport=[e*g,0,g,g]}_setupMatrices(e,t){n.multiply(this._projectionView,e.projectionMatrix,e.viewMatrix),n.invert(this._projectionViewInverse,this._projectionView);const r=this._viewingMode===p.ViewingMode.Global?e.eye:c.set(O,0,0,1);n.lookAt(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_computeCascadeDistances(e,t,i){const s=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(y.logWithBase(t/e,4)),s);const n=(t-e)/this._numCascades,o=(t/e)**(1/this._numCascades);let a=e,l=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=r.lerp(a,l,this.settings.splitSchemeLambda),a*=o,l+=n}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/CascadeCamera":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../webgl/RenderCamera"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.CascadeCamera=class extends l{constructor(){super(...arguments),this._projectionMatrix=a.create()}get projectionMatrix(){return this._projectionMatrix}},t.__decorate([r.property()],e.CascadeCamera.prototype,"_projectionMatrix",void 0),t.__decorate([r.property({readOnly:!0})],e.CascadeCamera.prototype,"projectionMatrix",null),e.CascadeCamera=t.__decorate([o.subclass("esri.views.3d.webgl-engine.lib.CascadeCamera")],e.CascadeCamera),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextureTechnique":function(){define(["require","exports","../../../../chunks/TextureOnly.glsl","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.TextureOnly,(()=>new Promise(((t,r)=>e(["../core/shaderLibrary/util/TextureOnly.glsl"],t,r))))))}initializePipeline(e){return e.hasAlpha?n.makePipelineState({blending:n.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:n.defaultColorWrite}):n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.TextureTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextureTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.hasAlpha=!1}}t.__decorate([r.parameter()],i.prototype,"hasAlpha",void 0),e.TextureTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/OverlayCompositing.glsl":function(){define(["exports","../views/3d/terrain/interfaces","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends a.NoParameters{constructor(){super(...arguments),this.overlayIndex=t.OverlayIndex.INNER,this.opacity=1}}function u(){const e=new l.ShaderBuilder;return e.include(r.ScreenSpacePass),e.fragment.uniforms.add(new o.Texture2DPassUniform("tex",(e=>e.texture))),e.fragment.uniforms.add(new n.IntegerPassUniform("overlayIdx",(e=>e.overlayIndex))),e.fragment.uniforms.add(new i.FloatPassUniform("opacity",(e=>e.opacity))),e.fragment.main.add(s.glsl`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}const d=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:c,build:u},Symbol.toStringTag,{value:"Module"}));e.OverlayCompositing=d,e.OverlayCompositingPassParameters=c,e.build=u}))},"esri/views/3d/webgl-engine/shaders/OverlayCompositingTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../../chunks/OverlayCompositing.glsl"],(function(e,t,r,i,s){"use strict";class n extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.OverlayCompositing,(()=>new Promise(((t,r)=>e(["./OverlayCompositing.glsl"],t,r))))))}}t.OverlayCompositingTechnique=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/SortedRenderGeometryRenderer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/has","../../../../core/MapUtils","../../../../core/PooledArray","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../../../chunks/sphere","../../terrain/Intersector","../core/shaderLibrary/ShaderOutput","./ChangeSet","./IntersectorInterfaces","./IntersectorResult","./IntersectorType","./Material","./ModelDirtyTypes","./RendererBase","./RenderSlot","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S){"use strict";e.SortedRenderGeometryRenderer=class extends b.RendererBase{constructor(e){super(e),this._pending=new w,this._changes=new p.ChangeSet,this._sortedRenderers=new s,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlight(e){return i.someMap(this.renderers,(t=>t.hasHighlight(e)))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(const e of this.renderers.values())if(0!==e.numGeometries&&e.renderOccludedFlags&~y.RenderOccludedFlag.Occlude)return!0;return!1}get isEmpty(){return!this.updating&&0===this.renderers.size&&0===this._geometries.size}get sortedRenderers(){return this._sortedRenderers}commitChanges(){return!!this.updating&&(this._processAddsRemoves(),this.commit(this._changes,S.noBudget,this.rendererContext.pluginContext)&&(this._updateSortedMaterialRenderers(),this._hasHighlights=i.someMap(this.renderers,(e=>{const t=e.produces.get(v.RenderSlot.DRAPED_MATERIAL);return!!t&&t(h.ShaderOutput.Highlight)})),this._hasWater=i.someMap(this.renderers,(e=>{const t=e.produces.get(v.RenderSlot.DRAPED_WATER);return!!t&&t(h.ShaderOutput.Normal)}))),this.notifyChange("updating"),!0)}rendererAdded(){this._sortedRenderers.clear()}rendererRemoved(){this._sortedRenderers.clear()}addGeometries(e,t){if(0===e.length)return;const r=this._validateRenderGeometries(e);for(const e of r)this._geometries.set(e.id,e);const i=this._pending.empty;for(const e of r)this._pending.adds.add(e);i&&this.notifyChange("updating"),t===_.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const r=this._pending.empty,i=this._pending.adds;for(const t of e)i.has(t)?(this._pending.removed.add(t),i.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);r&&!this._pending.empty&&this.notifyChange("updating"),t===_.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const r=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._ensureValidRenderGeometry(r),e.updateType=t}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case _.DirtyState.TRANSFORMATION:case _.DirtyState.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case _.DirtyState.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll((r=>t=!!r.updateAnimation&&r.updateAnimation(e)||t)),t}precompile(e){return this._sortedRenderers.reduce(((t,r)=>r.precompile(e)||t),!1)}render(e){this._sortedRenderers.forAll((t=>{const r=t.acquireTechniques(e);r&&t.render(e,r)}))}intersect(e,t,r,i,s){for(const n of this._geometries.values()){if(!i(n))continue;this._intersectRenderGeometry(n,r,t,0,e,s);const o=this.rendererContext.longitudeCyclical;o&&(n.boundingSphere[0]-n.boundingSphere[3]<o.min&&this._intersectRenderGeometry(n,r,t,o.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>o.max&&this._intersectRenderGeometry(n,r,t,-o.range,e,s)),s++}return s}_updateSortedMaterialRenderers(){if(!(this._sortedRenderers.length>0)){for(const e of this.renderers.values())this._sortedRenderers.push(e);this._sortedRenderers.sort(((e,t)=>t.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-t.drapedPriority:(t.material?.renderPriority||0)-(e.material?.renderPriority||0)))}}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace((({renderGeometry:e})=>!this._pending.has(e))),this._pending.clear()}_intersectRenderGeometry(e,t,r,i,s,n){if(!e.visible||!e.material.visible||!e.material.intersectDraped)return;let o=0;i+=e.transformation[12],o=e.transformation[13],x[0]=r[0]-i,x[1]=r[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,s,x,((r,i,o)=>{!function(e,t,r,i,s,n,o){const a=new d.OverlayTarget(n,o,t),l=t=>{t.set(g.IntersectorType.OVERLAY,a,e.distance,e.normal,e.transformation,r,i)};if((null==s.results.min.drapedLayerOrder||r>=s.results.min.drapedLayerOrder)&&(null==s.results.min.distance||s.results.ground.distance<=s.results.min.distance)&&l(s.results.min),s.options.store!==m.StoreResults.MIN&&(null==s.results.max.drapedLayerOrder||r<s.results.max.drapedLayerOrder)&&(null==s.results.max.distance||s.results.ground.distance>s.results.max.distance)&&l(s.results.max),s.options.store===m.StoreResults.ALL){const e=new f.IntersectorResult(s.ray);l(e),s.results.all.push(e)}}(t,o,n,e.material.renderPriority,s,e.layerViewUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const{graphicUid:r}of e)null!=r&&r!==t&&(this.drapeSource.notifyGraphicGeometryChanged(r),t=r)}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const{graphicUid:r}of e)null!=r&&r!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(r),t=r)}_validateRenderGeometries(e){for(const t of e)this._ensureValidRenderGeometry(t);return e}_ensureValidRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin(u.getCenter(e.boundingSphere))),e}get test(){}},t.__decorate([n.property({constructOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"drapeSource",void 0),t.__decorate([n.property({constructOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"rendererContext",void 0),t.__decorate([n.property()],e.SortedRenderGeometryRenderer.prototype,"updating",null),t.__decorate([n.property()],e.SortedRenderGeometryRenderer.prototype,"rctx",null),t.__decorate([n.property()],e.SortedRenderGeometryRenderer.prototype,"_localOriginFactory",null),t.__decorate([n.property({readOnly:!0})],e.SortedRenderGeometryRenderer.prototype,"isEmpty",null),t.__decorate([n.property()],e.SortedRenderGeometryRenderer.prototype,"_geometries",void 0),e.SortedRenderGeometryRenderer=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],e.SortedRenderGeometryRenderer);class w{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const x=c.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ModelDirtyTypes":function(){define(["exports"],(function(e){"use strict";var t,r;e.DirtyOperation=void 0,(t=e.DirtyOperation||(e.DirtyOperation={}))[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE",e.DirtyState=void 0,(r=e.DirtyState||(e.DirtyState={}))[r.NONE=0]="NONE",r[r.VISIBILITY=1]="VISIBILITY",r[r.GEOMETRY=2]="GEOMETRY",r[r.TRANSFORMATION=4]="TRANSFORMATION",r[r.HIGHLIGHT=8]="HIGHLIGHT",r[r.OCCLUDEE=16]="OCCLUDEE",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/RendererBase":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./rendererUtils","../materials/renderers/MergedRenderer"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.RendererBase=class extends r{constructor(e){super(e),this._renderers=new Map}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear()}initialize(){this.addHandles(i.watch((()=>this.stage.view.state.highlights),(()=>this.updateHighlights())))}getMaterialRenderer(e){return this._renderers.get(e)}updateHighlights(){this._renderers.forEach((e=>e.updateHighlights(this.stage.view.state.highlightOrderMap)))}commit(e,t,r){const{adds:i,removes:s,updates:n}=e;if(0===i.length&&0===s.length&&0===n.length)return!1;c.splitRenderGeometryChangeSetByMaterial(e).forEach(((e,i)=>{if(t.done)return;let s=this._renderers.get(i);null==s&&e.adds.length>0&&(s=new u.MergedRenderer({material:i,highlightOrderMap:this.stage.view.state.highlightOrderMap}),s.initializeRenderContext(r),this.rendererAdded(s),this._renderers.set(i,s)),s?(s.modify(e,t),s.updateHighlights(this.stage.view.state.highlightOrderMap),0===s.numGeometries&&(this._renderers.delete(s.material),this.rendererRemoved(s),s.destroy())):(e.clear(),t.madeProgress())}));let o=0;for(const e of this._renderers.values())e.drapedPriority=o++;return!0}get canCompact(){for(const e of this._renderers.values())if(e.canCompact)return!0;return!1}compact(e){let t=!1;for(const r of this._renderers.values()){if(e.done)return t;t=r.compact(e)||t}return t}get renderers(){return this._renderers}},t.__decorate([s.property({constructOnly:!0})],e.RendererBase.prototype,"stage",void 0),e.RendererBase=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.RendererBase")],e.RendererBase),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/renderers/MergedRenderer":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/arrayUtils","../../../../../core/has","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/NestedMap","../../../../../core/PooledArray","../../../../../core/SetUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/Logger","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../support/buffer/glUtil","../../core/shaderLibrary/ShaderOutput","../../effects/RenderPlugin","../../lib/GLMaterials","../../lib/ModelDirtyTypes","../../lib/RenderSlot","../../lib/Util","../DrawParameters","./BufferRange","./Instance","./PerBufferData","./PerOriginData","../../../../support/HighlightDefaults"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P){"use strict";e.MergedRenderer=class extends g.SyncRenderPlugin{get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(e){return this._highlightNames.has(e)}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new S.DrawParameters,this._highlightNames=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=n.disposeMaybe(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this._updateProduces()}_updateProduces(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==f.ShaderOutput.Highlight&&t!==f.ShaderOutput.ShadowHighlight||this._hasHighlights))&&e(t)))}))}initializeRenderContext(e){k??=e.renderContext.rctx.isAssumedMetalDriver,this._glMaterials=new y.GLMaterials(this.material,e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,m.glLayout(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}get renderOccludedFlags(){return this.material.renderOccludedFlags}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.cachedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((({geometry:t})=>e(t)))))))}modify(e,t){this._applyUpdates(e,t),this._applyAddsAndRemoves(e),this._updateDrawCommands()}get canCompact(){for(const e of this._dataByOrigin.values())if(e.buffers.some((e=>e.holes.length>1)))return!0;return!1}compact(e){if(!this.canCompact)return!1;let t=!1;for(const r of this._dataByOrigin.values()){const i=new Array;for(let t=0;t<r.buffers.length&&!e.done;){const s=r.buffers[t];s.holes.length<=1?++t:(s.instances.forEach((({geometry:e})=>i.push(e))),this._vaoCache.deleteVao(s.vao),r.buffers[t]=r.buffers[r.buffers.length-1],--r.buffers.length,e.madeProgress())}if(i.length>0){for(r.buffers.forEach((e=>this._applyAdds(e,i)));i.length>0;)r.buffers.push(this._applyAndRebuild(new T.PerBufferData,i,null));t=!0}}return t}updateHighlights(e){this.highlightOrderMap=e,this._highlightNames.clear(),this._dataByOrigin.forEach((t=>{t.buffers.forEach((t=>{t.updateHighlights(e),t.highlightNames.forEach((e=>this._highlightNames.add(e)))}))})),this._updateProduces()}_applyUpdates(e,t){const r=this._bufferWriter;if(null==r)return void e.clearUpdates();const i=r.vertexBufferLayout.stride/4;for(const s of e.updates){if(t.done)return;const{renderGeometry:n,updateType:o}=s;e.pending.updates.removeUnordered(s),t.madeProgress();const a=this._dataByOrigin.get(n.localOrigin.id),l=a?.findBuffer(n.id);if(null==l)return;const c=l.instances.get(n.id);if(o&(_.DirtyState.GEOMETRY|_.DirtyState.TRANSFORMATION)){const e=V(r.elementCount(c.geometry.geometry.attributes)*i),t=r.vertexBufferLayout.createView(e.buffer);this._writeGeometry(n,t,0),l.vao.vertexBuffers.get("geometry").setSubData(e,c.from*i,0,c.numElements*i)}o&(_.DirtyState.HIGHLIGHT|_.DirtyState.OCCLUDEE|_.DirtyState.VISIBILITY)&&(l.drawCommandsDirty=!0)}}_computeDeltas(e,t){const r=new o.NestedMap;for(const t of e){const e=t.localOrigin;if(null==e)continue;let i=r.get(e.id,null);null==i&&(i=new M(e.vec3),r.set(e.id,null,i)),i.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const i=this._dataByOrigin.get(t.id),s=i?.findBuffer(e.id);if(null==s)continue;let n=r.get(t.id,s);null==n&&(n=new M(t.vec3),r.set(t.id,s,n)),n.changes.push(e)}return r}_applyAddsAndRemoves(e){const{_bufferWriter:t,_dataByOrigin:i,_vaoCache:s}=this;if(null==t||null==s)return void e.clearAddsAndRemoves();const n=t.vertexBufferLayout.stride/4,o=this._computeDeltas(e.adds,e.removes);o.forEach(((e,a)=>{const l=e.get(null),c=l?.changes??[];o.delete(a,null);let u=i.get(a);if(e.forEach(((e,l)=>{if(o.delete(a,l),null==l&&v.assert(!1,"No VAO for removed geometries"),l.instances.size===e.changes.length)return s.deleteVao(l.vao),r.removeUnordered(u.buffers,l),void(0===u.buffers.length&&0===c.length&&i.delete(a));const d=l.numElements,h=l.vao.getByteLength("geometry")/4,p=c.reduce(((e,r)=>e+t.elementCount(r.geometry.attributes)),0),m=e.changes.reduce(((e,r)=>e+t.elementCount(r.geometry.attributes)),0),f=Math.min((d+p-m)*n,N),g=f>h;f>I&&f<h/2?(e.changes.forEach((({id:e})=>l.deleteInstance(e))),l.instances.forEach((({geometry:e})=>c.push(e))),this._vaoCache.deleteVao(l.vao),r.removeUnordered(u.buffers,l)):g?this._applyAndRebuild(l,c,e):this._applyRemoves(l,e)})),c.length>0)for(null==u&&(u=new C.PerOriginData(l.origin),i.set(a,u)),u.buffers.forEach((e=>this._applyAdds(e,c)));c.length>0;)u.buffers.push(this._applyAndRebuild(new T.PerBufferData,c,null))})),e.clearAddsAndRemoves()}_updateDrawCommands(){this._highlightNames.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.updateIfDrawCommandsDirty(this.highlightOrderMap,this._bufferWriter.vertexBufferLayout.stride),e.hasHighlights&&l.addMany(this._highlightNames,e.highlightNames),this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,r){if(r)for(const t of r.changes)e.deleteInstance(t.id);const i=this._bufferWriter,s=i.vertexBufferLayout.stride,n=s/4,o=Math.floor(N/n);let a=e.numElements;for(;t.length>0;){const r=t.pop(),s=i.elementCount(r.geometry.attributes);if(a+s>o&&a>0){t.push(r);break}a+=s;const n=new x.Instance(r,0,0,this.highlightOrderMap);v.assert(null==e.instances.get(r.id)),e.addInstance(r.id,n)}const l=a*n,c=V(l),u=i.vertexBufferLayout.createView(c.buffer);let d=0;e.resetInstanceSummary(),e.instances.forEach(((t,r)=>{this._writeGeometry(t.geometry,u,d);const s=d;d+=i.elementCount(t.geometry.geometry.attributes),e.updateInstance(r,s,d),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(B(l)),e.vao.vertexBuffers.get("geometry").setSubData(c,0,0,d*n),e.holes.clear();const h=e.holes.pushNew();return h.from=d,h.to=Math.floor(e.vao.getByteLength("geometry")/s),e.updateDrawCommands(this.highlightOrderMap,s),e}_applyRemoves(e,t){if(0===t.changes.length||null==this._bufferWriter)return;let r=1/0,i=-1/0;for(const s of t.changes){const t=s.id,n=e.instances.get(t);if(!n)continue;e.deleteInstance(t),k&&(r=Math.min(r,n.from),i=Math.max(i,n.to));const o=A.back();if(o){if(o.to===n.from){o.to=n.to;continue}if(o.from===n.to){o.from=n.from;continue}}const a=A.pushNew();a.from=n.from,a.to=n.to}w.mergeAdjacentRanges(A);const s=this._bufferWriter.vertexBufferLayout.stride/4,n=e.vao.vertexBuffers.get("geometry");if(k){const t=(i-r)*s,o=V(t),a=this._bufferWriter.vertexBufferLayout.createView(o.buffer);o.fill(0,0,t),e.instances.forEach((e=>{if(!(e.from>=r&&e.to<=i))return;const t=e.from-r;this._writeGeometry(e.geometry,a,t)})),n.setSubData(o,r*s,0,t)}else{const e=A.reduce(((e,t)=>Math.max(e,t.numElements)),0)*s,t=V(e);t.fill(0,0,e),A.forAll((e=>n.setSubData(t,e.from*s,0,e.numElements*s)))}e.holes.pushArray(A.data,A.length),A.forAll(((e,t)=>A.data[t]=null)),A.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null==this._bufferWriter)return;if(!T.hasVao(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,s=i.vertexBufferLayout.stride/4,n=e.numElements,o=t.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),a=Math.min((n+o)*s,N),l=4*a;if(e.vao.getByteLength("geometry")<B(N-I)&&l>e.vao.getByteLength("geometry"))return void this._applyAndRebuild(e,t,null);w.mergeAdjacentRanges(e.holes);const c=new Array;let u=1/0,d=-1/0;for(const r of t){const t=i.elementCount(r.geometry.attributes),s=R(e.holes,t);c.push(s),k&&null!=s&&(u=Math.min(s,u),d=Math.max(s+t,d))}const h=e.vao.vertexBuffers.get("geometry");let p=0,m=0,f=0;const g=V(k?(d-u)*s:a),y=i.vertexBufferLayout.createView(g.buffer);if(t.forEach(((t,r)=>{const n=c[r];if(null==n)return;const o=i.elementCount(t.geometry.attributes);if(!k){if(f!==n){const e=f-m;e>0&&h.setSubData(g,m*s,0,e*s),m=n,p=0}this._writeGeometry(t,y,p),p+=o,f=n+o}const a=new x.Instance(t,n,n+o,this.highlightOrderMap);v.assert(null==e.instances.get(t.id)),e.addInstance(t.id,a),e.drawCommandsDirty=!0})),k){const t=(d-u)*s;g.fill(0,0,t),e.instances.forEach((e=>{if(!(e.from>=u&&e.to<=d))return;const t=e.from-u;this._writeGeometry(e.geometry,y,t)})),m=u,f=d}const _=f-m;_>0&&h.setSubData(g,m*s,0,_*s),r.filterInPlace(t,((e,t)=>null==c[t]))}_writeGeometry(e,t,r){null!=this._bufferWriter&&(h.copy(E,e.transformation),E[12]-=e.localOrigin.vec3[0],E[13]-=e.localOrigin.vec3[1],E[14]-=e.localOrigin.vec3[2],h.invert(O,E),h.transpose(O,O),this._bufferWriter.write(E,O,e.geometry.attributes,e.geometry.objectAndLayerIdColor,t,r))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:r}=e,i=this.material.produces.get(r.slot);if(!i?.(t))return null;const{highlight:s,slot:n}=r,o=t===f.ShaderOutput.ShadowHighlight,a=t===f.ShaderOutput.Highlight,l=a||o,c=s?.name;if(l&&(0===this._highlightNames.size||a&&c&&!this._highlightNames.has(c)))return null;const u=t===f.ShaderOutput.ShadowExcludeHighlight,d=!(l||u);for(const{buffers:i}of this._dataByOrigin.values())for(const s of i){if(h=s.highlightNames,a&&c&&!h.has(c))continue;const i=o?s.drawCommandsHighlights.get(P.defaultHighlightName):l?c?s.drawCommandsHighlights.get(c):s.drawCommandsHighlights.size>0:((u&&s.needsMultipleCommands()?s.drawCommandsShadowHighlightRest:s.drawCommandsDefault)||null)?.length??!1,p=d&&s.drawCommandsOccludees||null;if(i||p?.length){const i=this._glMaterials.load(e.rctx,n,t),s=i?.beginSlot(r);if(s)return s}}var h;return null}render(e,t){const{output:r,bind:i}=e,{slot:s,highlight:n}=i,o=r===f.ShaderOutput.Highlight,l=n?.name??"";if(o&&!n)return;const c=r===f.ShaderOutput.ShadowHighlight,u=o||c,d=r===f.ShaderOutput.ShadowExcludeHighlight,h=!(u||d),p=s===b.RenderSlot.OCCLUDER_MATERIAL||s===b.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL?s:null,{rctx:m}=e;m.runAppleAmdDriverHelper();const g=m.bindTechnique(t,i,this.material.parameters);for(const e of this._dataByOrigin.values())for(const r of e.buffers){if(o&&(!r.hasHighlights||!r.drawCommandsHighlights.has(l)))continue;if(c&&(!r.hasHighlights||!r.drawCommandsHighlights.has(P.defaultHighlightName)))continue;const s=()=>{const e=[],t=r.drawCommandsHighlights.get(P.defaultHighlightName)??new a;return t&&e.push(t),e},n=u&&!c?r.drawCommandsHighlights.get(l)??null:null,f=c?s():u?n?[n]:G:d&&r.needsMultipleCommands()?[r.drawCommandsShadowHighlightRest]:[r.drawCommandsDefault],y=f.some((e=>e.length>0)),_=h&&r.drawCommandsOccludees||null;if(y||_?.length){if(this._drawParameters.origin=e.origin,g.bindDraw(i,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(r.vao),m.bindVAO(r.vao),y)for(const e of f)m.setPipelineState(t.getPipeline(!1,p)),e.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count)));_?.length&&(m.setPipelineState(t.getPipeline(!0,p)),_.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count))))}}}static prune(){U=new Float32Array(I)}get test(){}},t.__decorate([c.property({constructOnly:!0})],e.MergedRenderer.prototype,"material",void 0),t.__decorate([c.property({})],e.MergedRenderer.prototype,"highlightOrderMap",void 0),e.MergedRenderer=t.__decorate([d.subclass("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],e.MergedRenderer);class M{constructor(e){this.origin=e,this.changes=new Array}}function R(e,t){const r=e.find((e=>e.numElements>=t));if(null==r)return null;const i=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),i}const E=p.create(),O=p.create(),A=new a({allocator:e=>e||new w.BufferRange,deallocator:null}),I=65536,D=4*I,F=1024,L=16777216,N=L/4;let U=new Float32Array(I);function V(e){return U.length<e&&(U=new Float32Array(e)),U}function B(e){const t=4*e;return t<=F?F:t<D?s.nextHighestPowerOfTwo(t):Math.max(Math.min(Math.ceil(1.5*t/D)*D,L),t)}const G=[];let k;e.sizeForVao=B,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/GLMaterials":function(){define(["exports","./basicInterfaces"],(function(e,t){"use strict";e.GLMaterials=class{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,r,i){const s=this._material.produces.get(r);if(!s?.(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,r,i));const n=this._map.get(i);if(n){if(n.ensureResources(e)===t.ResourceState.LOADED)return n;this._repository.requestRender()}return null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/DrawParameters":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec3f64","../core/shaderLibrary/attributes/VertexNormal.glsl"],(function(e,t,r){"use strict";class i extends r.VertexNormalDrawParameters{constructor(e=t.create()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}}e.DrawParameters=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/renderers/BufferRange":function(){define(["exports"],(function(e){"use strict";e.BufferRange=class{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}},e.mergeAdjacentRanges=function(e){if(e.length<2)return;const t=new Map;e.forAll((e=>t.set(e.from,e)));let r=!0;for(;r;){r=!1;for(let i=0;i<e.length;++i){const s=e.data[i],n=t.get(s.to);n&&(s.to=n.to,t.delete(n.from),e.removeUnordered(n),r=!0)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/renderers/Instance":function(){define(["exports","./BufferRange"],(function(e,t){"use strict";class r extends t.BufferRange{constructor(e,t,r,i){super(t,r),this.geometry=e,this._highlightName=null,this.updateHighlightOptions(i)}updateHighlightOptions(e){const{geometry:t}=this;if(!t.hasHighlights)return void(this._highlightName=null);let r=-1,i=null;t.foreachHighlightOptions((t=>{const s=e.get(t)??-1;s>r&&(r=s,i=t)})),this._highlightName=i}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return null!=this.geometry.occludees}}e.Instance=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/renderers/PerBufferData":function(){define(["exports","../../../../../core/MapUtils","../../../../../core/PooledArray","./BufferRange","./DrawCommand","../../../../support/HighlightDefaults"],(function(e,t,r,i,s,n){"use strict";class o{constructor(){this._numElements=0,this._instances=new Map,this.holes=new r({allocator:e=>e||new i.BufferRange,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=a(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=a(),this.drawCommandsShadowHighlightRest=a()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(e,t){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const e of this.instances.values())this.updateDrawState(e);this.updateDrawCommands(e,t)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,r){const i=this._instances.get(e);i&&(this._numElements-=i.numElements,i.from=t,i.to=r,this._numElements+=i.numElements)}updateDrawState(e){if(e.isVisible){const{highlightName:t}=e;t&&this.highlightNames.add(t),e.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(e,t){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;const{sortedInstances:r}=this;if(this._updateHighlightDrawCommands(e,r),!this.needsMultipleCommands()){const e=this.drawCommandsDefault.pushNew(),r=this.holes.front();return this.vao&&1===this.holes.length&&r.to===Math.floor(this.vao.getByteLength("geometry")/t)?(e.first=0,void(e.count=r.from)):(e.first=1/0,e.count=0,this._instances.forEach((t=>{e.first=Math.min(e.first,t.from),e.count=Math.max(e.count,t.to)})),void(e.count-=e.first))}for(const e of r)e.isVisible&&l(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e)}get sortedInstances(){return Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from))}updateHighlights(e){this.highlightNames.clear();const t=this.sortedInstances;for(const r of t)r.updateHighlightOptions(e),r.isVisible&&r.highlightName&&this.highlightNames.add(r.highlightName);this._updateHighlightDrawCommands(e)}_updateHighlightDrawCommands(e,r=this.sortedInstances){const{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:s}=this;i.clear(),s.clear();for(const o of r){if(o.updateHighlightOptions(e),!o.isVisible)continue;const{highlightName:r}=o;r&&(this.highlightNames.add(r),l(t.getOrCreateMapValue(i,r,a),o)),r&&r===n.defaultHighlightName||l(s,o)}}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function a(){return new r({allocator:e=>e||new s.DrawCommand,deallocator:e=>e})}function l(e,t){const r=e.back();if(null==r){const r=e.pushNew();return r.first=t.from,void(r.count=t.numElements)}if(s=t,(i=r).first+i.count>=s.from){const e=t.from-r.first+t.numElements;r.count=e}else{const r=e.pushNew();r.first=t.from,r.count=t.numElements}var i,s}e.PerBufferData=o,e.PerVaoData=class extends o{},e.hasVao=function(e){return null!=e.vao},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/renderers/DrawCommand":function(){define(["exports"],(function(e){"use strict";e.DrawCommand=class{constructor(){this.first=0,this.count=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/renderers/PerOriginData":function(){define(["exports"],(function(e){"use strict";e.PerOriginData=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/parts/renderUtils":function(){define(["exports"],(function(e){"use strict";e.RenderSceneResult=class{constructor(e,t){this.screen=e,this.olid=t}},e.removeLoadedShaderModules=function(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const r of t)r.includes(".glsl")&&delete e[r]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/PlanarPatch":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/SpatialReference","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/spatialReferenceUtils","./PatchGeometryFactory","./Tile","./TileFrustumVisibility","../webgl-engine/lib/RayIntersections"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d extends l.Tile{constructor(e,t,r,i,s){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=n.create(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,r,i,s)}init(e,s,n,a,l){super.init(e,s,n,a,l);const c=l.view.renderSpatialReference,u=l.spatialReference,d=null!=c&&o.isPlateCarree(c)&&null!=u&&u.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=d;const{isWebMercatorOnPlateCarree:h}=l,p=this._extentInRenderSR,m=this.extent;if(h){const e=t.fromValues(m[0],m[1],0);i.projectVectorToVector(e,r.WebMercator,e,r.PlateCarree);const s=t.fromValues(m[2],m[3],0);i.projectVectorToVector(s,r.WebMercator,s,r.PlateCarree),p[0]=e[0],p[1]=e[1],p[2]=s[0],p[3]=s[1]}else for(let e=0;e<4;++e)p[e]=m[e]*d;this.centerAtSeaLevel[0]=.5*(p[0]+p[2]),this.centerAtSeaLevel[1]=.5*(p[1]+p[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(p[2]-p[0],p[3]-p[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),r=.5*(e[3]-e[1]),i=Math.sqrt(t*t+r*r),s=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(i,s);this._center[l.CenterPosition.MIDDLE][3]=n}_calculateFrustumVisibility(e){const t=this._aabb(),r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5];let l=!0;for(let t=0;t<6;t++){const u=e[t],d=u[0],h=u[1],p=u[2],m=u[3];if(d*(d>0?r:n)+h*(h>0?i:o)+p*(p>0?s:a)+m>=0)return c.TileFrustumVisibility.OUTSIDE;l=l&&d*(d<0?r:n)+h*(h<0?i:o)+p*(p<0?s:a)+m<=0}return l?c.TileFrustumVisibility.INSIDE:c.TileFrustumVisibility.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return s.wrap(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,r,i){return h[0]=1/t[0],h[1]=1/t[1],h[2]=1/t[2],u.intersectAabbInvDirBefore(this._aabb(),e,h,r,i)}createGeometry(){a.createPlanarGlobePatch(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,r=this.renderData;let i=e,s=t;if(r){const e=r.geometry.boundingBox;i=e[2],s=e[5]}else if(!this.leaf){i=1/0,s=-1/0;for(const e of this.children){const t=e;i=Math.min(i,t._subtreeGeometryElevationBoundMin),s=Math.max(s,t._subtreeGeometryElevationBoundMax)}}if(i!==this._subtreeGeometryElevationBoundMin||s!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=i,this._subtreeGeometryElevationBoundMax=s;const e=this.parent;e?._updateSubtreeGeometryElevationsBounds()}}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){a.updateCornersPlanar(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){a.updateEdgesAndCornersPlanar(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){a.updateEdgeElevationsAndResolutionsPlanar(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}}const h=t.create();e.PlanarPatch=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/PatchGeometryFactory":function(){define(["exports","../../../core/mathUtils","../../../core/typedArrayUtil","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","./ElevationData","./interfaces","./NeighborIndex","./PatchGeometryLUT","./PatchRenderData","./terrainUtils","./Tile","./tileUtils","../webgl-engine/lib/Normals"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";function m(e){e.tile.intersectsClippingArea&&(g(e),f(e))}function f(e,i=!1){const{geometry:s,geometryState:o,tile:a,localOrigin:l}=e,{level:d,extent:p,extentInRadians:m,ellipsoid:f}=a,g=f.radius,y=m[0],b=m[2],v=m[1],S=m[3],{samplerData:w}=o,x=p[0],T=p[2],C=p[1],P=p[3],M=_(e),{boundingBox:E,vertexAttributes:O}=s,A=l[0],I=l[1],D=l[2],{position:F,uv0:L}=O,N=F.typedBuffer,U=F.typedBufferStride;for(let l=0;l<4;++l){const m=1===l||3===l,f=o.edgeResolutions[l];u.internalAssert(t.isPowerOfTwo(f));const _=f+1,O=c.neighborTileIfLoadedOrSelf(a,o.edgePeerNeighbors[l]);if(V(a,O,l)){R(e,l,O);continue}const F=null!=O;u.internalAssert(!F||O.level===a.level),u.internalAssert(!F||h.compareTilesByLij(a,O)<=0);const B=O?.renderData,G=B?.geometryState;if(u.enableTerrainInternalChecks){const e=a.surface;if(!O&&e&&!e.updatingRootTiles){const t=u.neighborEdgeIndices[l],r=a.findNeighborTile(t,(e=>e.loaded||e.leaf||e.level===a.level));r?r.intersectsClippingArea&&(u.internalAssert(!r.loaded),u.internalAssert(!r.leaf),u.internalAssert(r.level===d)):u.internalAssert(null==e?.rootTiles||!a.shouldHaveNeighbor(t))}}const z=1===l?p[2]:p[0],j=O?.extent,q=j&&m?1===l?j[0]:j[2]:z,H=0===l?p[3]:p[1],W=1===l?1:0,$=0===l?1:0,Q=1===l?b:y,Z=0===l?S:v,Y=Math.sin(Q),X=Math.cos(Q),K=Math.sin(Z),J=Math.cos(Z),ee=G?.samplerData,te=F?(e,t,r)=>.5*(n.sampleElevation(e,t,w)+n.sampleElevation(r,t,ee)):(e,t,r)=>n.sampleElevation(e,t,w),re=s.outerEdgesOffsetAndLength[2*l+0],ie=i&&_>3?_-3:1,se=null!=w&&w.some((e=>null!=e)),ne=null!=ee&&ee.some((e=>null!=e)),oe=se||ne,ae=1/f,le=re;u.internalAssert(!j||u.almostEquals(j[2]-j[0],p[2]-p[0])),(()=>{const e=1===l?-1:3===l?1:0,t=0===l?-1:2===l?1:0,i=(p[2]-p[0])*ae,o=e*i,a=t*i,c=m?e*((b-y)*ae):0,u=m?0:t*ae,d=$,h=m?Q+c:Q,f=m?Math.sin(h):Y,v=m?Math.cos(h):X,S=m?Q-c:Q,R=m?Math.sin(S):Y,O=m?Math.cos(S):X,V=m?Z:M(d+u),B=m?K:Math.sin(V),G=m?J:Math.cos(V),j=m?Z:M(d-u),re=m?K:Math.sin(j),se=m?J:Math.cos(j);let ne=0,ce=0,ue=0;{const e=0*ae,t=m?z:x*(1-e)+T*e,r=m?q:t,i=m?C*(1-e)+P*e:H,s=m?Q:y*(1-e)+b*e,n=m?Y:Math.sin(s),o=m?X:Math.cos(s),a=m?M(e):Z,l=m?Math.sin(a):K,c=m?Math.cos(a):J,u=g+te(t,i,r);ne=o*c*u,ce=n*c*u,ue=l*u}let de=0,he=0,pe=0;{const e=1*ae,t=m?z:x*(1-e)+T*e,r=m?q:t,i=m?C*(1-e)+P*e:H,s=m?Q:y*(1-e)+b*e,n=m?Y:Math.sin(s),o=m?X:Math.cos(s),a=m?M(e):Z,l=m?Math.sin(a):K,c=m?Math.cos(a):J,u=g+te(t,i,r);de=o*c*u,he=n*c*u,pe=l*u}for(let e=1;e<_-1;e+=ie){let t=0,i=0,c=0;{const r=(e+1)*ae,s=m?z:x*(1-r)+T*r,n=m?q:s,o=m?C*(1-r)+P*r:H,a=m?Q:y*(1-r)+b*r,l=m?Y:Math.sin(a),u=m?X:Math.cos(a),d=m?M(r):Z,h=m?Math.sin(d):K,p=m?Math.cos(d):J,f=g+te(s,o,n);t=u*p*f,i=l*p*f,c=h*f}const u=t,d=i,h=c,p=de,_=he,S=pe;de=u,he=d,pe=h;{const t=le+e,i=t*U,s=p-A,n=_-I,o=S-D;N[i]=s,N[i+1]=n,N[i+2]=o,k(s,n,o,E);const a=e*ae,l=m?W:a,c=m?a:$;L.setValues(t,Math.round(l*r.maxUint16),Math.round(c*r.maxUint16))}const V=ne,j=ce,ie=ue;ne=p,ce=_,ue=S;const me=p,fe=_,ge=S,ye=1/Math.sqrt(me*me+fe*fe+ge*ge),_e=ge*ye;let be=0,ve=0,Se=0;if(oe&&_e*_e<.999){let t=0,r=0,i=0;{const e=0===l?-1:1;t=e*(u-V),r=e*(d-j),i=e*(h-ie)}{const s=e*ae,c=m?z:x*(1-s)+T*s,u=m?q:c,d=m?C*(1-s)+P*s:H,h=m?Q:y*(1-s)+b*s,p=m?Y:Math.sin(h),_=m?X:Math.cos(h),S=m?M(s):Z,E=m?Math.sin(S):K,A=m?Math.cos(S):J;let I=me,D=fe,L=ge;if(F){const e=u-o,t=d-a,r=g+n.sampleElevation(e,t,ee),i=m?A:se;I=(m?O:_)*i*r,D=(m?R:p)*i*r,L=(m?E:re)*r}{const e=c+o,s=d+a,u=g+n.sampleElevation(e,s,w),h=m?A:G,y=(m?v:_)*h*u,b=(m?f:p)*h*u,S=(m?E:B)*u;F||(I=2*me-y,D=2*fe-b,L=2*ge-S);const x=3===l?-1:1,T=x*(I-y),C=x*(D-b),P=x*(L-S);be=i*C-r*P,ve=t*P-i*T,Se=r*T-t*C;const M=1/Math.sqrt(be*be+ve*ve+Se*Se);be*=M,ve*=M,Se*=M}}}else be=me*ye,ve=fe*ye,Se=ge*ye;s.setEdgeNormalFromValues(l,e,be,ve,Se)}})()}}function g(e){E(e)}function y(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function _(e){const{tile:t}=e;if(t.surface.isWebMercator){const e=t.extent,r=t.ellipsoid.radius,i=t=>function(e,t,r,i){return y(e*(1-i)+t*i,r)}(e[1],e[3],r,t);return i}const r=t.extentInRadians;return e=>function(e,t,r){return e*(1-r)+t*r}(r[1],r[3],e)}function b(e,t){e.tile.intersectsClippingArea&&(S(e),v(e,!1))}function v(e,r){const{geometry:i,geometryState:s,localOrigin:o}=e,a=e.tile,{surface:l,extent:d}=a,{clippingArea:p,samplerData:m}=s,f=null!=p?p:N,g=d[0],y=d[2],_=d[1],b=d[3],v=[b>f[3],y>f[2],_<f[1],g<f[0]],S=a.horizontalScale,x=w(l.isWebMercatorOnPlateCarree,a.ellipsoid.radius,S),{minu:T,minv:C,maxu:P,maxv:M,boundingBox:E}=i,O=Math.max(g,f[0]),A=Math.min(y,f[2]),I=Math.max(_,f[1]),D=Math.min(b,f[3]),F=o[0],L=o[1],U=o[2];for(let o=0;o<4;++o){const d=1===o||3===o,p=s.edgeResolutions[o];u.internalAssert(t.isPowerOfTwo(p));const f=p+1,w=v[o],N=c.neighborTileIfLoadedOrSelf(a,s.edgePeerNeighbors[o]);if(!w&&V(a,N,o)){R(e,o,N);continue}const B=null!=N&&!w,G=N?.renderData,z=G?.geometryState;if(u.enableTerrainInternalChecks&&(u.internalAssert(!B||N.level===a.level),u.internalAssert(!B||h.compareTilesByLij(a,N)<=0),a&&!N&&!l.updatingRootTiles)){const e=u.neighborEdgeIndices[o],t=a.findNeighborTile(e,(e=>e.loaded||e.leaf||e.level===a.level));l.updatingRootTiles||(t?t.intersectsClippingArea&&(u.internalAssert(!t.loaded),u.internalAssert(!t.leaf),u.internalAssert(t.level===a.level)):u.internalAssert(null==l?.rootTiles||!a.shouldHaveNeighbor(e)))}const j=t.clamp(1===o?y:g,O,A),q=t.clamp(0===o?b:_,I,D),H=z?.samplerData,W=r&&f>3?f-3:1,$=t.clamp(1===o?1:0,T,P),Q=t.clamp(0===o?1:0,C,M),Z=B?(e,t)=>.5*(n.sampleElevation(e,t,H)+n.sampleElevation(e,t,m)):(e,t)=>n.sampleElevation(e,t,m),Y=(y-g)/p,X=d?1===o?Y:-Y:0,K=d?0:0===o?Y:-Y,J=-X,ee=-K;let te=0,re=0,ie=0;{const e=0/p,r=d?j:t.clamp(g*(1-e)+y*e,O,A),i=d?t.clamp(_*(1-e)+b*e,I,D):q,s=Z(r,i);te=r*S,re=x(i),ie=s}let se=0,ne=0,oe=0;{const e=1/p,r=d?j:t.clamp(g*(1-e)+y*e,O,A),i=d?t.clamp(_*(1-e)+b*e,I,D):q,s=Z(r,i);se=r*S,ne=x(i),oe=s}for(let e=1;e<f-1;e+=W){const r=e/p,s=se,a=ne,l=oe;{const n=d?$:t.clamp(r,T,P),c=d?t.clamp(r,C,M):Q,u=s-F,h=a-L,p=l-U;k(s,h,p,E),i.setEdgeVertexFromValuesRawPositionUV(o,e,u,h,p,n,c)}{const r=(e+1)/p,i=d?j:t.clamp(g*(1-r)+y*r,O,A),s=d?t.clamp(_*(1-r)+b*r,I,D):q,n=Z(i,s);se=i*S,ne=x(s),oe=n}const c=se,u=oe,h=te,f=re,v=ie;te=s,re=a,ie=l;let w=0,R=0,N=0;if(d){const e=ne-a,i=u-l,c=f-a,d=v-l,h=t.clamp(_*(1-r)+b*r,I,D),p=j+J,g=h,y=p*S-s,x=n.sampleElevation(p,g,m)-l,T=3===o?-1:1;if(w=T*(-c+e)*x,R=T*y*(-d+i),N=-T*y*(-c+e),B){const t=j+X,r=h,o=t*S-s;w=(-c+e)*(x-(n.sampleElevation(t,r,H)-l)),R=(y-o)*(-d+i),N=-(y-o)*(-c+e)}}else{const e=c-s,i=u-l,d=h-s,p=v-l,f=t.clamp(g*(1-r)+y*r,O,A),_=f,b=q+ee,S=n.sampleElevation(_,b,m)-l,T=x(b)-a,C=2===o?-1:1;if(w=C*T*(-p+i),R=C*(-d+e)*S,N=-C*T*(-d+e),B){const t=f,r=q+K,s=x(r)-a;w=(-T+s)*(-p+i),R=(-d+e)*(-S+(n.sampleElevation(t,r,H)-l)),N=-(-T+s)*(-d+e)}}const V=1/Math.sqrt(w*w+R*R+N*N);i.setEdgeNormalFromValues(o,e,w*V,R*V,N*V)}}}function S(e,t){E(e)}function w(e,t,r){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,r)}function x(e,t,r){const{numVerticesPerSide:i,vertexAttributes:s,maxEdgeVertexCount:n}=e,o=i-1,a=s.count,l=2*(i-3)*(i-3),u=4*(o+n-3),d=c.zeroToFour.reduce(((t,r)=>t+(o+e.getEdgeCount(r)-3)),0),h=t.reduce(((e,t)=>e+o*(2*(t.latitudeResolution-1)+1)),0),p=3*(r?2:1),m=(l+u+h)*p,f=a>=65536?new Uint32Array(m):new Uint16Array(m);for(let e=0;e<m;++e)f[e]=0;e.indices=f,e.indexCount=(l+d+h)*p,e.poleIndicesStartIndex=l*p,e.edgeIndicesStartIndex=(l+h)*p,r?(function(e){const{indices:t,numVerticesPerSide:r,vertexAttributes:i}=e,{position:s}=i,{typedBuffer:n,typedBufferStride:o}=s,a=r-2;let l=0;for(let e=0;e<r-3;++e){const i=e*a;for(let s=0;s<r-3;++s){const r=e*a+s,c=r+1,u=c+a,d=u-1,h=i+s,p=h+1,m=p+a;j(h,p,m,m-1,o,n)?(q(t,l,r,c,u),l+=6,q(t,l,u,d,r)):(q(t,l,r,c,d),l+=6,q(t,l,d,u,c)),l+=6}}}(e),function(e,t){const{indices:r,numVerticesPerSide:i,poleIndicesStartIndex:s}=e,n=i-1;let o=s;for(const s of t){const t=s.connectedOuterEdgeOffset;let a=e.getEdgeVertexIndex(t,0),l=1;for(let e=0;e<s.latitudeResolution;++e){const t=0===e?s.rowOffset:a+i;for(let i=0;i<n;i++)q(r,o,a,a+1,t+i),o+=6,e<s.latitudeResolution-1&&(q(r,o,a+1,t+i+1,t+i),o+=6),a+=l;a=t,l=1}}}(e,t),C(e)):(function(e){const{numVerticesPerSide:t,indices:r,vertexAttributes:i}=e,{position:s}=i,{typedBuffer:n,typedBufferStride:o}=s,a=t-2,l=t-3,c=t-3;let u=0;for(let e=0;e<l;++e){const t=e*a;for(let e=0;e<c;++e){const i=t+e,s=i+1,l=s+a,c=l-1;j(i,s,l,c,o,n)?(r[u]=i,r[u+1]=s,r[u+2]=l,r[u+3]=l,r[u+4]=c,r[u+5]=i):(r[u]=i,r[u+1]=s,r[u+2]=c,r[u+3]=c,r[u+4]=s,r[u+5]=l),u+=6}}}(e),function(e,t){const{numVerticesPerSide:r,indices:i,poleIndicesStartIndex:s}=e,n=r-1;let o=s;for(const s of t){const t=s.isNorth?1:2,a=s.isNorth?2:1,l=s.isNorth?3:4,c=s.isNorth?4:3;let u=e.getEdgeVertexIndex(s.connectedOuterEdgeOffset,0),d=1;for(let e=0;e<s.latitudeResolution;++e){const h=0===e?s.rowOffset:u+r;for(let r=0;r<n;r++){const n=h+r;i[o]=u,i[o+t]=u+1,i[o+a]=n,e<s.latitudeResolution-1?(i[o+l]=u+1,i[o+c]=n+1,i[o+5]=n,o+=6):o+=3,u+=d}u=h,d=1}}}(e,t),T(e))}function T(e){const{indices:t,numVerticesPerSide:r,edgeIndicesStartIndex:i}=e,s=r-1,n=s-2;let o=i;for(let r=0;r<4;++r){const i=G[r];let a=0,l=0;const c=e.getEdgeCount(r),d=i.count;u.internalAssert(d===s-1);const h=1===r||2===r,p=h?1:2,m=h?2:1,f=e.getEdgeFirstVertexIndex(r),g=1,y=i.vertex0Index,_=i.stride;for(;a<c-1||l<d-1;){const e=y+l*_,r=f+a*g,i=a<c-1,u=l<d-1,h=i&&(!u||(i?0+s*(a+.5)/(c-1):0)<=(u?1+n*(l+.5)/(d-1):0));h?++a:++l;const b=h?r+g:e+_;t[o]=e,t[o+p]=r,t[o+m]=b,o+=3}}e.indexCount=o}function C(e){const{indices:t,numVerticesPerSide:r,edgeIndicesStartIndex:i}=e,s=r-1,n=s-2;let o=i;for(let r=0;r<4;++r){const i=G[r];let a=0,l=0;const c=e.getEdgeCount(r),d=i.count;u.internalAssert(d===s-1);const h=1===r||2===r,p=h?1:3,m=h?3:1,f=e.getEdgeFirstVertexIndex(r),g=1,y=i.vertex0Index,_=i.stride;for(;a<c-1||l<d-1;){const e=y+l*_,r=f+a*g,i=a<c-1,u=l<d-1,h=i&&(!u||(i?0+s*(a+.5)/(c-1):0)<=(u?1+n*(l+.5)/(d-1):0));h?++a:++l;const b=h?r+g:e+_;t[o]=e,t[o+p]=r,t[o+p+1]=r,t[o+m]=b,t[o+m+1]=b,t[o+5]=e,o+=6}}e.indexCount=o}function P(e){const{geometry:t,geometryState:r}=e,{edgeResolutions:i}=r,{numVerticesPerSide:s,edgeVerticesStartIndex:n}=t,o=s-2;let a=n;for(let e=0;e<4;++e){{const t=0===e||2===e,r=(0===e?o-1:0)*o+(1===e?o-1:0),i=(t?0:1)*o+(t?1:0),s=G[e];s.vertex0Index=r,s.stride=i,s.count=o}{const r=i[e]+1;t.outerEdgesOffsetAndLength[2*e+0]=a,t.outerEdgesOffsetAndLength[2*e+1]=r,a+=r}}}function M(e){P(e),e.geometryState.wireframe?C(e.geometry):T(e.geometry)}function R(e,i,s){const{geometryState:n,geometry:o,tile:a,localOrigin:l}=e,c=1===i||3===i,d=n.edgeResolutions[i];u.internalAssert(t.isPowerOfTwo(d));const h=d+1,{boundingBox:p,minu:m,minv:f,maxu:g,maxv:y,vertexAttributes:_}=o,b=t.clamp(1===i?1:0,m,g),v=t.clamp(0===i?1:0,f,y),S=s.renderData,w=S.geometryState,x=S.geometry,T=(i+2)%4,C=x.getEdgeCount(T),P=a.getNeighborEdgeStartVertexIndex(i,s)*d,M=d*2**(a.level-s.level);u.internalAssert(w.edgeResolutions[T]===M),u.internalAssert(C-1===M);const R=S.localOrigin[0]-l[0],E=S.localOrigin[1]-l[1],O=S.localOrigin[2]-l[2],A=o.getEdgeFirstVertexIndex(i),{position:I,uv0:D}=_,F=I.typedBuffer,L=I.typedBufferStride,N=_.normalCompressed,U=N.typedBuffer,V=N.typedBufferStride,B=x.vertexAttributes,G=x.getEdgeFirstVertexIndex(T),z=B.position.typedBuffer,j=B.position.typedBufferStride,q=B.normalCompressed.typedBuffer,H=B.normalCompressed.typedBufferStride;for(let e=1;e<h-1;++e){const i=A+e,s=G+(P+e),n=i*L,o=s*j,a=z[o]+R,l=z[o+1]+E,u=z[o+2]+O;F[n]=a,F[n+1]=l,F[n+2]=u,k(a,l,u,p);const h=i*V,_=s*H;U[h]=q[_],U[h+1]=q[_+1];const S=e/d,w=c?b:t.clamp(S,m,g),x=c?t.clamp(S,f,y):v;D.setValues(i,Math.round(w*r.maxUint16),Math.round(x*r.maxUint16))}}function E(e){const{geometry:i,geometryState:s,localOrigin:o}=e,{clippingArea:a,samplerData:l}=s,{minu:c,minv:d,maxu:p,maxv:m,boundingBox:f,vertexAttributes:g}=i,y=e.tile,{surface:b,ellipsoid:v,extent:S,extentInRadians:x,horizontalScale:T}=y,C="local"===b.view?.viewingMode,P=v.radius;let M=0,R=0,E=0;const A=C?(()=>{const e=a,r=null!=e&&(S[3]>e[3]||S[2]>e[2]||S[1]<e[1]||S[0]<e[0]),i=w(b.isWebMercatorOnPlateCarree,P,T);return(s,n,o)=>{const a=0===s?S[0]:S[2],l=0===n?S[1]:S[3],c=r?t.clamp(a,e[0],e[2]):a,u=r?t.clamp(l,e[1],e[3]):l,d=o;M=c*T,R=i(u),E=d}})():(e,t,r)=>{const i=x[0===t?1:3],s=x[0===e?0:2],n=Math.cos(i),o=Math.sin(i),a=Math.sin(s),l=Math.cos(s),c=P+r;M=l*n*c,R=a*n*c,E=o*c};let I=0,D=0,L=0,V=0,B=0,G=0,z=0,j=0,q=0;const H=C&&b.isWebMercatorOnPlateCarree,W=(e,t,r,i,s)=>{let n=0,o=0,a=0;if(C){const e=t*T,s=H?(Math.PI/2-2*Math.atan(Math.exp(-r/P)))*P:r*T;n=e-M,o=s-R,a=i-E}else{const s=_(e),l=e.tile,c=l.extent,u=l.extentInRadians,d=(t-c[0])/(c[2]-c[0]),h=(r-c[1])/(c[3]-c[1]),p=u[0]*(1-d)+u[2]*d,m=s(h),f=Math.cos(m),g=Math.sin(m),y=Math.sin(p),b=Math.cos(p),v=P+i;n=b*f*v-M,o=y*f*v-R,a=g*v-E}switch(s){case 0:z+=n,j+=o,q+=a;break;case 1:V-=n,B-=o,G-=a;break;case 2:z-=n,j-=o,q-=a;break;case 3:V+=n,B+=o,G+=a}},$=a??N,Q=S[0],Z=S[2],Y=S[1],X=S[3],K=[X>$[3],Z>$[2],Y<$[1],Q<$[0]],J=Math.max(Q,$[0]),ee=Math.min(Z,$[2]),te=Math.max(Y,$[1]),re=Math.min(X,$[3]),ie=e=>Math.max($[0],Math.min($[2],e)),se=e=>Math.max($[1],Math.min($[3],e)),ne=e=>{const t=s.cornerNeighborCornerTiles;I=0,D=0,L=1,V=0,B=0,G=0,z=0,j=0,q=0;let r=1/0;for(let i=0;i<4;++i){const s=t[4*e+i];r=Math.min(r,s?.level??1/0)}for(let i=0;i<4;++i){const s=t[4*e+i];U[i]=s?.level===r?s:null}let i=1,o=0;for(let e=0;e<4;++e){const t=U[e];t&&(i=Math.max(i,t?.renderData.geometryState.numVerticesPerSide),o=t.extent[2]-t.extent[0])}const a=o,l=i;u.internalAssert(l>1);const c=a/l;for(let e=0;e<4;++e){const t=U[(e+3)%4],r=U[e%4];if(!t&&!r)continue;const i=0===e?1:1===e?2:2===e?3:0,s=0===e?2:1===e?3:2===e?0:1;if(t&&r){const o=F[e][0]*c,a=F[e][1]*c,l=t.extent,u=ie(l[0===i||1===i?2:0]+o),d=se(l[0===i||3===i?3:1]+a),h=r.extent,p=ie(h[0===s||1===s?2:0]+o),m=se(h[0===s||3===s?3:1]+a),f=t.renderData,g=r.renderData,y=n.sampleElevation(u,d,f.geometryState.samplerData),_=n.sampleElevation(p,m,g.geometryState.samplerData);W(f,u,d,.5*(y+_),e)}else{const o=t??r,a=t?i:s,l=o.extent,u=F[e],d=ie(l[0===a||1===a?2:0]+u[0]*c),h=se(l[0===a||3===a?3:1]+u[1]*c),p=o.renderData,m=n.sampleElevation(d,h,p.geometryState.samplerData);W(p,d,h,m,e)}}if(!C){const e=Math.sqrt(M*M+R*R+E*E);I=M/e,D=R/e,L=E/e}if(C||L*L<.999){const e=Math.sqrt(V*V+B*B+G*G);V/=e,B/=e,G/=e;const t=Math.sqrt(z*z+j*j+q*q);z/=t,j/=t,q/=t,I=G*j-B*q,D=V*q-G*z,L=B*z-V*j;const r=1/Math.sqrt(I*I+D*D+L*L);I*=r,D*=r,L*=r}},oe=s.cornerNeighborCornerTiles;for(let e=0;e<4;++e){const a=e,_=(e+1)%4,b=0===e||1===e?1:0,v=0===e||3===e?1:0,S=t.clamp(b,c,p),w=t.clamp(v,d,m),x=i.getEdgeFirstVertexIndex(a),T=i.getEdgeCount(a),C=0===e||3===e?T-1:0,P=i.getEdgeFirstVertexIndex(_),F=i.getEdgeCount(_),N=0===e||1===e?F-1:0;let U=-1;for(let t=0;t<4;++t){const r=oe[4*e+t],i=oe[4*e+U];r&&(-1===U||h.compareTilesByLij(i,r)>0)&&(U=t)}const V=U,B=oe[4*e+V];if(B!==y){const t=y.level-B.level,i=2**t,n=[B.lij[0]+t,B.lij[1]*i,B.lij[2]*i],a=[n[1]+i===y.lij[1],0===e&&(1===V||0===V&&B!==oe[4*e+3])||1===e&&(0===V||1===V&&B!==oe[4*e+2]),n[1]===y.lij[1]+1,2===e&&(3===V||2===V&&B!==oe[4*e+1])||3===e&&(2===V||3===V&&B!==oe[4*e+0])],l=a.reduce(((e,t)=>e+(t?1:0)),0);u.internalAssert(1===l||2===l);let c=-1,d=-1;const h=B.renderData;if(1===l){const t=a.findIndex((e=>e));u.internalAssert(0<=t&&t<=3),c=(t+2)%4;const r=s.edgeResolutions[t];d=y.getNeighborEdgeStartVertexIndex(t,B)*r+r*(0===t&&0===e||1===t&&0===e||2===t&&1===e||3===t&&3===e?1:0)}else{u.internalAssert(a[1]||a[3]),c=a[1]?3:1;const t=h.geometryState.edgeResolutions[c];d=0===e||3===e?0:t}const p=h.geometry;{const e=x+C,t=P+N,i=p.getEdgeFirstVertexIndex(c)+d,s=p.vertexAttributes,n=h.localOrigin,a=s.position,l=a.typedBuffer,u=i*a.typedBufferStride,m=l[u]+n[0]-o[0],y=l[u+1]+n[1]-o[1],_=l[u+2]+n[2]-o[2];k(m,y,_,f);const b=g.position,v=b.typedBuffer,T=e*b.typedBufferStride;v[T]=m,v[T+1]=y,v[T+2]=_;const M=t*b.typedBufferStride;v[M]=m,v[M+1]=y,v[M+2]=_;const R=g.uv0;R.setValues(e,Math.round(S*r.maxUint16),Math.round(w*r.maxUint16)),R.setValues(t,Math.round(S*r.maxUint16),Math.round(w*r.maxUint16));{const r=s.normalCompressed.typedBuffer,n=i*s.normalCompressed.typedBufferStride,o=g.normalCompressed,a=o.typedBuffer;{const t=e*o.typedBufferStride;a[t]=r[n],a[t+1]=r[n+1]}{const e=t*o.typedBufferStride;a[e]=r[n],a[e+1]=r[n+1]}}}}else{let r;if(K[a]||K[_]){const e=t.clamp(Q*(1-b)+Z*b,J,ee),i=t.clamp(Y*(1-v)+X*v,te,re);r=n.sampleElevation(e,i,l)}else r=O(oe,e);A(b,v,r),ne(e);const s=M-o[0],c=R-o[1],u=E-o[2];k(s,c,u,f),i.setEdgeVertexFromValuesRawPositionUVNormal(a,C,s,c,u,S,w,I,D,L),i.setEdgeVertexFromValuesRawPositionUVNormal(_,N,s,c,u,S,w,I,D,L)}}for(let e=0;e<4;++e)U[e]=null}function O(e,t){const r=4*t,i=c.zeroToFour.reduce(((t,i)=>Math.min(t,e[r+i]?.level??1/0)),1/0);u.enableTerrainInternalChecks&&(u.internalAssert(!e[r+0]||!e[r+2]||d.isCornerNeighbor(e[r+0],e[r+2],a.NeighborIndex.SOUTH_WEST)),u.internalAssert(!e[r+1]||!e[r+3]||d.isCornerNeighbor(e[r+1],e[r+3],a.NeighborIndex.NORTH_WEST)));let s=0,o=0;for(let t=0;t<4;++t){const a=e[r+t];if(a&&a.level===i){const e=0===t||1===t,r=0===t||3===t,i=a.extent,l=i[e?0:2],c=i[r?1:3],u=a.renderData?.geometryState?.samplerData;o+=n.sampleElevation(l,c,u),s++}}const l=s?o/s:0;return u.internalAssert(null!=l),l}function A(e){const{vao:t,geometry:r}=e,{vertexAttributes:i,edgeVerticesStartIndex:s}=r,n=i.position.typedBuffer;t.vertexBuffers.get("geometry").setSubData(n,s,s,n.length)}function I(e){const{vao:t,geometry:r}=e,{indices:i,indexCount:s,edgeIndicesStartIndex:n}=r;t.indexBuffer.setSubData(i,n,n,s)}class D{constructor(e,t,r,i,s){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=r,this.rowOffset=i,this.latitudeResolution=s}}const F=[[0,1],[1,0],[0,-1],[-1,0]],L=new l.PatchGeometryLUT,N=s.fromValues(-1/0,-1/0,1/0,1/0),U=[null,null,null,null];function V(e,t,r){if(!t)return!1;const i=h.compareTilesByLij(e,t);return i>0||0===i&&r>=2}class B{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return u.internalAssert(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const G=[new B,new B,new B,new B];function k(e,t,r,i){e<i[0]?i[0]=e:e>i[3]&&(i[3]=e),t<i[1]?i[1]=t:t>i[4]&&(i[4]=t),r<i[2]?i[2]=r:r>i[5]&&(i[5]=r)}function z(e){const{edgeResolutions:t,numVerticesPerSide:r}=e,i=1+Math.max(...t);return Math.max(r,i)}function j(e,t,r,i,s,n){const o=e*s,a=n[o],l=n[o+1],c=n[o+2],u=t*s,d=n[u],h=n[u+1],p=n[u+2],m=r*s,f=n[m],g=n[m+1],y=n[m+2],_=i*s,b=n[_],v=n[_+1],S=n[_+2];return(d-b)*(d-b)+(h-v)*(h-v)+(p-S)*(p-S)>(a-f)*(a-f)+(l-g)*(l-g)+(c-y)*(c-y)}function q(e,t,r,i,s){e[t]=r,e[t+1]=i,e[t+2]=i,e[t+3]=s,e[t+4]=s,e[t+5]=r}e.createPlanarGlobePatch=function(e,s){const{tile:o,geometryState:a,geometry:l}=e,{extent:c,surface:u}=o,{wireframe:d}=a,h=c[0],m=c[1],f=c[2]-h,g=c[3]-m,{numVerticesPerSide:y,clippingArea:_}=a,v=null!=_?Math.max(0,(_[0]-h)/f):0,S=null!=_?Math.max(0,(_[1]-m)/g):0,w=null!=_?Math.min(1,(_[2]-h)/f):1,T=null!=_?Math.min(1,(_[3]-m)/g):1,C=(y-2)**2,M=z(a),R=C+4*M,E=u.renderer.tileGeometryCache.acquire(R),{boundingBox:O}=l;i.empty(O),l.numVerticesPerSide=y,l.vertexAttributes=E,l.maxEdgeVertexCount=M,l.minu=v,l.minv=S,l.maxu=w,l.maxv=T,function(e){const i=e.tile;if(!i.intersectsClippingArea)return;const{geometry:s,geometryState:o,localOrigin:a}=e,{samplerData:l,clippingArea:c,numVerticesPerSide:u}=o,{surface:d,extent:h,ellipsoid:m}=i,{isWebMercatorOnPlateCarree:f}=d,g=null!=c?c:N,y=h[0],_=h[1],b=h[2],v=h[3],S=Math.max(y,g[0]),w=Math.min(b,g[2]),x=Math.max(_,g[1]),T=Math.min(v,g[3]),C=m.radius,P=i.horizontalScale,M=u-1,R=u-2,{minu:E,minv:O,maxu:A,maxv:I,boundingBox:D,vertexAttributes:F}=s,{position:L,uv0:U}=F,{typedBuffer:V,typedBufferStride:B}=F.normalCompressed,G=a[0],z=a[1],j=a[2],q=L.typedBuffer,H=L.typedBufferStride;let W=0;const $=t.clamp(_,x,T),Q=f?(Math.PI/2-2*Math.atan(Math.exp(-$/C)))*C:$*P,Z=1/M,Y=t.clamp(_*(1-Z)+v*Z,x,T);let X=Q,K=f?(Math.PI/2-2*Math.atan(Math.exp(-Y/C)))*C:Y*P;for(let e=1;e<=R;e++){const i=e/M,s=t.clamp(_*(1-i)+v*i,x,T),o=t.clamp(i,O,I),a=K,c=(e-1)/M,u=t.clamp(_*(1-c)+v*c,x,T),d=X,h=(e+1)/M,m=t.clamp(_*(1-h)+v*h,x,T),g=f?(Math.PI/2-2*Math.atan(Math.exp(-m/C)))*C:m*P,F=t.clamp(h,O,I);X=K,K=g;const L=t.clamp(y,S,w);let N=L*P,$=n.sampleElevation(L,s,l);const Q=1/M,Z=t.clamp(Q,E,A),Y=t.clamp(y*(1-Z)+b*Z,S,w);let J=Z,ee=Y,te=Y*P,re=n.sampleElevation(Y,s,l);if(1===e){const e=te-G,i=X-z,s=re-j,n=0*H;q[n]=e,q[n+1]=i,q[n+2]=s,k(e,i,s,D);const a=t.clamp(Q,E,A);U.setValues(W,Math.round(a*r.maxUint16),Math.round(o*r.maxUint16))}for(let i=1;i<=R;i++){const c=te,h=re,f=(i+1)/M,_=t.clamp(f,E,A),v=t.clamp(y*(1-f)+b*f,S,w),x=ee;ee=v;{const t=W+1,c=t*H;if(1===e||i===R){const u=v*P,d=n.sampleElevation(v,s,l);if(1===e&&i<R){const e=u-G,i=a-z,s=d-j;q[c]=e,q[c+1]=i,q[c+2]=s,k(e,i,s,D),U.setValues(t,Math.round(_*r.maxUint16),Math.round(o*r.maxUint16))}te=u,re=d}else te=q[c]+G,re=q[c+2]+j}const T=te,C=re,O=N,I=$;N=c,$=h;const L=(W-R)*H,Q=1===e?n.sampleElevation(x,u,l):q[L+2]+j,Z=n.sampleElevation(x,m,l);if(e<R){const e=W+R,t=e*H,i=c-G,s=g-z,n=Z-j;q[t]=i,q[t+1]=s,q[t+2]=n,k(i,s,n,D);const o=J;J=_,U.setValues(e,Math.round(o*r.maxUint16),Math.round(F*r.maxUint16))}{const e=T-O,t=d-g,r=t*(C-I),i=e*(Q-Z),s=-t*e,n=r*r+i*i+s*s;if(0===n)p.compressNormal(V,W,0,0,1,B);else{const e=1/Math.sqrt(n);p.compressNormal(V,W,r*e,i*e,s*e,B)}}++W}}}(e),l.edgeVerticesStartIndex=C,P(e),b(e),x(l,[],d),e.intersectionData=null},e.createSphericalGlobePatch=function(e,t){const{tile:s,geometry:a,geometryState:l}=e,{extentInRadians:c,surface:u}=s,{isWebMercator:d,renderer:h}=u,{numVerticesPerSide:f,wireframe:g}=l,b=f-1,v=(f-2)**2,S=d&&(t===o.PatchType.HAS_SOUTH_POLE||t===o.PatchType.HAS_BOTH_POLES),w=d&&(t===o.PatchType.HAS_NORTH_POLE||t===o.PatchType.HAS_BOTH_POLES),T=6*((S?1:0)+(w?1:0))*f,C=z(l),M=v+T+4*C,R=h.tileGeometryCache.acquire(M);a.numVerticesPerSide=f,a.vertexAttributes=R,a.maxEdgeVertexCount=C;const{boundingBox:E}=a;i.empty(E);const O=_(e);L.update(b,c,O),function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:s,localOrigin:o}=e,{numVerticesPerSide:a,samplerData:l}=s,c=a-2,u=a-1,{vertexAttributes:d,boundingBox:h}=i,{position:m,uv0:f}=d,{typedBuffer:g,typedBufferStride:y}=d.normalCompressed,{extent:_}=t,b=_[0],v=_[2],S=_[1],w=_[3],x=t.ellipsoid.radius,T=o[0],C=o[1],P=o[2],M=m.typedBuffer,R=m.typedBufferStride,E=1/u;let O=0;if(1<=c){const e=E,t=S*(1-e)+w*e,i=L.sinLatLUT[1],s=L.cosLatLUT[1];for(let o=1;o<=c;o++){const a=o*E,c=b*(1-a)+v*a,u=L.sinLonLUT[o],d=L.cosLonLUT[o],p=x+n.sampleElevation(c,t,l),m=p*d*s-T,g=p*u*s-C,y=p*i-P;k(m,g,y,h);const _=(o-1)*R;M[_]=m,M[_+1]=g,M[_+2]=y,f.setValues(o-1,Math.round(a*r.maxUint16),Math.round(e*r.maxUint16))}}for(let e=1;e<=c;e++){const t=e*E,i=S*(1-t)+w*t,s=L.sinLatLUT[e],o=L.cosLatLUT[e],a=e+1,d=a*E,m=S*(1-d)+w*d,_=L.sinLatLUT[a],A=L.cosLatLUT[a],I=L.sinLonLUT[0],D=L.cosLonLUT[0],F=x+n.sampleElevation(b,i,l);let N=D*o*F-T,U=I*o*F-C,V=s*F-P;const B=O*R;let G=M[B],z=M[B+1],j=M[B+2];for(let t=1;t<=c;t++){const a=t*E,w=b*(1-a)+v*a,I=L.sinLonLUT[t],D=L.cosLonLUT[t];let F=0,B=0,q=0;if(t<c){const e=(O+1)*R;F=M[e],B=M[e+1],q=M[e+2]}else{const e=L.sinLonLUT[u],t=L.cosLonLUT[u],r=x+n.sampleElevation(v,i,l);F=t*o*r-T,B=e*o*r-C,q=s*r-P}const H=N,W=U,$=V;N=G,U=z,V=j,G=F,z=B,j=q;const Q=F-H,Z=B-W,Y=q-$;let X=0,K=0,J=0;if(e>1){const e=(O-c)*R;X=M[e],K=M[e+1],J=M[e+2]}else{const e=L.sinLatLUT[0],t=L.cosLatLUT[0],r=x+n.sampleElevation(w,S,l);X=D*t*r-T,K=I*t*r-C,J=e*r-P}const ee=x+n.sampleElevation(w,m,l),te=D*A*ee-T,re=I*A*ee-C,ie=_*ee-P;if(e<c){const e=O+c,t=e*R;M[t]=te,M[t+1]=re,M[t+2]=ie,k(te,re,ie,h),f.setValues(e,Math.round(a*r.maxUint16),Math.round(d*r.maxUint16))}const se=X-te,ne=K-re,oe=J-ie;let ae=D*o,le=I*o,ce=s;ce*ce<.999&&(ae=Y*ne-Z*oe,le=Q*oe-Y*se,ce=Z*se-Q*ne);const ue=1/Math.sqrt(ae*ae+le*le+ce*ce);p.compressNormal(g,O,ae*ue,le*ue,ce*ue,y),++O}}}(e),a.poleVerticesStartIndex=v;const A=function(e,t,i){const{tile:s,localOrigin:n,geometry:o}=e,{extent:a,ellipsoid:l}=s,{boundingBox:c,numVerticesPerSide:u,vertexAttributes:d,poleVerticesStartIndex:h}=o,m=u-1,f=n[0],g=n[1],_=n[2],b=l.radius,v=a[1],S=a[3],w=[];let x=h;const T=(e,t)=>{const i=t*u;k(-f,-g,e*b-_,c),w.push(new D(1===e,i,1===e?0:2,x,6));const s=y(-1===e?v:S,b),n=e*Math.PI/2-s,o=.99*(1===e?1:-1),a=b+0,{position:l,uv0:h}=d,{typedBuffer:T,typedBufferStride:C}=d.normalCompressed;for(let e=1;e<=6;++e){const t=s+n*(e/6),i=Math.cos(t),u=Math.sin(t);for(let e=0;e<=m;e++){const t=e/m,s=L.sinLonLUT[e],n=L.cosLonLUT[e]*i,d=s*i,y=u,b=n*a-f,v=d*a-g,S=y*a-_;k(b,v,S,c),l.setValues(x,b,v,S),h.setValues(x,Math.round(t*r.maxUint16),Math.round(o*r.maxUint16)),p.compressNormal(T,x,n,d,y,C),++x}}};return t&&T(-1,0),i&&T(1,m),w}(e,S,w);a.edgeVerticesStartIndex=v+T,P(e),m(e),x(a,A,g),e.intersectionData=null},e.updateCornerSpherical=function(e){e.tile.intersectsClippingArea&&(g(e),f(e,!0),A(e),e.intersectionData=null)},e.updateCornersPlanar=function(e,t){e.tile.intersectsClippingArea&&(S(e),v(e,!0),A(e),e.intersectionData=null)},e.updateEdgeElevationsAndResolutionsPlanar=function(e,t){e.tile.intersectsClippingArea&&(M(e),b(e),A(e),I(e),e.intersectionData=null)},e.updateEdgeElevationsAndResolutionsSpherical=function(e){e.tile.intersectsClippingArea&&(M(e),m(e),A(e),I(e),e.intersectionData=null)},e.updateEdgesAndCornersPlanar=function(e,t){e.tile.intersectsClippingArea&&(b(e),A(e),e.intersectionData=null)},e.updateEdgesAndCornersSpherical=function(e){e.tile.intersectsClippingArea&&(m(e),A(e),e.intersectionData=null)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/PatchGeometryLUT":function(){define(["exports","./TerrainConst"],(function(e,t){"use strict";e.PatchGeometryLUT=class{constructor(){this.sinLonLUT=new Array(t.maxPatchTesselation+1),this.cosLonLUT=new Array(t.maxPatchTesselation+1),this.sinLatLUT=new Array(t.maxPatchTesselation+1),this.cosLatLUT=new Array(t.maxPatchTesselation+1)}update(e,t,r){const i=t[0],s=t[2];for(let t=0;t<=e;t++){const n=t/e,o=i*(1-n)+s*n;this.sinLonLUT[t]=Math.sin(o),this.cosLonLUT[t]=Math.cos(o);const a=r(n);this.sinLatLUT[t]=Math.sin(a),this.cosLatLUT[t]=Math.cos(a)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/PatchRenderData":function(){define(["exports","../../../core/arrayUtils","../../../core/has","../../../core/mathUtils","../../../core/maybe","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/support/aaBoundingRect","../../../geometry/support/Ellipsoid","../support/buffer/glUtil","./GeometryState","./interfaces","./LayerClass","./NeighborIndex","./PatchGeometry","./TerrainConst","./terrainUtils","./TextureFader","./TextureReference","./TileOverlayData","./tileUtils","../webgl-engine/lib/VertexArrayObject","../webgl-engine/shaders/TerrainTechnique","../../webgl/BufferObject","../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T){"use strict";const C=o.create(),P=o.create(),M=o.create(),R=o.create(),E=o.create(),O=o.create(),A=[null,null,null,null];function I(e,t){return t?.loaded||t===e?t:null}const D=[0,1,2,3];e.PatchRenderData=class{constructor(){this.geometry=new m.PatchGeometry,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureOpacity=1,this._textureRef=new y.TextureFader((()=>this._tile.surface.fadeDuration)),this.overlay=new b,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new u.GeometryState,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),g.enableTerrainInternalChecks&&this.tile.intersectsClippingArea)for(let e=0;e<4;++e)g.internalAssert(this.geometry.getEdgeCount(e)===this.geometryState.edgeResolutions[e]+1)}_calculateEdgeResolution(e,t){const r=this.tile,i=this.geometryState.numVerticesPerSide-1;if(!r.surface.isGlobal){const t=r.surface.extent;if(null!=t&&(0===e&&r.extent[3]>t[3]||1===e&&r.extent[2]>t[2]||2===e&&r.extent[1]<t[1]||3===e&&r.extent[0]<t[0]))return i}const s=r.level,n=g.neighborEdgeIndices[e];if(!t)return g.internalAssert(null==r.surface?.rootTiles||r.surface.updatingRootTiles||!r.shouldHaveNeighbor(n)),i;if(t.loaded){const r=t,n=r.renderData.geometryState,o=s-r.level;if(g.internalAssert(o>=0),0===o){const e=n.numVerticesPerSide-1;return Math.max(e,i)}const a=2**o,l=n.edgeResolutions[(e+2)%4]/a;return Math.max(1,l)}g.internalAssert(!t.leaf);let o=i;return t.forAllSubtreeOnSide(g.oppositeEdge(n),(e=>e===r||(e.loaded?(o=Math.max(o,2**(e.level-s)),!0):(g.internalAssert(!e.leaf),!1)))),o}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,r=t=>(t.loaded||t.level===e.level)&&t?.intersectsClippingArea,s=t.edgePeerNeighbors,n=t.edgePeerNeighborSamplerVersions;for(let o=0;o<4;++o){const a=e.findNeighborTile(g.neighborEdgeIndices[o],r),l=I(e,a),c=l?.renderData?.geometryState.samplerDataVersion??-1,u=s[o],d=l!==I(e,u),h=n[o]!==c;g.enableTerrainInternalChecks&&a&&(g.internalAssert(e.level>=a.level),g.internalAssert(e.level-a.level<=f.maxTileNeighborLevelDelta)),s[o]=a,(d||h)&&(n[o]=c,this._markEdgeDirty(o));const p=t.edgeResolutions[o],m=this._calculateEdgeResolution(o,a);g.internalAssert(i.isPowerOfTwo(m)),g.internalAssert(m>=1),t.edgeResolutions[o]=m,p!==m&&this._markEdgeResolutionDirty(o)}for(let i=0;i<4;++i){const n=e.findNeighborTile(g.neighborCornerIndices[i],r);t.cornerPeerNeighbors[i]=n;const o=I(e,s[i]),a=I(e,s[(i+1)%4]),l=I(e,n);A[i]=l,A[(i+1)%4]=a,A[(i+2)%4]=e,A[(i+3)%4]=o,g.internalAssert(A.some((t=>t?.loaded||t===e)));const c=A.reduce(((e,t)=>Math.min(e,t?.level??1/0)),1/0);A.forEach(((e,t)=>{e&&e?.level>c&&(A[t]=null)})),g.internalAssert(A.some((t=>t?.loaded||t===e)));const u=t.cornerNeighborCornerTiles,d=t.cornerNeighborCornerTileSamplerVersions;for(let e=0;e<4;++e){const t=A[e],r=t?.renderData.geometryState.samplerDataVersion??-1,s=4*i+e,n=u[s]!==t,o=!n&&d[s]!==r;(n||o)&&(u[s]=t,d[s]=r,this._markCornerDirty(i))}g.enableTerrainInternalChecks&&g.internalAssert(D.some((t=>u[4*i+t]?.loaded||u[4*i+t]===e)))}g.enableTerrainInternalChecks&&g.internalAssert(this.geometryState.edgeResolutions.every((e=>e>0)));for(let e=0;e<4;++e)A[e]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;g.enableTerrainInternalChecks&&g.internalAssert(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every((e=>e>0))),this.intersectionData=null;const{tile:t,_vao:r,geometry:i,geometryState:s}=this,n=!r||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=0!==this.dirtyEdgeResolutions,a=s.edgeResolutions.reduce(((e,t)=>e+t+1),0),l=n||o&&a>(i?.maxEdgeVertexCount??0),c=!l&&o,u=!c&&(0!==this.dirtyEdges||o),d=!u&&0!==this.dirtyCorners;l?(this.releaseGeometry(),this._createGeometry(e)):c?t.updateEdgeElevationsAndResolutions():u||d?t.updateEdgeElevations():d?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=s.disposeMaybe(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,r,i){const s=t?T.PixelFormat.RGBA:T.PixelFormat.RGB;return null!=this._texture&&(r===d.TextureUpdate.FADING&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==s)&&this.releaseTexture(),null==this._texture&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture&&(this._texture=s.releaseMaybe(this._texture),this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture||(e.setTextureReference(new _.TextureReference(this._texture,d.TextureUpdate.FADING,t,this._textureOpacity,0,1)),0))}get numVerticesPerSideChanged(){return!!(1&this._modifiedFlags)}get samplerDataChanged(){return!!(2&this._modifiedFlags)}get clippingAreaChanged(){return!!(4&this._modifiedFlags)}get wireframeChanged(){return!!(8&this._modifiedFlags)}get dirtyEdges(){return this._modifiedFlags>>4&15}get dirtyCorners(){return this._modifiedFlags>>8&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>12&15}_markCornerDirty(e){const t=1<<e<<8;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<4;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<12;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=65520}updateGeometryState(){const e=this._elevationInfo,r=this.tile,i=e.samplerData?r.getElevationVerticesPerSide(e.maxTileLevel):r.minimumVerticesPerSide,s=Math.max(i,5);let n=r.clippingArea;r.intersectsClippingArea&&!r.withinClippingArea||(n=null);const o=this.geometryState;let a=!1;o.numVerticesPerSide!==s&&(this._modifiedFlags|=1,o.numVerticesPerSide=s,o.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,o.samplerData=e.samplerData,o.samplerDataVersion++,a=!0),t.equals(o.clippingArea,n)||(this._modifiedFlags=4,o.clippingArea=n,a=!0);const l=r.surface.wireframe;return o.wireframe!==l&&(this._modifiedFlags=8,o.wireframe=l,a=!0),this._geometryStateChangedSinceLastUpdate||=a,a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,r=this.geometry.indices,i=e.gl;this._vao=new S.VertexArrayObject(e,w.vertexAttributeLocations,new Map([["geometry",c.glLayout(t.layout)]]),new Map([["geometry",x.BufferObject.createVertex(e,i.STATIC_DRAW,t.buffer)]]),x.BufferObject.createIndex(e,i.STATIC_DRAW,r)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=y.ActivationTime.Immediate){e?.texture===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){return this._textureRef.current?.texture===e||this._textureRef.next?.texture===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[h.LayerClass.ELEVATION],r=t.length,i=new Array(r);let s=0,n=0,o=!1;for(let a=0;a<r;a++){const r=t[a],l=r.upsampleInfo?.tile;if(l){const t=l.layerInfo[h.LayerClass.ELEVATION][a].data,r=t&&t.samplerData;e&&e[s]===r||(o=!0),i[s++]=r,n=Math.max(n,l.lij[0])}else if(r.data){const t=this.tile.surface.layerViewByIndex(a,h.LayerClass.ELEVATION);if(v.fallsWithinLayerView(this.tile,t)){const t=r.data;e&&e[s]===t.samplerData||(o=!0),i[s++]=t.samplerData,n=this.tile.level}}}null!=e&&e.length!==s&&(o=!0);const a=s>0,l=a?i:null;return a&&(i.length=s),{changed:o,samplerData:l,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!g.enableTerrainInternalChecks)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||0===e.level)return void g.internalAssert(e?.loaded);const t=e.surface.extent;if(null!=t&&!e.intersectsExtent(t))return;const r=g.neighborEdgeIndices.map(((r,i)=>null!=t&&(i<2?-1:1)*(e.extent[3-i]-t[3-i])<0)),s=e.level;g.internalAssert(0===this.dirtyCorners),g.internalAssert(0===this.dirtyEdges),g.internalAssert(0===this.dirtyEdgeResolutions),g.internalAssert(!this.numVerticesPerSideChanged),g.internalAssert(!this.samplerDataChanged),g.internalAssert(!this.clippingAreaChanged),g.internalAssert(!this.wireframeChanged);const c=g.neighborCornerIndices.map((t=>e.findNeighborCornerTileExact(t,(t=>!t.intersectsClippingArea||t.loaded||t.level===e.level))??null)).map((e=>e?.intersectsClippingArea?e:null)),u=this.geometryState;for(let t=0;t<4;++t){const r=u.cornerPeerNeighbors[t],i=c[t];g.internalAssert(i===r,`Tile[${e.lij}].corner[${t}] out of date: cur=[${r?.lij}] exp=[${i?.lij}]`)}g.neighborEdgeIndices.forEach(((t,c)=>{if(r[c])return;const u=e.findNeighborTile(t,(e=>(e.level===s||e?.loaded)&&e?.intersectsClippingArea));if(!u){const r=!e.surface.updatingRootTiles&&null!=e.surface.rootTiles&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(t);return void g.internalAssert(!r)}g.internalAssert(u.loaded||u.level===e.level),g.internalAssert(u===this.geometryState.edgePeerNeighbors[c]);const d=s-u.level;if(!u.loaded)return g.internalAssert(!u.leaf),void g.internalAssert(0===d);const h=u.renderData;g.internalAssert(e.isEdgeNeighbor(u,t)),g.internalAssert(d>=0);const m=2**d;if(d<0)return void g.internalAssert(!1);const f=e.renderData,y=f.geometry,_=f.localOrigin,b=y.getEdgeCount(c),v=y.numVerticesPerSide-1,S=h.geometry;if(!S)return void g.internalAssert(!1);const w=h.localOrigin,x=this.geometryState.edgePeerNeighbors[c];if(x?.loaded){const e=x.renderData;g.internalAssert(f.geometryState.edgePeerNeighborSamplerVersions[c]===e.geometryState.samplerDataVersion),g.internalAssert(this.geometryState.edgePeerNeighborSamplerVersions[c]===e.geometryState.samplerDataVersion)}const T=(c+2)%4,A=S.getEdgeCount(T),I=b-1,D=A-1;g.internalAssert(I*m===D,`Tile[${e.lij}]:e${c},res=${I} edgeRes mismatch with Neighbor[${u.lij}]:e${T},res=${D} (expected:${I*m})`);const F=e.extent,L=t===p.NeighborIndex.NORTH||t===p.NeighborIndex.SOUTH,N=A-1,U=N>>d,V=b-1;if(U<1)return void g.internalAssert(1===V);g.internalAssert(U===V),g.internalAssert(i.isPowerOfTwo(U));const B=S.numVerticesPerSide-1;g.internalAssert(d>0||U===Math.max(B,v));const G=e.getNeighborEdgeStartVertexIndex(c,u);g.internalAssert(0<=G&&G<m);const k=G*U;g.internalAssert(0<=k&&k<=N-U);let z=0,j=k;y.getEdgeVertexPosition(c,C,_,0),y.getEdgeVertexPosition(c,P,_,b-1);const q=n.distance(C,P),H=Math.max(1,1e-4*q);for(let r=0;r<=U;++r){y.getEdgeVertexPosition(c,C,_,z),S.getEdgeVertexPosition(T,P,w,j);const i=r/U,s=L?F[0]+i*(F[2]-F[0]):t===p.NeighborIndex.WEST?F[0]:F[2],d=L?t===p.NeighborIndex.SOUTH?F[1]:F[3]:F[1]+i*(F[3]-F[1]),m=e.surface.extent;if(null==m||a.containsXY(m,s,d)){const t=n.dist(C,P),r=n.len(C)-l.earth.radius,i=n.len(P)-l.earth.radius,a=t<H;if(!a){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${c}[${z}/${b}] and [${u.lij}].edge${T}[${j}/${A}]`),null!=m&&console.warn("  surface extent= ",m," x,y=",s,",",d);const l=o.create();n.subtract(l,f.localOrigin,h.localOrigin),n.len(l)>0&&console.warn(`   localOrigins: ${f.localOrigin} vs ${h.localOrigin} d=${n.len(l)} [${l}]`),(()=>{const t=o.clone(C),r=o.clone(P);e.updateEdgeElevations(),u.updateEdgeElevations(),y.getEdgeVertexPosition(c,C,_,z),S.getEdgeVertexPosition(T,P,w,j);const i=o.create();n.sub(i,C,t),n.len(i)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${t} vs ${C} d=${n.len(i)} [${i}]`),n.sub(i,P,r),n.len(i)>0&&console.warn(`  XXX Neighbor[${u.lij}] edge out of date: ${r} vs ${P} d=${n.len(i)} [${i}]`)})();const p=y.getEdgeCount(c),v=S.getEdgeCount(A);g.internalAssert(a,`Mismatch in tile [${e.lij}].edge[${c}][${z}/${p}] vs neighbor [${u.lij}].edge[${T}][${j}/${v}] ${g.v32s(C)} vs ${g.v32s(P)}  dist=${t} h(t|n|d)=${r}|${i}|${i-r}`)}y.getEdgeNormal(c,M,z),S.getEdgeNormal(T,R,j),n.normalize(E,M),n.normalize(O,R);const p=n.dot(E,O),v=1-p<.01||e===u;if(!v){const t=o.create();n.sub(t,M,R);const r=()=>`Mismatch in tile edge normal ${g.lij2s(e.lij)} (${z}/${b-1}) edge ${c} vs neighbor ${g.lij2s(u.lij)}  (${j}/${A-1}) nedge ${T} :${g.v32s(M)} vs ${g.v32s(R)}  dot = ${p} : ${g.v32s(t)}`;console.warn("Mismatch in tile edge normal: ",r());{e.updateEdgeElevations(),u.updateEdgeElevations();const t=o.create(),r=o.create();y.getEdgeNormal(c,t,z),S.getEdgeNormal(T,r,j),n.equals(M,t)||console.warn("Missing update in tile normal: ",g.v32s(M)," => ",g.v32s(t)),n.equals(R,r)||console.warn("Missing update in neighbor normal: ",g.v32s(R)," => ",g.v32s(r))}g.internalAssert(v,r())}}z+=1,j+=1}}))}},e.neighborTileIfLoadedOrSelf=I,e.zeroToFour=D,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/GeometryState":function(){define(["exports"],(function(e){"use strict";e.GeometryState=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/PatchGeometry":function(){define(["exports","../../../core/maybe","../../../core/typedArrayUtil","../../../chunks/vec32","../../../geometry/support/aaBoundingBox","./terrainUtils","../webgl-engine/lib/Normals"],(function(e,t,r,i,s,n,o){"use strict";e.PatchGeometry=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=s.empty(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=t.releaseMaybe(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,s.empty(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,r,s){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,s),t),i.add(t,t,r)}getEdgeNormal(e,t,r){const{typedBuffer:i,typedBufferStride:s}=this.vertexAttributes.normalCompressed;o.decompressNormal(t,i,this.getEdgeAttributeIndex(e,r),s)}setEdgeNormalFromValues(e,t,r,i,s){this._setNormal(this.getEdgeAttributeIndex(e,t),r,i,s)}setEdgeVertexFromValuesRawPositionUV(e,t,r,i,s,n,o){const a=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(a,r,i,s),this._setUV(a,n,o)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,r,i,s,n,o,a,l,c){const u=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(u,r,i,s),this._setUV(u,n,o),this._setNormal(u,a,l,c)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,r,i){const{typedBuffer:s,typedBufferStride:n}=this.vertexAttributes.normalCompressed;o.compressNormal(s,e,t,r,i,n)}_setUV(e,t,i){this.vertexAttributes.uv0.setValues(e,Math.round(t*r.maxUint16),Math.round(i*r.maxUint16))}getEdgeAttributeIndex(e,t){return n.internalAssert(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Normals":function(){define(["exports","../../../../core/mathUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/FloatArray","../../../../geometry/support/ShortArray"],(function(e,t,r,i,s,n){"use strict";function o(e,t,r,i,s,n=2){const o=1/(Math.abs(r)+Math.abs(i)+Math.abs(s)),a=r*o,c=i*o,u=s<=0?(a>=0?1:-1)*(1-Math.abs(c)):a,d=s<=0?(c>=0?1:-1)*(1-Math.abs(a)):c,h=t*n;e[h]=l(u),e[h+1]=l(d)}function a(e,t,i,s=2){const n=i*s,o=c(t[n]),a=c(t[n+1]),l=1-Math.abs(o)-Math.abs(a);return e[2]=l,l<0?(e[0]=(o>=0?1:-1)*(1-Math.abs(a)),e[1]=(a>=0?1:-1)*(1-Math.abs(o))):(e[0]=o,e[1]=a),r.normalize(e,e)}function l(e){return t.clamp(Math.round(32767*e),-32767,32767)}function c(e){return t.clamp(e/32767,-1,1)}e.compressAndTransformNormals=function(e,t){const s=e.length/3,n=new Int16Array(2*s);let a=0;const l=i.create();for(let i=0;i<s;++i)l[0]=e[a++],l[1]=e[a++],l[2]=e[a++],r.transformMat3(l,l,t),o(n,i,l[0],l[1],l[2]);return n},e.compressNormal=o,e.compressNormals=function(e){const t=e.length/3,r=n.newShortArray(2*t);let i=0;for(let s=0;s<t;++s)o(r,s,e[i++],e[i++],e[i++]);return r},e.decodeInt16=c,e.decompressNormal=a,e.decompressNormals=function(e,t=2){const r=e.length/t,n=s.newFloatArray(3*r),o=i.create();let l=0;for(let i=0;i<r;++i)a(o,e,i,t),n[l++]=o[0],n[l++]=o[1],n[l++]=o[2];return n},e.encodeInt16=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/ShortArray":function(){define(["exports","../../core/typedArrayUtil"],(function(e,t){"use strict";e.compactShortArray=function(e){return Array.isArray(e)?e.length<t.nativeArrayMaxSize?e:new Int16Array(e):e.length<t.nativeArrayMaxSize?Array.from(e):e},e.newShortArray=function(e){return e<=t.nativeArrayMaxSize?new Array(e):new Int16Array(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TextureFader":function(){define(["exports","../../../core/maybe","./interfaces"],(function(e,t,r){"use strict";class i{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=t.destroyMaybe(this._current),this._next=t.destroyMaybe(this._next),this._waiting=t.destroyMaybe(this._waiting),this._delayed=t.destroyMaybe(this._delayed)}get current(){if(null==this._current)return null;if(!this._isFadingEnabled){let e=null;this._delayed?(e=this._delayed,this._delayed=null):this._waiting?(e=this._waiting,this._waiting=null):this._next&&(e=this._next,this._next=null),e&&(this.clear(),this._current=e)}let s=i.test.fadeMoment;if(this._delayed&&(s=s||performance.now(),s>=this._delayedTime&&(this._push(this._delayed,e.ActivationTime.Immediate),this._delayed=null)),this._next){s=s||performance.now();const e=this._fadeDuration,i=null!=this._current&&this._next.texture===this._current.texture,n=this._next.type!==r.TextureUpdate.FADING,o=s-this._fadeStart>=e;(i||n||o)&&(t.destroyMaybe(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(s))}return this._current}get next(){return this._next}get fadeFactor(){if(null==this._next)return 1;const e=i.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),r=this._fadeDuration;return t>r?0:1-t/r}get isFading(){return null!=this._next||null!=this._delayed}push(r,i=e.ActivationTime.Immediate){this._delayed=t.destroyMaybe(this._delayed),this._push(r,i)}_push(r,s){if(this._isFadingEnabled||this.clear(),null==this._current)return void(this._current=r);const n=i.test.fadeMoment||performance.now();return s!==e.ActivationTime.Immediate?(this._delayed=r,void(this._delayedTime=n+s)):null==this._next?(this._next=r,void(this._fadeStart=this._alignFadeStart(n))):void(null!=r&&(t.destroyMaybe(this._waiting),this._waiting=r))}get _fadeDuration(){const e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}static{this.test={fadeMoment:0}}}var s;e.ActivationTime=void 0,(s=e.ActivationTime||(e.ActivationTime={}))[s.Immediate=0]="Immediate",s[s.Delayed=5e3]="Delayed",e.TextureFader=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TextureReference":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t){"use strict";e.TextureReference=class{constructor(e,r,i,s,n,o){this.texture=e,this.type=r,this.offsetAndScale=i,e.retain(),this.opacities=t.fromValues(s,n,o)}destroy(){this.texture.release()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TileOverlayData":function(){define(["../../../core/libs/gl-matrix-2/factories/vec4f64"],(function(e){"use strict";return class{constructor(){this._scales=e.fromValues(-1,-1,-1,-1),this._offsets=e.fromValues(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,r){this._scales[2*e]=t,this._scales[2*e+1]=r}setOffset(e,t,r){this._offsets[2*e]=t,this._offsets[2*e+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}}}))},"esri/views/3d/terrain/tileUtils":function(){define(["exports","../../../core/PooledArray","./RenderOrder","./terrainUtils"],(function(e,t,r,i){"use strict";function s(e,t,r=()=>!0){if(t(e),!e.leaf&&r(e))for(const r of e.children)s(r,t)}function n(e,t){const r=e.lij,i=t.lij;return r[0]-i[0]||r[1]-i[1]||r[2]-i[2]}function o(e,t){const r=t.screenDepth-e.screenDepth;if(0!==r)return r;const i=e.lij,s=t.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function a(e,t){const r=e.screenDepth-t.screenDepth;if(0!==r)return r;const i=e.lij,s=t.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function l(e,t,r){const i=e.screenDepth,s=t.screenDepth;return i<s?-r:i>s?r:n(e,t)}function c(e,t,r,i){return u(e,i)===u(t,i)?l(e,t,r):e?r:-r}function u(e,t){for(const r of t)if(e.intersectsExtent(r))return!0;return!1}function d(e,t){const r=e.distanceToPOI-t.distanceToPOI;if(0!==r)return r;const i=e.lij,s=t.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}e.IteratorPostorder=class{constructor(){this._q=new t}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.leaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}},e.IteratorPreorder=class{constructor(){this._queue=new t,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e?.[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},e.compareTiles=l,e.compareTilesByLij=n,e.compareTilesWithStencil=c,e.computeUpsampleInfo=function(e,t,r){let i=1,s=0,n=0;for(;e!==t;)if(i*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),1&e.lij[1]||(n+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");r.init(t,s,n,i)},e.fallsWithinLayerView=function(e,t){if(null==t)return!1;const r=(s=t,i.isImageryTileLayerView(s)?{fullExtent:s.fullExtent,minScale:s.layer.minScale,maxScale:s.layer.maxScale}:s.layer);var s;if(null==r?.fullExtent)return!1;const n=r.fullExtent,o=e.extent;if(n.xmin>o[2]||n.ymin>o[3]||n.xmax<o[0]||n.ymax<o[1])return!1;const a=e.surface.tilingScheme.levels[e.level].scale,l=r.minScale;if(l>0&&a>1.00000001*l)return!1;const c=r.maxScale;return!(c>0&&a<.99999999*c)},e.getTileMapCache=function(e){return!i.isImageryTileLayerView(e)&&e.layer&&"tilemapCache"in e.layer?e.layer.tilemapCache:null},e.hasLoadableSiblings=function(e){for(let t=0;t<e.length;t++){const r=e[t],i=r.parent;if(i)for(let e=0;e<4;e++){const t=i.children[e];if(t&&t!==r)return!0}}return!1},e.sortTiles=function(e,t,i=null){null==i||0===i.length?e===r.RenderOrder.BACK_TO_FRONT?t.sort(o):t.sort(a):t.sort(((t,r)=>c(t,r,e,i)))},e.sortTilesByPOI=function(e,t){const r=e.length;for(let i=0;i<r;++i)e.at(i).updateDistanceToPOI(t);e.sort(d)},e.tilesAreRelated=function(e,t){if(!e||!t||e[0]===t[0])return!1;const r=e[0]<t[0],i=r?e:t,s=r?t:e,n=1<<s[0]-i[0];return Math.floor(s[1]/n)===i[1]&&Math.floor(s[2]/n)===i[2]},e.traverseTilesPreorder=function(e,t,r=()=>!0){if(Array.isArray(e))for(let i=0;i<e.length;i++)s(e[i],t,r);else s(e,t,r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/RenderOrder":function(){define(["exports"],(function(e){"use strict";var t;e.RenderOrder=void 0,(t=e.RenderOrder||(e.RenderOrder={}))[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT",t[t.NONE=0]="NONE",t[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/TerrainTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/basicInterfaces","../lib/StencilUtils","../lib/VertexAttribute","../../../../chunks/Terrain.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(a.Terrain,(()=>new Promise(((t,r)=>e(["./Terrain.glsl"],t,r))))),d),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:r,output:o}=e,a=e.backfaceCullingEnabled&&!r;return c.makePipelineState({blending:r?c.premultipliedAlpha:null,culling:a?c.backFaceCullingParams:null,depthTest:r?null:{func:l.CompareFunction.LESS},depthWrite:r?null:c.defaultDepthWrite,colorWrite:c.defaultColorWrite,stencilTest:t?n.renderWhenBitIsNotSet(s.StencilBits.IntegratedMeshMaskExcluded):null,drawBuffers:i.depthOnlyOutputBuffersOr(o)})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}}const d=new Map([[o.VertexAttribute.POSITION,0],[o.VertexAttribute.UV0,1],[o.VertexAttribute.NORMALCOMPRESSED,2]]);t.TerrainTechnique=u,t.vertexAttributeLocations=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Terrain.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/terrain/OverlayContent","../views/3d/terrain/TransparencyMode","../views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexTangent.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlightOverlay","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientOcclusion.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/NormalUtils.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/Overlay.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/TerrainTexture.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4DrawUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/lib/VertexAttribute","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I){"use strict";class D extends T.OverlayTerrainPassParameters{}function F(e){const r=new A.ShaderBuilder,{attributes:s,vertex:D,fragment:F,varyings:U}=r;s.add(O.VertexAttribute.POSITION,"vec3"),r.include(d.NormalAttribute,e),r.include(h.TextureCoordinateAttribute,e);const V=()=>{r.include(v.NormalUtils,e),D.code.add(M.glsl`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};C.addProjViewLocalOrigin(D,e),r.include(u.Transform,e);const{output:B,pbrMode:G,overlayMode:k,tileBorders:z,spherical:j,transparencyMode:q,screenSizePerspective:H,overlayEnabled:W}=e,$=q===o.TransparencyMode.InvisibleWithDraped||q===o.TransparencyMode.Invisible,Q=W&&$;switch(B){case l.ShaderOutput.ColorEmission:case l.ShaderOutput.Color:{r.include(T.TerrainTexture,e),r.include(_.EvaluateSceneLighting,e),W&&(e.pbrMode=G===S.PBRMode.Simplified?S.PBRMode.TerrainWithWater:S.PBRMode.Water,r.include(x.OverlayTerrain,e),e.pbrMode=G);const s=k===x.OverlayMode.EnabledWithWater;s&&r.include(p.VertexTangent,e),U.add("vnormal","vec3"),U.add("vpos","vec3",{invariant:!0}),U.add("vup","vec3"),V(),H&&C.addViewNormal(D);const o=e.receiveShadows&&!e.renderOccluded;o&&r.include(a.ForwardLinearDepth,e),H&&(U.add("screenSizeDistanceToCamera","float"),U.add("screenSizeCosAngle","float")),D.main.add(M.glsl`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${M.If(s,M.glsl`forwardVertexTangent(vnormal);`)}

          forwardTextureCoordinatesWithTransform(uv0);
          ${M.If(W,"setOverlayVTC(uv0);")}
          ${M.If(z,"forwardTextureCoordinates();")}
          ${M.If(H,M.glsl`vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
                 screenSizeDistanceToCamera = length(viewPos);
                 vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
                 screenSizeCosAngle = abs(viewSpaceNormal.z);`)}
          ${M.If(o,"forwardLinearDepth();")}`),F.include(c.SliceDraw,e),r.include(_.EvaluateSceneLighting,e),F.include(y.EvaluateAmbientOcclusion,e),r.include(w.ReadShadowMapDraw,e),C.addCameraPosition(F,e),_.addAmbientBoostFactor(F),_.addLightingGlobalFactor(F),F.uniforms.add(D.uniforms.get("localOrigin"),new P.Float3BindUniform("viewDirection",(({camera:e})=>i.normalize(N,i.set(N,e.viewMatrix[12],e.viewMatrix[13],e.viewMatrix[14]))))),s&&F.uniforms.add(new E.Texture2DBindUniform("ovWaterTex",(e=>e.overlay?.getTexture(n.OverlayContent.WaterNormal))),new R.Matrix4DrawUniform("view",(({origin:e},{camera:r})=>t.translate(L,r.viewMatrix,e))));const l=.2;F.code.add(M.glsl`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),b.addMainLightDirection(F),b.addMainLightIntensity(F),F.main.add(M.glsl`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${o?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":j?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${M.If(W,M.glsl`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${M.If($,`if (overlayColor.a < ${M.glsl.float(I.alphaCutoff)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${M.glsl.float(I.alphaCutoff)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${M.glsl.float(l)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${G===S.PBRMode.Simplified||G===S.PBRMode.TerrainWithWater?M.glsl`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:M.glsl`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${M.If(s,M.glsl`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${M.glsl.float(l)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${M.If(H,M.glsl`float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0));
                   if (perspectiveScale <= 0.25) {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
                   } else if (perspectiveScale <= 0.5) {
                     fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
                   } else if (perspectiveScale >= 0.99) {
                     fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
                   } else {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
                   }`)}
          ${M.If(e.visualizeNormals,j?M.glsl`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:M.glsl`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${M.If(z,M.glsl`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = applySlice(fragColor, vpos);`)}break;case l.ShaderOutput.Depth:Q&&r.include(x.OverlayTerrain,e),D.main.add(M.glsl`
        ${M.If(Q,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),F.main.add(`${M.If(Q,`if (getCombinedOverlayColor().a < ${M.glsl.float(I.alphaCutoff)}) discard;`)}`);break;case l.ShaderOutput.Shadow:case l.ShaderOutput.ShadowHighlight:case l.ShaderOutput.ShadowExcludeHighlight:case l.ShaderOutput.ViewshedShadow:r.include(m.OutputDepth,e),a.addLinearDepth(r),a.addNearFar(r),D.main.add(M.glsl`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),F.main.add(M.glsl`outputDepth(linearDepth);`);break;case l.ShaderOutput.Normal:Q&&r.include(x.OverlayTerrain,e),U.add("vnormal","vec3"),C.addViewNormal(D),V(),D.main.add(M.glsl`
        ${M.If(Q,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),F.main.add(M.glsl`
        ${M.If(Q,`if (getCombinedOverlayColor().a < ${M.glsl.float(I.alphaCutoff)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case l.ShaderOutput.Highlight:W&&(r.include(x.OverlayTerrain,e),r.include(g.OutputHighlightOverlay,e)),D.main.add(M.glsl`
        ${M.If(W,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),r.include(f.OutputHighlight,e),F.main.add(M.glsl`
        ${M.If(W,M.glsl`
           calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(B===l.ShaderOutput.ObjectAndLayerIdColor)if(W)e.pbrMode=S.PBRMode.Disabled,r.include(x.OverlayTerrain,e),e.pbrMode=G,D.main.add(M.glsl`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(uv0);`),F.main.add(M.glsl`fragColor = getOverlayColorTexel();`);else{const e=q===o.TransparencyMode.Opaque;D.main.add(M.glsl`${M.If(e,"gl_Position = transformPosition(proj, view, position);")}`),F.main.add(M.glsl`fragColor = vec4(0.0);`)}return r}const L=r.create(),N=s.create(),U=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:D,build:F},Symbol.toStringTag,{value:"Module"}));e.Terrain=U,e.TerrainPassParameters=D,e.build=F}))},"esri/views/3d/terrain/TransparencyMode":function(){define(["exports"],(function(e){"use strict";var t;e.TransparencyMode=void 0,(t=e.TransparencyMode||(e.TransparencyMode={}))[t.Opaque=0]="Opaque",t[t.Transparent=1]="Transparent",t[t.InvisibleWithDraped=2]="InvisibleWithDraped",t[t.Invisible=3]="Invisible",t[t.COUNT=4]="COUNT",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/attributes/VertexTangent.glsl":function(){define(["exports","../../shaderModules/glsl"],(function(e,t){"use strict";e.VertexTangent=function(e,r){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),r.spherical?e.vertex.code.add(t.glsl`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(t.glsl`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(t.glsl`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlightOverlay":function(){define(["exports","../ShaderOutput","./OutputHighlight.glsl","../../shaderModules/glsl"],(function(e,t,r,i){"use strict";e.OutputHighlightOverlay=function(e,s){s.output===t.ShaderOutput.Highlight&&(e.include(r.OutputHighlight,s),e.fragment.code.add(i.glsl`
    void calculateOcclusionAndOutputHighlight(uvec2 highlightToAdd) {
      uint levelBits = readLevelBits(highlightToAdd, highlightLevel);
      if ((levelBits & 1u) == 0u) discard;
      outputHighlight(isHighlightOccluded());
    }
  `))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/NormalUtils.glsl":function(){define(["exports","../../shaderModules/glsl"],(function(e,t){"use strict";e.NormalUtils=function(e,r){r.spherical?e.vertex.code.add(t.glsl`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(t.glsl`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),r.spherical?e.vertex.code.add(t.glsl`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(t.glsl`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/TerrainTexture.glsl":function(){define(["exports","../shading/ReadShadowMap.glsl","./BackgroundGrid.glsl","./TileBlendInput","../../shaderModules/glsl","../../../../../webgl/Uniform"],(function(e,t,r,i,s,n){"use strict";class o extends t.ReadShadowMapPassParameters{constructor(){super(...arguments),this.overlayOpacity=1}}class a extends n.Uniform{constructor(e){super(e,"float")}}class l extends n.Uniform{constructor(e){super(e,"vec3")}}class c extends n.Uniform{constructor(e){super(e,"vec4")}}class u extends n.Uniform{constructor(e){super(e,"sampler2D")}}e.Float3Uniform=l,e.OverlayTerrainPassParameters=o,e.TerrainTexture=function(e,t){const{vertex:n,fragment:o,varyings:d}=e;d.add("vtc","vec2"),n.uniforms.add(new c("texOffsetAndScale")),o.uniforms.add(new u("tex")),o.uniforms.add(new l("textureOpacities"));const h=t.textureFadingEnabled&&!t.renderOccluded;h&&(n.uniforms.add(new c("nextTexOffsetAndScale")),d.add("nvtc","vec2"),o.uniforms.add(new u("texNext")),o.uniforms.add(new l("nextTexOpacities")),o.uniforms.add(new a("fadeFactor")));const p=t.tileBlendInput===i.TileBlendInput.ColorComposite,m=t.tileBlendInput===i.TileBlendInput.GridComposite;m&&o.include(r.BackgroundGrid),p&&o.uniforms.add(new l("backgroundColor")),n.code.add(s.glsl`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = texOffsetAndScale.xy + uv * texOffsetAndScale.zw;
    ${s.If(h,"nvtc = nextTexOffsetAndScale.xy + uv * nextTexOffsetAndScale.zw;")}
  }`),o.code.add(s.glsl`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${s.If(m||p,s.glsl`if (opacities.y <= 0.0) {
           return color * opacities.z * opacities.x;
         }
         vec4 bg = vec4(${p?s.glsl`backgroundColor`:s.glsl`gridColor(uv)`} * opacities.y, opacities.y);
         vec4 layer = color * opacities.z;
         return (bg * (1.0 - layer.a) + layer) * opacities.x;`,"return color;")}
    }`),h?o.code.add(s.glsl`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):o.code.add(s.glsl`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)},e.Texture2DUniform=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/BackgroundGrid.glsl":function(){define(["exports","../../shaderModules/glsl"],(function(e,t){"use strict";e.BackgroundGrid=function(e){e.code.add(t.glsl`
    float lineFactorAtPosition(float value) {
      float pos = value * ${t.glsl.float(257)};
      if(pos < 0.5 || pos > ${t.glsl.float(256.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/TileBlendInput":function(){define(["exports"],(function(e){"use strict";var t;e.TileBlendInput=void 0,(t=e.TileBlendInput||(e.TileBlendInput={}))[t.LayerOnly=0]="LayerOnly",t[t.ColorComposite=1]="ColorComposite",t[t.GridComposite=2]="GridComposite",t[t.COUNT=3]="COUNT",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/Tile":function(){define(["exports","../../../core/mathUtils","../../../core/maybe","../../../core/ObjectPool","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/support/aaBoundingRect","../../../chunks/sphere","../../../layers/support/layerUtils","./ElevationBounds","./ElevationTileAgent","./interfaces","./LayerClass","./MapTileAgent","./NeighborIndex","./TerrainConst","./TerrainData","./terrainUtils","./TileAgent","./TileFrustumVisibility","./TilePerLayerInfo","./TileUpdate","./tileUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x){"use strict";function T(e,t,r,i){const s=r===p.LayerClass.ELEVATION?M.acquire():P.acquire();return s.init(e,t,r,i),s}function C(e){e.dispose(),d.isElevationTileAgent(e)?M.release(e):m.isMapTileAgent(e)&&P.release(e)}const P=new i(m.MapTileAgent),M=new i(d.ElevationTileAgent),R=new u.ElevationBounds;var E;function O(e,t){const r=e.lij,i=t[0]-r[0];return!(i<0)&&t[1]>>i===r[1]&&t[2]>>i===r[2]}function A(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function I(e,t,r){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?D(e,t,r):D(t,e,_.oppositeCorner(r)))}function D(e,t,r){_.internalAssert(e.level>=t.level);const i=_.isWestCorner(r),s=_.isNorthCorner(r),n=e.extent,o=t.extent,a=[i?n[0]:n[2],s?n[3]:n[1]],l=[i?o[2]:o[0],s?o[1]:o[3]],c=1e-5*(n[2]-n[0]),u=_.almostEquals(a[0],l[0],c)||e.surface.isGlobal&&_.almostEquals(a[0],-l[0],c),d=_.almostEquals(a[1],l[1],c);if(u&&d)return!0;if(e.level===t.level)return _.internalAssert(!1),!1;if(!u&&!d)return _.internalAssert(!1),!1;const h=u?F(o[1],o[3],n[1],n[3],c):F(o[0],o[2],n[0],n[2],c);return _.internalAssert(h),h}function F(e,t,r,i,s){return e-s<=r&&r<=i&&i<=t+s}e.CenterPosition=void 0,(E=e.CenterPosition||(e.CenterPosition={}))[E.TOP=0]="TOP",E[E.MIDDLE=1]="MIDDLE",E[E.BOTTOM=2]="BOTTOM";const L=n.create(),N=n.create(),U=n.create(),V=n.create();e.Tile=class{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=a.create(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=a.create(),this.centerAtSeaLevel=n.create(),this._center=[n.create(),l.create(),n.create()],this.up=n.unitZ(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.onCompressionFinished=()=>{this.setPendingUpdate(w.TileUpdate.TEXTURE_NOFADING),this.setMemoryDirty()},this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=n.create(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get spatialReference(){return this._surface.spatialReference??this._surface.tilingScheme.spatialReference}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){P.prune(0),M.prune(0),S.TilePerLayerInfo.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[e.CenterPosition.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=e?.frustumVisibility??v.TileFrustumVisibility.INTERSECTS;this._frustumVisibility=t===v.TileFrustumVisibility.INSIDE?v.TileFrustumVisibility.INSIDE:t===v.TileFrustumVisibility.OUTSIDE?v.TileFrustumVisibility.OUTSIDE:this._calculateFrustumVisibility(this.surface.frustum);const r=this._frustumVisibility!==v.TileFrustumVisibility.OUTSIDE&&this._intersectsClippingArea;r!==this._visible&&(this._visible=r,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(t,r,i,s,n){this._lij[0]=t,this._lij[1]=r,this._lij[2]=i,this.ellipsoid=o.getReferenceEllipsoid(n.tilingScheme.spatialReference),n.tilingScheme.getExtent(t,r,i,this.extent),n.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,n.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[e.CenterPosition.MIDDLE][3]=0,this.elevationLevel=t,s&&!Number.isNaN(s.elevationBoundsMin)?(this._elevationBoundsMin=s.elevationBoundsMin,this._elevationBoundsMax=s.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=s,this.clearChildren(),this._surface=n,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const e of p.LayerClasses){const t=n.numLayers(e),r=this.layerInfo[e];for(const e of r)e.release();r.length=t;for(let i=0;i<t;i++)r[i]=S.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool),e===p.LayerClass.ELEVATION&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(n.tilingScheme.pixelSize,g.maxPatchTesselation)}dispose(){null!=this._surface&&(_.weakAssert(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key),this.layerInfo.forEach((e=>{e.forEach((e=>e.release())),e.length=0})),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty())}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,this)}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get cachedMemory(){return this._ensureUsedMemory(),null==this._surface?this.usedMemory:this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[p.LayerClass.MAP].reduce(((e,{data:t})=>e+(y.isVectorTile(t)?t.usedMemoryPerReference:0)),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:e}of this.layerInfo[p.LayerClass.MAP])y.isVectorTile(e)?this._vectorTileMemory+=e.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(e);for(const e of this.layerInfo[p.LayerClass.ELEVATION])this._usedMemory+=e.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.cachedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this),this._usedMemory}getUsedMemoryForLayer(e,t){const r=this.layerInfo[e][t];return r?.data?e===p.LayerClass.MAP?this._cached?0:this.getTerrainDataMemory(r.data):e===p.LayerClass.ELEVATION?this._cpuImageMemorySize:0:0}getTerrainDataMemory(e){return y.isTileTexture(e)?e.texture.usedMemory:y.isRasterTile(e)?e.memoryUsage:y.isVectorTile(e)?e.usedMemoryPerReference:y.isImageWithType(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(t){const r=this._center[e.CenterPosition.MIDDLE],i=t,s=r[0],n=r[1],o=r[2],a=i[2]*s+i[6]*n+i[10]*o+i[14];this.screenDepth=a<0?0:a/(i[3]*s+i[7]*n+i[11]*o+i[15])}shouldSplit(t,r,i){if(!this.visible)return w.TileUpdate.NONE;if(t.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibility(t.frustum)===v.TileFrustumVisibility.OUTSIDE))return w.TileUpdate.NONE;const n=this.level;s.subtract(L,l.getCenter(this._center[e.CenterPosition.MIDDLE]),r);let o=s.squaredLength(L),a=L,c=l.getCenter(this._center[e.CenterPosition.MIDDLE]);s.subtract(N,this._center[e.CenterPosition.TOP],r);const u=s.squaredLength(N);u<o&&(o=u,a=N,c=this._center[e.CenterPosition.TOP]),s.subtract(U,this._center[e.CenterPosition.BOTTOM],r);const d=s.squaredLength(U);if(d<o&&(o=d,a=U,c=this._center[e.CenterPosition.BOTTOM]),this._edgeLen2>o&&n<t.maxLod)return w.TileUpdate.SPLIT;const h=Math.sqrt(o),p=t.fovX*h*2,m=this._edgeLen/p,f=()=>{if(n<t.maxLod)return this.elevationLevel=n,w.TileUpdate.NONE;const e=n+Math.ceil(-Math.log2(t.relativeWidthLimit/m));return e!==this.elevationLevel?(this.elevationLevel=e,w.TileUpdate.ELEVATION):w.TileUpdate.NONE},g=null!=i?i-n:1/0;if(g<=.5)return f();const y=s.dot(this.up,L),_=this._elevationBoundsMax-this._elevationBoundsMin,b=_/this.edgeLen;if(t.aboveGround&&y>0&&b<.001&&y/h-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-b>0)return w.TileUpdate.NONE;const S=null!=i?3-Math.min(g,2):1;if(m*S<t.relativeWidthLimit||n>=t.maxLod)return f();if(n<7)return w.TileUpdate.SPLIT;s.scale(V,this.up,y),s.subtract(V,V,a);const x=s.squaredLength(V);if(x<=this.radius*this.radius)return w.TileUpdate.SPLIT;s.scale(V,V,this.radius/Math.sqrt(x)),s.add(V,V,c),s.subtract(V,r,V);const T=Math.min(1,(Math.abs(s.dot(V,this.up))+.5*_+this._curvatureHeight)/s.length(V)),C=.1/t.angledSplitBias,P=t.fovY*h*2;return T*(this._edgeLen/P*S)<C*t.relativeHeightLimit?w.TileUpdate.NONE:w.TileUpdate.SPLIT}createChildren(){const e=this._children,t=this.lij[0]+1,r=2*this.lij[1],i=2*this.lij[2];return e[0]=this.surface.createTile(t,r,i,this),e[1]=this.surface.createTile(t,r,i+1,this),e[2]=this.surface.createTile(t,r+1,i,this),e[3]=this.surface.createTile(t,r+1,i+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of p.LayerClasses)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(const e of p.LayerClasses){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==b.tileAgentDone&&(C(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(w.TileUpdate.GEOMETRY),this.resetPendingUpdate(w.TileUpdate.TEXTURE_NOFADING),this.resetPendingUpdate(w.TileUpdate.TEXTURE_FADING)}unloadMapData(){const e=this.layerInfo[p.LayerClass.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==b.tileAgentDone&&(C(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0,t.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(a.equals(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,r=this._withinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const i=r&&this._withinClippingArea,s=!(r||t||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||i||s||this.setPendingUpdate(w.TileUpdate.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const r=this.layerInfo[t][e];return!(!r?.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of p.LayerClasses){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==b.tileAgentDone&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(w.TileUpdate.SPLIT)||e!==p.LayerClass.ELEVATION&&!this._loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===w.TileUpdate.SPLIT||e===w.TileUpdate.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const s=this.layerInfo[t][e];if(s.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(s.waitingAgents.push(i),s.data&&!s.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const r=y.isVectorTile(s.data);return i.dataArrived(this,r),!0}if(s.requestPromise)return!0;r.abortMaybe(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,t,s.requestAbort);if(!n)return s.requestAbort=null,!1;const o=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(o,o),!0}get leaf(){return null==this._children[0]}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(t){return s.squaredLength(s.subtract(V,l.getCenter(this._center[e.CenterPosition.MIDDLE]),t))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const r=this.extent;return e>=r[0]&&t>=r[1]&&e<=r[2]&&t<=r[3]}unrequestLayerData(e,t,r){const i=this.layerInfo[t][e],s=i.waitingAgents,n=null!=s.removeUnordered(r);_.weakAssert(n,"agent has not requested this piece of map data"),s.length<1&&(i.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,r){const i=y.isVectorTile(r),s=this.layerInfo[t][e];s.data=r,s.dataInvalidated=!1,s.waitingAgents.forAll((e=>e.dataArrived(this,i))),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const r=this.layerInfo[t][e];r.dataMissing=!0,r.waitingAgents.forAll((e=>e.dataMissing())),r.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,r){switch(r&&this.forEachLoadedNeighbor((r=>r.updateRenderData(e,t))),e){case p.LayerClass.MAP:return this._updateTexture(t);case p.LayerClass.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===h.TextureUpdate.FADING?w.TileUpdate.TEXTURE_NOFADING:w.TileUpdate.TEXTURE_FADING),this.setPendingUpdate(e===h.TextureUpdate.FADING?w.TileUpdate.TEXTURE_FADING:w.TileUpdate.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(w.TileUpdate.GEOMETRY);for(const e of this.layerInfo[p.LayerClass.ELEVATION])e.pendingUpdates|=w.TileUpdate.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let r=1/0,i=-1/0;const s=this.layerInfo[p.LayerClass.ELEVATION];let n=!0;for(const e of s)null!=e.elevationBounds&&(r=Math.min(r,e.elevationBounds.min),i=Math.max(i,e.elevationBounds.max),e.elevationBounds.hasNoDataValues||(n=!1));n&&(r=Math.min(r,0),i=Math.max(i,0)),e===r&&t===i||(this._elevationBoundsMin=r,this._elevationBoundsMax=i,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const t=this._elevationBoundsMin,r=this._elevationBoundsMax,i=.5*(t+r),n=this._center;s.scale(V,this.up,i),s.add(l.getCenter(n[e.CenterPosition.MIDDLE]),this.centerAtSeaLevel,V),s.scale(V,this.up,t),s.add(n[e.CenterPosition.TOP],this.centerAtSeaLevel,V),s.scale(V,this.up,r),s.add(n[e.CenterPosition.BOTTOM],this.centerAtSeaLevel,V)}findElevationBoundsForLayer(e,t){const r=this.layerInfo[p.LayerClass.ELEVATION][e],i=this.elevationLevelDelta,s=Math.max(this.elevationLevel-i,0),n=r.elevationBounds;if(null!=n&&n.level>=t&&n.level<=s)return;const o=this._surface.layerViewByIndex(e,p.LayerClass.ELEVATION);if(!x.fallsWithinLayerView(this,o))return;const a=R;let l=!1;const c=r.data;if(c&&c.level<=s){const e=r.data;a.min=e.samplerData.data.minValue,a.max=e.samplerData.data.maxValue,a.hasNoDataValues=e.samplerData.data.hasNoDataValues,a.level=this.level,l=!0}else{let t,r,n=0;for(let o=this._parent;o&&(!r||n<i)&&(n=this.elevationLevel-o.level,t=r||t,r=o.layerInfo[p.LayerClass.ELEVATION][e].data,!(!r&&t&&o.level<=s));o=o.parent);r=r||t,r&&(r.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],a),a.min!==1/0&&(a.level=r.level,l=!0))}l&&(null==r.elevationBounds&&(r.elevationBounds=new u.ElevationBounds),r.elevationBounds.copyFrom(a))}modifyLayers(e,t,r){const i=this.layerInfo[r];for(const e of i)e.loadingAgent&&e.loadingAgent!==b.tileAgentDone&&(C(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<i.length;++t)void 0===e[t]&&i[t].release();const s=new Array(...i),n=t.length;i.length=n;for(let e=0;e<n;e++){const r=t[e];i[e]=r>-1?s[r]:S.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,h.TextureUpdate.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===b.tileAgentDone&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of p.LayerClasses){const t=this._isSuspended(e);for(const r of this.layerInfo[e])r.loadingAgent&&r.loadingAgent!==b.tileAgentDone&&(r.loadingAgent.setSuspension(t),r.loadingAgent===b.tileAgentDone&&this.updateRenderData(e,h.TextureUpdate.FADING))}}removeLayerAgent(e,t){const r=this.layerInfo[t][e];r.loadingAgent&&r.loadingAgent!==b.tileAgentDone&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(e,t){const r=this.layerInfo[t][e];r.loadingAgent=b.tileAgentDone,r.data||null!=r.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||c.isGroupLayer(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,r){for(let i=e;i<t;++i){const e=this._surface.layerViewByIndex(i,r);if(_.isBlendableLayerView(e)&&"normal"!==e?.layer?.blendMode||c.isGroupLayer(e?.layer?.parent)&&this._hasBlendableAncestor(e?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,t){const r=this.layerInfo[t];if(0===r.length)return;const i=this._isSuspended(t);for(let s=e;s<r.length;++s){const n=r[s],o=this._surface.layerViewByIndex(s,t);let a=!1;if(n.loadingAgent?x.fallsWithinLayerView(this,o)?(n.loadingAgent!==b.tileAgentDone&&n.loadingAgent.setSuspension(i),n.loadingAgent!==b.tileAgentDone&&(a=n.loadingAgent.update())):n.dispose():x.fallsWithinLayerView(this,o)&&(n.loadingAgent=T(this,s,t,i),a=n.loadingAgent.startLoading(),a?n.loadingAgent===b.tileAgentDone&&this.setPendingUpdate(w.TileUpdate.GEOMETRY):(C(n.loadingAgent),n.loadingAgent=b.tileAgentDone)),n.loadingAgent===b.tileAgentDone&&this.updateRenderData(t,h.TextureUpdate.FADING),!this._hasBlendModes(e,r.length,t)&&a&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const r=this.elevationLevel-this.level,i=Math.max(this.level-e,this.elevationLevelDelta-r),s=t.clamp(1+(this._maxTesselation>>i),2,this._maxTesselation+1),n=this.minimumVerticesPerSide;return Math.max(s,n)}_findLIJ(e,t){if(!e)return null;const r=this.surface.rootTiles;if(null!=r)for(const i of r)if(O(i,e)){let r=i,s=e[0]-r.level-1;for(;s>=0&&!r.leaf&&!t(r);){const t=e[1]>>s&1,i=e[2]>>s&1;r=r.children[2*t+i],s--}return t(r)?r:null}return null}findNeighborTile(e,t){const r=this._lij,i=this._getNeighborLIJ(r,e);return i?A(r,i)?t(this)?this:null:this._findLIJ(i,t):null}findCorner(e,t){const r=e===f.NeighborIndex.NORTH_EAST?1:e===f.NeighborIndex.NORTH_WEST?0:e===f.NeighborIndex.SOUTH_WEST?2:3;let i=this;for(;i.children[0]&&(!t||!t(i));)i=i.children[r];return i}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,(e=>t(e)||e.level===this.level))?.findCorner(_.oppositeCorner(e),t)||null}forAllSubtreeOnSide(e,t){const r=e===f.NeighborIndex.NORTH?[0,1]:e===f.NeighborIndex.NORTH_EAST?[1]:e===f.NeighborIndex.EAST?[1,3]:e===f.NeighborIndex.SOUTH_EAST?[3]:e===f.NeighborIndex.SOUTH?[2,3]:e===f.NeighborIndex.SOUTH_WEST?[2]:e===f.NeighborIndex.WEST?[0,2]:[0],i=e=>{const s=e.children;!t(e)&&s[0]&&r.forEach((e=>i(s[e])))};i(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const r=this.level-t.level;if(_.internalAssert(!_.enableTerrainInternalChecks||r>=0),0===r)return 0;const i=2**r,s=!(1&~e),n=s?0:1,o=t.lij[n+1]*i,a=this._lij[n+1],l=a-o,c=s?i-1-l:l;return _.enableTerrainInternalChecks&&(_.internalAssert(o<=a&&a<o+i),_.internalAssert(0<=c&&c<i)),c}forEachLoadedNeighbor(e){const t=this.level,r=e=>e.level===t||e.loaded;_.neighborEdgeIndices.forEach((t=>{const i=this.findNeighborTile(t,r);null!=i&&i!==this&&i.forAllSubtreeOnSide(_.oppositeEdge(t),(r=>!!r.loaded&&(e(r,t),!0)))})),_.neighborCornerIndices.forEach((t=>{const i=this.findNeighborTile(t,r)?.findCorner(_.oppositeCorner(t),(e=>e.loaded));_.internalAssert(!i||I(this,i,t)),i?.loaded&&e(i,t)}))}_getNeighborLIJ(e,t){const r=_.isNorth(t)?-1:_.isSouth(t)?1:0,i=_.isWest(t)?-1:_.isEast(t)?1:0,s=[e[0],e[1]+r,e[2]+i];return s[1]<0?null:this.surface.isGlobal?this._wrapLIJ(s):s[2]<0?null:s}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,t){if(null==e)return!1;if(0===this.level&&0===e.level){if(this._eastEnd&&e._westEnd&&t===f.NeighborIndex.EAST)return!0;if(this._westEnd&&e._eastEnd&&t===f.NeighborIndex.WEST)return!0}const r=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(t){case f.NeighborIndex.NORTH:return _.almostEquals(this.extent[3],e.extent[1],r);case f.NeighborIndex.SOUTH:return _.almostEquals(this.extent[1],e.extent[3],r);case f.NeighborIndex.EAST:return _.almostEquals(this.extent[2],e.extent[0],r)||_.almostEquals(this.extent[2],-e.extent[0],r);case f.NeighborIndex.WEST:return _.almostEquals(this.extent[0],e.extent[2],r)||_.almostEquals(this.extent[0],-e.extent[2],r)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return 0===this._lij[2]}checkGeometryWaterproofness(){_.enableWaterproofTests&&(_.internalAssert(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,r=this.surface.rootTilesExtent,i=.25*(t[2]-t[0]);if(_.isNorth(e)&&t[3]+i>=r[3])return!1;if(_.isSouth(e)&&t[1]-i<=r[1])return!1;const s=this.surface.isGlobal;return!(!s&&_.isWest(e)&&t[0]-i<=r[0]||!s&&_.isEast(e)&&t[2]+i>=r[2])}updateDistanceToPOI(t){const r=this._lastPOI;if(this.distanceToPOI>=0&&r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2])return;s.copy(this._lastPOI,t);const i=this._center[e.CenterPosition.MIDDLE],n=t[0]-i[0],o=t[1]-i[1],a=t[2]-i[2];this.distanceToPOI=n*n+o*o+a*a}},e.isCornerNeighbor=I,e.lijEquals=A,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/ElevationTileAgent":function(){define(["exports","./TileAgent"],(function(e,t){"use strict";class r extends t.TileAgent{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}e.ElevationTileAgent=r,e.isElevationTileAgent=function(e){return"elevation"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TileAgent":function(){define(["exports","../../../core/has","./interfaces","./TerrainConst","./tileUtils"],(function(e,t,r,i,s){"use strict";class n{get updating(){return!!this._tileRequested}init(e,t,r,i){this.tile=e,this._layerIdx=t,this._layerClass=r,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,r),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,r.TextureUpdate.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,r=this.tile.surface.layerViewByIndex(e,t),{minLevel:n,maxLevel:o}=r.dataLevelRange,a=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+a,c=this._scaleRangeEnabled?s.fallsWithinLayerView:()=>!0;let u=this.tile;const d=u.level;let h;const p=this._tileLayerInfo.upsampleInfo,m=p?.tile?.level??-1,f=null!=p&&m-d>=a,g=s.getTileMapCache(r),y="vector-tile-3d"===r.type?r.schemaHelper:null;for(;u&&c(u,r)&&u.level>=n;){const r=u.level,s=d-r,c=u.layerInfo[t][e];if(c.data&&s>=a){(!f||r>m)&&this._setUpsampleTile(u),c.dataInvalidated&&(h=u);break}const p=y?.getLevelRowColumn(u.lij)??u.lij;if("unavailable"!==g?.getAvailability(p[0],p[1],p[2])&&r<=o&&!c.data&&!c.dataMissing&&((!h||u.level===n||r%i.progressiveLoadingModulo===0||d-h.level<a)&&(h=u),s>=l))break;u=u.parent}if(null!=h&&d-h.level<a)if(p)h=null;else{const r=this._findAncestorWithData();null!=r&&(this._setUpsampleTile(r),h=r.layerInfo[t][e].dataInvalidated?r:null)}return h}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let r;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;r=i}return r}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,r.TextureUpdate.FADING,t)}get test(){}}const o=new Error("Abstract method called on TileAgent"),a=new class extends n{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw o}get _progressiveLevelModulo(){throw o}dispose(){}};e.TileAgent=n,e.tileAgentDone=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/MapTileAgent":function(){define(["exports","./TerrainConst","./TileAgent"],(function(e,t,r){"use strict";class i extends r.TileAgent{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return t.progressiveLoadingModulo}}e.MapTileAgent=i,e.isMapTileAgent=function(e){return"map"===e.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TileFrustumVisibility":function(){define(["exports"],(function(e){"use strict";var t;e.TileFrustumVisibility=void 0,(t=e.TileFrustumVisibility||(e.TileFrustumVisibility={}))[t.INSIDE=0]="INSIDE",t[t.INTERSECTS=1]="INTERSECTS",t[t.OUTSIDE=2]="OUTSIDE",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TilePerLayerInfo":function(){define(["exports","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","./terrainUtils","./tileUtils"],(function(e,t,r,i,s,n){"use strict";class o{constructor(){this.waitingAgents=new i,this.pendingUpdates=0}static acquire(e){const t=a.acquire();return t._init(e),t}release(){this.dispose(),l.delete(this),a.release(this)}dispose(){this.loadingAgent=t.disposeMaybe(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=s.releaseTerrainData(this._data)}static prune(){a.prune(0)}_init(e){this.waitingAgents.clear(),this._data=s.releaseTerrainData(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=t.abortMaybe(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this.upsampleInfo)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===t)return;this.upsampleInfo.tile?.unrefMapData()}t.refMapData(),n.computeUpsampleInfo(e,t,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){s.releaseTerrainData(this._data),this._data=e}}const a=new r(o,null,(()=>{})),l=new Map;e.TilePerLayerInfo=o,e.printAllocations=function(){l.size>0&&(console.log(`${l.size} live TilePerLayerInfo allocations:`),l.forEach((e=>console.log(e,"\n"))))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TileUpdate":function(){define(["exports"],(function(e){"use strict";var t;e.TileUpdate=void 0,(t=e.TileUpdate||(e.TileUpdate={}))[t.NONE=0]="NONE",t[t.SPLIT=1]="SPLIT",t[t.ELEVATION=2]="ELEVATION",t[t.MERGE=4]="MERGE",t[t.GEOMETRY=8]="GEOMETRY",t[t.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",t[t.TEXTURE_FADING=32]="TEXTURE_FADING",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/ScaleRangeQueries":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/ObjectPool","../../../core/PooledArray","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h{constructor(){this.extent=d.create(),this.minLevel=0,this.maxLevel=0,this.callback=null}}e.ScaleRangeQueries=class extends r{constructor(){super(...arguments),this._queries=new s({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new s({initialSize:30}),this._queryPool=new i(h)}queryVisibleLevelRange(e,t,r,i){const s=this._queryPool.acquire();u.copy(s.extent,e),s.minLevel=t??-Number.MAX_VALUE,s.maxLevel=r??Number.MAX_VALUE,s.callback=i,this._queryQueue.push(s),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let r=0;for(;r<this._queriesInvPtr;){const i=this._queries.data[r],s=i.extent;t>=i.minLevel&&t<=i.maxLevel&&s[0]<=e.extent[2]&&s[2]>=e.extent[0]&&s[1]<=e.extent[3]&&s[3]>=e.extent[1]?(this._queries.swapElements(r,this._queriesInvPtr-1),this._queriesInvPtr--):r++}}},t.__decorate([n.property()],e.ScaleRangeQueries.prototype,"updating",null),e.ScaleRangeQueries=t.__decorate([c.subclass("esri.views.3d.terrain.ScaleRangeQueries")],e.ScaleRangeQueries),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/SphericalPatch":function(){define(["exports","../../../core/mathUtils","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projection/lonLatToSphericalPCPF","../../../geometry/support/DoubleArray","../../../geometry/support/frustum","../../../chunks/sphere","./interfaces","./PatchGeometryFactory","./terrainUtils","./Tile","./TileFrustumVisibility","./tileUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class m extends d.Tile{constructor(e,t,r,i,s){super(),this._convexHull=new Array(24),this._boundingSphere=a.create(),this._baseUsedMemory=1816,this.init(e,t,r,i,s)}init(e,i,n,o,a){super.init(e,i,n,o,a);const l=this.ellipsoid.radius,c=this.extentInRadians[0],u=this.extentInRadians[1],d=this.extentInRadians[2],h=this.extentInRadians[3],p=t.lerp(u,h,.5),m=t.lerp(c,d,.5),f=0===e?0:Math.min(Math.abs(u),Math.abs(h));this._edgeLen=(d-c)*Math.cos(f)*l,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=l-Math.sqrt(l*l-this._edgeLen2/4),s.lonLatToSphericalPCPF(this.centerAtSeaLevel,m,p,this.ellipsoid.radius),r.normalize(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])r.set(a.getCenter(e[d.CenterPosition.MIDDLE]),0,0,0),r.set(e[d.CenterPosition.TOP],0,0,0),r.set(e[d.CenterPosition.BOTTOM],0,0,0),e[d.CenterPosition.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const r=e[d.CenterPosition.MIDDLE],n=this.convexHull;let o=0;for(let e=0;e<8;++e)o=Math.max(o,(i=n,s=3*e,g((t=a.getCenter(r))[0],t[1],t[2],i[s],i[s+1],i[s+2])));e[d.CenterPosition.MIDDLE][3]=Math.sqrt(o)}var t,i,s}_calculateFrustumVisibility(e){if(!o.intersectsSphere(e,this._boundingSphere))return h.TileFrustumVisibility.OUTSIDE;if(this.lij[0]<10)return h.TileFrustumVisibility.INTERSECTS;const t=this.convexHull,r=this.surface.view.state.camera.near;let i=!0;for(let s=0;s<o.numPlanes;s++){const n=s===o.PlaneIndex.NEAR,a=e[s],l=a[0],c=a[1],u=a[2],d=a[3]-(n?r:0);let p=!1;for(let e=0;e<8;++e){const r=3*e;if(l*t[r]+c*t[r+1]+u*t[r+2]+d<0){if(p=!0,!i)break}else i=!1}if(!p)return h.TileFrustumVisibility.OUTSIDE}return i?h.TileFrustumVisibility.INSIDE:h.TileFrustumVisibility.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){c.createSphericalGlobePatch(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),u.enableTerrainInternalChecks&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=a.getCenter(e),i=this.elevationBoundsMin,s=this.elevationBoundsMax,n=this.ellipsoid.radius,o=s;if(0===this.level)r.set(t,0,0,0),e[3]=n+o;else{const o=this.extentInRadians,a=.5*(o[0]+o[2]),l=o[1],c=o[3];y(b,a,l,n),y(v,a,c,n),r.add(t,b,v);const u=n+.5*(i+s);r.scale(t,t,u/r.len(t));const d=this.convexHull;let h=0;const p=(e,t)=>{const r=e[0]-d[3*t],i=e[1]-d[3*t+1],s=e[2]-d[3*t+2];return Math.sqrt(r*r+i*i+s*s)};for(let e=0;e<8;++e){const r=p(t,e);h=Math.max(h,r)}const m=h;e[3]=m+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const s=this.elevationBoundsMin,n=this.elevationBoundsMax,o=this._getPatchType(),a=this.surface.isWebMercator,c=a&&o===l.PatchType.HAS_NORTH_POLE,d=a&&o===l.PatchType.HAS_SOUTH_POLE,h=d||c,p=Math.PI/2,m=e[0],f=e[2],g=d?-p:e[1],b=c?p:e[3],v=.5*(m+f),S=s,w=t+(h?Math.min(0,S-1):S),x=(e,t,r)=>y(e,t,r,w),T=i.create(),C=i.create(),P=i.create(),M=i.create();x(T,m,g),x(C,m,b),x(P,f,b),x(M,f,g);const R=(e,t)=>{for(let r=0;r<3;++r)this._convexHull[3*t+r]=e[r]};R(T,0),R(C,1),R(P,2),R(M,3);const E=n,O=t+(h?Math.max(0,E+1):E),A=i.create(),I=i.create(),D=i.create();y(I,v,b,w),y(D,v,g,w),r.add(A,I,D),r.normalize(A,A);const F=i.create(),L=i.create(),N=(e,t)=>{r.sub(L,e,t),r.normalize(L,L);const i=-r.dot(e,F)/r.dot(L,F);u.internalAssert(i>=0),r.scale(L,L,i),r.add(e,e,L)};if(2**this.lij[0]>2*this.lij[1]){const e=D,t=i.create();r.cross(t,_,e),r.normalize(t,t),r.cross(F,e,t),r.normalize(F,F),u.internalAssert(u.almostEquals(r.dot(F,e)/r.len(e),0)),N(T,C),N(M,P),R(T,0),R(M,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=I,t=i.create();r.cross(t,_,e),r.normalize(t,t),r.cross(F,t,e),r.normalize(F,F),N(C,T),N(P,M),R(C,1),R(P,2)}const U=(e,t)=>{const i=O/r.dot(t,A);for(let r=0;r<3;++r)this._convexHull[3*e+r]=t[r]*i};U(4,T),U(5,C),U(6,P),U(7,M)}_getPatchType(){const e=this.lij[1],t=0===e,r=e===(1<<this.level)-1;return t?r?l.PatchType.HAS_BOTH_POLES:l.PatchType.HAS_NORTH_POLE:r?l.PatchType.HAS_SOUTH_POLE:l.PatchType.REGULAR}intersectsRay(e,t,r,i){const s=this._boundingSphere,n=s[3]+r,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],a=s[0]-e[0],l=s[1]-e[1],c=s[2]-e[2],u=(a*t[0]+l*t[1]+c*t[2])/o,d=t[0]*u-a,h=t[1]*u-l,p=t[2]*u-c;return d*d+h*h+p*p<n*n}get minimumVerticesPerSide(){return this.level<f.length?f[this.level]+1:2}updateCornerElevations(){c.updateCornerSpherical(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){c.updateEdgesAndCornersSpherical(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){c.updateEdgeElevationsAndResolutionsSpherical(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!u.enableTerrainInternalChecks)return;if(this.level<=2)return;const e=this._boundingSphere,t=e[3],s=a.getCenter(e),o=i.create(),l=this.ellipsoid.radius,c=this.elevationBoundsMin,h=this.elevationBoundsMax,m=l+c,f=this._center[d.CenterPosition.MIDDLE][3],_=this.convexHull,b=(e,t)=>{for(let r=0;r<3;++r)e[r]=_[3*t+r]};{const e=i.create(),t=i.create(),s=i.create(),n=i.create(),o=i.create(),a=(i,a,l,c)=>{b(t,i),b(s,a),b(n,l),r.sub(t,t,s),r.sub(n,n,s),r.cross(e,t,n),r.normalize(e,e);const d=r.dot(e,s);b(o,c);const h=r.dot(e,o),p=Math.abs(h-d);u.internalAssert(u.almostEquals(p,0),`Non coplanar ${i},${a},${l},${c} diff = ${p}`)};a(0,1,2,3),a(4,5,6,7),a(0,1,4,5),a(1,2,5,6),a(2,3,6,7),a(3,0,7,4)}const v=n.newDoubleArray(24),S=i.create(),w=i.create(),x=i.create(),T=i.create(),C=(e,t,i,s)=>{b(S,t),b(w,i),b(x,s),r.sub(S,S,w),r.normalize(S,S),r.sub(x,x,w),r.normalize(x,x),r.cross(T,S,x),r.normalize(T,T);const n=r.dot(T,w);((e,t,r)=>{const i=4*e;for(let e=0;e<3;++e)v[i+e]=t[e];v[i+3]=r})(e,T,n)};C(0,0,1,2),C(1,1,0,4),C(2,1,5,2),C(3,3,2,6),C(4,4,0,3),C(5,4,6,5);const P=(e,t,r,i)=>{const s=4*e;return v[s]*t+v[s+1]*r+v[s+2]*i-v[s+3]},M=(e,t,r,i)=>P(e,t,r,i)>=-1,R=(e,t)=>M(e,t[0],t[1],t[2]),E=2**this.lij[0]>2*this.lij[1],O=(e,r,i)=>Math.sqrt(g(e,r,i,s[0],s[1],s[2]))<t,A=e=>O(e[0],e[1],e[2]),I=this.extentInRadians,D=.5*(I[0]+I[2]),F=I[1],L=I[3],N=i.create(),U=i.create();y(N,D,L,m),y(U,D,F,m);const V=E?"Upper":"Lower";let B=!0;for(let e=0;e<6;++e){for(let t=0;t<8;++t){const r=3*t,i=M(e,_[r],_[r+1],_[r+2]);B&&=i,u.internalAssert(i,`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}u.internalAssert(R(e,U),`Tile[${this.lij}] (${V}) bottom mid outside of plane ${e}`),u.internalAssert(R(e,N),`Tile[${this.lij}] (${V}) top mid outside of plane ${e}`)}u.internalAssert(B,"Not all convex hull points are inside  convex hull polyhedron"),u.internalAssert(A(U),`Tile[${this.lij}] (${V}) bottom mid outside of bounding sphere`),u.internalAssert(A(N),`Tile[${this.lij}] (${V}) top mid outside of bounding sphere`);for(let e=0;e<8;++e){const t=O((G=_)[k=3*e],G[k+1],G[k+2]);u.internalAssert(t,`Tile[${this.lij}] Convex hull point ${e} outside of bounding sphere`)}var G,k;for(let e=0;e<6;++e)for(let t=0;t<8;++t){const r=3*t;M(e,_[r],_[r+1],_[r+2])||console.error(`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}const{extentInRadians:z}=this,j=Math.max(z[2]-z[0],z[3]-z[1]),q=Math.round(j*l),{renderData:H}=this;if(!H)return;const{geometry:W,geometryState:$,localOrigin:Q}=H,Z=W.vertexAttributes?.position;if(!Z)return;const Y=i.create(),X=W.numVerticesPerSide-2,{indices:K,indexCount:J,edgeVerticesStartIndex:ee,poleVerticesStartIndex:te}=W;if(!K)return;const re=new Set;for(let e=0;e<J;++e){const i=K[e];if(re.has(i))continue;re.add(i);const n=i<te,a=i>=ee;let u=!1,d=-1;if(a){let e=ee;for(let t=0;t<4;++t){const r=$.edgeResolutions[t];if(i===e||i===e+r-1){u=!0;break}if(e+=r,i<e){d=t;break}}}const m=a?$.edgePeerNeighbors[d]:null,g=a&&m&&p.compareTilesByLij(this,m)>0;Z.getVec(i,o),r.add(Y,o,Q);const y=r.len(Y)-l;let _=0,b=!1;const v=c-y,S=y-h,w=v>1,x=S>1,T=w||x,C=()=>{const e=n?"internal":a&&!u?"edge":u?"corner":"pole";return`Tile[${this.lij}].vertex[${i}]:${e}`+(w?"(below)":x?"(above)":"")+(g?"(Neighbor)":"")},R=r.dist(Y,s);if(R>=t+0){const e=R-t;T||(console.error(`${C()} is out of the bounding sphere by ${e.toFixed(0)} / ${t.toFixed(0)}[tol=0] h=${y.toFixed(0)} / [${c.toFixed(0)}..${h.toFixed(0)}] (${(e/t).toFixed(0)})`),b=!0)}for(let e=0;e<6;++e)if(!M(e,Y[0],Y[1],Y[2])){const r=P(e,Y[0],Y[1],Y[2]),s=i%X,n=(i-s)/X;0===e&&v||5===e&&S||(console.error(`${C()} (${s},${n})|${X}] is out of the bounding trapezoid plane ${e} h=${Math.round(y)} / [${Math.round(c)}..${Math.round(h)}] dist=${Math.round(r)} radii = ${Math.round(t)}/${Math.round(f)}} : maxL = ${q}`),++_)}if(b||_>0)break}}get convexHull(){return this._convexHull}}const f=[128,64,64,32,16,8,8,4];function g(e,t,r,i,s,n){const o=i-e,a=s-t,l=n-r;return o*o+a*a+l*l}const y=(e,t,r,i)=>{const s=Math.cos(t),n=Math.sin(t),o=Math.cos(r),a=Math.sin(r);e[0]=i*o*s,e[1]=i*o*n,e[2]=i*a},_=[0,0,1],b=i.create(),v=i.create();e.SphericalPatch=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/projection/lonLatToSphericalPCPF":function(){define(["exports"],(function(e){"use strict";e.lonLatToSphericalPCPF=function(e,t,r,i){const s=Math.cos(r);e[0]=Math.cos(t)*s*i,e[1]=Math.sin(t)*s*i,e[2]=Math.sin(r)*i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/SplitLimits":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";e.SplitLimits=class extends r{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}},t.__decorate([i.property()],e.SplitLimits.prototype,"fovX",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"fovY",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"relativeWidthLimit",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"relativeHeightLimit",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"maxLod",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"angledSplitBias",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"aboveGround",void 0),t.__decorate([i.property()],e.SplitLimits.prototype,"frustum",void 0),e.SplitLimits=t.__decorate([a.subclass("esri.views.3d.terrain.SplitLimits")],e.SplitLimits),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TerrainRenderer":function(){define(["exports","../../../chunks/tslib.es6","../../../Color","../../../core/has","../../../core/maybe","../../../core/MemCachePool","../../../core/ObjectPool","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/buffer/BufferView","../../ViewingMode","./interfaces","./LayerClass","./OverlayContent","./OverlayRenderer","./PatchRenderData","./RenderOrder","./TerrainAttributesCache","./terrainUtils","./TileRenderer","./TileUpdate","./tileUtils","./TransparencyMode","../webgl-engine/collections/Component/ComponentIntersectionData","../webgl-engine/core/shaderLibrary/ShaderOutput","../webgl-engine/core/shaderLibrary/terrain/TileBlendInput","../webgl-engine/effects/RenderPlugin","../webgl-engine/lib/Attribute","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/IntersectorInterfaces","../webgl-engine/lib/IntersectorResult","../webgl-engine/lib/IntersectorType","../webgl-engine/lib/Material","../webgl-engine/lib/RayIntersections","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/VertexAttribute","../webgl-engine/lib/verticalOffsetUtils","../webgl-engine/materials/DrawParameters","../../../chunks/Terrain.glsl","../webgl-engine/shaders/TerrainTechnique","../webgl-engine/shaders/TerrainTechniqueConfiguration","../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z){"use strict";const Y=f.create();e.TerrainRenderer=class extends D.SyncRenderPlugin{get _isGlobal(){return this._stage.viewingMode===y.ViewingMode.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,r,i,s,a){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=r,this._ellipsoidRadius=i,this._compressionTracker=s,this.type=V.IntersectorType.TERRAIN,this.isGround=!0,this._passParameters=new W.TerrainPassParameters,this._drawParameters=new H.DrawParameters,this._renderDataPool=new o(w.PatchRenderData),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new R.IteratorPreorder,this._castShadows=!1,this._inViewshed=!1,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=B.RenderOccludedFlag.Occlude,this.produces=new Map([[k.RenderSlot.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===E.TransparencyMode.Opaque],[k.RenderSlot.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===E.TransparencyMode.Transparent||this.transparency===E.TransparencyMode.InvisibleWithDraped)],[k.RenderSlot.OCCLUDED_GROUND,()=>this._produces()&&this.renderOccludedFlags===S.overlayRenderOccludedFlag]]),this._tileSize=256,this._configuration=new Q.TerrainTechniqueConfiguration(t.viewingMode===y.ViewingMode.Global),this._tileTextureCache=new n.MemCachePool(((e,t)=>a.newCache(e,t)),"TileTexture"),this.tileGeometryCache=new T.TerrainAttributesCache(a)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(a.watch((()=>this._overlayRenderer.rendersOccludedDraped),(e=>{this.renderOccludedFlags=e?S.overlayRenderOccludedFlag:B.RenderOccludedFlag.Occlude,this.setNeedsRender()}),a.sync))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?D.ConsumesDepth:D.ConsumesNone}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerViewUid(){return q.terrainId}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._configuration.screenSizePerspective!==e&&(this._configuration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,M.TileUpdate.TEXTURE_FADING)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const r=m.fromValues(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,r)??!1}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===M.TileUpdate.TEXTURE_FADING?_.TextureUpdate.FADING:_.TextureUpdate.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const t of e.layerInfo[b.LayerClass.ELEVATION])t.pendingUpdates&=~M.TileUpdate.GEOMETRY;e.resetPendingUpdate(M.TileUpdate.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return p.ZEROS;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=L.RenderRequestType.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=L.RenderRequestType.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=L.RenderRequestType.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new P.TileRenderer(this._rctx,this._tileSize,this._techniques,this._tileTextureCache,this._compressionTracker),this.updateTileBackground()}uninitializeRenderContext(){this._tileRenderer=s.disposeMaybe(this._tileRenderer)}intersect(e,t,r,i){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==E.TransparencyMode.Opaque)return;const s=X,n=K;h.subtract(s,i,r),h.set(n,1/s[0],1/s[1],1/s[2]);const o=e.results.min,a=e.results.max,l=e.results.ground,c=e.options.store===N.StoreResults.MIN,u=!!e.results.ground.target,d=q.getVerticalOffsetTerrain(e.verticalOffset),p=e.tolerance;let m,y=c&&null!=o.distance?o.distance:1/0;const _=e.options,b=_.normalRequired||!_.backfacesTerrain,v=new G.MeshIntersectionOptions(!1,b),S=u=>{const S=u.renderData;if(!S?.vao)return;const w=S.geometry;f.set(Y,w.boundingBox);const x=S.localOrigin;null!=d&&(d.localOrigin=x,d.applyToAabb(Y));const T=Y;if(J[0]=r[0]-x[0],J[1]=r[1]-x[1],J[2]=r[2]-x[2],!G.intersectAabbInvDirBefore(T,J,n,p,y))return;const C=(e,t,r)=>{e.set(this.type,u,t,r),y=c&&null!=o.distance?o.distance:1/0},P=(n,c,u)=>{if((!b||null!=u)&&n>=0&&(_.backfacesTerrain||h.dot(u,s)<0)&&(_.invisibleTerrain||!_.selectionMode||null==t||t(r,i,n))){if((null==l.distance||n<l.distance)&&C(l,n,u),_.isFiltered)return;_.store===N.StoreResults.ALL&&(null==m?(m=new U.IntersectorResult(e.ray),C(m,n,u),e.results.all.push(m)):n<m.distance&&C(m,n,u)),(null==o.distance||n<o.distance)&&C(o,n,u),_.store!==N.StoreResults.MIN&&(null==a.distance||n>a.distance)&&C(a,n,u)}},M=ee;h.subtract(M,i,x);const{indices:R,indexCount:E}=w,A=w.vertexAttributes,I=A.getField(j.VertexAttribute.POSITION,g.BufferViewVec3f),D=new F.Vertices(I.typedBuffer,3,A.stride/4),L=E/3;if(!d&&L>O.componentMinimalSizeForIntersectionData){const e=u.renderData;null==e.intersectionData&&(e.intersectionData=new O.ComponentIntersectionData(R,0,L,D)),e.intersectionData.intersectRay(J,M,v,P)}else G.intersectTriangles(J,M,0,L,R,D,d,v,P)},w=this._rootTiles;null!=w&&(()=>{const t=this._tileIterator;t.reset(w);const i=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||i&&e.intersectsClippingArea)||null==d&&!e.intersectsRay(r,s,p,y)||u&&this._useStencilForTile(e)?t.skipSubtree():S(e)})()}processScaleRangeQueries(e,t){if(!t.done&&e)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const r of t)null!=r.renderData?.textureReference&&e.queriesForTile(r);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!i("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const r=e.bind.viewshedEnabled;if(this._inViewshed!==r&&(this._inViewshed=r,this._patchesByOriginDirty=!0),e.bind.slot===k.RenderSlot.OCCLUDED_GROUND){if(0===(e.renderOccludedMask&S.overlayRenderOccludedFlag))return null}else{const t=this.transparency===E.TransparencyMode.Opaque?k.RenderSlot.OPAQUE_TERRAIN:k.RenderSlot.TRANSPARENT_TERRAIN;if(e.bind.slot!==t)return null}if(this.transparency===E.TransparencyMode.Invisible)return null;const s=this._configuration;switch(s.screenSpaceReflections=s.cloudReflections=s.receiveShadows=s.receiveAmbientOcclusion=s.renderOccluded=s.hasHighlightMixTexture=!1,s.overlayMode=this._overlayRenderer.mode,e.output){case A.ShaderOutput.Color:case A.ShaderOutput.ColorEmission:{s.screenSpaceReflections=null!=e.bind.ssr.lastFrameColor,s.cloudReflections=null!=e.bind.clouds.data,s.receiveShadows=e.bind.shadowMap.ready;const t=e.bind.slot===k.RenderSlot.OCCLUDED_GROUND;return s.renderOccluded=t,s.receiveAmbientOcclusion=!t&&null!=e.bind.ssao,this._acquireTechnique(e.output)}case A.ShaderOutput.Shadow:case A.ShaderOutput.ShadowExcludeHighlight:return this._castShadows?this._acquireTechnique(A.ShaderOutput.Shadow):null;case A.ShaderOutput.ViewshedShadow:return this._inViewshed?this._acquireTechnique(A.ShaderOutput.ViewshedShadow):null;case A.ShaderOutput.Depth:case A.ShaderOutput.Normal:return this._acquireTechnique(e.output);case A.ShaderOutput.ObjectAndLayerIdColor:return this._acquireTechnique(A.ShaderOutput.ObjectAndLayerIdColor);case A.ShaderOutput.Highlight:return s.hasHighlightMixTexture=null!=e.bind.highlightMixTexture,this._overlayRenderer.hasHighlights?this._acquireTechnique(A.ShaderOutput.Highlight):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case A.ShaderOutput.Color:case A.ShaderOutput.ColorEmission:{const r=e.bind.slot===k.RenderSlot.OCCLUDED_GROUND?v.OverlayContent.Occluded:v.OverlayContent.Color;this._renderMaterialPass(e,t,r);break}case A.ShaderOutput.Depth:case A.ShaderOutput.Normal:this._renderAuxiliaryPass(e,t,v.OverlayContent.Color,this._visiblePatchesByOrigin);break;case A.ShaderOutput.Highlight:{const r=e.bind.highlight?.name;r&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(v.OverlayContent.Highlight)&&this._overlayRenderer.hasHighlight(r)&&this._renderAuxiliaryPass(e,t,v.OverlayContent.Highlight,this._visiblePatchesByOrigin);break}case A.ShaderOutput.Shadow:case A.ShaderOutput.ShadowExcludeHighlight:case A.ShaderOutput.ViewshedShadow:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case A.ShaderOutput.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,v.OverlayContent.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=r.toUnitRGBA(e);i=p.fromValues(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,_.TextureUpdate.FADING))),this._configuration.tileBlendInput=t.backgroundIsGrid?I.TileBlendInput.GridComposite:null!=t.backgroundColor?I.TileBlendInput.ColorComposite:I.TileBlendInput.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==x.RenderOrder.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const r of e)R.sortTiles(this.renderOrder,r,t);e.sort(((e,t)=>R.compareTiles(e[0],t[0],this.renderOrder))),this._visiblePatchesByOrigin=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),r=e.renderData;if(!r){this._numTilesCulled++;continue}const i=r.localOrigin;if(this._castShadows||this._inViewshed){let t=this._allPatchesByOrigin.get(i);t||(t=[],this._allPatchesByOrigin.set(i,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let s=this._visiblePatchesByOrigin.get(i);s||(s=[],this._visiblePatchesByOrigin.set(i,s)),s.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,r,i){const s=e.rctx;this._passParameters.overlayContent=r,s.bindTechnique(t,e.bind,this._passParameters);const n=this._stencilEnabledLayerExtents.length>0;i.forEach((i=>{this._drawParameters.origin=i[0].renderData.localOrigin,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters);for(let s=0;s<i.length;s++)this._renderPatch(e,t,i[s],Z.PrimitiveType.TRIANGLES,n,r)})),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,r){const{rctx:i}=e;this._passParameters.overlayContent=r,i.bindTechnique(t,e.bind,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const s=e.bind.camera,n=t.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const e=z.getSettings(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const o=this._stencilEnabledLayerExtents.length>0,a=r===v.OverlayContent.Occluded;a&&(n.bindTexture("tex",i.emptyTexture),n.setUniform3fv("textureOpacities",p.ZEROS),n.setUniform4fv("texOffsetAndScale",m.ZEROS));const l=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:p.ZEROS;this._configuration.tileBlendInput===I.TileBlendInput.ColorComposite&&n.setUniform3fv("backgroundColor",l);const c=this.wireframe?Z.PrimitiveType.LINES:Z.PrimitiveType.TRIANGLES;this._configuration.textureFadingEnabled&&n.bindTexture("texNext",i.emptyTexture);const u=this._visiblePatchesByOrigin;for(const i of u.values()){const s=i[0].renderData.localOrigin;this._drawParameters.origin=s,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const s of i){const i=s.renderData,l=i.textureReference;if(null!=l){if(!a){n.setUniform4fv("texOffsetAndScale",l.offsetAndScale),n.bindTexture("tex",l.texture.texture);const e=i.textureFadeFactor,t=e<1?i.nextTextureReference:null;this._configuration.textureFadingEnabled&&t&&e<1?(n.setUniform1f("fadeFactor",e),n.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),n.setUniform3fv("nextTexOpacities",t.opacities),n.bindTexture("texNext",t.texture.texture)):n.setUniform1f("fadeFactor",1),i.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",l.opacities)}this._renderPatch(e,t,s,c,o,r),s.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,r,i,s,n){const o=r.renderData,a=o.vao,l=a?.indexBuffer;if(!a||null==l)return void(C.enableTerrainInternalChecks&&console.error("Rendered tile with no indices: ",r.lij," : ",o));const c=t.program;null==n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(c,o.overlay),s&&(t.useStencil=this._useStencilForTile(r),e.rctx.setPipelineState(t.getPipeline()));const u=o.geometry.indexCount;e.rctx.bindVAO(a),c.assertCompatibleVertexAttributeLocations(a),e.rctx.drawElements(i,u,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e){return this._configuration.output=e,this._techniques.get($.TerrainTechnique,this._configuration)}get test(){}hasHighlight(e){return this._overlayRenderer.hasHighlight(e)}},t.__decorate([l.property({readOnly:!0})],e.TerrainRenderer.prototype,"_isGlobal",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"renderOccludedFlags",void 0),t.__decorate([l.property({value:!1})],e.TerrainRenderer.prototype,"renderingDisabled",null),t.__decorate([l.property({value:!0})],e.TerrainRenderer.prototype,"visible",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"renderPatchBorders",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"visualizeNormals",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"cullBackFaces",null),t.__decorate([l.property({value:x.RenderOrder.FRONT_TO_BACK})],e.TerrainRenderer.prototype,"renderOrder",null),t.__decorate([l.property()],e.TerrainRenderer.prototype,"wireframe",null),e.TerrainRenderer=t.__decorate([d.subclass("esri.views.3d.terrain.TerrainRenderer")],e.TerrainRenderer);const X=p.create(),K=p.create(),J=p.create(),ee=p.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TerrainAttributesCache":function(){define(["exports","../../../core/MemCachePool","./TerrainAttributes"],(function(e,t,r){"use strict";e.TerrainAttributesCache=class{constructor(e){this._storage=new t.MemCachePool(((t,r)=>e.newCache(t,r)),"TileGeometry")}acquire(e){const t=4*Math.ceil(e/4),i=this._storage,s=function(e){return e.toString()}(t),n=i.pop(s);if(n)return n;const o=r.terrainAttributesLayout.createBuffer(t);return o.release=()=>i.put(s,o),o}clear(){this._storage.clear()}destroy(){this._storage.destroy()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TerrainAttributes":function(){define(["exports","../support/buffer/InterleavedLayout","../webgl-engine/lib/VertexAttribute"],(function(e,t,r){"use strict";const i=t.newLayout().vec3f(r.VertexAttribute.POSITION).vec2u16(r.VertexAttribute.UV0,{glNormalized:!0}).vec2i16(r.VertexAttribute.NORMALCOMPRESSED,{glNormalized:!0});e.terrainAttributesLayout=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TileRenderer":function(){define(["exports","../../../core/has","../../../core/maybe","../../../core/libs/gl-matrix-2/math/vec2","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../layers/support/layerUtils","../support/flowUtils","./BlendLayersTechnique","./interfaces","./LayerClass","./NeighborIndex","./TerrainData","./terrainUtils","./TextureFader","./TextureReference","./TileCompositor","./TileRenderInfo","./TileTexture","./TileUpdate","./tileUtils","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput","../webgl-engine/lib/glUtil3D","../../support/TextureCompressionWorkerHandle","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M){"use strict";class R{constructor(e,t,r,i,s,n){this.start=e,this.end=t,this.blendMode=r,this.opacity=i,this.output=s,this.baseOpacity=n}}function E(e,t,r){L.layerIndex=t,L.vtlNeighborInfos.clear();const s=e.layerInfo[u.LayerClass.MAP][t];if(i.set(L.offset,0,0),L.tile=e,L.scale=1,L.sourceLod=e.lij,L.sourceLayerInfo=s,L.isVTLBackground=r,s.data)return r&&e.forEachLoadedNeighbor(((r,i)=>{if(r.level!==e.level)return;const n=r.layerInfo[u.LayerClass.MAP][t];if(!p.isVectorTilePerLayerInfo(n)||s.data===n.data)return;const o=L.vtlNeighborInfos.pushNew();o.offset=U[i],o.sourceLod=r.lij,o.sourceLayerInfo=n})),L;const n=s.upsampleInfo,o=n?.tile?.layerInfo[u.LayerClass.MAP][t];return o&&n.tile?(L.tile=n.tile,i.copy(L.offset,n.offset),L.scale=n.scale,L.sourceLod=n.tile.lij,L.sourceLayerInfo=o,L):r?L:null}function O(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function A(e){let t="normal"!==e.blendMode;return o.isGroupLayer(e.parent)&&(t=A(e.parent)||t),t}function I(e,t){o.isGroupLayer(e.parent)&&I(e.parent,t);const r=e.uid;if(null!=r&&""!==r){const i=D.get(r);i?i.start=t:D.set(r,new R(t,t,e.blendMode,e.opacity,w.BlendLayersOutput.Composite,1))}}const D=new Map,F=new Array,L=new y.TileRenderInfo,N=n.fromValues(0,0,1,1),U=new Array;U[d.NeighborIndex.NORTH]=[0,-1],U[d.NeighborIndex.NORTH_EAST]=[-1,-1],U[d.NeighborIndex.EAST]=[-1,0],U[d.NeighborIndex.SOUTH_EAST]=[-1,1],U[d.NeighborIndex.SOUTH]=[0,1],U[d.NeighborIndex.SOUTH_WEST]=[1,1],U[d.NeighborIndex.WEST]=[1,0],U[d.NeighborIndex.NORTH_WEST]=[1,-1],e.GroupInfo=R,e.TileRenderer=class{constructor(e,t,r,i,s){this._rctx=e,this.tileSize=t,this._techniques=r,this._cache=i,this._compressionTracker=s,this._passParameters=new l.BlendLayersPassParameters,this._backgroundColor=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new g.TileCompositor(this._rctx,this._techniques)}dispose(){this._compositor=r.disposeMaybe(this._compositor),this._backgroundTexture=r.releaseMaybe(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,i=r.baseOpacity;let s=0,n=0,l=this.tileSize,d=!1,h=!1;const m=r.view.state.contentPixelRatio;let f=!1;D.clear(),F.length=0;const g=e.layerInfo[u.LayerClass.MAP];let y=0,_=null;for(;y<g.length;y++){const t=r.layerViewByIndex(y,u.LayerClass.MAP),c=t.layer,S=!v.fallsWithinLayerView(e,t),w=c.opacity,x=t.fullOpacity;if(h=h||o.isBaseLayer(c),a.isLayerViewWithFlowRenderer(t))continue;if(p.isBlendableLayerView(t)){let e="normal"!==t.layer.blendMode;if(o.isGroupLayer(c.parent)){const t=c.parent.uid;null!=t&&""!==t&&(e=A(c.parent)||e)}e&&(f=e,d=!1)}if((S||0===w)&&!f){g[y].pendingUpdates&=~(b.TileUpdate.TEXTURE_NOFADING&b.TileUpdate.TEXTURE_FADING);continue}++n;const T=p.isVectorTileLayerView(t),C=E(e,y,T);if(C){if(g[y].pendingUpdates&=~(b.TileUpdate.TEXTURE_NOFADING&b.TileUpdate.TEXTURE_FADING),o.isGroupLayer(c.parent)){const e=c.parent.uid;null!=e&&""!==e&&I(c.parent,y)}T?l=Math.max(l,this.tileSize*m):1===i&&1===x&&(t.isOpaque||this._dataToTexture(C,o.isReferenceLayer(c))&&C.sourceLayerInfo.data.descriptor.isOpaque)&&(d=!0),++s,null===_&&(_=y)}}const S=l/this.tileSize;0!==s&&null!==_?1===s&&!f&&this._useLayerTexture(e,_)||this._composeLayers(e,t,y-1,h,l,S,!d||f,D,f):this._useBackgroundTexture(e,n,t!==c.TextureUpdate.FADING)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundTexture&&this._drawBackgroundTexture(this._backgroundTexture))}_ensureBackgroundTexture(){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(this.tileSize,!1),this._drawBackgroundTexture(this._backgroundTexture)),this._backgroundTexture}_drawBackgroundTexture(e){this._compositor.bind(this.tileSize),this._passParameters.offset=s.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(e),this._compositor.unbind()}_useBackgroundTexture(e,t,r){const i=e.renderData,s=!r&&null!=i.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?m.ActivationTime.Delayed:m.ActivationTime.Immediate,n=this._ensureBackgroundTexture();i.setTextureReference(new f.TextureReference(n,c.TextureUpdate.FADING,N,e.surface.baseOpacity,0,1),s)}_useLayerTexture(e,t){const r=e.surface.layerViewByIndex(t,u.LayerClass.MAP),i=o.isBaseLayer(r.layer),s=i?e.surface.baseOpacity:1,a=i?1:e.surface.baseOpacity,l=r.fullOpacity,d=E(e,t,!1);return!!this._dataToTexture(d,o.isReferenceLayer(r.layer))&&(e.renderData.setTextureReference(new f.TextureReference(d.sourceLayerInfo.data,c.TextureUpdate.FADING,n.fromValues(d.offset[0],d.offset[1],d.scale,d.scale),s,a,l)),!0)}_composeLayers(e,t,r,i,n,a,l,c,d){this._compositor.ensureBuffer(n);const h=e.surface.baseOpacity;let m=!1,g=C.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,y=!1,_=0;for(let t=r;t>=0;t--){const r=e.surface.layerViewByIndex(t,u.LayerClass.MAP),f=r.layer,b=p.isVectorTileLayerView(r),x=E(e,t,b),T=f.opacity,P=!v.fallsWithinLayerView(e,r);if(!x||(0===T||P)&&!d)continue;const M=!o.isBaseLayer(f)&&!m;M&&(m=!0);let R=!1;c.forEach((e=>{e.start===t&&(e.output=i?w.BlendLayersOutput.Composite:l&&M?this.backgroundIsGrid?w.BlendLayersOutput.GridComposite:w.BlendLayersOutput.ColorComposite:w.BlendLayersOutput.Composite,e.baseOpacity=M?h:1,F.push(e),this._compositor.openGroup(n),R=!0)}));const A=0===_,I=R?w.BlendLayersOutput.GroupBackgroundComposite:l&&A?this.backgroundIsGrid?w.BlendLayersOutput.GridComposite:w.BlendLayersOutput.ColorComposite:w.BlendLayersOutput.Composite,D=S.blendModeFromString[p.isBlendableLayerView(r)?r.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=M&&!R&&h<1?h:1,this._passParameters.opacity=T,p.isVectorTileRenderInfo(x)?y=this._compositor.drawVectorData(this._passParameters,I,n,D,x,a,this.tileSize,y):p.isImageryTileRenderInfo(x)?(this._compositor.drawRasterData(this._passParameters,I,n,D,x),O(x)&&(g=C.TextureSamplingMode.NEAREST)):this._dataToTexture(x,o.isReferenceLayer(f))&&(this._passParameters.texture=x.sourceLayerInfo.data.texture,this._passParameters.offset=x.offset,this._passParameters.scale=x.scale,this._compositor.drawImageData(this._passParameters,I,n,D));F.length>0&&F[F.length-1].end===t;){const e=F.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=s.ZEROS,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,n,S.blendModeFromString[e.blendMode])}_++}const b=e.renderData,x=d||m&&h<1,T=b.ensureTexture(n,x,t,(()=>this._buildTexture(n,x,g)));this._compositor.copyFBOToTexture(T),this._compositor.unbind(),b.setTextureReference(new f.TextureReference(T,t,N,m?1:h,0,1))}_dataToTexture(e,t){if(p.isImageSourceRenderInfo(e)){const r=e.sourceLayerInfo,i=1===e.scale&&!t;r.data=this._buildTexture(r.data,!0,i,e.tile.onCompressionFinished),e.tile.setMemoryDirty()}return p.isTextureTileRenderInfo(e)}_buildTexture(e,t,r=C.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,i=()=>{}){if(null==e)return null;const s=new M.TextureDescriptor;s.wrapMode=C.TextureWrapMode.CLAMP_TO_EDGE,s.samplingMode="boolean"==typeof r?C.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:r,s.maxAnisotropy=this._maxAnisotropy,s.preMultiplyAlpha=!0,s.flipped=!0,s.hasMipmap=!0,t||(s.pixelFormat=C.PixelFormat.RGB);const n=this._rctx,o="boolean"==typeof r&&r;let a;if("number"==typeof e)s.width=s.height=e,a=this._buildTileTexture(s);else if(h.isImageWithType(e))s.isOpaque=e.isOpaque,s.isOpaque&&(s.pixelFormat=C.PixelFormat.RGB),s.width=e.element.width,s.height=e.element.height,a=this._buildTileTexture(s,o,i,e.element);else try{s.width=e.width,s.height=e.height,a=this._buildTileTexture(s,o,i,e)}catch(e){a=new _.TileTexture(x.createEmptyTexture(n)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const l=n.bindTexture(a.texture,P.Texture.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),n.bindTexture(l,P.Texture.TEXTURE_UNIT_FOR_UPDATES),a}_buildTileTexture(e,t=!1,r=()=>{},i){const s=this._cache.pop(_.getCacheKey(e,!1))??this._cache.pop(_.getCacheKey(e,!0));if(t&&=T.isCompressible(i,e),s)return s.retain(),t?s.texture.enableCompression({compressionTracker:this._compressionTracker,compressionCallback:r}):s.texture.disableCompression(),s.texture.setData(i),s;e.compress=t?{compressionTracker:this._compressionTracker,compressionCallback:r}:void 0;const n=new P.Texture(this._rctx,e,i);return new _.TileTexture(n,this._cache)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/flowUtils":function(){define(["exports","../../../layers/support/layerUtils"],(function(e,t){"use strict";e.isLayerViewWithFlowRenderer=function(e){return t.isLayerWithFlowRenderer(e.layer)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/BlendLayersTechnique":function(){define(["require","exports","../../../core/libs/gl-matrix-2/factories/vec3f64","../webgl-engine/core/shaderLibrary/terrain/TileComposite.glsl","../../../chunks/BlendLayers.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique"],(function(e,t,r,i,s,n,o){"use strict";class a extends i.TileCompositePassParameters{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=r.ZEROS}}class l extends o.ShaderTechnique{constructor(t,r){super(t,r,new n.ReloadableShaderModule(s.BlendLayers,(()=>new Promise(((t,r)=>e(["../webgl-engine/core/shaderLibrary/util/BlendLayers.glsl"],t,r))))))}}t.BlendLayersPassParameters=a,t.BlendLayersTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/TileComposite.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/factories/vec2f64","../../shaderModules/Float2PassUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../../lib/VertexAttribute","../../../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o){"use strict";class a extends o.NoParameters{constructor(){super(...arguments),this.scale=1,this.offset=t.ZEROS}}e.TileComposite=function(e){e.attributes.add(n.VertexAttribute.POSITION,"vec2"),e.attributes.add(n.VertexAttribute.UV0,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.uniforms.add(new i.FloatPassUniform("scale",(e=>e.scale)),new r.Float2PassUniform("offset",(e=>e.offset))).main.add(s.glsl`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)},e.TileCompositePassParameters=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/BlendLayers.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/terrain/BackgroundGrid.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput","../views/3d/webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/TileComposite.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";var u;function d(u){const d=new c.ShaderBuilder,h=d.fragment;if(d.include(s.TileComposite),u.background===e.BackgroundMode.Only){const e=u.output===r.BlendLayersOutput.ColorComposite;return e?h.uniforms.add(new n.Float3PassUniform("backgroundColor",(e=>e.backgroundColor))):h.include(t.BackgroundGrid),h.main.add(a.glsl`fragColor = vec4(${e?a.glsl`backgroundColor`:a.glsl`gridColor(uv)`}, 1.0);`),d}return d.include(i.TileBackground,u),h.uniforms.add(new l.Texture2DPassUniform("tex",(e=>e.texture)),new o.FloatPassUniform("opacity",(e=>e.opacity))),h.main.add(a.glsl`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),d}e.BackgroundMode=void 0,(u=e.BackgroundMode||(e.BackgroundMode={}))[u.BelowLayer=0]="BelowLayer",u[u.Only=1]="Only",u[u.COUNT=2]="COUNT";const h=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return e.BackgroundMode},build:d},Symbol.toStringTag,{value:"Module"}));e.BlendLayers=h,e.build=d}))},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput":function(){define(["exports"],(function(e){"use strict";var t;e.BlendLayersOutput=void 0,(t=e.BlendLayersOutput||(e.BlendLayersOutput={}))[t.Draw=0]="Draw",t[t.Composite=1]="Composite",t[t.ColorComposite=2]="ColorComposite",t[t.GridComposite=3]="GridComposite",t[t.GroupBackgroundComposite=4]="GroupBackgroundComposite",t[t.COUNT=5]="COUNT",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl":function(){define(["exports","../../../../../../core/has","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../output/BlendOptions","./BackgroundGrid.glsl","./BaseOpacityMode","./BlendLayersOutput","./PremultipliedAlphaSource","../util/BlendModes.glsl","../../shaderModules/Float3PassUniform","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform","../../../../../webgl/NoParameters"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class m extends p.NoParameters{constructor(){super(...arguments),this.baseOpacity=1,this.backgroundColor=r.ZEROS,this.fboTexture=null}}e.TileBackground=function(e,t){const{output:r,blendMode:p,baseOpacityMode:m,premultipliedSource:f}=t,g=e.fragment,y=m===n.BaseOpacityMode.Required;y&&g.uniforms.add(new u.FloatPassUniform("baseOpacity",(e=>e.baseOpacity)));const _=p!==i.LayerBlendMode.Normal,b=f===a.PremultipliedAlphaSource.On,v=r===o.BlendLayersOutput.Composite,S=r===o.BlendLayersOutput.GroupBackgroundComposite,w=!_&&!b&&(v&&!y||S);g.include(l.BlendModes,t);let x="";switch(r){case o.BlendLayersOutput.GroupBackgroundComposite:case o.BlendLayersOutput.Draw:x=d.glsl`vec4(0.0)`;break;case o.BlendLayersOutput.ColorComposite:g.uniforms.add(new c.Float3PassUniform("backgroundColor",(e=>e.backgroundColor))),x=d.glsl`vec4(backgroundColor, 1.0)`;break;case o.BlendLayersOutput.GridComposite:g.include(s.BackgroundGrid),x=d.glsl`vec4(gridColor(uv), 1.0)`;break;case o.BlendLayersOutput.Composite:g.uniforms.add(new h.Texture2DPassUniform("fboColor",(e=>e.fboTexture))),x=d.glsl`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`;case o.BlendLayersOutput.COUNT:}g.code.add(d.glsl`
    vec4 getBackground(vec2 uv) {
      return ${d.If(y,d.glsl`baseOpacity *`)} ${x};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${_?d.glsl`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:d.glsl`
          float composeAlpha = colorLayer.a * opacity;
          ${w?d.glsl`return colorLayer * opacity;`:d.glsl`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)},e.TileBackgroundPassParameters=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/output/BlendOptions":function(){define(["exports"],(function(e){"use strict";var t;e.LayerBlendMode=void 0,(t=e.LayerBlendMode||(e.LayerBlendMode={}))[t.Normal=0]="Normal",t[t.Average=1]="Average",t[t.Lighten=2]="Lighten",t[t.Lighter=3]="Lighter",t[t.Plus=4]="Plus",t[t.Screen=5]="Screen",t[t.ColorDodge=6]="ColorDodge",t[t.Darken=7]="Darken",t[t.Multiply=8]="Multiply",t[t.ColorBurn=9]="ColorBurn",t[t.Overlay=10]="Overlay",t[t.SoftLight=11]="SoftLight",t[t.HardLight=12]="HardLight",t[t.VividLight=13]="VividLight",t[t.Hue=14]="Hue",t[t.Saturation=15]="Saturation",t[t.Luminosity=16]="Luminosity",t[t.Color=17]="Color",t[t.DestinationOver=18]="DestinationOver",t[t.DestinationAtop=19]="DestinationAtop",t[t.DestinationIn=20]="DestinationIn",t[t.DestinationOut=21]="DestinationOut",t[t.SourceAtop=22]="SourceAtop",t[t.SourceIn=23]="SourceIn",t[t.SourceOut=24]="SourceOut",t[t.Xor=25]="Xor",t[t.Difference=26]="Difference",t[t.Exclusion=27]="Exclusion",t[t.Minus=28]="Minus",t[t.Invert=29]="Invert",t[t.Reflect=30]="Reflect",t[t.COUNT=31]="COUNT";const r={normal:e.LayerBlendMode.Normal,average:e.LayerBlendMode.Average,lighten:e.LayerBlendMode.Lighten,lighter:e.LayerBlendMode.Lighter,screen:e.LayerBlendMode.Screen,plus:e.LayerBlendMode.Plus,"color-dodge":e.LayerBlendMode.ColorDodge,darken:e.LayerBlendMode.Darken,multiply:e.LayerBlendMode.Multiply,"color-burn":e.LayerBlendMode.ColorBurn,overlay:e.LayerBlendMode.Overlay,"soft-light":e.LayerBlendMode.SoftLight,"hard-light":e.LayerBlendMode.HardLight,"vivid-light":e.LayerBlendMode.VividLight,hue:e.LayerBlendMode.Hue,saturation:e.LayerBlendMode.Saturation,luminosity:e.LayerBlendMode.Luminosity,color:e.LayerBlendMode.Color,difference:e.LayerBlendMode.Difference,exclusion:e.LayerBlendMode.Exclusion,minus:e.LayerBlendMode.Minus,invert:e.LayerBlendMode.Invert,reflect:e.LayerBlendMode.Reflect,"destination-over":e.LayerBlendMode.DestinationOver,"destination-atop":e.LayerBlendMode.DestinationAtop,"destination-in":e.LayerBlendMode.DestinationIn,"destination-out":e.LayerBlendMode.DestinationOut,"source-atop":e.LayerBlendMode.SourceAtop,"source-in":e.LayerBlendMode.SourceIn,"source-out":e.LayerBlendMode.SourceOut,xor:e.LayerBlendMode.Xor};e.blendModeFromString=r,e.isCompositeBlendMode=function(t){return t===e.LayerBlendMode.DestinationOver||t===e.LayerBlendMode.DestinationAtop||t===e.LayerBlendMode.DestinationIn||t===e.LayerBlendMode.DestinationOut||t===e.LayerBlendMode.SourceAtop||t===e.LayerBlendMode.SourceIn||t===e.LayerBlendMode.SourceOut||t===e.LayerBlendMode.Xor},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/BaseOpacityMode":function(){define(["exports"],(function(e){"use strict";var t;e.BaseOpacityMode=void 0,(t=e.BaseOpacityMode||(e.BaseOpacityMode={}))[t.NotRequired=0]="NotRequired",t[t.Required=1]="Required",t[t.COUNT=2]="COUNT",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/terrain/PremultipliedAlphaSource":function(){define(["exports"],(function(e){"use strict";var t;e.PremultipliedAlphaSource=void 0,(t=e.PremultipliedAlphaSource||(e.PremultipliedAlphaSource={}))[t.Off=0]="Off",t[t.On=1]="On",t[t.COUNT=2]="COUNT",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/BlendModes.glsl":function(){define(["exports","../output/BlendOptions","../../shaderModules/glsl"],(function(e,t,r){"use strict";e.BlendModes=function(e,i){const s=i.blendMode;s!==t.LayerBlendMode.Normal&&(s===t.LayerBlendMode.Reflect&&e.code.add(r.glsl`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),s!==t.LayerBlendMode.ColorDodge&&s!==t.LayerBlendMode.VividLight||e.code.add(r.glsl`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),s!==t.LayerBlendMode.ColorBurn&&s!==t.LayerBlendMode.VividLight||e.code.add(r.glsl`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),s===t.LayerBlendMode.Overlay&&e.code.add(r.glsl`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),s===t.LayerBlendMode.HardLight&&e.code.add(r.glsl`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),s===t.LayerBlendMode.SoftLight&&e.code.add(r.glsl`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),s===t.LayerBlendMode.VividLight&&e.code.add(r.glsl`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),s!==t.LayerBlendMode.Hue&&s!==t.LayerBlendMode.Saturation&&s!==t.LayerBlendMode.Color&&s!==t.LayerBlendMode.Luminosity||(e.code.add(r.glsl`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),s!==t.LayerBlendMode.Hue&&s!==t.LayerBlendMode.Saturation||e.code.add(r.glsl`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(r.glsl`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${s===t.LayerBlendMode.Multiply?r.glsl`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Average?r.glsl`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Lighten?r.glsl`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Darken?r.glsl`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Lighter?r.glsl`return vec4(cl * ol + cb * ob, ol + ob);`:s===t.LayerBlendMode.Plus?r.glsl`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:s===t.LayerBlendMode.Minus?r.glsl`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:s===t.LayerBlendMode.Screen?r.glsl`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Difference?r.glsl`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Invert?r.glsl`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:s===t.LayerBlendMode.DestinationOver?r.glsl`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:s===t.LayerBlendMode.DestinationAtop?r.glsl`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:s===t.LayerBlendMode.DestinationOut?r.glsl`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:s===t.LayerBlendMode.SourceAtop?r.glsl`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:s===t.LayerBlendMode.SourceOut?r.glsl`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:s===t.LayerBlendMode.Xor?r.glsl`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:s===t.LayerBlendMode.DestinationIn?r.glsl`return vec4(cb * ob * ol, ol * ob);`:s===t.LayerBlendMode.SourceIn?r.glsl`return vec4(cl * ol * ob, ol * ob);`:s===t.LayerBlendMode.Hue?r.glsl`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Saturation?r.glsl`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Color?r.glsl`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Luminosity?r.glsl`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Exclusion?r.glsl`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Reflect?r.glsl`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.ColorDodge?r.glsl`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.ColorBurn?r.glsl`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.Overlay?r.glsl`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.SoftLight?r.glsl`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.HardLight?r.glsl`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:s===t.LayerBlendMode.VividLight?r.glsl`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r.glsl``}
    }
  `))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TileCompositor":function(){define(["exports","../../../core/Logger","../../../core/maybe","../../../core/libs/gl-matrix-2/factories/vec2f64","../../2d/engine/imagery/enums","../../2d/engine/vectorTiles/VectorTileRendererHelper3D","./BlendLayersTechnique","./BlendLayersTechniqueConfiguration","./LayerClass","./RasterColorizerTechnique","./RasterColorizerTechniqueConfiguration","./support/MultiSizeFramebuffer","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderLibrary/terrain/BaseOpacityMode","../webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput","../webgl-engine/core/shaderLibrary/terrain/PremultipliedAlphaSource","../../../chunks/BlendLayers.glsl","../webgl-engine/lib/BindParameters","../webgl-engine/lib/glUtil3D","../../webgl/enums","../../webgl/Texture","../../webgl/Util"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S){"use strict";e.TileCompositor=class{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new n.VectorTileRendererHelper3D,this._bindParameters=new y.BindParameters(null),this._blendConfiguration=new a.BlendLayersTechniqueConfiguration,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=_.createQuadVAO(this._rctx,_.Layout.Pos2Tex)}dispose(){this._fbos.forEach(r.disposeMaybe),this._fbos=null,this._vtFBO=r.disposeMaybe(this._vtFBO),this._vaoQuad=r.disposeMaybe(this._vaoQuad),this._vectorTileHelper=r.disposeMaybe(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendTechnique(e,t,r,i=f.PremultipliedAlphaSource.Off,s=g.BackgroundMode.BelowLayer){return this._blendConfiguration.output=t,this._blendConfiguration.blendMode=e,this._blendConfiguration.baseOpacityMode=r,this._blendConfiguration.premultipliedSource=i,this._blendConfiguration.background=s,this._techniques.precompile(o.BlendLayersTechnique,this._blendConfiguration),this._techniques.get(o.BlendLayersTechnique,this._blendConfiguration)}drawBackground(e,t){const r=this._acquireBlendTechnique(h.LayerBlendMode.Normal,t?m.BlendLayersOutput.ColorComposite:m.BlendLayersOutput.GridComposite,p.BaseOpacityMode.NotRequired,f.PremultipliedAlphaSource.Off,g.BackgroundMode.Only),i=this._rctx.bindTechnique(r,this._bindParameters,e);this._render(i)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(b.PrimitiveType.TRIANGLE_STRIP,0,S.vertexCount(this._vaoQuad,"geometry"))}drawGroup(e,t,r,i,s=f.PremultipliedAlphaSource.On){t===m.BlendLayersOutput.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(r).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture)),e.texture=this.currentFBO(r).colorTexture,this.closeGroup(r);const n=e.baseOpacity<1?p.BaseOpacityMode.Required:p.BaseOpacityMode.NotRequired,o=this._acquireBlendTechnique(i,t,n,s),a=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(a)}drawImageData(e,t,r,i,s=f.PremultipliedAlphaSource.Off){if(null==e.texture)return;const n=e.baseOpacity<1?p.BaseOpacityMode.Required:p.BaseOpacityMode.NotRequired;e.fboTexture=t===m.BlendLayersOutput.GroupBackgroundComposite||i===h.LayerBlendMode.Normal&&n===p.BaseOpacityMode.NotRequired&&s===f.PremultipliedAlphaSource.Off?null:this.switch(r).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture);const o=this._acquireBlendTechnique(i,t,n,s),a=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(a)}drawRasterData(e,t,r,i,s){const n=s.sourceLayerInfo.data;if(!n.source)return;if(s.tile.surface.layerViewByIndex(s.layerIndex,l.LayerClass.MAP).ensureSymbolizerParameters(n),!n.bind(this._rctx))return;const o=e.baseOpacity<1?p.BaseOpacityMode.Required:p.BaseOpacityMode.NotRequired;e.fboTexture=i===h.LayerBlendMode.Normal&&o===p.BaseOpacityMode.NotRequired?null:this.switch(r).colorTexture;const a=this._acquireRasterTechnique(n,t,i,o);if(!a)return;n.opacity=e.opacity;const c=n.getUniforms(this._rctx);c.scale=s.scale,c.offset=s.offset,c.backgroundColor=e.backgroundColor,c.fboTexture=e.fboTexture,c.baseOpacity=e.baseOpacity;const u=this._rctx.bindTechnique(a,this._bindParameters,c);this._render(u)}_acquireRasterTechnique(e,t,r,i){if(!this._rctx.capabilities.colorBufferFloat)return null;const n=e.symbolizerParameters,o=["stretch","lut","hillshade"].indexOf(n.type);return this._rasterConfiguration??=new u.RasterColorizerTechniqueConfiguration,this._rasterConfiguration.output=t,this._rasterConfiguration.blendMode=r,this._rasterConfiguration.baseOpacityMode=i,this._rasterConfiguration.colorizerType=o,this._rasterConfiguration.applyColormap=!!n.colormap,this._rasterConfiguration.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterConfiguration.stretchType=e.hasStretchTypeNone()?s.RasterColorizerStretchType.Noop:s.RasterColorizerStretchType.PerBand,this._techniques.precompile(c.RasterColorizerTechnique,this._rasterConfiguration),this._techniques.get(c.RasterColorizerTechnique,this._rasterConfiguration)}drawVectorData(e,r,s,n,o,a,c,u){const g=this._rctx,y=o.sourceLayerInfo.data,_=o.tile.surface.layerViewByIndex(o.layerIndex,l.LayerClass.MAP),v=e.baseOpacity<1?p.BaseOpacityMode.Required:p.BaseOpacityMode.NotRequired,S=v===p.BaseOpacityMode.Required||e.opacity<1||n!==h.LayerBlendMode.Normal||r!==m.BlendLayersOutput.Composite,w=S?f.PremultipliedAlphaSource.On:f.PremultipliedAlphaSource.Off,x=this._acquireBlendTechnique(n,r,v,w);g.setPipelineState(x.getPipeline());let T=null,C=null;S?(C=this.currentFBO(s),null==this._vtFBO&&(this._vtFBO=new d.MultiSizeFramebuffer(this._rctx)),T=this._vtFBO.get(s),g.bindFramebuffer(T),this._clearCurrentFBO()):u&&g.clear(b.FramebufferBit.DEPTH);try{this._vectorTileHelper.renderBackground(g,o.sourceLod,_.painter,_.layer.styleRepository,_.schemaHelper,Math.round(1/o.scale),o.offset,c,a,_.contentZoom),y&&this._vectorTileHelper.renderContent(g,o.sourceLod,y,o.vtlNeighborInfos,_.painter,_.layer.styleRepository,_.schemaHelper,Math.round(1/o.scale),o.offset,c,a,_.contentZoom)}catch(e){t.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",e)}return!T||(g.bindFramebuffer(C),e.texture=T.colorTexture,e.offset=i.ZEROS,e.scale=1,this.drawImageData(e,r,s,n,w),u)}copyFBOToTexture(e){const t=this._rctx,r=t.bindTexture(e.texture,v.Texture.TEXTURE_UNIT_FOR_UPDATES),i=e.descriptor;t.gl.copyTexImage2D(b.TextureType.TEXTURE_2D,0,i.pixelFormat,0,0,i.width,i.height,0),e.generateMipmap(),t.bindTexture(r,v.Texture.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(b.FramebufferBit.COLOR|b.FramebufferBit.DEPTH|b.FramebufferBit.STENCIL)}_initFBO(e,t,r){this._rctx.bindFramebuffer(e),r&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,r=!0){if(this._current=t,t>=this._fbos.length)for(let e=this._fbos.length;e<=t;e++)this._fbos.push(new d.MultiSizeFramebuffer(this._rctx));this._initFBO(this._fbos[t].get(e),e,r)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),r=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/imagery/enums":function(){define(["exports"],(function(e){"use strict";var t,r;e.RasterColorizerType=void 0,(t=e.RasterColorizerType||(e.RasterColorizerType={}))[t.Stretch=0]="Stretch",t[t.Lut=1]="Lut",t[t.Hillshade=2]="Hillshade",t[t.COUNT=3]="COUNT",e.RasterColorizerStretchType=void 0,(r=e.RasterColorizerStretchType||(e.RasterColorizerStretchType={}))[r.Noop=0]="Noop",r[r.PerBand=1]="PerBand",r[r.COUNT=2]="COUNT",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/VectorTileRendererHelper3D":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../core/libs/gl-matrix-2/math/common","../../tiling/TileInfoView","../../tiling/TileKey","../../tiling/TileQueue","../../tiling/TileStrategy","./constants","./decluttering/jobsUtil","./style/StyleDefinition","../webgl/RenderableTile","../webgl/TileReshuffleManager","../../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class m{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=r.create(),this.displayViewMat3=r.create(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}}e.VectorTileRendererHelper3D=class{constructor(){this._renderParams={reshuffleManager:new h.TileReshuffleManager,context:null,drawPhase:1,state:new m,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new d.RenderableTile(new n(0,0,0,0),0,0,0,l.tilePixelSize,l.tilePixelSize,l.tileCoordSize,l.tileCoordSize),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,r,i,s,n,o,a,l,c){const u=this._backgroundTile;this._updateRenderParameters(e,t,u,r,s,n,o,a,l,c),this._renderParams.stencilSymbols=!1,r.drawBackground(this._renderParams,u,i)}renderContent(e,t,r,i,s,n,o,a,l,c,u,d){this._declutter(r),i.forAll((({sourceLayerInfo:{data:e}})=>this._declutter(e)));const h=i.length>0;h&&this._stencilSymbols(e,t,r,i,s,n,o,a,l,c,u,d);let m=1;r.stencilRef=h?m:0,e.setStencilFunction(p.CompareFunction.EQUAL,r.stencilRef,255),this._render(e,t,r,s,n,o,a,l,c,u,d),i.forAll((({sourceLod:t,offset:r,sourceLayerInfo:{data:i}})=>{i.stencilRef=++m,this._renderSymbols(e,t,i,s,n,o,a,r,c,u,d)}))}_stencilSymbols(e,t,r,i,s,n,o,a,l,c,u,d){let h=1;r.stencilRef=h,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(p.StencilOperation.KEEP,p.StencilOperation.KEEP,p.StencilOperation.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(p.CompareFunction.ALWAYS,r.stencilRef,255),this._stencilTileSymbols(e,t,r,s,n,o,a,l,c,u,d),i.forAll((({sourceLod:t,offset:r,sourceLayerInfo:{data:i}})=>{i.stencilRef=++h,e.setStencilFunction(p.CompareFunction.ALWAYS,i.stencilRef,255),this._stencilTileSymbols(e,t,i,s,n,o,a,r,c,u,d)})),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,r,i,s,n,o,a,l,c,d){e.setStencilFunction(p.CompareFunction.EQUAL,r.stencilRef,255),this._render(e,t,r,i,s,n,o,a,l,c,d,u.StyleLayerType.SYMBOL)}_render(e,t,r,i,s,n,o,a,l,c,u,d){this._updateRenderParameters(e,t,r,i,n,o,a,l,c,u),this._renderParams.stencilSymbols=!1,i.drawTile(this._renderParams,r,s,d)}_stencilTileSymbols(e,t,r,i,s,n,o,a,l,c,u){this._updateRenderParameters(e,t,r,i,n,o,a,l,c,u),this._renderParams.stencilSymbols=!0,r.triangleCount=0,i.drawSymbols(this._renderParams,r,s)}_updateRenderParameters(e,r,s,n,o,a,c,u,d,h){"type"in s&&"vector-tile"===s.type&&!s.stage&&s.attachWithContext(e);const p=r[0]-o.getLevelShift(r[0]),m=this._renderParams;m.context=e,m.painter=n,m.glyphMosaic=n.glyphMosaic,m.spriteMosaic=n.spriteMosaic,m.pixelRatio=d*h,m.displayLevel=p,m.requiredLevel=p;const f=o.getScale(r[0]),[g,y]=o.getOffset(r,a*f),_=l.tileCoordinateScale*a*f/u,b=s.transforms.displayViewScreenMat3;b[0]=_,b[4]=-_,b[6]=-1-g-c[0]*a*2,b[7]=1+y+(1-c[1])*a*2-2;const v=m.state,S=u/h;v.size[0]=S,v.size[1]=S,v.pixelRatio=h,v.rotation=(360-this._heading)%360;const w=2/S;t.set(v.displayViewMat3,w,0,0,0,-w,0,-1,1,1);const x=t.identity(v.displayMat3),T=i.toRadian(this._heading);t.translate(x,x,[S/2,S/2]),t.rotate(x,x,T),t.translate(x,x,[-S/2,-S/2]),t.multiply(x,v.displayViewMat3,x)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(c.declutterSingleTile(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/tiling/TileInfoView":function(){define(["../../../geometry/support/spatialReferenceUtils","./LODInfo","./TileCoverage","./TileKey","./TileSpan"],(function(e,t,r,i,s){"use strict";const n=new i("0/0/0/0");class o{static create(e,t){e[1]>t[1]&&([e,t]=[t,e]);const[r,i]=e,[s,n]=t,a=s-r,l=n-i,c=0!==l?a/l:0,u=(Math.ceil(i)-i)*c,d=(Math.floor(i)-i)*c;return new o(r,Math.floor(i),Math.ceil(n),c,a<0?u:d,a<0?d:u,a<0?s:r,a<0?r:s)}constructor(e,t,r,i,s,n,o,a){this.x=e,this.ymin=t,this.ymax=r,this.invM=i,this.leftAdjust=s,this.rightAdjust=n,this.leftBound=o,this.rightBound=a}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const a=[[0,0],[0,0],[0,0],[0,0]];return class{constructor(e,r=null,i=e.lods[0].level,s=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=r,this.scales=[],this._infoByScale={},this._infoByLevel={};const n=e.lods.filter((e=>e.level>=i&&e.level<=s));this.minScale=n[0].scale,this.maxScale=n[n.length-1].scale;const o=this._lodInfos=n.map((i=>t.create(e,i,r)));n.forEach(((e,t)=>{this._infoByLevel[e.level]=o[t],this._infoByScale[e.scale]=o[t],this.scales[t]=e.scale}),this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel["number"==typeof e?e:e.level]}getTileBounds(e,t,r=!1){n.set(t);const i=this._infoByLevel[n.level];return i?i.getTileBounds(e,n,r):e}getTileCoords(e,t,r=!1){n.set(t);const i=this._infoByLevel[n.level];return i?i.getTileCoords(e,n,r):e}getTileCoverage(e,t=192,i=!0,n="closest"){if(!i&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const l="closest"===n?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),c=r.pool.acquire(l),u=this._wrap;let d,h,p,m=1/0,f=-1/0;const g=c.spans;a[0][0]=a[0][1]=a[1][1]=a[3][0]=-t,a[1][0]=a[2][0]=e.size[0]+t,a[2][1]=a[3][1]=e.size[1]+t;for(const t of a)e.toMap(t,t),t[0]=l.getColumnForX(t[0]),t[1]=l.getRowForY(t[1]);const y=[];let _=3;for(let e=0;e<4;e++){if(a[e][1]===a[_][1]){_=e;continue}const t=o.create(a[e],a[_]);m=Math.min(t.ymin,m),f=Math.max(t.ymax,f),void 0===y[t.ymin]&&(y[t.ymin]=[]),y[t.ymin].push(t),_=e}if(null==m||null==f||f-m>100)return null;let b=[];for(d=m;d<f;){null!=y[d]&&(b=b.concat(y[d])),h=1/0,p=-1/0;for(let e=b.length-1;e>=0;e--){const t=b[e];h=Math.min(h,t.getLeftCol()),p=Math.max(p,t.getRightCol())}if(h=Math.floor(h),p=Math.floor(p),d>=l.first[1]&&d<=l.last[1])if(u)if(l.size[0]<l.worldSize[0]){const e=Math.floor(p/l.worldSize[0]);for(let t=Math.floor(h/l.worldSize[0]);t<=e;t++)g.push(new s(d,Math.max(l.getFirstColumnForWorld(t),h),Math.min(l.getLastColumnForWorld(t),p)))}else g.push(new s(d,h,p));else h>l.last[0]||p<l.first[0]||(h=Math.max(h,l.first[0]),p=Math.min(p,l.last[0]),g.push(new s(d,h,p)));d+=1;for(let e=b.length-1;e>=0;e--){const t=b[e];t.ymax>=d?t.incrRow():b.splice(e,1)}}return c}getTileParentId(e){n.set(e);const t=this._infoByLevel[n.level],r=this._lodInfos.indexOf(t)-1;return r<0?null:(this._getTileIdAtLOD(n,this._lodInfos[r],n),n.id)}getTileResolution(e){const t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1}getTileScale(e){const t=this._infoByLevel[e.level];return t?t.scale:-1}intersects(e,t){n.set(t);const r=this._infoByLevel[n.level],i=e.lodInfo;if(i.resolution>r.resolution){this._getTileIdAtLOD(n,i,n);const t=i.denormalizeCol(n.col,n.world);for(const r of e.spans)if(r.row===n.row&&r.colFrom<=t&&r.colTo>=t)return!0}if(i.resolution<r.resolution){const[t,s,o,a]=e.spans.reduce(((e,t)=>(e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e)),[1/0,-1/0,1/0,-1/0]),l=r.denormalizeCol(n.col,n.world),c=i.getColumnForX(r.getXForColumn(l)),u=i.getRowForY(r.getYForRow(n.row)),d=i.getColumnForX(r.getXForColumn(l+1))-1,h=i.getRowForY(r.getYForRow(n.row+1))-1;return!(c>a||d<o||u>s||h<t)}const s=i.denormalizeCol(n.col,n.world);return e.spans.some((e=>e.row===n.row&&e.colFrom<=s&&e.colTo>=s))}normalizeBounds(t,r,i){if(t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],this._wrap){const r=e.getInfo(this.tileInfo.spatialReference),s=-i*(r.valid[1]-r.valid[0]);t[0]+=s,t[2]+=s}return t}getSmallestInfoForScale(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let r=1;r<t.length-1;r++)if(e>t[r]+1e-6)return this._infoByScale[t[r-1]];return this._infoByScale[t[t.length-1]]}getClosestInfoForScale(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce(((t,r)=>Math.abs(r-e)<Math.abs(t-e)?r:t),t[0])),this._infoByScale[e]}scaleToLevel(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let r=t.length-1;r>=0;r--)if(e<t[r])return r===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[r]].level+(t[r]-e)/(t[r]-t[r+1]);return this._infoByScale[t[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}zoomToScale(e){return this.tileInfo.zoomToScale(e)}_getTileIdAtLOD(e,t,r){const i=this._infoByLevel[r.level];return e.set(r),t.resolution<i.resolution?null:(t.resolution===i.resolution||(e.level=t.level,e.col=Math.floor(r.col*i.resolution/t.resolution+.01),e.row=Math.floor(r.row*i.resolution/t.resolution+.01)),e)}}}))},"esri/views/2d/tiling/LODInfo":function(){define(["../../../geometry/support/spatialReferenceUtils","./TileKey"],(function(e,t){"use strict";function r(e,t){return[e,t]}function i(e,t,r){return e[0]=t,e[1]=r,e}const s=new t("0/0/0/0");class n{static create(t,s,o=null){const a=e.getInfo(t.spatialReference),l=s.origin||r(t.origin.x,t.origin.y),c=r(t.size[0]*s.resolution,t.size[1]*s.resolution),u=r(-1/0,-1/0),d=r(1/0,1/0),h=r(1/0,1/0);null!=o&&(i(u,Math.max(0,Math.floor((o.xmin-l[0])/c[0])),Math.max(0,Math.floor((l[1]-o.ymax)/c[1]))),i(d,Math.max(0,Math.floor((o.xmax-l[0])/c[0])),Math.max(0,Math.floor((l[1]-o.ymin)/c[1]))),i(h,d[0]-u[0]+1,d[1]-u[1]+1));const{cols:p,rows:m}=s;let f,g,y,_;return!o&&p&&m&&(i(u,p[0],m[0]),i(d,p[1],m[1]),i(h,p[1]-p[0]+1,m[1]-m[0]+1)),t.isWrappable?(f=r(Math.ceil(Math.round((a.valid[1]-a.valid[0])/s.resolution)/t.size[0]),h[1]),g=!0,y=a.origin,_=a.valid):(f=h,g=!1),new n(s.level,s.resolution,s.scale,l,u,d,h,c,f,g,y,_)}constructor(e,t,r,i,s,n,o,a,l,c,u,d){this.level=e,this.resolution=t,this.scale=r,this.origin=i,this.first=s,this.last=n,this.size=o,this.norm=a,this.worldSize=l,this.wrap=c,this._spatialReferenceOrigin=u,this._spatialReferenceValid=d}normalizeCol(e){if(!this.wrap)return e;const t=this.worldSize[0];return e<0?t-1-Math.abs((e+1)%t):e%t}normalizeKey(e){if(!this.wrap)return;const t=this.worldSize[0],r=e.col;r<0?(e.col=r+t,e.world-=1):r>=t&&(e.col=r-t,e.world+=1)}denormalizeCol(e,t){return this.wrap?this.worldSize[0]*t+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){const t=this.origin[0]+e*this.norm[0],r=this._spatialReferenceOrigin,i=this._spatialReferenceValid;return this.wrap&&r&&i?t===r[0]?i[0]:this.origin[0]===r[0]&&e===this.worldSize[0]?i[1]:t:t}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,t,r=!1){s.set(t);const i=r?s.col:this.denormalizeCol(s.col,s.world),n=s.row;return function(e,t,r,i,s){e[0]=t,e[1]=r,e[2]=i,e[3]=s}(e,this.getXForColumn(i),this.getYForRow(n+1),this.getXForColumn(i+1),this.getYForRow(n)),e}getTileCoords(e,t,r=!1){s.set(t);const n=r?s.col:this.denormalizeCol(s.col,s.world);return Array.isArray(e)?i(e,this.getXForColumn(n),this.getYForRow(s.row)):(e.x=this.getXForColumn(n),e.y=this.getYForRow(s.row)),e}}return n}))},"esri/views/2d/tiling/TileKey":function(){define(["../../../core/ObjectPool"],(function(e){"use strict";class t{static{this.pool=new e(t,null,null,25,50)}static getId(e,t,r,i){return"object"==typeof e?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${t}/${r}/${i}`}constructor(e,t,r,i){this.set(e,t,r,i)}get key(){return this}get id(){return this.toString()}get normalizedId(){return`${this.level}/${this.row}/${this.col}`}set id(e){this.set(e)}get hash(){const e=4095&this.row,t=4095&this.col,r=63&this.level;return(3&this.world)<<30|t<<22|e<<8|r}acquire(e,t,r,i){this.set(e,t,r,i)}contains(e){const t=e.level-this.level;return t>=0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}containsChild(e){const t=e.level-this.level;return t>0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new t(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,t,r,i){if(null==e)this.level=0,this.row=0,this.col=0,this.world=0;else if("object"==typeof e)this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if("string"==typeof e){const[t,r,i,s]=e.split("/");this.level=parseFloat(t),this.row=parseFloat(r),this.col=parseFloat(i),this.world=parseFloat(s)}else this.level=+e,this.row=+t,this.col=+r,this.world=+i||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new t(this.level-1,this.row>>1,this.col>>1,this.world)}getNormalizedNeighbor(e,t,r){const i=this.clone();return i.col+=e,i.row+=t,r.normalizeKey(i),i}getChildKeys(){const e=this.level+1,r=this.row<<1,i=this.col<<1,s=this.world;return[new t(e,r,i,s),new t(e,r,i+1,s),new t(e,r+1,i,s),new t(e,r+1,i+1,s)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}}return t}))},"esri/views/2d/tiling/TileCoverage":function(){define(["../../../core/ObjectPool","./TileKey"],(function(e,t){"use strict";class r{constructor(){this.spans=[]}static{this.pool=new e(r)}acquire(e){this.lodInfo=e}release(){this.lodInfo=null,this.spans.length=0}*keys(){const e=this.lodInfo;for(const{row:r,colFrom:i,colTo:s}of this.spans)for(let n=i;n<=s;n++){const i=e.getWorldForColumn(n);yield new t(e.level,r,e.normalizeCol(n),i)}}forEach(e,t){const{spans:r,lodInfo:i}=this,{level:s}=i;if(0!==r.length)for(const{row:n,colFrom:o,colTo:a}of r)for(let r=o;r<=a;r++)e.call(t,s,n,i.normalizeCol(r),i.getWorldForColumn(r))}}return r}))},"esri/views/2d/tiling/TileSpan":function(){define((function(){"use strict";return class{constructor(e,t,r){this.row=e,this.colFrom=t,this.colTo=r}}}))},"esri/views/2d/tiling/TileQueue":function(){define(["../../../chunks/tslib.es6","../../../core/Accessor","../../../core/MapUtils","../../../core/maybe","../../../core/SetUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../support/ScheduledQueueProcessor"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=[0,0];let p=class extends t{constructor(e){super(e),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:e,process:t,scheduler:r,priority:i}=this;this._queue=new d.ScheduledQueueProcessor({concurrency:e,scheduler:r,priority:i,process:(e,r)=>{const i=this._keyToItem.get(e);return t(i,{signal:r})},peeker:e=>this._peek(e)})}destroy(){this.clear(),this._queue=i.destroyMaybe(this._queue)}get length(){return this._queue?this._queue.length:0}abort(e){const t="string"==typeof e?e:e.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(e){return"string"==typeof e?this._keyToItem.has(e):this._keyToItem.has(e.id)}pause(){this._queue.pause()}push(e){const t=e.key.id;if(this._queue.has(t))return this._queue.get(t);const i=this._queue.push(t),s=this.tileInfoView.getTileScale(e.key),n=r.getOrCreateMapValue(this._tilesByScale,s,(()=>new Set)),o=()=>{n.delete(e.key),0===n.size&&this._tilesByScale.delete(s),this._keyToItem.delete(t)};return n.add(e.key),this._keyToItem.set(t,e),i.then(o,o),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(e){if(!this.state)return e.values().next().value;const t=new Set;for(const r of e)t.add(this._keyToItem.get(r).key);const r=this.state.scale;let i,n=Number.POSITIVE_INFINITY;for(const[e,o]of this._tilesByScale)if(s.someSet(o,(e=>t.has(e)))){const t=Math.abs(e-r);t<n&&(i=o,n=t)}return this._getClosestTileKey(i,e).id}_getClosestTileKey(e,t){const r=this.tileInfoView,i=this.state.center;let s,n=Number.POSITIVE_INFINITY;for(const o of e)if(t.has(o.id)){r.getTileCoords(h,o);const e=u.distance(h,i);e<n&&(n=e,s=o)}return s}};return e.__decorate([n.property({constructOnly:!0})],p.prototype,"concurrency",void 0),e.__decorate([n.property({constructOnly:!0})],p.prototype,"priority",void 0),e.__decorate([n.property({constructOnly:!0})],p.prototype,"process",void 0),e.__decorate([n.property({constructOnly:!0})],p.prototype,"scheduler",void 0),e.__decorate([n.property()],p.prototype,"state",void 0),e.__decorate([n.property({constructOnly:!0})],p.prototype,"tileInfoView",void 0),p=e.__decorate([c.subclass("esri.views.2d.tiling.TileQueue")],p),p}))},"esri/views/support/ScheduledQueueProcessor":function(){define(["exports","../../core/has","../../core/maybe","../../core/promiseUtils","../../core/Queue","../../core/ReactiveMap","../../core/scheduling","../../core/signal"],(function(e,t,r,i,s,n,o,a){"use strict";class l{constructor(e,t){this.item=e,this.controller=t,this.promise=null}}e.ScheduledQueueProcessor=class{constructor(e){this._schedule=null,this._task=null,this._deferreds=new n,this._controllers=new n,this._processingItems=new n,this._pausedSignal=a.signal(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new s(e.peeker),this.process=e.process;const t=e.scheduler;e.priority&&t&&(this._task=t.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=r.removeMaybe(this._schedule),this._task=r.removeMaybe(this._task)}get updating(){return!!this._task?.updating||this.running}get length(){return this._processingItems.size+this._queue.length}abort(e){const t=this._controllers.get(e);t&&t.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach((t=>e.push(t))),this._controllers.clear(),e.forEach((e=>e.abort())),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach(((t,r)=>e(r)))}get(e){const t=this._deferreds.get(e);return t?t.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,t){const r=this.get(e);if(r)return r;const s=new AbortController;let n=null;t&&(n=i.onAbort(t,(()=>s.abort())));const o=()=>{a.remove(),null!=n&&n.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},a=i.onAbortOrThrow(s.signal,(()=>{const t=this._processingItems.get(e);t&&t.controller.abort(),o(),l.reject(i.createAbortError())})),l=i.createResolver();return this._deferreds.set(e,l),this._controllers.set(e,s),l.promise.then(o,o),this._queue.push(e),this._scheduleNext(),l.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){const e=this._queue.popLast();return e&&(this._deferreds.get(e)?.reject(i.createAbortError()),this._removeItem(e)),e}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const t of e)this._queue.push(t.item),t.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=o.schedule((()=>{this._schedule=null,this._next()})))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}_processError(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(null==e)return;let t;const r=new AbortController,s=new l(e,r);this._processingItems.set(e,s);try{t=this.process(e,r.signal)}catch(e){this._processError(s,e)}i.isPromiseLike(t)?(s.promise=t,t.then((e=>this._processResult(s,e)),(e=>this._processError(s,e)))):this._processResult(s,t)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/tiling/TileStrategy":function(){define(["../../../geometry/support/aaBoundingRect","./TileCache","./TileCoverage","./TileKey"],(function(e,t,r,i){"use strict";const s=new i(0,0,0,0),n=new Map,o=[],a=[];return class{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,null!=e.resampling&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),null!=e.buffer&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new t(e.cacheSize,this.tileInfoView,(e=>{this.releaseTile(e)})))}destroy(){this.tileIndex.clear()}update(e){const{resampling:t,tileIndex:i}=this,{scale:l,center:c,resolution:u}=e.state,{minScale:d,maxScale:h}=this.tileInfoView,p=!e.stationary&&l>this._previousScale;if(this._previousScale=l,!t&&(l>d||l<h))return this.tiles.length=0,void this.clear();const m=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!m)return this.tiles.length=0,void this.clear();const{spans:f,lodInfo:g}=m,{level:y}=g;this.tiles.length=0,i.forEach((e=>e.visible=!0));let _=0,b=0;if(f.length>0)for(const{row:e,colFrom:t,colTo:r}of f)for(let o=t;o<=r;o++){_++;const t=s.set(y,e,g.normalizeCol(o),g.getWorldForColumn(o)).id;let r=i.get(t);if(r)r.isReady?(n.set(t,r),b++):p||this._addParentTile(t,n);else{if(this._tileCache?.has(t)){if(r=this._tileCache.pop(t),this.tileIndex.set(t,r),r.isReady){n.set(t,r),b++;continue}}else r=this.acquireTile(s),this.tileIndex.set(t,r);p||this._addParentTile(t,n)}}const v=b===_;for(const[e,t]of i){if(n.has(e))continue;s.set(e);const r=this.tileInfoView.intersects(m,s),i="purge"===this.cachePolicy?s.level!==y:s.level>y;!r||!p&&v?!i&&r||o.push(t):t.isReady?i&&"purge"===this.cachePolicy&&this._hasReadyAncestor(s,y)?o.push(t):a.push(t):i&&o.push(t)}for(const e of a)e.isReady&&n.set(e.key.id,e);for(const e of o)this._tileCache?this._tileCache.add(e):this.releaseTile(e),i.delete(e.key.id);for(const e of n.values())this.tiles.push(e);for(const e of i.values())n.has(e.key.id)||(e.visible=!1);this._tileCache?.prune(y,c,u),r.pool.release(m),a.length=0,o.length=0,n.clear()}clear(){const{tileIndex:e}=this;for(const t of e.values())this.releaseTile(t);e.clear()}refresh(e){for(const t of this.tileIndex.values())e(t);this._tileCache?.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,t){let r=e,i=null;for(;r=this.tileInfoView.getTileParentId(r),r;)if(this.tileIndex.has(r)){if(i=this.tileIndex.get(r),i?.isReady){t.has(i.key.id)||t.set(i.key.id,i);break}}else if(this._tileCache?.has(r)&&(i=this._tileCache.pop(r),this.tileIndex.set(r,i),i?.isReady)){t.has(i.key.id)||t.set(i.key.id,i);break}}_hasReadyAncestor(t,r){const i=e.create();this.tileInfoView.getTileBounds(i,t,!0);for(const s of this.tileIndex.values())if(s.isReady&&s.key.level>=r&&s.key.level<t.level){const t=e.create();if(this.tileInfoView.getTileBounds(t,s.key,!0),e.contains(t,i))return!0}return!1}}}))},"esri/views/2d/tiling/TileCache":function(){define(["../../../core/libs/gl-matrix-2/math/vec2"],(function(e){"use strict";function t(e,t){e.delete(t)}return class{constructor(e,t,r){this.maxSize=e,this._tileInfoView=t,this._removedFunc=r,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(e){return this._tilePerId.has(e)}get(e){return this._tilePerId.get(e)}pop(e){const r=this._tilePerId.get(e);if(!r)return;const i=r.key.level,s=this._tileKeysPerLevel[i];t(this._tilePerId,e);for(let t=0;t<s.length;t++)if(s[t].id===e){s.splice(t,1);break}return r.visible=!0,r}add(e){e.visible=!1;const t=e.key,r=t.id;if(this._tilePerId.has(r))return;this._tilePerId.set(r,e);const i=t.level;this._tileKeysPerLevel[i]||(this._tileKeysPerLevel[i]=[]),this._tileKeysPerLevel[i].push(t)}prune(e,t,r){let i=this._tilePerId.size;if(i<=this.maxSize)return;let s=this._tileKeysPerLevel.length-1;for(;i>this.maxSize&&s>=0;)s!==e&&(i=this._pruneAroundCenterTile(i,t,r,s)),s--;i>this.maxSize&&(i=this._pruneAroundCenterTile(i,t,r,e))}_pruneAroundCenterTile(t,r,i,s){const n=this._tileKeysPerLevel[s];if(!n||0===n.length)return t;const{size:o,origin:a}=this._tileInfoView.tileInfo,l=i*o[0],c=i*o[1],u=[0,0],d=[0,0];for(n.sort(((t,i)=>(u[0]=a.x+l*(t.col+.5),u[1]=a.y-c*(t.row+.5),d[0]=a.x+l*(i.col+.5),d[1]=a.y-c*(i.row+.5),e.squaredDistance(u,r)-e.squaredDistance(d,r))));n.length>0;){const e=n.pop();if(this._removeTile(e.id),--t===this.maxSize)break}return t}_removeTile(e){const r=this._tilePerId.get(e);this._removedFunc&&r&&this._removedFunc(r),t(this._tilePerId,e)}}}))},"esri/views/2d/engine/vectorTiles/constants":function(){define(["exports"],(function(e){"use strict";e.tileCoordSize=4096,e.tileCoordinateScale=.125,e.tilePixelRatio=8,e.tilePixelSize=512,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/decluttering/jobsUtil":function(){define(["exports","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f32","../../../../../core/libs/gl-matrix-2/math/common","../constants","./CollisionJob","./SymbolDeclutterer","./SymbolRepository","./util","../style/StyleDefinition"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=r.create();e.declutterSingleTile=function(e,r){const d=e.transforms.tileUnitsToPixels,h=i.toRadian(r),p=Math.cos(h),m=Math.sin(h),f=Math.ceil(512*(Math.abs(m)+Math.abs(p)));t.identity(u),t.translate(u,u,[f/2,f/2]),t.rotate(u,u,h),t.translate(u,u,[-256,-256]),t.scale(u,u,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=u;const g=[],y=new a.SymbolRepository(s.tileCoordSize,g),_=new o.SymbolDeclutterer("vector-tile",g,y,null,((t,i,s)=>new n.CollisionJob(t,i,s,e.styleRepository,e.key.level,r)),((e,t)=>{l.writeOpacityToBuffers(e,t,!1)}),(()=>0),(t=>{const r=e.styleRepository.getStyleLayerByUID(t).getLayoutProperty("visibility");return!r||r.getValue()!==c.Visibility.NONE}));g.push(e),y.registerVectorTile(e),_.setScreenSize(f,f),_.continue(1/0),y.unregisterVectorTile(e),e.transforms.tileUnitsToPixels=d},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/libs/gl-matrix-2/factories/mat3f32":function(){define(["exports"],(function(e){"use strict";function t(){const e=new Float32Array(9);return e[0]=1,e[4]=1,e[8]=1,e}function r(e){const t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function i(e,t,r,i,s,n,o,a,l){const c=new Float32Array(9);return c[0]=e,c[1]=t,c[2]=r,c[3]=i,c[4]=s,c[5]=n,c[6]=o,c[7]=a,c[8]=l,c}const s=Object.freeze(Object.defineProperty({__proto__:null,clone:r,create:t,fromValues:i},Symbol.toStringTag,{value:"Module"}));e.clone=r,e.create=t,e.fromValues=i,e.mat3f32=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/decluttering/CollisionJob":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/mat3f32","./config","./util","../style/StyleDefinition"],(function(e,t,r,i,s){"use strict";e.CollisionJob=class{constructor(e,s,n,o,a,l){this._symbols=e,this._styleRepository=o,this._zoom=a,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new i.GridIndex(s,n,r.collisionGridCellSize),this._si=Math.sin(Math.PI*l/180),this._co=Math.cos(Math.PI*l/180),o.cachedStyles&&(this._styleProps=o.cachedStyles);for(const r of e)for(const e of r.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,t.clone(e.tile.transforms.tileUnitsToPixels))}work(e){const t=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const r=this._symbols[this._currentLayerCursor],i=this._getProperties(r.styleLayerUID),s=this._styleRepository.layerContexts?.get(r.styleLayerUID);for(;this._currentSymbolCursor<r.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-t>e)return!1;const n=r.symbols[this._currentSymbolCursor];if(!n.uniqueSymbol?.show)continue;const o=this._computeCoordinates(n,i,s),a=n.uniqueSymbol;if(!a.show)continue;const{iconAllowOverlap:l,textAllowOverlap:c}=i;for(const e of o){if(!e.enabled)continue;const t=a.parts[e.partIndex];t.show&&!(e.partIndex?c:l)&&this._doesCollide(e)&&(e.hard?a.show=!1:t.show=!1)}a.show&&this._insertColliders(a.parts,o,i)}}return!0}_insertColliders(e,t,r){const{iconIgnorePlacement:i,textIgnorePlacement:s}=r;for(const r of t){if(!r.enabled)continue;if(r.partIndex?s:i)continue;if(!e[r.partIndex].show)continue;const t=r.xScreen+r.dxScreen,n=r.yScreen+r.dyScreen,o=t+r.width,a=n+r.height,[l,c,u,d]=this._gridIndex.getCellSpan(t,n,o,a);for(let e=c;e<=d;e++)for(let t=l;t<=u;t++)this._gridIndex.cells[e][t].push(r)}}_computeCoordinates(e,t,r){const{iconRotationAlignment:i,textRotationAlignment:n,iconTranslate:o,iconTranslateAnchor:a,textTranslate:l,textTranslateAnchor:c}=t,u=this._si,d=this._co,h=this._zoom,p=this._allNeededMatrices.get(e.tile),m=e.uniqueSymbol,f=e.colliders(r);let g=0;for(const e of f){const[t,r]=0===e.partIndex?o:l,m=0===e.partIndex?a:c,f=e.minLod<=h&&h<=e.maxLod;g+=f?0:1,e.enabled=f,e.xScreen=e.xTile*p[0]+e.yTile*p[3]+p[6],e.yScreen=e.xTile*p[1]+e.yTile*p[4]+p[7],m===s.TranslateAnchor.MAP?(e.xScreen+=d*t-u*r,e.yScreen+=u*t+d*r):(e.xScreen+=t,e.yScreen+=r),s.RotationAlignment.VIEWPORT===(0===e.partIndex?i:n)?(e.dxScreen=e.dxPixels,e.dyScreen=e.dyPixels):(e.dxScreen=d*(e.dxPixels+e.width/2)-u*(e.dyPixels+e.height/2)-e.width/2,e.dyScreen=u*(e.dxPixels+e.width/2)+d*(e.dyPixels+e.height/2)-e.height/2)}return f.length>0&&g===f.length&&m&&(m.show=!1),f}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const r=this._styleRepository.getLayerStyleProperties?.(e,this._zoom);return this._styleProps.set(e,r),r}_doesCollide(e){const t=e.xScreen+e.dxScreen,r=e.yScreen+e.dyScreen,i=t+e.width,s=r+e.height,[n,o,a,l]=this._gridIndex.getCellSpan(t,r,i,s);for(let c=o;c<=l;c++)for(let o=n;o<=a;o++){const n=this._gridIndex.cells[c][o];for(const o of n){if(null!=o.labelId&&null!=e.labelId&&o.labelId===e.labelId)continue;const n=o.xScreen+o.dxScreen,a=o.yScreen+o.dyScreen,l=n+o.width,c=a+o.height;if(!(i<n||t>l||s<a||r>c))return!0}}return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/decluttering/config":function(){define(["exports"],(function(e){"use strict";e.collisionGridCellSize=32,e.declutterBudget=1.5,e.declutterTiles=!0,e.fadeDuration=200,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/decluttering/util":function(){define(["exports","../enums","../GeometryUtils","./core"],(function(e,t,r,i){"use strict";function s(e,t,r,i,s,n){const o=r-s;if(o>=0)return(t>>o)+(i-(n<<o))*(e>>o);const a=-o;return t-(n-(i<<a))*(e>>a)<<a}function n(e,r,i,s,n){const o=e.layerData.get(n);if(o.type===t.BucketType.SYMBOL){for(const t of s){const r=t.uniqueSymbol;let s;if(t.selectedForRendering){const t=r.parts[0],n=t.startOpacity,o=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===o;const a=i?Math.floor(127*n)|o<<7:o?255:0;s=a<<24|a<<16|a<<8|a}else s=0;for(const[e,r]of t.iconVertexRanges)for(let t=e;t<e+r;t+=4)o.iconOpacity[t/4]=s;if(t.selectedForRendering){const t=r.parts[1],n=t.startOpacity,o=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===o;const a=i?Math.floor(127*n)|o<<7:o?255:0;s=a<<24|a<<16|a<<8|a}else s=0;for(const[e,r]of t.textVertexRanges)for(let t=e;t<e+r;t+=4)o.textOpacity[t/4]=s}o.lastOpacityUpdate=r,o.opacityChanged=!0}}e.GridIndex=class{constructor(e,t,r){this._rows=Math.ceil(t/r),this._columns=Math.ceil(e/r),this._cellSize=r,this.cells=new Array(this._rows);for(let e=0;e<this._rows;e++){this.cells[e]=new Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[e][t]=[]}}getCell(e,t){const r=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),i=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[r]&&this.cells[r][i]||null}getCellSpan(e,t,r,i){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}},e.deserializeSymbols=function(e,t,r,s,n,o,a){const l=t[s++];for(let c=0;c<l;c++){const l=new i.VTLSymbol(o,a);l.xTile=t[s++],l.yTile=t[s++],l.hash=t[s++],l.priority=t[s++],l.featureIndex=t[s++];const c=t[s++],u=l.colliders();for(let e=0;e<c;e++){const e=t[s++],i=t[s++],n=t[s++],o=t[s++],a=!!t[s++],l=t[s++],c=r[s++],d=r[s++],h=t[s++],p=t[s++];u.push({xTile:e,yTile:i,dxPixels:n,dyPixels:o,hard:a,partIndex:l,width:h,height:p,minLod:c,maxLod:d})}const d=e[s++];for(let t=0;t<d;t++)l.textVertexRanges.push([e[s++],e[s++]]);const h=e[s++];for(let t=0;t<h;t++)l.iconVertexRanges.push([e[s++],e[s++]]);n.push(l)}return s},e.isSearchCircleOverlapingSymbol=function(e,t,i,s){const n=e.colliders();let o,a,l,c;for(const u of n)if(e.uniqueSymbol?.show&&e.uniqueSymbol.parts[u.partIndex].show&&(o=u.xScreen-s[0]+u.dxScreen,a=u.yScreen-s[1]+u.dyScreen,l=o+u.width,c=a+u.height,r.isCircleOverlapingRect(i,t.x,t.y,o,a,l,c)))return!0;return!1},e.tileCoordChangeX=function(e,t,r,i){return s(e,t,r.level,r.col,i.key.level,i.key.col)},e.tileCoordChangeY=function(e,t,r,i){return s(e,t,r.level,r.row,i.level,i.row)},e.writeOpacityToBuffers=function(e,t,r){for(const[i,s]of e.symbols)n(e,t,r,s,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/enums":function(){define(["exports"],(function(e){"use strict";var t,r,i;e.BucketType=void 0,(t=e.BucketType||(e.BucketType={}))[t.FILL=1]="FILL",t[t.LINE=2]="LINE",t[t.SYMBOL=3]="SYMBOL",t[t.CIRCLE=4]="CIRCLE",e.ShaderProgramType=void 0,(r=e.ShaderProgramType||(e.ShaderProgramType={}))[r.BACKGROUND=0]="BACKGROUND",r[r.FILL=1]="FILL",r[r.OUTLINE=2]="OUTLINE",r[r.LINE=3]="LINE",r[r.ICON=4]="ICON",r[r.CIRCLE=5]="CIRCLE",r[r.TEXT=6]="TEXT",r[r.TILEINFO=7]="TILEINFO",e.StyleUpdateType=void 0,(i=e.StyleUpdateType||(e.StyleUpdateType={}))[i.PAINTER_CHANGED=0]="PAINTER_CHANGED",i[i.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",i[i.LAYER_CHANGED=2]="LAYER_CHANGED",i[i.LAYER_REMOVED=3]="LAYER_REMOVED",i[i.SPRITES_CHANGED=4]="SPRITES_CHANGED",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/GeometryUtils":function(){define(["exports","../../../../geometry/support/coordsUtils","../../../../geometry/support/TileClipper"],(function(e,t,r){"use strict";const i=Number.POSITIVE_INFINITY,s=Math.PI,n=2*s,o=128/s,a=256/360,l=s/180,c=1/Math.LN2;function u(e,t){return(e%=t)>=0?e:e+t}e.between=function(e,t,r){return e>=t&&e<=r||e>=r&&e<=t},e.c2pi=n,e.cDegTo256=a,e.cDegToRad=l,e.cInfinity=i,e.cPi=s,e.cRadTo256=o,e.degToByte=function(e){return u(e*a,256)},e.distanceFromToPolylineWithinThreshold=function(e,r,i,s){let n,o,a,l;const c=s*s;for(const s of i){const i=s.length;if(!(i<2)){n=s[0].x,o=s[0].y;for(let u=1;u<i;++u){if(a=s[u].x,l=s[u].y,t.distanceToSegmentSquared(e,r,n,o,a,l)<c)return!0;n=a,o=l}}}return!1},e.getTileMargins=function(e){return 8+Math.max(16*(e-14),0)},e.interpolate=function(e,t,r){return e*(1-r)+t*r},e.isCircleOverlapingRect=function(e,t,r,i,s,n,o){const a=Math.max(i,Math.min(t,n))-t,l=Math.max(s,Math.min(r,o))-r;return a*a+l*l<=e*e},e.log2=function(e){return Math.log(e)*c},e.offsetLine=function(e,t){if(0===t||Number.isNaN(t))return e;const i=[],s=new r.Point(0,0),n=new r.Point(0,0),o=new r.Point(0,0);for(let a=0;a<e.length;a++){const l=e[a],c=[];for(let e=0;e<l.length;e++){const i=l[e-1],a=l[e],u=l[e+1];0===e?s.setCoords(0,0):s.assignSub(a,i).normalize().rightPerpendicular(),e===l.length-1?n.setCoords(0,0):n.assignSub(u,a).normalize().rightPerpendicular(),o.assignAdd(s,n).normalize();const d=o.x*n.x+o.y*n.y;0!==d&&o.scale(1/d),c.push(r.Point.add(a,o.scale(t)))}i.push(c)}return i},e.pointInPolygon=function(e,t,r){let i,s,n,o=0;for(const a of r){i=a.length;for(let r=1;r<i;++r)s=a[r-1],n=a[r],s.y>t!=n.y>t&&((n.x-s.x)*(t-s.y)-(n.y-s.y)*(e-s.x)>0?o++:o--)}return 0!==o},e.positiveMod=u,e.radToByte=function(e){return u(e*o,256)},e.sqr=function(e){return e*e},e.translateAnchor=function(e,t,i,s){const n=new r.Point(e[0],e[1]);if(n.scale(s),"viewport"===t){const e=-i*(Math.PI/180),t=Math.cos(e),r=Math.sin(e);n.rotate(t,r)}return n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/TileClipper":function(){define(["exports"],(function(e){"use strict";var t,r;e.GeometryType=void 0,(t=e.GeometryType||(e.GeometryType={}))[t.Unknown=0]="Unknown",t[t.Point=1]="Point",t[t.LineString=2]="LineString",t[t.Polygon=3]="Polygon";class i{constructor(e,t){this.x=e,this.y=t}static fromArray(e){return new i(e[0],e[1])}clone(){return new i(this.x,this.y)}equals(e,t){return e===this.x&&t===this.y}isEqual(e){return e.x===this.x&&e.y===this.y}setCoords(e,t){return this.x=e,this.y=t,this}normalize(){const e=this.x,t=this.y,r=Math.sqrt(e*e+t*t);return this.x/=r,this.y/=r,this}rightPerpendicular(){const e=this.x;return this.x=this.y,this.y=-e,this}leftPerpendicular(){const e=this.x;return this.x=-this.y,this.y=e,this}move(e,t){return this.x+=e,this.y+=t,this}assign(e){return this.x=e.x,this.y=e.y,this}assignAdd(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}assignSub(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}rotate(e,t){const r=this.x,i=this.y;return this.x=r*e-i*t,this.y=r*t+i*e,this}rotateReverse(e,t){const r=this.x,i=this.y;return this.x=r*e+i*t,this.y=-r*t+i*e,this}scale(e){return this.x*=e,this.y*=e,this}length(){const e=this.x,t=this.y;return Math.sqrt(e*e+t*t)}sub(e){return this.x-=e.x,this.y-=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}static distance(e,t){const r=t.x-e.x,i=t.y-e.y;return Math.sqrt(r*r+i*i)}static add(e,t){return new i(e.x+t.x,e.y+t.y)}static sub(e,t){return new i(e.x-t.x,e.y-t.y)}}class s{constructor(e,t,r){this.ratio=e,this.x=t,this.y=r}}!function(e){e[e.sideLeft=0]="sideLeft",e[e.sideRight=1]="sideRight",e[e.sideTop=2]="sideTop",e[e.sideBottom=3]="sideBottom"}(r||(r={}));class n{static simplify(e,t,i){if(!i)return;const s=-t,o=e+t,a=-t,l=e+t,c=[],u=[],d=i.length;for(let e=0;e<d;++e){const t=i[e];if(!t||t.length<2)continue;let n,d=t[0];const h=t.length;for(let i=1;i<h;++i)n=t[i],d.x===n.x&&(d.x<=s&&(d.y>n.y?(c.push(e),c.push(i),c.push(r.sideLeft),c.push(-1)):(u.push(e),u.push(i),u.push(r.sideLeft),u.push(-1))),d.x>=o&&(d.y<n.y?(c.push(e),c.push(i),c.push(r.sideRight),c.push(-1)):(u.push(e),u.push(i),u.push(r.sideRight),u.push(-1)))),d.y===n.y&&(d.y<=a&&(d.x<n.x?(c.push(e),c.push(i),c.push(r.sideTop),c.push(-1)):(u.push(e),u.push(i),u.push(r.sideTop),u.push(-1))),d.y>=l&&(d.x>n.x?(c.push(e),c.push(i),c.push(r.sideBottom),c.push(-1)):(u.push(e),u.push(i),u.push(r.sideBottom),u.push(-1)))),d=n}if(0===c.length||0===u.length)return;n.fillParent(i,u,c),n.fillParent(i,c,u);const h=[];n.calcDeltas(h,u,c),n.calcDeltas(h,c,u),n.addDeltas(h,i)}static fillParent(e,t,i){const s=i.length,n=t.length;for(let a=0;a<n;a+=4){const n=t[a],l=t[a+1],c=t[a+2],u=e[n][l-1],d=e[n][l];let h=8092,p=-1;for(let t=0;t<s;t+=4){if(i[t+2]!==c)continue;const s=i[t],n=i[t+1],a=e[s][n-1],l=e[s][n];switch(c){case r.sideLeft:case r.sideRight:if(o(u.y,a.y,l.y)&&o(d.y,a.y,l.y)){const e=Math.abs(l.y-a.y);e<h&&(h=e,p=t)}break;case r.sideTop:case r.sideBottom:if(o(u.x,a.x,l.x)&&o(d.x,a.x,l.x)){const e=Math.abs(l.x-a.x);e<h&&(h=e,p=t)}}}t[a+3]=p}}static calcDeltas(e,t,r){const i=t.length;for(let s=0;s<i;s+=4){const i=[],o=n.calcDelta(s,t,r,i);e.push(t[s]),e.push(t[s+1]),e.push(t[s+2]),e.push(o)}}static calcDelta(e,t,r,i){const s=t[e+3];if(-1===s)return 0;const o=i.length;return o>1&&i[o-2]===s?0:(i.push(s),n.calcDelta(s,r,t,i)+1)}static addDeltas(e,t){const i=e.length;let s=0;for(let t=0;t<i;t+=4){const r=e[t+3];r>s&&(s=r)}for(let n=0;n<i;n+=4){const i=t[e[n]],o=e[n+1],a=s-e[n+3];switch(e[n+2]){case r.sideLeft:i[o-1].x-=a,i[o].x-=a,1===o&&(i[i.length-1].x-=a),o===i.length-1&&(i[0].x-=a);break;case r.sideRight:i[o-1].x+=a,i[o].x+=a,1===o&&(i[i.length-1].x+=a),o===i.length-1&&(i[0].x+=a);break;case r.sideTop:i[o-1].y-=a,i[o].y-=a,1===o&&(i[i.length-1].y-=a),o===i.length-1&&(i[0].y-=a);break;case r.sideBottom:i[o-1].y+=a,i[o].y+=a,1===o&&(i[i.length-1].y+=a),o===i.length-1&&(i[0].y+=a)}}}}const o=(e,t,r)=>e>=t&&e<=r||e>=r&&e<=t;e.Point=i,e.SimpleBuilder=class{setExtent(e){this._ratio=4096===e?1:4096/e}get validateTessellation(){return this._ratio<1}reset(e){this._lines=[],this._line=null}moveTo(e,t){this._line&&this._lines.push(this._line),this._line=[];const r=this._ratio;this._line.push(new i(e*r,t*r))}lineTo(e,t){const r=this._ratio;this._line.push(new i(e*r,t*r))}close(){const e=this._line;e&&!e[0].isEqual(e[e.length-1])&&e.push(e[0])}result(){return this._line&&this._lines.push(this._line),0===this._lines.length?null:this._lines}},e.TileClipper=class{constructor(e,t,r,i=8,s=8){this._lines=[],this._starts=[],this.validateTessellation=!0,this._pixelRatio=i,this._pixelMargin=s,this._tileSize=512*i,this._dz=e,this._yPos=t,this._xPos=r}setPixelMargin(e){e!==this._pixelMargin&&(this._pixelMargin=e,this.setExtent(this._extent))}setExtent(e){this._extent=e,this._finalRatio=this._tileSize/e*(1<<this._dz);let t=this._pixelRatio*this._pixelMargin;t/=this._finalRatio;const r=e>>this._dz;t>r&&(t=r),this._margin=t,this._xmin=r*this._xPos-t,this._ymin=r*this._yPos-t,this._xmax=this._xmin+r+2*t,this._ymax=this._ymin+r+2*t}reset(e){this._type=e,this._lines=[],this._starts=[],this._line=null,this._start=0}moveTo(e,t){this._pushLine(),this._prevIsIn=this._isIn(e,t),this._moveTo(e,t,this._prevIsIn),this._prevPt=new i(e,t),this._firstPt=new i(e,t),this._dist=0}lineTo(e,t){const r=this._isIn(e,t),n=new i(e,t),o=i.distance(this._prevPt,n);let a,l,c,u,d,h,p,m;if(r)this._prevIsIn?this._lineTo(e,t,!0):(a=this._prevPt,l=n,c=this._intersect(l,a),this._start=this._dist+o*(1-this._r),this._lineTo(c.x,c.y,!0),this._lineTo(l.x,l.y,!0));else if(this._prevIsIn)l=this._prevPt,a=n,c=this._intersect(l,a),this._lineTo(c.x,c.y,!0),this._lineTo(a.x,a.y,!1);else{const e=this._prevPt,t=n;if(e.x<=this._xmin&&t.x<=this._xmin||e.x>=this._xmax&&t.x>=this._xmax||e.y<=this._ymin&&t.y<=this._ymin||e.y>=this._ymax&&t.y>=this._ymax)this._lineTo(t.x,t.y,!1);else{const r=[];if((e.x<this._xmin&&t.x>this._xmin||e.x>this._xmin&&t.x<this._xmin)&&(u=(this._xmin-e.x)/(t.x-e.x),m=e.y+u*(t.y-e.y),m<=this._ymin?h=!1:m>=this._ymax?h=!0:r.push(new s(u,this._xmin,m))),(e.x<this._xmax&&t.x>this._xmax||e.x>this._xmax&&t.x<this._xmax)&&(u=(this._xmax-e.x)/(t.x-e.x),m=e.y+u*(t.y-e.y),m<=this._ymin?h=!1:m>=this._ymax?h=!0:r.push(new s(u,this._xmax,m))),(e.y<this._ymin&&t.y>this._ymin||e.y>this._ymin&&t.y<this._ymin)&&(u=(this._ymin-e.y)/(t.y-e.y),p=e.x+u*(t.x-e.x),p<=this._xmin?d=!1:p>=this._xmax?d=!0:r.push(new s(u,p,this._ymin))),(e.y<this._ymax&&t.y>this._ymax||e.y>this._ymax&&t.y<this._ymax)&&(u=(this._ymax-e.y)/(t.y-e.y),p=e.x+u*(t.x-e.x),p<=this._xmin?d=!1:p>=this._xmax?d=!0:r.push(new s(u,p,this._ymax))),0===r.length)d?h?this._lineTo(this._xmax,this._ymax,!0):this._lineTo(this._xmax,this._ymin,!0):h?this._lineTo(this._xmin,this._ymax,!0):this._lineTo(this._xmin,this._ymin,!0);else if(r.length>1&&r[0].ratio>r[1].ratio)this._start=this._dist+o*r[1].ratio,this._lineTo(r[1].x,r[1].y,!0),this._lineTo(r[0].x,r[0].y,!0);else{this._start=this._dist+o*r[0].ratio;for(let e=0;e<r.length;e++)this._lineTo(r[e].x,r[e].y,!0)}this._lineTo(t.x,t.y,!1)}}this._dist+=o,this._prevIsIn=r,this._prevPt=n}close(){if(this._line.length>2){const e=this._firstPt,t=this._prevPt;e.x===t.x&&e.y===t.y||this.lineTo(e.x,e.y);const r=this._line;let i=r.length;for(;i>=4&&(r[0].x===r[1].x&&r[0].x===r[i-2].x||r[0].y===r[1].y&&r[0].y===r[i-2].y);)r.pop(),r[0].x=r[i-2].x,r[0].y=r[i-2].y,--i}}result(t=!0){return this._pushLine(),0===this._lines.length?null:(this._type===e.GeometryType.Polygon&&t&&n.simplify(this._tileSize,this._margin*this._finalRatio,this._lines),this._lines)}resultWithStarts(){if(this._type!==e.GeometryType.LineString)throw new Error("Only valid for lines");this._pushLine();const t=this._lines,r=t.length;if(0===r)return null;const i=[];for(let e=0;e<r;e++)i.push({line:t[e],start:this._starts[e]||0});return i}_isIn(e,t){return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}_intersect(e,t){let r,s,n;if(t.x>=this._xmin&&t.x<=this._xmax)s=t.y<=this._ymin?this._ymin:this._ymax,n=(s-e.y)/(t.y-e.y),r=e.x+n*(t.x-e.x);else if(t.y>=this._ymin&&t.y<=this._ymax)r=t.x<=this._xmin?this._xmin:this._xmax,n=(r-e.x)/(t.x-e.x),s=e.y+n*(t.y-e.y);else{s=t.y<=this._ymin?this._ymin:this._ymax,r=t.x<=this._xmin?this._xmin:this._xmax;const i=(r-e.x)/(t.x-e.x),o=(s-e.y)/(t.y-e.y);i<o?(n=i,s=e.y+i*(t.y-e.y)):(n=o,r=e.x+o*(t.x-e.x))}return this._r=n,new i(r,s)}_pushLine(){this._line&&(this._type===e.GeometryType.Point?this._line.length>0&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===e.GeometryType.LineString?this._line.length>1&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===e.GeometryType.Polygon&&this._line.length>3&&(this._lines.push(this._line),this._starts.push(this._start))),this._line=[],this._start=0}_moveTo(t,r,s){this._type!==e.GeometryType.Polygon?s&&(t=Math.round((t-(this._xmin+this._margin))*this._finalRatio),r=Math.round((r-(this._ymin+this._margin))*this._finalRatio),this._line.push(new i(t,r))):(s||(t<this._xmin&&(t=this._xmin),t>this._xmax&&(t=this._xmax),r<this._ymin&&(r=this._ymin),r>this._ymax&&(r=this._ymax)),t=Math.round((t-(this._xmin+this._margin))*this._finalRatio),r=Math.round((r-(this._ymin+this._margin))*this._finalRatio),this._line.push(new i(t,r)),this._isH=!1,this._isV=!1)}_lineTo(t,r,s){let n,o;if(this._type!==e.GeometryType.Polygon)if(s){if(t=Math.round((t-(this._xmin+this._margin))*this._finalRatio),r=Math.round((r-(this._ymin+this._margin))*this._finalRatio),this._line.length>0&&(n=this._line[this._line.length-1],n.equals(t,r)))return;this._line.push(new i(t,r))}else this._line&&this._line.length>0&&this._pushLine();else if(s||(t<this._xmin&&(t=this._xmin),t>this._xmax&&(t=this._xmax),r<this._ymin&&(r=this._ymin),r>this._ymax&&(r=this._ymax)),t=Math.round((t-(this._xmin+this._margin))*this._finalRatio),r=Math.round((r-(this._ymin+this._margin))*this._finalRatio),this._line&&this._line.length>0){n=this._line[this._line.length-1];const e=n.x===t,s=n.y===r;if(e&&s)return;this._isH&&e||this._isV&&s?(n.x=t,n.y=r,o=this._line[this._line.length-2],o.x===t&&o.y===r?(this._line.pop(),this._line.length<=1?(this._isH=!1,this._isV=!1):(o=this._line[this._line.length-2],this._isH=o.x===t,this._isV=o.y===r)):(this._isH=o.x===t,this._isV=o.y===r)):(this._line.push(new i(t,r)),this._isH=e,this._isV=s)}else this._line.push(new i(t,r))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/decluttering/core":function(){define(["exports"],(function(e){"use strict";e.UniqueSymbol=class{constructor(e){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[e],this.id=e.id}},e.VTLSymbol=class{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/style/StyleDefinition":function(){define(["exports","../../../../../symbols/cim/enums"],(function(e,t){"use strict";var r,i,s,n,o,a,l,c,u;e.StyleLayerType=void 0,(r=e.StyleLayerType||(e.StyleLayerType={}))[r.BACKGROUND=0]="BACKGROUND",r[r.FILL=1]="FILL",r[r.LINE=2]="LINE",r[r.SYMBOL=3]="SYMBOL",r[r.CIRCLE=4]="CIRCLE",e.Visibility=void 0,(i=e.Visibility||(e.Visibility={}))[i.VISIBLE=0]="VISIBLE",i[i.NONE=1]="NONE",e.SymbolPlacement=void 0,(s=e.SymbolPlacement||(e.SymbolPlacement={}))[s.POINT=0]="POINT",s[s.LINE=1]="LINE",s[s.LINE_CENTER=2]="LINE_CENTER",e.RotationAlignment=void 0,(n=e.RotationAlignment||(e.RotationAlignment={}))[n.MAP=0]="MAP",n[n.VIEWPORT=1]="VIEWPORT",n[n.AUTO=2]="AUTO",e.TextJustification=void 0,(o=e.TextJustification||(e.TextJustification={}))[o.AUTO=0]="AUTO",o[o.LEFT=1]="LEFT",o[o.CENTER=2]="CENTER",o[o.RIGHT=3]="RIGHT",e.SymbolAnchor=void 0,(a=e.SymbolAnchor||(e.SymbolAnchor={}))[a.CENTER=0]="CENTER",a[a.LEFT=1]="LEFT",a[a.RIGHT=2]="RIGHT",a[a.TOP=3]="TOP",a[a.BOTTOM=4]="BOTTOM",a[a.TOP_LEFT=5]="TOP_LEFT",a[a.TOP_RIGHT=6]="TOP_RIGHT",a[a.BOTTOM_LEFT=7]="BOTTOM_LEFT",a[a.BOTTOM_RIGHT=8]="BOTTOM_RIGHT",e.TextTransform=void 0,(l=e.TextTransform||(e.TextTransform={}))[l.NONE=0]="NONE",l[l.UPPERCASE=1]="UPPERCASE",l[l.LOWERCASE=2]="LOWERCASE",e.TranslateAnchor=void 0,(c=e.TranslateAnchor||(e.TranslateAnchor={}))[c.MAP=0]="MAP",c[c.VIEWPORT=1]="VIEWPORT",e.TextWritingMode=void 0,(u=e.TextWritingMode||(e.TextWritingMode={}))[u.HORIZONTAL=0]="HORIZONTAL",u[u.VERTICAL=1]="VERTICAL";class d{static{this.backgroundLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:e.Visibility.VISIBLE}}}static{this.fillLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:e.Visibility.VISIBLE}}}static{this.lineLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:e.Visibility.VISIBLE},"line-cap":{type:"enum",values:["butt","round","square"],default:t.CapType.BUTT},"line-join":{type:"enum",values:["bevel","round","miter"],default:t.JoinType.MITER},"line-miter-limit":{type:"number",default:2},"line-round-limit":{type:"number",default:1.05}}}static{this.symbolLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:e.Visibility.VISIBLE},"symbol-avoid-edges":{type:"boolean",default:!1},"symbol-placement":{type:"enum",values:["point","line","line-center"],default:e.SymbolPlacement.POINT},"symbol-sort-key":{type:"number",default:-1},"symbol-spacing":{type:"number",minimum:1,default:250},"icon-allow-overlap":{type:"boolean",default:!1},"icon-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:e.SymbolAnchor.CENTER},"icon-ignore-placement":{type:"boolean",default:!1},"icon-image":{type:"string"},"icon-keep-upright":{type:"boolean",default:!1},"icon-offset":{type:"array",value:"number",length:2,default:[0,0]},"icon-optional":{type:"boolean",default:!1},"icon-padding":{type:"number",minimum:0,default:2},"icon-rotate":{type:"number",default:0},"icon-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:e.RotationAlignment.AUTO},"icon-size":{type:"number",minimum:0,default:1},"text-allow-overlap":{type:"boolean",default:!1},"text-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:e.SymbolAnchor.CENTER},"text-field":{type:"string"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"]},"text-ignore-placement":{type:"boolean",default:!1},"text-justify":{type:"enum",values:["auto","left","center","right"],default:e.TextJustification.CENTER},"text-keep-upright":{type:"boolean",default:!0},"text-letter-spacing":{type:"number",default:0},"text-line-height":{type:"number",default:1.2},"text-max-angle":{type:"number",minimum:0,default:45},"text-max-width":{type:"number",minimum:0,default:10},"text-offset":{type:"array",value:"number",length:2,default:[0,0]},"text-optional":{type:"boolean",default:!1},"text-padding":{type:"number",minimum:0,default:2},"text-rotate":{type:"number",default:0},"text-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:e.RotationAlignment.AUTO},"text-size":{type:"number",minimum:0,default:16},"text-transform":{type:"enum",values:["none","uppercase","lowercase"],default:e.TextTransform.NONE},"text-writing-mode":{type:"array",value:"enum",values:["horizontal","vertical"],default:[e.TextWritingMode.HORIZONTAL]}}}static{this.circleLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:e.Visibility.VISIBLE}}}static{this.backgroundPaintDefinition={"background-color":{type:"color",default:[0,0,0,1]},"background-opacity":{type:"number",minimum:0,maximum:1,default:1},"background-pattern":{type:"string"}}}static{this.fillPaintDefinition={"fill-antialias":{type:"boolean",default:!0},"fill-color":{type:"color",default:[0,0,0,1]},"fill-opacity":{type:"number",minimum:0,maximum:1,default:1},"fill-outline-color":{type:"color",default:[0,0,0,0]},"fill-pattern":{type:"string"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0]},"fill-translate-anchor":{type:"enum",values:["map","viewport"],default:e.TranslateAnchor.MAP}}}static{this.linePaintDefinition={"line-blur":{type:"number",minimum:0,default:0},"line-color":{type:"color",default:[0,0,0,1]},"line-dasharray":{type:"array",value:"number",default:[]},"line-gap-width":{type:"number",minimum:0,default:0},"line-offset":{type:"number",default:0},"line-opacity":{type:"number",minimum:0,maximum:1,default:1},"line-pattern":{type:"string"},"line-translate":{type:"array",value:"number",length:2,default:[0,0]},"line-translate-anchor":{type:"enum",values:["map","viewport"],default:e.TranslateAnchor.MAP},"line-width":{type:"number",minimum:0,default:1}}}static{this.symbolPaintDefinition={"icon-color":{type:"color",default:[0,0,0,1]},"icon-halo-blur":{type:"number",minimum:0,default:0},"icon-halo-color":{type:"color",default:[0,0,0,0]},"icon-halo-width":{type:"number",minimum:0,default:0},"icon-opacity":{type:"number",minimum:0,maximum:1,default:1},"icon-translate":{type:"array",value:"number",length:2,default:[0,0]},"icon-translate-anchor":{type:"enum",values:["map","viewport"],default:e.TranslateAnchor.MAP},"text-color":{type:"color",default:[0,0,0,1]},"text-halo-blur":{type:"number",minimum:0,default:0},"text-halo-color":{type:"color",default:[0,0,0,0]},"text-halo-width":{type:"number",minimum:0,default:0},"text-opacity":{type:"number",minimum:0,maximum:1,default:1},"text-translate":{type:"array",value:"number",length:2,default:[0,0]},"text-translate-anchor":{type:"enum",values:["map","viewport"],default:e.TranslateAnchor.MAP}}}static{this.rasterPaintDefinition={"raster-opacity":{type:"number",minimum:0,maximum:1,default:1},"raster-hue-rotate":{type:"number",default:0},"raster-brightness-min":{type:"number",minimum:0,maximum:1,default:0},"raster-brightness-max":{type:"number",minimum:0,maximum:1,default:1},"raster-saturation":{type:"number",minimum:-1,maximum:1,default:0},"raster-contrast":{type:"number",minimum:-1,maximum:1,default:0},"raster-fade-duration":{type:"number",minimum:0,default:300}}}static{this.circlePaintDefinition={"circle-blur":{type:"number",minimum:0,default:0},"circle-color":{type:"color",default:[0,0,0,1]},"circle-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-radius":{type:"number",minimum:0,default:5},"circle-stroke-color":{type:"color",default:[0,0,0,1]},"circle-stroke-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-stroke-width":{type:"number",minimum:0,default:0},"circle-translate":{type:"array",value:"number",length:2,default:[0,0]},"circle-translate-anchor":{type:"enum",values:["map","viewport"],default:e.TranslateAnchor.MAP}}}}e.StyleDefinition=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/decluttering/SymbolDeclutterer":function(){define(["exports","../VectorTile","./config","../../webgl/definitions"],(function(e,t,r,i){"use strict";function s(e){return(e.uniqueSymbol?.show&&e.uniqueSymbol?.lastShow)??!1}function n(e,t){if(e.priority-t.priority)return e.priority-t.priority;if(s(e)&&!s(t))return-1;if(s(t)&&!s(e))return 1;const r=e.tile.key,i=t.tile.key;return r.world-i.world?r.world-i.world:r.level-i.level?r.level-i.level:r.row-i.row?r.row-i.row:r.col-i.col?r.col-i.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}function o(e,t){for(const i of e){const e=i.uniqueSymbol;for(const i of e.parts){const s=i.targetOpacity>.5?1:-1;i.startOpacity+=s*((t-i.startTime)/r.fadeDuration),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=e.show&&i.show?1:0}}}function a(e){let t=null,r=null,i=null;for(const s of e.tileSymbols){const e=s.tile;e.isReady&&e.isCoverage?t=s:e.isReady?r=s:e.rendering&&(i=s)}return t??r??i}function l(e){let t=null,r=!1,i=!1;for(const s of e.tileSymbols)if(!i||!r){const e=s.tile;(!t||e.isCoverage||e.neededForCoverage&&!r)&&(t=s,(e.neededForCoverage||e.isCoverage)&&(i=!0),e.isCoverage&&(r=!0))}return i?t:null}e.SymbolDeclutterer=class{get running(){return this._running}constructor(e,t,r,i,s,n,o,a){this.selectionMode=e,this._visibleTiles=t,this._symbolRepository=r,this._styleRepository=i,this._createCollisionJob=s,this._assignTileSymbolsOpacity=n,this._symbolLayerSorter=o,this._isLayerVisible=a,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}return this._running=!1,!0}_isFeatureFiltered(e,t,r){const s=t.getFilterFlags(e),n=s&i.filterFlag0,o=null==r.featureEffect||r.featureEffect.excludedLabelsVisible||s&i.effectFlag0;return!(n&&o)}_getFilteredByLayer(){let e;if(this._styleRepository?.layerContexts)for(const t of this._symbolRepository.uniqueSymbols){const r=this._styleRepository.layerContexts?.get(t.styleLayerUID);if(r?.attributeView)for(const i of t.uniqueSymbols){e??=new Map,e.get(t.styleLayerUID)||e.set(t.styleLayerUID,new Set);const s=e.get(t.styleLayerUID),n=r.attributeView,o=r.layerView;this._isFeatureFiltered(i.id,n,o)&&s.add(i.id)}}return e}_resetSelection(){for(let e=0;e<this._symbolRepository.uniqueSymbols.length;e++){const t=this._symbolRepository.uniqueSymbols[e];for(let e=0;e<t.uniqueSymbols.length;e++){const r=t.uniqueSymbols[e];for(const e of r.tileSymbols)e.selectedForRendering=!1}}}_createSelectionJob(){const e="feature-tile"===this.selectionMode?a:l,t=this._symbolRepository.uniqueSymbols;this._resetSelection();const r=[];let i=0,s=0;const o=this._isLayerVisible,c=this._getFilteredByLayer(),u=this._styleRepository?.layerContexts,d=this._symbolLayerSorter;return{work:function(a){let l;const d=performance.now();for(;s<t.length;s++,i=0){const n=t[s],h=n.styleLayerUID,p=c?.get(h);let m=0;if(u){const e=u.get(h).layerView;m=e.view.allLayerViews.items.indexOf(e)}if(!o(h)){r[s]||(r[s]={styleLayerUID:h,layerOrder:m,symbols:[]});continue}r[s]||={styleLayerUID:h,symbols:[],layerOrder:m};const f=r[s];for(;i<n.uniqueSymbols.length;i++){if(l=n.uniqueSymbols[i],i%100==99&&performance.now()-d>a)return!1;if(l.lastShow=l.show,l.id&&p?.has(l.id)){l.show=!1,l.parts[0].show=!1,l.parts[1].show=!1;continue}const t=e(l);if(t){t.selectedForRendering=!0,f.symbols.push(t),l.show=!0;for(const e of l.parts)e.show=!0}else l.show=!1}}for(const e of r)e.symbols.sort(n);return r.sort(((e,t)=>t.layerOrder-e.layerOrder)),!0},get sortedSymbols(){return r.sort(d)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,r=this._visibleTiles;let i=0;function s(t,r){for(const e of t.symbols.values())o(e,r);e(t,r);for(const e of t.childrenTiles)s(e,r)}return{work(n){const o=performance.now();for(;i<r.length;i++){if(performance.now()-o>n)return!1;const a=r[i];if(null!=a.parentTile)continue;const l=performance.now();a instanceof t.VectorTile?s(a,l):e(a,l)}return!0}}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/VectorTile":function(){define(["exports","../../../../core/has","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f32","./constants","./enums","./RenderBucket","./decluttering/config","../webgl/TiledDisplayObject"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.TiledDisplayObject{constructor(e,t,r,i,n,o,a,l=null){super(e,t,r,i,n,o,s.tileCoordSize,s.tileCoordSize),this.styleRepository=a,this._memCache=l,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<a.fadeDuration}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<a.fadeDuration)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){let t=!1;for(const r of e){const e=this.layerData.get(r);e&&(this._usedMemory-=e.usedMemory,e.type===n.BucketType.SYMBOL&&this.symbols.delete(r)&&(t=!0),e.destroy(),this.layerData.delete(r))}this._memCache?.updateSize(this.key.id,this),t&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const e=this.layerData.values();for(const t of e)if(t.hasData())return!0;return!1}dispose(){"unloaded"!==this.status&&(c._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){0===--this._referenced&&(this.dispose(),this.stage=null)}retain(){++this._referenced}get cachedMemory(){return this._usedMemory}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){this.featureIndex?.clear();let t=!1;if(e){const{bucketsWithData:r,emptyBuckets:i}=e,s=this._createRenderBuckets(r);if(i&&i.byteLength>0){const e=new Uint32Array(i);for(const t of e)this._deleteLayerData(t)}for(const[e,r]of s)this._deleteLayerData(e),r.type===n.BucketType.SYMBOL&&(this.symbols.set(e,r.symbols),t=!0),this._usedMemory+=r.usedMemory,this.layerData.set(e,r);this._memCache?.updateSize(this.key.id,this)}this._hasSymbolBuckets=!1;for(const e of this.layerData.values())e.type===n.BucketType.SYMBOL&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*t,s=this.height/this.rangeY*t,n=[0,0];e.toScreen(n,[this.x,this.y]);const o=this.transforms.tileUnitsToPixels;r.identity(o),r.translate(o,o,n),r.rotate(o,o,Math.PI*e.rotation/180),r.scale(o,o,[i,s,1])}_createTransforms(){return{displayViewScreenMat3:i.create(),tileMat3:i.create(),tileUnitsToPixels:i.create()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;for(const r of e.values())t.has(r)||(r.destroy(),t.add(r));e.clear()}_createRenderBuckets(e){const t=new Map,r=new Map;for(const i of e){const e=this._deserializeBucket(i,r);for(const r of e.layerUIDs)t.set(r,e)}return t}_deserializeBucket(e,t){let r=t.get(e);if(r)return r;switch(new Uint32Array(e)[0]){case n.BucketType.FILL:r=new o.FillRenderBucket(e,this.styleRepository);break;case n.BucketType.LINE:r=new o.LineRenderBucket(e,this.styleRepository);break;case n.BucketType.SYMBOL:r=new o.SymbolRenderBucket(e,this.styleRepository,this);break;case n.BucketType.CIRCLE:r=new o.CircleRenderBucket(e,this.styleRepository)}return t.set(e,r),r}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._usedMemory-=t.usedMemory,t.destroy(),this.layerData.delete(e)}}e.VectorTile=c,e.tracer=null,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/RenderBucket":function(){define(["exports","../../../../core/maybe","../../../../core/memoryEstimations","../../tiling/TileInfoView","../../tiling/TileKey","../../tiling/TileQueue","../../tiling/TileStrategy","./enums","./decluttering/util","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexArrayObject"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let r=1;const i=new Uint32Array(e);this.layerUIDs=[];const s=i[r++];for(let e=0;e<s;e++)this.layerUIDs[e]=i[r++];this.bufferDataOffset=r,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){null!=this._data&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}e.CircleRenderBucket=class extends h{constructor(e,t){super(e,t),this.type=a.BucketType.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const r=new Uint32Array(e);let i=this.bufferDataOffset;this.circleIndexStart=r[i++],this.circleIndexCount=r[i++],this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=t.disposeMaybe(this.vao)}doPrepareForRendering(e,t,r){const i=new Uint32Array(t),s=new Int32Array(i.buffer),n=i[r++],o=c.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,new Int32Array(s.buffer,4*r,n));r+=n;const a=i[r++],l=c.BufferObject.createIndex(e,u.Usage.STATIC_DRAW,new Uint32Array(i.buffer,4*r,a));r+=a;const h=this.layer.circleMaterial;this.vao=new d.VertexArrayObject(e,h.getAttributeLocations(),h.getLayoutInfo(),new Map([["geometry",o]]),l)}},e.FillRenderBucket=class extends h{constructor(e,t){super(e,t),this.type=a.BucketType.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const r=new Uint32Array(e);let i=this.bufferDataOffset;this.fillIndexStart=r[i++],this.fillIndexCount=r[i++],this.outlineIndexStart=r[i++],this.outlineIndexCount=r[i++];const s=r[i++];if(s>0){this.patternMap=new Map;for(let e=0;e<s;e++){const e=r[i++],t=r[i++],s=r[i++];this.patternMap.set(e,[t,s])}}this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.cachedMemory??0)+(this.outlineVAO?.cachedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=t.disposeMaybe(this.fillVAO),this.outlineVAO=t.disposeMaybe(this.outlineVAO)}doPrepareForRendering(e,t,r){const i=new Uint32Array(t),s=new Int32Array(i.buffer),n=i[r++],o=c.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,new Int32Array(s.buffer,4*r,n));r+=n;const a=i[r++],l=c.BufferObject.createIndex(e,u.Usage.STATIC_DRAW,new Uint32Array(i.buffer,4*r,a));r+=a;const h=i[r++],p=c.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,new Int32Array(s.buffer,4*r,h));r+=h;const m=i[r++],f=c.BufferObject.createIndex(e,u.Usage.STATIC_DRAW,new Uint32Array(i.buffer,4*r,m));r+=m;const g=this.layer,y=g.fillMaterial,_=g.outlineMaterial;this.fillVAO=new d.VertexArrayObject(e,y.getAttributeLocations(),y.getLayoutInfo(),new Map([["geometry",o]]),l),this.outlineVAO=new d.VertexArrayObject(e,_.getAttributeLocations(),_.getLayoutInfo(),new Map([["geometry",p]]),f)}},e.LineRenderBucket=class extends h{constructor(e,t){super(e,t),this.type=a.BucketType.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const r=new Uint32Array(e);let i=this.bufferDataOffset;this.lineIndexStart=r[i++],this.lineIndexCount=r[i++];const s=r[i++];if(s>0){this.patternMap=new Map;for(let e=0;e<s;e++){const e=r[i++],t=r[i++],s=r[i++];this.patternMap.set(e,[t,s])}}this.bufferDataOffset=i}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=t.disposeMaybe(this.vao)}doPrepareForRendering(e,t,r){const i=new Uint32Array(t),s=new Int32Array(i.buffer),n=i[r++],o=c.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,new Int32Array(s.buffer,4*r,n));r+=n;const a=i[r++],l=c.BufferObject.createIndex(e,u.Usage.STATIC_DRAW,new Uint32Array(i.buffer,4*r,a));r+=a;const h=this.layer.lineMaterial;this.vao=new d.VertexArrayObject(e,h.getAttributeLocations(),h.getLayoutInfo(),new Map([["geometry",o]]),l)}},e.RenderBucketBase=h,e.SymbolRenderBucket=class extends h{constructor(e,t,r){super(e,t),this.type=a.BucketType.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const i=new Uint32Array(e),n=new Int32Array(e),o=new Float32Array(e);let c=this.bufferDataOffset;this.isIconSDF=!!i[c++];const u=i[c++],d=i[c++],h=i[c++],p=new s(u,d,h,0),m=i[c++];for(let e=0;e<m;e++){const e=i[c++],t=i[c++],r=i[c++];this.iconPerPageElementsMap.set(e,[t,r])}const f=i[c++];for(let e=0;e<f;e++){const e=i[c++],t=i[c++],r=i[c++];this.glyphPerPageElementsMap.set(e,[t,r])}const g=i[c++],y=i[c++];this.iconOpacity=new Int32Array(g),this.textOpacity=new Int32Array(y),c=l.deserializeSymbols(i,n,o,c,this.symbols,r,p),this.bufferDataOffset=c}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.cachedMemory??0)+(this.textVAO?.cachedMemory??0)+r.estimateNumberArrayMemory(this.iconOpacity)+r.estimateNumberArrayMemory(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const t of this.iconPerPageElementsMap.values())e+=t[1];for(const t of this.glyphPerPageElementsMap.values())e+=t[1];return e/3}doDestroy(){this.iconVAO=t.disposeMaybe(this.iconVAO),this.textVAO=t.disposeMaybe(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,t=this.iconVAO.vertexBuffers.get("opacity");e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);const r=this.textOpacity,i=this.textVAO.vertexBuffers.get("opacity");r.length>0&&r.byteLength===i.usedMemory&&i.setSubData(r,0,0,r.length)}doPrepareForRendering(e,t,r){const i=new Uint32Array(t),s=new Int32Array(i.buffer),n=i[r++],o=c.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,new Int32Array(s.buffer,4*r,n));r+=n;const a=i[r++],l=c.BufferObject.createIndex(e,u.Usage.STATIC_DRAW,new Uint32Array(i.buffer,4*r,a));r+=a;const h=i[r++],p=c.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,new Int32Array(s.buffer,4*r,h));r+=h;const m=i[r++],f=c.BufferObject.createIndex(e,u.Usage.STATIC_DRAW,new Uint32Array(i.buffer,4*r,m));r+=m;const g=c.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,this.iconOpacity.buffer),y=c.BufferObject.createVertex(e,u.Usage.STATIC_DRAW,this.textOpacity.buffer),_=this.layer,b=_.iconMaterial,v=_.textMaterial;this.iconVAO=new d.VertexArrayObject(e,b.getAttributeLocations(),b.getLayoutInfo(),new Map([["geometry",o],["opacity",g]]),l),this.textVAO=new d.VertexArrayObject(e,v.getAttributeLocations(),v.getLayoutInfo(),new Map([["geometry",p],["opacity",y]]),f)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/webgl/TiledDisplayObject":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat3","../DisplayObject","../../tiling/TileKey"],(function(e,t,r,i){"use strict";class s extends r.DisplayObject{constructor(e,t,r,s,n,o,a=n,l=o){super(),this.tileDebugInfoTexture=null,this.debugInfo={display:{length:0,minOrderedLength:0,minUnorderedLength:0,triangleCount:0},memory:{bytesUsed:0,bytesReserved:0}},this._destroyed=!1,this.key=new i(e),this.resolution=t,this.x=r,this.y=s,this.width=n,this.height=o,this.rangeX=a,this.rangeY=l}destroy(){this.tileDebugInfoTexture&&(this.tileDebugInfoTexture.dispose(),this.tileDebugInfoTexture=null),this._destroyed=!0}get debugSlot(){let e=this;for(;e.parent!==this._stage;){if(!e.parent)return 0;e=e.parent}return this._stage.children.indexOf(e)}setTransform(e){const r=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[s,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),o=this.width/this.rangeX*r,a=this.height/this.rangeY*r;t.set(i,o,0,0,0,a,0,s,n,1),t.multiply(this.transforms.displayViewScreenMat3,e.displayViewMat3,i)}get destroyed(){return this._destroyed}}e.TiledDisplayObject=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/DisplayObject":function(){define(["exports","../../../core/arrayUtils","../../../core/Evented","./transitions/FadeTransition"],(function(e,t,r,i){"use strict";e.DisplayObject=class extends r{constructor(){super(...arguments),this._transitionables=null,this._clips=null,this._fadeTransition=null,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get computedOpacity(){return this._fadeTransition?.computedOpacity??this.opacity}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get fadeTransitionEnabled(){return null!==this._fadeTransition}set fadeTransitionEnabled(e){!this._fadeTransition&&e?(this._fadeTransition=new i.FadeTransition({opacity:this.opacity,visible:this.visible}),this.addTransitionable(this._fadeTransition)):this._fadeTransition&&!e&&(this.removeTransitionable(this._fadeTransition),this._fadeTransition=null)}get inFadeTransition(){return this._fadeTransition?.transitioning??!1}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this._fadeTransition&&(this._fadeTransition.opacity=this._opacity),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const t=this._stage;this._stage=e,e?this._stage?.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t?.trashDisplayObject(this)}get transforms(){return null==this._transforms&&(this._transforms=this._createTransforms()),this._transforms}get transitioning(){return this.isTransitioning()}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._fadeTransition&&(this._fadeTransition.visible=this._visible),this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}addTransitionable(e){this._transitionables??=[],this._transitionables.push(e),this.requestRender()}removeTransitionable(e){e.endTransition(),this._transitionables&&t.remove(this._transitionables,e),this.requestRender()}fadeIn(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeIn();return this.opacity=1,this.requestRender(),e}fadeOut(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeOut();return this.opacity=0,this.requestRender(),e}endTransitions(){if(this._transitionables){for(const e of this._transitionables)e.endTransition();this.requestRender()}}beforeRender(e){this.transitionStep(e.deltaTime,e.state.scale),this.setTransform(e.state)}afterRender(e){this.transitioning&&this.requestRender()}remove(){this.parent?.removeChild(this)}setTransform(e){}processRender(e){this.stage&&(this._fadeTransition?.computedVisible??this.visible)&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.endTransitions(),this.onDetach(),this.emit("detach")}isTransitioning(){return this._transitionables?.some((e=>e.transitioning))??!1}transitionStep(e,t){if(this._transitionables)for(const r of this._transitionables)r.transitionStep(e,t)}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/transitions/FadeTransition":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.FadeTransition=class extends r{constructor(e){super(e),this.computedOpacity=1,this.computedVisible=!0,this.opacity=1,this.visible=!0,this._fadeOutResolver=null,this._fadeInResolver=null}get transitioning(){return(this._fadeOutResolver||!this.visible?0:this.opacity)!==this.computedOpacity}endTransition(){this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeInResolver=this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0}fadeIn(){return this._fadeInResolver||(this.opacity=1,this.computedOpacity=0,this._fadeOutResolver?.(),this._fadeOutResolver=null,this._fadeInResolver=s.createResolver()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver?.(),this._fadeInResolver=null,this._fadeOutResolver=s.createResolver()),this._fadeOutResolver.promise}transitionStep(e,t){const r=i("mapview-transitions-duration"),s=r?1/r:0;if(0===s)this.computedOpacity=this.opacity,this.computedVisible=this.visible;else{const t=this._fadeOutResolver||!this.visible?0:this.opacity,r=this.computedOpacity;if(r===t)this.computedVisible=this.visible;else{const i=e*s;this.computedOpacity=r>t?Math.max(t,r-i):Math.min(t,r+i),this.computedVisible=this.computedOpacity>0}}this.transitioning||(this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeOutResolver=this._fadeInResolver=null)}},t.__decorate([n.property()],e.FadeTransition.prototype,"computedOpacity",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"computedVisible",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"opacity",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"visible",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"transitioning",null),t.__decorate([n.property()],e.FadeTransition.prototype,"_fadeOutResolver",void 0),t.__decorate([n.property()],e.FadeTransition.prototype,"_fadeInResolver",void 0),e.FadeTransition=t.__decorate([l.subclass("esri.views.2d.engine.transitions.FadeTransition")],e.FadeTransition),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/webgl/definitions":function(){define(["exports"],(function(e){"use strict";var t;e.AttributeDataType=void 0,(t=e.AttributeDataType||(e.AttributeDataType={}))[t.FilterFlags=0]="FilterFlags",t[t.Animation=1]="Animation",t[t.GPGPU=2]="GPGPU",t[t.VV=3]="VV",t[t.DD0=4]="DD0",t[t.DD1=5]="DD1",t[t.DD2=6]="DD2",t[t.LocalTimeOrigin=7]="LocalTimeOrigin",e.MAX_TILE_RESHUFFLES_PER_FRAME=1,e.RESHUFFLING_EXEMPT_DRAW_CALLS=10,e.RESHUFFLING_EXEMPT_MEMORY_BYTES=1<<20,e.RESHUFFLING_TARGET_DRAW_EFFICIENCY=.75,e.RESHUFFLING_TARGET_MEMORY_EFFICIENCY=.75,e.angleFactor256=256/360,e.animationUnit=2,e.attributeStoreInitialSize=256,e.attributeStoreTextureSize=1024,e.averageGlyphMosaicItem={metrics:{width:15,height:17,left:0,top:-7,advance:14}},e.backbufferStencilClipped=1,e.backbufferStencilVisible=0,e.bitsetFillHasPatternHeightPrecisionFactor=32,e.bitsetFillHasPatternWidthPrecisionFactor=64,e.bitsetFillHasUnresolvedReplacementColor=8,e.bitsetFillRandomPatternOffset=4,e.bitsetGenericConsiderAlphaOnly=16,e.bitsetGenericLockColor=2,e.bitsetLineScaleDash=4,e.bitsetMarkerAlignmentMap=1,e.bitsetMarkerAlignmentScreen=0,e.bitsetMarkerOutlineAllowColorOverride=4,e.bitsetMarkerScaleSymbolsProportionally=8,e.bitsetTypeFillOutline=1,e.bufferDataMinimumSize=128,e.bufferDataPoolSize=4,e.chartMaxFields=10,e.collisionBoxPadding=16,e.collisionBucketSize=128,e.collisionEarlyRejectBucketSize=16,e.collisionMaxZoomDelta=1,e.collisionPlacementPadding=8,e.collisionTileBoxSize=4,e.compressionFactorForU16=128,e.dataDrivenUnit0=4,e.dataDrivenUnit1=5,e.dataDrivenUnit2=6,e.debugLabels=!1,e.defaultSdfTextureSize=128,e.displayRecordIntPerElement=8,e.dotDensityMaxFields=8,e.effectFlag0=128,e.enableEarlyLabelDiscard=!1,e.extrudeScale=64,e.filterFlag0=64,e.filterFlagsUnit=1,e.glyphSize=24,e.gpgpuUnit=12,e.gradientTextureExternalPadding=1,e.heuristicGlyphsPerFeature=10,e.heuristicGlyphsPerLine=50,e.hittestSmallSymbolThreshold=3,e.hittestToleranceDesktop=1,e.hittestToleranceMobile=3,e.hittestToleranceSmallSymbol=3,e.labelPlacementOffsetPadding=4,e.localTimeOriginUnit=13,e.magicLabelLineHeight=29,e.maxGeohashLevel=12,e.maxGpuUploadsPerFrame=2,e.maxHighlightReasons=6,e.maxRepresentableInt=16777216,e.maxTextLineWidth=512,e.minMaxZoomPrecisionFactor=10,e.minTextLineWidth=32,e.nanMagicNumber=1e-30,e.patchPixelBufferAllocSize=500,e.patternFillRasterizationScale=2,e.pictureFillColor=4294967295,e.randomInsidePolygonTextureSize=1024,e.rasterTileSize=256,e.rasterizedVectorMarkerMinSize=128,e.spritePadding=4,e.svgSdfTextureInnerSize=248,e.svgSdfTextureSize=256,e.textureBindingBitmap=0,e.textureBindingGlyphAtlas=0,e.textureBindingHighlight0=5,e.textureBindingHighlight1=6,e.textureBindingRenderer0=5,e.textureBindingRenderer1=6,e.textureBindingSpriteAtlas=0,e.textureUploadManagerBudget=4,e.textureUploadManagerChunkSize=128,e.thinLineHalfWidthThreshold=1.05,e.tileSize=512,e.visualVariableUnit=3,e.vtlHighResCutoff=1.15,e.vtlTextureBindingUnitGlyphs=6,e.vtlTextureBindingUnitSprites=5,e.webglMaxInnerStops=6,e.webglMaxStops=8,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/vectorTiles/decluttering/SymbolRepository":function(){define(["exports","./core","./util"],(function(e,t,r){"use strict";class i{static fromSymbols(e,t){let a=e.length;if(a>=s){let s=t;do{s/=2,a/=4}while(a>n&&s>o);const l=new r.GridIndex(t,t,s);for(const t of e)l.getCell(t.xTile,t.yTile).push(t);return new i(t,e,l)}return new i(t,e,null)}constructor(e,t,r){this.tileCoordRange=e,this._symbols=t,this._index=r}addSymbols(e){for(const t of e)this._symbols.push(t);if(this._index)for(const t of e)this._index.getCell(t.xTile,t.yTile).push(t)}removeSymbols(e){const t=new Set(e);if(this._symbols=this._symbols.filter((e=>!t.has(e))),this._index)for(const e of this._index.cells)for(let r=0;r<e.length;r++)e[r]=e[r].filter((e=>!t.has(e)))}getSymbols(){return this._symbols}getCandidate(e,t,r,i){if(!this._index){for(const s of this._symbols)if(r===s.hash&&Math.abs(e-s.xTile)<=i&&Math.abs(t-s.yTile)<=i)return s;return null}const s=this._index.getCellSpan(e-i,t-i,e+i,t+i),[n,o,a,l]=s;for(let s=o;s<=l;s++)for(let o=n;o<=a;o++){const n=this._index.cells[s][o];for(const s of n)if(r===s.hash&&Math.abs(e-s.xTile)<=i&&Math.abs(t-s.yTile)<=i)return s}return null}}const s=32,n=8,o=64;function a(e){const t=new Map;for(const r of e){const e=r.labelClassId;let i=t.get(e);i||(i=[],t.set(e,i)),i.push(r)}return t}e.SymbolRepository=class{constructor(e,t){this.tileCoordRange=e,this._visibleTiles=t,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}registerVectorTile(e,t){const r=this._ensureIndexMap(e),i=t?.values()??r.keys();for(const e of i){const t=r.get(e);t&&(this._removeSymbols(e,t.getSymbols()),r.delete(e))}this._addSymbols(e.key,r,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,t){const r=this._indexMapByTile.get(e);if(!r)throw new Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,r,a(t)),this._invalidate()}removeFeatureTileMetrics(e,t){const r=this._indexMapByTile.get(e);if(!r)return;const i=a(t);for(const[e,t]of r.entries()){const r=i.get(e);r&&(t.removeSymbols(r),this._removeSymbols(e,r))}this._invalidate()}deleteStyleLayers(e){for(const t of this._indexMapByTile.values())for(const r of e){const e=t.get(r);e&&(this._removeSymbols(r,e.getSymbols()),t.delete(r))}this._invalidate()}querySymbols(e,t,i,s){const n=[];for(const[s,o]of this._uniqueSymbolsByStyleLayerId.entries())for(const a of o){const o=a.tileSymbols.find((e=>e.selectedForRendering));o&&r.isSearchCircleOverlapingSymbol(o,e,t*(window.devicePixelRatio||1),i)&&n.push({vtlSymbol:o,styleLayerUID:s,tileKey:o.tile.key})}return n}_ensureIndexMap(e){let t=this._indexMapByTile.get(e);return t||(t=new Map,this._indexMapByTile.set(e,t)),t}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,t,r){for(const[e,s]of r){let r=t.get(e);r?r.addSymbols(s):(r=i.fromSymbols(s,this.tileCoordRange),t.set(e,r))}this._updateUniqueSymbols(e,r)}_removeTile(e){const t=this._indexMapByTile.get(e);if(t){for(const[e,r]of t.entries())this._removeSymbols(e,r.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,t){for(const r of t){const t=r.uniqueSymbol;if(t){if(t.tileSymbols=t.tileSymbols.filter((e=>e!==r)),0===t.tileSymbols.length){const r=this._uniqueSymbolsByStyleLayerId.get(e);r.delete(t),0===r.size&&this._uniqueSymbolsByStyleLayerId.delete(e)}r.uniqueSymbol=null}}}_updateUniqueSymbols(e,r){if(0!==r.size){for(const t of this._visibleTiles)t.parentTile||t.key.world!==e.world||t.key.level===e.level&&!t.key.equals(e)||this._matchSymbols(t,e,r);for(const[e,i]of r)for(const r of i)if(!r.uniqueSymbol){r.uniqueSymbol=new t.UniqueSymbol(r);let i=this._uniqueSymbolsByStyleLayerId.get(e);i||(i=new Set,this._uniqueSymbolsByStyleLayerId.set(e,i)),i.add(r.uniqueSymbol)}}}_matchSymbols(e,t,i){if(e.key.level>t.level){const r=e.key.level-t.level;if(e.key.row>>r!==t.row||e.key.col>>r!==t.col)return}if(t.level>e.key.level){const r=t.level-e.key.level;if(t.row>>r!==e.key.row||t.col>>r!==e.key.col)return}const s=new Map;for(const[n,o]of i){const i=[],a=20+(e.key.level<t.level?1:1<<e.key.level-t.level),l=this._indexMapByTile.get(e),c=l?.get(n);if(c)for(const s of o){if(s.uniqueSymbol)continue;const n=r.tileCoordChangeX(this.tileCoordRange,s.xTile,t,e.key),o=r.tileCoordChangeY(this.tileCoordRange,s.yTile,t,e.key),l=-20,u=this.tileCoordRange+20;if(!(n>=l&&n<u&&o>=l&&o<u)){i.push(s);continue}const d=c.getCandidate(n,o,s.hash,a),h=d?.uniqueSymbol;h?(s.uniqueSymbol=h,h.tileSymbols.push(s)):i.push(s)}i.length>0&&s.set(n,i)}for(const r of e.childrenTiles||[])this._matchSymbols(r,t,s)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsByStyleLayerId,t=new Array(e.size);let r,i=0;for(const[s,n]of e){const e=new Array(n.size);r=0;for(const t of n)e[r++]=t;t[i]={styleLayerUID:s,uniqueSymbols:e},i++}return t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/webgl/RenderableTile":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/mat3f32","./TiledDisplayObject"],(function(e,t,r){"use strict";class i extends r.TiledDisplayObject{_createTransforms(){return{displayViewScreenMat3:t.create(),tileMat3:t.create()}}}e.RenderableTile=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/webgl/TileReshuffleManager":function(){define(["exports"],(function(e){"use strict";e.TileReshuffleManager=class{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const t=[];for(const r of this._candidateTiles)e>0?(r.reshuffle(),e--):t.push(r);this._candidateTiles=t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/BlendLayersTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","./TileBlendTechniqueConfiguration","../../../chunks/BlendLayers.glsl","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r,i,s){"use strict";class n extends r.TileBlendTechniqueConfiguration{constructor(){super(...arguments),this.background=i.BackgroundMode.BelowLayer}}t.__decorate([s.parameter({count:i.BackgroundMode.COUNT})],n.prototype,"background",void 0),e.BlendLayersTechniqueConfiguration=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TileBlendTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","./BlendModeTechniqueConfiguration","../webgl-engine/core/shaderLibrary/terrain/BaseOpacityMode","../webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput","../webgl-engine/core/shaderLibrary/terrain/PremultipliedAlphaSource","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r,i,s,n,o){"use strict";class a extends r.BlendModeTechniqueConfiguration{constructor(){super(...arguments),this.output=s.BlendLayersOutput.Composite,this.baseOpacityMode=i.BaseOpacityMode.NotRequired,this.premultipliedSource=n.PremultipliedAlphaSource.Off}}t.__decorate([o.parameter({count:s.BlendLayersOutput.COUNT})],a.prototype,"output",void 0),t.__decorate([o.parameter({count:i.BaseOpacityMode.COUNT})],a.prototype,"baseOpacityMode",void 0),t.__decorate([o.parameter({count:n.PremultipliedAlphaSource.COUNT})],a.prototype,"premultipliedSource",void 0),e.TileBlendTechniqueConfiguration=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/BlendModeTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderLibrary/output/BlendOptions","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r,i){"use strict";class s extends i.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.blendMode=r.LayerBlendMode.Normal}}t.__decorate([i.parameter({count:r.LayerBlendMode.COUNT})],s.prototype,"blendMode",void 0),e.BlendModeTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/RasterColorizerTechnique":function(){define(["require","exports","../../../chunks/RasterColorizer.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique"],(function(e,t,r,i,s){"use strict";class n extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.RasterColorizer,(()=>new Promise(((t,r)=>e(["../webgl-engine/core/shaderLibrary/raster/RasterColorizer.glsl"],t,r))))))}}t.RasterColorizerTechnique=n,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/RasterColorizer.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec3f64","../views/2d/engine/imagery/enums","../views/3d/webgl-engine/core/shaderLibrary/raster/Colormap.glsl","../views/3d/webgl-engine/core/shaderLibrary/raster/Common.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/TileComposite.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl","../views/3d/webgl-engine/core/shaderModules/BooleanPassUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/FloatsPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";class g extends s.CommonPassParameters{constructor(e,r,i,s,n,o){super(e,s,n),this.colormap=r,this.symbolizer=i,this.u_colormap=o,this.backgroundColor=t.ZEROS,this.fboTexture=null,this.baseOpacity=1}}class y extends g{}class _ extends g{}function b(e){const t=new f.ShaderBuilder;return t.include(o.TileComposite),t.include(s.Common,e),t.include(i.Colormap,e),t.include(n.TileBackground,e),t.fragment.code.add(h.glsl`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),e.colorizerType===r.RasterColorizerType.Stretch?function(e,t){e.fragment.uniforms.add(new p.IntegerPassUniform("u_bandCount",(e=>e.symbolizer.u_bandCount)),new d.FloatsPassUniform("u_minCutOff",(e=>e.symbolizer.u_minCutOff),3),new d.FloatsPassUniform("u_maxCutOff",(e=>e.symbolizer.u_maxCutOff),3),new d.FloatsPassUniform("u_factor",(e=>e.symbolizer.u_factor),3),new u.FloatPassUniform("u_minOutput",(e=>e.symbolizer.u_minOutput)),new u.FloatPassUniform("u_maxOutput",(e=>e.symbolizer.u_maxOutput)),new l.BooleanPassUniform("u_useGamma",(e=>e.symbolizer.u_useGamma)),new d.FloatsPassUniform("u_gamma",(e=>e.symbolizer.u_gamma),3),new d.FloatsPassUniform("u_gammaCorrection",(e=>e.symbolizer.u_gammaCorrection),3),new u.FloatPassUniform("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(h.glsl`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?h.glsl`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:h.glsl`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.main.add(h.glsl`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${t.stretchType===r.RasterColorizerStretchType.Noop?h.glsl`fragColor = applyBackgroundBlend(currentPixel);`:h.glsl`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${i}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}(t,e):e.colorizerType===r.RasterColorizerType.Lut?function(e){e.fragment.main.add(h.glsl`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}(t):e.colorizerType===r.RasterColorizerType.Hillshade&&function(e,t){const r=e.fragment;r.uniforms.add(new m.Texture2DPassUniform("u_image",(e=>e.u_image)),new p.IntegerPassUniform("u_hillshadeType",(e=>e.symbolizer.u_hillshadeType)),new d.FloatsPassUniform("u_sinZcosAs",(e=>e.symbolizer.u_sinZcosAs),6),new d.FloatsPassUniform("u_sinZsinAs",(e=>e.symbolizer.u_sinZsinAs),6),new d.FloatsPassUniform("u_cosZs",(e=>e.symbolizer.u_cosZs),6),new d.FloatsPassUniform("u_weights",(e=>e.symbolizer.u_weights),6),new c.Float2PassUniform("u_factor",(e=>e.symbolizer.u_factor)),new u.FloatPassUniform("u_minValue",(e=>e.symbolizer.u_minValue)),new u.FloatPassUniform("u_maxValue",(e=>e.symbolizer.u_maxValue)),new c.Float2PassUniform("u_srcImageSize",(e=>e.common.u_srcImageSize))),r.include(a.ColorConversion),r.code.add(h.glsl`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),r.code.add(h.glsl`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=t.applyColormap?h.glsl`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:h.glsl`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;r.main.add(h.glsl`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}`)}(t,e),t}const v=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:_,ColorizerStretchUniforms:y,ColorizerUniforms:g,build:b},Symbol.toStringTag,{value:"Module"}));e.ColorizerHillshadeUniforms=_,e.ColorizerStretchUniforms=y,e.ColorizerUniforms=g,e.RasterColorizer=v,e.build=b}))},"esri/views/3d/webgl-engine/core/shaderLibrary/raster/Colormap.glsl":function(){define(["exports","../../shaderModules/FloatPassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform"],(function(e,t,r,i){"use strict";e.Colormap=function(e){e.fragment.uniforms.add(new i.Texture2DPassUniform("u_colormap",(e=>e.u_colormap)),new t.FloatPassUniform("u_colormapOffset",(e=>e.colormap.u_colormapOffset)),new t.FloatPassUniform("u_colormapMaxIndex",(e=>e.colormap.u_colormapMaxIndex)),new t.FloatPassUniform("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(r.glsl`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/raster/Common.glsl":function(){define(["exports","./Projection.glsl","../terrain/TileComposite.glsl","../../shaderModules/BooleanPassUniform","../../shaderModules/Float2PassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform"],(function(e,t,r,i,s,n,o){"use strict";class a extends r.TileCompositePassParameters{constructor(e,t,r){super(),this.common=e,this.u_image=t,this.u_transformGrid=r}}e.Common=function(e,r){e.include(t.Projection),e.fragment.uniforms.add(new o.Texture2DPassUniform("u_image",(e=>e.u_image)),new i.BooleanPassUniform("u_flipY",(e=>e.common.u_flipY)),new i.BooleanPassUniform("u_applyTransform",(e=>e.common.u_applyTransform)));const{requireBilinearWithNN:a}=r;a&&e.fragment.uniforms.add(new s.Float2PassUniform("u_srcImageSize",(e=>e.common.u_srcImageSize))),e.fragment.code.add(n.glsl`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),a?e.fragment.code.add(n.glsl`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):e.fragment.code.add(n.glsl`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)},e.CommonPassParameters=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/raster/Projection.glsl":function(){define(["exports","../../shaderModules/Float2PassUniform","../../shaderModules/glsl","../../shaderModules/Texture2DPassUniform"],(function(e,t,r,i){"use strict";e.Projection=function(e){e.fragment.uniforms.add(new i.Texture2DPassUniform("u_transformGrid",(e=>e.u_transformGrid)),new t.Float2PassUniform("u_transformSpacing",(e=>e.common.u_transformSpacing)),new t.Float2PassUniform("u_targetImageSize",(e=>e.common.u_targetImageSize))),e.fragment.code.add(r.glsl`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/RasterColorizerTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../../2d/engine/imagery/enums","./TileBlendTechniqueConfiguration","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r,i,s){"use strict";class n extends i.TileBlendTechniqueConfiguration{constructor(){super(...arguments),this.colorizerType=r.RasterColorizerType.Stretch,this.stretchType=r.RasterColorizerStretchType.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}}t.__decorate([s.parameter({count:r.RasterColorizerType.COUNT})],n.prototype,"colorizerType",void 0),t.__decorate([s.parameter({count:r.RasterColorizerStretchType.COUNT})],n.prototype,"stretchType",void 0),t.__decorate([s.parameter()],n.prototype,"applyColormap",void 0),t.__decorate([s.parameter()],n.prototype,"requireBilinearWithNN",void 0),e.RasterColorizerTechniqueConfiguration=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/support/MultiSizeFramebuffer":function(){define(["exports","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/RenderbufferDescriptor","../../../webgl/TextureDescriptor"],(function(e,t,r,i,s){"use strict";e.MultiSizeFramebuffer=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach((e=>e.dispose())),this._fbos.clear()}_getPool(e){const n=this._fbos.get(e);if(n)return n;const o=new r.FramebufferObject(this._rctx,new s.TextureDescriptor(e),new i.RenderbufferDescriptor(t.SizedDepthStencilFormat.DEPTH24_STENCIL8,e));return this._fbos.set(e,o),o}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/glUtil3D":function(){define(["exports","../../../../geometry/support/float16","./DefaultVertexAttributeLocations","./DefaultVertexBufferLayouts","./VertexArrayObject","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l){"use strict";var c;e.Layout=void 0,(c=e.Layout||(e.Layout={}))[c.Pos2=0]="Pos2",c[c.Pos2Tex=1]="Pos2Tex",e.createEmptyTexture=function(e){const t=new l.TextureDescriptor(4);return t.samplingMode=o.TextureSamplingMode.NEAREST,new a.Texture(e,t)},e.createQuadVAO=function(a,l=e.Layout.Pos2,c=r.Default3D,u=-1,d=1){const h=l===e.Layout.Pos2Tex,p=h?t.hasNativeFloat16Array?new Float32Array([u,u,0,d,u,0,u,d,0,d,d,0]):new Float32Array([u,u,0,0,d,u,1,0,u,d,0,1,d,d,1,1]):new Float32Array([u,u,d,u,u,d,d,d]);if(h&&t.hasNativeFloat16Array){const e=t.makeFloat16Array(p.buffer);e[10]=e[17]=e[22]=e[23]=1}const m=h?t.hasNativeFloat16Array?i.Pos2TexF16:i.Pos2TexF32:i.Pos2;return new s.VertexArrayObject(a,c,new Map([["geometry",m]]),new Map([["geometry",n.BufferObject.createVertex(a,o.Usage.STATIC_DRAW,p)]]))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TileRenderInfo":function(){define(["exports","../../../core/PooledArray"],(function(e,t){"use strict";class r{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}}e.TileRenderInfo=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new t({allocator:e=>e||new r})}},e.VTLNeighhborInfo=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TileTexture":function(){define(["exports","../../webgl/enums","../../webgl/textureUtils"],(function(e,t,r){"use strict";function i(e,t=r.isCompressedFormat(e.internalFormat)){return`${e.width} ${e.pixelFormat} ${t}`}e.TileTexture=class{constructor(e,r){this._texture=e,this._cache=r,this.type="tile-texture",this._refCount=1,this._texture.descriptor.context.instanceCounter.increment(t.ResourceType.TileTexture,this)}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&(this._cache?(this._texture.abortCompression(),this._cache.put(i(this.descriptor),this)):this.dispose())}dispose(){this._texture.descriptor.context.instanceCounter.decrement(t.ResourceType.TileTexture,this),this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get cachedMemory(){return this._texture.usedMemory}},e.getCacheKey=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/TextureCompressionWorkerHandle":function(){define(["exports","../../core/mathUtils","../../core/workers/WorkerHandle","../webgl/enums"],(function(e,t,r,i){"use strict";function s(e,r){let s=r.width,n=r.height;return(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(s=e.width,n=e.height),(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof Uint8Array)&&(r.pixelFormat===i.PixelFormat.RGBA||r.pixelFormat===i.PixelFormat.RGB)&&t.isPowerOfTwo(s)&&t.isPowerOfTwo(n)&&s>=16&&n>=16}class n extends r.WorkerHandle{constructor(e){super("TextureCompressionWorker","compress",{compress:e=>[e.data]},e)}isCompressible(e,t){return s(e,t)}}e.TextureCompressionWorkerHandle=n,e.isCompressible=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/workers/WorkerHandle":function(){define(["exports","../arrayUtils","../handleUtils","../Logger","../promiseUtils","./workers"],(function(e,t,r,i,s,n){"use strict";e.WorkerHandle=class{constructor(e,t,r,s,o={}){this._mainMethod=t,this._transferLists=r,this._listeners=[],this._promise=n.open(e,{...o,schedule:s}).then((e=>{if(void 0===this._thread){this._thread=e,this._promise=null,o.hasInitialize&&this.broadcast({},"initialize");for(const e of this._listeners)this._connectListener(e)}else e.close()})),this._promise.catch((t=>i.getLogger("esri.core.workers.WorkerHandle").error(`Failed to initialize ${e} worker: ${t}`)))}on(e,i){const s={removed:!1,eventName:e,callback:i,threadHandle:null};return this._listeners.push(s),this._connectListener(s),r.makeHandle((()=>{s.removed=!0,t.remove(this._listeners,s),this._thread&&null!=s.threadHandle&&s.threadHandle.remove()}))}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}invoke(e,t,r){return this.invokeMethod(this._mainMethod,e,t,r)}invokeMethod(e,t,r,i){if(this._thread){const s=this._transferLists[e],n=s?s(t):[];return this._thread.invoke(e,t,{transferList:n,signal:r,priority:i})}return this._promise?this._promise.then((()=>(s.throwIfAborted(r),this.invokeMethod(e,t,r)))):Promise.reject(null)}broadcast(e,t){return this._thread?Promise.all(this._thread.broadcast(t,e)).then((()=>{})):this._promise?this._promise.then((()=>this.broadcast(e,t))):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then((t=>{e.removed||(e.threadHandle=t)}))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/ComponentIntersectionData":function(){define(["exports","../../../../../core/mathUtils","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../lib/RayIntersections"],(function(e,t,r,i,s){"use strict";const n=1e-6;class o{constructor(e,t,r,i,s){this.aabb=e,this.axis=t,this.d=r,this.midStartIndex=i,this.rightStartIndex=s}}class a{constructor(e,s,n,a){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=s,this.positions=a,this._rayDirection=r.create(),this._callback=p,this._intersectionOptions=h,this.bspNodeTree=new Array;const m=n-s,f=new(m<u?Uint8Array:m<d?Uint16Array:Uint32Array)(m);this.triangleIndexMap=f;for(let e=0;e<m;++e)f[e]=e;{const r=function(e,t,r,i,s){const n=r-t,o=new Float32Array(6*n);for(let r=0;r<n;++r){const n=3*(r+t),a=e[n]*s,l=e[n+1]*s,c=e[n+2]*s;for(let e=0;e<3;++e){const t=i[a+e],s=i[l+e],n=i[c+e];o[6*r+e]=Math.min(t,s,n),o[6*r+3+e]=Math.max(t,s,n)}}return o}(e,s,n,a.data,a.stride),u=t.clamp(Math.log2(m/40),2,10),d=(e,t,s)=>{const n=function(e,t,r,s){if(s<=r)return i.fromValues(NaN,NaN,NaN,NaN,NaN,NaN);{const i=6*e[r];for(let e=0;e<3;++e)l[e]=t[i+0+e],c[e]=t[i+3+e]}for(let i=r+1;i<s;++i){const r=6*e[i];for(let e=0;e<3;++e)l[e]=Math.min(l[e],t[r+0+e]),c[e]=Math.max(c[e],t[r+3+e])}return i.fromValues(l[0],l[1],l[2],c[0],c[1],c[2])}(f,r,e,t),a=t-e;if(a<=40){const r=new o(n,void 0,0,e,t);return this.bspNodeTree.push(r),r}const{axis:h,midValue:p}=function(e){const t=e[3]-e[0],r=e[4]-e[1],i=e[5]-e[2],s=t>r?t>i?0:r>i?1:2:r>i?1:i>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}(n),m=function(e,t,r,i,s,n){let o=r,a=i;for(;o<a;){const r=e[o];t[6*r+s+3]<=n?++o:(--a,e[o]=e[a],e[a]=r)}let l=o;for(a=i;l<a;){const r=e[a-1];t[6*r+s]>=n?--a:(e[a-1]=e[l],e[l]=r,++l)}return{next:o,mid:l}}(f,r,e,t,h,p),g=(e,t)=>{if(s>u)return;const r=t-e;return r<40||r>=.8*a?void 0:d(e,t,s+1)},y=new o(n,h,p,m.next,m.mid);return this.bspNodeTree.push(y),y.leftNode=g(e,m.next),y.rightNode=g(m.mid,t),y};d(0,m,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const r=this.positions;s.intersectRayTriangles(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,r.data,r.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),a.numFacesTested+=t-e}intersectRay(e,t,r,i){a.numFacesTested=0;const s=e,o=t,l=o[0]-s[0],c=o[1]-s[1],u=o[2]-s[2];if(l*l+c*c+u*u<n)return;this._rayFrom=s;const d=this._rayDirection;d[0]=l,d[1]=c,d[2]=u;const m=this.triangleIndexMap.length;this._callback=i,this._intersectionOptions=r,this.intersectRayBSP(this.bspNodeTree[0],0,m),this._callback=p,this._intersectionOptions=h}intersectRayBSP(e,t,r){const i=this._rayFrom,s=this._rayDirection;if(!function(e,t,r){const i=t,s=r;let o=0,a=1/0;for(let t=0;t<3;++t){{const r=e[t];if(i[t]<r){if(s[t]<=n)return!1;const e=(r-i[t])/s[t];o=Math.max(o,e)}else if(s[t]<=-1e-6){const e=(r-i[t])/s[t];a=Math.min(a,e)}if(o>a)return!1}{const r=e[t+3];if(i[t]>r){if(s[t]>=-1e-6)return!1;const e=(r-i[t])/s[t];o=Math.max(o,e)}else if(s[t]>=n){const e=(r-i[t])/s[t];a=Math.min(a,e)}if(o>a)return!1}}return!0}(e.aabb,i,s))return;const o=e.axis,a=e.d;if(i[o]<a||s[o]<0){const r=t,i=e.midStartIndex;if(r<i){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,r,i):this.intersectRayTriangleRange(r,i)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),i[o]>a||s[o]>0){const t=e.rightStartIndex,i=r;if(t<i){const r=e.rightNode;void 0!==r?this.intersectRayBSP(r,t,i):this.intersectRayTriangleRange(t,i)}}}static{this.numFacesTested=0}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}const l=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0],u=255,d=65535,h=new s.MeshIntersectionOptions,p=()=>{};e.ComponentIntersectionData=a,e.componentMinimalSizeForIntersectionData=200,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/TerrainTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../../terrain/TransparencyMode","../core/shaderLibrary/attributes/NormalAttribute.glsl","../core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../core/shaderLibrary/terrain/Overlay.glsl","../core/shaderLibrary/terrain/TileBlendInput","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";class u extends c.DefaultTechniqueConfiguration{constructor(e){super(),this.spherical=e,this.overlayMode=o.OverlayMode.Disabled,this.tileBlendInput=a.TileBlendInput.LayerOnly,this.transparencyMode=r.TransparencyMode.Opaque,this.pbrMode=n.PBRMode.Simplified,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.normalType=i.NormalType.Compressed,this.textureCoordinateType=s.TextureCoordinateType.Default,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.draped=!1}get overlayEnabled(){return this.overlayMode!==o.OverlayMode.Disabled}}t.__decorate([l.parameter({count:o.OverlayMode.COUNT})],u.prototype,"overlayMode",void 0),t.__decorate([l.parameter({count:a.TileBlendInput.COUNT})],u.prototype,"tileBlendInput",void 0),t.__decorate([l.parameter({count:r.TransparencyMode.COUNT})],u.prototype,"transparencyMode",void 0),t.__decorate([l.parameter({count:n.PBRMode.COUNT})],u.prototype,"pbrMode",void 0),t.__decorate([l.parameter()],u.prototype,"receiveShadows",void 0),t.__decorate([l.parameter()],u.prototype,"backfaceCullingEnabled",void 0),t.__decorate([l.parameter()],u.prototype,"textureFadingEnabled",void 0),t.__decorate([l.parameter()],u.prototype,"renderOccluded",void 0),t.__decorate([l.parameter()],u.prototype,"screenSpaceReflections",void 0),t.__decorate([l.parameter()],u.prototype,"cloudReflections",void 0),t.__decorate([l.parameter()],u.prototype,"screenSizePerspective",void 0),t.__decorate([l.parameter()],u.prototype,"receiveAmbientOcclusion",void 0),t.__decorate([l.parameter()],u.prototype,"tileBorders",void 0),t.__decorate([l.parameter()],u.prototype,"visualizeNormals",void 0),e.TerrainTechniqueConfiguration=u,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/TerrainSurfacePerformanceInfo":function(){define((function(){"use strict";return class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}}))},"esri/views/3d/terrain/TilingSchemeLogic":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/aaBoundingRect","../../../layers/support/layerUtils","../../ViewingMode","../support/supportedSpatialReference","./terrainUtils","./TilingScheme"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";e.TilingSchemeLogic=class extends r{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",(()=>this._update())),s.watch((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!u.isTiledLayer(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,r){return null!=p.getTiledLayerInfo(e,t,r)}(t,this.viewSpatialReference,this.viewingMode)||(e=t,"vector-tile"===t?.type||p.isProjectableRasterLayer(t))))),e)if(e.isResolved()){const t=e,r=p.getTiledLayerInfo(t,this.viewSpatialReference,this.viewingMode);if(null!=r){const e=new m.TilingScheme(r.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===d.ViewingMode.Global){const t=e.levels.length-1,r=e.spatialReference;r.isWebMercator?e=m.TilingScheme.makeWebMercatorAuxiliarySphere(t):h.isSupportedEarthGCS(r)&&(e=m.TilingScheme.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(s.watch((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===d.ViewingMode.Global){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=m.TilingScheme.WebMercatorAuxiliarySphere:h.isSupportedGCSOnGlobe(e)&&(this.tilingScheme=m.TilingScheme.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||c.equals(e,this.extent)||(this.tilingScheme=m.TilingScheme.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}},t.__decorate([n.property()],e.TilingSchemeLogic.prototype,"tilingScheme",void 0),t.__decorate([n.property({readOnly:!0})],e.TilingSchemeLogic.prototype,"extent",void 0),t.__decorate([n.property({value:!1})],e.TilingSchemeLogic.prototype,"tilingSchemeLocked",void 0),t.__decorate([n.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"viewSpatialReference",void 0),t.__decorate([n.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"layers",void 0),t.__decorate([n.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"extentHelper",void 0),t.__decorate([n.property({constructOnly:!0})],e.TilingSchemeLogic.prototype,"viewingMode",void 0),e.TilingSchemeLogic=t.__decorate([l.subclass("esri.views.3d.terrain.TilingSchemeLogic")],e.TilingSchemeLogic),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/terrain/UpsampleInfo":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec2f64"],(function(e,t){"use strict";e.UpsampleInfo=class{constructor(){this._offset=t.create(),this.scale=0}get offset(){return this._offset}init(e,t,r,i){this.tile=e,this._offset[0]=t,this._offset[1]=r,this.scale=i}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/TextureCompressionTracker":function(){define(["exports","../../core/signal"],(function(e,t){"use strict";e.TextureCompressionTracker=class{constructor(){this._pendingCompressionTasks=t.signal(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/Stage":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/compilerUtils","../../../core/has","../../../core/PooledArray","../../../core/promiseUtils","../../../core/signal","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../state/helpers/SceneIntersectionHelper","../support/TextureCollection","./lib/ChangeSet","./lib/UpdatePolicy","./parts/Model","./parts/RenderView","../../support/Scheduler","../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";e.Stage=class extends r{constructor(e){super(e),this._model=new g.Model,this._canCompact=a.signal(!1),this._layers=new n,this._asyncChangeSet=new m.ChangeSet,this._syncChangeSet=new m.ChangeSet,this._layerSyncSet=new Set,this.textures=new p.TextureCollection(this,e.view.resourceController.scheduler),this._frameTask=e.view.resourceController.scheduler.registerTask(_.TaskPriority.STAGE,this),this.addHandles(this._frameTask)}initialize(){this._renderView=new y.RenderView({stage:this})}destroy(){this.textures.destroy(),this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating||this.textures.updating}get renderView(){return this._renderView}get renderer(){return this.renderView.renderer}addTexture(e){this._model.addTexture(e),this.renderView.requestRender()}removeTexture(e){null!=e&&!this.destroyed&&this._model.hasTexture(e)&&(this._model.removeTexture(e),this.renderView.requestRender())}addTextures(e){null!=e&&(this._model.addTextures(e),this.renderView.requestRender())}removeTextures(e){null!=e&&(this._model?.removeTextures(e),this.renderView.requestRender())}forEachTexture(e){this._model.forEachTexture(e)}getTexture(e){return this._model.getTexture(e)}addLayer(e){this._layers.includes(e)||(this._model.addLayer(e),this._layers.push(e),this._model.dirtySet.layerAdded(e),this.renderView.requestRender())}removeLayer(e){null!=e&&!this.destroyed&&this._model.hasLayer(i.toConst(e))&&(this._model.dirtySet.layerRemoved(e),this._commitLayer(e),this._layers.removeUnordered(e),this._model.dirtySet.assertLayerClean(e.id),this._model.removeLayer(e),this.renderView.requestRender())}getLayer(e){return this._model.getLayer(e)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty||this._canCompact.value}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),this.renderer.compact(e),this._canCompact.value=this.renderer.canCompact,!e.hasProgressed)return b.Yield}compact(e){return this._canCompact.value=!1,this.renderer.compact(e)}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((r=>{if(e.done)return;const i=this._layerSyncSet.has(r.id)||r.updatePolicy===f.UpdatePolicy.SYNC,s=i?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(r.id,s),this._layerSyncSet.delete(r.id),s.empty||(this.renderer.commit(s,i?_.noBudget:e),this.renderView.requestRender(),e.madeProgress())})),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,_.noBudget),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((r=>{e.done||this._layerSyncSet.has(r.id)||r.updatePolicy!==f.UpdatePolicy.ASYNC||(t.commitLayer(r.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===f.UpdatePolicy.SYNC?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)}));for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,_.noBudget),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,_.noBudget),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}get layers(){return this._layers}addRenderPlugin(e,t){const r=this.renderer.plugins.add(e,t),i=()=>{h.isIntersectionHandler(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if(o.isPromiseLike(r))return r.then(i);i()}removeRenderPlugin(e){this.destroyed||(h.isIntersectionHandler(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get test(){}},t.__decorate([l.property({constructOnly:!0})],e.Stage.prototype,"view",void 0),t.__decorate([l.property({constructOnly:!0})],e.Stage.prototype,"options",void 0),t.__decorate([l.property({readOnly:!0})],e.Stage.prototype,"viewingMode",null),t.__decorate([l.property({constructOnly:!0})],e.Stage.prototype,"container",void 0),t.__decorate([l.property({readOnly:!0})],e.Stage.prototype,"updating",null),t.__decorate([l.property({constructOnly:!0})],e.Stage.prototype,"_model",void 0),t.__decorate([l.property()],e.Stage.prototype,"_renderView",void 0),t.__decorate([l.property({readOnly:!0})],e.Stage.prototype,"renderer",null),t.__decorate([l.property()],e.Stage.prototype,"textures",void 0),t.__decorate([l.property({readOnly:!0})],e.Stage.prototype,"running",null),e.Stage=t.__decorate([d.subclass("esri.views.3d.webgl-engine.Stage")],e.Stage),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/parts/Model":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/sphere","../lib/GridLocalOriginFactory","../lib/ModelDirtySet","../lib/RenderGeometry","../lib/Util"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.Model=class extends r{constructor(){super(...arguments),this.dirtySet=new d({model:this}),this._originFactory=new u.GridLocalOriginFactory(null),this._textures=new Map,this._layers=new Map}hasTexture(e){return this._textures.has(e.id)}getTexture(e){return null==e?null:this._textures.get(e)}addTexture(e){const t=e.id;p.assert(!this._textures.has(t),"Model/Stage already contains texture to be added"),this._textures.set(t,e)}removeTexture(e){return this._textures.delete(e.id)}addTextures(e){for(const t of e)t&&(p.assert(!this._textures.has(t.id),"Model/Stage already contains object to be added"),this._textures.set(t.id,t))}removeTextures(e){for(const t of e)t&&(p.assert(this._textures.has(t.id),"Model/Stage doesn't contain object to be removed"),this._textures.delete(t.id))}forEachTexture(e){this._textures.forEach((t=>e(t)))}hasLayer(e){return this._layers.has(e.id)}getLayer(e){return null==e?null:this._layers.get(e)}addLayer(e){const t=e.id;p.assert(!this._layers.has(t),"Model/Stage already contains layer to be added"),this._layers.set(t,e)}removeLayer(e){return this._layers.delete(e.id)}getRenderGeometry(e,t){const r=new h.RenderGeometry(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation}),i=t.localOrigin;return r.transformation=e.getCombinedStaticTransformation(t,m),r.localOrigin=i??this._originFactory.getOrigin(c.getCenter(r.boundingSphere)),r}updateRenderGeometryTransformation(e,t,r){if(null==e)return!1;r.transformation=e.getCombinedStaticTransformation(t,m);const i=this._originFactory.getOrigin(c.getCenter(r.boundingSphere));return r.localOrigin!==i}get test(){}},t.__decorate([s.property({constructOnly:!0})],e.Model.prototype,"dirtySet",void 0),e.Model=t.__decorate([a.subclass("esri.views.3d.webgl-engine.parts.Model")],e.Model);const m=l.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ModelDirtySet":function(){define(["../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/NestedMap","../../../../core/uid","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./ModelDirtyTypes","./Util"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d{constructor(e,t,r,i){this.operation=e,this.geometry=t,this.states=r,this.sync=i}}let h=class extends t{constructor(e){super(e),this._residentGeomRecords=new i.NestedMap,this._dirtyGeomRecords=new i.NestedMap,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const r=this._dirtyGeomRecords.getInner(e),i=this.model.getLayer(e);if(!r||!i)return;let s=0;r.forEach(((r,n)=>{const o=this._ensureGeomRecord(e,n);this._dirtyGeomRecords.delete(e,n),s+=r.size,r.forEach((({geometry:e,operation:r,states:s},a)=>{let l=!1;if(r===c.DirtyOperation.UPDATE){const r=o.get(a);if(r){if(s&c.DirtyState.TRANSFORMATION){const t=i.getObject(n);this.model.updateRenderGeometryTransformation(t,e,r)&&(l=!0)}l||t.updates.push({renderGeometry:r,updateType:s})}else u.assert(!1,"ModelDirtySet.commitLayer: invalid update")}if(r===c.DirtyOperation.REMOVE||l){const e=o.get(a);e?(t.removes.push(e),o.delete(a)):r===c.DirtyOperation.REMOVE&&u.assert(!1,"ModelDirtySet.commitLayer: invalid remove")}if(r===c.DirtyOperation.ADD||l){const r=i.getObject(n);if(null!=r){const i=this.model.getRenderGeometry(r,e);t.adds.push(i),o.set(a,i)}}})),0===o.size&&this._residentGeomRecords.delete(e,n)})),this._dirtyRecordCount-=s}commitSyncUpdates(e,t){const r=this._dirtyGeomRecords.getInner(e),i=this.model.getLayer(e);r&&i&&r.forEach(((r,s)=>{const n=this._ensureGeomRecord(e,s);r.forEach((({geometry:e,operation:r,states:o,sync:a},l)=>{let d=!1;if(r===c.DirtyOperation.UPDATE&&a){const r=n.get(l);if(r){if(o&c.DirtyState.TRANSFORMATION){const t=i.getObject(s);this.model.updateRenderGeometryTransformation(t,e,r)&&(d=!0)}d||t.updates.push({renderGeometry:r,updateType:o})}else u.assert(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}}))}))}_objectStateChanged(e,t){for(const r of t.geometries)this._updateOrCreateDirtyRecord(t,r,c.DirtyOperation.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(c.DirtyState.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(c.DirtyState.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(c.DirtyState.OCCLUDEE,e)}attributesChanged({object:e,geometry:t,sync:r}){this._updateOrCreateDirtyRecord(e,t,c.DirtyOperation.UPDATE,c.DirtyState.GEOMETRY,r)}layerAdded(e){e.objects.forEach((e=>this.layerObjectAdded(e)))}layerRemoved(e){e.objects.forEach((e=>this.layerObjectRemoved(e)))}layerObjectAdded(e){for(const t of e.geometries)this._geometryAdded(e,t)}layerObjectRemoved(e){for(const t of e.geometries)this._geometryRemoved(e,t)}layerObjectsAdded(e){for(const t of e)this.layerObjectAdded(t)}layerObjectsRemoved(e){for(const t of e)this.layerObjectRemoved(t)}transformationChanged(e){const t=this._getLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach((({geometry:t})=>this._updateOrCreateDirtyRecord(e,t,c.DirtyOperation.UPDATE,c.DirtyState.TRANSFORMATION)))}shaderTransformationChanged(e){const t=this._getLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach((t=>t.objectShaderTransformationChanged(e.shaderTransformation)))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){this._updateOrCreateDirtyRecord(e,t,c.DirtyOperation.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){this._updateOrCreateDirtyRecord(e,t,c.DirtyOperation.REMOVE)}_updateOrCreateDirtyRecord(e,t,r,i=c.DirtyState.NONE,s=!1){const n=this._getLayerId(e),o=e.id,a=t.id,l=this._ensureDirtyRecord(n,o),h=l.get(a);if(h){const e=h.operation;e===c.DirtyOperation.REMOVE&&r===c.DirtyOperation.ADD&&h.states!==c.DirtyState.NONE?h.operation=c.DirtyOperation.UPDATE:e===c.DirtyOperation.REMOVE&&r===c.DirtyOperation.ADD||e===c.DirtyOperation.ADD&&r===c.DirtyOperation.REMOVE?(l.delete(a),this._dirtyRecordCount--):e!==c.DirtyOperation.UPDATE||r!==c.DirtyOperation.REMOVE&&r!==c.DirtyOperation.UPDATE?(u.assert((e===c.DirtyOperation.REMOVE||e===c.DirtyOperation.ADD)&&r===c.DirtyOperation.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),h.states|=i):(h.operation=r,h.states|=i),h.sync=h.sync||s}else l.set(a,new d(r,t,i,s)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let r=this._residentGeomRecords.get(e,t);return r||(r=new Map,this._residentGeomRecords.set(e,t,r)),r}assertLayerClean(e){u.assert(null==this._dirtyGeomRecords.getInner(e),"Dirty geometry records for removed layer")}_ensureDirtyRecord(e,t){const r=this.model.getLayer(e);u.assert(null!=r,"Updating geometry record for an unregistered layer");let i=this._dirtyGeomRecords.get(e,t);return i||(i=new Map,this._dirtyGeomRecords.set(e,t,i)),i}_getLayerId(e){return e.layer?.id??s.nullUid}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forAll(((r,i,s)=>{t.length>0&&(t+="\n"),t+=i+"."+s;const n=[];r.forEach((e=>{const t=e.operation;n[t]||(n[t]=[]),n[t].push(e.geometry.id)}));for(let r=0;r<n.length;r++)if(n[r]){t+=" "+e[r-1]+": ";for(let e=0;e<n[r].length;e++)t+=n[r][e]+", "}})),t}get test(){}};return e.__decorate([n.property({constructOnly:!0})],h.prototype,"model",void 0),e.__decorate([n.property()],h.prototype,"_dirtyRecordCount",void 0),h=e.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.ModelDirtySet")],h),h}))},"esri/views/3d/webgl-engine/lib/RenderGeometry":function(){define(["exports","../../../../core/uid","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../chunks/sphere","../../support/mathUtils"],(function(e,t,r,i,s,n,o){"use strict";class a{constructor(e,r={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=i.create(),this._shaderTransformation=null,this._boundingSphere=null,this.id=t.generateUID(),this.layerViewUid=r.layerViewUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){r.copy(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){null==e?this._shaderTransformation=null:(this._shaderTransformation??=i.create(),r.multiply(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(null==this._boundingSphere&&(this._boundingSphere??=n.create(),s.transformMat4(n.getCenter(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*o.maxScale(this.shaderTransformation)),this._boundingSphere):n.NullSphere}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlight(){return this.geometry.highlights}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}e.RenderGeometry=a,e.ValidatedRenderGeometry=class extends a{},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/parts/RenderView":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/floatRGBA","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/time","../../../../core/accessorSupport/decorators/property","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/spatialReferenceUtils","../../../ViewingMode","../../environment/ChapmanAtmosphere","../../environment/CloudsComposition","../../environment/Fog","../../environment/LocalAtmosphere","../../environment/MarsAtmosphere","../collections/Component/ComponentObjectCollection","../core/shaderTechnique/ShaderTechniqueConstructionContext","../core/shaderTechnique/ShaderTechniqueRepository","../effects/bloom/BloomRenderNode","../effects/geometry/ObjectAndLayerIDRenderNode","../effects/geometry/olidUtils","../effects/geometry/RenderOccludedRenderNode","../effects/haze/Haze","../effects/highlight/Highlight","../effects/highlight/ShadowHighlight","../effects/magnifier/Magnifier","../effects/smaa/SMAA","../effects/ssao/SSAO","../effects/stars/Stars","../lib/basicInterfaces","../lib/CompositingHelper","../lib/GLMaterialRepository","../lib/ObjectAndLayerIdRenderHelper","../lib/Renderer","../lib/RenderingContext","../lib/TextureRepository","../materials/markerTextureRepository","../materials/stippleTextureRepository","../materials/internal/WaterTextureRepository","./contextCache","./renderUtils","./ScreenshotManager","./testUtils","../../../support/RenderState","../../../webgl/checkWebGLError"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z,Y){"use strict";e.RenderView=class extends r{constructor(e){super(e),this.events=new i,this.waterTextures=new q.WaterTextureRepository,this.olidRenderHelper=P.olidEnabled()?new V.ObjectAndLayerIdRenderHelper:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this.bloom=null,this.test=null;const t=e.stage;try{this._initializeContext(t)}catch(e){return void console.error("Failed to initialize context",e)}const{memoryController:r}=t.view.resourceController;this.stippleTextures=j.createStippleTextureRepository(this._rctx,r),this.markerTextures=z.createMarkerTextureRepository(this._rctx,r),this._techniques=new x.ShaderTechniqueRepository(new w.ShaderTechniqueConstructionContext(this._rctx,t.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new k.TextureRepository(t),this.addHandles(this._textures.events.on("changed",(e=>this.requestRender(e))));const s=new U.GLMaterialRepository(this._textures,this._techniques,(()=>this.requestRender()),(()=>this.requestRender()));this._compositingHelper=new N(this._rctx,this._techniques),this.renderer=new B.Renderer(t,s,this._techniques,this._rctx,this._compositingHelper,(e=>this.requestRender(e))),this.addHandles([l.watch((()=>t.view.ready),(e=>{e&&this._createRenderNodes()}),l.initial),l.watch((()=>this.waterTextures?.updating),(()=>this.requestRender()),l.initial),l.watch((()=>t.view.qualityProfile),(e=>this.renderer?.updateRenderFeatures(e)),l.syncAndInitial)]);const n={renderScene:(e,t,r,i)=>this.renderer.render(e,t,r,i),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(e,r,i)=>t.options.screenshot.renderOverlay(e,r,i)};this._screenshotManager=new $.ScreenshotManager(this._rctx,n,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(t)}destroy(){const e=this.stage?.container;e?.contains(this._canvas)&&e.removeChild(this._canvas),this._frameTask=a.removeMaybe(this._frameTask),this._techniques=a.destroyMaybe(this._techniques),this._componentObjects=a.destroyMaybe(this._componentObjects),this._screenshotManager=a.destroyMaybe(this._screenshotManager),a.destroyMaybe(this.renderer),this._textures=a.destroyMaybe(this._textures),a.destroyMaybe(this.waterTextures),a.destroyMaybe(this.markerTextures),a.destroyMaybe(this.stippleTextures),this._canvas=null,this._rctx=a.destroyMaybe(this._rctx)}_createRenderNodes(){const{view:e,viewingMode:t}=this.stage;new F.Stars({view:e}),m.isMoon(e.spatialReference)||(t===f.ViewingMode.Local?(new b.LocalAtmosphere({view:e}),this.bloom=new T.BloomRenderNode({view:e})):m.isMars(e.spatialReference)?(new v({view:e}),this.bloom=new T.BloomRenderNode({view:e})):(new g.ChapmanAtmosphere({view:e}),new y.CloudsComposition({view:e}),this.bloom=new T.BloomRenderNode({view:e}),new R.Haze({view:e}),new _.Fog({view:e}))),new D.SSAO({view:e,isEnabled:()=>this.renderer.hasSSAO}),new I.SMAA({view:e,isEnabled:()=>this.renderer.hasSMAA}),new A.Magnifier({view:e}),new E.Highlight({view:e}),new O.ShadowHighlight({view:e,viewingMode:t}),new M.RenderOccludedRenderNode({view:e}),P.olidEnabled()&&new C.ObjectAndLayerIDRenderNode({view:e})}requestRender(e=L.RenderRequestType.UPDATE){this._needsRender=!0,e===L.RenderRequestType.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,r,i,n,o=n){const a=i.constrainWindowSize(t,r,n*i.pixelRatio,o*i.pixelRatio),l=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,l);const c=(e,t,r)=>s.unpackFloatRGBA(t,e)*(r[1]-r[0])+r[0];let u=Number.MAX_VALUE;for(let e=0;e<a[2]*a[3];e++){const t=c(4*e,l,i.nearFar);u>t&&t!==i.nearFar[0]&&t!==i.nearFar[1]&&(u=t)}if(e){const s=e.pickDepth(t*i.pixelRatio,r*i.pixelRatio,i);null!=s&&u>s&&s!==i.nearFar[0]&&s!==i.nearFar[1]&&(u=s)}return u===Number.MAX_VALUE?void 0:u}_ensureLinearDepthArrayBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){W.removeLoadedShaderModules(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let r=!1,i=L.RenderRequestType.BACKGROUND,s=!1;const n={preRender:({time:s})=>{r=this.updating,i=this._needsUpdate?L.RenderRequestType.UPDATE:L.RenderRequestType.BACKGROUND,this._needsRender&&this.renderer.updateSceneDepthRange(t.camera),e.commitSyncLayers(),s=this.test?.time??s,(u.Milliseconds(s-this._lastAnimationUpdate)>this.renderer.animationTimestep||r||this._needsRender)&&(this.renderer.updateAnimation(t,s)&&this.requestRender(L.RenderRequestType.BACKGROUND),this._lastAnimationUpdate=s)},render:({time:e})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const r=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,e=this.test?.time??e,this.renderer.render(t,e),s=!0,r&&this.renderer.hasReflections&&(this.requestRender(L.RenderRequestType.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:e})=>{this._textures.update();const r=new $.ScreenshotContext(t,this.renderer.fboCache);e=this.test?.time??e,this._screenshotManager.update(r,e)},finish:()=>{s&&(this.renderer.finish(t.mode===Z.RenderState.IDLE?i:L.RenderRequestType.UPDATE),s=!1)}};this._frameTask=c.addFrameTask(n)}_initializeContext(e){const{options:t}=e,r=t.canvas??document.createElement("canvas");r.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=r;const i={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},s=r.getContext("webgl2",i);if(null==s)return void o.getLogger(this).error("A WebGL2 context could not be created.");Y.checkWebGLError(s,!0),this._rctx=function(e,t){const r={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8,maxPreferredTexturePixels:t.view.qualitySettings.maxTexturePixels,newCache:(e,r)=>t.view.resourceController.memoryController.newCache(e,r)};if(Q.contextCache.enabled){let t=X.get(e);return t?(t.configure(r),t.ref(),t):(t=new G.RenderingContext(e,r),X.set(e,t),t.ref(),t)}return new G.RenderingContext(e,r)}(s,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&o.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:a}=e;!this._rctx.contextAttributes.alpha&&n("safari")>=11&&(a.style.backgroundColor="black"),a.contains(r)||a.appendChild(r)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}getObjectAndLayerIdColor(e){return this.olidRenderHelper?.getObjectAndLayerIdColor(e)}get componentObjectCollection(){return null==this._componentObjects&&(this._componentObjects=new S.ComponentObjectCollection(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(e){this._componentObjects=e}updateQualitySettings(e){this.test&&null!=this.test.time&&(this.test.savedFadeDuration=e.fadeDuration,e.fadeDuration=u.Milliseconds(0)),this._rctx.updateOptions({maxPreferredTexturePixels:this.stage.view.qualitySettings.maxTexturePixels})}},t.__decorate([d.property({type:Boolean,readOnly:!0})],e.RenderView.prototype,"updating",null),t.__decorate([d.property({constructOnly:!0})],e.RenderView.prototype,"stage",void 0),t.__decorate([d.property()],e.RenderView.prototype,"_rctx",void 0),t.__decorate([d.property()],e.RenderView.prototype,"_canvas",void 0),t.__decorate([d.property()],e.RenderView.prototype,"stippleTextures",void 0),t.__decorate([d.property()],e.RenderView.prototype,"markerTextures",void 0),t.__decorate([d.property()],e.RenderView.prototype,"waterTextures",void 0),t.__decorate([d.property({readOnly:!0})],e.RenderView.prototype,"olidRenderHelper",void 0),t.__decorate([d.property()],e.RenderView.prototype,"_textures",void 0),t.__decorate([d.property({readOnly:!0})],e.RenderView.prototype,"renderer",void 0),t.__decorate([d.property()],e.RenderView.prototype,"_screenshotManager",void 0),t.__decorate([d.property()],e.RenderView.prototype,"componentObjectCollection",null),t.__decorate([d.property()],e.RenderView.prototype,"_componentObjects",void 0),t.__decorate([d.property()],e.RenderView.prototype,"_needsUpdate",void 0),t.__decorate([d.property()],e.RenderView.prototype,"_needsWaterReflectionUpdate",void 0),e.RenderView=t.__decorate([p.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView);const X=H.getContextCache();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/ChapmanAtmosphere":function(){define(["exports","../../../chunks/tslib.es6","../../../core/colorUtils","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/vec32","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/Ellipsoid","../webgl","./atmosphereUtils","./ChapmanAtmosphereTechnique","./ChapmanAtmosphereTechniqueConfiguration","../webgl-engine/core/FBOCacheFormats","../webgl-engine/effects/OpaqueEnvironment","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/textureUtils","../../../chunks/AtmosphereCompositing.glsl","../webgl-engine/shaders/AtmosphereCompositingTechnique","../../webgl/enums","../../../webscene/background/ColorBackground"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R){"use strict";e.ChapmanAtmosphere=class extends S.OpaqueEnvironment{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new C.AtmosphereCompositingPassParameters,this._vao=null,this._passParameters=new _.ChapmanAtmospherePassParameters,this._configuration=new b.ChapmanAtmosphereTechniqueConfiguration}initialize(){this.techniques.precompile(_.ChapmanAtmosphereTechnique,this._configuration),this.techniques.precompile(P.AtmosphereCompositingTechnique),this._configuration.reduced=!0,this.techniques.precompile(_.ChapmanAtmosphereTechnique,this._configuration),this._configuration.reduced=!1,this.addHandles([n.watch((()=>this.view.environment.background),(e=>{const t=e instanceof R?r.unitRGBAFromColor(e.color):m.ZEROS;h.set(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])}),n.syncAndInitial),n.watch((()=>this.view.stage?.renderer?.fullResolutionAtmosphere),(e=>this._configuration.reduced=!e),n.syncAndInitial),n.watch((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),n.syncAndInitial)])}destroy(){this._vao=s.disposeMaybe(this._vao)}render(e){const t=e.find((({name:e})=>e===g.InternalRenderCategory.OPAQUE_ENVIRONMENT));if(!this.bindParameters.mainDepth)return t;const r=this.renderingContext;this._vao??=x.createQuadVAO(r,x.Layout.Pos2Tex);const s=t.getAttachment(M.DepthStencilAttachment);this._update();const n=this.techniques.get(_.ChapmanAtmosphereTechnique,this._configuration);if(!n.compiled)return this.requestRender(w.RenderRequestType.UPDATE),t;if(!this._configuration.reduced)return t.detachDepth(),r.bindFramebuffer(t.fbo),r.bindTechnique(n,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(M.PrimitiveType.TRIANGLE_STRIP,0,4),t.attachDepth(s),t;const o=this.techniques.get(P.AtmosphereCompositingTechnique);if(!o.compiled)return this.requestRender(w.RenderRequestType.UPDATE),t;const a=r.getViewport(),l=this.bindParameters.camera,c=h.length(l.eye)-f.earth.radius;let u;const d=f.earth.atmosphereHeight;if(c<d){const e=Math.min(1,Math.max(0,c/d));u=i.lerp(.2,.3,e)}else{const e=Math.min(1,Math.max(0,(c-d)/(15*d)));u=i.lerp(.3,.6,e)}const p=this.renderingContext.parameters.maxTextureSize,m=T.applyTextureResizeModulo(Math.round(u*l.fullViewport[2]),p),y=T.applyTextureResizeModulo(Math.round(u*l.fullViewport[3]),p);r.setViewport(0,0,m,y);const b=this.fboCache.acquire(m,y,"chapman",v.ColorFormat.RGBA8UNORM);return r.bindFramebuffer(b.fbo),r.clearFramebuffer([0,0,0,1],!0,!0),r.bindTechnique(n,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(M.PrimitiveType.TRIANGLE_STRIP,0,4),r.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=b.getTexture(),t.detachDepth(),r.bindFramebuffer(t.fbo),r.bindTechnique(o,this.bindParameters,this._compositingPassParameters),r.screen.draw(),t.attachDepth(s),b.release(),t}_update(){const e=this.bindParameters.camera,t=h.squaredLength(e.eye),r=Math.sqrt(t),s=t-this._passParameters.radii[1]**2,n=i.clamp((r-this._passParameters.radii[0])/f.earth.atmosphereHeight,0,1);p.set(this._passParameters.heightParameters,r,t,s,n);const o=this.view.basemapTerrain?.getLowerBoundRadius()??0;d.set(this._passParameters.radii,o,o+f.earth.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*o-y.innerAtmosphereDepth)*y.innerAtmosphereDepth),this._passParameters.altitudeFade=y.computeInnerAltitudeFade(r-o)}},e.ChapmanAtmosphere=t.__decorate([u.subclass("esri.views.3d.environment.ChapmanAtmosphere")],e.ChapmanAtmosphere),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/colorUtils":function(){define(["exports","../Color","./arrayUtils","./lang","./mathUtils","../chunks/vec42","./libs/gl-matrix-2/factories/vec4f64"],(function(e,t,r,i,s,n,o){"use strict";function a(e){return"r"in e&&"g"in e&&"b"in e}function l(e){return"h"in e&&"s"in e&&"v"in e}function c(e){return"l"in e&&"a"in e&&"b"in e}function u(e){return"l"in e&&"c"in e&&"h"in e}const d=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],h=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function p(e,t){const r=[];let i,s;if(e[0].length!==t.length)throw new Error("dimensions do not match");const n=e.length,o=e[0].length;let a=0;for(i=0;i<n;i++){for(a=0,s=0;s<o;s++)a+=e[i][s]*t[s];r.push(a)}return r}function m(e){const t=[e.r/255,e.g/255,e.b/255].map((e=>e<=.04045?e/12.92:((e+.055)/1.055)**2.4)),r=p(d,t);return{x:100*r[0],y:100*r[1],z:100*r[2]}}function f(e){const t=p(h,[e.x/100,e.y/100,e.z/100]).map((e=>{const t=e<=.0031308?12.92*e:1.055*e**(1/2.4)-.055;return Math.min(1,Math.max(t,0))}));return{r:Math.round(255*t[0]),g:Math.round(255*t[1]),b:Math.round(255*t[2])}}function g(e){const t=[e.x/95.047,e.y/100,e.z/108.883].map((e=>e>(6/29)**3?e**(1/3):1/3*(29/6)**2*e+4/29));return{l:116*t[1]-16,a:500*(t[0]-t[1]),b:200*(t[1]-t[2])}}function y(e){const t=e.l,r=[(t+16)/116+e.a/500,(t+16)/116,(t+16)/116-e.b/200].map((e=>e>6/29?e**3:3*(6/29)**2*(e-4/29)));return{x:95.047*r[0],y:100*r[1],z:108.883*r[2]}}function _(e){return a(e)?e:u(e)?function(e){return f(y(function(e){const t=e.l,r=e.c,i=e.h;return{l:t,a:r*Math.cos(i),b:r*Math.sin(i)}}(e)))}(e):c(e)?function(e){return f(y(e))}(e):function(e){return"x"in e&&"y"in e&&"z"in e}(e)?f(e):l(e)?function(e){const t=(e.h+360)%360/60,r=e.s/100,i=e.v/100*255,s=i*r,n=s*(1-Math.abs(t%2-1));let o;switch(Math.floor(t)){case 0:o={r:s,g:n,b:0};break;case 1:o={r:n,g:s,b:0};break;case 2:o={r:0,g:s,b:n};break;case 3:o={r:0,g:n,b:s};break;case 4:o={r:n,g:0,b:s};break;case 5:case 6:o={r:s,g:0,b:n};break;default:o={r:0,g:0,b:0}}return o.r=Math.round(o.r+i-s),o.g=Math.round(o.g+i-s),o.b=Math.round(o.b+i-s),o}(e):e}function b(e){return l(e)?e:function(e){const t=e.r,r=e.g,i=e.b,s=Math.max(t,r,i),n=s-Math.min(t,r,i);let o=s,a=0===n?0:s===t?(r-i)/n%6:s===r?(i-t)/n+2:(t-r)/n+4,l=0===n?0:n/o;return a<0&&(a+=6),a*=60,l*=100,o*=100/255,{h:a,s:l,v:o}}(_(e))}function v(e){return c(e)?e:function(e){return g(m(e))}(_(e))}function S(e){let{r,g:i,b:s,a:n}=e;return n<1&&(r=Math.round(n*r+255*(1-n)),i=Math.round(n*i+255*(1-n)),s=Math.round(n*s+255*(1-n))),new t({r,g:i,b:s})}function w(e,t){const{r,g:i,b:s}=t?.ignoreAlpha?e:S(e);return.2126*r+.7152*i+.0722*s}var x;function T(e){return e[0]??=0,e[1]??=0,e[2]??=0,e}e.BrightnessThreshold=void 0,(x=e.BrightnessThreshold||(e.BrightnessThreshold={}))[x.Low=160]="Low",x[x.High=225]="High";const C=(e,t)=>{const r=Math.floor(10*t())-5;return Math.min(255,Math.max(0,e+r))};function P(e,i,s,n={}){const o=e.r,a=e.g,l=e.b,c=i.r,u=i.g,d=i.b,h=Math.round(o+(c-o)*s),p=Math.round(a+(u-a)*s),m=Math.round(l+(d-l)*s);if(!n.offset)return new t([h,p,m]);const f=r.getRandomNumberGenerator(n.seed);return new t([C(h,f),C(p,f),C(m,f)])}e.colorEquals=function(e,t){return e===t||null!=e&&e.equals(t)},e.colorVectorEquals=function(e,t){return e===t||null!=e&&null!=t&&n.equals(e,t)},e.colorVectorToColorAndOpacity=function(e){return o.fromValues(e[0],e[1],e[2],e.length>3?e[3]:1)},e.createUniqueColors=function(e,s,n={}){if(0===e.length||s<=0)return[];if(1===(e=e.map((e=>"string"==typeof e?new t(e):e))).length||1===s){const t=[],r=e[0];for(let e=0;e<s;e++)t.push(r.clone());return t}if(n.shuffle&&(e=r.shuffle(i.clone(e),n.seed)),e.length>=s){const t=[],r=(e.length-1)/(s-1);for(let i=0;i<s;i++){const s=Math.round(i*r);t.push(e[s].clone())}return t}return function(e,t,i={}){const s=[],n=e.length-1,o=Math.ceil((t-e.length)/n);e:for(let r=0;r<n;r++){const n=e[r],a=e[r+1];for(let r=1;r<=o;r++){const l=r/(o+1);if(s.push(P(n,a,l,i)),s.length+e.length===t)break e}}return[...e.map((e=>e.clone())),...r.shuffle(s,i.seed??1)]}(e,s,n)},e.darken=function(e,t){const r=v(e);r.l*=1-t;const i=_(r),s=e.clone();return s.setColor(i),s.a=e.a,s},e.desaturate=function(e,t){const r=b(e);r.s*=t;const i=_(r),s=e.clone();return s.setColor(i),s.a=e.a,s},e.getColorLuminance=w,e.getColorTheme=function(e){return S(e).isBright?"light":"dark"},e.getContrast=function(r,i=e.BrightnessThreshold.High){return w(r,{ignoreAlpha:!0})>i?new t([0,0,0,r.a]):new t([255,255,255,r.a])},e.isRGB=a,e.multiplyOpacity=function(e,t){const r=e.clone();return r.a*=t,r},e.multiplyOpacityToUnitRGBA=function(e,r){const i=t.toUnitRGBA(e);return i[3]*=r,i},e.toHSV=b,e.toLAB=v,e.toLCH=function(e){return u(e)?e:function(e){return function(e){const t=e.l,r=e.a,i=e.b,s=Math.sqrt(r*r+i*i);let n=Math.atan2(i,r);return n=n>0?n:n+2*Math.PI,{l:t,c:s,h:n}}(g(m(e)))}(_(e))},e.toRGB=_,e.unitRGBAFromColor=function(e){return t.toUnitRGBA(e)},e.validateColor=T,e.validateColorAndOpacity=function(e){return e.length=4,T(e),e[3]??=1,s.clamp(e[3],0,1),e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/ChapmanAtmosphereTechnique":function(){define(["require","exports","../../../core/libs/gl-matrix-2/factories/vec3f64","./ChapmanApproximation.glsl","../../../chunks/ChapmanAtmosphere.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../../webgl/enums","../../webgl/renderState"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends i.ChapmanApproximationParameters{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=r.create()}}class u extends o.ShaderTechnique{constructor(t,r){super(t,r,new n.ReloadableShaderModule(s.ChapmanAtmosphere,(()=>new Promise(((t,r)=>e(["./ChapmanAtmosphere.glsl"],t,r))))))}initializePipeline(e){return l.makePipelineState({blending:e.reduced?l.copySource:l.simpleBlendingParams(a.BlendFactor.SRC_ALPHA,a.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:{func:e.reduced?a.CompareFunction.ALWAYS:a.CompareFunction.LEQUAL},colorWrite:l.defaultColorWrite})}}t.ChapmanAtmospherePassParameters=c,t.ChapmanAtmosphereTechnique=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/ChapmanApproximation.glsl":function(){define(["exports","../../../core/libs/gl-matrix-2/factories/vec2f64","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../geometry/support/Ellipsoid","../webgl-engine/core/shaderModules/Float2PassUniform","../webgl-engine/core/shaderModules/Float4PassUniform","../webgl-engine/core/shaderModules/glsl","../../webgl/NoParameters"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends a.NoParameters{constructor(){super(...arguments),this.radii=t.create(),this.heightParameters=r.create()}}e.ChapmanApproximation=function(e){e.uniforms.add(new s.Float2PassUniform("radii",(e=>e.radii)),new n.Float4PassUniform("heightParameters",(e=>e.heightParameters))),e.constants.add("scaleHeight","float",i.earth.scaleHeight*i.earth.atmosphereHeight),e.code.add(o.glsl`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),e.code.add(o.glsl`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),e.code.add(o.glsl`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)},e.ChapmanApproximationParameters=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/ChapmanAtmosphere.glsl":function(){define(["exports","../views/3d/environment/ChapmanRaymarching.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl","../views/3d/webgl-engine/shaders/SphereIntersect.glsl","../views/3d/webgl-engine/shaders/ToneMapping.glsl","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e){const h=new d.ShaderBuilder;h.include(l.ScreenSpacePassAtmosphere);const{reduced:p}=e,{fragment:m}=h;return i.addMainLightDirection(m),m.include(r.Gamma),m.include(c.SphereIntersect),m.include(u.ToneMapping),m.include(t.ChapmanRaymarching,!1),m.uniforms.add(new s.Float3PassUniform("backgroundColor",(e=>e.backgroundColor)),new n.FloatPassUniform("innerFadeDistance",(e=>e.innerFadeDistance)),new n.FloatPassUniform("altitudeFade",(e=>e.altitudeFade)),new a.Texture2DBindUniform("depthTexture",(e=>e.mainDepth))).code.add(o.glsl`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`).main.add(o.glsl`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${o.If(!p,o.glsl`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),h}const p=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}));e.ChapmanAtmosphere=p,e.build=h}))},"esri/views/3d/environment/ChapmanRaymarching.glsl":function(){define(["exports","./atmosphereUtils","./ChapmanApproximation.glsl","../webgl-engine/core/shaderModules/Float3BindUniform","../webgl-engine/core/shaderModules/glsl"],(function(e,t,r,i,s){"use strict";e.ChapmanRaymarching=function(e,n){e.include(r.ChapmanApproximation),e.uniforms.add(new i.Float3BindUniform("cameraPosition",(e=>e.camera.eye))),e.constants.add("betaRayleigh","vec3",t.betaRayleigh),e.constants.add("betaCombined","vec3",t.betaCombined),e.constants.add("betaMie","float",t.betaMie),e.code.add(s.glsl`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${s.If(n,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${s.glsl.float(6)};

      for (int i = 0; i < ${s.glsl.int(6)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${s.If(!n,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${s.If(!n,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${n?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":s.glsl`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../core/shaderModules/glsl","../core/shaderModules/Matrix4BindUniform","../lib/VertexAttribute"],(function(e,t,r,i,s,n){"use strict";const o=r.create();e.ScreenSpacePassAtmosphere=function(e,r={needUVs:!0,needEyeDirection:!0}){e.attributes.add(n.VertexAttribute.POSITION,"vec2"),e.varyings.add("worldRay","vec3");const{needUVs:a,needEyeDirection:l}=r;a&&e.varyings.add("uv","vec2"),l&&e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add(new s.Matrix4BindUniform("inverseProjectionMatrix",(e=>e.camera.inverseProjectionMatrix)),new s.Matrix4BindUniform("inverseViewMatrix",(e=>t.invertOrIdentity(o,e.camera.viewMatrix)))),e.vertex.main.add(i.glsl`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${i.If(l,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${i.If(a,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/ChapmanAtmosphereTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.reduced=!1}}t.__decorate([r.parameter()],i.prototype,"reduced",void 0),e.ChapmanAtmosphereTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/AtmosphereCompositing.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o){"use strict";class a extends n.NoParameters{}function l(){const e=new o.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new s.Texture2DPassUniform("colorTexture",(e=>e.color)),new i.Texture2DBindUniform("depthTexture",(e=>e.mainDepth))),e.fragment.main.add(r.glsl`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const c=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:a,build:l},Symbol.toStringTag,{value:"Module"}));e.AtmosphereCompositing=c,e.AtmosphereCompositingPassParameters=a,e.build=l}))},"esri/views/3d/webgl-engine/shaders/AtmosphereCompositingTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../../chunks/AtmosphereCompositing.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.AtmosphereCompositing,(()=>new Promise(((t,r)=>e(["./AtmosphereCompositing.glsl"],t,r))))))}initializePipeline(){return o.makePipelineState({blending:o.simpleBlendingParams(n.BlendFactor.SRC_ALPHA,n.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:{func:n.CompareFunction.ALWAYS},colorWrite:o.defaultColorWrite})}}t.AtmosphereCompositingTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/CloudsComposition":function(){define(["exports","../../../chunks/tslib.es6","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../geometry/ellipsoidUtils","../webgl","./CloudsCompositionTechnique","../webgl-engine/effects/OpaqueEnvironment","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/glUtil3D","../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";e.CloudsComposition=class extends h.OpaqueEnvironment{constructor(e){super(e),this._planetRadius=c.getReferenceEllipsoid(e.view.spatialReference).radius}initialize(){this.techniques.precompile(d.CloudsCompositionTechnique),this.addHandles([i.watch((()=>null!=this.view.environment.weather&&this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),i.initial)])}destroy(){this._vao=r.disposeMaybe(this._vao)}render(e){const t=e.find((({name:e})=>e===u.InternalRenderCategory.OPAQUE_ENVIRONMENT)),r=this.bindParameters.clouds;if(!r.data)return t;const i=this.techniques.get(d.CloudsCompositionTechnique);if(!i.compiled)return this.requestRender(p.RenderRequestType.UPDATE),t;const s=this.renderingContext;this._vao??=m.createQuadVAO(s);const n=s.bindTechnique(i,this.bindParameters);return s.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(f.PrimitiveType.TRIANGLE_STRIP,0,4),r.isFading&&this.requestRender(p.RenderRequestType.UPDATE),t}},e.CloudsComposition=t.__decorate([l.subclass("esri.views.3d.environment.CloudsComposition")],e.CloudsComposition),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/CloudsCompositionTechnique":function(){define(["require","exports","../../../chunks/CloudsComposition.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../../webgl/enums","../../webgl/renderState"],(function(e,t,r,i,s,n,o){"use strict";class a extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.CloudsComposition,(()=>new Promise(((t,r)=>e(["./CloudsComposition.glsl"],t,r))))))}initializePipeline(){return o.makePipelineState({blending:o.separateBlendingParams(n.BlendFactor.ONE,n.BlendFactor.ZERO,n.BlendFactor.SRC_ALPHA,n.BlendFactor.ONE),depthTest:{func:n.CompareFunction.LEQUAL},colorWrite:o.defaultColorWrite})}}t.CloudsCompositionTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/CloudsComposition.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateAmbientLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PiUtils.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/CloudsParallaxShading.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";function p(){const e=new h.ShaderBuilder,{fragment:p}=e;return e.include(d.ScreenSpacePassAtmosphere,{needUVs:!1,needEyeDirection:!1}),p.include(o.ColorConversion),p.include(a.RgbaFloatEncoding),e.include(t.EvaluateAmbientLighting,{pbrMode:i.PBRMode.Disabled,lightingSphericalHarmonicsOrder:2}),p.include(s.PiUtils),p.include(r.Gamma),e.include(n.CloudsParallaxShading),p.uniforms.add(new l.Float3BindUniform("cameraPosition",(e=>e.camera.eye)),new c.FloatBindUniform("cloudsOpacity",(e=>e.clouds.opacity))).main.add(u.glsl`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),e}const m=Object.freeze(Object.defineProperty({__proto__:null,build:p},Symbol.toStringTag,{value:"Module"}));e.CloudsComposition=m,e.build=p}))},"esri/views/3d/environment/Fog":function(){define(["exports","../../../chunks/tslib.es6","../../../core/mathUtils","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../webgl","../../../chunks/Fog.glsl","./FogTechnique","./weather","../webgl-engine/effects/TransparentEnvironment","../webgl-engine/lib/basicInterfaces","../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_){"use strict";e.Fog=class extends g.TransparentEnvironment{constructor(e){super(e),this.requireGeometryDepth=!0,this._newParameters=new b,this._oldParameters=new b,this._fadedParameters=new b,this._parameters=this._newParameters,this._passParameters=new p.FogPassParameters;const t=d.getReferenceEllipsoid(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view.stage?.renderView.techniques.precompile(m.FogTechnique)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([i.watch((()=>this.view.environment.atmosphereEnabled),(()=>this.toogle()),i.syncAndInitial),i.watch((()=>this.view.environment.weather),(()=>this.toogle()),i.syncAndInitial),i.watch((()=>this._updateFogParameters()),(()=>{}),i.syncAndInitial)]),this.addHandles(i.watch((()=>this._fadeFactor),(e=>this._fade(e)),i.syncAndInitial))}get _fadeFactor(){return this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(e){const{_newParameters:t,_oldParameters:r}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=r:(this._fadedParameters.lerp(r,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t="foggy"===e.type||"snowy"===e.type||"rainy"===e.type;this._newParameters.strength="foggy"===e.type?r.lerp(3e-5,.005,e.fogStrength**3):"snowy"===e.type||"rainy"===e.type?r.lerp(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,"foggy"!==e.type&&"snowy"!==e.type||c.copy(this._newParameters.color,x),"rainy"===e.type&&c.copy(this._newParameters.color,w),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(y.RenderRequestType.UPDATE)}render(e){const t=e.find((({name:e})=>e===h.InternalRenderCategory.TRANSPARENT_ENVIRONMENT));if(0===this._parameters.amount)return t;if(this._update(),this._passParameters.amount<=0)return t;const r=this.techniques.get(m.FogTechnique);if(!r.compiled)return this.requestRender(y.RenderRequestType.UPDATE),t;const i=this.renderingContext,s=t.getAttachment(_.DepthStencilAttachment);return t.attachDepth(null),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),i.screen.draw(),t.attachDepth(s),t}_update(){const e=this.bindParameters.camera;c.normalize(v,e.eye);const t=Math.max(0,c.dot(v,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;c.scale(S,i,.1),c.lerp(this._passParameters.color,S,i,t);const s=c.length(e.eye);this._passParameters.atmosphereC=s**2-this._atmosphereRadius**2,this._passParameters.amount=(1-r.smoothstep(.95*f.heightLimit,1*f.heightLimit,Math.abs(s-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}},e.Fog=t.__decorate([l.subclass("esri.views.3d.environment.Fog")],e.Fog);class b{constructor(){this.color=u.create(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,c.copy(this.color,e.color)}lerp(e,t,i){this.amount=r.lerp(e.amount,t.amount,i),this.strength=r.lerp(e.strength,t.strength,i),c.lerp(this.color,e.color,t.color,i)}}const v=u.create(),S=u.create(),w=u.fromValues(.5,.5,.5),x=u.fromValues(1.5,1.5,1.5);e.FogParameters=b,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Fog.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl","../views/3d/webgl-engine/shaders/SphereIntersect.glsl","../views/3d/webgl-engine/shaders/ToneMapping.glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";class m extends h.NoParameters{constructor(){super(...arguments),this.color=t.create(),this.strength=4e-6,this.atmosphereC=1,this.amount=0}}function f(){const e=new p.ShaderBuilder;e.include(c.ScreenSpacePassAtmosphere,{needUVs:!0,needEyeDirection:!0});const t=e.fragment;return t.uniforms.add(new o.FloatPassUniform("atmosphereC",(e=>e.atmosphereC)),new s.Float3BindUniform("cameraPosition",(e=>e.camera.eye)),new l.Texture2DBindUniform("depthTexture",(e=>e.mainDepth)),new o.FloatPassUniform("fogStrength",(e=>e.strength)),new o.FloatPassUniform("fogAmount",(e=>e.amount)),new n.Float3PassUniform("fogColor",(e=>e.color))),t.include(i.Gamma),t.include(u.SphereIntersect),t.include(d.ToneMapping),t.include(r.ReadDepth),t.code.add(a.glsl`float getFogAmount(float dist, vec3 rayDir) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return fogAmount * (1.0 - exp(-dist * fogStrength));
}`),t.main.add(a.glsl`vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = depthFromTexture(depthTexture, uv);
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linearizeDepth(depthSample);;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
float fogAmount = getFogAmount(terrainDepth, rayDir);
vec4 fog = vec4(fogColor, 1.0) * fogAmount;
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),e}const g=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:m,build:f},Symbol.toStringTag,{value:"Module"}));e.Fog=g,e.FogPassParameters=m,e.build=f}))},"esri/views/3d/environment/FogTechnique":function(){define(["require","exports","../../../chunks/Fog.glsl","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../../webgl/enums","../../webgl/renderState"],(function(e,t,r,i,s,n,o){"use strict";class a extends s.ShaderTechnique{constructor(t,s){super(t,s,new i.ReloadableShaderModule(r.Fog,(()=>new Promise(((t,r)=>e(["./Fog.glsl"],t,r))))))}initializePipeline(){return o.makePipelineState({blending:o.separateBlendingParams(n.BlendFactor.SRC_ALPHA,n.BlendFactor.ZERO,n.BlendFactor.ONE_MINUS_SRC_ALPHA,n.BlendFactor.ONE),colorWrite:o.defaultColorWrite})}}t.FogTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/LocalAtmosphere":function(){define(["exports","../../../chunks/tslib.es6","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../webgl","../../../chunks/SimpleAtmosphere.glsl","./SimpleAtmosphereTechnique","./SimpleAtmosphereTechniqueConfiguration","./resources/SimpleAtmosphereTexture","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/effects/OpaqueEnvironment","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/GeometryUtil","../webgl-engine/lib/VertexArrayObject","../webgl-engine/lib/VertexAttribute","../../webgl/BufferObject","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor","../../webgl/Util"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R){"use strict";e.LocalAtmosphere=class extends _.OpaqueEnvironment{constructor(){super(...arguments),this._configuration=new m.SimpleAtmosphereTechniqueConfiguration,this._passParameters=new h.SimpleAtmospherePassParameters,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=m.SimpleAtmosphereGeometry.Cylinder,this.addHandles([i.watch((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),i.initial)])}destroy(){this._passParameters.texture=r.disposeMaybe(this._passParameters.texture),this._vao=r.disposeMaybe(this._vao)}precompile(){this.techniques.precompile(p.SimpleAtmosphereTechnique,this._configuration)}render(e){const t=e.find((({name:e})=>e===d.InternalRenderCategory.OPAQUE_ENVIRONMENT)),r=this.techniques.get(p.SimpleAtmosphereTechnique,this._configuration);if(!r.compiled)return this.requestRender(b.RenderRequestType.UPDATE),t;const i=this.renderingContext;if(this._vao||(this._vao=function(e){const t=S.createPolySphereData(1,2,!1),{data:r,indices:i}=t[0][1],s=O.createBuffer(i.length),n=s.position;for(let e=0;e<i.length;++e){const t=3*i[e%3==0?e+2:e%3==2?e-2:e];n.set(e,0,r[t]),n.set(e,1,r[t+1]),n.set(e,2,r[t+2])}return new w.VertexArrayObject(e,v.Default3D,new Map([["geometry",g.glLayout(O)]]),new Map([["geometry",T.BufferObject.createVertex(e,C.Usage.STATIC_DRAW,s.buffer)]]))}(i),this._vaoCount=R.vertexCount(this._vao,"geometry")),!this._passParameters.texture){const e=new M.TextureDescriptor;e.wrapMode=C.TextureWrapMode.CLAMP_TO_EDGE,e.flipped=!0,e.width=1,e.height=512,this._passParameters.texture=new P.Texture(i,e,f.earthAtmosphereTextureSimple)}const s=i.bindTechnique(r,this.bindParameters,this._passParameters);var n,o;return n=E,o=this.bindParameters.camera.viewMatrix,c.copy(n,o),n[12]=0,n[13]=0,n[14]=0,n[15]=1,s.setUniformMatrix4fv("view",E),i.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(C.PrimitiveType.TRIANGLES,0,this._vaoCount),t}},e.LocalAtmosphere=t.__decorate([l.subclass("esri.views.3d.environment.LocalAtmosphere")],e.LocalAtmosphere);const E=u.create(),O=y.newLayout().vec3f(x.VertexAttribute.POSITION);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/SimpleAtmosphere.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec2f64","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/environment/SimpleAtmosphereTechniqueConfiguration","../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/Float3PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/lib/VertexAttribute","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";class g extends m.NoParameters{constructor(){super(...arguments),this.texV=t.create(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new y}}class y{constructor(){this.center=r.create(),this.v1=r.create(),this.v2=r.create()}}function _(e){const t=new f.ShaderBuilder,{vertex:r,fragment:m}=t;if(n.addMainLightDirection(r),e.geometry===i.SimpleAtmosphereGeometry.Underground)t.attributes.add(p.VertexAttribute.POSITION,"vec2"),t.varyings.add("color","vec4"),r.uniforms.add(new a.Float3BindUniform("cameraPosition",(e=>e.camera.eye)),new c.FloatPassUniform("undergroundFadeAlpha",(e=>e.undergroundFadeAlpha))),r.main.add(u.glsl`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),m.main.add(u.glsl`fragColor = color;`);else{t.include(s.Transform,e),t.attributes.add(p.VertexAttribute.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const n=e.geometry===i.SimpleAtmosphereGeometry.Cylinder;r.uniforms.add(new d.Matrix4BindUniform("proj",(e=>e.camera.projectionMatrix)),new d.Matrix4BindUniform("view",(e=>e.camera.viewMatrix))),n||(t.varyings.add("innerFactor","float"),r.uniforms.add(new l.Float3PassUniform("silCircleCenter",(e=>e.silhouette.center))),r.uniforms.add(new l.Float3PassUniform("silCircleV1",(e=>e.silhouette.v1))),r.uniforms.add(new l.Float3PassUniform("silCircleV2",(e=>e.silhouette.v2))),r.uniforms.add(new o.Float2PassUniform("texV",(e=>e.texV))),r.uniforms.add(new c.FloatPassUniform("innerScale",(e=>e.innerScale))));const a=6.2831853,f=1/128;r.main.add(u.glsl`
      ${n?u.glsl`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:u.glsl`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${u.glsl.float(a*f)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${u.glsl.float(f)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),m.uniforms.add(new h.Texture2DPassUniform("tex",(e=>e.texture))),n||m.uniforms.add(new c.FloatPassUniform("altitudeFade",(e=>e.altitudeFade))),m.main.add(u.glsl`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${n?u.glsl`fragColor = atmosphereColor;`:u.glsl`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return t}const b=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:y,SimpleAtmospherePassParameters:g,build:_},Symbol.toStringTag,{value:"Module"}));e.SilhouetteCircle=y,e.SimpleAtmosphere=b,e.SimpleAtmospherePassParameters=g,e.build=_}))},"esri/views/3d/environment/SimpleAtmosphereTechniqueConfiguration":function(){define(["exports","../../../chunks/tslib.es6","../webgl-engine/core/shaderTechnique/ShaderTechniqueConfiguration","../webgl-engine/materials/DefaultTechniqueConfiguration"],(function(e,t,r,i){"use strict";var s;e.SimpleAtmosphereGeometry=void 0,(s=e.SimpleAtmosphereGeometry||(e.SimpleAtmosphereGeometry={}))[s.Cone=0]="Cone",s[s.Cylinder=1]="Cylinder",s[s.Underground=2]="Underground",s[s.COUNT=3]="COUNT";class n extends i.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.geometry=e.SimpleAtmosphereGeometry.Cone}}t.__decorate([r.parameter({count:e.SimpleAtmosphereGeometry.COUNT})],n.prototype,"geometry",void 0),e.SimpleAtmosphereTechniqueConfiguration=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/SimpleAtmosphereTechnique":function(){define(["require","exports","../../../chunks/SimpleAtmosphere.glsl","./SimpleAtmosphereTechniqueConfiguration","../webgl-engine/core/shaderTechnique/ReloadableShaderModule","../webgl-engine/core/shaderTechnique/ShaderTechnique","../../webgl/enums","../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends n.ShaderTechnique{constructor(t,i){super(t,i,new s.ReloadableShaderModule(r.SimpleAtmosphere,(()=>new Promise(((t,r)=>e(["./SimpleAtmosphere.glsl"],t,r))))))}initializePipeline(e){const t=e.geometry===i.SimpleAtmosphereGeometry.Cylinder;return a.makePipelineState({blending:a.unpremultipliedAlphaToPremultipliedAlpha,culling:t?a.backFaceCullingParams:void 0,depthTest:{func:o.CompareFunction.LEQUAL},colorWrite:a.defaultColorWrite})}}t.SimpleAtmosphereTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/resources/SimpleAtmosphereTexture":function(){define(["exports"],(function(e){"use strict";const t=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);e.earthAtmosphereTextureSimple=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/environment/MarsAtmosphere":function(){define(["../../../chunks/tslib.es6","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/Logger","../../../core/has","../../../core/RandomLCG","../../../core/Error","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/math/vec2","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/support/FloatArray","../webgl","./atmosphereUtils","../../../chunks/SimpleAtmosphere.glsl","./SimpleAtmosphereTechnique","./SimpleAtmosphereTechniqueConfiguration","./resources/MarsAtmosphereTexture","../support/mathUtils","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/effects/OpaqueEnvironment","../webgl-engine/lib/basicInterfaces","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/Util","../webgl-engine/lib/VertexArrayObject","../webgl-engine/lib/VertexAttribute","../../webgl/BufferObject","../../webgl/enums","../../webgl/Texture","../../webgl/TextureDescriptor","../../webgl/Util"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N){"use strict";const U=-1e4,V=w.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let B=class extends C.OpaqueEnvironment{constructor(e){super(e),this._passParameters=new _.SimpleAtmospherePassParameters,this._configuration=new v.SimpleAtmosphereTechniqueConfiguration,this._vao=null,this._vaoCount=0,this._fadeVao=null,this._fadeVaoCount=0,this._texV1=1;const t=e.view,r=m.getReferenceEllipsoid(t.spatialReference),{outerAtmosphereRimWidth:i,radius:s}=r;this._planetRadius=s,this._innerRimFactor=1+U/s,this._middleRimFactor=1+0/s,this._outerRimFactor=1+i/s,this._texV0=0/i,this._texVScale=this._texV1-this._texV0;const n=t.stage.renderView.techniques;n.precompile(b.SimpleAtmosphereTechnique,this._configuration),this._configuration.geometry=v.SimpleAtmosphereGeometry.Underground,n.precompile(b.SimpleAtmosphereTechnique,this._configuration)}initialize(){this.addHandles(i.watch((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),i.initial))}destroy(){this._passParameters.texture=r.disposeMaybe(this._passParameters.texture),this._fadeVao=r.disposeMaybe(this._fadeVao),this._vao=r.disposeMaybe(this._vao)}render(e){const t=e.find((({name:e})=>e===g.InternalRenderCategory.OPAQUE_ENVIRONMENT));this._update();const r=this.renderingContext;if(!this._passParameters.texture){const e=new L.TextureDescriptor;e.wrapMode=D.TextureWrapMode.CLAMP_TO_EDGE,e.flipped=!0,e.width=1,e.height=512,this._passParameters.texture=new F.Texture(r,e,S.marsAtmosphereTextureSimple)}if(this._passParameters.undergroundFadeAlpha<1){this._vao||(this._vao=this._createRibbon(r),this._vaoCount=N.vertexCount(this._vao,"geometry")),this._configuration.geometry=v.SimpleAtmosphereGeometry.Cone;const e=this.techniques.get(b.SimpleAtmosphereTechnique,this._configuration);if(!e.compiled)return this.requestRender(P.RenderRequestType.UPDATE),t;r.bindTechnique(e,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(D.PrimitiveType.TRIANGLES,0,this._vaoCount)}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao||(this._fadeVao=R.createQuadVAO(r),this._fadeVaoCount=N.vertexCount(this._fadeVao,"geometry")),this._configuration.geometry=v.SimpleAtmosphereGeometry.Underground;const e=this.techniques.get(b.SimpleAtmosphereTechnique,this._configuration);if(!e.compiled)return this.requestRender(P.RenderRequestType.UPDATE),t;r.bindTechnique(e,this.bindParameters,this._passParameters),r.bindVAO(this._fadeVao),r.drawArrays(D.PrimitiveType.TRIANGLE_STRIP,0,this._fadeVaoCount)}return t}_update(){const e=this.bindParameters.camera,r=p.create(),i=this._planetRadius,s=h.length(e.eye),n=s-i;if(n<0){const e=Math.min(-n/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const o=Math.max(50,n),a=i+U;var l,c,u;this._passParameters.innerScale=(c=i,u=a,(l=i+o)*l/(Math.sqrt(l*l-c*c)*Math.sqrt(l*l-u*u)+c*u)-1),this._passParameters.altitudeFade=y.computeInnerAltitudeFade(n),h.scale(r,e.eye,(i+50)/s),G(r,e.center,e.up,i,this._passParameters.silhouette);const m=this._computeScreenRimWidth(e,r,e.up,this._passParameters.silhouette),f=1-511/512,g=V(n);let _=this._texV0+f*this._texVScale,b=this._texV0+m*g*this._texVScale;if(n>50){G(e.eye,e.center,e.up,i,this._passParameters.silhouette);const r=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),s=t.clamp((r-1.5)/(m-1.5),0,1);_=this._texV0+s*f*this._texVScale,b=this._texV0+t.lerp(this._texV1,m*g,s)*this._texVScale}d.set(this._passParameters.texV,_,b)}_createRibbon(e){const t=f.newFloatArray(1155),r=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<128;e++){const i=9*e+3;t[i]=e,t[i+1]=this._innerRimFactor,t[i+2]=-1,t[i+3]=e,t[i+4]=this._middleRimFactor,t[i+5]=0,t[i+6]=e,t[i+7]=this._outerRimFactor,t[i+8]=1;const s=3*e+1,n=127===e?1:s+3,o=15*e;r[o]=s,r[o+1]=s+1,r[o+2]=n+1,r[o+3]=n+1,r[o+4]=n,r[o+5]=s,r[o+6]=s+1,r[o+7]=s+2,r[o+8]=n+2,r[o+9]=n+2,r[o+10]=n+1,r[o+11]=s+1,r[o+12]=s,r[o+13]=n,r[o+14]=0}const i=q.createBuffer(r.length),s=i.position;for(let e=0;e<r.length;++e){const i=3*r[e];s.set(e,0,t[i]),s.set(e,1,t[i+1]),s.set(e,2,t[i+2])}return new O.VertexArrayObject(e,M.Default3D,new Map([["geometry",x.glLayout(q)]]),new Map([["geometry",I.BufferObject.createVertex(e,D.Usage.STATIC_DRAW,i.buffer)]]))}_computeScreenRimWidth(e,t,r,i){return h.add(z,i.center,i.v2),h.scale(j,z,this._outerRimFactor),c.lookAt(k,t,z,r),E.project(z,k,e.projectionMatrix,e.viewport,z),E.project(j,k,e.projectionMatrix,e.viewport,j),h.distance(z,j)/e.height}};function G(e,t,r,i,s){const n=h.length(e),o=i*Math.sqrt(n*n-i*i)/n,a=Math.sqrt(i*i-o*o),l=s.v1,c=s.v2;return h.scale(s.center,e,a/n),h.cross(l,e,t),h.squaredLength(l)<1&&h.cross(l,e,r),h.scale(l,l,o/h.length(l)),h.cross(c,l,e),h.scale(c,c,o/h.length(c)),o}B=e.__decorate([l.subclass("esri.views.3d.environment.MarsAtmosphere")],B);const k=u.create(),z=p.create(),j=p.create(),q=T.newLayout().vec3f(A.VertexAttribute.POSITION);return B}))},"esri/views/3d/environment/resources/MarsAtmosphereTexture":function(){define(["exports"],(function(e){"use strict";const t=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]);e.marsAtmosphereTextureSimple=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/ComponentObjectCollection":function(){define(["require","exports","../../../../../core/Logger","../../../../../core/MapUtils","../../../../../core/PooledArray","../../../../../core/typedArrayUtil","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/Indices","../../../../../chunks/vec3","../../../../../chunks/vec33","../../../../ViewingMode","../../../layers/support/symbolColorUtils","../../../support/orientedBoundingBox","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","./ComponentData","./ComponentObject","./IntersectionGeometry","./Renderable","./RenderGeometry","./RenderSubmitSystem","./SourceGeometry","./UniformComponentParameters","./Material/ComponentMaterial","./Material/ComponentTechnique","./Material/shader/ComponentData.glsl","../../effects/geometry/olidUtils","../../lib/ComponentUtils","../../lib/Util","../../lib/VertexAttribute","../../lib/verticalOffsetUtils","../../lib/TextureBackedBuffer/BufferManager","../../../../webgl/BufferObject","../../../../webgl/enums","../../../../webgl/VertexArrayObject"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N){"use strict";const U=()=>r.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection"),V=f.glLayout(g.newLayout().u16(A.VertexAttribute.COMPONENTINDEX));function B(e,t){return e===t?C.ComponentParameterSummary.All:0===e?C.ComponentParameterSummary.None:C.ComponentParameterSummary.Some}const G=l.create();t.ComponentObjectCollection=class{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new s,this._hidden=new s,this._renderSubmit=new w.RenderSubmitSystem(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new D.BufferManager(e.rctx,2+(R.olidEnabled()?1:0))}destroy(){O.assert(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll((e=>e.destroy())),this._visible.clear(),this._hidden.forAll((e=>e.destroy())),this._hidden.clear()}createObject(e){const t=e.geometry,r=new y.ComponentData(this._componentBufferManager,c.compactIndices(t.componentOffsets)),i=this._createRenderable(e,r),s=new b.IntersectionGeometry(this._viewingMode,t.positionData,r),n=new _.ComponentObject(e.transform,e.toMapSpace,e.obb.clone(),r,i,s);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const r=e;t!==r.visible&&(t?(this._hidden.removeUnordered(r),this._visible.push(r)):(this._visible.removeUnordered(r),this._hidden.push(r)),r.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=o.squaredDistance(t,e.obb.center)))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const r=e.renderable.material;t(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const r=e;r.componentData.visibility.reset(t),r.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.componentData.visibility.forEachComponent(t)}getComponentCount(e){const t=e,r=t.componentData.visibility.componentCount;return{visible:r,invisible:t.componentData.count-r}}setComponentData(e,t){const r=e,{renderable:i,componentData:s}=r,n=i.material,o=s.materialDataBuffer,a=s.materialDataIndices,l=new T.UniformComponentParameters,c=o.textureBuffer,u=new Uint8Array(4),d=new Uint32Array(u.buffer);let h=0,f=0,g=0,y=s.verticalOffsets,_=1/0,b=-1/0,v=!1,S=!1,w=0;for(let e=0;e<s.count;e++){t(e,l),h+=+(l.externalColor[3]<1),f+=+(l.externalColorMixMode===p.ColorMixModeEnum.Replace&&1===l.externalColor[3]),g+=+l.castShadows,p.encodeSymbolColor(l.externalColor,l.externalColorMixMode,u),u[2]=254&u[2]|+l.castShadows,c.setData(a[e],0,u[0],u[1],u[2],u[3]),v||=e>0&&w!==d[0],w=d[0],S||=0!==l.elevationOffset,S&&null==y&&(y=new Array(e).fill(0)),null!=y&&(y[e]=l.elevationOffset),_=Math.min(_,l.elevationOffset),b=Math.max(b,l.elevationOffset),M.encodeElevationOffset(l.elevationOffset,u),c.setData(a[e],1,u[0],u[1],u[2],u[3]);const r=l.objectAndLayerIdColor;null!=r&&c.setData(a[e],2,r[0],r[1],r[2],r[3]),l.pickable!==E.getVisibility(s.pickability,e)&&E.updatePickabilityWithCount(s,e,l.pickable)}s.verticalOffsets=S?y:null,r.offsetObb=S?m.computeOffsetObb(r.obb,_,b,this._viewingMode,r.offsetObb??r.obb.clone()):null,v||S||R.olidEnabled()?(n.componentParameters=new C.ComponentParametersVarying,n.componentParameters.castShadows=B(g,s.count),n.componentParameters.transparent=B(h,s.count),n.componentParameters.opaqueOverride=B(f,s.count),n.componentParameters.texture=c,c.updateTexture()):(n.componentParameters=new C.ComponentParametersUniform,n.componentParameters.castShadows=l.castShadows?C.ComponentParameterSummary.All:C.ComponentParameterSummary.None,n.componentParameters.externalColor=l.externalColor,n.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,r,i=!1){e.intersectionGeometry.getComponentAabb(t,r);const s=e,n=s.componentData.verticalOffsets;if(i||null==n)return r;const o=n[t];if(this._viewingMode===h.ViewingMode.Local||0===o)return r[2]+=o,r[5]+=o,r;const a=I.getVerticalOffsetI3S(o);return a.localOrigin=s.transform.position,a.applyToAabb(r)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,r){return e.intersectionGeometry.getComponentPositions(t,r)}expandRangeWithComponentObjectElevationRange(e,t,r,i){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||i.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const s=e,n=s.componentData,o=n.count,a=n.verticalOffsets,l=s.intersectionGeometry,c=this._viewingMode===h.ViewingMode.Local,u=l.getComponentAabbs(),d=G;let p=1/0,m=-1/0;for(let e=0;e<o;e++){const n=6*e,o=a?.[e]??0;let l=1/0,h=-1/0;if(c)l=u[n+2]+o+t,h=u[n+5]+o+t;else{if(d[0]=u[n],d[1]=u[n+1],d[2]=u[n+2],d[3]=u[n+3],d[4]=u[n+4],d[5]=u[n+5],0!==o){const e=I.getVerticalOffsetI3S(o);e.localOrigin=s.transform.position,e.applyToAabb(d)}const e=Math.max(Math.abs(d[3]),Math.abs(d[0])),a=Math.max(Math.abs(d[4]),Math.abs(d[1])),l=t+d[5]+r;i.expandElevationRangeValues(t+d[2],Math.sqrt(e*e+a*a+l*l)-r)}i.expandElevationRangeValues(l,h),p=Math.min(p,l),m=Math.max(m,h)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=p,this._elevationRangeCacheMax=m}intersect(e,t,r,i,s,n,o){const a=e,{transform:l,componentData:c,intersectionGeometry:u}=a;return null!=s&&(s.localOrigin=l.position),u.intersect(t,r,i,s,c.verticalOffsets,l,n,o)}addEdges(e,t,r,i,s){const n=e,{indices:o,positions:a}=n.intersectionGeometry,l=n.componentData.offsets;return t.addComponentObject(n,a,o,l,r,i,s)}async extractEdgeInformation(t,r,i){const s=t,n=s.componentData.visibility;if(n.allInvisible()){const{extractComponentsEdgeLocationsLayout:t}=await new Promise(((t,r)=>e(["../../lib/edgeRendering/edgeProcessing"],t,r)));return{buffer:t.createBuffer(0),origin:[0,0,0]}}const{indices:o,positions:l}=s.intersectionGeometry,c=s.componentData.offsets,{EdgeInputBufferLayout:h}=await new Promise(((t,r)=>e(["../../lib/edgeRendering/bufferLayouts"],t,r))),p=h.createBuffer(l.length/3);d.copy(p.position.typedBuffer,l,p.position.typedBufferStride,3),u.transformMat3View(p.position,p.position,s.transform.rotationScale),this._setComponentIndices(p.componentIndex,o,c);const m=p.count,f=this._computeVisibilityIndices(o,n,c,m);return{origin:a.clone(s.transform.position),buffer:await r.extractComponentsEdgeLocations({indices:f,indicesLength:f.length,skipDeduplicate:!0,data:p,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,r){let i=0;for(let s=0;s<r.length-1;s++){const n=r[s],o=r[s+1];for(let r=n;r<o;r++){const s=t?t[r]:r;e.set(s,i)}i++}}_computeVisibilityIndices(e,t,r,i){if(e&&t.allVisible())return e;let s=0;t.forEachComponentRange(((e,t)=>(s+=r[t]-r[e],!0)));const o=n.isTypedArray(e)?2===e?.BYTES_PER_ELEMENT||i<=65536?new Uint16Array(s):new Uint32Array(s):new Array(s);let a=0;return t.forEachComponentRange(((t,i)=>{const s=r[t],n=r[i];for(let t=s;t<n;t++)o[a++]=e?e[t]:t;return!0})),o}addComponentHighlight(e,t,r){const s=e.componentData,n=i.getOrCreateMapValue(s.componentHighlights,r,(()=>new Uint32Array(s.count+1)));{const e=this._activeHighlightOptions.get(r)??0;this._activeHighlightOptions.set(r,e+1)}0===n[t]++&&(s.markHighlightsDirty(),this._notifyDirty()),n[s.count]++}removeComponentHighlight(e,t,r){const{componentData:i}=e,s=i.componentHighlights.get(r);if(void 0===s)return void U().warn("Removing non-existing highlight.");const n=s[t];if(0===n)return void U().warn("Removing non-existing highlight.");this._removeActiveHighlight(r);const o=s[i.count];if(n>1)return s[t]=n-1,void(s[i.count]=o-1);s[t]=0,1===o?i.componentHighlights.delete(r):s[i.count]=o-1,i.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e,t=1){const r=this._activeHighlightOptions.get(e);if(void 0===r)U().warn("Removing non-existing highlight.");else{const i=r-t;i<0&&U().warn("Removing non-existing highlight."),i<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,i)}}clearHighlights(e){const{componentData:t}=e,{componentHighlights:r}=t;if(r.size>0){for(const e of r)this._removeActiveHighlight(e[0],e[1][t.count]);r.clear(),t.markHighlightsDirty(),this._notifyDirty()}}hasHighlight(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const r=this._renderManager.rctx,i=e.geometry,s=i.vertices.layoutParameters,n=F.BufferObject.createVertex(r,L.Usage.STATIC_DRAW,i.vertices.data),o=i.indices?F.BufferObject.createIndex(r,L.Usage.STATIC_DRAW,i.indices):null,a=f.glLayout(x.createVertexBufferLayout(s)),l=new Uint16Array(i.vertices.count);for(let e=0;e<t.count;e++){const r=t.offsets[e],s=t.offsets[e+1],n=t.materialDataIndices[e];if(null!=i.indices)for(let e=r;e<s;e++)l[i.indices[e]]=n;else for(let e=r;e<s;e++)l[e]=n}const c=F.BufferObject.createVertex(r,L.Usage.STATIC_DRAW,l.buffer),u=new C.ComponentMaterial(e.transform,e.toMapSpace),d=new N.VertexArrayObject(r,P.vertexAttributeLocations,new Map([["data",a],["componentIndices",V]]),new Map([["data",n],["componentIndices",c]]),o),h=new S.RenderGeometry(d,L.PrimitiveType.TRIANGLES,s,null!=o),p={cameraDepthSquared:.5,gpuMemoryEstimate:n.usedMemory+c.usedMemory+(null!=o?o.usedMemory:0)};return new v.Renderable(u,h,p)}_notifyDirty(){this._renderManager.notifyDirty()}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/vec3":function(){define(["exports","../colorUtils","../core/has","../core/Logger"],(function(e,t,r,i){"use strict";function s(e,t,r){n(e.typedBuffer,t.typedBuffer,r,e.typedBufferStride,t.typedBufferStride)}function n(e,t,r,i=3,s=i){if(e.length/i!==Math.ceil(t.length/s))return e;const n=e.length/i,o=r[0],a=r[1],l=r[2],c=r[4],u=r[5],d=r[6],h=r[8],p=r[9],m=r[10],f=r[12],g=r[13],y=r[14];let _=0,b=0;for(let r=0;r<n;r++){const r=t[_],n=t[_+1],v=t[_+2];e[b]=o*r+c*n+h*v+f,e[b+1]=a*r+u*n+p*v+g,e[b+2]=l*r+d*n+m*v+y,_+=s,b+=i}return e}function o(e,t,r){a(e.typedBuffer,t.typedBuffer,r,e.typedBufferStride,t.typedBufferStride)}function a(e,t,r,i=3,s=i){if(e.length/i!==Math.ceil(t.length/s))return;const n=e.length/i,o=r[0],a=r[1],l=r[2],c=r[3],u=r[4],d=r[5],h=r[6],p=r[7],m=r[8];let f=0,g=0;for(let r=0;r<n;r++){const r=t[f],n=t[f+1],y=t[f+2];e[g]=o*r+c*n+h*y,e[g+1]=a*r+u*n+p*y,e[g+2]=l*r+d*n+m*y,f+=s,g+=i}}function l(e,t,r){c(e.typedBuffer,t.typedBuffer,r,e.typedBufferStride,t.typedBufferStride)}function c(e,t,r,i=3,s=i){const n=Math.min(e.length/i,t.length/s);let o=0,a=0;for(let l=0;l<n;l++)e[a]=r*t[o],e[a+1]=r*t[o+1],e[a+2]=r*t[o+2],o+=s,a+=i;return e}function u(e,t,r,i){d(e.typedBuffer,t.typedBuffer,r,i,e.typedBufferStride,t.typedBufferStride)}function d(e,r,i,s,n=3,o=n){const a=Math.min(e.length/n,r.length/o);let l=0,c=0;const u=1/t.colorGamma;for(let t=0;t<a;t++)e[c]=s*(i*r[l])**u,e[c+1]=s*(i*r[l+1])**u,e[c+2]=s*(i*r[l+2])**u,l+=o,c+=n}function h(e,t,r,i=3,s=i){const n=e.length/i;if(n!==Math.ceil(t.length/s))return e;let o=0,a=0;for(let l=0;l<n;l++)e[a]=t[o]+r[0],e[a+1]=t[o+1]+r[1],e[a+2]=t[o+2]+r[2],o+=s,a+=i;return e}function p(e,t){m(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)}function m(e,t,r=3,i=r){const s=Math.min(e.length/r,t.length/i);let n=0,o=0;for(let a=0;a<s;a++){const s=t[n],a=t[n+1],l=t[n+2],c=s*s+a*a+l*l;if(c>0){const t=1/Math.sqrt(c);e[o]=t*s,e[o+1]=t*a,e[o+2]=t*l}n+=i,o+=r}}function f(e,t,r){const i=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;let l=0,c=0;for(let e=0;e<i;e++)s[c]=o[l]>>r,s[c+1]=o[l+1]>>r,s[c+2]=o[l+2]>>r,l+=a,c+=n}const g=Object.freeze(Object.defineProperty({__proto__:null,linearToSRGB:d,linearToSRGBView:u,normalize:m,normalizeView:p,scale:c,scaleView:l,shiftRight:f,transformMat3:a,transformMat3View:o,transformMat4:n,transformMat4View:s,translate:h},Symbol.toStringTag,{value:"Module"}));e.linearToSRGB=d,e.linearToSRGBView=u,e.normalize=m,e.normalizeView=p,e.scale=c,e.scaleView=l,e.shiftRight=f,e.transformMat3=a,e.transformMat3View=o,e.transformMat4=n,e.transformMat4View=s,e.translate=h,e.vec3=g}))},"esri/chunks/vec33":function(){define(["exports"],(function(e){"use strict";function t(e,t){r(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)}function r(e,t,r=3,i=r){const s=t.length/i;let n=0,o=0;for(let a=0;a<s;++a)e[n]=t[o],e[n+1]=t[o+1],e[n+2]=t[o+2],n+=r,o+=i}function i(e,t,r,i,s){const n=e.typedBuffer,o=e.typedBufferStride,a=s?.count??e.count;let l=(s?.dstIndex??0)*o;for(let e=0;e<a;++e)n[l]=t,n[l+1]=r,n[l+2]=i,l+=o}const s=Object.freeze(Object.defineProperty({__proto__:null,copy:r,copyView:t,fill:i},Symbol.toStringTag,{value:"Module"}));e.copy=r,e.copyView=t,e.fill=i,e.vec3=s}))},"esri/views/3d/webgl-engine/collections/Component/ComponentData":function(){define(["exports","../../../../../core/MapUtils","./IndexRange/ComponentRange","../../../../support/HighlightDefaults"],(function(e,t,r,i){"use strict";e.ComponentData=class{constructor(e,t){this.offsets=t,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this._cachedGeometryRanges=null,this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null;const i=this.count;this.visibility=new r.ComponentRange(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return null==this._cachedGeometryRanges&&(this._cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this._cachedGeometryRanges}get highlightRangesMap(){return 0===this.componentHighlights.size?null:(this._updateCachedHighlightRanges(),this._cachedHighlightRangesMap)}get shadowmapRanges(){return 0===this.componentHighlights.size?this.geometryRanges:(this._updateCachedHighlightRanges(),this._cachedShadowmapRanges)}markHighlightsDirty(){this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null}markVisibilityDirty(){this._cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){const{_highlightsInOrder:t}=this;let r=t.length!==e.length;t.length=Math.min(e.length,8);for(let i=0;i<e.length;++i){const s=e.at(i).name;t.length<i?(r=!0,t.push(s)):t[i]!==s&&(t[i]=s,r=!0)}return r}_updateCachedHighlightRanges(){if(null==this._cachedHighlightRangesMap||null==this._cachedShadowmapRanges){const{highlightRangesMap:e,shadowmapRangesMap:r}=function(e,r,s,n){const o=new Map,a=[];if(e.size>0){let l=s.length;r.forEachComponent((r=>{let c=!1;for(let a=n.length-1;a>=0;--a){const l=n[a],u=e.get(l);if((u?.[r]??0)>0){const e=t.getOrCreateMapValue(o,l,(()=>[])),n=s[r],a=s[r+1];e.push(n),e.push(a-n),c||=l===i.defaultHighlightName;break}}return c||(l!==r-1&&(a.length>0&&a.push(s[l+1]-a[a.length-1]),a.push(s[r])),l=r),!0})),a.length>0&&a.push(s[l+1]-a[a.length-1])}return{highlightRangesMap:o,shadowmapRangesMap:a}}(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this._cachedHighlightRangesMap=e,this._cachedShadowmapRanges=r}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/IndexRange/ComponentRange":function(){define(["exports"],(function(e){"use strict";e.ComponentRange=class{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return 0===this._indexRanges.length}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;const t=this._indexRanges;let r=0,i=t.length/2;if(e<t[2*r]||e>t[2*i]+t[2*i+1])return!1;for(;i-r>0;){const s=Math.floor(.5*(r+i)),n=t[2*s];if(e<n){if(i-r===1)return!1;i=s}else{if(e<n+t[2*s+1])return!0;if(i-r===1)return!1;r=s+1}}return!1}get componentCount(){if(-1===this._componentCountCache){const e=this._indexRanges;let t=0;for(let r=0;r<e.length;r+=2)t+=e[r+1];this._componentCountCache=t}return this._componentCountCache}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let r=e[0],i=1;for(let s=1;s<e.length;s++){const n=e[s];r+i===n?i+=1:(t.push(r),t.push(i),r=n,i=1)}return t.push(r),t.push(i),t}(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let r=0;r<t.length;r+=2){const i=t[r],s=i+t[r+1];for(let t=i;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let r=0;r<t.length;r+=2){const i=t[r];if(!e(i,i+t[r+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),r=this._indexRanges;for(let i=0;i<r.length;i+=2){const s=r[i],n=s+r[i+1],o=e[s],a=e[n];t[i]=o,t[i+1]=a-o}return t}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/ComponentObject":function(){define(["exports","../../../../../core/maybe"],(function(e,t){"use strict";e.ComponentObject=class{constructor(e,t,r,i,s,n){this.transform=e,this.toMapSpace=t,this.obb=r,this.componentData=i,this.renderable=s,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=t.destroyMaybe(this.intersectionGeometry),this.renderable=t.destroyMaybe(this.renderable),this.componentData=t.destroyMaybe(this.componentData)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/IntersectionGeometry":function(){define(["exports","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/FloatArray","../../../../../geometry/support/Indices","../../../../ViewingMode","./ComponentObjectElevationAgnosticComponentBVH"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=s.create(),d=s.create(),h=r.create(),p=s.create(),m=r.create();e.IntersectionGeometry=class{constructor(e,t,r){this.viewingMode=e,this.positionData=t,this._components=r,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=s.create(),this._componentBvh=null,this._aabb=n.create(),this._indices=t.indices?a.compactIndices(t.indices):a.getContinuousIndexArray(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const r=this._ensureComponentAabbs(),i=6*e;return t[0]=r[i],t[1]=r[i+1],t[2]=r[i+2],t[3]=r[i+3],t[4]=r[i+4],t[5]=r[i+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,r,s,n,o,a,c,f){this.verticalOffset=n,this.componentVerticalOffsets=o;const{position:g}=a,y=i.sub(u,e,g),_=i.sub(d,r,g),b=t.invert(h,a.rotationScale);i.transformMat3(y,y,b),i.transformMat3(_,_,b);const v=t.transpose(m,b);if(this.viewingMode===l.ViewingMode.Global){const e=this._planetCenter;i.negate(e,g),i.transformMat3(e,e,b)}this._intersectComponents(y,_,o,n,((e,t,r,s)=>{f(r,e,s?i.transformMat3(p,s,v):null,t)}),s,c)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),r=.5*(e[1]+e[4]),i=.5*(e[2]+e[5]),s=this._components.count,n=o.newFloatArray(6*s),a=this._indices,l=this._positions,c=this._components.offsets;let u=0,d=1/0,h=1/0,p=1/0,m=-1/0,f=-1/0,g=-1/0;for(let e=0;e<s;e++){const s=c[e],o=c[e+1];let y=1/0,_=1/0,b=1/0,v=-1/0,S=-1/0,w=-1/0;if(s<o)for(let e=s;e<o;e++){const t=3*a[e],r=l[t],i=l[t+1],s=l[t+2];y=Math.min(y,r),_=Math.min(_,i),b=Math.min(b,s),v=Math.max(v,r),S=Math.max(S,i),w=Math.max(w,s)}else y=t,_=r,b=i,v=t,S=r,w=i;n[u++]=y,n[u++]=_,n[u++]=b,n[u++]=v,n[u++]=S,n[u++]=w,d=Math.min(d,y),h=Math.min(h,_),p=Math.min(p,b),m=Math.max(m,v),f=Math.max(f,S),g=Math.max(g,w)}return this._aabb[0]=d,this._aabb[1]=h,this._aabb[2]=p,this._aabb[3]=m,this._aabb[4]=f,this._aabb[5]=g,n}_intersectComponents(e,t,r,i,s,n,o){let a=this._componentBvh;null==a&&(a=new c.ComponentObjectElevationAgnosticComponentBVH(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=a),a.intersectRay(e,t,r,i,s,n,o)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===l.ViewingMode.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/ComponentObjectElevationAgnosticComponentBVH":function(){define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../../../../geometry/support/DoubleArray","./ComponentObjectElevationAgnosticComponentGeometryBVH","./ElevationAgnosticBVH","../../lib/ComponentUtils","../../lib/RayIntersections"],(function(e,t,r,i,s,n,o,a,l){"use strict";const c=i.create(),u=r.create(),d=r.create(),h=r.create(),p=r.create(),m=()=>{},f=new l.MeshIntersectionOptions;e.ComponentObjectElevationAgnosticComponentBVH=class{constructor(e,t,i,s,n,a,l,c){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=s,this._componentAabbs3D=n,this.geometryMinZ=a,this.planetCenterZ=l,this.localMode=c,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=h,this._ray1=p,this._invDir=r.create(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=f,this._callback=m,this.rayDirectionC=r.create(),this._componentIndexMap=null,this._bvh=new o.ElevationAgnosticBVH(s.count,this),this.componentIntersectionData=new Array(s.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:r}=this,i=s.newDoubleArray(4*e),n=this._componentAabbs3D;for(let s=0;s<e;++s){const e=6*s,o=n[e+0],a=n[e+1],l=n[e+2],c=n[e+3],u=n[e+4],d=r/(l-t),h=r/(n[e+5]-t),p=Math.min(o*d,o*h),m=Math.min(a*d,a*h),f=Math.max(c*d,c*h),g=Math.max(u*d,u*h),y=4*s;i[y+0]=p,i[y+1]=m,i[y+2]=f,i[y+3]=g}return i}getAabbs2DLocal(){const{numComponents:e}=this,t=s.newDoubleArray(4*e),r=this._componentAabbs3D;for(let i=0;i<e;++i){const e=6*i,s=r[e+0],n=r[e+1],o=r[e+3],a=r[e+4],l=4*i;t[l+0]=s,t[l+1]=n,t[l+2]=o,t[l+3]=a}return t}intersectRay(e,t,r,i,s,n,o){const{isVerticalRay:a}=o;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=r,this._verticalOffset=i,this._tolerance=n,this._intersectionOptions=o,this._componentIndexMap=this._bvh.elementIndexMap,l.computeInvDir(e,t,this._invDir),this._callback=s,this._bvh.intersectRay(e,t,a),this._callback=m}intersectRange(e,t){const r=this._componentIndexMap,{pickability:i,visibility:s}=this._components;for(let n=e;n<t;++n){const e=r?r[n]:n;a.getVisibility(i,e)&&s.isVisible(e)&&this._intersectComponent(e)}}getComponentTriangleCount(e){const t=this._components.offsets,r=t[e]/3;return t[e+1]/3-r}getComponentAabb3D(e,t){const r=this._componentAabbs3D,i=6*e;return t[0]=r[i],t[1]=r[i+1],t[2]=r[i+2],t[3]=r[i+3],t[4]=r[i+4],t[5]=r[i+5],t}_intersectComponent(e){const r=this.getComponentAabb3D(e,c);let i=!1;const{localMode:s,_componentVerticalOffsets:o,_verticalOffset:a,_ray0:h,_ray1:p,_invDir:m,planetCenterZ:f,_tolerance:g,rayDirectionC:y,componentIntersectionData:_}=this,{isVerticalRay:b}=this._intersectionOptions,v=this._components.offsets,S=t.copy(u,h),w=t.copy(d,p),x=o?.[e]??0,T=x+(a?.offset??0);if(0!==T&&(s?(S[2]=h[2]-T,w[2]=p[2]-T,i=!0):null!=a&&(a.componentOffset=x)),null==a||i||0===T||a.applyToAabb(r),!l.intersectAabbInvDir(r,S,m,g))return;t.sub(y,w,S);const C=v[e]/3,P=v[e+1]/3,M=P-C,R=(t,r,i)=>{this._callback(t,r,e,i)},{vertexData:E,vertexStride:O,indexData:A,_intersectionOptions:I}=this,{normalRequired:D}=I;if(M>40){let t=_[e];null==t&&(t=new n.ComponentObjectElevationAgnosticComponentGeometryBVH(e,E,O,A,C,P,this.geometryMinZ,f,s),_[e]=t),t.intersectRay(S,w,b,i?0:T,R,D)}else{const e=i?0:T;n.intersectTriangleRangeForComponent(S,y,C,P,A,E,O,e,f,D,R)}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/ComponentObjectElevationAgnosticComponentGeometryBVH":function(){define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./ElevationAgnosticBVH","../../lib/RayIntersections","../../lib/triangleIntersectionUtils"],(function(e,t,r,i,s,n){"use strict";function o(e,t,r,i,n,o,a,l,c,u,d,h=null,p=0){0!==l?s.intersectRayTrianglesWithVerticalOffsetENUGlobal(e,t,r,i,n,o,a,l,c,u,d,h,p):s.intersectRayTriangles(e,t,r,i,n,o,a,u,d,h,p)}function a(){}e.ComponentObjectElevationAgnosticComponentGeometryBVH=class{constructor(e,t,s,n,o,l,c,u,d){this.componentIndex=e,this.vertexData=t,this.vertexStride=s,this.indexData=n,this.startTriangleNumber=o,this.endTriangleNumber=l,this.geometryMinZ=c,this.planetCenterZ=u,this.localMode=d,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=r.create(),this.ray0=r.create(),this.isVerticalRay=!1,this._triangleHitCallback=a,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new i.ElevationAgnosticBVH(l-o,this)}getAabbs2D(){return this.localMode?n.generateTriangleAabbsLocal(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):n.generateTriangleAabbsGlobal(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,r,i,s,n,o){t.copy(this.ray0,e),t.sub(this.rayDirection,r,e),this.isVerticalRay=i,this.totalElevationOffset=s,this.normalRequired=o,this._triangleHitCallback=n,this._bvh.intersectRay(e,r,i),this._triangleHitCallback=a}intersectRange(e,t){const r=this._bvh.elementIndexMap;o(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,r,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}},e.intersectTriangleRangeForComponent=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/ElevationAgnosticBVH":function(){define(["exports","../../../../../core/mathUtils","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingRect","../../lib/triangleIntersectionUtils"],(function(e,t,r,i,s){"use strict";function n(e,t,r,i){const s=4*e,n=i[s+0+t];return i[s+2+t]<r?-1:n>r?1:0}class o{constructor(e,t,r,i,s,n,o){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=r,this.maxIndexIndex=i,this.dim=s,this.d=n,this.aabb2D=o,this.child0=-1,this.child1=-1}}e.ElevationAgnosticBVH=class{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=r.fromValues(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||0===this._bspNodes.length&&this._generateBsp()}intersectRay(e,t,r){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(r):this._intersectRayWithBVH(e,t,r))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,r){this._ensureBVH(),r?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],r=e[1];if(!this.localMode){const{geometryMinZ:i,planetCenterZ:s}=this,n=(i-s)/(e[2]-s);t=e[0]*n,r=e[1]*n}const{_bspNodes:i}=this;let s=0;for(;s>=0;){const e=i[s],{d:n,dim:o,minIndexIndex:a,minMidIndexIndex:l,maxMidIndexIndex:c,maxIndexIndex:u,aabb2D:d}=e;if(t<d[0]||t>d[2]||r<d[1]||r>d[3])break;if(-1===o||-1===e.child0&&-1===e.child1){this._intersectRange(a,u);break}{this._intersectRange(l,c);const i=(0===o?t:r)-n;if(i<0){if(-1===e.child0){this._intersectRange(a,l);break}s=e.child0}else{if(!(i>0))break;if(-1===e.child1){this._intersectRange(c,u);break}s=e.child1}}}}_intersectGeometryWithBVHGeneralRay(e,r){let i=e[0],s=e[1],n=r[0],o=r[1];const{geometryMinZ:a}=this;if(!this.localMode){let t=0,l=1;const c=Math.min(.5*this.planetCenterZ,a),u=e[2],d=r[2];if(u<c&&d<c)return;if(u<c&&(t=(c-u)/(d-u)),d<c&&(l=(c-u)/(d-u)),t>l)return;const h=(1-t)*e[0]+t*r[0],p=(1-t)*e[1]+t*r[1],m=(1-t)*e[2]+t*r[2],f=(1-l)*e[0]+l*r[0],g=(1-l)*e[1]+l*r[1],y=(1-l)*e[2]+l*r[2],{planetCenterZ:_}=this,b=a-_,v=b/(m-_);i=h*v,s=p*v;const S=b/(y-_);n=f*S,o=g*S}const l=n-i,c=o-s,u=this._bspNodes;let d=1;{const{aabb2D:e}=u[0],t=(e,t,r,i)=>{if(Math.abs(t)<1e-5*Math.max(i-r,1))return!1;const s=t>0,n=s?i:r,o=e+d*t;return(s?o<n:o>n)&&(d=Math.max((n-e)/t,d),!0)},r=()=>t(i,l,e[0],e[2]),n=()=>t(s,c,e[1],e[3]);Math.abs(l)>=Math.abs(c)?r()||n():n()||r()}const h=[0,0,d];let p=0;for(;p<h.length;){const e=h[p];let r=h[p+1],n=h[p+2];if(p+=3,r>n)continue;const o=u[e],{minIndexIndex:a,maxIndexIndex:m}=o,{child0:f,child1:g,minMidIndexIndex:y,maxMidIndexIndex:_,aabb2D:b,d:v,dim:S}=o;{const e=i+r*l,t=i+n*l,s=Math.min(e,t),o=Math.max(e,t),a=b[0],c=b[2];if(o<a||c<s)continue;if(s<a){const e=(a-i)/l;l>0?r=Math.max(r,e):n=Math.min(n,e)}if(c<o){const e=(c-i)/l;l>0?n=Math.min(n,e):r=Math.max(r,e)}}{const e=s+r*c,t=s+n*c,i=Math.min(e,t),o=Math.max(e,t),a=b[1],l=b[3];if(o<a||l<i)continue;if(i<a){const e=(a-s)/c;c>0?r=Math.max(r,e):n=Math.min(n,e)}if(l<o){const e=(l-s)/c;c>0?n=Math.min(n,e):r=Math.max(r,e)}}if(-1===f&&-1===g)this._intersectRange(a,m);else{const e=0===S?i:s,o=0===S?l:c,u=e+r*o,p=e+n*o,b=Math.min(u,p),w=Math.max(u,p),x=t.clamp((v-e)/o,0,d);a<y&&b<=v&&(-1!==f?(h.push(f),h.push(o>=0?r:Math.max(r,x)),h.push(o>=0?Math.min(n,x):n)):this._intersectRange(a,y)),this._intersectRange(y,_),_<m&&v<=w&&(-1!==g?(h.push(g),h.push(o>=0?Math.max(r,x):r),h.push(o>=0?n:Math.min(n,x))):this._intersectRange(_,m))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=s.createUintArray(e,e);this._elementIndexMap=t;for(let r=0;r<e;++r)t[r]=r;const r=this.model.getAabbs2D();let a=0;const l=this._bspNodes;l.length=0;const{localMode:c}=this;let u=!1;if(!c){const{planetCenterZ:e,geometryMinZ:t}=this;u=e>=0||t<.5*e}const d=[],h=(e,t,r,i,s)=>{d.push(e),d.push(t),d.push(r),d.push(i<0?-1:(s?0:1)+2*i)},{maxBspNodeDepth:p,minBspNodeElementCount:m}=this,f=(e,s,a,d,f)=>{const g=l.length;if(g>0&&(u||a>=p||s-e<m))return;const y=i.create();!function(e,t,r,i,s){let n=1/0,o=1/0,a=-1/0,l=-1/0;for(let e=t;e<r;++e){const t=4*i[e];n=Math.min(n,s[t+0]),o=Math.min(o,s[t+1]),a=Math.max(a,s[t+2]),l=Math.max(l,s[t+3])}e[0]=n,e[1]=o,e[2]=a,e[3]=l}(y,e,s,t,r);const{d:_,dim:b}=c?function(e){const t=e[0],r=e[1],i=e[2],s=e[3];let n,o;return i-t>=s-r?(o=.5*(t+i),n=0):(o=.5*(r+s),n=1),{d:o,dim:n}}(y):function(e){const t=e[0],r=e[1],i=e[2],s=e[3];let n,o;return i-t>=s-r?(n=0,o=.5*(t+i)):(n=1,o=.5*(r+s)),{dim:n,d:o}}(y),{rangeMidStart:v,rangeMidEnd:S}=function(e,t,r,i,s,o){let a=e;{let e=t;for(;a<e;){const t=s[a];n(t,r,i,o)<0?++a:(--e,s[a]=s[e],s[e]=t)}}const l=a;let c=a,u=t;for(;c<u;){const e=s[u-1];n(e,r,i,o)>0?--u:(s[u-1]=s[c],s[c]=e,++c)}return{rangeMidStart:l,rangeMidEnd:u}}(e,s,b,_,t,r),w=a===p-1,x=!w&&v>=e+m,T=!w&&s>=S+m;if(x||T||0===g){const t=new o(e,v,S,s,b,_,y);if(x&&h(e,v,a+1,g,!0),T&&h(S,s,a+1,g,!1),l.push(t),-1!==d){const e=l[d];f?e.child0=g:e.child1=g}}};for(h(0,e,0,-1,!1);a<d.length;){const e=d[a],t=d[a+1],r=d[a+2],i=d[a+3];a+=4;const s=i>>1;f(e,t,r,s,i-(s<<1)==0)}this._generatedBVH=!0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/triangleIntersectionUtils":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t,r){"use strict";function i(e,r,i){const s=t.dot(e,r)-i;return Math.abs(s)<=1e-5}function s(e,i,s){const n=r.create(),o=r.create();t.sub(o,i,e);const a=r.create();return t.sub(a,s,e),t.cross(n,o,a),t.normalize(n,n),n}function n(e,n,o,a){const l=[n,o,a],c=s(n,o,a);if(!i(e,c,t.dot(l[0],c)))return!1;for(let e=0;e<3;++e){const i=l[e],s=l[(e+1)%3],n=l[(e+2)%3],o=r.create();t.sub(o,s,i),t.normalize(o,o);const a=r.create();t.sub(a,n,i);const c=t.dot(a,o),u=r.create();t.scaleAndAdd(u,i,o,c);const d=r.create();t.sub(d,n,u),t.normalize(d,d);const h=t.dot(i,d);if(!(t.dot(d,u)-h>=-1e-4))return!1}return!0}function o(e){const i=r.create();t.sub(i,e[1],e[0]),t.normalize(i,i);const s=r.create();t.sub(s,e[2],e[0]),t.normalize(s,s);const n=r.create();return t.cross(n,i,s),t.normalize(n,n),n}function a(e,i,s){const n=r.create();t.sub(n,s,i),t.normalize(n,n);const o=r.create();t.sub(o,e,i);const a=t.dot(o,n),l=r.create();return t.scaleAndAdd(l,i,n,a),l}function l(e,i,s){const n=r.create();t.sub(n,s,i);const o=t.len(n);t.normalize(n,n);const a=r.create();t.sub(a,e,i);const l=t.dot(a,n);if(l<0)return t.dist(i,e);if(l>o)return t.dist(s,e);const c=r.create();return t.scaleAndAdd(c,i,n,l),t.dist(c,e)}function c(e,r,i){return t.dot(e,r)-i}function u(e,i,s){const n=r.create(),o=r.create();t.sub(o,i,e);const a=r.create();return t.sub(a,s,e),t.cross(n,o,a),t.normalize(n,n),{normal:n,d:t.dot(n,e)}}function d(e,i,s,o){const{normal:a,d}=u(i,s,o),h=c(e,a,d),p=r.create();return t.scaleAndAdd(p,e,a,-h),n(p,i,s,o)?h:Math.min(l(e,i,s),l(e,s,o),l(e,o,i))}function h(e){return e<128?Uint8Array:e<32768?Uint16Array:e<1<<31?Uint32Array:Array}e.binarySearchSortedArray=function(e,t){const r=e.length;if(0===r)return 0;if(t<e[0])return-1;if(t>=e[r-1])return r;let i=0,s=r-1;for(;s-i>1;){const r=Math.floor(.5*(s+i));t>=e[r]?i=r:s=r}return i},e.calculateNormalFromVertices=o,e.createUintArray=function(e,t){return new(h(e))(t)},e.distancePointLine=function(e,r,i){const s=a(e,r,i);return t.dist(s,e)},e.distancePointPlane=c,e.distancePointSegment=l,e.distancePointTriangle=d,e.elevationAlignVertexGlobal=function(e,t,r,i){const[s,n,o]=i??e,a=o-r,l=t/Math.sqrt(s*s+n*n+a*a);e[0]+=s*l,e[1]+=n*l,e[2]+=a*l},e.elevationAlignVertexLocal=function(e,t){e[2]+=t},e.generateTriangleAabbsGlobal=function(e,t,r,i,s,n,o){const a=n-o,l=t-e,c=new Float64Array(4*l);for(let t=0;t<l;++t){const n=3*(t+e),l=s*r[n+0],u=i[l+0],d=i[l+1],h=a/(i[l+2]-o),p=u*h,m=d*h,f=s*r[n+1],g=i[f+0],y=i[f+1],_=a/(i[f+2]-o),b=g*_,v=y*_,S=s*r[n+2],w=i[S+0],x=i[S+1],T=a/(i[S+2]-o),C=w*T,P=x*T,M=4*t;c[M+0]=Math.min(p,b,C),c[M+1]=Math.min(m,v,P),c[M+2]=Math.max(p,b,C),c[M+3]=Math.max(m,v,P)}return c},e.generateTriangleAabbsLocal=function(e,t,r,i,s){const n=t-e,o=new Float64Array(4*n);for(let t=0;t<n;++t){const n=3*(t+e),a=s*r[n+0],l=i[a+0],c=i[a+1],u=s*r[n+1],d=i[u+0],h=i[u+1],p=s*r[n+2],m=i[p+0],f=i[p+1],g=4*t;o[g+0]=Math.min(l,d,m),o[g+1]=Math.min(c,h,f),o[g+2]=Math.max(l,d,m),o[g+3]=Math.max(c,h,f)}return o},e.getConstructorForValueCount=h,e.getNearestPointOnLine=a,e.getRayTriangleIntersectionDistance=function(e,i,s){const a=r.create();t.sub(a,i,e);const l=o(s),c=t.dot(l,s[0]),u=t.dot(l,e)-c,h=t.dot(l,i)-c;if(u*h>0)return 1/0;const p=r.create(),m=(0-u)/(h-u);return t.scaleAndAdd(p,e,a,m),n(p,s[0],s[1],s[2])?0:d(p,s[0],s[1],s[2])},e.getTriangleNormal=s,e.getTrianglePlane=u,e.isPointInPlane=i,e.isPointInTriangle=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ComponentUtils":function(){define(["exports","../../../../core/arrayUtils"],(function(e,t){"use strict";function r(e){return 8*e.BYTES_PER_ELEMENT}e.getVisibility=function(e,t){if(null==e)return!0;const i=r(e);return!(t<e.length*i)||function(e,t,r){const i=t/r|0,s=t-i*r;return!function(e,t){return!!(e&1<<t)}(e[i],s)}(e,t,i)},e.updatePickabilityWithCount=function(e,i,s){const n=e.count;if(i>=n)return;e.pickability??=new Uint32Array(0);let o=e.pickability;const a=r(o),l=i/a|0,c=i-a*l,u=(n-1)/a|0,d=o;if(!(i<d.length*a||s)){const r=l+1,i=Math.ceil(d.length*t.reallocGrowthFactor),s=u+1;let n=Math.max(r,i);n=Math.min(n,s),e.pickability=o=new Uint32Array(n),o.set(d)}l<o.length&&(o[l]=function(e,t,r){return e&~(1<<t)|(r?1:0)<<t}(o[l],c,!s))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/Renderable":function(){define(["exports"],(function(e){"use strict";e.Renderable=class{constructor(e,t,r){this.material=e,this.geometry=t,this.meta=r}destroy(){this.material.dispose(),this.geometry.dispose()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/RenderGeometry":function(){define(["exports"],(function(e){"use strict";e.RenderGeometry=class{constructor(e,t,r,i){this.vao=e,this.primitiveType=t,this.parameters=r,this.indexed=i}dispose(){this.vao.dispose()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/RenderSubmitSystem":function(){define(["exports","./DepthRange"],(function(e,t){"use strict";e.RenderSubmitSystem=class{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((r=>r.renderable.material.submit(e,t,r)))}queryDepthRange(e){return this._objects.visibleObjects.length?t.computeDepthRange(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some((e=>e.renderable.material.hasEmissions))}hasHighlight(e){return this._objects.hasHighlight(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/DepthRange":function(){define(["exports","../../../../../core/PooledArray","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/math/quat","../../../../../core/libs/gl-matrix-2/factories/quatf64","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/plane","../../lib/DepthRange"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=new t({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),d=new c.DepthRange,h=a.create(),p=a.create(),m=new t({deallocator:null}),f=new t({deallocator:null});function g(e,t,r){r.length=0;const i=t.length-3;y(h,t,i);const s=l.signedDistance(e,h);s<=0&&(r.push(h[0]),r.push(h[1]),r.push(h[2]));let n=0,a=s;for(;n<i;n+=3){y(p,t,n);const i=l.signedDistance(e,p);if(a*i<0){const e=i/(i-a);o.lerp(h,p,h,e),_(r,h)}i<=0&&_(r,p),a=i,o.copy(h,p)}if(a*s<0){y(p,t,i);const e=s/(s-a);o.lerp(h,p,h,e),_(r,h)}}function y(e,t,r){return o.set(e,t.data[r],t.data[r+1],t.data[r+2])}function _(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function b(e,t,i,n){s.conjugate(w,e.quaternion),o.sub(x,t,e.center),o.transformQuat(x,x,w);const a=e.halfSize,l=8*((x[0]<-a[0]?-1:x[0]>a[0]?1:0)+3*(x[1]<-a[1]?-1:x[1]>a[1]?1:0)+9*(x[2]<-a[2]?-1:x[2]>a[2]?1:0)+13),c=v[l];if(0===c)return c;r.fromQuat(S,e.quaternion),r.scale(S,S,e.halfSize);const u=(t,r)=>{const i=v[l+r+1];return o.set(t,((1&i)<<1)-1,(2&i)-1,((4&i)>>1)-1),o.transformMat3(t,t,S),o.add(t,e.center,t)};return i.length=0,_(i,u(T,0)),_(i,u(C,1)),_(i,u(x,2)),_(i,u(P,3)),n(i),1===c||(i.length=0,_(i,T),_(i,P),_(i,u(x,4)),_(i,u(M,5)),n(i),2===c||(i.length=0,_(i,T),_(i,M),_(i,u(x,6)),_(i,C),n(i))),c}const v=(()=>{const e=new Array(216);let t=0;const r=r=>{for(let i=0;i<r.length;i++)e[t+i]=r[i];t+=8};return r([3,0,6,2,3,1,5,4]),r([2,0,2,3,1,5,4,0]),r([3,1,0,2,3,7,5,4]),r([2,0,1,3,2,6,4,0]),r([1,0,1,3,2,0,0,0]),r([2,1,5,7,3,2,0,0]),r([3,2,0,1,3,7,6,4]),r([2,2,0,1,3,7,6,0]),r([3,3,0,1,5,7,6,2]),r([2,0,1,5,4,6,2,0]),r([1,0,1,5,4,0,0,0]),r([2,1,3,7,5,4,0,0]),r([1,0,2,6,4,0,0,0]),r([0,0,0,0,0,0,0,0]),r([1,1,3,7,5,0,0,0]),r([2,2,3,7,6,4,0,0]),r([1,2,3,7,6,0,0,0]),r([2,3,1,5,7,6,2,0]),r([3,4,0,1,5,7,6,2]),r([2,5,7,6,4,0,1,0]),r([3,5,0,1,3,7,6,4]),r([2,4,5,7,6,2,0,0]),r([1,4,5,7,6,0,0,0]),r([2,5,1,3,7,6,4,0]),r([3,6,0,2,3,7,5,4]),r([2,6,2,3,7,5,4,0]),r([3,7,6,2,3,1,5,4]),e})(),S=i.create(),w=n.create(),x=a.create(),T=a.create(),C=a.create(),P=a.create(),M=a.create();e.computeDepthRange=function(e,t){const r=new c.DepthRange,{eye:i,frustum:s,viewForward:n}=e;t.forAll((e=>{const t=null!=e.offsetObb?e.offsetObb:e.obb,a=o.dot(o.sub(x,t.center,i),n),l=t.projectedRadius(n);if(r.within(a-l)&&r.within(a+l))return;const c=function(e,t){let r=0;for(let i=0;i<4;i++){const s=e.intersectPlane(t[i]);if(s>0)return-1;0===s&&(r|=1<<i)}return r}(t,s);if(-1===c)return;if(0===c)return d.far=a+l,d.near=a-l,void r.union(d);const h=u.pushNew();h.near=a-l,h.far=a+l,h.mask=c,h.object=e}));for(let e=0;e<u.length;e++){const t=u.data[e];if(r.within(t.near)&&r.within(t.far))continue;d.far=t.far,d.near=1/0;const a=b(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,i,m,(e=>{let r=f;for(let i=0;i<4&&e.length>0;i++){if(!(t.mask&1<<i))continue;g(s[i],e,r);const n=e;e=r,r=n}for(let t=0;t<e.length;t+=3){o.set(h,e.data[t],e.data[t+1],e.data[t+2]);const r=o.dot(o.sub(h,h,i),n);d.near=Math.min(d.near,r)}}));0===a&&(d.near=0),r.union(d)}return u.length=0,r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/SourceGeometry":function(){define(["exports","../../../support/buffer/InterleavedLayout","../../core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../../lib/VertexAttribute","../../../../webgl/NoParameters"],(function(e,t,r,i,s){"use strict";class n extends s.NoParameters{constructor(e,t,r,i,s){super(),this.colors=e,this.textureCoordinates=t,this.hasNormals=r,this.shadeNormals=i,this.applySSAO=s}}e.GeometryParameters=n,e.createVertexBufferLayout=function({hasNormals:e,textureCoordinates:s,colors:n}){const o=t.newLayout().vec3f(i.VertexAttribute.POSITION);return e&&o.vec2i16(i.VertexAttribute.NORMALCOMPRESSED,{glNormalized:!0}),s===r.TextureCoordinateType.Default?o.vec2f(i.VertexAttribute.UV0):s===r.TextureCoordinateType.Atlas&&(o.vec2f(i.VertexAttribute.UV0),o.vec4u16(i.VertexAttribute.UVREGION,{glNormalized:!0})),n&&o.vec4u8(i.VertexAttribute.COLOR,{glNormalized:!0}),o.freeze()},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/UniformComponentParameters":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../layers/support/symbolColorUtils"],(function(e,t,r){"use strict";e.UniformComponentParameters=class{constructor(){this.externalColor=t.create(),this.externalColorMixMode=r.ColorMixModeEnum.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/Material/ComponentMaterial":function(){define(["exports","../../../../../../chunks/tslib.es6","../../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../../chunks/vec32","../../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../../chunks/vec42","../../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../../../symbols/support/materialUtils","../../../../layers/support/symbolColorUtils","../../../../terrain/OverlayContent","./ComponentTechnique","./ComponentTechniqueConfiguration","./shader/ComponentData.glsl","./shader/VertexDiscardMode","../../../core/material/MaterialBase","../../../core/renderPasses/RenderPassIdentifier","../../../core/shaderLibrary/ShaderOutput","../../../core/shaderLibrary/attributes/NormalAttribute.glsl","../../../core/shaderLibrary/output/Emissions.glsl","../../../core/shaderLibrary/shading/Normals.glsl","../../../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../../../core/shaderLibrary/util/EllipsoidMode","../../../core/util/TwoVectorPosition","../../../lib/basicInterfaces","../../../lib/OITPass","../../../lib/RenderSlot","../../../materials/pbrUtils","../../../../../support/HighlightDefaults","../../../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E){"use strict";class O extends f.MaterialBase{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=a.freeze(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=M.advancedMRRFactors,this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.normalTexture=null,this.occlusionTexture=null,this.emissionTexture=null,this.emissiveBaseColor=n.freeze(0,0,0),this.emissiveStrength=1,this.emissiveSource=l.EmissiveSourceMode.Emissive,this.commonMaterialParameters=new D,this.componentParameters=new F,this.objectOpacity=1,this.textureAlphaCutoff=E.alphaCutoff,this.alphaDiscardMode=T.AlphaDiscardMode.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=w.EllipsoidMode.Earth,this.hasOccludees=!1;const s=new x.TwoVectorPosition(e.position),o=i.clone(e.rotationScale);r.invert(o,o),r.transpose(o,o),this.transformNormalGlobalFromModel=o,this.transformWorldFromModelTL=s.low,this.transformWorldFromModelTH=s.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get hasEmissions(){return null!=this.emissionTexture||!s.exactEquals(this.emissiveBaseColor,n.ZEROS)}get texture(){return this.baseColorTexture?.glTexture}get textureMetallicRoughness(){return this.metallicRoughnessTexture?.glTexture}get textureEmissive(){return this.emissionTexture?.glTexture}get textureOcclusion(){return this.occlusionTexture?.glTexture}get textureNormal(){return this.normalTexture?.glTexture}acquireTechnique(e,t,r,i){const s=new h.ComponentTechniqueConfiguration(e.context.spherical);s.renderOccluded=r.slot===P.RenderSlot.OCCLUDED_GROUND,s.hasVertexColors=i.colors,s.hasNormals=i.hasNormals,s.textureCoordinateType=i.textureCoordinates,s.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,s.hasOcclusionTexture=null!=this.occlusionTexture,s.hasNormalTexture=null!=this.normalTexture,s.oitPass=t.identifier===g.RenderPassIdentifier.Material&&null!=r.oitPass?r.oitPass:C.OITPass.NONE,s.terrainDepthTest=t.identifier===g.RenderPassIdentifier.Material&&r.terrainDepthTest,s.cullAboveTerrain=t.identifier===g.RenderPassIdentifier.Material&&r.cullAboveTerrain,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?v.NormalsDoubleSidedMode.View:v.NormalsDoubleSidedMode.None,s.hasColorTexture=null!=this.baseColorTexture;const n=this._computeWhichMaterialPass();if(s.blendingEnabled=n===A.Transparent||n===A.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?function(e){return null!=e.overlay?.getTexture(u.OverlayContent.ColorNoRasterImage)}(r)?function(e){return null!=e.overlay?.getTexture(u.OverlayContent.WaterNormal)}(r)?h.IntegratedMeshMode.ColorOverlayWithWater:h.IntegratedMeshMode.ColorOverlay:h.IntegratedMeshMode.NoOverlay:h.IntegratedMeshMode.None,s.hasPolygonOffset=this.polygonOffsetEnabled,s.pbrMode=s.integratedMeshMode===h.IntegratedMeshMode.ColorOverlayWithWater?S.PBRMode.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?i.shadeNormals&&this.isIntegratedMesh?S.PBRMode.Disabled:S.PBRMode.Schematic:S.PBRMode.Normal:S.PBRMode.Disabled,s.emissionSource=this.hasEmissions?null!=this.emissionTexture?b.EmissionSource.Texture:s.pbrMode===S.PBRMode.Normal?b.EmissionSource.SymbolColor:b.EmissionSource.None:b.EmissionSource.None,s.shadeNormals=i.shadeNormals,s.normalType=s.hasNormals?_.NormalType.Compressed:_.NormalType.ScreenDerivative,s.hasSlicePlane=null!=r.slicePlane&&this.commonMaterialParameters.hasSlicePlane,s.receiveAmbientOcclusion=s.hasOccludees=s.receiveShadows=s.screenSpaceReflections=s.cloudReflections=s.hasHighlightMixTexture=!1,t.identifier===g.RenderPassIdentifier.ShadowMap)s.output=y.ShaderOutput.Shadow,s.vertexDiscardMode=m.VertexDiscardMode.None;else if(t.identifier===g.RenderPassIdentifier.ViewshedShadowMap)s.output=y.ShaderOutput.ViewshedShadow,s.vertexDiscardMode=m.VertexDiscardMode.None;else if(t.identifier===g.RenderPassIdentifier.Highlight)s.output=y.ShaderOutput.Highlight,s.vertexDiscardMode=m.VertexDiscardMode.None,s.hasHighlightMixTexture=null!=r.highlightMixTexture;else{switch(n===A.OpaqueAndTransparent?s.vertexDiscardMode=t.transparent?m.VertexDiscardMode.Opaque:m.VertexDiscardMode.Transparent:s.vertexDiscardMode=m.VertexDiscardMode.None,s.hasBloom=y.isColorEmission(t.output),s.output=t.output,t.output){case y.ShaderOutput.Color:case y.ShaderOutput.ColorEmission:s.receiveAmbientOcclusion=i.applySSAO&&null!=r.ssao?.getTexture(),s.hasOccludees=r.hasOccludees,s.receiveShadows=r.shadowMap.ready,s.screenSpaceReflections=null!=r.ssr.lastFrameColor,s.cloudReflections=null!=r.clouds.data?.cubeMap?.colorTexture;break;case y.ShaderOutput.ObjectAndLayerIdColor:s.objectAndLayerIdColor=!0}s.snowCover=r.snowCover}const o=e.get(d.ComponentTechnique,s);return this._setClean(),o}submit(t,r,i){if(this.objectOpacity<=0)return;const{componentData:s,renderable:n}=i,{geometry:o}=n,a=n.meta.cameraDepthSquared;s.updateHighlights(r.highlights);const{geometryRanges:l,highlightRangesMap:c,shadowmapRanges:d}=s;switch(this._computeWhichMaterialPass()){case A.Opaque:t.opaque.submitDraw(this,o,l,a);break;case A.Transparent:t.transparent.submitDraw(this,o,l,a);break;case A.OpaqueAndTransparent:t.opaque.submitDraw(this,o,l,a),t.transparent.submitDraw(this,o,l,a);break;case A.IntegratedMesh:t.integratedMesh.submitDraw(this,o,l,a),function(e){return null!=e.overlay?.getTexture(u.OverlayContent.Occluded)}(r)&&t.occludedGround.submitDraw(this,o,l,a),function(e){return null!=e.overlay?.getTexture(u.OverlayContent.Highlight)}(r)&&t.highlightIntegratedMesh.submitDraw(this,o,l,a)}if(this.componentParameters.castShadows!==e.ComponentParameterSummary.None){if(null!=c)for(const e of c)e[0]===R.defaultHighlightName&&t.highlightShadowMap.submitDraw(this,o,e[1],a,e[0]);null!=d&&t.defaultShadowMap.submitDraw(this,o,d,a),t.shadowMap.submitDraw(this,o,l,a)}if(null!=c)for(const e of c)t.highlight.submitDraw(this,o,e[1],a,e[0]);r.viewshedEnabled&&t.viewshedShadowMap.submitDraw(this,o,l,a)}_computeWhichMaterialPass(){if(this.isIntegratedMesh)return A.IntegratedMesh;if(this.objectOpacity<1)return A.Transparent;if(this.componentParameters.opaqueOverride===e.ComponentParameterSummary.All)return A.Opaque;if(this.baseColor[3]<1||this.alphaDiscardMode===T.AlphaDiscardMode.Blend||this.alphaDiscardMode===T.AlphaDiscardMode.MaskBlend)return A.Transparent;switch(this.componentParameters.transparent){case e.ComponentParameterSummary.None:return A.Opaque;case e.ComponentParameterSummary.All:return A.Transparent;case e.ComponentParameterSummary.Some:return A.OpaqueAndTransparent}}}var A,I;t.__decorate([f.parameter({vectorOps:o.vec4})],O.prototype,"baseColor",void 0),t.__decorate([f.parameter()],O.prototype,"usePBR",void 0),t.__decorate([f.parameter()],O.prototype,"hasParametersFromSource",void 0),t.__decorate([f.parameter({vectorOps:s.vec3})],O.prototype,"mrrFactors",void 0),t.__decorate([f.parameter({dispose:!0})],O.prototype,"baseColorTexture",void 0),t.__decorate([f.parameter({dispose:!0})],O.prototype,"metallicRoughnessTexture",void 0),t.__decorate([f.parameter({dispose:!0})],O.prototype,"normalTexture",void 0),t.__decorate([f.parameter({dispose:!0})],O.prototype,"occlusionTexture",void 0),t.__decorate([f.parameter({dispose:!0})],O.prototype,"emissionTexture",void 0),t.__decorate([f.parameter({vectorOps:s.vec3})],O.prototype,"emissiveBaseColor",void 0),t.__decorate([f.parameter()],O.prototype,"emissiveStrength",void 0),t.__decorate([f.parameter()],O.prototype,"emissiveSource",void 0),t.__decorate([f.parameterBlock()],O.prototype,"commonMaterialParameters",void 0),t.__decorate([f.parameterBlock()],O.prototype,"componentParameters",void 0),t.__decorate([f.parameter()],O.prototype,"objectOpacity",void 0),t.__decorate([f.parameter()],O.prototype,"textureAlphaCutoff",void 0),t.__decorate([f.parameter()],O.prototype,"alphaDiscardMode",void 0),t.__decorate([f.parameter()],O.prototype,"isIntegratedMesh",void 0),t.__decorate([f.parameter()],O.prototype,"polygonOffsetEnabled",void 0),t.__decorate([f.parameter()],O.prototype,"ellipsoidMode",void 0),t.__decorate([f.parameter()],O.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(A||(A={}));class D extends f.MaterialParameterBlock{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=T.CullFaceOptions.Back,this.hasSlicePlane=!0}}t.__decorate([f.parameter()],D.prototype,"doubleSided",void 0),t.__decorate([f.parameter()],D.prototype,"cullFace",void 0),t.__decorate([f.parameter()],D.prototype,"hasSlicePlane",void 0);class F extends f.MaterialParameterBlock{constructor(){super(...arguments),this.externalColor=a.fromValues(1,1,1,1),this.externalColorMixMode=c.ColorMixModeEnum.Multiply,this.castShadows=e.ComponentParameterSummary.All}get transparent(){return this.externalColor[3]<1?e.ComponentParameterSummary.All:e.ComponentParameterSummary.None}get opaqueOverride(){return this.externalColorMixMode===c.ColorMixModeEnum.Replace&&1===this.externalColor[3]?e.ComponentParameterSummary.All:e.ComponentParameterSummary.None}get visible(){return this.externalColor[3]>0?e.ComponentParameterSummary.All:e.ComponentParameterSummary.None}get type(){return p.ComponentDataType.Uniform}}t.__decorate([f.parameter({vectorOps:o.vec4})],F.prototype,"externalColor",void 0),t.__decorate([f.parameter()],F.prototype,"externalColorMixMode",void 0),t.__decorate([f.parameter()],F.prototype,"castShadows",void 0),e.ComponentParameterSummary=void 0,(I=e.ComponentParameterSummary||(e.ComponentParameterSummary={}))[I.All=0]="All",I[I.Some=1]="Some",I[I.None=2]="None";class L extends f.MaterialParameterBlock{constructor(){super(...arguments),this.texture=null,this.transparent=e.ComponentParameterSummary.None,this.opaqueOverride=e.ComponentParameterSummary.None,this.castShadows=e.ComponentParameterSummary.None}get type(){return p.ComponentDataType.Varying}}t.__decorate([f.parameter()],L.prototype,"texture",void 0),t.__decorate([f.parameter()],L.prototype,"transparent",void 0),t.__decorate([f.parameter()],L.prototype,"opaqueOverride",void 0),t.__decorate([f.parameter()],L.prototype,"castShadows",void 0),e.CommonMaterialParameters=D,e.ComponentMaterial=O,e.ComponentParametersUniform=F,e.ComponentParametersVarying=L,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/Material/ComponentTechnique":function(){define(["require","exports","./ComponentTechniqueConfiguration","../../../../../../chunks/ComponentShader.glsl","../../../core/shaderLibrary/ShaderOutput","../../../core/shaderTechnique/ReloadableShaderModule","../../../core/shaderTechnique/ShaderTechnique","../../../lib/basicInterfaces","../../../lib/OITPass","../../../lib/OrderIndependentTransparency","../../../lib/StencilUtils","../../../lib/VertexAttribute","../../../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p extends o.ShaderTechnique{constructor(t,r){super(t,r,new n.ReloadableShaderModule(i.ComponentShader,(()=>new Promise(((t,r)=>e(["./shader/ComponentShader.glsl"],t,r))))),m)}initializePipeline(e){const{integratedMeshMode:t,output:i,blendingEnabled:n,cullFace:d,hasOccludees:p,hasPolygonOffset:m,oitPass:f,renderOccluded:g}=e,y=t!==r.IntegratedMeshMode.None,_=f===l.OITPass.NONE,b=f===l.OITPass.FrontFace;return h.makePipelineState({blending:g?h.premultipliedAlpha:s.isColorOrColorEmission(i)&&n?c.blending(f):null,culling:h.cullingParams(d),depthTest:g?null:{func:c.oitDepthTest(f)},depthWrite:g||!_&&!b?null:h.defaultDepthWrite,drawBuffers:o.depthOnlyOutputBuffersOr(i,c.getDrawBuffers(f,i)),colorWrite:h.defaultColorWrite,stencilWrite:!g&&y||p?u.stencilWriteMaskOn:null,stencilTest:y?u.replaceBitWhenDepthTestPasses(a.StencilBits.IntegratedMeshMaskExcluded):p?u.stencilBaseAllZerosParams:null,polygonOffset:_||b?m?{factor:2,units:2}:null:c.OITPolygonOffset})}}const m=new Map([[d.VertexAttribute.POSITION,0],[d.VertexAttribute.NORMAL,1],[d.VertexAttribute.NORMALCOMPRESSED,1],[d.VertexAttribute.COLOR,2],[d.VertexAttribute.UV0,3],[d.VertexAttribute.UVREGION,4],[d.VertexAttribute.COMPONENTINDEX,5]]);t.ComponentTechnique=p,t.vertexAttributeLocations=m,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/Material/ComponentTechniqueConfiguration":function(){define(["exports","../../../../../../chunks/tslib.es6","./shader/ComponentData.glsl","./shader/VertexDiscardMode","../../../core/shaderLibrary/ShaderOutput","../../../core/shaderLibrary/attributes/NormalAttribute.glsl","../../../core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../../../core/shaderLibrary/output/Emissions.glsl","../../../core/shaderLibrary/shading/Normals.glsl","../../../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../../../core/shaderLibrary/util/EllipsoidMode","../../../core/shaderTechnique/ShaderTechniqueConfiguration","../../../lib/basicInterfaces","../../../lib/OITPass","../../../../../webgl/BindType"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";var f;e.IntegratedMeshMode=void 0,(f=e.IntegratedMeshMode||(e.IntegratedMeshMode={}))[f.None=0]="None",f[f.NoOverlay=1]="NoOverlay",f[f.ColorOverlay=2]="ColorOverlay",f[f.ColorOverlayWithWater=3]="ColorOverlayWithWater",f[f.COUNT=4]="COUNT";class g extends d.ShaderTechniqueConfiguration{constructor(t){super(),this.spherical=t,this.output=s.ShaderOutput.Color,this.textureCoordinateType=o.TextureCoordinateType.None,this.componentData=r.ComponentDataType.Uniform,this.cullFace=h.CullFaceOptions.Back,this.vertexDiscardMode=i.VertexDiscardMode.None,this.doubleSidedMode=l.NormalsDoubleSidedMode.WindingOrder,this.alphaDiscardMode=h.AlphaDiscardMode.Opaque,this.integratedMeshMode=e.IntegratedMeshMode.None,this.oitPass=p.OITPass.NONE,this.ellipsoidMode=u.EllipsoidMode.Earth,this.pbrMode=c.PBRMode.Disabled,this.normalType=n.NormalType.Attribute,this.emissionSource=a.EmissionSource.None,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.hasHighlightMixTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1,this.hasBloom=!1,this.renderOccluded=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=m.BindType.Draw,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.objectAndLayerIdColorInstanced=!1,this.draped=!1}get overlayEnabled(){return(this.integratedMeshMode===e.IntegratedMeshMode.ColorOverlay||this.integratedMeshMode===e.IntegratedMeshMode.ColorOverlayWithWater)&&s.isColorEmissionHighlightOrOID(this.output)}}t.__decorate([d.parameter({count:s.ShaderOutput.COUNT})],g.prototype,"output",void 0),t.__decorate([d.parameter({count:o.TextureCoordinateType.COUNT})],g.prototype,"textureCoordinateType",void 0),t.__decorate([d.parameter({count:r.ComponentDataType.COUNT})],g.prototype,"componentData",void 0),t.__decorate([d.parameter({count:h.CullFaceOptions.COUNT})],g.prototype,"cullFace",void 0),t.__decorate([d.parameter({count:i.VertexDiscardMode.COUNT})],g.prototype,"vertexDiscardMode",void 0),t.__decorate([d.parameter({count:l.NormalsDoubleSidedMode.COUNT})],g.prototype,"doubleSidedMode",void 0),t.__decorate([d.parameter({count:h.AlphaDiscardMode.COUNT})],g.prototype,"alphaDiscardMode",void 0),t.__decorate([d.parameter({count:e.IntegratedMeshMode.COUNT})],g.prototype,"integratedMeshMode",void 0),t.__decorate([d.parameter({count:p.OITPass.COUNT})],g.prototype,"oitPass",void 0),t.__decorate([d.parameter({count:u.EllipsoidMode.COUNT})],g.prototype,"ellipsoidMode",void 0),t.__decorate([d.parameter({count:c.PBRMode.COUNT})],g.prototype,"pbrMode",void 0),t.__decorate([d.parameter({count:n.NormalType.COUNT})],g.prototype,"normalType",void 0),t.__decorate([d.parameter({count:a.EmissionSource.COUNT})],g.prototype,"emissionSource",void 0),t.__decorate([d.parameter()],g.prototype,"hasVertexColors",void 0),t.__decorate([d.parameter()],g.prototype,"hasNormals",void 0),t.__decorate([d.parameter()],g.prototype,"shadeNormals",void 0),t.__decorate([d.parameter()],g.prototype,"hasSlicePlane",void 0),t.__decorate([d.parameter()],g.prototype,"hasColorTexture",void 0),t.__decorate([d.parameter()],g.prototype,"hasHighlightMixTexture",void 0),t.__decorate([d.parameter()],g.prototype,"receiveAmbientOcclusion",void 0),t.__decorate([d.parameter()],g.prototype,"receiveShadows",void 0),t.__decorate([d.parameter()],g.prototype,"blendingEnabled",void 0),t.__decorate([d.parameter()],g.prototype,"screenSpaceReflections",void 0),t.__decorate([d.parameter()],g.prototype,"hasPolygonOffset",void 0),t.__decorate([d.parameter()],g.prototype,"hasMetallicRoughnessTexture",void 0),t.__decorate([d.parameter()],g.prototype,"hasOcclusionTexture",void 0),t.__decorate([d.parameter()],g.prototype,"hasNormalTexture",void 0),t.__decorate([d.parameter()],g.prototype,"hasOccludees",void 0),t.__decorate([d.parameter()],g.prototype,"terrainDepthTest",void 0),t.__decorate([d.parameter()],g.prototype,"cullAboveTerrain",void 0),t.__decorate([d.parameter()],g.prototype,"hasNormalTextureTransform",void 0),t.__decorate([d.parameter()],g.prototype,"cloudReflections",void 0),t.__decorate([d.parameter()],g.prototype,"snowCover",void 0),t.__decorate([d.parameter()],g.prototype,"objectAndLayerIdColor",void 0),t.__decorate([d.parameter()],g.prototype,"hasBloom",void 0),t.__decorate([d.parameter()],g.prototype,"renderOccluded",void 0),e.ComponentTechniqueConfiguration=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/Material/shader/VertexDiscardMode":function(){define(["exports"],(function(e){"use strict";var t;e.VertexDiscardMode=void 0,(t=e.VertexDiscardMode||(e.VertexDiscardMode={}))[t.None=0]="None",t[t.Transparent=1]="Transparent",t[t.Opaque=2]="Opaque",t[t.COUNT=3]="COUNT",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/EllipsoidMode":function(){define(["exports","../../../../../../geometry/support/spatialReferenceUtils"],(function(e,t){"use strict";var r;e.EllipsoidMode=void 0,(r=e.EllipsoidMode||(e.EllipsoidMode={}))[r.Earth=1]="Earth",r[r.Mars=2]="Mars",r[r.Moon=3]="Moon",r[r.COUNT=4]="COUNT",e.getEllipsoidMode=function(r){return r&&t.isMars(r)?e.EllipsoidMode.Mars:r&&t.isMoon(r)?e.EllipsoidMode.Moon:e.EllipsoidMode.Earth},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/ComponentShader.glsl":function(){define(["exports","../geometry/support/Ellipsoid","../views/3d/terrain/OverlayContent","../views/3d/webgl-engine/collections/Component/Material/shader/ComponentData.glsl","../views/3d/webgl-engine/collections/Component/Material/shader/VertexDiscardMode","../views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexNormal.glsl","../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexPosition.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlightOverlay","../views/3d/webgl-engine/core/shaderLibrary/shading/ComputeFragmentNormals.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ComputeMaterialColor.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ComputeNormalTexture.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/EvaluateSceneLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadBaseColorTexture.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/TerrainDepthTest.glsl","../views/3d/webgl-engine/core/shaderLibrary/terrain/Overlay.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/DiscardOrAdjustAlpha.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/EllipsoidMode","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/effects/weather/SnowCover.glsl","../views/3d/webgl-engine/shaders/OutputColorHighlightOID.glsl","../views/webgl/ShaderBuilder","../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D){"use strict";function F(e){const F=new I.ShaderBuilder,{vertex:L,fragment:N}=F;F.include(d.VertexPosition,e),F.include(u.VertexNormal,e),F.include(c.VertexColor,e),F.include(l.TextureCoordinateAttribute,e),F.include(n.ForwardLinearDepth,e),F.include(i.ComponentData,e),F.include(C.DiscardOrAdjustAlphaDraw,e),N.include(a.SlicePass,e),F.include(S.ReadBaseColorTexture,e),F.include(x.terrainDepthTest,e);const{output:U,pbrMode:V,hasNormalTexture:B,snowCover:G,receiveShadows:k,shadeNormals:z,spherical:j,ellipsoidMode:q,overlayEnabled:H,componentData:W,vertexDiscardMode:$,hasBloom:Q,renderOccluded:Z}=e,Y=V===v.PBRMode.Normal||V===v.PBRMode.Schematic;Y&&(F.include(v.PhysicallyBasedRenderingParameters,e),B&&F.include(y.ComputeNormalTexture,e));const X=U===o.ShaderOutput.Shadow||U===o.ShaderOutput.ShadowHighlight||U===o.ShaderOutput.ShadowExcludeHighlight,K=X&&W===i.ComponentDataType.Varying;if(H){F.include(_.EvaluateSceneLighting,e),F.include(T.OverlayIM,e);const r=q===P.EllipsoidMode.Earth,i=q===P.EllipsoidMode.Earth,s=r?t.earth.radius:i?t.mars.radius:t.moon.radius;L.code.add(`\n      ${M.If(j,`const float invRadius = ${M.glsl.float(1/s)};`)}\n      vec2 projectOverlay(vec3 pos) { return pos.xy ${M.If(j,"/ (1.0 + invRadius * pos.z);")}; }`)}const J=H&&o.isColorOrColorEmission(U)&&V===v.PBRMode.WaterOnIntegratedMesh;J&&(F.varyings.add("tbnTangent","vec3"),F.varyings.add("tbnBiTangent","vec3"),F.varyings.add("groundNormal","vec3"));const ee=$===s.VertexDiscardMode.None,te=$===s.VertexDiscardMode.Opaque;if(L.main.add(M.glsl`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    ${M.If(K,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")}

    ${M.If(!ee,`{ if (externalColor.a ${te?">":"<="} ${M.glsl.float(1-1/255)}) { gl_Position = vec4(vec3(1e38), 1.0); return; } }`)}

    ${M.If(U===o.ShaderOutput.ObjectAndLayerIdColor,"externalColor.a = 1.0;")}

    forwardPosition(readElevationOffset());
    forwardViewPosDepth(vPosition_view);
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepth();
    forwardObjectAndLayerIdColor();
    ${M.If(J,j?M.glsl`
            groundNormal = normalize(positionWorld());
            tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
            tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:M.glsl`
            groundNormal = vec3(0.0, 0.0, 1.0);
            tbnTangent = vec3(1.0, 0.0, 0.0);
            tbnBiTangent = vec3(0.0, 1.0, 0.0);`)}
    ${M.If(H,"setOverlayVTC(projectOverlay(position));")}

    if (externalColor.a < ${M.glsl.float(D.alphaCutoff)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
  `),o.isColorOrColorEmission(U))return F.include(g.ComputeMaterialColor,e),F.include(f.computeFragmentNormals,e),F.include(_.EvaluateSceneLighting,e),F.include(A.outputColorHighlightOID,e),N.include(O.SnowCover,e),k&&F.include(w.ReadShadowMapPass,e),N.code.add(M.glsl`
      float evaluateShadow() {
        return ${k?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),H&&N.uniforms.add(new E.Texture2DPassUniform("ovColorTex",((e,t)=>T.getIMColorTexture(e,t)))),N.main.add(M.glsl`
      discardBySlice(vPositionWorldCameraRelative);
      discardByTerrainDepth();

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      /* When rendering the occluded overlay, we still need to read the base color texture
       * because we need to use the same discard logic. However after that to render only the
       * draped overlay, we simply set the base texture color to zero. */
      ${M.If(Z,M.glsl`textureColor = vec4(0);`)}

      ${M.If(H,M.glsl`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`)}

      /* Early discard to only emit when we have overlay */
      ${M.If(H&&Z,M.glsl`if (overlayColor.a < ${M.glsl.float(D.alphaCutoff)}) { discard; }`)}

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
    `),Y?(b.addMainLightIntensity(N),j&&_.addLightingGlobalFactor(N),N.main.add(M.glsl`
        applyPBRFactors();
        ${M.If(V===v.PBRMode.Normal,M.glsl`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${M.If(B,"mat3 tangentSpace = computeTangentSpace(fragmentFaceNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${B?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 groundNormal = ${j?M.glsl`normalize(positionWorld())`:M.glsl`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${M.If(G,M.glsl`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${M.If(H,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 emission = ${Q?"vec4(0.0)":"getEmissions(materialColor.rgb)"};
        ${M.If(j,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${j?M.glsl`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, groundNormal, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(b.addMainLightDirection(N),j&&_.addLightingGlobalFactor(N),J&&N.uniforms.add(new R.Texture2DBindUniform("ovNormalTex",(e=>e.overlay?.getTexture(r.OverlayContent.WaterNormal)))),N.main.add(M.glsl`
        ${M.If(j,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${k?j?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":j?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${M.If(k&&!z,M.glsl`
            float dotFL = dot(fragmentFaceNormal, mainLightDirection);
            if( dotFL <= 0.0) shadow = 1.0;
        `)}
        ${M.If(G,M.glsl`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${M.If(H,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${M.If(J,M.glsl`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),N.main.add(`outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative, materialColor.rgb ${M.If(G,", snow")});`),F;const re=U===o.ShaderOutput.Normal,ie=U===o.ShaderOutput.ObjectAndLayerIdColor,se=U===o.ShaderOutput.Highlight,ne=X||U===o.ShaderOutput.ViewshedShadow;return ne&&F.include(h.OutputDepth,e),re&&F.include(f.computeFragmentNormals,e),H&&F.include(m.OutputHighlightOverlay,e),F.include(p.OutputHighlight,e),N.main.add(M.glsl`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${M.If(ne,"outputDepth(linearDepth);")}
    ${M.If(re,M.glsl`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${M.If(ie,H?"fragColor = getOverlayColorTexel();":"outputObjectAndLayerIdColor();")}
    ${M.If(se,M.If(H,M.glsl`calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,M.glsl`calculateOcclusionAndOutputHighlight();`))}`),F}const L=Object.freeze(Object.defineProperty({__proto__:null,build:F},Symbol.toStringTag,{value:"Module"}));e.ComponentShader=L,e.build=F}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ComputeFragmentNormals.glsl":function(){define(["exports","../../../../../../core/compilerUtils","../attributes/NormalAttribute.glsl","../attributes/VertexNormal.glsl","../attributes/VertexPosition.glsl","./Normals.glsl","../../shaderModules/glsl"],(function(e,t,r,i,s,n,o){"use strict";e.computeFragmentNormals=function(e,a){const l=e.fragment;switch(a.doubleSidedMode){case n.NormalsDoubleSidedMode.None:l.code.add(o.glsl`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case n.NormalsDoubleSidedMode.View:e.include(s.VertexPosition,a),l.code.add(o.glsl`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case n.NormalsDoubleSidedMode.WindingOrder:l.code.add(o.glsl`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:t.neverReached(a.doubleSidedMode);case n.NormalsDoubleSidedMode.COUNT:}switch(a.normalType){case r.NormalType.Attribute:case r.NormalType.Compressed:e.include(i.VertexNormal,a),l.main.add(o.glsl`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case r.NormalType.ScreenDerivative:e.include(s.VertexPosition,a),l.main.add(o.glsl`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`);default:case r.NormalType.COUNT:}a.shadeNormals?l.main.add(o.glsl`vec3 fragmentShadingNormal = fragmentFaceNormal;`):a.spherical?(e.include(s.VertexPosition,a),l.main.add(o.glsl`vec3 fragmentShadingNormal = normalize(positionWorld());`)):l.main.add(o.glsl`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ComputeMaterialColor.glsl":function(){define(["exports","../attributes/VertexColor.glsl","../util/MixExternalColor.glsl","../../shaderModules/Float4DrawUniform","../../shaderModules/FloatDrawUniform","../../shaderModules/glsl"],(function(e,t,r,i,s,n){"use strict";e.ComputeMaterialColor=function(e,o){e.include(t.VertexColor,o),e.fragment.include(r.MixExternalColor);const a=e.fragment;a.uniforms.add(new i.Float4DrawUniform("baseColor",(e=>e.baseColor))),a.uniforms.add(new s.FloatDrawUniform("objectOpacity",(e=>e.objectOpacity))),o.hasVertexColors?a.code.add(n.glsl`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):a.code.add(n.glsl`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),a.code.add(n.glsl`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/ReadBaseColorTexture.glsl":function(){define(["exports","../ShaderOutput","../attributes/VertexTextureCoordinates.glsl","../../shaderModules/glsl","../../shaderModules/Texture2DDrawUniform","../../../lib/basicInterfaces"],(function(e,t,r,i,s,n){"use strict";e.ReadBaseColorTexture=function(e,o){const a=o.hasColorTexture&&(t.isColorOrColorEmission(o.output)||o.alphaDiscardMode!==n.AlphaDiscardMode.Opaque);a&&(e.include(r.VertexTextureCoordinates,o),e.fragment.uniforms.add(new s.Texture2DDrawUniform("baseColorTexture",(e=>e.texture)))),e.fragment.code.add(i.glsl`
    vec4 readBaseColorTexture() {
      return ${a?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/material/MaterialBase":function(){define(["exports","../../../../webgl/NoParameters"],(function(e,t){"use strict";class r extends t.NoParameters{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}e.MaterialBase=r,e.MaterialParameterBlock=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}},e.parameter=function(e={}){return(t,r)=>{const i=t._parameterCount??0;if(t._parameterCount=i+1,e.vectorOps){const s=e.vectorOps;Object.defineProperty(t,r,{get(){return this[i]},set(e){const t=this[i];if(null==t)this[i]=[...e];else{if(s.equals(t,e))return;s.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,r,{get(){return this[i]},set(t){this[i]!==t&&(e.dispose&&this[i]&&this[i].dispose(),this[i]=t,this._setDirty())}})}},e.parameterBlock=function(){return(e,t)=>{const r=e._parameterCount??0;e._parameterCount=r+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(r),Object.defineProperty(e,t,{get(){return this[r]},set(e){this[r]!==e&&(this[r]=e,this._setDirty())}})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/util/TwoVectorPosition":function(){define(["exports","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f32","../../../../../core/libs/gl-matrix-2/factories/vec3f64"],(function(e,t,r,i){"use strict";const s=r.create();e.TwoVectorPosition=class{constructor(e){this._low=i.create(),this._high=i.create(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){t.copy(this._low,t.copy(s,e));const r=t.sub(s,e,this._low);t.copy(this._high,r)}get(e){return t.add(e,this._low,this._high)}getLowScaled(e){return t.scale(e,this._low,1)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextureBackedBuffer/BufferManager":function(){define(["exports","./ManagedTextureBackedBuffer"],(function(e,t){"use strict";e.BufferManager=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this._buffers.forEach((e=>e.dispose())),this._buffers=[]}getBuffer(e){for(const t of this._buffers)if(t.availableCount>=e)return t;if(e>t.maxIndexCount)return null;const r=new t.ManagedTextureBackedBuffer(this._rctx,this._fieldCount);return this._buffers.push(r),r}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextureBackedBuffer/ManagedTextureBackedBuffer":function(){define(["exports","./SimpleIndexManager","./TextureBackedBuffer"],(function(e,t,r){"use strict";e.ManagedTextureBackedBuffer=class{constructor(e,i=1){this.textureBuffer=new r.TextureBackedBuffer(e,i),this._indexManager=new t.SimpleIndexManager(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},e.maxIndexCount=65536,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextureBackedBuffer/SimpleIndexManager":function(){define(["exports"],(function(e){"use strict";e.SimpleIndexManager=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextureBackedBuffer/TextureBackedBuffer":function(){define(["exports","../../../../../geometry/support/buffer/BufferView","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,i,s){"use strict";e.TextureBackedBuffer=class{constructor(e,n=1){this._rctx=e,this._fieldCount=n,this.textureWidth=4096,this._dirty=!0;const o=new s.TextureDescriptor(this.textureWidth,1);o.samplingMode=r.TextureSamplingMode.NEAREST,o.wrapMode=r.TextureWrapMode.CLAMP_TO_EDGE,this._texture=new i.Texture(this._rctx,o),this._data=new t.BufferViewVec4u8(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,r,i,s,n){const o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,r),this._data.set(o,1,i),this._data.set(o,2,s),this._data.set(o,3,n)}setDataElement(e,t,r,i){const s=e*this._fieldCount+t;this._dirty=!0,this._data.set(s,r,i)}getDataElement(e,t,r){const i=e*this._fieldCount+t;return this._dirty=!0,this._data.get(i,r)}resizeToFit(e){const r=(e+1)*this._fieldCount;if(r>this._data.count){const e=Math.ceil(r/this.textureWidth)*this.textureWidth,i=new t.BufferViewVec4u8(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechniqueConstructionContext":function(){define(["exports","../../../../ViewingMode"],(function(e,t){"use strict";e.ShaderTechniqueConstructionContext=class{constructor(e,t,r,i,s){this.rctx=e,this.viewingMode=t,this.stippleTextures=r,this.waterTextures=i,this.markerTextures=s}get spherical(){return this.viewingMode===t.ViewingMode.Global}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderTechnique/ShaderTechniqueRepository":function(){define(["exports","../../../../../core/Error","../../../../../core/has","../../../../../core/NestedMap","./ShaderTechniqueConfiguration"],(function(e,t,r,i,s){"use strict";const n=new s.ShaderTechniqueConfiguration;e.NoConfiguration=n,e.ShaderTechniqueRepository=class{constructor(e){this.context=e,this._debug=!1,this._precompiling=this._debug?0:1,this._cache=new i.NestedMap}get precompiling(){return this._precompiling}set precompiling(e){this._precompiling=e,0===e&&this.context.rctx.gl.flush()}get viewingMode(){return this.context.viewingMode}destroy(){this._cache.forAll((e=>e.destroy())),this._cache.clear()}precompile(e,t=n){++this.precompiling,this.get(e,t),--this.precompiling}get(e,r=n){const i=r.key.code;let s=this._cache.get(e,i);if(null==s){if(0===this._precompiling){let i=`Uncached shader compile in ${(new Error).stack}\n  for configuration\n${r.decode()}`;const s=this._cache.getInner(e);throw s?.size&&(i+="\n\n  cached configurations:\n",i+=Array.from(s.values()).map((e=>r.decode(e.key))).sort().join("\n\n")),console.log(i),new t("shader:uncached-compile",i)}s=new e(this.context,r),this._cache.set(e,i,s)}return s}async reloadAll(){const e=new Array;this._cache.forEach((t=>e.push(async function(e){let t=!0;e.forEach((async e=>{await e.reload(t),t=!1}))}(t)))),await Promise.all(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/bloom/BloomRenderNode":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../webgl","../../core/FBOCacheFormats","../TransparentEnvironment","../../../../../chunks/BloomBlur.glsl","./BloomBlurTechnique","./BloomBlurTechniqueConfiguration","../../../../../chunks/BloomComposition.glsl","./BloomCompositionTechnique","./BloomPresets.glsl","../../lib/basicInterfaces","../../../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";e.BloomRenderNode=class extends d.TransparentEnvironment{constructor(e){super(e),this.consumes={required:[c.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,"emissive"]},this._blurHorizontalConfiguration=new m.BloomBlurTechniqueConfiguration,this._blurVerticalConfiguration=new m.BloomBlurTechniqueConfiguration,this._compositionParameters=new f.BloomCompositionPassParameters,this._blurParameters=new h.BloomBlurPassParameters,this._blurScale=3.06,this._bloomResults=new Array}initialize(){this.addHandles([i.watch((()=>this._updateFogParameters()),(()=>{}),i.syncAndInitial),i.watch((()=>this.view.qualitySettings.bloom),(e=>{e?(this._enable(),this.precompile()):this._disable()}),i.syncAndInitial)])}destroy(){}_updateFogParameters(){const e=this.view.environment.weather;if("sunny"===e.type||"cloudy"===e.type)this._blurParameters.blurRadius=y.blurRadiusPresets[e.type];else{const t="foggy"===e.type?e.fogStrength:e.precipitation;this._blurParameters.blurRadius=r.lerp(y.blurRadiusPresets.cloudy,y.blurRadiusPresets[e.type],t)}this._compositionParameters.lodFactors=y.lodFactorsPresets[e.type].far,this._compositionParameters.lodFactorsFront=y.lodFactorsPresets[e.type].near,this.requestRender(_.RenderRequestType.UPDATE)}precompile(){this.techniques.precompile(p.BloomBlurTechnique,this._blurHorizontalConfiguration),this._blurVerticalConfiguration.bloomStage=h.BlurDirection.Vertical,this.techniques.precompile(p.BloomBlurTechnique,this._blurVerticalConfiguration),this.techniques.precompile(g.BloomCompositionTechnique)}render(e){const t=e.find((({name:e})=>e===c.InternalRenderCategory.TRANSPARENT_ENVIRONMENT)),r=t.getAttachment(b.ColorAttachment1)?.attachment;if(!r)return t;const i=this.techniques.get(p.BloomBlurTechnique,this._blurHorizontalConfiguration),s=this.techniques.get(p.BloomBlurTechnique,this._blurVerticalConfiguration),n=this.techniques.get(g.BloomCompositionTechnique);if(!i.compiled||!s.compiled||!n.compiled)return this.requestRender(_.RenderRequestType.UPDATE),t;const o=t.getTexture(),a=this.fboCache,{fullWidth:l,fullHeight:d}=this.bindParameters.camera,h=this.renderingContext;let m=r,f=l/2,y=d/2;const v=this._blurParameters.blurRadius;for(let e=0;e<5;e++){const t=a.acquire(f,y,"bloomHorizontal",u.ColorFormat.RGBA16FLOAT);this._blurParameters.color=m,this._prepareFBO(t,f,y),h.bindTechnique(i,this.bindParameters,this._blurParameters),h.screen.draw();const r=a.acquire(f,y,"bloomVertical",u.ColorFormat.RGBA16FLOAT);this._blurParameters.color=t.getTexture(),this._prepareFBO(r,f,y),h.bindTechnique(s,this.bindParameters,this._blurParameters),h.screen.draw(),t.release(),this._bloomResults[e]=r,f=Math.ceil(f/2),y=Math.ceil(y/2),m=this._bloomResults[e].getTexture(),this._blurParameters.blurRadius*=this._blurScale}this._blurParameters.blurRadius=v,this._compositionParameters.color=o,this._compositionParameters.emission=r,this._compositionParameters.bloomTexture0=this._bloomResults[0].getTexture(),this._compositionParameters.bloomTexture1=this._bloomResults[1].getTexture(),this._compositionParameters.bloomTexture2=this._bloomResults[2].getTexture(),this._compositionParameters.bloomTexture3=this._bloomResults[3].getTexture(),this._compositionParameters.bloomTexture4=this._bloomResults[4].getTexture();const S=a.acquire(o.descriptor.width,o.descriptor.height,this.produces);return this._prepareFBO(S,l,d),h.bindTechnique(n,this.bindParameters,this._compositionParameters),h.screen.draw(),this._bloomResults.forEach((e=>e.release())),S.attachDepth(t.getAttachment(b.DepthStencilAttachment)),S.attachColor(t.getAttachment(b.ColorAttachment1),b.ColorAttachment1),S}_prepareFBO(e,t,r){const i=this.renderingContext;i.bindFramebuffer(e.fbo),i.setViewport(0,0,t,r),i.setClearColor(0,0,0,0),i.clear(b.FramebufferBit.COLOR)}get test(){return{compositionParameters:this._compositionParameters,blurParameters:this._blurParameters,setLodFactors:e=>{this._compositionParameters.lodFactors=y.normalizePreset(e)}}}},t.__decorate([s.property()],e.BloomRenderNode.prototype,"consumes",void 0),e.BloomRenderNode=t.__decorate([l.subclass("esri.views.3d.webgl-engine.effects.bloom.BloomRenderNode")],e.BloomRenderNode),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/BloomBlur.glsl":function(){define(["exports","../core/mathUtils","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/effects/bloom/BloomPresets.glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";var u;e.BlurDirection=void 0,(u=e.BlurDirection||(e.BlurDirection={}))[u.Horizontal=0]="Horizontal",u[u.Vertical=1]="Vertical",u[u.COUNT=2]="COUNT";class d extends l.NoParameters{constructor(){super(...arguments),this.blurRadius=a.blurRadiusPresets.sunny}}function h(a){const l=new c.ShaderBuilder,u=l.fragment;l.include(r.ScreenSpacePass),u.include(i.Gamma),u.uniforms.add(new o.Texture2DPassUniform("colorTexture",(e=>e.color)),new s.FloatPassUniform("blurRadius",(e=>e.blurRadius)));let d="";for(let e=0;e<15;e++)d+=`locations1D[${e}] = ${(e/14*2-1).toFixed(3).toString()};`;let h="";for(let e=0;e<15;e++)h+=`locations1DWeights[${e}] = ${t.gauss(e-Math.floor(7.5),2).toFixed(7).toString()};`;const p=a.bloomStage===e.BlurDirection.Horizontal;return u.code.add(n.glsl`
    float locations1D[${n.glsl.int(15)}];
    float locations1DWeights[${n.glsl.int(15)}];

    vec4 blurUniformSamples(sampler2D toBlur) {
      vec4 res = vec4(0.0);
      vec2 size = vec2(textureSize(toBlur, 0));
      vec2 aspectCorrection = vec2(1.0, size.x / size.y);
      vec2 uvInPixel = uv * size;

      ${d}
      ${h}
      vec2 pixelCenterShift = 0.5 / size;

      for(int i=0;i < ${n.glsl.int(15)}; i++) {
        float uv1D = locations1D[i] + ${p?"pixelCenterShift.x":"pixelCenterShift.y"};
        vec2 uvOffset = ${p?"vec2(uv1D, 0.0)":"vec2(0.0, uv1D)"};

        vec2 uvDistorted = uv + uvOffset * blurRadius * aspectCorrection;
        vec4 sampleColor = texture(toBlur, uvDistorted);
        res += vec4(linearizeGamma(sampleColor.rgb), sampleColor.a)  * locations1DWeights[i];
      }
      res.a = clamp(res.a, 0.0, 1.0);
      return delinearizeGamma(res);
    }
  `).main.add(n.glsl`fragColor = blurUniformSamples(colorTexture);`),l}const p=Object.freeze(Object.defineProperty({__proto__:null,BloomBlurPassParameters:d,get BlurDirection(){return e.BlurDirection},build:h},Symbol.toStringTag,{value:"Module"}));e.BloomBlur=p,e.BloomBlurPassParameters=d,e.build=h}))},"esri/views/3d/webgl-engine/effects/bloom/BloomPresets.glsl":function(){define(["exports"],(function(e){"use strict";class t{constructor(e,t){this.near=e,this.far=t,this.near=i(e),this.far=i(t)}}const r={sunny:new t([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),cloudy:new t([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),rainy:new t([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),snowy:new t([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),foggy:new t([.15,.05,.01,0,0],[1,.8,.6,.4,.2])};function i(e,t=1){const r=e[0]+e[1]+e[2]+e[3]+e[4];return r<t?e:[e[0]/r,e[1]/r,e[2]/r,e[3]/r,e[4]/r]}e.blurRadiusPresets={sunny:.0022,cloudy:.0022,rainy:.0022,snowy:.0022,foggy:.0022},e.defaultExposure=2.6,e.lodFactorsPresets=r,e.normalizePreset=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/bloom/BloomBlurTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/BloomBlur.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.BloomBlur,(()=>new Promise(((t,r)=>e(["./BloomBlur.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.BloomBlurTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/bloom/BloomBlurTechniqueConfiguration":function(){define(["exports","../../../../../chunks/tslib.es6","../../core/shaderTechnique/ShaderTechniqueConfiguration","../../../../../chunks/BloomBlur.glsl"],(function(e,t,r,i){"use strict";class s extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.bloomStage=i.BlurDirection.Horizontal}}t.__decorate([r.parameter({count:i.BlurDirection.COUNT})],s.prototype,"bloomStage",void 0),e.BloomBlurTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/BloomComposition.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/FloatsPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/IntegerPassUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/effects/bloom/BloomPresets.glsl","../views/3d/webgl-engine/shaders/ToneMapping.glsl","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";class p extends d.NoParameters{constructor(e=c.defaultExposure,t=c.lodFactorsPresets.sunny.far,r=c.lodFactorsPresets.sunny.near){super(),this.exposure=e,this.lodFactors=t,this.lodFactorsFront=r}}const m=new p;class f extends p{constructor(){super(...arguments),this.bloomLod=-1}}function g(){const e=new h.ShaderBuilder,c=e.fragment;return e.include(t.ScreenSpacePass),c.include(i.Gamma),c.include(r.ReadDepth),c.include(u.ToneMapping),c.uniforms.add(new l.Texture2DPassUniform("colorTexture",(e=>e.color)),new l.Texture2DPassUniform("emissionTexture",(e=>e.emission)),new l.Texture2DPassUniform("bloomTexture0",(e=>e.bloomTexture0)),new l.Texture2DPassUniform("bloomTexture1",(e=>e.bloomTexture1)),new l.Texture2DPassUniform("bloomTexture2",(e=>e.bloomTexture2)),new l.Texture2DPassUniform("bloomTexture3",(e=>e.bloomTexture3)),new l.Texture2DPassUniform("bloomTexture4",(e=>e.bloomTexture4)),new s.FloatPassUniform("exposure",(e=>e.exposure)),new a.IntegerPassUniform("bloomLod",(e=>e.bloomLod)),new n.FloatsPassUniform("lodFactors",(e=>e.lodFactors),5),new n.FloatsPassUniform("lodFactorsFront",(e=>e.lodFactorsFront),5)).main.add(o.glsl`vec4 color = texture(colorTexture, uv);
color = vec4(linearizeGamma(color.rgb), color.a);
vec4 lod0 = texture(bloomTexture0, uv);
lod0 = vec4(linearizeGamma(lod0.rgb), lod0.a);
vec4 lod1 = texture(bloomTexture1, uv);
lod1 = vec4(linearizeGamma(lod1.rgb), lod1.a);
vec4 lod2 = texture(bloomTexture2, uv);
lod2 = vec4(linearizeGamma(lod2.rgb), lod2.a);
vec4 lod3 = texture(bloomTexture3, uv);
lod3 = vec4(linearizeGamma(lod3.rgb), lod3.a);
vec4 lod4 = texture(bloomTexture4, uv);
lod4 = vec4(linearizeGamma(lod4.rgb), lod4.a);
vec4 blur = lodFactors[0] * lod0;
blur += lodFactors[1] * lod1;
blur += lodFactors[2] * lod2;
blur += lodFactors[3] * lod3;
blur += lodFactors[4] * lod4;
blur = bloomLod == 0 ? lodFactors[0] * lod0 : bloomLod == 1 ? lodFactors[1] * lod1 : bloomLod == 2 ? lodFactors[2] * lod2 : bloomLod == 3 ? lodFactors[3] * lod3 : bloomLod == 4 ? lodFactors[4] * lod4 : blur;
vec4 emission = texture(emissionTexture, uv);
emission = vec4(linearizeGamma(emission.rgb), emission.a);
emission += blur;
emission = vec4(tonemapACES(emission.rgb), emission.a);
fragColor = emission + color;
fragColor = delinearizeGamma(fragColor);`),e}const y=Object.freeze(Object.defineProperty({__proto__:null,BloomCompositionPassParameters:f,build:g,defaultCompositionParameters:m},Symbol.toStringTag,{value:"Module"}));e.BloomComposition=y,e.BloomCompositionPassParameters=f,e.build=g,e.defaultCompositionParameters=m}))},"esri/views/3d/webgl-engine/effects/bloom/BloomCompositionTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/BloomComposition.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.BloomComposition,(()=>new Promise(((t,r)=>e(["./BloomComposition.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.BloomCompositionTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/geometry/ObjectAndLayerIDRenderNode":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../webgl/RenderNode","../../core/shaderLibrary/ShaderOutput","../../core/shaderLibrary/hud/HUDRenderStyle","../../../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.ObjectAndLayerIDRenderNode=class extends l{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find((({name:e})=>"olid"===e)),r=this.renderingContext;return r.bindFramebuffer(t.fbo),r.clearFramebuffer(a.ZEROS,!0,!0),this.view.stage.renderer.renderAllGeometry(c.ShaderOutput.ObjectAndLayerIdColor),r.clear(d.FramebufferBit.DEPTH|d.FramebufferBit.STENCIL),this.view.stage.renderer.renderHUD(u.HUDRenderStyle.NotOccluded),t}},t.__decorate([r.property()],e.ObjectAndLayerIDRenderNode.prototype,"consumes",void 0),t.__decorate([r.property()],e.ObjectAndLayerIDRenderNode.prototype,"produces",void 0),e.ObjectAndLayerIDRenderNode=t.__decorate([o.subclass("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],e.ObjectAndLayerIDRenderNode),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/geometry/RenderOccludedRenderNode":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/PooledArray","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../webgl","../../../webgl/RenderNode","../../core/FBOCacheFormats","../blit/Blit","../../lib/Material","../../lib/RenderSlot","../../shaders/CompositingTechniqueConfiguration","../../../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g){"use strict";e.RenderOccludedRenderNode=class extends u{constructor(e){super(e),this.consumes={required:[c.InternalRenderCategory.OCCLUDED]},this.produces=c.InternalRenderCategory.OCCLUDED,this._blit=new h.Blit(e.view.stage.renderView.techniques,f.BlitMode.PremultipliedAlpha)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forAll((t=>{e.precompileSlots(t,m.RenderSlot.OCCLUDED_GROUND,m.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL),t.material&&e.precompileOccludedSlots(t,_)}))}render(e){const t=e.find((({name:e})=>e===this.produces));return this._renderOccludedAndTransparentStencil(t),this._renderOccludedComposite(t),t}_renderOccludedAndTransparentStencil(e){const t=this.view.stage.renderer,r=y;r.clear();for(const e of t.plugins.plugins)e.renderOccludedFlags&p.RenderOccludedFlag.OccludeAndTransparentStencil&&r.push(e);0!==r.length&&(t.renderSlots(r,m.RenderSlot.OCCLUDER_MATERIAL),this._renderAndComposite(e,e.getAttachment(g.DepthStencilAttachment),.5,(()=>t.renderSlots(r,m.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL)),!1,!1),r.clear())}_renderOccludedComposite(e){const t=this.view.stage.renderer,r=y;r.clear();let i=0;for(const e of t.plugins.plugins){const t=e.renderOccludedFlags&b;i|=t,t&&r.push(e)}if(!i)return void r.clear();const s=this._getDepthStencilAttachment(e);let n=s.clearStencil;for(const o of _)i&o&&(this._renderAndComposite(e,s.depth,o===p.RenderOccludedFlag.Opaque?1:.5,(()=>t.renderOccludedSlots(r,o)),!0,n),n=!1);s.release(),r.clear()}_renderAndComposite(e,t,r,i,s,n){const o=this.renderingContext,{width:a,height:c}=e.fbo,u=this.fboCache.acquire(a,c,"tmp color");u.attachDepth(t),o.bindFramebuffer(u.fbo),o.clearFramebuffer(l.ZEROS,s,n),i(),u.detachDepth(),this._blit.blend(o,u,e,this.bindParameters,r),u.release()}_getDepthStencilAttachment(e){const{width:t,height:r}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const e=this.fboCache.acquireDepth(d.DepthFormat.DEPTH24_STENCIL8,t,r,"retained stencil");return{depth:e,release:()=>e.release(),clearStencil:!0}}const i=this.fboCache.acquire(t,r,"retained stencil",d.DepthFormat.DEPTH24_STENCIL8);return this.renderingContext.blitFramebuffer(e.fbo,i.fbo,g.FramebufferBit.STENCIL),{depth:i.getAttachment(g.DepthStencilAttachment),release:()=>i.release(),clearStencil:!1}}},t.__decorate([i.property()],e.RenderOccludedRenderNode.prototype,"consumes",void 0),t.__decorate([i.property()],e.RenderOccludedRenderNode.prototype,"produces",void 0),e.RenderOccludedRenderNode=t.__decorate([a.subclass("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],e.RenderOccludedRenderNode);const y=new r,_=[p.RenderOccludedFlag.OccludeAndTransparent,p.RenderOccludedFlag.Transparent,p.RenderOccludedFlag.Opaque],b=_.reduce(((e,t)=>e|t),p.RenderOccludedFlag.None);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/blit/Blit":function(){define(["exports","../../../../../chunks/Compositing.glsl","../../shaders/CompositingTechnique","../../shaders/CompositingTechniqueConfiguration","../../../../webgl/enums"],(function(e,t,r,i,s){"use strict";e.Blit=class{constructor(e,s=i.BlitMode.None){this._techniques=e,this._parameters=new t.CompositingPassParameters,this._configuration=new i.CompositingTechniqueConfiguration,this._configuration.blitMode=s,e.precompile(r.CompositingTechnique,this._configuration)}blit(e,t,i,n){e.bindFramebuffer(i.fbo),e.setClearColor(0,0,0,1),e.clear(s.FramebufferBit.COLOR),this._parameters.texture=t.getTexture();const o=this._techniques.get(r.CompositingTechnique,this._configuration);e.bindTechnique(o,n,this._parameters),e.screen.draw()}blend(e,t,i,s,n=1){this._configuration.hasOpacityFactor=n<1;const o=this._techniques.get(r.CompositingTechnique,this._configuration);return!!o.compiled&&(e.bindFramebuffer(i.fbo),this._parameters.texture=t.getTexture(),this._parameters.opacity=n,e.bindTechnique(o,s,this._parameters),e.screen.draw(),!0)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Compositing.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderModules/Float2BindUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/shaders/CompositingTechniqueConfiguration","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d extends c.NoParameters{constructor(){super(...arguments),this.opacity=1}}function h(e){const c=new u.ShaderBuilder;c.include(t.ScreenSpacePass),c.fragment.uniforms.add(new a.Texture2DPassUniform("tex",(e=>e.texture))),e.hasOpacityFactor&&c.fragment.uniforms.add(new n.FloatPassUniform("opacity",(e=>e.opacity)));const d=e.blitMode===l.BlitMode.Depth;return d&&(c.fragment.uniforms.add(new s.Float2BindUniform("nearFar",(e=>e.camera.nearFar))),c.fragment.include(r.ReadDepth),c.fragment.include(i.RgbaFloatEncoding)),c.fragment.main.add(o.glsl`
    ${d?o.glsl`
          float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);
          fragColor = float2rgba(normalizedLinearDepth);`:o.glsl`
          fragColor = texture(tex, uv) ${e.hasOpacityFactor?"* opacity":""};`}`),c}const p=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:d,build:h},Symbol.toStringTag,{value:"Module"}));e.Compositing=p,e.CompositingPassParameters=d,e.build=h}))},"esri/views/3d/webgl-engine/shaders/CompositingTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";var i;e.BlitMode=void 0,(i=e.BlitMode||(e.BlitMode={}))[i.None=0]="None",i[i.Alpha=1]="Alpha",i[i.PremultipliedAlpha=2]="PremultipliedAlpha",i[i.Depth=3]="Depth",i[i.COUNT=4]="COUNT";class s extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.blitMode=e.BlitMode.None,this.hasOpacityFactor=!1}}t.__decorate([r.parameter({count:e.BlitMode.COUNT})],s.prototype,"blitMode",void 0),t.__decorate([r.parameter()],s.prototype,"hasOpacityFactor",void 0),e.CompositingTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/CompositingTechnique":function(){define(["require","exports","../../../../core/compilerUtils","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../../chunks/Compositing.glsl","./CompositingTechniqueConfiguration","../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends s.ShaderTechnique{constructor(t,r){super(t,r,new i.ReloadableShaderModule(n.Compositing,(()=>new Promise(((t,r)=>e(["./Compositing.glsl"],t,r))))))}initializePipeline(e){switch(e.blitMode){case o.BlitMode.None:case o.BlitMode.Depth:return a.makePipelineState({colorWrite:a.defaultColorWrite});case o.BlitMode.Alpha:return a.makePipelineState({blending:a.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:a.defaultColorWrite});default:r.neverReached(e.blitMode);case o.BlitMode.PremultipliedAlpha:case o.BlitMode.COUNT:return a.makePipelineState({blending:a.premultipliedAlpha,colorWrite:a.defaultColorWrite})}}}t.CompositingTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/haze/Haze":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/Logger","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/vec2","../../../../../chunks/vec32","../../../../../chunks/vec42","../../../../../geometry/support/Ellipsoid","../../../webgl","../../core/FBOCacheFormats","../TransparentEnvironment","../../../../../chunks/HazeCompositing.glsl","./HazeCompositingTechnique","./HazeTechnique","./HazeTechniqueConfiguration","../../lib/glUtil3D","../../lib/textureUtils","../../../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x){"use strict";e.Haze=class extends g.TransparentEnvironment{constructor(e){super(e),this._compositingPassParameters=new y.HazeCompositingPassParameters,this._passParameters=new b.HazePassParameters,this._hazeConfiguration=new v.HazeTechniqueConfiguration,this._vao=null,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const t=e.view.stage.renderView.techniques;t.precompile(b.HazeTechnique,new v.HazeTechniqueConfiguration);const r=new v.HazeTechniqueConfiguration;r.reduced=!0,t.precompile(b.HazeTechnique,r),t.precompile(_.HazeCompositingTechnique)}initialize(){this.addHandles([s.watch((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),s.syncAndInitial),s.watch((()=>this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1),(e=>this._fade(e)),s.syncAndInitial),s.watch((()=>this.view.environment.weather.type),(e=>this._newAmount="rainy"===e?0:1),s.syncAndInitial),s.watch((()=>this.view.stage.renderer?.fullResolutionAtmosphere),(e=>this._hazeConfiguration.reduced=!e),s.syncAndInitial)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:r.lerp(this._oldAmount,this._newAmount,e)}destroy(){this._vao=i.disposeMaybe(this._vao)}render(e){const t=e.find((({name:e})=>e===m.InternalRenderCategory.TRANSPARENT_ENVIRONMENT));if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=S.createQuadVAO(i,S.Layout.Pos2Tex);const s=this.techniques.get(b.HazeTechnique,this._hazeConfiguration);if(!s.compiled)return t;const n=t.getAttachment(x.DepthStencilAttachment);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(n),t;const o=this.techniques.get(_.HazeCompositingTechnique);if(!o.compiled)return t;const a=i.getViewport(),l=this.camera,c=d.length(l.eye)-p.earth.radius;let u;const h=p.earth.atmosphereHeight;if(c<h){const e=Math.min(1,Math.max(0,c/h));u=r.lerp(.4,.5,e)}else{const e=Math.min(1,Math.max(0,(c-h)/(15*h)));u=r.lerp(.5,1,e)}const g=this.renderingContext.parameters.maxTextureSize,y=w.applyTextureResizeModulo(Math.round(u*l.fullViewport[2]),g),v=w.applyTextureResizeModulo(Math.round(u*l.fullViewport[3]),g);i.setViewport(0,0,y,v);const T=this.fboCache.acquire(y,v,"haze",f.ColorFormat.RGBA8UNORM);return i.bindFramebuffer(T.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(s,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=T.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(o,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(n),T.release(),t}_renderCommon(e){null!=this._vao&&(e.bindVAO(this._vao),e.drawArrays(x.PrimitiveType.TRIANGLE_STRIP,0,4))}_update(){const e=this.bindParameters.camera,t=d.squaredLength(e.eye),i=Math.sqrt(t),s=t-this._passParameters.radii[1]*this._passParameters.radii[1],n=r.clamp((i-this._passParameters.radii[0])/p.earth.atmosphereHeight,0,1);h.set(this._passParameters.heightParameters,i,t,s,n);const o=this.view.basemapTerrain?.getLowerBoundRadius()??0;u.set(this._passParameters.radii,o,o+p.earth.atmosphereHeight),this._passParameters.hazeStrength=r.lerp(r.lerp(.6,1,r.smoothstep(9500,10500,i-p.earth.radius)),1,this._amount)}},e.Haze=t.__decorate([c.subclass("esri.views.3d.webgl-engine.effects.haze.Haze")],e.Haze),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/HazeCompositing.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o){"use strict";class a extends n.NoParameters{}function l(){const e=new o.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new s.Texture2DPassUniform("colorTexture",(e=>e.color)),new i.Texture2DBindUniform("depthTexture",(e=>e.mainDepth))),e.fragment.main.add(r.glsl`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const c=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:a,build:l},Symbol.toStringTag,{value:"Module"}));e.HazeCompositing=c,e.HazeCompositingPassParameters=a,e.build=l}))},"esri/views/3d/webgl-engine/effects/haze/HazeCompositingTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/HazeCompositing.glsl","../../../../webgl/enums","../../../../webgl/renderState"],(function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.HazeCompositing,(()=>new Promise(((t,r)=>e(["./HazeCompositing.glsl"],t,r))))))}initializePipeline(){return o.makePipelineState({blending:o.separateBlendingParams(n.BlendFactor.ONE,n.BlendFactor.ZERO,n.BlendFactor.ONE_MINUS_SRC_COLOR,n.BlendFactor.ONE),depthTest:{func:n.CompareFunction.ALWAYS},colorWrite:o.defaultColorWrite})}}t.HazeCompositingTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/haze/HazeTechnique":function(){define(["require","exports","../../../environment/ChapmanApproximation.glsl","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/Haze.glsl","../../../../webgl/enums","../../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends r.ChapmanApproximationParameters{constructor(){super(...arguments),this.hazeStrength=1}}class c extends s.ShaderTechnique{constructor(t,r){super(t,r,new i.ReloadableShaderModule(n.Haze,(()=>new Promise(((t,r)=>e(["./Haze.glsl"],t,r))))))}initializePipeline(e){return e.reduced?a.makePipelineState({blending:a.copySource,depthTest:{func:o.CompareFunction.ALWAYS},colorWrite:a.defaultColorWrite}):a.makePipelineState({blending:a.separateBlendingParams(o.BlendFactor.ONE,o.BlendFactor.ZERO,o.BlendFactor.ONE_MINUS_SRC_COLOR,o.BlendFactor.ONE),colorWrite:a.defaultColorWrite})}}t.HazePassParameters=l,t.HazeTechnique=c,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Haze.glsl":function(){define(["exports","../views/3d/environment/ChapmanRaymarching.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/ReadDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/Gamma.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/MainLighting.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/shaders/ScreenSpacePassAtmosphere.glsl","../views/3d/webgl-engine/shaders/SphereIntersect.glsl","../views/3d/webgl-engine/shaders/ToneMapping.glsl","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";function h(e){const h=new d.ShaderBuilder,{fragment:p}=h;h.include(l.ScreenSpacePassAtmosphere),s.addMainLightDirection(p),p.include(i.Gamma),p.include(r.ReadDepth),p.include(c.SphereIntersect),p.include(u.ToneMapping),p.include(t.ChapmanRaymarching,!0),p.uniforms.add(new a.Texture2DBindUniform("depthTexture",(e=>e.mainDepth)),new n.FloatPassUniform("hazeStrength",(e=>e.hazeStrength)));const{reduced:m}=e;return m&&p.code.add(o.glsl`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),p.main.add(o.glsl`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${o.If(m,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),h}const p=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}));e.Haze=p,e.build=h}))},"esri/views/3d/webgl-engine/effects/haze/HazeTechniqueConfiguration":function(){define(["exports","../../../../../chunks/tslib.es6","../../core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.reduced=!1}}t.__decorate([r.parameter()],i.prototype,"reduced",void 0),e.HazeTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/highlight/ShadowHighlight":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/colorUtils","../../../../../core/mathUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../ViewingMode","../../../webgl","../../../webgl/RenderNode","./ShadowHighlightTechnique","../../lib/basicInterfaces","../../../../support/HighlightDefaults"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";const _=1/512;e.ShadowHighlight=class extends m{constructor(e){super(e),this.produces=p.RenderCategory.COMPOSITE,this.consumes={required:[p.RenderCategory.COMPOSITE,"highlights"]},this._passParameters=new f.ShadowHighlightPassParameters,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([s.watch((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=e??y.defaultShadowOpacity,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),s.syncAndInitial),s.watch((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=e??y.defaultShadowDifference,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),s.syncAndInitial),s.watch((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=r.unitRGBAFromColor(e??y.defaultShadowColor),this._ensureMaxOpacity()}),s.syncAndInitial)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(g.RenderRequestType.UPDATE)}precompile(){this.techniques.precompile(f.ShadowHighlightTechnique)}render(e){const t=e.find((({name:e})=>e===p.RenderCategory.COMPOSITE)),r=this.bindParameters;if(!r.shadowHighlightsVisible||!r.depth||!this._ensureIfVisible(r.camera,r.lighting.mainLight.direction))return t;const i=this.techniques.get(f.ShadowHighlightTechnique);if(i.compiled){this._passParameters.highlightTexture=e.find((({name:e})=>"highlights"===e))?.getTexture(),this._passParameters.origin=r.camera.center;const s=this.renderingContext;s.bindFramebuffer(t.fbo),s.bindTechnique(i,r,this._passParameters),s.screen.draw()}else this.requestRender(g.RenderRequestType.UPDATE);return t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-i.smoothstep(4e4,5e4,e.relativeElevation);const r=this.viewingMode===h.ViewingMode.Global?u.normalize(b,e.center):u.set(b,0,0,1),s=u.dot(r,t);return this._passParameters.dayNightTerminator=i.smoothstep(0,1,i.clamp(30*s,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=_}},t.__decorate([n.property()],e.ShadowHighlight.prototype,"produces",void 0),t.__decorate([n.property()],e.ShadowHighlight.prototype,"consumes",void 0),t.__decorate([n.property({constructOnly:!0})],e.ShadowHighlight.prototype,"viewingMode",void 0),e.ShadowHighlight=t.__decorate([c.subclass("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],e.ShadowHighlight);const b=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/highlight/ShadowHighlightTechnique":function(){define(["require","exports","../../../../../core/libs/gl-matrix-2/factories/vec4f64","../../core/shaderLibrary/shading/ReadShadowMap.glsl","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/ShadowHighlight.glsl","../../../../webgl/enums","../../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends i.ReadShadowMapPassParameters{constructor(){super(...arguments),this.shadowColor=r.fromValues(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class u extends n.ShaderTechnique{constructor(t,r){super(t,r,new s.ReloadableShaderModule(o.ShadowHighlight,(()=>new Promise(((t,r)=>e(["../../shaders/ShadowHighlight.glsl"],t,r)))))),this.primitiveType=a.PrimitiveType.TRIANGLE_STRIP}initializePipeline(){return l.makePipelineState({blending:l.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:l.defaultColorWrite,depthTest:null,depthWrite:null})}}t.ShadowHighlightPassParameters=c,t.ShadowHighlightTechnique=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/ShadowHighlight.glsl":function(){define(["exports","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../views/3d/webgl-engine/core/shaderLibrary/NormalFromDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/calculateUVZShadowFromDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ShadowmapFiltering.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderModules/Float3BindUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DShadowBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DUintPassUniform","../views/3d/webgl-engine/lib/ShadowMap","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g){"use strict";function y(){const e=new g.ShaderBuilder;e.include(n.calculateUVZShadowFromDepthPass),e.include(o.ShadowmapFiltering),e.include(s.ScreenSpacePass),e.include(i.NormalFromDepth);const r=e.fragment;return r.include(a.RgbaFloatEncoding),r.uniforms.add(new p.Texture2DShadowBindUniform("shadowMapExcludingHighlight",(e=>e.shadowMap.getSnapshot(f.SnapshotSlot.ExcludeHighlight))),new p.Texture2DShadowBindUniform("shadowMapHighlight",(e=>e.shadowMap.getSnapshot(f.SnapshotSlot.Highlight))),new h.Texture2DBindUniform("depthMap",(e=>e.depth?.attachment)),new m.Texture2DUintPassUniform("highlightTexture",(e=>e.highlightTexture)),new c.Float4PassUniform("uColor",(e=>e.shadowColor)),new u.FloatPassUniform("opacity",(e=>e.shadowOpacity)),new u.FloatPassUniform("occludedOpacity",(e=>e.occludedShadowOpacity)),new u.FloatPassUniform("terminationFactor",(e=>e.opacityElevation*e.dayNightTerminator)),new l.Float3BindUniform("lightingMainDirectionView",(({lighting:e,camera:r})=>t.normalize(_,t.transformMat4(_,e.mainLight.direction,r.viewInverseTransposeMatrix))))),r.main.add(d.glsl`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    uvec2 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0).rg;

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    uint ored = (highlightInfo.r << 0) | (highlightInfo.g << 8);

    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1u+4u+16u+64u)) != 0u;
    if (visiblyHighlighted) {
      return;
    }

    vec4 currentPixelPos;
    vec3 uvzShadow = calculateUVZShadowAndPixelPosFromDepth(uv, textureSize(shadowMapHighlight,0), depthMap, currentPixelPos);
    if (uvzShadow.z < 0.0) {
      return;
    }

    float shadowHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapHighlight);
    if (shadowHighlightFactor == 0.0) {
      return;
    }

    float shadowExcludingHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapExcludingHighlight);

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${d.glsl.float(.025)};

    float occludedFactor = max(shadowExcludingHighlightFactor, shaded ? 1.0 : 0.0);
    float fragOpacity = mix(opacity, occludedOpacity, occludedFactor);
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),e}const _=r.create(),b=Object.freeze(Object.defineProperty({__proto__:null,build:y},Symbol.toStringTag,{value:"Module"}));e.ShadowHighlight=b,e.build=y}))},"esri/views/3d/webgl-engine/core/shaderLibrary/NormalFromDepth.glsl":function(){define(["exports","./output/ReadDepth.glsl","./util/CameraSpace.glsl","../shaderModules/glsl"],(function(e,t,r,i){"use strict";e.NormalFromDepth=function(e){const s=e.fragment;e.include(r.CameraSpace),s.include(t.ReadDepth),s.code.add(i.glsl`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/shaderLibrary/shading/calculateUVZShadowFromDepth.glsl":function(){define(["exports","../../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../../core/libs/gl-matrix-2/factories/mat4f64","../output/ReadDepth.glsl","./calculateUVZShadow.glsl","../util/CameraSpace.glsl","../../shaderModules/glsl","../../shaderModules/Matrix4BindUniform"],(function(e,t,r,i,s,n,o,a){"use strict";function l(e){e.fragment.include(i.ReadDepth),e.include(n.CameraSpace),e.fragment.uniforms.add(new a.Matrix4BindUniform("inverseViewMatrix",(({camera:e})=>t.invert(c,t.translate(c,e.viewMatrix,e.center))))).code.add(o.glsl`vec3 calculateUVZShadowAndPixelPosFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap,
out vec4 currentPixelPos
) {
float depth = depthFromTexture(_depthMap, _uv);
if (depth >= 1.0 || depth <= 0.0) {
return invalidShadowmapUVZ;
}
float currentPixelDepth = linearizeDepth(depth);
currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
float linearDepth = -currentPixelDepth;
return calculateUVZShadow(worldSpacePos.xyz, linearDepth, shadowMapSize);
}
vec3 calculateUVZShadowFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap
) {
vec4 currentPixelPos;
return calculateUVZShadowAndPixelPosFromDepth(_uv, shadowMapSize, _depthMap, currentPixelPos);
}`)}const c=r.create();e.calculateUVZShadowFromDepthDraw=function(e){e.include(s.calculateUVZShadowDraw),l(e)},e.calculateUVZShadowFromDepthPass=function(e){e.include(s.calculateUVZShadowPass),l(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/magnifier/Magnifier":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/asyncUtils","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/reactiveUtils","../../../../../core/screenUtils","../../../../../core/urlUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../../webgl","../../../webgl/RenderNode","./MagnifierTechnique","../../lib/basicInterfaces","../../lib/DefaultVertexAttributeLocations","../../lib/glUtil3D","../../../../../chunks/Magnifier.glsl","../../../../magnifier/resources","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T){"use strict";e.Magnifier=class extends f{constructor(){super(...arguments),this.produces=m.InternalRenderCategory.MAGNIFIER,this.consumes={required:[m.InternalRenderCategory.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new v.MagnifierPassParameters,this._vao=null,this._magnifier=null,this._tmpScreenPoint=o.createScreenPointArray(),this._tmpRenderPoint=o.createRenderScreenPointArray()}initialize(){this.addHandles([n.watch((()=>this.view.magnifier),(e=>this._update(e)),n.syncAndInitial)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const e=this._validMagnifier;e?(this._loadResources(e),this.produces=m.InternalRenderCategory.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(n.watch((()=>this._magnifier?.version),t)),t()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=s.disposeMaybe(this._vao)}_disposeTextures(){this._passParameters.mask=s.disposeMaybe(this._passParameters.mask),this._passParameters.overlay=s.disposeMaybe(this._passParameters.overlay),this._passParameters.input=s.disposeMaybe(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(g.MagnifierTechnique)}render(e){const t=this._validMagnifier,r=e.find((({name:e})=>e===m.InternalRenderCategory.MAGNIFIER));if(null==t)return r;if(null==this._imageSources)return this.requestRender(y.RenderRequestType.UPDATE),r;const s=this.renderingContext,n=this.camera.pixelRatio,a=Math.ceil(n*t.size);this._vao??=b.createQuadVAO(s,b.Layout.Pos2,_.Default3D,0,1);const l=this.techniques.get(g.MagnifierTechnique);if(this._ensureTextureResources(s,a),!l.compiled||!this._passParameters.input)return this.requestRender(y.RenderRequestType.UPDATE),r;const c=Math.ceil(1/this._factor*a),u=this._passParameters.input;u.resize(c,c),o.screenPointObjectToArray(t.position,this._tmpScreenPoint);const d=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),h=this.camera.fullWidth,p=this.camera.fullHeight,f=.5*c,v=.5*c;d[0]=i.clamp(d[0],f,h-f-1),d[1]=i.clamp(d[1],v,p-v-1);const S=Math.floor(d[0]-f),x=Math.floor(d[1]-v);return s.bindFramebuffer(r.fbo),l.program.bindTexture("textureInput",u),s.gl.copyTexImage2D(u.descriptor.target,0,u.descriptor.pixelFormat,S,x,c,c,0),this._passParameters.magnifier=t,s.bindTechnique(l,this.bindParameters,this._passParameters),s.bindVAO(this._vao),s.drawArrays(w.PrimitiveType.TRIANGLE_STRIP,0,4),r}_loadResources(e){const{maskUrl:t,overlayUrl:i}=e;this._imageLoadTask?.maskUrl===t&&this._imageLoadTask?.overlayUrl===i||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:r.createTask((async e=>{const r=null==t||null==i?S.loadMagnifierResources(e):null,s=null!=t?p.requestImage(t,{signal:e}):r.then((e=>e.mask)),n=null!=i?p.requestImage(i,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await s,overlay:await n}}))})}_ensureTextureResources(e,t){null==this._imageSources||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t,this._passParameters.overlay=new x.Texture(e,this._createTextureDescriptor(t,w.PixelFormat.RGBA,this._imageSources.overlay),this._imageSources.overlay),this._passParameters.mask=new x.Texture(e,this._createTextureDescriptor(t,w.PixelFormat.ALPHA,this._imageSources.mask),this._imageSources.mask),this._passParameters.input=new x.Texture(e,this._createTextureDescriptor(t,w.PixelFormat.RGBA,null)))}_createTextureDescriptor(e,t,r){const i=this.renderingContext,s=new T.TextureDescriptor(e,e);return s.pixelFormat=s.internalFormat=t,s.wrapMode=w.TextureWrapMode.CLAMP_TO_EDGE,s.flipped=!!r,s.preMultiplyAlpha=!(t!==w.PixelFormat.RGBA||!r||a.isSVG(r.src)&&i.driverTest.svgPremultipliesAlpha.result),s}},t.__decorate([l.property()],e.Magnifier.prototype,"produces",void 0),t.__decorate([l.property()],e.Magnifier.prototype,"consumes",void 0),t.__decorate([l.property()],e.Magnifier.prototype,"_imageSources",void 0),t.__decorate([l.property()],e.Magnifier.prototype,"_imageLoadTask",void 0),e.Magnifier=t.__decorate([h.subclass("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],e.Magnifier),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/magnifier/MagnifierTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/Magnifier.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.Magnifier,(()=>new Promise(((t,r)=>e(["../../shaders/Magnifier.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({blending:n.premultipliedAlpha,depthTest:null,depthWrite:null,colorWrite:n.defaultColorWrite})}}t.MagnifierTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Magnifier.glsl":function(){define(["exports","../core/screenUtils","./vec42","../core/libs/gl-matrix-2/factories/vec4f64","../views/3d/webgl-engine/core/shaderModules/BooleanPassUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/3d/webgl-engine/lib/VertexAttribute","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d extends c.NoParameters{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}}function h(){const e=new u.ShaderBuilder;return e.attributes.add(l.VertexAttribute.POSITION,"vec2"),e.vertex.uniforms.add(new n.Float4PassUniform("drawPosition",((e,i)=>function(e,i){const s=i.camera.pixelRatio,n=e.magnifier.offset.x*s,o=e.magnifier.offset.y*s;t.screenPointObjectToArray(e.magnifier.position,p);const a=i.camera.screenToRender(p,m),l=Math.ceil(s*e.magnifier.size),{fullWidth:c,fullHeight:u}=i.camera;return r.set(f,(a[0]+n)/c*2-1,(a[1]-o)/u*2-1,l/c*2,l/u*2)}(e,i)))),e.varyings.add("vUV","vec2"),e.vertex.main.add(o.glsl`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),e.fragment.uniforms.add(new a.Texture2DPassUniform("textureInput",(e=>e.input))),e.fragment.uniforms.add(new a.Texture2DPassUniform("textureMask",(e=>e.mask))),e.fragment.uniforms.add(new a.Texture2DPassUniform("textureOverlay",(e=>e.overlay))),e.fragment.uniforms.add(new s.BooleanPassUniform("maskEnabled",(e=>e.magnifier.maskEnabled))),e.fragment.uniforms.add(new s.BooleanPassUniform("overlayEnabled",(e=>e.magnifier.overlayEnabled))),e.fragment.code.add(o.glsl`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),e.fragment.main.add(o.glsl`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),e}const p=t.createScreenPointArray(),m=t.createRenderScreenPointArray(),f=i.create(),g=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:d,build:h},Symbol.toStringTag,{value:"Module"}));e.Magnifier=g,e.MagnifierPassParameters=d,e.build=h}))},"esri/views/magnifier/resources":function(){define(["require","exports","../../core/promiseUtils","../../support/requestImageUtils"],(function(e,t,r,i){"use strict";const s=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));t.loadMagnifierResources=async function(t){const n=new Promise(((t,r)=>e(["./mask-svg"],(e=>t(s(e))),r))),o=new Promise(((t,r)=>e(["./overlay-svg"],(e=>t(s(e))),r))),a=i.requestImage((await n).default,{signal:t}),l=i.requestImage((await o).default,{signal:t}),c={mask:await a,overlay:await l};return r.throwIfAborted(t),c},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/smaa/SMAA":function(){define(["require","exports","../../../../../chunks/tslib.es6","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/Logger","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../../webgl","../../../webgl/RenderNode","../../core/FBOCacheFormats","./SMAABlendWeightsTechnique","./SMAABlurTechnique","./SMAAEdgeDetectTechnique","./SMAAPassParameters","../../lib/basicInterfaces","../../../../webgl/enums","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w){"use strict";function x(e,t,r,i){const s=new w.TextureDescriptor;return s.pixelFormat=r,s.wrapMode=v.TextureWrapMode.CLAMP_TO_EDGE,s.width=i.width,s.height=i.height,s.samplingMode=t,new S.Texture(e,s,i)}t.SMAA=class extends p{constructor(e){super(e),this.produces="disabled",this.consumes={required:[h.InternalRenderCategory.ANTIALIASING],optional:[h.RenderCategory.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new _.SMAAPassParameters}initialize(){this.addHandles([n.watch((()=>this.isEnabled()),(e=>e?this.enable():this.disable()),n.syncAndInitial)])}async enable(){if(this.produces=h.InternalRenderCategory.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const t=this._abortController.signal;try{const r=await new Promise(((t,r)=>e(["./SMAAData"],t,r)));await this._loadTextures(r,t),this.requestRender(b.RenderRequestType.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,t){s.throwIfAborted(t);const[r,i]=await Promise.allSettled([d.requestImage(e.areaTexture,{signal:t}),d.requestImage(e.searchTexure,{signal:t})]);if(s.throwIfAborted(t),"fulfilled"!==r.status||"fulfilled"!==i.status)return;const n=this.renderingContext;this._areaTexture=x(n,v.TextureSamplingMode.LINEAR,v.PixelFormat.RGB,r.value),this._searchTexture=x(n,v.TextureSamplingMode.NEAREST,v.PixelFormat.LUMINANCE,i.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=i.disposeMaybe(this._searchTexture),this._areaTexture=i.disposeMaybe(this._areaTexture)}precompile(){this.techniques.precompile(y.SMAAEdgeDetectTechnique),this.techniques.precompile(f.SMAABlendWeightsTechnique),this.techniques.precompile(g.SMAABlurTechnique)}render(e){const t=e.find((({name:e})=>e===h.InternalRenderCategory.ANTIALIASING));if(!this._areaTexture||!this._searchTexture)return this.requestRender(b.RenderRequestType.UPDATE),t;const r=this.techniques.get(y.SMAAEdgeDetectTechnique),i=this.techniques.get(f.SMAABlendWeightsTechnique),s=this.techniques.get(g.SMAABlurTechnique);if(!r.compiled||!i.compiled||!s.compiled)return this.requestRender(b.RenderRequestType.UPDATE),t;const n=e.find((({name:e})=>e===h.RenderCategory.COMPOSITE));if(!n)return t;const o=n.fbo.width,a=n.fbo.height,l=this.renderingContext;l.setViewport(0,0,o,a);const c=this.fboCache.acquire(o,a,"smaa edges",m.ColorFormat.RG8UNORM);l.bindFramebuffer(c.fbo),l.setClearColor(0,0,0,1),l.clear(v.FramebufferBit.COLOR),this._smaaParameters.color=n.getTexture();const u=this.bindParameters;l.bindTechnique(r,u,this._smaaParameters),l.screen.draw();const d=this.fboCache.acquire(o,a,"smaa blend");return l.bindFramebuffer(d.fbo),l.setClearColor(0,0,1,1),l.clear(v.FramebufferBit.COLOR),this._smaaParameters.inputTexture=c.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(i,u,this._smaaParameters),l.screen.draw(),c.release(),l.bindFramebuffer(t.fbo),l.setClearColor(0,1,0,1),l.clear(v.FramebufferBit.COLOR),this._smaaParameters.inputTexture=d.getTexture(),l.bindTechnique(s,u,this._smaaParameters),l.screen.draw(),d.release(),t}},r.__decorate([o.property()],t.SMAA.prototype,"produces",void 0),r.__decorate([o.property()],t.SMAA.prototype,"consumes",void 0),r.__decorate([o.property({constructOnly:!0})],t.SMAA.prototype,"isEnabled",void 0),r.__decorate([o.property()],t.SMAA.prototype,"_abortController",void 0),t.SMAA=r.__decorate([u.subclass("esri.views.3d.webgl-engine.effects.smaa.SMAA")],t.SMAA),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/smaa/SMAABlendWeightsTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/BlendWeights.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.BlendWeights,(()=>new Promise(((t,r)=>e(["../../shaders/BlendWeights.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.SMAABlendWeightsTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/BlendWeights.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s){"use strict";function n(){const e=new s.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new i.Texture2DPassUniform("edgesTexture",(e=>e.inputTexture)),new i.Texture2DPassUniform("areaTexture",(e=>e.areaTexture)),new i.Texture2DPassUniform("searchTexture",(e=>e.searchTexture))),e.fragment.constants.add("smaaAreaTexPixelSize","vec2",[1/160,1/560]),e.fragment.code.add(r.glsl`
    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${r.glsl.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${r.glsl.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${r.glsl.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${r.glsl.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${r.glsl.int(16)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = smaaAreaTexPixelSize * texcoord + (0.5 * smaaAreaTexPixelSize);
      texcoord.y += ${r.glsl.float(1/7)} * offset;
      return texture(areaTex, texcoord).rg;
    }`),e.fragment.main.add(r.glsl`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${r.glsl.int(8)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),e}const o=Object.freeze(Object.defineProperty({__proto__:null,build:n},Symbol.toStringTag,{value:"Module"}));e.BlendWeights=o,e.build=n}))},"esri/views/3d/webgl-engine/effects/smaa/SMAABlurTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/Blur.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.Blur,(()=>new Promise(((t,r)=>e(["../../shaders/Blur.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.SMAABlurTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Blur.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s){"use strict";function n(){const e=new s.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new i.Texture2DPassUniform("blendWeightsTexture",(e=>e.inputTexture)),new i.Texture2DPassUniform("colorTexture",(e=>e.color))),e.fragment.main.add(r.glsl`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),e}const o=Object.freeze(Object.defineProperty({__proto__:null,build:n},Symbol.toStringTag,{value:"Module"}));e.Blur=o,e.build=n}))},"esri/views/3d/webgl-engine/effects/smaa/SMAAEdgeDetectTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/EdgeDetect.glsl","../../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.EdgeDetect,(()=>new Promise(((t,r)=>e(["../../shaders/EdgeDetect.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:n.defaultColorWrite})}}t.SMAAEdgeDetectTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/EdgeDetect.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s){"use strict";function n(){const e=new s.ShaderBuilder;return e.include(t.ScreenSpacePass),e.outputs.add("fragEdges","vec2"),e.fragment.code.add(r.glsl`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),e.fragment.uniforms.add(new i.Texture2DPassUniform("colorTexture",(e=>e.color))).main.add(r.glsl`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${r.glsl.float(.05)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${r.glsl.float(2)}) * delta);
    }
  `),e}const o=Object.freeze(Object.defineProperty({__proto__:null,build:n},Symbol.toStringTag,{value:"Module"}));e.EdgeDetect=o,e.build=n}))},"esri/views/3d/webgl-engine/effects/smaa/SMAAPassParameters":function(){define(["exports","../../../../webgl/NoParameters"],(function(e,t){"use strict";class r extends t.NoParameters{}e.SMAAPassParameters=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/stars/Stars":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../assets","../../../../../core/asyncUtils","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/reactiveUtils","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../webgl","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","../OpaqueEnvironment","./StarsTechnique","../../lib/basicInterfaces","../../lib/DefaultVertexAttributeLocations","../../lib/VertexArrayObject","../../lib/VertexAttribute","../../../../webgl/BufferObject","../../../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T){"use strict";e.Stars=class extends y.OpaqueEnvironment{constructor(){super(...arguments),this._starData=null,this._loadDataTask=null,this._numPoints=0,this._passParameters=new _.StarPassParameters}initialize(){this.addHandles([l.watch((()=>this.view.environment.starsEnabled),(e=>e?this._enable():this._disable()),l.initial),l.watch((()=>"virtual"===this.view.environment.lighting.type?null:this.view.environment.lighting.date),(e=>this._update(e)),l.syncAndInitial)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=o.abortMaybe(this._loadDataTask),this._numPoints=0,this._vao=o.disposeMaybe(this._vao),this._starData=null}precompile(){this.techniques.precompile(_.StarsTechnique)}render(e){const t=e.find((({name:e})=>e===m.InternalRenderCategory.OPAQUE_ENVIRONMENT)),r=this.renderingContext;if(this.loading)return this.requestRender(b.RenderRequestType.UPDATE),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,r);const i=this.techniques.get(_.StarsTechnique);return i.compiled?(r.bindTechnique(i,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(T.PrimitiveType.POINTS,0,this._numPoints),t):(this.requestRender(b.RenderRequestType.UPDATE),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/R,function(e,t,r,i){const s=E.createBuffer(i),n=s.position,o=s.color,a=s.size;for(let e=0;e<i;e++){const i=t[2*e],s=t[2*e+1];n.set(e,0,-Math.cos(i)*Math.sin(s)),n.set(e,1,-Math.sin(i)*Math.sin(s)),n.set(e,2,-Math.cos(s));const u=(c=r[e])>=192?[2.9,c-192]:c>=160?[2.5,c-160]:c>=128?[2,c-128]:c>=96?[1.5,c-96]:c>=64?[1,c-64]:c>=32?[.7,c-32]:[.4,c],d=(l=C[u[1]],[parseInt(l.slice(0,2),16),parseInt(l.slice(2,4),16),parseInt(l.slice(4,6),16)]);o.set(e,0,255*d[0]),o.set(e,1,255*d[1]),o.set(e,2,255*d[2]),o.set(e,3,255),a.set(e,u[0])}var l,c;return new S.VertexArrayObject(e,v.Default3D,new Map([["geometry",f.glLayout(E)]]),new Map([["geometry",x.BufferObject.createVertex(e,T.Usage.STATIC_DRAW,s.buffer)]]))}(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,r=2*function(e){const t=e,r=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+r)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+r)}(e),i=h.copy(this._passParameters.modelMatrix,M);h.rotateZ(i,i,-r*Math.PI),h.multiply(i,P,i),h.rotateZ(i,i,-t*Math.PI),this.requestRender(b.RenderRequestType.UPDATE)}_createLoadDataTask(){if(this._starData)return null;const e=i.createTask((async e=>{const{data:t}=await r.fetchAsset("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});!function(e){if(!e)throw new s("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/R;if(t%1!=0||t>5e4||t<5e3)throw new s("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}(t),this._starData=t}));return e.promise.catch((e=>{a.isAbortError(e)||n.getLogger(this).error(e)})).then((()=>{this.destroyed||this.requestRender(b.RenderRequestType.UPDATE)})),e}},e.Stars=t.__decorate([d.subclass("esri.views.3d.webgl-engine.effects.stars.Stars")],e.Stars);const C=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],P=p.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),M=p.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),R=9,E=g.newLayout().vec3f(w.VertexAttribute.POSITION).vec4u8(w.VertexAttribute.COLOR).f32(w.VertexAttribute.SIZE);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/stars/StarsTechnique":function(){define(["require","exports","../../../../../core/libs/gl-matrix-2/factories/mat4f64","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/Stars.glsl","../../../../webgl/enums","../../../../webgl/NoParameters","../../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends a.NoParameters{constructor(){super(...arguments),this.modelMatrix=r.create()}}class u extends s.ShaderTechnique{constructor(t,r){super(t,r,new i.ReloadableShaderModule(n.Stars,(()=>new Promise(((t,r)=>e(["./Stars.glsl"],t,r))))))}initializePipeline(){return l.makePipelineState({blending:l.unpremultipliedAlphaToPremultipliedAlpha,depthTest:{func:o.CompareFunction.LEQUAL},colorWrite:l.defaultColorWrite})}}t.StarPassParameters=c,t.StarsTechnique=u,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Stars.glsl":function(){define(["exports","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","../views/3d/webgl-engine/core/shaderModules/Float4BindUniform","../views/3d/webgl-engine/core/shaderModules/FloatBindUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4PassUniform","../views/3d/webgl-engine/lib/VertexAttribute","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l){"use strict";function c(){const e=new l.ShaderBuilder;return e.attributes.add(a.VertexAttribute.POSITION,"vec3"),e.attributes.add(a.VertexAttribute.COLOR,"vec4"),e.attributes.add(a.VertexAttribute.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new o.Matrix4PassUniform("transform",((e,r)=>function(e,r){const i=24e-8;return t.copy(u,r.camera.projectionMatrix),u[10]=i-1,u[11]=-1,u[14]=(i-2)*r.camera.near,t.multiply(u,u,r.camera.viewMatrix),t.multiply(u,u,e.modelMatrix)}(e,r))),new i.Float4BindUniform("viewport",(e=>e.camera.fullViewport)),new s.FloatBindUniform("pixelRatio",(e=>e.camera.pixelRatio))),e.vertex.main.add(n.glsl`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),e.fragment.main.add(n.glsl`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),e}const u=r.create(),d=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}));e.Stars=d,e.build=c}))},"esri/views/3d/webgl-engine/lib/CompositingHelper":function(){define(["../../../../chunks/Compositing.glsl","../shaders/CompositingTechnique","../shaders/CompositingTechniqueConfiguration","../../../../chunks/HUDCompositing.glsl","../shaders/HUDCompositingTechnique"],(function(e,t,r,i,s){"use strict";return class{constructor(n,o){this._rctx=n,this._techniques=o,this._configuration=new r.CompositingTechniqueConfiguration,this._passParameters=new e.CompositingPassParameters,this._hudParameters=new i.HUDCompositingPassParameters,this._configuration.blitMode=r.BlitMode.PremultipliedAlpha,this._techniques.precompile(t.CompositingTechnique,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(t.CompositingTechnique,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=r.BlitMode.Alpha,this._techniques.precompile(t.CompositingTechnique,this._configuration),this._configuration.blitMode=r.BlitMode.Depth,this._techniques.precompile(t.CompositingTechnique,this._configuration),this._techniques.precompile(s.HUDCompositingTechnique)}compositeHUD(e,t){this._hudParameters.texture=t;const r=this._techniques.get(s.HUDCompositingTechnique);this._rctx.bindTechnique(r,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,t,i=1){this._composite(e,t,r.BlitMode.PremultipliedAlpha,i)}composite(e,t){this._composite(e,t,r.BlitMode.Alpha,1)}blitDepthToLinearDepth(e,t){this._composite(e,t,r.BlitMode.Depth,1)}_composite(e,r,i,s){this._configuration.blitMode=i,this._configuration.hasOpacityFactor=1!==s,this._passParameters.texture=r,this._passParameters.opacity=s;const n=this._techniques.get(t.CompositingTechnique,this._configuration);this._rctx.bindTechnique(n,e,this._passParameters),this._rctx.screen.draw()}}}))},"esri/chunks/HUDCompositing.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n){"use strict";class o extends s.NoParameters{}function a(){const e=new n.ShaderBuilder;return e.include(t.ScreenSpacePass),e.fragment.uniforms.add(new i.Texture2DPassUniform("tex",(e=>e.texture))),e.fragment.main.add(r.glsl`fragColor = vec4(1.0 - texture(tex, uv).a);`),e}const l=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:o,build:a},Symbol.toStringTag,{value:"Module"}));e.HUDCompositing=l,e.HUDCompositingPassParameters=o,e.build=a}))},"esri/views/3d/webgl-engine/shaders/HUDCompositingTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../../chunks/HUDCompositing.glsl","../../../webgl/renderState"],(function(e,t,r,i,s,n){"use strict";class o extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.HUDCompositing,(()=>new Promise(((t,r)=>e(["./HUDCompositing.glsl"],t,r))))))}initializePipeline(){return n.makePipelineState({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}t.HUDCompositingTechnique=o,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ObjectAndLayerIdRenderHelper":function(){define(["exports","../../../../core/has","../../../../core/NestedMap","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/buffer/BufferView"],(function(e,t,r,i,s){"use strict";e.ObjectAndLayerIdRenderHelper=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new s.BufferViewVec4u8(new ArrayBuffer(4)),this._layerToOidToColor=new r.NestedMap,this._colorToUID=new Map,this._layerViewUidToGraphicsUidToObjectId=new r.NestedMap,this._layerViewUidToLayerId=new Map,this._layerViewUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,r,i,s,n=null,o=null,a=null){e&&t&&r&&i&&(this._layerViewUidToLayerId.set(i,r),this._layerViewUidToPopupEnabled.set(i,s),s&&this._layerViewUidToGraphicsUidToObjectId.set(i,t,{objectId:e,attributeNodeId:n,attributeIndex:o,subLayerId:a}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return i.fromValues(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerViewUid||!e.graphicUid)return this.colorZero;const r=this._layerViewUidToPopupEnabled.get(e.layerViewUid);if(void 0===r)return this.colorZero;if(!1===r)return this.colorZero;const i=this._layerViewUidToGraphicsUidToObjectId.get(e.layerViewUid,e.graphicUid)?.objectId;if(!i)return this.colorZero;let n=this._layerToOidToColor.get(e.layerViewUid,i);if(!n){if(t("enable-feature:objectAndLayerId-screenshot-testing"))n=i;else for(;!n;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(n=e)}if(n>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerViewUid,i,n),this._colorToUID.set(n,e)}const o=new ArrayBuffer(4);return new DataView(o).setUint32(0,n,!1),new s.BufferViewVec4u8(o)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,r]of this._colorToUID.entries()){const i=this._layerViewUidToGraphicsUidToObjectId.get(r.layerViewUid,r.graphicUid),s=this._layerViewUidToLayerId.get(r.layerViewUid);i&&s&&e.set(t,i.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:i.objectId,lid:s,attrId:i.attributeNodeId,attrIdx:i.attributeIndex,subLayerId:i.subLayerId}:{type:"object-and-layer-id",olid:i.objectId,lid:s})}return e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Renderer":function(){define(["require","exports","../../../../chunks/tslib.es6","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/colorUtils","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/time","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f32","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/Indices","../../webgl","../../environment/atmosphereUtils","../../state/NearFarHeuristic","../../support/debugFlags","../core/FBOCache","../core/FBOCacheFormats","../core/renderPasses/RenderPassManager","../core/shaderLibrary/ShaderOutput","../core/shaderLibrary/hud/HUDRenderStyle","../core/shaderLibrary/shading/ScreenSpaceConstants","../effects/RenderNodes","../effects/RenderPluginManager","../effects/blit/Blit","../effects/highlight/Highlight","../effects/transparency/OITBlend","./AnimationTimer","./AnimationTimeStep","./basicInterfaces","./BoundingInfo","./DepthRange","./depthRangeUtils","./hudFragmentOpacityParameters","./MainFramebuffer","./Material","./OITPass","./RenderContext","./RendererBase","./rendererUtils","./RenderFeature","./RenderPluginInput","./RenderSlot","./ShadowAccumulator","./ShadowMap","./SliceHelper","./edgeRendering/interfaces","../materials/renderers/MergedRenderer","../parts/renderUtils","../statistics/RendererPerformanceInfo","../../../support/RenderState","../../../webgl/enums"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z,Y,X,K,J,ee,te,re,ie,se,ne,oe,ae){"use strict";var le;t.Renderer=class extends Q.RendererBase{constructor(e,t,r,i,s,a){super({stage:e}),this._techniques=r,this._rctx=i,this._compositingHelper=s,this._requestRender=a,this._pluginsHas={hudElements:!1,water:!1},this.renderPassManager=new R.RenderPassManager,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=v.fromValues(0,0,0,1),this._sliceHelper=new te,this._blit=null,this._oitblend=null,this.sceneDepthRange=d.signal(k.DepthRange.infinite),this._state=d.signal(oe.RenderState.IDLE),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new V.AnimationTimeStep,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=d.signal(0),this._lastFrameTime=h.Milliseconds(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new X.RenderPluginInput,this._releaseNormals=e=>{e.some((({name:e})=>"normals"===e))&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new P.FBOCache(i),this._renderStateFeatures=d.signal(Y.setupFeatureDefaults(!o("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new q.MainFramebuffer(this.fboCache),this.performanceInfo=new ne.RendererPerformanceInfo(this._rctx),this._shadowMap=new ee.ShadowMap(this.fboCache,e.viewingMode),this._shadowAccumulator=new J.ShadowAccumulator(this.fboCache,r,e,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t}),((t,r,i)=>{const s=e.view.qualitySettings.maximumPixelRatio;t.shadowMap.start(t.camera,r,i,!0,s),this._renderShadowCascades(E.ShaderOutput.Shadow,t.shadowMap),t.shadowMap.finish(),t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.contentCamera)}),a),this._renderContext=new $.RenderContext(this._rctx,this._shadowMap,r),this._nodes=new I.RenderNodes(this._renderContext),this._plugins=new D.RenderPluginManager({renderContext:this._renderContext,techniques:r,materials:t,requestRender:a,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this._plugins.add(this.renderPassManager),this.addHandles([u.watch((()=>e.view.state.camera),(()=>a()),u.syncAndInitial),u.watch((()=>C.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(re.Transparency.TRANSPARENT):()=>{},a()}),u.initial),u.watch((()=>e.view.environment.background?.color),(e=>{const t=e?n.unitRGBAFromColor(e):v.ZEROS;_.set(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),a()}),u.syncAndInitial),u.watch((()=>e.view.state.camera.relativeElevation),(e=>this._inGlobeView=(e??1/0)>=A.distanceFadeEnd),u.syncAndInitial),u.watch((()=>this._bindParameters.clouds.fadeFactor),(()=>this._bindParameters.fadeLighting()),u.sync),u.watch((()=>this._bindParameters.clouds.data?.state),(()=>a()),u.sync),u.watch((()=>e.view.state.highlights),(e=>{this._bindParameters.highlights=e,a()}),u.initial)])}destroy(){this._gpuTimerHandle=l.removeMaybe(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=l.abortMaybe(this._loadEdgeViewTask),this._edgeView=l.destroyMaybe(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),this._blit=null,this._oitblend=null,G.BoundingInfo.prune(),ie.MergedRenderer.prune(),S.pruneIndexArrays()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(e=null,t=!o("disable-feature:high-quality-idle")){this._renderStateFeatures.value=Y.setupFeatureDefaults(t,e),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,r){this._renderStateFeatures.mutate((i=>i.set(t,e,r))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Y.RenderFeature.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(Y.RenderFeature.WaterReflection))}get _hasHighlights(){return this._plugins.produces(E.ShaderOutput.Highlight,K.RenderSlot.OPAQUE_MATERIAL,K.RenderSlot.TRANSPARENT_MATERIAL,K.RenderSlot.DRAPED_MATERIAL,K.RenderSlot.HUD_MATERIAL,K.RenderSlot.LABEL_MATERIAL)}hasHighlight(e){return this._plugins.hasHighlight(e)}get _hasHUDHighlights(){return this._plugins.produces(E.ShaderOutput.Highlight,K.RenderSlot.HUD_MATERIAL,K.RenderSlot.LABEL_MATERIAL)}get hasSSAO(){return(this.stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(Y.RenderFeature.SSAO))&&!this._inGlobeView}get hasSMAA(){return this.stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(Y.RenderFeature.Antialiasing)}get fullResolutionAtmosphere(){return this.stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(Y.RenderFeature.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=l.releaseMaybe(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=l.releaseMaybe(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=l.releaseMaybe(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=l.releaseMaybe(this._bindParameters.depth),this._bindParameters.hudVisibility=l.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return this._loadEdgeViewTask&&!this._loadEdgeViewTask.finished||this._edgeView?.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=s.createTask((async t=>{const{EdgeView:r}=await new Promise(((t,r)=>e(["./edgeRendering/EdgeView"],t,r)));c.throwIfAborted(t);const i=this._edgeView=new r({rctx:this._rctx,renderSR:this.stage.view.renderSpatialReference,viewingMode:this.stage.view.stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:(s=this.stage.view.resourceController,e=>s.immediate.schedule(e))});var s;return this.addHandles(u.watch((()=>i.updating),(()=>this._requestRender()),u.sync)),this._requestRender(),this._edgeViewCallbacks.forEach((e=>e(i))),this._edgeViewCallbacks.length=0,i}))),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&g.equals(this._bindParameters.ssr.reprojectionMatrix,y.IDENTITY)}set _reprojectionMatrix(e){i.update(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:r}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){if(null!=e.environment.weather){const t=e.environment.weather;this._bindParameters.weather=t,this._bindParameters.snowCover=!!e.weatherVisible&&null!=t&&"snowy"===t.type&&"enabled"===t.snowCover}const t="virtual"!==e.environment.lighting.type;r.enableFillLights!==t&&(r.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}set slice(e){this._sliceHelper.update(e)&&this._requestRender()}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}commit(e,t){return this._isRendering&&console.warn("Renderer.modify called while rendering"),!!super.commit(e,t,this._plugins.context)&&(this.updateHasFlags(),!0)}rendererAdded(e){this._plugins.add(e)}rendererRemoved(e){this._plugins.remove(e)}get occludedRequiresStencil(){return this.occludedRequiresOccludeeStencil||this.occludedRequiresIntegratedMeshStencil}get occludedRequiresOccludeeStencil(){return this._bindParameters.hasOccludees&&0!==(this.plugins.renderOccludedFlags&H.RenderOccludedFlag.OccludeAndTransparentStencil)}get occludedRequiresIntegratedMeshStencil(){return this._plugins.produces(E.ShaderOutput.Color,K.RenderSlot.INTEGRATED_MESH)&&this._plugins.produces(E.ShaderOutput.Color,K.RenderSlot.OCCLUDED_GROUND)}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(E.ShaderOutput.Color,...me),e.water=this._plugins.produces(E.ShaderOutput.Normal,K.RenderSlot.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??=new U.AnimationTimer(e.camera,t),this._animationTimer.advance(e.camera,t,this._animationTimeDilation);const r=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?l.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,r=Z.RendererTarget.Default,i=!1){try{return this._isRendering=!0,this._render(e,t,r,i)}catch(e){console.error(`Exception during rendering: ${e}`)}finally{this._isRendering=!1}return new se.RenderSceneResult(this._pluginInput.get(w.RenderCategory.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:r,navigatingOpacity:i,maxDelta:s,tiltFadeStart:n,tiltFadeEnd:o,altitudeStart:l,altitudeEnd:c}=j.hudFragmentOpacityParameters,u=this.stage.view,d=u.stateManager.camera,h=u.qualitySettings.fadeDuration,p=e===oe.RenderState.IDLE?r:i,m=a.clamp((d.tilt-n)/(o-n),0,1),f=a.clamp(((d.position.z??0)-l)/(c-l),0,1),g=a.lerp(a.lerp(1,p,m),1,f),y=this._bindParameters.hudOccludedFragmentOpacity;if(h<=0||y===g||0===this._lastFrameTime||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=g,void(this._lastFrameTime=t);const _=t-this._lastFrameTime;this._lastFrameTime=t;const b=Math.max(1-r,Math.abs(r-i)),v=Math.min(b*_/h,s);v>=Math.abs(g-y)?this._bindParameters.hudOccludedFragmentOpacity=g:(this._bindParameters.hudOccludedFragmentOpacity=y+Math.sign(g-y)*v,this._requestRender())}_render(e,t,r=Z.RendererTarget.Default,i){this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=r===Z.RendererTarget.Default,this._disposeBindBuffers();const{camera:s,contentCamera:n,mode:o,alignPixelEnabled:a}=e;this._state.value=o;const l=this._nodes.produces("magnifier-color"),c=this._nodes.produces(w.RenderCategory.FINAL),u=this._nodes.require("emissive",w.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,w.RenderCategory.COMPOSITE,w.RenderCategory.FINAL)>0&&this._plugins.hasEmissions,d=u?E.ShaderOutput.ColorEmission:E.ShaderOutput.Color;this._renderContext.time=t,this._renderContext.output=d,this._bindParameters.oitPass=W.OITPass.NONE,this._bindParameters.alignPixelEnabled=a,this._bindParameters.decorations=!i,this._bindParameters.mainDepth=null;const h=!i||!this._sliceHelper.isDecoration;this._bindParameters.slicePlane=h?this._sliceHelper.plane:null,this._bindParameters.viewshedEnabled=this._nodes.produces(w.InternalRenderCategory.VIEWSHED),this._renderOverlay(t),s.setGLViewport(this._rctx);const p=this._framebuffer,m=p.initialize(s.fullWidth,s.fullHeight,this._backgroundColor,u);this.hasReflections?(m?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=m):m?.release(),this._ensureBindParametersCamera(s,n),this._updateHUDOccludedFragmentOpacity(o,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!i;const f=this._highQualityTransparency&&this._hasTransparentTerrain,g=this._plugins.produces(E.ShaderOutput.Color,...he);this._precompilePrepasses(),this.performanceInfo.advance(ne.PerformanceCategory.PREPARE);const y=this._computeShadowDepthRange(s);this._renderShadowMap(s,this._bindParameters.lighting.mainLight.direction,y),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(y,s,n),this._ensureBindParametersSSR(t),this._precompileShaders(f,g,d),this._renderContext.output=d,p.bind(),this._bindParameters.mainDepth=p.depth.attachment,this._renderOpaque(f),this._renderTransparent(g,f,d),this._shadowMap.disposeMainBuffer(),this._pluginInput.set(w.InternalRenderCategory.FOCUSAREA,this._renderFocusAreaGeometry()),p.update((e=>this._renderNodes(w.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,e))),p.update((e=>this._renderNodes(w.InternalRenderCategory.VIEWSHED,e))),p.update((e=>this._renderNodes(w.InternalRenderCategory.LASERLINES,e))),p.update((e=>this._renderNodes(w.InternalRenderCategory.FOCUSAREA_COLOR,e))),this._pluginInput.release(w.InternalRenderCategory.FOCUSAREA),p.update((e=>this._renderNodes(w.InternalRenderCategory.OCCLUDED,e))),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._renderHighlightShadowMap(s,this._bindParameters.lighting.mainLight.direction,y);const _=r===Z.RendererTarget.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;p.update((e=>this._renderNodes(w.RenderCategory.COMPOSITE,e))),this._shadowMap.disposeOffscreenBuffers();const b=!(r!==Z.RendererTarget.Default||c||l&&!i),v=this._pluginInput.get(w.RenderCategory.COMPOSITE),S=b?P.defaultWebGLFBO:this.fboCache.acquire(v.fbo.width,v.fbo.height,w.InternalRenderCategory.ANTIALIASING),x=this._nodes.produces(w.InternalRenderCategory.ANTIALIASING)?this._renderNodes(w.InternalRenderCategory.ANTIALIASING,S):this._blitFBO(v,S,!1);let T;this._pluginInput.set(w.InternalRenderCategory.ANTIALIASING,x),this._hasHUDHighlights?(this._renderHUD(O.HUDRenderStyle.NotOccluded,x,d),T=this._renderNodes(w.InternalRenderCategory.HIGHLIGHTS,x)):(T=this._renderNodes(w.InternalRenderCategory.HIGHLIGHTS,x),this._renderHUD(O.HUDRenderStyle.NotOccluded,T,d));const C=this._renderNodes(w.InternalRenderCategory.MAGNIFIER,T);return l&&!i&&r===Z.RendererTarget.Default&&!c&&this._blitFBO(C),c?(C.attachDepth(p.depth),this._blitFBO(this._renderNodes(w.RenderCategory.FINAL,C)),C.detachDepth()):this._pluginInput.set(w.RenderCategory.FINAL,C),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),p.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),r!==Z.RendererTarget.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),new se.RenderSceneResult(this._pluginInput.get(w.RenderCategory.FINAL),_)}_precompileShaders(e,t,r){++this._plugins.context.techniques.precompiling,this._renderContext.output=r,this._precompileOpaqueGeometry(),this._nodes.precompile(w.InternalRenderCategory.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=E.ShaderOutput.Depth,this._plugins.precompile(K.RenderSlot.TRANSPARENT_TERRAIN),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=r,this._plugins.precompile(K.RenderSlot.TRANSPARENT_TERRAIN),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(w.InternalRenderCategory.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(K.RenderSlot.OCCLUSION_PIXELS),this._plugins.precompile(K.RenderSlot.LINE_CALLOUTS),this._precompileHUD(O.HUDRenderStyle.Occluded),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(w.InternalRenderCategory.VIEWSHED,w.InternalRenderCategory.LASERLINES,w.InternalRenderCategory.FOCUSAREA_COLOR,w.InternalRenderCategory.OCCLUDED,w.InternalRenderCategory.ANTIALIASING,w.InternalRenderCategory.HIGHLIGHTS);const i=this._bindParameters;i.highlightMixTexture=i.highlights.length>1?this._rctx.emptyTexture:null,this._precompileHUD(O.HUDRenderStyle.NotOccluded),this._hasHighlights&&(i.highlights.forEach(((e,t)=>{i.highlightLevel=t,this._precompileAllGeometry(E.ShaderOutput.Highlight)})),i.highlightLevel=null),i.highlightMixTexture=null,this._nodes.precompile(w.RenderCategory.COMPOSITE,w.InternalRenderCategory.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(K.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),--this._plugins.context.techniques.precompiling}_renderFocusAreaGeometry(){const e=this._nodes.produce(w.InternalRenderCategory.FOCUSAREA,this._pluginInput);return e&&this.performanceInfo.advance(ne.PerformanceCategory.FOCUS_AREA_MASK),e}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let r=this.fboCache.acquire(t.width,t.height,"olid");return r.acquireDepth(M.DepthFormat.DEPTH24_STENCIL8),r=this._nodes.render(r,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(ne.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,r}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,r=e===B.RenderRequestType.BACKGROUND;if(r||t){const e=r?this.performanceInfo.elapsedTime:0;let i=0;t?i=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const s=Math.max(e,i);this._animationTimestep.frame(s,r)}}readMainDepth(e,t){const{mainDepth:r,camera:i}=this._bindParameters;if(!r)return;const s=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(s.fbo),i.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(v.ZEROS),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,r),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),s.fbo?.readPixels(e[0],e[1],e[2],e[3],ae.PixelFormat.RGBA,ae.PixelType.UNSIGNED_BYTE,t),s.release()}readHUDVisibility(e,t,r,i,s){this._bindParameters.hudVisibility?.fbo?.readPixels(e,t,r,i,ae.PixelFormat.RGBA,ae.PixelType.UNSIGNED_BYTE,s)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!t?.shouldRender())return;const r=this._framebufferSize,i=this.fboCache.acquire(r.width,r.height,"edges"),s=this._bindParameters.geometryDepth;this.renderToTargets((()=>t.render(this._bindParameters,e)),i,s??this._framebuffer.depth,v.ZEROS),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,i.getTexture()),i.release(),this.performanceInfo.advance(e===re.Transparency.OPAQUE?ne.PerformanceCategory.OPAQUE_EDGES:ne.PerformanceCategory.TRANSPARENT_EDGES)}_renderOverlay(e){this._bindParameters.overlay=this.overlay?.render(e),this._bindParameters.overlay&&this.performanceInfo.advance(ne.PerformanceCategory.OVERLAY)}_renderShadowMap(e,t,r){if(!this.shadowsEnabled)return;const{contentCamera:i}=this._bindParameters,s=this._shadowMap;s.start(e,t,r,this.isFeatureEnabled(Y.RenderFeature.HighResolutionShadows),this.stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(E.ShaderOutput.ShadowExcludeHighlight,this._shadowMap),s.copySnapshot(ee.SnapshotSlot.ExcludeHighlight),this._renderShadowCascades(E.ShaderOutput.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(E.ShaderOutput.Shadow),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,i),this.performanceInfo.advance(ne.PerformanceCategory.SHADOW_MAP)}_renderHighlightShadowMap(e,t,r){if(!this.shadowsEnabled||!this._needsShadowHighlight)return;const{contentCamera:i}=this._bindParameters,s=this._shadowMap;s.start(e,t,r,this.isFeatureEnabled(Y.RenderFeature.HighResolutionShadows),this.stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(E.ShaderOutput.ShadowHighlight,this._shadowMap),s.moveSnapshot(ee.SnapshotSlot.Highlight),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,i),this.performanceInfo.advance(ne.PerformanceCategory.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){t.bindFbo();for(const r of t.cascades)r.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(r.camera,r.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(E.ShaderOutput.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._shadowAccumulator.active||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");e?(this._pluginInput.set(w.InternalRenderCategory.SSAO,this._renderSSAO()),this._needsDepth?(this._rctx.bindFramebuffer(e.fbo),this._rctx.clear(ae.FramebufferBit.STENCIL),this._renderGeometryWithoutNormals(E.ShaderOutput.Depth),l.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=e.obtainDepthTexture(),this.performanceInfo.advance(ne.PerformanceCategory.DEPTH)):(e.detachDepth(),this._bindParameters.depth=l.releaseMaybe(this._bindParameters.depth)),this.hasSSAO&&this._pluginInput.release("normals")):this._renderAllGeometryDepth()}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=l.releaseMaybe(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"depth",M.DepthFormat.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear(ae.FramebufferBit.DEPTH|ae.FramebufferBit.STENCIL),this.renderAllGeometry(E.ShaderOutput.Depth),l.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(ne.PerformanceCategory.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=l.releaseMaybe(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=E.ShaderOutput.Depth;const r=this._framebufferSize,i=this.fboCache.acquire(r.width,r.height,"terrain depth",M.DepthFormat.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(i.fbo),this._rctx.clear(ae.FramebufferBit.DEPTH|ae.FramebufferBit.STENCIL),this._renderTransparentTerrain(),l.releaseMaybe(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=i.obtainDepthTexture(),this._renderContext.output=t,i.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=l.releaseMaybe(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:r,height:i}=this._framebufferSize,s=this.fboCache.acquire(r,i,"geometry depth",M.DepthFormat.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(ae.FramebufferBit.DEPTH|ae.FramebufferBit.STENCIL),this._renderOpaqueAndTransparentGeometry(E.ShaderOutput.Depth),this._renderContext.output=t,l.releaseMaybe(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=s.obtainDepthTexture(),s.release()}get _needsShadowDepthRange(){return this._shadowMap.enabled||this._shadowAccumulator.active}_computeShadowDepthRange(e){if(!this._needsShadowDepthRange)return k.DepthRange.zero;const t=z.depthRangeFromScene(e,this._plugins.plugins,this.stage.layers,z.DepthRangeMode.SHADOW_CASTERS);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}updateSceneDepthRange(e){if(!this.stage.view.state.isGlobal)return void(this.sceneDepthRange.value=k.DepthRange.infinite);if((this.stage.view.renderCoordsHelper?.getAltitude(e.eye)??0)<x.innerAtmosphereFadeStart)return void(this.sceneDepthRange.value=k.DepthRange.infinite);const t=e.clone();t.near=T.minNearDistanceInMeters,t.far=1e10;const r=z.depthRangeFromScene(t,this._plugins.plugins,this.stage.layers,z.DepthRangeMode.FULL_SCENE);r.union(this._plugins.queryDepthRange(t)),this.sceneDepthRange.value.far===r.far&&this.sceneDepthRange.value.near===r.near||(this.sceneDepthRange.value=r)}get _normalsRequired(){const e=this._nodes.require("normals",w.RenderCategory.FINAL,w.RenderCategory.COMPOSITE,w.RenderCategory.OPAQUE,w.RenderCategory.TRANSPARENT,w.InternalRenderCategory.VIEWSHED,w.InternalRenderCategory.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(E.ShaderOutput.Normal),this._needsDepth&&this._precompileAllGeometry(E.ShaderOutput.Depth),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(E.ShaderOutput.ShadowHighlight),this._precompileShadowCascades(E.ShaderOutput.ShadowExcludeHighlight),this._precompileShadowCascades(E.ShaderOutput.ShadowHighlight)):this._precompileShadowCascades(E.ShaderOutput.Shadow)),this._shadowAccumulator.active&&this._precompileAllGeometry(E.ShaderOutput.Shadow)}_renderNormals(){const e=this._normalsRequired;if(0===e)return;const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"normals",M.ColorFormat.RGBA8UNORM);r.acquireDepth(M.DepthFormat.DEPTH24_STENCIL8),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(v.ZEROS,!0,!0),this._renderGeometryWithNormals(E.ShaderOutput.Normal);const i=this._nodes.optional("normals",w.RenderCategory.FINAL,w.RenderCategory.COMPOSITE,w.RenderCategory.OPAQUE,w.RenderCategory.TRANSPARENT,w.InternalRenderCategory.VIEWSHED);return r.retain(e+i-1),this.performanceInfo.advance(ne.PerformanceCategory.NORMALS),r}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return;const t=this._nodes.produce(w.InternalRenderCategory.SSAO,this._pluginInput);return this._bindParameters.ssao=t,t&&this.performanceInfo.advance(ne.PerformanceCategory.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(K.RenderSlot.TRANSPARENT_TERRAIN),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const r of t)this._bindParameters.slot=r,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const r of t)this._renderContext.renderOccludedMask=r,this.precompileSlots(e,...pe);this._renderContext.renderOccludedMask=$.defaultRenderOccludedMask}renderSlots(e,...t){for(const r of t)this._bindParameters.slot=r,e.forAll((e=>{const t=e.acquireTechniques(this._renderContext);t&&e.render(this._renderContext,t)}))}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>H.RenderOccludedFlag.Occlude&&this._plugins.render(K.RenderSlot.OCCLUDED_GROUND),this.renderSlots(e,...pe),this._renderContext.renderOccludedMask=$.defaultRenderOccludedMask}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(K.RenderSlot.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(E.ShaderOutput.ViewshedShadow)}renderViewshedShadowMap(e){const{camera:t,contentCamera:r}=this._bindParameters,i=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(E.ShaderOutput.ViewshedShadow),this._ensureBindParametersCamera(t,r),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=i}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(...ce),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(...ue)}_precompileOpaqueGeometry(){this._plugins.precompile(...de)}_renderOpaqueGeometry(){this._plugins.render(...de)}_renderTransparentGeometry(){this._plugins.render(...he)}get _hasTransparentTerrain(){return this._plugins.produces(E.ShaderOutput.Color,K.RenderSlot.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){const e=()=>this._plugins.render(K.RenderSlot.TRANSPARENT_TERRAIN);if(!E.isColorOrColorEmission(this._renderContext.output))return void e();const t=this._framebufferSize,r=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,r,this._framebuffer.depth,v.ZEROS),r}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,K.RenderSlot.OCCLUSION_PIXELS)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=l.releaseMaybe(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let r=this._bindParameters.hudVisibility;r?.fbo?.width===e&&r?.fbo?.height===t||(r?.release(),r=this.fboCache.acquire(e,t,"hud visibility",M.ColorFormat.RGBA4UNORM),this._bindParameters.hudVisibility=r);const i=this._bindParameters.geometryDepth;r.attachDepth(i||this._framebuffer.depth),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(K.RenderSlot.OCCLUSION_PIXELS),r.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(ne.PerformanceCategory.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===O.HUDRenderStyle.Occluded){const e=()=>this._plugins.render(K.RenderSlot.LINE_CALLOUTS),t=this._framebufferSize,r=this.fboCache.acquireDepth(M.DepthFormat.DEPTH16,t.width,t.height,"line callouts");this.renderToTargets(e,this._framebuffer.color,r,void 0,!0,!0),r.release()}else this._plugins.render(K.RenderSlot.LINE_CALLOUTS)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=E.ShaderOutput.Highlight,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&E.isColorOrColorEmission(this._renderContext.output)?(this._bindParameters.oitPass=W.OITPass.ColorAlpha,this._plugins.precompile(...me),this._bindParameters.oitPass=W.OITPass.FrontFace,this._plugins.precompile(...me),this._bindParameters.oitPass=W.OITPass.NONE):this._plugins.precompile(...me),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,r){if(this._pluginsHas.hudElements){if(this._oitEnabled){const i=this._renderOIT(le.HUD,r,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,i.getTexture()),i.release()}else if(this._renderContext.output=r,e===O.HUDRenderStyle.Occluded){const t=()=>this._renderHUDElements(e),r=this._framebufferSize,i=this.fboCache.acquireDepth(M.DepthFormat.DEPTH16,r.width,r.height,"hud");this.renderToTargets(t,this._framebuffer.color,i,void 0,!0,!0),i.release()}else t.acquireDepth(M.DepthFormat.DEPTH16),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===O.HUDRenderStyle.Occluded?ne.PerformanceCategory.HUD_OCCLUDED:ne.PerformanceCategory.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(...me)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(E.ShaderOutput.ShadowHighlight,K.RenderSlot.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:r}=this,i=this._framebufferSize,{highlights:s}=r,n=e.acquire(i.width,i.height,"highlights",s.length>L.maxHighlightsPerChannel?M.ColorFormat.RG8UINT:M.ColorFormat.R8UINT);n.acquireDepth(M.DepthFormat.DEPTH24_STENCIL8),t.bindFramebuffer(n.fbo);const{gl:o}=t;return o.clearBufferuiv(o.COLOR,0,[0,0,0,0]),this._renderContext.output=E.ShaderOutput.Highlight,t.bindFramebuffer(n.fbo),L.renderHighlightBuffer(t,e,i,r,(()=>this._renderHighlightGeometries())),this.performanceInfo.advance(ne.PerformanceCategory.HIGHLIGHTS),n}_renderHighlightGeometries(){this._plugins.render(...fe),this._rctx.clear(ae.FramebufferBit.DEPTH),this._renderHUDElements(O.HUDRenderStyle.Both)}_renderShadowAccumulation(e,t,r){this._shadowAccumulator.updateDepthRange(e),this._shadowAccumulator.accumulating&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,t,r)&&this.performanceInfo.advance(ne.PerformanceCategory.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&E.isColorOrColorEmission(this._renderContext.output)?(this._bindParameters.oitPass=W.OITPass.ColorAlpha,this._plugins.precompile(...he),this._bindParameters.oitPass=W.OITPass.FrontFace,this._plugins.precompile(...he),this._bindParameters.oitPass=W.OITPass.NONE):this._plugins.precompile(...he)}_renderOIT(e,t,r=O.HUDRenderStyle.Both){const i=e===le.HUD,s=this._framebufferSize,n=i?this.fboCache.acquire(s.width,s.height,"oit hud composite"):null,o=i?()=>this._renderHUDElements(r):()=>this._renderTransparentGeometry(),a=this._bindParameters,l=this._renderContext.output;this._renderContext.output=t,a.oitPass=W.OITPass.ColorAlpha;const c=n?"oit hud color+alpha":"oit color+alpha",u=this.fboCache.acquire(s.width,s.height,c,M.ColorFormat.RGBA16FLOAT),d=t===E.ShaderOutput.ColorEmission;d&&u.acquireColor(ae.ColorAttachment1,M.ColorFormat.RGBA16FLOAT,"emissive"),u.acquireColor(d?ae.ColorAttachment2:ae.ColorAttachment1,M.ColorFormat.R16FLOAT),n||u.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(u.fbo),this._rctx.clearFramebuffer([0,0,0,1]),d&&this._rctx.clearBuffer(1,b.ZEROS),o(),u.detachDepth(),a.oitPass=W.OITPass.FrontFace;const h=this.fboCache.acquire(s.width,s.height,n?"oit hud front":"oit front");return d&&h.acquireColor(ae.ColorAttachment1,M.ColorFormat.RGBA16FLOAT,"emissive"),n?h.acquireDepth(M.DepthFormat.DEPTH16):h.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(h.fbo),this._rctx.clearFramebuffer(v.ZEROS,!!n),o(),h.detachDepth(),a.oitPass=W.OITPass.NONE,n?(this._rctx.bindFramebuffer(n.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(ae.FramebufferBit.COLOR)):this._framebuffer.bind(),this._oitblend??=new N.OITBlend(this._techniques),this._oitblend.blend(this._rctx,u,h,a,d),n?.detachDepth(),h.release(),u.release(),this._renderContext.output=l,n}_renderOpaque(e){const t=this.plugins.produces(E.ShaderOutput.Color,...de);if(t){this._plugins.render(K.RenderSlot.INTEGRATED_MESH,K.RenderSlot.OPAQUE_TERRAIN);const e=this._framebuffer;e.update((e=>this._renderNodes(w.InternalRenderCategory.OPAQUE_TERRAIN,e))),e.bind(),this._plugins.render(K.RenderSlot.OPAQUE_MATERIAL,K.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS)}const r=this._framebuffer;r.update((e=>this._renderNodes(w.RenderCategory.OPAQUE,e,t))),this.fboCache.debugCallback?.(w.RenderCategory.OPAQUE,r.color.fbo),r.update((e=>this._renderNodes(w.InternalRenderCategory.OPAQUE_ENVIRONMENT,e))),this.fboCache.debugCallback?.(w.InternalRenderCategory.OPAQUE_ENVIRONMENT,r.color.fbo),this._renderTerrainDepth(e),this._renderEdges(re.Transparency.OPAQUE)}_renderTransparent(e,t,r){const i=this._framebuffer;i.bind(),this._renderPlugins(K.RenderSlot.VOXEL,ne.PerformanceCategory.VOXEL),this._renderHiddenTransparentEdges(),e&&(this._oitEnabled?this._renderOIT(le.Geometry,r):this._renderTransparentGeometry()),i.update((t=>this._renderNodes(w.RenderCategory.TRANSPARENT,t,e))),this.fboCache.debugCallback?.(w.RenderCategory.TRANSPARENT,i.color.fbo),this._renderGeometryDepth(t),this._renderHUDVisibility(),t||this._plugins.render(K.RenderSlot.LINE_CALLOUTS),this._renderEdges(re.Transparency.TRANSPARENT);const s=this._hasTransparentTerrain?this._renderTransparentTerrain():null;s&&(this.performanceInfo.advance(ne.PerformanceCategory.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(t?this._renderLineCallouts(O.HUDRenderStyle.Occluded):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,s.getTexture())),this._renderHUD(O.HUDRenderStyle.Occluded,i.color,r))),this._bindParameters.cullAboveTerrain=!1,s&&(i.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,s.getTexture()),s.release(),t&&(this._renderEdges(re.Transparency.OPAQUE),e&&(this._oitEnabled?this._renderOIT(le.Geometry,r):this._renderTransparentGeometry(),this.performanceInfo.advance(ne.PerformanceCategory.TRANSPARENT)),this._renderEdges(re.Transparency.TRANSPARENT))),this._bindParameters.ssao=l.releaseMaybe(this._bindParameters.ssao),t&&this._renderLineCallouts(O.HUDRenderStyle.NotOccluded),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(ne.PerformanceCategory.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(K.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),this.performanceInfo.advance(ne.PerformanceCategory.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(e),this.performanceInfo.advance(t))}_renderNodes(e,t,r=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return r&&this.performanceInfo.advance(e),t;const i=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),i}_blitFBO(e,t=P.defaultWebGLFBO,r=!0){return this._blit??=new F.Blit(this._techniques),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),r&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=y.IDENTITY:(g.invert(ye,this._bindParameters.camera.viewMatrix),g.invert(ge,this._bindParameters.camera.projectionMatrix),g.multiply(_e,ye,ge),g.multiply(_e,this._renderContext.lastFrameCamera.viewMatrix,_e),g.multiply(_e,this._renderContext.lastFrameCamera.projectionMatrix,_e),this._reprojectionMatrix=_e);const t=this.stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=y.IDENTITY,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,r,i){this._bindParameters.updateLighting(e,t,r,i),this._requestRender(B.RenderRequestType.UPDATE)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,t,r,i,s=!1,n=!1){t.attachDepth(r),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(i,s,n),e(),t.detachDepth()}get test(){}},r.__decorate([p.property({readOnly:!0})],t.Renderer.prototype,"fullResolutionAtmosphere",null),r.__decorate([p.property()],t.Renderer.prototype,"_edgeView",void 0),r.__decorate([p.property()],t.Renderer.prototype,"updating",null),t.Renderer=r.__decorate([f.subclass("esri.views.3d.webgl-engine.lib.Renderer")],t.Renderer),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(le||(le={}));const ce=[K.RenderSlot.INTEGRATED_MESH,K.RenderSlot.OPAQUE_TERRAIN,K.RenderSlot.OPAQUE_MATERIAL,K.RenderSlot.TRANSPARENT_MATERIAL],ue=[K.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS,K.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],de=[K.RenderSlot.INTEGRATED_MESH,K.RenderSlot.OPAQUE_TERRAIN,K.RenderSlot.OPAQUE_MATERIAL,K.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS],he=[K.RenderSlot.TRANSPARENT_MATERIAL,K.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],pe=[K.RenderSlot.OPAQUE_MATERIAL,K.RenderSlot.TRANSPARENT_MATERIAL,K.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],me=[K.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,K.RenderSlot.HUD_MATERIAL,K.RenderSlot.LABEL_MATERIAL],fe=[K.RenderSlot.TRANSPARENT_MATERIAL,K.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,K.RenderSlot.OPAQUE_MATERIAL,K.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS,K.RenderSlot.TRANSPARENT_TERRAIN,K.RenderSlot.INTEGRATED_MESH,K.RenderSlot.OPAQUE_TERRAIN],ge=y.create(),ye=y.create(),_e=y.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/core/libs/gl-matrix-2/factories/vec4f32":function(){define(["exports"],(function(e){"use strict";function t(){return new Float32Array(4)}function r(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function i(e,t,r,i){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}function s(){return t()}function n(){return i(1,1,1,1)}function o(){return i(1,0,0,0)}function a(){return i(0,1,0,0)}function l(){return i(0,0,1,0)}function c(){return i(0,0,0,1)}const u=s(),d=n(),h=o(),p=a(),m=l(),f=c(),g=Object.freeze(Object.defineProperty({__proto__:null,ONES:d,UNIT_W:f,UNIT_X:h,UNIT_Y:p,UNIT_Z:m,ZEROS:u,clone:r,create:t,fromValues:i,ones:n,unitW:c,unitX:o,unitY:a,unitZ:l,zeros:s},Symbol.toStringTag,{value:"Module"}));e.ONES=d,e.UNIT_W=f,e.UNIT_X=h,e.UNIT_Y=p,e.UNIT_Z=m,e.ZEROS=u,e.clone=r,e.create=t,e.fromValues=i,e.ones=n,e.unitW=c,e.unitX=o,e.unitY=a,e.unitZ=l,e.vec4f32=g,e.zeros=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/FBOCache":function(){define(["exports","../../../../core/Error","../../webgl/ManagedColorAttachment","../../webgl/ManagedDepthTexture","../../webgl/ManagedFBO","./FBOCacheFormats","./FBOPool","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e,t=0){return`${e}.color${t}`}function d(e){return`${e}.depth`}const h=new s("default","default",null,(()=>h),(()=>h),(()=>{}));function p(e,t,r){return`${t}x${r}:${e}`}h.release=()=>!1,e.FBOCache=class{constructor(e){this.rctx=e,this._interactive=!1,this._acquired=new Set,this._cache=new o.FBOPool(e.newCache,"FBOCache"),this._depthCache=new o.FBOPool(e.newCache,"DepthAttachmentCache"),this._colorCache=new o.FBOPool(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){const{debugCallback:e}=this;e&&this._acquired.forEach((t=>e(t.name,t.fbo)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>e+t.cachedMemory),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e,this._interactive=e}get interactive(){return this._interactive}acquire(e,r,i,o=n.ColorFormat.RGBA8UNORM){const c=p(o,e,r);let h=this._cache.pop(c);const{rctx:m}=this;if(h){h.retain(),h.setName(i);const e=h.getAttachment(a.DepthStencilAttachment);e&&(e.name=d(i));const r=h.getAttachment(a.ColorAttachment0);r&&(r.name=u(i,0));const{fbo:s}=h;if(!s)throw new t("renderer","attempt to use a none existing framebuffer");m.temporaryBindFramebufferObject(s,(()=>{m.setDrawBuffers([a.ColorAttachment0]),m.unbindTexture(s.colorTexture)}))}else{const t=new l.FramebufferObject(m),p=(t,i,s)=>{i??=n.ColorFormat.RGBA8UNORM;const o=this._acquireColor(i,e,r,s??u(h.name,t-a.ColorAttachment0));return this.rctx.unbindTexture(o.attachment),h.attachColor(o,t),o.release(),h},f=t=>{t??=n.DepthFormat.DEPTH24_STENCIL8;const i=this.acquireDepth(t,e,r,d(h.name));return h.attachDepth(i),i.release(),h},g=()=>{this.debugCallback?.(h.name,h.fbo),this._acquired.delete(h);const e=n.isDepthFormat(o);e&&null!=h?.getAttachment(a.DepthStencilAttachment)||!e&&null!=h?.getAttachment(a.ColorAttachment0)?(e?(h.fbo?.invalidateAttachments([a.DepthStencilAttachment]),h.detachAllColors()):(h.fbo?.invalidateAttachments([a.ColorAttachment0]),h.detachAllButColor0()),this._cache.put(h)):h?.dispose()};h=new s(c,i,t,p,f,g),n.isDepthFormat(o)?h.acquireDepth(o):h.acquireColor(a.ColorAttachment0,o,i)}return this._trackHandle(h)}acquireDepth(e,t,r,s){const o=p(e,t,r);let a=this._depthCache.pop(o);if(a)a.retain(),a.attachment.setShadowFiltering(!1);else{const s=new c.Texture(this.rctx,{...n.DepthTextureFormats[e],width:t,height:r});a=new i.ManagedDepthTexture(o,s,(()=>this._depthCache.put(a)))}return a.name=s,a}_acquireColor(e,t,i,s){const o=p(e,t,i);let a=this._colorCache.pop(o);if(a)a.retain();else{const s=new c.Texture(this.rctx,{...n.ColorFormats[e],width:t,height:i});a=new r.ManagedColorAttachment(o,s,(()=>this._colorCache.put(a)))}return a.name=s,a}_trackHandle(e){return this._acquired.add(e),e}},e.defaultWebGLFBO=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl/ManagedColorAttachment":function(){define(["exports","./ManagedFBOAttachment","./ManagedFBOResource"],(function(e,t,r){"use strict";class i extends t.ManagedFBOAttachment{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=r.AttachmentType.COLOR}}e.ManagedColorAttachment=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl/ManagedFBOAttachment":function(){define(["exports","./ManagedFBOResource"],(function(e,t){"use strict";class r extends t.ManagedFBOResource{constructor(e,t,r){super(e,r),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get cachedMemory(){return this.attachment.usedMemory}}e.ManagedFBOAttachment=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl/ManagedFBOResource":function(){define(["exports"],(function(e){"use strict";var t;e.AttachmentType=void 0,(t=e.AttachmentType||(e.AttachmentType={}))[t.FBO=0]="FBO",t[t.DEPTH=1]="DEPTH",t[t.COLOR=2]="COLOR",e.ManagedFBOResource=class{constructor(e,t){this.key=e,this._free=t,this.incarnation=0,this._refCount=1}retain(e=1){this._refCount+=e}release(){return 0===this._refCount?(console.log(`Releasing already released FBO attachment "${this.name}" in ${(new Error).stack}`),!0):(--this._refCount,0===this._refCount&&(this._free(),!0))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl/ManagedDepthTexture":function(){define(["exports","./ManagedDepthAttachment","../../webgl/FBOAttachmentType"],(function(e,t,r){"use strict";class i extends t.ManagedDepthAttachment{constructor(e,t,r){super(e,t,r),this.attachment=t}}e.ManagedDepthTexture=i,e.isManagedDepthTexture=function(e){return e?.attachment.type===r.FBOAttachmentType.Texture},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl/ManagedDepthAttachment":function(){define(["exports","./ManagedFBOAttachment","./ManagedFBOResource"],(function(e,t,r){"use strict";class i extends t.ManagedFBOAttachment{constructor(){super(...arguments),this.type=r.AttachmentType.DEPTH}}e.ManagedDepthAttachment=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl/ManagedFBO":function(){define(["../../../core/MapUtils","../../../core/maybe","../webgl","./ManagedDepthTexture","./ManagedFBOResource","../../webgl/enums"],(function(e,t,r,i,s,n){"use strict";class o extends s.ManagedFBOResource{constructor(e,t,i,n,o,a){super(e,a),this.fbo=i,this.type=s.AttachmentType.FBO,this._colors=new Map,this._name=r.RenderCategory.COMPOSITE,this.acquireColor=null,this.acquireDepth=null,this._name=t,this.acquireColor=n,this.acquireDepth=o}dispose(){this.fbo?.dispose()}get cachedMemory(){return this.fbo?.usedMemory||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(e){this._name=e}getTexture(e=n.ColorAttachment0){return e===n.DepthStencilAttachment?this.fbo?.depthStencilTexture:this.fbo?.getColorTexture(e)}get depthTexture(){return this.getTexture(n.DepthStencilAttachment)}getAttachment(e=n.ColorAttachment0){return e===n.DepthStencilAttachment?this._depth:this._colors.get(e)}hasAttachment(t){return e.someMap(this._colors,(e=>e.name===t))}attachDepth(e){return e?.retain(),this.detachDepth(),e&&this.fbo?.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){this.fbo?.detachDepthStencilTexture(),this.fbo?.detachDepthStencilBuffer(),this._depth=t.releaseMaybe(this._depth)}obtainDepthTexture(){const e=this._depth;return i.isManagedDepthTexture(e)?(this.fbo?.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){return e.retain(),this.detachColor(t),this.fbo?.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){this.fbo?.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t?.release()}detachAllColors(){this._colors.forEach(((e,t)=>this.detachColor(t)))}detachAll(){this.detachAllColors(),this.detachDepth()}detachAllColorsBut0(){this._colors.forEach(((e,t)=>{t!==n.ColorAttachment0&&this.detachColor(t)}))}detachAllButColor0(){this.detachAllColorsBut0(),this.detachDepth()}}return o}))},"esri/views/3d/webgl-engine/core/FBOPool":function(){define(["exports","../../../../core/MemCachePool","../../../../core/PooledArray"],(function(e,t,r){"use strict";e.FBOPool=class{constructor(e,i){this._last=new r,this._incarnation=0,this._cache=new t.MemCachePool(e,i)}destroy(){this._last?.forAll((e=>e.dispose())),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new r:e||(this._last?.forAll((e=>e.dispose())),this._last=null)}clean(){this._last?.filterInPlace((e=>!(e.incarnation<this._incarnation&&(this._cache.put(e.key,e),1))))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find((t=>t.key===e));if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce(((e,t)=>e+t.cachedMemory),0)??0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/renderPasses/RenderPassManager":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../core/Logger","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/Error","../../../../../core/accessorSupport/decorators/subclass","../../../../../core/libs/gl-matrix-2/math/mat3","../../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../../core/libs/gl-matrix-2/math/mat4","../../../../../chunks/vec32","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./AllRenderPasses","./RenderPassIdentifier","../shaderLibrary/ShaderOutput","../util/TwoVectorPosition","../../effects/RenderPlugin","../../lib/DepthRange","../../lib/RenderSlot"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_){"use strict";e.RenderPassManager=class extends g.SyncRenderPlugin{constructor(){super({}),this.produces=new Map([[_.RenderSlot.OPAQUE_MATERIAL,e=>this._produces(e,_.RenderSlot.OPAQUE_MATERIAL)],[_.RenderSlot.TRANSPARENT_MATERIAL,e=>this._produces(e,_.RenderSlot.TRANSPARENT_MATERIAL)],[_.RenderSlot.INTEGRATED_MESH,e=>this._produces(e,_.RenderSlot.INTEGRATED_MESH)],[_.RenderSlot.OCCLUDED_GROUND,e=>this._produces(e,_.RenderSlot.OCCLUDED_GROUND)]]),this._materialPassParameters=new h.MaterialPassParameters,this._shadowPassParameters=new h.ShadowMapPassParameters,this._highlightPassParameters=new h.HighlightPassParameters,this._viewshedPassParameters=new h.ViewshedShadowMapPassParameters,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new h.AllRenderPasses(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,(e=>e.count>0))}prepareRender(e){const{_systems:t,_passes:r}=this;if(0!==t.size&&null!=r){for(const e of Object.values(r))e.prepareSubmit();t.forEach((t=>t.submit(r,e.bind)));for(const e of Object.values(r))e.finishSubmit()}}acquireTechniques(e){if(0===this._systems.size)return null;const t=e.output===m.ShaderOutput.Shadow||e.output===m.ShaderOutput.ShadowHighlight||e.output===m.ShaderOutput.ShadowExcludeHighlight?this._shadowPassParameters:e.output===m.ShaderOutput.ViewshedShadow?this._viewshedPassParameters:e.output===m.ShaderOutput.Highlight?this._highlightPassParameters:this._materialPassParameters,r=e.bind;return this._updateParameters(r.camera,t,r.slot),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,((t,r)=>t.acquire(r,e.bind)))}render(e,t){this._invoke(e.output,e.bind.slot,((r,i)=>r.dispatch(i,e.bind,t)))}_invoke(e,t,r){if(null==this._passes)return null;switch(t){case _.RenderSlot.OPAQUE_MATERIAL:switch(e){case m.ShaderOutput.Color:case m.ShaderOutput.ColorEmission:case m.ShaderOutput.Depth:case m.ShaderOutput.Normal:case m.ShaderOutput.ObjectAndLayerIdColor:return r(this._passes.opaque,this._materialPassParameters);case m.ShaderOutput.Highlight:return r(this._passes.highlight,this._highlightPassParameters);case m.ShaderOutput.Shadow:return r(this._passes.shadowMap,this._shadowPassParameters);case m.ShaderOutput.ShadowHighlight:return r(this._passes.highlightShadowMap,this._shadowPassParameters);case m.ShaderOutput.ShadowExcludeHighlight:return r(this._passes.defaultShadowMap,this._shadowPassParameters);case m.ShaderOutput.ViewshedShadow:return r(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case _.RenderSlot.TRANSPARENT_MATERIAL:switch(e){case m.ShaderOutput.Color:case m.ShaderOutput.ColorEmission:case m.ShaderOutput.Depth:case m.ShaderOutput.Normal:case m.ShaderOutput.ObjectAndLayerIdColor:return r(this._passes.transparent,this._materialPassParameters)}break;case _.RenderSlot.INTEGRATED_MESH:switch(e){case m.ShaderOutput.Color:case m.ShaderOutput.ColorEmission:case m.ShaderOutput.Depth:case m.ShaderOutput.Normal:case m.ShaderOutput.ObjectAndLayerIdColor:return r(this._passes.integratedMesh,this._materialPassParameters);case m.ShaderOutput.Highlight:return r(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}break;case _.RenderSlot.OCCLUDED_GROUND:switch(e){case m.ShaderOutput.Color:case m.ShaderOutput.ColorEmission:case m.ShaderOutput.Depth:case m.ShaderOutput.Normal:case m.ShaderOutput.ObjectAndLayerIdColor:return r(this._passes.occludedGround,this._materialPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new y.DepthRange;return this._systems.forEach((r=>t.union(r.queryDepthRange(e)))),t}get hasEmissions(){let e=!1;return this._systems.forEach((t=>e=t.hasEmissions||e)),e}_updateParameters(e,t,r){const i=e.viewInverseTransposeMatrix,s=r===_.RenderSlot.TRANSPARENT_MATERIAL,n=r===_.RenderSlot.OCCLUDED_GROUND;u.set(b,i[3],i[7],i[11]),S.set(b),u.copy(t.transformWorldFromViewTH,S.high),u.copy(t.transformWorldFromViewTL,S.low),u.copy(t.slicePlaneLocalOrigin,b),a.fromMat4(t.transformViewFromCameraRelativeRS,e.viewMatrix),c.copy(t.transformProjFromView,e.projectionMatrix),t.identifier===p.RenderPassIdentifier.Material&&(this._materialPassParameters.transparent=s,this._materialPassParameters.occludedGround=n,a.transpose(v,t.transformViewFromCameraRelativeRS),a.invert(t.transformNormalViewFromGlobal,v))}hasHighlight(e){for(const t of this._systems)if(t.hasHighlight(e))return!0;return!1}},e.RenderPassManager=t.__decorate([o.subclass("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],e.RenderPassManager);const b=d.create(),v=l.create(),S=new f.TwoVectorPosition;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/renderPasses/AllRenderPasses":function(){define(["exports","../../../../../core/libs/gl-matrix-2/factories/vec3f64","./RenderPass","./RenderPassIdentifier","../shaderLibrary/ShaderOutput","../shaderLibrary/attributes/VertexNormal.glsl"],(function(e,t,r,i,s,n){"use strict";class o extends n.VertexNormalPassParameters{constructor(){super(...arguments),this.slicePlaneLocalOrigin=t.create(),this.origin=this.slicePlaneLocalOrigin}}class a extends n.VertexNormalDrawParameters{}e.AllRenderPasses=class{constructor(e){const t=e.renderContext.rctx,i=e.techniques;this.opaque=new r.RenderPass(t,i),this.transparent=new r.RenderPass(t,i,r.RenderPassSorting.BackToFront),this.integratedMesh=new r.RenderPass(t,i),this.occludedGround=new r.RenderPass(t,i),this.shadowMap=new r.RenderPass(t,i),this.highlight=new r.RenderPass(t,i),this.highlightIntegratedMesh=new r.RenderPass(t,i),this.highlightShadowMap=new r.RenderPass(t,i),this.viewshedShadowMap=new r.RenderPass(t,i),this.defaultShadowMap=new r.RenderPass(t,i)}},e.DrawParameters=a,e.HighlightPassParameters=class extends o{constructor(){super(...arguments),this.identifier=i.RenderPassIdentifier.Highlight}},e.MaterialPassParameters=class extends o{constructor(){super(...arguments),this.identifier=i.RenderPassIdentifier.Material,this.output=s.ShaderOutput.Color,this.transparent=!1,this.occludedGround=!1}},e.PassParameters=o,e.ShadowMapPassParameters=class extends o{constructor(){super(...arguments),this.identifier=i.RenderPassIdentifier.ShadowMap}},e.ViewshedShadowMapPassParameters=class extends o{constructor(){super(...arguments),this.identifier=i.RenderPassIdentifier.ViewshedShadowMap}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/renderPasses/RenderPass":function(){define(["exports","../../../../../core/PooledArray","./RenderPassIdentifier","../../lib/OITPass","../../../../webgl/enums"],(function(e,t,r,i,s){"use strict";var n;e.RenderPassSorting=void 0,(n=e.RenderPassSorting||(e.RenderPassSorting={}))[n.FrontToBack=0]="FrontToBack",n[n.BackToFront=1]="BackToFront";const o=new Map;o.set(s.DataType.UNSIGNED_BYTE,1),o.set(s.DataType.UNSIGNED_SHORT,2),o.set(s.DataType.UNSIGNED_INT,4),e.RenderPass=class{constructor(r,i,s=e.RenderPassSorting.FrontToBack){this._rctx=r,this._techniques=i,this._sorting=s,this._draws=new t({allocator:e=>e??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,r,i,s){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=r,n.material=e,n.depthSquaredHint=i,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,n.highlightName=s}acquire(e,t){return this._draws.map((r=>r.material.acquireTechnique(this._techniques,e,t,r.geometry.parameters)))}dispatch(e,t,s){const n=this._rctx;this._previouslyBoundDraw.clear();let a=null;const l=this._draws.length,c=t.highlight?.name;for(let u=0;u<l;u++){const l=this._draws.data[u];if(e.identifier===r.RenderPassIdentifier.Highlight){const e=l.highlightName;if(e){if(e!==c)continue}else if(!c||!t.overlay?.hasHighlight(c))continue}const d=s[u];d===a&&t.oitPass===i.OITPass.NONE||(n.bindTechnique(d,t,e),a=d);const{geometryRanges:h,indexType:p,geometry:m,material:f}=l;n.bindVAO(m.vao),this._previouslyBoundDraw.get(d)!==f&&(d.program.bindDraw(t,e,f),this._previouslyBoundDraw.set(d,f));const g=h.length,{primitiveType:y}=m;for(let e=0;e<g;e+=2){const t=h[e],r=h[e+1];if(0!==p){const e=o.get(p);n.drawElements(y,r,p,t*e)}else n.drawArrays(y,t,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const t=this._sorting===e.RenderPassSorting.FrontToBack?1:-1;this._draws.sort(((e,r)=>t*(e.depthSquaredHint-r.depthSquaredHint)||e.geometry.vao.usedMemory-r.geometry.vao.usedMemory))}get count(){return this._draws.length}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/RenderNodes":function(){define(["exports","../../../../core/Logger","../../../../core/PooledArray","../../webgl/utils","../core/FBOCache","../../../webgl/checkWebGLError"],(function(e,t,r,i,s,n){"use strict";e.RenderNodes=class{constructor(e){this._context=e,this._nodes=new r}destroy(){this._nodes.forEach((e=>e.destroy())),this._nodes.clear()}add(e){this._nodes.push(e),n.hasFeatureFlagWebGLDebug&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}remove(e){this._nodes.remove(e),n.hasFeatureFlagWebGLDebug&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}produces(e){return this._nodes.some((({produces:t})=>t===e))}require(e,...t){const r=this._nodes,i=t=>r.reduce(((r,{consumes:i,produces:s})=>r+(!i.required.includes(e)||null!=t&&s!==t?0:1)),0);return 0===t.length?i():t.reduce(((e,t)=>e+i(t)),0)}optional(e,...t){const r=this._nodes,i=t=>r.reduce(((r,{consumes:i,produces:s})=>r+(!i.optional?.includes(e)||null!=t&&s!==t?0:1)),0);return 0===t.length?i():t.reduce(((e,t)=>e+i(t)),0)}updateAnimation(e){return this._nodes.reduce(((t,r)=>r.updateAnimation(e)||t),!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach((e=>{e.produces===t&&e.precompile()}));--this._context.techniques.precompiling}render(e,t,r=()=>{}){return this._render(e,t,r)??(i.isManagedFBO(e)?e:s.defaultWebGLFBO)}produce(e,t,r=()=>{}){return this._render(e,t,r)}_render(e,r,i=()=>{}){const s="string"==typeof e?e:e.name,n=this._nodes.filter((({produces:e})=>e===s));if(0===n.length)return;let o="string"==typeof e?null:e;return n.some((e=>{const n=o?[o]:[],a=null==o;for(const t of e.consumes.required){if(t===s){if(a)return!1;continue}const e=r.get(t);if(e)n.push(e);else if("emissive"!==t||!r.get(s)?.hasAttachment(t))return i?.(n),!1}if(e.consumes.optional)for(const t of e.consumes.optional){if(t===s)continue;const e=r.get(t);e&&n.push(e)}try{const i=e.doRender(n);i&&i!==o&&(s!==i.name&&(t.getLogger(e).errorOnce(`RenderNode produced ${i.name}, expected ${s}`),i.setName(s)),o?.release(),o=i,r.set(s,o))}catch(r){t.getLogger(e).errorOnce(r)}return i?.(n),a&&null!=o})),this._context.rctx.enforceState(),o}requireGeometryDepth(){return this._nodes.some((e=>"disabled"!==e.produces&&e.requireGeometryDepth))}get test(){return{nodes:this._nodes}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl/utils":function(){define(["exports"],(function(e){"use strict";e.isManagedFBO=function(e){return e.name},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/RenderPluginManager":function(){define(["exports","../../../../core/has","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../core/signal","../lib/DepthRange","../lib/Material","../lib/RenderSlot"],(function(e,t,r,i,s,n,o,a){"use strict";const l=[a.RenderSlot.OPAQUE_MATERIAL,a.RenderSlot.TRANSPARENT_MATERIAL,a.RenderSlot.DRAPED_MATERIAL,a.RenderSlot.HUD_MATERIAL,a.RenderSlot.LABEL_MATERIAL];e.RenderPluginManager=class{constructor(e){this.context=e,this._renderPlugins=new r,this._slots=new Array,this._version=s.signal(0);for(let e=0;e<a.RenderSlot.MAX_SLOTS;++e)this._slots[e]=[]}destroy(){this._renderPlugins.forEach((e=>e.destroy())),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,t){const r=()=>{if(t?.aborted)throw e.uninitializeRenderContext(),i.createAbortError();this._renderPlugins.push(e),e.produces.forEach(((t,r)=>this._slots[r].push(e))),this.context.requestRender(),this._version.value++},s=e.initializeRenderContext(this.context,t);if(i.isPromiseLike(s))return s.then(r);r()}remove(e){this._renderPlugins.removeUnordered(e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((t=>t!==e));this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((r=>t=r.updateAnimation?.(e)||t)),t}precompile(...e){++this.context.techniques.precompiling;const t=this.context.renderContext.bind.slot;for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender((()=>{}));this.context.renderContext.bind.slot=t,--this.context.techniques.precompiling}render(...e){for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender(((e,t)=>e.render(this.context.renderContext,t)))}_forEachRender(e){const t=this.context.renderContext.bind.slot,r=this.context.renderContext.output;this._slots[t].forEach((i=>{const s=i.produces.get(t);if(!s?.(r)||i.isDecoration&&!this.context.renderContext.bind.decorations)return;const n=i.acquireTechniques(this.context.renderContext);n&&e(i,n)}))}queryDepthRange(e){const t=new n.DepthRange;return this._renderPlugins.forAll((r=>{const i=r.queryDepthRange?.(e);t.union(i)})),t}get updating(){return this._version.value>=0&&this._renderPlugins.some((e=>e.running))}produces(e,...t){return t.some((t=>this._slots[t].some((r=>{const i=r.produces.get(t);return!!i&&i(e)}))))}consumes(e){return this._renderPlugins.some((t=>t.consumes().required.includes(e)))}hasHighlight(e){return l.some((t=>this._slots[t].some((t=>t.hasHighlight(e)))))}get hasDecorations(){return this._renderPlugins.some((e=>e.isDecoration))}get hasOccludees(){return this._renderPlugins.some((e=>e.hasOccludees))}get hasEmissions(){return this._renderPlugins.some((e=>e.hasEmissions))}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|(t.renderOccludedFlags??o.RenderOccludedFlag.None)),o.RenderOccludedFlag.None)}get usedMemory(){return this._renderPlugins.reduce(((e,t)=>t.material?e:e+(t.usedMemory??0)),0)}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/transparency/OITBlend":function(){define(["exports","../../../../../chunks/OITBlend.glsl","./OITBlendTechnique","./OITBlendTechniqueConfiguration","../../../../webgl/enums"],(function(e,t,r,i,s){"use strict";e.OITBlend=class{constructor(e){this._techniques=e,this._parameters=new t.OITBlendPassParameters,this._configuration=new i.OITBlendTechniqueConfiguration,e.precompile(r.OITBlendTechnique,this._configuration),this._configuration.hasEmission=!0,e.precompile(r.OITBlendTechnique,this._configuration)}blend(e,t,i,n,o){this._parameters.colorTexture=t.getTexture(),o&&(this._parameters.emissionTexture=t.getTexture(s.ColorAttachment1),this._parameters.emissionFrontFaceTexture=i.getTexture(s.ColorAttachment1)),this._parameters.alphaTexture=t.getTexture(o?s.ColorAttachment2:s.ColorAttachment1),this._parameters.frontFaceTexture=i.getTexture(),this._configuration.hasEmission=o;const a=this._techniques.get(r.OITBlendTechnique,this._configuration);e.bindTechnique(a,n,this._parameters),e.screen.draw()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/OITBlend.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n){"use strict";class o extends s.NoParameters{}function a(e){const s=new n.ShaderBuilder;s.include(t.ScreenSpacePass);const o=e.hasEmission,a=s.fragment;return a.uniforms.add(new i.Texture2DPassUniform("colorTexture",(e=>e.colorTexture)),new i.Texture2DPassUniform("alphaTexture",(e=>e.alphaTexture)),new i.Texture2DPassUniform("frontFaceTexture",(e=>e.frontFaceTexture))),s.outputs.add("fragColor","vec4",0),o&&(s.outputs.add("fragEmission","vec4",1),a.uniforms.add(new i.Texture2DPassUniform("emissionTexture",(e=>e.emissionTexture))),a.uniforms.add(new i.Texture2DPassUniform("emissionFrontFaceTexture",(e=>e.emissionFrontFaceTexture)))),a.main.add(r.glsl`
      float srcAlpha = texture(alphaTexture, uv).r;
      if(srcAlpha == 0.0){
        fragColor = vec4(0.0);
        ${r.If(o,"fragEmission = vec4(0.0);")}
        return;
      }

      vec4 srcColor = texture(colorTexture, uv);
      vec4 frontFace = texture(frontFaceTexture, uv);

      vec4 transparentColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);
      fragColor = transparentColor;

      ${r.If(o,"vec4 emission = texture(emissionTexture, uv);\n         vec4 emissionFrontFace = texture(emissionFrontFaceTexture, uv);\n        fragEmission = vec4(mix(emission.rgb / srcAlpha, emissionFrontFace.rgb, emissionFrontFace.a), emissionFrontFace.a);")}
    `),s}const l=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:o,build:a},Symbol.toStringTag,{value:"Module"}));e.OITBlend=l,e.OITBlendPassParameters=o,e.build=a}))},"esri/views/3d/webgl-engine/effects/transparency/OITBlendTechnique":function(){define(["require","exports","../../core/shaderTechnique/ReloadableShaderModule","../../core/shaderTechnique/ShaderTechnique","../../../../../chunks/OITBlend.glsl","../../../../webgl/enums","../../../../webgl/renderState"],(function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.OITBlend,(()=>new Promise(((t,r)=>e(["./OITBlend.glsl"],t,r))))))}initializePipeline(e){return o.makePipelineState({blending:o.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:o.defaultColorWrite,drawBuffers:e.hasEmission?{buffers:[n.ColorAttachment0,n.ColorAttachment1]}:{buffers:[n.ColorAttachment0]}})}}t.OITBlendTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/transparency/OITBlendTechniqueConfiguration":function(){define(["exports","../../../../../chunks/tslib.es6","../../core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.hasEmission=!1}}t.__decorate([r.parameter()],i.prototype,"hasEmission",void 0),e.OITBlendTechniqueConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/AnimationTimer":function(){define(["exports","../../../../core/time"],(function(e,t){"use strict";e.AnimationTimer=class{constructor(e,r){this._camera=e,this._dt=t.Milliseconds(0),this._time=t.Milliseconds(0),this._lastUpdate=t.Milliseconds(0),this._lastUpdate=r,this._time=r}advance(e,r,i){const s=t.Milliseconds(r-this._lastUpdate);this._dt=t.Milliseconds(s/i),this._time=t.Milliseconds(this._time+s),this._lastUpdate=r,this._camera=e}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/AnimationTimeStep":function(){define(["exports","../../../../core/has","../../../../core/mathUtils","../../../../core/time"],(function(e,t,r,i){"use strict";const s=i.Milliseconds(12e4),n=i.Milliseconds(1e4),o=i.Milliseconds(1e3),a=i.Milliseconds(1e3/30);e.AnimationTimeStep=class{constructor(){this._step=o,this._dilation=1,this._firstIdleTime=i.Milliseconds(0)}frame(e,l){if(l?0===this._firstIdleTime&&(this._firstIdleTime=i.Milliseconds(performance.now())):this._firstIdleTime=i.Milliseconds(0),t("disable-feature:high-quality-idle"))this._dilation=1;else{const e=l?performance.now()-this._firstIdleTime:0;if(e>=s+n)return this._step=i.Milliseconds(1/0),void(this._dilation=1);this._dilation=e>=s?10:1}const c=r.clamp(e/.5,o,a);this._step===1/0?this._step=i.Milliseconds(c):this._step=i.Milliseconds(.9*this._step+c*(1-.9))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=i.Milliseconds(0)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/depthRangeUtils":function(){define(["exports","../../../../core/PooledArray","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/support/frustum","../../../../chunks/sphere","../../support/mathUtils","./DepthRange","./Octree","./Util"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";var p;function m(e,t,i){if(!i.visible)return;if(!a.intersectsSphere(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const s=i.transformation,n=x;i.geometries.forEach((i=>{r.multiply(n,s,i.transformation);const o=c.maxScale(n);f(e,t,i.boundingInfo,n,o)}))}function f(e,t,r,i,n){if(null==r)return;s.transformMat4(l.getCenter(w),r.center,i);const{eye:o,viewForward:c}=t,u=c[0]*(w[0]-o[0])+c[1]*(w[1]-o[1])+c[2]*(w[2]-o[2]);if(w[3]=r.radius*n,!(u-w[3]>e.near&&u+w[3]<e.far)&&a.intersectsSphere(t.frustum,w))if(r.radius>100&&r.getChildren())for(const s of r.getChildren())f(e,t,s,i,n);else M.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,i,r.bbMin,r.bbMax)}function g(e,t,r){const i=t.eye,s=t.viewForward,n=(r[0]-i[0])*s[0]+(r[1]-i[1])*s[1]+(r[2]-i[2])*s[2];e.near=Math.min(e.near,n-r[3]),e.far=Math.max(e.far,n+r[3])}e.DepthRangeMode=void 0,(p=e.DepthRangeMode||(e.DepthRangeMode={}))[p.SHADOW_CASTERS=0]="SHADOW_CASTERS",p[p.FULL_SCENE=1]="FULL_SCENE";class y{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new u.DepthRange(0,0)}compute(t,r,i){this._reset();const{viewMatrix:s}=t;r.forAll((t=>{t.forEachGeometry((t=>{if(!t.visible||i===e.DepthRangeMode.SHADOW_CASTERS&&!t.castShadow)return;const r=t.boundingSphere,n=s[2]*r[0]+s[6]*r[1]+s[10]*r[2]+s[14],o=n-r[3],a=n+r[3];this._geometries.push(t),this._near.push(-a),this._far.push(-o)}))}));const n=new u.DepthRange;if(0===this._geometries.length)return n;for(let e=0;e<this._geometries.length;++e)this._near[e]>n.far&&(n.far=this._near[e]),this._near[e]>2&&this._far[e]<n.near&&(n.near=this._far[e]);const o=this._looseRange;o.near=Math.max(.5*n.near,2),o.far=2*n.far;let a=0,l=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<n.near&&(this._near[e]>=o.near?n.near=this._near[e]:this._nearCandidates[a++]=e),this._far[e]>n.far&&(this._far[e]<=o.far?n.far=this._far[e]:this._farCandidates[l++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return n;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let e=0;e<this._nearCandidates.length;++e){const r=this._nearCandidates[e];if(this._near[r]<n.near){const e=this._geometries[r],{boundingInfo:i,shaderTransformation:s}=e;this._includeNearBoundingInfoRec(t,i,s,n)}}for(let e=0;e<this._farCandidates.length;++e){const r=this._farCandidates[e];if(this._far[r]>n.far){const e=this._geometries[r],{boundingInfo:i,shaderTransformation:s}=e;this._includeFarBoundingInfoRec(t,i,s,n)}}return this._reset(),n}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const r=l.getCenter(e),i=l.getRadius(e);return t[0][0]*r[0]+t[0][1]*r[1]+t[0][2]*r[2]+t[0][3]>i||t[1][0]*r[0]+t[1][1]*r[1]+t[1][2]*r[2]+t[1][3]>i||t[2][0]*r[0]+t[2][1]*r[1]+t[2][2]*r[2]+t[2][3]>i||t[3][0]*r[0]+t[3][1]*r[1]+t[3][2]*r[2]+t[3][3]>i}_includeNearBoundingInfoRec(e,t,r,i){if(null==t)return;const n=t.center;s.transformMat4(l.getCenter(w),n,r),w[3]=t.radius*c.maxScale(r);const{frustum:o}=e;if(this._isOutsideSidePlanes(w,o))return;const a=w[0],u=w[1],d=w[2],h=w[3],{viewMatrix:p}=e,m=p[2]*a+p[6]*u+p[10]*d+p[14],f=m+h;if(!(-(m-h)<2||-f>=i.near))if(-f>this._looseRange.near)i.near=-f;else{if(h>100){const s=t.getChildren();if(void 0!==s){for(const t of s)this._includeNearBoundingInfoRec(e,t,r,i);return}}M.unionDepthRangeWithAABB(i,e.viewProjectionMatrix,r,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,r,i){if(null==t)return;const n=t.center;s.transformMat4(l.getCenter(w),n,r),w[3]=t.radius*c.maxScale(r);const{frustum:o}=e;if(this._isOutsideSidePlanes(w,o))return;const[a,u,d,h]=w,{viewMatrix:p}=e,m=p[2]*a+p[6]*u+p[10]*d+p[14]-h;if(!(-m<=i.far))if(-m<this._looseRange.far)i.far=-m;else{if(h>100){const s=t.getChildren();if(void 0!==s){for(const t of s)this._includeFarBoundingInfoRec(e,t,r,i);return}}M.unionDepthRangeWithAABB(i,e.viewProjectionMatrix,r,t.bbMin,t.bbMax)}}}function _(e,t,r){let i=[e,t,r];for(let e=0;e<4;++e){const t=i;i=[];for(let r=0;r<t.length;++r){const s=t[r],n=t[(r+1)%t.length];b(n,e)?(b(s,e)||i.push(v(s,n,e)),i.push(n)):b(s,e)&&i.push(v(s,n,e))}}return i}function b(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void h.assert(!1)}function v(e,t,r){let i=0;return 0===r?i=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?i=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?i=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(i=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),n.lerp(o.create(),e,t,i)}const S=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],w=l.create(),x=i.create(),T=new u.DepthRange,C=new class{constructor(){this._items=new t({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll((e=>{const i=e.object.boundingVolumeWorldSpace.bounds,s=(i[0]-t[0])*r[0]+(i[1]-t[1])*r[1]+(i[2]-t[2])*r[2];e.distance=s,e.near=s-i[3],e.far=s+i[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,r){if(t===d.DepthOrder.FRONT_TO_BACK)for(let t=0;t<this._items.length;++t){const i=this._items.data[t];i.far<e.near||i.near>e.far||r(i.object,i.near,i.far)}else for(let t=this._items.length-1;t>=0;--t){const i=this._items.data[t];i.far<e.near||i.near>e.far||r(i.object,i.near,i.far)}}},P=new y,M=new class{constructor(){this._modelViewProj=i.create(),this._clipPosition=[o.create(),o.create(),o.create(),o.create(),o.create(),o.create(),o.create(),o.create()]}unionDepthRangeWithAABB(e,t,i,s,n){const o=this._modelViewProj;r.multiply(o,t,i);let a=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],r=0===e||3===e||4===e||7===e?s[0]:n[0],i=0===e||1===e||4===e||5===e?s[1]:n[1],a=e<4?s[2]:n[2];t[0]=o[0]*r+o[4]*i+o[8]*a+o[12],t[1]=o[1]*r+o[5]*i+o[9]*a+o[13],t[2]=o[2]*r+o[6]*i+o[10]*a+o[14],t[3]=o[3]*r+o[7]*i+o[11]*a+o[15]}for(let t=0;t<12;++t){const r=_(this._clipPosition[S[t][0]],this._clipPosition[S[t][1]],this._clipPosition[S[t][2]]);let i=!0;for(let e=0;e<r.length;++e)if(r[e][3]>=2){i=!1;break}if(!i){a=!0;for(let t=0;t<r.length;++t){const i=r[t][3];Number.isFinite(i)&&(e.near=Math.min(i,e.near),e.far=Math.max(i,e.far))}}}return a}};e.DepthRangeFromRenderGeometries=y,e.depthRangeFromScene=function(e,t,r,i){let s=0;if(!t.some((e=>!!e.material&&(s+=e.numGeometries,s>=1e4))))return P.compute(e,t,i);const n=new u.DepthRange;return r.forAll((t=>n.union(function(e,t){if(!t.visible)return;const r=new u.DepthRange,i=t.getSpatialQueryAccelerator();return i?function(e,t,r){const{eye:i,viewForward:s,frustum:n}=t,o=e=>e.visible,a=r.objectCount;if(a<500)T.set(t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(i,s,d.DepthOrder.FRONT_TO_BACK,T,((r,i)=>{m(e,t,r),T.far=e.near,i.setRange(T)}),n,o),T.set(Math.max(e.far,t.near),t.far),r.forEachInDepthRange(i,s,d.DepthOrder.BACK_TO_FRONT,T,((r,i)=>{m(e,t,r),T.near=e.far,i.setRange(T)}),n,o);else{const i=Math.max(Math.min(a,500),Math.ceil(.1*a)),l=r.findClosest(s,d.DepthOrder.FRONT_TO_BACK,n,o,i),c=r.findClosest(s,d.DepthOrder.BACK_TO_FRONT,n,o,i);l&&c&&(g(e,t,l.boundingVolumeWorldSpace.bounds),g(e,t,c.boundingVolumeWorldSpace.bounds))}}(r,e,i):function(e,t,r){C.clear(),r.forEach((e=>{e.visible&&0!==e.geometries.length&&C.add(e)})),C.empty||(C.sort(t),T.set(t.near,Math.min(e.near,t.far)),C.forEachInDepthRange(T,d.DepthOrder.FRONT_TO_BACK,((r,i)=>{i<e.near&&m(e,t,r)})),T.set(Math.max(e.far,t.near),t.far),C.forEachInDepthRange(T,d.DepthOrder.BACK_TO_FRONT,((t,r,i)=>{e.far=Math.max(e.far,i)})))}(r,e,t.objects),r}(e,t)))),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/hudFragmentOpacityParameters":function(){define(["exports"],(function(e){"use strict";e.hudFragmentOpacityParameters={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/MainFramebuffer":function(){define(["exports","../../../../core/maybe","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f32","../../../../core/libs/gl-matrix-2/factories/vec4f64","../core/FBOCacheFormats","./BindParameters","../../../webgl/enums","../../../webgl/FramebufferObject"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.MainFramebuffer=class{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new o.ViewportSize(0,0),this._clearColor=s.create()}dispose(){this._color=t.releaseMaybe(this._color),this.releaseDepth()}initialize(e,t,i,s){this._size.width=e,this._size.height=t,l.ensureAttachmentMaxSize(this._size,this._fbos.rctx.parameters.maxTextureSize);const n=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=s,r.copy(this._clearColor,i),n}releaseDepth(){this._color?.detachDepth(),this._depth=t.releaseMaybe(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const{rctx:e}=this._fbos,t=null==this._color;this.color.attachDepth(this.depth),e.bindFramebuffer(this.color.fbo),t&&(e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clear(a.FramebufferBit.COLOR|a.FramebufferBit.DEPTH|a.FramebufferBit.STENCIL),this._requiresEmission&&e.clearBuffer(1,i.ZEROS))}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor(a.ColorAttachment1,n.ColorFormat.RGBA16FLOAT,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(n.DepthFormat.DEPTH24_STENCIL8,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/RenderPluginInput":function(){define(["exports"],(function(e){"use strict";e.RenderPluginInput=class{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){this._inputs.get(e)?.release()&&this._inputs.delete(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ShadowAccumulator":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/has","../../../../core/mathUtils","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/signal","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../core/shaderLibrary/shading/ReadShadowMap.glsl","./BindParameters","./DepthRange","./glUtil3D","./ShadowCastRenderer","./ShadowMap","../../../../chunks/ShadowCastAccumulate.glsl","../shaders/ShadowCastAccumulateTechnique","../shaders/ShadowCastAccumulateTechniqueConfiguration","../shaders/ShadowCastClearTechnique","../../../support/Scheduler","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/TextureDescriptor","../../../webgl/Util"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R){"use strict";e.ShadowAccumulator=class extends r{updateDepthRange(e){this._depthRange.equals(e)||(this._depthRange=e)}constructor(e,t,r,i,s,n){super({}),this.fbos=e,this._techniques=t,this._stage=r,this._prepareForShadowMapPass=i,this._renderToShadowMap=s,this._requestRender=n,this._primarySet=new I(new w.ShadowCastAccumulateTechniqueConfiguration(w.ShadowCastAccumulateIndex.PRIMARY),(()=>this._requestRenderIfEnabled())),this._contextSet=new I(new w.ShadowCastAccumulateTechniqueConfiguration(w.ShadowCastAccumulateIndex.CONTEXT),(()=>this._requestRenderIfEnabled())),this._passParameters=new m.ReadShadowMapPassParameters,this._depthRange=g.DepthRange.zero,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey=Symbol("shadowAccumulator"),this._rctx=e.rctx,this._bindParameters=new f.BindParameters(new b.ShadowMap(e,r.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=y.createQuadVAO(this._rctx),this._accumulationRenderer=new _.ShadowCastRenderer(t,this._rctx,this,n);const o=this._stage.view.resourceController.scheduler;this.addHandles([o.registerTask(T.TaskPriority.SHADOW_ACCUMULATOR,this),a.watch((()=>r.renderView),(e=>{this.removeHandles(O),null!=e&&this.addHandles(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),O)}),a.syncAndInitial),a.watch((()=>this._previewing),(()=>this._requestRenderIfEnabled()),a.sync),a.watch((()=>2===this._numActive),(()=>this._numActiveChanged()),a.sync),a.watch((()=>this._depthRange),(()=>this._invalidateAccumulationSets()),a.sync)],this._shadowAccumulatorKey);for(const e of this._accumulationSets())e.precompile(t)}*_accumulationSets(){yield this._primarySet,yield this._contextSet}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=o.disposeMaybe(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=o.disposeMaybe(this._fbo),this._vao=o.disposeMaybe(this._vao);for(const e of this._accumulationSets())e.destroy()}get computedSamples(){return[this._primarySet.progress,this._contextSet.progress]}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this.active&&this._previewing||this._refining}get _refining(){return this.active&&!this._doneAccumulating&&!this._previewing}get active(){return null!=this._fbo&&[...this._accumulationSets()].some((e=>e.active))}get canAccumulate(){return null!=this._bindParameters.depth&&this._depthRange!==g.DepthRange.zero&&this._opacityFromElevation>_.shadowCastDisabledElevationThreshold}get _doneAccumulating(){return[...this._accumulationSets()].every((e=>e.doneAccumulating))}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get _numActive(){return[...this._accumulationSets()].reduce(((e,t)=>e+(t.active?1:0)),0)}get _pixelFormat(){return 2===this._numActive?{pixelFormat:C.PixelFormat.RG,internalFormat:C.SizedPixelFormat.RG8}:{pixelFormat:C.PixelFormat.RED,internalFormat:C.SizedPixelFormat.R8}}get running(){return this._refining&&this.canAccumulate&&[...this._accumulationSets()].some((e=>e.running))}runTask(e){this._clearBuffersOnAccumulationStart(),this._prepareForShadowMapPass(this._bindParameters);let t=!1;for(const r of this._accumulationSets())this._runTaskForSet(r,e)&&(t=!0);t&&this._requestRender()}_runTaskForSet(e,t){let r=!1;for(;!t.done&&!e.doneAccumulating;)this._accumulateShadow(e),t.madeProgress(),r=!0;return r}renderAccumulation(e,t,r){if(this._updateCamera(t),this._bindParameters.contentCamera=r,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.accumulating||!this.canAccumulate)return!1;this._previewing||this._cameraForcedForScreenshot?(this._clearFramebuffer(),this._reset()):this._clearBuffersOnAccumulationStart();const i=this._accumulateSetsForRenderFrame();return this._cameraForcedForScreenshot=!1,i}_clearBuffersOnAccumulationStart(){if([...this._accumulationSets()].every((e=>0===e.progress)))this._clearFramebuffer();else for(const e of this._accumulationSets())0===e.progress&&this._clearFramebufferForSet(this._fbo,e)}_accumulateSetsForRenderFrame(){let e=!1;for(const t of this._accumulationSets())this._accumulateSetForRenderFrame(t)&&(e=!0);return e&&this._requestRender(),e}_accumulateSetForRenderFrame(e){let t=this._cameraForcedForScreenshot?e.sampleCount:Math.min(E,e.sampleCount);t-=e.progress;for(let r=0;r<t;++r)this._accumulateShadow(e);return t>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._primarySet.lightDirections=e.lightDirections),void 0!==e.lightDirectionsContext&&(this._contextSet.lightDirections=e.lightDirectionsContext),!0===e.enabled?this._enable():!1===e.enabled&&this._disable(),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){const r=this._primarySet.progress;return!this.active||!this._fbo||r<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,C.PixelFormat.RGBA,C.PixelType.UNSIGNED_BYTE,A),A[w.ShadowCastAccumulateIndex.PRIMARY]/r)}_numActiveChanged(){if(!this._fbo)return;const e=2===this._numActive,t=this._createFBO();t.resize(this._fbo.width,this._fbo.height),e&&(this._clearFramebuffer(t),this._contextSet.reset()),this._fbo.width&&this._fbo.height&&this._rctx.blitFramebuffer(this._fbo,t),this._fbo.dispose(),this._fbo=t,this._requestRender()}_enable(){this._fbo||(this._fbo=this._createFBO(),this._invalidateAccumulationSets())}_createFBO(){const{pixelFormat:e,internalFormat:t}=this._pixelFormat,r=new M.TextureDescriptor;return r.pixelFormat=e,r.internalFormat=t,r.wrapMode=C.TextureWrapMode.CLAMP_TO_EDGE,new P.FramebufferObject(this._rctx,r)}_invalidateAccumulationSets(){for(const e of this._accumulationSets())e.reset();this._requestRenderIfEnabled()}_disable(){this._fbo&&(this._fbo=o.disposeMaybe(this._fbo),this._requestRender())}_reset(){for(const e of this._accumulationSets())e.reset()}_clearFramebuffer(e=this._fbo){e&&e.width&&e.height&&(this._rctx.bindFramebuffer(e),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(C.FramebufferBit.COLOR))}_clearFramebufferForSet(e,t){if(!e)return;const r=this._techniques.get(x.ShadowCastClearTechnique,t.configuration);this._rctx.bindFramebuffer(e),this._rctx.bindTechnique(r,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(r.primitiveType,0,R.vertexCount(this._vao,"geometry"))}_accumulateShadow(e){this._renderToShadowMap(this._bindParameters,e.lightDirections[e.progress++],this._depthRange);const t=this._techniques.get(S.ShadowCastAccumulateTechnique,e.configuration);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(t,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,R.vertexCount(this._vao,"geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const r=this._bindParameters.camera;e.equals(r)||r.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-n.smoothstep(_.shadowCastDisableElevationMin,_.shadowCastDisableElevationMax,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}},t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_fbo",void 0),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_depthRange",void 0),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_previewing",void 0),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_accumulationRenderer",void 0),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_refining",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"active",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"canAccumulate",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_doneAccumulating",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_opacityFromElevation",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_numActive",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"_pixelFormat",null),t.__decorate([c.property()],e.ShadowAccumulator.prototype,"running",null),e.ShadowAccumulator=t.__decorate([d.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],e.ShadowAccumulator);const E=6,O="renderView",A=new Uint8Array(4);class I{constructor(e,t){this.configuration=e,this._notifyChange=t,this._cachedLightDirections=[],this._progress=l.signal(0),this._sampleCount=l.signal(0)}get progress(){return this._progress.value}set progress(e){this._progress.value=e}get sampleCount(){return this._sampleCount.value}get doneAccumulating(){return this.progress>=this.sampleCount}get running(){return this.progress>0}get active(){return this.sampleCount>0}get lightDirections(){return this._cachedLightDirections}set lightDirections(e){const t=this._cachedLightDirections,r=Math.min(v.ShadowCastMaxSamples,e.length);if(!i.sliceEquals(t,0,t.length,e,0,r,h.equals)){t.length=r,this._sampleCount.value=r;for(let i=0;i<r;++i)t[i]=h.copy(t[i]??p.create(),e[i]);this.reset(),this._notifyChange()}}destroy(){this._cachedLightDirections.length=0,this._sampleCount.value=0}reset(){this.progress=0}precompile(e){e.precompile(S.ShadowCastAccumulateTechnique,this.configuration),e.precompile(x.ShadowCastClearTechnique,this.configuration)}}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ShadowCastRenderer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec42","./glUtil3D","../../../../chunks/ShadowCastVisualize.glsl","../shaders/ShadowCastVisualizeTechnique","../shaders/ShadowCastVisualizeTechniqueConfiguration","../../../webgl/Util"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";const f=1/512;e.ShadowCastRenderer=class extends r{constructor(e,t,r,i){super({}),this._techniques=e,this._rctx=t,this._data=r,this._requestRender=i,this._passParameters=new d.ShadowCastVisualizePassParameters(this._data),this._configuration=new p.ShadowCastVisualizeTechniqueConfiguration,this._enabled=!1,this._vao=u.createQuadVAO(t)}dispose(){this._stop(),this._vao=i.disposeMaybe(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(h.ShadowCastVisualizeTechnique,this._configuration)}render(e){if(!this._showVisualization)return;const[t,r]=this._data.computedSamples;this._passParameters.sampleScale=[t?1/t:0,r?1/r:0];const i=this._techniques.get(h.ShadowCastVisualizeTechnique,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(i,e,this._passParameters),this._rctx.drawArrays(i.primitiveType,0,m.vertexCount(this._vao,"geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.thresholdColor&&this._setThresholdColor(e.thresholdColor),void 0!==e.gradientColor&&this._setGradientColor(e.gradientColor),void 0!==e.bandedGradientColor&&this._setBandedGradientColor(e.bandedGradientColor),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&(this._data.computedSamples[0]>0||this._data.computedSamples[1]>0)&&this.opacityFromElevation>f}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}_setThresholdColor(e){const t=this._passParameters.thresholdColor;c.exactEquals(e,t)||(c.copy(this._passParameters.thresholdColor,e),this._requestRenderIfEnabled())}_setGradientColor(e){const t=this._passParameters.gradientColor;c.exactEquals(e,t)||(c.copy(this._passParameters.gradientColor,e),this._requestRenderIfEnabled())}_setBandedGradientColor(e){const t=this._passParameters.bandedGradientColor;c.exactEquals(e,t)||(c.copy(this._passParameters.bandedGradientColor,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}},t.__decorate([s.property()],e.ShadowCastRenderer.prototype,"opacityFromElevation",null),e.ShadowCastRenderer=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],e.ShadowCastRenderer),e.shadowCastDisableElevationMax=5e4,e.shadowCastDisableElevationMin=4e4,e.shadowCastDisabledElevationThreshold=f,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/ShadowCastVisualize.glsl":function(){define(["exports","../core/libs/gl-matrix-2/factories/vec2f64","../core/libs/gl-matrix-2/factories/vec4f64","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/BlendColorsPremultiplied.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/CameraSpace.glsl","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float4PassUniform","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","./ShadowCastAccumulate.glsl","../views/3d/webgl-engine/shaders/ShadowCastVisualizeTechniqueConfiguration","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";class f extends p.NoParameters{constructor(e){super(),this._data=e,this.sampleScale=t.create(),this.opacityFromElevation=1,this.gradientColor=r.clone(y),this.thresholdColor=r.clone(_),this.bandedGradientColor=r.clone(b),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const g=50/255,y=r.fromValues(0,0,1,.7),_=r.fromValues(1,0,0,.7),b=r.fromValues(g,g,g,.7);function v(e){const t=new m.ShaderBuilder,r=t.fragment;t.include(n.CameraSpace),t.include(i.ScreenSpacePass);const{visualization:p}=e;r.constants.add("inverseSampleValue","float",d.ShadowCastMaxSamples),r.uniforms.add(new u.Texture2DPassUniform("shadowCastMap",(e=>e.shadowCastMap)),new o.Float2PassUniform("sampleScale",(e=>e.sampleScale)),new l.FloatPassUniform("opacityFromElevation",(e=>e.opacityFromElevation)));const f=p===h.ShadowCastVisualization.Threshold,g=p===h.ShadowCastVisualization.ThresholdAndGradient,y=p===h.ShadowCastVisualization.BandedGradient;switch(g&&r.include(s.BlendColorsPremultiplied),p){case h.ShadowCastVisualization.Gradient:r.uniforms.add(new a.Float4PassUniform("uColor",(e=>s.premultiplyAlpha(S,e.gradientColor))));break;case h.ShadowCastVisualization.BandedGradient:r.uniforms.add(new a.Float4PassUniform("uColor",(e=>s.premultiplyAlpha(S,e.bandedGradientColor))),new l.FloatPassUniform("bandSize",(e=>e.bandSize)));break;case h.ShadowCastVisualization.ThresholdAndGradient:r.uniforms.add(new a.Float4PassUniform("uColor",(e=>s.premultiplyAlpha(S,e.thresholdColor))),new a.Float4PassUniform("gradientColor",(e=>s.premultiplyAlpha(S,e.gradientColor))),new l.FloatPassUniform("threshold",(e=>e.threshold)));break;case h.ShadowCastVisualization.Threshold:r.uniforms.add(new a.Float4PassUniform("uColor",(e=>s.premultiplyAlpha(S,e.thresholdColor))),new l.FloatPassUniform("threshold",(e=>e.threshold)))}const{type:_,selector:b,thresholdStrengthSelector:v}=g?{type:"vec2",selector:"rg",thresholdStrengthSelector:"strength.x"}:{type:"float",selector:"r",thresholdStrengthSelector:"strength"};return r.main.add(c.glsl`
    ${_} numSamples = texture(shadowCastMap, uv).${b} * inverseSampleValue;

    fragColor = vec4(0.0);

    // early out if we do not have any samples in one or more channels
    if (dot(numSamples, ${_}(1)) < 1.0) {
      return;
    }

    // sampleScale is the number of total samples taken, so this brings strength to a 0-1 range.
    // note that sampleScale is always a vec2 even if we have only the primary channel.
    ${_} strength = numSamples * sampleScale.${b};

    // in threshold mode, step the strength to 0 if we are at or below the threshold, 1 otherwise.
    ${c.If(f||g,c.glsl`
      ${v} = 1.0 - step(${v}, threshold);
    `)}

    // bail out if we are below the threshold
    ${c.If(f,c.glsl`if (${v} == 0.0) { return; }`)}

    ${c.If(y,c.glsl`strength = ceil(strength / bandSize) * bandSize;`)}

    ${_} attenuation = opacityFromElevation * strength;

    // in ThresholdAndGradient mode we blend the threshold color on top of the gradient color
    fragColor = ${c.If(g,c.glsl`blendColorsPremultiplied(uColor * attenuation.r, gradientColor * attenuation.g)`,c.glsl`uColor * attenuation`)};
  `),t}const S=r.create(),w=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:f,build:v},Symbol.toStringTag,{value:"Module"}));e.ShadowCastVisualize=w,e.ShadowCastVisualizePassParameters=f,e.build=v}))},"esri/views/3d/webgl-engine/core/shaderLibrary/util/BlendColorsPremultiplied.glsl":function(){define(["exports"],(function(e){"use strict";e.BlendColorsPremultiplied=function(e){e.code.add("\n  vec4 blendColorsPremultiplied(vec4 source, vec4 dest) {\n    float oneMinusSourceAlpha = 1.0 - source.a;\n    return source + dest * oneMinusSourceAlpha;\n  }\n  ")},e.premultiplyAlpha=function(e,t){return e[0]=t[0]*t[3],e[1]=t[1]*t[3],e[2]=t[2]*t[3],e[3]=t[3],e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/ShadowCastAccumulate.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/calculateUVZShadowFromDepth.glsl","../views/3d/webgl-engine/core/shaderLibrary/shading/ReadShadowMap.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DBindUniform","../views/3d/webgl-engine/core/shaderModules/Texture2DShadowBindUniform","../views/3d/webgl-engine/shaders/ReadShadowMapConfiguration","../views/3d/webgl-engine/shaders/ShadowCastAccumulateTechniqueConfiguration","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=1/255;function d(e){const a=new c.ShaderBuilder,{fragment:d}=a;a.include(t.ScreenSpacePass),a.include(r.calculateUVZShadowFromDepthPass),a.include(i.ReadShadowMapPass,h),d.uniforms.add(new o.Texture2DShadowBindUniform("shadowMap",(e=>e.shadowMap.depthTexture)),new n.Texture2DBindUniform("depthMap",(e=>e.depth?.attachment))),d.constants.add("sampleValue","float",u);const p=e.index===l.ShadowCastAccumulateIndex.CONTEXT?"vec2":"float";return a.outputs.add("sampleCount",p),d.main.add(s.glsl`
    sampleCount = ${p}(0.0);

    vec3 uvzShadow = calculateUVZShadowFromDepth(uv, textureSize(shadowMap,0), depthMap);
    if (uvzShadow.z < 0.0) {
      return;
    }

    // The shadow map sampler returns a value between 0 and 1, we take the midpoint as we count discrete samples
    bool shadow = readShadowMapUVZ(uvzShadow, shadowMap) > 0.5;

    if (shadow) {
      sampleCount = ${p}(sampleValue); // Add 1 to the sample count
    }
  `),a}const h=new a.ReadShadowMapConfiguration,p=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:255,build:d},Symbol.toStringTag,{value:"Module"}));e.ShadowCastAccumulate=p,e.ShadowCastMaxSamples=255,e.build=d}))},"esri/views/3d/webgl-engine/shaders/ReadShadowMapConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";class i extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.receiveShadows=!0}}t.__decorate([r.parameter()],i.prototype,"receiveShadows",void 0),e.ReadShadowMapConfiguration=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/ShadowCastAccumulateTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";var i;e.ShadowCastAccumulateIndex=void 0,(i=e.ShadowCastAccumulateIndex||(e.ShadowCastAccumulateIndex={}))[i.PRIMARY=0]="PRIMARY",i[i.CONTEXT=1]="CONTEXT",i[i.COUNT=2]="COUNT";class s extends r.ShaderTechniqueConfiguration{constructor(t){super(),this.index=e.ShadowCastAccumulateIndex.PRIMARY,this.index=t}}t.__decorate([r.parameter({count:e.ShadowCastAccumulateIndex.COUNT})],s.prototype,"index",void 0),e.ShadowCastAccumulateTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/ShadowCastVisualizeTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration"],(function(e,t,r){"use strict";var i;e.ShadowCastVisualization=void 0,(i=e.ShadowCastVisualization||(e.ShadowCastVisualization={}))[i.Gradient=0]="Gradient",i[i.BandedGradient=1]="BandedGradient",i[i.Threshold=2]="Threshold",i[i.ThresholdAndGradient=3]="ThresholdAndGradient",i[i.COUNT=4]="COUNT";class s extends r.ShaderTechniqueConfiguration{constructor(){super(...arguments),this.visualization=e.ShadowCastVisualization.Gradient}}t.__decorate([r.parameter({count:e.ShadowCastVisualization.COUNT})],s.prototype,"visualization",void 0),e.ShadowCastVisualizeTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/ShadowCastVisualizeTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../../chunks/ShadowCastVisualize.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s,n,o){"use strict";class a extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.ShadowCastVisualize,(()=>new Promise(((t,r)=>e(["./ShadowCastVisualize.glsl"],t,r)))))),this.primitiveType=n.PrimitiveType.TRIANGLE_STRIP}initializePipeline(){return o.makePipelineState({blending:o.premultipliedAlpha,colorWrite:o.defaultColorWrite,depthTest:null,depthWrite:null})}}t.ShadowCastVisualizeTechnique=a,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/ShadowCastAccumulateTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../../chunks/ShadowCastAccumulate.glsl","./ShadowCastAccumulateTechniqueConfiguration","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.ShadowCastAccumulate,(()=>new Promise(((t,r)=>e(["./ShadowCastAccumulate.glsl"],t,r)))))),this.primitiveType=o.PrimitiveType.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===n.ShadowCastAccumulateIndex.PRIMARY,g:e.index===n.ShadowCastAccumulateIndex.CONTEXT,b:!1,a:!1};return a.makePipelineState({blending:a.add,colorWrite:t,depthTest:null,depthWrite:null})}}t.ShadowCastAccumulateTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/ShadowCastClearTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","./ShadowCastAccumulateTechniqueConfiguration","../../../../chunks/ShadowCastClear.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.ShadowCastClear,(()=>new Promise(((t,r)=>e(["./ShadowCastClear.glsl"],t,r)))))),this.primitiveType=o.PrimitiveType.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===s.ShadowCastAccumulateIndex.PRIMARY,g:e.index===s.ShadowCastAccumulateIndex.CONTEXT,b:!1,a:!1};return a.makePipelineState({blending:null,colorWrite:t,depthTest:null,depthWrite:null})}}t.ShadowCastClearTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/ShadowCastClear.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/shaders/ShadowCastAccumulateTechniqueConfiguration","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s){"use strict";function n(e){const n=new s.ShaderBuilder,{fragment:o}=n;n.include(t.ScreenSpacePass);const a=e.index===i.ShadowCastAccumulateIndex.CONTEXT?"vec2":"float",l="value";return n.outputs.add(l,a),o.main.add(r.glsl`${l} = ${a}(0.0);`),n}const o=Object.freeze(Object.defineProperty({__proto__:null,build:n},Symbol.toStringTag,{value:"Module"}));e.ShadowCastClear=o,e.build=n}))},"esri/views/3d/webgl-engine/lib/SliceHelper":function(){define(["../../../../chunks/boundedPlane"],(function(e){"use strict";const t=e.create();return class{constructor(){this._plane=e.create(),this._isDecoration=!0}get plane(){return this._plane}get isDecoration(){return this._isDecoration}update({plane:r,isDecoration:i}){let s=!1;return this._isDecoration!==i&&(this._isDecoration=i,s=!0),r??=t,e.equals(r,this._plane)?s:(e.copy(r,this._plane),!0)}}}))},"esri/views/3d/webgl-engine/statistics/RendererPerformanceInfo":function(){define(["exports","../../../../core/maybe","../../../../core/PerformanceSampler","../../../../core/time","../../webgl","../../../webgl/TimerPool"],(function(e,t,r,i,s,n){"use strict";var o;e.PerformanceCategory=void 0,(o=e.PerformanceCategory||(e.PerformanceCategory={})).OVERLAY="overlay",o.PREPARE="prepare",o.SHADOW_MAP="shadow map",o.DEPTH="depth",o.ACCUMULATED_SHADOWS="accumulated shadows",o.APPLY_ACCUMULATED_SHADOWS="apply accumulated shadows",o.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",o.NORMALS="normals",o.SSAO="SSAO",o.HIGHLIGHTS="highlights",o.OPAQUE_EDGES="opaque edges",o.VOXEL="voxel",o.TRANSPARENT="transparent",o.TRANSPARENT_EDGES="transparent edges",o.HUD_VISIBILITY="HUD visibility",o.TRANSPARENT_TERRAIN="transparent terrain",o.TRANSPARENT_MATERIAL_WITHOUT_DEPTH="transparent material without depth",o.OPAQUE_ENVIRONMENT="opaque environment",o.TRANSPARENT_ENVIRONMENT="transparent environment",o.OCCLUDED="occluded",o.HUD="HUD",o.HUD_OCCLUDED="HUD occluded",o.FINISH="finish",o.FOCUS_AREA_MASK="focus area mask";const a=Object.values(s.RenderCategory).concat(Object.values(s.InternalRenderCategory)).concat(Object.values(e.PerformanceCategory)),l="Total";e.PerformanceCategories=a,e.RendererPerformanceInfo=class{constructor(e){this._rctx=e,this._startTimeStampCPU=i.Milliseconds(0),this._lastTimeStampCPU=i.Milliseconds(0),this._totalCPUTime=new r(l),this._cpuTimeSamplers=new Map(a.map((e=>[e,new r(e)]))),this._enableGPUTimer=0,this._totalGPUTime=new r("GPU"),this._gpuTimeSamplers=new Map(a.map((e=>[e,new r(e)]))),this._totalTime=i.Milliseconds(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return null!=this._gpuTimerPool}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return i.Milliseconds(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(null==this._gpuTimerPool){const e=[...a,l];this._gpuTimerPool=n.createElapsedTimerPool(this._rctx,e)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=t.disposeMaybe(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=i.Milliseconds(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach((e=>e.push(0))),this._gpuTimerPool.start())}advance(e){const t=i.Milliseconds(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(t),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const t=this._gpuTimerPool.stop(e.PerformanceCategory.FINISH);this._gpuTimeSamplers.get(e.PerformanceCategory.FINISH).set(t),this._rctx.gl.flush()}const t=i.Milliseconds(performance.now()-this._startTimeStampCPU);this._totalTime=i.Milliseconds(this._totalTime+t),this._totalCPUTime.push(t),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce(((e,t)=>e+(t.last||0)),0)),++this._totalFrameCount}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/TimerPool":function(){define(["exports","./capabilities/DisjointTimerQuery"],(function(e,t){"use strict";class r{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach((e=>{const t=this._timer.createQuery(),r=this._timer.createQuery();this._queryPool.push(t,r),this._queryResults.set(e,null)}))}start(){t.hasRunningElapsedTimer||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const r=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,r}abort(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((e=>{this._timer.deleteQuery(e)})),this._queryResults.forEach((e=>{null!=e&&this._timer.deleteQuery(e)}))}}e.createElapsedTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return null==i?null:new r(i,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/capabilities/DisjointTimerQuery":function(){define(["exports"],(function(e){"use strict";class t{constructor(e,t,r,i,s,n,o,a,l){this.createQuery=e,this.deleteQuery=t,this.resultAvailable=r,this.getResult=i,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=o,this.createTimestamp=a,this.timestampBits=l}}e.hasRunningElapsedTimer=!1,e.DisjointTimerQuery=t,e.createDisjointTimerQuery=function(r,i){if(i.disjointTimerQuery)return null;let s=r.getExtension("EXT_disjoint_timer_query_webgl2");return s?new t((()=>r.createQuery()),(t=>{r.deleteQuery(t),e.hasRunningElapsedTimer=!1}),(e=>r.getQueryParameter(e,r.QUERY_RESULT_AVAILABLE)),(e=>r.getQueryParameter(e,r.QUERY_RESULT)),(()=>r.getParameter(s.GPU_DISJOINT_EXT)),(t=>{e.hasRunningElapsedTimer||(e.hasRunningElapsedTimer=!0,r.beginQuery(s.TIME_ELAPSED_EXT,t))}),(()=>{r.endQuery(s.TIME_ELAPSED_EXT),e.hasRunningElapsedTimer=!1}),(e=>s.queryCounterEXT(e,s.TIMESTAMP_EXT)),(()=>r.getQuery(s.TIMESTAMP_EXT,s.QUERY_COUNTER_BITS_EXT))):(s=r.getExtension("EXT_disjoint_timer_query"),s?new t((()=>s.createQueryEXT()),(t=>{s.deleteQueryEXT(t),e.hasRunningElapsedTimer=!1}),(e=>s.getQueryObjectEXT(e,s.QUERY_RESULT_AVAILABLE_EXT)),(e=>s.getQueryObjectEXT(e,s.QUERY_RESULT_EXT)),(()=>r.getParameter(s.GPU_DISJOINT_EXT)),(t=>{e.hasRunningElapsedTimer||(e.hasRunningElapsedTimer=!0,s.beginQueryEXT(s.TIME_ELAPSED_EXT,t))}),(()=>{s.endQueryEXT(s.TIME_ELAPSED_EXT),e.hasRunningElapsedTimer=!1}),(e=>s.queryCounterEXT(e,s.TIMESTAMP_EXT)),(()=>s.getQueryEXT(s.TIMESTAMP_EXT,s.QUERY_COUNTER_BITS_EXT))):null)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/RenderingContext":function(){define(["exports","../../../../core/has","../../../../core/NestedMap","../effects/ScreenSpaceGeometry","./glUtil3D","../materials/renderers/VaoCache","../../../webgl/AppleAmdDriverHelper","../../../webgl/RenderingContext"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends a.RenderingContext{constructor(e,t){super(e,t),this.emptyTexture=s.createEmptyTexture(this),this._vaoCaches=new r.NestedMap,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this.screen=new i.ScreenSpaceGeometry(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){this._vaoCaches?.forAll((e=>e.dispose())),this._vaoCaches?.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){this.emptyTexture.dispose(),this.screen.destroy(),super.dispose(),this._appleAmdDriverHelper?.dispose(),this._vaoCaches.forAll((e=>e.dispose())),this._vaoCaches.clear()}get newCache(){return this._newCache}getVaoCache(e,t){const r=Array.from(e).join("."),i=JSON.stringify(t),s=this._vaoCaches.get(r,i);if(s)return s;const o=new n.VaoCache(this,e,t);return this._vaoCaches.set(r,i,o),o}bindTechnique(e,t,r,i){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(t),r&&(e.program.bindPass(r,t),i&&e.program.bindDraw(t,r,i)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new o.AppleAmdDriverHelper(this),this._appleAmdDriverHelper.run())}get isAssumedMetalDriver(){if(null==this._isAssumedMetalDriver&&(this._isAssumedMetalDriver=!!t("ios")||!!t("safari"),!this._isAssumedMetalDriver&&t("mac")&&t("chrome"))){const e=this.capabilities.rendererInfo?.getUnmaskedRenderer().toLowerCase(),t=e?.includes("apple")&&e?.includes("angle")&&e?.includes("metal");this._isAssumedMetalDriver=t??!0}return this._isAssumedMetalDriver}get test(){}}e.RenderingContext=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/effects/ScreenSpaceGeometry":function(){define(["exports","../../../../core/has","../../../../core/maybe","../lib/DefaultVertexAttributeLocations","../lib/DefaultVertexBufferLayouts","../lib/VertexArrayObject","../../../webgl/BufferObject","../../../webgl/enums"],(function(e,t,r,i,s,n,o,a){"use strict";e.ScreenSpaceGeometry=class{constructor(e){this._rctx=e,this._vao=function(e,t=s.Pos2,r=i.Default3D){const l=new Float32Array([-1,-1,3,-1,-1,3]);return new n.VertexArrayObject(e,r,new Map([["geometry",t]]),new Map([["geometry",o.BufferObject.createVertex(e,a.Usage.STATIC_DRAW,l)]]))}(e)}destroy(){this._vao=r.disposeMaybe(this._vao)}draw(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(a.PrimitiveType.TRIANGLES,0,3))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/renderers/VaoCache":function(){define(["exports","../../../../../core/MemCachePool","../../lib/VertexArrayObject","../../../../webgl/BufferObject","../../../../webgl/enums"],(function(e,t,r,i,s){"use strict";e.VaoCache=class{constructor(e,r,i){this._rctx=e,this._locations=r,this._layout=i,this._cache=new t.MemCachePool(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let n=this._cache.pop(t);return n||(n=new r.VertexArrayObject(this._rctx,this._locations,new Map([["geometry",this._layout]]),new Map([["geometry",i.BufferObject.createVertex(this._rctx,s.Usage.STATIC_DRAW)]])),n.vertexBuffers.get("geometry")?.setSize(e),n)}deleteVao(e){if(null==e)return;const t=e.getByteLength("geometry").toString();this._cache.put(t,e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/AppleAmdDriverHelper":function(){define(["exports","../../core/has","./BufferObject","./enums"],(function(e,t,r,i){"use strict";class s{constructor(e){this._rctx=e,this._indexBuffer=this._createIndexbuffer(),this._program=this._createHelperProgram()}static getShaderSources(){return{vertex:"#version 300 es\n    precision highp float;\n\n    void main(void) {\n      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);\n    }",fragment:"#version 300 es\n    precision highp float;\n\n    out vec4 fragColor;\n\n    void main(void) {\n      fragColor = vec4(0.0, 0.0, 0.0, 1.0);\n    }"}}_createHelperProgram(){const e=s.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}_createIndexbuffer(){return r.BufferObject.createIndex(this._rctx,i.Usage.STATIC_DRAW,new Uint32Array([0]))}run(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,i.BufferType.ELEMENT_ARRAY_BUFFER),this._rctx.drawElements(i.PrimitiveType.POINTS,1,i.DataType.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}get test(){}}e.AppleAmdDriverHelper=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/RenderingContext":function(){define(["exports","../../core/has","../../core/maybe","../../core/promiseUtils","../../core/time","./checkWebGLError","./ContextState","./enums","./InstanceCounter","./Parameters","./ProgramCache","./renderState","./Texture","./Util","./WebGLDriverTest","./capabilities/Capabilities"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";function g(e,t,r,i){return t?i!==t&&e.bindBuffer(r,t.glName):e.bindBuffer(r,null),t}function y(e,t){switch(e){case a.PrimitiveType.POINTS:return 2*t;case a.PrimitiveType.TRIANGLES:return t/3;case a.PrimitiveType.TRIANGLE_STRIP:case a.PrimitiveType.TRIANGLE_FAN:return t-2;default:return 0}}e.RenderingContext=class{constructor(e,t){this.gl=e,this.instanceCounter=new l.InstanceCounter,this.programCache=new u.ProgramCache(this),this._transformFeedbackRequestInfo=null,this._state=new o.ContextState,this._numOfDrawCalls=0,this._numOfTriangles=0,this.configure(t)}configure(e){this._capabilities=new f.Capabilities(this.gl,e),this._parameters=new c.Parameters(this.gl,this._capabilities,e),h.Texture.TEXTURE_UNIT_FOR_UPDATES=this._parameters.maxTextureImageUnits-1;const t=this.gl.getParameter(this.gl.VIEWPORT);this._state=new o.ContextState,this._state.viewport={x:t[0],y:t[1],width:t[2],height:t[3]},this._stateTracker=new d.StateTracker({setBlending:e=>{if(e){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(e.opRgb,e.opAlpha),this.setBlendFunctionSeparate(e.srcRgb,e.dstRgb,e.srcAlpha,e.dstAlpha);const t=e.color;this.setBlendColor(t.r,t.g,t.b,t.a)}else this.setBlendingEnabled(!1)},setCulling:e=>{e?(this.setFaceCullingEnabled(!0),this.setCullFace(e.face),this.setFrontFace(e.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:e=>{e?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(e.factor,e.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:e=>{e?(this.setDepthTestEnabled(!0),this.setDepthFunction(e.func)):this.setDepthTestEnabled(!1)},setStencilTest:e=>{if(e){this.setStencilTestEnabled(!0);const t=e.function;this.setStencilFunction(t.func,t.ref,t.mask);const r=e.operation;this.setStencilOp(r.fail,r.zFail,r.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:e=>{e?(this.setDepthWriteEnabled(!0),this.setDepthRange(e.zNear,e.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:e=>{e?this.setColorMask(e.r,e.g,e.b,e.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:e=>{e?this.setStencilWriteMask(e.mask):this.setStencilWriteMask(0)},setDrawBuffers:e=>{if(e)this.setDrawBuffers(e.buffers);else{const{drawFramebuffer:e}=this._state;null===e?this.setDrawBuffers([a.SpecialDrawBuffers.BACK]):0===e.colorAttachments.length?this.setDrawBuffers([a.SpecialDrawBuffers.NONE]):this.setDrawBuffers([a.ColorAttachment0])}}}),this.enforceState(),r.disposeMaybe(this._driverTest),this._driverTest=new m.WebGLDriverTest(this)}updateOptions(e){this._parameters=new c.Parameters(this.gl,this._capabilities,e)}dispose(){r.disposeMaybe(this._driverTest),this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(a.BufferType.ARRAY_BUFFER),this.unbindBuffer(a.BufferType.ELEMENT_ARRAY_BUFFER),this.unbindBuffer(a.BufferType.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(a.BufferType.PIXEL_PACK_BUFFER),this.unbindBuffer(a.BufferType.PIXEL_UNPACK_BUFFER),this.unbindBuffer(a.BufferType.COPY_READ_BUFFER),this.unbindBuffer(a.BufferType.COPY_WRITE_BUFFER),this._state.textureUnitMap.length=0,n.webglDebugEnabled()&&console.log(this.instanceCounter.resourceInformation)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(!0===e?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){this._state.program?.stop(),this._state.program=null}externalTextureUnitUpdate(e,t){for(let t=0;t<e.length;++t)this._state.textureUnitMap[e[t]]=null;t>=0&&(this._state.activeTexture=t)}externalVertexArrayObjectUpdate(){this.gl.bindVertexArray(null),this._state.vertexArrayObject=null,this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,t,r,i){e===this._state.blendColor.r&&t===this._state.blendColor.g&&r===this._state.blendColor.b&&i===this._state.blendColor.a||(this.gl.blendColor(e,t,r,i),this._state.blendColor.r=e,this._state.blendColor.g=t,this._state.blendColor.b=r,this._state.blendColor.a=i,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._state.blendFunction.srcRGB&&t===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,t),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,r,i){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===r&&this._state.blendFunction.dstRGB===t&&this._state.blendFunction.dstAlpha===i||(this.gl.blendFuncSeparate(e,t,r,i),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=r,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=i,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,r,i){this._state.colorMask.r===e&&this._state.colorMask.g===t&&this._state.colorMask.b===r&&this._state.colorMask.a===i||(this.gl.colorMask(e,t,r,i),this._state.colorMask.r=e,this._state.colorMask.g=t,this._state.colorMask.b=r,this._state.colorMask.a=i,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,r,i){this._state.clearColor.r===e&&this._state.clearColor.g===t&&this._state.clearColor.b===r&&this._state.clearColor.a===i||(this.gl.clearColor(e,t,r,i),this._state.clearColor.r=e,this._state.clearColor.g=t,this._state.clearColor.b=r,this._state.clearColor.a=i)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(!0===e?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(!0===e?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===t||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(!0===e?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,t,r,i){this._state.scissorRect.x===e&&this._state.scissorRect.y===t&&this._state.scissorRect.width===r&&this._state.scissorRect.height===i||(this.gl.scissor(e,t,r,i),this._state.scissorRect.x=e,this._state.scissorRect.y=t,this._state.scissorRect.width=r,this._state.scissorRect.height=i)}setDepthTestEnabled(e){this._state.depthTest!==e&&(!0===e?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===t||(this.gl.depthRange(e,t),this._state.depthRange.zNear=e,this._state.depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(!0===e?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,t,r){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===t&&this._state.stencilFunction.mask===r||(this.gl.stencilFunc(e,t,r),this._state.stencilFunction.face=a.Face.FRONT_AND_BACK,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=t,this._state.stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,r,i){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===r&&this._state.stencilFunction.mask===i||(this.gl.stencilFuncSeparate(e,t,r,i),this._state.stencilFunction.face=e,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=r,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,r){this._state.stencilOperation.face===a.Face.FRONT_AND_BACK&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===t&&this._state.stencilOperation.zPass===r||(this.gl.stencilOp(e,t,r),this._state.stencilOperation.face=a.Face.FRONT_AND_BACK,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=t,this._state.stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,r,i){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===r&&this._state.stencilOperation.zPass===i||(this.gl.stencilOpSeparate(e,t,r,i),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=r,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,t=!1){const r=this._state.activeTexture;return e>=0&&(t||e!==this._state.activeTexture)&&(this.gl.activeTexture(a.baseTextureUnit+e),this._state.activeTexture=e),r}setDrawBuffers(e){const{drawFramebuffer:t}=this._state,r=null===t,i=r?this._state.drawBuffers.defaultFramebuffer:this._state.drawBuffers.fbos.get(t);if(i?.length!==e.length||!i.every(((t,r)=>t===e[r])))if(e.length>this.parameters.maxDrawBuffers)console.error("Setting more active draw buffers than GL.MAX_DRAW_BUFFERS allows.");else{if(r){if(e.length>1)return void console.error("The default framebuffer can only have one active draw buffer.");if(e[0]!==a.SpecialDrawBuffers.BACK&&e[0]!==a.SpecialDrawBuffers.NONE)return void console.error("The default framebuffer can only use the constants GL.BACK or GL.NONE as draw buffers.")}r||!e.includes(a.SpecialDrawBuffers.BACK)?(this.gl.drawBuffers(e),r?this._state.drawBuffers.defaultFramebuffer=e:this._state.drawBuffers.fbos.set(t,e),this._stateTracker.invalidateDrawBuffers()):console.error("A framebuffer object can only use the constants GL.COLOR_ATTACHMENTi or GL.NONE as draw buffers.")}}clear(e,t=255){if(e){if(e&a.FramebufferBit.COLOR){const e=this._state.drawFramebuffer?.colorAttachments;e&&this.setDrawBuffers(e),this.setColorMask(!0,!0,!0,!0)}e&a.FramebufferBit.DEPTH&&this.setDepthWriteEnabled(!0),e&a.FramebufferBit.STENCIL&&this.setStencilWriteMask(t),this.gl.clear(e)}}clearFramebuffer(e,t=!1,r=!1){let i=0;if(e){const t=1e-13,r=Math.max(t,e[3]);this.setClearColor(e[0],e[1],e[2],r),i|=a.FramebufferBit.COLOR}t&&(i|=a.FramebufferBit.DEPTH),!1===r?r=0:(!0===r&&(r=255),i|=a.FramebufferBit.STENCIL),i&&this.clear(i,r)}clearBuffer(e,t,r=a.BufferContent.COLOR,i=void 0){this.gl.clearBufferfv(r,e,t,i)}clearBufferInteger(e,t,r=a.BufferContent.COLOR,i=void 0){this.gl.clearBufferiv(r,e,t,i)}clearBufferUnsignedInteger(e,t,r=a.BufferContent.COLOR,i=void 0){this.gl.clearBufferuiv(r,e,t,i)}drawArrays(e,r,i){if(this._transformFeedbackRequestInfo){if(e!==this._transformFeedbackRequestInfo.primitiveType)throw new Error("DrawArrays called during transform feedback, but primitiveType does not match that of the current transform feedback request");if(null==this._state.program?.hasTransformFeedbackVaryings)throw new Error("DrawArrays called during transform feedback, but the shader program was not linked with a transform feedback varying")}if(n.webglDebugEnabled()&&(this._numOfDrawCalls++,this._numOfTriangles+=y(e,i),t("enable-feature:webgl-debug:textureReadWrite"))){const e=this._state.textureUnitMap;for(let t=0;t<e.length;t++){const r=e[t];if(null!=r&&r===this._state.drawFramebuffer?.colorTexture)throw new Error(`Detected readWrite. Texture already bound at index ${t}`)}}this.gl.drawArrays(e,r,i),n.checkWebGLError(this.gl)}drawArraysInstanced(e,t,r,i){this.gl.drawArraysInstanced(e,t,r,i),n.checkWebGLError(this.gl)}drawElements(e,t,r,i){if(this._transformFeedbackRequestInfo)throw new Error("Cannot called drawElements during a transform feedback request");if(n.webglDebugEnabled()&&(this._numOfDrawCalls++,this._numOfTriangles+=y(e,t)),this.gl.drawElements(e,t,r,i),n.webglDebugEnabled()){const s=p.getErrorString(this);if(s){const n=this.getBoundVAO(),o=n?.indexBuffer,a=n?.vertexBuffers,l={indexBuffer:o,vertexBuffers:a},c={mode:e,count:t,type:r,offset:i},u=o?.size??0,d=i+t,h=u<d?`. Buffer is too small. Attempted to draw index ${d} of ${u}`:"";console.error(`drawElements: ${s}${h}`,{args:c,vao:l})}}}drawElementsInstanced(e,t,r,i,s){this.gl.drawElementsInstanced(e,t,r,i,s),n.checkWebGLError(this.gl)}logInfo(){n.webglDebugEnabled()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){n.webglDebugEnabled()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,t,r,i){r=Math.max(Math.round(r),1),i=Math.max(Math.round(i),1);const s=this._state.viewport;s.x===e&&s.y===t&&s.width===r&&s.height===i||(s.x=e,s.y=t,s.width=r,s.height=i,this.gl.viewport(e,t,r,i))}setViewport4fv(e){this.setViewport(e[0],e[1],e[2],e[3])}restoreViewport({x:e,y:t,width:r,height:i}){this.setViewport(e,t,r,i)}getViewport(){const e=this._state.viewport;return{x:e.x,y:e.y,width:e.width,height:e.height}}useProgram(e){this._state.program!==e&&(this._state.program?.stop(),this._state.program=e,this.gl.useProgram(e?.glName??null))}bindTexture(e,t,r=!1){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const i=this._state.textureUnitMap[t];return null==e?.glName?(null!=i&&(this.setActiveTexture(t,r),this.gl.bindTexture(i.descriptor.target,null)),this._state.textureUnitMap[t]=null,i):r||i!==e?(this.setActiveTexture(t,r),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[t]=e,i):(e.isDirty&&(this.setActiveTexture(t,r),e.applyChanges()),i)}unbindTexture(e){if(null!=e)for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._state.textureUnitMap[t]===e&&(this.bindTexture(null,t),this._state.textureUnitMap[t]=null)}bindFramebuffer(e,t=!1){if(t||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if(this._stateTracker.invalidateDrawBuffers(),null==e)return this.gl.bindFramebuffer(a.FramebufferTarget.FRAMEBUFFER,null),void(this._state.readFramebuffer=this._state.drawFramebuffer=null);e.initializeAndBind(a.FramebufferTarget.FRAMEBUFFER),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,t,r=!1){const i=t===a.FramebufferTarget.READ_FRAMEBUFFER,s=i?this._state.readFramebuffer:this._state.drawFramebuffer;(r||s!==e)&&(null==e?this.gl.bindFramebuffer(t,null):e.initializeAndBind(t),i?this._state.readFramebuffer=e??null:(this._stateTracker.invalidateDrawBuffers(),this._state.drawFramebuffer=e??null))}blitFramebuffer(e,t,r=a.FramebufferBit.COLOR,i=a.TextureSamplingMode.NEAREST,s=0,n=0,o=e.width,l=e.height,c=0,u=0,d=t.width,h=t.height){this.bindFramebufferSeparate(e,a.FramebufferTarget.READ_FRAMEBUFFER,!0),this.bindFramebufferSeparate(t,a.FramebufferTarget.DRAW_FRAMEBUFFER,!0),this.gl.blitFramebuffer(s,n,o,l,c,u,d,h,r,i)}bindBuffer(e,t){if(e)switch(t??=e.bufferType,t){case a.BufferType.ARRAY_BUFFER:this._state.vertexBuffer=g(this.gl,e,t,this._state.vertexBuffer);break;case a.BufferType.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=g(this.gl,e,t,this._state.indexBuffer);break;case a.BufferType.UNIFORM_BUFFER:this._state.uniformBuffer=g(this.gl,e,t,this._state.uniformBuffer);break;case a.BufferType.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=g(this.gl,e,t,this._state.pixelPackBuffer);break;case a.BufferType.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=g(this.gl,e,t,this._state.pixelUnpackBuffer);break;case a.BufferType.COPY_READ_BUFFER:this._state.copyReadBuffer=g(this.gl,e,t,this._state.copyReadBuffer);break;case a.BufferType.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=g(this.gl,e,t,this._state.copyWriteBuffer);break;case a.BufferType.TRANSFORM_FEEDBACK_BUFFER:this._state.transformFeedbackBuffer=g(this.gl,e,t,this._state.transformFeedbackBuffer)}}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,t){if(t>=this.parameters.maxUniformBufferBindings||t<0)return console.error("Uniform buffer binding point is out of range!"),null;const r=e===a.BufferType.UNIFORM_BUFFER?this._state.uniformBufferBindingPoints:this._state.transformBufferBindingPoints;let i=r[t];return null==i&&(i={buffer:null,offset:0,size:0},r[t]=i),i}bindBufferBase(e,t,r){const i=this._getBufferBinding(e,t);null!=i&&(i.buffer===r&&0===i.offset&&0===i.size||(this.gl.bindBufferBase(e,t,r?r.glName:null),i.buffer=r,i.offset=0,i.size=0))}bindBufferRange(e,t,r,i,s){const n=this._getBufferBinding(e,t);null!=n&&(n.buffer===r&&n.offset===i&&n.size===s||(i%this._parameters.uniformBufferOffsetAlignment===0?(this.gl.bindBufferRange(e,t,r.glName,i,s),n.buffer=r,n.offset=i,n.size=s):console.error("Uniform buffer binding offset is not a multiple of the context offset alignment")))}bindUBO(e,t,r,i){null!=t?(n.webglDebugEnabled()&&(i??t.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),t.initialize(),void 0!==r&&void 0!==i?this.bindBufferRange(a.BufferType.UNIFORM_BUFFER,e,t.buffer,r,i):this.bindBufferBase(a.BufferType.UNIFORM_BUFFER,e,t.buffer)):this.bindBufferBase(a.BufferType.UNIFORM_BUFFER,e,null)}unbindUBO(e){for(let t=0,r=this._state.uniformBufferBindingPoints.length;t<r;t++){const r=this._state.uniformBufferBindingPoints[t];null!=r&&r.buffer===e.buffer&&this.bindBufferBase(a.BufferType.UNIFORM_BUFFER,t,null)}}unbindBuffer(e){switch(e){case a.BufferType.ARRAY_BUFFER:this._state.vertexBuffer=g(this.gl,null,e,this._state.vertexBuffer);break;case a.BufferType.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=g(this.gl,null,e,this._state.indexBuffer);break;case a.BufferType.UNIFORM_BUFFER:this._state.uniformBuffer=g(this.gl,null,e,this._state.uniformBuffer);break;case a.BufferType.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=g(this.gl,null,e,this._state.pixelPackBuffer);break;case a.BufferType.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=g(this.gl,null,e,this._state.pixelUnpackBuffer);break;case a.BufferType.COPY_READ_BUFFER:this._state.copyReadBuffer=g(this.gl,null,e,this._state.copyReadBuffer);break;case a.BufferType.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=g(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e=null){null!=e?this._state.vertexArrayObject!==e&&(e.bind(),this._state.vertexArrayObject=e):this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null)}bindTransformFeedback(e){const{gl:t}=this;t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,e.glName)}beginTransformFeedback(e,t){if(this._transformFeedbackRequestInfo)throw new Error("Already in a transform feedback request");const{gl:r}=this;r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,e.glName),r.beginTransformFeedback(t),this._transformFeedbackRequestInfo={primitiveType:t}}endTransformFeedback(){if(!this._transformFeedbackRequestInfo)throw new Error("Not in a transform feedback request");const{gl:e}=this;e.endTransformFeedback(),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null),this._transformFeedbackRequestInfo=null}async clientWaitAsync(e=s.Milliseconds(10)){const{gl:t}=this,r=t.fenceSync(a.SyncCondition.SYNC_GPU_COMMANDS_COMPLETE,0);if(!r)throw new Error("Client wait failed, could not create sync object");let n;this.instanceCounter.increment(a.ResourceType.Sync,r),t.flush();do{await i.after(e),n=t.clientWaitSync(r,0,0)}while(n===a.ClientWaitSyncStatus.TIMEOUT_EXPIRED);if(this.instanceCounter.decrement(a.ResourceType.Sync,r),t.deleteSync(r),n===a.ClientWaitSyncStatus.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(e=a.FramebufferTarget.FRAMEBUFFER){return e===a.FramebufferTarget.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}temporaryBindFramebufferObject(e,t,r=!1){const i=this.getBoundFramebufferObject();try{this.bindFramebuffer(e,r),t()}finally{this.bindFramebuffer(i,r)}}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(a.BufferType.ARRAY_BUFFER),this.unbindBuffer(a.BufferType.ELEMENT_ARRAY_BUFFER),this.unbindBuffer(a.BufferType.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(a.BufferType.PIXEL_PACK_BUFFER),this.unbindBuffer(a.BufferType.PIXEL_UNPACK_BUFFER),this.unbindBuffer(a.BufferType.COPY_READ_BUFFER),this.unbindBuffer(a.BufferType.COPY_WRITE_BUFFER);for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(a.BlendFactor.ONE,a.BlendFactor.ZERO),this.setBlendEquation(a.BlendOperation.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(a.Face.BACK),this.setFrontFace(a.CullMode.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(a.CompareFunction.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(a.CompareFunction.ALWAYS,0,0),this.setStencilOp(a.StencilOperation.KEEP,a.StencilOperation.KEEP,a.StencilOperation.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setDrawBuffers([a.SpecialDrawBuffers.BACK]),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){const{gl:e}=this;e.bindVertexArray(null);for(let t=0;t<this.parameters.maxVertexAttributes;t++)e.disableVertexAttribArray(t);this._state.vertexBuffer?e.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):e.bindBuffer(a.BufferType.ARRAY_BUFFER,null),this._state.indexBuffer?e.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):e.bindBuffer(a.BufferType.ELEMENT_ARRAY_BUFFER,null),this._state.uniformBuffer?e.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):e.bindBuffer(a.BufferType.UNIFORM_BUFFER,null);for(let t=0;t<this._parameters.maxUniformBufferBindings;t++){const r=this._state.uniformBufferBindingPoints[t];if(null!=r){const{buffer:i,offset:s,size:n}=r;null!==i?0===s&&0===n?e.bindBufferBase(a.BufferType.UNIFORM_BUFFER,t,i.glName):e.bindBufferRange(a.BufferType.UNIFORM_BUFFER,t,i.glName,s,n):e.bindBufferBase(a.BufferType.UNIFORM_BUFFER,t,null)}}if(this._state.pixelPackBuffer?e.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):e.bindBuffer(a.BufferType.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?e.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):e.bindBuffer(a.BufferType.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?e.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):e.bindBuffer(a.BufferType.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?e.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):e.bindBuffer(a.BufferType.COPY_WRITE_BUFFER,null),e.bindFramebuffer(a.FramebufferTarget.READ_FRAMEBUFFER,null),e.readBuffer(e.BACK),this._state.readFramebuffer&&(e.bindFramebuffer(a.FramebufferTarget.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),e.readBuffer(a.ColorAttachment0)),e.bindFramebuffer(a.FramebufferTarget.DRAW_FRAMEBUFFER,this._state.drawFramebuffer?.glName??null),null===this._state.drawFramebuffer){const t=this._state.drawBuffers.defaultFramebuffer;e.drawBuffers(t??[a.SpecialDrawBuffers.BACK])}else{const t=this._state.drawBuffers.fbos.get(this._state.drawFramebuffer);e.drawBuffers(t??[a.ColorAttachment0])}if(this._state.vertexArrayObject){const e=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(e)}e.useProgram(this._state.program?.glName??null),e.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),e.bindRenderbuffer(e.RENDERBUFFER,this._state.renderbuffer?.glName??null),!0===this._state.blend?e.enable(this.gl.BLEND):e.disable(this.gl.BLEND),e.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),e.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),e.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),e.clearDepth(this._state.clearDepth),e.clearStencil(this._state.clearStencil),e.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),e.cullFace(this._state.cullFace),e.depthFunc(this._state.depthFunction),e.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),!0===this._state.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(this._state.depthWrite),e.frontFace(this._state.frontFace),e.lineWidth(1),!0===this._state.faceCulling?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),!0===this._state.polygonOffsetFill?e.enable(e.POLYGON_OFFSET_FILL):e.disable(e.POLYGON_OFFSET_FILL),e.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),!0===this._state.scissorTest?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),e.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),e.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),!0===this._state.stencilTest?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.stencilMask(this._state.stencilWriteMask);for(let t=0;t<this.parameters.maxTextureImageUnits;t++){e.activeTexture(a.baseTextureUnit+t),e.bindTexture(a.TextureType.TEXTURE_2D,null),e.bindTexture(a.TextureType.TEXTURE_CUBE_MAP,null),e.bindTexture(a.TextureType.TEXTURE_3D,null),e.bindTexture(a.TextureType.TEXTURE_2D_ARRAY,null);const r=this._state.textureUnitMap[t];null!=r&&e.bindTexture(r.descriptor.target,r.glName)}e.activeTexture(a.baseTextureUnit+this._state.activeTexture);const t=this._state.viewport;e.viewport(t.x,t.y,t.width,t.height),this.resetInfo()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/ContextState":function(){define(["exports","./enums"],(function(e,t){"use strict";e.ContextState=class{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:t.BlendFactor.ONE,dstRGB:t.BlendFactor.ZERO,srcAlpha:t.BlendFactor.ONE,dstAlpha:t.BlendFactor.ZERO},this.blendEquation={mode:t.BlendOperation.ADD,modeAlpha:t.BlendOperation.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=t.Face.BACK,this.frontFace=t.CullMode.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=t.CompareFunction.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:t.Face.FRONT_AND_BACK,func:t.CompareFunction.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:t.Face.FRONT_AND_BACK,fail:t.StencilOperation.KEEP,zFail:t.StencilOperation.KEEP,zPass:t.StencilOperation.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.transformFeedbackBuffer=null,this.uniformBufferBindingPoints=new Array,this.transformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.drawBuffers={defaultFramebuffer:[t.SpecialDrawBuffers.BACK],fbos:new WeakMap},this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array,this.vertexArrayObject=null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/InstanceCounter":function(){define(["exports","./AllocationTracer","./enums"],(function(e,t,r){"use strict";const i={RECORD_ALLOCATIONS:!1};e.InstanceCounter=class{constructor(){for(this._current=new Array,this._allocations=i.RECORD_ALLOCATIONS?new t.AllocationTracer("WebGLObject"):null;this._current.length<r.ResourceType.COUNT;)this._current.push(0)}increment(e,t,r=1){this._current[e]+=r,this._allocations?.add(t)}decrement(e,t,r=1){this._current[e]-=r,this._allocations?.remove(t)}get current(){return this._current}get total(){return this.current.reduce(((e,t,i)=>e+(i<r.ResourceType.UNCOUNTED?t:0)),0)}get resourceInformation(){let e="";if(this.total>0){e+="Live objects:\n";for(let t=0;t<r.ResourceType.COUNT;++t){const i=this._current[t];i>0&&(e+=`${r.ResourceType[t]}: ${i}\n`)}}return e+=this._allocations?.resetLog(),e}},e.test=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/AllocationTracer":function(){define(["exports"],(function(e){"use strict";class t{constructor(e){this.from=e,this.retains=new Array,this.releases=new Array}}e.AllocationTracer=class{constructor(e){this._objectType=e,this._active=new Map}get _stack(){const e=(new Error).stack.split("\n");return e.shift(),e.shift(),e.shift(),e.join("\n")}add(e){this._active.set(e,new t(this._stack))}remove(e){this._active.delete(e)}addReference(e){const t=this._active.get(e);t&&t.retains.push(this._stack)}removeReference(e){const t=this._active.get(e);t&&t.releases.push(this._stack)}resetLog(){const e=new Map;let t="";this._active.forEach(((r,{usedMemory:i})=>{e.has(r.from)||(e.set(r.from,new Map),r.retains.length>0&&(t+=`  First reference count mismatch:\n  Retain:\n    ${r.retains.join("\n\n    ")}\n\n  Release:    ${r.releases.join("\n\n    ")}\n`));const s=e.get(r.from);s.set(i??0,s.get(i??0)??1)})),this._active.clear();let r=0;const i=new Array;return e.forEach(((e,t)=>{let s=0;e.forEach(((e,t)=>s+=e*t)),e.set(-1,s),r+=s,i.push([t,e])})),e.clear(),i.sort(((e,t)=>t[1].get(-1)-e[1].get(-1))),i.reduce(((e,[t,r])=>{const i=Math.round(r.get(-1)/1024);return r.delete(-1),e+`  ${i}KB from ${Array.from(r.values()).reduce(((e,t)=>e+t),0)} allocations at ${t}\n`}),`Total ${this._objectType} memory: ${Math.round(r/1024)}KB\n${t}`)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/Parameters":function(){define(["exports"],(function(e){"use strict";e.Parameters=class{constructor(e,t,r){const i=t.textureFilterAnisotropic;this.versionString=e.getParameter(e.VERSION),this.maxVertexTextureImageUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS);const s=r.maxAnisotropy??1/0;this.maxMaxAnisotropy=i?Math.min(e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY),s):1,this.maxTextureImageUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPreferredTexturePixels=r.maxPreferredTexturePixels??1/0,this.maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxViewportDims=e.getParameter(e.MAX_VIEWPORT_DIMS),this.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this.maxVertexUniformBlocks=e.getParameter(e.MAX_VERTEX_UNIFORM_BLOCKS),this.maxFragmentUniformBlocks=e.getParameter(e.MAX_FRAGMENT_UNIFORM_BLOCKS),this.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this.uniformBufferOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this.maxArrayTextureLayers=e.getParameter(e.MAX_ARRAY_TEXTURE_LAYERS),this.maxSamples=e.getParameter(e.MAX_SAMPLES),this.maxDrawBuffers=e.getParameter(e.MAX_DRAW_BUFFERS)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/ProgramCache":function(){define(["exports","../../core/has","../../core/NestedMap","./Program"],(function(e,t,r,i){"use strict";e.ProgramCache=class{constructor(e){this._rctx=e,this._store=new r.NestedMap}dispose(){this._store.forAll((e=>e.dispose())),this._store.clear()}acquire(e,t,r,s){const n=this._store.get(e,t);if(null!=n)return n.ref(),n;const o=new i.Program(this._rctx,e,t,r,s);return o.ref(),this._store.set(e,t,o),o}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/Program":function(){define(["exports","../../core/has","./checkWebGLError","./enums","./ShaderTranspiler"],(function(e,t,r,i,s){"use strict";function n(e,t,s){const n=e.gl,o=n.createShader(t);return n.shaderSource(o,s),n.compileShader(o),r.webglValidateShadersEnabled()&&!n.getShaderParameter(o,n.COMPILE_STATUS)&&(console.error("Compile error in ".concat(t===i.ShaderType.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(n.getShaderInfoLog(o)),console.error(function(e){let t=2;return e.replaceAll("\n",(()=>{return"\n"+((e=t++)>=1e3?e.toString():("  "+e).slice(-3))+":";var e}))}(s))),o}function o(e,t,r){const i=e.get(t);if(!i)return e.set(t,Array.from(r)),!0;const s=r.length;if(i.length!==s)return e.set(t,Array.from(r)),!0;for(let e=0;e<s;++e){const t=r[e];if(i[e]!==t){for(i[e]=t;e<s;++e)i[e]=r[e];return!0}}return!1}const a={enabled:!1},l=r.webglDebugEnabled()?(...e)=>c(e):()=>{},c=r.webglDebugEnabled()?e=>{const t=e.length;for(let r=0;r<t;++r){const t=e[r];Number.isNaN(t)&&console.error(`Got ${t} as uniform value from ${(new Error).stack}`)}}:()=>{};e.Program=class{constructor(e,t,o,l,c=new Map,u=[]){this._context=e,this._locations=l,this._uniformBlockBindings=c,this._transformFeedbackVaryings=u,this._refCount=1,this._compiled=!1,this._linesOfCode=0,this._nameToUniformLocation=new Map,this._nameToUniform1=new Map,this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),0===t.length&&console.error("Shaders source should not be empty!"),t=s.transpileShader(t,i.ShaderType.VERTEX_SHADER),o=s.transpileShader(o,i.ShaderType.FRAGMENT_SHADER),this._vShader=n(this._context,i.ShaderType.VERTEX_SHADER,t),this._fShader=n(this._context,i.ShaderType.FRAGMENT_SHADER,o),a.enabled&&(this._linesOfCode=t.match(/\n/g).length+o.match(/\n/g).length+2,this._context.instanceCounter.increment(i.ResourceType.LinesOfCode,this._vShader,this._linesOfCode)),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(i.ResourceType.Shader,this),r.webglValidateShadersEnabled()&&(this.vertexShader=t,this.fragmentShader=o),this.usedMemory=t.length+o.length;const d=this._context.gl,h=d.createProgram();d.attachShader(h,this._vShader),d.attachShader(h,this._fShader),this._locations.forEach(((e,t)=>d.bindAttribLocation(h,e,t))),this._transformFeedbackVaryings?.length&&d.transformFeedbackVaryings(h,this._transformFeedbackVaryings,d.SEPARATE_ATTRIBS),d.linkProgram(h),r.webglValidateShadersEnabled()&&!d.getProgramParameter(h,d.LINK_STATUS)&&console.error(`Could not link shader\nvalidated: ${d.getProgramParameter(h,d.VALIDATE_STATUS)}, gl error ${d.getError()}, vertex: ${d.getShaderParameter(this._vShader,d.COMPILE_STATUS)}, fragment: ${d.getShaderParameter(this._fShader,d.COMPILE_STATUS)}, info log: ${d.getProgramInfoLog(h)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`);for(const[e,t]of this._uniformBlockBindings){const r=d.getUniformBlockIndex(h,e);r<4294967295&&d.uniformBlockBinding(h,r,t)}this._glName=h,this._context.instanceCounter.increment(i.ResourceType.Program,this)}get glName(){return this._glName}get hasGLName(){return null!=this._glName}get hasTransformFeedbackVaryings(){return!!this._transformFeedbackVaryings?.length}get compiled(){return!!this._compiled||(this._context.capabilities.parallelShaderCompile&&null!=this.glName?(this._compiled=!!this._context.gl.getProgramParameter(this.glName,i.Extension.COMPLETION_STATUS_KHR),this._compiled):(this._compiled=!0,!0))}dispose(){if(--this._refCount>0)return;const e=this._context.gl,t=this._context.instanceCounter;this._nameToUniformLocation.forEach((e=>e&&t.decrement(i.ResourceType.Uniform,e))),this._nameToUniformLocation.clear(),this._vShader&&(this._linesOfCode>0&&(t.decrement(i.ResourceType.LinesOfCode,this._vShader,this._linesOfCode),this._linesOfCode=0),e.deleteShader(this._vShader),this._vShader=null,t.decrement(i.ResourceType.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,t.decrement(i.ResourceType.Program,this))}ref(){++this._refCount}_getUniformLocation(e){const t=this._nameToUniformLocation.get(e);if(void 0!==t)return t;if(this.glName){const t=this._context.gl.getUniformLocation(this.glName,e);return this._nameToUniformLocation.set(e,t),t&&this._context.instanceCounter.increment(i.ResourceType.Uniform,t),t}return null}hasUniform(e){return null!=this._getUniformLocation(e)}setUniform1i(e,t){l(t);const r=this._nameToUniform1.get(e);void 0!==r&&t===r||(this._context.gl.uniform1i(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1iv(e,t){c(t),o(this._nameToUniform1v,e,t)&&this._context.gl.uniform1iv(this._getUniformLocation(e),t)}setUniform2iv(e,t){c(t),o(this._nameToUniform2,e,t)&&this._context.gl.uniform2iv(this._getUniformLocation(e),t)}setUniform3iv(e,t){c(t),o(this._nameToUniform3,e,t)&&this._context.gl.uniform3iv(this._getUniformLocation(e),t)}setUniform4iv(e,t){c(t),o(this._nameToUniform4,e,t)&&this._context.gl.uniform4iv(this._getUniformLocation(e),t)}setUniform1f(e,t){l(t);const r=this._nameToUniform1.get(e);void 0!==r&&t===r||(this._context.gl.uniform1f(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1fv(e,t){c(t),o(this._nameToUniform1v,e,t)&&this._context.gl.uniform1fv(this._getUniformLocation(e),t)}setUniform2f(e,t,r){l(t,r);const i=this._nameToUniform2.get(e);void 0===i?(this._context.gl.uniform2f(this._getUniformLocation(e),t,r),this._nameToUniform2.set(e,[t,r])):t===i[0]&&r===i[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),t,r),i[0]=t,i[1]=r)}setUniform2fv(e,t){c(t),o(this._nameToUniform2,e,t)&&this._context.gl.uniform2fv(this._getUniformLocation(e),t)}setUniform3f(e,t,r,i){l(t,r,i);const s=this._nameToUniform3.get(e);void 0===s?(this._context.gl.uniform3f(this._getUniformLocation(e),t,r,i),this._nameToUniform3.set(e,[t,r,i])):t===s[0]&&r===s[1]&&i===s[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),t,r,i),s[0]=t,s[1]=r,s[2]=i)}setUniform3fv(e,t){c(t);const r=this._getUniformLocation(e);null!=r&&o(this._nameToUniform3,e,t)&&this._context.gl.uniform3fv(r,t)}setUniform4f(e,t,r,i,s){l(t,r,i,s);const n=this._nameToUniform4.get(e);void 0===n?(this._context.gl.uniform4f(this._getUniformLocation(e),t,r,i,s),this._nameToUniform4.set(e,[t,r,i,s])):void 0!==n&&t===n[0]&&r===n[1]&&i===n[2]&&s===n[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),t,r,i,s),n[0]=t,n[1]=r,n[2]=i,n[3]=s)}setUniform4fv(e,t){c(t);const r=this._getUniformLocation(e);null!=r&&o(this._nameToUniform4,e,t)&&this._context.gl.uniform4fv(r,t)}setUniformMatrix3fv(e,t,r=!1){c(t);const i=this._getUniformLocation(e);null!=i&&o(this._nameToUniformMatrix3,e,t)&&this._context.gl.uniformMatrix3fv(i,r,t)}setUniformMatrix4fv(e,t,r=!1){c(t);const i=this._getUniformLocation(e);null!=i&&o(this._nameToUniformMatrix4,e,t)&&this._context.gl.uniformMatrix4fv(i,r,t)}stop(){}},e.test=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/ShaderTranspiler":function(){define(["exports","../../core/has","./enums","./reservedWordsGLSL3","./testUtils"],(function(e,t,r,i,s){"use strict";const n=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","uvec2","uvec3","uvec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","usampler1D","usampler2D","usampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"],o=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"],a=["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"];var l=999,c=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];const u=new Set(["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"]);function d(e,t){for(let r=t-1;r>=0;r--){const t=e[r];if("whitespace"!==t.type&&"block-comment"!==t.type){if("keyword"!==t.type)break;if("attribute"===t.data||"in"===t.data)return!0}}return!1}function h(e,t,r,i){i=i||r;for(const s of e)if("ident"===s.type&&s.data===r)return i in t?t[i]++:t[i]=0,h(e,t,i+"_"+t[i],i);return r}function p(e,t,r="afterVersion"){function i(e,t){for(let r=t;r<e.length;r++){const t=e[r];if("operator"===t.type&&";"===t.data)return r}return null}const s={data:"\n",type:"whitespace"},n=t=>t<e.length&&/[^\r\n]$/.test(e[t].data);let o=function(e){let t=-1,s=0,n=-1;for(let o=0;o<e.length;o++){const a=e[o];if("preprocessor"===a.type&&(/#(if|ifdef|ifndef)\s+.+/.test(a.data)?++s:/#endif\s*.*/.test(a.data)&&--s),"afterVersion"!==r&&"afterPrecision"!==r||"preprocessor"===a.type&&a.data.startsWith("#version")&&(n=Math.max(n,o)),"afterPrecision"===r&&"keyword"===a.type&&"precision"===a.data){const t=i(e,o);if(null===t)throw new Error("precision statement not followed by any semicolons!");n=Math.max(n,t)}t<n&&0===s&&(t=o)}return t+1}(e);n(o-1)&&e.splice(o++,0,s);for(const r of t)e.splice(o++,0,r);n(o-1)&&n(o)&&e.splice(o,0,s)}function m(e,t,r,i="lowp"){p(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function f(e,t,r,i,s="lowp"){p(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:i.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function g(e,t){let r,i,s=-1;for(let n=t;n<e.length;n++){const t=e[n];if("operator"===t.type&&("["===t.data&&(r=n),"]"===t.data)){i=n;break}"integer"===t.type&&(s=parseInt(t.data,10))}return r&&i&&e.splice(r,i-r+1),s}const y=new Map;e.transpileShader=function(e,t){if(e.startsWith("#version 300"))return e;const p=function(e){return s.shaderTranspiler.enableCache?y.get(e):null}(e);if(null!=p)return p;const _=function(e){return t=e,r=function(){var e,t,r,i=0,s=0,u=l,d=[],h=[],p=1,m=0,f=0,g=!1,y=!1,_="";return function(t){return h=[],null!==t?function(t){var n;for(i=0,r=(_+=t).length;e=_[i],i<r;){switch(n=i,u){case 0:i=x();break;case 1:case 2:i=w();break;case 3:i=T();break;case 4:i=M();break;case 11:i=P();break;case 5:i=R();break;case 9999:i=E();break;case 9:i=S();break;case l:i=v()}n!==i&&("\n"===_[n]?(m=0,++p):++m)}return s+=i,_=_.slice(i),h}(t.replace?t.replace(/\r\n/g,"\n"):t):(d.length&&b(d.join("")),u=10,b("(eof)"),h)};function b(e){e.length&&h.push({type:c[u],data:e,position:f,line:p,column:m})}function v(){return d=d.length?[]:d,"/"===t&&"*"===e?(f=s+i-1,u=0,t=e,i+1):"/"===t&&"/"===e?(f=s+i-1,u=1,t=e,i+1):"#"===e?(u=2,f=s+i,i):/\s/.test(e)?(u=9,f=s+i,i):(g=/\d/.test(e),y=/[^\w_]/.test(e),f=s+i,u=g?4:y?3:9999,i)}function S(){return/[^\s]/g.test(e)?(b(d.join("")),u=l,i):(d.push(e),t=e,i+1)}function w(){return"\r"!==e&&"\n"!==e||"\\"===t?(d.push(e),t=e,i+1):(b(d.join("")),u=l,i)}function x(){return"/"===e&&"*"===t?(d.push(e),b(d.join("")),u=l,i+1):(d.push(e),t=e,i+1)}function T(){if("."===t&&/\d/.test(e))return u=5,i;if("/"===t&&"*"===e)return u=0,i;if("/"===t&&"/"===e)return u=1,i;if("."===e&&d.length){for(;C(d););return u=5,i}if(";"===e||")"===e||"("===e){if(d.length)for(;C(d););return b(e),u=l,i+1}var r=2===d.length&&"="!==e;if(/[\w_\d\s]/.test(e)||r){for(;C(d););return u=l,i}return d.push(e),t=e,i+1}function C(e){for(var t,r,i=0;;){if(t=o.indexOf(e.slice(0,e.length+i).join("")),r=o[t],-1===t){if(i--+e.length>0)continue;r=e.slice(0,1).join("")}return b(r),f+=r.length,(d=d.slice(r.length)).length}}function P(){return/[^a-fA-F0-9]/.test(e)?(b(d.join("")),u=l,i):(d.push(e),t=e,i+1)}function M(){return"."===e||/[eE]/.test(e)?(d.push(e),u=5,t=e,i+1):"x"===e&&1===d.length&&"0"===d[0]?(u=11,d.push(e),t=e,i+1):/[^\d]/.test(e)?(b(d.join("")),u=l,i):(d.push(e),t=e,i+1)}function R(){return"f"===e&&(d.push(e),t=e,i+=1),/[eE]/.test(e)||"-"===e&&/[eE]/.test(t)?(d.push(e),t=e,i+1):/[^\d]/.test(e)?(b(d.join("")),u=l,i):(d.push(e),t=e,i+1)}function E(){if(/[^\d\w_]/.test(e)){var r=d.join("");return u=n.indexOf(r)>-1?8:a.indexOf(r)>-1?7:6,b(d.join("")),u=l,i}return d.push(e),t=e,i+1}}(),[].concat(r(t)).concat(r(null));var t,r}(e);if("300 es"===function(e,t="100",r="300 es"){const i=/^\s*#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of e)if("preprocessor"===s.type){const e=i.exec(s.data);if(e){const i=e[1].replaceAll(/\s{2,}/g," ");if(i===r)return i;if(i===t)return s.data="#version "+r,t;throw new Error("unknown glsl version: "+i)}}return e.splice(0,0,{type:"preprocessor",data:"#version "+r},{type:"whitespace",data:"\n"}),null}(_,"100","300 es"))return e;let b=null,v=null;const S={},w={};for(let e=0;e<_.length;++e){const s=_[e];switch(s.type){case"keyword":t===r.ShaderType.VERTEX_SHADER&&"attribute"===s.data?s.data="in":"varying"===s.data&&(s.data=t===r.ShaderType.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(s.data.trim())&&(s.data=s.data.replaceAll(/(2D|Cube|EXT)/g,"")),t===r.ShaderType.FRAGMENT_SHADER&&"gl_FragColor"===s.data&&(b||(b=h(_,S,"fragColor"),m(_,b,"vec4")),s.data=b),t===r.ShaderType.FRAGMENT_SHADER&&"gl_FragData"===s.data){const t=g(_,e+1),r=h(_,S,"fragData");f(_,r,"vec4",t,"mediump"),s.data=r}else t===r.ShaderType.FRAGMENT_SHADER&&"gl_FragDepthEXT"===s.data&&(v||(v=h(_,S,"gl_FragDepth")),s.data=v);break;case"ident":if(i.includes(s.data)){if(t===r.ShaderType.VERTEX_SHADER&&d(_,e))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");s.data in w||(w[s.data]=h(_,S,s.data)),s.data=w[s.data]}}}for(let e=_.length-1;e>=0;--e){const t=_[e];if("preprocessor"===t.type){const r=t.data.match(/#extension\s+(.*):/);if(r?.[1]&&u.has(r[1].trim())){const t=_[e+1];_.splice(e,t&&"whitespace"===t.type?2:1)}const i=t.data.match(/#ifdef\s+(.*)/);i?.[1]&&u.has(i[1].trim())&&(t.data="#if 1");const s=t.data.match(/#ifndef\s+(.*)/);s?.[1]&&u.has(s[1].trim())&&(t.data="#if 0")}}return function(e,t){return s.shaderTranspiler.enableCache&&y.set(e,t),t}(e,function(e){return e.map((e=>"eof"!==e.type?e.data:"")).join("")}(_))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/reservedWordsGLSL3":function(){define((function(){"use strict";return["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"]}))},"esri/views/webgl/testUtils":function(){define(["exports"],(function(e){"use strict";e.shaderTranspiler={enableCache:!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/WebGLDriverTest":function(){define(["exports","./testAppleAmdDrawArrays","./testFloatBufferBlend","./testSVGPremultipliedAlpha"],(function(e,t,r,i){"use strict";e.WebGLDriverTest=class{constructor(e){this.rctx=e,this.floatBufferBlend=new r.FloatBufferBlend(e),this.svgPremultipliesAlpha=new i.SVGPremultipliedAlpha(e),this.drawArraysRequiresIndicesTypeReset=new t.DrawArraysRequiresIndicesTypeReset(e)}dispose(){this.svgPremultipliesAlpha.dispose(),this.floatBufferBlend.dispose(),this.drawArraysRequiresIndicesTypeReset.dispose()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/testAppleAmdDrawArrays":function(){define(["exports","../../core/has","../3d/webgl-engine/core/shaderModules/glsl","./AppleAmdDriverHelper","./BufferObject","./enums","./FramebufferObject","./TextureDescriptor","./WebGLDriverTestModule"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.WebGLDriverTestModule{constructor(e){super(),this._rctx=e,this._helperProgram=null,t("mac")&&t("chrome")&&(this._program=this._prepareProgram(),this._helperProgram=this._prepareHelperProgram())}dispose(){super.dispose(),this._helperProgram?.dispose(),this._helperProgram=null}_test(e){const t=this._rctx,r=t.getBoundFramebufferObject(),{x:i,y:l,width:c,height:u}=t.getViewport();t.resetState();const d=new a.TextureDescriptor(1);d.wrapMode=n.TextureWrapMode.CLAMP_TO_EDGE,d.samplingMode=n.TextureSamplingMode.NEAREST;const h=new o.FramebufferObject(t,d),p=s.BufferObject.createIndex(this._rctx,n.Usage.STATIC_DRAW,new Uint8Array([0]));t.bindFramebuffer(h),t.setViewport(0,0,1,1),t.useProgram(this._helperProgram),t.bindBuffer(p,n.BufferType.ELEMENT_ARRAY_BUFFER),t.drawElements(n.PrimitiveType.POINTS,1,n.DataType.UNSIGNED_BYTE,0),t.useProgram(e),t.bindVAO(null),t.drawArrays(n.PrimitiveType.TRIANGLES,0,258);const m=new Uint8Array(4);return h.readPixels(0,0,1,1,n.PixelFormat.RGBA,n.PixelType.UNSIGNED_BYTE,m),t.setViewport(i,l,c,u),t.bindFramebuffer(r),h.dispose(),p.dispose(),255===m[0]}_prepareProgram(){const e=`#version 300 es\n    precision highp float;\n\n    out float triangleId;\n\n    const vec3 triangleVertices[3] = vec3[3](vec3(-0.5, -0.5, 0.0), vec3(0.5, -0.5, 0.0), vec3(0.0, 0.5, 0.0));\n\n    void main(void) {\n      triangleId = floor(float(gl_VertexID)/3.0);\n\n      vec3 position = triangleVertices[gl_VertexID % 3];\n      float offset = triangleId / ${r.glsl.float(85)};\n      position.z = 0.5 - offset;\n\n      gl_Position = vec4(position, 1.0);\n    }\n    `,t=`#version 300 es\n    precision highp float;\n\n    in float triangleId;\n\n    out vec4 fragColor;\n\n    void main(void) {\n      fragColor = triangleId == ${r.glsl.float(85)} ? vec4(0.0, 1.0, 0.0, 1.0) : vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    `;return this._rctx.programCache.acquire(e,t,new Map([]))}_prepareHelperProgram(){const e=i.AppleAmdDriverHelper.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}}e.DrawArraysRequiresIndicesTypeReset=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/WebGLDriverTestModule":function(){define(["exports","../../core/maybe"],(function(e,t){"use strict";e.WebGLDriverTestModule=class{constructor(){this._result=!1}dispose(){this._program=t.disposeMaybe(this._program)}get result(){return null!=this._program&&(this._result=this._test(this._program),this.dispose()),this._result}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/testFloatBufferBlend":function(){define(["exports","./BufferObject","./enums","./FramebufferObject","./renderState","./TextureDescriptor","./VertexArrayObject","./VertexElementDescriptor","./WebGLDriverTestModule"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.WebGLDriverTestModule{constructor(e){super(),this._rctx=e,e.gl&&e.capabilities.colorBufferFloat?.textureFloat&&e.capabilities.colorBufferFloat?.floatBlend&&(this._program=e.programCache.acquire("\n    precision highp float;\n    attribute vec2 a_pos;\n\n    void main() {\n      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n    }\n    ","\n     precision highp float;\n\n     void main() {\n      gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);\n     }\n    ",new Map([["a_pos",0]])))}_test(e){const l=this._rctx,c=new n.TextureDescriptor(1);c.wrapMode=r.TextureWrapMode.CLAMP_TO_EDGE,c.dataType=r.PixelType.FLOAT,c.internalFormat=r.SizedPixelFormat.RGBA32F,c.samplingMode=r.TextureSamplingMode.NEAREST;const u=new i.FramebufferObject(l,c),d=t.BufferObject.createVertex(l,r.Usage.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),h=new o.VertexArrayObject(l,new Map([["a_pos",0]]),new Map([["geometry",[new a.VertexElementDescriptor("a_pos",2,r.DataType.UNSIGNED_SHORT,0,4)]]]),new Map([["geometry",d]]));l.gl.getError(),l.useProgram(e);const p=l.getBoundFramebufferObject(),{x:m,y:f,width:g,height:y}=l.getViewport();l.bindFramebuffer(u),l.setViewport(0,0,1,1),l.bindVAO(h),l.drawArrays(r.PrimitiveType.TRIANGLE_STRIP,0,4);const _=s.makePipelineState({blending:s.destinationTimesOneMinusSourceAlpha});l.setPipelineState(_),l.drawArrays(r.PrimitiveType.TRIANGLE_STRIP,0,4);const b=l.gl.getError();return l.setViewport(m,f,g,y),l.bindFramebuffer(p),h.dispose(),u.dispose(),b!==r.ErrorConstant.INVALID_OPERATION||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}}e.FloatBufferBlend=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/testSVGPremultipliedAlpha":function(){define(["exports","../2d/engine/webgl/DefaultVertexAttributeLayouts","./BufferObject","./enums","./FramebufferObject","./Texture","./TextureDescriptor","./VertexArrayObject","./WebGLDriverTestModule"],(function(e,t,r,i,s,n,o,a,l){"use strict";class c extends l.WebGLDriverTestModule{constructor(e){super(),this._rctx=e,this._program=e.programCache.acquire("\n    precision highp float;\n\n    attribute vec2 a_pos;\n    varying vec2 v_uv;\n\n    void main() {\n      v_uv = a_pos;\n      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n    }\n    ","\n    precision highp float;\n\n    varying vec2 v_uv;\n\n    uniform sampler2D u_texture;\n\n    void main() {\n      gl_FragColor = texture2D(u_texture, v_uv);\n    }\n    ",new Map([["a_pos",0]]))}dispose(){super.dispose()}_test(e){const l=this._rctx;if(!l.gl)return e.dispose(),!0;const c=new o.TextureDescriptor(1);c.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE,c.samplingMode=i.TextureSamplingMode.NEAREST;const d=new s.FramebufferObject(l,c),h=r.BufferObject.createVertex(l,i.Usage.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),p=new a.VertexArrayObject(l,new Map([["a_pos",0]]),t.Pos2us,new Map([["geometry",h]])),m=new o.TextureDescriptor;m.samplingMode=i.TextureSamplingMode.LINEAR,m.wrapMode=i.TextureWrapMode.CLAMP_TO_EDGE;const f=new n.Texture(l,m,u);l.useProgram(e),l.bindTexture(f,0),e.setUniform1i("u_texture",0);const g=l.getBoundFramebufferObject(),{x:y,y:_,width:b,height:v}=l.getViewport();l.bindFramebuffer(d),l.setViewport(0,0,1,1),l.setClearColor(0,0,0,0),l.setBlendingEnabled(!1),l.clear(i.FramebufferBit.COLOR),l.bindVAO(p),l.drawArrays(i.PrimitiveType.TRIANGLE_STRIP,0,4);const S=new Uint8Array(4);return d.readPixels(0,0,1,1,i.PixelFormat.RGBA,i.PixelType.UNSIGNED_BYTE,S),p.dispose(),d.dispose(),f.dispose(),l.setViewport(y,_,b,v),l.bindFramebuffer(g),255!==S[0]}}const u=new Image;u.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",u.width=5,u.height=5,u.decode(),e.SVGPremultipliedAlpha=c,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/engine/webgl/DefaultVertexAttributeLayouts":function(){define(["exports","../../../webgl/enums","../../../webgl/VertexElementDescriptor"],(function(e,t,r){"use strict";const i=new Map([["geometry",[new r.VertexElementDescriptor("a_pos",2,t.DataType.BYTE,0,2)]]]),s=new Map([["geometry",[new r.VertexElementDescriptor("a_pos",2,t.DataType.BYTE,0,4),new r.VertexElementDescriptor("a_tex",2,t.DataType.BYTE,2,4)]]]),n=new Map([["geometry",[new r.VertexElementDescriptor("a_pos",2,t.DataType.UNSIGNED_SHORT,0,4)]]]);e.Pos2b=i,e.Pos2us=n,e.PosTex2b=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/capabilities/Capabilities":function(){define(["exports","./DebugRendererInfo","./DisjointTimerQuery","./load","./LoseContext"],(function(e,t,r,i,s){"use strict";e.Capabilities=class{constructor(e,t){this._gl=e,this._compressedTextureETC=null,this._compressedTextureS3TC=null,this._textureFilterAnisotropic=null,this._colorBufferFloat=null,this._loseContext=null,this._textureNorm16=null,this._textureFloatLinear=null,this._parallelShaderCompile=null,this._rendererInfo=null,this._disabledExtensions=t.disabledExtensions||{},this._debugWebGLExtensions=t.debugWebGLExtensions||{}}get compressedTextureETC(){return this._compressedTextureETC??=i.loadCompressedTextureETC(this._gl,this._disabledExtensions),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC??=i.loadCompressedTextureS3TC(this._gl,this._disabledExtensions),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic??=i.loadTextureFilterAnisotropicCapability(this._gl,this._disabledExtensions),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery??=r.createDisjointTimerQuery(this._gl,this._disabledExtensions),this._disjointTimerQuery}get colorBufferFloat(){return this._colorBufferFloat??=i.loadColorBufferFloat(this._gl,this._disabledExtensions),this._colorBufferFloat}get textureNorm16(){return this._textureNorm16??=i.loadTextureNorm16(this._gl,this._disabledExtensions),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear??=i.loadBooleanExtension(this._gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"]),this._textureFloatLinear}get parallelShaderCompile(){return this._parallelShaderCompile??=i.loadBooleanExtension(this._gl,this._disabledExtensions,"parallelShaderCompile",!1,["KHR_parallel_shader_compile"]),this._parallelShaderCompile}get loseContext(){return this._loseContext??=s.load(this._gl,this._debugWebGLExtensions),this._loseContext}get rendererInfo(){return this._rendererInfo??=t.loadRendererInfo(this._gl),this._rendererInfo}enable(e){return this[e]}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/capabilities/DebugRendererInfo":function(){define(["exports"],(function(e){"use strict";class t{constructor(e){this.getUnmaskedRenderer=e}}e.RendererInfo=t,e.loadRendererInfo=function(e){const r=e.getExtension("WEBGL_debug_renderer_info");return r?new t((()=>e.getParameter(r.UNMASKED_RENDERER_WEBGL))):null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/capabilities/load":function(){define(["exports"],(function(e){"use strict";e.loadBooleanExtension=function(e,t,r,i,s){if(i)return!0;if(t[r])return!1;for(const t of s)if(e.getExtension(t))return!0;return!1},e.loadColorBufferFloat=function(e,t){const r=!t.colorBufferHalfFloat&&e.getExtension("EXT_color_buffer_half_float")||!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return r||i||s?{textureFloat:!!i,textureHalfFloat:!!r,floatBlend:!!s,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null},e.loadCompressedTextureETC=function(e,t){if(t.compressedTextureETC)return null;const r=e.getExtension("WEBGL_compressed_texture_etc");return r?{COMPRESSED_R11_EAC:r.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:r.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:r.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:r.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:r.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:r.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null},e.loadCompressedTextureS3TC=function(e,t){if(t.compressedTextureS3TC)return null;const r=e.getExtension("WEBGL_compressed_texture_s3tc");return r?{COMPRESSED_RGB_S3TC_DXT1:r.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:r.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:r.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:r.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null},e.loadTextureFilterAnisotropicCapability=function(e,t){if(t.textureFilterAnisotropic)return null;const r=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return r?{MAX_TEXTURE_MAX_ANISOTROPY:r.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:r.TEXTURE_MAX_ANISOTROPY_EXT}:null},e.loadTextureNorm16=function(e,t){if(t.textureNorm16)return null;const r=e.getExtension("EXT_texture_norm16");return r?{R16:r.R16_EXT,RG16:r.RG16_EXT,RGB16:r.RGB16_EXT,RGBA16:r.RGBA16_EXT,R16_SNORM:r.R16_SNORM_EXT,RG16_SNORM:r.RG16_SNORM_EXT,RGB16_SNORM:r.RGB16_SNORM_EXT,RGBA16_SNORM:r.RGBA16_SNORM_EXT}:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/capabilities/LoseContext":function(){define(["exports"],(function(e){"use strict";e.load=function(e,t){const r=t.loseContext&&e.getExtension("WEBGL_lose_context");return r?{loseRenderingContext:()=>r.loseContext()}:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextureRepository":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./basicInterfaces","./ITexture","./TextureUpdater","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";e.TextureRepository=class extends r{constructor(e){super({}),this._stage=e,this._textures=new Map,this._loadingCount=0,this.events=new i,this.updater=new h.TextureUpdater,this._frameTask=e.view.resourceController.scheduler.registerTask(p.TaskPriority.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachTexture((e=>e.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){this.updater.run()&&this.events.emit("changed",u.RenderRequestType.BACKGROUND)}_createNewRef(e){const t=this._stage.getTexture(e);if(null==t)return null;const r=t.events.on("unloaded",(()=>{r.remove(),this._onTextureUnloaded(t)})),i=new m(e,(()=>{this._frameTask.schedule((()=>{i.isUnreferenced&&t.unload()}))}));return this._textures.set(e,i),i.ref(),t.loaded?(this._updateGLTexture(i,t.glTexture),d.isUpdatableTexture(t)&&this.updater.add(t),i):(this._loadingCount++,i.loadingPromise=this._stage.schedule((()=>{const e=t.load(this._stage.renderView.renderingContext),r=e=>(this._loadingCount--,i.loadingPromise=null,this._updateGLTexture(i,e),d.isUpdatableTexture(t)&&this.updater.add(t),i);return n.isPromiseLike(e)?e.then(r,(e=>(this._loadingCount--,i.loadingPromise=null,n.isAbortError(e)||s.getLogger(this).error(e),null))):r(e)})),i.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",u.RenderRequestType.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e.id),this.updater.remove(e)}},t.__decorate([o.property()],e.TextureRepository.prototype,"_loadingCount",void 0),t.__decorate([o.property()],e.TextureRepository.prototype,"_frameTask",void 0),t.__decorate([o.property()],e.TextureRepository.prototype,"updating",null),e.TextureRepository=t.__decorate([c.subclass("esri.views.3d.webgl-engine.lib.TextureRepository")],e.TextureRepository);class m{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(s.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/ITexture":function(){define(["exports"],(function(e){"use strict";e.isUpdatableTexture=function(e){return!!e.update},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/TextureUpdater":function(){define(["exports"],(function(e){"use strict";class t{constructor(e){this.texture=e,this.previousToken=-1}}e.TextureUpdater=class{constructor(){this._updating=new Map}add(e){this._updating.set(e.id,new t(e))}remove(e){this._updating.delete(e.id)}run(){let e=!1;return this._updating.forEach((t=>{const r=t.texture.update(t.previousToken);r>=0&&r!==t.previousToken&&(t.previousToken=r,e=!0)})),e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/markerTextureRepository":function(){define(["exports","../../support/engineContent/marker","./ProceduralTextureRepository"],(function(e,t,r){"use strict";e.createMarkerTextureRepository=function(e,i){return new r.ProceduralTextureRepository((r=>t.createMarkerTexture(r,e)),(e=>e),i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/internal/WaterTextureRepository":function(){define(["exports","../../../../../chunks/tslib.es6","../../../../../assets","../../../../../core/Accessor","../../../../../core/asyncUtils","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators/property","../../../../../core/has","../../../../../core/RandomLCG","../../../../../core/accessorSupport/decorators/subclass","../../../../../support/requestImageUtils","../../lib/basicInterfaces","../../../../webgl/enums","../../../../webgl/NoParameters","../../../../webgl/Texture","../../../../webgl/TextureDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";e.WaterTextureRepository=class extends i{constructor(){super(...arguments),this._passParameters=new _,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=o.abortMaybe(this._resourcesTask),this._passParameters.waveNormal=o.disposeMaybe(this._passParameters.waveNormal),this._passParameters.wavePerturbation=o.disposeMaybe(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=s.createTask((async t=>{await Promise.allSettled([this._loadImageResource(e,r.getAssetUrl("esri/images/materials/water/normals.jpg"),(e=>this._passParameters.waveNormal=e),t),this._loadImageResource(e,r.getAssetUrl("esri/images/materials/water/perturbation.jpg"),(e=>this._passParameters.wavePerturbation=e),t)])}))),this._resourcesTask.finished?p.ResourceState.LOADED:p.ResourceState.LOADING}async _loadImageResource(e,t,r,i){try{const s=await h.requestImage(t,{signal:i});a.throwIfAborted(i);const n=new y.TextureDescriptor(s.width,s.height);n.pixelFormat=m.PixelFormat.RGB,n.samplingMode=m.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,n.hasMipmap=!0,n.maxAnisotropy=8,r(new g.Texture(e,n,s))}catch(e){n.getLogger(this).error("Failed to load water material normal texture.",e)}}},t.__decorate([l.property()],e.WaterTextureRepository.prototype,"_resourcesTask",void 0),t.__decorate([l.property({type:Boolean,readOnly:!0})],e.WaterTextureRepository.prototype,"updating",null),e.WaterTextureRepository=t.__decorate([d.subclass("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],e.WaterTextureRepository);class _ extends f.NoParameters{}e.WaterTexturePassParameters=_,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/parts/contextCache":function(){define(["exports"],(function(e){"use strict";const t=new Map;e.getContextCache=function(){return t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/parts/ScreenshotManager":function(){define(["exports","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/factories/vec4f64","../lib/basicInterfaces","../lib/rendererUtils","../../../support/RenderState","../../../support/screenshotUtils","../../../webgl/enums","../../../webgl/FramebufferObject","../../../../core/imageUtils"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";e.ScreenshotContext=class{constructor(e,t){this.parameters=e,this.fbos=t}},e.ScreenshotManager=class{constructor(e,t,r){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=r,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(i.RenderRequestType.BACKGROUND);const r=t.createResolver();return this._screenshotQueue.push({settings:e,resolver:r}),r.promise}update(e,t){for(const r of this._screenshotQueue){if(null==this._rctx){r.resolver.reject();continue}const i={...r.settings,pixelRatio:r.settings.pixelRatio*e.parameters.camera.pixelRatio},s=this._renderScreenshot(e,i,t);r.resolver(s)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,r){e.width=t.width,e.height=t.height;const i=e.getContext("2d",{willReadFrequently:!0}),s=r.pixelRatio;return i.save(),i.translate(0,t.height),i.scale(1,-1),r.region&&i.translate(-r.region.x,-r.region.y),i.scale(s,s),t=this._renderFunctions.renderOverlay(e,r.disableDecorations,t),i.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:r,framebufferHeight:i,region:s,resample:n}=e,l=this._ensureScreenshotEncodeCanvas();let u=c.createEmptyImageData(r,i,l);this._rctx.gl.readPixels(0,0,r,i,a.PixelFormat.RGBA,a.DataType.UNSIGNED_BYTE,new Uint8Array(u.data.buffer)),t(),u=this._renderScreenshotOverlay(l,u,{...e,region:void 0});const d=c.createEmptyImageData(s.width,s.height,l);return o.resampleHermite(u,d,!0,n.region.x,i-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:r,region:i}=e,s=this._ensureScreenshotEncodeCanvas(),n=c.createEmptyImageData(i.width,i.height,s);return this._rctx.gl.readPixels(i.x,r-(i.y+i.height),i.width,i.height,a.PixelFormat.RGBA,a.DataType.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),t(),this._renderScreenshotOverlay(s,n,e)}_renderScreenshot(e,t,i){const o=e.parameters.camera,a={width:t.framebufferWidth,height:t.framebufferHeight};l.ensureAttachmentMaxSize(a,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let c=!1;const u=a.width!==o.fullWidth||a.height!==o.fullHeight,d=t.ignorePadding&&o.pixelRatio!==t.pixelRatio,h=u||t.disableDecorations||d||t.objectAndLayerIdColor;let p=null,m=null;if(h){const e=o.clone();if(t.ignorePadding){const i=r.clone(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=a.width,e.fullHeight=a.height,e.pixelRatio=t.pixelRatio;const l=o.fovX-e.fovX,u=o.fovY-e.fovY;l<0&&l<u?e.fovX=o.fovX:u<0&&u<l&&(e.fovY=o.fovY);const d={camera:e,contentCamera:e,mode:n.RenderState.IDLE,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(d),c=!0;const h=this._renderFunctions.renderScene(d,i,t.objectAndLayerIdColor?s.RendererTarget.ObjectAndLayerID:s.RendererTarget.Screenshot,t.disableDecorations);m=h.screen,p=h.olid}this._rctx.bindFramebuffer(m?.fbo);const f=this._readbackScreenshot(t,(()=>{this._rctx.bindFramebuffer(null),m?.release()}));let g=null;if(t.objectAndLayerIdColor){const e=()=>{this._rctx.bindFramebuffer(null),p?.release()};this._rctx.bindFramebuffer(p?.fbo),g=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(h&&!this._rctx.contextAttributes.alpha)for(let e=3;e<f.data.length;e+=4)f.data[e]=255;if(g&&!this._rctx.contextAttributes.alpha)for(let e=3;e<g.data.length;e+=4)g.data[e]=255;return c&&this._forceCameraHook(e.parameters),[f,g]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/screenshotUtils":function(){define(["exports","../../core/has","../../core/mathUtils","../../core/imageUtils"],(function(e,t,r,i){"use strict";function s(e,t){const{format:i,quality:s,rotation:n,disableDecorations:o}=e||{},a=c(e,t.padding),l=function(e,t){const r={x:0,y:0,width:t.width,height:t.height};if(e?.area){null!=e.area.x&&(r.x=Math.floor(e.area.x)),null!=e.area.y&&(r.y=Math.floor(e.area.y));const i=null!=e.area.width?Math.floor(e.area.width):null,s=null!=e.area.height?Math.floor(e.area.height):null;if(r.width=t.width-r.x,r.height=t.height-r.y,null!=i&&null!=s)r.width=Math.min(r.width,i),r.height=Math.min(r.height,s);else if(null==i&&null!=s){const e=Math.min(r.width,i);r.height=e/r.width*r.height,r.width=e}else if(null!=i&&null==s){const e=Math.min(r.height,s);r.width=e/r.height*r.width,r.height=e}}return function(e,t){const r=Math.floor(Math.max(e.x,0)),i=Math.floor(Math.max(e.y,0)),s={x:r,y:i,width:Math.floor(Math.min(e.width,t.width-r)),height:Math.floor(Math.min(e.height,t.height-i))},n=s.width/s.height,o=e.width/e.height;if(o===n)return s;if(o>n){const e=Math.floor(s.width/o),t=s.height-e;return{x:s.x,y:Math.floor(s.y+t/2),width:s.width,height:e}}const a=Math.floor(s.height*o),l=s.width-a;return{x:Math.floor(s.x+l/2),y:s.y,width:a,height:s.height}}(function(e,t){if(null==t?.width||null==t.height)return e;const r=t.width/t.height,i=e.width/e.height;if(i===r)return e;if(i<r){const t=Math.floor(e.height*r);return e.x-=(t-e.width)/2,e.width=t,e}const s=Math.floor(e.width/r);return e.y-=(s-e.height)/2,e.height=s,e}(r,e),t)}(e,{width:t.width-a.left-a.right,height:t.height-a.top-a.bottom}),{width:d,height:h}=function(e,t){if(!e)return t;const r=e.width,i=e.height;if(null!=r&&null!=i)return{width:Math.floor(r),height:Math.floor(i)};if(null==r&&null==i)return t;const s=t.width/t.height;return null==i?{width:Math.floor(r),height:Math.floor(r/s)}:{width:Math.floor(i*s),height:Math.floor(i)}}(e,l),m=u(i),f=p[m];return{format:m,quality:r.clamp(null!=s?s:f,0,100),area:l,width:d,height:h,rotation:n,disableDecorations:!!o,ignoreBackground:!!e?.ignoreBackground,ignorePadding:!!e?.ignorePadding}}function n(e,t){const r=(null==a&&(a=document.createElement("canvas")),a);t.premultipliedAlpha&&function(e){const t=e.data,r=t.length;for(let e=0;e<r;e+=4){const r=t[e+3];if(255!==r&&r>0){const i=255/r;t[e]=t[e]*i,t[e+1]=t[e+1]*i,t[e+2]=t[e+2]*i}}}(e),r.width=e.width,r.height=e.height;const i=r.getContext("2d",{willReadFrequently:!0});return i.putImageData(e,0,0),t.flipY&&function(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}(i),{ctx:i,canvas:r}}function o(e){e.width=0,e.height=0}let a=null;function l(e,t){const r=d[t.format],i=t.quality/100;return e.toDataURL(r,i)}function c(e,t){return!t||e?.ignorePadding?m:t}function u(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return h}}const d={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},h="png",p={png:100,jpg:98,jpeg:98},m={top:0,right:0,bottom:0,left:0};e.createEmptyImageData=i.createEmptyImageData,e.completeUserSettings=s,e.encode=function(e,t,r){const{ctx:i,canvas:s}=n(e,r),a=i.getImageData(0,0,e.width,e.height),c=l(s,t);return o(s),{dataUrl:c,data:a}},e.encodeData=function(e,t){const{ctx:r,canvas:i}=n(e,t),s=r.getImageData(0,0,e.width,e.height);return o(i),s},e.getFormatAndQuality=function(e,t){const i=u(e),s=p[i];return{format:i,quality:r.clamp(null!=t?t:s,0,100)}},e.getMaximumResolutionScale=function(e,t){return t/Math.max(e[0],e[1])},e.resampleHermite=function(e,t,r,i=0,s=0,n=e.width-i,o=e.height-s,a=!1){const{data:l}=e,{width:c,height:u,data:d}=t,h=n/c,p=o/u,m=Math.ceil(h/2),f=Math.ceil(p/2),g=e.width;for(let e=0;e<u;e++)for(let t=0;t<c;t++){const n=4*(t+(a?u-e-1:e)*c);let o=0,y=0,_=0,b=0,v=0,S=0;const w=(e+.5)*p;for(let n=Math.floor(e*p);n<(e+1)*p;n++){const e=Math.abs(w-(n+.5))/f,a=(t+.5)*h,c=e*e;for(let e=Math.floor(t*h);e<(t+1)*h;e++){const t=Math.abs(a-(e+.5))/m,u=Math.sqrt(c+t*t);if(u>=1)continue;let d=2*u*u*u-3*u*u+1;const h=4*(i+e+(s+n)*g);S+=d*l[h+3],y+=d,!r&&l[h+3]<255&&(d=d*l[h+3]/255),_+=d*l[h],b+=d*l[h+1],v+=d*l[h+2],o+=d}}d[n]=_/o,d[n+1]=b/o,d[n+2]=v/o,d[n+3]=S/y}return t},e.screenshotSuperSampleSettings=function(e,t,r){if(!t)return e;const{framebufferWidth:i,framebufferHeight:s,pixelRatio:n,region:o}=e,a=c(e,r),l=a.left+a.right,u=a.top+a.bottom,d=i-l,h=s-u,p=Math.min(8,Math.min((2048-l)/d,(2048-u)/h));return p<1.5?e:{...e,framebufferWidth:Math.round(d*p)+l,framebufferHeight:Math.round(h*p)+u,pixelRatio:n*p,resample:{region:{x:Math.round((o.x-a.left)*p)+a.left,y:Math.round((o.y-a.top)*p)+a.top,width:Math.round(o.width*p),height:Math.round(o.height*p)},width:i,height:s}}},e.toDataUrl=l,e.toRenderSettings=function(e,t){const r=s(e,t),i=r.area,n=r.width/i.width,o=c(r,t.padding),a=o.left+o.right,l=o.top+o.bottom,u=t.width-a,d=t.height-l,h=Math.floor(u*n+a),p=Math.floor(d*n+l),m=e?.layers??[],f=r.ignoreBackground,g=r.ignorePadding;return{framebufferWidth:h,framebufferHeight:p,region:{x:Math.floor(i.x*n)+o.left,y:Math.floor(i.y*n)+o.top,width:r.width,height:r.height},format:r.format,quality:r.quality,rotation:r.rotation,pixelRatio:n,layers:m,disableDecorations:r.disableDecorations,ignoreBackground:f,ignorePadding:g,objectAndLayerIdColor:!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/imageUtils":function(){define(["require","exports","../request","./Error","./promiseUtils","./urlUtils","../support/base64Utils"],(function(e,t,r,i,s,n,o){"use strict";let a=null,l=!0;function c(e,t,r){return r||(a||(a=document.createElement("canvas"),a.width=1,a.height=1),r=a),r.getContext("2d").createImageData(e,t)}t.createEmptyImageData=function(e,t,r){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(l)try{return new ImageData(e,t)}catch(e){l=!1}return c(e,t,r)},t.getImageData=async function(t,a){const{arrayBuffer:l,mediaType:c}=await async function(e,t){const i=n.dataComponents(e);if(i?.isBase64)return{arrayBuffer:o.base64ToArrayBuffer(i.data),mediaType:i.mediaType};const s=await r(e,{responseType:"array-buffer",...t});return{arrayBuffer:s.data,mediaType:s.getHeader?.("Content-Type")??""}}(t,a),u="image/png"===c;if("image/gif"===c){const{isAnimatedGIF:t,parseGif:r}=await new Promise(((t,r)=>e(["./image/gif"],t,r)));if(t(l))return r(l,a)}if(u){const{isAnimatedPNG:t,parseApng:r}=await new Promise(((t,r)=>e(["./image/apng"],t,r)));if(t(l))return r(l,a)}return async function(e,t){const n=window.URL.createObjectURL(e);try{const{data:e}=await r(n,{...t,responseType:"image"});return e}catch(e){if(!s.isAbortError(e))throw new i("invalid-image",`Could not fetch requested image at ${n}`);throw e}finally{window.URL.revokeObjectURL(n)}}(new Blob([l],{type:c}),a)},t.wrapImageData=function(e,t,r,i){if(!t||!r)throw new Error("Cannot construct image data without dimensions");if(l)try{return new ImageData(e,t,r)}catch(e){l=!1}const s=c(t,r,i);return s.data.set(e,0),s},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/parts/testUtils":function(){define(["exports","./contextCache"],(function(e,t){"use strict";const r={enabled:!1,disposeContextCache:()=>{const e=t.getContextCache();e.forEach((e=>e.dispose())),e.clear()}};e.contextCache=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/TextureCompressionHelper":function(){define(["exports","../../core/Logger","../../core/maybe","../3d/layers/support/makeScheduleFunction","./TextureCompressionWorkerHandle","../webgl/Texture"],(function(e,t,r,i,s,n){"use strict";const o=new Set,a=()=>t.getLogger("esri/views/support/TextureCompressionHelper");e.destroyTextureCompressionWorker=function(e){n.Texture.compressionWorkerHandle&&(o.delete(e)||a().warn("Unknown view attempted to destroy the texture compression worker."),o.size||(r.destroyMaybe(n.Texture.compressionWorkerHandle),n.Texture.compressionWorkerHandle=null))},e.initializeTextureCompressionWorker=function(e,t){return n.Texture.compressionWorkerHandle??=new s.TextureCompressionWorkerHandle(i.makeScheduleFunction(t)),o.has(e)?a().warn("Repeated texture compression worker initialization by the same view."):o.add(e),n.Texture.compressionWorkerHandle},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/makeScheduleFunction":function(){define(["exports"],(function(e){"use strict";e.makeScheduleFunction=function(e){return t=>{if(e.immediate)return e.immediate.schedule(t);const r="No immediate scheduler";throw console.error(r),new Error(r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/support/WebGLRequirements":function(){define(["exports","../../core/Error","../webgl/capabilities"],(function(e,t,r){"use strict";e.check=function(e){const i=r.getWebGLCapabilities();return i.available?"3d"===e&&i.majorPerformanceCaveat?new t("webgl:major-performance-caveat-detected",`Your WebGL implementation (${i.unmaskedRenderer}) doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.`):i.supportsHighPrecisionFragment?i.supportsVertexShaderSamplers?null:new t("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new t("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new t("webgl:required","WebGL2 is required but not supported.",(new Error).stack)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/capabilities":function(){define(["exports","./capabilities/DebugRendererInfo"],(function(e,t){"use strict";let r;class i{constructor(){this.available=!1,this.majorPerformanceCaveat=!1,this.maxTextureSize=0,this.supportsVertexShaderSamplers=!1,this.supportsHighPrecisionFragment=!1,this.supportsColorBufferFloat=!1,this.supportsColorBufferFloatBlend=!1,this.supportsColorBufferHalfFloat=!1,this.unmaskedRenderer="unloaded"}}e.getWebGLCapabilities=function(){return r??=function(){const e=new i,r=function(e){if("undefined"==typeof WebGL2RenderingContext)return null;const r=document.createElement("canvas");if(!r)return null;let i=r.getContext("webgl2",{failIfMajorPerformanceCaveat:!0});if(null==i&&(i=r.getContext("webgl2"),null!=i&&(e.majorPerformanceCaveat=!0,e.unmaskedRenderer=t.loadRendererInfo(i)?.getUnmaskedRenderer()??"unknown")),null==i)return i;e.available=!0,e.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),e.supportsVertexShaderSamplers=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;const s=i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT);return s&&(e.supportsHighPrecisionFragment=s.precision>0),i}(e);return null==r||(e.supportsColorBufferFloat=null!==r.getExtension("EXT_color_buffer_float"),e.supportsColorBufferFloatBlend=null!==r.getExtension("EXT_float_blend"),e.supportsColorBufferHalfFloat=e.supportsColorBufferFloat||null!==r.getExtension("EXT_color_buffer_half_float")),e}(),r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/ui/DefaultUI":function(){define(["../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./Component","./UI","../../widgets/Attribution","../../widgets/Compass","../../widgets/NavigationToggle","../../widgets/Zoom"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";let p=class extends l{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[],this._updateViewAwareWidgets=e=>{this.components.forEach((t=>{const r=this._find(t),i=r?.widget;(function(e){return void 0!==e?.view})(i)&&(i.view=e)}))},this._componentsWatcher=(e,t)=>{this._removeComponents(t),this._addComponents(e),this._adjustPadding(e)}}initialize(){this.addHandles([i.watch((()=>this.components),this._componentsWatcher,i.initial),i.watch((()=>this.view),this._updateViewAwareWidgets,i.initial)])}_add(e,t,r,i,s){let n=e;if("string"==typeof e&&this._defaultPositionLookup[e]){if(this._find(e))return;n=this._createComponent(e)}super._add(n,t,r,i,s)}_removeComponents(e){e.forEach((e=>{const t=this._find(e);t&&(this.remove(t),t.destroy())}))}_adjustPadding(e){if(!e.includes("attribution")&&!this._isOverridden("padding")){const{top:e}=this.padding;this.padding=e}}_addComponents(e){this.constructed&&e.forEach((e=>this.add(this._createComponent(e),this._defaultPositionLookup[e])))}_createComponent(e){const t=this._createWidget(e);return new a({id:e,node:t})}_createWidget(e){const t=this.view;switch(e){case"attribution":return new c({view:t});case"compass":return new u({view:t});case"navigation-toggle":return new d({view:t,isDefaultUI:!0});case"zoom":return new h({view:t})}}};return e.__decorate([s.property()],p.prototype,"components",void 0),p=e.__decorate([o.subclass("esri.views.ui.DefaultUI")],p),p}))},"esri/views/ui/UI":function(){define(["../../chunks/tslib.es6","../../intl","../../core/Accessor","../../core/arrayUtils","../../core/Evented","../../core/handleUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/accessorSupport/decorators/cast","../../core/has","../../core/accessorSupport/decorators/subclass","../../support/modeUtils","./Component","../../widgets/support/widgetUtils","../../intl/locale"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";const f={left:0,top:0,bottom:0,right:0},g={bottom:30,top:15,right:15,left:15},y="esri-ui",_={ui:y,corner:`${y}-corner`,innerContainer:`${y}-inner-container`,manualContainer:`${y}-manual-container`,cornerContainer:`${y}-corner-container`,topLeft:`${y}-top-left`,topRight:`${y}-top-right`,bottomLeft:`${y}-bottom-left`,bottomRight:`${y}-bottom-right`};function b(e){return 0===e?"0":`${e}px`}function v(e){const t="object"==typeof e&&null!==e&&Object.getPrototypeOf(e);return null!==t&&t!==Object.prototype||!("component"in e||"index"in e||"position"in e)?null:e}function S(e,{top:t,bottom:r,left:i,right:s}){e.style.top=t,e.style.bottom=r,e.style.left=i,e.style.right=s}let w=class extends s.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentMap=new Map,this._removeWidgetHandleKey=Symbol("componentOnRemoveSymbol"),this._locale=m.getLocale(),this.view=null,this._applyViewPadding=()=>{const e=this.container;e&&S(e,this._toPixelPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const e=this._innerContainer;e&&S(e,this._toPixelPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([o.watch((()=>[this.view?.padding,this.container]),this._applyViewPadding,o.initial),o.watch((()=>this.padding),this._applyUIPadding,o.initial),o.watch((()=>[this.container,this._locale]),(([e,t])=>{e&&e.setAttribute("lang",t)}),o.initial),m.onLocaleChange((e=>{this._locale=e}))])}destroy(){this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._componentMap.clear()}set container(e){const t=this._get("container");e!==t&&(e&&(e.classList.add(_.ui),d.setCalciteModeClass(e),this._attachContainers(e)),t&&(t.classList.remove(_.ui),S(t,{top:"",bottom:"",left:"",right:""}),t.textContent=""),this._set("container",e))}get height(){const e=this.view?.height??0;if(0===e)return e;const t=this._getViewPadding(),{top:r,bottom:i}=t;return Math.max(e-r-i,0)}get padding(){return this._get("padding")}set padding(e){this._overrideIfSome("padding",e)}castPadding(e){return"number"==typeof e?{bottom:e,top:e,right:e,left:e}:{...g,...e}}get width(){const e=this.view?.width??0;if(0===e)return e;const t=this._getViewPadding(),{left:r,right:i}=t;return Math.max(e-r-i,0)}add(e,t){let r,i,s;if(Array.isArray(e))return void e.forEach((e=>this.add(e,t)));const n=v(e);n&&({index:r,position:t,component:e,key:i}=n),t&&"object"==typeof t&&({index:r,key:i,position:t,internal:s}=t),!e||t&&!this._isValidPosition(t)||this._add(e,t,r??this._getNumComponentsAtPosition(t),i,s)}remove(e,t){if(!e)return;if(Array.isArray(e))return e.map((e=>this.remove(e,t)));const r=this._find(e);if(r){const e=this._componentMap.get(r);if(!e||e.key!==t)return;const i=this._components.indexOf(r),s=r.node.parentNode;return s?.removeChild(r.node),this._componentMap.delete(r),r.widget?.removeHandlesReference(this._removeWidgetHandleKey),this._components.forEach((t=>{const r=this._componentMap.get(t);r&&r.position===e.position&&r.index>e.index&&r.index--})),this._components.splice(i,1)[0]}}empty(e,t={removeInternal:!1}){if(Array.isArray(e)){for(const r of e)this.empty(r,t);return}const r=this._positionNameToContainerLookup[e??"manual"],i=Array.prototype.slice.call(r.children).map((e=>this._findByNode(e))).filter((e=>null!=e&&(!this._componentMap.get(e)?.internal||t.removeInternal)));for(const e of i)this.remove(e)}move(e,t){if(Array.isArray(e)&&e.forEach((e=>this.move(e,t))),!e)return;let r;const i=v(e)||v(t);if(i&&(r=i.index,t=i.position,e=i.component||e),t&&!this._isValidPosition(t))return;const s=this.remove(e);s&&this.add(s,{position:t,index:r})}find(e){if(!e)return null;const t=this._findById(e);return t&&(t.widget||t.node)}getComponents(e,t={includeInternal:!1}){return e?Array.isArray(e)?e.flatMap((e=>this._getComponentsAtPosition(e,t))):this._getComponentsAtPosition(e,t):this._components.filter((e=>t.includeInternal||!this._componentMap.get(e)?.internal)).map((({widget:e,node:t})=>e??t))}getPosition(e){for(const t in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[t].contains(e))return t;return null}_add(e,t,i,s,o){e instanceof h||(e=new h({node:e}));const{widget:a}=e;null!=a&&a instanceof r&&a.addHandles(n.makeHandle((()=>{queueMicrotask((()=>this.remove(e)))})),this._removeWidgetHandleKey),this._components.some((e=>this._componentMap.get(e)?.position===t&&this._componentMap.get(e)?.index===i))&&this._components.forEach((e=>{const r=this._componentMap.get(e);r&&r.position===t&&r.index>=i&&r.index++})),this._place({component:e,position:t,index:i}),this._components.push(e),this._componentMap.set(e,{key:s,position:t,internal:o,index:i})}_find(e){return e?e instanceof h?this._findByComponent(e):"string"==typeof e?this._findById(e):"domNode"in e?this._findByNode(e.domNode):this._findByNode(e):null}_getViewPadding(){return this.view?.padding??f}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(_.innerContainer,_.cornerContainer);const t=document.createElement("div");t.classList.add(_.innerContainer,_.manualContainer);const r=document.createElement("div");r.classList.add(_.topLeft,_.corner),e.appendChild(r);const i=document.createElement("div");i.classList.add(_.topRight,_.corner),e.appendChild(i);const s=document.createElement("div");s.classList.add(_.bottomLeft,_.corner),e.appendChild(s);const n=document.createElement("div");n.classList.add(_.bottomRight,_.corner),e.appendChild(n),this._innerContainer=e,this._manualContainer=t;const o=p.isRTL();this._cornerNameToContainerLookup={"top-left":r,"top-right":i,"bottom-left":s,"bottom-right":n,"top-leading":o?i:r,"top-trailing":o?r:i,"bottom-leading":o?n:s,"bottom-trailing":o?s:n},this._positionNameToContainerLookup={manual:t,...this._cornerNameToContainerLookup}}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const t=e.position??"manual",{component:r,index:i}=e,s=this._positionNameToContainerLookup[t],n=null!=i&&i>-1;var o;if((o=r.widget)&&!o._started&&"function"==typeof o.postMixInProperties&&"function"==typeof o.buildRendering&&"function"==typeof o.postCreate&&"function"==typeof o.startup&&r.widget.startup(),!n)return void s.appendChild(r.node);const a=Array.from(s.children);if(0!==a.length){for(const e of a){const t=this._findByNode(e);if(t&&i<(this._componentMap.get(t)?.index??0))return void e.parentNode?.insertBefore(r.node,e)}s.appendChild(r.node)}else s.appendChild(r.node)}_toPixelPosition(e){return{top:b(e.top),left:b(e.left),right:b(e.right),bottom:b(e.bottom)}}_findByComponent(e){return this._components.find((t=>t===e))??null}_findById(e){return this._components.find((({id:t})=>t===e))??null}_findByNode(e){return e?this._components.find((({node:t})=>t===e)):null}_getComponentsAtPosition(e,t){const r=this._positionNameToContainerLookup[e];return Array.prototype.slice.call(r.children).map((e=>this._findByNode(e))).filter(i.isSome).filter((e=>t.includeInternal||!this._componentMap.get(e)?.internal)).map((({widget:e,node:t})=>e??t))}_getNumComponentsAtPosition(e){const t=this._positionNameToContainerLookup[e];return t?.children.length??0}};return e.__decorate([a.property()],w.prototype,"_locale",void 0),e.__decorate([a.property()],w.prototype,"container",null),e.__decorate([a.property()],w.prototype,"height",null),e.__decorate([a.property({value:g})],w.prototype,"padding",null),e.__decorate([l.cast("padding")],w.prototype,"castPadding",null),e.__decorate([a.property()],w.prototype,"view",void 0),e.__decorate([a.property()],w.prototype,"width",null),w=e.__decorate([u.subclass("esri.views.ui.UI")],w),w}))},"esri/widgets/Attribution":function(){define(["../chunks/tslib.es6","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./Attribution/AttributionViewModel","./support/globalCss","./support/decorators/accessibleHandler","./support/decorators/messageBundle","./support/jsxFactory","./support/widgetUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const m="esri-attribution",f={base:m,poweredBy:`${m}__powered-by`,sources:`${m}__sources`,open:`${m}--open`,sourcesOpen:`${m}__sources--open`,link:`${m}__link`};let g=class extends a{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._resizeObserver=new ResizeObserver((e=>e.forEach((({target:e})=>this._checkSourceTextOverflow(e))))),this.itemDelimiter=" | ",this.messages=null,this.viewModel=new l}initialize(){this.addHandles(t.on((()=>this.viewModel?.items),"change",(()=>this.scheduleRender())))}destroy(){this._resizeObserver?.disconnect()}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce(((e,t)=>(e.includes(t.text)||e.push(t.text),e)),[]).join(this.itemDelimiter)}get icon(){return"description"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e={[f.open]:this._isOpen};return h.tsx("div",{bind:this,class:this.classes(f.base,c.globalCss.widget,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this._renderSourcesNode(),this._renderPoweredBy())}_renderPoweredBy(){return h.tsx("div",{class:f.poweredBy},"Powered by"," ",h.tsx("a",{class:f.link,href:"https://www.esri.com/",rel:"noreferrer",target:"_blank"},"Esri"))}_renderSourcesNode(){const e=this._isOpen,t=this._isInteractive,r=t?0:void 0,{attributionText:i}=this,s={[f.sourcesOpen]:e,[c.globalCss.interactive]:t};return h.tsx("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(f.sources,s),innerHTML:i,tabIndex:r})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._resizeObserver.observe(e)}_checkSourceTextOverflow(e){let t=!1;const{clientHeight:r,clientWidth:i,scrollWidth:s}=e,n=s>i,o=this._attributionTextOverflowed!==n;if(this._attributionTextOverflowed=n,o&&(t=!0),this._isOpen){const e=r<this._prevSourceNodeHeight;this._prevSourceNodeHeight=r,e&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};return e.__decorate([r.property()],g.prototype,"_isOpen",void 0),e.__decorate([r.property()],g.prototype,"_isInteractive",null),e.__decorate([r.property()],g.prototype,"_attributionTextOverflowed",void 0),e.__decorate([r.property()],g.prototype,"_prevSourceNodeHeight",void 0),e.__decorate([r.property({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],g.prototype,"attributionText",null),e.__decorate([r.property()],g.prototype,"icon",null),e.__decorate([r.property()],g.prototype,"itemDelimiter",void 0),e.__decorate([r.property()],g.prototype,"label",null),e.__decorate([r.property(),d.messageBundle("esri/widgets/Attribution/t9n/Attribution")],g.prototype,"messages",void 0),e.__decorate([r.property()],g.prototype,"view",null),e.__decorate([r.property({type:l})],g.prototype,"viewModel",void 0),e.__decorate([u.accessibleHandler()],g.prototype,"_toggleState",null),g=e.__decorate([o.subclass("esri.widgets.Attribution")],g),g}))},"esri/widgets/Attribution/AttributionViewModel":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/asyncUtils","../../core/Collection","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../geometry/Extent","../../geometry/SpatialReference","../../geometry/support/contains","../../geometry/support/webMercatorUtils","../../views/3d/layers/Lyr3DWasm"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";function f(e,t){return e&&"copyright"in e&&(!t||"function"==typeof e.originOf&&"user"===e.originOf("copyright"))}function g(e,t,r){r&&t&&(e.find((e=>e.layerView===t&&e.text===r))||e.push({text:r,layerView:t}))}const y=[];let _=class extends t{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new i,this.view=null,this._allLayerViewsChange=e=>{this.removeHandles("suspension"),this.removeHandles("visible-geometry-changed");const t=this.view?.allLayerViews;t&&(this.addHandles(t.map((e=>s.watch((()=>[e.suspended,e.layer?.attributionVisible]),(()=>this._updateAttributionItems())))).toArray(),"suspension"),t.forEach((e=>{"esri.views.3d.layers.Tiles3DLayerView3D"===e.declaredClass&&this.addHandles(e.on("visible-geometry-changed",(()=>this._updateAttributionItems())),"visible-geometry-changed")}))),e?.removed&&e.removed.forEach((e=>{this._pendingAttributions.delete(e),this._fetchedAttributionData.delete(e)})),this._updateAttributionItems()},this.addHandles([s.on((()=>this.view?.allLayerViews),"change",(e=>this._allLayerViewsChange(e)),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),s.when((()=>!0===this.view?.stationary),(()=>this._updateAttributionItems()))])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const e=this.view,t=e?.allLayerViews;if(y.length=0,!e||!t)return void this._clear();t.forEach((t=>{if(t.suspended||!t.layer?.attributionVisible)return;const r=t.layer;if(f(r,"user"))return void g(y,t,r.copyright);if(r.hasAttributionData){if(this._fetchedAttributionData.has(t)){const i=this._fetchedAttributionData.get(t);return void(i?g(y,t,this._getDynamicAttribution(i,e,r)):f(r)&&g(y,t,r.copyright))}return void this._fetchAttributionData(t)}const i="portalItem"in r?r.portalItem?.accessInformation:void 0;g(y,t,i||r.copyright)}));const r=t.find((e=>"integrated-mesh-3dtiles"===e.layer?.type));if(this.view&&r){const e=m.getLyr3DWasm(this.view);if(e){const t=e.getAttributionText();for(let e=0;e<t.length;++e)g(y,r,t[e])}}var i,s;i=this.items,s=y,(i.length!==s.length||i.some(((e,t)=>e.text!==s[t].text)))&&(this.items.removeAll(),this.items.addMany(y)),y.length=0,this.notifyChange("state")}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const t=await r.result(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const r=t.ok?this._createContributionIndex(t.value,"bing-maps"===e.layer.type):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,r)}this._updateAttributionItems()}_createContributionIndex(e,t){const r=e.contributors,i={};if(!r)return i;for(let e=0;e<r.length;e++){const s=r[e],n=s.coverageAreas;if(!n)return;for(const r of n){const n=r.bbox,o=r.zoomMin-(t&&r.zoomMin?1:0),a=r.zoomMax-(t&&r.zoomMax?1:0),l=new u({xmin:n[1],ymin:n[0],xmax:n[3],ymax:n[2],spatialReference:d.WGS84}),c={extent:p.geographicToWebMercator(l),attribution:s.attribution||"",score:null!=r.score?r.score:100,id:e};for(let e=o;e<=a;e++)i[e]??=[],i[e].push(c)}}return i.maxKey=Math.max.apply(null,Object.keys(i)),i}_getDynamicAttribution(e,t,r){const{extent:i,scale:s}=t;let n=r.tileInfo?.scaleToZoom(s)??0;if(n=Math.min(e.maxKey??0,Math.round(n)),!i||null==n||n<=-1)return"";const o=e[n],a=p.project(i.center.clone().normalize(),d.WebMercator),l=new Set;return o?o.filter((e=>{const t=e.id,r=!l.has(t)&&a&&e.extent&&h.extentContainsPoint(e.extent,a);return r&&l.add(t),r})).sort(((e,t)=>t.score-e.score||e.objectId-t.objectId)).map((e=>e.attribution)).join(", "):""}};return e.__decorate([n.property({readOnly:!0,type:i})],_.prototype,"items",void 0),e.__decorate([n.property({readOnly:!0})],_.prototype,"state",null),e.__decorate([n.property()],_.prototype,"view",void 0),_=e.__decorate([c.subclass("esri.widgets.Attribution.AttributionViewModel")],_),_}))},"esri/views/3d/layers/Lyr3DWasm":function(){define(["require","exports","../../../core/Error","../../../layers/ILyr3DWasmPerSceneView"],(function(e,t,r,i){"use strict";const s=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let n,o=null;const a=new Map;t.addLayerViewToWasm=async function(t){null==o&&(null==n&&(n=new Promise(((t,r)=>e(["../../../layers/Lyr3DWasmPerSceneView"],(e=>t(s(e))),r)))),o=await n);const l=t.view;let c=a.get(l);c||(c=new o.default({view:l}),a.set(l,c));const u=!!l.stage.renderView.renderingContext.capabilities.compressedTextureS3TC,d=!!l.stage.renderView.renderingContext.capabilities.compressedTextureETC;await c.initializeWasm(u,d);const h=c.add3DTilesLayerView(t);if(h.wasmLayerId<0)throw c.getValidLayerViewCount()<1&&(a.delete(l),0===a.size&&(n=null,o=null)),h.wasmLayerId===i.wasmFailedToInit?new r("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{}):new r("tiles3d:addLayer-failure",h.check?.errorDescription??"The 3d tiles layer description was invalid.",{});return h.wasmLayerId},t.getLyr3DWasm=function(e){return a.get(e)},t.removeLayerViewFromWasm=function(e){const t=e.view,r=a.get(t);r&&r.remove3DTilesLayerView(e)<1&&(a.delete(t),0===a.size&&(n=null,o=null))},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/ILyr3DWasmPerSceneView":function(){define(["exports"],(function(e){"use strict";var t,r,i,s,n,o,a,l,c,u,d,h,p,m,f;e.Lyr3DType=void 0,(t=e.Lyr3DType||(e.Lyr3DType={})).U8="U8",t.I8="I8",t.U16="U16",t.I16="I16",t.U32="U32",t.I32="I32",t.F32="F32",t.F64="F64",t.Utf8String="Utf8String",t.NotSet="NotSet",e.Lyr3DImageFormat=void 0,(r=e.Lyr3DImageFormat||(e.Lyr3DImageFormat={})).Png="Png",r.Jpeg="Jpeg",r.Dds="Dds",r.Raw="Raw",r.Dxt1="Dxt1",r.Dxt5="Dxt5",r.Bc7="Bc7",r.Basis="Basis",r.Etc1="Etc1",r.Etc2="Etc2",r.Astc="Astc",r.Pvrtc="Pvrtc",r.NotSet="NotSet",e.Lyr3DVtxAtrbSemantic=void 0,(i=e.Lyr3DVtxAtrbSemantic||(e.Lyr3DVtxAtrbSemantic={})).Position="Position",i.Normal="Normal",i.TexCoord="TexCoord",i.Color="Color",i.Tangent="Tangent",i.FeatureIndex="FeatureIndex",i.UvRegion="UvRegion",i.FeatureVariable="FeatureVariable",i.NotSet="NotSet",e.Lyr3DAlphaMode=void 0,(s=e.Lyr3DAlphaMode||(e.Lyr3DAlphaMode={})).Opaque="Opaque",s.Mask="Mask",s.Blend="Blend",e.Lyr3DTransparency=void 0,(n=e.Lyr3DTransparency||(e.Lyr3DTransparency={})).None="None",n.Mask="Mask",n.Alpha="Alpha",n.PreMultAlpha="PreMultAlpha",n.NotSet="NotSet",e.Lyr3DPrimitiveType=void 0,(o=e.Lyr3DPrimitiveType||(e.Lyr3DPrimitiveType={})).Points="Points",o.Lines="Lines",o.LineStrip="LineStrip",o.Triangles="Triangles",o.TriangleStrip="TriangleStrip",o.NotSet="NotSet",e.Lyr3DUvWrapMode=void 0,(a=e.Lyr3DUvWrapMode||(e.Lyr3DUvWrapMode={})).None="None",a.WrapXBit="WrapXBit",a.WrapYBit="WrapYBit",a.WrapXy="WrapXy",a.NotSet="NotSet",e.Lyr3DMagFilterMode=void 0,(l=e.Lyr3DMagFilterMode||(e.Lyr3DMagFilterMode={})).Linear="Linear",l.Nearest="Nearest",l.NotSet="NotSet",e.Lyr3DMinFilterMode=void 0,(c=e.Lyr3DMinFilterMode||(e.Lyr3DMinFilterMode={})).Linear="Linear",c.Nearest="Nearest",c.NearestMipmapNearest="NearestMipmapNearest",c.LinearMipmapNearest="LinearMipmapNearest",c.NearestMipmapLinear="NearestMipmapLinear",c.LinearMipmapLinear="LinearMipmapLinear",c.NotSet="NotSet",e.Lyr3DSchemaPropertySemantic=void 0,(u=e.Lyr3DSchemaPropertySemantic||(e.Lyr3DSchemaPropertySemantic={})).FeatureId="FeatureId",u.GlobalUid="GlobalUid",u.UnspecifiedDateTime="UnspecifiedDateTime",u.EcmaIso8601DateTime="EcmaIso8601DateTime",u.EcmaIso8601DateOnly="EcmaIso8601DateOnly",u.TimeOnly="TimeOnly",u.TimeStamp="TimeStamp",u.ColorRgb="ColorRgb",u.ColorRgba="ColorRgba",u.Unrecognized="Unrecognized",u.NotSet="NotSet",e.Lyr3DFeatureIndexSource=void 0,(d=e.Lyr3DFeatureIndexSource||(e.Lyr3DFeatureIndexSource={})).Texture="Texture",d.VertexAtrb="VertexAtrb",d.Implicit="Implicit",d.NotSet="NotSet",e.Lyr3DFaceCullingMode=void 0,(h=e.Lyr3DFaceCullingMode||(e.Lyr3DFaceCullingMode={})).Front="Front",h.Back="Back",h.None="None",h.NotSet="NotSet",e.Lyr3DLightingModel=void 0,(p=e.Lyr3DLightingModel||(e.Lyr3DLightingModel={})).Pbr="Pbr",p.Unlit="Unlit",e.Lyr3DPixelFormat=void 0,(m=e.Lyr3DPixelFormat||(e.Lyr3DPixelFormat={})).Rgb8="Rgb8",m.Rgba8="Rgba8",m.R8="R8",m.Bgr8="Bgr8",m.Bgra8="Bgra8",m.Rg8="Rg8",m.Ga8="Ga8",m.Etc1="Etc1",m.Etc2="Etc2",m.Dxt1="Dxt1",m.Dxt5="Dxt5",m.Bc7="Bc7",m.NotSet="NotSet",e.Lyr3DWasmWorkerOutputStatus=void 0,(f=e.Lyr3DWasmWorkerOutputStatus||(e.Lyr3DWasmWorkerOutputStatus={}))[f.Succeeded=0]="Succeeded",f[f.Failed=1]="Failed",f[f.MissingInputs=2]="MissingInputs",e.invalidLayerView=-1,e.wasmFailedToInit=-2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/widgets/support/globalCss":function(){define(["exports"],(function(e){"use strict";e.globalCss={anchor:"esri-widget__anchor",anchorDisabled:"esri-widget__anchor--disabled",button:"esri-button",buttonDisabled:"esri-button--disabled",buttonHalf:"esri-button--half",buttonSecondary:"esri-button--secondary",buttonSmall:"esri-button--small",buttonTertiary:"esri-button--tertiary",buttonThird:"esri-button--third",disabled:"esri-disabled",empty:"esri-widget__content--empty",emptyIllustration:"esri-widget__content-illustration--empty",heading:"esri-widget__heading",hidden:"esri-hidden",input:"esri-input",interactive:"esri-interactive",loader:"esri-widget__loader",loaderAnimation:"esri-widget__loader-animation",loaderText:"esri-widget__loader-text",menu:"esri-menu",menuHeader:"esri-menu__header",menuItem:"esri-menu__list-item",menuItemActive:"esri-menu__list-item--active",menuItemFocus:"esri-menu__list-item--focus",menuList:"esri-menu__list",panel:"esri-widget--panel",panelHeightOnly:"esri-widget--panel-height-only",primaryTick:"primary-tick",primaryTickAmPm:"primary-tick__ampm",primaryTickLabel:"primary-tick__label",primaryTickLabelKeepAll:"primary-tick__label--keep-all",rotating:"esri-rotating",secondaryTick:"secondary-tick",select:"esri-select",table:"esri-widget__table",widget:"esri-widget",widgetButton:"esri-widget--button",widgetButtonActive:"esri-widget--button-active",widgetDisabled:"esri-widget--disabled"},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/widgets/Compass":function(){define(["require","../chunks/tslib.es6","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./Compass/CompassViewModel","./Compass/css","../chunks/componentsUtils","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";let f=class extends a{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new l,this._reset=()=>{this.viewModel.reset()},this._toRotationTransform=e=>({transform:`rotateZ(${e.z}deg)`})}loadDependencies(){return u.loadCalciteComponents({button:()=>new Promise(((t,r)=>e(["../chunks/index2"],t,r))),icon:()=>new Promise(((t,r)=>e(["../chunks/index7"],t,r)))})}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return"rotation"===this.viewModel.state?"arrow-up":"compass-needle"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:t}=this.viewModel,{messages:r}=this;return m.tsx("div",{class:this.classes(c.css.base,d.globalCss.widget)},m.tsx("calcite-button",{class:d.globalCss.widgetButton,disabled:"disabled"===t,kind:"neutral",label:r.reset,onclick:this._reset,round:!0,scale:"s",title:r.reset},m.tsx("div",{"aria-hidden":"true",class:c.css.iconContainer,title:r.reset},m.tsx("calcite-icon",{icon:this.icon,styles:this._toRotationTransform(e)}))))}};return t.__decorate([r.property()],f.prototype,"goToOverride",null),t.__decorate([r.property()],f.prototype,"icon",null),t.__decorate([r.property()],f.prototype,"label",null),t.__decorate([r.property(),p.messageBundle("esri/widgets/Compass/t9n/Compass")],f.prototype,"messages",void 0),t.__decorate([r.property()],f.prototype,"view",null),t.__decorate([r.property({type:l})],f.prototype,"viewModel",void 0),f=t.__decorate([o.subclass("esri.widgets.Compass")],f),f}))},"esri/widgets/Compass/CompassViewModel":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../views/2d/navigation/duration","./utils","../support/GoTo"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";let d=class extends(u(t)){constructor(e){super(e),this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._watchForView(r.initial)}destroy(){this.view=null}get canShowNorth(){return c.canShowNorth(this.view)}get state(){return!this.view?.ready||"2d"===this.view.type&&!this.view.constraints.rotationEnabled?"disabled":this.canShowNorth?"compass":"rotation"}reset(){this.view?.ready&&("2d"===this.view?.type?this.callGoTo({target:{rotation:0},options:{animationMode:"always",duration:l.getGoToDuration()}}):this.callGoTo({target:{heading:0}}))}_updateForRotation(e){null!=e&&this._set("orientation",{z:e})}_updateForCamera(e){if(!e)return;const t=-e.heading;this._set("orientation",{x:0,y:0,z:t})}_updateRotationWatcher(e){this.removeAllHandles(),this._watchForView(),e&&this.addHandles("2d"===e.type?r.watch((()=>e?.rotation),this._updateForRotation,r.initial):r.watch((()=>e?.camera),this._updateForCamera,r.initial))}_watchForView(e){this.addHandles(r.watch((()=>this.view),this._updateRotationWatcher,e))}};return e.__decorate([i.property({readOnly:!0})],d.prototype,"canShowNorth",null),e.__decorate([i.property({readOnly:!0})],d.prototype,"orientation",void 0),e.__decorate([i.property({readOnly:!0})],d.prototype,"state",null),e.__decorate([i.property()],d.prototype,"view",void 0),d=e.__decorate([a.subclass("esri.widgets.Compass.CompassViewModel")],d),d}))},"esri/views/2d/navigation/duration":function(){define(["exports","../../../core/has","../../../core/time"],(function(e,t,r){"use strict";e.getGoToDuration=function(){const e=t("mapview-essential-goto-duration");return null==e?e:r.Milliseconds(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/widgets/Compass/utils":function(){define(["exports"],(function(e){"use strict";e.canShowNorth=function(e){return e?.spatialReference?.isWebMercator||e?.spatialReference?.isGeographic||!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/widgets/support/GoTo":function(){define(["../../chunks/tslib.es6","../../core/maybe","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./goToUtils"],(function(e,t,r,i,s,n,o,a){"use strict";return i=>{let s=class extends i{constructor(...e){super(...e),this.goToOverride=null,this.view=null}callGoTo(e){const{view:r}=this;return t.assertIsSome(r),this.goToOverride?this.goToOverride(r,e):a.goTo(r,e.target,e.options)}};return e.__decorate([r.property()],s.prototype,"goToOverride",void 0),e.__decorate([r.property()],s.prototype,"view",void 0),s=e.__decorate([o.subclass("esri.widgets.support.GoTo")],s),s}}))},"esri/widgets/support/goToUtils":function(){define(["exports"],(function(e){"use strict";e.goTo=function(e,t,r){return e.goTo(t,r)},e.makeGoToWithoutAnimation=function(){return(e,t)=>e.goTo(t.target,{...t.options,animate:!1})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/widgets/Compass/css":function(){define(["exports"],(function(e){"use strict";const t="esri-compass",r={base:t,iconContainer:`${t}__icon-container`};e.css=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/widgets/NavigationToggle":function(){define(["require","../chunks/tslib.es6","../core/deprecate","../core/Logger","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","./NavigationToggle/css","./NavigationToggle/NavigationToggleViewModel","../chunks/componentsUtils","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";let g=class extends l{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new u({isDefaultViewModel:!0}),this.toggle=()=>this.viewModel.toggle(),this._panButton=null,this._rotateButton=null,this._toggle=()=>{const e="pan"===this.viewModel?.navigationMode?this._rotateButton:this._panButton;p.setFocus(e),this.toggle()},e?.isDefaultUI||r.deprecateWidget(i.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.32"})}normalizeCtorArgs(e={}){const{isDefaultUI:t,...r}=e;return r}loadDependencies(){return d.loadCalciteComponents({button:()=>new Promise(((t,r)=>e(["../chunks/index2"],t,r)))})}get icon(){return"move"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){"horizontal"!==e&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e="disabled"===this.viewModel?.state,t="pan"===this.viewModel?.navigationMode,r=this.messages.toggle;return f.tsx("div",{class:this.classes(c.css.base,h.globalCss.widget,{[c.css.isLayoutHorizontal]:"horizontal"===this.layout})},f.tsx("calcite-button",{afterCreate:e=>{this._panButton=e},appearance:t?"outline-fill":"solid",class:h.globalCss.widgetButton,disabled:e,iconStart:"move",kind:"neutral",label:r,onclick:this._toggle,tabIndex:t?void 0:-1,title:r}),f.tsx("calcite-button",{afterCreate:e=>{this._rotateButton=e},appearance:t?"solid":"outline-fill",class:h.globalCss.widgetButton,disabled:e,iconStart:"rotate",kind:"neutral",label:r,onclick:this._toggle,tabIndex:t?-1:void 0,title:r}))}};return t.__decorate([s.property()],g.prototype,"icon",null),t.__decorate([s.property()],g.prototype,"label",null),t.__decorate([s.property({value:"vertical"})],g.prototype,"layout",null),t.__decorate([s.property(),m.messageBundle("esri/widgets/NavigationToggle/t9n/NavigationToggle")],g.prototype,"messages",void 0),t.__decorate([s.property()],g.prototype,"view",null),t.__decorate([s.property({type:u})],g.prototype,"viewModel",void 0),g=t.__decorate([a.subclass("esri.widgets.NavigationToggle")],g),g}))},"esri/widgets/NavigationToggle/css":function(){define(["exports"],(function(e){"use strict";const t="esri-navigation-toggle",r={base:t,isLayoutHorizontal:`${t}--horizontal`};e.css=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/widgets/NavigationToggle/NavigationToggleViewModel":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/deprecate","../../core/Logger","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a,l){"use strict";let c=class extends t{constructor(e){super(e),this._navigationMode="pan",this.view=null,e?.isDefaultViewModel||r.deprecateUnnecessaryViewModel(i.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.33"})}normalizeCtorArgs(e={}){const{isDefaultViewModel:t,...r}=e;return r}initialize(){this.addHandles(s.when((()=>this.view?.navigation?.actionMap),(()=>this._updateNavigationActionMap())))}destroy(){this.view=null}get state(){return this.view?.ready&&"3d"===this.view?.type?"ready":"disabled"}get navigationMode(){return this._navigationMode}set navigationMode(e){this._navigationMode=e,this._updateNavigationActionMap()}toggle(){"disabled"!==this.state&&(this.navigationMode="pan"!==this.navigationMode?"pan":"rotate")}_updateNavigationActionMap(){const e=this.view?.navigation?.actionMap;if(!e)return;const t="pan"===this._navigationMode;e.dragPrimary=t?"pan":"rotate",e.dragSecondary=t?"rotate":"pan"}};return e.__decorate([n.property({readOnly:!0})],c.prototype,"state",null),e.__decorate([n.property()],c.prototype,"_navigationMode",void 0),e.__decorate([n.property()],c.prototype,"view",void 0),c=e.__decorate([l.subclass("esri.widgets.NavigationToggle.NavigationToggleViewModel")],c),c}))},"esri/widgets/Zoom":function(){define(["require","../chunks/tslib.es6","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/RandomLCG","../core/accessorSupport/decorators/subclass","./Widget","../chunks/componentsUtils","./support/globalCss","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","./Zoom/ZoomViewModel"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const m="esri-zoom--horizontal";let f=class extends a{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new p,this.zoomIn=()=>this.viewModel.zoomIn(),this.zoomOut=()=>this.viewModel.zoomOut()}loadDependencies(){return l.loadCalciteComponents({button:()=>new Promise(((t,r)=>e(["../chunks/index2"],t,r)))})}get icon(){return"magnifying-glass-plus"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){"horizontal"!==e&&(e="vertical"),this._set("layout",e)}set view(e){this.viewModel.view=e}get view(){return this.viewModel.view}render(){const e={[m]:"horizontal"===this.layout},{canZoomIn:t,canZoomOut:r}=this.viewModel,{zoomIn:i,zoomOut:s}=this.messages;return h.tsx("div",{class:this.classes("esri-zoom",c.globalCss.widget,e)},h.tsx("calcite-button",{class:c.globalCss.widgetButton,disabled:!t,iconStart:"plus",kind:"neutral",label:i,onclick:this.zoomIn,title:i}),h.tsx("calcite-button",{class:c.globalCss.widgetButton,disabled:!r,iconStart:"minus",kind:"neutral",label:s,onclick:this.zoomOut,title:s}))}};return t.__decorate([r.property()],f.prototype,"icon",null),t.__decorate([r.property()],f.prototype,"label",null),t.__decorate([r.property({value:"vertical"})],f.prototype,"layout",null),t.__decorate([r.property(),d.messageBundle("esri/widgets/Zoom/t9n/Zoom")],f.prototype,"messages",void 0),t.__decorate([r.property()],f.prototype,"view",null),t.__decorate([r.property({type:p})],f.prototype,"viewModel",void 0),f=t.__decorate([o.subclass("esri.widgets.Zoom")],f),f}))},"esri/widgets/Zoom/ZoomViewModel":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/promiseUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","./ZoomConditions2D","./ZoomConditions3D"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";let u=class extends t{constructor(e){super(e)}destroy(){this.view=null}get canZoomIn(){return null!=this._zoomConditions&&this._zoomConditions.canZoomIn}get canZoomOut(){return null!=this._zoomConditions&&this._zoomConditions?.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){e?"2d"===e.type?this._zoomConditions=new l({view:e}):"3d"===e.type&&(this._zoomConditions=new c({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){const e=this.view;this.canZoomIn&&e&&("2d"===e.type?e.mapViewNavigation.zoomIn():r.ignoreAbortErrors(e.goTo({zoomFactor:2})))}zoomOut(){const e=this.view;this.canZoomOut&&e&&("2d"===e.type?e.mapViewNavigation.zoomOut():r.ignoreAbortErrors(e.goTo({zoomFactor:.5})))}};return e.__decorate([i.property()],u.prototype,"_zoomConditions",void 0),e.__decorate([i.property()],u.prototype,"canZoomIn",null),e.__decorate([i.property()],u.prototype,"canZoomOut",null),e.__decorate([i.property({readOnly:!0})],u.prototype,"state",null),e.__decorate([i.property()],u.prototype,"view",null),u=e.__decorate([a.subclass("esri.widgets.Zoom.ZoomViewModel")],u),u}))},"esri/widgets/Zoom/ZoomConditions2D":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o){"use strict";let a=class extends t{get canZoomIn(){const e=this.view?.ready;if(!e)return!1;const t=this.view?.constraints?.effectiveMaxScale;return 0===t||this._scale>t}get canZoomOut(){const{view:e}=this,t=e?.ready;if(!t)return!1;const r=e.constraints?.effectiveMinScale;return 0===r||this._scale<r}get _scale(){const e=this.view?.animation?.target;return(e&&"then"in e?void 0:e?.scale)??this.view?.scale??0}};return e.__decorate([r.property({readOnly:!0})],a.prototype,"canZoomIn",null),e.__decorate([r.property({readOnly:!0})],a.prototype,"canZoomOut",null),e.__decorate([r.property()],a.prototype,"view",void 0),e.__decorate([r.property()],a.prototype,"_scale",null),a=e.__decorate([o.subclass("esri.widgets.Zoom.ZoomConditions2D")],a),a}))},"esri/widgets/Zoom/ZoomConditions3D":function(){define(["../../chunks/tslib.es6","../../core/Accessor","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o){"use strict";let a=class extends t{get canZoomIn(){return!!this.view.ready}get canZoomOut(){return!!this.view.ready}};return e.__decorate([r.property({readOnly:!0})],a.prototype,"canZoomIn",null),e.__decorate([r.property({readOnly:!0})],a.prototype,"canZoomOut",null),e.__decorate([r.property()],a.prototype,"view",void 0),a=e.__decorate([o.subclass("esri.widgets.Zoom.ZoomConditions3D")],a),a}))},"esri/views/ui/3d/DefaultUI3D":function(){define(["../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../DefaultUI"],(function(e,t,r,i,s,n,o){"use strict";let a=class extends o{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};return e.__decorate([t.property()],a.prototype,"components",void 0),a=e.__decorate([n.subclass("esri.views.ui.3d.DefaultUI3D")],a),a}))},"esri/layers/SceneLayer":function(){define(["require","../chunks/tslib.es6","../Graphic","../PopupTemplate","../core/Clonable","../core/Collection","../core/Error","../core/handleUtils","../core/Logger","../core/maybe","../core/MultiOriginJSONSupport","../core/promiseUtils","../core/reactiveUtils","../core/accessorSupport/decorators/property","../core/has","../core/RandomLCG","../core/accessorSupport/utils","../core/accessorSupport/decorators/reader","../core/accessorSupport/decorators/subclass","../core/accessorSupport/PropertyOrigin","../geometry/Point","./Layer","./graphics/sources/support/uploadAssetErrors","./mixins/APIKeyMixin","./mixins/ArcGISService","./mixins/CustomParametersMixin","./mixins/EditBusLayer","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/SceneService","./mixins/TemporalLayer","./mixins/TemporalSceneLayer","./support/arcgisLayerUrl","./support/associatedFeatureServiceUtils","./support/capabilities","./support/commonProperties","./support/featureLayerUtils","./support/FeatureReduction","./support/FeatureReductionSelection","./support/fieldProperties","./support/FieldsIndex","./support/fieldUtils","./support/I3SLayerDefinitions","./support/infoFor3D","./support/LabelClass","./support/labelingInfo","./support/LayerFloorInfo","./support/lazyLayerLoader","./support/meshSpatialReferenceScaleUtils","./support/RangeInfo","./support/SceneFilter","./support/sceneLayerCacheUtils","./support/sceneLayerStatistics","../renderers/support/styleUtils","../renderers/support/typeUtils","../rest/support/Query","../support/elevationInfoUtils","../support/popupUtils","../support/zipUtils","../views/3d/layers/i3s/I3SUtil","../views/layers/support/popupUtils","../webdoc/support/opacityUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z,Y,X,K,J,ee,te,re,ie,se,ne,oe,ae,le){"use strict";const ce=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"})),ue=new Set(["3DObject","Point"]),de=G.defineFieldProperties();let he=class extends(I.TemporalSceneLayer(P.EditBusLayer(O.SceneService(T.ArcGISService(M.OperationalLayer(R.PortalLayer(E.ScaleRangeLayer(u.MultiOriginJSONMixin(C.CustomParametersMixin(x.APIKeyMixin(s.ClonableMixin(S)))))))))))){constructor(...e){super(...e),this.featureReduction=null,this.rangeInfos=null,this.operationalLayerType="ArcGISSceneServiceLayer",this.type="scene",this.fields=null,this.floorInfo=null,this.outFields=null,this.nodePages=null,this.materialDefinitions=null,this.textureSetDefinitions=null,this.geometryDefinitions=null,this.serviceUpdateTimeStamp=null,this.excludeObjectIds=new n,this.definitionExpression=null,this.filter=null,this.path=null,this.labelsVisible=!0,this.labelingInfo=null,this.legendEnabled=!0,this.priority=null,this.semantic=null,this.cachedDrawingInfo={color:!1},this.popupEnabled=!0,this.popupTemplate=null,this.attributeTableTemplate=null,this.objectIdField=null,this.globalIdField=null,this._fieldUsageInfo={},this.screenSizePerspectiveEnabled=!0,this.serviceItemId=void 0}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}destroy(){this._set("renderer",null),this.associatedLayer=c.destroyMaybe(this.associatedLayer)}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){const r=this.getField(e)?.domain??null;return this.associatedLayer?U.getFieldDomain(this.associatedLayer,e,t,r):r}getFeatureType(e){return e&&this.associatedLayer?this.associatedLayer.getFeatureType(e):null}get types(){return this.associatedLayer?.types??[]}get typeIdField(){return this.associatedLayer?.typeIdField??null}get templates(){return this.associatedLayer?.templates??null}get formTemplate(){return this.associatedLayer?.formTemplate??null}get fieldsIndex(){return new k(this.fields)}readNodePages(e,t,r){return"Point"===t.layerType&&(e=t.pointNodePages),null==e||"object"!=typeof e?null:j.I3SNodePageDefinition.fromJSON(e,r)}set elevationInfo(e){this._set("elevationInfo",e),this.loaded&&this._validateElevationInfo()}get effectiveCapabilities(){return this._capabilitiesFromAssociatedFeatureLayer(this.associatedLayer?.effectiveCapabilities)}get effectiveEditingEnabled(){return null!=this.associatedLayer&&U.computeEffectiveEditingEnabled(this.associatedLayer)}get geometryType(){return me[this.profile]||"mesh"}set renderer(e){z.fixRendererFields(e,this.fieldsIndex),this._set("renderer",e)}readCachedDrawingInfo(e){return null!=e&&"object"==typeof e||(e={}),null==e.color&&(e.color=!1),e}get capabilities(){return this._capabilitiesFromAssociatedFeatureLayer(this.associatedLayer?.capabilities)}_capabilitiesFromAssociatedFeatureLayer(e){e=null!=e?e:L.zeroCapabilities;const{query:t,queryRelated:r,editing:{supportsGlobalId:i,supportsRollbackOnFailure:s,supportsUploadWithItemId:n,supportsGeometryUpdate:o,supportsReturnServiceEditsInSourceSpatialReference:a},data:{supportsZ:l,supportsM:c,isVersioned:u,supportsAttachment:d},operations:{supportsEditing:h,supportsAdd:p,supportsUpdate:m,supportsDelete:f,supportsQuery:g,supportsQueryAttachments:y,supportsAsyncConvert3D:_}}=e,b=e.operations.supportsChangeTracking,v=!!this.associatedLayer?.infoFor3D;return{query:t,queryRelated:r,editing:{supportsGlobalId:i,supportsReturnServiceEditsInSourceSpatialReference:a,supportsRollbackOnFailure:s,supportsGeometryUpdate:v&&o,supportsUploadWithItemId:n},data:{supportsAttachment:d,supportsZ:l,supportsM:c,isVersioned:u},operations:{supportsQuery:g,supportsQueryAttachments:y,supportsEditing:h&&b,supportsAdd:v&&p&&b,supportsDelete:v&&f&&b,supportsUpdate:m&&b,supportsAsyncConvert3D:_}}}get editingEnabled(){return this._isOverridden("editingEnabled")?this._get("editingEnabled"):this.associatedLayer?.editingEnabled??!1}set editingEnabled(e){this._overrideIfSome("editingEnabled",e)}get infoFor3D(){return this.associatedLayer?.infoFor3D??null}get relationships(){return this.associatedLayer?.relationships}get defaultPopupTemplate(){return this.associatedLayer||this.attributeStorageInfo?this.createPopupTemplate():null}readObjectIdField(e,t){return!e&&t.fields&&t.fields.some((t=>("esriFieldTypeOID"===t.type&&(e=t.name),!!e))),e||void 0}readGlobalIdField(e,t){return!e&&t.fields&&t.fields.some((t=>("esriFieldTypeGlobalID"===t.type&&(e=t.name),!!e))),e||void 0}get displayField(){return this.associatedLayer?.displayField??null}readProfile(e,t){const r=t.store.profile;return null!=r&&pe[r]?pe[r]:(l.getLogger(this).error("Unknown or missing profile",{profile:r,layer:this}),"mesh-pyramids")}get useViewTime(){return this.associatedLayer?.useViewTime??!0}set useViewTime(e){this._override("useViewTime",e)}load(e){return this.addResolvingPromise(this._load(e)),Promise.resolve(this)}async _load(e){const t=null!=e?e.signal:null;await this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(d.throwIfAbortError),await this._fetchService(t),await Promise.all([this._fetchIndexAndUpdateExtent(this.nodePages,t),this._setAssociatedFeatureLayer(t),this._loadFilterGeometries()]),this._validateElevationInfo(),this._applyAssociatedLayerOverrides(),this._populateFieldUsageInfo(),await this.loadTimeInfoFromService(e),await ee.loadStyleRenderer(this,{origin:"service"},t),z.fixRendererFields(this.renderer,this.fieldsIndex),await this.finishLoadEditablePortalLayer(e)}async beforeSave(){null!=this.filter&&(this.filter=this.filter.clone(),await this.load())}async _loadFilterGeometries(){if(this.filter)try{await this.filter.loadGeometries(this.spatialReference)}catch(e){l.getLogger(this).error("#_loadFilterGeometries()",this,"Failed to load filter geometries. Geometry filter will not be applied for this layer.",{error:e}),this.filter=null}}createQuery(){const e=new re;return"mesh"===this.geometryType?this.capabilities.query.supportsReturnMesh&&(e.returnGeometry=!0):(e.returnGeometry=!0,e.returnZ=!0),e.where=this.definitionExpression||"1=1",e.sqlFormat="standard",e.outFields=["*"],e}queryExtent(e,t){return this._getAssociatedLayerForQuery().then((r=>r.queryExtent(e||this.createQuery(),t)))}queryFeatureCount(e,t){return this._getAssociatedLayerForQuery().then((r=>r.queryFeatureCount(e||this.createQuery(),t)))}queryFeatures(e,t){return this._getAssociatedLayerForQuery().then((r=>r.queryFeatures(e||this.createQuery(),t))).then((e=>{if(e?.features)for(const t of e.features)t.layer=this,t.sourceLayer=this;return e}))}async queryRelatedFeatures(e,t){if(await this.load(),!this.associatedLayer)throw new o("scenelayer:query-not-available","SceneLayer queries are not available without an associated feature layer",{layer:this});return this.associatedLayer.queryRelatedFeatures(e,t)}async queryRelatedFeaturesCount(e,t){if(await this.load(),!this.associatedLayer)throw new o("scenelayer:query-not-available","SceneLayer queries are not available without an associated feature layer",{layer:this});return this.associatedLayer.queryRelatedFeaturesCount(e,t)}async queryCachedAttributes(e,t){const r=z.unpackFieldNames(this.fieldsIndex,await ae.getRequiredFields(this,ae.getFetchPopupTemplate(this)));return oe.queryAttributesFromCachedAttributesId(this.parsedUrl?.path??"",this.attributeStorageInfo??[],e,t,r,this.apiKey,this.customParameters)}async queryCachedFeature(e,t){const i=await this.queryCachedAttributes(e,[t]);if(!i||0===i.length)throw new o("scenelayer:feature-not-in-cached-data","Feature not found in cached data");const s=new r;return s.attributes=i[0],s.layer=this,s.sourceLayer=this,s}queryObjectIds(e,t){return this._getAssociatedLayerForQuery().then((r=>r.queryObjectIds(e||this.createQuery(),t)))}queryAttachments(e,t){return this._getAssociatedLayerForQuery().then((r=>r.queryAttachments(e,t)))}getFieldUsageInfo(e){const t={supportsLabelingInfo:!1,supportsRenderer:!1,supportsPopupTemplate:!1,supportsLayerQuery:!1};return this.loaded?this._fieldUsageInfo[e]||t:(l.getLogger(this).error("#getFieldUsageInfo()","Unavailable until layer is loaded"),t)}createPopupTemplate(e){return se.createPopupTemplate(this,e)}_getAssociatedLayerForQuery(){const e=this.associatedLayer;return e?.loaded?Promise.resolve(e):this._loadAssociatedLayerForQuery()}async _loadAssociatedLayerForQuery(){if(await this.load(),!this.associatedLayer)throw new o("scenelayer:query-not-available","SceneLayer queries are not available without an associated feature layer",{layer:this});try{await this.associatedLayer.load()}catch(e){throw new o("scenelayer:query-not-available","SceneLayer associated feature layer could not be loaded",{layer:this,error:e})}return this.associatedLayer}hasCachedStatistics(e){return null!=this.statisticsInfo&&this.statisticsInfo.some((t=>t.name===e))}async queryCachedStatistics(e,t){return await this.load(t),await this.fetchStatistics(e,t)}async saveAs(e,t){return this._debouncedSaveOperations(O.SaveOperationType.SAVE_AS,{...t,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"scene"},e)}async save(){const e={getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"scene"};return this._debouncedSaveOperations(O.SaveOperationType.SAVE,e)}async applyEdits(t,r){const{applyEdits:i}=await new Promise(((t,r)=>e(["./graphics/editingSupport"],t,r)));let s=r;await this.load();const n=this.associatedLayer;if(!n)throw new o(`${this.type}-layer:not-editable`,"Service is not editable");await n.load();const{globalIdField:a}=n,l=!!n.infoFor3D,c=s?.globalIdUsed??!0;if(l&&null==a)throw new o(`${this.type}-layer:not-editable`,"Valid globalIdField expected on editable SceneLayer");if(l&&!c)throw new o(`${this.type}-layer:globalid-required`,"globalIdUsed must not be false for SceneLayer editing as globalIds are required.");return D.isHostedAgolService(n.url)&&l&&null!=t.deleteFeatures&&null!=a&&(s={...s,globalIdToObjectId:await U.getGlobalIdToObjectIdMap(n,t.deleteFeatures,a)}),i(this,n.source,t,s)}async uploadAssets(e,t){if(await this.load(),null==this.associatedLayer)throw new o(`${this.type}-layer:not-editable`,"Service is not editable");return await this.associatedLayer.load(),this.associatedLayer.uploadAssets(e,t)}on(e,t){return super.on(e,t)}async convertMesh(t,r){r??={};const i=e=>{throw l.getLogger(this).error(".convertMesh()",e.message),e};await this.load(),this.infoFor3D||i(new o("invalid:layer","SceneLayer has no capability for mesh conversion"));const s=await this.extractAndFilterFiles(t),n=s.reduce(((e,t)=>q.isFileEditFormat(this.infoFor3D,t)?e+1:e),0);0===n&&i(new w.NoModelError),n>1&&i(new w.MultipleModelsError);const a=this.spatialReference,c=r.location??new v({x:0,y:0,z:0,spatialReference:a}),u=c.spatialReference.isGeographic?"local":"georeferenced",{default:d}=await new Promise(((t,r)=>e(["../geometry/Mesh"],(e=>t(ce(e))),r))),h=d.createWithExternalSource(c,{type:"client",files:s},{vertexSpace:u,transform:Z.getMeshTransformForMetersToSpatialReference(c.spatialReference),unitConversionDisabled:!0}),[p]=await this.uploadAssets([h],{...r,useAssetOrigin:!r.location});return p}async extractAndFilterFiles(e){await this.load();const t=this.infoFor3D;return t?(await ne.extractZipFiles(e)).filter((e=>q.isFileSupported(t,e))):e}validateLayer(e){if(e.layerType&&!ue.has(e.layerType))throw new o("scenelayer:layer-type-not-supported","SceneLayer does not support this layer type",{layerType:e.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor))throw new o("layer:service-version-not-supported","Service version is not supported.",{serviceVersion:this.version.versionString,supportedVersions:"1.x, 2.x"});if(this.version.major>2)throw new o("layer:service-version-too-new","Service version is too new.",{serviceVersion:this.version.versionString,supportedVersions:"1.x, 2.x"});!function(e,t){let r=!1,i=!1;if(null==e)r=!0,i=!0;else{const s=t&&t.isGeographic;switch(e){case"east-north-up":case"earth-centered":r=!0,i=s;break;case"vertex-reference-frame":r=!0,i=!s;break;default:r=!1}}if(!r)throw new o("scenelayer:unsupported-normal-reference-frame","Normal reference frame is invalid.");if(!i)throw new o("scenelayer:incompatible-normal-reference-frame","Normal reference frame is incompatible with layer spatial reference.")}(this.normalReferenceFrame,this.spatialReference)}_getTypeKeywords(){const e=[];if("points"===this.profile)e.push("Point");else{if("mesh-pyramids"!==this.profile)throw new o("scenelayer:unknown-profile","SceneLayer:save() encountered an unknown SceneLayer profile: "+this.profile);e.push("3DObject")}return e}_populateFieldUsageInfo(){if(this._fieldUsageInfo={},this.fields)for(const e of this.fields){const t=!!this.attributeStorageInfo?.some((t=>t.name===e.name)),r=!!this.associatedLayer?.fields?.some((t=>t&&e.name===t.name)),i={supportsLabelingInfo:t,supportsRenderer:t,supportsPopupTemplate:t||r,supportsLayerQuery:r};this._fieldUsageInfo[e.name]=i}}_applyAssociatedLayerOverrides(){this._applyAssociatedLayerFieldsOverrides(),this._applyAssociatedLayerPropertyOverrides(),this._applyAssociatedLayerExtentOverride(),this._applyAssociatedLayerPrivileges()}_applyAssociatedLayerFieldsOverrides(){if(!this.associatedLayer?.fields)return;let e=null;for(const t of this.associatedLayer.fields){const r=this.getField(t.name);r?(!r.domain&&t.domain&&(r.domain=t.domain.clone()),r.editable=t.editable,r.nullable=t.nullable,r.length=t.length):(e||(e=this.fields?this.fields.slice():[]),e.push(t.clone()))}e&&this._set("fields",e)}_applyAssociatedLayerPropertyOverrides(){if(!this.associatedLayer)return;const e=["popupTemplate","popupEnabled","attributeTableTemplate"],t=g.getProperties(this);for(let r=0;r<e.length;r++){const i=e[r],s=this.originIdOf(i),n=this.associatedLayer.originIdOf(i);s<n&&(n===b.OriginId.SERVICE||n===b.OriginId.PORTAL_ITEM)&&t.setAtOrigin(i,this.associatedLayer[i],n)}}_applyAssociatedLayerExtentOverride(){const e=this.associatedLayer?.getAtOrigin("fullExtent","service");null!=this.associatedLayer?.infoFor3D&&e&&D.isHostedAgolService(this.associatedLayer?.url)&&K.cacheIsOutOfSync(this)&&g.getProperties(this).setAtOrigin("fullExtent",e.clone(),b.OriginId.SERVICE)}_applyAssociatedLayerPrivileges(){const e=this.associatedLayer;e&&(this._set("userHasEditingPrivileges",e.userHasEditingPrivileges),this._set("userHasFullEditingPrivileges",e.userHasFullEditingPrivileges),this._set("userHasUpdateItemPrivileges",e.userHasUpdateItemPrivileges))}async _setAssociatedFeatureLayer(e){if(["mesh-pyramids","points"].includes(this.profile))try{const{serverUrl:t,layerId:r,portalItem:i}=await F.findAssociatedFeatureService(`${this.url}/layers/${this.layerId}`,{sceneLayerItem:this.portalItem,customParameters:this.customParameters,apiKey:this.apiKey,signal:e}),s=await Q.layerLookupMap.FeatureLayer();this.associatedLayer=new s({url:t,customParameters:this.customParameters,layerId:r,portalItem:i}),await this.associatedLayer.load()}catch(e){d.isAbortError(e)||this._logWarningOnPopupEnabled()}}async _logWarningOnPopupEnabled(){const e=new AbortController;this.addHandles(a.abortHandle(e));try{await h.whenOnce((()=>this.popupEnabled&&null!=this.popupTemplate),e.signal)}catch(e){return void d.throwIfNotAbortError(e)}const t=`this SceneLayer: ${this.title}`;null==this.attributeStorageInfo?l.getLogger(this).warn(`Associated FeatureLayer could not be loaded and no binary attributes found. Popups will not work on ${t}`):l.getLogger(this).info(`Associated FeatureLayer could not be loaded. Falling back to binary attributes for Popups on ${t}`)}_validateElevationInfo(){const e=this.elevationInfo;"mesh-pyramids"===this.profile&&ie.logInvalidElevationInfoWarning(l.getLogger(this),ie.elevationModeUnsupportedMessage("Mesh scene layers","relative-to-scene",e)),ie.logInvalidElevationInfoWarning(l.getLogger(this),ie.featureExpressionUnsupportedMessage("Scene layers",e))}async fetchStatistics(e,t){return await J.fetchStatistics({fieldName:e,statisticsInfo:this.statisticsInfo,errorContext:"scenelayer",fieldsIndex:this.fieldsIndex,path:this.parsedUrl?.path??"",customParameters:this.customParameters,apiKey:this.apiKey,signal:t?.signal})}};t.__decorate([p.property({types:{key:"type",base:V.FeatureReduction,typeMap:{selection:B}},json:{origins:{"web-scene":{name:"layerDefinition.featureReduction",write:!0},"portal-item":{name:"layerDefinition.featureReduction",write:!0}}}})],he.prototype,"featureReduction",void 0),t.__decorate([p.property({type:[Y.RangeInfo],json:{read:!1,origins:{"web-scene":{name:"layerDefinition.rangeInfos",write:!0},"portal-item":{name:"layerDefinition.rangeInfos",write:!0}}}})],he.prototype,"rangeInfos",void 0),t.__decorate([p.property({json:{read:!1}})],he.prototype,"associatedLayer",void 0),t.__decorate([p.property({type:["show","hide"]})],he.prototype,"listMode",void 0),t.__decorate([p.property({type:["ArcGISSceneServiceLayer"]})],he.prototype,"operationalLayerType",void 0),t.__decorate([p.property({json:{read:!1},readOnly:!0})],he.prototype,"type",void 0),t.__decorate([p.property({...de.fields,readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],he.prototype,"fields",void 0),t.__decorate([p.property()],he.prototype,"types",null),t.__decorate([p.property()],he.prototype,"typeIdField",null),t.__decorate([p.property()],he.prototype,"templates",null),t.__decorate([p.property()],he.prototype,"formTemplate",null),t.__decorate([p.property({readOnly:!0,clonable:!1})],he.prototype,"fieldsIndex",null),t.__decorate([p.property({type:$,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],he.prototype,"floorInfo",void 0),t.__decorate([p.property(de.outFields)],he.prototype,"outFields",void 0),t.__decorate([p.property({type:j.I3SNodePageDefinition,readOnly:!0,json:{read:!1}})],he.prototype,"nodePages",void 0),t.__decorate([y.reader("service","nodePages",["nodePages","pointNodePages"])],he.prototype,"readNodePages",null),t.__decorate([p.property({type:[j.I3SMaterialDefinition],readOnly:!0})],he.prototype,"materialDefinitions",void 0),t.__decorate([p.property({type:[j.I3STextureSetDefinition],readOnly:!0})],he.prototype,"textureSetDefinitions",void 0),t.__decorate([p.property({type:[j.I3SGeometryDefinition],readOnly:!0})],he.prototype,"geometryDefinitions",void 0),t.__decorate([p.property({readOnly:!0})],he.prototype,"serviceUpdateTimeStamp",void 0),t.__decorate([p.property({readOnly:!0})],he.prototype,"attributeStorageInfo",void 0),t.__decorate([p.property({readOnly:!0})],he.prototype,"statisticsInfo",void 0),t.__decorate([p.property({type:n.ofType(Number),nonNullable:!0,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.excludeObjectIds",write:{enabled:!0}}})],he.prototype,"excludeObjectIds",void 0),t.__decorate([p.property({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],he.prototype,"definitionExpression",void 0),t.__decorate([p.property({type:X,json:{name:"layerDefinition.polygonFilter",write:{enabled:!0,allowNull:!0},origins:{service:{read:!1,write:!1}}}})],he.prototype,"filter",void 0),t.__decorate([p.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],he.prototype,"path",void 0),t.__decorate([p.property(N.elevationInfo)],he.prototype,"elevationInfo",null),t.__decorate([p.property({readOnly:!0,json:{read:!1}})],he.prototype,"effectiveCapabilities",null),t.__decorate([p.property({readOnly:!0})],he.prototype,"effectiveEditingEnabled",null),t.__decorate([p.property({type:String})],he.prototype,"geometryType",null),t.__decorate([p.property(N.labelsVisible)],he.prototype,"labelsVisible",void 0),t.__decorate([p.property({type:[H],json:{origins:{service:{name:"drawingInfo.labelingInfo",read:{reader:W.reader},write:!1}},name:"layerDefinition.drawingInfo.labelingInfo",read:{reader:W.reader},write:!0}})],he.prototype,"labelingInfo",void 0),t.__decorate([p.property(N.legendEnabled)],he.prototype,"legendEnabled",void 0),t.__decorate([p.property({type:Number,json:{origins:{"web-document":{default:1,write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}},read:{source:["opacity","layerDefinition.drawingInfo.transparency"],reader(e,t){if("number"==typeof e&&e>=0&&e<=1)return e;const r=t.layerDefinition?.drawingInfo?.transparency;return void 0!==r?le.transparencyToOpacity(r):void 0}}},"portal-item":{write:!0},service:{read:!1}}}})],he.prototype,"opacity",void 0),t.__decorate([p.property({type:["Low","High"],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],he.prototype,"priority",void 0),t.__decorate([p.property({type:["Labels"],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],he.prototype,"semantic",void 0),t.__decorate([p.property({types:te.webSceneRendererTypes,json:{origins:{service:{read:{source:"drawingInfo.renderer"}}},name:"layerDefinition.drawingInfo.renderer",write:!0},value:null})],he.prototype,"renderer",null),t.__decorate([p.property({json:{read:!1}})],he.prototype,"cachedDrawingInfo",void 0),t.__decorate([y.reader("service","cachedDrawingInfo")],he.prototype,"readCachedDrawingInfo",null),t.__decorate([p.property({readOnly:!0,json:{read:!1}})],he.prototype,"capabilities",null),t.__decorate([p.property({type:Boolean,json:{read:!1}})],he.prototype,"editingEnabled",null),t.__decorate([p.property({readOnly:!0,json:{write:!1,read:!1}})],he.prototype,"infoFor3D",null),t.__decorate([p.property({readOnly:!0,json:{write:!1,read:!1}})],he.prototype,"relationships",null),t.__decorate([p.property(N.popupEnabled)],he.prototype,"popupEnabled",void 0),t.__decorate([p.property({type:i,json:{name:"popupInfo",write:!0}})],he.prototype,"popupTemplate",void 0),t.__decorate([p.property({readOnly:!0,json:{read:!1}})],he.prototype,"defaultPopupTemplate",null),t.__decorate([p.property(N.attributeTableTemplate)],he.prototype,"attributeTableTemplate",void 0),t.__decorate([p.property({type:String,json:{read:!1}})],he.prototype,"objectIdField",void 0),t.__decorate([y.reader("service","objectIdField",["objectIdField","fields"])],he.prototype,"readObjectIdField",null),t.__decorate([p.property({type:String,json:{read:!1}})],he.prototype,"globalIdField",void 0),t.__decorate([y.reader("service","globalIdField",["globalIdField","fields"])],he.prototype,"readGlobalIdField",null),t.__decorate([p.property({readOnly:!0,type:String,json:{read:!1}})],he.prototype,"displayField",null),t.__decorate([p.property({type:String,json:{read:!1}})],he.prototype,"profile",void 0),t.__decorate([y.reader("service","profile",["store.profile"])],he.prototype,"readProfile",null),t.__decorate([p.property({readOnly:!0,type:String,json:{origins:{service:{read:{source:"store.normalReferenceFrame"}}},read:!1}})],he.prototype,"normalReferenceFrame",void 0),t.__decorate([p.property(N.screenSizePerspectiveEnabled)],he.prototype,"screenSizePerspectiveEnabled",void 0),t.__decorate([p.property({json:{read:!1,origins:{service:{read:!0}}}})],he.prototype,"serviceItemId",void 0),t.__decorate([p.property(A.useViewTimeProperty)],he.prototype,"useViewTime",null),he=t.__decorate([_.subclass("esri.layers.SceneLayer")],he);const pe={"mesh-pyramids":"mesh-pyramids",meshpyramids:"mesh-pyramids","features-meshes":"mesh-pyramids",points:"points","features-points":"points",lines:"lines","features-lines":"lines",polygons:"polygons","features-polygons":"polygons"},me={"mesh-pyramids":"mesh",points:"point"};return he}))},"esri/layers/graphics/sources/support/uploadAssetErrors":function(){define(["exports","../../../../core/Error"],(function(e,t){"use strict";const r="upload-assets",i=()=>new Error;e.BadResponseError=class extends t{constructor(e,t){super(`${r}:bad-response`,`Bad response. Uploaded ${e} items and received ${t} results.`,i())}},e.Convert3DFailedError=class extends t{constructor(){super(`${r}:convert3D-failed`,"convert3D failed.")}},e.MultipleModelsError=class extends t{constructor(){super("invalid-input:multiple-models","Multiple supported models found")}},e.NoGlbSupportError=class extends t{constructor(){super(`${r}:no-glb-support`,"Layer does not support glb.",i())}},e.NoModelError=class extends t{constructor(){super("invalid-input:no-model","No supported model found")}},e.NoSupportedSourceError=class extends t{constructor(){super(`${r}:no-supported-source`,"No supported external source found",i())}},e.NotBase64Error=class extends t{constructor(){super(`${r}:not-base-64`,"Expected gltf data in base64 format after conversion.",i())}},e.UnableToPrepareOptionsError=class extends t{constructor(){super(`${r}:unable-to-prepare-options`,"Unable to prepare uploadAsset request options.",i())}},e.UnsupportedError=class extends t{constructor(){super(`${r}:unsupported`,"Layer does not support asset uploads.",i())}},e.UnsupportedFormatUploadedError=class extends t{constructor(e){super(`${r}-layer:unsupported-format`,`The service allowed us to upload an asset of FormatID ${e}, but it does not list it in its supported formats.`,i())}},e.UploadFailedError=class extends t{constructor(e,t){super(`${r}-layer:upload-failed`,`Failed to upload mesh file ${e}. Error code: ${t?.code??"-1"}. Error message: ${t?.messages??"unknown"}`,i())}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/mixins/SceneService":function(){define(["exports","../../chunks/tslib.es6","../../request","../../core/Error","../../core/Logger","../../core/promiseUtils","../../core/urlUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../core/accessorSupport/originUtils","../../geometry/Extent","../../geometry/HeightModelInfo","../../geometry/SpatialReference","../support/arcgisLayerUrl","../support/commonProperties","../support/I3SIndexInfo","../support/schemaValidatorLoader","../../portal/Portal","../../portal/PortalItem","../../portal/support/jsonContext","../../webdoc/support/resourceUtils","../../webdoc/support/saveUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C){"use strict";const P=-1e38;function M(e){if(null!=e.spatialReference)return g.fromJSON(e.spatialReference);const t=e.store,r=t.indexCRS||t.geographicCRS,i=r&&parseInt(r.slice(r.lastIndexOf("/")+1),10);return null!=i?new g(i):null}function R(e,t,r){e.typeKeywords||(e.typeKeywords=[]);const i=t.getTypeKeywords();for(const t of i)e.typeKeywords.push(t);e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)),r===E.newItem&&(e.typeKeywords=e.typeKeywords.filter((e=>"Hosted Service"!==e))))}var E;!function(e){e[e.existingItem=0]="existingItem",e[e.newItem=1]="newItem"}(E||(E={}));const O="Scene Service",A={getTypeKeywords:()=>[],portalItemLayerType:"unknown",validationOptions:{enabled:!0,ignoreUnsupported:!1,failPolicy:"throw"}};var I;e.SaveOperationType=void 0,(I=e.SaveOperationType||(e.SaveOperationType={}))[I.SAVE=0]="SAVE",I[I.SAVE_AS=1]="SAVE_AS",e.SceneService=l=>{let c=class extends l{constructor(){super(...arguments),this.spatialReference=null,this.fullExtent=null,this.heightModelInfo=null,this.minScale=0,this.maxScale=0,this.version={major:Number.NaN,minor:Number.NaN,versionString:""},this.copyright=null,this.sublayerTitleMode="item-title",this.title=null,this.layerId=null,this.indexInfo=null,this._debouncedSaveOperations=n.debounce((async(t,r,i)=>{switch(t){case e.SaveOperationType.SAVE:return this._save(r);case e.SaveOperationType.SAVE_AS:return this._saveAs(i,r)}}))}readSpatialReference(e,t){return M(t)}readFullExtent(e,t,r){if(null!=e&&"object"==typeof e){const i=null==e.spatialReference?{...e,spatialReference:M(t)}:e;return m.fromJSON(i,r)}const i=t.store,s=M(t);return null==s||null==i?.extent||!Array.isArray(i.extent)||i.extent.some((e=>e<P))?null:new m({xmin:i.extent[0],ymin:i.extent[1],xmax:i.extent[2],ymax:i.extent[3],spatialReference:s})}parseVersionString(e){const t={major:Number.NaN,minor:Number.NaN,versionString:e},r=e.split(".");return r.length>=2&&(t.major=parseInt(r[0],10),t.minor=parseInt(r[1],10)),t}readVersion(e,t){const r=t.store,i=null!=r.version?r.version.toString():"";return this.parseVersionString(i)}readTitlePortalItem(e){return"item-title"!==this.sublayerTitleMode?void 0:e}readTitleService(e,t){const r=this.portalItem?.title;if("item-title"===this.sublayerTitleMode)return this.url?y.titleFromUrlAndName(this.url,t.name):t.name;let i=t.name;if(!i&&this.url){const e=y.parse(this.url);null!=e&&(i=e.title)}return"item-title-and-service-name"===this.sublayerTitleMode&&r&&(i=r+" - "+i),y.cleanTitle(i)}set url(e){if(null==e)return void this._set("url",e);const t=y.sanitizeUrlWithLayerId({layer:this,url:e,nonStandardUrlAllowed:!1,logger:s.getLogger(this)});this._set("url",t.url),null!=t.layerId&&this._set("layerId",t.layerId)}writeUrl(e,t,r,i){y.writeUrlWithLayerId(this,e,"layers",t,i)}get parsedUrl(){const e=this._get("url"),t=o.urlToObject(e);return t&&null!=this.layerId&&(t.path=`${t.path}/layers/${this.layerId}`),t}async _fetchIndexAndUpdateExtent(e,t){this.indexInfo=b.fetchIndexInfo(this.parsedUrl?.path??"",this.rootNode,e,this.customParameters,this.apiKey,s.getLogger(this),t),null==this.fullExtent||this.fullExtent.hasZ||this._updateExtent(await this.indexInfo)}_updateExtent(e){if("page"===e?.type){const t=e.rootIndex%e.pageSize,r=e.rootPage?.nodes?.[t];if(null==r?.obb?.center||null==r.obb.halfSize)throw new i("sceneservice:invalid-node-page","Invalid node page.");if(r.obb.center[0]<P||null==this.fullExtent||this.fullExtent.hasZ)return;const s=r.obb.halfSize,n=r.obb.center[2],o=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);this.fullExtent.zmin=n-o,this.fullExtent.zmax=n+o}else if("node"===e?.type){const t=e.rootNode?.mbs;if(!Array.isArray(t)||4!==t.length||t[0]<P)return;const r=t[2],i=t[3],{fullExtent:s}=this;s&&(s.zmin=r-i,s.zmax=r+i)}}async _fetchService(e){if(null==this.url)throw new i("sceneservice:url-not-set","Scene service can not be loaded without valid portal item or url");if(null==this.layerId&&/SceneServer\/*$/i.test(this.url)){const t=await this._fetchFirstLayerId(e);null!=t&&(this.layerId=t)}return this._fetchServiceLayer(e)}async _fetchFirstLayerId(e){const t=await r(this.url??"",{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e});if(t.data&&Array.isArray(t.data.layers)&&t.data.layers.length>0)return t.data.layers[0].id}async _fetchServiceLayer(e){const t=await r(this.parsedUrl?.path??"",{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e});t.ssl&&this.url&&(this.url=this.url.replace(/^http:/i,"https:"));let i=!1;if(t.data.layerType&&"Voxel"===t.data.layerType&&(i=!0),i)return this._fetchVoxelServiceLayer();const s=t.data;this.read(s,this._getServiceContext()),this.validateLayer(s)}async _fetchVoxelServiceLayer(e){const t=(await r(this.parsedUrl?.path+"/layer",{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e})).data;this.read(t,this._getServiceContext()),this.validateLayer(t)}_getServiceContext(){return{origin:"service",portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl}}async _ensureLoadBeforeSave(){await this.load(),"beforeSave"in this&&"function"==typeof this.beforeSave&&await this.beforeSave()}validateLayer(e){}async _saveAs(e,t){const r={...A,...t};let s=w.from(e);if(!s)throw new i("sceneservice:portal-item-required","_saveAs() requires a portal item to save to");s.id&&(s=s.clone(),s.id=null);const n=s.portal||S.getDefault();await this._ensureLoadBeforeSave(),s.type=O,s.portal=n;const o=x.createForItemWrite(s,"portal-item",!0),a={layers:[this.write({},o)]};return await Promise.all(o.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(a,o,r),this.url&&(s.url=this.url),s.title||(s.title=this.title),R(s,r,E.newItem),await n.signIn(),await n.user.addItem({item:s,folder:r?.folder,data:a}),await T.saveResources(this.resourceReferences,o),this.portalItem=s,p.updateOrigins(o),o.portalItem=s,s}async _save(e){const t={...A,...e};if(!this.portalItem)throw new i("sceneservice:portal-item-not-set","Portal item to save to has not been set on this SceneService");if(this.portalItem.type!==O)throw new i("sceneservice:portal-item-wrong-type",`Portal item needs to have type "${O}"`);await this._ensureLoadBeforeSave();const r=x.createForItemWrite(this.portalItem,"portal-item",!0),s={layers:[this.write({},r)]};return await Promise.all(r.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(s,r,t),this.url&&(this.portalItem.url=this.url),this.portalItem.title||(this.portalItem.title=this.title),R(this.portalItem,t,E.existingItem),await T.updateItemWithResources(this.portalItem,s,this.resourceReferences,r),p.updateOrigins(r),this.portalItem}async _validateAgainstJSONSchema(e,t,r){const n=r?.validationOptions;C.evaluateWriteErrors(t,{errorName:"sceneservice:save"},{ignoreUnsupported:n?.ignoreUnsupported,supplementalUnsupportedErrors:["scenemodification:unsupported"]});const o=n?.enabled,a=v.getLoader();if(o&&a){const t=(await a()).validate(e,r.portalItemLayerType);if(!t.length)return;const o=`Layer item did not validate:\n${t.join("\n")}`;if(s.getLogger(this).error(`_validateAgainstJSONSchema(): ${o}`),"throw"===n.failPolicy){const e=t.map((e=>new i("sceneservice:schema-validation",e)));throw new i("sceneservice-validate:error","Failed to save layer item due to schema validation, see `details.errors`.",{validationErrors:e})}}}};return t.__decorate([a.property(_.id)],c.prototype,"id",void 0),t.__decorate([a.property({type:g})],c.prototype,"spatialReference",void 0),t.__decorate([u.reader("spatialReference",["spatialReference","store.indexCRS","store.geographicCRS"])],c.prototype,"readSpatialReference",null),t.__decorate([a.property({type:m})],c.prototype,"fullExtent",void 0),t.__decorate([u.reader("fullExtent",["fullExtent","store.extent","spatialReference","store.indexCRS","store.geographicCRS"])],c.prototype,"readFullExtent",null),t.__decorate([a.property({readOnly:!0,type:f})],c.prototype,"heightModelInfo",void 0),t.__decorate([a.property({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:{source:"minScale"},write:!1}}}})],c.prototype,"minScale",void 0),t.__decorate([a.property({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:{source:"maxScale"},write:!1}}}})],c.prototype,"maxScale",void 0),t.__decorate([a.property({readOnly:!0})],c.prototype,"version",void 0),t.__decorate([u.reader("version",["store.version"])],c.prototype,"readVersion",null),t.__decorate([a.property({type:String,json:{read:{source:"copyrightText"}}})],c.prototype,"copyright",void 0),t.__decorate([a.property({type:String,json:{read:!1}})],c.prototype,"sublayerTitleMode",void 0),t.__decorate([a.property({type:String})],c.prototype,"title",void 0),t.__decorate([u.reader("portal-item","title")],c.prototype,"readTitlePortalItem",null),t.__decorate([u.reader("service","title",["name"])],c.prototype,"readTitleService",null),t.__decorate([a.property({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{write:{target:"id",isRequired:!0,ignoreOrigin:!0},read:!1}}}})],c.prototype,"layerId",void 0),t.__decorate([a.property(_.url)],c.prototype,"url",null),t.__decorate([h.writer("url")],c.prototype,"writeUrl",null),t.__decorate([a.property()],c.prototype,"parsedUrl",null),t.__decorate([a.property({readOnly:!0})],c.prototype,"store",void 0),t.__decorate([a.property({type:String,readOnly:!0,json:{read:{source:"store.rootNode"}}})],c.prototype,"rootNode",void 0),c=t.__decorate([d.subclass("esri.layers.mixins.SceneService")],c),c},e.sceneServiceItemType=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/accessorSupport/originUtils":function(){define(["exports","../multiOriginJSONSupportUtils"],(function(e,t){"use strict";e.updateOrigins=function(e){e?.writtenProperties&&e.writtenProperties.forEach((({target:e,propName:r,newOrigin:i})=>{t.isMultiOriginJSONMixin(e)&&i&&e.originOf(r)!==i&&e.updateOrigin(r,i)}))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/I3SIndexInfo":function(){define(["exports","../../request","../../core/Error"],(function(e,t,r){"use strict";e.fetchIndexInfo=async function(e,i,s,n,o,a,l){let c=null;if(null!=s){const r=`${e}/nodepages/`,i=r+Math.floor(s.rootIndex/s.nodesPerPage);try{return{type:"page",rootPage:(await t(i,{query:{f:"json",...n,token:o},responseType:"json",signal:l})).data,rootIndex:s.rootIndex,pageSize:s.nodesPerPage,lodMetric:s.lodSelectionMetricType,urlPrefix:r}}catch(e){null!=a&&a.warn("#fetchIndexInfo()","Failed to load root node page. Falling back to node documents.",i,e),c=e}}if(!i)return null;const u=i?.split("/").pop(),d=`${e}/nodes/`,h=d+u;try{return{type:"node",rootNode:(await t(h,{query:{f:"json",...n,token:o},responseType:"json",signal:l})).data,urlPrefix:d}}catch(e){throw new r("sceneservice:root-node-missing","Root node missing.",{pageError:c,nodeError:e,url:h})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/schemaValidatorLoader":function(){define(["exports"],(function(e){"use strict";let t=null;e.getLoader=function(){return t},e.registerLoader=function(e){t=e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/portal/support/jsonContext":function(){define(["exports","../../core/urlUtils","../Portal"],(function(e,t,r){"use strict";function i(e,i){return{origin:i,url:t.urlToObject(e.itemUrl),portal:e.portal||r.getDefault(),portalItem:e}}e.createForItemRead=function(e,t){return{...i(e,t),readResourcePaths:[]}},e.createForItemWrite=function(e,r,s){const n=t.urlToObject(e.itemUrl);return{...i(e,r),messages:[],writtenProperties:[],blockedRelativeUrls:[],verifyItemRelativeUrls:n?{rootPath:n.path,writtenUrls:[]}:null,resources:s?{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}:null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/webdoc/support/resourceUtils":function(){define(["require","exports","../../core/Error","../../core/promiseUtils","../../core/uuid","../../portal/support/resourceUtils"],(function(e,t,r,i,s,n){"use strict";async function o(t,o,a){if(!o?.resources)return;const l=o.portalItem===t.portalItem?new Set(t.paths):new Set;t.paths.length=0,t.portalItem=o.portalItem;const c=new Set(o.resources.toKeep.map((e=>e.resource.path))),u=new Set,d=[];c.forEach((e=>{l.delete(e),t.paths.push(e)}));const h=[],p=[],m=[];for(const e of o.resources.toUpdate)if(l.delete(e.resource.path),c.has(e.resource.path)||u.has(e.resource.path)){const{resource:r,content:i,finish:o}=e,a=n.getSiblingOfSameTypeI(r,s.generateUUID());t.paths.push(a.path),h.push({resource:a,content:await n.contentToBlob(i),compress:e.compress}),o&&m.push((()=>o(a)))}else{t.paths.push(e.resource.path),p.push({resource:e.resource,content:await n.contentToBlob(e.content),compress:e.compress});const r=e.finish;r&&m.push((()=>r(e.resource))),u.add(e.resource.path)}for(const e of o.resources.toAdd)if(t.paths.push(e.resource.path),l.has(e.resource.path))l.delete(e.resource.path);else{h.push({resource:e.resource,content:await n.contentToBlob(e.content),compress:e.compress});const t=e.finish;t&&m.push((()=>t(e.resource)))}if(h.length||p.length){const{addOrUpdateResources:t}=await new Promise(((t,r)=>e(["../../portal/support/resourceUtils"],t,r)));await t(o.portalItem,h,"add",a),await t(o.portalItem,p,"update",a)}if(m.forEach((e=>e())),0===d.length)return l;const f=await i.allSettledErrors(d);if(i.throwIfAborted(a),f.length>0)throw new r("save:resources","Failed to save one or more resources",{errors:f});return l}async function a(e,t,r){if(!e||!t.portalItem)return;const s=[];for(const i of e){const e=t.portalItem.resourceFromPath(i);s.push(e.portalItem.removeResource(e,r))}await i.eachAlways(s)}t.saveResources=async function(e,t,r){const i=await o(e,t,r);await a(i,t,r)},t.updateItemWithResources=async function(e,t,r,i,s){const n=await o(r,i,s);await e.update({data:t}),await a(n,i,s)},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/portal/support/resourceUtils":function(){define(["exports","../../request","../../core/Error","../../core/urlUtils"],(function(e,t,r,i){"use strict";function s(e){const t=e.lastIndexOf("/");return-1===t?[".",e]:[e.slice(0,t),e.slice(t+1)]}function n(e){const[t,r]=function(e){const t=i.getPathExtension(e);return null==t?[e,""]:[e.slice(0,e.length-t.length-1),`.${t}`]}(e),[n,o]=s(t);return[n,o,r]}e.addOrUpdateResources=async function(e,t,n,o){const a=new Map;for(const{resource:e,content:i,compress:o,access:l}of t){if(!e.hasPath())throw new r(`portal-item-resource-${n}:invalid-path`,"Resource does not have a valid path");const[t,c]=s(e.path),u=`${t}/${o??""}/${l??""}`;a.has(u)||a.set(u,{prefix:t,compress:o,access:l,files:[]}),a.get(u).files.push({fileName:c,content:i})}await e.load(o);const l=i.join(e.userItemUrl,"add"===n?"addResources":"updateResources");for(const{prefix:t,compress:r,access:i,files:s}of a.values()){const n=25;for(let a=0;a<s.length;a+=n){const c=s.slice(a,a+n),u=new FormData;t&&"."!==t&&u.append("resourcesPrefix",t),r&&u.append("compress","true"),i&&u.append("access",i);let d=0;for(const{fileName:e,content:t}of c)u.append("file"+ ++d,t,e);u.append("f","json"),await e.portal.request(l,{method:"post",body:u,signal:o?.signal})}}},e.contentToBlob=async function(e){return"blob"===e.type?e.blob:"json"===e.type?new Blob([e.jsonString],{type:"application/json"}):(await t(e.url,{responseType:"blob"})).data},e.fetchResources=async function(e,t={},r){await e.load(r);const s=i.join(e.itemUrl,"resources"),{start:n=1,num:o=10,sortOrder:a="asc",sortField:l="resource"}=t,c={query:{start:n,num:o,sortOrder:a,sortField:l,token:e.apiKey},signal:r?.signal},u=await e.portal.request(s,c);return{total:u.total,nextStart:u.nextStart,resources:u.resources.map((({created:t,size:r,resource:i})=>({created:new Date(t),size:r,resource:e.resourceFromPath(i)})))}},e.getSiblingOfSameType=function(e,t){if(!e.hasPath())return null;const[r,,s]=n(e.path);return e.portalItem.resourceFromPath(i.join(r,t+s))},e.getSiblingOfSameTypeI=function(e,t){if(!e.hasPath())return null;const[r,,s]=n(e.path);return e.portalItem.resourceFromPath(i.join(r,t+s))},e.removeAllResources=async function(e,t){await e.load(t);const r=i.join(e.userItemUrl,"removeResources");return e.portal.request(r,{method:"post",query:{deleteAll:!0},signal:t?.signal})},e.removeResource=async function(e,t,s){if(!t.hasPath())throw new r("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await e.load(s);const n=i.join(e.userItemUrl,"removeResources");await e.portal.request(n,{method:"post",query:{resource:t.path},signal:s?.signal}),t.portalItem=null},e.splitPrefixFileNameAndExtension=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/webdoc/support/saveUtils":function(){define(["exports","../../core/Error","../../layers/support/layerUtils"],(function(e,t,r){"use strict";const i=new Set(["layer:unsupported","property:unsupported","symbol:unsupported","symbol-layer:unsupported","url:unsupported"]);e.beforeSave=async function(e){const t=[];for(const r of e.allLayers)if("beforeSave"in r&&"function"==typeof r.beforeSave){const e=r.beforeSave();e&&t.push(e)}await Promise.allSettled(t)},e.evaluateWriteErrors=function(e,r,s){let n=(e.messages??[]).filter((({type:e})=>"error"===e)).map((({name:e,message:r,details:i})=>new t(e,r,i)));if(e.blockedRelativeUrls&&(n=n.concat(e.blockedRelativeUrls.map((e=>new t("url:unsupported",`Relative url '${e}' is not supported`))))),s){const{ignoreUnsupported:e,supplementalUnsupportedErrors:t=[],requiredPropertyChecksDisabled:r}=s;e&&(n=n.filter((({name:e})=>!(i.has(e)||t.includes(e))))),r&&(n=n.filter((e=>"web-document-write:property-required"!==e.name)))}if(n.length>0)throw new t(r.errorName,"Failed to save due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:n})},e.hasCharts=function(e){return r.getLayersWithChartSupport(e).some((e=>!!e.charts?.length))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/mixins/TemporalSceneLayer":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../support/fieldUtils","../support/sceneLayerCacheUtils","../support/TimeInfo","../../chunks/TimeExtent","../../chunks/TimeInterval"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";let p=class extends r{constructor(){super(...arguments),this.endTimeField=null,this.startTimeField=null}};t.__decorate([i.property({type:String})],p.prototype,"endTimeField",void 0),t.__decorate([i.property({type:String})],p.prototype,"startTimeField",void 0),p=t.__decorate([a.subclass("esri.layers.mixins.TemporalSceneLayer.SceneServiceTimeInfo")],p),e.TemporalSceneLayer=e=>{let r=class extends e{constructor(){super(...arguments),this.serviceTimeInfo=null}get timeInfo(){const e=this.associatedLayer?.timeInfo;if(null==e)return null;const t=e.clone();return l.fixTimeInfoFields(t,this.fieldsIndex),t}set timeInfo(e){l.fixTimeInfoFields(e,this.fieldsIndex),this._override("timeInfo",e)}get timeExtent(){return this.associatedLayer?.timeExtent}set timeExtent(e){this._override("timeExtent",e)}get timeOffset(){return this.associatedLayer?.timeOffset}set timeOffset(e){this._override("timeOffset",e)}get datesInUnknownTimezone(){return this.associatedLayer?.datesInUnknownTimezone??!1}set datesInUnknownTimezone(e){this._override("datesInUnknownTimezone",e)}async loadTimeInfoFromService(e){const{serviceTimeInfo:t}=this;if(null==t)return;const{startTimeField:r,endTimeField:i}=t;if(null==r&&null==i)return;if(c.cacheIsOutOfSync({associatedLayer:this.associatedLayer,serviceUpdateTimeStamp:this.serviceUpdateTimeStamp}))return;const s=async t=>{let i=null;try{const r=await(this.fetchStatistics?.(t,e));i=r?.stats}catch{}if(null==i)return null;const{minTimeStr:s,min:n,maxTimeStr:o,max:a}=i,l=t===r?s??n:o??a;return null!=l?new Date(l):null},[n,o]=await Promise.all([s(r),s(i)]);if(null!=r&&null==n||null!=i&&null==o)return;const a=new d.TimeExtent({start:n,end:o});this.setAtOrigin("timeInfo",new u({endField:i,startField:r,fullTimeExtent:a}),"service")}};return t.__decorate([i.property({type:u,json:{read:!1,write:!1}})],r.prototype,"timeInfo",null),t.__decorate([i.property({type:d.TimeExtent,json:{read:!1,write:!1}})],r.prototype,"timeExtent",null),t.__decorate([i.property({type:h.TimeInterval,json:{read:!1,write:!1}})],r.prototype,"timeOffset",null),t.__decorate([i.property({type:Boolean,nonNullable:!0,json:{read:!1,write:!1}})],r.prototype,"datesInUnknownTimezone",null),t.__decorate([i.property({type:p,readOnly:!0,json:{read:{source:"timeInfo"}}})],r.prototype,"serviceTimeInfo",void 0),r=t.__decorate([a.subclass("esri.layers.mixins.TemporalSceneLayer")],r),r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/sceneLayerCacheUtils":function(){define(["exports"],(function(e){"use strict";e.cacheIsOutOfSync=function({associatedLayer:e,serviceUpdateTimeStamp:t}){const r=e?.editingInfo?.lastEditDate,i=e?.serverGens,s=null!=r,n=null!=t,o=s&&n&&t.lastUpdate!==r.getTime();return s&&(o||!n&&i?.minServerGen!==i?.serverGen)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/capabilities":function(){define(["exports"],(function(e){"use strict";const t={supportsDate:!1,supportsFixedInterval:!1,supportsAutoInterval:!1,supportsFixedBoundaries:!1,supportsStackBy:!1,supportsSplitBy:!1,supportsSnapToData:!1,supportsReturnFullIntervalBin:!1,supportsFirstDayOfWeek:!1,supportsNormalization:!1,supportedStatistics:void 0,supportedNormalizationTypes:void 0},r={analytics:{supportsCacheHint:!1},attachment:{supportsContentType:!1,supportsExifInfo:!1,supportsKeywords:!1,supportsName:!1,supportsSize:!1,supportsCacheHint:!1,supportsOrderByFields:!1,supportsResize:!1},data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsAsyncApplyEdits:!1,zDefault:void 0},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryBins:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},queryAttributeBins:t,query:{maxRecordCount:0,maxRecordCountFactor:0,maxUniqueIDCount:0,standardMaxRecordCount:0,supportsCacheHint:!1,supportsCentroid:!1,supportsCompactGeometry:!1,supportsCurrentUser:!1,supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPaginationOnAggregatedQueries:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByAnonymous:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsReturnMesh:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsTrueCurve:!1,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsStatistics:!1,tileMaxRecordCount:0}};e.zeroCapabilities=r,e.zeroQueryBins=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/I3SLayerDefinitions":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.I3SNodePageDefinition=class extends r{constructor(){super(...arguments),this.nodesPerPage=null,this.rootIndex=0,this.lodSelectionMetricType=null}},t.__decorate([i.property({type:Number})],e.I3SNodePageDefinition.prototype,"nodesPerPage",void 0),t.__decorate([i.property({type:Number})],e.I3SNodePageDefinition.prototype,"rootIndex",void 0),t.__decorate([i.property({type:String})],e.I3SNodePageDefinition.prototype,"lodSelectionMetricType",void 0),e.I3SNodePageDefinition=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SNodePageDefinition")],e.I3SNodePageDefinition),e.I3SMaterialTexture=class extends r{constructor(){super(...arguments),this.factor=1}},t.__decorate([i.property({type:Number,json:{read:{source:"textureSetDefinitionId"}}})],e.I3SMaterialTexture.prototype,"id",void 0),t.__decorate([i.property({type:Number})],e.I3SMaterialTexture.prototype,"factor",void 0),e.I3SMaterialTexture=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SMaterialTexture")],e.I3SMaterialTexture),e.I3SMaterialPBRMetallicRoughness=class extends r{constructor(){super(...arguments),this.baseColorFactor=[1,1,1,1],this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.metallicFactor=1,this.roughnessFactor=1}},t.__decorate([i.property({type:[Number]})],e.I3SMaterialPBRMetallicRoughness.prototype,"baseColorFactor",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialPBRMetallicRoughness.prototype,"baseColorTexture",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialPBRMetallicRoughness.prototype,"metallicRoughnessTexture",void 0),t.__decorate([i.property({type:Number})],e.I3SMaterialPBRMetallicRoughness.prototype,"metallicFactor",void 0),t.__decorate([i.property({type:Number})],e.I3SMaterialPBRMetallicRoughness.prototype,"roughnessFactor",void 0),e.I3SMaterialPBRMetallicRoughness=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SMaterialPBRMetallicRoughness")],e.I3SMaterialPBRMetallicRoughness),e.I3SMaterialDefinition=class extends r{constructor(){super(...arguments),this.alphaMode="opaque",this.alphaCutoff=.25,this.doubleSided=!1,this.cullFace="none",this.normalTexture=null,this.occlusionTexture=null,this.emissiveTexture=null,this.emissiveFactor=null,this.pbrMetallicRoughness=null}},t.__decorate([a.enumeration({opaque:"opaque",mask:"mask",blend:"blend"})],e.I3SMaterialDefinition.prototype,"alphaMode",void 0),t.__decorate([i.property({type:Number})],e.I3SMaterialDefinition.prototype,"alphaCutoff",void 0),t.__decorate([i.property({type:Boolean})],e.I3SMaterialDefinition.prototype,"doubleSided",void 0),t.__decorate([a.enumeration({none:"none",back:"back",front:"front"})],e.I3SMaterialDefinition.prototype,"cullFace",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialDefinition.prototype,"normalTexture",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialDefinition.prototype,"occlusionTexture",void 0),t.__decorate([i.property({type:e.I3SMaterialTexture})],e.I3SMaterialDefinition.prototype,"emissiveTexture",void 0),t.__decorate([i.property({type:[Number]})],e.I3SMaterialDefinition.prototype,"emissiveFactor",void 0),t.__decorate([i.property({type:e.I3SMaterialPBRMetallicRoughness})],e.I3SMaterialDefinition.prototype,"pbrMetallicRoughness",void 0),e.I3SMaterialDefinition=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SMaterialDefinition")],e.I3SMaterialDefinition),e.I3STextureFormat=class extends r{},t.__decorate([i.property({type:String,json:{read:{source:["name","index"],reader:(e,t)=>null!=e?e:`${t.index}`}}})],e.I3STextureFormat.prototype,"name",void 0),t.__decorate([a.enumeration({jpg:"jpg",png:"png",dds:"dds","ktx-etc2":"ktx-etc2",ktx2:"ktx2",basis:"basis"})],e.I3STextureFormat.prototype,"format",void 0),e.I3STextureFormat=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3STextureFormat")],e.I3STextureFormat),e.I3STextureSetDefinition=class extends r{constructor(){super(...arguments),this.atlas=!1}},t.__decorate([i.property({type:[e.I3STextureFormat]})],e.I3STextureSetDefinition.prototype,"formats",void 0),t.__decorate([i.property({type:Boolean})],e.I3STextureSetDefinition.prototype,"atlas",void 0),e.I3STextureSetDefinition=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3STextureSetDefinition")],e.I3STextureSetDefinition),e.I3SGeometryAttribute=class extends r{},t.__decorate([a.enumeration({Float32:"Float32",UInt64:"UInt64",UInt32:"UInt32",UInt16:"UInt16",UInt8:"UInt8"})],e.I3SGeometryAttribute.prototype,"type",void 0),t.__decorate([i.property({type:Number})],e.I3SGeometryAttribute.prototype,"component",void 0),e.I3SGeometryAttribute=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SGeometryAttribute")],e.I3SGeometryAttribute),e.I3SGeometryCompressedAttributes=class extends r{},t.__decorate([a.enumeration({draco:"draco"})],e.I3SGeometryCompressedAttributes.prototype,"encoding",void 0),t.__decorate([i.property({type:[String]})],e.I3SGeometryCompressedAttributes.prototype,"attributes",void 0),e.I3SGeometryCompressedAttributes=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SGeometryCompressedAttributes")],e.I3SGeometryCompressedAttributes),e.I3SGeometryBuffer=class extends r{constructor(){super(...arguments),this.offset=0}},t.__decorate([i.property({type:Number})],e.I3SGeometryBuffer.prototype,"offset",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"position",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"normal",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"uv0",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"color",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"uvRegion",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"featureId",void 0),t.__decorate([i.property({type:e.I3SGeometryAttribute})],e.I3SGeometryBuffer.prototype,"faceRange",void 0),t.__decorate([i.property({type:e.I3SGeometryCompressedAttributes})],e.I3SGeometryBuffer.prototype,"compressedAttributes",void 0),e.I3SGeometryBuffer=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SGeometryBuffer")],e.I3SGeometryBuffer),e.I3SGeometryDefinition=class extends r{},t.__decorate([a.enumeration({triangle:"triangle"})],e.I3SGeometryDefinition.prototype,"topology",void 0),t.__decorate([i.property()],e.I3SGeometryDefinition.prototype,"geometryBuffers",void 0),e.I3SGeometryDefinition=t.__decorate([l.subclass("esri.layers.support.I3SLayerDefinitions.I3SGeometryDefinition")],e.I3SGeometryDefinition),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/meshSpatialReferenceScaleUtils":function(){define(["exports","../../core/unitUtils","../../geometry/support/MeshTransform"],(function(e,t,r){"use strict";e.getMeshTransformForMetersToSpatialReference=function(e){const i=1/t.getMetersPerUnitForSR(e,1);return 1!==i?new r({scale:[i,i,i]}):void 0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/RangeInfo":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";e.RangeInfo=class extends r{constructor(){super(...arguments),this.name=null,this.field=null,this.currentRangeExtent=null,this.fullRangeExtent=null,this.type="rangeInfo"}},t.__decorate([i.property({type:String,json:{read:!0,write:{isRequired:!0}}})],e.RangeInfo.prototype,"name",void 0),t.__decorate([i.property({type:String,json:{read:!0,write:{isRequired:!0}}})],e.RangeInfo.prototype,"field",void 0),t.__decorate([i.property({type:[Number],json:{read:!0,write:!0}})],e.RangeInfo.prototype,"currentRangeExtent",void 0),t.__decorate([i.property({type:[Number],json:{read:!0,write:!0}})],e.RangeInfo.prototype,"fullRangeExtent",void 0),t.__decorate([i.property({type:["rangeInfo"],readOnly:!0,json:{read:!1,write:{isRequired:!0}}})],e.RangeInfo.prototype,"type",void 0),e.RangeInfo=t.__decorate([a.subclass("esri.layers.support.RangeInfo")],e.RangeInfo),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/SceneFilter":function(){define(["../../chunks/tslib.es6","../../request","../../core/JSONSupport","../../core/lang","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/reader","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/persistable","./PolygonCollection","../../chunks/persistableUrlUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";var p;let m=p=class extends r{constructor(e){super(e),this.spatialRelationship="disjoint",this.geometries=new d,this._geometriesSource=null}initialize(){this.addHandles(s.on((()=>this.geometries),"after-changes",(()=>this.geometries=this.geometries),s.sync))}readGeometries(e,t,r){Array.isArray(e)?this.geometries=d.fromJSON(e,r):this._geometriesSource={url:h.fromJSON(e,r),context:r}}async loadGeometries(e,r){if(null==this._geometriesSource)return;const{url:i,context:s}=this._geometriesSource,n=await t(i,{responseType:"json",signal:r?.signal}),o=e.toJSON(),a=n.data.map((e=>({...e,spatialReference:o})));this.geometries=d.fromJSON(a,s),this._geometriesSource=null}clone(){const e=new p({geometries:i.clone(this.geometries),spatialRelationship:this.spatialRelationship});return e._geometriesSource=this._geometriesSource,e}};return e.__decorate([n.property({type:["disjoint","contains"],nonNullable:!0,json:{write:{isRequired:!0}}})],m.prototype,"spatialRelationship",void 0),e.__decorate([n.property({type:d,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}}),u.persistable({origins:["web-scene","portal-item"],type:"resource",prefix:"geometries",contentAddressed:!0})],m.prototype,"geometries",void 0),e.__decorate([l.reader(["web-scene","portal-item"],"geometries")],m.prototype,"readGeometries",null),m=p=e.__decorate([c.subclass("esri.layers.support.SceneFilter")],m),m}))},"esri/layers/support/sceneLayerStatistics":function(){define(["exports","../../request","../../core/Error","../../core/urlUtils"],(function(e,t,r,i){"use strict";e.fetchStatistics=async function({fieldName:e,statisticsInfo:s,errorContext:n,fieldsIndex:o,path:a,customParameters:l,apiKey:c,signal:u}){if(null==s)throw new r(`${n}:no-cached-statistics`,"Cached statistics are not available for this layer");const d=o.get(e);if(null==d)throw new r(`${n}:field-unexisting`,`Field '${e}' does not exist on the layer`);const h=s.find((e=>e.name===d.name));if(null==h)throw new r(`${n}:no-cached-statistics`,"Cached statistics for this attribute are not available");const p=i.join(a,h.href),{data:m}=await t(p,{query:{f:"json",...l,token:c},responseType:"json",signal:u});return m},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/support/zipUtils":function(){define(["require","exports"],(function(e,t){"use strict";async function r(t){const{BlobReader:r,ZipReader:i,BlobWriter:s}=await new Promise(((t,r)=>e(["./zipjs-wrapper"],t,r))),n=[],o=new i(new r(t));return(await o.getEntries()).forEach((e=>{if(e.directory||/^__MACOS/i.test(e.filename))return;const t=new s,r=e.getData?.(t).then((t=>new File([t],e.filename)));r&&n.push(r)})),Promise.all(n)}t.extractZipFile=r,t.extractZipFiles=async function(e){const t=[];for(const i of e)i.name.toLowerCase().endsWith(".zip")?t.push(r(i)):t.push(Promise.resolve(i));return(await Promise.all(t)).flat()},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SUtil":function(){define(["exports","../../../../request","../../../../core/arrayUtils","../../../../core/Error","../../../../core/has","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projectionUtils","../../../../geometry/SpatialReference","../../../../geometry/projection/projectVectorToVector","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere","../../../../layers/support/featurePopupQueryUtils","../../../../rest/support/Query","./I3SBinaryReader","./I3SProjectionUtil","../support/edgeUtils","../support/symbolColorUtils","../../support/orientedBoundingBox","../../../support/layerViewUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S){"use strict";function w(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}const x=h.create();var T;function C(t,r){const i=r[0],s=r[1],n=r[3],o=t[0]-i,a=i-t[2],l=t[1]-s,c=s-t[3],u=Math.max(o,a,0),d=Math.max(l,c,0),h=u*u+d*d;return h>n*n?e.MbsIntersectResult.OUTSIDE:h>0?e.MbsIntersectResult.INTERSECTS_CENTER_OUTSIDE:-Math.max(o,a,l,c)>n?e.MbsIntersectResult.INSIDE:e.MbsIntersectResult.INTERSECTS_CENTER_INSIDE}function P(e,t,r){const i=[],s=r?.missingFields,n=r?.originalFields;let o=!1;for(const r of e){const e=t.get(r);e?(n?.push(r),i.push(e.name),r!==e.name&&(o=!0)):s?.push(r)}return r&&"hasMismatchedCasing"in r&&(r.hasMismatchedCasing=o),i}function M(e,t,r,i){if(null!=t&&"number"==typeof t)return e.featureIds.indexOf(t);if(null==i||null==r)return-1;const s=e.attributeInfo?.attributeData?.[r];return s?s.indexOf(i):-1}async function R(e,r,i,s,n,o,a,l){const c=[];for(const t of r)if(t&&n.includes(t.name)){const r=`${e}/nodes/${i}/attributes/${t.key}/0`;c.push({url:r,storageInfo:t})}const u=await Promise.allSettled(c.map((e=>t(e.url,{responseType:"array-buffer",query:{...a,token:o},signal:l?.signal}).then((t=>g.readBinaryAttribute(e.storageInfo,t.data)))))),d=[];for(const e of s){const t={};for(let r=0;r<u.length;r++){const i=u[r];if("fulfilled"===i.status){const s=i.value;t[c[r].storageInfo.name]=g.getCachedAttributeValue(s,e)}}d.push(t)}return d}function E(e){const t=e.store,r=t.indexCRS||t.geographicCRS,s=void 0===r?t.indexWKT:void 0;if(s){if(!e.spatialReference)throw new i("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(s!==e.spatialReference.wkt)throw new i("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const n=r?new u(w(r)):e.spatialReference;return n.equals(e.spatialReference)?e.spatialReference:n}function O(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,s=void 0===r?t.vertexWKT:void 0;if(s){if(!e.spatialReference)throw new i("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(s!==e.spatialReference.wkt)throw new i("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const n=r?new u(w(r)):e.spatialReference;return n.equals(e.spatialReference)?e.spatialReference:n}function A(e,t,r){if(!c.canProjectWithoutEngine(e,t))throw S.spatialReferenceIncompatibleError("scene layer",e?.wkid,t?.wkid);if("local"===r&&!I(e,t))throw S.spatialReferenceIncompatibleError("scene layer",e?.wkid,t?.wkid)}function I(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function D(e,t,r){const i=E(e),s=O(e);A(i,t,r),A(s,t,r)}function F(e){return"mesh-3d"===e.type}e.MbsIntersectResult=void 0,(T=e.MbsIntersectResult||(e.MbsIntersectResult={}))[T.OUTSIDE=0]="OUTSIDE",T[T.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",T[T.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",T[T.INSIDE=3]="INSIDE";const L=_.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});class N{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}const U=[l.create(),l.create(),l.create(),l.create(),l.create(),l.create(),l.create(),l.create()],V=h.create(),B=h.create(),G=new v.Obb,k=l.create(),z={data:new Array(72),size:3,exclusive:!0,stride:3},j=o.create();e.SymbolInfo=N,e.addWraparound=function(e,t){return(0|e)+(0|t)|0},e.checkPointCloudLayerCompatibleWithView=function(e,t){A(e.spatialReference,t.spatialReference,t.viewingMode)},e.checkPointCloudLayerValid=function(e){if(null==e.store?.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes?.position)throw new i("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t},e.checkRecyclable=function(e,t,r){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new i("layerview:recycle-failed","Could not recycle layerview")},e.checkSceneLayerCompatibleWithView=function(e,t){D(e,t.spatialReference,t.viewingMode)},e.checkSceneLayerValid=function(e){if(null==e.store?.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes?.position)throw new i("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t},e.checkSpatialReference=A,e.checkSpatialReferences=D,e.computeVisibilityObb=function(e,t,r,i,s,o,l){if(!o||0===o.length||null==t||!e.serviceMbsInIndexSR)return null;const c=y.computeGlobalTransformation(e.serviceMbsInIndexSR,s,"none",r,t);n.invert(j,c);let u=null,m=1/0,f=-1/0;if(o.forEach((n=>(n=>{if("replace"!==n.type)return;const o=n.geometry;if(!o?.hasZ)return;h.empty(V);const c=o.spatialReference||i,g=o.rings.reduce(((e,r)=>r.reduce(((e,r)=>(a.set(k,r[0],r[1],r[2]),d.projectVectorToVector(k,c,k,t),a.transformMat4(k,k,j),h.expandPointInPlace(V,k),Math.min(k[2],e))),e)),1/0);(()=>{if(!u)if(u=U,h.empty(B),null!=e.serviceObbInIndexSR){e.serviceObbInIndexSR.transform(G,r,t,s,l),G.getCorners(u);for(const e of u)a.transformMat4(e,e,j),h.expandPointInPlace(B,e)}else{const i=e.serviceMbsInIndexSR;if(!i)return;const n=i[3];d.projectVectorToVector(p.getCenter(i),r,k,t),a.transformMat4(k,k,j),k[2]+=s;for(let e=0;e<8;++e){const t=1&e?n:-n,r=2&e?n:-n,i=4&e?n:-n,s=u[e];a.copy(s,[k[0]+t,k[1]+r,k[2]+i]),h.expandPointInPlace(B,s)}}})(),h.intersects(B,V)&&(m=Math.min(m,g),f=Math.max(f,g))})(n))),m===1/0)return null;for(let e=0;e<8;++e)g=z.data,_=3*e,b=u[e],a.transformMat4(k,b,c),g[_]=k[0],g[_+1]=k[1],g[_+2]=k[2],_+=24,b[2]=m,a.transformMat4(k,b,c),g[_]=k[0],g[_+1]=k[1],g[_+2]=k[2],_+=24,b[2]=f,a.transformMat4(k,b,c),g[_]=k[0],g[_+1]=k[1],g[_+2]=k[2];var g,_,b;return v.compute(z)},e.containsDraco=function(e){if(s("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1},e.extractWkid=w,e.filterInPlace=function(e,t,r){let i=0,s=0;for(let n=0;n<t.length&&i<e.length;n++)e[i]===t[n]&&(r(n)&&(e[s]=e[i],s++),i++);e.length=s},e.findFieldsCaseInsensitive=P,e.findIntersectingNodes=function(t,r,i,s){i.traverse(r,(r=>{const i=r.serviceMbsInIndexSR;return(null!=i&&C(t,i))!==e.MbsIntersectResult.OUTSIDE&&(s(r),!0)}))},e.getClipRect=function(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return x[0]=(e[0]-t.position[0])/t.rotationScale[0],x[1]=(e[1]-t.position[1])/t.rotationScale[4],x[2]=(e[2]-t.position[0])/t.rotationScale[0],x[3]=(e[3]-t.position[1])/t.rotationScale[4],x},e.getIndexCrs=E,e.getSymbolInfo=function(e){const t=new N;let r=!1,i=!1;for(const s of e.symbolLayers.items)if("fill"===s.type&&s.enabled){const e=s.material,n=s.edges;if(null!=e&&!r){const i=e.color,n=b.parseColorMixMode(e.colorMixMode);t.material=null!=i?{color:[i.r/255,i.g/255,i.b/255],alpha:i.a,colorMixMode:n}:{color:[1,1,1],alpha:1,colorMixMode:b.ColorMixModeEnum.Multiply},t.castShadows=s.castShadows,r=!0}null==n||i||(t.edgeMaterial=_.createMaterialFromEdges(n,{}),i=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:b.ColorMixModeEnum.Multiply}),t},e.getVertexCrs=O,e.intersectBoundingRectWithMbs=C,e.invalidateMbs=function(e){null!=e&&(e[3]=-1)},e.isSupportedLocalModeProjection=I,e.isValidMbs=function(e){return e[3]>=0},e.objectIdFilter=function(e,t,i){let s=0,n=0;for(;s<i.length;)r.binaryIndexOf(e,i[s])>=0===t&&(i[n]=i[s],n++),s++;i.length=n},e.queryAttributesFromCachedAttributesId=R,e.rendererNeedsTextures=function(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.symbols;if(0===t.length)return!0;for(const e of t){if(!F(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||null==t.material?.color||"replace"!==t.material.colorMixMode)return!0}return!1},e.transparentEdgeMaterial=L,e.whenGraphicAttributes=async function(e,t,r,s,n,o){if(0===t.length)return[];const a=e.attributeStorageInfo;if(null!=e.associatedLayer)try{return await async function(e,t,r,i){const s=[],n={hasMismatchedCasing:!1,originalFields:s},o=P(r,e.fieldsIndex,n),a=new f({outFields:[...o]});if(await m.fetchFeaturePopupFeatures(e,t,a,{updateSourceAttributes:!0,...i}),!n.hasMismatchedCasing)return t;for(let e=0;e<t.length;e++){const r=t[e];if(r.attributes)for(let e=0;e<s.length;e++){const t=s[e],i=o[e];i in r.attributes&&(r.attributes[t]=r.attributes[i],delete r.attributes[i])}}return t}(e.associatedLayer,t,s,o)}catch(t){if(e.associatedLayer.loaded)throw t}if(a){const i=function({globalIdField:e},t,r,i){const s=new Map,n=[],o=i();for(const i of t){const t=i.attributes?.[r],a=null==t?i.getGlobalId():void 0;for(let r=0;r<o.length;r++){const l=o[r],c=M(l,t,e,a);if(c<0)continue;let u=s.get(l.node);u||(u={node:l.node,indices:[],graphics:[]},n.push(u),s.set(l.node,u)),u.indices.push(c),u.graphics.push(i);for(let e=r;e>0;e--)o[e]=o[e-1];o[0]=l;break}}return n}(e,t,r,n),l=e.parsedUrl.path;return await Promise.allSettled(i.map((t=>function(e,t,r,i,s,n,o,a){return R(e,t,r.resources.attributes,i,s,n,o,a)}(l,a,t.node,t.indices,s,e.apiKey,e.customParameters,o).then((e=>{for(let r=0;r<t.graphics.length;r++){const i=t.graphics[r],s=e[r];if(i.attributes)for(const e in i.attributes)e in s||(s[e]=i.attributes[e]);i.attributes=s}}))))),t}throw new i("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/featurePopupQueryUtils":function(){define(["exports","../../core/promiseUtils","../../core/sql","./fieldUtils","../../support/loadArcade"],(function(e,t,r,i,s){"use strict";async function n(e){if(e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type)))return s.loadArcade()}e.fetchFeaturePopupFeatures=async function(e,s,o,a){const l=new Array(s.length),c=new Map,u=new Map,d=i.unpackFieldNames(e.fieldsIndex,o.outFields),h=a?.hasRequiredFields??i.featureHasFields;for(let e=0;e<s.length;e++){const r=s[e];if(r.isAggregate){l[e]=r;continue}let i=!1;if(a?.getPopupTemplate){const e=r.origin?.layer??r.sourceLayer??r.layer,s=a.getPopupTemplate(e);if(null==s)continue;const o=await n(s);t.throwIfAborted(a),i=o&&o.arcadeUtils.hasGeometryOperations(s)}if(i||!h(r,d)){const t=r.getObjectId();if(null!=t){c.set(t,{graphic:r,index:e});continue}const i=r.getGlobalId();if(null!=i){u.set(i,{graphic:r,index:e});continue}}l[e]=r}if(!e.queryFeatures||0===c.size&&0===u.size)return l.filter(Boolean);const p=[],m=(e,t)=>{t&&(e.outFields??=[],e.outFields.includes(t)||e.outFields.push(t))};if(c.size>0){const t=o.clone();m(t,e.objectIdField),"uniqueIdFields"in e&&e.uniqueIdFields?.length&&(t.outFields??=[],t.outFields.push(...e.uniqueIdFields)),t.objectIds=Array.from(c.keys()),p.push({type:"object-id",query:t,map:c})}const f="globalIdField"in e?e.globalIdField:null;if(null!=f&&u.size>0){const e=o.clone();m(e,f);const t=Array.from(u.keys());e.where=r.sqlAnd(o.where,`${f} IN (${t.map((e=>`'${e}'`)).join(",")})`),p.push({type:"global-id",query:e,map:u})}const g=a?.updateSourceAttributes??!1;for(const{type:t,query:r,map:i}of p)try{const s=await e.queryFeatures(r,a);for(const e of s.features){const r="object-id"===t?e.getObjectId():e.getGlobalId();if(null==r)continue;const s=i.get(r);if(!s)continue;const{graphic:n,index:o}=s;if(g&&e.attributes){n.attributes??={};for(const t of d)t in e.attributes&&(n.attributes[t]=e.attributes[t])}const{geometry:a,origin:c}=n;e.geometry||=a,e.origin=c,l[o]=e}}catch{}return l.filter(Boolean)},e.loadFeaturePopupArcadeModules=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SBinaryReader":function(){define(["exports","../../../../core/Error","../../../../core/lang","../../../../core/Logger","../../../../core/typedArrayUtil","../../../../geometry/support/UCharArray","../../../../geometry/support/UShortArray","./LEPCC","../../webgl-engine/lib/VertexAttribute"],(function(e,t,r,i,s,n,o,a,l){"use strict";const c=()=>i.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function u(e,r,i){let s="",n=0;for(;n<i;){const o=e[r+n];if(o<128)s+=String.fromCharCode(o),n++;else if(o>=192&&o<224){if(n+1>=i)throw new t("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");const a=(31&o)<<6|63&e[r+n+1];s+=String.fromCharCode(a),n+=2}else if(o>=224&&o<240){if(n+2>=i)throw new t("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const a=(15&o)<<12|(63&e[r+n+1])<<6|63&e[r+n+2];s+=String.fromCharCode(a),n+=3}else{if(!(o>=240&&o<248))throw new t("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");{if(n+3>=i)throw new t("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const a=(7&o)<<18|(63&e[r+n+1])<<12|(63&e[r+n+2])<<6|63&e[r+n+3];if(a>=65536){const e=55296+(a-65536>>10),t=56320+(1023&a);s+=String.fromCharCode(e,t)}else s+=String.fromCharCode(a);n+=4}}}return s}function d(e,t){const r={byteOffset:0,byteCount:0,fields:Object.create(null)};let i=0;for(let s=0;s<t.length;s++){const n=t[s],o=n.valueType||n.type,a=T[o];r.fields[n.property]=a(e,i),i+=x[o].BYTES_PER_ELEMENT}return r.byteCount=i,r}function h(e,t,r){return p(e,t,r).map((e=>{const t=e?Date.parse(e):null;return null==t||Number.isNaN(t)?null:t}))}function p(e,r,i){const s=[];let n,o,a=0;for(o=0;o<e;o+=1){if(n=r[o],n>0){if(s.push(u(i,a,n-1)),0!==i[a+n-1])throw new t("string-array-error","Invalid string array: missing null termination.")}else s.push(null);a+=n}return s}function m(e,t){return new(0,x[t.valueType])(e,t.byteOffset,t.count*t.valuesPerElement)}function f(e,t){if(!e)return null;const r=e[t];return s.isInt16Array(e)?r===s.minInt16?null:r:s.isInt32Array(e)?r===s.minInt32?null:r:r!=r?null:r}function g(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function y(e,i,s){const n=null!=i.header?d(e,i.header):{byteOffset:0,byteCount:0,fields:{count:s}},o={header:n,byteOffset:n.byteCount,byteCount:0,entries:Object.create(null)};let a=n.byteCount;for(let e=0;e<i.ordering.length;e++){const s=i.ordering[e],l=r.clone(i[s]);if(l.count=n.fields.count??0,"String"===l.valueType){if(l.byteOffset=a,l.byteCount=n.fields[s+"ByteCount"],"UTF-8"!==l.encoding)throw new t("unsupported-encoding","Unsupported String encoding.",{encoding:l.encoding});if(l.timeEncoding&&"ECMA_ISO8601"!==l.timeEncoding)throw new t("unsupported-time-encoding","Unsupported time encoding.",{timeEncoding:l.timeEncoding})}else{if(!C(l.valueType))throw new t("unsupported-value-type","Unsupported binary valueType",{valueType:l.valueType});{const e=P(l.valueType);a+=a%e!==0?e-a%e:0,l.byteOffset=a,l.byteCount=e*l.valuesPerElement*l.count}}a+=l.byteCount??0,o.entries[s]=l}return o.byteCount=a-o.byteOffset,o}function _(e,r,i){if(r!==e&&c().error(`Invalid ${i} buffer size\n expected: ${e}, actual: ${r})`),r<e)throw new t("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:r})}function b(e){return{isDraco:!1,isLegacy:!1,color:null!=e.color,normal:null!=e.normal,uv0:null!=e.uv0,uvRegion:null!=e.uvRegion,featureIndex:null!=e.faceRange&&null!=e.featureId}}function v(e){const t={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const r of e.ordering)if(e.vertexAttributes[r])switch(r){case"position":break;case"normal":t.normal=!0;break;case"color":t.color=!0;break;case"uv0":t.uv0=!0;break;case"region":t.uvRegion=!0}return e.featureAttributes&&e.featureAttributeOrder&&(t.featureIndex=!0),t}function S(e){const t={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const r of e)switch(r){case"position":break;case"normal":t.normal=!0;break;case"uv0":t.uv0=!0;break;case"color":t.color=!0;break;case"uv-region":t.uvRegion=!0;break;case"feature-index":t.featureIndex=!0}return t}const w={position:l.VertexAttribute.POSITION,normal:l.VertexAttribute.NORMAL,color:l.VertexAttribute.COLOR,uv0:l.VertexAttribute.UV0,region:l.VertexAttribute.UVREGION},x={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},T={Float32:(e,t)=>new DataView(e,0).getFloat32(t,!0),Float64:(e,t)=>new DataView(e,0).getFloat64(t,!0),UInt8:(e,t)=>new DataView(e,0).getUint8(t),Int8:(e,t)=>new DataView(e,0).getInt8(t),UInt16:(e,t)=>new DataView(e,0).getUint16(t,!0),Int16:(e,t)=>new DataView(e,0).getInt16(t,!0),UInt32:(e,t)=>new DataView(e,0).getUint32(t,!0),Int32:(e,t)=>new DataView(e,0).getInt32(t,!0)};function C(e){return x.hasOwnProperty(e)}function P(e){return C(e)?x[e].BYTES_PER_ELEMENT:0}e.createAttributeDataIndex=y,e.createGeometryDescriptor=function(e,t){return e&&e.compressedAttributes&&"draco"===e.compressedAttributes.encoding?S(e.compressedAttributes.attributes):e?b(e):v(t)},e.createGeometryDescriptorForDraco=S,e.createGeometryDescriptorFromDefinition=b,e.createGeometryDescriptorFromSchema=v,e.createGeometryIndexFromSchema=function(e,t){const r=d(e,t&&t.header);let i=r.byteCount;const s={isDraco:!1,header:r,byteOffset:r.byteCount,byteCount:0,vertexAttributes:{}},n=r.fields,o=null!=n.vertexCount?n.vertexCount:n.count;for(const e of t.ordering){if(!t.vertexAttributes[e])continue;const r={...t.vertexAttributes[e],byteOffset:i,count:o},n=w[e]||"_"+e;s.vertexAttributes[n]=r,i+=P(r.valueType)*r.valuesPerElement*o}const a=n.faceCount;if(t.faces&&a){s.faces={};for(const e of t.ordering){if(!t.faces[e])continue;const r={...t.faces[e],byteOffset:i,count:a};s.faces[e]=r,i+=P(r.valueType)*r.valuesPerElement*a}}const l=n.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&l){s.featureAttributes={};for(const e of t.featureAttributeOrder){if(!t.featureAttributes[e])continue;const r={...t.featureAttributes[e],byteOffset:i,count:l};s.featureAttributes[e]=r,i+=("UInt64"===r.valueType?8:P(r.valueType))*r.valuesPerElement*l}}return _(i,e.byteLength,"geometry"),s.byteCount=i-s.byteOffset,s},e.createRawView=g,e.createTypedView=m,e.getBytesPerValue=P,e.getCachedAttributeValue=f,e.isValueType=C,e.readBinaryAttribute=function(e,r,i,l=!1){if("lepcc-rgb"===e.encoding)return l?a.decodeRGB(r):n.compactUCharArray(a.decodeRGB(r));if("lepcc-intensity"===e.encoding)return l?a.decodeIntensity(r):o.compactUShortArray(a.decodeIntensity(r));if(null!=e.encoding&&""!==e.encoding)throw new t("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(c().warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(c().warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");const u=y(r,e,i);_(u.byteOffset+u.byteCount,r.byteLength,"attribute");const d=u.entries.attributeValues||u.entries.objectIds;if(d){if("String"===d.valueType){const e=u.entries.attributeByteCounts,t=m(r,e),i=g(r,d);return d.timeEncoding?h(e.count,t,i):p(e.count,t,i)}return l?m(r,d):function(e,t){const r=m(e,t);if(r.length>=s.nativeArrayMaxSize)return r;const i=new Array;return r.forEach(((e,t)=>i.push(f(r,t)))),i}(r,d)}throw new t("bad-attribute-storage-info","Bad attributeStorageInfo specification.")},e.readDateStringArray=h,e.readHeader=d,e.readStringArray=p,e.valueType2ArrayBufferReader=T,e.valueType2TypedArrayClassMap=x,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/UCharArray":function(){define(["exports","../../core/typedArrayUtil"],(function(e,t){"use strict";e.compactUCharArray=function(e){return Array.isArray(e)?e.length<t.nativeArrayMaxSize?e:new Uint8Array(e):e.length<t.nativeArrayMaxSize?Array.from(e):e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/UShortArray":function(){define(["exports","../../core/typedArrayUtil"],(function(e,t){"use strict";e.compactUShortArray=function(e){return Array.isArray(e)?e.length<t.nativeArrayMaxSize?e:new Uint16Array(e):e.length<t.nativeArrayMaxSize?Array.from(e):e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/LEPCC":function(){define(["exports","../../../../core/Error"],(function(e,t){"use strict";const r=!0;function i(e,t,i){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,i+0,10)),version:t.getUint16(i+10,r),checksum:t.getUint32(i+12,r)}}function s(e,t,r){const i=[];t=n(e,t,i);const s=[];for(let o=0;o<i.length;o++){s.length=0,t=n(e,t,s);for(let e=0;e<s.length;e++)r.push(s[e]+i[o])}return t}function n(e,i,s){const n=new DataView(e,i),o=n.getUint8(0),a=31&o,l=!!(32&o),c=(192&o)>>6;let u=0;if(0===c)u=n.getUint32(1,r),i+=5;else if(1===c)u=n.getUint16(1,r),i+=3;else{if(2!==c)throw new t("lepcc-decode-error","Bad count type");u=n.getUint8(1),i+=2}if(l)throw new t("lepcc-decode-error","LUT not implemented");const d=Math.ceil(u*a/8),h=new Uint8Array(e,i,d);let p=0,m=0,f=0;const g=-1>>>32-a;for(let e=0;e<u;e++){for(;m<a;)p|=h[f]<<m,m+=8,f+=1;s[e]=p&g,p>>>=a,m-=a,m+a>32&&(p|=h[f-1]>>8-m)}return i+f}e.decodeIntensity=function(e){const s=new DataView(e,0);let o=0;const{identifier:a,version:l}=i(e,s,o);if(o+=16,"Intensity "!==a)throw new t("lepcc-decode-error","Bad identifier");if(l>1)throw new t("lepcc-decode-error","Unknown version");const c=function(e,t){return{sizeLo:e.getUint32(t+0,r),sizeHi:e.getUint32(t+4,r),count:e.getUint32(t+8,r),scaleFactor:e.getUint16(t+12,r),bitsPerPoint:e.getUint8(t+14),reserved:e.getUint8(t+15)}}(s,o);if(o+=16,c.sizeHi*2**32+c.sizeLo!==e.byteLength)throw new t("lepcc-decode-error","Bad size");const u=new Uint16Array(c.count);if(8===c.bitsPerPoint){if(c.count+o!==e.byteLength)throw new t("lepcc-decode-error","Bad size");const r=new Uint8Array(e,o,c.count);for(let e=0;e<c.count;e++)u[e]=r[e]*c.scaleFactor}else if(16===c.bitsPerPoint){if(2*c.count+o!==e.byteLength)throw new t("lepcc-decode-error","Bad size");const r=new Uint16Array(e,o,c.count);for(let e=0;e<c.count;e++)u[e]=r[e]*c.scaleFactor}else{const r=[];if(n(e,o,r)!==e.byteLength)throw new t("lepcc-decode-error","Bad size");for(let e=0;e<c.count;e++)u[e]=r[e]*c.scaleFactor}return u},e.decodeRGB=function(e){const s=new DataView(e,0);let n=0;const{identifier:o,version:a}=i(e,s,n);if(n+=16,"ClusterRGB"!==o)throw new t("lepcc-decode-error","Bad identifier");if(a>1)throw new t("lepcc-decode-error","Unknown version");const l=function(e,t){return{sizeLo:e.getUint32(t+0,r),sizeHi:e.getUint32(t+4,r),count:e.getUint32(t+8,r),colorMapCount:e.getUint16(t+12,r),lookupMethod:e.getUint8(t+14),compressionMethod:e.getUint8(t+15)}}(s,n);if(n+=16,l.sizeHi*2**32+l.sizeLo!==e.byteLength)throw new t("lepcc-decode-error","Bad size");if((2===l.lookupMethod||1===l.lookupMethod)&&0===l.compressionMethod){if(3*l.colorMapCount+l.count+n!==e.byteLength||l.colorMapCount>256)throw new t("lepcc-decode-error","Bad count");const r=new Uint8Array(e,n,3*l.colorMapCount),i=new Uint8Array(e,n+3*l.colorMapCount,l.count),s=new Uint8Array(3*l.count);for(let e=0;e<l.count;e++){const t=i[e];s[3*e]=r[3*t],s[3*e+1]=r[3*t+1],s[3*e+2]=r[3*t+2]}return s}if(0===l.lookupMethod&&0===l.compressionMethod){if(3*l.count+n!==e.byteLength||0!==l.colorMapCount)throw new t("lepcc-decode-error","Bad count");return new Uint8Array(e,n).slice()}if(l.lookupMethod<=2&&1===l.compressionMethod){if(n+3!==e.byteLength||1!==l.colorMapCount)throw new t("lepcc-decode-error","Bad count");const r=s.getUint8(n),i=s.getUint8(n+1),o=s.getUint8(n+2),a=new Uint8Array(3*l.count);for(let e=0;e<l.count;e++)a[3*e]=r,a[3*e+1]=i,a[3*e+2]=o;return a}throw new t("lepcc-decode-error","Bad method "+l.lookupMethod+","+l.compressionMethod)},e.decodeXYZ=function(e){const n=new DataView(e,0);let o=0;const{identifier:a,version:l}=i(e,n,o);if(o+=16,"LEPCC     "!==a)throw new t("lepcc-decode-error","Bad identifier");if(l>1)throw new t("lepcc-decode-error","Unknown version");const c=function(e,t){return{sizeLo:e.getUint32(t+0,r),sizeHi:e.getUint32(t+4,r),minX:e.getFloat64(t+8,r),minY:e.getFloat64(t+16,r),minZ:e.getFloat64(t+24,r),maxX:e.getFloat64(t+32,r),maxY:e.getFloat64(t+40,r),maxZ:e.getFloat64(t+48,r),errorX:e.getFloat64(t+56,r),errorY:e.getFloat64(t+64,r),errorZ:e.getFloat64(t+72,r),count:e.getUint32(t+80,r),reserved:e.getUint32(t+84,r)}}(n,o);if(o+=88,c.sizeHi*2**32+c.sizeLo!==e.byteLength)throw new t("lepcc-decode-error","Bad size");const u=new Float64Array(3*c.count),d=[],h=[],p=[],m=[];if(o=s(e,o,d),o=s(e,o,h),o=s(e,o,p),o=s(e,o,m),o!==e.byteLength)throw new t("lepcc-decode-error","Bad length");let f=0,g=0;for(let e=0;e<d.length;e++){g+=d[e];let t=0;for(let r=0;r<h[e];r++){t+=p[f];const e=m[f];u[3*f]=Math.min(c.maxX,c.minX+2*c.errorX*t),u[3*f+1]=Math.min(c.maxY,c.minY+2*c.errorY*g),u[3*f+2]=Math.min(c.maxZ,c.minZ+2*c.errorZ*e),f++}}return{errorX:c.errorX,errorY:c.errorY,errorZ:c.errorZ,result:u}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SProjectionUtil":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/ellipsoidUtils","../../../../geometry/projection/computeTranslationToOriginAndRotation"],(function(e,t,r,i,s){"use strict";function n(e,t,s){const n=r.create(),o=e[3],a=2**(4*Math.ceil(Math.log(o)*Math.LOG2E/4)+1);if(s.isGeographic){const t=a/i.getReferenceEllipsoid(s).radius*180/Math.PI,r=Math.round(e[1]/t),o=Math.max(-90,Math.min(90,r*t)),l=t/Math.cos((Math.abs(o)-t/2)/180*Math.PI),c=Math.round(e[0]/l)*l;n[0]=c,n[1]=o}else{const t=Math.round(e[0]/a),r=Math.round(e[1]/a);n[0]=t*a,n[1]=r*a}const l=e[2]+t,c=Math.round(l/a);return n[2]=c*a,n}e.computeGlobalTransformation=function(e,i,o,a,l){const c="east-north-up"===o?r.clone(e):n(e,i,a),u=t.create();return s.computeTranslationToOriginAndRotation(a,c,u,l),u},e.getLocalOrigin=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/layers/support/popupUtils":function(){define(["exports","../../../layers/support/fieldUtils"],(function(e,t){"use strict";function r(e,t){return e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&null!=e.defaultPopupTemplate?e.defaultPopupTemplate:null}e.getFetchPopupTemplate=r,e.getRequiredFields=async function(e,r=e.popupTemplate){if(null==r)return[];const i=await r.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:s}=r,{objectIdField:n,typeIdField:o,globalIdField:a,relationships:l}=e;if(i.includes("*"))return["*"];const c=s?t.getFeatureEditFields(e):[],u=t.fixFields(e.fieldsIndex,[...i,...c]);return o&&u.push(o),u&&n&&e.fieldsIndex?.has(n)&&!u.includes(n)&&u.push(n),u&&a&&e.fieldsIndex?.has(a)&&!u.includes(a)&&u.push(a),l&&l.forEach((t=>{const{keyField:r}=t;u&&r&&e.fieldsIndex?.has(r)&&!u.includes(r)&&u.push(r)})),u},e.hasPopupTemplate=function(e,t){return null!=r(e,{defaultPopupTemplateEnabled:t})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/ElevationLayerView3D":function(){define(["require","../../../chunks/tslib.es6","../../../core/Error","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/support/ElevationTileData","../../../layers/support/LercDecoder","./ElevationLayerView3DModifications","./LayerView3D","./TiledLayerView3D","../terrain/TerrainConst","../terrain/terrainUtils","../../layers/LayerView"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";let _=class extends(m.TiledLayerView3D(p.LayerView3D(y))){constructor(){super(...arguments),this.type="elevation-3d",this.modifications=new h.ElevationLayerView3DModifications}get tileInfo(){return this.layer.tileInfo}initialize(){const e=this.view,t=e.map?.allLayers,i=t&&t.includes(this.layer),s=e.map?.ground?.layers,n=s&&s.includes(this.layer);if(i&&!n){const e=new r("layerview:elevation-layer-only",`3D elevation layer '${this.layer.id}' can only be added to layers in map.ground`);this.addResolvingPromise(Promise.reject(e))}this._lercDecoder=d.acquireDecoder(e.resourceController),this._addTilingSchemeMatchPromise()}destroy(){this._lercDecoder=s.releaseMaybe(this._lercDecoder)}async fetchElevationTile(e,t){const r=await this._fetchTileData(e.lij,t);if(!n.isAborted(t))return r&&await this.modifications.apply(r,e,t.signal),r}async _fetchTileData(e,t){const r=this.layer;if(g.useFetchTileForLayer(r)){const s=await r.fetchTile(e[0],e[1],e[2],{noDataValue:f.elevationNoDataValue,signal:t.signal});return n.isAborted(t)?void i.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."):s}const s=this.getTileUrl(e),o=await t.requester.request(s,"binary",t),a=await this._lercDecoder.decode(o,{noDataValue:f.elevationNoDataValue},t.signal);if(a)return new u.ElevationTileData(a);throw new Error("LERC decoding failed")}async setModifications(t){if(this.modifications.modifications.length=0,!t||0===t.length)return;this._simplifyOperatorPromise??=new Promise(((t,r)=>e(["../../../geometry/operators/simplifyOperator"],t,r)));const r=await this._simplifyOperatorPromise;for(const e of t){const t=e.geometry;if("polygon"===t?.type){const s=r.execute(t);if("polygon"===s?.type){const t=new h.ElevationLayerView3DModification(e.type,s);this.modifications.modifications.push(t)}else i.getLogger(this).warn("Failed to simplify modification polygon")}else i.getLogger(this).warn("Invalid modification added to elevation layer: "+(t?`non polygon geometry ${t.type}`:"no geometry"))}}};return t.__decorate([o.property()],_.prototype,"layer",void 0),t.__decorate([o.property()],_.prototype,"tileInfo",null),t.__decorate([o.property()],_.prototype,"modifications",void 0),_=t.__decorate([c.subclass("esri.views.3d.layers.ElevationLayerView3D")],_),_}))},"esri/layers/support/ElevationTileData":function(){define(["exports"],(function(e){"use strict";e.ElevationTileData=class{constructor(e,t,r,i){this._hasNoDataValues=null,this._minValue=null,this._maxValue=null,"pixelData"in e?(this.values=e.pixelData,this.width=e.width,this.height=e.height,this.noDataValue=e.noDataValue):(this.values=e,this.width=t,this.height=r,this.noDataValue=i)}get hasNoDataValues(){if(null==this._hasNoDataValues){const e=this.noDataValue;this._hasNoDataValues=this.values.includes(e)}return this._hasNoDataValues}get minValue(){return this._ensureBounds(),this._minValue}get maxValue(){return this._ensureBounds(),this._maxValue}get cachedMemory(){return this.values.byteLength+256}_ensureBounds(){if(null!=this._minValue)return;const{noDataValue:e,values:t}=this;let r=1/0,i=-1/0,s=!0;for(const n of t)n===e?this._hasNoDataValues=!0:(r=n<r?n:r,i=n>i?n:i,s=!1);s?(this._minValue=0,this._maxValue=0):(this._minValue=r,this._maxValue=i>-3e38?i:0)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/LercDecoder":function(){define(["exports","../../core/workers/WorkerHandle"],(function(e,t){"use strict";class r extends t.WorkerHandle{constructor(e=null){super("LercWorker","_decode",{_decode:e=>[e.buffer]},e,{strategy:"dedicated"}),this.schedule=e,this.ref=0}decode(e,t,r){return e&&0!==e.byteLength?this.invoke({buffer:e,options:t},r):Promise.resolve(null)}release(){--this.ref<=0&&(i.forEach(((e,t)=>{e===this&&i.delete(t)})),this.destroy())}}const i=new Map;e.acquireDecoder=function(e=null){let t=i.get(e);return t||(null!=e?(t=new r((t=>e.immediate.schedule(t))),i.set(e,t)):(t=new r,i.set(null,t))),++t.ref,t},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/ElevationLayerView3DModifications":function(){define(["require","exports","../../../core/promiseUtils","../../../geometry/Extent","../../../geometry/support/aaBoundingRect"],(function(e,t,r,i,s){"use strict";let n,o;t.ElevationLayerView3DModification=class{constructor(e,t){this.type=e,this.polygon=t}apply(e,t){if("replace"!==this.type)return;const{polygon:r}=this,[n,a,l]=o,{extent:c,spatialReference:u}=t,d=s.toExtent(c,u);if(a.accelerateGeometry(r),!a.execute(r,d))return;n.accelerateGeometry(r),l.accelerateGeometry(r);const{width:h,height:p,values:m}=e,f=r.hasZ?r.rings.reduce(((e,t)=>t.reduce(((e,t)=>Math.min(e,t[2]??1/0)),e)),1/0):1/0,g=f===1/0?0:f;if(n.execute(r,d))m.fill(g);else{const e=function(e,t,r){const[s,n,a,l]=e.extent,{spatialReference:c}=e,[u,d]=r,h=(a-s)/(u-1),p=(l-n)/(d-1),m=new i({xmin:s-2*h,ymin:n-2*p,xmax:a+2*h,ymax:l+2*p,spatialReference:c}),f=o[2].execute(t,m);return"polygon"===f?.type?f:null}(t,r,[h,p]);if(!e)return;if(e.rings.every((e=>0===e.length)))return;const s=function(e,t,r,i){const s=new OffscreenCanvas(r+2,i+2).getContext("2d",{willReadFrequently:!0});if(!s)throw new Error("failed to create canvas");const[n,o,a,l]=e.extent,c=a-n,u=l-o;s.fillStyle="black",s.clearRect(0,0,r,i);const d=new Path2D;for(const e of t.rings)if(e.length>0){const t=new Path2D;let s=!0;for(const[o,a]of e){const e=(o-n)/c*(r-1)+1+.5,d=(l-a)/u*(i-1)+1+.5;s?(s=!1,t.moveTo(e,d)):t.lineTo(e,d)}t.closePath(),d.addPath(t)}s.fillStyle="white",s.fill(d,"evenodd");const h=s.getImageData(0,0,r+2,i+2),p=(r+2)*(i+2),m=new Uint8Array(p);for(let e=0;e<p;++e)m[e]=h.data[4*e+0]>0?1:0;return m}(t,e,h,p);for(let e=p-1;e>=0;--e)for(let t=0;t<h;++t){const r=(e+1)*(h+2)+(t+1);let i=0;for(let e=-1;e<=1;++e){const t=r+e*(h+2);for(let e=-1;e<=1;++e)i=Math.max(i,s[t+e])}const n=e*h+t;m[n]=0===i?m[n]:g}}}},t.ElevationLayerView3DModifications=class{constructor(){this.modifications=[]}async apply(t,i,s){if(0!==this.modifications.length&&(n??=Promise.all([new Promise(((t,r)=>e(["../../../geometry/operators/containsOperator"],t,r))),new Promise(((t,r)=>e(["../../../geometry/operators/intersectsOperator"],t,r))),new Promise(((t,r)=>e(["../../../geometry/operators/intersectionOperator"],t,r)))]),o=await n,!r.isAborted(s)))for(const e of this.modifications)e.apply(t,i)}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/LayerView3D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/handleUtils","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/support/heightModelInfoUtils"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.LayerView3D=e=>{let o=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),u.supportsHeightModelInfo(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles(r.makeHandle((()=>e.abort()))),await s.whenOnce((()=>this.view.defaultsFromMap?.heightModelInfoReady),t),i.throwIfAborted(t);const n=u.rejectLayerError(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(n)throw n}};return t.__decorate([n.property()],o.prototype,"view",void 0),t.__decorate([n.property()],o.prototype,"slicePlaneEnabled",void 0),o=t.__decorate([c.subclass("esri.views.3d.layers.LayerView3D")],o),o},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/TiledLayerView3D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Error","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","./support/LayerViewPerformanceInfo","../support/updatingProperties","../terrain/terrainUtils","../../support/layerViewUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.TiledLayerView3D=e=>{let n=class extends e{constructor(){super(...arguments),this.hasMixedImageFormats=!0}get imageFormatIsOpaque(){return!1}get fullExtent(){return this.layer.fullExtent}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get visibleAtCurrentScale(){if(!h.isScaleRangeActive(this.layer.minScale,this.layer.maxScale)||!this.view.scale)return!0;const e=Math.round(this.view.basemapTerrain.tilingScheme.levelAtScale(this.view.scale));return e>=this.displayLevelRange.minLevel&&e<=this.displayLevelRange.maxLevel}get dataScaleRange(){const e=this.tileInfo.lods;let t=e[0].scale,r=e[e.length-1].scale;if("tilemapCache"in this.layer&&this.layer.tilemapCache){const{effectiveMinLOD:e,effectiveMaxLOD:i}=this.layer.tilemapCache;t=this.tileInfo.lodAt(e).scale,r=this.tileInfo.lodAt(i).scale}return{minScale:t,maxScale:r}}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready&&h.validateScaleRange(e)&&this.visibleAtCurrentTimeExtent||!1}get dataLevelRange(){const{minScale:e,maxScale:t}=this.dataScaleRange;return this.levelRangeFromScaleRange(e,t)}get displayLevelRange(){const e=this.layer.minScale||this.dataScaleRange.minScale,t=this.layer.maxScale||this.dataScaleRange.maxScale,r=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale&&r.maxLevel++,r}get performanceInfo(){return new c.LayerViewPerformanceInfo(this.view.basemapTerrain.getUsedMemoryForLayerView(this))}getTileUrl(e){return this.layer.getTileUrl(e[0],e[1],e[2])}_addTilingSchemeMatchPromise(){if(null==this.fullExtent)return this.addResolvingPromise(Promise.reject(new r("tilingscheme:extent-not-defined","This layer doesn't define a fullExtent.")));const e=this._getTileInfoSupportError(this.tileInfo,this.fullExtent);if(e)return this.addResolvingPromise(Promise.reject(e));this.addResolvingPromise(i.whenOnce((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const e=this.view.basemapTerrain.tilingScheme,t="tilemapCache"in this.layer?this.layer.tilemapCache?.effectiveMaxLOD:void 0,r=this._getTileInfoCompatibilityError(this.tileInfo,e,t);if(r)throw r})))}_getTileInfoSupportError(e,t){const i=d.checkIfTileInfoSupportedForView(e,t,this.view.spatialReference,this.view.state.viewingMode,"tilemapCache"in this.layer?this.layer.tilemapCache?.effectiveMaxLOD:void 0);if(!i)return;const s={layer:this.layer,error:i};switch(i.name){case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":case"tilingscheme:local-unsupported-spatial-reference":return new r("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",s);default:return new r("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",s)}}_getTileInfoCompatibilityError(e,t,i){return null!=e&&t.compatibleWith(e,i)?null:new r("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(e,t){const r={minLevel:0,maxLevel:1/0},i=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!i)return r;const s=i.levels[0],n=e=>{const t=Math.log(s.scale/e)/Math.LN2;return.5-Math.abs(.5-t%1)<1e-9?Math.round(t):Math.ceil(t)};return null!=e&&e>0&&(r.minLevel=Math.max(0,n(e))),null!=t&&t>0&&(r.maxLevel=Math.max(0,n(t))),r}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return t.__decorate([s.property({readOnly:!0})],n.prototype,"imageFormatIsOpaque",null),t.__decorate([s.property({readOnly:!0})],n.prototype,"updating",void 0),t.__decorate([s.property(u.updatingProgress)],n.prototype,"updatingProgress",void 0),t.__decorate([s.property(u.updatingProgressValue)],n.prototype,"updatingProgressValue",void 0),t.__decorate([s.property()],n.prototype,"hasMixedImageFormats",void 0),t.__decorate([s.property()],n.prototype,"fullExtent",null),t.__decorate([s.property({readOnly:!0})],n.prototype,"isOpaque",null),t.__decorate([s.property({readOnly:!0})],n.prototype,"visibleAtCurrentScale",null),t.__decorate([s.property()],n.prototype,"dataScaleRange",null),t.__decorate([s.property({readOnly:!0})],n.prototype,"dataLevelRange",null),t.__decorate([s.property({readOnly:!0})],n.prototype,"displayLevelRange",null),t.__decorate([s.property()],n.prototype,"layer",void 0),n=t.__decorate([l.subclass("esri.views.3d.layers.TiledLayerView3D")],n),n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/FeatureLayerView3D":function(){define(["../../../chunks/tslib.es6","../../../core/Error","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/projectionUtils","../../../layers/support/layerUtils","./FeatureLayerViewBase3D"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";let u=class extends c{constructor(){super(...arguments),this.type="feature-3d"}initialize(){const{layer:e,view:r}=this;l.getEffectiveLayerCapabilities(e)?.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new t("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e}))),null!=e.infoFor3D&&this.addResolvingPromise(Promise.reject(new t("featurelayerview3d:unsupported-geometry-type",`Unsupported geometry type ${e.geometryType}`))),"mesh"!==e.geometryType||a.canProjectWithoutEngine(e.spatialReference,r.spatialReference)||this.addResolvingPromise(Promise.reject(new t("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}get featureSpatialReference(){return this.view.featureTiles?.tilingScheme?.spatialReference}};return e.__decorate([r.property()],u.prototype,"layer",void 0),u=e.__decorate([o.subclass("esri.views.3d.layers.FeatureLayerView3D")],u),u}))},"esri/views/3d/layers/FeatureLayerViewBase3D":function(){define(["require","exports","../../../chunks/tslib.es6","../../../core/Error","../../../core/has","../../../core/maybe","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/dehydratedFeatures","./FeatureLikeLayerView3D","./LayerView3D","./graphics/FeatureGraphics3DGraphicsPipeline","../support/updatingProperties","../webgl-engine/lib/UpdatePolicy","../../layers/FeatureLayerView","../../layers/LayerView","../../layers/RefreshableLayerView"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";return t.default=class extends(b(h.FeatureLikeLayerView3D(y(p.LayerView3D(_))))){constructor(e){super(e)}initialize(){this.addHandles(o.watch((()=>this._updatingRequiredPromise),(e=>this._updatingHandles.addPromise(e)),o.syncAndInitial))}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=n.destroyMaybe(this._fetcherContext)}get maximumNumberOfFeatures(){return this.graphicsPipeline.maximumNumberOfFeatures}set maximumNumberOfFeatures(e){this.graphicsPipeline.maximumNumberOfFeatures=e}get maximumNumberOfFeaturesExceeded(){return null!=this.graphicsPipeline&&!this.suspended&&this.graphicsPipeline.maximumNumberOfFeaturesExceeded}get updatingProgressValue(){return this.graphicsPipeline?.updatingProgressValue??0}get updatePolicy(){return this.graphicsPipeline?.updatePolicy??g.UpdatePolicy.ASYNC}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM}setVisibility(e,t){this.graphicsPipeline?.setVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const r=()=>super.queryFeatures(e,t);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),r):r()}async createGraphicsPipeline(){if(s("feature-pipeline-3d-test")){const{Feature3DPipeline:t}=await new Promise(((t,r)=>e(["./graphics/pipeline/Feature3DPipeline"],t,r)));return new t({layerView:this})}return new m.FeatureGraphics3DGraphicsPipeline({layerView:this})}async doRefresh(e){return await this.graphicsPipeline.doRefresh(e)}_popupFeatureHasRequiredFields(e,t){if(!super._popupFeatureHasRequiredFields(e,t))return!1;const r=d.getObjectId(e,this.layer.objectIdField);if(null==r)return!0;const i=this.graphicsPipeline.getMissingAttributesForFeature(r);if(null==i)return!0;for(const e of t)if(i.has(e))return!1;return!0}get usedMemory(){return this.graphicsPipeline?.usedMemory??0}get unloadedMemory(){return this.graphicsPipeline?.unloadedMemory??0}get ignoresMemoryFactor(){return this.graphicsPipeline?.ignoresMemoryFactor??!1}async _queryFeaturesMesh(e,t){await this._validateQueryFeaturesMesh(e);const r=await t(),i=this.graphicsPipeline;if(e?.outStatistics||null==i)return r;const s=this.layer.objectIdField,n=[];for(const e of r.features)if(e.geometry){const t=i.getHydratedGeometry(e.attributes[s]);t&&(e.geometry=t,n.push(e))}else n.push(e);return r.features=n,r}async _validateQueryFeaturesMesh(e){if(!e)return;const t=e=>{throw new i("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${e}'`)},r=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const i of r)null!=e[i]&&t(i);"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),null==e.outSpatialReference||e.outSpatialReference.equals(this.view.spatialReference)||t("outSpatialReference")}get test(){}},r.__decorate([a.property()],t.default.prototype,"layer",void 0),r.__decorate([a.property()],t.default.prototype,"graphicsPipeline",void 0),r.__decorate([a.property()],t.default.prototype,"maximumNumberOfFeatures",null),r.__decorate([a.property()],t.default.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([a.property(f.updatingProgress)],t.default.prototype,"updatingProgress",void 0),r.__decorate([a.property({readOnly:!0})],t.default.prototype,"updatingProgressValue",null),r.__decorate([a.property({readOnly:!0})],t.default.prototype,"updatePolicy",null),r.__decorate([a.property({readOnly:!0})],t.default.prototype,"hasZ",null),r.__decorate([a.property({readOnly:!0})],t.default.prototype,"hasM",null),t.default=r.__decorate([u.subclass("esri.views.3d.layers.FeatureLayerViewBase3D")],t.default),t.default}))},"esri/views/3d/layers/FeatureLikeLayerView3D":function(){define(["exports","../../../chunks/tslib.es6","../../../Graphic","../../../core/Error","../../../core/has","../../../core/maybe","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../layers/graphics/hydratedFeatures","../../../layers/support/timeSupport","../../../rest/support/Query","../webgl-engine/lib/UpdatePolicy","../../support/HighlightDefaults","../../support/layerViewUtils","../../support/projectionUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g){"use strict";e.FeatureLikeLayerView3D=e=>{let a=class extends e{constructor(){super(...arguments),this.highlightOptions=null,this.updatePolicy=p.UpdatePolicy.SYNC,this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.supportsHeightUnitConversion=!0}initialize(){const e=this.layer;"isTable"in e&&e.isTable?this.addResolvingPromise(Promise.reject(new i("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e}))):(this.addResolvingPromise(this._validateGeometryType()),this.addResolvingPromise((async()=>{if(this.destroyed)return;this.fullExtentInLocalViewSpatialReference="local"===this.view.viewingMode?await g.projectWithZConversionSilent(this.layer.fullExtent,this.view.spatialReference):null;const e=await this.createGraphicsPipeline();this.destroyed?e.destroy():(this.graphicsPipeline=e,await e.when())})()),this.notifyChange("updating"))}destroy(){this.graphicsPipeline=n.destroyMaybe(this.graphicsPipeline)}get dataUpdating(){return!!this.graphicsPipeline?.dataUpdating}get legendEnabled(){return this.canResume()&&this.graphicsPipeline?.legendEnabled}get visibleAtCurrentScale(){return f.hasLayerBasedScaleVisibility()?f.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale):!this.graphicsPipeline?.scaleVisibilitySuspended}get symbologySnappingSupported(){return this.graphicsPipeline.symbologySnappingSupported}get hasAllFeatures(){return this.graphicsPipeline.hasAllFeatures}get hasAllFeaturesInView(){return this.graphicsPipeline.hasAllFeaturesInView}get hasFullGeometries(){return this.graphicsPipeline.hasFullGeometries}get timeExtent(){return d.combineTimeExtent(this.layer,this.view?.timeExtent,this._get("timeExtent"))}getHit(e){if(s("feature-pipeline-3d-test"))return this._getHitMock(e);const t=this.graphicsPipeline.findGraphic((t=>t.uid===e));if(null==t)return null;const r=u.hydrateGraphic(t,this.layer);return{type:"graphic",graphic:r,layer:r.layer}}_getHitMock(e){const t=this.layer,i={};i[this.layer.objectIdField]=e;const s=new r({layer:t,sourceLayer:t,visible:!0,symbol:null,attributes:i,geometry:null});return{type:"graphic",graphic:s,layer:s.layer}}whenGraphicBounds(e,t){return this.graphicsPipeline?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsPipeline?.computeAttachmentOrigin(e,t)}async elevationAlignPointsInFeatures(e,t){return this.graphicsPipeline.elevationAlignPointsInFeatures(e,t)}async queryForSymbologySnapping(e,t){return this.graphicsPipeline.graphicsQuery.queryForSymbologySnapping(e,t)}queryFeatures(e,t){return this.graphicsPipeline.graphicsQuery.executeQuery(this._ensureQuery(e),t?.signal)}queryObjectIds(e,t){return this.graphicsPipeline.graphicsQuery.executeQueryForIds(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this.graphicsPipeline.graphicsQuery.executeQueryForCount(this._ensureQuery(e),t?.signal)}queryExtent(e,t){return this.graphicsPipeline.graphicsQuery.executeQueryForExtent(this._ensureQuery(e),t?.signal)}_ensureQuery(e){return null==e?this.createQuery():h.from(e)}highlight(e,t){return this.graphicsPipeline.highlight(e,t?.name??m.defaultHighlightName)}maskOccludee(e){return this.graphicsPipeline.maskOccludee(e)}getSuspendInfo(){return{...super.getSuspendInfo(),...this.graphicsPipeline.suspendInfo}}isUpdating(){return!(!this.graphicsPipeline||this.graphicsPipeline.destroyed||!this.graphicsPipeline?.updating&&this.view?.basemapTerrain?.ready)}async _validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new i("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}}get performanceInfo(){return this.graphicsPipeline.performanceInfo}queryAttributeBins(){throw new Error("Not implemented")}queryAggregates(){throw new Error("Not implemented")}};return t.__decorate([o.property()],a.prototype,"graphicsPipeline",void 0),t.__decorate([o.property({readOnly:!0})],a.prototype,"dataUpdating",null),t.__decorate([o.property()],a.prototype,"highlightOptions",void 0),t.__decorate([o.property()],a.prototype,"suspended",void 0),t.__decorate([o.property({readOnly:!0})],a.prototype,"legendEnabled",null),t.__decorate([o.property({readOnly:!0})],a.prototype,"visibleAtCurrentScale",null),t.__decorate([o.property()],a.prototype,"updating",void 0),t.__decorate([o.property({readOnly:!0})],a.prototype,"updatePolicy",void 0),t.__decorate([o.property({type:Boolean})],a.prototype,"slicePlaneEnabled",void 0),t.__decorate([o.property({readOnly:!0})],a.prototype,"suspendInfo",void 0),t.__decorate([o.property()],a.prototype,"symbologySnappingSupported",null),t.__decorate([o.property({readOnly:!0})],a.prototype,"hasAllFeatures",null),t.__decorate([o.property({readOnly:!0})],a.prototype,"hasAllFeaturesInView",null),t.__decorate([o.property({readOnly:!0})],a.prototype,"hasFullGeometries",null),t.__decorate([o.property({readOnly:!0})],a.prototype,"timeExtent",null),a=t.__decorate([c.subclass("esri.views.3d.layers.FeatureLikeLayerView3D")],a),a},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/timeSupport":function(){define(["exports","../../support/timeUtils"],(function(e,t){"use strict";e.combineTimeExtent=function(e,r,i){if(null==e?.timeInfo)return null;const{datesInUnknownTimezone:s=!1,timeOffset:n,useViewTime:o}=e;let a=e.timeExtent;s&&(a=t.toLocalTimeExtent(a));let l=o?r&&a?r.intersection(a):r||a:a;return!l||l.isEmpty||l.isAllTime?l:(n&&(l=l.offset(-n.value,n.unit)),s&&(l=t.toUTCTimeExtent(l)),l.equals(i)?i:l)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/support/timeUtils":function(){define(["exports","../core/arrayUtils","../core/lang","../core/timeUtils","../chunks/TimeExtent","../webmap/utils","../webscene/utils"],(function(e,t,r,i,s,n,o){"use strict";function a(e){return void 0!==e.timeInfo}async function l(e,r){if(0===e.length)return s.TimeExtent.allTime;await Promise.all(e.map((e=>e.load({signal:r}))));const i=e.filter(a),n=e.filter((e=>!a(e)&&null!=e.visibilityTimeExtent));if(0===i.length&&0===n.length)return s.TimeExtent.allTime;const o=[],l=[];for(const e of i)"feature"!==e?.type&&"map-image"!==e?.type||!e.timeInfo?.hasLiveData?l.push(e):o.push(e);const c=e=>null==e||e.isAllTime,u=[...l.map((e=>{const t=e.timeInfo?.fullTimeExtent,{visibilityTimeExtent:r}=e;return t?.intersection(r)??r})),...n.map((e=>e.visibilityTimeExtent))];if(u.some(c))return s.TimeExtent.allTime;const d=o.map((async e=>{const t=(await e.fetchRecomputedExtents({signal:r}))?.timeExtent??e.timeInfo?.fullTimeExtent,{visibilityTimeExtent:i}=e;return t?.intersection(i)??i})),h=(await Promise.allSettled(d)).map((e=>"fulfilled"===e.status?e.value:null));if(h.some(c))return s.TimeExtent.allTime;const p=[...h,...u].filter(t.isSome);return 0===p.length?s.TimeExtent.allTime:p.reduce(((e,t)=>e.union(t)))}e.getTimeExtentFromLayers=l,e.getTimeSliderSettingsFromWebDocument=async function(e,t){if(!n.isWebMap(e)&&!o.isWebScene(e))return null;await e.load({signal:t});const i=e?.widgets?.timeSlider;if(!i)return null;const a=await async function(e,t){return e.widgets?.timeSlider?.fullTimeExtent??l(e.allLayers,t)}(e,t),c=i.loop,u=function(e){const t=e.numThumbs??2,r=e.currentTimeExtent;if(r){const{start:e,end:i}=r;return null!=e&&null!=i&&e.getTime()===i.getTime()?"instant":2===t?"time-window":null==e||0===e.getTime()?"cumulative-from-start":"cumulative-from-end"}return 2===t?"time-window":"cumulative-from-start"}(i),d=i.stopDelay??2e3,h=function(e){const{numStops:t,stopInterval:i,stops:s}=e;return s?{dates:r.clone(s)}:i?{interval:i.clone()}:{count:t??5}}(i),p=function(e,t){const r=e.currentTimeExtent;if(!r)return null;const{start:i,end:n}=r,o=i??n??null;switch(t){case"time-window":return new s.TimeExtent({start:i,end:n});case"cumulative-from-start":return new s.TimeExtent({start:null,end:o});case"cumulative-from-end":return new s.TimeExtent({start:o,end:null});case"instant":return new s.TimeExtent({start:o,end:o})}}(i,u);return{fullTimeExtent:a,loop:c,mode:u,playRate:d,stops:h,timeExtent:p}},e.toLocalTimeExtent=function(e){if(!e)return e;const{start:t,end:r}=e;return new s.TimeExtent({start:null!=t?i.offsetDate(t,t.getTimezoneOffset(),"minutes"):t,end:null!=r?i.offsetDate(r,r.getTimezoneOffset(),"minutes"):r})},e.toUTCTimeExtent=function(e){if(!e)return e;const{start:t,end:r}=e;return new s.TimeExtent({start:null!=t?i.offsetDate(t,-t.getTimezoneOffset(),"minutes"):t,end:null!=r?i.offsetDate(r,-r.getTimezoneOffset(),"minutes"):r})},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/webmap/utils":function(){define(["exports","./Version"],(function(e,t){"use strict";const r=new t.Version(2,34);e.currentVersion=r,e.isWebMap=function(e){return null!=e&&"object"==typeof e&&"declaredClass"in e&&"esri.WebMap"===e.declaredClass},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/webmap/Version":function(){define(["exports","../core/Version"],(function(e,t){"use strict";class r extends t.Version{constructor(e,t){super(e,t,"webmap")}}e.Version=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/webscene/utils":function(){define(["exports","../support/tagSymbols"],(function(e,t){"use strict";e.isWebScene=function(e){return null!=e&&"object"==typeof e&&t.WebSceneTag in e},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/FeatureGraphics3DGraphicsPipeline":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/hydratedFeatures","../../../../layers/graphics/controllers/FeatureTileController3D","../FeatureLayerViewPerformanceInfo","./Graphics3DGraphicsPipeline","../support/FeatureTileFetcher3DContext","../../support/EventedSet","../../webgl-engine/lib/UpdatePolicy"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";e.FeatureGraphics3DGraphicsPipeline=class extends h.Graphics3DGraphicsPipeline{constructor(e){super(e),this._controllerTotal=0,this._processorTotal=0,this._needsRefresh=!1,this.suspendResumeExtentMode="data"}initialize(){this.addHandles(i.watch((()=>({controller:this.controller,suspended:this.suspended})),(({controller:e,suspended:t})=>{e&&!t&&this._needsRefresh&&(e.refetch(),this._needsRefresh=!1)})))}destroy(){this._fetcherContext=r.destroyMaybe(this._fetcherContext)}get maximumNumberOfFeatures(){return this.controller?.maximumNumberOfFeatures??this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){let e=0;if(this.controller?.updating){const t=this.controller.updatingRemaining,r=Math.max(this.controller.updatingTotal,this._controllerTotal);r>0&&(e=(r-t)/r,this._controllerTotal=r)}let t=0;if(this.processor?.updating){const e=this.processor.updatingRemaining,r=Math.max(e,this._processorTotal);r>0&&(t=(r-e)/r,this._processorTotal=r)}return.5*(e+t)}get updatePolicy(){if(!this.controller)return f.UpdatePolicy.ASYNC;switch(this.controller.mode){case"snapshot":{const e=g.get(this.layer.geometryType);return null==e||this.controller.serviceDataCount>e?f.UpdatePolicy.ASYNC:f.UpdatePolicy.SYNC}case"tiles":return f.UpdatePolicy.ASYNC}}get usedMemory(){return(this.processor?.usedMemory??0)+(this.controller?.memoryForUnusedFeatures??0)}get unloadedMemory(){const e=this.processor?.unprocessedMemoryEstimate??0,t=this.controller?.expectedFeatureDiff??0,r=this.processor?.loadedFeatures??0,i=r+t>0?r/(r+t):1;return e+t*(this.processor?.usedMemoryPerFeature??0)*i}get ignoresMemoryFactor(){return this.controller?.hasMaximumNumberOfFeaturesOverride}get performanceInfo(){const e=this.controller?.displayFeatureLimit,t=null!=e?e.averageSymbolComplexity:void 0,r=null!=t?`f:${t.verticesPerFeature},v:${t.verticesPerCoordinate}`:"n/a";return new d.FeatureLayerViewPerformanceInfo(super.performanceInfo,this.controller?.performanceInfo?.storedFeatures??0,this.controller?.performanceInfo?.totalVertices??0,this.maximumNumberOfFeaturesExceeded,this.controller?.mode??"n/a",r)}async doRefresh(e){const{controller:t,processor:r,suspended:i}=this;e&&t&&(i?this._needsRefresh=!0:(t.refetch(),this._needsRefresh=!1)),r.refreshFilter()}setVisibility(e,t){this.processor?.setObjectIdVisibility(e,t)}getMissingAttributesForFeature(e){return this.controller.getMissingAttributesForFeature(e)}getHydratedGeometry(e){const t=this.graphics3DProcessor;if(null==t)return null;const r=t.graphics3DGraphicsByObjectID;if(null==r)return null;const i=r.get(e);return null==i?null:c.hydrateGeometry(i.graphic.geometry)}createController(){this._fetcherContext=new p.FeatureTileFetcher3DContext({layerView:this.layerView,returnZ:this.hasZ,returnM:this.hasM});const e=new u.FeatureTileController3D({layerView:this.layerView,context:this._fetcherContext,graphics:new m.EventedSet,extent:this.clippingExtent});return this.updatingHandles.add((()=>e.serviceDataExtent),(e=>{this.processor&&(this.processor.dataExtent=e)}),i.initial),this.addHandles(i.watch((()=>this.suspended&&this.layerView.updateSuspended),(t=>{t?e.suspend():e.resume()}),i.syncAndInitial)),this.updatingHandles.add((()=>this.processor?.displayFeatureLimit),(t=>e.displayFeatureLimit=t),i.initial),this.addHandles(i.when((()=>!this.updating),(()=>{this._controllerTotal=0,this._processorTotal=0}))),e}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}get test(){return{controller:this.controller,graphics3DProcessor:this.graphics3DProcessor,heatmapProcessor:this.heatmapProcessor,loadedGraphics:this.loadedGraphics}}},t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"layerView",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"controller",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"_controllerTotal",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"_processorTotal",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"_needsRefresh",void 0),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"maximumNumberOfFeatures",null),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"updatingProgressValue",null),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"updatePolicy",null),t.__decorate([s.property()],e.FeatureGraphics3DGraphicsPipeline.prototype,"suspendResumeExtentMode",void 0),e.FeatureGraphics3DGraphicsPipeline=t.__decorate([l.subclass("esri.views.3d.layers.graphics.FeatureGraphics3DGraphicsPipeline")],e.FeatureGraphics3DGraphicsPipeline);const g=new Map([["point",5e3],["polygon",500],["polyline",1e3]]);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/controllers/FeatureTileController3D":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/asyncUtils","../../../core/Collection","../../../core/has","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/sql","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/support/UpdatingHandles","../../../geometry/projectionUtils","../../support/arcgisLayerUrl","../../support/featureLayerUtils","../../support/layerUtils","../../../rest/support/StatisticDefinition","../../../views/3d/layers/support/FeatureTileDescriptor","../../../views/3d/layers/support/FeatureTileFetcher3D","../../../views/3d/layers/support/FeatureTileFetcher3DDebugger","../../../views/3d/support/debugFlags"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C){"use strict";e.FeatureTileController3D=class extends(u.EsriPromiseMixin(r)){get dataUpdating(){return this._tileFetcher?.dataUpdating??!1}set extent(e){if(null!=e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void l.getLogger(this).error("#extent=","extent needs to be in the same spatial reference as the view");const t=this._get("extent");if(t===e)return;if(null!=t&&e&&t.equals(e))return;const r=null!=e?e.clone():null;this._set("extent",r)}get updating(){return!!(this._tileFetcher?.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles?.updating||this._updatingHandles?.updating)}get updatingTotal(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return null!=this._tileFetcher?this._tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(null==this._tileFetcher||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return this.displayFeatureLimit?.maximumNumberOfFeatures??0}set maximumNumberOfFeatures(e){e!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",e)}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get hasAllFeatures(){return this.serviceDataCount===e.FeatureTileController3DConstants.noServiceDataCount&&"snapshot"===this.mode&&this.hasAllFeaturesInView||this.serviceDataCount===this.graphics.length}get hasAllFeaturesInView(){const e=this.context.effectiveDisplayFilter?.where||null,t=null!=e&&"1=1"!==e;return("tiles"!==this.mode||!t)&&(this._tileFetcher?.showsAllFeatures??!1)}get hasFullGeometries(){return this._tileFetcher?.hasFullGeometries??!1}get mode(){const t=this.layerView.layer;if("feature"===t.type&&null!=t.infoFor3D)return"snapshot";if("catalog-footprint"===t.type)return"tiles";if(this._forceTilesMode)return"tiles";const r=this.layerView.view;if(!1===r.qualitySettings?.graphics3D?.snapshotAvailable||this.serviceDataCount===e.FeatureTileController3DConstants.noServiceDataCount||this._snapshotLimitExceeded||this.maximumNumberOfFeaturesExceeded||r.quality<1)return"tiles";const i=r&&r.featureTiles,s=i&&i.tilingScheme;if(t&&t.minScale&&this.serviceDataExtent&&s){const r=this._approximateExtentSizeAtScale(t.minScale,s);if((this.serviceDataExtent.width/r+this.serviceDataExtent.height/r)/2>e.FeatureTileController3DConstants.maxSnapshotMinScaleFactor)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&this._tileFetcher?.totalVertices||0;return Math.max(e,t)}_approximateExtentSizeAtScale(e,t){const r=this.layerView.view,i=Math.ceil((r.width/t.pixelSize+r.height/t.pixelSize)/2),s=t.levels[0];return i*((s.tileSize[0]/(s.scale/e)+s.tileSize[1]/(s.scale/e))/2)}get tileDescriptors(){if("snapshot"===this.mode){const e=new w.FeatureTileDescriptor(0,0,0,this.layerView.view.featureTiles.tilingScheme,"dummy-tile-full-extent");return new s([e])}const e=this.layerView.view.featureTiles;return e?e.tiles:new s}get test(){}constructor(t){super(t),this.type="feature-tile-3d",this._updatingHandles=new g.UpdatingHandles,this.serviceDataExtent=null,this.serviceDataCount=e.FeatureTileController3DConstants.noServiceDataCount,this._snapshotLimitExceeded=!1,this.displayFeatureLimit=null,this._forceTilesMode=!1,this._suspended=!1,this._tileFetcher=null,this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null,this._lifeCycleAbortController=new AbortController}initialize(){this._updatingHandles.add((()=>this.displayFeatureLimit),(e=>this._updatingHandles.addPromise(this._updateSnapshotLimit(e,null,this._lifeCycleAbortController.signal)))),this._updatingHandles.add((()=>this.mode),(()=>this._modeChanged()),h.initial),this._updatingHandles.add((()=>this.mode),((e,t)=>{"tiles"===e&&"snapshot"===t&&(this._forceTilesMode=!0)}),h.initial),this.addResolvingPromise(Promise.resolve().then((()=>this._verifyCapabilities())).then((()=>this._updatingHandles.addPromise(this._fetchServiceDataInfo()))).then((()=>this._initializeTileFetcher())))}_verifyCapabilities(){const e=this.layerView.layer;if("ogc-feature"!==e.type&&!v.getEffectiveLayerCapabilities(e)?.operations.supportsQuery)throw new o("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}destroy(){this._cancelFetchServiceDataInfo(),this._tileFetcher=c.destroyMaybe(this._tileFetcher),this._tilesHandle=c.removeMaybe(this._tilesHandle),this._lifeCycleAbortController=c.abortMaybe(this._lifeCycleAbortController),this._updatingHandles.destroy(),this._set("_updatingHandles",null)}suspend(){this._suspended||(this._suspended=!0,null!=this._tileFetcher&&this._tileFetcher.suspend())}resume(){this._suspended&&(this._suspended=!1,null!=this._tileFetcher&&this._tileFetcher.resume())}restart(){const e=()=>{null!=this._tileFetcher&&this._tileFetcher.restart()};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(e,e))}refetch(){this._refetch({resetForceTilesMode:!1})}getMissingAttributesForFeature(e){return this._tileFetcher?.getMissingAttributesForFeature(e)}_refetch(e){const t=()=>{null!=this._tileFetcher&&(e.resetForceTilesMode&&(this._forceTilesMode=!1),this._tileFetcher.refetch())};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(t,t))}_initializeTileFetcher(){const e=this.layerView.view;if(!e)return;const t=h.whenOnce((()=>e.featureTiles?.tilingScheme),this._lifeCycleAbortController.signal);this._updatingHandles.addPromise(t),t.then((()=>{const{layerView:e,tileDescriptors:t}=this,r=e.layer,i=new x.FeatureTileFetcher3D({context:this.context,filterExtent:this.extent,tileDescriptors:t,features:this.graphics});this._tileFetcher=i,this._suspended?i.suspend():i.resume();const s=this.layerView.view;s&&this.addHandles(h.watch((()=>s.quality),(e=>i.memoryFactor=e),h.syncAndInitial));const n="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;n&&this.addHandles(h.watch((()=>this.layerView.view?.qualitySettings?.graphics3D?.[n]),(e=>i.lodFactor=e||1),h.initial)),"ogc-feature"!==r.type&&this._updatingHandles.add((()=>r.createQueryVersion),(()=>this._dataFilterChanged())),this._updatingHandles.add((()=>this.context.effectiveDisplayFilter),(()=>this._effectiveDisplayFilterChanged())),this._updatingHandles.add((()=>e.availableFields),((e,t)=>this._availableFieldsChanged(t,e))),this._updatingHandles.add((()=>e.requiredFields),((e,t)=>this._requiredFieldsChanged(t,e))),"customParameters"in r&&this._updatingHandles.add((()=>r.customParameters),(()=>this.restart())),this.addHandles([r.on("apply-edits",(e=>this._applyEdits(e))),h.watch((()=>this.extent),(e=>i.filterExtent=e),h.sync),h.watch((()=>this.tileDescriptors),(e=>i.tileDescriptors=e),h.sync),h.watch((()=>this.maximumNumberOfFeatures),(e=>{i.maximumNumberOfFeatures=e,i.useTileCount=this.serviceDataCount>e}),h.syncAndInitial),h.watch((()=>this.serviceDataCount),(e=>{i.useTileCount=e>this.maximumNumberOfFeatures}),h.syncAndInitial),h.watch((()=>C.debugFlags.FEATURE_TILE_FETCH_SHOW_TILES),(e=>{e&&i?i.debugger??=new T.FeatureTileFetcher3DDebugger(i,s.featureTiles.tilingScheme.toTileInfo(),s):!e&&this._tileFetcher&&i.debugger&&(i.debugger=c.destroyMaybe(i.debugger))}),h.initial)]),this._supportsExceedsLimitQuery||this._updatingHandles.add((()=>this.maxTotalSnapshotVertices),(()=>this._updatingHandles.addPromise(this._updateSnapshotLimit(this.displayFeatureLimit,null,this._lifeCycleAbortController.signal))))})).catch((()=>{}))}_modeChanged(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:l.getLogger(this).warn("Unhandled feature layer mode "+this.mode);case"snapshot":null!=this._tilesHandle&&(this._tilesHandle.remove(),this._tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this._refetch({resetForceTilesMode:!0})}_effectiveDisplayFilterChanged(){"snapshot"!==this.mode&&this._refetch({resetForceTilesMode:!1})}_applyEdits(e){const t=this.layerView.layer;null!=this._tileFetcher&&this._tileFetcher.applyEdits(e).then((e=>{if(e){if(!this._lifeCycleAbortController)throw d.createAbortError();e.exceededTransferLimit&&"refresh"in t?t.refresh():(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&this._updatingHandles.addPromise(this._updateServiceDataExtent(this._lifeCycleAbortController.signal))}})).catch((e=>{if(!d.isAbortError(e))throw e}))}_availableFieldsChanged(e,t){null!=this._tileFetcher&&R(this._tileFetcher.availableFields,t)&&this._refetch({resetForceTilesMode:!1})}_requiredFieldsChanged(e,t){null!=this._tileFetcher&&R(this._tileFetcher.availableFields,t)&&this.restart()}_createVertexLimitExceededQuery(e){const t=this.layerView.layer,r=t.createQuery();return r.returnGeometry=!1,r.outStatistics=[new S({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities?.query.supportsCacheHint&&(r.cacheHint=!0),r}_createDataInfoQuery(){const e=this.layerView.layer,t=this.layerView,r=e.createQuery();return r.returnGeometry=!1,r.outSpatialReference=this.layerView.view.spatialReference,e.capabilities?.query.supportsCacheHint&&(r.cacheHint=!0),t.effectiveDisplayFilter&&(r.where=p.sqlAnd(r.where,t.effectiveDisplayFilter.where)),r}_fullExtentIsAccurate(){const e=this.layerView.layer;if("definitionExpression"in e&&e.definitionExpression)return!1;switch(e.type){case"feature":case"catalog-footprint":case"oriented-imagery":return _.isHostedAgolService(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}async _updateServiceDataExtent(e){try{await this._tryUpdateServiceDataExtent(e)}catch(e){d.isAbortError(e)||this._set("serviceDataExtent",a.clone(this.layerView.fullExtentInLocalViewSpatialReference)??null)}}async _tryUpdateServiceDataExtent(t){const r=this.layerView,i=r.layer,s=i.capabilities?.query.supportsExtent??!1,n=a.clone(r.fullExtentInLocalViewSpatialReference),o=i.fullExtent,l=this._fullExtentIsAccurate(),c=this.serviceDataCount;if(s&&c<=e.FeatureTileController3DConstants.maxFeatureCountForExtent&&(!n||!l)&&"queryExtent"in i){const r=this._createDataInfoQuery(),s=await i.queryExtent(r,{timeout:e.FeatureTileController3DConstants.queryExtentTimeout,signal:t});this._set("serviceDataExtent",s.extent)}else if(n)this._set("serviceDataExtent",n);else if(null!=o){const e=o.spatialReference?await y.projectWithZConversion(o,r.view.spatialReference):null;this._set("serviceDataExtent",e??null)}else this._set("serviceDataExtent",null)}async _updateServiceDataCount(t){const r=this.layerView.layer;if(!("queryFeatureCount"in r)||!n("featurelayer-snapshot-enabled"))return void this._set("serviceDataCount",e.FeatureTileController3DConstants.noServiceDataCount);const s=await i.result(r.queryFeatureCount(this._createDataInfoQuery(),{timeout:e.FeatureTileController3DConstants.queryStatisticsTimeout,signal:t}));if(!0===s.ok)this._set("serviceDataCount",s.value);else{if(d.isAbortError(s.error))throw s.error;this._set("serviceDataCount",e.FeatureTileController3DConstants.noServiceDataCount)}}get _supportsExceedsLimitQuery(){const e=this.layerView.layer;return null!=e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}get _minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}async _updateSnapshotLimit(t,r,s){if(null==t?.averageSymbolComplexity)return void(this._snapshotLimitExceeded=!1);const{maximumTotalNumberOfVertices:o,averageSymbolComplexity:a}=t,{verticesPerFeature:l,verticesPerCoordinate:c}=a,u=l<=0,h=this._minimumNumberOfVerticesForGeometry>1;if(!u&&!h)return void(this._snapshotLimitExceeded=!1);0!==l&&null!=r&&await r;const p=Math.min(o,P),m=this.serviceDataCount,f=m!==e.FeatureTileController3DConstants.noServiceDataCount;let g=f?Math.ceil((p-m*l)/(c||1)):Math.ceil(p/(c||1));if(h&&(g=Math.min(g,M)),f&&this._minimumNumberOfVerticesForGeometry*m>g)return void(this._snapshotLimitExceeded=!0);if(!this._supportsExceedsLimitQuery||!n("featurelayer-snapshot-enabled"))return void(this._snapshotLimitExceeded=this.maxTotalSnapshotVertices>g);const y=await i.result(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(g),{timeout:e.FeatureTileController3DConstants.queryStatisticsTimeout,signal:s}));if(!1===y.ok){if(d.isAbortError(y.error))throw y.error;return void(this._snapshotLimitExceeded=!1)}const _=y.value.features[0];this._snapshotLimitExceeded=!!_?.attributes&&!!_.attributes.exceedslimit}async _fetchServiceDataInfo(){this._cancelFetchServiceDataInfo(),await b.checkServiceCurrentUserSupport(this.layerView.layer);let e=new AbortController;const t=e.signal,r=this._updateServiceDataCount(t),i=Promise.allSettled([r,this._updateSnapshotLimit(this.displayFeatureLimit,r,t)]),s=i.then((()=>this._updateServiceDataExtent(t))).catch((e=>{d.isAbortError(e)||l.getLogger(this).error("#fetchServiceDataInfo()",e)})).then((()=>{s===this._fetchDataInfoPromise&&(this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null),e=null}));return e&&(this._fetchDataInfoPromise=s),this._fetchDataInfoAbortController=e,i.then((()=>{}),(()=>{}))}_cancelFetchServiceDataInfo(){const e=this._fetchDataInfoAbortController;e&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,e.abort())}get performanceInfo(){return{storedFeatures:this._tileFetcher?.storedFeatures??0,totalFeatures:this._tileFetcher?.totalFeatures??0,totalVertices:this._tileFetcher?.totalVertices??0,missingTiles:this._tileFetcher?.missingTiles??0}}},t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"type",void 0),t.__decorate([m.property({constructOnly:!0})],e.FeatureTileController3D.prototype,"graphics",void 0),t.__decorate([m.property({constructOnly:!0})],e.FeatureTileController3D.prototype,"layerView",void 0),t.__decorate([m.property({constructOnly:!0})],e.FeatureTileController3D.prototype,"context",void 0),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"dataUpdating",null),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"extent",null),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"updating",null),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"_updatingHandles",void 0),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"updatingTotal",null),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"updatingRemaining",null),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"expectedFeatureDiff",null),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"memoryForUnusedFeatures",null),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"serviceDataExtent",void 0),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"serviceDataCount",void 0),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"_snapshotLimitExceeded",void 0),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"displayFeatureLimit",void 0),t.__decorate([m.property({type:Number})],e.FeatureTileController3D.prototype,"maximumNumberOfFeatures",null),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"hasAllFeatures",null),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"hasAllFeaturesInView",null),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"hasFullGeometries",null),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"_forceTilesMode",void 0),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"mode",null),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"maxTotalSnapshotVertices",null),t.__decorate([m.property({readOnly:!0})],e.FeatureTileController3D.prototype,"tileDescriptors",null),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"_tileFetcher",void 0),t.__decorate([m.property()],e.FeatureTileController3D.prototype,"_fetchDataInfoPromise",void 0),e.FeatureTileController3D=t.__decorate([f.subclass("esri.layers.graphics.controllers.FeatureTileController3D")],e.FeatureTileController3D);const P=1e6,M=5e6;function R(e,t){if(!t)return!1;for(const r of t)if(!e.has(r))return!0;return!1}var E;e.FeatureTileController3DConstants=void 0,(E=e.FeatureTileController3DConstants||(e.FeatureTileController3DConstants={})).noServiceDataCount=1/0,E.maxSnapshotMinScaleFactor=5,E.reset=function(){E.maxFeatureCountForExtent=1e4,E.queryStatisticsTimeout=12e3,E.queryExtentTimeout=1e4},e.FeatureTileController3DConstants.reset(),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FeatureTileFetcher3D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/has","../../../../core/Logger","../../../../core/MapUtils","../../../../core/promiseUtils","../../../../core/ReactiveMap","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/signal","../../../../core/sql","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/common","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../rest/support/QuantizationParameters","../../../../rest/support/Query","../../../ViewingMode","./featureReference","./FeatureTile","../../terrain/tileUtils","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T){"use strict";function C(e){return"dummy-tile-full-extent"===e.id}function P(e){return null==e?new Set:new Set(e.map((e=>e.name)))}function M(e,t){if(null==e||null==t)return P(t);const r=new Set;for(const{name:i}of t)e.has(i)&&r.add(i);return r}function R(e,t){if(!t?.length)return e;e??=new Map;const r=()=>new Set;for(const{objectId:i,attribute:s}of t)o.getOrCreateMapValue(e,i,r).add(s);return e}e.FeatureTileFetcher3D=class extends r{set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this._supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&null!=this.context.query.queryFeatureCount}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get updating(){return this._dirty||!!this._pendingEdits||this._isFetching||(this.tileDescriptors?.updating??!1)}get running(){return this._dirty}get memoryForUnusedFeatures(){let e=0;return this._featureTiles.forEach((t=>e+=t.estimatedUnusedSize)),e}get totalVertices(){let e=0;return this._featureTiles.forEach((t=>e+=t.numVertices)),e}get totalFeatures(){let e=0;return this._featureTiles.forEach((t=>e+=t.numFeatures)),e}get showsAllFeatures(){if(this._paused||this.dataUpdating)return!1;for(const e of this._featureTiles.values())if(!this.hasFullGeometries&&0!==e.emptyFeatureRatio||!e.showsAllFeatures)return!1;return!0}get hasFullGeometries(){if(!this._supportsResolution)return!0;const e=this.tileDescriptors?.some(C);return e||!this.context.capabilities.supportsQuantization&&"polyline"!==this.context.geometryType}set filterExtent(e){if(null!=e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void n.getLogger(this).error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const r=null!=e?e.clone():null;this._set("filterExtent",r),this._reclip(r,t)}_updateTileZQuantization(e){if(this.context.viewingMode===v.ViewingMode.Global){const t=e.computeZQuantizationFactor();this._zQuantizationFactor.value<t&&(this._zQuantizationFactor.value=t)}}get _tileZQuantization(){return this.context.isDraped?1:this._zQuantizationFactor.value}constructor(e){super(e),this._useTileCount=!1,this.dataUpdating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this._fullRatio=1,this._farRatio=1,this._zQuantizationFactor=d.signal(1),this._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this._featureTiles=new l,this._displayingFeatureReferences=new Map,this._numDisplayingFeatureReferences=0,this._dirty=!1,this._suspended=!0,this._pendingEdits=null,this._applyEditsTilesUpdated=!1,this._isFetching=!1;const t=e.context;this._frameTask=t.scheduler?.registerTask(T.TaskPriority.FEATURE_TILE_FETCHER,this)??T.ImmediateTask,this.FeatureReferenceClass=t.capabilities.supportsMultipleResolutions?S.MultiFeatureReference:S.SingleFeatureReference,this._objectIdField=t.objectIdField}initialize(){this.addHandles([c.on((()=>this.tileDescriptors),"change",(()=>this._setDirty())),c.watch((()=>this._tileZQuantization),(()=>this.refetch()))]),this._setDirty()}destroy(){this._frameTask.remove(),this._featureTiles.forEach((e=>{this._cancelFetchTile(e),this._removeTile(e)})),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),this._pendingEdits?.controller.abort(),this._pendingEdits=null}get _paused(){return this._suspended||!!this._pendingEdits}restart(){this._featureTiles.forEach((e=>{this._cancelFetchTile(e),this._clearTile(e),this._resetFetchTile(e)})),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this._featureTiles.forEach((e=>{this._cancelFetchTile(e),this._resetFetchTile(e)})),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}resume(){this._suspended&&(this._suspended=!1,this._unpause())}getMissingAttributesForFeature(e){for(const t of this._featureTiles.values()){const r=t.missingAttributes?.get(e);if(null!=r)return r}}_pause(){this._paused&&(this._featureTiles.forEach((e=>this._cancelFetchTile(e))),this._updated())}_unpause(){this._paused||this._setDirty()}get availableFields(){let e=null;return this._featureTiles.forEach((t=>{null!=t.displayingFeatures&&0!==t.displayingFeatures.length&&(null==e?e=new Set(t.availableFields):e.forEach((r=>{t.availableFields?.has(r)||e.delete(r)})))})),null!=e?e:new Set}applyEdits(e){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const t=this._pendingEdits;t.count++;const r=t.edits.then((()=>e.result.catch((e=>{if(a.isAbortError(e))throw e;return null})).then((e=>e?(this._applyEditsDeleteFeatures(e.deletedFeatures),this._applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,t.controller.signal).then((()=>e))):e)).then((e=>(0===--t.count&&(this._pendingEdits===t&&(this._pendingEdits=null),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._applyEditsTilesUpdated=!1,this._unpause()),e)))));return t.edits=r,this._updated(),r}_applyEditsDeleteFeatures(e){if(0===e.length)return;const t=this.context.globalIdField,r=t&&this.availableFields.has(t),i=new Set,s=this._objectIdField;e.forEach((({objectId:e,globalId:o})=>{(!e||e<0)&&t&&o&&(r||n.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`),e=this._objectIdFromGlobalId(o,s,t)),null!=e&&e>=0&&i.add(e)})),this._featureTiles.forEach((e=>{if(!e.features)return;const t=e.features.filter((e=>!i.has(y.getObjectId(e,this._objectIdField))));t.length!==e.features.length&&(this._applyEditsTileUpdated(),e.setFeatures(t,0,e.availableFields,e.missingAttributes),this._updateTileZQuantization(e),this._invalidateCounts())}))}_objectIdFromGlobalId(e,t,r){if(null==e)return null;const i=this.features.find((t=>t.attributes?.[r]===e));return i?y.getObjectId(i,t):null}async _applyEditsAddUpdateFeatures(e,t,r){const{objectIdField:i,globalIdField:s}=this.context,o=s&&this.availableFields.has(s),a=new Set,l=new Set;for(const t of e){const e=t.objectId;null!=e&&a.add(e)}for(const{objectId:e,globalId:r}of t){let t=e;(null==t||t<0)&&s&&(o||n.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${s} to be included the layer's outFields for updates to be reflected in the view`),t=this._objectIdFromGlobalId(r,i,s)),null!=t&&t>=0&&(a.add(t),l.add(t))}if(0===a.size)return;const c=[];this._featureTiles.forEach((e=>{const t=this._applyEditsAddUpdateTile(e,a,l,r);t&&c.push(t)})),this._updated(),await Promise.allSettled(c)}async _applyEditsAddUpdateTile(e,t,r,i){if(!e.features)return;e.fetchingResolution=e.descriptor.resolution;const s=this._createQuery(e);s.resultType=void 0,s.cacheHint=!1,s.objectIds=Array.from(t);const n=await this._queryFeatures(s,i);let o=null;if(r.size>0){const t=e.features.filter((e=>!r.has(y.getObjectId(e,this._objectIdField))));t.length!==e.features.length&&(o=t)}if(n.features.length>0){o||(o=e.features.slice());for(const e of n.features)o.push(e)}o&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,o.length)),this._applyEditsTileUpdated(),e.setFeatures(o,0,M(e.availableFields,n.fields),R(e.missingAttributes,n.missingAttributes)),this._updateTileZQuantization(e),this._invalidateCounts())}_applyEditsTileUpdated(){this._applyEditsTilesUpdated||(this._applyEditsTilesUpdated=!0,this._updated())}_queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:D})}_setDirty(){this._dirty=!0,this._updated()}runTask(e){const t=this._frameTask.processQueue(e);if(!this._dirty||!this.initialized)return t;this._dirty=!1;const r=this._featureTilesArray;if(this._markTilesNotAlive(r),!e.run((()=>this._addTiles(r,e)))||!e.run((()=>this._filterExtentTiles(r,e)))||!e.run((()=>this._removeTiles(r,e)))||e.done)return void this._setDirty();const i=this._sortTiles(r);e.run((()=>this._showTiles(i,e)))&&e.run((()=>this._fetchTiles(i,e)))&&e.run((()=>this._updateMemoryEstimates(i,e)))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(e){for(const t of e)t.alive=!1}_addTiles(e,t){return!(this._suspended||!this.tileDescriptors)&&(this.tileDescriptors.forEach((r=>{const i=this._featureTiles.get(r.id);i?i.alive=!0:t.done||(e.push(this._addTile(r)),t.madeProgress())})),t.hasProgressed)}_filterExtentTiles(e,t){for(const r of e){if(t.done)break;r.alive&&(r.filtered=!r.intersects(this.filterExtent),r.filtered&&(this._clearTile(r),t.madeProgress()))}return t.hasProgressed}_removeTiles(e,t){for(let r=e.length-1;r>=0&&!t.done;r--){const i=e[r];i.alive||(this._removeTile(i),r!==e.length-1&&(e[r]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}_sortTiles(e){return e.sort(((e,t)=>e.descriptor.loadPriority-t.descriptor.loadPriority)),e}_showTiles(e,t){const r=this._updateRatio(e),i=e=>{const t=this._fullRatio<1?r(e)*this._farRatio:1;e.reduceFeatures(t,this.memoryFactor,this._objectIdField,this._reduceMode)&&this._setDirty();const{numFeatures:i,fetchingResolution:s,descriptor:n,isFetched:o}=e;return this._supportsResolution&&i>0&&s!==n.resolution&&o&&(e.requestRefetch(),this._setDirty()),this._showTile(e)};for(const r of e)if(!t.run((()=>i(r)))){this._setDirty();break}return t.hasProgressed}_fetchTiles(e,t){if(this._paused)return!1;let r=!1;for(const i of e){if(!i.needsFetch)continue;const e=null!=this.context.memoryCache?this.context.memoryCache.pop(i.id):null;if(e?.resolution!==i.displayingResolution){if(this._needsNumFeatures(i)){const e=new AbortController,s=this._fetchTileCount(i,e.signal);this._handleRequest(i,s,e,(()=>i.resetFetching()),(()=>i.numFeatures=w.failedFeatureCount)),r=!0,t.madeProgress()}if(t.done)return!0}else i.cache=e,i.numFeatures&&this._notifyDataUpdating(),this._setDirty(),this._scheduleUpdated(),t.madeProgress()}if(r)return t.hasProgressed;for(const r of e){if(!r.needsFetch)continue;const e=new AbortController,i=this._fetchTile(r,e.signal);if(this._handleRequest(r,i,e,(e=>r.fetchDone(e)),(e=>{r.fetchFailed=!0,this.context.logFetchError(n.getLogger(this),e)})),t.madeProgress(),t.done)return!0}return t.hasProgressed}_updateMemoryEstimates(e,t){return e.some((e=>!t.run((()=>e.updateMemoryEstimates()))&&(this._setDirty(),!0))),t.hasProgressed}_reclip(e,t){if(!this.initialized)return;const r=new Array;this._featureTiles.forEach((i=>{null!=i.displayingFeatures&&0!==i.displayingFeatures.length&&(i.intersectionIncludingBorrowed(t,O),i.intersectionIncludingBorrowed(e,A),g.equals(O,A)||r.push(i))})),this._refreshDisplayingFeatures(r),this._updated()}_refreshDisplayingFeatures(e){const t=new Set,r=this._changes.updates;for(const i of e)if(null!=i.displayingFeatures)for(const e of i.displayingFeatures){const i=y.getObjectId(e,this._objectIdField);if(t.has(i))continue;t.add(i);const s=this._displayingFeatureReferences.get(i).feature;r.removes.push(s),r.adds.push(s)}this._applyChanges()}_updated(){let e=0;if(this._paused||this._featureTiles.forEach((t=>t.isFetching?++e:0)),this._isFetching=e>0,e>0||this._applyEditsTilesUpdated?this._notifyDataUpdating():this._dirty||this._set("dataUpdating",!1),this.updating){let t=0,r=0,i=0,s=0,n=0;const o=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach((e=>{if(++r,e.isFetching&&e.hasPreciseFeatureCount){const t=this._maximumFeaturesForTile(e)*(1-e.emptyFeatureRatio),r=null!=e.displayingFeatures?e.displayingFeatures.length*o:0;n+=t-r}e.needsFetch?++s:e.numFeatures>0&&(++i,t+=e.numFeatures)})),s+=e;let a=0,l=0;t?(l=t,a=Math.min(s*t/i,t)):(l=r,a=s),n=Math.min(this.maximumNumberOfFeatures-this.features.length,n),this._set("updatingTotal",l),this._set("updatingRemaining",a),this._set("expectedFeatureDiff",n)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger?.update()}_updateMaximumNumberOfFeaturesExceeded(){for(const{perTileMaximumNumberOfFeaturesExceeded:e}of this._featureTiles.values())if(e)return void this._set("maximumNumberOfFeaturesExceeded",!0);this._set("maximumNumberOfFeaturesExceeded",!1)}_updateRatio(e){const t=function(e){let t=0;for(const r of e)r.features&&r.features.length>0&&r.alive&&(t=Math.max(t,r.descriptor.lij[0]));return t}(e),r=e=>1/(1<<Math.max(0,t-e.descriptor.lij[0]));let i=0,s=0;for(const t of e){const e=t.numFeatures;i+=e,s+=e*r(t)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/i),this._farRatio=this.maximumNumberOfFeatures/s,this._scheduleUpdated(),r}_maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this._featureTiles.forEach((e=>{if(!e.featuresMissing)return;const t=this._maximumFeaturesForTile(e);e.isFullyFetched(t)||(this._cancelFetchTile(e),this._resetFetchTile(e))})),this._setDirty())}_addTile(e){const t=new w.FeatureTile(e);return this._featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}_referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.displayingResolution;this._featureTiles.forEach((r=>{if(null!=r.displayingFeatures&&e!==r&&x.tilesAreRelated(e.descriptor.lij,r.descriptor.lij)){null==e.displayingFeatures&&(e.displayingFeatures=[]),e.descriptor.extent&&r.descriptor.extent&&(e.extentIncludingBorrowedFeatures??=g.clone(e.descriptor.extent),g.expand(e.extentIncludingBorrowedFeatures,r.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const i of r.displayingFeatures){e.displayingFeatures.push(i);const r=this._displayingFeatureReferences.get(y.getObjectId(i,this._objectIdField));r.ref(r.feature,t),this._numDisplayingFeatureReferences++}}}))}_removeTile(e){this._clearTile(e),this._featureTiles.delete(e.id)}_resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetch&&e.fetchDone(w.FetchStatus.DONE):e.requestFetch()}_cancelFetchTile(e){const t=e.requestController;null!=t&&(e.requestController=null,e.resetFetching(),t.abort())}async _fetchTileCount(e,t){e.numFeatures=await this._fetchCount(e,t),this._updateRatio(this._featureTilesArray)}async _fetchTile(e,t){e.fetchFailed=!1;const r=this._maximumFeaturesForTile(e);if(r<=0)return e.hasPreciseFeatureCount&&0===e.numFeatures||(e.fetchFailed=!0),function(e){e.setFeatures([],0,null,void 0)}(e),e.fetchInformation.value="Empty tile",w.FetchStatus.DONE;const i=this._getMaxRecordCount(e),s=Math.ceil(r/i);if(e.fetchingResolution=e.descriptor.resolution,C(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=r&&s>b.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(e,t);const n=this._createQuery(e);if(n.maxRecordCountFactor=s,e.isRefetching&&e.features&&e.features.length>0){const t=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/i);n.maxRecordCountFactor=Math.max(t+1,n.maxRecordCountFactor)}e.fetchInformation.value=`Single fetch\n${r} features`;const{features:o,exceededTransferLimit:l,fields:c,missingAttributes:u}=await this._queryFeatures(n,t),d=l||n.maxRecordCountFactor>=b.MAX_MAX_RECORD_COUNT_FACTOR||r===this._totalFeaturesForTile(e)?w.FetchStatus.FULL:w.FetchStatus.DONE,h=await this._frameTask.schedule((()=>{e.exceededTransferLimit.value=!!l;const t=this._removeEmptyFeatures(o,this._getEffectiveTileResolution(e));return e.fetchInformation.value=`Single fetch\n${o.length}/${r} features`,e.setFeatures(o,t,P(c),R(void 0,u)),this._updateTileZQuantization(e),this._maximumFeaturesForTile(e)>r?w.FetchStatus.REFETCH_NEEDED:d}),t);return a.throwIfAborted(t),this._invalidateCounts(),h}async _fetchCount(e,t){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(e),{signal:t})}async _fetchPagedTile(e,t){let r,i=0,s=0,n=0,o=this._maximumFeaturesForTile(e)-n;const l=this._getMaxRecordCount(e);let c,u=null;for(;;){const d=this._createQuery(e),h=this._setPagingParameters(d,i,o,l);e.fetchInformation.value=`Paged fetch\n${e.features?.length}/${o} features`;const{features:p,exceededTransferLimit:m,fields:f,missingAttributes:g}=await this._queryFeatures(d,t);if(await this._frameTask.schedule((()=>{h&&(i+=d.num),n+=p.length,s+=this._removeEmptyFeatures(p,this._getEffectiveTileResolution(e)),e.exceededTransferLimit.value=!!m,r=r?.concat(p)??p,u=M(u,f),c=R(c,g),e.setFeatures(r,s,u,c),this._updateTileZQuantization(e),this._invalidateCounts(),this._setDirty()}),t),a.throwIfAborted(t),o=this._maximumFeaturesForTile(e)-(r?.length??0),!h||!m||o<=0)return m?w.FetchStatus.DONE:w.FetchStatus.FULL}}_createFeatureCountQuery(e){const t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}_createQuery(e){const t=this.context.createQuery();t.resultType=this._resultType(e);const r=C(e);return r||(t.geometry=g.toExtent(e.descriptor.extent,this.context.tilingScheme.spatialReference)),this._setResolutionParams(t,e),"tile"!==t.resultType&&this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),!r&&this.context.effectiveDisplayFilter&&(t.where=h.sqlAnd(t.where,this.context.effectiveDisplayFilter.where)),t}_setPagingParameters(e,t,r,i){return!!this.context.capabilities.supportsPagination&&(e.start=t,r>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(r/i),e.num=Math.min(e.maxRecordCountFactor*i,r)):e.num=Math.min(i),!0)}_getEffectiveTileResolution(e){if(C(e)||!this._supportsResolution)return null;const t=this.context.viewingMode===v.ViewingMode.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.fetchingResolution,t)/this.lodFactor/this._tileZQuantization}get _supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(e,t){const r=this._getEffectiveTileResolution(t);null!=r&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new _({mode:"view",originPosition:"upper-left",tolerance:r,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=r))}_removeEmptyFeatures(e,t){const r=e.length;if(t&&this._supportsResolution){const r=t*(1+f.getEpsilon());i.filterInPlace(e,(({geometry:e})=>!(!e||!y.hasVertices(e))&&(y.computeAABR(e,I),g.width(I)>r||g.height(I)>r)))}else i.filterInPlace(e,(({geometry:e})=>y.hasVertices(e)));return r-e.length}_needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!C(e)}_getMaxRecordCount(e){switch(this._resultType(e)){case"tile":if(this.context.tileMaxRecordCount)return this.context.tileMaxRecordCount;break;case"standard":if(this.context.standardMaxRecordCount)return this.context.standardMaxRecordCount}return this.context.maxRecordCount||E}_resultType(e){if(this.context.capabilities.supportsResultType)return C(e)?"standard":"tile"}get _reduceMode(){const e=this.context.geometryType;return"polygon"===e||"polyline"===e?w.ReduceMode.SIZE:w.ReduceMode.RANDOM}_handleRequest(e,t,r,i,s){e.startFetch(),e.requestController=r;let n=!1;t.then((t=>{e.requestController=null,i(t)})).catch((t=>{e.requestController===r&&(e.requestController=null,e.fetchDone(w.FetchStatus.DONE)),a.isAbortError(t)?n=!0:s(t)})).then((()=>{n||this._setDirty(),this._scheduleUpdated()}))}_scheduleUpdated(){this.hasHandles("scheduleUpdated")||this.addHandles(u.schedule((()=>{this.removeHandles("scheduleUpdated"),this._updated()})),"scheduleUpdated")}_showTile(e){if(e.displayingFeatures&&!e.needsDisplayUpdate)return!1;const t=e.features;if(0===e.featureLimit||!t){const t=null!=e.displayingFeatures&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],t}const r=e.fetchingResolution,{adds:i,updates:s}=this._changes,n=Math.min(e.featureLimit,t.length);for(let e=0;e<n;++e){const n=t[e],o=y.getObjectId(n,this._objectIdField),a=this._displayingFeatureReferences.get(o);if(a){const{oldVersion:e,newVersion:t}=a.ref(n,r);e!==t&&(e&&s.removes.push(e),t&&s.adds.push(t))}else this._displayingFeatureReferences.set(o,new this.FeatureReferenceClass(n,r)),i.push(n);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(e),e.displayingResolution=e.fetchingResolution,this._applyChanges(),e.displayingFeatures=t.slice(0,n),!0}_hideTile(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}_hideTileFeatures(e){if(null==e.displayingFeatures)return;const{updates:t,removes:r}=this._changes;for(const i of e.displayingFeatures){const s=y.getObjectId(i,this._objectIdField),n=this._displayingFeatureReferences.get(s);if(!n)continue;const{oldVersion:o,newVersion:a}=n.unref(e.displayingResolution);this._numDisplayingFeatureReferences--,o!==a&&(null==a?(this._displayingFeatureReferences.delete(s),o&&r.push(o)):(t.adds.push(a),o&&t.removes.push(o)))}this._applyChanges(),e.displayingFeatures=null}_notifyDataUpdating(){this._get("dataUpdating")||this._set("dataUpdating",!0)}_applyChanges(){const e=this._changes.updates;e.removes.length>0&&(this._notifyDataUpdating(),this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this._notifyDataUpdating(),this.features.addMany(e.adds),e.adds.length=0);const t=this._changes.adds,r=this._changes.removes,i=Math.min(t.length,r.length);let s=0;for(;s<i;){const e=Math.min(s+F,i);this._notifyDataUpdating(),this.features.addMany(t.slice(s,e)),this.features.removeMany(r.slice(s,e)),s=e}t.length>i&&(this._notifyDataUpdating(),this.features.addMany(0===s?t:t.slice(s))),r.length>i&&(this._notifyDataUpdating(),this.features.removeMany(0===s?r:r.slice(s))),t.length=0,r.length=0}_clearTile(e){this._hideTile(e),e.features&&null!=this.context.memoryCache&&this.context.memoryCache.put(e.id,e.cache),e.setFeatures(null,0,null,void 0),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}get _featureTilesArray(){return Array.from(this._featureTiles.values())}get featureTiles(){return this._featureTiles}get storedFeatures(){return this._featureTilesArray.reduce(((e,t)=>e+(t.features?t.features.length:0)),0)}get missingTiles(){return Array.from(this._featureTiles.values()).reduce(((e,t)=>e+(t.needsFetch||t.isFetching?1:0)),0)}_totalFeaturesForTile(e){return e.hasPreciseFeatureCount?e.numFeatures:this.maximumNumberOfFeatures}_maximumFeaturesForTile(e){const t=this._totalFeaturesForTile(e),r=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(t*r/(1-e.emptyFeatureRatio)),t)}get test(){}},t.__decorate([p.property({constructOnly:!0})],e.FeatureTileFetcher3D.prototype,"features",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"tileDescriptors",void 0),t.__decorate([p.property({value:1/0})],e.FeatureTileFetcher3D.prototype,"maximumNumberOfFeatures",null),t.__decorate([p.property({value:1})],e.FeatureTileFetcher3D.prototype,"memoryFactor",null),t.__decorate([p.property({value:1})],e.FeatureTileFetcher3D.prototype,"lodFactor",null),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"useTileCount",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"updating",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"dataUpdating",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"updatingTotal",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"updatingRemaining",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"expectedFeatureDiff",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"memoryForUnusedFeatures",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"maximumNumberOfFeaturesExceeded",void 0),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"totalVertices",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"totalFeatures",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"showsAllFeatures",null),t.__decorate([p.property({readOnly:!0})],e.FeatureTileFetcher3D.prototype,"hasFullGeometries",null),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"filterExtent",null),t.__decorate([p.property({constructOnly:!0})],e.FeatureTileFetcher3D.prototype,"context",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_dirty",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_suspended",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_pendingEdits",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_applyEditsTilesUpdated",void 0),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_paused",null),t.__decorate([p.property()],e.FeatureTileFetcher3D.prototype,"_isFetching",void 0),e.FeatureTileFetcher3D=t.__decorate([m.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],e.FeatureTileFetcher3D);const E=2e3,O=g.create(),A=g.create(),I=g.create(),D=6e5,F=200;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/featureReference":function(){define(["exports","../../../../core/Error","../../../../core/has","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingBox","../../../../core/mathUtils","../../../../geometry/Extent","../../../../geometry/Geometry","../../../../geometry/Multipoint","../../../../geometry/Point","../../../../geometry/Polygon","../../../../geometry/Polyline","../../../../geometry/support/typeUtils","../../../../layers/support/Field","../../../../layers/graphics/dehydratedFeatureComparison"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";class f{constructor(e,t){this.feature=e,this.resolution=t,this.refCount=1}}const g={oldVersion:null,newVersion:null},y={oldVersion:null,newVersion:null};e.FeatureVersion=f,e.MultiFeatureReference=class{get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}constructor(e,t){this._highestResolutionVersion=null,this.versions=[],this.ref(e,t)}ref(e,t){const r=this.feature;y.oldVersion=r,r&&Object.defineProperty(e,"uid",{value:r.uid,configurable:!0});const i=this._highestResolutionVersion;for(const s of this.versions)if(s.resolution===t){s.refCount++;const t=i===s&&!m.equals(e,s.feature);return(t||i!==s)&&(s.feature=e),y.newVersion=t?e:r,y}const s=new f(e,t);return this.versions.push(s),!i||t<i.resolution?(y.newVersion=e,this._highestResolutionVersion=s):y.newVersion=r,y}unref(e){const{versions:r}=this;for(let t=0;t<r.length;t++){const i=r[t];if(i.resolution===e)return i.refCount--,g.oldVersion=this.feature,0===i.refCount&&(r[t]=r[r.length-1],--r.length,this._highestResolutionVersion===i&&(this._recalculateHighestResolutionVersion(),g.oldVersion=i.feature)),g.newVersion=this.feature,g}const i=`Unref feature with no references: ${this.feature?.uid}`;throw new t(i,i,(new Error).stack?.slice(6))}get feature(){return this._highestResolutionVersion?.feature??null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this._highestResolutionVersion=null);let e=this.versions[0];for(let t=1;t<this.versions.length;t++){const r=this.versions[t];r.resolution<e.resolution&&(e=r)}this._highestResolutionVersion=e}},e.SingleFeatureReference=class{get isReferenced(){return 0!==this._refCount}get isSingle(){return 1===this._refCount}constructor(e){this._feature=e,this._refCount=1}ref(e){++this._refCount;const t=this._feature;return y.oldVersion=t,t&&Object.defineProperty(e,"uid",{value:t.uid,configurable:!0}),m.equals(t,e)||(this._feature=e),y.newVersion=this._feature,y}unref(){g.oldVersion=this._feature;const e=this._refCount;if(!(e>0)){const e=`Unref feature with no references: ${this.feature?.uid}`;throw new t(e,e,(new Error).stack?.slice(6))}return this._refCount=e-1,1===e?(g.newVersion=null,g):(g.newVersion=this._feature,g)}get feature(){return this._feature}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FeatureTile":function(){define(["exports","../../../../core/arrayUtils","../../../../core/memoryEstimations","../../../../core/signal","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../graphics/graphicUtils"],(function(e,t,r,i,s,n,o,a){"use strict";var l,c;e.FetchStatus=void 0,(l=e.FetchStatus||(e.FetchStatus={}))[l.FETCH_NEEDED=0]="FETCH_NEEDED",l[l.REFETCH_NEEDED=1]="REFETCH_NEEDED",l[l.FETCHING=2]="FETCHING",l[l.REFETCHING=3]="REFETCHING",l[l.DONE=4]="DONE",l[l.FULL=5]="FULL",e.ReduceMode=void 0,(c=e.ReduceMode||(e.ReduceMode={}))[c.SIZE=0]="SIZE",c[c.RANDOM=1]="RANDOM";class u{constructor(e,t,i,s){this.features=t,this.numFeatures=i,this.emptyFeatureRatio=s,this.cachedMemory=r.baseObjectMemory+e.estimatedSize,this.resolution=e.displayingResolution,this.availableFields=e.availableFields,this.fetchStatus=e.fetchStatus,this.exceededTransferLimit=e.exceededTransferLimit.value,this.fetchInformation=e.fetchInformation.value}}const d=n.create(),h=s.create();e.FeatureTile=class{constructor(t){this.descriptor=t,this._numVertices=0,this.exceededTransferLimit=i.signal(!1),this._fetchFailed=i.signal(!1),this._sorted=!1,this._numFeatures=i.signal(-1),this._emptyFeatureRatio=i.signal(0),this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._displayingFeatures=null,this.alive=!0,this.filtered=!1,this._features=null,this._featuresLength=i.signal(0),this._featureLimit=i.signal(0),this._fetchStatus=e.FetchStatus.FETCH_NEEDED,this.fetchInformation=i.signal(""),this.fetchingResolution=this.displayingResolution=t.resolution}get featuresMissing(){return this.fetchFailed||(this.hasPreciseFeatureCount?this._featuresLength.value<this.numFeatures:this.exceededTransferLimit.value)}get showsAllFeatures(){return!this.fetchFailed&&null!=this.displayingFeatures&&(this.hasPreciseFeatureCount?this.displayingFeatures.length===this.numFeatures:!this.exceededTransferLimit.value)}get missingAttributes(){return this._missingAttributes}get fetchFailed(){return this._fetchFailed.value}set fetchFailed(e){this._fetchFailed.value=e}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){const e=this.isFetched&&this.featuresMissing;return!this.filtered&&(e||this.hasFeatureLimit)}get features(){return this._features}get featureLimit(){return this._featureLimit.value}set featureLimit(e){this._featureLimit.value!==e&&(this._featureLimit.value=e,this._estimatedUnusedSizeDirty=!0)}get hasFeatureLimit(){return this.featureLimit!==this._featuresLength.value}get availableFields(){return this._availableFields}setFeatures(e,t,r,i){this._availableFields=r,this._features=e,this._featuresLength.value=e?.length??0,this._sorted=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this._missingAttributes=i,e&&e.length>0?(this._emptyFeatureRatio.value=t/(e.length+t),this._numVertices=e.reduce(((e,t)=>e+o.numVertices(t.geometry)),0)):(this._emptyFeatureRatio.value=0,this._numVertices=0)}computeZQuantizationFactor(){if(this._features&&this._features.length>0){const e=this._features.reduce(((e,{geometry:t})=>Math.max(e,a.computeMaxZ(t)??0)),0);return Math.floor(e/this.descriptor.planetRadius)+1}return 1}get emptyFeatureRatio(){return this._emptyFeatureRatio.value}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures.value:this._features?this._featuresLength.value:0}set numFeatures(e){this._numFeatures.value=e}get hasPreciseFeatureCount(){return this._numFeatures.value>-1}get needsFeatureCount(){return-1===this._numFeatures.value}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let e=0;e<this._features.length;++e){const t=o.estimateSize(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let e=this.featureLimit;e<this._features.length;++e)this._estimatedUnusedSize+=o.estimateSize(this._features[e]);return!0}return!1}get fetchStatus(){return this._fetchStatus}requestFetch(){this._fetchStatus=e.FetchStatus.FETCH_NEEDED}requestRefetch(){this._fetchStatus=e.FetchStatus.REFETCH_NEEDED}startFetch(){this._fetchStatus=this.needsRefetch?e.FetchStatus.REFETCHING:e.FetchStatus.FETCHING}fetchDone(e){this._fetchStatus=e}get isFetching(){return this._fetchStatus===e.FetchStatus.FETCHING||this._fetchStatus===e.FetchStatus.REFETCHING}get isRefetching(){return this._fetchStatus===e.FetchStatus.REFETCHING}get needsFetch(){return this._fetchStatus===e.FetchStatus.FETCH_NEEDED||this._fetchStatus===e.FetchStatus.REFETCH_NEEDED}get needsRefetch(){return this._fetchStatus===e.FetchStatus.REFETCH_NEEDED}get isFetched(){return this._fetchStatus===e.FetchStatus.DONE||this._fetchStatus===e.FetchStatus.FULL}isFullyFetched(t){return!!this.features&&(this.features.length>=t||this.fetchStatus===e.FetchStatus.FULL)}resetFetching(){this._fetchStatus=this.isRefetching?e.FetchStatus.REFETCH_NEEDED:e.FetchStatus.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!function(e,t,r){if(null==t||null==e||r!==t.length||r>e.length)return!1;for(let i=0;i<r;++i)if(e[i]!==t[i])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(e){return null==e||!this.descriptor.extent||(n.fromExtent(e,d),n.intersects(this.descriptor.extent,d))}intersectionIncludingBorrowed(e,t){const r=null!=this.extentIncludingBorrowedFeatures?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||r?(null!=e?(n.fromExtent(e,t),n.intersection(t,r,t)):n.copy(t,r),t):(n.copy(t,n.positiveInfinity),t)}_shuffle(e){this._features?.sort(((t,r)=>o.getObjectId(t,e)-o.getObjectId(r,e))),t.shuffle(this._features,16438)}_sortBySize(e){this._features?.sort(((t,r)=>s.diameter(o.computeAABB(r.geometry,h))-s.diameter(o.computeAABB(t.geometry,h))||o.getObjectId(t,e)-o.getObjectId(r,e)))}reduceFeatures(t,r,i,s){if(t<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let n=!1;this.featureLimit=Math.ceil(this.numFeatures*t),this.featureLimit>this._features.length&&this._fetchStatus===e.FetchStatus.DONE&&this._features.length>0&&(this._fetchStatus=e.FetchStatus.REFETCH_NEEDED,n=!0),!this._sorted&&t<1&&(s===e.ReduceMode.RANDOM?this._shuffle(i):this._sortBySize(i),this._sorted=!0,this._estimatedUnusedSizeDirty=!0);const o=Math.max(this.featureLimit,Math.ceil(r*this.numFeatures));return this._features.length>o&&(this._features.length=o,this._featuresLength.value=o,this.exceededTransferLimit.value=!1,this._fetchStatus===e.FetchStatus.FULL&&(this._fetchStatus=e.FetchStatus.DONE)),n}get cache(){return new u(this,this._features,this._numFeatures.value,this._emptyFeatureRatio.value)}set cache(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._featuresLength.value=e.features?.length??0,this._numFeatures.value=e.numFeatures,this._emptyFeatureRatio.value=e.emptyFeatureRatio,this._fetchStatus=e.fetchStatus,this.exceededTransferLimit.value=e.exceededTransferLimit,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this.fetchInformation.value=e.fetchInformation}},e.FeatureTileCacheItem=u,e.failedFeatureCount=-2,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FeatureTileFetcher3DDebugger":function(){define(["exports","../../../../Color","../../../../Graphic","../../../../core/Collection","../../../../core/Handles","../../../../core/reactiveUtils","../../../../geometry/Polygon","../../../../symbols/FillSymbol3DLayer","../../../../symbols/PointSymbol3D","../../../../symbols/PolygonSymbol3D","../../../../symbols/TextSymbol3DLayer","../../../../symbols/callouts/LineCallout3D","../../../../symbols/callouts/LineCallout3DBorder","../../../../symbols/support/Symbol3DVerticalOffset","../../terrain/TilingScheme"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";const f=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];e.FeatureTileFetcher3DDebugger=class{constructor(e,t,r){this._tileFetcher=e,this._view=r,this._handles=new s,this._loadingGraphics=new Map,this._loadingSymbols=[new c({symbolLayers:new i([new a({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}})])})],this._loadedGraphics=new Map,this._loadedSymbols=f.map((e=>new c({symbolLayers:new i([new a({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}})])}))),this._pendingGraphics=new Map,this._pendingSymbols=[new c({symbolLayers:new i([new a({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}})])})],this._dataExtentGraphic=null,this._dataExtentSymbol=new c({symbolLayers:new i([new a({material:{color:[0,0,0,0]},outline:{color:"green",size:4}})])}),this._enabled=!0,this._tilingScheme=new m.TilingScheme(t),this.update()}destroy(){this.enabled=!1,this._handles.destroy()}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.update()}update(){this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:({isFetching:e})=>e,symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:e=>!e.isFetching,symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:({isFetching:e})=>!e,symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach((e=>this._view.graphics.removeMany(e))),this._loadingGraphics.clear(),this._loadedGraphics.forEach((e=>this._view.graphics.removeMany(e))),this._loadedGraphics.clear(),this._pendingGraphics.forEach((e=>this._view.graphics.removeMany(e))),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}showDataExtent(e){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),null==e)return;const t=o.fromExtent(e);this._dataExtentGraphic=new r({geometry:t,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}_synchronizeMaps(e,t){const r=this._tileFetcher.featureTiles;e.forEach(((i,s)=>{const n=r.get(s);n&&t.filter(n)||(this._view.graphics.removeMany(i),e.delete(s))})),this._handles.removeAll(),r.forEach((r=>{t.filter(r)&&!e.has(r.id)&&this._handles.add(n.watch((()=>r.fetchInformation),(()=>this._showTile(r,e,t)),n.initial))}))}_showTile(e,s,n){const[o,a,c]=e.descriptor.lij,{numFeatures:m,featureLimit:f,features:g}=e;this._tilingScheme.ensureMaxLod(o);const y=this._tilingScheme.getExtentGeometry(o,a,c),_=new r({geometry:y,symbol:n.symbols[o%n.symbols.length]}),b=`Tile ${e.id}\nloaded/limit/total\n${g?.length}/${f}/${m}\nres ${Math.round(e.displayingResolution)} ${e.featuresMissing?"some":"all"}\n${e.fetchInformation.value}`,v=new r({geometry:y.center,symbol:new l({verticalOffset:new p({screenLength:40/.75}),callout:new d({color:new t("white"),border:new h({color:new t("black")})}),symbolLayers:new i([new u({text:b,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})])})}),S=s.get(e.id);S&&this._view.graphics.removeMany(S);const w=[_,v];s.set(e.id,w),this._view.graphics.addMany(w)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/FeatureLayerViewPerformanceInfo":function(){define(["exports","./support/LayerViewPerformanceInfo"],(function(e,t){"use strict";class r extends t.LayerViewPerformanceInfo{constructor(e,t,r,i,s,n){super(e.usedMemory,e.displayedFeatures,e.totalFeatures,e.maximumFeatures,e.nodes,e.core),this.storedFeatures=t,this.totalVertices=r,this.partial=i,this.mode=s,this.symbolComplexity=n}}e.FeatureLayerViewPerformanceInfo=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DGraphicsPipeline":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Error","../../../../core/maybe","../../../../core/Promise","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../layers/graphics/controllers/FeatureTileController3D","../../../../symbols/support/utils","./elevationAlignPointsInFeatures","./Graphics3DFeatureProcessor","./QueryEngine","./QueryEngineContext","./queryForSymbologySnapping","../support/HeatmapFeatureProcessor","../support/LayerViewPerformanceInfo","../../webgl-engine/lib/UpdatePolicy","../../../support/layerViewUtils","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x){"use strict";var T;e.Graphics3DGraphicsPipeline=class extends s{constructor(e){super(e),this._dataUpdatingState=T.NONE,this.graphicsQuery={queryForSymbologySnapping:async(e,t)=>this.symbologySnappingSupported?_.queryForSymbologySnapping(this.graphics3DProcessor,e,t):{candidates:[],sourceCandidateIndices:[]},executeQuery:(e,t)=>this.queryEngine.executeQuery(e,t),executeQueryForIds:(e,t)=>this.queryEngine.executeQueryForIds(e,t),executeQueryForCount:(e,t)=>this.queryEngine.executeQueryForCount(e,t),executeQueryForExtent:(e,t)=>this.queryEngine.executeQueryForExtent(e,t),executeQueryForLatestObservations:(e,t)=>this.queryEngine.executeQueryForLatestObservations(e,t)},this.controller=null,this.updatingHandles=new d.UpdatingHandles,this._controllerCreated=!1,this._pendingController=null}initialize(){this.addResolvingPromise(this._initializeController()),this.updatingHandles.add((()=>this.layer.renderer),(e=>this._recreateProcessor(e)),n.initial),this.updatingHandles.add((()=>this.updatePolicy),(e=>this.processor.preferredUpdatePolicy=e));const{layer:e,view:t,hasM:r,hasZ:i}=this,{spatialReference:s,resourceController:o}=t,a=new y.QueryEngineContext(s,e,o,(()=>this.processor.featureStore),i,r);this.queryEngine=new g.QueryEngine({context:a,priority:x.TaskPriority.FEATURE_QUERY_ENGINE})}destroy(){this.removeAllHandles(),this.updatingHandles.destroy(),this._destroyPendingController(),this.controller=i.destroyMaybe(this.controller),this.processor=i.destroyMaybe(this.processor),this.queryEngine=i.destroyMaybe(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this._pendingController=i.destroyMaybe(this._pendingController)}get updating(){return this.updatingHandles.updating||!this._controllerCreated||this.controller?.updating||this.processor?.updating}get legendEnabled(){return this.processor.legendEnabled}get layer(){return this.layerView.layer}get layerViewUid(){return this.layerView.uid}get view(){return this.layerView.view}get hasZ(){return this.layerView.hasZ}get hasM(){return this.layerView.hasM}get fullOpacity(){return this.layerView.fullOpacity}get suspended(){return this.layerView.suspended}get filter(){return"filter"in this.layerView?this.layerView.filter:null}get effectiveDisplayFilter(){return"effectiveDisplayFilter"in this.layerView?this.layerView.effectiveDisplayFilter:null}get slicePlaneEnabled(){return this.layerView.slicePlaneEnabled}get featureSpatialReference(){return"featureSpatialReference"in this.layerView?this.layerView.featureSpatialReference:null}get graphics3DProcessor(){return"graphics-3d"===this.processor?.type?this.processor:null}get heatmapProcessor(){return"heatmap"===this.processor?.type?this.processor:null}get hasAllFeatures(){return!(!this.controller||!("hasAllFeatures"in this.controller))&&this.controller.hasAllFeatures}get hasAllFeaturesInView(){return!(!this.controller||!("hasAllFeaturesInView"in this.controller))&&this.controller.hasAllFeaturesInView}get hasFullGeometries(){return!(!this.controller||!("hasFullGeometries"in this.controller))&&this.controller.hasFullGeometries}get symbologySnappingSupported(){return this.layer?.renderer?.symbols?.some(p.symbolHasExtrudeSymbolLayer)??!1}get updatePolicy(){return S.UpdatePolicy.SYNC}get scaleVisibilitySuspended(){return this.processor?.scaleVisibilitySuspended}get timeExtent(){return"timeExtent"in this.layerView?this.layerView.timeExtent:null}get dataUpdating(){return this._dataUpdatingState!==T.NONE}get suspendInfo(){return this.processor?.suspendInfo??{}}forEachGraphic(e){this.loadedGraphics.forEach(e)}findGraphic(e){return this.loadedGraphics.find(e)}queryObjectIds(e,t){return this.layerView.queryObjectIds(e,t)}whenGraphicBounds(e,t){return this.processor?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor?.computeAttachmentOrigin(e,t)}async elevationAlignPointsInFeatures(e,t){const i=this.graphics3DProcessor;if(null==i)throw new r("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return m.elevationAlignPointsInFeatures(this.view,this.layer,(e=>i.getGraphics3DGraphicByObjectId(e)),e,t)}highlight(e,t){return this.processor.highlight(e,this.layer.objectIdField,t)}maskOccludee(e){return this.processor.maskOccludee(e)}notifyContentGeometryUpdate(){this.layerView.emit("visible-geometry-changed")}async _initializeController(){const e=this.createController();this._pendingController=e,this._setupDataUpdating(e),await e.when(),this._setControllerWhenInitialized(e)}_setupDataUpdating(e){"dataUpdating"in e&&this.addHandles([n.watch((()=>e.dataUpdating),(e=>{e&&this._dataUpdatingState===T.NONE?this._dataUpdatingState=T.CONTROLLER:e||this._dataUpdatingState!==T.CONTROLLER||(this._dataUpdatingState=T.NONE)}),n.sync),n.watch((()=>!!this.graphics3DProcessor?.dataUpdating),(t=>{t&&this._dataUpdatingState===T.CONTROLLER?this._dataUpdatingState=T.CORE:t||this._dataUpdatingState!==T.CORE||(this._dataUpdatingState=e.dataUpdating?T.CONTROLLER:T.NONE)}),n.sync)])}async _setControllerWhenInitialized(e){try{await this.when()}catch(e){}this._controllerCreated=!0,this.isResolved()&&!this.destroyed?(await n.whenOnce((()=>this.view?.basemapTerrain?.ready)),this.beforeSetController(e),this._pendingController=null,this.controller=e,this.loadedGraphics=e.graphics):this._destroyPendingController()}_recreateProcessor(e){const t="heatmap"===e?.type,r="heatmap"===this.processor?.type,i=this.processor;if(i&&t===r)return;const s=t?new b.HeatmapFeatureProcessor({owner:this}):new f.Graphics3DFeatureProcessor({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!w.hasLayerBasedScaleVisibility(),filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:e=>this._updateClippingExtent(e)});this.processor=s,i?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(s.when())}_updateClippingExtent(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}get usedMemory(){return this.processor?.usedMemory??0}get performanceInfo(){const e=this.controller instanceof h.FeatureTileController3D?this.controller:null;return new v.LayerViewPerformanceInfo(this.usedMemory,this.loadedGraphics?.length,e?.serviceDataCount??-1,e?.maximumNumberOfFeatures??-1,0,this.processor.performanceInfo)}},t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"updating",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"legendEnabled",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"layerView",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"layer",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"layerViewUid",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"view",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasZ",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasM",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"fullOpacity",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"suspended",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"filter",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"effectiveDisplayFilter",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"slicePlaneEnabled",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"featureSpatialReference",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"loadedGraphics",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"graphics3DProcessor",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"heatmapProcessor",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasAllFeatures",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasAllFeaturesInView",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"hasFullGeometries",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"symbologySnappingSupported",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"updatePolicy",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"scaleVisibilitySuspended",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"timeExtent",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"_dataUpdatingState",void 0),t.__decorate([o.property({readOnly:!0})],e.Graphics3DGraphicsPipeline.prototype,"dataUpdating",null),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"controller",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"processor",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"updatingHandles",void 0),t.__decorate([o.property()],e.Graphics3DGraphicsPipeline.prototype,"_controllerCreated",void 0),e.Graphics3DGraphicsPipeline=t.__decorate([u.subclass("esri.views.3d.layers.graphics.Graphics3DGraphicsPipeline")],e.Graphics3DGraphicsPipeline),function(e){e[e.NONE=0]="NONE",e[e.CONTROLLER=1]="CONTROLLER",e[e.CORE=2]="CORE"}(T||(T={})),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/symbols/support/utils":function(){define(["require","exports","../../Color","../../core/asyncUtils","../../core/has","../../core/screenUtils","../../core/libs/gl-matrix-2/factories/vec3f64","../../layers/effects/jsonUtils","./cimSymbolUtils","./gfxUtils","./Symbol3DMaterial","./typeUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=new r("white");function p(e,t){if(null==t||null==e)return e;const i=e.toRgba();return i[3]=i[3]*t,new r(i)}function m(e){for(const t of e)if("number"==typeof t)return t;return null}function f(e,t,r){for(let i=0;i<3;i++){const s=e[i];switch(s){case"symbol-value":{const e=r[i];return null!=e?e/t[i]:1}case"proportional":break;default:if(s&&t[i])return s/t[i]}}return null}function g(e,t,r,i){switch(e){case"proportional":return r*i;case"symbol-value":return null!=t?t:r;default:return e}}t.applyColorToSymbol=function(e,t,i){e&&(t||null!=i)&&(t&&(t=new r(t)),d.isSymbol3D(e)?function(e,t,r){const i=e.symbolLayers;if(!i)return;const s=e=>p(t??e??(null!=r?h:null),r);i.forEach((e=>{if("object"!==e.type||!e.resource?.href||t)if("water"===e.type)e.color=s(e.color);else{const t=null!=e.material?e.material.color:null,i=s(t);if(null==e.material?e.material=new u.Symbol3DMaterial({color:i}):e.material.color=i,null!=r&&"outline"in e&&null!=e.outline?.color&&(e.outline.color=p(e.outline.color,r)),"marker"in e&&null!=e.marker){const t=s(e.marker.color);e.marker.color=t}}}))}(e,t,i):d.isSymbol2D(e)&&function(e,t,r){(t=t??e.color)&&(e.color=p(t,r)),null!=r&&"outline"in e&&e.outline?.color&&(e.outline.color=p(e.outline.color,r))}(e,t,i))},t.applyOpacityToColor=p,t.applyRotationToSymbol=function(e,t,r){if(e&&null!=t)if(d.isSymbol3D(e)){const i=e.symbolLayers;i&&i.forEach((e=>{if("object"===e.type)switch(r){case"tilt":e.tilt=(e.tilt??0)+t;break;case"roll":e.roll=(e.roll??0)+t;break;default:e.heading=(e.heading??0)+t}"icon"===e.type&&(e.angle+=t)}))}else d.isSymbol2D(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle+=t))},t.applySizesToSymbol=async function(t,r){if(t&&r)return d.isSymbol3D(t)?async function(t,r){const s=t.symbolLayers;s&&await i.forEach(s,(async t=>async function(t,r){switch(t.type){case"extrude":!function(e,t){const r=t[2];"number"==typeof r&&(e.size=r)}(t,r);break;case"icon":case"line":case"text":!function(e,t){const r=m(t);null!=r&&(e.size=r)}(t,r);break;case"path":!function(e,t){const r=f(t,o.ONES,[e.width,void 0,e.height]);null!=r&&(e.width=g(t[0],e.width,1,r),e.height=g(t[2],e.height,1,r))}(t,r);break;case"object":await async function(t,r){const{resourceSize:i,symbolSize:s}=await async function(t){const{computeObjectLayerResourceSize:r}=await new Promise(((t,r)=>e(["./symbolLayerUtils"],t,r))),i=await r(t,10),{width:s,height:n,depth:o}=t,a=[s,o,n];let l=1;for(let e=0;e<3;e++){const t=a[e];if(null!=t){l=t/i[e];break}}for(let e=0;e<3;e++)null==a[e]&&(a[e]=i[e]*l);return{resourceSize:i,symbolSize:a}}(t),n=f(r,i,s);null!=n&&(t.width=g(r[0],s[0],i[0],n),t.depth=g(r[1],s[1],i[1],n),t.height=g(r[2],s[2],i[2],n))}(t,r)}}(t,r)))}(t,r):void(d.isSymbol2D(t)&&function(e,t){const r=m(t);if(null!=r)switch(e.type){case"simple-marker":e.size=r;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=r,e.height=r*t):(e.width=r*t,e.height=r);break}case"simple-line":e.width=r;break;case"text":e.font.size=r}}(t,r))},t.getCSSFilterFromEffectList=function(e){if(!e)return null;const t=e.effects.filter((e=>"bloom"!==e.type)).map((e=>e.toJSON()));return a.effectFunctionsFromJSON(t)},t.getColorFromSymbol=function(e,t){if(!e)return null;let i=null;return d.isSymbol3D(e)?i=function(e){const t=e.symbolLayers;if(!t)return null;let i=null;return t.forEach((e=>{"object"===e.type&&e.resource?.href||(i="water"===e.type?e.color:e.material?e.material.color:null)})),i?new r(i):null}(e):d.isSymbol2D(e)&&(i="cim"===e.type?l.getCIMSymbolColor(e):e.color?new r(e.color):null),i?p(i,t):null},t.getIconHref=function(e){return e.resource?.href??""},t.getSymbolOutlineColor=function(e){if(!e)return null;if(d.isSymbol3D(e))return function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.color}(e);const t=c.getStroke(e)?.color;return t?new r(t):null},t.getSymbolOutlineSize=function(e){if(!e)return 0;if(d.isSymbol3D(e)){const t=function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.size}(e);return null!=t?t:0}return n.px2pt(c.getStroke(e)?.width)},t.isVolumetricSymbol=function(e){if(null==e||!("symbolLayers"in e)||null==e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}},t.symbolHasExtrudeSymbolLayer=function(e){return null!=e&&"polygon-3d"===e.type&&e.symbolLayers.some((e=>"extrude"===e.type))},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/symbols/support/cimSymbolUtils":function(){define(["exports","../../Color","../cim/utils"],(function(e,t,r){"use strict";function i(e){const t=r.toCIMSymbolJSON(e);if("CIMTextSymbol"===t?.type)return t.height??0;let i=0;if(t?.symbolLayers)for(const e of t.symbolLayers)r.isCIMMarker(e)&&null!=e.size&&e.size>i?i=e.size:r.isCIMStroke(e)&&null!=e.width&&e.width>i?i=e.width:r.isCIMFill(e);return i}function s(e,t,r,i){if(e)if("CIMTextSymbol"!==e.type){if(r&&e.effects)for(const r of e.effects)o(r,t);if(e.symbolLayers)for(const r of e.symbolLayers){switch(r.type){case"CIMPictureMarker":case"CIMVectorMarker":n(r,t,i);break;case"CIMPictureStroke":case"CIMSolidStroke":case"CIMGradientStroke":!i?.preserveOutlineWidth&&r.width&&(r.width*=t);break;case"CIMPictureFill":r.height&&(r.height*=t),r.offsetX&&(r.offsetX*=t),r.offsetY&&(r.offsetY*=t);break;case"CIMHatchFill":s(r.lineSymbol,t,!0,{...i,preserveOutlineWidth:!1}),r.offsetX&&(r.offsetX*=t),r.offsetY&&(r.offsetY*=t),r.separation&&(r.separation*=t)}if(r.effects)for(const e of r.effects)o(e,t)}}else null!=e.height&&(e.height*=t)}function n(e,t,i){if(e&&(e.markerPlacement&&function(e,t){switch(r.isCIMMarkerStrokePlacement(e)&&e.offset&&(e.offset*=t),e.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.placementTemplate&&e.placementTemplate.length){const r=e.placementTemplate.map((e=>e*t));e.placementTemplate=r}break;case"CIMMarkerPlacementAlongLineVariableSize":if(e.maxRandomOffset&&(e.maxRandomOffset*=t),e.placementTemplate&&e.placementTemplate.length){const r=e.placementTemplate.map((e=>e*t));e.placementTemplate=r}break;case"CIMMarkerPlacementOnLine":e.startPointOffset&&(e.startPointOffset*=t);break;case"CIMMarkerPlacementAtExtremities":e.offsetAlongLine&&(e.offsetAlongLine*=t);break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":e.beginPosition&&(e.beginPosition*=t),e.endPosition&&(e.endPosition*=t);break;case"CIMMarkerPlacementPolygonCenter":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMMarkerPlacementInsidePolygon":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.stepX&&(e.stepX*=t),e.stepY&&(e.stepY*=t)}}(e.markerPlacement,t),e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.anchorPoint&&"Absolute"===e.anchorPointUnits&&(e.anchorPoint={x:e.anchorPoint.x*t,y:e.anchorPoint.y*t}),e.size=null!=e.size?e.size*t:0,"CIMVectorMarker"===e.type&&e.markerGraphics))for(const r of e.markerGraphics)e.scaleSymbolsProportionally||s(r.symbol,t,!0,i)}function o(e,t){switch(e.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":e.width&&(e.width*=t);break;case"CIMGeometricEffectBuffer":e.size&&(e.size*=t);break;case"CIMGeometricEffectCut":e.beginCut&&(e.beginCut*=t),e.endCut&&(e.endCut*=t),e.middleCut&&(e.middleCut*=t);break;case"CIMGeometricEffectDashes":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.dashTemplate&&e.dashTemplate.length){const r=e.dashTemplate.map((e=>e*t));e.dashTemplate=r}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":e.length&&(e.length*=t);break;case"CIMGeometricEffectMove":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":e.offset&&(e.offset*=t);break;case"CIMGeometricEffectRegularPolygon":e.radius&&(e.radius*=t);break;case"CIMGeometricEffectTaperedPolygon":e.fromWidth&&(e.fromWidth*=t),e.length&&(e.length*=t),e.toWidth&&(e.toWidth*=t);break;case"CIMGeometricEffectWave":e.amplitude&&(e.amplitude*=t),e.period&&(e.period*=t)}}function a(e,t){if(!e)return;let i;i="CIMTextSymbol"===e.type?e.symbol:e;const s="CIMPolygonSymbol"===e.type;if(i?.symbolLayers)for(const e of i.symbolLayers)if(!(e.colorLocked||s&&(r.isCIMStroke(e)||r.isCIMMarker(e)&&e.markerPlacement&&r.isCIMMarkerStrokePlacement(e.markerPlacement))))switch(e.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":e.tintColor&&l(t,e.tintColor);break;case"CIMVectorMarker":e.markerGraphics?.forEach((e=>{a(e.symbol,t)}));break;case"CIMSolidStroke":case"CIMSolidFill":l(t,e.color);break;case"CIMGradientFill":c(t,e);break;case"CIMHatchFill":a(e.lineSymbol,t)}}function l(e,t){for(const r of e)if(r.join(".")===t.join("."))return;e.push(t)}function c(e,t){const r=t.colorRamp?.type;switch(r){case"CIMMultipartColorRamp":t.colorRamp.colorRamps?.forEach((t=>{"CIMLinearContinuousColorRamp"===t.type&&u(e,t)}));break;case"CIMLinearContinuousColorRamp":case"CIMPolarContinuousColorRamp":u(e,t.colorRamp)}}function u(e,t){t&&(t.fromColor&&l(e,t.fromColor),t.toColor&&l(e,t.toColor))}function d(e,t,i){if(!e)return;let s;s="CIMTextSymbol"===e.type?e.symbol:e;const n="CIMPolygonSymbol"===s?.type;if(s?.symbolLayers)for(const e of s.symbolLayers){if(e.colorLocked)continue;if(n)if(i){const{layersToColor:t}=i;if((r.isCIMStroke(e)||r.isCIMMarker(e)&&e.markerPlacement&&r.isCIMMarkerStrokePlacement(e.markerPlacement))&&"fill"===t||r.isCIMFill(e)&&"outline"===t)continue}else if(r.isCIMStroke(e)||r.isCIMMarker(e)&&e.markerPlacement&&r.isCIMMarkerStrokePlacement(e.markerPlacement))continue;const s=t.toArray();switch(e.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":e.tintColor=s;break;case"CIMVectorMarker":e.markerGraphics?.forEach((e=>{d(e.symbol,t,i)}));break;case"CIMSolidStroke":case"CIMSolidFill":e.color=s;break;case"CIMGradientFill":h(e,t);break;case"CIMHatchFill":d(e.lineSymbol,t,i)}}}function h(e,t){const r=e.colorRamp?.type;switch(r){case"CIMMultipartColorRamp":e.colorRamp.colorRamps?.forEach((e=>{"CIMLinearContinuousColorRamp"===e.type&&p(e,t)}));break;case"CIMLinearContinuousColorRamp":case"CIMPolarContinuousColorRamp":p(e.colorRamp,t)}}function p(e,t){if(e&&(e.fromColor&&(e.fromColor=t.toArray()),e.toColor)){const r=t.clone();r.a=0,e.toColor=r.toArray()}}e.applyCIMSymbolColor=function(e,i,s){i instanceof t||(i=new t(i));const n=r.toCIMSymbolJSON(e);n&&d(n,i,s)},e.applyCIMSymbolRotation=function(e,t,i=!1){const s=r.toCIMSymbolJSON(e);if(i&&(t=360-t),"CIMTextSymbol"!==s?.type){if("CIMPointSymbol"===s?.type&&s.symbolLayers){const e=t-(s.angle||0);for(const t of s.symbolLayers)if(r.isCIMMarker(t)){let r=t.rotation||0;t.rotateClockwise?r-=e:r+=e,t.rotation=r}s.angle=t}}else s.angle=t},e.getCIMSymbolColor=function(e){const i=[];return a(r.toCIMSymbolJSON(e),i),i.length?new t(r.normalizeAlpha(i[0])):null},e.getCIMSymbolRotation=function(e,t=!1){const i=r.toCIMSymbolJSON(e);if("CIMTextSymbol"===i?.type||"CIMPointSymbol"===i?.type){const e=i.angle;return null!=e&&t?360-e:e??0}return 0},e.getCIMSymbolSize=i,e.getCIMSymbolType=function(e){const t=r.toCIMSymbolJSON(e);if(!t)return null;switch(t.type){case"CIMPointSymbol":return"CIMPointSymbol";case"CIMLineSymbol":return"CIMLineSymbol";case"CIMPolygonSymbol":return"CIMPolygonSymbol";case"CIMTextSymbol":return"CIMTextSymbol";case"CIMMeshSymbol":return"CIMMeshSymbol";default:return null}},e.scaleCIMMarker=n,e.scaleCIMSymbol=s,e.scaleCIMSymbolTo=function(e,t,n){if(!e)return;const o=r.toCIMSymbolJSON(e),a=i(e);0!==a?s(o,t/a,!1,n):function(e,t){if(e)if("CIMTextSymbol"!==e.type){if(e.symbolLayers)for(const r of e.symbolLayers)switch(r.type){case"CIMPictureMarker":case"CIMVectorMarker":r.size=t;break;case"CIMPictureStroke":case"CIMSolidStroke":case"CIMGradientStroke":r.width=t}}else e.height=t}(o,t)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/symbols/support/gfxUtils":function(){define(["exports","../../assets","../../Color","../../request","../../core/LRUCache","../../core/screenUtils","./cimSymbolUtils"],(function(e,t,r,i,s,n,o){"use strict";const a="picture-fill",l="simple-fill",c="simple-marker",u=new Map([["dash",[4,3]],["dashdot",[4,3,1,3]],["dot",[1,3]],["longdash",[8,3]],["longdashdot",[8,3,1,3]],["longdashdotdot",[8,3,1,3,1,3]],["shortdash",[4,1]],["shortdashdot",[4,1,1,1]],["shortdashdotdot",[4,1,1,1,1,1]],["shortdot",[1,1]],["solid",[]]]),d=new s.LRUCache(1e3);function h(e){if(!e?.style)return[];const{dashArray:t,style:r,width:i}=e;if("string"==typeof t&&"none"!==t)return t.split(",").map((e=>Number(e)));const s=i??0,n=u.has(r)?u.get(r).map((e=>e*s)):[];if("butt"!==e.cap)for(const[e,t]of n.entries())n[e]=e%2==1?t+s:Math.max(t-s,1);return n}const p=(()=>{const e={};return t=>{if(e[t])return e[t];const r=t.replaceAll("-","");return e[t]=r,r}})(),m=new r([128,128,128]);e.defaultThematicColor=m,e.dekebabifyLineStyle=p,e.getDashArray=h,e.getFill=function(e){const r=e.style;let i=null;if(e)switch(e.type){case c:"cross"!==r&&"x"!==r&&(i=e.color);break;case l:r&&"solid"!==r?"none"!==r&&(i={type:"pattern",x:0,y:0,src:t.getAssetUrl(`esri/symbols/patterns/${r}.png`),width:5,height:5}):i=e.color;break;case a:i={type:"pattern",src:e.url,width:n.pt2px(e.width)*e.xscale,height:n.pt2px(e.height)*e.yscale,x:n.pt2px(e.xoffset),y:n.pt2px(e.yoffset)};break;case"text":i=e.color;break;case"cim":i=o.getCIMSymbolColor(e)}return i},e.getPatternUrlWithColor=function(e,t){const r=e+"-"+t;return void 0!==d.get(r)?Promise.resolve(d.get(r)):i(e,{responseType:"image"}).then((e=>{const i=e.data,s=i.naturalWidth,n=i.naturalHeight,o=document.createElement("canvas");o.width=s,o.height=n;const a=o.getContext("2d");a.fillStyle=t,a.fillRect(0,0,s,n),a.globalCompositeOperation="destination-in",a.drawImage(i,0,0);const l=o.toDataURL();return d.put(r,l),l}))},e.getStroke=function e(t){if(!t)return null;let r=null;switch(t.type){case l:case a:case c:r=e(t.outline);break;case"simple-line":{const e=n.pt2px(t.width);null!=t.style&&"none"!==t.style&&0!==e&&(r={color:t.color,style:p(t.style),width:e,cap:t.cap,join:"miter"===t.join?n.pt2px(t.miterLimit):t.join},r.dashArray=h(r).join(",")||"none");break}default:r=null}return r},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/elevationAlignPointsInFeatures":function(){define(["exports","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/SpatialReference","../../../../geometry/projection/projectPointToVector","../../../../layers/graphics/dehydratedPoint","../../../../support/elevationInfoUtils","./elevationAlignmentUtils","./ElevationContext","./featureExpressionInfoUtils"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";e.elevationAlignPointsInFeatures=async function(e,u,d,h,p){const{elevationProvider:m,renderCoordsHelper:f}=e,{elevationInfo:g}=u,{pointsInFeatures:y,spatialReference:_}=h,b=i.fromJSON(_),v=c.extractExpressionInfo(g,!0),S=await c.createContext(v,b,p);t.throwIfAborted(p);const w=[],x=new Set,T=new Set,C=new l.ElevationContext,P=n.makeDehydratedPoint(0,0,0,i.WGS84),M=new a.SampleElevationInfo,R=r.create();P.spatialReference=b;const E=e.elevationProvider.spatialReference??e.spatialReference;for(const{objectId:e,points:t}of y){const r=d(e);if(null==r){for(const e of t)w.push(e.z??0);x.add(e);continue}r.isDraped&&T.add(e);const i=r.graphic.geometry;C.setFromElevationInfo(o.getGeometryEffectiveElevationInfo(i,g)),C.updateFeatureExpressionInfoContext(S,r.graphic,u);for(const{x:e,y:r,z:i}of t)P.x=e,P.y=r,P.z=i??0,await s.projectPointToVectorAsync(P,R,E,0,{signal:p}),a.evaluateElevationInfoAtPoint(R,m,C,f,M),w.push(M.z)}return{elevations:w,drapedObjectIds:T,failedObjectIds:x}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DFeatureProcessor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../Graphic","../../../../arcade/functions/hash","../../../../core/compilerUtils","../../../../core/handleUtils","../../../../core/maybe","../../../../core/Promise","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/accessorSupport/diffUtils","../../../../core/support/UpdatingHandles","../../../../geometry/support/webMercatorUtils","../../../../renderers/support/renderingInfoUtils","../../../../rest/support/Query","../../../../support/arcadeExpressionUtils","../interfaces","./constants","./DisplayFeatureLimit","./Graphics3DCore","./Graphics3DElevationAlignment","./Graphics3DFrustumVisibility","./Graphics3DObjectStates","./Graphics3DScaleVisibility","./graphicUtils","../support/attributeUtils","../support/FeatureVisibilityFilter","../support/highlightUtils","../../webgl-engine/lib/UpdatePolicy","../../../support/HighlightDefaults"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D){"use strict";e.Graphics3DFeatureProcessor=class extends a{constructor(e){super(e),this.type="graphics-3d",this._updatingHandles=new f.UpdatingHandles,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=v.DrapeSourceType.Features,this.preferredUpdatePolicy=I.UpdatePolicy.ASYNC,this._suspendResumeExtent=null}initialize(){const e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==e.layer.geometryType,r=new x.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:t=>e.view.deconflictor.addGraphicsOwner(t),labeler:(t,r)=>e.view.labeler.addGraphicsOwner(t,r),elevationAlignment:this.elevationAlignmentEnabled?(t,r)=>new T.Graphics3DElevationAlignment({graphicsCoreOwner:this,graphicsCore:t,queryGraphicUIDsInExtent:r,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(t,r)=>new M.Graphics3DScaleVisibility({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:r,graphicsCore:t,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?t=>new O.FeatureVisibilityFilter({context:{...t,configuration:e}}):null,objectStates:e=>new P.Graphics3DObjectStates(e)}});this._set("graphicsCore",r),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new C.Graphics3DFrustumVisibility({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add((()=>this.layer.elevationInfo),((e,t)=>{m.diff(e,t)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})),this._updatingHandles.add((()=>this.layer.labelsVisible),(()=>this.graphicsCore.updateVisibilityInfo())),this._updatingHandles.add((()=>this.layer.labelingInfo),((e,t)=>{m.diff(e,t)&&this.graphicsCore.updateLabelingInfo()})),this._updatingHandles.add((()=>this.preferredUpdatePolicy),(e=>this.graphicsCore.preferredUpdatePolicy=e)),this.addResolvingPromise(this._initializeAsync())}async _initializeAsync(){await l.logOnError(this.graphicsCore.initializePromise);const e=this.owner;this._updatingHandles.add((()=>this.renderer),(e=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(e)))),this._updatingHandles.add((()=>e.fullOpacity),(()=>this.graphicsCore.opacityChange())),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add((()=>e.view.clippingArea),(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await l.logOnError(this.graphicsCore.updateLabelingInfo())}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",o.destroyMaybe(this.frustumVisibility)),this._set("graphicsCore",o.destroyMaybe(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get layerViewUid(){return this.owner.layerViewUid}get dataUpdating(){return this.graphicsCore?.dataUpdating??!1}get renderer(){const{renderer:e,objectIdField:t}=this.layer;if(!e||!t||"heatmap"===e.type||!e.visualVariables)return e;const r=e.visualVariables.findIndex((e=>"rotation"===e.type&&null!=e.valueExpression&&b.matchRandomRotationExpression(e.valueExpression)===t&&(null==e.axis||"heading"===e.axis)&&"geographic"===e.rotationType));if(r<0)return e;const i=e.clone();return i.visualVariables?(i.visualVariables.splice(r,1),this._randomRotationRenderers??=new WeakMap,this._randomRotationRenderers.set(i,t),i):e}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get filterVisibility(){return this.graphicsCore?.filterVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get suspendResumeExtentMode(){return this.owner.suspendResumeExtentMode??"computed"}get scaleVisibilitySuspended(){return null!=this.scaleVisibility&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return null==this.frustumVisibility||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),null!=this.frustumVisibility&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){return!!(this.graphicsCore?.updating||this.frustumVisibility?.updating||this._updatingHandles.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){const e=this.view.quality,t=this.graphicsCore?.displayFeatureLimit;if(1===e)return t;const r=Math.ceil(t.maximumNumberOfFeatures*e);return new w.DisplayFeatureLimit(t.maximumTotalNumberOfVertices,r,t.averageSymbolComplexity)}get usedMemory(){return this.graphicsCore?.usedMemory??0}get loadedFeatures(){return this.graphicsCore?.numberOfGraphics??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){const t=this.graphicsCore?.objectStates;if(!t)return n.makeHandle();const{set:r,handle:i}=t.acquireOccludeeSet(null);return t.setUid(r,e.uid),i}highlight(e,t=null,i){const s=this.graphicsCore?.objectStates;if(!s)return A.emptyHighlightHandle;if(i??=D.defaultHighlightName,e instanceof _){const{set:r,handle:n}=s.acquireHighlightSet(i,t);return this.owner.queryObjectIds(e).then((e=>s.setObjectIds(r,e))),n}let n=A.normalizeHighlightTargetExceptQuery(e);if(0===n.length)return A.emptyHighlightHandle;if(n[0]instanceof r){const e=n;if(null==E.attributeLookup(this.layer.fieldsIndex,e[0].attributes,t)){const t=e.map((e=>e.uid)),{set:r,handle:n}=s.acquireHighlightSet(i,null);return s.setUids(r,t),n}n=e.map((e=>E.attributeLookup(this.layer.fieldsIndex,e.attributes,t)))}if(A.isObjectId(n[0])){const e=n,{set:r,handle:o}=s.acquireHighlightSet(i,t);return s.setObjectIds(r,e),o}return A.emptyHighlightHandle}resetObjectStates(){this.graphicsCore?.objectStates?.reset()}whenGraphicBounds(e,t){return this.graphicsCore?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsCore?.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}notifyContentGeometryUpdate(){this.owner.notifyContentGeometryUpdate?.()}getRenderingInfo(e,t,r){const s=y.getRenderingInfo(e,{renderer:t,arcade:r});if(s?.color){const e=s.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}if(null!=s&&null!=t&&this._randomRotationRenderers?.has(t)){const r=this._randomRotationRenderers.get(t),n=e.attributes[r],o=new i.XXH(0);o.updateFloatArray([n]),o.updateUint8Array([173]),s.heading=8.381e-8*o.digest()}return s}getRenderingInfoAsync(e,t,r,i){return y.getRenderingInfoAsync(e,{renderer:t,arcade:r,...i})}getSymbolLayerSize(e,t){return this.graphicsCore?.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){this.graphicsCore?.setObjectIdVisibility(e,t)}refreshFilter(){null!=this.filterVisibility&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){return this.graphicsCore?.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles(c.watch((()=>this.suspendResumeExtentMode),(()=>{switch(this.removeHandles(F),this.suspendResumeExtentMode){case"computed":this.addHandles([c.watch((()=>this.graphicsCore.computedExtent),(e=>this._updateSuspendResumeExtent(e)),c.initial),c.watch((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],F);break;case"data":this.addHandles([c.when((()=>this.dataExtent),(e=>this._updateSuspendResumeExtent(e)),c.initial),c.watch((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.dataExtent)))],F);break;default:s.neverReached(this.suspendResumeExtentMode)}}),c.initial))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const r=this.owner.view.spatialReference;if(!e.spatialReference.equals(r)){if(!g.canProject(e,r))return;e=g.project(e,r)}return R.enlargeExtent(e,t,S.suspendResumeExtentOptimism,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){null!=this.frustumVisibility&&this.frustumVisibility.setExtent(e),null!=this.scaleVisibility&&this.scaleVisibility.setExtent(e)}},t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"type",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"owner",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"layer",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"layerViewUid",null),t.__decorate([u.property({readOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"dataUpdating",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"renderer",null),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"updateClippingExtent",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"elevationFeatureExpressionEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"graphicsCore",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"scaleVisibilityEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"filterVisibilityEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"frustumVisibilityEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"elevationAlignmentEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"timeExtentEnabled",void 0),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"setUidToIdOnAdd",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"scaleVisibility",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"filterVisibility",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"elevationAlignment",null),t.__decorate([u.property({constructOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"frustumVisibility",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"suspendResumeExtentMode",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"dataExtent",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"scaleVisibilitySuspended",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"suspended",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"legendEnabled",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"suspendInfo",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"updating",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"updatingRemaining",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"featureStore",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"view",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"loadedGraphics",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"fullOpacity",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"filter",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"slicePlaneEnabled",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"drapeSourceType",void 0),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"updatePolicy",null),t.__decorate([u.property()],e.Graphics3DFeatureProcessor.prototype,"preferredUpdatePolicy",void 0),t.__decorate([u.property({readOnly:!0})],e.Graphics3DFeatureProcessor.prototype,"displayFeatureLimit",null),e.Graphics3DFeatureProcessor=t.__decorate([p.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],e.Graphics3DFeatureProcessor);const F="suspendResumeExtentMode";Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/arcade/functions/hash":function(){define(["exports"],(function(e){"use strict";const t=2654435761,r=2246822519,i=3266489917,s=668265263,n=374761393;function o(e){const t=[];for(let r=0,i=e.length;r<i;r++){let i=e.charCodeAt(r);i<128?t.push(i):i<2048?t.push(192|i>>6,128|63&i):i<55296||i>=57344?t.push(224|i>>12,128|i>>6&63,128|63&i):(r++,i=65536+((1023&i)<<10|1023&e.charCodeAt(r)),t.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return new Uint8Array(t)}e.XXH=class{constructor(e){this._seed=e,this._totallen=0,this._bufs=[],this.init()}init(){return this._bufs=[],this._totallen=0,this}updateFloatArray(e){const t=[];for(const r of e)isNaN(r)?t.push("NaN"):r===1/0?t.push("Infinity"):r===-1/0?t.push("-Infinity"):0===r?t.push("0"):t.push(r.toString(16));this.update(o(t.join("")))}updateIntArray(e){const t=Int32Array.from(e);this.update(new Uint8Array(t.buffer))}updateUint8Array(e){this.update(Uint8Array.from(e))}updateWithString(e){return this.update(o(e))}update(e){return this._bufs.push(e),this._totallen+=e.length,this}digest(){const e=new Uint8Array(this._totallen);let t=0;for(const r of this._bufs)e.set(r,t),t+=r.length;return this.init(),this._xxHash32(e,this._seed)}_xxHash32(e,o=0){const a=e;let l=o+n&4294967295,c=0;if(a.length>=16){const i=[o+t+r&4294967295,o+r&4294967295,o+0&4294967295,o-t&4294967295],s=e,n=s.length-16;let a=0;for(c=0;(4294967280&c)<=n;c+=4){const e=c,n=s[e]+(s[e+1]<<8),o=s[e+2]+(s[e+3]<<8),l=n*r+(o*r<<16);let u=i[a]+l&4294967295;u=u<<13|u>>>19;const d=65535&u,h=u>>>16;i[a]=d*t+(h*t<<16)&4294967295,a=a+1&3}l=(i[0]<<1|i[0]>>>31)+(i[1]<<7|i[1]>>>25)+(i[2]<<12|i[2]>>>20)+(i[3]<<18|i[3]>>>14)&4294967295}l=l+e.length&4294967295;const u=e.length-4;for(;c<=u;c+=4){const e=c,t=a[e]+(a[e+1]<<8),r=a[e+2]+(a[e+3]<<8);l=l+(t*i+(r*i<<16))&4294967295,l=l<<17|l>>>15,l=(65535&l)*s+((l>>>16)*s<<16)&4294967295}for(;c<a.length;++c)l+=a[c]*n,l=l<<11|l>>>21,l=(65535&l)*t+((l>>>16)*t<<16)&4294967295;return l^=l>>>15,l=((65535&l)*r&4294967295)+((l>>>16)*r<<16),l^=l>>>13,l=((65535&l)*i&4294967295)+((l>>>16)*i<<16),l^=l>>>16,l<0?l+4294967296:l}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/renderers/support/renderingInfoUtils":function(){define(["exports","../../Color","./RenderingInfo","../visualVariables/support/visualVariableUtils"],(function(e,t,r,i){"use strict";async function s(e,t){return null!=e.symbol?e.symbol:t?.renderer?.getSymbolAsync(e,t)??null}e.getDriverAxisSizeValue=function(e,t=0){const r=e[t];return"number"==typeof r&&isFinite(r)?r:null},e.getDriverAxisSizeValueAny=function(e){for(let t=0;t<3;t++){const r=e[t];if("number"==typeof r)return isFinite(r)?r:0}return 0},e.getRenderingInfo=function(e,t){const s=function(e,t){if(null!=e.symbol)return e.symbol;const r=t?.renderer;return null!=r&&"dot-density"!==r.type?r.getSymbol(e,t):null}(e,t);if(null==s)return null;const n=t?.renderer,o=new r.RenderingInfo(n,s);if(null==n||!("visualVariables"in n)||!n.visualVariables)return o;const a=i.getVisualVariableValues(n,e,t)??[],l=["proportional","proportional","proportional"];for(const{variable:e,value:t}of a)if(null!=t||"size"===e.type&&e.useSymbolValue)switch(e.type){case"color":o.color=t?.toRgba();break;case"size":if("outline"===e.target)o.outlineSize=t;else{const r=e.axis,i=e.useSymbolValue?"symbol-value":t??"proportional";switch(r){case"width":l[0]=i;break;case"depth":l[1]=i;break;case"height":l[2]=i;break;case"width-and-depth":l[0]=l[1]=i;break;default:l[0]=l[1]=l[2]=i}}break;case"opacity":o.opacity=t;break;case"rotation":switch(e.axis){case"tilt":o.tilt=t;break;case"roll":o.roll=t;break;default:o.heading=t}}return"proportional"===l[0]&&"proportional"===l[1]&&"proportional"===l[2]||(o.size=l),o},e.getRenderingInfoAsync=async function(e,n){const o=await s(e,n);if(!o)return null;const a=n?.renderer,l=new r.RenderingInfo(a,o);if(!a||!("visualVariables"in a)||!a.visualVariables)return l;const c=i.getVisualVariableValues(a,e,n)??[],u=["proportional","proportional","proportional"];for(const{variable:e,value:r}of c)if("color"===e.type)l.color=t.toUnitRGBA(r);else if("size"===e.type)if("outline"===e.target)l.outlineSize=r;else{const t=e.axis,i=e.useSymbolValue?"symbol-value":r;"width"===t?u[0]=i:"depth"===t?u[1]=i:"height"===t?u[2]=i:u[0]=u[1]="width-and-depth"===t?i:u[2]=i}else"opacity"===e.type?l.opacity=r:"rotation"===e.type&&"tilt"===e.axis?l.tilt=r:"rotation"===e.type&&"roll"===e.axis?l.roll=r:"rotation"===e.type&&(l.heading=r);return(isFinite(u[0])||isFinite(u[1])||isFinite(u[2]))&&(l.size=u),l},e.getSymbolAsync=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/DisplayFeatureLimit":function(){define(["exports"],(function(e){"use strict";e.DisplayFeatureLimit=class{constructor(e,t,r){this.maximumTotalNumberOfVertices=e,this.maximumNumberOfFeatures=t,this.averageSymbolComplexity=r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DCore":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/has","../../../../core/Error","../../../../core/handleUtils","../../../../core/Logger","../../../../core/MapUtils","../../../../core/maybe","../../../../core/MemCache","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/scheduling","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/accessorSupport/diffUtils","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/Extent","../../../../geometry/Point","../../../../geometry/projectionUtils","../../../../geometry/projection/projectBuffer","../../../../geometry/projection/projectVectorToVector","../../../../geometry/projection/projectXYZToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/Layer","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/hydratedFeatures","../../../../layers/support/PromiseQueue","../../../../renderers/UniqueValueRenderer","../../../../renderers/support/rendererConversion","../../../../renderers/support/RenderingInfo","../../../../support/basemapUtils","../../../../support/loadArcade","../../../../symbols/LabelSymbol3D","../../../../symbols/TextSymbol","../../../../symbols/WebStyleSymbol","../../../../symbols/support/defaults3D","../../../../symbols/support/symbolConversion","./defaultSymbolComplexity","./DisplayFeatureLimit","./ElevationQuery","./enums","./featureExpressionInfoUtils","./Graphics3DFeatureStore","./Graphics3DGraphicCreationContext","./Graphics3DSymbolCreationContext","./Graphics3DSymbolFactory","./Graphics3DWebStyleSymbol","./GraphicsCorePerformanceInfo","./GraphicStateTracking","./graphicUtils","./interfaces","./Loadable","./SpatialIndex2D","../support/StageLayerElevationProvider","../../support/extentUtils","../../webgl-engine/lib/GridLocalOriginFactory","../../webgl-engine/lib/UpdatePolicy","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/lib/WebGLLayer","../../../layers/support/popupUtils","../../../support/PropertiesPool","../../../support/Scheduler","../../../support/TextureCompressionTracker","../../../support/Yield","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z,Y,X,K,J,ee,te,re,ie,se,ne,oe,ae,le,ce,ue,de,he,pe,me,fe,ge){"use strict";var ye;const _e=b.create(),be=P.create();var ve;e.Graphics3DCore=class extends r{static{ye=this}static{this.tmpVec=b.create()}get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new se.SpatialIndex2D({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?le.UpdatePolicy.ASYNC:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this._updateQueue.updating||this.running)}get dataUpdating(){return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.updating||this._loadingSymbols>0||this.compressionTracker.compressing)}get running(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){const e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?.graphics3D.minTotalNumberOfFeatures??0,r=e?.graphics3D.maxTotalNumberOfFeatures??0,i=e?.graphics3D.maxNumberOfDrawCalls??0,s=e?.graphics3D.maxTotalNumberOfVertices??0,n=this.averageSymbolComplexity,o=Math.max(1,n?.verticesPerFeature??1),a=n&&n.drawCallsPerFeature>0&&i>0?i/n.drawCallsPerFeature:r,l=Math.ceil(s/o),c=Math.max(t,Math.min(r,l,a)),u=this._get("displayFeatureLimit");return u&&u.maximumTotalNumberOfVertices===s&&u.averageSymbolComplexity===n&&u.maximumNumberOfFeatures===c?u:new q.DisplayFeatureLimit(s,c,n)}get averageSymbolComplexity(){const e=j.averageSymbolComplexities(this._symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||null!=t&&(e.estimated&&(t.verticesPerFeature>=e.verticesPerFeature||t.verticesPerCoordinate>=e.verticesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.verticesPerFeature===e.verticesPerFeature&&t.verticesPerCoordinate===e.verticesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get usedMemory(){const e=this.labelsEnabled?(this.averageSymbolComplexity?.memory.bytesPerFeatureLabel??0)*this._numberOfGraphics:0,t=this._getSymbolComplexitiesUsed().reduce(((e,t)=>e+t.memory.resourceBytes),0);if(null==this._symbolMaterials){this._symbolMaterials=[];for(const e of this._symbols.values())if(null!=e)for(const t of e.symbolLayers)if(t)for(const e of t.materials)e&&this._symbolMaterials.push(e)}const r=this.owner.view.stage.renderer,i=this.owner.view.basemapTerrain.overlayManager.renderer,s=this._symbolMaterials.reduce(((e,t)=>e+((r.getMaterialRenderer(t)||i.getMaterialRenderer(t))?.usedMemory??0)),0);return this._usedMemory+e+t+s}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){const e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if(null!=this.averageSymbolComplexity){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(e){const t=e;if("web-style"===t.type)return t.clone();const r=this._symbolConversionCache.get(t.id);if(null!=r)return r;const i=z.to3D(t,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(t),cimFallbackEnabled:!0}),s=i.symbol||null;return null==s&&i.error&&a.getLogger(this).error(i.error.message),this._symbolConversionCache.set(t.id,s),s}_getSymbolComplexitiesUsedOrRenderer(e){if(null==e)return[];const t=e.symbols,r="backgroundFillSymbol"in e?e.backgroundFillSymbol:null;if(!r&&!t.length)return[];const i=[],s=this._getSymbolComplexityUsedOrRenderer(r);null!=s&&i.push(s);for(const e of t){const t=this._getSymbolComplexityUsedOrRenderer(e);null!=t&&i.push(t)}return i}_getSymbolComplexityUsedOrRenderer(e){if(null==e)return null;const t=this._symbols.get(e.id);if(null!=t)return t.complexity;const r=this._getConvertedSymbol(e);return null!=r?j.defaultSymbolComplexity(r):null}_getSymbolComplexitiesUsed(){const e=[];return this._symbols.forEach((t=>{null!=t&&e.push(t.complexity)})),e}get _objectIdField(){return this.layer.objectIdField}constructor(e){super(e),this._propertiesPool=new he.PropertiesPool({computedExtent:v},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=pe.ImmediateTask,this._dataUpdateQueue=new I.PromiseQueue,this._updateQueue=new I.PromiseQueue,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._elevationAlignment=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this._pendingUpdatesPool=new d({allocator:e=>e||new Se,deallocator:e=>(e.clear(),e)}),this.compressionTracker=new me.TextureCompressionTracker,this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new d,this.preferredUpdatePolicy=le.UpdatePolicy.SYNC,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=e.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",(e=>e.destroy())),this.symbolCreationContext=new Y.Graphics3DSymbolCreationContext(e.owner.view.resourceController.scheduler,((e,t)=>this._updateQueue.push(e,t)),e.owner.layerViewUid,this.compressionTracker)}initialize(){this._featureStore=new Q.Graphics3DFeatureStore({objectIdField:this.owner.layer?.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e)});const e=(e,t,r)=>this.spatialIndex.queryGraphicUIDsInExtent(e,t,r),{componentFactories:t}=this;this._elevationAlignment=t.elevationAlignment?.(this,e),this._scaleVisibility=t.scaleVisibility?.(this,e),this._filterVisibility=t.filterVisibility?.({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(W.VisibilityGroup.GRAPHIC,W.VisibilityFlag.FILTER,e(O.getObjectId(t.graphic,this._objectIdField))))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(W.VisibilityGroup.GRAPHIC,W.VisibilityFlag.FILTER,e))),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(W.VisibilityGroup.GRAPHIC,W.VisibilityFlag.FILTER,!0)))}),this._deconflictor=t.deconflictor?.(this),this._labeler=t.labeler?.(this,this._scaleVisibility),this._objectStates=t.objectStates?.(this),this._initializeAbortController=new AbortController,this.addHandles(p.when((()=>this.owner.view.state.highlights),(()=>{const{highlightOrderMap:e}=this.owner.view.state;this.graphics3DGraphics.forEach((t=>t.updateHighlights(e)))}))),this._initializePromise=this._initializeAsync()}async _initializeAsync(){const e=this._initializeAbortController?.signal,t=this.owner.view;this._viewElevationProvider=new H.ViewElevationProvider(this._viewSpatialReference,t),this._initializeStage(t,this.owner.layerViewUid);const r=t.sharedSymbolResources;this.symbolCreationContext.sharedResources=r,this._sharedSymbolResourcesOwnerHandle=r.addGraphicsOwner(this.owner),null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=r.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=t.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new ae.GridLocalOriginFactory(t.renderSpatialReference),this.symbolCreationContext.elevationProvider=t.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const i=$.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await $.createContext(i,this._viewSpatialReference,e,a.getLogger(this)),h.throwIfAborted(e),this.symbolCreationContext.screenSizePerspectiveEnabled=t.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,"drapeSourceType"in this.owner){const{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=t.basemapTerrain.overlayManager.registerGeometryDrapeSource(e),this.addHandles(o.makeHandle((()=>t.basemapTerrain.overlayManager.unregisterDrapeSource(e))))}this.addHandles([p.watch((()=>this.suspendedOrOutsideOfView),(()=>this._updateQueue.unshift((()=>this._updateLayerVisibility()),null).catch(h.ignoreAbortErrors))),p.watch((()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view?.screenSizePerspectiveEnabled]),(()=>{const e=t.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())})),p.watch((()=>this.owner.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(!!e))),p.watch((()=>this.owner.view.state?.rasterPixelRatio),(()=>this._pixelRatioChange())),p.watch((()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._physicalBasedRenderingChange(e))),p.watch((()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods),(e=>this._skipHighSymbolLoDsChange(e))),p.watch((()=>this.owner.view.focusAreasView?.polygons),(()=>this._updateFocusedLabels())),p.watch((()=>this.owner.view.map?.focusAreas.style),(()=>this.recreateAllGraphicsAndSymbols())),p.when((()=>t.basemapTerrain?.tilingScheme),(e=>{if(e.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==t.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=t.basemapTerrain.spatialReference),this.hasHandles("loaded-graphics"))this.recreateAllGraphics();else{const e=()=>this.owner?.loadedGraphics;this.addHandles([p.on(e,"change",(e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),p.watch((()=>this.effectiveUpdatePolicy),(e=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===le.UpdatePolicy.ASYNC,e===le.UpdatePolicy.SYNC&&this.runTask(pe.noBudget)}),p.syncAndInitial)]),this._frameTaskHandle=t.resourceController.scheduler.registerTask(pe.TaskPriority.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this.addHandles(p.watch((()=>this.layer.featureReduction),(()=>this._deconflictor?.featureReductionChange()))),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch((()=>{})),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController=c.abortMaybe(this._initializeAbortController)}_updateFocusedLabels(){this.forEachGraphics3DSymbol(((e,t)=>{t&&e.updateFocus((({graphic:e})=>this.recreateGraphics([e])),t)}))}destroy(){this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._rendererChangeAbortController=c.abortMaybe(this._rendererChangeAbortController),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=pe.ImmediateTask,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this._deconflictor=c.removeMaybe(this._deconflictor),this._labeler=c.removeMaybe(this._labeler),this._elevationAlignment=c.destroyMaybe(this._elevationAlignment),this._scaleVisibility=c.destroyMaybe(this._scaleVisibility),this._filterVisibility=c.destroyMaybe(this._filterVisibility),this._objectStates=c.destroyMaybe(this._objectStates),this.clear(),this._featureStore=c.destroyMaybe(this._featureStore),this._updatingPendingLoadedGraphicsChange=c.removeMaybe(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=c.destroyMaybe(this._graphicStateTracking),this.stage&&(this.stageLayer=c.destroyMaybe(this.stageLayer),this.stage=null),this._set("owner",null);for(const e in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new n("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=c.removeMaybe(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=c.destroyMaybe(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=c.destroyMaybe(this._spatialIndex)}clear(){this._objectStates?.allGraphicsDeleted(),null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((e=>e.destroy())),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(c.destroyMaybe),this._symbols.clear(),this._symbolMaterials=null,this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("dataUpdating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed"),this.owner.notifyContentGeometryUpdate?.()}_initializeStage(e,t){this.stage=e.stage,this.stageLayer=new ue.WebGLLayer(this.stage,{visible:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t);const r=this.stageLayer.events;r.on("transformationChanged",(e=>this.notifyGraphicGeometryChanged(e.graphicUid))),r.on("shaderTransformationChanged",(e=>this.notifyGraphicGeometryChanged(e.graphicUid))),r.on("visibilityChanged",(e=>this.notifyGraphicVisibilityChanged(e.graphicUid))),r.on("geometryAdded",(e=>this.notifyGraphicGeometryChanged(e.object.graphicUid))),r.on("geometryRemoved",(e=>this.notifyGraphicGeometryChanged(e.object.graphicUid))),r.on("attributesChanged",(e=>ce.affectsGeometry(e.attribute)&&this.notifyGraphicGeometryChanged(e.object.graphicUid)))}notifyGraphicGeometryChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(null==this._graphicStateTracking||null==e)return;const t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}_updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*we,r=!this.suspendedOrOutsideOfView&&!t;r!==this._visible&&(this._visible=r,this._updateStageLayerVisibility())}_updateStageLayerVisibility(){const e=this._visible&&(null==this.layer.opacity||this.layer.opacity>=ge.alphaCutoff);this.stageLayer.visible!==e&&(this.stageLayer.visible=e,e?this.updateGraphicsVisibilities():this._hideAllGraphics(),this.owner.notifyContentGeometryUpdate?.())}getGraphics3DGraphicById(e){return null!=e?this.graphics3DGraphics.get(e):void 0}getGraphics3DGraphicByObjectId(e){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer?.objectIdField){return O.getObjectId(e,t)}get graphics3DGraphicsByObjectID(){const e=this.owner.layer?.objectIdField;if(!e)return;const t=new Map;return this.graphics3DGraphics.forEach((r=>{if(!r)return;const i=r.graphic,s=this._getGraphicObjectID(i,e);null!=s&&t.set(s,r)})),t}get labelsEnabled(){return!!this._labeler?.layerLabelsEnabled()}async updateLabelingInfo(e){const t=this._deconflictor?.labelingInfoChange(e),r=this._labeler?.labelingInfoChange(e);await Promise.allSettled([t,r])}updateVisibilityInfo(){this._deconflictor?.labelingInfoChange(),this._labeler?.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let e=!1,t=!1;for(const[r,i]of this._symbols)if(null!=i)switch(i.getFastUpdateStatus()){case re.FastUpdateStatus.Loading:return"unknown";case re.FastUpdateStatus.Fast:this._graphicsBySymbol.has(r)&&(t=!0);break;case re.FastUpdateStatus.Slow:this._graphicsBySymbol.has(r)&&(e=!0);break;case re.FastUpdateStatus.Mixed:this._graphicsBySymbol.has(r)&&(t=e=!0);case re.FastUpdateStatus.Undefined:}return t?e?"mixed":"fast":e?"slow":"mixed"}runTask(e){if(this._dataUpdateQueue.runTask(e),this._updateQueue.runTask(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("dataUpdating"),this.notifyChange("updatingRemaining"),!e.hasProgressed)return fe.Yield}setObjectIdVisibility(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);const r=this._findGraphics3DGraphicByObjectId(e);null!=r&&this._updateUserVisibility(r)}_findGraphics3DGraphicByObjectId(e){return l.findInMap(this.graphics3DGraphics,(t=>this._getGraphicObjectID(t.graphic)===e))}_updateUserVisibility(e){if(null==e)return!1;const t=e.graphic,r=this._getGraphicObjectID(t),i=t.visible&&!this.owner.suspended&&this.stageLayer.visible&&(null==r||!this._objectIdInvisibleSet.has(r));return e.setVisibilityFlag(W.VisibilityGroup.GRAPHIC,W.VisibilityFlag.USER,i)}_whenGraphics3DGraphic(e){const t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);const r=this._whenGraphics3DGraphicRequests[e.uid];if(r)return r.promise;const i=h.createResolver();return this._whenGraphics3DGraphicRequests[e.uid]=i,i.promise}async _boundsForGraphics3DGraphic(e,t){const r=this._viewSpatialReference,i=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,n=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:null!=t&&!!t.useViewElevation,minDemResolution:null!=t?t.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,o=await e.getProjectedBoundingBox(((e,t,s)=>x.projectBuffer(e,i,t,e,r,t,s)),((e,t,i)=>x.projectBuffer(e,s,t,e,r,t,i)),n,t?.signal);if(!o)return null;const a=o.boundingBox;if(o.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){P.center(a,_e);const t=e.getElevation(_e[0],_e[1],0,r,"ground")??0;a[2]=Math.min(a[2],t),a[5]=Math.max(a[5],t)}}return{boundingBox:a,screenSpaceObjects:o.screenSpaceObjects}}async whenGraphicBounds(e,t){await p.whenOnce((()=>this.owner?.loadedGraphics));const r=this.owner.layer?.objectIdField,i=this.owner.loadedGraphics.find((t=>t===e||null!=r&&null!=t.attributes&&e.attributes&&t.attributes[r]===e.attributes[r]));if(!i)throw new n("internal:graphic-not-part-of-view","Graphic is not part of this view");const s=await this._whenGraphics3DGraphic(i);return this._boundsForGraphics3DGraphic(s,t)}computeAttachmentOrigin(e,t){const r=this.graphics3DGraphics.get(e.uid);if(!r)return null;const i=r.computeAttachmentOrigin();if(0===i.render.num&&0===i.draped.num)return null;_.set(xe,0,0,0);let s=0;if(i.render.num>0){if(!T.projectVectorToVector(i.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,Te,t))return null;_.add(xe,xe,Te),s++}if(i.draped.num>0){const[e,r]=i.draped.origin,n=this._viewElevationProvider.getElevation(e,r,"ground")??0;if(_.set(Te,e,r,n),!T.projectVectorToVector(Te,this._viewElevationProvider.spatialReference,Te,t))return null;_.add(xe,xe,Te),s++}return s>1&&_.scale(xe,xe,1/s),new S({x:xe[0],y:xe[1],z:xe[2],spatialReference:t})}getSymbolLayerSize(e,t){const r=this._symbols.get(e.id);if(null==r)throw new n("internal:symbol-not-part-of-view","Symbol is not part of this view");const i=e.symbolLayers.indexOf(t);if(-1===i)throw new n("internal:missing-symbol-layer","Symbol layer is not in symbol");const s=r.getSymbolLayerSize(i);if(null==s)throw new n("internal:missing-size","Symbol layer has no valid size");return s}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){const t=e.graphic.uid,r=this.graphics3DGraphics.get(t);if(null!=r||null!=this._graphicsWithoutSymbol.get(t)){switch(e.property){case"visible":this._graphicUpdateVisibleHandler(r);break;case"geometry":this._graphicUpdateGeometryHandler(r,e);break;case"symbol":this._graphicUpdateSymbolHandler(r,e);break;case"attributes":case"popupTemplate":break;case"origin-transform":this._graphicUpdateTransformHandler(r,e)}this.owner.notifyContentGeometryUpdate?.()}}_graphicUpdateGeometryHandler(e,t){this._graphicUpdateGeometryOrTransformHandler(e,t,(()=>!(null==t.newValue||null==e||!e.graphics3DSymbol.updateGeometry(e,t.newValue)||!(this._labeler?.updateGraphicGeometry(e)??1)||(this._labeler?.setDirty(),0))));const r=t.graphic.geometry;null!=r&&this._expandComputedExtent(r)}_graphicUpdateTransformHandler(e,t){const r=t.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(e,t,(()=>null!=t.newValue&&null!=e&&null!=r&&e.graphics3DSymbol.updateTransform(e,r.spatialReference,t.newValue,t.action)))}_graphicUpdateGeometryOrTransformHandler(e,t,r){if(null!=t.graphic.geometry)if(null!=e)r()||this._recreateGraphic(e.graphic);else{const e=t.graphic.symbol?.id;if(e){const t=this._symbols.get(e);if(null!=t&&t.loadStatus===ie.LoadStatus.LOADING)return}this._recreateGraphic(t.graphic)}else this._recreateGraphic(t.graphic)}_graphicUpdateSymbolHandler(e,t){const r=t.graphic,i=null!=e?e.graphics3DSymbol:null!=t.oldValue?this._symbols.get(t.oldValue.id):null;if(null==i||null==t.newValue)return void this._recreateGraphic(r);const s=i.symbol,n=this._getConvertedSymbol(t.newValue);if(null!=n&&(n.type!==s.type||"web-style"===n.type)||"web-style"===s.type)return void this._recreateGraphic(r);const o=this._graphicsBySymbol.get(s.id);if(o&&1!==o.size)return void this._recreateGraphic(r);const a=y.diff(s,n);if(null==a)return void this._updateSymbolMapping(s.id,n);const l={diff:a,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(i.prepareSymbolPatch(l),!y.isEmpty(l.diff))return void this._recreateGraphic(r);const c=this._getRenderingInfo(r,!1);if(null==c)return void this._recreateGraphic(r);const u=i.extentPadding;for(const e of l.symbolStatePatches)e();if(u!==i.extentPadding&&this._recomputeExtentPadding(),null!=e)for(const t of l.graphics3DGraphicPatches)t(e,c);this._updateSymbolMapping(s.id,n)}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}recreateGraphics(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===le.UpdatePolicy.SYNC&&this._cleanupSymbols()}_recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){const t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating"),t}_endGraphicUpdate(e,t){e&&(t&&this._graphicStateTracking?.updateGraphicError(e,t),this._graphicsWaitingForSymbol.delete(e.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let e=0;this._symbols.forEach((t=>{null!=t&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}_expandComputedExtent(e){const t=be,r=e.spatialReference;O.computeAABB(e,t);const i=this._viewSpatialReference,s=ye.tmpVec;if(R.equals(r,i)||C.projectXYZToVector(t[0],t[1],0,r,s,i)&&(t[0]=s[0],t[1]=s[1],C.projectXYZToVector(t[3],t[4],0,r,s,i),t[3]=s[0],t[4]=s[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;const n=this.computedExtent;let o=null;const a=isFinite(t[2])&&isFinite(t[5]),l=a&&(null==n?.zmin||t[2]<n.zmin),c=a&&(null==n?.zmax||t[5]>n.zmax);n?(t[0]<n.xmin||t[1]<n.ymin||t[3]>n.xmax||t[4]>n.ymax||l||c)&&(o=this._propertiesPool.get("computedExtent"),o.xmin=Math.min(t[0],n.xmin),o.ymin=Math.min(t[1],n.ymin),o.xmax=Math.max(t[3],n.xmax),o.ymax=Math.max(t[4],n.ymax),o.spatialReference=i):(o=this._propertiesPool.get("computedExtent"),o.xmin=t[0],o.ymin=t[1],o.xmax=t[3],o.ymax=t[4],o.spatialReference=i),o&&(l&&(o.zmin=t[2]),c&&(o.zmax=t[5]),this._set("computedExtent",o))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}async elevationInfoChange(){this._abortElevationInfoChange();const e=new AbortController;this._elevationInfoChangeAbortController=e;const t=$.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await $.createContext(t,this._viewSpatialReference,e.signal,a.getLogger(this)),h.throwIfAborted(e.signal),this._elevationInfoChangeAbortController=null,this._labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol(((e,t,r)=>{e.globalPropertyChanged("elevationInfo",t)?t?.forEach((e=>{const t=e.graphic,r=e.labelLayers;for(const e of r)e.graphics3DSymbolLayer.updateGraphicElevationContext(t,e)})):this._recreateSymbol(r)})),this.updateStageLayerElevationProvider(),this._elevationAlignment?.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=c.disposeMaybe(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new ne.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear(),null!=this._filterVisibility&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=c.disposeMaybe(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:t,view:r}=this.owner,i=r.basemapTerrain?.tilingScheme&&t?.length?t.toArray():null;!e&&i||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),i&&(e?this.add(i):this.recreateGraphics(i))}_recreateSymbol(e){const t=this._graphicsBySymbol.get(e),r=[];t&&(t.forEach(((e,t)=>{const i=e.usedMemory;this._conditionalRemove(e,t),this._spatialIndex?.remove(e),r.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,i),this._updateLayerVisibility(),this._featureStore.events.emit("changed"),this.owner.notifyContentGeometryUpdate?.()})),this._graphicsBySymbol.set(e,new Map));const i=this._symbols.get(e);c.destroyMaybe(i),this._symbols.delete(e),this._symbolMaterials=null,c.destroyMaybe(this._unusedSymbolsCache.pop(e)),this.add(r)}_recreateGraphicsForSymbol(e){const t=this._graphicsBySymbol.get(e);if(t){const e=[];t.forEach((t=>e.push(t.graphic))),this.recreateGraphics(e)}}_conditionalRemove(e,t){this._graphicsDrapedUids.delete(t),this._objectStates?.removeGraphic(e),this._labeler?.removeGraphic(e),this._deconflictor?.removeGraphic(e),null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(e)}add(e){e&&0!==e.length&&(this.owner.view.basemapTerrain?.tilingScheme?(this._updatePolicyForGraphics(e)===le.UpdatePolicy.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("dataUpdating")):a.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===le.UpdatePolicy.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const t of e)if(null!=t.geometry&&"mesh"===t.geometry.type&&!t.geometry.loaded)return le.UpdatePolicy.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const t of e)this._addGraphic(t,this._getRenderingInfo(t),le.UpdatePolicy.SYNC);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_addDelayed(e){for(const t of e){const e=t.uid;let r=this._pendingUpdates.get(e);r?r.add?r.state!==ve.NEW&&r.abortController?.abort():this._pendingAdds++:(r=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(e,r)),r.add=t}this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}remove(e){this.effectiveUpdatePolicy===le.UpdatePolicy.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("dataUpdating")}_removeImmediate(e){for(const t of e)this._removeGraphic(t);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_removeDelayed(e){for(const t of e){const e=t.uid,r=this._pendingUpdates.get(e);if(r)r.add&&(r.remove?r.add=null:this._pendingUpdates.delete(e),r.state===ve.LOADING&&r.abortController?.abort(),this._pendingAdds--);else{const r=this._pendingUpdatesPool.pushNew();r.remove=t,this._pendingUpdates.set(e,r),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&a.getLogger(this).warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(e){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&this._spatialIndex?.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[t,r]of this._pendingUpdates){if(e.done){this._applyPendingRemovesFirst=!0;break}if(r.remove&&!r.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(r.remove),r.remove=null,this._pendingUpdates.delete(t),0===this._pendingRemoves))break}}for(const[t,r]of this._pendingUpdates){if(e.done)break;r.add&&r.state===ve.NEW&&this._processPendingUpdateNew(r);let i=this.effectiveUpdatePolicy;if(!r.remove||r.add&&r.state!==ve.READY||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(r.remove),r.remove=null,i=le.UpdatePolicy.SYNC),r.add)switch(r.state){case ve.READY:this._addGraphic(r.add,r.renderingInfo,i),r.add=null,this._pendingAdds--,e.madeProgress();break;case ve.REJECTED:r.add=null,this._pendingAdds--;case ve.LOADING:}null==r.remove&&null==r.add&&this._pendingUpdates.delete(t)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}_processPendingUpdateNew(e){if(!e.add)return void(e.state=ve.READY);const t=e.add.geometry;null==t||"mesh"!==t.type||t.loaded?this._processPendingUpdateNewRenderingInfo(e):this._processPendingUpdateNewMesh(e,t)}async _processPendingUpdateNewMesh(e,t){e.state=ve.LOADING,e.abortController=new AbortController;const r=e.abortController.signal;try{await t.load({signal:r})}catch(t){return this._processPendingUpdateNewError(e,t)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,h.isAbortError(t)?e.state=ve.NEW:e.state=ve.REJECTED}async _processPendingUpdateNewRenderingInfo(e){if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add),void(e.state=ve.READY);e.state=ve.LOADING,e.abortController=new AbortController;let t=null;try{t=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(t){return e.abortController=null,void(h.isAbortError(t)?e.state=ve.NEW:e.state=ve.REJECTED)}null==t?.symbol?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,a.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=ve.READY}_addGraphic(e,t,r){if(this._graphicsWithoutSymbol.set(e.uid,e),null==t?.symbol||!O.hasGeometry(e))return;const i=this.stage.renderView.olidRenderHelper;if(i&&this.setUidToIdOnAdd){const t=N.isBasemapLayerView(this.owner.view,this.owner.layerViewUid);i.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.owner.layerViewUid,!!this.layer.popupEnabled&&!t&&de.hasPopupTemplate(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}const s=t.symbol,n=this.getOrCreateGraphics3DSymbol(s,t.renderer);if(null==n)return;this._expandComputedExtent(e.geometry);const o=this._beginGraphicUpdate(e),a=new Z.Graphics3DGraphicCreationContext(e,t,this.layer);let l=!1;const c=e=>{e===n.symbol.id&&(l=!0)};this._whenSymbolRemoved.push(c);const u=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(c),this._graphicsWaitingForSymbol.get(e.uid)!==o||l||n.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==n.symbol.id)--n.referenced,this._cleanupSymbols();else{const t=this._createGraphics3DGraphic(n,a);this._spatialIndex&&null!=t&&this._spatialIndex.add(t),--n.referenced,this._endGraphicUpdate(e)}this._featureStore.events.emit("changed"),this.owner.notifyContentGeometryUpdate?.(),this._labeler?.setDirty()}},d=t=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(c),l||(h.isAbortError(t)?this.add([e]):n.destroyed||this._endGraphicUpdate(e,t)))};++this._loadingSymbols,r===le.UpdatePolicy.ASYNC?n.load((()=>this._dataUpdateQueue.push(u,null).catch(h.ignoreAbortErrors)),(e=>this._dataUpdateQueue.push((()=>d(e)),null).catch(h.ignoreAbortErrors))):n.load(u,d)}_removeGraphic(e){const t=e.uid,r=this.graphics3DGraphics.get(t);if(r){r.graphics3DSymbol.onRemoveGraphic(r);const e=r.usedMemory,i=r.isElevationSource;this._conditionalRemove(r,t),this._spatialIndex?.remove(r);const s=r.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(s)?.delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,i),r.destroy(),this._featureStore.events.emit("changed"),this.owner.notifyContentGeometryUpdate?.()}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(e){if(e instanceof V||e instanceof B){const t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((t=>t.symbol===e))}return!1}_hasValidSymbolCreationContext(e){return!(e instanceof V&&!this._hasLabelingContext(e)&&(a.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),1))}_getRenderingInfo(e,t=!0){const r=e.geometry;if(null==r)return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,a.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!w.canProjectWithoutEngine(r.spatialReference,this._viewSpatialReference))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,a.getLogger(this).warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,a.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const i=this.rendererHasGeometryOperations?A.hydrateGraphic(e,this.layer):e;let s;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer))s=this.owner.getRenderingInfo(i,this.currentRenderer,this._arcadeOnDemand);else{const e=i.symbol||k.getDefaultSymbol3D(i.geometry);s=new L.RenderingInfo(null,e)}return null==s?.symbol?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,a.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):s}_getRenderingInfoAsync(e,t){if(null==e.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,a.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&null!=e.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,a.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?A.hydrateGraphic(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,this.currentRenderer,this._arcadeOnDemand,t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;const r=this._getConvertedSymbol(e);if(!r)return null;let i;if(null!=t&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){const e=z.to3D(t.backgroundFillSymbol,{ignoreDrivers:!0});null!=e.symbol&&(i=e.symbol.symbolLayers)}const s=X.make(r,this.symbolCreationContext,i);return s.load((()=>{const e=s.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity")}),(()=>{})),s}getOrCreateGraphics3DSymbol(e,t){let r=this._symbols.get(e.id);if(void 0===r){const i=this._unusedSymbolsCache.pop(e.id);r=null!=i?i:e instanceof G?new K.Graphics3DWebStyleSymbol(e,(e=>this._dataUpdateQueue.push(e,null)),(e=>this._createGraphics3DSymbol(e,t))):this._createGraphics3DSymbol(e,t),this._symbols.set(e.id,r),this._symbolMaterials=null}return null!=r&&++r.referenced,r}trackGraphicState(e){return null==this._graphicStateTracking&&(this._graphicStateTracking=new ee.GraphicStateTracking(this)),this._graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(e,t,r=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,r&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(e,t){const r=t.graphic;if(this._graphicsWithoutSymbol.delete(r.uid),!this._symbols.has(e.symbol.id))return this.add([r]),null;if(this.graphics3DGraphics.has(r.uid))return null;const i=e.createGraphics3DGraphic(t);if(null==i)return null;this._addGraphics3DGraphic(i);const s=e.symbol.id;if(this._graphicsBySymbol.has(s)||this._graphicsBySymbol.set(s,new Map),this._graphicsBySymbol.get(s).set(r.uid,i),i.isDraped&&this._graphicsDrapedUids.add(r.uid),i.centroid=null,null!=r.geometry&&"point"!==r.geometry.type&&(i.centroid=te.computeCentroid(r.geometry,this._viewSpatialReference)),this._updateUserVisibility(i),null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(i),null!=this._filterVisibility){const{defaultVisibility:e}=this._filterVisibility;i.setVisibilityFlag(W.VisibilityGroup.GRAPHIC,W.VisibilityFlag.FILTER,e),e||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(i),this._labeler?.addGraphic(i),this._objectStates?.addGraphic(i),i.initialize(this.stageLayer),null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(i);const n=this._whenGraphics3DGraphicRequests[r.uid];return n&&(delete this._whenGraphics3DGraphicRequests[r.uid],n.resolve(i)),this._symbolMaterials=null,i}async rendererChange(e){if(this._rendererChangeAbortController=c.abortMaybe(this._rendererChangeAbortController),e!==this.currentRenderer)if(this._validateRenderer(e),null==e&&this._currentRendererChange(null,!1),F.isSupportedRenderer3D(e))if(e?.arcadeRequired){const t=new AbortController;this._rendererChangeAbortController=t;const{arcadeUtils:r}=await this._ensureArcade();h.throwIfAborted(t);const i=r.hasGeometryOperations(e);i&&(await r.enableGeometryOperations(),h.throwIfAborted(t)),this.effectiveUpdatePolicy===le.UpdatePolicy.ASYNC?await this._updateQueue.push((()=>this._currentRendererChange(e,i)),t.signal):this._currentRendererChange(e,i),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===le.UpdatePolicy.ASYNC){const t=new AbortController;this._rendererChangeAbortController=t,await this._updateQueue.push((()=>this._currentRendererChange(e,!1)),t.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}async _ensureArcade(){return null==this._arcadeOnDemand?(this._arcadeOnDemand=await U.loadArcade(),this._arcadeOnDemand):this._arcadeOnDemand}_currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=this._arcadeOnDemand;const r=this.symbolCreationContext.renderer;if(e===r)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==e)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const i=y.diff(r,e);this._updateUnchangedSymbolMappings(i,e,r),this.symbolCreationContext.renderer=e,null!=i&&("complete"===i.type?this.recreateAllGraphicsAndSymbols():"partial"===i.type&&(this._applyRendererDiff(i,e,r)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(e){for(const t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}_applySymbolSetDiff(e,t,r){e=e||[],t=t||[];const i=[];for(const s of t){const t=this._graphicsBySymbol.get(s.id);t&&t.forEach(((n,o)=>{const a=n.graphic,l=this.layer instanceof E?this.layer:null,c=this._arcadeOnDemand;if(s===r.defaultSymbol&&r.getSymbol(A.hydrateGraphic(a,l),{arcade:c})===r.defaultSymbol)return;const u=n.usedMemory;e.length||r.defaultSymbol?i.push(a):this._graphicsWithoutSymbol.set(o,a);const d=this.graphics3DGraphics.get(o);this._conditionalRemove(d,o),n.destroy(),t.delete(o),this._removeGraphics3DGraphic(o,u),this._updateLayerVisibility()})),this._whenSymbolRemoved.forAll((e=>e(s.id)))}(e.length||i.length)&&(this._graphicsWithoutSymbol.forEach((e=>i.push(e))),this._graphicsWithoutSymbol.clear(),this.add(i)),this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_applyUniqueValueRendererDiff(e,t,r){const s=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(s||n){const o=n?.changed,a=n?.unchanged;if(o&&a&&o.some((e=>a.some((t=>t.oldValue.symbol?.id===e.oldValue.symbol?.id)))))return!1;const l=n?n.added.map((e=>e.symbol)).filter(i.isSome):[],c=n?n.removed.map((e=>e.symbol)).filter(i.isSome):[];if(o)for(let e=0;e<o.length;e++)l.push(o[e].newValue.symbol),c.push(o[e].oldValue.symbol);return s?(r.defaultSymbol&&c.push(r.defaultSymbol),t.defaultSymbol&&l.push(t.defaultSymbol)):r.defaultSymbol&&l.length&&c.push(t.defaultSymbol),this._applySymbolSetDiff(l,c,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(e,t,r){if("unique-value"!==t?.type||"unique-value"!==r?.type||null!=e&&"partial"!==e.type)return[];const i=e=>null!=e?e.id:null,s=e&&e.diff,n=s?.defaultSymbol,o=s&&s.uniqueValueInfos;let a;if(o)a=o.unchanged.map((e=>({oldId:i(e.oldValue.symbol),newId:i(e.newValue.symbol)})));else{a=[];for(const e of r.uniqueValueInfos??[]){const r=i(e.symbol),s=t.uniqueValueInfos?.find((t=>t.value===e.value));s&&r!==i(s.symbol)&&a.push({oldId:r,newId:i(s.symbol)})}}return!n&&r.defaultSymbol&&a.push({oldId:i(r.defaultSymbol),newId:i(t.defaultSymbol)}),a}_updateSymbolMapping(e,t){const r=null!=t&&t?"string"==typeof t?t:t.id:null;if(null==e||e===r)return;const i=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),void 0!==i&&this._graphicsBySymbol.set(r,i);const s=this._symbols.get(e);if(void 0!==s&&(this._symbols.delete(e),this._symbols.set(r,s),this._symbolMaterials=null,null!=s)){const e="string"==typeof t?null:t;null!=e?s.symbol=e:s.symbol.id=r}}_updateUnchangedSymbolMappings(e,t,r){const i=this._calculateUnchangedSymbolMapping(e,t,r);for(const{oldId:e,newId:t}of i)this._updateSymbolMapping(e,t)}_applyRendererDiff(e,t,r){if(this._diffHasSymbolChange(e))return!1;if(t instanceof D&&r instanceof D&&this._applyUniqueValueRendererDiff(e,t,r)&&0===Object.keys(e.diff).length)return!0;for(const r of this._graphicsBySymbol.keys()){const i=this._symbols.get(r);if(null!=i)switch(i.applyRendererDiff(e,t)){case re.ApplyRendererDiffResult.RecreateSymbol:this._recreateSymbol(r);break;case re.ApplyRendererDiffResult.RecreateGraphics:this._recreateGraphicsForSymbol(r);case re.ApplyRendererDiffResult.FastUpdate:}}return!0}opacityChange(){this._updateStageLayerVisibility(),this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("opacity",t)))}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t))),this._deconflictor?.slicePlaneEnabledChange(),this._labeler?.slicePlaneEnabledChange())}_physicalBasedRenderingChange(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(((e,t,r)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(r)}))}_skipHighSymbolLoDsChange(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol(((e,t,r)=>{e.globalPropertyChanged("skipHighSymbolLods",t)||this._recreateSymbol(r)}))}_pixelRatioChange(){this.forEachGraphics3DSymbol(((e,t,r)=>{e.globalPropertyChanged("pixelRatio",t)||this._recreateSymbol(r)}))}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=m.schedule((()=>{this._updatingPendingLoadedGraphicsChange=null}))}setClippingExtent(e,t){const r=this.symbolCreationContext.clippingExtent,i=M.create();return oe.toBoundingRect(e,i,t)?this.symbolCreationContext.clippingExtent=P.fromRect(P.create(),i):this.symbolCreationContext.clippingExtent=null,!P.equals(this.symbolCreationContext.clippingExtent,r)}modifyGraphics3DGraphicVisibilities(e){if(this.destroyed)return;let t=!1;this.graphics3DGraphics.forEach((r=>{e(r)&&(t=!0)})),t&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}forEachGraphics3DSymbol(e,t){for(const[t,r]of this._symbols){if(null==r)return;e(r,this._graphicsBySymbol.get(t)||Ce,t)}if(!t?.excludeUnused)for(const t of this._unusedSymbolsCache)e(t,void 0,t.symbol.id)}updateGraphicsVisibilities(){null!=this._filterVisibility&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((e=>{const t=this._updateUserVisibility(e),r=!!this._scaleVisibility?.updateVisibility(e);return t||r}))}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(W.VisibilityGroup.GRAPHIC,W.VisibilityFlag.USER,!1)))}_validateRenderer(e){const t=()=>`'${this.layer.title?`${this.layer.title}, `:""}id:${this.layer.id}'`,r=F.validateTo3D(e,{geometryType:this.layer?.geometryType,logWarning:(e,r)=>a.getLogger(this).warn(e,`Symbology conversion for layer ${t()}: ${r}`)});if(r){const e=`Renderer for layer ${t} is not supported in a SceneView`;a.getLogger(this).warn(e,r.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach(((t,r)=>{if(null==t||t.referenced>0)return;const i=this._graphicsBySymbol.get(r);i&&0!==i.size||(this._graphicsBySymbol.delete(r),this._symbols.delete(r),this._symbolMaterials=null,this._unusedSymbolsCache.put(r,t,u.MinPriority),e=!0)})),e&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){}get performanceInfo(){return new J.GraphicsCorePerformanceInfo(this.graphics3DGraphics.size,Array.from(this.graphics3DGraphics.values()).reduce(((e,t)=>e+(t.isVisible()?1:0)),0),this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}},t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"computedExtent",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"currentRenderer",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_frameTaskHandle",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_dataUpdateQueue",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_updateQueue",void 0),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"_viewSpatialReference",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_rendererChangeAbortController",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_elevationInfoChangeAbortController",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_initializeAbortController",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_elevationAlignment",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_scaleVisibility",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_filterVisibility",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_initializePromise",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_spatialIndex",void 0),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"extentPadding",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_featureStore",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_objectStates",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_loadingSymbols",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"compressionTracker",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_forcedUpdatePolicy",void 0),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"effectiveUpdatePolicy",null),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"owner",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"layer",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"graphicSymbolSupported",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"getRenderingInfoWithoutRenderer",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"componentFactories",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"setUidToIdOnAdd",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"featureStore",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"initializePromise",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"scaleVisibility",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"elevationAlignment",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"objectStates",null),t.__decorate([f.property()],e.Graphics3DCore.prototype,"filterVisibility",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"updating",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"dataUpdating",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"running",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null),t.__decorate([f.property({readOnly:!0,dependsOn:[]})],e.Graphics3DCore.prototype,"updatingRemaining",null),t.__decorate([f.property({readOnly:!0})],e.Graphics3DCore.prototype,"displayFeatureLimit",null),t.__decorate([f.property({readOnly:!0,dependsOn:[]})],e.Graphics3DCore.prototype,"averageSymbolComplexity",null),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"hasZ",void 0),t.__decorate([f.property({constructOnly:!0})],e.Graphics3DCore.prototype,"hasM",void 0),t.__decorate([f.property()],e.Graphics3DCore.prototype,"_objectIdField",null),e.Graphics3DCore=ye=t.__decorate([g.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],e.Graphics3DCore),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED"}(ve||(ve={}));class Se{constructor(){this.add=null,this.renderingInfo=null,this.state=ve.NEW,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=ve.NEW,this.abortController=null,this.remove=null}}const we=10,xe=b.create(),Te=b.create(),Ce=new Map;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/renderers/support/rendererConversion":function(){define(["exports","../../core/arrayUtils","../../core/has","../../core/Error","../../symbols/support/symbolConversion"],(function(e,t,r,i,s){"use strict";function n(e){return null==e||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type||"heatmap"===e.type}function o(e,t){if(!t)return null;if(Array.isArray(t)||(t=[t]),t.length>0){const r=t.map((e=>e.details.symbol.type||e.details.symbol.declaredClass)).filter((e=>!!e));r.sort();const s=new Array;return r.forEach(((e,t)=>{0!==t&&e===r[t-1]||s.push(e)})),new i("renderer-conversion-3d:unsupported-symbols",`Renderer contains symbols (${s.join(", ")}) which are not supported in 3D`,{renderer:e,symbolErrors:t})}return null}e.isSupportedRenderer3D=n,e.validateTo3D=function(e,r){if(null==e)return null;if(!n(e))return new i("renderer-conversion-3d:unsupported-renderer",`Unsupported renderer of type '${e.type||e.declaredClass}'`,{renderer:e});switch(e.type){case"simple":return function(e,t){const r={...s.defaultTo3DOptions,...t,cimFallbackEnabled:!0};return o(e,s.to3D(e.symbol,r).error)}(e,r);case"unique-value":return function(e,r){const i={...s.defaultTo3DOptions,...r,cimFallbackEnabled:!0},n=e.uniqueValueInfos?.map((e=>s.to3D(e.symbol,i).error)).filter(t.isSome),a=s.to3D(e.defaultSymbol,i);return a.error&&n?.unshift(a.error),o(e,n)}(e,r);case"class-breaks":return function(e,r){const i={...s.defaultTo3DOptions,...r,cimFallbackEnabled:!0},n=e.classBreakInfos.map((e=>s.to3D(e.symbol,i).error)).filter(t.isSome),a=s.to3D(e.defaultSymbol,i);return a.error&&n.unshift(a.error),o(e,n)}(e,r);case"dictionary":case"heatmap":return null}return null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DFeatureStore":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/projectionUtils","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/OptimizedFeature","../../../../layers/graphics/OptimizedGeometry","../../../../layers/graphics/data/optimizedFeatureQueryEngineAdapter"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";const f=u.create();e.Graphics3DFeatureStore=class extends r{constructor(e){super(e),this.events=new i,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(e,t)=>"graphic"in e?e.graphic.attributes[t]:m.optimizedFeatureQueryEngineAdapter.getAttribute(e,t),getAttributes:e=>"graphic"in e?e.graphic.attributes:m.optimizedFeatureQueryEngineAdapter.getAttributes(e),getObjectId:e=>"graphic"in e?d.getObjectId(e.graphic,this.objectIdField)??void 0:m.optimizedFeatureQueryEngineAdapter.getObjectId(e),getGeometry:e=>"graphic"in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):m.optimizedFeatureQueryEngineAdapter.getGeometry(e),getCentroid:(e,t)=>{if("graphic"in e){let r=null;null!=e.centroid?r=e.centroid:"point"===e.graphic.geometry.type&&c.projectPoint(e.graphic.geometry,g,this.viewSpatialReference)&&(r=g);const i=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return null==r?(i[0]=0,i[1]=0,i[2]=0,i[3]=0):(i[0]=r.x,i[1]=r.y,t.hasZ&&(i[2]=r.hasZ?r.z:0),t.hasM&&(i[t.hasZ?3:2]=r.hasM?r.m:0)),new p([],i)}return m.optimizedFeatureQueryEngineAdapter.getCentroid(e,t)},cloneWithGeometry:(e,t)=>"graphic"in e?new h.OptimizedFeature(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):m.optimizedFeatureQueryEngineAdapter.cloneWithGeometry(e,t)}}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t){const r=this.getSpatialIndex();for(const i of e){const e=this.featureAdapter.getObjectId(i);null!=r.getBounds(e,f)&&t(f)}}},t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"getSpatialIndex",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"forEach",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"hasZ",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"hasM",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"objectIdField",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"viewSpatialReference",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFeatureStore.prototype,"featureSpatialReference",void 0),e.Graphics3DFeatureStore=t.__decorate([l.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],e.Graphics3DFeatureStore);const g={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/optimizedFeatureQueryEngineAdapter":function(){define(["exports","../OptimizedFeature"],(function(e,t){"use strict";const r={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,r)=>new t.OptimizedFeature(r,e.attributes,null,e.objectId),getGeometry:e=>e.geometry,getCentroid:(e,t)=>e.ensureCentroid(t)};e.optimizedFeatureQueryEngineAdapter=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DSymbolFactory":function(){define(["exports","./Graphics3DPointSymbol","./Graphics3DSymbol"],(function(e,t,r){"use strict";e.make=function(e,i,s){return"point-3d"===e.type?new t.Graphics3DPointSymbol(e,i,s):new r.Graphics3DSymbol(e,i,s)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DPointSymbol":function(){define(["exports","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/promiseUtils","./Graphics3DCalloutSymbolLayerFactory","./Graphics3DLineCalloutSymbolLayer","./Graphics3DSymbol"],(function(e,t,r,i,s,n,o){"use strict";class a extends o.Graphics3DSymbol{constructor(e,t,r){super(e,t,r),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=s.make(this.symbol,t))}async doLoad(e){const r=this._calloutSymbolLayer?t.result(this._calloutSymbolLayer.load()):null;try{await super.doLoad(e),i.throwIfAborted(e)}catch(e){throw this._calloutSymbolLayer?.abortLoad(),e}r&&await r}destroy(){super.destroy(),this._calloutSymbolLayer=r.destroyMaybe(this._calloutSymbolLayer)}createGraphics3DGraphic(e,t){const r=super.createGraphics3DGraphic(e,t);if(null!=this._calloutSymbolLayer&&null!=r){const t=this._createCalloutGraphic(e);t&&r.setCalloutGraphic(t)}return r}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,(e=>e.calloutLayer)))}updateGeometry(e,t){const r=super.updateGeometry(e,t);if(r&&this._calloutSymbolLayer){const r=e.calloutLayer;if(r)return this._calloutSymbolLayer.updateGeometry(r,t)}return r}_createCalloutGraphic(e){const t=e.renderingInfo;return e.renderingInfo=new n.LineCalloutSymbolLayerRenderingInfo(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}}e.Graphics3DPointSymbol=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/GraphicsCorePerformanceInfo":function(){define(["exports"],(function(e){"use strict";e.GraphicsCorePerformanceInfo=class{constructor(e,t,r,i){this.total=e,this.visible=t,this.missing=r,this.pending=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/GraphicStateTracking":function(){define(["exports","../../../../core/arrayUtils","../../../../core/handleUtils","../../../../layers/graphics/dehydratedFeatures"],(function(e,t,r,i){"use strict";e.GraphicStateTracking=class{constructor(e){this._graphicsCore=e,this._idToState=new Map,this._states=new Set;const t=e.owner.layer?.objectIdField;t?(this._getGraphicId=e=>i.getObjectId(e,t),this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicByObjectId(e)):(this._getGraphicId=e=>e.uid,this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicById(e))}destroy(){this._idToState.clear(),this._states.forEach(((e,t)=>this.remove(t)))}add(e){const t=r.makeHandle((()=>this.remove(e)));if(this._states.has(e))return t;const i=this._getGraphicId(e.graphic),s=this._getGraphics3DGraphicById(i);return this._states.has(e)||this._states.add(e),this._ensureStateList(i).push(e),e.displaying=null!=s&&s.isVisible(),e.isDraped=null!=s&&s.isDraped,e.tracking=!0,null!=s&&e.emit("changed"),t}remove(e){if(this._states.has(e)){if(this._idToState.size){const r=this._getGraphicId(e.graphic),i=this._idToState.get(r);i&&(t.remove(i,e),0===i.length&&this._idToState.delete(r))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e.graphic,(t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed")}))}removeGraphic(e){this._forEachState(e.graphic,(e=>{e.displaying=!1,e.isDraped=!1}))}updateGraphicGeometry(e){this._forEachState(e.graphic,(e=>e.emit("changed")))}updateGraphicVisibility(e){this._forEachState(e.graphic,(t=>t.displaying=e.isVisible()))}updateGraphicError(e,t){this._forEachState(e,(e=>e.error=t))}allGraphicsDeleted(){this._states.forEach((e=>e.displaying=!1))}_ensureStateList(e){const t=this._idToState.get(e);if(t)return t;const r=new Array;return this._idToState.set(e,r),r}_forEachState(e,t){if(0===this._states.size||0===this._idToState.size)return;const r=this._getGraphicId(e),i=this._idToState.get(r);null!=i&&i.forEach(t)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/SpatialIndex2D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/has","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/rbush/PooledRBush","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/dehydratedFeatures"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";e.SpatialIndex2D=class extends r{constructor(e){super(e),this._index=new c.PooledRBush(9,i("esri-csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index=s.destroyMaybe(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,r){null!=t&&t.equals(this.spatialReference)&&(h.minX=e[0],h.minY=e[1],h.maxX=e[2],h.maxY=e[3],this.update(),this._index.search(h,(e=>r(e.graphic.uid))))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);if(!e.extent)return;this._index.remove(e);const t=d.getObjectId(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}_addMany(e){if(0===e.length)return;const t=this._get("objectIdField");for(const r of e){r.computeExtent(this.spatialReference);const e=d.getObjectId(r.graphic,t);null!=e&&this._boundsByFeature.set(e,r.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){h.minX=e[0],h.minY=e[1],h.maxX=e[2],h.maxY=e[3],this.update(),this._index.search(h,(e=>{t(e)}))}getBounds(e,t){this.update();const r=this._boundsByFeature.get(e);return r?u.fromRect(t,r):null}},t.__decorate([n.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"spatialReference",void 0),t.__decorate([n.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"hasZ",void 0),t.__decorate([n.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"hasM",void 0),t.__decorate([n.property({constructOnly:!0})],e.SpatialIndex2D.prototype,"objectIdField",void 0),t.__decorate([n.property()],e.SpatialIndex2D.prototype,"updating",void 0),t.__decorate([n.property({readOnly:!0})],e.SpatialIndex2D.prototype,"updatingRemaining",null),e.SpatialIndex2D=t.__decorate([l.subclass("esri.views.3d.layers.graphics.SpatialIndex2D")],e.SpatialIndex2D);const h={minX:0,minY:0,maxX:0,maxY:0};Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/libs/rbush/PooledRBush":function(){define(["exports","../../arrayUtils","../../compilerUtils","../../has","../../PooledArray","../../../chunks/quickselect"],(function(e,t,r,i,s,n){"use strict";function o(e,t){let i=e;for(b.clear();i;){if(!0===i.leaf)for(const e of i.children)t(r.toConst(e));else b.pushArray(i.children);i=b.pop()??null}}function a(e,t){l(e,0,e.children.length,t,e)}function l(e,t,r,i,s){s||(s=new T([])),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let n,o=t;o<r;o++)n=e.children[o],c(s,e.leaf?i(n):n);return s}function c(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function u(e,t){return e.minX-t.minX}function d(e,t){return e.minY-t.minY}function h(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function p(e){return e.maxX-e.minX+(e.maxY-e.minY)}function m(e,t){const r=Math.max(e.minX,t.minX),i=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,s-r)*Math.max(0,n-i)}function f(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function g(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function y(e,t,r,i,s){const o=[t,r];for(;o.length;){const t=o.pop(),r=o.pop();if(t-r<=i)continue;const a=r+Math.ceil((t-r)/i/2)*i;n.quickselect(e,a,r,t,s),o.push(r,a,a,t)}}const _=new s,b=new s,v=new s,S=new s({deallocator:void 0});class w{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class x extends w{constructor(){super(...arguments),this.height=1,this.indexHint=new t.PositionHint}}class T extends x{constructor(e){super(),this.children=e,this.leaf=!0}}class C extends x{constructor(e){super(),this.children=e,this.leaf=!1}}e.BBox=w,e.PooledRBush=class{constructor(e=9,t){this._compareMinX=u,this._compareMinY=d,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),_.prune(),b.prune(),v.prune(),S.prune()}all(e){o(this._data,e)}search(e,t){let r=this._data;const i=this._toBBox;if(g(e,r))for(_.clear();r;){for(let s=0,n=r.children.length;s<n;s++){const n=r.children[s],a=r.leaf?i(n):n;g(e,a)&&(r.leaf?t(n):f(e,a)?o(n,t):_.push(n))}r=_.pop()}}collides(e){let t=this._data;const r=this._toBBox;if(!g(e,t))return!1;for(_.clear();t;){for(let i=0,s=t.children.length;i<s;i++){const s=t.children[i],n=t.leaf?r(s):s;if(g(e,n)){if(t.leaf||f(e,n))return!0;_.push(s)}}t=_.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,r=e.length;t<r;t++)this.insert(e[t]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new T([]),this}remove(e){if(!e)return this;let i,s=this._data,n=null,o=0,a=!1;const l=this._toBBox(e);for(v.clear(),S.clear();s||v.length>0;){if(s||(s=v.pop(),n=v.data[v.length-1],o=S.pop()??0,a=!0),s.leaf&&(i=t.indexOf(s.children,r.toConst(e),s.children.length,s.indexHint),-1!==i))return s.children.splice(i,1),v.push(s),this._condense(v),this;a||s.leaf||!f(s,l)?n?(o++,s=n.children[o],a=!1):s=null:(v.push(s),S.push(o),o=0,n=s,s=s.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_build(e,t,r,i){const s=r-t+1;let n=this._maxEntries;if(s<=n){const i=new T(e.slice(t,r+1));return a(i,this._toBBox),i}i||(i=Math.ceil(Math.log(s)/Math.log(n)),n=Math.ceil(s/n**(i-1)));const o=new C([]);o.height=i;const l=Math.ceil(s/n),c=l*Math.ceil(Math.sqrt(n));y(e,t,r,c,this._compareMinX);for(let s=t;s<=r;s+=c){const t=Math.min(s+c-1,r);y(e,s,t,l,this._compareMinY);for(let r=s;r<=t;r+=l){const s=Math.min(r+l-1,t);o.children.push(this._build(e,r,s,i-1))}}return a(o,this._toBBox),o}_insert(e,t,r){const i=this._toBBox,s=r?e:i(e);v.clear();const n=function(e,t,r,i){for(;i.push(t),!0!==t.leaf&&i.length-1!==r;){let r,i=1/0,o=1/0;for(let a=0,l=t.children.length;a<l;a++){const l=t.children[a],c=h(l),u=(s=e,n=l,(Math.max(n.maxX,s.maxX)-Math.min(n.minX,s.minX))*(Math.max(n.maxY,s.maxY)-Math.min(n.minY,s.minY))-c);u<o?(o=u,i=c<i?c:i,r=l):u===o&&c<i&&(i=c,r=l)}t=r||t.children[0]}var s,n;return t}(s,this._data,t,v);for(n.children.push(e),c(n,s);t>=0&&v.data[t].children.length>this._maxEntries;)this._split(v,t),t--;!function(e,t,r){for(let i=r;i>=0;i--)c(t.data[i],e)}(s,v,t)}_split(e,t){const r=e.data[t],i=r.children.length,s=this._minEntries;this._chooseSplitAxis(r,s,i);const n=this._chooseSplitIndex(r,s,i);if(!n)return;const o=r.children.splice(n,r.children.length-n),l=r.leaf?new T(o):new C(o);l.height=r.height,a(r,this._toBBox),a(l,this._toBBox),t?e.data[t-1].children.push(l):this._splitRoot(r,l)}_splitRoot(e,t){this._data=new C([e,t]),this._data.height=e.height+1,a(this._data,this._toBBox)}_chooseSplitIndex(e,t,r){let i,s,n;i=s=1/0;for(let o=t;o<=r-t;o++){const t=l(e,0,o,this._toBBox),a=l(e,o,r,this._toBBox),c=m(t,a),u=h(t)+h(a);c<i?(i=c,n=o,s=u<s?u:s):c===i&&u<s&&(s=u,n=o)}return n}_chooseSplitAxis(e,t,r){const i=e.leaf?this._compareMinX:u,s=e.leaf?this._compareMinY:d;this._allDistMargin(e,t,r,i)<this._allDistMargin(e,t,r,s)&&e.children.sort(i)}_allDistMargin(e,t,r,i){e.children.sort(i);const s=this._toBBox,n=l(e,0,t,s),o=l(e,r-t,r,s);let a=p(n)+p(o);for(let i=t;i<r-t;i++){const t=e.children[i];c(n,e.leaf?s(t):t),a+=p(n)}for(let i=r-t-1;i>=t;i--){const t=e.children[i];c(o,e.leaf?s(t):t),a+=p(o)}return a}_condense(e){for(let r=e.length-1;r>=0;r--){const i=e.data[r];if(0===i.children.length)if(r>0){const s=e.data[r-1],n=s.children;n.splice(t.indexOf(n,i,n.length,s.indexHint),1)}else this.clear();else a(i,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/quickselect":function(){define(["exports"],(function(e){"use strict";function t(e,i,s,n,o){for(;n>s;){if(n-s>600){var a=n-s+1,l=i-s+1,c=Math.log(a),u=.5*Math.exp(2*c/3),d=.5*Math.sqrt(c*u*(a-u)/a)*(l-a/2<0?-1:1);t(e,i,Math.max(s,Math.floor(i-l*u/a+d)),Math.min(n,Math.floor(i+(a-l)*u/a+d)),o)}var h=e[i],p=s,m=n;for(r(e,s,i),o(e[n],h)>0&&r(e,s,n);p<m;){for(r(e,p,m),p++,m--;o(e[p],h)<0;)p++;for(;o(e[m],h)>0;)m--}0===o(e[s],h)?r(e,s,m):r(e,++m,n),m<=i&&(s=m+1),i<=m&&(n=m-1)}}function r(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function i(e,t){return e<t?-1:e>t?1:0}e.quickselect=function(e,r,s,n,o){t(e,r,s||0,n||e.length-1,o||i)}}))},"esri/views/3d/layers/support/StageLayerElevationProvider":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../symbols/support/unitConversionUtils","../../support/ElevationUpdateEvent","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/VertexAttribute"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";const _=Symbol("layerHandles");e.StageLayerElevationProvider=class extends(i.EventedMixin(r)){get spatialReference(){return this.view?.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new f.Intersector(this.view.state.viewingMode),this._intersector.options.store=g.StoreResults.MIN;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on(["layerObjectAdded","layerObjectRemoved","transformationChanged","shaderTransformationChanged"],(e=>this._objectChanged(e))),t.on(["geometryAdded","geometryRemoved"],(({object:e})=>this._objectChanged(e))),t.on("attributesChanged",(({attribute:e,object:t})=>y.affectsGeometry(e)&&this._objectChanged(t)))],_)}dispose(){this.removeHandles(_)}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=n.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=p.getMetersPerUnit(e.unit??"meters");this._elevationOffset=(e.offset??0)*r/t}else this._elevationOffset=0}getElevation(e,t,r,i){if(S[0]=e,S[1]=t,S[2]=r,!this._renderCoordsHelper.toRenderCoords(S,i,S))return s.getLogger(this).error("could not project point for elevation alignment"),null;const n=this._elevationOffset,o=this._zmin+n,a=this._zmax+n;return this._renderCoordsHelper.setAltitude(w,a,S),this._renderCoordsHelper.setAltitude(x,o,S),this._intersector.reset(w,x,null),this._intersector.intersect(this._intersectLayers,null,1,null,(e=>!!e.lastValidElevationBB)),this._intersector.results.min.getIntersectionPoint(S)?this._renderCoordsHelper.getAltitude(S):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;h.empty(b);const r=e.lastValidElevationBB;r.isEmpty()||this._expandExtent(t,r.min,r.max,b);const{min:i,max:s}=e.boundingVolumeWorldSpace;this._expandExtent(t,i,s,b),h.toRect(b,v.extent),this._zmin=Math.min(this._zmin,b[2]),this._zmax=Math.max(this._zmax,b[5]),v.spatialReference=t,this.emit("elevation-change",v),u.copy(r.min,i),u.copy(r.max,s)}_computeLayerExtent(e,t){return h.empty(b),null!=e&&t.objects.forEach((t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,b))),b}_expandExtent(e,t,r,i){for(let s=0;s<8;++s)S[0]=1&s?t[0]:r[0],S[1]=2&s?t[1]:r[1],S[2]=4&s?t[2]:r[2],this._renderCoordsHelper.fromRenderCoords(S,S,e),h.expandWithVec3(i,S);return i}},t.__decorate([o.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"layer",void 0),t.__decorate([o.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"stageLayer",void 0),t.__decorate([o.property({constructOnly:!0})],e.StageLayerElevationProvider.prototype,"view",void 0),t.__decorate([o.property()],e.StageLayerElevationProvider.prototype,"spatialReference",null),e.StageLayerElevationProvider=t.__decorate([c.subclass("esri.views.3d.layers.support.StageLayerElevationProvider")],e.StageLayerElevationProvider);const b=h.empty(),v=new m.ElevationUpdateEvent,S=d.create(),w=d.create(),x=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DElevationAlignment":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./ExtentSet","../../webgl-engine/lib/UpdatePolicy","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";function p(e){return null==e?h.TaskPriority.ELEVATION_ALIGNMENT:"relative-to-scene"===e?h.TaskPriority.ELEVATION_ALIGNMENT_SCENE:h.TaskPriority.ELEVATION_ALIGNMENT}e.Graphics3DElevationAlignment=class extends r{constructor(e){super(e),this._dirtyExtents=new u.ExtentSet,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new i}initialize(){const e=this.elevationProvider,t=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=t.registerTask(p(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([e.on("elevation-change",(e=>this._elevationChanged(e))),s.watch((()=>this.graphicsCoreOwner.suspended),(()=>this._suspendedChange())),this._task,s.watch((()=>p(this.graphicsCore.layer.elevationInfo?.mode)),(e=>this._task.priority=e))])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run((()=>this._dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,r=this.graphicsCore.effectiveUpdatePolicy===d.UpdatePolicy.ASYNC;for(const i of this._dirtyGraphicsSet.keys()){const s=this.graphicsCore.getGraphics3DGraphicById(i);if(this._dirtyGraphicsSet.delete(i),null!=s&&(s.alignWithElevation(this.elevationProvider,t,r),this.graphicsCore.deconflictor?.setDirty(),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){const t=this._dirtyExtents.pop(),r=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:r});const i=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,r,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);null!=t&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e)})),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-i)+.9*this._averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this._dirtyGraphicsSet.add(t)))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const t=e.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",e)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}},t.__decorate([n.property()],e.Graphics3DElevationAlignment.prototype,"graphicsCoreOwner",void 0),t.__decorate([n.property()],e.Graphics3DElevationAlignment.prototype,"graphicsCore",void 0),t.__decorate([n.property()],e.Graphics3DElevationAlignment.prototype,"queryGraphicUIDsInExtent",void 0),t.__decorate([n.property()],e.Graphics3DElevationAlignment.prototype,"elevationProvider",void 0),t.__decorate([n.property({readOnly:!0})],e.Graphics3DElevationAlignment.prototype,"updating",null),t.__decorate([n.property({readOnly:!0})],e.Graphics3DElevationAlignment.prototype,"updatingRemaining",null),e.Graphics3DElevationAlignment=t.__decorate([c.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],e.Graphics3DElevationAlignment),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/ExtentSet":function(){define(["exports","../../../../core/has","../../../../core/PooledArray","../../../../geometry/support/aaBoundingRect","../../../support/Scheduler"],(function(e,t,r,i,s){"use strict";e.ExtentSet=class{constructor(){this._extents=new r({allocator:e=>e||i.create()}),this._tmpExtent=i.create(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),i.copy(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(e=s.noBudget){const t=this._extents,r=new Set;let n=0;for(;n!==t.length;){t.sort(((e,t)=>e[0]-t[0])),n=t.length,r.clear();for(let s=0;s<t.length;++s){if(e.done)return;const n=t.at(s);if(n){for(let e=s+1;e<t.length;++e){const i=t.at(e);if(null==i||i[0]>=n[2])break;r.add(i)}r.forEach((s=>{if(n===s)return;if(s[2]<=n[0])return void r.delete(s);const o=i.area(n),a=i.area(s),l=this._tmpExtent;i.expand(n,s,l);const c=o+a;(i.area(l)-c)/c<.05&&(i.copy(n,l),r.delete(s),t.remove(s),e.madeProgress())})),r.add(n)}}}this._dirty=!1}_contains(e){return this._extents.some((t=>i.contains(t,e)))}_removeContained(e){this._extents.filterInPlace((t=>!i.contains(e,t)))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DFrustumVisibility":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/ellipsoidUtils","../../support/FrustumExtentIntersection","../../../support/Scheduler","../../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";e.Graphics3DFrustumVisibility=class extends r{constructor(e){super(e),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:e}=this;this._extentIntersection=new u.FrustumExtentIntersection({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,r=t.basemapTerrain,s=t.resourceController.scheduler;this.addHandles([t.on("resize",(()=>this._viewChange())),i.watch((()=>t.state.camera),(()=>this._viewChange()),i.sync),s.registerTask(d.TaskPriority.FRUSTUM_VISIBILITY,this),i.watch((()=>r.visibleElevationBounds),(()=>this._elevationBoundsChange()))]),"local"===t.viewingMode?this._isVisibleBelowSurface=!0:this.addHandles([i.watch((()=>[r.baseOpacity,r.wireframe,t.map?.ground?.navigationConstraint?.type]),(()=>this._updateIsVisibleBelowSurface()),i.initial)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){const e=this.graphicsCoreOwner.view,t=e.basemapTerrain,r="local"===e.viewingMode,i="none"===e.map.ground?.navigationConstraint?.type;this._isVisibleBelowSurface=r||!t.opaque||i}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const e=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*c.getReferenceEllipsoid(e.spatialReference).radius;else{const{min:r,max:i}=e.basemapTerrain.visibleElevationBounds;t=r-Math.max(1,(i-r)*(1.2-1))}this._extentIntersection.update(this._extent,e.spatialReference,t)}get running(){return this.updating}runTask(e){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),h.Yield;this._updateExtentIntersection();const t=this.graphicsCoreOwner.view.frustum,r=c.getReferenceEllipsoid(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(t,r)),e.madeProgress()}},t.__decorate([s.property({readOnly:!0})],e.Graphics3DFrustumVisibility.prototype,"suspended",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DFrustumVisibility.prototype,"graphicsCoreOwner",void 0),t.__decorate([s.property({readOnly:!0})],e.Graphics3DFrustumVisibility.prototype,"updating",void 0),e.Graphics3DFrustumVisibility=t.__decorate([l.subclass("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],e.Graphics3DFrustumVisibility),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/FrustumExtentIntersection":function(){define(["exports","../../../core/compilerUtils","../../../core/mathUtils","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/ellipsoidUtils","../../../geometry/projection/computeTranslationToOriginAndRotation","../../../geometry/projection/projectBoundingRect","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/frustum","../../../geometry/support/lineSegment","../../../geometry/support/plane","../../../geometry/support/ray","../../ViewingMode","./intersectionUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_){"use strict";const b=.5*Math.PI,v=b/Math.PI*180,S=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],w=o.create(),x=s.create(),T=s.create(),C=d.create(),P=h.create(),M=m.create();e.FrustumExtentIntersection=class{constructor(e){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:o.create(),direction:o.create()},this._renderCoordsHelper=e.renderCoordsHelper;for(let e=0;e<4;e++)this._extent[e]={origin:o.create(),direction:o.create(),cap:{next:null,direction:o.create()}},this._planes[e]=f.create();this._planes[p.PlaneIndex.NEAR]=f.create(),this._planes[p.PlaneIndex.FAR]=f.create(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,r,i=!0){const s=this._extent;this._toRenderBoundingExtent(e,t,r),n.add(this._center.origin,s[0].origin,s[2].origin),n.scale(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),i||n.scale(this._center.direction,this._center.direction,-1);for(let e=0;e<4;e++){const t=s[e];this._renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);const r=s[3===e?0:e+1];t.cap.next=r.origin,n.direction(t.cap.direction,t.origin,r.origin),f.fromVectorsAndPoint(t.direction,t.cap.direction,t.origin,this._planes[e]),i||n.scale(t.direction,t.direction,-1)}f.fromVectorsAndPoint(s[0].cap.direction,s[1].cap.direction,s[0].origin,this._planes[p.PlaneIndex.NEAR]),i?f.negate(this._planes[p.PlaneIndex.NEAR],this._planes[p.PlaneIndex.FAR]):(f.copy(this._planes[p.PlaneIndex.FAR],this._planes[p.PlaneIndex.NEAR]),f.negate(this._planes[p.PlaneIndex.NEAR],this._planes[p.PlaneIndex.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*a.getReferenceEllipsoid(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,r=!1){if(null==e)return!1;if(this._renderCoordsHelper.viewingMode===y.ViewingMode.Global){const r=this._maxSpanSpatialReference.isGeographic?v:b*t;if(this._maxSpan>r)return!0;if(null!=e.altitude&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(0===this._maxSpan){const t=this._extent[0];return!(r||!e.intersectsRay(g.wrap(t.origin,t.direction)))}for(let t=0;t<this._extent.length;t++){const i=this._extent[t];if(!r&&e.intersectsRay(g.wrap(i.origin,i.direction)))return!0;if(e.intersectsLineSegment(m.fromPoints(i.origin,i.cap.next,M),i.cap.direction))return!0}const i=r?this._planes:this._planesWithoutFar;for(let t=0;t<e.lines.length;t++){const r=e.lines[t];if(_.frustumLineSegment(i,r.origin,r.endpoint,r.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,s){h.center(e,w),w[2]=s,l.computeTranslationToOriginAndRotation(t,w,x,this._renderCoordsHelper.spatialReference),i.invert(T,x),d.empty(C);for(const{x0:i,x1:o,y0:a,y1:l}of S)for(let c=0;c<5;c++){const h=c/4;w[0]=r.lerp(e[i],e[o],h),w[1]=r.lerp(e[a],e[l],h),w[2]=s,u.projectVectorToVector(w,t,w,this._renderCoordsHelper.spatialReference),n.transformMat4(w,w,T),d.expandWithVec3(C,w)}n.set(this._extent[0].origin,C[0],C[1],C[2]),n.set(this._extent[1].origin,C[3],C[1],C[2]),n.set(this._extent[2].origin,C[3],C[4],C[2]),n.set(this._extent[3].origin,C[0],C[4],C[2]);for(let e=0;e<4;++e)n.transformMat4(this._extent[e].origin,this._extent[e].origin,x)}_toRenderBoundingExtentLocal(e,t,r){c.projectBoundingRect(e,t,P,this._renderCoordsHelper.spatialReference),n.set(this._extent[0].origin,P[0],P[1],r),n.set(this._extent[1].origin,P[2],P[1],r),n.set(this._extent[2].origin,P[2],P[3],r),n.set(this._extent[3].origin,P[0],P[3],r)}_toRenderBoundingExtent(e,r,i){switch(this._renderCoordsHelper.viewingMode){case y.ViewingMode.Global:this._toRenderBoundingExtentGlobal(e,r,i);break;case y.ViewingMode.Local:this._toRenderBoundingExtentLocal(e,r,i);break;default:t.neverReached(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(f.signedDistance(e.planes[p.PlaneIndex.NEAR],this._center.origin)<0&&n.dot(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const r=this._extent[t];if(f.signedDistance(e.planes[p.PlaneIndex.NEAR],r.origin)<0&&n.dot(r.direction,e.direction)<0)return!0}return!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DObjectStates":function(){define(["exports","../../../../core/handleUtils","../../../../core/has","./Graphics3DObjectStateSet"],(function(e,t,r,i){"use strict";e.Graphics3DObjectStates=class{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach((e=>e.objectStateSet.removeAll())),this._stateSets.length=0)}acquireOccludeeSet(e){const r=new i.Graphics3DOccludeeStateSet(e);this._stateSets.push(r);const s=t.makeHandle((()=>this.releaseSet(r)));return{set:r,handle:s}}acquireHighlightSet(e,r){const s=new i.Graphics3DObjectHighlightStateSet(e,r);this._stateSets.push(s);const n=t.makeHandle((()=>this.releaseSet(s)));return{set:s,handle:n}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}setUid(e,t){e.ids.add(t);const r=this._graphicsCore.graphics3DGraphics.get(t);r&&r.addObjectStateSet(e.objectStateSet)}setUids(e,t){t.forEach((t=>this.setUid(e,t)))}setObjectIds(e,t){t.forEach((t=>e.ids.add(t))),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach((t=>{!t.paused&&t.hasGraphic(e)&&e.addObjectStateSet(t.objectStateSet)}))}removeGraphic(e){this._stateSets.forEach((t=>{t.hasGraphic(e)&&e.removeObjectState(t.objectStateSet)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll()))}_initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach((t=>{t&&e.hasGraphic(t)&&t.addObjectStateSet(e.objectStateSet)})):e.ids.forEach((r=>{const i=t.get(r);i&&i.addObjectStateSet(e.objectStateSet)}))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DObjectStateSet":function(){define(["exports","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Object3DStateSet"],(function(e,t,r){"use strict";class i{constructor(e){this.objectIdField=e,this.ids=new Set,this.paused=!1}hasGraphic(e){const t=this.objectIdField?e.graphic.attributes[this.objectIdField]:e.graphic.uid;return this.ids.has(t)}}e.Graphics3DObjectHighlightStateSet=class extends i{constructor(e,i){super(i),this.highlightName=e,this.stateType=t.Object3DState.Highlight,this.objectStateSet=new r.Object3DHighlightStateSet(e)}},e.Graphics3DOccludeeStateSet=class extends i{constructor(e){super(e),this.stateType=t.Object3DState.MaskOccludee,this.objectStateSet=new r.Object3DOccludeeStateSet}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/Object3DStateSet":function(){define(["exports","./basicInterfaces"],(function(e,t){"use strict";class r{}class i extends r{constructor(e,t){super(),this.objectStateId=e,this.object=t}remove(){this.object.removeStateID(this.objectStateId)}}class s extends r{constructor(e,t,r){super(),this.objectStateId=e,this.object=t,this.owner=r}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}}class n extends r{constructor(e,t){super(),this.objectStateId=e,this._removeCallback=t,this.object=null}remove(){this._removeCallback(this.objectStateId)}}class o{constructor(){this._items=[]}addObject(e,t){this._items.push(new i(t,e))}addRenderGeometry(e,t,r){this._items.push(new s(t,e,r))}addExternal(e,t){this._items.push(new n(t,e))}remove(e){this._remove((t=>t.objectStateId===e))}removeByObject(e){this._remove((t=>t.object===e))}removeAll(){this._items.forEach((e=>e.remove())),this._items=[]}_remove(e){const{_items:t}=this;for(let r=t.length-1;r>=0;--r){const i=t[r];e(i)&&(i.remove(),t.splice(r,1))}}}e.Object3DHighlightStateSet=class extends o{constructor(e){super(),this.highlightName=e,this.stateType=t.Object3DState.Highlight}},e.Object3DOccludeeStateSet=class extends o{constructor(){super(...arguments),this.stateType=t.Object3DState.MaskOccludee}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/Graphics3DScaleVisibility":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../geometry/projection/projectBoundingRect","../../../../geometry/support/aaBoundingRect","./enums","../../../support/layerViewUtils","../../../support/Scheduler","../../../support/Yield"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";function f(e,t){return e>0||t>0}e.Graphics3DScaleVisibility=class extends r{constructor(e){super(e),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new l.UpdatingHandles,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();const e=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(e.registerTask(p.TaskPriority.SCALE_VISIBILITY,this)),this._updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.layerMinMaxScaleChangeHandler()))}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(e){const t=this.graphicsCoreOwner.view.spatialReference,r=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===r)this._extent=e??null;else{const i=u.create();c.projectBoundingRect(e,t,i,r)?this._extent=i:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer,t=e.effectiveScaleRange;let r=this.layerScaleEnabled&&null!=t&&f(t.minScale,t.maxScale);e.labelingInfo&&!r&&(r=e.labelingInfo.some((e=>e&&f(e.minScale??0,e.maxScale??0))));const i=this._scaleRangeActive!==r;return this._scaleRangeActive=r,r&&!this.hasHandles(g)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),g),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),g)):!r&&this.hasHandles(g)&&this.removeHandles(g),i}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(e){const t=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return m.Yield;{this._layerScaleRangeVisibilityQuery=!0;const{minScale:e,maxScale:r}=this.layer.effectiveScaleRange;t.queryVisibleScaleRange(this._extent,e,r,(e=>this._finishUpdate(e)))}}else this._finishUpdate(!0);e.madeProgress()}_finishUpdate(e){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._dirty=!1}_visibleAtLayerScale(e){const t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||h.scaleBoundsPredicate(e,t.minScale||0,t.maxScale||0)}_visibleAtLabelScale(e,t){return h.scaleBoundsPredicate(e,t.minScale||0,t.maxScale||0)}_graphicScale(e){let t;return null!=e.centroid?t=e.centroid:null!=e.graphic.geometry&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}_graphicVisible(e){if(!this.layerScaleEnabled)return!0;const t=this._graphicScale(e);return this._visibleAtLayerScale(t)}updateVisibility(e){if(!this._scaleRangeActive)return!1;const t=this._graphicVisible(e);return e.setVisibilityFlag(d.VisibilityGroup.GRAPHIC,d.VisibilityFlag.SCALE_RANGE,t)}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return!1;if(!e.labelLayers.length)return!1;const t=this._graphicScale(e),r=this._updateLabelScaleVisibility(e,t);return r&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty()),r}_updateLabelScaleVisibility(e,t){if(!e.labelLayers.length)return!1;const r=e.labelLayers[0].labelClass;if(null!=r?.minScale&&null!=r.maxScale){const i=this._visibleAtLabelScale(t,r);if(e.setVisibilityFlag(d.VisibilityGroup.LABEL,d.VisibilityFlag.SCALE_RANGE,i))return!0}return!1}_scaleUpdateHandler(e){if(this._setDirty(),!this.graphicsCore.visible)return;const t=e.extent,r=e.scale,s=this._visibleAtLayerScale(r);let n=!1;const o=this.graphicsCoreOwner.view.spatialReference,a=e.spatialReference;if(null==a)return void i.getLogger(this).error("scaleUpdate: Internal error, no SpatialReference given for tiles");const l=!a.equals(o);if(l&&!c.projectBoundingRect(t,a,y,o))return void i.getLogger(this).error("scaleUpdate: Internal error, cannot project AABR from "+a+" to wkid "+o);const u=l?y:t;this.queryGraphicUIDsInExtent(u,o,(e=>{const i=this.graphicsCore.getGraphics3DGraphicById(e);if(null==i)return;const o=i.centroid;null!=o&&(t[0]>o.x||t[1]>o.y||t[2]<o.x||t[3]<o.y)||(i.setVisibilityFlag(d.VisibilityGroup.GRAPHIC,d.VisibilityFlag.SCALE_RANGE,s)&&(n=!0),this._updateLabelScaleVisibility(i,r)&&(n=!0))})),n&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(d.VisibilityGroup.GRAPHIC,d.VisibilityFlag.SCALE_RANGE,!0))):this._scaleRangeActive&&this.graphicsCore.updateGraphicsVisibilities(),this._setDirty()}},t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"graphicsCoreOwner",void 0),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"layer",void 0),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"queryGraphicUIDsInExtent",void 0),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"graphicsCore",void 0),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"basemapTerrain",void 0),t.__decorate([s.property({constructOnly:!0})],e.Graphics3DScaleVisibility.prototype,"layerScaleEnabled",void 0),t.__decorate([s.property({readOnly:!0})],e.Graphics3DScaleVisibility.prototype,"suspended",void 0),t.__decorate([s.property({readOnly:!0})],e.Graphics3DScaleVisibility.prototype,"updating",null),t.__decorate([s.property()],e.Graphics3DScaleVisibility.prototype,"_dirty",void 0),e.Graphics3DScaleVisibility=t.__decorate([a.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],e.Graphics3DScaleVisibility);const g="terrain-events",y=u.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/attributeUtils":function(){define(["exports"],(function(e){"use strict";e.attributeLookup=function(e,t,r){if(!r||null==t)return null;if(!e)return function(e,t){const r=t.toLowerCase();for(const t in e)if(t.toLowerCase()===r)return e[t];return null}(t,r);const i=e.get(r);return i?t[i.name]:null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FeatureVisibilityFilter":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/reactiveUtils","../../../../core/sql","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/support/UpdatingHandles","../../../../layers/support/FeatureFilter","../../../../layers/support/floorFilterUtils","../graphics/QueryEngine","../graphics/QueryEngineContext","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";e.FeatureVisibilityFilter=class extends r{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new h.UpdatingHandles,this._abortController=new AbortController}initialize(){const e=y.TaskPriority.FILTER_VISIBILITY,{layer:t,view:r}=this._configuration,{featureStore:i}=this.context,{spatialReference:s,resourceController:a}=r,l=this._configuration.hasZ??!1,c=this._configuration.hasM??!1,u=new g.QueryEngineContext(s,t,a,(()=>i),l,c);this._queryEngine=new f.QueryEngine({context:u,priority:e}),this._frameTask=r.resourceController.scheduler.registerTask(e),this._updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this._updateRequested=!0),o.initial),this._updatingHandles.addWhen((()=>!this._frameTask.updating&&this._updateRequested),(()=>{this._frameTask.schedule((()=>this._updateVisibility()),this._abortController.signal).catch(n.throwIfNotAbortError),this._updateRequested=!1}),o.initial)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=s.removeMaybe(this._frameTask),this._queryEngine=s.destroyMaybe(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _effectiveDisplayFilter(){return"effectiveDisplayFilter"in this._configuration?this._configuration.effectiveDisplayFilter:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return m.getFloorFilterClause(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_effectiveDisplayFilter:t,_timeExtent:r,_floorFilter:i}=this;let s=e?.clone();if(null!=t&&(s??=new p,s.where=a.sqlAnd(s.where,t.where)),null!=r&&(s??=new p,s.timeExtent=s.timeExtent?.intersection(r)??r),null!=i){s??=new p;const e=null==s.where||""===s.where;s.where=e?i:a.sqlAnd(s.where,i)}return s}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async _updateVisibility(){const{signal:e}=this._abortController,{context:t,_frameTask:r,_sceneFilter:s,_compositedFeatureFilter:o}=this;if(n.throwIfAborted(e),null==o&&null==s||0===t.getFeatureCount())return await r.schedule((()=>this.clear()),e);try{const i=await this._updatingHandles.addPromise(this._queryEngine.executeQueryForIdSet(o,s,e));return n.throwIfAborted(e),await r.schedule((()=>{t.updateFeatureVisibilities((e=>i.has(e)))}),e)}catch(s){return n.throwIfAbortError(s),i.getLogger(this).warn(`FeatureFilter query failed: ${s}`,{error:s}),await r.schedule((()=>{t.setAllFeaturesVisibility(!0)}),e)}}},t.__decorate([l.property({constructOnly:!0})],e.FeatureVisibilityFilter.prototype,"context",void 0),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"updating",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"defaultVisibility",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_featureFilter",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_effectiveDisplayFilter",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_sceneFilter",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_floorFilter",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_timeExtent",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_configuration",null),t.__decorate([l.property()],e.FeatureVisibilityFilter.prototype,"_updateRequested",void 0),e.FeatureVisibilityFilter=t.__decorate([d.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],e.FeatureVisibilityFilter),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/support/floorFilterUtils":function(){define(["exports"],(function(e){"use strict";function t(e,t){if(!e?.length)return null;const r=e.filter((e=>""!==e)).map((e=>`'${e}'`));return r.push("''"),`${t} IN (${r.join(",")}) OR ${t} IS NULL`}e.getFloorFilterClause=function(e){const r=e.layer;return"floorInfo"in r&&r.floorInfo?.floorField&&"floors"in e.view?t(e.view.floors,r.floorInfo.floorField):null},e.getLayerFloorFilterClause=function(e,r){return"floorInfo"in r&&r.floorInfo?.floorField?t(e,r.floorInfo.floorField):null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/QueryEngine":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../geometry/support/typeUtils","../../../../layers/graphics/data/QueryEngine","../../../../layers/support/FieldsIndex","../../../../rest/support/FeatureSet","../../../../rest/support/Query","../../../2d/layers/features/layerAdapters/featureServiceUtils","./QueryEngineCache"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";const g=u.QueryEngine;e.QueryEngine=class extends r{constructor(e){super(e),this._dataQueryEngineInstance=null}destroy(){this.clear()}get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new p({outSpatialReference:this.spatialReference}).toJSON()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t,r){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),r)}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:r,extent:i}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:l.fromJSON(i)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const r=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),i=h.fromJSON(r);return i.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),i}async executeQuery(e,t){const r=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),i=h.fromJSON(r);return i.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),i}_ensureQueryJSON(e,t){let r=this.defaultQueryJSON;if(null!=e&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),r=e.toJSON(),r.cacheHint=!0),null!=t){const e=t.geometries.map((e=>e.toJSON())).reduce(((e,t)=>(e.rings=e.rings.concat(t.rings),e)));r={...r,cacheHint:!0,sceneFilter:{...t,geometry:e}}}return r}get _dataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const{priority:e,layer:t}=this,r="timeInfo"in t&&t.timeInfo?.toJSON()||null,i=m.createFeatureIdInfo(t),s=c.featureGeometryTypeKebabDictionary.toJSON(this._queryGeometryType),n=t.fieldsIndex?.toJSON()||new d([]),o=this.spatialReference.toJSON(),{hasZ:a,hasM:l,featureStore:u,scheduler:h,memoryController:p}=this.context,y=new f.QueryEngineCache(p);return this._dataQueryEngineInstance=new g({hasZ:a,hasM:l,geometryType:s,fieldsIndex:n,timeInfo:r,spatialReference:o,featureIdInfo:i,featureStore:u,scheduler:h,cache:y,priority:e}),this._dataQueryEngineInstance}},t.__decorate([i.property({constructOnly:!0})],e.QueryEngine.prototype,"context",void 0),t.__decorate([i.property({constructOnly:!0})],e.QueryEngine.prototype,"priority",void 0),t.__decorate([i.property()],e.QueryEngine.prototype,"layer",null),t.__decorate([i.property()],e.QueryEngine.prototype,"spatialReference",null),t.__decorate([i.property()],e.QueryEngine.prototype,"_queryGeometryType",null),t.__decorate([i.property()],e.QueryEngine.prototype,"defaultQueryJSON",null),e.QueryEngine=t.__decorate([a.subclass("esri.views.3d.layers.graphics.QueryEngine")],e.QueryEngine),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/QueryEngine":function(){define(["exports","../../../core/arrayUtils","../../../core/compilerUtils","../../../core/Error","../../../core/has","../../../core/lang","../../../core/maybe","../../../core/promiseUtils","../../../core/unitUtils","../../../core/support/jsonUtils","../../../geometry/projectionUtils","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/boundsUtils","../../../geometry/support/jsonUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./attributeSupport","./geometryUtils","./projectionSupport","./QueryEngineCache","./QueryEngineCapabilities","./QueryEngineResult","./queryUtils","./queryValidationUtils","./spatialQuerySupport","./timeSupport","../../support/FieldsIndex","../../../views/support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R){"use strict";function E(e){if(C.canQueryWithRBush(e)){if(m.isExtent(e))return[h.fromValues(Math.min(e.xmin,e.xmax),Math.min(e.ymin,e.ymax),Math.max(e.xmin,e.xmax),Math.max(e.ymin,e.ymax))];if(m.isPolygon(e))return e.rings.map((e=>h.fromValues(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))))}return[p.getBoundsXY(h.create(),e)]}e.Feature=class{constructor(e,t=null,r,i,s){this.attributes=e,this.geometry=r,this.centroid=i,this.filterFlags=s,this.groupId=-1,this.displayId=t}},e.QueryEngine=class{constructor(e){this._changeHandle=null,this.capabilities={query:S.queryCapabilities},this.geometryType=e.geometryType,this.hasM=!!e.hasM,this.hasZ=!!e.hasZ,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._cache=e.cache??new v.QueryEngineCache,this.timeInfo=e.timeInfo,this.featureIdInfo=e.featureIdInfo,"object-id"===e.featureIdInfo.type&&(this.objectIdField=e.featureIdInfo.fieldName),this._changeHandle=this.featureStore.events.on("changed",(()=>this._clearCache())),this.fieldsIndex=c.isSerializable(e.fieldsIndex)?e.fieldsIndex:M.fromJSON(e.fieldsIndex),!e.availableFields||1===e.availableFields.length&&"*"===e.availableFields[0]?this.availableFields=new Set(this.fieldsIndex.fields.map((e=>e.name))):this.availableFields=new Set(e.availableFields.map((e=>this.fieldsIndex.get(e)?.name)).filter((e=>null!=e))),e.scheduler&&e.priority&&(this._frameTask=e.scheduler.registerTask(e.priority))}destroy(){this._changeHandle=o.removeMaybe(this._changeHandle),this._frameTask=o.removeMaybe(this._frameTask),this._clearCache(),o.destroyMaybe(this._cache)}get featureAdapter(){return this.featureStore.featureAdapter}_clearCache(){this._cache.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null,this._fullExtentPromise=null}async executeQuery(e,t){const r=a.signalFromSignalOrOptions(t);try{const t=await this._executeQuery(e,{},r);return await t.createQueryResponse()}catch(t){if(t!==x.queryEngineEmptyResult)throw t;return new w.QueryEngineResult([],e,this).createQueryResponse()}}async executeQueryForCount(e={},t){const r=a.signalFromSignalOrOptions(t);try{return(await this._executeQuery(e,{returnGeometry:!1,returnCentroid:!1,outSR:null},r)).createQueryResponseForCount()}catch(e){if(e!==x.queryEngineEmptyResult)throw e;return 0}}async executeQueryForExtent(e,t){const r=a.signalFromSignalOrOptions(t),i=e.outSR;try{const t=await this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},r),s=t.size;return s?{count:s,extent:await this._getBounds(t.items,t.spatialReference,i||this.spatialReference)}:{count:0,extent:null}}catch(e){if(e===x.queryEngineEmptyResult)return{count:0,extent:null};throw e}}async executeQueryForIds(e,t){return this.executeQueryForIdSet(e,t).then((e=>Array.from(e)))}async executeQueryForIdSet(e,t){const r=a.signalFromSignalOrOptions(t);try{const t=await this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},r),i=t.items,s=new Set;return await this.reschedule((()=>{for(const e of i)s.add(t.featureAdapter.getObjectId(e))}),r),s}catch(e){if(e===x.queryEngineEmptyResult)return new Set;throw e}}async executeQueryForLatestObservations(e,t){const r=a.signalFromSignalOrOptions(t);if(!this.timeInfo?.trackIdField)throw new i("unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});try{const t=await this._executeQuery(e,{},r);return await this.reschedule((()=>this._filterLatest(t)),r),await t.createQueryResponse()}catch(t){if(t!==x.queryEngineEmptyResult)throw t;return new w.QueryEngineResult([],e,this).createQueryResponse()}}async executeAttributeBinsQuery(e,t){const r=a.signalFromSignalOrOptions(t);let i;e=n.clone(e);try{e=await this.schedule((()=>x.normalizeAttributeBinsQuery(e,this.definitionExpression,this.spatialReference)),r),e=await this.reschedule((()=>T.validateAttributeBinsQuery(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference})),r);const t=await this.reschedule((()=>this._executeSceneFilterQuery(e,r)),r);i=await this.reschedule((()=>this._executeGeometryQuery(e,t,r)),r),await this.reschedule((()=>this._executeAggregateIdsQuery(i)),r),await this.reschedule((()=>this.executeObjectIdsQuery(i)),r),await this.reschedule((()=>this.executeTimeQuery(i)),r),await this.reschedule((()=>this.executeAttributesQuery(i)),r)}catch(t){if(t!==x.queryEngineEmptyResult)throw t;i=new w.QueryEngineResult([],e,this)}return i.createQueryBinsResponse(e)}async executeQueryForSummaryStatistics(e={},t,r){const i=a.signalFromSignalOrOptions(r),{field:s,normalizationField:n,valueExpression:o}=t;return(await this._executeQueryForStatistics(e,{field:s,normalizationField:n,valueExpression:o},i)).createSummaryStatisticsResponse(t)}async executeQueryForUniqueValues(e={},t,r){const i=a.signalFromSignalOrOptions(r),{field:s,field2:n,field3:o,valueExpression:l}=t;return(await this._executeQueryForStatistics(e,{field:s,field2:n,field3:o,valueExpression:l},i)).createUniqueValuesResponse(t)}async executeQueryForClassBreaks(e={},t,r){const i=a.signalFromSignalOrOptions(r),{field:s,normalizationField:n,valueExpression:o}=t;return(await this._executeQueryForStatistics(e,{field:s,normalizationField:n,valueExpression:o},i)).createClassBreaksResponse(t)}async executeQueryForHistogram(e={},t,r){const i=a.signalFromSignalOrOptions(r),{field:s,normalizationField:n,valueExpression:o}=t;return(await this._executeQueryForStatistics(e,{field:s,normalizationField:n,valueExpression:o},i)).createHistogramResponse(t)}async fetchRecomputedExtents(e){const t=a.signalFromSignalOrOptions(e);this._timeExtentPromise||=P.getTimeExtent(this.timeInfo,this.featureStore);const[r,i]=await Promise.all([this._getFullExtent(),this._timeExtentPromise]);return a.throwIfAborted(t),{fullExtent:r,timeExtent:i}}async _getBounds(e,t,r){const i=d.set(d.create(),d.negativeInfinity);await this.featureStore.forEachBounds(e,(e=>d.expandWithAABB(i,e)));const s={xmin:i[0],ymin:i[1],xmax:i[3],ymax:i[4],spatialReference:_.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(i[2])&&isFinite(i[5])&&(s.zmin=i[2],s.zmax=i[5],s.hasZ=!0);const n=b.project(s,t,r);if(n.spatialReference=_.cleanFromGeometryEngine(r),n.xmax-n.xmin===0){const e=l.getMetersPerUnitForSR(n.spatialReference);n.xmin-=e,n.xmax+=e}if(n.ymax-n.ymin===0){const e=l.getMetersPerUnitForSR(n.spatialReference);n.ymin-=e,n.ymax+=e}if(this.hasZ&&null!=n.zmin&&null!=n.zmax&&n.zmax-n.zmin===0){const e=l.getMetersPerUnitForSR(n.spatialReference);n.zmin-=e,n.zmax+=e}return n}_getFullExtent(){return this._fullExtentPromise||="getFullExtent"in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getAllFeatures().then((e=>this._getBounds(e,this.spatialReference,this.spatialReference))),this._fullExtentPromise}async schedule(e,t){return this._frameTask?.schedule(e,t)??e(R.noBudget)}async reschedule(e,t){return this._frameTask?.reschedule(e,t)??e(R.noBudget)}async _getAllFeaturesQueryEngineResult(e){return new w.QueryEngineResult(await this._getAllFeatures(),e,this)}async _getAllFeatures(){if(null==this._allFeaturesPromise){const e=[];this._allFeaturesPromise=(async()=>await this.featureStore.forEach((t=>e.push(t))))().then((()=>r.toConst(e)))}const e=this._allFeaturesPromise,t=await e;return e===this._allFeaturesPromise?t.slice():this._getAllFeatures()}async _executeQuery(e,t,r){e=n.clone(e),e=await this.schedule((()=>x.normalizeQuery(e,this.definitionExpression,this.spatialReference)),r),e=await this.reschedule((()=>T.validateQuery(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference})),r),e={...e,...t};const i=await this.reschedule((()=>this._executeSceneFilterQuery(e,r)),r),s=await this.reschedule((()=>this._executeGeometryQuery(e,i,r)),r);return await this.reschedule((()=>this._executeAggregateIdsQuery(s)),r),await this.reschedule((()=>this.executeObjectIdsQuery(s)),r),await this.reschedule((()=>this.executeTimeQuery(s)),r),await this.reschedule((()=>this.executeAttributesQuery(s)),r),s}async _executeSceneFilterQuery(e,t){if(null==e.sceneFilter)return null;const{outSR:r,returnGeometry:i,returnCentroid:s}=e,n=this.featureStore.featureSpatialReference,o=e.sceneFilter.geometry,a=null==n||f.equals(n,o.spatialReference)?o:b.project(o,n);if(!a)return null;const l=i||s,c=f.isValid(r)&&!f.equals(this.spatialReference,r)&&l?async e=>this._project(e,r):e=>e,u=this.featureAdapter,d=await this.reschedule((()=>this.searchFeatures(E(a))),t);if("disjoint"===e.sceneFilter.spatialRelationship){if(!d.length)return null;const r=new Set;for(const e of d)r.add(u.getObjectId(e));const i=await this.reschedule((()=>this._getAllFeatures()),t);return c(await this.reschedule((async()=>{const s=await C.getSpatialQueryOperator("esriSpatialRelDisjoint",a,this.geometryType,this.hasZ,this.hasM),n=await this.runSpatialFilter(i,(e=>!r.has(u.getObjectId(e))||s(u.getGeometry(e))),t);return new w.QueryEngineResult(n,e,this)}),t))}if(!d.length)return new w.QueryEngineResult([],e,this);if(this._canExecuteSinglePass(a,e))return c(new w.QueryEngineResult(d,e,this));const h=await C.getSpatialQueryOperator("esriSpatialRelContains",a,this.geometryType,this.hasZ,this.hasM),p=await this.runSpatialFilter(d,(e=>h(u.getGeometry(e))),t);return c(new w.QueryEngineResult(p,e,this))}async _executeGeometryQuery(e,r,i){if(null!=r&&0===r.items.length)return r;const{geometry:s,outSR:n,returnGeometry:o,returnCentroid:a}=e,l=r?null:this._getCacheKey(e),c=l?this._cache.get(l):null;if(c)return new w.QueryEngineResult(c,e,this);const u=f.isValid(n)&&!f.equals(this.spatialReference,n),d=o||a,h=async e=>(u&&d&&await this._project(e,n),l&&this._cache.put(l,e.items),e),p=this.featureStore.featureSpatialReference,m=!s||null==p||f.equals(p,s.spatialReference)?s:b.project(s,p);if(!m)return h(null!=r?r:await this._getAllFeaturesQueryEngineResult(e));const g=this.featureAdapter;let y=await this.reschedule((()=>this.searchFeatures(E(s))),i);const _=e.spatialRel??"esriSpatialRelIntersects";if("esriSpatialRelDisjoint"===_){if(!y.length)return h(null!=r?r:await this._getAllFeaturesQueryEngineResult(e));const t=new Set;for(const e of y)t.add(g.getObjectId(e));const s=null!=r?r.items:await this.reschedule((()=>this._getAllFeatures()),i);return h(await this.reschedule((async()=>{const r=await C.getSpatialQueryOperator(_,m,this.geometryType,this.hasZ,this.hasM),n=await this.runSpatialFilter(s,(e=>!t.has(g.getObjectId(e))||r(g.getGeometry(e))),i);return new w.QueryEngineResult(n,e,this)}),i))}if(null!=r){const e=new t.PositionHint;y=y.filter((i=>t.indexOf(r.items,i,r.items.length,e)>=0))}if(!y.length){const t=new w.QueryEngineResult([],e,this);return l&&this._cache.put(l,t.items),t}if(this._canExecuteSinglePass(m,e))return h(new w.QueryEngineResult(y,e,this));const v=await C.getSpatialQueryOperator(_,m,this.geometryType,this.hasZ,this.hasM),S=await this.runSpatialFilter(y,(e=>v(g.getGeometry(e))),i);return h(new w.QueryEngineResult(S,e,this))}_executeAggregateIdsQuery(e){if(0===e.items.length||!e.query.aggregateIds?.length||null==this.aggregateAdapter)return;const t=new Set;for(const r of e.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(r).forEach((e=>t.add(e)));const r=this.featureAdapter.getObjectId;e.items=e.items.filter((e=>t.has(r(e))))}executeObjectIdsQuery(e){if(0===e.items.length||!e.query.objectIds?.length)return;const t=new Set(e.query.objectIds),r=this.featureAdapter.getObjectId;e.items=e.items.filter((e=>t.has(r(e))))}executeTimeQuery(e){if(0===e.items.length)return;const t=P.getTimeOperator(this.timeInfo,e.query.timeExtent,this.featureAdapter);null!=t&&(e.items=e.items.filter(t))}executeAttributesQuery(e){if(0===e.items.length)return;const t=y.getWhereClause(e.query.where,this.fieldsIndex);if(t){if(!t.isStandardized)throw new TypeError("Where clause is not standardized");e.items=e.items.filter((e=>t.testFeature(e,this.featureAdapter)))}}async runSpatialFilter(e,t,r){if(!t)return e;if(null==this._frameTask)return e.filter((e=>t(e)));let i=0;const s=new Array,n=async o=>{for(;i<e.length;){const a=e[i++];t(a)&&(s.push(a),o.madeProgress()),o.done&&await this.reschedule((e=>n(e)),r)}};return this.reschedule((e=>n(e)),r).then((()=>s))}_filterLatest(e){const{trackIdField:t,startTimeField:r,endTimeField:i}=this.timeInfo,s=i||r,n=new Map,o=this.featureAdapter.getAttribute;for(const r of e.items){const e=o(r,t),i=o(r,s),a=n.get(e);(!a||i>o(a,s))&&n.set(e,r)}e.items=Array.from(n.values())}_getCacheKey(e){const{geometry:t,spatialRel:r,returnGeometry:i,returnCentroid:s,outSR:n,resultType:o,cacheHint:a}=e;if("tile"!==o&&!a)return null;const l=i||s;return f.isValid(n)&&!f.equals(this.spatialReference,n)&&l?JSON.stringify([t,r,n]):JSON.stringify([t,r])}_canExecuteSinglePass(e,t){const{spatialRel:r}=t;return C.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===r||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===r||"esriSpatialRelContains"===r))}async _project(e,t){if(!t||f.equals(this.spatialReference,t))return e;const i=this.featureAdapter;let s;try{const e=await this._getFullExtent();s=u.getTransformation(this.spatialReference,t,e)}catch{}const n=await b.projectMany(e.items.map((e=>_.getGeometry(this.geometryType,this.hasZ,this.hasM,i.getGeometry(e)))),this.spatialReference,t,s);return e.items=r.toConst(n.map(((t,r)=>i.cloneWithGeometry(e.items[r],g.convertFromGeometry(t,this.hasZ,this.hasM))))),e}async searchFeatures(e){const t=new Set;await Promise.all(e.map((e=>this.featureStore.forEachInBounds(e,(e=>t.add(e))))));const r=Array.from(t.values());return t.clear(),r}async _executeQueryForStatistics(e,t,r){e=n.clone(e);try{e=await this.schedule((()=>x.normalizeQuery(e,this.definitionExpression,this.spatialReference)),r),e=await this.reschedule((()=>T.validateStatisticsQuery(e,t,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference})),r);const i=await this.reschedule((()=>this._executeSceneFilterQuery(e,r)),r),s=await this.reschedule((()=>this._executeGeometryQuery(e,i,r)),r);return await this.reschedule((()=>this._executeAggregateIdsQuery(s)),r),await this.reschedule((()=>this.executeObjectIdsQuery(s)),r),await this.reschedule((()=>this.executeTimeQuery(s)),r),await this.reschedule((()=>this.executeAttributesQuery(s)),r),s}catch(t){if(t!==x.queryEngineEmptyResult)throw t;return new w.QueryEngineResult([],e,this)}}get test(){}},e.getQueryBBoxes=E,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/attributeSupport":function(){define(["exports","../../../core/Error","../../../core/sql/WhereClauseCache","../../support/fieldType"],(function(e,t,r,i){"use strict";const s=new r.WhereClauseCache(50,500),n="unsupported-query",o=" as ",a=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeBigInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"]),l=new Set(["esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]),c=new Set(["esriFieldTypeString","esriFieldTypeGUID","esriFieldTypeGlobalID",...a,...l]);function u(e,r,i={}){const o=d(r,e);if(!o){const i=s.getError(r,e);throw new t(n,"invalid SQL expression",{expression:r,error:i})}const a=i.expressionName||"expression";if(i.validateStandardized&&!o.isStandardized)throw new t(n,`${a} is not standard`,{expression:r});if(i.validateAggregate&&!o.isAggregate)throw new t(n,`${a} does not contain a valid aggregate function`,{expression:r});return o.fieldNames}function d(e,t){return e?s.get(e,t):null}function h(e){return/\((.*?)\)/.test(e)?e:e.split(o)[0]}function p(e,r,i,s={}){const o=new Map;if(function(e,t,r,i,s){const n=s.includes("*")?[...r,...s.filter((e=>"*"!==e))]:s;for(const s of n)if(t.get(s))m(e,t,r,i,s);else try{const n=u(t,h(s),{validateStandardized:!0});for(const s of n)m(e,t,r,i,s)}catch(t){e.set(s,{type:"expression-error",expression:s,error:t})}}(o,e,r,s.allowedFieldTypes??c,i),o.size){const e=s.expressionName??"expression";throw new t(n,`${e} contains invalid or missing fields`,{errors:Array.from(o.values()),query:s.query})}}function m(e,t,r,s,n){const o=t.get(n);o?r.has(o.name)?"all"!==s&&!1===s?.has(o.type)&&e.set(n,{type:"invalid-type",fieldName:o.name,fieldType:i.kebabDict.fromJSON(o.type),allowedFieldTypes:Array.from(s,(e=>i.kebabDict.fromJSON(e)))}):e.set(n,{type:"missing-field",fieldName:o.name}):e.set(n,{type:"invalid-field",fieldName:n})}e.allDateAndTimeFieldTypes=l,e.getAliasFromFieldName=function(e){return e.split(o)[1]},e.getExpressionFromFieldName=h,e.getWhereClause=d,e.numericFieldTypes=a,e.validateFields=p,e.validateHaving=function(e,r,i,s,o){if(!i)return!0;const a="having clause",l=u(e,i,{validateAggregate:!0,expressionName:a});p(e,r,l,{expressionName:a,query:o});const c=d(i,e),h=c?.getExpressions().every((t=>{const{aggregateType:r,field:i}=t,n=e.get(i)?.name;return s.some((t=>{const{onStatisticField:i,statisticType:s}=t,o=e.get(i)?.name;return o===n&&s.toLowerCase().trim()===r}))}));if(!h)throw new t(n,"expressions in having clause should also exist in outStatistics",{having:i});return!0},e.validateWhere=function(e,t,r,i){if(!r)return!0;const s="where clause";return p(e,t,u(e,r,{validateStandardized:!0,expressionName:s}),{expressionName:s,query:i}),!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/WhereClauseCache":function(){define(["exports","../LRUCache","./WhereClause"],(function(e,t,r){"use strict";e.WhereClauseCache=class{constructor(e,r){this._cache=new t.LRUCache(e),this._invalidCache=new t.LRUCache(r)}get(e,t){const i=`${t?.uid}:${e}`,s=this._cache.get(i);if(s)return s;if(null!=this._invalidCache.get(i))return null;try{const s=r.create(e,{fieldsIndex:t});return this._cache.put(i,s),s}catch(e){return this._invalidCache.put(i,e),null}}getError(e,t){const r=`${t?.uid}:${e}`;return this._invalidCache.get(r)??null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/WhereClause":function(){define(["../has","./AggregateFunctions","./DateOnly","./errorSupport","./sqlArithmeticUtils","./sqlCompareUtils","./sqlDateParsingUtils","./SqlInterval","./SqlTimestampOffset","./StandardizedFunctions","./TimeOnly","./WhereGrammar","../../support/guards","../../chunks/datetime"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const m=new Set(["current_timestamp","current_date","current_time"]);class f{constructor(e){this.staticData=e}makeBool(e){return M(e)}featureValue(e,t,r,i){return B(e,t,r,i)}equalsNull(e){return null===e}applyLike(e,t,r){return V(e,t,r)}ensureArray(e){return R(e)}applyIn(e,t){return I(e,t)}currentTimestamp(e){return D(e)}currentDate(e){return F(e)}currentTime(e){return L(e)}makeSqlInterval(e,t,r){return a.SqlInterval.createFromValueAndQualifier(e,t,r)}convertInterval(e){return a.SqlInterval.isInterval(e)?e.valueInMilliseconds():e}compare(e,t,r){return n.sqlCompare(t,r,e)}calculate(e,t,r,i){return s.sqlCalculateFunction(e,t,r,i)}evaluateTime(e){return o.parseTime(e)}evaluateTimestamp(e,t,r){return o.parseTimestamp(e,t,r)}evaluateDate(e,t){return o.parseDate(e,t)}evaluateFunction(e,t,r){return c.evaluateFunction(e,t,r)}lookup(e,t){const r=t[e];return void 0===r?null:r}between(e,t){return null==e||null==t[0]||null==t[1]?null:n.sqlCompare(e,t[0],">=")&&n.sqlCompare(e,t[1],"<=")}notbetween(e,t){return null==e||null==t[0]||null==t[1]?null:n.sqlCompare(e,t[0],"<")||n.sqlCompare(e,t[1],">")}ternaryNot(e){return E(e)}ternaryAnd(e,t){return O(e,t)}ternaryOr(e,t){return A(e,t)}}function g(e,...t){return`this.${e}(${t.join(", ")})`}function y(e){return void 0===e?"void 0":JSON.stringify(e)}function _({type:e,period:t,precision:r,secondary:i}){return JSON.stringify({type:e,period:t,precision:r,secondary:i})}const b="feature",v="lookups",S="attributeAdapter",w="fieldsIndex",x="timeZone",T="currentUser";class C{constructor(e){this._parseTree=e,this._staticData=Object.create(null),this._nextStaticDataId=0,this._tempVars=new Set,this._nextTempVarId=0}compile(){const e=this._compileNode(this._parseTree),t=`\n      ${this._tempVars.size>0?`var ${Array.from(this._tempVars).join(", ")};`:""}\n      return this.convertInterval(${e});\n    `;return new Function(b,v,S,w,x,T,t).bind(new f(this._staticData))}_storeStaticData(e){const t="static$"+this._nextStaticDataId++;return this._staticData[t]=e,t}_compileRefStaticData(e){return`this.staticData[${y(e)}]`}_generateTempVar(){const e="temp$"+this._nextTempVarId++;return this._tempVars.add(e),e}_compileSimpleCase(e){const t=this._compileNode(e.operand),r=this._generateTempVar(),i=[];for(const t of e.clauses){const e=g("compare",y("="),r,this._compileNode(t.operand)),s=this._compileNode(t.value);i.push(`${e} ? (${s}) :`)}return null!=e.else?i.push(this._compileNode(e.else)):i.push(y(null)),`(${r} = ${t}, ${i.join(" ")})`}_compileSearchedCase(e){const t=[];for(const r of e.clauses){const e=g("makeBool",this._compileNode(r.operand)),i=this._compileNode(r.value);t.push(`${e} ? (${i}) :`)}return null!=e.else?t.push(this._compileNode(e.else)):t.push(y(null)),t.join(" ")}_compileInExpr(e,t){const r=new Set,i=[];for(const e of t.value)"number"===e.type||"string"===e.type?r.add(e.value):i.push(e);const s=this._compileNode(e),n=g("ensureArray",this._compileNode({type:"expression-list",location:t.location,value:i}));if(r.size>0){const e=this._compileRefStaticData(this._storeStaticData(r)),t=this._generateTempVar();return i.length>0?`(${t} = ${s}, ${e}.has(${t}) || ${g("applyIn",t,n)})`:`(${t} = ${s}, ${t} == null ? null : ${e}.has(${t}))`}return g("applyIn",s,n)}_compileNode(e){switch(e.type){case"interval":return g("makeSqlInterval",this._compileNode(e.value),"interval-qualifier"===e.qualifier.type?function({type:e,start:t,end:r}){return`{type: ${y(e)}, start: ${_(t)}, end: ${_(r)}}`}(e.qualifier):_(e.qualifier),y(e.op));case"case-expression":return"simple"===e.format?this._compileSimpleCase(e):this._compileSearchedCase(e);case"parameter":return g("lookup",y(e.value.toLowerCase()),v);case"expression-list":return`[${e.value.map((e=>this._compileNode(e))).join(", ")}]`;case"unary-expression":return g("ternaryNot",this._compileNode(e.expr));case"binary-expression":switch(e.operator){case"AND":return g("ternaryAnd",this._compileNode(e.left),this._compileNode(e.right));case"OR":return g("ternaryOr",this._compileNode(e.left),this._compileNode(e.right));case"IS":if("null"!==e.right.type)throw new i.SqlError(i.SqlErrorCodes.UnsupportedIsRhs);return g("equalsNull",this._compileNode(e.left));case"ISNOT":if("null"!==e.right.type)throw new i.SqlError(i.SqlErrorCodes.UnsupportedIsRhs);return`!${g("equalsNull",this._compileNode(e.left))}`;case"IN":return this._compileInExpr(e.left,e.right);case"NOT IN":return g("ternaryNot",this._compileInExpr(e.left,e.right));case"BETWEEN":return g("between",this._compileNode(e.left),this._compileNode(e.right));case"NOTBETWEEN":return g("notbetween",this._compileNode(e.left),this._compileNode(e.right));case"LIKE":return g("applyLike",this._compileNode(e.left),this._compileNode(e.right),y(e.escape));case"NOT LIKE":return g("ternaryNot",g("applyLike",this._compileNode(e.left),this._compileNode(e.right),y(e.escape)));case"<>":case"<":case">":case">=":case"<=":case"=":return g("compare",y(e.operator),this._compileNode(e.left),this._compileNode(e.right));case"*":case"-":case"+":case"/":case"||":return g("calculate",y(e.operator),this._compileNode(e.left),this._compileNode(e.right),x);default:throw new i.SqlError(i.SqlErrorCodes.UnsupportedOperator,{operator:e.operator})}case"null":case"boolean":case"string":case"number":return y(e.value);case"time":try{return this._compileRefStaticData(this._storeStaticData(o.parseTime(e.value)))}catch{return g("evaluateTime",y(e.value))}case"date":try{return this._compileRefStaticData(this._storeStaticData(o.parseDate(e.value,"unknown")))}catch{return g("evaluateDate",y(e.value),y("unknown"))}case"timestamp":try{return this._compileRefStaticData(this._storeStaticData(o.parseTimestamp(e.value,"unknown")))}catch{return g("evaluateTimestamp",y(e.value),y("unknown"))}case"current-time":return"date"===e.mode?g("currentDate",x):"time"===e.mode?g("currentTime",x):g("currentTimestamp",x);case"current-user":return T;case"column-reference":return g("featureValue",b,y(e.column),w,S);case"data-type":return function({type:e,size:t,withtimezone:r}){return JSON.stringify({type:e,size:t,withtimezone:r})}(e.value);case"function":return g("evaluateFunction",y(e.name),this._compileNode(e.args),x)}throw new i.SqlError(i.SqlErrorCodes.UnsupportedSyntax,{node:e.type})}}class P{static create(e,t={}){return new P(e,t.fieldsIndex,t.timeZone??void 0,t.currentUser)}constructor(e,t,r="UTC",i=null){this.fieldsIndex=t,this.timeZone=r,this.currentUser=i,this.parameters={},this._compiledExecutor=null,this._hasDateFunctions=void 0,this.parseTree=d.WhereGrammar.parse(e);const{isStandardized:s,isAggregate:n,currentUserRequired:o,referencedFieldNames:a}=this._extractExpressionInfo(t);this._referencedFieldNames=a,this.isStandardized=s,this.isAggregate=n,this.currentUserRequired=o}static convertValueToStorageFormat(e,t=null){if(null===t)return h.isDate(e)?e.getTime():o.isDateTime(e)?e.toMillis():o.isTimestampOffset(e)?e.toStorageFormat():o.isTimeOnly(e)?e.toStorageString():o.isDateOnly(e)?e.toStorageFormat():e;switch(t){case"date":return h.isDate(e)?e.getTime():o.isDateTime(e)?e.toMillis():o.isTimestampOffset(e)?e.toMilliseconds():o.isDateOnly(e)?e.toNumber():e;case"date-only":return h.isDate(e)?r.DateOnly.fromDateJS(e).toString():o.isTimestampOffset(e)?r.DateOnly.fromSqlTimeStampOffset(e).toString():o.isDateTime(e)?r.DateOnly.fromDateTime(e).toString():e;case"time-only":return h.isDate(e)?u.TimeOnly.fromDateJS(e).toStorageString():o.isDateTime(e)?u.TimeOnly.fromDateTime(e).toStorageString():o.isTimestampOffset(e)?u.TimeOnly.fromSqlTimeStampOffset(e).toStorageString():o.isTimeOnly(e)?e.toStorageString():e;case"timestamp-offset":if(h.isDate(e))return l.SqlTimeStampOffset.fromJSDate(e).toStorageFormat();if(o.isDateTime(e))return l.SqlTimeStampOffset.fromDateTime(e).toStorageFormat();if(o.isTimestampOffset(e))return e.toStorageFormat()}return e}get fieldNames(){return this._referencedFieldNames}testSet(e,t=G,r=this.currentUser){return!!this._evaluateNode(this.parseTree,null,t,e,r)}calculateValue(e,t=G,r=this.currentUser){const i=this._evaluateNode(this.parseTree,e,t,null,r);return a.SqlInterval.isInterval(i)?i.valueInMilliseconds()/864e5:i}tryGetCompiledExecutor(){if(null!=this._compiledExecutor)return this._compiledExecutor;if(e("esri-csp-restrictions"))return null;const t=new C(this.parseTree);return this._compiledExecutor=t.compile(),this._compiledExecutor}calculateValueCompiled(e,t=G,r=this.currentUser){const i=this.tryGetCompiledExecutor();return null==i?this.calculateValue(e,t):i(e,this.parameters,t,this.fieldsIndex,this.timeZone,r??null)}testFeature(e,t=G,r=this.currentUser){return!!this._evaluateNode(this.parseTree,e,t,null,r)}testFeatureCompiled(e,t=G,r=this.currentUser){const i=this.tryGetCompiledExecutor();return null==i?this.testFeature(e,t):!!i(e,this.parameters,t,this.fieldsIndex,this.timeZone,r??null)}get hasDateFunctions(){return null!=this._hasDateFunctions||(this._hasDateFunctions=!1,d.visitAll(this.parseTree,(e=>{"current-time"===e.type?this._hasDateFunctions=!0:"function"===e.type&&(this._hasDateFunctions=this._hasDateFunctions||m.has(e.name.toLowerCase()))}))),this._hasDateFunctions}getFunctions(){const e=new Set;return d.visitAll(this.parseTree,(t=>{"function"===t.type&&e.add(t.name.toLowerCase())})),Array.from(e)}getExpressions(){const e=new Map;return d.visitAll(this.parseTree,(t=>{if("function"===t.type){const r=t.name.toLowerCase(),i=t.args.value[0];if("column-reference"===i.type){const t=i.column,s=`${r}-${t}`;e.has(s)||e.set(s,{aggregateType:r,field:t})}}})),[...e.values()]}getVariables(){const e=new Set;return d.visitAll(this.parseTree,(t=>{"parameter"===t.type&&e.add(t.value.toLowerCase())})),Array.from(e)}_extractExpressionInfo(e){const r=[],i=new Set;let s=!0,n=!1,o=!1;return d.visitAll(this.parseTree,(a=>{switch(a.type){case"column-reference":{const t=e?.get(a.column);let s,n;t?s=n=t.name??"":(n=a.column,s=n.toLowerCase()),i.has(s)||(i.add(s),r.push(n)),a.column=n;break}case"current-user":o=!0;break;case"function":{const{name:e,args:r}=a,i=r.value.length;s&&(s=c.isStandardized(e,i)),!1===n&&(n=t.isAggregate(e,i));break}}})),{referencedFieldNames:Array.from(r),isStandardized:s,isAggregate:n,currentUserRequired:o}}_evaluateNode(e,r,l,u,d){let m;switch(e.type){case"interval":{const t=this._evaluateNode(e.value,r,l,u,d);return a.SqlInterval.createFromValueAndQualifier(t,e.qualifier,e.op)}case"case-expression":if("simple"===e.format){const t=this._evaluateNode(e.operand,r,l,u,d);for(let i=0;i<e.clauses.length;i++)if(n.sqlCompare(t,this._evaluateNode(e.clauses[i].operand,r,l,u,d),"="))return this._evaluateNode(e.clauses[i].value,r,l,u,d);if(null!==e.else)return this._evaluateNode(e.else,r,l,u,d)}else{for(let t=0;t<e.clauses.length;t++)if(M(this._evaluateNode(e.clauses[t].operand,r,l,u,d)))return this._evaluateNode(e.clauses[t].value,r,l,u,d);if(null!==e.else)return this._evaluateNode(e.else,r,l,u,d)}return null;case"parameter":return m=this.parameters[e.value.toLowerCase()],h.isDate(m)?p.DateTime.fromJSDate(m):null!=m&&"object"==typeof m&&"toDateTime"in m?m.toDateTime():m;case"expression-list":{const t=[];for(const i of e.value)t.push(this._evaluateNode(i,r,l,u,d));return t}case"unary-expression":return E(this._evaluateNode(e.expr,r,l,u,d));case"binary-expression":switch(e.operator){case"AND":return O(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d));case"OR":return A(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d));case"IS":if("null"!==e.right.type)throw new i.SqlError(i.SqlErrorCodes.UnsupportedIsRhs);return null===this._evaluateNode(e.left,r,l,u,d);case"ISNOT":if("null"!==e.right.type)throw new i.SqlError(i.SqlErrorCodes.UnsupportedIsRhs);return null!==this._evaluateNode(e.left,r,l,u,d);case"IN":{const t=R(this._evaluateNode(e.right,r,l,u,d));return I(this._evaluateNode(e.left,r,l,u,d),t)}case"NOT IN":{const t=R(this._evaluateNode(e.right,r,l,u,d));return E(I(this._evaluateNode(e.left,r,l,u,d),t))}case"BETWEEN":{const t=this._evaluateNode(e.left,r,l,u,d),i=this._evaluateNode(e.right,r,l,u,d);return null==t||null==i[0]||null==i[1]?null:n.sqlCompare(t,i[0],">=")&&n.sqlCompare(t,i[1],"<=")}case"NOTBETWEEN":{const t=this._evaluateNode(e.left,r,l,u,d),i=this._evaluateNode(e.right,r,l,u,d);return null==t||null==i[0]||null==i[1]?null:n.sqlCompare(t,i[0],"<")||n.sqlCompare(t,i[1],">")}case"LIKE":return V(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d),e.escape);case"NOT LIKE":return E(V(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return n.sqlCompare(this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d),e.operator);case"-":case"+":case"*":case"/":case"||":return s.sqlCalculateFunction(e.operator,this._evaluateNode(e.left,r,l,u,d),this._evaluateNode(e.right,r,l,u,d),this.timeZone)}case"null":case"boolean":case"string":case"number":return e.value;case"date":return e.parsedValue??=o.parseDate(e.value,"unknown"),e.parsedValue;case"timestamp":return e.parsedValue??=o.parseTimestamp(e.value,"unknown"),e.parsedValue;case"time":return o.parseTime(e.value);case"current-time":return"date"===e.mode?F(this.timeZone):"time"===e.mode?L(this.timeZone):D(this.timeZone);case"current-user":return d??null;case"column-reference":return B(r,e.column,this.fieldsIndex,l);case"data-type":return e.value;case"function":{if(this.isAggregate&&t.isAggregate(e.name,e.args.value.length)){const r=[];for(const t of e.args?.value||[]){const e=[];for(const r of u||[])e.push(this._evaluateNode(t,r,l,null,d));r.push(e)}return t.aggregateFunction(e.name,r)}const i=this._evaluateNode(e.args,r,l,u,d);return c.evaluateFunction(e.name,i,this.timeZone)}}throw new i.SqlError(i.SqlErrorCodes.UnsupportedSyntax,{node:e.type})}}function M(e){return!0===e}function R(e){return Array.isArray(e)?e:[e]}function E(e){return null!==e?!0!==e:null}function O(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function A(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function I(e,t){if(null==e)return null;let r=!1;for(const i of t)if(null==i)r=null;else{if(e===i){r=!0;break}if(n.isDateOrTimeValue(e)&&n.isDateOrTimeValue(i)&&(r=n.sqlCompare(e,i,"="),r))break}return r}function D(e){return o.convertToExecutingTimeZone(new Date,e)}function F(e){return r.DateOnly.fromNow(e)}function L(e){const t=o.convertToExecutingTimeZone(new Date,e);return u.TimeOnly.fromDateTime(t)}const N="-[]/{}()*+?.\\^$|";var U;function V(e,t,r){if(null==e)return null;const i=function(e,t){const r=t;let i="",s=U.Normal;for(let t=0;t<e.length;t++){const n=e.charAt(t);switch(s){case U.Normal:n===r?s=U.Escaped:N.includes(n)?i+="\\"+n:i+="%"===n?".*":"_"===n?".":n;break;case U.Escaped:N.includes(n)?i+="\\"+n:i+=n,s=U.Normal}}return new RegExp("^"+i+"$","m")}(t,r);return i.test(e)}function B(e,t,i,s){if("getAttributeSQL"in s)return s.getAttributeSQL(e,t);const n=s.getAttribute(e,t);if(null==n)return n;const a=i?.get(t);switch(a?.type){case"esriFieldTypeDate":case"date":return o.convertToExecutingTimeZone(new Date(n),i?.getLuxonTimeZone(a.name)??p.FixedOffsetZone.utcInstance);case"esriFieldTypeDateOnly":case"date-only":return r.DateOnly.fromReader(n);case"esriFieldTypeTimeOnly":case"time-only":return u.TimeOnly.fromReader(n);case"esriFieldTypeTimestampOffset":case"timestamp-offset":return new l.SqlTimeStampOffset(n)}return n}!function(e){e[e.Normal=0]="Normal",e[e.Escaped=1]="Escaped"}(U||(U={}));const G={getAttribute(e,t){var r;return((r=e)&&"object"==typeof r.attributes?e.attributes:e)[t]}};return P}))},"esri/core/sql/AggregateFunctions":function(){define(["exports","./DateOnly","./errorSupport","./SqlTimestampOffset","./TimeOnly","../../chunks/datetime"],(function(e,t,r,i,s,n){"use strict";const o={min:{minParams:1,maxParams:1,evaluate:e=>c(e[0],"min")},max:{minParams:1,maxParams:1,evaluate:e=>c(e[0],"max")},avg:{minParams:1,maxParams:1,evaluate:e=>a(e[0])},sum:{minParams:1,maxParams:1,evaluate:e=>function(e){if(null===e)return null;let t=0;for(let i=0;i<e.length;i++){const s=e[i];if(null!==s){if(!l(s))throw new r.SqlError(r.SqlErrorCodes.InvalidValueForAggregateFunction);t+=s}}return t}(e[0])},stddev:{minParams:1,maxParams:1,evaluate:e=>function(e){if(null===e)return null;const t=u(e);return null===t?null:Math.sqrt(t)}(e[0])},count:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].length},var:{minParams:1,maxParams:1,evaluate:e=>u(e[0])}};function a(e){if(null===e)return null;let t=0,i=0;for(let s=0;s<e.length;s++){const n=e[s];if(null!==n){if(!l(n))throw new r.SqlError(r.SqlErrorCodes.InvalidValueForAggregateFunction);i++,t+=n}}return 0===i?null:t/e.length}function l(e){return"number"==typeof e}function c(e,r){if(null===e)return null;let o=null,a=null;for(const l of e){let e=l;e=t.DateOnly.isDateOnly(l)||s.TimeOnly.isTimeOnly(l)?l.toNumber():n.DateTime.isDateTime(l)?l.toMillis():i.SqlTimeStampOffset.isTimestampOffset(l)?l.toMilliseconds():l,(null===o||"max"===r&&null!==a&&null!==e&&a<=e||"min"===r&&null!==a&&null!==e&&a>=e)&&(o=l,a=e)}return o}function u(e){if(null===e)return null;if(0===(e=e.filter((e=>null!==e))).length)return null;const t=a(e);if(null===t)return null;let i=0;for(const s of e){if(!l(s))throw new r.SqlError(r.SqlErrorCodes.InvalidValueForAggregateFunction);i+=(t-s)**2}return i/(e.length-1)}e.aggregateFunction=function(e,t){const i=o[e.toLowerCase()];if(null==i)throw new r.SqlError(r.SqlErrorCodes.FunctionNotRecognized);if(t.length<i.minParams||t.length>i.maxParams)throw new r.SqlError(r.SqlErrorCodes.InvalidParameterCount,{name:e.toUpperCase()});return i.evaluate(t)},e.isAggregate=function(e,t){const r=o[e.toLowerCase()];return null!=r&&t>=r.minParams&&t<=r.maxParams},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/errorSupport":function(){define(["exports","../string"],(function(e,t){"use strict";var r;e.SqlErrorCodes=void 0,(r=e.SqlErrorCodes||(e.SqlErrorCodes={})).InvalidFunctionParameters="InvalidFunctionParameters",r.InvalidValueForAggregateFunction="InvalidValueForAggregateFunction",r.UnsupportedSqlFunction="UnsupportedSqlFunction",r.UnsupportedOperator="UnsupportedOperator",r.UnsupportedSyntax="UnsupportedSyntax",r.UnsupportedIsRhs="UnsupportedIsRhs",r.UnsupportedIsLhs="UnsupportedIsLhs",r.InvalidDataType="InvalidDataType",r.CannotCastValue="CannotCastValue",r.FunctionNotRecognized="FunctionNotRecognized",r.InvalidTime="InvalidTime",r.InvalidParameterCount="InvalidParameterCount",r.InvalidTimeStamp="InvalidTimeStamp",r.InvalidDate="InvalidDate",r.InvalidOperator="InvalidOperator",r.IllegalInterval="IllegalInterval",r.YearMonthIntervals="YearMonthIntervals",r.PrimarySecondaryQualifiers="PrimarySecondaryQualifiers",r.MissingStatisticParameters="MissingStatisticParameters";const i={[e.SqlErrorCodes.InvalidValueForAggregateFunction]:"Invalid value used in aggregate function",[e.SqlErrorCodes.MissingStatisticParameters]:"Statistic does not have 1 or 0 Parameters",[e.SqlErrorCodes.InvalidFunctionParameters]:"Invalid parameters for call to {function}",[e.SqlErrorCodes.UnsupportedIsLhs]:"Unsupported left hand expression in is statement",[e.SqlErrorCodes.UnsupportedIsRhs]:"Unsupported right hand expression in is statement",[e.SqlErrorCodes.UnsupportedOperator]:"Unsupported operator - {operator}",[e.SqlErrorCodes.UnsupportedSyntax]:"Unsupported syntax - {node}",[e.SqlErrorCodes.UnsupportedSqlFunction]:"Sql function not found = {function}",[e.SqlErrorCodes.InvalidDataType]:"Invalid sql data type",[e.SqlErrorCodes.InvalidDate]:"Invalid date encountered",[e.SqlErrorCodes.InvalidOperator]:"Invalid operator encountered",[e.SqlErrorCodes.InvalidTime]:"Invalid time encountered",[e.SqlErrorCodes.IllegalInterval]:"Illegal interval",[e.SqlErrorCodes.FunctionNotRecognized]:"Function not recognized",[e.SqlErrorCodes.InvalidTimeStamp]:"Invalid timestamp encountered",[e.SqlErrorCodes.InvalidParameterCount]:"Invalid parameter count for call to {name}",[e.SqlErrorCodes.PrimarySecondaryQualifiers]:"Primary and Secondary SqlInterval qualifiers not supported",[e.SqlErrorCodes.YearMonthIntervals]:"Year-Month Intervals not supported",[e.SqlErrorCodes.CannotCastValue]:"Cannot cast value to the required data type"};class s extends Error{constructor(e,r){super(t.replace(i[e],r)),this.declaredRootClass="esri.arcade.featureset.support.sqlerror",Error.captureStackTrace&&Error.captureStackTrace(this,s)}}e.SqlError=s,e.sqlErrorMessages=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/SqlTimestampOffset":function(){define(["exports","../../chunks/datetime"],(function(e,t){"use strict";function r(e){return Number.isNaN(e)||0===e?e:Math.trunc(e)}const i="esri.core.sql.SqlTimeStampOffset";class s{constructor(e){this._timeStampOffset=e,this.declaredRootClass=i,this._date=null}static isTimestampOffset(e){return"object"==typeof e&&null!=e&&"declaredRootClass"in e&&e.declaredRootClass===i}toDateTime(){return this._date??=t.DateTime.fromISO(this._timeStampOffset,{setZone:!0}),this._date}get isValid(){return this.toDateTime().isValid}get timezoneOffsetHour(){return r(this.toDateTime().offset/60)}get timezoneOffsetMinutes(){return r(this.toDateTime().offset%60)}toMilliseconds(){return this.toDateTime().toMillis()}get hour(){return this.toDateTime().hour}get minute(){return this.toDateTime().minute}get second(){return this.toDateTime().second}get day(){return this.toDateTime().day}get month(){return this.toDateTime().month}get year(){return this.toDateTime().year}startOfDay(){return s.fromDateTime(this.toDateTime().startOf("day"))}static fromJSDate(e){return new s(t.DateTime.fromJSDate(e).toISO({includeOffset:!0}))}static fromDateTime(e){return new s(e.toISO({includeOffset:!0}))}static fromParts(e,t,r=0,i=0,n=0,o=0,a=0,l=!1,c=0,u=0){const d=`${e.toString().padStart(4,"0")}-${t.toString().padStart(2,"0")}-${r.toString().padStart(2,"0")}`;let h="";o<10&&(h="0");let p=`${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${h+o.toString()}`;0!==a&&(p+="."+a.toString().padStart(3,"0"));const m=`${l?"-":"+"}${c.toString().padStart(2,"0")}:${u.toString().padStart(2,"0")}`;return new s(d+"T"+p+m)}toStorageFormat(){return this._timeStampOffset}toString(){return this._timeStampOffset}toSQLValue(){let e=this.toDateTime().toSQL({includeOffset:!0,includeOffsetSpace:!0});return e&&(e=e.replace(".000","")),e}toSQLWithKeyword(){return`timestamp '${this.toSQLValue()}'`}addMilliseconds(e){const t=this.toDateTime().plus(e);return s.fromDateTime(t)}}e.SqlTimeStampOffset=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/sqlArithmeticUtils":function(){define(["exports","./errorSupport","./sqlDateParsingUtils","./SqlInterval","./StandardizedFunctions","../../support/guards"],(function(e,t,r,i,s,n){"use strict";function o(e,r,i){switch(i){case"+":return e+r;case"-":return e-r;case"*":return e*r;case"/":return e/r}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function a(e,r,i){switch(i){case"+":return r.plus({milliseconds:e.valueInMilliseconds()});case"-":return e.valueInMilliseconds()-r.toMillis()}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function l(e,r,i){if("+"===i)return r.plus("milliseconds",e.valueInMilliseconds());throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function c(e,r,i){if("+"===i)return r.plus("milliseconds",e.valueInMilliseconds());throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function u(e,r,i){switch(i){case"+":return e.plus("milliseconds",r.valueInMilliseconds());case"-":return e.plus("milliseconds",-1*r.valueInMilliseconds())}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function d(e,r,i){if("+"===i)return r.addMilliseconds(e.valueInMilliseconds());throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function h(e,r,s){switch(s){case"+":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()+r.valueInMilliseconds());case"-":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()-r.valueInMilliseconds());case"*":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()*r.valueInMilliseconds());case"/":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()/r.valueInMilliseconds())}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function p(e,r,s){switch(s){case"+":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()+r);case"-":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()-r);case"*":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()*r);case"/":return i.SqlInterval.createFromMilliseconds(e.valueInMilliseconds()/r)}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function m(e,r,s){switch(s){case"+":return i.SqlInterval.createFromMilliseconds(e+r.valueInMilliseconds());case"-":return i.SqlInterval.createFromMilliseconds(e-r.valueInMilliseconds());case"*":return i.SqlInterval.createFromMilliseconds(e*r.valueInMilliseconds());case"/":return i.SqlInterval.createFromMilliseconds(e/r.valueInMilliseconds())}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function f(e,r,i){switch(i){case"+":return e.plus("milliseconds",r.valueInMilliseconds());case"-":return e.plus("milliseconds",-1*r.valueInMilliseconds())}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function g(e,r,i){switch(i){case"+":return e.plus({milliseconds:r.valueInMilliseconds()});case"-":return e.minus({milliseconds:r.valueInMilliseconds()})}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function y(e,r,i){switch(i){case"+":return e.addMilliseconds(r.valueInMilliseconds());case"-":return e.addMilliseconds(-1*r.valueInMilliseconds())}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function _(e,r,i){const s=1e3*r*24*60*60;switch(i){case"+":return e.plus({milliseconds:s});case"-":return e.minus({milliseconds:s})}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function b(e,r,i){const s=1e3*r*24*60*60;switch(i){case"+":return e.plus("milliseconds",s);case"-":return e.plus("milliseconds",-1*s)}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function v(e,r,i){const s=1e3*r*24*60*60;switch(i){case"+":return e.plus("milliseconds",s);case"-":return e.plus("milliseconds",-1*s)}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function S(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function w(e,r,i){const s=1e3*r*24*60*60;switch(i){case"+":return e.addMilliseconds(s);case"-":return e.addMilliseconds(-1*s)}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function x(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function T(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function C(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function P(e,r,i){const s=parseFloat(r);if(isNaN(s))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);return o(e,s,i)}function M(e,r,i){const s=parseFloat(e);if(isNaN(s))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);return o(s,r,i)}function R(e,r,i){if("+"===i)return e+r;throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function E(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function O(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function A(e,r,i){if("-"===i)return e.toDateTimeLuxon(r.zone).diff(r).as("days");throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function I(e,r,i){if("-"===i)return e.toDateTimeLuxon(r.toDateTime().zone).diff(r.toDateTime()).as("days");throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function D(e,r,i){if("-"===i)return e.toDateTimeLuxon("UTC").diff(r.toDateTimeLuxon("UTC")).as("days");throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function F(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function L(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function N(e,r,i){if("-"===i)return e.toDateTime().diff(r.toDateTimeLuxon(e.toDateTime().zone)).as("days");throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function U(e,r,i){if("-"===i)return e.toDateTime().diff(r).as("days");throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function V(e,r,i){if("-"===i)return e.toDateTime().diff(r.toDateTime()).as("days");throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function B(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function G(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function k(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function z(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function j(e,r,i){if("-"===i)return e.diff(r).as("days");throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function q(e,r,i){if("-"===i)return e.diff(r.toDateTimeLuxon(e.zone)).as("days");throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function H(e,r,i){if("-"===i)return e.diff(r.toDateTime()).as("days");throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function W(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function $(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function Q(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function Z(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function Y(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function X(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function K(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function J(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}function ee(e,r,i){throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}e.calculateDateOnlyAndDateOnly=D,e.calculateDateOnlyAndDateTime=A,e.calculateDateOnlyAndNumber=b,e.calculateDateOnlyAndSqlInterval=f,e.calculateDateOnlyAndString=$,e.calculateDateOnlyAndTimeOnly=F,e.calculateDateOnlyAndTimestamp=I,e.calculateDateTimeAndDateOnly=q,e.calculateDateTimeAndDateTime=j,e.calculateDateTimeAndNumber=_,e.calculateDateTimeAndSqlInterval=g,e.calculateDateTimeAndString=Z,e.calculateDateTimeAndTimeOnly=W,e.calculateDateTimeAndTimestamp=H,e.calculateNumberAndDateOnly=C,e.calculateNumberAndDateTime=S,e.calculateNumberAndNumber=o,e.calculateNumberAndSqlInterval=m,e.calculateNumberAndString=P,e.calculateNumberAndTimeOnly=T,e.calculateNumberAndTimestamp=x,e.calculateSqlIntervalAndDateOnly=c,e.calculateSqlIntervalAndDateTime=a,e.calculateSqlIntervalAndNumber=p,e.calculateSqlIntervalAndSqlInterval=h,e.calculateSqlIntervalAndString=E,e.calculateSqlIntervalAndTimeOnly=l,e.calculateSqlIntervalAndTimestamp=d,e.calculateStringAndDateOnly=K,e.calculateStringAndDateTime=J,e.calculateStringAndNumber=M,e.calculateStringAndSqlInterval=O,e.calculateStringAndString=R,e.calculateStringAndTimeOnly=X,e.calculateStringAndTimestamp=ee,e.calculateTimeOnlyAndDateOnly=G,e.calculateTimeOnlyAndDateTime=B,e.calculateTimeOnlyAndNumber=v,e.calculateTimeOnlyAndSqlInterval=u,e.calculateTimeOnlyAndString=Q,e.calculateTimeOnlyAndTimeOnly=z,e.calculateTimeOnlyAndTimestamp=k,e.calculateTimestampAndDateOnly=N,e.calculateTimestampAndDateTime=U,e.calculateTimestampAndNumber=w,e.calculateTimestampAndSqlInterval=y,e.calculateTimestampAndString=Y,e.calculateTimestampAndTimeOnly=L,e.calculateTimestampAndTimestamp=V,e.sqlCalculateFunction=function(e,i,te,re){if("||"===e)return s.evaluateFunction("concat",[i,te],re);if(null===i||null===te)return null;if(n.isNumber(i)){if(n.isNumber(te))return o(i,te,e);if(r.isSqlInterval(te))return m(i,te,e);if(r.isTimeOnly(te))return T();if(r.isDateOnly(te))return C();if(r.isTimestampOffset(te))return x();if(r.isDateTime(te))return S();if(n.isString(te))return P(i,te,e);throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}if(r.isDateOnly(i)){if(n.isNumber(te))return b(i,te,e);if(r.isSqlInterval(te))return f(i,te,e);if(r.isTimeOnly(te))return F();if(r.isDateOnly(te))return D(i,te,e);if(r.isTimestampOffset(te))return I(i,te,e);if(r.isDateTime(te))return A(i,te,e);if(n.isString(te))return $();throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}if(r.isTimeOnly(i)){if(n.isNumber(te))return v(i,te,e);if(r.isSqlInterval(te))return u(i,te,e);if(r.isTimeOnly(te))return z();if(r.isDateOnly(te))return G();if(r.isTimestampOffset(te))return k();if(r.isDateTime(te))return B();if(n.isString(te))return Q();throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}if(r.isSqlInterval(i)){if(n.isNumber(te))return p(i,te,e);if(r.isSqlInterval(te))return h(i,te,e);if(r.isTimeOnly(te))return l(i,te,e);if(r.isDateOnly(te))return c(i,te,e);if(r.isTimestampOffset(te))return d(i,te,e);if(r.isDateTime(te))return a(i,te,e);if(n.isString(te))return E();throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}if(r.isDateTime(i)){if(n.isNumber(te))return _(i,te,e);if(r.isSqlInterval(te))return g(i,te,e);if(r.isTimeOnly(te))return W();if(r.isDateOnly(te))return q(i,te,e);if(r.isTimestampOffset(te))return H(i,te,e);if(r.isDateTime(te))return j(i,te,e);if(n.isString(te))return Z();throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}if(r.isTimestampOffset(i)){if(n.isNumber(te))return w(i,te,e);if(r.isSqlInterval(te))return y(i,te,e);if(r.isTimeOnly(te))return L();if(r.isDateOnly(te))return N(i,te,e);if(r.isTimestampOffset(te))return V(i,te,e);if(r.isDateTime(te))return U(i,te,e);if(n.isString(te))return Y();throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}if(n.isString(i)){if(n.isNumber(te))return M(i,te,e);if(r.isSqlInterval(te))return O();if(r.isTimeOnly(te))return X();if(r.isDateOnly(te))return K();if(r.isTimestampOffset(te))return ee();if(r.isDateTime(te))return J();if(n.isString(te))return R(i,te,e);throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/sqlDateParsingUtils":function(){define(["exports","./DateOnly","./errorSupport","./SqlInterval","./SqlTimestampOffset","./TimeOnly","./UnknownTimeZone","../../chunks/datetime"],(function(e,t,r,i,s,n,o,a){"use strict";const l=/^(\d{1,2}):(\d{1,2}):(\d{1,2})$/,c=/^(\d{1,2}):(\d{1,2})$/,u=/^(\d{1,2}):(\d{1,2}):(\d{1,2}).([0-9]+)$/,d=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,h=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?$/,p=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?[ ]{0,1}(\+|-)(\d{1,2}):(\d{1,2})$/,m=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})?[ ]{0,1}(\+|-)(\d{1,2}):(\d{1,2})$/,f=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/;function g(e,t,i=!1){let n=h.exec(e);if(null!==n){const[,e,i,s,l,c,u,d]=n,h=a.DateTime.fromObject({year:parseInt(e,10),month:parseInt(i,10),day:parseInt(s,10),hour:parseInt(l,10),minute:parseInt(c,10),second:parseInt(u,10),millisecond:d?parseInt(d.replace(".",""),10):0},{zone:o.substituteUnknownTimezone(t)});if(!1===h.isValid)throw new r.SqlError(r.SqlErrorCodes.InvalidTimeStamp);return h}if(n=p.exec(e),null!==n){const[,e,t,i,o,a,l,c,u,d,h]=n,p=s.SqlTimeStampOffset.fromParts(parseInt(e,10),parseInt(t,10),parseInt(i,10),parseInt(o,10),parseInt(a,10),parseInt(l,10),c?parseInt(c.replace(".",""),10):0,"-"===u,parseInt(d,10),parseInt(h,10));if(!1===p.isValid)throw new r.SqlError(r.SqlErrorCodes.InvalidTimeStamp);return p}if(n=m.exec(e),null!==n){const[,e,t,i,o,a,l,c,u]=n,d=s.SqlTimeStampOffset.fromParts(parseInt(e,10),parseInt(t,10),parseInt(i,10),parseInt(o,10),parseInt(a,10),0,0,"-"===l,parseInt(c,10),parseInt(u,10));if(!1===d.isValid)throw new r.SqlError(r.SqlErrorCodes.InvalidTimeStamp);return d}if(n=f.exec(e),null!==n){const[,e,i,s,l,c]=n,u=a.DateTime.fromObject({year:parseInt(e,10),month:parseInt(i,10),day:parseInt(s,10),hour:parseInt(l,10),minute:parseInt(c,10),second:0},{zone:o.substituteUnknownTimezone(t)});if(!1===u.isValid)throw new r.SqlError(r.SqlErrorCodes.InvalidTimeStamp);return u}if(n=d.exec(e),null!==n){const[,e,i,s]=n,l=a.DateTime.fromObject({year:parseInt(e,10),month:parseInt(i,10),day:parseInt(s,10),hour:0,minute:0,second:0},{zone:o.substituteUnknownTimezone(t)});if(!1===l.isValid)throw new r.SqlError(r.SqlErrorCodes.InvalidTimeStamp);return l}throw new r.SqlError(r.SqlErrorCodes.InvalidTimeStamp)}e.convertToExecutingTimeZone=function(e,t){if(t instanceof a.Zone)return t===o.UnknownTimeZone.instance?a.DateTime.fromMillis(e.getTime(),{zone:o.UnknownTimeZone.instance}):a.DateTime.fromJSDate(e,{zone:t});switch(t){case"system":case"local":case null:return a.DateTime.fromJSDate(e);default:return"unknown"===t?.toLowerCase()?a.DateTime.fromMillis(e.getTime(),{zone:o.UnknownTimeZone.instance}):a.DateTime.fromJSDate(e,{zone:t})}},e.isDateOnly=function(e){return t.DateOnly.isDateOnly(e)},e.isDateTime=function(e){return a.DateTime.isDateTime(e)},e.isSqlInterval=function(e){return i.SqlInterval.isInterval(e)},e.isTimeOnly=function(e){return n.TimeOnly.isTimeOnly(e)},e.isTimestampOffset=function(e){return s.SqlTimeStampOffset.isTimestampOffset(e)},e.parseDate=function(e,i){const s=d.exec(e);if(null===s)try{return g(e,i)}catch{throw new r.SqlError(r.SqlErrorCodes.InvalidDate)}const[,n,o,a]=s,l=t.DateOnly.fromParts(parseInt(n,10),parseInt(o,10),parseInt(a,10));if(null===l)throw new r.SqlError(r.SqlErrorCodes.InvalidDate);return l},e.parseTime=function(e){let t=l.exec(e);if(null!==t){const[,e,i,s]=t,o=n.TimeOnly.fromParts(parseInt(e,10),parseInt(i,10),parseInt(s,10),0);if(null!==o)return o;throw new r.SqlError(r.SqlErrorCodes.InvalidTime)}if(t=c.exec(e),null!==t){const[,e,i]=t,s=n.TimeOnly.fromParts(parseInt(e,10),parseInt(i,10),0,0);if(null!==s)return s;throw new r.SqlError(r.SqlErrorCodes.InvalidTime)}if(t=u.exec(e),null!==t){const[,e,i,s,o]=t,a=n.TimeOnly.fromParts(parseInt(e,10),parseInt(i,10),parseInt(s,10),parseInt(o,10));if(null!==a)return a;throw new r.SqlError(r.SqlErrorCodes.InvalidTime)}throw new r.SqlError(r.SqlErrorCodes.InvalidTime)},e.parseTimestamp=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/SqlInterval":function(){define(["exports","./errorSupport"],(function(e,t){"use strict";function r(e){if(null!==e.precision||null!==e.secondary)throw new t.SqlError(t.SqlErrorCodes.PrimarySecondaryQualifiers)}function i(e,t){if(t.includes(".")){const r=t.split(".");e.second=parseFloat(r[0]),e.millis=parseInt(r[1],10)}else e.second=parseFloat(t)}const s="esri.core.sql.SqlInterval";class n{constructor(){this.declaredRootClass=s,this.op="+",this.day=0,this.second=0,this.hour=0,this.month=0,this.year=0,this.minute=0,this.millis=0}static isInterval(e){return"object"==typeof e&&null!=e&&"declaredRootClass"in e&&e.declaredRootClass===s}static createFromMilliseconds(e){const t=new n;return t.second=e/1e3,t}static createFromValueAndQualifier(e,s,o){let a=null;const l=new n;if(l.op="-"===o?"-":"+","interval-period"===s.type){r(s);const n=new RegExp("^[0-9]{1,}$");if("year"===s.period||"month"===s.period)throw new t.SqlError(t.SqlErrorCodes.YearMonthIntervals);if("second"===s.period){if(!/^[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$/.test(e))throw new t.SqlError(t.SqlErrorCodes.IllegalInterval);i(l,e)}else{if(!n.test(e))throw new t.SqlError(t.SqlErrorCodes.IllegalInterval);l[s.period]=parseFloat(e)}}else{if(r(s.start),r(s.end),"year"===s.start.period||"month"===s.start.period||"year"===s.end.period||"month"===s.end.period)throw new t.SqlError(t.SqlErrorCodes.YearMonthIntervals);switch(s.start.period){case"day":switch(s.end.period){case"hour":if(a=new RegExp("^[0-9]{1,} [0-9]{1,}$"),!a.test(e))throw new t.SqlError(t.SqlErrorCodes.IllegalInterval);l[s.start.period]=parseFloat(e.split(" ")[0]),l[s.end.period]=parseFloat(e.split(" ")[1]);break;case"minute":if(a=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,}$"),!a.test(e))throw new t.SqlError(t.SqlErrorCodes.IllegalInterval);{l[s.start.period]=parseFloat(e.split(" ")[0]);const t=e.split(" ")[1].split(":");l.hour=parseFloat(t[0]),l.minute=parseFloat(t[1])}break;case"second":if(a=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,2}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!a.test(e))throw new t.SqlError(t.SqlErrorCodes.IllegalInterval);{l[s.start.period]=parseFloat(e.split(" ")[0]);const t=e.split(" ")[1].split(":");l.hour=parseFloat(t[0]),l.minute=parseFloat(t[1]),i(l,t[2])}break;default:throw new t.SqlError(t.SqlErrorCodes.IllegalInterval)}break;case"hour":switch(s.end.period){case"minute":if(a=new RegExp("^[0-9]{1,}:[0-9]{1,}$"),!a.test(e))throw new t.SqlError(t.SqlErrorCodes.IllegalInterval);l.hour=parseFloat(e.split(":")[0]),l.minute=parseFloat(e.split(":")[1]);break;case"second":if(a=new RegExp("^[0-9]{1,}:[0-9]{1,2}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!a.test(e))throw new t.SqlError(t.SqlErrorCodes.IllegalInterval);{const t=e.split(":");l.hour=parseFloat(t[0]),l.minute=parseFloat(t[1]),i(l,t[2])}break;default:throw new t.SqlError(t.SqlErrorCodes.IllegalInterval)}break;case"minute":if("second"!==s.end.period)throw new t.SqlError(t.SqlErrorCodes.IllegalInterval);if(a=new RegExp("^[0-9]{1,}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!a.test(e))throw new t.SqlError(t.SqlErrorCodes.IllegalInterval);{const t=e.split(":");l.minute=parseFloat(t[0]),i(l,t[1])}break;default:throw new t.SqlError(t.SqlErrorCodes.IllegalInterval)}}return l}valueInMilliseconds(){return("-"===this.op?-1:1)*(this.millis+1e3*this.second+60*this.minute*1e3+60*this.hour*60*1e3+24*this.day*60*60*1e3+this.month*(365/12)*24*60*60*1e3+365*this.year*24*60*60*1e3)}}e.SqlInterval=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/StandardizedFunctions":function(){define(["exports","../mathUtils","../string","./DateOnly","./errorSupport","./sqlCompareUtils","./sqlDateParsingUtils","./TimeOnly","../../support/guards","../../chunks/datetime"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";function u(e){return!(l.isDate(e)||o.isDateOnly(e)||o.isDateTime(e)||o.isTimeOnly(e)||o.isTimestampOffset(e))}function d(e){return o.isDateOnly(e)||o.isTimeOnly(e)?e.toString():o.isTimestampOffset(e)?e.toSQLValue():o.isDateTime(e)?0===e.millisecond?e.toFormat("yyyy-LL-dd HH:mm:ss"):e.toSQL({includeOffset:!1}):l.isDate(e)?d(c.DateTime.fromJSDate(e)):e.toString()}const h={extract:{minParams:2,maxParams:2,evaluate:([e,t])=>{if(null==t)return null;if(l.isDate(t))switch(e.toUpperCase()){case"SECOND":return t.getSeconds();case"MINUTE":return t.getMinutes();case"HOUR":return t.getHours();case"DAY":return t.getDate();case"MONTH":return t.getMonth()+1;case"YEAR":return t.getFullYear();case"TIMEZONE_HOUR":case"TIMEZONE_MINUTE":return 0;case"DOW":return c.DateTime.fromJSDate(t,{zone:"system"}).weekday;case"DOY":return c.DateTime.fromJSDate(t,{zone:"system"}).ordinal;case"WEEK":return c.DateTime.fromJSDate(t,{zone:"system"}).weekNumber}else if(o.isDateTime(t))switch(e.toUpperCase()){case"SECOND":return t.second;case"MINUTE":return t.minute;case"HOUR":return t.hour;case"DAY":return t.day;case"MONTH":return t.month;case"YEAR":return t.year;case"TIMEZONE_HOUR":case"TIMEZONE_MINUTE":throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"EXTRACT"});case"DOW":return t.weekday;case"DOY":return t.ordinal;case"WEEK":return t.weekNumber}else if(o.isDateOnly(t))switch(e.toUpperCase()){case"DAY":return t.day;case"MONTH":return t.month;case"YEAR":return t.year;case"TIMEZONE_HOUR":case"TIMEZONE_MINUTE":throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"EXTRACT"});case"DOW":return t.toDateTime("unknown").weekday;case"DOY":return t.toDateTime("unknown").ordinal;case"WEEK":return t.toDateTime("unknown").weekNumber}else if(o.isTimeOnly(t))switch(e.toUpperCase()){case"SECOND":return t.second;case"MINUTE":return t.minute;case"HOUR":return t.hour}else if(o.isTimestampOffset(t))switch(e.toUpperCase()){case"SECOND":return t.second;case"MINUTE":return t.minute;case"HOUR":return t.hour;case"DAY":return t.day;case"MONTH":return t.month;case"YEAR":return t.year;case"TIMEZONE_HOUR":return t.timezoneOffsetHour;case"TIMEZONE_MINUTE":return t.timezoneOffsetMinutes;case"DOW":return t.toDateTime().weekday;case"DOY":return t.toDateTime().ordinal;case"WEEK":return t.toDateTime().weekNumber}throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"EXTRACT"})}},substring:{minParams:2,maxParams:3,evaluate:e=>{if(2===e.length){const[t,r]=e;return null==t||null==r?null:t.toString().substring(r-1)}if(3===e.length){const[t,r,i]=e;return null==t||null==r||null==i?null:i<=0?"":t.toString().substring(r-1,r+i-1)}}},position:{minParams:2,maxParams:2,evaluate:([e,t])=>null==e||null==t?null:t.indexOf(e)+1},trim:{minParams:2,maxParams:3,evaluate:e=>{const t=3===e.length,i=t?e[1]:" ",n=t?e[2]:e[1];if(null==i||null==n)return null;const o=`(${r.escapeRegExpString(i)})`;switch(e[0]){case"BOTH":return n.replaceAll(new RegExp(`^${o}*|${o}*$`,"g"),"");case"LEADING":return n.replaceAll(new RegExp(`^${o}*`,"g"),"");case"TRAILING":return n.replaceAll(new RegExp(`${o}*$`,"g"),"")}throw new s.SqlError(s.SqlErrorCodes.InvalidFunctionParameters,{function:"TRIM"})}},abs:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.abs(e[0])},ceiling:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.ceil(e[0])},floor:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.floor(e[0])},log:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])},log10:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])*Math.LOG10E},sin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sin(e[0])},cos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.cos(e[0])},tan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.tan(e[0])},asin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.asin(e[0])},acos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.acos(e[0])},atan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.atan(e[0])},sign:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0]>0?1:e[0]<0?-1:0},power:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:e[0]**e[1]},mod:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:e[0]%e[1]},round:{minParams:1,maxParams:2,evaluate:e=>{const t=e[0],r=2===e.length?10**e[1]:1;return null==t?null:Math.round(t*r)/r}},truncate:{minParams:1,maxParams:2,evaluate:e=>null==e[0]?null:1===e.length||0===e[1]?Math.trunc(e[0]):t.decimalAdjust("trunc",e[0],-Number(e[1]))},char_length:{minParams:1,maxParams:1,evaluate:e=>l.isString(e[0])?e[0].length:0},concat:{minParams:1,maxParams:1/0,evaluate:e=>{let t="";for(let r=0;r<e.length;r++){if(null==e[r])return null;t+=e[r].toString()}return t}},lower:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toLowerCase()},upper:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toUpperCase()},coalesce:{minParams:1,maxParams:1/0,evaluate:e=>{for(const t of e)if(null!==t)return t;return null}},cosh:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.cosh(e[0])},sinh:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sinh(e[0])},tanh:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.tanh(e[0])},nullif:{minParams:2,maxParams:2,evaluate:e=>n.sqlCompare(e[0],e[1],"=")?null:e[0]},cast:{minParams:2,maxParams:2,evaluate:(e,t)=>{const r=e[0],n=e[1];if(null===r)return null;switch(n.type){case"integer":{if(!u(r))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);const e=parseInt(r,10);if(isNaN(e))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);return e}case"smallint":{if(!u(r))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);const e=parseInt(r,10);if(isNaN(e))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);if(e>32767||e<-32767)throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);return e}case"float":case"real":{if(!u(r))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);const e=parseFloat(r);if(isNaN(e))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);return e}case"time":return function(e){if(l.isDate(e))return a.TimeOnly.fromDateJS(e);if(o.isDateTime(e))return a.TimeOnly.fromDateTime(e);if(o.isDateOnly(e))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);if(o.isTimeOnly(e))return e;if(o.isTimestampOffset(e))return a.TimeOnly.fromSqlTimeStampOffset(e);if(l.isString(e))return o.parseTime(e);throw new s.SqlError(s.SqlErrorCodes.CannotCastValue)}(r);case"date":return function(e){if(l.isDate(e))return i.DateOnly.fromDateJS(e);if(o.isDateTime(e))return i.DateOnly.fromParts(e.year,e.month,e.day);if(o.isDateOnly(e))return e;if(o.isTimeOnly(e))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);if(o.isTimestampOffset(e)&&null===i.DateOnly.fromParts(e.year,e.month,e.day))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);if(l.isString(e)){const t=i.DateOnly.fromReader(e);if(null!==t&&t.isValid)return t}throw new s.SqlError(s.SqlErrorCodes.CannotCastValue)}(r);case"timestamp":return function(e,t,r){if(l.isDate(e))return o.convertToExecutingTimeZone(e,t);if(o.isDateTime(e))return e;if(o.isDateOnly(e))return e.toDateTimeLuxon("unknown");if(o.isTimeOnly(e))throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);if(o.isTimestampOffset(e))return e;if(l.isString(e))return o.parseTimestamp(e,"unknown",r);throw new s.SqlError(s.SqlErrorCodes.CannotCastValue)}(r,t,!0===n.withtimezone);case"varchar":{const e=d(r);if(e.length>n.size)throw new s.SqlError(s.SqlErrorCodes.CannotCastValue);return e}default:throw new s.SqlError(s.SqlErrorCodes.InvalidDataType)}}}};e.evaluateFunction=function(e,t,r){const i=h[e.toLowerCase()];if(null==i)throw new s.SqlError(s.SqlErrorCodes.FunctionNotRecognized);if(t.length<i.minParams||t.length>i.maxParams)throw new s.SqlError(s.SqlErrorCodes.InvalidParameterCount,{name:e.toUpperCase()});return i.evaluate(t,r)},e.isStandardized=function(e,t){const r=h[e.toLowerCase()];return null!=r&&t>=r.minParams&&t<=r.maxParams},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/sqlCompareUtils":function(){define(["exports","./errorSupport","./sqlDateParsingUtils","./SqlTimestampOffset","./UnknownTimeZone","../../support/guards","../../chunks/datetime"],(function(e,t,r,i,s,n,o){"use strict";function a(e){return!!r.isDateTime(e)||!!r.isTimestampOffset(e)}function l(e){return!!(r.isDateTime(e)||r.isDateOnly(e)||r.isTimestampOffset(e)||r.isTimeOnly(e))}function c(e){if(r.isDateTime(e))return e.toMillis();if(r.isDateOnly(e))return e.toNumber();if(r.isTimestampOffset(e))return e.toMilliseconds();throw new t.SqlError(t.SqlErrorCodes.InvalidDataType)}function u(e,t,r){switch(r){case"<>":return e!==t;case"=":return e===t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}}function d(e,t,r){i.SqlTimeStampOffset.isTimestampOffset(e)&&(e=e.toDateTime()),i.SqlTimeStampOffset.isTimestampOffset(t)&&(t=t.toDateTime());const s=h(e),n=h(t);switch(r){case"<>":return s!==n;case"=":return s===n;case">":return s>n;case"<":return s<n;case">=":return s>=n;case"<=":return s<=n}}function h(e){return 321408e5*e.year+26784e5*e.month+864e5*e.day+36e5*e.hour+6e4*e.minute+1e3*e.second+e.millisecond}e.dateValueInMilliseconds=c,e.isDateOrTimeValue=l,e.isDateTimeComparableValue=a,e.sqlCompare=function(e,h,p){if(null==e||null==h)return null;if(n.isNumber(e)){if(n.isNumber(h))return u(e,h,p);if(n.isString(h))return function(e,t,r){const i=parseFloat(t);if(!isNaN(i))return u(e,i,r);const s=e.toString();switch(r){case"<>":return s!==t;case"=":return s===t;case">":return s>t;case"<":return s<t;case">=":return s>=t;case"<=":return s<=t}}(e,h,p);if(l(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(r.isDateOnly(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}else if(n.isString(e)){if(n.isNumber(h))return function(e,t,r){const i=parseFloat(e);if(!isNaN(i))return u(i,t,r);const s=t.toString();switch(r){case"<>":return e!==s;case"=":return e===s;case">":return e>s;case"<":return e<s;case">=":return e>=s;case"<=":return e<=s}}(e,h,p);if(n.isString(h))return function(e,t,r){switch(r){case"<>":return e!==t;case"=":return e===t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}}(e,h,p);if(r.isDateTime(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(r.isDateOnly(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(r.isTimeOnly(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(r.isTimestampOffset(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}else if(r.isDateTime(e)){if(a(h)){if(s.isUnknownTimeZone(e.zone)){if(o.DateTime.isDateTime(h)&&!s.isUnknownTimeZone(h.zone))return d(e,h,p);if(i.SqlTimeStampOffset.isTimestampOffset(h))return d(e,h,p)}else if(o.DateTime.isDateTime(h)&&s.isUnknownTimeZone(h.zone)){if(!s.isUnknownTimeZone(e.zone))return d(e,h,p);if(i.SqlTimeStampOffset.isTimestampOffset(e))return d(e,h,p)}return u(c(e),c(h),p)}if(n.isString(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(r.isDateOnly(h))return function(e,t,r){const i=t.toDateTimeLuxon(e.zone);return u((e=e.startOf("day")).toMillis(),i.toMillis(),r)}(e,h,p);if(r.isTimeOnly(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(n.isNumber(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}else if(r.isDateOnly(e)){if(r.isTimestampOffset(h))return function(e,t,r){const i=e.toDateTimeLuxon(t.toDateTime().zone);return t=t.startOfDay(),u(i.toMillis(),t.toMilliseconds(),r)}(e,h,p);if(r.isDateTime(h))return function(e,t,r){const i=e.toDateTimeLuxon(t.zone);return t=t.startOf("day"),u(i.toMillis(),t.toMillis(),r)}(e,h,p);if(n.isString(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(r.isDateOnly(h))return u(e.toNumber(),h.toNumber(),p);if(r.isTimeOnly(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(n.isNumber(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}else if(r.isTimeOnly(e)){if(r.isTimeOnly(h))return u(e.toNumber(),h.toNumber(),p);if(n.isString(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(n.isNumber(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(r.isDateOnly(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(a(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}else if(r.isTimestampOffset(e)){if(a(h))return o.DateTime.isDateTime(h)&&s.isUnknownTimeZone(h.zone)?d(e,h,p):u(c(e),c(h),p);if(n.isString(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(r.isDateOnly(h))return function(e,t,r){const i=t.toDateTimeLuxon(e.toDateTime().zone);return u((e=e.startOfDay()).toMilliseconds(),i.toMillis(),r)}(e,h,p);if(r.isTimeOnly(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator);if(n.isNumber(h))throw new t.SqlError(t.SqlErrorCodes.InvalidOperator)}switch(p){case"<>":return e!==h;case"=":return e===h;case">":return e>h;case"<":return e<h;case">=":return e>=h;case"<=":return e<=h}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/sql/WhereGrammar":function(){define(["exports"],(function(e){"use strict";class t extends SyntaxError{constructor(e,t,r,i){super(e),this.expected=t,this.found=r,this.location=i,this.name="SyntaxError"}format(e){let t="Error: "+this.message;if(this.location){let r=null;const i=e.find((e=>e.source===this.location.source));i&&(r=i.text.split(/\r\n|\n|\r/g));const s=this.location.start,n=this.location.source&&"function"==typeof this.location.source.offset?this.location.source.offset(s):s,o=this.location.source+":"+n.line+":"+n.column;if(r){const e=this.location.end,i="".padEnd(n.line.toString().length," "),a=r[s.line-1],l=(s.line===e.line?e.column:a.length+1)-s.column||1;t+="\n --\x3e "+o+"\n"+i+" |\n"+n.line+" | "+a+"\n"+i+" | "+"".padEnd(s.column-1," ")+"".padEnd(l,"^")}else t+="\n at "+o}return t}static buildMessage(e,t){function r(e){return e.codePointAt(0).toString(16).toUpperCase()}const i=Object.prototype.hasOwnProperty.call(RegExp.prototype,"unicode")?new RegExp("[\\p{C}\\p{Mn}\\p{Mc}]","gu"):null;function s(e){return i?e.replace(i,(e=>"\\u{"+r(e)+"}")):e}function n(e){return s(e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(e=>"\\x0"+r(e))).replace(/[\x10-\x1F\x7F-\x9F]/g,(e=>"\\x"+r(e))))}function o(e){return s(e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(e=>"\\x0"+r(e))).replace(/[\x10-\x1F\x7F-\x9F]/g,(e=>"\\x"+r(e))))}const a={literal:e=>'"'+n(e.text)+'"',class(e){const t=e.parts.map((e=>Array.isArray(e)?o(e[0])+"-"+o(e[1]):o(e)));return"["+(e.inverted?"^":"")+t.join("")+"]"+(e.unicode?"u":"")},any:()=>"any character",end:()=>"end of input",other:e=>e.description};function l(e){return a[e.type](e)}return"Expected "+function(e){const t=e.map(l);if(t.sort(),t.length>0){let e=1;for(let r=1;r<t.length;r++)t[r-1]!==t[r]&&(t[e]=t[r],e++);t.length=e}switch(t.length){case 1:return t[0];case 2:return t[0]+" or "+t[1];default:return t.slice(0,-1).join(", ")+", or "+t[t.length-1]}}(e)+" but "+function(e){return e?'"'+n(e)+'"':"end of input"}(t)+" found."}}e.WhereGrammar=class{static parse(e){return function(e,r){const i={},s=(r=void 0!==r?r:{}).grammarSource,n={start:vr};let o=vr;const a="!",l="=",c=">=",u=">",d="<=",h="<>",p="!=",m="||",f="@",g="'",y="N'",_="''",b=".",v="null",S="true",w="false",x="in",T="is",C="like",P="escape",M="not",R="and",E="or",O="between",A="from",I="for",D="substring",F="extract",L="trim",N="position",U="timestamp",V="date",B="time",G="leading",k="trailing",z="both",j="cast",q="as",H="integer",W="int",$="smallint",Q="float",Z="real",Y="varchar",X="to",K="interval",J="year",ee="timezone_hour",te="timezone_minute",re="month",ie="day",se="hour",ne="minute",oe="second",ae="dow",le="doy",ce="week",ue="case",de="end",he="when",pe="then",me="else",fe=",",ge="(",ye=")",_e="`",be=/^[<-=]/,ve=/^[+\-]/,Se=/^[*\/]/,we=/^[A-Za-z_\x80-\uFFFF]/,xe=/^[A-Za-z0-9_]/,Te=/^[A-Za-z0-9_.\x80-\uFFFF]/,Ce=/^["]/,Pe=/^[^']/,Me=/^[0-9]/,Re=/^[eE]/,Ee=/^[ \t\n\r]/,Oe=/^[^`]/,Ae=fr("!",!1),Ie=fr("=",!1),De=fr(">=",!1),Fe=fr(">",!1),Le=fr("<=",!1),Ne=fr("<>",!1),Ue=gr([["<","="]],!1,!1,!1),Ve=fr("!=",!1),Be=gr(["+","-"],!1,!1,!1),Ge=fr("||",!1),ke=gr(["*","/"],!1,!1,!1),ze=gr([["A","Z"],["a","z"],"_",["","￿"]],!1,!1,!1),je=gr([["A","Z"],["a","z"],["0","9"],"_"],!1,!1,!1),qe=gr([["A","Z"],["a","z"],["0","9"],"_",".",["","￿"]],!1,!1,!1),He=gr(['"'],!1,!1,!1),We=fr("@",!1),$e=fr("'",!1),Qe=fr("N'",!1),Ze=fr("''",!1),Ye=gr(["'"],!0,!1,!1),Xe=fr(".",!1),Ke=gr([["0","9"]],!1,!1,!1),Je=gr(["e","E"],!1,!1,!1),et=fr("NULL",!0),tt=fr("TRUE",!0),rt=fr("FALSE",!0),it=fr("IN",!0),st=fr("IS",!0),nt=fr("LIKE",!0),ot=fr("ESCAPE",!0),at=fr("NOT",!0),lt=fr("AND",!0),ct=fr("OR",!0),ut=fr("BETWEEN",!0),dt=fr("FROM",!0),ht=fr("FOR",!0),pt=fr("SUBSTRING",!0),mt=fr("EXTRACT",!0),ft=fr("TRIM",!0),gt=fr("POSITION",!0),yt=fr("TIMESTAMP",!0),_t=fr("DATE",!0),bt=fr("TIME",!0),vt=fr("LEADING",!0),St=fr("TRAILING",!0),wt=fr("BOTH",!0),xt=fr("CAST",!0),Tt=fr("AS",!0),Ct=fr("INTEGER",!0),Pt=fr("INT",!0),Mt=fr("SMALLINT",!0),Rt=fr("FLOAT",!0),Et=fr("REAL",!0),Ot=fr("VARCHAR",!0),At=fr("TO",!0),It=fr("INTERVAL",!0),Dt=fr("YEAR",!0),Ft=fr("TIMEZONE_HOUR",!0),Lt=fr("TIMEZONE_MINUTE",!0),Nt=fr("MONTH",!0),Ut=fr("DAY",!0),Vt=fr("HOUR",!0),Bt=fr("MINUTE",!0),Gt=fr("SECOND",!0),kt=fr("DOW",!0),zt=fr("DOY",!0),jt=fr("WEEK",!0),qt=fr("CASE",!0),Ht=fr("END",!0),Wt=fr("WHEN",!0),$t=fr("THEN",!0),Qt=fr("ELSE",!0),Zt=fr(",",!1),Yt=fr("(",!1),Xt=fr(")",!1),Kt=gr([" ","\t","\n","\r"],!1,!1,!1),Jt=fr("`",!1),er=gr(["`"],!0,!1,!1);function tr(e,t,r){return{op:t,expr:r,location:pr()}}function rr(e,t,r){return{op:t,expr:r,location:pr()}}function ir(e,t){return{op:e,expr:t,location:pr()}}function sr(e,t,r){return{op:t,expr:r,location:pr()}}function nr(e,t,r){return{op:t,expr:r,location:pr()}}let or=0|r.peg$currPos,ar=or;const lr=[{line:1,column:1}];let cr,ur=or,dr=r.peg$maxFailExpected||[],hr=0|r.peg$silentFails;if(r.startRule){if(!(r.startRule in n))throw new Error("Can't start parsing from rule \""+r.startRule+'".');o=n[r.startRule]}function pr(){return _r(ar,or)}function mr(e,r){throw function(e,r){return new t(e,null,null,r)}(e,r=void 0!==r?r:_r(ar,or))}function fr(e,t){return{type:"literal",text:e,ignoreCase:t}}function gr(e,t,r,i){return{type:"class",parts:e,inverted:t,ignoreCase:r,unicode:i}}function yr(t){let r,i=lr[t];if(i)return i;if(t>=lr.length)r=lr.length-1;else for(r=t;!lr[--r];);for(i=lr[r],i={line:i.line,column:i.column};r<t;)10===e.charCodeAt(r)?(i.line++,i.column=1):i.column++,r++;return lr[t]=i,i}function _r(e,t,r){const i=yr(e),n=yr(t);return{source:s,start:{offset:e,line:i.line,column:i.column},end:{offset:t,line:n.line,column:n.column}}}function br(e){or<ur||(or>ur&&(ur=or,dr=[]),dr.push(e))}function vr(){let e,t;return e=or,Ei(),t=wr(),t!==i?(Ei(),ar=e,e=t):(or=e,e=i),e}function Sr(){let e,t,r,s,n,o,a,l;if(e=or,t=Mi(),t!==i){for(Ei(),r=[],s=wr();s!==i;)r.push(s),s=or,n=or,o=Ei(),a=Pi(),a!==i?(l=Ei(),o=[o,a,l],n=o):(or=n,n=i),n!==i?(n=wr(),n===i?(or=s,s=i):s=n):s=n;s=Ei(),n=Ri(),n!==i?(ar=e,c=r,e={type:"expression-list",location:pr(),value:c}):(or=e,e=i)}else or=e,e=i;var c;return e}function wr(){let e,t,r,s,n,o;if(e=or,t=xr(),t!==i){for(r=[],s=or,Ei(),n=li(),n!==i?(Ei(),o=xr(),o!==i?(ar=s,s=tr(0,n,o)):(or=s,s=i)):(or=s,s=i);s!==i;)r.push(s),s=or,Ei(),n=li(),n!==i?(Ei(),o=xr(),o!==i?(ar=s,s=tr(0,n,o)):(or=s,s=i)):(or=s,s=i);ar=e,e=Di(t,r)}else or=e,e=i;return e}function xr(){let e,t,r,s,n,o;if(e=or,t=Tr(),t!==i){for(r=[],s=or,Ei(),n=ai(),n!==i?(Ei(),o=Tr(),o!==i?(ar=s,s=rr(0,n,o)):(or=s,s=i)):(or=s,s=i);s!==i;)r.push(s),s=or,Ei(),n=ai(),n!==i?(Ei(),o=Tr(),o!==i?(ar=s,s=rr(0,n,o)):(or=s,s=i)):(or=s,s=i);ar=e,e=Di(t,r)}else or=e,e=i;return e}function Tr(){let t,r,s,n,o;return t=or,r=oi(),r===i&&(r=or,33===e.charCodeAt(or)?(s=a,or++):(s=i,0===hr&&br(Ae)),s!==i?(n=or,hr++,61===e.charCodeAt(or)?(o=l,or++):(o=i,0===hr&&br(Ie)),hr--,o===i?n=void 0:(or=n,n=i),n!==i?(s=[s,n],r=s):(or=r,r=i)):(or=r,r=i)),r!==i?(s=Ei(),n=Tr(),n!==i?(ar=t,t=function(e,t,r){return{type:"unary-expression",location:r,operator:"NOT",expr:t}}(0,n,pr())):(or=t,t=i)):(or=t,t=i),t===i&&(t=function(){let t,r,s,n;var o,a;return t=or,r=Rr(),r!==i?(s=or,Ei(),n=function(){let t;return t=function(){let e,t,r,s,n;if(e=or,t=[],r=or,Ei(),s=Cr(),s!==i?(Ei(),n=Rr(),n!==i?(ar=r,r=ir(s,n)):(or=r,r=i)):(or=r,r=i),r!==i)for(;r!==i;)t.push(r),r=or,Ei(),s=Cr(),s!==i?(Ei(),n=Rr(),n!==i?(ar=r,r=ir(s,n)):(or=r,r=i)):(or=r,r=i);else t=i;return t!==i&&(ar=e,t={type:"arithmetic",tail:t}),e=t,e}(),t===i&&(t=function(){let e,t,r;return e=or,t=Mr(),t!==i?(Ei(),r=Sr(),r!==i?(ar=e,e={op:t,right:r}):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=Mr(),t!==i?(Ei(),r=Br(),r!==i?(ar=e,e={op:t,right:r}):(or=e,e=i)):(or=e,e=i)),e}(),t===i&&(t=function(){let e,t,r,s,n,o,a,l;var c,u;return e=or,t=oi(),t!==i?(Ei(),r=ci(),r!==i?(s=Ei(),n=or,o=Rr(),o!==i?(Ei(),a=ai(),a!==i?(Ei(),l=Rr(),l!==i?(ar=n,c=o,u=l,n=Ii(pr(),c,u)):(or=n,n=i)):(or=n,n=i)):(or=n,n=i),n!==i?(ar=e,e={op:"NOT"+r,right:n}):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=ci(),t!==i?(Ei(),r=or,s=Rr(),s!==i?(n=Ei(),o=ai(),o!==i?(Ei(),a=Rr(),a!==i?(ar=r,r=function(e,t,r){return Ii(pr(),t,r)}(0,s,a)):(or=r,r=i)):(or=r,r=i)):(or=r,r=i),r!==i?(ar=e,e={op:t,right:r}):(or=e,e=i)):(or=e,e=i)),e}(),t===i&&(t=function(){let e,t,r,s;return e=or,t=si(),t!==i?(Ei(),r=oi(),r!==i?(Ei(),s=Rr(),s!==i?(ar=e,e={op:t+"NOT",right:s}):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=si(),t!==i?(Ei(),r=Rr(),r!==i?(ar=e,e={op:t,right:r}):(or=e,e=i)):(or=e,e=i)),e}(),t===i&&(t=function(){let t,r,s,n,o;return t=or,r=Pr(),r!==i?(Ei(),s=$r(),s!==i?(Ei(),n=function(){let t,r,s,n;return t=or,r=e.substr(or,6),r.toLowerCase()===P?or+=6:(r=i,0===hr&&br(ot)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="ESCAPE"):(or=t,t=i)):(or=t,t=i),t}(),n!==i?(Ei(),o=Qr(),o!==i?(ar=t,t={op:r,right:s,escape:o.value}):(or=t,t=i)):(or=t,t=i)):(or=t,t=i)):(or=t,t=i),t===i&&(t=or,r=Pr(),r!==i?(Ei(),s=$r(),s!==i?(ar=t,t={op:r,right:s,escape:""}):(or=t,t=i)):(or=t,t=i)),t}())))),t}(),n!==i?s=n:(or=s,s=i),s===i&&(s=null),ar=t,o=r,t=""==(a=s)||null==a||null==a?o:"arithmetic"==a.type?Di(o,a.tail):Ai(a.op,o,a.right,a.escape,pr())):(or=t,t=i),t}()),t}function Cr(){let t;return e.substr(or,2)===c?(t=c,or+=2):(t=i,0===hr&&br(De)),t===i&&(62===e.charCodeAt(or)?(t=u,or++):(t=i,0===hr&&br(Fe)),t===i&&(e.substr(or,2)===d?(t=d,or+=2):(t=i,0===hr&&br(Le)),t===i&&(e.substr(or,2)===h?(t=h,or+=2):(t=i,0===hr&&br(Ne)),t===i&&(t=e.charAt(or),be.test(t)?or++:(t=i,0===hr&&br(Ue)),t===i&&(e.substr(or,2)===p?(t=p,or+=2):(t=i,0===hr&&br(Ve))))))),t}function Pr(){let e,t,r,s,n;var o;return e=or,t=or,r=oi(),r!==i?(s=Ei(),n=ni(),n!==i?(r=[r,s,n],t=r):(or=t,t=i)):(or=t,t=i),t!==i&&(ar=e,t=(o=t)[0]+" "+o[2]),e=t,e===i&&(e=ni()),e}function Mr(){let e,t,r,s,n;var o;return e=or,t=or,r=oi(),r!==i?(s=Ei(),n=ii(),n!==i?(r=[r,s,n],t=r):(or=t,t=i)):(or=t,t=i),t!==i&&(ar=e,t=(o=t)[0]+" "+o[2]),e=t,e===i&&(e=ii()),e}function Rr(){let e,t,r,s,n,o;if(e=or,t=Or(),t!==i){for(r=[],s=or,Ei(),n=Er(),n!==i?(Ei(),o=Or(),o!==i?(ar=s,s=sr(0,n,o)):(or=s,s=i)):(or=s,s=i);s!==i;)r.push(s),s=or,Ei(),n=Er(),n!==i?(Ei(),o=Or(),o!==i?(ar=s,s=sr(0,n,o)):(or=s,s=i)):(or=s,s=i);ar=e,e=Di(t,r)}else or=e,e=i;return e}function Er(){let t;return t=e.charAt(or),ve.test(t)?or++:(t=i,0===hr&&br(Be)),t===i&&(e.substr(or,2)===m?(t=m,or+=2):(t=i,0===hr&&br(Ge))),t}function Or(){let e,t,r,s,n,o;if(e=or,t=Ir(),t!==i){for(r=[],s=or,Ei(),n=Ar(),n!==i?(Ei(),o=Ir(),o!==i?(ar=s,s=nr(0,n,o)):(or=s,s=i)):(or=s,s=i);s!==i;)r.push(s),s=or,Ei(),n=Ar(),n!==i?(Ei(),o=Ir(),o!==i?(ar=s,s=nr(0,n,o)):(or=s,s=i)):(or=s,s=i);ar=e,e=Di(t,r)}else or=e,e=i;return e}function Ar(){let t;return t=e.charAt(or),Se.test(t)?or++:(t=i,0===hr&&br(ke)),t}function Ir(){let t,r,s,n;var o;return t=function(){let t;return t=Qr(),t===i&&(t=function(){let e,t,r,s;var n;return e=or,t=function(){let e,t,r,s;return e=or,t=Kr(),t!==i?(r=Jr(),r!==i?(s=ei(),s!==i?(ar=e,e=parseFloat(t+r+s)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=Kr(),t!==i?(r=Jr(),r!==i?(ar=e,e=parseFloat(t+r)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=Kr(),t!==i?(r=ei(),r!==i?(ar=e,e=parseFloat(t+r)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=Kr(),t!==i&&(ar=e,t=parseFloat(t)),e=t))),e}(),t!==i?(r=or,hr++,s=Fr(),hr--,s===i?r=void 0:(or=r,r=i),r!==i?(ar=e,n=t,e={type:"number",location:pr(),value:n}):(or=e,e=i)):(or=e,e=i),e}(),t===i&&(t=function(){let t,r;return t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===S?or+=4:(r=i,0===hr&&br(tt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(r=[r,s],t=r):(or=t,t=i)):(or=t,t=i),t}(),r!==i&&(ar=t,r={type:"boolean",location:pr(),value:!0}),t=r,t===i&&(t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,5),r.toLowerCase()===w?or+=5:(r=i,0===hr&&br(rt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(r=[r,s],t=r):(or=t,t=i)):(or=t,t=i),t}(),r!==i&&(ar=t,r={type:"boolean",location:pr(),value:!1}),t=r),t}(),t===i&&(t=function(){let t,r;return t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===v?or+=4:(r=i,0===hr&&br(et)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(r=[r,s],t=r):(or=t,t=i)):(or=t,t=i),t}(),r!==i&&(ar=t,r={type:"null",location:pr(),value:null}),t=r,t}(),t===i&&(t=function(){let e,t,r;var s,n;return e=or,t=pi(),t!==i?(Ei(),r=$r(),r!==i?(ar=e,"string"===(s=r).type&&(n=s.value,!0!==/^(\d{4})-(\d{1,2})-(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?[ ]{0,1}(\+|\-)(\d{1,2}):(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})?[ ]{0,1}(\+|\-)(\d{1,2}):(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/.test(n)&&mr("Date literal is invalid")),e={type:"date",location:pr(),value:s.value}):(or=e,e=i)):(or=e,e=i),e}(),t===i&&(t=function(){let e,t,r;var s,n;return e=or,t=hi(),t!==i?(Ei(),r=$r(),r!==i?(ar=e,"string"===(s=r).type&&(n=s.value,!0!==/^(\d{4})-(\d{1,2})-(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})(\.[0-9]+)?[ ]{0,1}(\+|\-)(\d{1,2}):(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})?[ ]{0,1}(\+|\-)(\d{1,2}):(\d{1,2})$|^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/.test(n)&&mr("Timestamp literal is invalid")),e={type:"timestamp",location:pr(),value:s.value}):(or=e,e=i)):(or=e,e=i),e}(),t===i&&(t=function(){let t,r,s,n,o;var a,l,c;return t=or,r=fi(),r!==i?(Ei(),s=e.charAt(or),ve.test(s)?or++:(s=i,0===hr&&br(Be)),s!==i?(Ei(),n=$r(),n!==i?(Ei(),o=jr(),o!==i?(ar=t,a=s,l=n,c=o,t={type:"interval",location:pr(),value:l,qualifier:c,op:a}):(or=t,t=i)):(or=t,t=i)):(or=t,t=i)):(or=t,t=i),t===i&&(t=or,r=fi(),r!==i?(Ei(),s=$r(),s!==i?(Ei(),n=jr(),n!==i?(ar=t,t=function(e,t){return{type:"interval",location:pr(),value:e,qualifier:t,op:""}}(s,n)):(or=t,t=i)):(or=t,t=i)):(or=t,t=i)),t}(),t===i&&(t=function(){let e,t,r;var s,n;return e=or,t=mi(),t!==i?(Ei(),r=$r(),r!==i?(ar=e,"string"===(s=r).type&&(n=s.value,!0!==/^(\d{1,2}):(\d{1,2}):(\d{1,2})$|^(\d{1,2}):(\d{1,2})$|^(\d{1,2}):(\d{1,2}):(\d{1,2}).([0-9]+)$/.test(n)&&mr("Time literal is invalid")),e={type:"time",location:pr(),value:s.value}):(or=e,e=i)):(or=e,e=i),e}()))))))),t}(),t===i&&(t=function(){let e,t,r,s,n,o,a,l;var c,u,d;return e=or,t=di(),t!==i?(Ei(),r=or,s=Mi(),s!==i?(Ei(),n=zr(),n!==i?(Ei(),o=ui(),o!==i?(Ei(),a=wr(),a!==i?(Ei(),l=Ri(),l!==i?(ar=r,u=n,d=a,r=Ii(pr(),u,d)):(or=r,r=i)):(or=r,r=i)):(or=r,r=i)):(or=r,r=i)):(or=r,r=i),r===i&&(r=or,s=Mi(),s!==i?(Ei(),n=zr(),n!==i?(Ei(),o=Pi(),o!==i?(Ei(),a=wr(),a!==i?(Ei(),l=Ri(),l!==i?(ar=r,r=function(e,t){return Ii(pr(),e,t)}(n,a)):(or=r,r=i)):(or=r,r=i)):(or=r,r=i)):(or=r,r=i)):(or=r,r=i)),r!==i?(ar=e,c=r,e={type:"function",location:pr(),name:"extract",args:c}):(or=e,e=i)):(or=e,e=i),e}(),t===i&&(t=function(){let t,r,s,n,o,a,l,c,u,d,h;var p,m,f,g;return t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,9),r.toLowerCase()===D?or+=9:(r=i,0===hr&&br(pt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="SUBSTRING"):(or=t,t=i)):(or=t,t=i),t}(),r!==i?(Ei(),s=or,n=Mi(),n!==i?(Ei(),o=wr(),o!==i?(Ei(),a=ui(),a!==i?(Ei(),l=wr(),l!==i?(Ei(),c=or,u=function(){let t,r,s,n;return t=or,r=e.substr(or,3),r.toLowerCase()===I?or+=3:(r=i,0===hr&&br(ht)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="FOR"):(or=t,t=i)):(or=t,t=i),t}(),u!==i?(d=Ei(),h=wr(),h!==i?(Ei(),c=h):(or=c,c=i)):(or=c,c=i),c===i&&(c=null),u=Ri(),u!==i?(ar=s,m=o,f=l,g=c,s=Ii(pr(),m,f,...g?[g]:[])):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i),s===i&&(s=or,n=Mi(),n!==i?(Ei(),o=wr(),o!==i?(Ei(),a=Pi(),a!==i?(Ei(),l=wr(),l!==i?(Ei(),c=Pi(),c!==i?(u=Ei(),d=wr(),d!==i?(h=Ri(),h!==i?(ar=s,s=function(e,t,r){return Ii(pr(),e,t,r)}(o,l,d)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)),s!==i?(ar=t,p=s,t={type:"function",location:pr(),name:"substring",args:p}):(or=t,t=i)):(or=t,t=i),t}(),t===i&&(t=function(){let t,r,s,n,o,a,l,c,u;var d,h,p,m;return t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===L?or+=4:(r=i,0===hr&&br(ft)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="TRIM"):(or=t,t=i)):(or=t,t=i),t}(),r!==i?(Ei(),s=or,n=Mi(),n!==i?(Ei(),o=kr(),Ei(),a=wr(),a!==i?(Ei(),l=ui(),l!==i?(Ei(),c=wr(),c!==i?(Ei(),u=Ri(),u!==i?(ar=s,h=o,p=a,m=c,s=Ii(pr(),h,p,m)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i),s===i&&(s=or,n=Mi(),n!==i?(Ei(),o=kr(),Ei(),a=wr(),a!==i?(Ei(),l=Ri(),l!==i?(ar=s,s=function(e,t){return Ii(pr(),e,t)}(o,a)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)),s!==i?(ar=t,d=s,t={type:"function",location:pr(),name:"trim",args:d}):(or=t,t=i)):(or=t,t=i),t}(),t===i&&(t=function(){let t,r,s,n,o,a,l,c;var u,d,h;return t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,8),r.toLowerCase()===N?or+=8:(r=i,0===hr&&br(gt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="POSITION"):(or=t,t=i)):(or=t,t=i),t}(),r!==i?(Ei(),s=or,n=Mi(),n!==i?(Ei(),o=wr(),o!==i?(Ei(),a=ii(),a!==i?(Ei(),l=wr(),l!==i?(Ei(),c=Ri(),c!==i?(ar=s,d=o,h=l,s=Ii(pr(),d,h)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i),s===i&&(s=or,n=Mi(),n!==i?(Ei(),o=wr(),o!==i?(Ei(),a=Pi(),a!==i?(Ei(),l=wr(),l!==i?(Ei(),c=Ri(),c!==i?(ar=s,s=function(e,t){return Ii(pr(),e,t)}(o,l)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)),s!==i?(ar=t,u=s,t={type:"function",location:pr(),name:"position",args:u}):(or=t,t=i)):(or=t,t=i),t}(),t===i&&(t=function(){let t,r,s,n,o,a,l,c;var u,d,h;return t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===j?or+=4:(r=i,0===hr&&br(xt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="CAST"):(or=t,t=i)):(or=t,t=i),t}(),r!==i?(Ei(),s=or,n=Mi(),n!==i?(Ei(),o=wr(),o!==i?(Ei(),a=function(){let t,r,s,n;return t=or,r=e.substr(or,2),r.toLowerCase()===q?or+=2:(r=i,0===hr&&br(Tt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="AS"):(or=t,t=i)):(or=t,t=i),t}(),a!==i?(Ei(),l=Gr(),l!==i?(Ei(),c=Ri(),c!==i?(ar=s,d=o,h=l,s=Ii(pr(),d,h)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i),s===i&&(s=or,n=Mi(),n!==i?(Ei(),o=wr(),o!==i?(Ei(),a=Pi(),a!==i?(Ei(),l=Gr(),l!==i?(Ei(),c=Ri(),c!==i?(ar=s,s=function(e,t){return Ii(pr(),e,t)}(o,l)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)):(or=s,s=i)),s!==i?(ar=t,u=s,t={type:"function",location:pr(),name:"cast",args:u}):(or=t,t=i)):(or=t,t=i),t}(),t===i&&(t=function(){let t,r,s,n;var o,a;return t=or,r=or,hr++,s=di(),hr--,s===i?r=void 0:(or=r,r=i),r!==i?(s=function(){let t,r,s,n;if(t=or,r=Dr(),r!==i&&(ar=t),t=r,t===i)if(t=or,96===e.charCodeAt(or)?(r=_e,or++):(r=i,0===hr&&br(Jt)),r!==i){if(s=[],n=e.charAt(or),Oe.test(n)?or++:(n=i,0===hr&&br(er)),n!==i)for(;n!==i;)s.push(n),n=e.charAt(or),Oe.test(n)?or++:(n=i,0===hr&&br(er));else s=i;s!==i?(96===e.charCodeAt(or)?(n=_e,or++):(n=i,0===hr&&br(Jt)),n!==i?(ar=t,t=s.join("")):(or=t,t=i)):(or=t,t=i)}else or=t,t=i;return t}(),s!==i?(Ei(),n=Sr(),n!==i?(ar=t,o=s,a=n,t={type:"function",location:pr(),name:o,args:a}):(or=t,t=i)):(or=t,t=i)):(or=t,t=i),t}(),t===i&&(t=function(){let e;return e=function(){let e,t,r,s,n,o,a;if(e=or,t=wi(),t!==i)if(Ei(),r=wr(),r!==i){for(Ei(),s=[],n=or,o=Yr(),o!==i?(a=Ei(),n=o):(or=n,n=i);n!==i;)s.push(n),n=or,o=Yr(),o!==i?(a=Ei(),n=o):(or=n,n=i);n=xi(),n!==i?(ar=e,l=r,c=s,e={type:"case-expression",location:pr(),format:"simple",operand:l,clauses:c,else:null,elseLocation:null}):(or=e,e=i)}else or=e,e=i;else or=e,e=i;var l,c;if(e===i)if(e=or,t=wi(),t!==i)if(Ei(),r=wr(),r!==i){for(Ei(),s=[],n=or,o=Yr(),o!==i?(a=Ei(),n=o):(or=n,n=i);n!==i;)s.push(n),n=or,o=Yr(),o!==i?(a=Ei(),n=o):(or=n,n=i);n=Xr(),n!==i?(o=Ei(),a=xi(),a!==i?(ar=e,e=function(e,t,r){return{type:"case-expression",location:pr(),format:"simple",operand:e,clauses:t,else:r.value,elseLocation:r.location}}(r,s,n)):(or=e,e=i)):(or=e,e=i)}else or=e,e=i;else or=e,e=i;return e}(),e===i&&(e=function(){let e,t,r,s,n,o;if(e=or,t=wi(),t!==i){for(Ei(),r=[],s=or,n=Zr(),n!==i?(o=Ei(),s=n):(or=s,s=i);s!==i;)r.push(s),s=or,n=Zr(),n!==i?(o=Ei(),s=n):(or=s,s=i);s=xi(),s!==i?(ar=e,a=r,e={type:"case-expression",location:pr(),format:"searched",clauses:a,else:null,elseLocation:null}):(or=e,e=i)}else or=e,e=i;var a;if(e===i)if(e=or,t=wi(),t!==i){for(Ei(),r=[],s=or,n=Zr(),n!==i?(o=Ei(),s=n):(or=s,s=i);s!==i;)r.push(s),s=or,n=Zr(),n!==i?(o=Ei(),s=n):(or=s,s=i);s=Xr(),s!==i?(n=Ei(),o=xi(),o!==i?(ar=e,e=function(e,t){return{type:"case-expression",location:pr(),format:"searched",clauses:e,else:t.value,elseLocation:t.location}}(r,s)):(or=e,e=i)):(or=e,e=i)}else or=e,e=i;return e}()),e}(),t===i&&(t=function(){let e,t;var r,s;return e=or,t=function(){let e,t;return e=or,t=function(){let e,t,r,s;if(e=or,t=Fr(),t!==i){for(r=[],s=Nr();s!==i;)r.push(s),s=Nr();ar=e,e=t+r.join("")}else or=e,e=i;return e}(),t!==i&&(ar=e),e=t,e}(),t!==i&&(ar=e,t=/^CURRENT_DATE$/i.test(r=t)?{type:"current-time",location:pr(),mode:"date"}:/^CURRENT_TIMESTAMP$/i.test(r)?{type:"current-time",location:pr(),mode:"timestamp"}:/^CURRENT_TIME$/i.test(r)?{type:"current-time",location:pr(),mode:"time"}:/^CURRENT_USER$/i.test(r)?{type:"current-user",location:pr()}:{type:"column-reference",location:pr(),table:"",column:r}),e=t,e===i&&(e=or,t=function(){let e,t,r,s;return e=or,t=Vr(),t!==i?(r=function(){let e,t,r;for(e=or,t=[],r=Ur();r!==i;)t.push(r),r=Ur();return ar=e,t=t.join(""),e=t,e}(),s=Vr(),s!==i?(ar=e,e=r):(or=e,e=i)):(or=e,e=i),e}(),t!==i&&(ar=e,s=t,t={type:"column-reference",location:pr(),table:"",column:s,delimited:!0}),e=t),e}(),t===i&&(t=Br(),t===i&&(t=or,r=Mi(),r!==i?(Ei(),s=wr(),s!==i?(Ei(),n=Ri(),n!==i?(ar=t,(o=s).paren=!0,t=o):(or=t,t=i)):(or=t,t=i)):(or=t,t=i))))))))))),t}function Dr(){let e,t,r,s;if(e=or,t=Fr(),t!==i){for(r=[],s=Lr();s!==i;)r.push(s),s=Lr();ar=e,e=t+r.join("")}else or=e,e=i;return e}function Fr(){let t;return t=e.charAt(or),we.test(t)?or++:(t=i,0===hr&&br(ze)),t}function Lr(){let t;return t=e.charAt(or),xe.test(t)?or++:(t=i,0===hr&&br(je)),t}function Nr(){let t;return t=e.charAt(or),Te.test(t)?or++:(t=i,0===hr&&br(qe)),t}function Ur(){let t;return t=function(){let t;return t=e.charAt(or),Te.test(t)?or++:(t=i,0===hr&&br(qe)),t}(),t===i&&(t=function(){let e,t,r;return e=or,t=Vr(),t!==i?(r=Vr(),r!==i?(ar=e,e='"'):(or=e,e=i)):(or=e,e=i),e}()),t}function Vr(){let t;return t=e.charAt(or),Ce.test(t)?or++:(t=i,0===hr&&br(He)),t}function Br(){let t,r,s,n;var o;return t=or,r=or,64===e.charCodeAt(or)?(s=f,or++):(s=i,0===hr&&br(We)),s!==i?(n=Dr(),n!==i?(s=[s,n],r=s):(or=r,r=i)):(or=r,r=i),r!==i&&(ar=t,o=r,r={type:"parameter",location:pr(),value:o[1]}),t=r,t}function Gr(){let t,r,s,n,o;var a;return t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,7),r.toLowerCase()===H?or+=7:(r=i,0===hr&&br(Ct)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="INTEGER"):(or=t,t=i)):(or=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=or,r=e.substr(or,3),r.toLowerCase()===W?or+=3:(r=i,0===hr&&br(Pt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="INT"):(or=t,t=i)):(or=t,t=i),t}()),r!==i&&(ar=t,r={type:"data-type",location:pr(),value:{type:"integer"}}),t=r,t===i&&(t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,8),r.toLowerCase()===$?or+=8:(r=i,0===hr&&br(Mt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="SMALLINT"):(or=t,t=i)):(or=t,t=i),t}(),r!==i&&(ar=t,r={type:"data-type",location:pr(),value:{type:"smallint"}}),t=r,t===i&&(t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,5),r.toLowerCase()===Q?or+=5:(r=i,0===hr&&br(Rt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="FLOAT"):(or=t,t=i)):(or=t,t=i),t}(),r!==i&&(ar=t,r={type:"data-type",location:pr(),value:{type:"float"}}),t=r,t===i&&(t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===Z?or+=4:(r=i,0===hr&&br(Et)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="REAL"):(or=t,t=i)):(or=t,t=i),t}(),r!==i&&(ar=t,r={type:"data-type",location:pr(),value:{type:"real"}}),t=r,t===i&&(t=or,r=pi(),r!==i&&(ar=t,r={type:"data-type",location:pr(),value:{type:"date"}}),t=r,t===i&&(t=or,r=hi(),r!==i&&(ar=t,r={type:"data-type",location:pr(),value:{type:"timestamp"}}),t=r,t===i&&(t=or,r=mi(),r!==i&&(ar=t,r={type:"data-type",location:pr(),value:{type:"time"}}),t=r,t===i&&(t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,7),r.toLowerCase()===Y?or+=7:(r=i,0===hr&&br(Ot)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="VARCHAR"):(or=t,t=i)):(or=t,t=i),t}(),r!==i?(Ei(),s=Mi(),s!==i?(Ei(),n=ti(),n!==i?(Ei(),o=Ri(),o!==i?(ar=t,a=n,t={type:"data-type",location:pr(),value:{type:"varchar",size:parseInt(a)}}):(or=t,t=i)):(or=t,t=i)):(or=t,t=i)):(or=t,t=i)))))))),t}function kr(){let t,r;var s;return t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,7),r.toLowerCase()===G?or+=7:(r=i,0===hr&&br(vt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="LEADING"):(or=t,t=i)):(or=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=or,r=e.substr(or,8),r.toLowerCase()===k?or+=8:(r=i,0===hr&&br(St)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="TRAILING"):(or=t,t=i)):(or=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===z?or+=4:(r=i,0===hr&&br(wt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="BOTH"):(or=t,t=i)):(or=t,t=i),t}())),r===i&&(r=null),ar=t,s=r,r={type:"string",location:pr(),value:s??"BOTH"},t=r,t}function zr(){let t,r;var s;return t=or,r=gi(),r===i&&(r=yi(),r===i&&(r=_i(),r===i&&(r=bi(),r===i&&(r=vi(),r===i&&(r=Si(),r===i&&(r=function(){let t,r,s,n;return t=or,r=e.substr(or,13),r.toLowerCase()===ee?or+=13:(r=i,0===hr&&br(Ft)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="TIMEZONE_HOUR"):(or=t,t=i)):(or=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=or,r=e.substr(or,15),r.toLowerCase()===te?or+=15:(r=i,0===hr&&br(Lt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="TIMEZONE_MINUTE"):(or=t,t=i)):(or=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=or,r=e.substr(or,3),r.toLowerCase()===ae?or+=3:(r=i,0===hr&&br(kt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="DOW"):(or=t,t=i)):(or=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=or,r=e.substr(or,3),r.toLowerCase()===le?or+=3:(r=i,0===hr&&br(zt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="DOY"):(or=t,t=i)):(or=t,t=i),t}(),r===i&&(r=function(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===ce?or+=4:(r=i,0===hr&&br(jt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="WEEK"):(or=t,t=i)):(or=t,t=i),t}())))))))))),r!==i&&(ar=t,s=r,r={type:"string",location:pr(),value:s}),t=r,t}function jr(){let t,r,s,n;var o,a;return t=or,r=function(){let e,t,r,s,n;var o,a;return e=or,t=qr(),t!==i?(Ei(),r=Mi(),r!==i?(Ei(),s=Wr(),s!==i?(Ei(),n=Ri(),n!==i?(ar=e,o=t,a=s,e={type:"interval-period",location:pr(),period:o.value,precision:a,secondary:null}):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=qr(),t!==i&&(ar=e,t=function(e){return{type:"interval-period",location:pr(),period:e.value,precision:null,secondary:null}}(t)),e=t),e}(),r!==i?(Ei(),s=function(){let t,r,s,n;return t=or,r=e.substr(or,2),r.toLowerCase()===X?or+=2:(r=i,0===hr&&br(At)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="TO"):(or=t,t=i)):(or=t,t=i),t}(),s!==i?(Ei(),n=function(){let e,t,r,s,n,o,a;var l,c,u;return e=or,t=qr(),t!==i&&(ar=e,l=t,t={type:"interval-period",location:pr(),period:l.value,precision:null,secondary:null}),e=t,e===i&&(e=or,t=Si(),t!==i?(Ei(),r=Mi(),r!==i?(Ei(),s=Wr(),s!==i?(Ei(),n=Pi(),n!==i?(Ei(),o=Hr(),o!==i?(Ei(),a=Ri(),a!==i?(ar=e,c=s,u=o,e={type:"interval-period",location:pr(),period:"second",precision:c,secondary:u}):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=Si(),t!==i?(Ei(),r=Mi(),r!==i?(Ei(),s=Wr(),s!==i?(Ei(),n=Ri(),n!==i?(ar=e,e=function(e){return{type:"interval-period",location:pr(),period:"second",precision:e,secondary:null}}(s)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=Si(),t!==i&&(ar=e,t={type:"interval-period",location:pr(),period:"second",precision:null,secondary:null}),e=t))),e}(),n!==i?(ar=t,o=r,a=n,t={type:"interval-qualifier",location:pr(),start:o,end:a}):(or=t,t=i)):(or=t,t=i)):(or=t,t=i),t===i&&(t=function(){let e,t,r,s,n,o,a;var l,c;return e=or,t=qr(),t!==i?(Ei(),r=Mi(),r!==i?(Ei(),s=Hr(),s!==i?(Ei(),n=Ri(),n!==i?(ar=e,l=t,c=s,e={type:"interval-period",location:pr(),period:l.value,precision:c,secondary:null}):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=qr(),t!==i&&(ar=e,t=function(e){return{type:"interval-period",location:pr(),period:e.value,precision:null,secondary:null}}(t)),e=t,e===i&&(e=or,t=Si(),t!==i?(Ei(),r=Mi(),r!==i?(Ei(),s=Wr(),s!==i?(Ei(),n=Pi(),n!==i?(Ei(),o=Hr(),o!==i?(Ei(),a=Ri(),a!==i?(ar=e,e=function(e,t){return{type:"interval-period",location:pr(),period:"second",precision:e,secondary:t}}(s,o)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=Si(),t!==i?(Ei(),r=Mi(),r!==i?(Ei(),s=Hr(),s!==i?(Ei(),n=Ri(),n!==i?(ar=e,e=function(e){return{type:"interval-period",location:pr(),period:"second",precision:e,secondary:null}}(s)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e===i&&(e=or,t=Si(),t!==i&&(ar=e,t={type:"interval-period",location:pr(),period:"second",precision:null,secondary:null}),e=t)))),e}()),t}function qr(){let e,t;return e=or,t=_i(),t!==i&&(ar=e,t={type:"string",location:pr(),value:"day"}),e=t,e===i&&(e=or,t=bi(),t!==i&&(ar=e,t={type:"string",location:pr(),value:"hour"}),e=t,e===i&&(e=or,t=vi(),t!==i&&(ar=e,t={type:"string",location:pr(),value:"minute"}),e=t,e===i&&(e=or,t=yi(),t!==i&&(ar=e,t={type:"string",location:pr(),value:"month"}),e=t,e===i&&(e=or,t=gi(),t!==i&&(ar=e,t={type:"string",location:pr(),value:"year"}),e=t)))),e}function Hr(){let e,t;return e=or,t=ti(),t!==i&&(ar=e,t=parseFloat(t)),e=t,e}function Wr(){let e,t;return e=or,t=ti(),t!==i&&(ar=e,t=parseFloat(t)),e=t,e}function $r(){let e;return e=Qr(),e===i&&(e=Br()),e}function Qr(){let t,r,s,n,o;if(t=or,39===e.charCodeAt(or)?(r=g,or++):(r=i,0===hr&&br($e)),r===i&&(e.substr(or,2)===y?(r=y,or+=2):(r=i,0===hr&&br(Qe))),r!==i){for(s=[],n=or,e.substr(or,2)===_?(o=_,or+=2):(o=i,0===hr&&br(Ze)),o!==i&&(ar=n,o="'"),n=o,n===i&&(n=e.charAt(or),Pe.test(n)?or++:(n=i,0===hr&&br(Ye)));n!==i;)s.push(n),n=or,e.substr(or,2)===_?(o=_,or+=2):(o=i,0===hr&&br(Ze)),o!==i&&(ar=n,o="'"),n=o,n===i&&(n=e.charAt(or),Pe.test(n)?or++:(n=i,0===hr&&br(Ye)));39===e.charCodeAt(or)?(n=g,or++):(n=i,0===hr&&br($e)),n!==i?(ar=t,a=s,t={type:"string",location:pr(),value:a.join("")}):(or=t,t=i)}else or=t,t=i;var a;return t}function Zr(){let e,t,r,s,n;var o,a;return e=or,t=Ti(),t!==i?(Ei(),r=wr(),r!==i?(Ei(),s=Ci(),s!==i?(Ei(),n=wr(),n!==i?(ar=e,o=r,a=n,e={type:"when-clause",location:pr(),operand:o,value:a}):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e}function Yr(){let e,t,r,s,n;var o,a;return e=or,t=Ti(),t!==i?(Ei(),r=wr(),r!==i?(Ei(),s=Ci(),s!==i?(Ei(),n=wr(),n!==i?(ar=e,o=r,a=n,e={type:"when-clause",location:pr(),operand:o,value:a}):(or=e,e=i)):(or=e,e=i)):(or=e,e=i)):(or=e,e=i),e}function Xr(){let t,r,s;var n;return t=or,r=function(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===me?or+=4:(r=i,0===hr&&br(Qt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="ELSE"):(or=t,t=i)):(or=t,t=i),t}(),r!==i?(Ei(),s=wr(),s!==i?(ar=t,n=s,t={type:"else-clause",location:pr(),value:n}):(or=t,t=i)):(or=t,t=i),t}function Kr(){let t,r,s;var n;return t=ti(),t===i&&(t=or,r=e.charAt(or),ve.test(r)?or++:(r=i,0===hr&&br(Be)),r!==i?(s=ti(),s!==i?(ar=t,n=s,t=r[0]+n):(or=t,t=i)):(or=t,t=i)),t}function Jr(){let t,r,s;var n;return t=or,46===e.charCodeAt(or)?(r=b,or++):(r=i,0===hr&&br(Xe)),r!==i?(s=ti(),s===i&&(s=null),ar=t,t="."+(null!=(n=s)?n:"")):(or=t,t=i),t}function ei(){let t,r,s;return t=or,r=function(){let t,r,s;var n;return t=or,r=e.charAt(or),Re.test(r)?or++:(r=i,0===hr&&br(Je)),r!==i?(s=e.charAt(or),ve.test(s)?or++:(s=i,0===hr&&br(Be)),s===i&&(s=null),ar=t,t="e"+(null===(n=s)?"":n)):(or=t,t=i),t}(),r!==i?(s=ti(),s!==i?(ar=t,t=r+s):(or=t,t=i)):(or=t,t=i),t}function ti(){let e,t,r;if(e=or,t=[],r=ri(),r!==i)for(;r!==i;)t.push(r),r=ri();else t=i;return t!==i&&(ar=e,t=t.join("")),e=t,e}function ri(){let t;return t=e.charAt(or),Me.test(t)?or++:(t=i,0===hr&&br(Ke)),t}function ii(){let t,r,s,n;return t=or,r=e.substr(or,2),r.toLowerCase()===x?or+=2:(r=i,0===hr&&br(it)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="IN"):(or=t,t=i)):(or=t,t=i),t}function si(){let t,r,s,n;return t=or,r=e.substr(or,2),r.toLowerCase()===T?or+=2:(r=i,0===hr&&br(st)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="IS"):(or=t,t=i)):(or=t,t=i),t}function ni(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===C?or+=4:(r=i,0===hr&&br(nt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="LIKE"):(or=t,t=i)):(or=t,t=i),t}function oi(){let t,r,s,n;return t=or,r=e.substr(or,3),r.toLowerCase()===M?or+=3:(r=i,0===hr&&br(at)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="NOT"):(or=t,t=i)):(or=t,t=i),t}function ai(){let t,r,s,n;return t=or,r=e.substr(or,3),r.toLowerCase()===R?or+=3:(r=i,0===hr&&br(lt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="AND"):(or=t,t=i)):(or=t,t=i),t}function li(){let t,r,s,n;return t=or,r=e.substr(or,2),r.toLowerCase()===E?or+=2:(r=i,0===hr&&br(ct)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="OR"):(or=t,t=i)):(or=t,t=i),t}function ci(){let t,r,s,n;return t=or,r=e.substr(or,7),r.toLowerCase()===O?or+=7:(r=i,0===hr&&br(ut)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="BETWEEN"):(or=t,t=i)):(or=t,t=i),t}function ui(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===A?or+=4:(r=i,0===hr&&br(dt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="FROM"):(or=t,t=i)):(or=t,t=i),t}function di(){let t,r,s,n;return t=or,r=e.substr(or,7),r.toLowerCase()===F?or+=7:(r=i,0===hr&&br(mt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="EXTRACT"):(or=t,t=i)):(or=t,t=i),t}function hi(){let t,r,s,n;return t=or,r=e.substr(or,9),r.toLowerCase()===U?or+=9:(r=i,0===hr&&br(yt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="TIMESTAMP"):(or=t,t=i)):(or=t,t=i),t}function pi(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===V?or+=4:(r=i,0===hr&&br(_t)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="DATE"):(or=t,t=i)):(or=t,t=i),t}function mi(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===B?or+=4:(r=i,0===hr&&br(bt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="TIME"):(or=t,t=i)):(or=t,t=i),t}function fi(){let t,r,s,n;return t=or,r=e.substr(or,8),r.toLowerCase()===K?or+=8:(r=i,0===hr&&br(It)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="INTERVAL"):(or=t,t=i)):(or=t,t=i),t}function gi(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===J?or+=4:(r=i,0===hr&&br(Dt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="YEAR"):(or=t,t=i)):(or=t,t=i),t}function yi(){let t,r,s,n;return t=or,r=e.substr(or,5),r.toLowerCase()===re?or+=5:(r=i,0===hr&&br(Nt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="MONTH"):(or=t,t=i)):(or=t,t=i),t}function _i(){let t,r,s,n;return t=or,r=e.substr(or,3),r.toLowerCase()===ie?or+=3:(r=i,0===hr&&br(Ut)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="DAY"):(or=t,t=i)):(or=t,t=i),t}function bi(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===se?or+=4:(r=i,0===hr&&br(Vt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="HOUR"):(or=t,t=i)):(or=t,t=i),t}function vi(){let t,r,s,n;return t=or,r=e.substr(or,6),r.toLowerCase()===ne?or+=6:(r=i,0===hr&&br(Bt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="MINUTE"):(or=t,t=i)):(or=t,t=i),t}function Si(){let t,r,s,n;return t=or,r=e.substr(or,6),r.toLowerCase()===oe?or+=6:(r=i,0===hr&&br(Gt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="SECOND"):(or=t,t=i)):(or=t,t=i),t}function wi(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===ue?or+=4:(r=i,0===hr&&br(qt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="CASE"):(or=t,t=i)):(or=t,t=i),t}function xi(){let t,r,s,n;return t=or,r=e.substr(or,3),r.toLowerCase()===de?or+=3:(r=i,0===hr&&br(Ht)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="END"):(or=t,t=i)):(or=t,t=i),t}function Ti(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===he?or+=4:(r=i,0===hr&&br(Wt)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="WHEN"):(or=t,t=i)):(or=t,t=i),t}function Ci(){let t,r,s,n;return t=or,r=e.substr(or,4),r.toLowerCase()===pe?or+=4:(r=i,0===hr&&br($t)),r!==i?(s=or,hr++,n=Lr(),hr--,n===i?s=void 0:(or=s,s=i),s!==i?(ar=t,t="THEN"):(or=t,t=i)):(or=t,t=i),t}function Pi(){let t;return 44===e.charCodeAt(or)?(t=fe,or++):(t=i,0===hr&&br(Zt)),t}function Mi(){let t;return 40===e.charCodeAt(or)?(t=ge,or++):(t=i,0===hr&&br(Yt)),t}function Ri(){let t;return 41===e.charCodeAt(or)?(t=ye,or++):(t=i,0===hr&&br(Xt)),t}function Ei(){let e,t;for(e=[],t=Oi();t!==i;)e.push(t),t=Oi();return e}function Oi(){let t;return t=e.charAt(or),Ee.test(t)?or++:(t=i,0===hr&&br(Kt)),t}function Ai(e,t,r,i,s){const n={type:"binary-expression",location:s,operator:e,left:t,right:r};return void 0!==i&&(n.escape=i),n}function Ii(e,...t){return{type:"expression-list",location:e,value:t}}function Di(e,t){let r=e;for(const{op:e,expr:i,location:{end:s}}of t)r=Ai(e,r,i,void 0,{...r.location,end:s});return r}cr=o();const Fi=cr!==i&&or===e.length;function Li(){throw cr!==i&&or<e.length&&br({type:"end"}),function(e,r,i){return new t(t.buildMessage(e,r),e,r,i)}(dr,ur<e.length?function(t=or){const r=e.codePointAt(t);return void 0===r?"":String.fromCodePoint(r)}(ur):null,ur<e.length?_r(ur,ur+1):_r(ur,ur))}return r.peg$library?{peg$result:cr,peg$currPos:or,peg$FAILED:i,peg$maxFailExpected:dr,peg$maxFailPos:ur,peg$success:Fi,peg$throw:Fi?void 0:Li}:Fi?cr:void Li()}(e)}},e.visitAll=function e(t,r){if(null!=t)switch(r(t),t.type){case"when-clause":e(t.operand,r),e(t.value,r);break;case"case-expression":for(const i of t.clauses)e(i,r);"simple"===t.format&&e(t.operand,r),null!==t.else&&e(t.else,r);break;case"expression-list":for(const i of t.value)e(i,r);break;case"unary-expression":e(t.expr,r);break;case"binary-expression":e(t.left,r),e(t.right,r);break;case"function":e(t.args,r);break;case"interval":e(t.value,r),e(t.qualifier,r);break;case"interval-qualifier":e(t.start,r),e(t.end,r)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/geometryUtils":function(){define(["exports","../featureConversionUtils","../OptimizedGeometry"],(function(e,t,r){"use strict";const i=new r,s=new r,n=new r,o={esriGeometryPoint:t.convertToPoint,esriGeometryPolyline:t.convertToPolyline,esriGeometryPolygon:t.convertToPolygon,esriGeometryMultipoint:t.convertToMultipoint},a="_geVersion",l=(e,t)=>e===a?void 0:t;e.cleanFromGeometryEngine=function(e){return e&&a in e?JSON.parse(JSON.stringify(e,l)):e},e.getGeometry=function(e,r,a,l,c,u,d=r,h=a){const p=r&&d,m=a&&h,f=null!=l?"coords"in l?l:l.geometry:null;if(null==f)return null;if(c){let i=t.generalizeOptimizedGeometry(s,f,r,a,e,c,d,h);return u&&(i=t.quantizeOptimizedGeometry(n,i,p,m,e,u)),o[e]?.(i,p,m)??null}if(u){const i=t.quantizeOptimizedGeometry(n,f,r,a,e,u,d,h);return o[e]?.(i,p,m)??null}return t.removeZMValues(i,f,r,a,d,h),o[e]?.(i,p,m)??null},e.transformCentroid=function(e,r,i,s=e.hasZ,o=e.hasM){if(null==r)return null;const a=e.hasZ&&s,l=e.hasM&&o;if(i){const c=t.quantizeOptimizedGeometry(n,r,e.hasZ,e.hasM,"esriGeometryPoint",i,s,o);return t.convertToPoint(c,a,l)}return t.convertToPoint(r,a,l)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/projectionSupport":function(){define(["exports","../../../core/arrayUtils","../../../core/promiseUtils","../../../geometry/projectionUtils","../../../geometry/geometryAdapters/json","../../../geometry/support/spatialReferenceUtils","../../../geometry/support/webMercatorUtils"],(function(e,t,r,i,s,n,o){"use strict";const a=[0,0];function l(e,t){if(!t)return null;if("x"in t){const r={x:0,y:0};return[r.x,r.y]=e(t.x,t.y,a),null!=t.z&&(r.z=t.z),null!=t.m&&(r.m=t.m),r}if("xmin"in t){const r={xmin:0,ymin:0,xmax:0,ymax:0};return[r.xmin,r.ymin]=e(t.xmin,t.ymin,a),[r.xmax,r.ymax]=e(t.xmax,t.ymax,a),t.hasZ&&(r.zmin=t.zmin,r.zmax=t.zmax,r.hasZ=!0),t.hasM&&(r.mmin=t.mmin,r.mmax=t.mmax,r.hasM=!0),r}return"rings"in t?{rings:c(t.rings,e),hasM:t.hasM,hasZ:t.hasZ}:"paths"in t?{paths:c(t.paths,e),hasM:t.hasM,hasZ:t.hasZ}:"points"in t?{points:u(t.points,e),hasM:t.hasM,hasZ:t.hasZ}:null}function c(e,t){const r=[];for(const i of e)r.push(u(i,t));return r}function u(e,t){const r=[];for(const i of e){const e=t(i[0],i[1],[0,0]);r.push(e),i.length>2&&e.push(i[2]),i.length>3&&e.push(i[3])}return r}const d=l.bind(null,o.lngLatToXY),h=l.bind(null,o.xyToLngLat),p=new class{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(e,t,i,s){if(!e?.length||!t||!i||n.equals(t,i))return e;const o={geometries:e,inSpatialReference:t,outSpatialReference:i,geographicTransformation:s,resolve:r.createResolver()};return this._jobs.push(o),this._timer??=setTimeout(this._process,10),o.resolve.promise}_process(){this._timer=null;const e=this._jobs.shift();if(!e)return;const{geometries:t,inSpatialReference:r,outSpatialReference:a,resolve:l,geographicTransformation:c}=e;o.canProject(r,a)?n.isWebMercator(a)?l(t.map(d)):l(t.map(h)):l(i.projectMany(s.jsonAdapter,t,r,a,c,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}};e.checkProjectionSupport=async function(e,r){if(!e||!r)return;const s=Array.isArray(e)?e.map((e=>null!=e.geometry?e.geometry.spatialReference:null)).filter(t.isSome):[e];await i.initializeProjection(s.map((e=>({source:e,dest:r}))))},e.project=function(e,t,r,a){if(!e)return null;if(r||(r=t,t=e.spatialReference),!n.isValid(t)||!n.isValid(r)||n.equals(t,r))return e;if(o.canProject(t,r)){const t=n.isWebMercator(r)?d(e):h(e);return t.spatialReference=r,t}return i.projectMany(s.jsonAdapter,[e],t,r,null,a)[0]},e.projectMany=function(e,t,r,i){return p.push(e,t,r,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/geometryAdapters/json":function(){define(["exports"],(function(e){"use strict";const t={convertToGEGeometry:function(e,t){return null==t?null:e.convertJSONToGeometry(t)},exportPoint:function(e,t,i){const s=new r(e.getPointX(t),e.getPointY(t),i),n=e.hasZ(t),o=e.hasM(t);return n&&(s.z=e.getPointZ(t)),o&&(s.m=e.getPointM(t)),s},exportPolygon:function(e,t,r){return new i(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportPolyline:function(e,t,r){return new s(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportMultipoint:function(e,t,r){return new n(e.exportPoints(t),r,e.hasZ(t),e.hasM(t))},exportExtent:function(e,t,r){const i=e.hasZ(t),s=e.hasM(t),n=new o(e.getXMin(t),e.getYMin(t),e.getXMax(t),e.getYMax(t),r);if(i){const r=e.getZExtent(t);n.zmin=r.vmin,n.zmax=r.vmax}if(s){const r=e.getMExtent(t);n.mmin=r.vmin,n.mmax=r.vmax}return n}};class r{constructor(e,t,r){this.x=e,this.y=t,this.spatialReference=r,this.z=void 0,this.m=void 0}}class i{constructor(e,t,r,i){this.rings=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,r&&(this.hasZ=r),i&&(this.hasM=i)}}class s{constructor(e,t,r,i){this.paths=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,r&&(this.hasZ=r),i&&(this.hasM=i)}}class n{constructor(e,t,r,i){this.points=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,r&&(this.hasZ=r),i&&(this.hasM=i)}}class o{constructor(e,t,r,i,s){this.xmin=e,this.ymin=t,this.xmax=r,this.ymax=i,this.spatialReference=s,this.zmin=void 0,this.zmax=void 0,this.mmin=void 0,this.mmax=void 0}}e.jsonAdapter=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/QueryEngineCache":function(){define(["exports","../../../core/has"],(function(e,t){"use strict";let r=0;class i{constructor(e){this.items=e,this.time=performance.now(),this.id=r++}}e.QueryEngineCache=class{constructor(){this._storage=new Map,this._purgeInterval=5,this._sweep=()=>{if(this._timer=void 0,!this._storage)return;const e=1e3*this._purgeInterval,t=performance.now()-e;for(const[r,i]of this._storage){if(!(i.time<t))return void(this._storage.size>0&&(this._timer=setTimeout(this._sweep,e)));this._storage.delete(r)}}}destroy(){this._storage?.clear(),this._storage=null,clearTimeout(this._timer)}put(e,t){this._storage?.set(e,new i(t)),this._scheduleSweep()}get(e){const t=this._storage?.get(e);if(t)return this._storage?.delete(e),t.time=performance.now(),this._storage?.set(e,t),t.items}clear(){this._storage?.clear()}_scheduleSweep(){this._storage&&(this._timer??=setTimeout(this._sweep,1e3*this._purgeInterval))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/QueryEngineResult":function(){define(["require","exports","../../../core/lang","../../../geometry/support/centroid","../../../geometry/support/extentUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","./AttributesBuilder","./geometryUtils","./projectionSupport","./queryUtils","./SnappingCandidate","../../support/fieldUtils","../../../rest/support/AutoIntervalBinParameters","../../../rest/support/DateBinParameters","../../../rest/support/DateBinUtils","../../../rest/support/FixedBoundariesBinParameters","../../../rest/support/FixedIntervalBinParameters","../../../statistics/utils","../../../time/constants","../../../chunks/datetime"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v){"use strict";const S="bin";function w(e,t,r,i){const s=i.x-r.x,n=i.y-r.y,o=t.x-r.x,a=t.y-r.y,l=s*s+n*n;if(0===l)return!1;const c=o*s+a*n,u=Math.min(1,Math.max(0,c/l));return e.x=r.x+s*u,e.y=r.y+n*u,!0}function x(e,t){return e?t?4:3:t?3:2}class T{constructor(e,t){this.coords=e,this.coordsIndex=t}get x(){return this.coords[this.coordsIndex]}get y(){return this.coords[this.coordsIndex+1]}get z(){return this.coords[this.coordsIndex+2]}}const C=[1];t.QueryEngineResult=class{constructor(e,t,r){this.items=e,this.query=t,this.geometryType=r.geometryType,this.hasM=r.hasM,this.hasZ=r.hasZ,this.fieldsIndex=r.fieldsIndex,this.objectIdField=r.objectIdField,this.spatialReference=r.spatialReference,this.featureAdapter=r.featureAdapter}get size(){return this.items.length}createQueryResponseForCount(){const e=new a(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return e.countDistinctValues(this.items);const{groupByFieldsForStatistics:t,having:r,outStatistics:i}=this.query,s=t?.length;if(!s)return 1;const n=new Map,o=new Map,l=new Set;for(const s of i){const{statisticType:i}=s,a="exceedslimit"!==i?s.onStatisticField:void 0;if(!o.has(a)){const r=[];for(const i of t){const t=this._getAttributeValues(e,i,this.items,n);r.push(t)}o.set(a,this._calculateUniqueValues(r,this.items,e.returnDistinctValues))}const c=o.get(a);for(const t in c){const{data:i,items:s}=c[t],n=i.join(",");r&&!e.validateItems(s,r)||l.add(n)}}return l.size}async createQueryResponse(){let e;if(e=this.query.outStatistics?this.query.outStatistics.some((e=>"exceedslimit"===e.statisticType))?this._createExceedsLimitQueryResponse():await this._createStatisticsQueryResponse(this.query,this.items):this._createFeatureQueryResponse(this.query),this.query.returnQueryGeometry){const t=this.query.geometry;o.isValid(this.query.outSR)&&!o.equals(t.spatialReference,this.query.outSR)?e.queryGeometry=l.cleanFromGeometryEngine({spatialReference:this.query.outSR,...c.project(t,t.spatialReference,this.query.outSR)}):e.queryGeometry=l.cleanFromGeometryEngine({spatialReference:this.query.outSR,...t})}return e}createSnappingResponse(e,t,r){const i=this.featureAdapter,s=x(this.hasZ,this.hasM),{point:n,mode:o}=e,a="number"==typeof e.distance?e.distance:e.distance.x,l="number"==typeof e.distance?e.distance:e.distance.y,c={candidates:[]},u="esriGeometryPolygon"===this.geometryType,h="esriGeometryPolyline"===this.geometryType||"esriGeometryPoint"===this.geometryType,p=this._getPointCreator(o,t,this.spatialReference,r),m=new T(null,0),f=new T(null,0),g={x:0,y:0,z:0};for(const t of this.items){const r=i.getGeometry(t);if(null==r)continue;const{coords:o}=r,y=r.isPoint?C:r.lengths;if(m.coords=o,f.coords=o,e.returnEdge){let e=0;for(let r=0;r<y.length;r++){const o=y[r],h=e;for(let r=0;r<o;r++,e+=s){if(!u&&r===o-1)continue;const y=m;y.coordsIndex=e;const _=f;_.coordsIndex=r===o-1?h:e+s;const b=g;if(!w(g,n,y,_))continue;const v=(n.x-b.x)/a,S=(n.y-b.y)/l,x=v*v+S*S;x<=1&&c.candidates.push(d.makeEdgeCandidate(i.getObjectId(t),p(b),Math.sqrt(x),p(y),p(_)))}}}if("all"===e.vertexMode){let e=0;for(let r=0;r<y.length;r++){const o=y[r],h=e,g=f;g.coordsIndex=h;for(let r=0;r<o;r++,e+=s){const s=m;if(s.coordsIndex=e,u&&r===o-1&&s.x===g.x&&s.y===g.y)continue;const h=(n.x-s.x)/a,f=(n.y-s.y)/l,y=h*h+f*f;y<=1&&c.candidates.push(d.makeVertexCandidate(i.getObjectId(t),p(s),Math.sqrt(y)))}}}else if(h&&"ends"===e.vertexMode){let e=0;const r=[];for(let t=0;t<y.length;t++){r.push(e);const i=y[t];e+=i*s,!u&&i>1&&r.push(e-s)}for(const e of r){const r=m;r.coordsIndex=e;const s=(n.x-r.x)/a,o=(n.y-r.y)/l,u=s*s+o*o;u<=1&&c.candidates.push(d.makeVertexCandidate(i.getObjectId(t),p(r),Math.sqrt(u)))}}}return c.candidates.sort(((e,t)=>e.distance-t.distance)),c}_getPointCreator(e,t,r,i){const s=null==i||o.equals(r,i)?e=>e:e=>c.project(e,r,i),{hasZ:n}=this;return"3d"===e?n&&t?({x:e,y:t,z:r})=>s({x:e,y:t,z:r}):({x:e,y:t})=>s({x:e,y:t,z:0}):({x:e,y:t})=>s({x:e,y:t})}async createSummaryStatisticsResponse(e){const{field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,minValue:o,maxValue:a,scale:l,timeZone:c,outStatisticTypes:u}=e,d=this.fieldsIndex.get(t),p=h.isDateField(d)||h.isDateOnlyField(d)||h.isTimestampOffsetField(d),m=await this._getDataValues({field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,scale:l,timeZone:c},this.items),f=_.isNullCountSupported({normalizationType:s,normalizationField:i,minValue:o,maxValue:a}),g={value:.5,fieldType:d?.type},y=h.isStringField(d)?_.calculateStringStatistics({values:m,supportsNullCount:f,percentileParams:g,outStatisticTypes:u}):_.calculateStatistics({values:m,minValue:o,maxValue:a,useSampleStdDev:!s,supportsNullCount:f,percentileParams:g,outStatisticTypes:u});return _.processSummaryStatisticsResult(y,u,p)}async createUniqueValuesResponse(e){const{field:t,valueExpression:r,domains:i,returnAllCodedValues:s,scale:n,timeZone:o}=e,a=await this._getDataValues({field:t,field2:e.field2,field3:e.field3,fieldDelimiter:e.fieldDelimiter,valueExpression:r,scale:n,timeZone:o},this.items,!1),l=_.calculateUniqueValuesCount(a);return _.createUVResult(l,i,s,e.fieldDelimiter)}async createClassBreaksResponse(e){const{field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,classificationMethod:o,standardDeviationInterval:a,minValue:l,maxValue:c,numClasses:u,scale:d,timeZone:h}=e,p=await this._getDataValues({field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,scale:d,timeZone:h},this.items),m=_.calculateClassBreaks(p,{field:t,normalizationField:i,normalizationType:s,normalizationTotal:n,classificationMethod:o,standardDeviationInterval:a,minValue:l,maxValue:c,numClasses:u});return _.resolveCBResult(m,o)}async createHistogramResponse(e){const{field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,classificationMethod:o,standardDeviationInterval:a,minValue:l,maxValue:c,numBins:u,scale:d,timeZone:h}=e,p=await this._getDataValues({field:t,valueExpression:r,normalizationField:i,normalizationType:s,normalizationTotal:n,scale:d,timeZone:h},this.items);return _.calculateHistogram(p,{field:t,normalizationField:i,normalizationType:s,normalizationTotal:n,classificationMethod:o,standardDeviationInterval:a,minValue:l,maxValue:c,numBins:u})}_sortFeatures(e,t,r){if(e.length>1&&t?.length)for(const i of t.slice().reverse()){const t=i.split(" "),s=t[0],n=this.fieldsIndex.get(s),o=!!t[1]&&"desc"===t[1].toLowerCase(),a=_.getAttributeComparator(n?.type,o);e.sort(((e,t)=>{const i=r(e,s,n),o=r(t,s,n);return a(i,o)}))}}_createFeatureQueryResponse(e){const{items:t,geometryType:r,hasM:i,hasZ:s,objectIdField:o,spatialReference:a}=this,{outFields:c,outSR:u,quantizationParameters:d,resultRecordCount:h,resultOffset:p,returnZ:m,returnM:f}=e,g=null!=h&&t.length>(p||0)+h,y=c&&(c.includes("*")?[...this.fieldsIndex.fields]:c.map((e=>this.fieldsIndex.get(e))));return{exceededTransferLimit:g,features:this._createFeatures(e,t),fields:y,geometryType:r,hasM:i&&f,hasZ:s&&m,objectIdFieldName:o,spatialReference:l.cleanFromGeometryEngine(u||a),transform:d&&n.toQuantizationTransform(d)||null}}_createFeatures(e,t){const r=new a(e,this.featureAdapter,this.fieldsIndex),{hasM:i,hasZ:s}=this,{orderByFields:o,quantizationParameters:c,returnGeometry:u,returnCentroid:d,maxAllowableOffset:h,resultOffset:p,resultRecordCount:m,returnZ:f=!1,returnM:g=!1}=e,y=s&&f,_=i&&g;let b=[],v=0;const S=[...t];if(this._sortFeatures(S,o,((e,t,i)=>r.getFieldValue(e,t,i))),this.geometryType&&(u||d)){const e=n.toQuantizationTransform(c)??void 0,t="esriGeometryPolygon"===this.geometryType||"esriGeometryPolyline"===this.geometryType;if(u&&!d)for(const i of S){const s=this.featureAdapter.getGeometry(i),n={attributes:r.getAttributes(i),geometry:l.getGeometry(this.geometryType,this.hasZ,this.hasM,s,h,e,y,_),metadata:this.featureAdapter.getMetadata?.(i)};t&&s&&!n.geometry&&(n.centroid=l.transformCentroid(this,this.featureAdapter.getCentroid(i,this),e)),b[v++]=n}else if(!u&&d)for(const t of S)b[v++]={attributes:r.getAttributes(t),centroid:l.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e)};else for(const t of S)b[v++]={attributes:r.getAttributes(t),centroid:l.transformCentroid(this,this.featureAdapter.getCentroid(t,this),e),geometry:l.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),h,e,y,_),metadata:this.featureAdapter.getMetadata?.(t)}}else for(const e of S){const t=r.getAttributes(e);t&&(b[v++]={attributes:t})}const w=p||0;if(null!=m){const e=w+m;b=b.slice(w,Math.min(b.length,e))}return b}_createExceedsLimitQueryResponse(){let e=!1,t=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY;for(const e of this.query.outStatistics??[])if("exceedslimit"===e.statisticType){t=null!=e.maxPointCount?e.maxPointCount:Number.POSITIVE_INFINITY,r=null!=e.maxRecordCount?e.maxRecordCount:Number.POSITIVE_INFINITY,i=null!=e.maxVertexCount?e.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)e=this.items.length>t;else if(this.items.length>r)e=!0;else{const t=x(this.hasZ,this.hasM),r=this.featureAdapter;e=this.items.reduce(((e,t)=>{const i=r.getGeometry(t);return e+(null!=i&&i.coords.length||0)}),0)/t>i}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(e)}}]}}async _createStatisticsQueryResponse(e,t,r={attributes:{}}){const i=[],s=new Map,n=new Map,o=new Map,l=new Map,c=new a(e,this.featureAdapter,this.fieldsIndex),u=e.outStatistics,{groupByFieldsForStatistics:d,having:p,orderByFields:m,resultRecordCount:f}=e,g=d?.length,y=!!g,_=y?d[0]:null,b=y&&!this.fieldsIndex.get(_);for(const e of u??[]){const{outStatisticFieldName:a,statisticType:u}=e,m=e,f="exceedslimit"!==u?e.onStatisticField:void 0,v="percentile_disc"===u||"percentile_cont"===u,S="EnvelopeAggregate"===u||"CentroidAggregate"===u||"ConvexHullAggregate"===u,w=y&&1===g&&(f===_||b)&&"count"===u;if(y){if(!o.has(f)){const e=[];for(const r of d){const i=this._getAttributeValues(c,r,t,s);e.push(i)}o.set(f,this._calculateUniqueValues(e,t,!S&&c.returnDistinctValues))}const e=o.get(f);if(!e)continue;const r=Object.keys(e);for(const i of r){const{count:r,data:n,items:o,itemPositions:u}=e[i],h=n.join(",");if(!p||c.validateItems(o,p)){const e=l.get(h)||{attributes:{}};if(S){e.aggregateGeometries||(e.aggregateGeometries={});const{aggregateGeometries:t,outStatisticFieldName:r}=await this._getAggregateGeometry(m,o);e.aggregateGeometries[r]=t}else{let i=null;if(w)i=r;else{const e=this._getAttributeValues(c,f,t,s),r=u.map((t=>e[t]));i=v&&"statisticParameters"in m?this._getPercentileValue(m,r):this._getStatisticValue(m,r,null,c.returnDistinctValues)}e.attributes[a]=i}let i=0;d.forEach(((t,r)=>e.attributes[this.fieldsIndex.get(t)?t:"EXPR_"+ ++i]=n[r])),l.set(h,e)}}}else if(S){r.aggregateGeometries||(r.aggregateGeometries={});const{aggregateGeometries:e,outStatisticFieldName:i}=await this._getAggregateGeometry(m,t);r.aggregateGeometries[i]=e}else{const e=this._getAttributeValues(c,f,t,s);r.attributes[a]=v&&"statisticParameters"in m?this._getPercentileValue(m,e):this._getStatisticValue(m,e,n,c.returnDistinctValues)}const x="min"!==u&&"max"!==u||!h.isStringField(this.fieldsIndex.get(f))&&!this._isAnyDateField(f)?null:this.fieldsIndex.get(f)?.type;i.push({name:a,alias:a,type:x||"esriFieldTypeDouble"})}const v=y?Array.from(l.values()):[r];return this._sortFeatures(v,m,((e,t)=>e.attributes[t])),f&&(v.length=Math.min(f,v.length)),{fields:i,features:v}}_isAnyDateField(e){const t=this.fieldsIndex.get(e);return h.isDateField(t)||h.isDateOnlyField(t)||h.isTimestampOffsetField(t)||h.isTimeOnlyField(t)}async _getAggregateGeometry(t,r){const{convexHull:n,union:o}=await new Promise(((t,r)=>e(["../../../geometry/geometryEngineJSON"],t,r))),{statisticType:a,outStatisticFieldName:c}=t,{featureAdapter:u,spatialReference:d,geometryType:h,hasZ:p,hasM:m}=this,f=r.map((e=>l.getGeometry(h,p,m,u.getGeometry(e)))),g=n(d,f,!0)[0],y={aggregateGeometries:null,outStatisticFieldName:null};if("EnvelopeAggregate"===a){const e=g?s.getPolygonExtent(g):s.getGeometryExtent(o(d,f));y.aggregateGeometries={...e,spatialReference:d},y.outStatisticFieldName=c||"extent"}else if("CentroidAggregate"===a){const e=g?i.polygonCentroid(g):i.extentCentroid(s.getGeometryExtent(o(d,f)));y.aggregateGeometries={x:e[0],y:e[1],spatialReference:d},y.outStatisticFieldName=c||"centroid"}else"ConvexHullAggregate"===a&&(y.aggregateGeometries=g,y.outStatisticFieldName=c||"convexHull");return y}_getStatisticValue(e,t,r,i){const{onStatisticField:s,statisticType:n}=e;let o=null;return o=r?.has(s)?r.get(s):h.isStringField(this.fieldsIndex.get(s))||this._isAnyDateField(s)?_.calculateStringStatistics({values:t,returnDistinct:i}):_.calculateStatistics({values:i?[...new Set(t)]:t,minValue:null,maxValue:null,useSampleStdDev:!0}),r&&r.set(s,o),o["var"===n?"variance":n]}_getPercentileValue(e,t){const{onStatisticField:r,statisticParameters:i,statisticType:s}=e,{value:n,orderBy:o}=i,a=this.fieldsIndex.get(r),l={value:n,orderBy:o,fieldType:a?.type,isDiscrete:"percentile_disc"===s};return _.calculatePercentile(t,l)}_getAttributeValues(e,t,r,i){if(i.has(t))return i.get(t);const s=this.fieldsIndex.get(t),n=r.map((r=>e.getFieldValue(r,t,s)));return i.set(t,n),n}_calculateUniqueValues(e,t,r){const i={},s=t.length;for(let n=0;n<s;n++){const s=t[n],o=[];for(const t of e)o.push(t[n]);const a=o.join(",");null==i[a]?i[a]={count:1,data:o,items:[s],itemPositions:[n]}:(r||i[a].count++,i[a].items.push(s),i[a].itemPositions.push(n))}return i}async _getDataValues(e,t,i=!0){const s=new a(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:n,scale:o,timeZone:l}=e;return n?s.getExpressionValues(t,n,{viewingMode:"map",scale:o,spatialReference:this.query.outSR||this.spatialReference},{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM},l):s.getDataValues(t,r.clone(e),i)}async _calculateHistogramBins(e,t,r){if(null==t.min&&null==t.max)return[];const i=t.intervals,s=t.min??0,n=t.max??0,o=i.map((([e,t])=>({minValue:e,maxValue:t,count:0,items:[]})));for(let t=0;t<e.length;t++){const a=e[t],l=r[t];if(null!=a&&a>=s&&a<=n){const e=_.binIndex(i,a);e>-1&&(o[e].count++,o[e].items.push(l))}}return o}async createQueryBinsResponse(e){const t=e.bin?.splitBy;if(!t)return this._createBinsResponse(e);const{value:r,outAlias:i,valueType:s}=t,n=[],o=[{name:i??r,alias:i??r,type:s??"esriFieldTypeString"},{name:S,alias:S,type:"esriFieldTypeInteger"}],l=new a(e,this.featureAdapter,this.fieldsIndex),c=new Map,u=[...this.items];this._sortFeatures(u,[r],((e,t,r)=>l.getFieldValue(e,t,r)));const d=this._getAttributeValues(l,r,u,c),h=this._calculateUniqueValues([d],u,l.returnDistinctValues);for(const t in h){const{items:s}=h[t],a=await this._createBinsResponse(e,s);if(n.push(...a.features.map((e=>({...e,attributes:{...e.attributes,[i??r]:t}})))),a.fields)for(const e of a.fields)o.some((t=>t.name===e.name))||o.push(e)}return{fields:o,features:n}}async _createBinsResponse(e,t){const r=e.bin;switch(t=t??this.items,r.type){case"autoIntervalBin":return this._createAutoIntervalBinsResponse(p.fromJSON(r),e,t);case"dateBin":return this._createDateBinsResponse(m.fromJSON(r),e,t);case"fixedBoundariesBin":return this._createFixedBoundariesBinsResponse(g.fromJSON(r),e,t);case"fixedIntervalBin":return this._createFixedIntervalBinsResponse(y.fromJSON(r),e,t)}}async _createAutoIntervalBinsResponse(e,t,r){const{field:i,normalizationField:s,numBins:n,normalizationType:o,normalizationTotal:a,start:l,end:c}=e,d=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},r),h=_.getBinParams(d,{field:i,normalizationField:s,normalizationType:o,normalizationTotal:a,numBins:n,minValue:u.getDateInNumber(l,!1),maxValue:u.getDateInNumber(c,!1)}),p=await this._calculateHistogramBins(d,h,r);return this._createFeaturesFromHistogramBins(p,t)}async _createDateBinsResponse(e,t,r){const{field:i,interval:s,start:n,end:o,snapToData:a,returnFullIntervalBin:l}=e,c=s.unit,d=await this._getDataValues({field:e.field,timeZone:t.outTimeReference?.ianaTimeZone},r),p=h.isTimeOnlyField(this.fieldsIndex.get(i)),m=f.unitsDict.toJSON(c),g=d.filter(Boolean).sort(((e,t)=>e-t)),y=null!=n?u.getDateInNumber(n,p):g[0],_=null!=o?u.getDateInNumber(o,p):g[g.length-1],S={zone:t.outTimeReference?.ianaTimeZone??b.utc},w=v.DateTime.fromMillis(y,S),x=v.DateTime.fromMillis(_,S),T=[];if("last"===a){let e=x;for(;e>w;){const t=e.minus({[m]:s.value});if(t<w){T.unshift([l?t.toMillis():w.toMillis(),e.toMillis()]);break}T.unshift([t.toMillis(),e.toMillis()]),e=t}}else{let e="first"===a?w:w.startOf(m);for(;e<=x;){const t=e.plus({[m]:s.value});if(t>x){T.push([e.toMillis(),l?t.toMillis():x.toMillis()]);break}T.push([e.toMillis(),t.toMillis()]),e=t}}const C=await this._calculateHistogramBins(d,{intervals:T,min:y,max:_},r);return this._createFeaturesFromHistogramBins(C,t)}async _createFixedBoundariesBinsResponse(e,t,r){const{field:i}=e,s=await this._getDataValues({field:i,timeZone:t.outTimeReference?.ianaTimeZone},r),n=h.isTimeOnlyField(this.fieldsIndex.get(i)),o=e.boundaries.map((e=>u.getDateInNumber(e,n))).sort(((e,t)=>e-t)),a=[];for(let e=0;e<o.length-1;e++)a.push([o[e],o[e+1]]);const l={intervals:a,min:o.at(0),max:o.at(-1)},c=await this._calculateHistogramBins(s,l,r);return this._createFeaturesFromHistogramBins(c,t)}async _createFixedIntervalBinsResponse(e,t,r){const{field:i,interval:s,start:n,end:o}=e,a=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},r),l=h.isTimeOnlyField(this.fieldsIndex.get(i)),c=_.getBinParams(a,{field:i,classificationMethod:"defined-interval",definedInterval:s,minValue:u.getDateInNumber(n,l),maxValue:u.getDateInNumber(o,l)},!0),d=await this._calculateHistogramBins(a,c,r);return this._createFeaturesFromHistogramBins(d,t)}async _createFeaturesFromHistogramBins(e,t){const{upperBoundaryAlias:r,lowerBoundaryAlias:i}=t,s=i||"lowerBoundary",n=r||"upperBoundary",o=[],a=[{name:s,alias:s,type:"esriFieldTypeDouble"},{name:n,alias:n,type:"esriFieldTypeDouble"}],l=t.bin?.stackBy?.value,c=t.bin?.stackBy?.outAlias;l&&a.push({name:S,alias:S,type:"esriFieldTypeInteger"},{name:c??l,alias:c??l,type:"esriFieldTypeString"});let u=0;const d="dateBin"===t.bin.type,h=t.outTimeReference?.ianaTimeZone;for(const r of e){const{minValue:e,maxValue:i,items:p}=r,m={attributes:{}};let f;if(m.attributes[s]=d&&h&&null!=e?v.DateTime.fromMillis(e,{zone:h}).toISO():e,m.attributes[n]=d&&h&&null!=i?v.DateTime.fromMillis(i,{zone:h}).toISO():i,l?(f=await this._createStatisticsQueryResponse({...t,groupByFieldsForStatistics:[l],orderByFields:[l]},p),m.attributes[S]=++u,"flat"===t.bin.jsonStyle?o.push(...f.features.map((({attributes:{EXPR_1:e,...t},...r})=>({...r,attributes:c??e?{...t,[c??e]:e,...m.attributes}:{...t,...m.attributes}})))):(m.stackedAttributes=f.features.map((({attributes:{EXPR_1:e,...t}})=>c??e?{...t,[c??e]:e}:t)),o.push(m))):(t.bin?.splitBy&&(m.attributes[S]=++u),f=await this._createStatisticsQueryResponse(t,p,m),o.push(m)),f.fields)for(const e of f.fields)a.some((t=>t.name===e.name))||a.push(e)}return"desc"===t.binOrder&&o.reverse(),{fields:a,features:o}}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/AttributesBuilder":function(){define(["./attributeSupport","./geometryUtils","../../support/fieldUtils","../../../smartMapping/statistics/support/utils","../../../statistics/utils","../../../support/loadArcade"],(function(e,t,r,i,s,n){"use strict";return class{constructor(t,r,i){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=t.returnDistinctValues??!1,this.fieldsIndex=i,this.featureAdapter=r;const s=t.outFields;if(s&&!s.includes("*")){this.outFields=s;let t=0;for(const r of s){const s=e.getExpressionFromFieldName(r),n=this.fieldsIndex.get(s),o=n?null:e.getWhereClause(s,i),a=n?n.name:e.getAliasFromFieldName(r)||"FIELD_EXP_"+t++;this._fieldDataCache.set(r,{alias:a,clause:o})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach((e=>this.getAttributes(e))),this._returnDistinctMap.size):e.length}getAttributes(e){const t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(t,r,i){const s=i?i.name:r;let n=null;return this._fieldDataCache.has(s)?n=this._fieldDataCache.get(s)?.clause:i||(n=e.getWhereClause(r,this.fieldsIndex),this._fieldDataCache.set(s,{alias:s,clause:n})),i?this.featureAdapter.getAttribute(t,s):n?.calculateValue(t,this.featureAdapter)}getDataValues(e,t,n=!0){const o=t.normalizationType,a=t.normalizationTotal,l=this.fieldsIndex.get(t.field),c=r.isDateOnlyField(l)||r.isTimestampOffsetField(l),u=r.isTimeOnlyField(l);return e.map((e=>{let r=t.field&&this.getFieldValue(e,t.field,this.fieldsIndex.get(t.field));if(t.field2?(r=`${s.processNullValue(r)}${t.fieldDelimiter}${s.processNullValue(this.getFieldValue(e,t.field2,this.fieldsIndex.get(t.field2)))}`,t.field3&&(r=`${r}${t.fieldDelimiter}${s.processNullValue(this.getFieldValue(e,t.field3,this.fieldsIndex.get(t.field3)))}`)):"string"==typeof r&&n&&(c?r=r?new Date(r).getTime():null:u&&(r=r?i.timeOnlyToMilliseconds(r):null)),o&&Number.isFinite(r)){const i="field"===o&&t.normalizationField?this.getFieldValue(e,t.normalizationField,this.fieldsIndex.get(t.normalizationField)):null;r=s.getNormalizedValue(r,o,i,a)}return r}))}async getExpressionValues(e,r,i,s,o){const{arcadeUtils:a}=await n.loadArcade(),l=a.hasGeometryOperations(r);l&&await a.enableGeometryOperations();const c=a.createFunction(r),u=a.getViewInfo(i),d={fields:this.fieldsIndex.fields};return e.map((e=>{const r={attributes:this.featureAdapter.getAttributes(e),layer:d,geometry:l?{...t.getGeometry(s.geometryType,s.hasZ,s.hasM,this.featureAdapter.getGeometry(e)),spatialReference:i?.spatialReference}:null},n=a.createExecContext(r,u,o);return a.executeFunction(c,n)}))}validateItem(t,r){return this._fieldDataCache.has(r)||this._fieldDataCache.set(r,{alias:r,clause:e.getWhereClause(r,this.fieldsIndex)}),this._fieldDataCache.get(r)?.clause?.testFeature(t,this.featureAdapter)??!1}validateItems(t,r){return this._fieldDataCache.has(r)||this._fieldDataCache.set(r,{alias:r,clause:e.getWhereClause(r,this.fieldsIndex)}),this._fieldDataCache.get(r)?.clause?.testSet(t,this.featureAdapter)??!1}_processAttributesForOutFields(e){const t=this.outFields;if(!t?.length)return this.featureAdapter.getAttributes(e);const r={};for(const i of t){const{alias:t,clause:s}=this._fieldDataCache.get(i);r[t]=s?s.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,t)}return r}_processAttributesForDistinctValues(e){if(null==e||!this.returnDistinctValues)return e;const t=this.outFields,r=[];if(t)for(const i of t){const{alias:t}=this._fieldDataCache.get(i);r.push(e[t])}else for(const t in e)r.push(e[t]);const i=`${(t||["*"]).join(",")}=${r.join(",")}`;let s=this._returnDistinctMap.get(i)||0;return this._returnDistinctMap.set(i,++s),s>1?null:e}}}))},"esri/smartMapping/statistics/support/utils":function(){define(["exports","../../../core/Error","../../../core/screenUtils","../../../core/timeUtils","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../../../layers/support/fieldUtils","../../../renderers/support/heatmapUtils","../../support/utils","../../../statistics/utils","../../../support/loadArcade"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";let p=null;const m=/^(?<hh>([0-1][0-9])|([2][0-3])):(?<mm>[0-5][0-9])(:(?<ss>[0-5][0-9]))?([.](?<ms>\d+))?$/;function f(e){const t=m.exec(e);if(!t)return null;const{hh:r,mm:s,ss:n,ms:o}=t.groups;return Number(r)*i.millisecondsPerTimeUnit.hours+Number(s)*i.millisecondsPerTimeUnit.minutes+Number(n)*i.millisecondsPerTimeUnit.seconds+Number(o||0)}function g(e,t){let r=null!=e?e:"";return null!=t&&t&&(r=r?"("+r+") AND ("+t+")":t),r}e.calculateHeatmapStats=function(e,t=18,i,s,n){const o=new Float64Array(s*n);t=Math.round(r.pt2px(t));let a=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY;const u=c.createValueFunction(i);for(const{geometry:r,attributes:i}of e){const{x:e,y:d}=r,h=Math.max(0,e-t),p=Math.max(0,d-t),m=Math.min(n,d+t),f=Math.min(s,e+t),g=+u(i);for(let r=p;r<m;r++)for(let i=h;i<f;i++){const n=r*s+i,u=c.evaluateDensityKernel(i-e,r-d,t)*g,h=o[n]+=u;a=Math.min(a,h),l=Math.max(l,h)}}return{min:a,max:l}},e.getDataValues=async function(e,t,r=!0){if(!t)return[];const{field:i,field2:s,field3:o,fieldDelimiter:a,fieldInfos:c,timeZone:m}=e,g=i&&c?.find((e=>e.name.toLowerCase()===i.toLowerCase())),y=!!g&&l.isTimeOnlyField(g),_=!!g&&u.isAnyDateField(g),b=e.valueExpression,v=e.normalizationType,S=e.normalizationField,w=e.normalizationTotal,x=[],T=e.viewInfoParams;let C=null,P=null;if(b){if(!p){const{arcadeUtils:e}=await h.loadArcade();p=e}p.hasGeometryOperations(b)&&await p.enableGeometryOperations(),C=p.createFunction(b),P=T?p.getViewInfo({viewingMode:T.viewingMode,scale:T.scale,spatialReference:new n(T.spatialReference)}):null}const M=e.fieldInfos,R=t[0]&&"declaredClass"in t[0]&&"esri.Graphic"===t[0].declaredClass||!M?null:{fields:M};return t.forEach((e=>{const t=e.attributes;let n;if(b){const t=R?{...e,layer:R}:e,r=p.createExecContext(t,P,m);n=p.executeFunction(C,r)}else t&&(n=t[i],s?(n=`${d.processNullValue(n)}${a}${d.processNullValue(t[s])}`,o&&(n=`${n}${a}${d.processNullValue(t[o])}`)):"string"==typeof n&&r&&(_?n=n?new Date(n).getTime():null:y&&(n=n?f(n):null)));if(v&&"number"==typeof n&&isFinite(n)){const e=t&&parseFloat(t[S]);n=d.getNormalizedValue(n,v,e,w)}x.push(n)})),x},e.getRangeExpr=function(e,t,r){const i=null!=t?e+" >= "+t:"",s=null!=r?e+" <= "+r:"";let n="";return n=i&&s?g(i,s):i||s,n?"("+n+")":""},e.getSQLFilterForNormalization=function(e){const t=e.field,r=e.normalizationType,i=e.normalizationField;let s;return"field"===r?s="(NOT "+i+" = 0)":"log"!==r&&"natural-log"!==r&&"square-root"!==r||(s=`(${t} > 0)`),s},e.getSumOfAttributesExpr=function(e,t,r){const i=[],s=[],n=[],o=[],a=[];e.forEach(((e,t)=>{const l=e.field?"field":"expression",c=e.field||e.valueExpression;e.field?(a.push(c),s.push(`var ${l}${t} = Number($feature["${c}"]);`)):(i.push(`function getValueForExpr${t}() {\n  ${c} \n}`),s.push(`var ${l}${t} = Number(getValueForExpr${t}());`)),r||n.push(`${l}${t} = IIf(${l}${t} < 0, 0, ${l}${t});`),o.push(`${l}${t}`)}));const l=i.length?null:a.reduce(((e,t)=>`${e} + ${t}`));let c=null;return t||r?t?r||l&&(c=`(( ${l} ) >= 0)`):l&&(c=`(( ${l} ) <> 0)`):l&&(c=`(( ${l} ) > 0)`),{valueExpression:[i.length?i.join("\n"):"",s.join("\n"),n.join("\n"),`var total = ${o.join(" + ")};`,"return total;"].filter(Boolean).join("\n\n"),sqlExpression:l,sqlWhere:c}},e.mergeWhereClauses=g,e.quantizeFeatures=function(e,t,r,i){const n=a.isWrappable(r)?a.getInfo(r):null,l=n?Math.round((n.valid[1]-n.valid[0])/t.scale[0]):null;return e.map((e=>{const r=new s(e.geometry);return o.quantizePoint(t,r,r),e.geometry=n?function(e,t,r){return e.x<0?e.x+=t:e.x>r&&(e.x-=t),e}(r,l??0,i[0]):r,e}))},e.timeOnlyToMilliseconds=f,e.verifyBasicFieldValidity=function(e,r,i){const s=function(e){const t=e.layer;return e.fields.filter((e=>!t.getField(e)))}({layer:e,fields:r});if(s.length)return new t(i,"Unknown fields: "+s.join(", ")+". You can only use fields defined in the layer schema");const n=function(e){const t=e.layer;return e.fields.filter((e=>{const r=t.getFieldUsageInfo(e);return!r||!r.supportsStatistics}))}({layer:e,fields:r});return n.length?new t(i,"Unsupported fields: "+n.join(", ")+". You can only use fields that can be fetched i.e. AdapterFieldUsageInfo.supportsStatistics must be true"):void 0},e.verifyFieldType=function(e,r,i,s){let n;return r?r.name!==e.objectIdField&&s.includes(r.type)||(n=new t(i,"'field' should be one of these types: "+s.join(","))):n=new t(i,"'field' is not defined in the layer schema"),n},e.verifyFilterValidity=function(e,r){if(e&&"intersects"!==e.spatialRelationship)return new t(r,"Only 'intersects' spatialRelationship is supported for featureFilter")},e.verifyNumericField=function(e,r,i){let s;return r?r.name!==e.objectIdField&&l.isNumericField(r)||(s=new t(i,"'field' should be one of these numeric types: "+l.numericTypes.join(","))):s=new t(i,"'field' is not defined in the layer schema"),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/smartMapping/support/utils":function(){define(["exports","../../intl/date","../../layers/support/fieldUtils","../../support/basemapUtils","../../support/loadArcade","../../time/constants","../../time/timeZoneUtils"],(function(e,t,r,i,s,n,o){"use strict";const a={light:["streets","gray","topo","terrain","oceans","osm","gray-vector","streets-vector","topo-vector","streets-relief-vector","streets-navigation-vector","topo-3d","navigation-3d","streets-3d","osm-3d","gray-3d"],dark:["satellite","hybrid","dark-gray","dark-gray-vector","streets-night-vector","navigation-dark-3d","streets-dark-3d","dark-gray-3d"]},l={years:365,months:30,days:1,hours:1/24,minutes:1/1440,seconds:1/86400,milliseconds:1/864e5},c=new Set(["integer","small-integer"]);let u=null;function d(e){return String(e).padStart(2,"0")}function h(e,t,r){let i;return"date"===t||"number"===t?("number"===t&&(e=new Date(e)),i=`TIMESTAMP'${r?e.getFullYear():e.getUTCFullYear()}-${d((r?e.getMonth():e.getUTCMonth())+1)}-${d(r?e.getDate():e.getUTCDate())} ${d(r?e.getHours():e.getUTCHours())}:${d(r?e.getMinutes():e.getUTCMinutes())}:${d(r?e.getSeconds():e.getUTCSeconds())}'`):i=e,i}function p(e,t){if(t instanceof Date)return"date";if("number"==typeof t)return"number";if("string"==typeof t){const i=e.getField(t);if("<now>"===t.toLowerCase())return;if(r.isDateField(i))return"field"}}e.castIntegerFieldToFloat=function(e){return`cast(${e} as float)`},e.dateTypes=["date","date-only","timestamp-offset"],e.defaultBasemapGroups=a,e.defaultStatisticTypes={exclude:["median"]},e.fieldDelimiter=",",e.formatAnyDate=function(e,r){const{format:i,timeZoneOptions:s,fieldType:a}=r??{};let l,c;if(s&&({timeZone:l,timeZoneName:c}=o.getTimeZoneFormattingOptions(s.layerTimeZone,s.datesInUnknownTimezone,s.viewTimeZone,t.convertDateFormatToIntlOptions(i||"short-date-short-time"),a)),"string"==typeof e&&isNaN(Date.parse("time-only"===a?`1970-01-01T${e}Z`:e)))return e;switch(a){case"date-only":{const r=t.convertDateFormatToIntlOptions(i||"short-date");return"string"==typeof e?t.formatDateOnly(e,{...r}):t.formatDate(e,{...r,timeZone:n.utc})}case"time-only":{const r=t.convertDateFormatToIntlOptions(i||"short-time");return"string"==typeof e?t.formatTimeOnly(e,r):t.formatDate(e,{...r,timeZone:n.utc})}case"timestamp-offset":{if(!l&&"string"==typeof e&&new Date(e).toISOString()!==e)return e;const r=i||s?t.convertDateFormatToIntlOptions(i||"short-date-short-time"):void 0,n=r?{...r,timeZone:l,timeZoneName:c}:void 0;return"string"==typeof e?t.formatTimestamp(e,n):t.formatDate(e,n)}default:{const r=i||s?t.convertDateFormatToIntlOptions(i||"short-date-short-time"):void 0;return t.formatDate("string"==typeof e?new Date(e):e,r?{...r,timeZone:l,timeZoneName:c}:void 0)}}},e.getBasemapGroup=function(e,t=a){for(const r in t)if(t[r].includes(e))return r},e.getBasemapId=function(e,t,r=!0){let s=null;return e&&("string"==typeof e?t.includes(e)&&(s=e):s=i.getWellKnownBasemapId(e)),r?s||"gray":s},e.getDateDiffSQL=function(e,t,r,i){const{hasQueryEngine:s}=e,n=`(${h(r,p(e,r),s)} - ${h(t,p(e,t),s)})`;let o=l[i],a="/";return o<1&&(o=1/o,a="*"),{sqlExpression:1===o?n:`(${n} ${a} ${o})`,sqlWhere:null}},e.getDateType=p,e.getFieldsList=async function(e){const{field:t,field2:r,field3:i,normalizationField:n,valueExpression:o}=e;let a=[];if(o){if(!u){const{arcadeUtils:e}=await s.loadArcade();u=e}a=u.extractFieldNames(o)}return t&&a.push(t),r&&a.push(r),i&&a.push(i),n&&a.push(n),a},e.getNormalizationType=function(e){let t=e.normalizationType;return t||(e.normalizationField?t="field":null!=e.normalizationTotal&&(t="percent-of-total")),t??void 0},e.isAnyDateField=function(e){return r.isDateField(e)||r.isDateOnlyField(e)||r.isTimestampOffsetField(e)},e.isIntegerField=function(e,t){const r=t&&e.getField(t);return!!r&&c.has(r.type)},e.unitValueInDays=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/statistics/utils":function(){define(["exports","../rest/support/ClassBreaksDefinition","../rest/support/generateRendererUtils"],(function(e,t,r){"use strict";const i=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,s=new Set(["esriFieldTypeDate","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeOID","esriFieldTypeBigInteger"]),n=new Set(["esriFieldTypeTimeOnly","esriFieldTypeDateOnly"]),o=["min","max","avg","stddev","count","sum","variance","nullcount","median"];function a(e){return null==e||"string"==typeof e&&!e?"<Null>":e}function l(e){const t=null!=e.normalizationField||null!=e.normalizationType,r=null!=e.minValue||null!=e.maxValue,i=!!e.sqlExpression&&e.supportsSQLExpression;return!t&&!r&&!i}function c(e){const{values:t,useSampleStdDev:r,supportsNullCount:i,outStatisticTypes:s}=e;let n=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,a=null,l=null,c=null,d=null,h=0;const p=null==e.minValue?-1/0:e.minValue,m=null==e.maxValue?1/0:e.maxValue;for(const e of t)Number.isFinite(e)?e>=p&&e<=m&&(a=null===a?e:a+e,n=Math.min(n,e),o=Math.max(o,e),h++):"string"==typeof e&&h++;if(h&&null!=a){l=a/h;let e=0;for(const r of t)Number.isFinite(r)&&r>=p&&r<=m&&(e+=(r-l)**2);d=r?h>1?e/(h-1):0:h>0?e/h:0,c=Math.sqrt(d)}else n=null,o=null;const f={avg:l,count:h,max:o,min:n,stddev:c,sum:a,variance:d};return i&&(f.nullcount=t.length-h),!e.percentileParams||s?.include?.length&&!s.include.includes("median")||s?.exclude?.length&&s.exclude.includes("median")||(f.median=u(t,e.percentileParams)),f}function u(e,t){const{fieldType:r,value:i,orderBy:s,isDiscrete:n}=t,o=d(r,"desc"===s);if(0===(e=[...e].filter((e=>null!=e)).sort(((e,t)=>o(e,t)))).length)return null;if(i<=0)return e[0];if(i>=1)return e[e.length-1];const a=(e.length-1)*i,l=Math.floor(a),c=l+1,u=a%1,h=e[l],p=e[c];return c>=e.length||n||"string"==typeof h||"string"==typeof p?h:h*(1-u)+p*u}function d(e,t){if(e){if(s.has(e))return w(t);if(n.has(e))return b(t,!1);if("esriFieldTypeTimestampOffset"===e)return function(e){return e?g:f}(t);const r=b(t,!0);if("esriFieldTypeString"===e)return r;if("esriFieldTypeGUID"===e||"esriFieldTypeGlobalID"===e)return(e,t)=>r(x(e),x(t))}const r=t?1:-1,i=w(t),o=b(t,!0),a=m(t);return(e,t)=>"number"==typeof e&&"number"==typeof t?i(e,t):"string"==typeof e&&"string"==typeof t?o(e,t):a(e,t)??r}const h=(e,t)=>null==e?null==t?0:1:null==t?-1:null,p=(e,t)=>null==e?null==t?0:-1:null==t?1:null;function m(e){return e?h:p}const f=(e,t)=>p(e,t)??(e===t?0:new Date(e).getTime()-new Date(t).getTime()),g=(e,t)=>h(e,t)??(e===t?0:new Date(t).getTime()-new Date(e).getTime()),y=(e,t)=>p(e,t)??(e===t?0:e<t?-1:1),_=(e,t)=>h(e,t)??(e===t?0:e<t?1:-1);function b(e,t){if(!t)return e?_:y;const r=m(e);return e?(e,t)=>{const i=r(e,t);return null!=i?i:(e=e.toUpperCase())>(t=t.toUpperCase())?-1:e<t?1:0}:(e,t)=>{const i=r(e,t);return null!=i?i:(e=e.toUpperCase())<(t=t.toUpperCase())?-1:e>t?1:0}}const v=(e,t)=>h(e,t)??t-e,S=(e,t)=>p(e,t)??e-t;function w(e){return e?v:S}function x(e){return e.slice(24,36)+e.slice(19,23)+e.slice(16,18)+e.slice(14,16)+e.slice(11,13)+e.slice(9,11)+e.slice(6,8)+e.slice(4,6)+e.slice(2,4)+e.slice(0,2)}function T(e){return"coded-value"!==e?.type?[]:e.codedValues.map((e=>e.code))}function C(e,t,i){const s=P({field:t.field,normalizationType:t.normalizationType,normalizationField:t.normalizationField,classificationMethod:t.classificationMethod,standardDeviationInterval:t.standardDeviationInterval,definedInterval:t.definedInterval,breakCount:t.numClasses||5});return e=function(e,t,r){const i=t??-1/0,s=r??1/0;return e.filter((e=>Number.isFinite(e)&&e>=i&&e<=s))}(e,t.minValue,t.maxValue),r.createGenerateRendererClassBreaks({definition:s,values:e,normalizationTotal:t.normalizationTotal},i)}function P(e){const{breakCount:r,field:i,normalizationField:s,normalizationType:n}=e,o=e.classificationMethod||"equal-interval",a="standard-deviation"===o?e.standardDeviationInterval||1:void 0,l="defined-interval"===o?e.definedInterval:void 0;return new t({breakCount:r,classificationField:i,classificationMethod:o,normalizationField:"field"===n?s:void 0,normalizationType:n,standardDeviationInterval:a,definedInterval:l})}function M(e,t,r=!1){const{field:i,classificationMethod:s,standardDeviationInterval:n,definedInterval:o,normalizationType:a,normalizationField:u,normalizationTotal:d,minValue:h,maxValue:p}=t,m=t.numBins||10;let f=null,g=null,y=null;if(s&&"equal-interval"!==s||a){const{classBreaks:t}=C(e,{field:i,normalizationType:a,normalizationField:u,normalizationTotal:d,classificationMethod:s,standardDeviationInterval:n,definedInterval:o,minValue:h,maxValue:p,numClasses:m},null!=h&&null!=p?[h,p]:void 0);f=t[0]?.minValue,g=t[t.length-1]?.maxValue,y=t.map((e=>[e.minValue,e.maxValue]))}else{if(null!=h&&null!=p)f=h,g=p;else{const t=c({values:e,minValue:h,maxValue:p,useSampleStdDev:!a,supportsNullCount:l({normalizationType:a,normalizationField:u,minValue:h,maxValue:p})});f=t.min??null,g=t.max??null}y=E(f??0,g??0,m)}if(r&&y.length){const e=y.at(-1)[1];y.push([e,e])}return{min:f,max:g,intervals:y}}function R(e,t){let r=-1;for(let i=e.length-1;i>=0;i--)if(t>=e[i][0]){r=i;break}return r}function E(e,t,r){const i=(t-e)/r,s=[];let n,o=e;for(let e=1;e<=r;e++)n=o+i,n=Number(n.toFixed(16)),s.push([o,e===r?t:n]),o=n;return s}e.binIndex=R,e.calculateClassBreaks=C,e.calculateHistogram=function(e,t){const r=M(e,t);if(null==r.min&&null==r.max)return{bins:[],minValue:r.min,maxValue:r.max,normalizationTotal:t.normalizationTotal};const i=r.intervals,s=r.min??0,n=r.max??0,o=i.map(((e,t)=>({minValue:i[t][0],maxValue:i[t][1],count:0})));for(const t of e)if(null!=t&&t>=s&&t<=n){const e=R(i,t);e>-1&&o[e].count++}return{bins:o,minValue:s,maxValue:n,normalizationTotal:t.normalizationTotal}},e.calculatePercentile=u,e.calculateStatistics=c,e.calculateStringStatistics=function(e){const{outStatisticTypes:t}=e,r=e.returnDistinct?[...new Set(e.values)]:e.values,i=r.filter((e=>null!=e)).sort(),s=i.length,n={count:s,min:i[0],max:i[s-1]};return e.supportsNullCount&&(n.nullcount=r.length-s),!e.percentileParams||t?.include?.length&&!t.include.includes("median")||t?.exclude?.length&&t.exclude.includes("median")||(n.median=u(r,e.percentileParams)),n},e.calculateUniqueValuesCount=function(e){const t={};for(let r of e)(null==r||"string"==typeof r&&""===r.trim())&&(r=null),null==t[r]?t[r]={count:1,data:r}:t[r].count++;return{count:t}},e.createClassBreaksDefinition=P,e.createUVResult=function(e,t,r,i){const s=e.count,n=[];if(r&&t){const e=[],r=T(t[0]);for(const s of r)if(t[1]){const r=T(t[1]);for(const n of r)if(t[2]){const r=T(t[2]);for(const t of r)e.push(`${a(s)}${i}${a(n)}${i}${a(t)}`)}else e.push(`${a(s)}${i}${a(n)}`)}else e.push(s);for(const t of e)s.hasOwnProperty(t)||(s[t]={data:t,count:0})}for(const e in s){const t=s[e];n.push({value:t.data,count:t.count,label:t.label})}return{uniqueValueInfos:n}},e.getAttributeComparator=d,e.getBinParams=M,e.getEqualIntervalBins=E,e.getNormalizedValue=function(e,t,r,i){let s=null;switch(t){case"log":0!==e&&(s=Math.log(e)*Math.LOG10E);break;case"percent-of-total":Number.isFinite(i)&&0!==i&&(s=e/i*100);break;case"field":Number.isFinite(r)&&0!==r&&(s=e/r);break;case"natural-log":e>0&&(s=Math.log(e));break;case"square-root":e>0&&(s=e**.5)}return s},e.isNullCountSupported=l,e.processNullValue=a,e.processSummaryStatisticsResult=function(e,t,r){let i;for(i in e)t?.include?.length&&!t.include.includes(i)||t?.exclude?.length&&t.exclude.includes(i)?delete e[i]:o.includes(i)&&(Number.isFinite(e[i])||(e[i]=null));return r?(["avg","stddev","variance"].forEach((t=>{null!=e[t]&&(e[t]=Math.ceil(e[t]??0))})),e):e},e.resolveCBResult=function(e,t){let r=e.classBreaks;const s=r.length,n=r[0]?.minValue,o=r[s-1]?.maxValue,a="standard-deviation"===t,l=i;return r=r.map((e=>{const t=e.label,r={minValue:e.minValue,maxValue:e.maxValue,label:t};if(a&&t){const e=t.match(l),i=e?.map((e=>+e.trim()))??[];2===i.length?(r.minStdDev=i[0],r.maxStdDev=i[1],i[0]<0&&i[1]>0&&(r.hasAvg=!0)):1===i.length&&(t.includes("<")?(r.minStdDev=null,r.maxStdDev=i[0]):t.includes(">")&&(r.minStdDev=i[0],r.maxStdDev=null))}return r})),{minValue:n,maxValue:o,classBreakInfos:r,normalizationTotal:e.normalizationTotal}},e.statisticTypes=o,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/rest/support/ClassBreaksDefinition":function(){define(["exports","../../chunks/tslib.es6","../../core/jsonMap","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=new r.JSONMap({esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation",esriClassifyDefinedInterval:"defined-interval"}),d=new r.JSONMap({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"});return e.default=class extends i{constructor(e){super(e),this.type="class-breaks-definition",this.breakCount=null,this.classificationField=null,this.classificationMethod=null,this.normalizationField=null,this.normalizationType=null}set standardDeviationInterval(e){"standard-deviation"===this.classificationMethod&&this._set("standardDeviationInterval",e)}set definedInterval(e){"defined-interval"===this.classificationMethod&&this._set("definedInterval",e)}},t.__decorate([l.enumeration({classBreaksDef:"class-breaks-definition"})],e.default.prototype,"type",void 0),t.__decorate([s.property({json:{write:!0}})],e.default.prototype,"breakCount",void 0),t.__decorate([s.property({json:{write:!0}})],e.default.prototype,"classificationField",void 0),t.__decorate([s.property({type:String,json:{read:u.read,write:u.write}})],e.default.prototype,"classificationMethod",void 0),t.__decorate([s.property({json:{write:!0}})],e.default.prototype,"normalizationField",void 0),t.__decorate([s.property({json:{read:d.read,write:d.write}})],e.default.prototype,"normalizationType",void 0),t.__decorate([s.property({value:null,json:{write:!0}})],e.default.prototype,"standardDeviationInterval",null),t.__decorate([s.property({value:null,json:{write:!0}})],e.default.prototype,"definedInterval",null),e.default=t.__decorate([c.subclass("esri.rest.support.ClassBreaksDefinition")],e.default),e.default}))},"esri/rest/support/generateRendererUtils":function(){define(["exports","../../core/Logger"],(function(e,t){"use strict";function r(e,t){return Number(e.toFixed(t))}function i(e,t,r){let i=null;return i=e===t?r&&"percent-of-total"===r?e+"%":e.toString():r&&"percent-of-total"===r?e+"% - "+t+"%":e+" - "+t,i}function s(e){const t=[],r=[];let i=Number.MIN_VALUE,s=1,n=-1;for(let o=0;o<e.length;o++){const a=e[o];a===i?(s++,r[n]=s):null!==a&&(t.push(a),i=a,s=1,r.push(s),n++)}return{uniqueValues:t,valueFrequency:r}}function n(e,t,r,i){let s=[],n=[],a=[],l=0;const c=[],u=[];for(let s=0;s<i;s++){const i=o(s,e,t,r);c.push(i.sbMean),u.push(i.sbSdcm),l+=u[s]}let d,h=l,p=!0;for(;p||l<h;){p=!1,s=[];for(let t=0;t<i;t++)s.push(e[t]);for(let r=0;r<i;r++)for(let s=e[r]+1;s<=e[r+1];s++)if(d=t[s],r>0&&s!==e[r+1]&&Math.abs(d-c[r])>Math.abs(d-c[r-1]))e[r]=s;else if(r<i-1&&e[r]!==s-1&&Math.abs(d-c[r])>Math.abs(d-c[r+1])){e[r+1]=s-1;break}h=l,l=0,n=[],a=[];for(let s=0;s<i;s++){n.push(c[s]),a.push(u[s]);const i=o(s,e,t,r);c[s]=i.sbMean,u[s]=i.sbSdcm,l+=u[s]}}if(l>h){for(let t=0;t<i;t++)e[t]=s[t],c[t]=n[t],u[t]=a[t];l=h}return{mean:c,sdcm:u}}function o(e,r,i,s){let n=0,o=0;for(let t=r[e]+1;t<=r[e+1];t++){const e=s[t];n+=i[t]*e,o+=e}o<=0&&t.getLogger("esri.rest.support.generateRendererUtils").warn("Exception in Natural Breaks calculation");const a=n/o;let l=0;for(let t=r[e]+1;t<=r[e+1];t++)l+=s[t]*(i[t]-a)**2;return{sbMean:a,sbSdcm:l}}e.createGenerateRendererClassBreaks=function(e,t){const{normalizationTotal:a}=e;return{classBreaks:function(e,t){const a=e.definition,{classificationMethod:l,normalizationType:c,definedInterval:u}=a,d=a.breakCount??1,h=[];let p=e.values;if(0===p.length)return[];p=p.sort(((e,t)=>e-t));const[m,f]=t??[p.at(0),p.at(-1)];if("equal-interval"===l)if(p.length>=d){const e=(f-m)/d;let t=m;for(let s=1;s<d;s++){const n=r(m+s*e,6);h.push({minValue:t,maxValue:n,label:i(t,n,c)}),t=n}h.push({minValue:t,maxValue:f,label:i(t,f,c)})}else p.forEach((e=>{h.push({minValue:e,maxValue:e,label:i(e,e,c)})}));else if("natural-breaks"===l){const t=s(p),a=e.valueFrequency||t.valueFrequency,l=function(e,t,r){const i=e.length,s=[];r>i&&(r=i);for(let e=0;e<r;e++)s.push(Math.round(e*i/r-1));s.push(i-1);let a=n(s,e,t,r);return function(e,t,r,i,s,n){let a=0,l=0,c=0,u=0,d=!0;for(let h=0;h<2&&d;h++){0===h&&(d=!1);for(let h=0;h<n-1;h++)for(;r[h+1]+1!==r[h+2];){r[h+1]=r[h+1]+1;const n=o(h,r,i,s);c=n.sbMean,a=n.sbSdcm;const p=o(h+1,r,i,s);if(u=p.sbMean,l=p.sbSdcm,!(a+l<t[h]+t[h+1])){r[h+1]=r[h+1]-1;break}t[h]=a,t[h+1]=l,e[h]=c,e[h+1]=u,d=!0}for(let h=n-1;h>0;h--)for(;r[h]!==r[h-1]+1;){r[h]=r[h]-1;const n=o(h-1,r,i,s);c=n.sbMean,a=n.sbSdcm;const p=o(h,r,i,s);if(u=p.sbMean,l=p.sbSdcm,!(a+l<t[h-1]+t[h])){r[h]=r[h]+1;break}t[h-1]=a,t[h]=l,e[h-1]=c,e[h]=u,d=!0}}return d}(a.mean,a.sdcm,s,e,t,r)&&(a=n(s,e,t,r)),s}(t.uniqueValues,a,d);let u=m;for(let e=1;e<d;e++)if(t.uniqueValues.length>e){const s=r(t.uniqueValues[l[e]],6);h.push({minValue:u,maxValue:s,label:i(u,s,c)}),u=s}h.push({minValue:u,maxValue:f,label:i(u,f,c)})}else if("quantile"===l)if(p.length>=d&&m!==f){let e=m,t=Math.ceil(p.length/d),r=0;for(let s=1;s<d;s++){let n=t+r-1;n>p.length&&(n=p.length-1),n<0&&(n=0),h.push({minValue:e,maxValue:p[n],label:i(e,p[n],c)}),e=p[n],r+=t,t=Math.ceil((p.length-r)/(d-s))}h.push({minValue:e,maxValue:f,label:i(e,f,c)})}else{let e=-1;for(let t=0;t<p.length;t++){const r=p[t];r!==e&&(e=r,h.push({minValue:e,maxValue:r,label:i(e,r,c)}),e=r)}}else if("standard-deviation"===l){const e=function(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return t/=e.length,t}(p),t=function(e,t){let r=0;for(let i=0;i<e.length;i++){const s=e[i];r+=(s-t)*(s-t)}return r/=e.length,Math.sqrt(r)}(p,e);if(0===t)h.push({minValue:p[0],maxValue:p[0],label:i(p[0],p[0],c)});else{const s=function(e,t,r,i,s){let n=Math.max(i-e,t-i)/s/r;return n=n>=1?1:n>=.5?.5:.25,n}(m,f,d,e,t),n=s*t;let o=0,a=m;for(let t=d;t>=1;t--){const s=r(e-(t-.5)*n,6);h.push({minValue:a,maxValue:s,label:i(a,s,c)}),a=s,o++}let l=r(e+.5*n,6);h.push({minValue:a,maxValue:l,label:i(a,l,c)}),a=l,o++;for(let t=1;t<=d;t++)l=o===2*d?f:r(e+(t+.5)*n,6),h.push({minValue:a,maxValue:l,label:i(a,l,c)}),a=l,o++}}else if("defined-interval"===l){if(!u)return h;const[e,s]=t??[p.at(0),p.at(-1)],n=Math.ceil((s-e)/u);let o=e;for(let t=1;t<n;t++){const s=r(e+t*u,6);h.push({minValue:o,maxValue:s,label:i(o,s,c)}),o=s}h.push({minValue:o,maxValue:s,label:i(o,s,c)})}return h}(e,t),normalizationTotal:a}},e.createGenerateRendererUniqueValues=function(e){const t=s(e),r=[],i=t.uniqueValues.length;for(let e=0;e<i;e++){const i=t.uniqueValues[e],s=t.valueFrequency[e],n=i.toString();r.push({value:i,count:s,label:n})}return{uniqueValues:r}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/queryUtils":function(){define(["require","exports","../../../core/Error","../../../core/jsonMap","../../../core/unitUtils","../../../geometry/projectionUtils","../../../geometry/support/extentUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","./projectionSupport"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=new i.JSONMap({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),h=Object.freeze({});async function p(e,t,r){const{outFields:i,orderByFields:s,groupByFieldsForStatistics:n,outStatistics:o}=e;if(i)for(let e=0;e<i.length;e++)i[e]=i[e].trim();if(s)for(let e=0;e<s.length;e++)s[e]=s[e].trim();if(n)for(let e=0;e<n.length;e++)n[e]=n[e].trim();if(o)for(let e=0;e<o.length;e++)o[e].onStatisticField&&(o[e].onStatisticField=o[e].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),m(e,t,r)}async function m(t,i,n){if(!t)return null;let{where:p}=t;if(t.where=p=p?.trim(),(!p||/^1 *= *1$/.test(p)||i&&i===p)&&(t.where=null),!t.geometry)return t;let m=await async function(t){const{distance:i,units:n}=t,o=t.geometry;if(null==i||"vertexAttributes"in o)return o;const l=o.spatialReference,h=n?d.fromJSON(n):s.getUnitString(l),p=l&&(c.isGeographic(l)||c.isWebMercator(l))?o:await u.checkProjectionSupport(l,c.wgs84).then((()=>u.project(o,c.wgs84))),m=await new Promise(((t,r)=>e(["../../../geometry/operators/json/geodesicBufferOperator"],t,r)));await m.load();const f=m.execute(p,i||1,{unit:h})??void 0;if(!f||!a.isPolygon(f)||0===f.rings.length)throw new r("unsupported-query:invalid-parameters","Invalid parameters for query by distance");return f}(t);if(t.distance=0,t.units=null,"esriSpatialRelEnvelopeIntersects"===t.spatialRel){const{spatialReference:e}=t.geometry;m=o.getGeometryExtent(m),m.spatialReference=e}if(m){await u.checkProjectionSupport(m.spatialReference,n),m=function(e,t){const r=e.spatialReference;return f(e,t)&&a.isExtent(e)?{spatialReference:r,rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}:e}(m,n);const e=(await l.normalizeCentralMeridian(a.fromJSON(m)))[0];if(null==e)throw h;const r="quantizationParameters"in t&&t.quantizationParameters?.tolerance||"maxAllowableOffset"in t&&t.maxAllowableOffset||0,i=r&&f(m,n)?{densificationStep:8*r}:void 0,s=e.toJSON(),o=u.project(s,s.spatialReference,n,i);if(!o)throw h;o.spatialReference=n,t.geometry=o}return t}function f(e,t){if(!e)return!1;const r=e.spatialReference;return(a.isExtent(e)||a.isPolygon(e)||a.isPolyline(e))&&!c.equals(r,t)&&!n.canProjectWithoutEngine(r,t)}t.getDateInNumber=function(e,t){return null==e?null:"string"==typeof e?t?new Date(`1970-01-01T${e}Z`).getTime():new Date(e).getTime():e instanceof Date?e.getTime():e},t.normalizeAttributeBinsQuery=async function(e,t,r){const i=e.bin;return i.onField&&(i.onField=i.onField.trim()),i.onExpression?.value&&(i.onExpression.value=i.onExpression.value.trim()),i.splitBy&&(i.splitBy.value&&(i.splitBy.value=i.splitBy.value.trim()),i.splitBy.outAlias&&(i.splitBy.outAlias=i.splitBy.outAlias.trim())),i.stackBy&&(i.stackBy.value&&(i.stackBy.value=i.stackBy.value.trim()),i.stackBy.outAlias&&(i.stackBy.outAlias=i.stackBy.outAlias.trim())),"normalizationField"in i.parameters&&i.parameters.normalizationField&&(i.parameters.normalizationField=i.parameters.normalizationField.trim()),e.outStatistics?.length||(e.outStatistics=[{statisticType:"count",onStatisticField:"1",outStatisticFieldName:"frequency"}]),p(e,t,r)},t.normalizeQuery=p,t.normalizeQueryLike=m,t.queryEngineEmptyResult=h,t.unitsKebabDict=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/SnappingCandidate":function(){define(["exports"],(function(e){"use strict";e.makeEdgeCandidate=function(e,t,r,i,s,n=!1){return{objectId:e,target:t,distance:r,type:"edge",start:i,end:s,draped:n}},e.makeVertexCandidate=function(e,t,r){return{objectId:e,target:t,distance:r,type:"vertex"}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/rest/support/AutoIntervalBinParameters":function(){define(["exports","../../chunks/tslib.es6","../../core/object","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./BinParametersBase","./NormalizationBinParametersMixin"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(e,t,i){r.setDeepValue(i,e instanceof Date?e.getTime():e,t)}return e.default=class extends(u.NormalizationBinParametersMixin(c)){constructor(e){super(e),this.numBins=null,this.end=null,this.start=null,this.type="auto-interval"}},t.__decorate([i.property({type:Number,json:{name:"parameters.numberOfBins",write:!0}})],e.default.prototype,"numBins",void 0),t.__decorate([i.property({json:{name:"parameters.end",write:{writer:d}}})],e.default.prototype,"end",void 0),t.__decorate([i.property({json:{name:"parameters.start",write:{writer:d}}})],e.default.prototype,"start",void 0),t.__decorate([a.enumeration({autoIntervalBin:"auto-interval"},{readOnly:!0})],e.default.prototype,"type",void 0),e.default=t.__decorate([l.subclass("esri.rest.support.AutoIntervalBinParameters")],e.default),e.default.from=s.ensureType(e.default),e.default}))},"esri/rest/support/BinParametersBase":function(){define(["exports","../../chunks/tslib.es6","../../core/Clonable","../../core/jsonMap","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./AttributeBinsGrouping"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h=new i.JSONMap({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeDate:"date",esriFieldTypeDateOnly:"date-only",esriFieldTypeTimeOnly:"time-only",esriFieldTypeTimestampOffset:"timestamp-offset"}),p=new i.JSONMap({naturalLog:"natural-log",squareRoot:"square-root"});return e.default=class extends(r.ClonableMixin(s)){constructor(e){super(e),this.expression=null,this.expressionValueType=null,this.field=null,this.firstDayOfWeek=null,this.hideUpperBound=null,this.splitBy=null,this.stackBy=null,this.transformation=null}},t.__decorate([n.property({type:String,json:{name:"onExpression.value",write:!0}})],e.default.prototype,"expression",void 0),t.__decorate([c.enumeration(h,{name:"onExpression.valueType"})],e.default.prototype,"expressionValueType",void 0),t.__decorate([n.property({type:String,json:{name:"onField",write:!0}})],e.default.prototype,"field",void 0),t.__decorate([n.property({type:String,json:{write:!0}})],e.default.prototype,"firstDayOfWeek",void 0),t.__decorate([n.property({type:String,json:{write:!0}})],e.default.prototype,"hideUpperBound",void 0),t.__decorate([n.property({type:d,json:{write:{overridePolicy(){return{enabled:null!=this.splitBy?.value||null!=this.splitBy?.type}}}}})],e.default.prototype,"splitBy",void 0),t.__decorate([n.property({type:d,json:{write:{target:{stackBy:{type:d},jsonStyle:{type:String}},writer:(e,t)=>{e&&(t.stackBy=e.toJSON(),null!=e.responseType&&(t.jsonStyle=e.responseType))},overridePolicy(){return{enabled:null!=this.stackBy?.value||null!=this.stackBy?.type}}},read:{source:["stackBy","jsonStyle"],reader:(e,t)=>d.fromJSON({...t.stackBy,responseType:t.jsonStyle})}}})],e.default.prototype,"stackBy",void 0),t.__decorate([c.enumeration(p)],e.default.prototype,"transformation",void 0),e.default=t.__decorate([u.subclass("esri.rest.support.BinParametersBase")],e.default),e.default}))},"esri/rest/support/AttributeBinsGrouping":function(){define(["../../chunks/tslib.es6","../../core/Clonable","../../core/jsonMap","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=new r.JSONMap({esriFieldTypeInteger:"integer",esriFieldTypeString:"string"});let d=class extends(t.ClonableMixin(i)){constructor(e){super(e),this.alias=null,this.responseType=null,this.type=null,this.value=null,this.valueType=null}};e.__decorate([s.property({type:String,json:{name:"outAlias",write:!0}})],d.prototype,"alias",void 0),e.__decorate([s.property({type:String})],d.prototype,"responseType",void 0),e.__decorate([s.property({type:String,json:{write:!0}})],d.prototype,"type",void 0),e.__decorate([s.property({type:String,json:{write:!0}})],d.prototype,"value",void 0),e.__decorate([l.enumeration(u)],d.prototype,"valueType",void 0),d=e.__decorate([c.subclass("esri.rest.support.AttributeBinsGrouping")],d);const h=d;return d.from=n.ensureType(d),h}))},"esri/rest/support/DateBinParameters":function(){define(["exports","../../chunks/tslib.es6","../../core/object","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./BinParametersBase","./DateBinTimeInterval"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(e,t,i){r.setDeepValue(i,"string"==typeof e?e:e?.getTime(),t)}function h(e,t){const r=e.parameters[t];return r?"string"==typeof r?r:new Date(r):null}return e.default=class extends c{constructor(e){super(e),this.end=null,this.interval=null,this.offset=null,this.returnFullIntervalBin=!1,this.start=null,this.snapToData=null,this.type="date"}},t.__decorate([i.property({cast:e=>null!=e?"string"==typeof e?e:new Date(e):null,json:{name:"parameters.end",read:{reader:(e,t)=>h(t,"end")},write:{writer:d}}})],e.default.prototype,"end",void 0),t.__decorate([i.property({type:u,json:{name:"parameters",write:!0}})],e.default.prototype,"interval",void 0),t.__decorate([i.property({type:u,json:{name:"parameters.offset",write:!0}})],e.default.prototype,"offset",void 0),t.__decorate([i.property({type:Boolean,json:{name:"parameters.returnFullIntervalBin",write:!0}})],e.default.prototype,"returnFullIntervalBin",void 0),t.__decorate([i.property({cast:e=>null!=e?"string"==typeof e?e:new Date(e):null,json:{name:"parameters.start",read:{reader:(e,t)=>h(t,"start")},write:{writer:d}}})],e.default.prototype,"start",void 0),t.__decorate([i.property({type:String,json:{name:"parameters.snapToData",write:!0}})],e.default.prototype,"snapToData",void 0),t.__decorate([a.enumeration({dateBin:"date"},{readOnly:!0})],e.default.prototype,"type",void 0),e.default=t.__decorate([l.subclass("esri.rest.support.DateBinParameters")],e.default),e.default.from=s.ensureType(e.default),e.default}))},"esri/rest/support/DateBinTimeInterval":function(){define(["../../chunks/tslib.es6","../../core/Clonable","../../core/JSONSupport","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./DateBinUtils"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";let u=class extends(t.ClonableMixin(r)){constructor(e){super(e),this.value=null,this.unit=null}};e.__decorate([i.property({type:Number,json:{name:"number",write:!0}})],u.prototype,"value",void 0),e.__decorate([a.enumeration(c.unitsDict)],u.prototype,"unit",void 0),u=e.__decorate([l.subclass("esri.rest.support.DateBinTimeInterval")],u);const d=u;return u.from=s.ensureType(u),d}))},"esri/rest/support/DateBinUtils":function(){define(["exports","../../core/jsonMap"],(function(e,t){"use strict";const r=t.strict()({year:"years",quarter:"quarters",month:"months",week:"weeks",day:"days",hour:"hours",minute:"minutes",second:"seconds"});e.unitsDict=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/rest/support/FixedBoundariesBinParameters":function(){define(["exports","../../chunks/tslib.es6","../../core/object","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./BinParametersBase"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";return e.default=class extends c{constructor(e){super(e),this.boundaries=[],this.type="fixed-boundaries"}},t.__decorate([i.property({json:{name:"parameters.boundaries",write:{writer:function(e,t,i){r.setDeepValue(i,e&&e[0]instanceof Date?e.map((e=>e.getTime())):e,t)}}}})],e.default.prototype,"boundaries",void 0),t.__decorate([a.enumeration({fixedBoundariesBin:"fixed-boundaries"},{readOnly:!0})],e.default.prototype,"type",void 0),e.default=t.__decorate([l.subclass("esri.rest.support.FixedBoundariesBinParameters")],e.default),e.default.from=s.ensureType(e.default),e.default}))},"esri/rest/support/FixedIntervalBinParameters":function(){define(["exports","../../chunks/tslib.es6","../../core/object","../../core/accessorSupport/decorators/property","../../core/accessorSupport/ensureType","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/enumeration","../../core/accessorSupport/decorators/subclass","./BinParametersBase","./NormalizationBinParametersMixin"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";function d(e,t,i){r.setDeepValue(i,e instanceof Date?e.getTime():e,t)}return e.default=class extends(u.NormalizationBinParametersMixin(c)){constructor(e){super(e),this.end=null,this.interval=null,this.start=null,this.type="fixed-interval"}},t.__decorate([i.property({json:{name:"parameters.end",write:{writer:d}}})],e.default.prototype,"end",void 0),t.__decorate([i.property({type:Number,json:{name:"parameters.interval",write:!0}})],e.default.prototype,"interval",void 0),t.__decorate([i.property({json:{name:"parameters.start",write:{writer:d}}})],e.default.prototype,"start",void 0),t.__decorate([a.enumeration({fixedIntervalBin:"fixed-interval"},{readOnly:!0})],e.default.prototype,"type",void 0),e.default=t.__decorate([l.subclass("esri.rest.support.FixedIntervalBinParameters")],e.default),e.default.from=s.ensureType(e.default),e.default}))},"esri/layers/graphics/data/queryValidationUtils":function(){define(["exports","../../../core/Error","./attributeSupport","./projectionSupport","./spatialQuerySupport","../../../support/loadArcade"],(function(e,t,r,i,s,n){"use strict";const o="unsupported-query";async function a(e,{fieldsIndex:n,geometryType:a,spatialReference:u,availableFields:d}){if(null!=e.geometryPrecision||e.multipatchOption&&"xyFootprint"!==e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new t(o,"Unsupported query options",{query:e});return l(n,d,e),function(e,i,s){const{outStatistics:n,groupByFieldsForStatistics:a,having:l}=s,u=a?.length,d=n?.length;if(l){if(!u||!d)throw new t(o,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:s});r.validateHaving(e,i,l,n,s)}if(d){if(!function(e){return null!=e&&e.every((e=>"exceedslimit"!==e.statisticType))}(n))return;const l=n.map((e=>e.onStatisticField)).filter(Boolean);r.validateFields(e,i,l,{expressionName:"onStatisticFields",query:s}),u&&r.validateFields(e,i,a,{expressionName:"groupByFieldsForStatistics",query:s});for(const a of n){const{onStatisticField:n,statisticType:l}=a;if("percentile_disc"!==l&&"percentile_cont"!==l||!("statisticParameters"in a))e.get(n)&&"count"!==l&&"min"!==l&&"max"!==l&&r.validateFields(e,i,[n],{expressionName:`outStatistics with '${l}' statistic type`,allowedFieldTypes:c,query:s});else{const{statisticParameters:e}=a;if(!e)throw new t(o,"statisticParameters should be set for percentile type",{definition:a,query:s})}}}}(n,d,e),Promise.all([s.checkSpatialQuerySupport(e,a,u),i.checkProjectionSupport(u,e.outSR)]).then((()=>e))}function l(e,i,s){const{returnDistinctValues:n,outStatistics:a}=s,l=a?a.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())).filter(Boolean):[];if("orderByFields"in s&&s.orderByFields&&s.orderByFields.length>0){const t=" asc",n=" desc",o=s.orderByFields.map((e=>{const r=e.toLowerCase();return r.includes(t)?r.split(t)[0]:r.includes(n)?r.split(n)[0]:e})).filter((e=>!l.includes(e)));r.validateFields(e,i,o,{expressionName:"orderByFields",query:s})}if("outFields"in s)if(s.outFields?.length)r.validateFields(e,i,s.outFields,{expressionName:"outFields",query:s,allowedFieldTypes:"all"});else if(n)throw new t(o,"outFields should be specified for returnDistinctValues",{query:s});r.validateWhere(e,i,s.where,s)}const c=new Set([...r.numericFieldTypes,...r.allDateAndTimeFieldTypes]);async function u(e,i,s,a){let l=[];if(s.valueExpression){const{arcadeUtils:e}=await n.loadArcade();l=e.extractFieldNames(s.valueExpression)}if(s.field&&l.push(s.field),s.field2&&l.push(s.field2),s.field3&&l.push(s.field3),s.normalizationField&&l.push(s.normalizationField),!l.length&&!s.valueExpression)throw new t(o,"field or valueExpression is required",{params:s});r.validateFields(e,i,l,{expressionName:"statistics",query:a})}e.validateAttributeBinsQuery=async function(e,r){const i=e.bin;if(!i.onField&&!i.onExpression?.value||"autoIntervalBin"===i.type&&null==i.parameters.numberOfBins||"dateBin"===i.type&&(null==i.parameters.number||null==i.parameters.unit)||"fixedBoundariesBin"===i.type&&null==i.parameters.boundaries||"fixedIntervalBin"===i.type&&null==i.parameters.interval)throw new t(o,"Unsupported query options",{query:e});return a(e,r)},e.validateQuery=a,e.validateStatisticsQuery=async function(e,r,{fieldsIndex:n,geometryType:a,spatialReference:c,availableFields:d}){if(null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new t(o,"Unsupported query options",{query:e});return l(n,d,e),Promise.all([u(n,d,r,e),s.checkSpatialQuerySupport(e,a,c),i.checkProjectionSupport(c,e.outSR)]).then((()=>e))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/spatialQuerySupport":function(){define(["require","exports","../../../core/Error","../../../geometry/support/contains","../../../geometry/support/intersects","../../../geometry/support/jsonUtils","../../../geometry/support/spatialReferenceUtils","../contains","../featureConversionUtils","../OptimizedGeometry","./geometryUtils","./projectionSupport"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";const h="unsupported-query",p={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},m={esriGeometryPoint:!0,esriGeometryMultiPatch:!1,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},f={esriGeometryPoint:!0,esriGeometryMultiPatch:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1},g={esriSpatialRelIntersects:()=>new Promise(((t,r)=>e(["../../../geometry/operators/json/intersectsOperator"],t,r))),esriSpatialRelContains:()=>new Promise(((t,r)=>e(["../../../geometry/operators/json/containsOperator"],t,r))),esriSpatialRelCrosses:()=>new Promise(((t,r)=>e(["../../../geometry/operators/json/crossesOperator"],t,r))),esriSpatialRelDisjoint:()=>new Promise(((t,r)=>e(["../../../geometry/operators/json/disjointOperator"],t,r))),esriSpatialRelEnvelopeIntersects:null,esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:()=>new Promise(((t,r)=>e(["../../../geometry/operators/json/overlapsOperator"],t,r))),esriSpatialRelTouches:()=>new Promise(((t,r)=>e(["../../../geometry/operators/json/touchesOperator"],t,r))),esriSpatialRelWithin:()=>new Promise(((t,r)=>e(["../../../geometry/operators/json/withinOperator"],t,r))),esriSpatialRelRelation:null};t.canQueryWithRBush=function(e){if(n.isExtent(e))return!0;if(n.isPolygon(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1},t.checkSpatialQuerySupport=async function(e,t,i){const{spatialRel:s,geometry:a}=e;if(a){if(null==(l=s)||!0!==p[l])throw new r(h,"Unsupported query spatial relationship",{query:e});var l;if(o.isValid(a.spatialReference)&&o.isValid(i)){if(!function(e){return null!=e&&!0===m[n.getJsonType(e)]}(a))throw new r(h,"Unsupported query geometry type",{query:e});if(!function(e){return null!=e&&!0===f[e]}(t))throw new r(h,"Unsupported layer geometry type",{query:e});if(e.outSR)return d.checkProjectionSupport(e.geometry?.spatialReference,e.outSR)}}},t.getSpatialQueryOperator=async function(e,t,r,o,d){if(n.isPolygon(t)){if("esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=l.convertFromPolygon(new c,t,!1,!1);return t=>a.polygonContainsPoint(e,!1,!1,t)}if("esriGeometryMultipoint"===r){const r=l.convertFromPolygon(new c,t,!1,!1);if("esriSpatialRelContains"===e)return e=>a.polygonContainsMultipoint(r,!1,!1,e,o,d)}}if(n.isExtent(t)){if("esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return e=>i.extentContainsPoint(t,u.getGeometry(r,o,d,e));if("esriGeometryMultipoint"===r&&"esriSpatialRelContains"===e)return e=>i.extentContainsMultipoint(t,u.getGeometry(r,o,d,e));if("esriSpatialRelIntersects"===e){const e=s.getExtentIntersector(r);return i=>e(t,u.getGeometry(r,o,d,i))}}"esriSpatialRelEnvelopeIntersects"===e&&(e="esriSpatialRelIntersects");const h=await function(e){const t=g[e];if(null==t)throw new Error(`Cannot load unsupported spatial operator: ${e}`);return t()}(e);return e=>h.execute(t,u.getGeometry(r,o,d,e))},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/intersects":function(){define(["exports","./intersectsBase"],(function(e,t){"use strict";e.extentIntersectsExtent=t.extentIntersectsExtent,e.extentIntersectsMultipoint=t.extentIntersectsMultipoint,e.extentIntersectsPoint=t.extentIntersectsPoint,e.extentIntersectsPolygon=t.extentIntersectsPolygon,e.extentIntersectsPolyline=t.extentIntersectsPolyline,e.getFeatureExtentIntersector=t.getFeatureExtentIntersector,e.isSelfIntersecting=t.isSelfIntersecting,e.segmentIntersects=t.segmentIntersects,e.getExtentIntersector=function(e){return"mesh"===e?t.extentIntersectsExtent:t.getFeatureExtentIntersector(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/contains":function(){define(["exports"],(function(e){"use strict";function t(e,t){return e?t?4:3:t?3:2}function r(e,r,s,n,o){if(!e)return!1;const a=t(r,s),{coords:l,lengths:c}=e;let u=!1,d=0;for(const e of c)u=i(u,l,a,d,e,n,o),d+=e*a;return u}function i(e,t,r,i,s,n,o){let a=e,l=i;for(let e=i,c=i+s*r;e<c;e+=r){l=e+r,l===c&&(l=i);const s=t[e],u=t[e+1],d=t[l],h=t[l+1];(u<o&&h>=o||h<o&&u>=o)&&s+(o-u)/(h-u)*(d-s)<n&&(a=!a)}return a}e.polygonContainsCoords=r,e.polygonContainsMultipoint=function(e,i,s,n,o,a){const l=t(o,a),{coords:c,lengths:u}=n;if(!u)return!1;for(let t=0,n=0;t<u.length;t++,n+=l)if(!r(e,i,s,c[n],c[n+1]))return!1;return!0},e.polygonContainsPoint=function(e,t,i,s){return r(e,t,i,s.coords[0],s.coords[1])},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/timeSupport":function(){define(["exports","../../../core/compilerUtils"],(function(e,t){"use strict";e.getTimeExtent=async function(e,r){if(!e)return null;const i=r.featureAdapter,{startTimeField:s,endTimeField:n}=e;let o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;if(s&&n)await r.forEach((e=>{const r=i.getAttribute(t.toConst(e),s),l=i.getAttribute(t.toConst(e),n);null==r||isNaN(r)||(o=Math.min(o,r)),null==l||isNaN(l)||(a=Math.max(a,l))}));else{const e=s||n;await r.forEach((r=>{const s=i.getAttribute(t.toConst(r),e);null==s||isNaN(s)||(o=Math.min(o,s),a=Math.max(a,s))}))}return{start:o,end:a}},e.getTimeOperator=function(e,t,r){if(!t||!e)return null;const{startTimeField:i,endTimeField:s}=e;if(!i&&!s)return null;const{start:n,end:o}=t;if(null===n&&null===o)return null;if(void 0===n&&void 0===o)return()=>!1;const a=r.getAttributeAsTimestamp?.bind(r)??r.getAttribute.bind(r);return i&&s?function(e,t,r,i,s){return null!=i&&null!=s?n=>{const o=e(n,t),a=e(n,r);return(null==o||o<=s)&&(null==a||a>=i)}:null!=i?t=>{const s=e(t,r);return null==s||s>=i}:null!=s?r=>{const i=e(r,t);return null==i||i<=s}:void 0}(a,i,s,n,o):function(e,t,r,i){return null!=r&&null!=i&&r===i?i=>e(i,t)===r:null!=r&&null!=i?s=>{const n=e(s,t);return null!=n&&n>=r&&n<=i}:null!=r?i=>{const s=e(i,t);return null!=s&&s>=r}:null!=i?r=>{const s=e(r,t);return null!=s&&s<=i}:void 0}(a,i||s,n,o)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/2d/layers/features/layerAdapters/featureServiceUtils":function(){define(["exports","../../../../../core/has"],(function(e,t){"use strict";function r(e,r){return!(!e&&!t("featurelayer-snapshot-non-hosted-exceedslimit-enabled"))&&r?.operations.supportsExceedsLimitStatistics}e.createFeatureIdInfo=function(e){const{objectIdField:t,uniqueIdFields:r}=e;return r?.length?r.length>=2?{type:"unique-id-composite",fieldNames:r}:{type:"unique-id-simple",fieldName:r[0]}:{type:"object-id",fieldName:t}},e.createSnapshotInfo=function(e,i,s,n,o,a){const l=function(e){switch(e){case"esriGeometryMultipoint":return{min:t("featurelayer-snapshot-multipoint-min-threshold"),max:t("featurelayer-snapshot-multipoint-max-threshold")};case"esriGeometryPoint":return{min:t("featurelayer-snapshot-point-min-threshold"),max:t("featurelayer-snapshot-point-max-threshold")};case"esriGeometryMultiPatch":case"esriGeometryPolygon":return{min:t("featurelayer-snapshot-polygon-min-threshold"),max:t("featurelayer-snapshot-polygon-max-threshold")};case"esriGeometryPolyline":return{min:t("featurelayer-snapshot-polyline-min-threshold"),max:t("featurelayer-snapshot-polyline-max-threshold")}}}(n);if(!t("featurelayer-snapshot-enabled")||!s?.query.supportsPagination||s?.operations.supportsEditing||i)return null;const c=function(e,r){const i=r?.clone().intersection(e),s=null!=i?i.width*i.height:0,n=r?r.width*r.height:0,o=0===n?0:s/n,a=t("featurelayer-snapshot-coverage");return!isNaN(o)&&o>=a}(o,a),{min:u,max:d}=l,h=c?d:u,p=function(e){switch(e){case"esriGeometryPoint":return null;case"esriGeometryPolyline":case"esriGeometryPolygon":case"esriGeometryMultiPatch":case"esriGeometryMultipoint":return t("featurelayer-snapshot-max-vertex-count")}}(n);let m=t("featurelayer-snapshot-initial-tolerance");return"esriGeometryPoint"!==n&&"esriGeometryMultipoint"!==n||(m=null),{supportsExceedsLimit:r(e,s),initialTolerance:m,maxFeatureCount:h,maxVertexCount:p}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/QueryEngineCache":function(){define(["exports","../../../../core/has","../../../../core/memoryEstimations"],(function(e,t,r){"use strict";class i{constructor(e){this.items=e}get cachedMemory(){return this.items.reduce(((e,t)=>e+t.usedMemory),r.baseArrayMemory+r.baseObjectMemory)}}e.QueryEngineCache=class{constructor(e){this._cache=e.newCache("QueryEngine",null,-1)}clear(){this._cache.clear()}destroy(){this._cache.destroy()}get(e){return this._cache.get(e)?.items}put(e,t){this._cache.put(e,new i(t))}get test(){}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/QueryEngineContext":function(){define(["exports"],(function(e){"use strict";e.QueryEngineContext=class{constructor(e,t,r,i,s,n){this.spatialReference=e,this.layer=t,this.resourceController=r,this._getFeatureStore=i,this.hasZ=s,this.hasM=n}get scheduler(){return this.resourceController.scheduler}get memoryController(){return this.resourceController.memoryController}get featureStore(){return this._getFeatureStore()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/highlightUtils":function(){define(["exports","../../../../core/Collection","../../../../core/handleUtils","../../../../support/guards"],(function(e,t,r,i){"use strict";function s(e){return"number"==typeof e||"string"==typeof e}const n=[],o=r.makeHandle();e.emptyHighlightHandle=o,e.isObjectId=s,e.normalizeHighlightTargetExceptQuery=function(e){return t.isCollection(e)?e.toArray():Array.isArray(e)?e:s(e)||i.isGraphic(e)||"esri.views.3d.layers.i3s.PointCloudGraphic"===e.declaredClass?[e]:n},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/graphics/queryForSymbologySnapping":function(){define(["exports","../../../../core/promiseUtils","../../../../support/loadArcade"],(function(e,t,r){"use strict";const i={candidates:[],sourceCandidateIndices:[]};e.queryForSymbologySnapping=async function(e,s,n){if(null==e||0===s.candidates.length)return i;const o=e.graphics3DGraphicsByObjectID??e.graphics3DGraphics,a=[],l=[],{renderer:c}=e,u=null!=c&&"arcadeRequired"in c&&c.arcadeRequired?r.loadArcade():null,d=async(t,{graphic:r,graphics3DSymbol:i})=>{const s=await u,o=await e.getRenderingInfoAsync(r,c,s,{signal:n});return null==o?[]:i.queryForSnapping(t,p,o,n)},{candidates:h,spatialReference:p}=s;for(let e=0;e<h.length;++e){const t=h[e],{objectId:r}=t,i="number"==typeof r?o?.get(r):void 0;if(null==i)continue;const{graphics3DSymbol:s}=i;s.symbologySnappingSupported&&(a.push(d(t,i)),l.push(e))}if(0===a.length)return i;const m=await Promise.all(a);t.throwIfAborted(n);const f=[],g=[];for(let e=0;e<m.length;++e){const t=m[e],r=l[e];for(const e of t)f.push(e),g.push(r)}return{candidates:f,sourceCandidateIndices:g}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/HeatmapFeatureProcessor":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/arrayUtils","../../../../core/handleUtils","../../../../core/has","../../../../core/Logger","../../../../core/memoryEstimations","../../../../core/Promise","../../../../core/reactiveUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/support/UpdatingHandles","../../../../geometry/projection/projectPointToVector","../../../../geometry/support/Indices","../../../../geometry/support/scaleUtils","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","../../../../layers/graphics/OptimizedFeature","../../../../layers/graphics/OptimizedGeometry","../../../../layers/graphics/data/FeatureStore","../../../../layers/support/fieldUtils","../../../../renderers/support/heatmapUtils","../interfaces","../graphics/DisplayFeatureLimit","../graphics/GraphicsCorePerformanceInfo","./FeatureVisibilityFilter","./highlightUtils","../../terrain/OverlayRenderer","../../webgl-engine/lib/Attribute","../../webgl-engine/lib/DrapedHeatmapRenderer","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/ModelDirtyTypes","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/UpdatePolicy","../../webgl-engine/lib/VertexAttribute","../../webgl-engine/materials/HeatmapDensityMaterial","../../../support/layerViewUtils","../../../webgl/enums","../../../webgl/heatmapTextureUtils","../../webgl-engine/lib/IntersectableGeometry"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k){"use strict";e.HeatmapFeatureProcessor=class extends a{constructor(e){super(e),this.type="heatmap",this.preferredUpdatePolicy=L.UpdatePolicy.ASYNC,this.dataExtent=null,this.drapeSourceType=T.DrapeSourceType.Features,this._renderGeometries=new Map,this._fieldTotal=0,this._drapeSourceRenderer=null,this._dataType=B.PixelType.HALF_FLOAT,this._pixelFormat=B.PixelFormat.RGBA,this._updatingHandles=new p.UpdatingHandles}initialize(){let e;try{e=G.loadHeatmapTextureConfiguration(this._renderView.renderingContext,n.getLogger(this))}catch(t){this.addResolvingPromise(Promise.reject(t)),e=G.fallBackHeatmapConfiguration}const{dataType:t,samplingMode:r,pixelFormat:s,internalFormat:o}=e;this._featureStore=new S({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM}),this._dataType=t,this._pixelFormat=s;const a=t!==B.PixelType.FLOAT,c=this.view.basemapTerrain.overlayManager,u={...this._rendererParameters,stage:this.view.stage,dataType:t,samplingMode:r,pixelFormat:s,internalFormat:o,rendererContext:c.renderer,drapeSource:this};this._drapeSourceRenderer=new A.DrapedHeatmapRenderer(u),c.registerDrapeSource(this,this._drapeSourceRenderer),this._material=new U.HeatmapDensityMaterial({usesHalfFloats:a}),this._materialWithField=new U.HeatmapDensityMaterial({usesHalfFloats:a,isAttributeDriven:!0}),this._filterVisibility=new M.FeatureVisibilityFilter({context:{configuration:this.owner,featureStore:this.featureStore,getFeatureCount:()=>this._loadedPointGraphics.length,setAllFeaturesVisibility:e=>this._setAllFeaturesVisibility(e),clearFeaturesVisibility:()=>this._setAllFeaturesVisibility(!0),updateFeatureVisibilities:e=>this._updateFeatureVisibilities(e)}}),this._updatingHandles.addOnCollectionChange((()=>this._loadedPointGraphics),(e=>this._onLoadedFeaturesChange(e)),l.initial),this._updatingHandles.addWhen((()=>this._materialParameters),(e=>this._forEachMaterial((t=>t.setParameters(e)))),l.initial),this._updatingHandles.add((()=>this._rendererParameters),(e=>this._drapeSourceRenderer.set(e))),this._updatingHandles.add((()=>this._heatmapRendererField),(()=>{this._recreate()}),l.sync),this._updatingHandles.add((()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric})),(({fieldName:e,numeric:t})=>{if(null!=e&&t){let t=0;this._featureStore.forEach((r=>t+=r.attributes[e]??0)),this._fieldTotal=t}else this._fieldTotal=this._featureStore.numFeatures}),l.initial),this.addHandles([l.watch((()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField})),(({fieldName:e,field:t})=>{e&&!t&&n.getLogger(this).warn(`Heatmap renderer field '${e}' for layer '${this.layer.title??this.layer.id}' not found`)})),l.watch((()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric})),(({field:e,numeric:t})=>{null==e||t||n.getLogger(this).warn(`Heatmap renderer field '${e.name}' for layer '${this.layer.title??this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)})),i.makeHandle((()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this)))])}destroy(){this._renderGeometries.clear(),this._material=null,this._materialWithField=null,this._featureStore.clear(),this._featureStore=null,this._updatingHandles.destroy()}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this._updatingHandles.updating||this.filterVisibility.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get filterVisibility(){return this._filterVisibility}get displayFeatureLimit(){const e=this.owner?.view?.quality??1,t=this.owner?.view?.qualitySettings,r=t?Math.ceil(t.heatmap.maxTotalNumberOfFeatures*e):0,i=6*r,s=r;return new C.DisplayFeatureLimit(i,s)}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){if(!this._isScaleRangeActive)return!1;const{minScale:e,maxScale:t}=this.layer.effectiveScaleRange,{scale:r}=this.view;return!V.scaleBoundsPredicate(r,e??0,t??0)}get usedMemory(){const e=this.usedMemoryPerFeature*this._featureStore.numFeatures,t=this._pixelFormat===B.PixelFormat.RED?1:4,r=this._dataType===B.PixelType.FLOAT?4:2,i=Math.ceil((this._overlayRenderer?.overlays[0]?.resolution??0)*this._densityMapPixelRatio)??0;return i*i*t*r+e}get usedMemoryPerFeature(){const e=this._loadedPointGraphics.find((()=>!0));if(null==e)return 0;const t=o.estimateAttributesMemory(e);return 6*o.estimateFixedArrayMemory([0,0,0],o.estimateNumberMemory)+6*o.estimateFixedArrayMemory([0,0],o.estimateNumberMemory)+(this._heatmapRendererFieldIsNumeric?6*o.estimateNumberMemory:0)+t}get loadedFeatures(){return this._featureStore.numFeatures}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return new P.GraphicsCorePerformanceInfo(this._renderGeometries.size,this._visibleFeatures,0,0)}get renderer(){return this._heatmapRenderer}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return this._overlayRenderer.spatialReference}get _rendererParameters(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}get _materialParameters(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}get _densityParameters(){const e=this._heatmapRenderer;if(null==e)return null;const{minDensity:t,maxDensity:r}=e;return{minDensity:t,maxDensity:r,fieldTotal:this._fieldTotal}}get _radiusParameter(){const e=this._heatmapRenderer;return e?{searchRadius:c.pt2px(this._clampSearchRadius(e.radius))}:null}get _resolutionForScaleParameter(){const e=this._heatmapRenderer;if(!e)return null;const{referenceScale:t}=e;return{resolutionForScale:0===t?0:g.getResolutionForScale(t,this.view.spatialReference)}}get _colorRampParameter(){const e=this._heatmapRenderer;return e?{colorRampData:x.generateGradient(e.colorStops)}:null}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){return this.owner?.view?.qualitySettings.heatmap.pixelRatio??1}get _renderView(){return this.view.stage.renderView}get _featuresArePoints(){return"point"===this.layer.geometryType}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const e=this.layer.renderer;return"heatmap"===e?.type?e:null}get _heatmapRendererFieldName(){return this._heatmapRenderer?.field}get _heatmapRendererField(){const e=this._heatmapRendererFieldName;return null!=e?this.layer.fieldsIndex.get(e):null}get _heatmapRendererFieldIsNumeric(){const e=this._heatmapRendererField;return null!=e&&w.isNumericField(e)}get _isScaleRangeActive(){const{layer:e}=this;if(!("effectiveScaleRange"in e))return!1;const{minScale:t,maxScale:r}=e.effectiveScaleRange;return V.isScaleRangeActive(t,r)}get _visibleFeatures(){return Array.from(this._renderGeometries.values()).reduce(((e,{visible:t})=>e+(t?1:0)),0)}async whenGraphicBounds(){return null}computeAttachmentOrigin(){return null}highlight(){return R.emptyHighlightHandle}maskOccludee(){return i.makeHandle()}setObjectIdVisibility(){}refreshFilter(){this.filterVisibility.reapply()}_onLoadedFeaturesChange(e){if(!this._featuresArePoints)return;const{objectIdField:t}=this.layer;this._featureStore.removeManyById(e.removed.map((e=>y.getObjectId(e,t)))),this._featureStore.addMany(e.added.map((e=>{const{attributes:r,centroid:i,geometry:s}=e,n=new b.OptimizedFeature(_.convertFromPoint(new v,s),r,i?_.convertFromPoint(new v,i):null,y.getObjectId(e,t));return n.displayId=e.uid,n})));const i=e.added,s=e.removed;this._fieldTotal+=this._computeFieldTotalChange(i,s);const n=s.map((({uid:e})=>{const t=this._renderGeometries.get(e);return this._renderGeometries.delete(e),t})).filter(r.isSome),o=i.map((e=>{const t=this._pointGraphicToRenderGeometry(e);return this._renderGeometries.set(e.uid,t),t}));n.length>0&&this._drapeSourceRenderer.removeGeometries(n,D.DirtyOperation.REMOVE),o.length>0&&this._drapeSourceRenderer.addGeometries(o,D.DirtyOperation.ADD),(o.length>0||n.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}_recreate(){if(!this._loadedPointGraphics)return;const e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})}_pointGraphicToRenderGeometry(e){const t=this._heatmapRendererFieldName,r=null!=t?this._materialWithField:this._material,i=h.create();m.projectPointToVector(e.geometry,i,this._overlaySpatialReference),i[2]=E.drapedZ;const s=f.getContinuousIndexArray(1),n=[[N.VertexAttribute.POSITION,new O.Attribute(i,s,i.length)]],o=this._heatmapRendererFieldIsNumeric;null!=t&&n.push([N.VertexAttribute.FEATUREATTRIBUTE,new O.Attribute([o?e.attributes[t]??0:0],s,1)]);const a=new F.RenderGeometry(new I.Geometry(r,n,null,k.GeometryType.Point),{layerViewUid:this.owner.layerViewUid,graphicUid:e.uid});return a.visible=this.filterVisibility.defaultVisibility,a}_forEachMaterial(e){e(this._material),e(this._materialWithField)}_computeFieldTotalChange(e,t){if(null==this._heatmapRendererFieldName||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;const r=this._heatmapRendererFieldName,i=(e,t)=>e+(t.attributes[r]??0);return e.reduce(i,0)-t.reduce(i,0)}_clampSearchRadius(e){return e>112&&n.getLogger(this).warnOnce("SceneView supports a maximum radius of 112 pt for HeatmapRenderer."),Math.min(e,112)}_updateFeatureVisibilities(e){const t=[];this._featureStore.forEach((({objectId:r,displayId:i})=>{const s=e(r),n=this._renderGeometries.get(i);n&&n.visible!==s&&(t.push(n),n.visible=s)})),this._drapeSourceRenderer.modifyGeometries(t,D.DirtyState.VISIBILITY)}_setAllFeaturesVisibility(e){const t=[];for(const r of this._renderGeometries.values())r.visible!==e&&(t.push(r),r.visible=e);this._drapeSourceRenderer.modifyGeometries(t,D.DirtyState.VISIBILITY)}get test(){}},t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"type",void 0),t.__decorate([u.property({constructOnly:!0})],e.HeatmapFeatureProcessor.prototype,"owner",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"layer",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"featureStore",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"updating",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"updatingRemaining",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"suspendInfo",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"legendEnabled",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"filterVisibility",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"displayFeatureLimit",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"preferredUpdatePolicy",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"hasZ",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"hasM",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"dataExtent",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"view",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"fullOpacity",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"updatePolicy",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"drapeSourceType",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"scaleVisibilitySuspended",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"renderer",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_featureStore",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_filterVisibility",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_overlayRenderer",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_overlaySpatialReference",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_rendererParameters",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_materialParameters",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_densityParameters",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_radiusParameter",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_resolutionForScaleParameter",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_colorRampParameter",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_pixelRatioParameter",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_densityMapPixelRatio",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_renderGeometries",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_material",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_materialWithField",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_renderView",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_featuresArePoints",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_loadedPointGraphics",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRenderer",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldName",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRendererField",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldIsNumeric",null),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_fieldTotal",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_drapeSourceRenderer",void 0),t.__decorate([u.property()],e.HeatmapFeatureProcessor.prototype,"_isScaleRangeActive",null),e.HeatmapFeatureProcessor=t.__decorate([d.subclass("esri.views.3d.layers.support.HeatmapFeatureProcessor")],e.HeatmapFeatureProcessor),e.maxRadiusPt=112,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/data/FeatureStore":function(){define(["../../../core/arrayUtils","../../../core/Error","../../../core/Evented","../../../core/Logger","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../featureConversionUtils","./BoundsStore","./geometryUtils","./optimizedFeatureQueryEngineAdapter"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";const u=s.create();return class{constructor(e){this.geometryInfo=e,this._boundsStore=new a.BoundsStore,this._featuresById=new Map,this._usedMemory=0,this.events=new r,this.featureAdapter=c.optimizedFeatureQueryEngineAdapter}get usedMemory(){return this._usedMemory}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach((t=>{null!=t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(null==this.fullBounds)return null;const[t,r,i,s]=this.fullBounds;return{xmin:t,ymin:r,xmax:i,ymax:s,spatialReference:l.cleanFromGeometryEngine(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(t){const r=t.map((e=>this._upsert(e)));return this._emitChanged(),r.filter(e.isSome)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged(),this._usedMemory=0}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(const r of e){const e=this._boundsStore.get(r.objectId);e&&t(s.fromRect(u,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach((t=>e(t)))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,(e=>{t(this._featuresById.get(e))}))}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const r=e.objectId;if(null==r)return void i.getLogger("esri.layers.graphics.data.FeatureStore").error(new t("featurestore:invalid-feature","feature id is missing",{feature:e}));const s=this._featuresById.get(r);let a;if(s?(e.displayId=s.displayId,a=this._boundsStore.get(r),this._boundsStore.delete(r),this._usedMemory-=this.estimateFeatureUsedMemory?.(s)??0):null!=this.onFeatureAdd&&this.onFeatureAdd(e),!e.geometry?.coords?.length)return this._boundsStore.set(r,null),void this._featuresById.set(r,e);a=o.getBoundsOptimizedGeometry(null!=a?a:n.create(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=a&&this._boundsStore.set(r,a),this._featuresById.set(r,e),this._usedMemory+=this.estimateFeatureUsedMemory?.(e)??0}_upsert(e){const r=e?.objectId;if(null==r)return i.getLogger("esri.layers.graphics.data.FeatureStore").error(new t("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const s=this._featuresById.get(r);if(!s)return this._add(e),e;this._usedMemory-=this.estimateFeatureUsedMemory?.(s)??0;const{geometry:a,attributes:l}=e;for(const e in l)s.attributes[e]=l[e];return a&&(s.geometry=a,this._boundsStore.set(r,o.getBoundsOptimizedGeometry(n.create(),a,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),this._usedMemory+=this.estimateFeatureUsedMemory?.(s)??0,s}_remove(e){null!=this.onFeatureRemove&&this.onFeatureRemove(e);const t=e.objectId;return this._boundsStore.delete(t),this._featuresById.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(e)??0,e}}}))},"esri/layers/graphics/data/BoundsStore":function(){define(["exports","../../../core/has","../../../core/libs/rbush/PooledRBush","../../../geometry/support/aaBoundingRect"],(function(e,t,r,i){"use strict";const s={minX:0,minY:0,maxX:0,maxY:0};e.BoundsStore=class{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new r.PooledRBush(9,t("esri-csp-restrictions")?e=>({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const e=new Array(this._idByBounds.size);let t=0;this._idByBounds.forEach(((r,i)=>{e[t++]=i})),this._indexInvalid=!1,this._index.clear(),this._index.load(e)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter((e=>this._idByBounds.has(e)))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const e=i.empty();for(const t of this._boundsById.values())t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]));return e}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(e){const t=this._boundsById.get(e);this._boundsById.delete(e),t&&(this._idByBounds.delete(t),this._indexInvalid||this._index.remove(t))}forEachInBounds(e,t){this._loadIndex(),function(e,t,r){!function(e){s.minX=e[0],s.minY=e[1],s.maxX=e[2],s.maxY=e[3]}(t),e.search(s,r)}(this._index,e,(e=>t(this._idByBounds.get(e))))}get(e){return this._boundsById.get(e)}has(e){return this._boundsById.has(e)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(e,t){if(!this._indexInvalid){const t=this._boundsById.get(e);t&&(this._index.remove(t),this._idByBounds.delete(t))}this._boundsById.set(e,t),t&&(this._idByBounds.set(t,e),this._indexInvalid||(this._boundsToLoad.push(t),this._boundsToLoad.length>5e4&&this._loadIndex()))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/lib/DrapedHeatmapRenderer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","./glUtil3D","./SortedRenderGeometryRenderer","../shaders/HeatmapTechnique","../shaders/HeatmapTechniqueConfiguration","../../../webgl/enums","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/TextureDescriptor","../../../webgl/Util"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y){"use strict";e.DrapedHeatmapRenderer=class extends u.SortedRenderGeometryRenderer{constructor(e){super(e),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new d.HeatmapPassParameters,this._configuration=new h.HeatmapTechniqueConfiguration;const t=new g.TextureDescriptor;t.pixelFormat=e.pixelFormat,t.internalFormat=e.internalFormat,t.dataType=e.dataType,t.samplingMode=e.samplingMode,t.wrapMode=p.TextureWrapMode.CLAMP_TO_EDGE;const r=e.rendererContext.rctx;this._densityMap=new m.FramebufferObject(r,t),this._quad=c.createQuadVAO(r),this._configuration.usesHalfFloat=e.dataType!==p.PixelType.FLOAT,e.rendererContext.pluginContext.techniques.precompile(d.HeatmapTechnique,this._configuration)}initialize(){const e=this._colorRampData,t=new g.TextureDescriptor(e.length/4,1);t.wrapMode=p.TextureWrapMode.CLAMP_TO_EDGE,this._colorRamp=new f.Texture(this.rctx,t,e),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles(i.watch((()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius]),(()=>this.rendererContext.notifyContentChanged())))}destroy(){this._densityMap=r.disposeMaybe(this._densityMap),this._quad=r.disposeMaybe(this._quad),this._colorRamp=r.disposeMaybe(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(e){const{colorRamp:t}=this._heatmapParameters;if(null!=t&&e!==this._colorRampData){const r=t.descriptor.width,i=e.length/4;i!==r&&t.resize(i,1),t.setData(e)}this._colorRampData=e}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(e){this._heatmapParameters.colorRamp=e}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccludedDraped(){return!1}render(e){const t=this.sortedRenderers;if(0===t.length)return;const r=this.rctx.getBoundFramebufferObject(),i=this.rctx.getViewport(),{pixelRatio:s}=this,n=Math.ceil(i.width*s),o=Math.ceil(i.height*s);this._densityMap.resize(n,o),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,n,o),this.rctx.clear(p.FramebufferBit.COLOR);let a=!1;if(t.forAll((t=>{const r=t.acquireTechniques(e);r&&(t.render(e,r),a=!0)})),this.rctx.bindFramebuffer(r),this.rctx.setViewport(i.x,i.y,i.width,i.height),!a)return;this.rctx.bindVAO(this._quad);const l=this.rendererContext.pluginContext.techniques.get(d.HeatmapTechnique,this._configuration);this.rctx.bindTechnique(l,e.bind,this._heatmapParameters),this.rctx.drawArrays(l.primitiveType,0,y.vertexCount(this._quad,"geometry"))}},t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"searchRadius",null),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"minDensity",null),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"maxDensity",null),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"fieldTotal",null),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"pixelRatio",void 0),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"colorRampData",null),t.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"dataType",void 0),t.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"samplingMode",void 0),t.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"pixelFormat",void 0),t.__decorate([s.property({constructOnly:!0})],e.DrapedHeatmapRenderer.prototype,"internalFormat",void 0),t.__decorate([s.property()],e.DrapedHeatmapRenderer.prototype,"_colorRampData",void 0),e.DrapedHeatmapRenderer=t.__decorate([l.subclass("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],e.DrapedHeatmapRenderer),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/HeatmapTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../../../../chunks/Heatmap.glsl","../../../webgl/enums","../../../webgl/NoParameters","../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends o.NoParameters{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class c extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(s.Heatmap,(()=>new Promise(((t,r)=>e(["./Heatmap.glsl"],t,r)))))),this.primitiveType=n.PrimitiveType.TRIANGLE_STRIP}initializePipeline(){return a.makePipelineState({blending:a.unpremultipliedAlphaToPremultipliedAlpha,colorWrite:a.defaultColorWrite,depthTest:null,depthWrite:null})}}t.HeatmapPassParameters=l,t.HeatmapTechnique=c,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/Heatmap.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/ScreenSpacePass.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Texture2DPassUniform","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n){"use strict";function o(e){const o=new n.ShaderBuilder;return o.include(t.ScreenSpacePass),o.fragment.uniforms.add(new s.Texture2DPassUniform("densityMap",(e=>e.densityMap)),new s.Texture2DPassUniform("tex",(e=>e.colorRamp)),new r.FloatPassUniform("densityNormalizer",(e=>1/(e.maxDensity-e.minDensity))),new r.FloatPassUniform("minDensity",(e=>e.minDensity)),new r.FloatPassUniform("densityMultiplier",(t=>3/(t.searchRadius*t.searchRadius*Math.PI)*(e.usesHalfFloat?4:1)))).main.add(i.glsl`float density = texture(densityMap, uv).r * densityMultiplier;
float densityRatio = (density - minDensity) * densityNormalizer;
fragColor = texture(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));`),o}const a=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}));e.Heatmap=a,e.build=o}))},"esri/views/3d/webgl-engine/shaders/HeatmapTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],(function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.usesHalfFloat=!1}}t.__decorate([r.parameter()],s.prototype,"usesHalfFloat",void 0),e.HeatmapTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/materials/HeatmapDensityMaterial":function(){define(["exports","../../../../core/libs/gl-matrix-2/math/vec2","../../../../core/libs/gl-matrix-2/factories/vec2f64","../../support/buffer/InterleavedLayout","../core/shaderLibrary/ShaderOutput","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/VertexAttribute","./internal/bufferWriterUtils","../shaders/HeatmapDensityTechnique","../shaders/HeatmapDensityTechniqueConfiguration"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h extends u.HeatmapDensityPassParameters{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloats=!1}}class p extends o.Material{constructor(e){super(e,h),this.produces=new Map([[a.RenderSlot.DRAPED_MATERIAL,e=>e===s.ShaderOutput.Color]]),this._configuration=new d.HeatmapDensityTechniqueConfiguration}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}get visible(){return!0}createGLMaterial(e){return new m(e)}intersect(){}intersectDraped(e,r,i,s,n){const o=e.attributes.get(l.VertexAttribute.POSITION),{parameters:a}=this,{searchRadius:c}=a,{screenToWorldRatio:u}=e,d=c*u+2*u,h=d*d,p=o.data.length/o.size;for(let e=0;e<p;e++){const r=e*o.size,a=t.set(b,o.data[r],o.data[r+1]);t.squaredDistance(a,i)<h&&s(n.distance,n.normal,-1)}}createBufferWriter(){return new f(this.parameters.isAttributeDriven?y:g)}}class m extends n{beginSlot(e){return this.getTechnique(u.HeatmapDensityTechnique,e)}}class f{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.get(l.VertexAttribute.POSITION).indices.length*_}write(e,t,r,i,s,n){c.writePosition(r.get(l.VertexAttribute.POSITION),e,s.position,n,_);const o=r.get(l.VertexAttribute.POSITION).indices.length,a=s.uv0;let u=n;for(let e=0;e<o;++e)a.setValues(u++,-1,-1),a.setValues(u++,1,-1),a.setValues(u++,1,1),a.setValues(u++,1,1),a.setValues(u++,-1,1),a.setValues(u++,-1,-1);const d=l.VertexAttribute.FEATUREATTRIBUTE in s?s.featureAttribute:null;return d?(c.writeBufferFloat(r.get(l.VertexAttribute.FEATUREATTRIBUTE),d,n,_),null):null}}const g=i.newLayout().vec3f(l.VertexAttribute.POSITION).vec2f16(l.VertexAttribute.UV0),y=g.clone().f32(l.VertexAttribute.FEATUREATTRIBUTE),_=6,b=r.create();e.HeatmapDensityMaterial=p,e.Parameters=h,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/HeatmapDensityTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/Material","../../../../chunks/HeatmapDensity.glsl","../../../webgl/renderState"],(function(e,t,r,i,s,n,o){"use strict";class a extends s.MaterialParameters{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.HeatmapDensity,(()=>new Promise(((t,r)=>e(["./HeatmapDensity.glsl"],t,r))))))}initializePipeline(){return o.makePipelineState({blending:o.add,colorWrite:o.defaultColorWrite,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}t.HeatmapDensityPassParameters=a,t.HeatmapDensityTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/HeatmapDensity.glsl":function(){define(["exports","../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl","../views/3d/webgl-engine/core/shaderModules/FloatPassUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/lib/VertexAttribute","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n){"use strict";function o(e){const o=new n.ShaderBuilder,{vertex:a,fragment:l,attributes:c,varyings:u}=o;t.addProjViewLocalOrigin(a,e);const{isAttributeDriven:d,usesHalfFloat:h}=e;return c.add(s.VertexAttribute.POSITION,"vec3"),c.add(s.VertexAttribute.UV0,"vec2"),d&&(c.add(s.VertexAttribute.FEATUREATTRIBUTE,"float"),u.add("attributeValue","float")),h&&l.constants.add("compressionFactor","float",.25),u.add("unitCirclePos","vec2"),a.uniforms.add(new r.FloatPassUniform("radius",(({resolutionForScale:e,searchRadius:t},{camera:r,screenToWorldRatio:i,overlayStretch:s})=>2*t*(0===e?1:e/i)*r.pixelRatio/r.fullViewport[2]/s))),a.main.add(i.glsl`
    unitCirclePos = uv0;

    vec4 posProj = proj * (view * vec4(${s.VertexAttribute.POSITION}, 1.0));
    vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

    ${d?i.glsl`attributeValue = ${s.VertexAttribute.FEATUREATTRIBUTE};`:""}
    gl_Position = posProj + quadOffset;
  `),l.main.add(i.glsl`
    float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
    if (radiusRatioSquared > 1.0) {
      fragColor = vec4(0.0);
    }
    else {
      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${d?i.glsl` * attributeValue`:""} ${h?i.glsl` * compressionFactor`:""};
      fragColor = vec4(density);
    }
  `),o}const a=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}));e.HeatmapDensity=a,e.build=o}))},"esri/views/3d/webgl-engine/shaders/HeatmapDensityTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],(function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloat=!1}}t.__decorate([r.parameter()],s.prototype,"isAttributeDriven",void 0),t.__decorate([r.parameter()],s.prototype,"usesHalfFloat",void 0),e.HeatmapDensityTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/webgl/heatmapTextureUtils":function(){define(["exports","../../core/Error","./enums"],(function(e,t,r){"use strict";class i{constructor(e,t,r,i){this.dataType=e,this.samplingMode=t,this.pixelFormat=r,this.internalFormat=i}}const s=new i(r.PixelType.HALF_FLOAT,r.TextureSamplingMode.NEAREST,r.PixelFormat.RGBA,r.PixelFormat.RGBA);e.HeatmapTextureConfiguration=i,e.fallBackHeatmapConfiguration=s,e.loadHeatmapTextureConfiguration=function(e,s){const{textureFloatLinear:n,colorBufferFloat:o}=e.capabilities,a=o?.textureFloat,l=o?.textureHalfFloat,c=o?.floatBlend,u=e.driverTest.floatBufferBlend.result;if(!a&&!l)throw new t("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(c&&u||l))throw new t("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(u?"":" This device claims support for EXT_float_blend, but does not actually support it."));const d=a&&c&&u,h=l,p=n,m=!!o?.R32F,f=!!o?.R16F;if(d&&p)return p||s.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new i(r.PixelType.FLOAT,p?r.TextureSamplingMode.LINEAR:r.TextureSamplingMode.NEAREST,m?r.PixelFormat.RED:r.PixelFormat.RGBA,m?r.SizedPixelFormat.R32F:r.PixelFormat.RGBA);if(h)return new i(r.PixelType.HALF_FLOAT,r.TextureSamplingMode.LINEAR,f?r.PixelFormat.RED:r.PixelFormat.RGBA,f?r.SizedPixelFormat.R16F:r.PixelFormat.RGBA);throw new t("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/FeatureTileFetcher3DContext":function(){define(["exports","../../../../core/maybe","./featureTileQuery3D"],(function(e,t,r){"use strict";function i(e){const t=e.capabilities.query;return{supportsMultipleResolutions:s(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function s(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}e.FeatureTileFetcher3DContext=class{constructor(e){this._memoryCache=null;const t=e.layerView.layer;this._layerView=e.layerView,this.objectIdField=t.objectIdField,this.globalIdField="globalIdField"in t?t.globalIdField:null,this._returnZ=e.returnZ,this._returnM=e.returnM;const i=this._layerView.view.resourceController;this.query=r.createFeatureTileQuery3D(this._layerView,i.normal),i&&this._memoryCacheEnabled&&(this._memoryCache=i.memoryController.newCache(`fl-${t.uid}`))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"parquet":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=t.destroyMaybe(this._memoryCache),this.query.destroy()}createQuery(){const e=this._layerView.layer.createQuery();return e.outFields=this._layerView.availableFields,e.returnZ=this._returnZ,e.returnM=this._returnM,e.outSpatialReference=this.tilingScheme.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles.tilingScheme}get scheduler(){return this._layerView.view.resourceController?.scheduler}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get standardMaxRecordCount(){return this._layerView.layer.capabilities.query.standardMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get isDraped(){return"on-the-ground"===this._layerView.layer.elevationInfo?.mode}get effectiveDisplayFilter(){return this._layerView.displayFilterEnabled?this._layerView.effectiveDisplayFilter:null}get capabilities(){return this._capabilities??=i(this._layerView.layer),this._capabilities}logFetchError(e,t){e.error("#fetchTile()",this._layerView.layer,t?.message??t)}},e.contextCapabilitiesFromLayer=i,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/featureTileQuery3D":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/SetUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/dehydratedFeatures","../../../../rest/query/operations/query","../../support/PBFDecoder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";let m=class extends r{constructor(e){super(e)}get implicitFields(){const e=this.layer.outFields?.includes("*");if(!e)return new Set;const t=new Set(this.layerView.requiredFields),r=new Set(this.layerView.availableFields);return n.difference(r,t)}get queryFeaturesDehydrated(){const{layer:e}=this,t=e.capabilities,r=t&&t.query,i=r&&r.supportsFormatPBF,n=e.parsedUrl;if(i){null==this._decoder&&(this._decoder=new p.PBFDecoder(this.controller));const t={sourceSpatialReference:e.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:y};return(e,r)=>h.runQuery(n,e,"pbf",this._createRequestOptions(r)).then((e=>(s.throwIfAborted(r),null!=this._decoder?this._decoder.invoke({buffer:e.data,options:t},r.signal):Promise.reject(s.createAbortError()))))}return(t,r)=>h.executeQuery(n,t,e.spatialReference,this._createRequestOptions(r)).then((e=>d.fromFeatureSetJSON(e.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:y})))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}destroy(){this._decoder=i.destroyMaybe(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...e?.query}}}};t.__decorate([o.property({constructOnly:!0})],m.prototype,"layer",void 0),t.__decorate([o.property({constructOnly:!0})],m.prototype,"layerView",void 0),t.__decorate([o.property({constructOnly:!0})],m.prototype,"controller",void 0),t.__decorate([o.property({readOnly:!0})],m.prototype,"implicitFields",null),t.__decorate([o.property({readOnly:!0})],m.prototype,"queryFeaturesDehydrated",null),m=t.__decorate([u.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],m);let f=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}};t.__decorate([o.property({constructOnly:!0})],f.prototype,"layer",void 0),f=t.__decorate([u.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileOGCServiceQuery3D")],f);let g=class extends r{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.source.queryFeaturesJSON(e,t).then(d.fromFeatureSetJSON,(r=>{if(r&&"query-features-json:unsupported"===r.name)return this.layer.queryFeatures(e,t);throw r}))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};t.__decorate([o.property({constructOnly:!0})],g.prototype,"layer",void 0),t.__decorate([o.property({constructOnly:!0})],g.prototype,"source",void 0),g=t.__decorate([u.subclass("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],g);const y=1024;e.createFeatureTileQuery3D=function(e,t){const{layer:r}=e;return"feature"===r.type&&"feature-layer"===r.source.type||"catalog-footprint"===r.type?new m({layer:r,layerView:e,controller:t}):"feature"===r.type&&"memory"===r.source.type||"csv"===r.type||"geojson"===r.type||"oriented-imagery"===r.type||"wfs"===r.type?new g({layer:r,source:r.source}):"ogc-feature"===r.type?new f({layer:r}):null},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/PBFDecoder":function(){define(["exports","../../../core/uid","../../../core/workers/WorkerHandle","../../../geometry/SpatialReference","../../../layers/support/Field"],(function(e,t,r,i,s){"use strict";function n(e){switch(e.type){case"polyline":e.paths=e.hasZ&&e.hasM?e.paths.map((e=>e.map((e=>[e[0],e[1],e[2],e[3]])))):e.hasZ||e.hasM?e.paths.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.paths.map((e=>e.map((e=>[e[0],e[1]]))));break;case"polygon":e.rings=e.hasZ&&e.hasM?e.rings.map((e=>e.map((e=>[e[0],e[1],e[2],e[3]])))):e.hasZ||e.hasM?e.rings.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.rings.map((e=>e.map((e=>[e[0],e[1]]))))}}class o extends r.WorkerHandle{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},e)}}e.PBFDecoder=class{constructor(e){this._controller=e,this._handle=new o((t=>e.schedule(t)))}destroy(){this._handle.destroy()}invoke(e,r){return e.buffer&&0!==e.buffer.byteLength?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof i&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,r).then((e=>{let r=0,o=0;const a=i.fromJSON(e.spatialReference);e.spatialReference=a;const l=async i=>{const c=e.fields;if(c)for(;r<c.length;)if(c[r]=s.fromJSON(c[r]),r++,i.madeProgress())return this._controller.reschedule((e=>l(e)));const u=e.features;for(;o<u.length;){const e=u[o];++o,e.uid=t.generateUID();const r=e.geometry;if(null!=r&&(r.spatialReference=a,n(r),i.madeProgress()))return this._controller.reschedule((e=>l(e)))}return e};return this._controller.schedule((e=>l(e)))}))):Promise.resolve(null)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/EventedSet":function(){define(["exports","../../../core/Evented","../../../core/ObservableChangesType","../../../core/signal"],(function(e,t,r,i){"use strict";e.EventedSet=class extends t{constructor(){super(...arguments),this._set=new Set,this._length=i.signal(0)}clear(){if(this._set.size>0){const e=this.toArray();this._set.clear(),this.emit("after-changes",{type:r.ObservableChangesType.REMOVE}),this.emit("change",{added:[],removed:e})}}get length(){return this._length.value}addMany(e){if(0!==e.length){for(const t of e)this._set.add(t);this._length.value=this._set.size,this.emit("after-changes",{type:r.ObservableChangesType.ADD}),this.emit("change",{added:e,removed:[]})}}remove(e){this._set.delete(e)&&(this._length.value=this._set.size,this.emit("after-changes",{type:r.ObservableChangesType.REMOVE}),this.emit("change",{added:[],removed:[e]}))}removeMany(e){const t=[];for(const r of e)this._set.delete(r)&&t.push(r);t.length>0&&(this._length.value=this._set.size,this.emit("after-changes",{type:r.ObservableChangesType.REMOVE}),this.emit("change",{added:[],removed:t}))}toArray(){return Array.from(this._set.values())}find(e){for(const t of this._set.values())if(e(t))return t}some(e){for(const t of this._set.values())if(e(t))return!0;return!1}forEach(e){this._set.forEach((t=>e(t)))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/layers/FeatureLayerView":function(){define(["../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/sql","../../core/accessorSupport/decorators/property","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/graphics/data/FeatureIdInfo","../../layers/knowledgeGraph/constants","../../layers/support/displayFilterUtils","../../layers/support/FeatureEffect","../../layers/support/FeatureFilter","../../layers/support/featureLayerUtils","../../layers/support/featurePopupQueryUtils","../../layers/support/fieldUtils","../../layers/support/floorFilterUtils","../../networks/support/networkFieldUtils","../../rest/support/Query","../2d/layers/features/layerAdapters/featureServiceUtils","./support/popupUtils","./support/WhereClauseVisitor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w){"use strict";return t=>{let a=class extends t{constructor(...e){super(...e),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([s.watch((()=>{const e=this.layer,t=this.view;return[e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,t?.requiredFieldsOptions?.featureTitleFields&&e&&"featureTitleFields"in e&&e.featureTitleFields,t?.requiredFieldsOptions?.utilityNetworkFields&&_.getUtilityNetworkFields(t,e),e.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,"knowledge-graph-sublayer"===e?.type&&"link-chart"===e.parentCompositeLayer.type&&e.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode,"parquet"===e?.type&&e.popupTemplate]}),(()=>this._handleChange()),s.syncAndInitial),s.on((()=>this.view?.floors),"change",(()=>this._handleChange())),s.on((()=>this.layer.displayFilterInfo?.filters),"change",(()=>this._handleChange())),s.on((()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null),"change",(()=>this._handleChange()))])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?g.fixFields(t,[...g.unpackFieldNames(t,e.outFields),...r]):g.fixFields(t,r)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const e=this.layer;return this.displayFilterEnabled&&e.displayFilterInfo?d.getEffectiveDisplayFilter(e.displayFilterInfo,this.view):null}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){r.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?m.getSignedInUser(this.layer.url):Promise.resolve(null)}highlight(e,t){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new b(e);return"floorInfo"in this.layer&&this.layer.floorInfo&&(t.where=n.sqlAnd(t.where,y.getFloorFilterClause(this))),this.displayFilterEnabled&&(t.where=n.sqlAnd(t.where,this.effectiveDisplayFilter?.where)),null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new b(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){const r=await this._createPopupQuery(e.map((e=>e.origin?.layer??e.layer)),t);return await f.fetchFeaturePopupFeatures(this.layer,e,r,{getPopupTemplate:e=>e&&"popupEnabled"in e&&e.popupEnabled?S.getFetchPopupTemplate(e,t):null,hasRequiredFields:(e,t)=>this._popupFeatureHasRequiredFields(e,t),...t})}_handleChange(){const e=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then((()=>{}));return this._set("_updatingRequiredPromise",e),e.then((()=>{this._updatingRequiredPromise===e&&this._set("_updatingRequiredPromise",null)})),e}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:e}=this,t=new w.WhereClauseVisitor(e.fieldsIndex);if(t.visitFilter(this.filter),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction),"labelingInfo"in e&&t.visitLabelingInfo(e.labelsVisible,e.labelingInfo),"trackInfo"in e&&t.visitTrackInfo(e.trackInfo),"2d"===this.view.type&&(t.visitFilter(this.featureEffect?.filter),t.visitDisplayFilter(this.displayFilterEnabled,e.displayFilterInfo),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction)),"subtype-group"===e.type)for(const r of e.sublayers)t.visitLabelingInfo(r.labelsVisible,r.labelingInfo);try{const e=await t.finish();this._set("requiresCurrentUser",e.requiresCurrentUser)}catch(e){r.getLogger(this).error(e)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:i}}=this,s="renderer"in t&&t.renderer,n="orderBy"in t&&t.orderBy,o="featureReduction"in t?t.featureReduction:null,a=new Set,l=[s?s.collectRequiredFields(a,i):null,g.collectLabelingFields(a,t),e&&"elevationInfo"in t?g.collectElevationFields(a,t):null,null!=this.filter?g.collectFilterFields(a,t,this.filter):null,e||null==this.featureEffect?null:g.collectFilterFields(a,t,this.featureEffect.filter),!e&&o?g.collectFeatureReductionFields(a,t,o):null,!e&&n?g.collectOrderByInfos(a,t,n):null];if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&g.collectFields(a,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"timeInfo"in t&&t.timeInfo&&"trackInfo"in t&&t.trackInfo){const{trackInfo:e}=t;g.collectFields(a,t.fieldsIndex,[t.timeInfo.trackIdField]),"feature"!==t.type&&"startTimeField"!==e.timeField||g.collectFields(a,t.fieldsIndex,[t.timeInfo.startField]),"endTimeField"===e.timeField&&g.collectFields(a,t.fieldsIndex,[t.timeInfo.endField]),await g.collectTrackInfoFields(a,t)}if("floorInfo"in t&&t.floorInfo&&g.collectFields(a,t.fieldsIndex,[t.floorInfo.floorField]),"featureTitleFields"in t&&this.view?.requiredFieldsOptions?.featureTitleFields&&t.featureTitleFields&&g.collectFields(a,t.fieldsIndex,t.featureTitleFields),"feature"===t.type&&t.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&g.collectFields(a,t.fieldsIndex,[t.globalIdField]),this.displayFilterEnabled&&l.push(g.collectDisplayFilterFields(a,t,t.displayFilterInfo)),"feature"===t.type&&e&&null!=t.infoFor3D&&(null==t.globalIdField&&r.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),g.collectFields(a,t.fieldsIndex,[t.globalIdField])),"subtype-group"===t.type){g.collectField(a,i,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(a,i),g.collectLabelingFields(a,e)])));l.push(Promise.all(e))}if("catalog-footprint"===t.type&&t.parent){const e=t.parent;g.collectFields(a,i,[e.itemNameField,e.itemSourceField,e.itemTypeField,e.maxScaleField,e.minScaleField])}"knowledge-graph-sublayer"===t.type&&"link-chart"===t.parentCompositeLayer.type&&g.collectField(a,i,u.systemIsSpatialFieldName),"parquet"===t.type&&l.push(S.getRequiredFields(t,t.popupTemplate).then((e=>{for(const t of e)a.add(t)})));const d=await Promise.allSettled(l);if(e)g.collectField(a,i,t.objectIdField);else for(const e of c.getFeatureIdInfoFieldNames(v.createFeatureIdInfo(t)))g.collectField(a,i,e);e&&"displayField"in t&&t.displayField&&g.collectField(a,i,t.displayField);for(const e of d)"rejected"===e.status&&r.getLogger(this).error(e.reason);const h=Array.from(a).sort();this._set("requiredFields",h)}_popupFeatureHasRequiredFields(e,t){return g.featureHasFields(e,t)}async _createPopupQuery(e,t){const r=this.layer.createQuery(),s=new Set;let o=!1;const a=e??[this.layer];for(const e of a){if(!("popupEnabled"in e))continue;const r=S.getFetchPopupTemplate(e,t);if(null==r)continue;const n=await f.loadFeaturePopupArcadeModules(r);i.throwIfAborted(t);const a=n&&n.arcadeUtils.hasGeometryOperations(r);o=!("point"!==this.layer.geometryType&&!a);const l=await S.getRequiredFields(this.layer,r);i.throwIfAborted(t);for(const e of l)s.add(e)}return r.returnGeometry=o,r.returnZ=o,r.returnM=o,r.outFields=Array.from(s),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(r.where=n.sqlAnd(r.where,y.getFloorFilterClause(this))),r}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}getTest(){}get test(){}};return e.__decorate([o.property()],a.prototype,"_updatingRequiredPromise",void 0),e.__decorate([o.property({readOnly:!0})],a.prototype,"availableFields",null),e.__decorate([o.property({readOnly:!0})],a.prototype,"displayFilterEnabled",null),e.__decorate([o.property({readOnly:!0})],a.prototype,"effectiveDisplayFilter",null),e.__decorate([o.property({type:h})],a.prototype,"featureEffect",null),e.__decorate([o.property({type:p})],a.prototype,"filter",void 0),e.__decorate([o.property()],a.prototype,"layer",void 0),e.__decorate([o.property({type:Number})],a.prototype,"maximumNumberOfFeatures",null),e.__decorate([o.property({readOnly:!0,type:Boolean})],a.prototype,"maximumNumberOfFeaturesExceeded",null),e.__decorate([o.property()],a.prototype,"requiresCurrentUser",void 0),e.__decorate([o.property({readOnly:!0})],a.prototype,"requiredFields",void 0),e.__decorate([o.property({readOnly:!0})],a.prototype,"signedInUser",null),e.__decorate([o.property()],a.prototype,"suspended",void 0),e.__decorate([o.property()],a.prototype,"view",void 0),a=e.__decorate([l.subclass("esri.views.layers.FeatureLayerView")],a),a}}))},"esri/layers/graphics/data/FeatureIdInfo":function(){define(["exports"],(function(e){"use strict";e.getFeatureIdInfoFieldNames=function*(e){switch(e.type){case"object-id":case"unique-id-simple":return void(yield e.fieldName);case"unique-id-composite":return void(yield*e.fieldNames)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/knowledgeGraph/constants":function(){define(["exports"],(function(e){"use strict";e.systemAggregationCountFieldName="ESRI__AggregationCount",e.systemDestinationIdFieldName="ESRI__DestID",e.systemIsSpatialFieldName="LC.ESRI__IsSpatial",e.systemLayoutGeometryFieldName="ESRI__LayoutGeometry",e.systemOidFieldName="ESRI__ID",e.systemOriginIdFieldName="ESRI__OriginID",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/networks/support/networkFieldUtils":function(){define(["exports"],(function(e){"use strict";e.getAssociationsTableFields=function(e){const t=e?.fieldsIndex,r="fromnetworksourceid",i="fromglobalid",s="fromterminalid",n="tonetworksourceid",o="toglobalid",a="toterminalid",l="status",c="associationtype",u="iscontentvisible",d="percentalong",h="globalid";return{fromNetworkSourceId:t?.get(r)?.name??r,fromGlobalId:t?.get(i)?.name??i,fromTerminalId:t?.get(s)?.name??s,toNetworkSourceId:t?.get(n)?.name??n,toGlobalId:t?.get(o)?.name??o,toTerminalId:t?.get(a)?.name??a,status:t?.get(l)?.name??l,associationType:t?.get(c)?.name??c,isContentVisible:t?.get(u)?.name??u,percentAlong:t?.get(d)?.name??d,globalId:t?.get(e?.globalIdField??h)?.name??h}},e.getUtilityNetworkFields=function(e,t){if("feature"!==t.type&&"subtype-group"!==t.type)return[];if(!t.url)return[];const r="utilityNetworks"in e.map?e.map.utilityNetworks??[]:[];for(const e of r)if(e.isUtilityLayer(t)){const e=t.fieldsIndex.get("assetgroup"),r=t.fieldsIndex.get("assettype");return[e?.name,r?.name].filter((e=>null!=e))}return[]},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/layers/support/WhereClauseVisitor":function(){define(["exports","../../../core/sql"],(function(e,t){"use strict";e.WhereClauseVisitor=class{constructor(e){this._fieldsIndex=e,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some((e=>e.currentUserRequired))}}visitClientWhereClause(e){e&&this._clauses.push(t.parseWhereClause(e,this._fieldsIndex))}visitFeatureReduction(e){if(e)switch(e.type){case"binning":case"cluster":this.visitLabelingInfo(e.labelsVisible,e.labelingInfo)}}visitLabelingInfo(e,t){if(e&&null!=t)for(const e of t)this.visitClientWhereClause(e.where)}visitDisplayFilter(e,t){if(e)for(const e of t?.filters??[])this.visitClientWhereClause(e.where)}visitFilter(e){this.visitClientWhereClause(e?.where)}visitTrackInfo(e){null!=e&&(this.visitLabelingInfo(e?.latestObservations.labelsVisible,e?.latestObservations.labelingInfo),this.visitLabelingInfo(e?.previousObservations.labelsVisible,e?.previousObservations.labelingInfo),this.visitLabelingInfo(e?.trackLines.labelsVisible,e?.trackLines.labelingInfo))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/layers/RefreshableLayerView":function(){define(["../../chunks/tslib.es6","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/has","../../core/RandomLCG","../../core/Error","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";return s=>{let n=class extends s{initialize(){this.addHandles(i.on((()=>this.layer),"refresh",(e=>{this.doRefresh(e.dataChanged).catch((e=>{r.isAbortError(e)||t.getLogger(this).error(e)}))})),"RefreshableLayerView")}};return n=e.__decorate([a.subclass("esri.views.layers.RefreshableLayerView")],n),n}}))},"esri/views/3d/layers/PointCloudLayerView3D":function(){define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/arrayUtils","../../../core/asyncUtils","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/memoryEstimations","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/screenUtils","../../../core/typedArrayUtil","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/Extent","../../../geometry/Point","../../../geometry/projection/projectBoundingSphere","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/plane","../../../chunks/sphere","../../../layers/graphics/OptimizedGeometry","../../../layers/graphics/data/QueryEngine","../../../layers/support/CodedValue","../../../layers/support/CodedValueDomain","../../../layers/support/Domain","../../../layers/support/InheritedDomain","../../../layers/support/RangeDomain","../../../layers/support/fieldUtils","../../../layers/support/PromiseQueue","../../../rest/support/FeatureSet","../../../rest/support/Query","../../../support/elevationInfoUtils","./II3SMeshView3D","./LayerView3D","./PointCloudLayerViewPerformanceInfo","./PointCloudWorkerHandle","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./i3s/LoDUtil","./i3s/PagedNodeIndex","./i3s/PointCloudGraphic","./i3s/PointCloudRenderer","./i3s/PointCloudRendererNode","./i3s/PointCloudRendererUtil","./i3s/PointCloudWorkerUtil","./support/highlightUtils","./support/PopupSceneLayerView","../support/extentUtils","../support/hitTest","../support/index","../support/orientedBoundingBox","../support/updatingProperties","../../layers/LayerView","../../layers/PointCloudLayerView","../../support/HighlightDefaults","../../support/layerViewUtils","../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z,Y,X,K,J,ee,te,re,ie,se,ne,oe){"use strict";const ae=w.create();let le=class extends(ie(Y.PopupSceneLayerView(U.LayerView3D(re)))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new I.PromiseQueue,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[],this.ignoresMemoryFactor=!1}get baseUrl(){return this.layer.parsedUrl?.path??""}get pointScale(){const e=$.getSplatSizeAlgorithm(this.layer?.renderer);return null!=e?.scaleFactor?e.scaleFactor:1}get useRealWorldSymbolSizes(){const e=$.getFixedSizeAlgorithm(this.layer?.renderer);return null!=e?.useRealWorldSymbolSizes&&e.useRealWorldSymbolSizes}get pointSize(){const e=$.getFixedSizeAlgorithm(this.layer?.renderer);return null!=e?.size?e.size:0}get inverseDensity(){return this.layer?.renderer?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const e=$.getRendererInfo(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.modulationAttribute.name);const r=$.getFilterInfo(this.layer);if(r)for(const e of r)e.attributeInfo&&t.add(e.attributeInfo.name);if(this.layer.outFields)for(const e of A.unpackFieldNames(this.layer.fieldsIndex,this.layer.outFields))t.add(e);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const e=S.create(),t=this.view.renderSpatialReference;return X.projectToBoundingBox(this.view.clippingArea,e,t)?e:null}get _elevationOffset(){const e=this.layer&&this.layer.elevationInfo;return e&&"absolute-height"===e.mode?L.getElevationOffset(e,this.layer.spatialReference):0}initialize(){const e=this.view.resourceController,t=function(e){return t=>e.immediate.schedule(t)}(e);this._worker=new B.PointCloudWorkerHandle(t),this.addResolvingPromise(this._worker.promise),k.checkPointCloudLayerValid(this.layer),k.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(J.ClientType.I3S_INDEX),this._dataRequester=e.createStreamDataRequester(J.ClientType.I3S_DATA),this._initRenderer();const r=this._initNodePages(),i=this.view.resourceController.memoryController;this._memCache=i.newCache(`pcl-${this.layer.uid}`),this._queryFeaturesCache=i.newCache(`pcl-query-features-${this.layer.uid};`),this._updatingHandles.add((()=>this._clippingBox),(()=>this._setUpdateViewNeeded()),c.initial),this._updatingHandles.add((()=>this._elevationOffset),(()=>this._elevationOffsetChanged()),c.initial),this._updatingHandles.add((()=>this.layer.renderer),(()=>this._rendererChanged()),c.initial),this._updatingHandles.add((()=>this.layer.filters),(()=>this._reload()),c.initial),this._updatingHandles.add((()=>this.layer.outFields),(()=>this._reload()),c.initial),this._updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this._setUpdateViewNeeded())),this._updatingHandles.add((()=>this.view.state.contentCamera),(()=>this._setUpdateViewNeeded())),this.addHandles([c.watch((()=>this.view.quality),(()=>this._setUpdateViewNeeded()),c.sync)]),this.addResolvingPromise(r),this.when((()=>{this.addHandles([e.scheduler.registerTask(oe.TaskPriority.POINT_CLOUD_LAYER,this),e.scheduler.registerIdleStateCallbacks((()=>this._idleBegin()),(()=>this._idleEnd())),this._updatingHandles.add((()=>this.suspended),(e=>{e?this._clearNodeState():this._setUpdateViewNeeded()}),c.initial)])}),(()=>{this._updatingHandles.removeAll(),this.removeAllHandles()}))}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=o.destroyMaybe(this._worker),this._destroyRenderer(),this._memCache=o.destroyMaybe(this._memCache),this._queryFeaturesCache=o.destroyMaybe(this._queryFeaturesCache),this._queryEngine=o.destroyMaybe(this._queryEngine),this._codedDomainPopulationAbortController=o.abortMaybe(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new H.PointCloudRenderer({createGraphic:(e,t,r)=>this._createGraphic(e,t,r)}),this._renderer.layerViewUid=this.uid,this._updatingHandles.add((()=>this._clippingBox),(e=>this._renderer.clippingBox=e),c.initial),this._updatingHandles.add((()=>this.suspended),(e=>this._setPointsVisible(!e)),c.initial),this._updatingHandles.add((()=>this.pointScale),(e=>this._renderer.scaleFactor=e),c.initial),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add((()=>this.useRealWorldSymbolSizes),(e=>this._renderer.useRealWorldSymbolSizes=e),c.initial),this._updatingHandles.add((()=>this.pointSize),(e=>{const t=u.pt2px(e);this._renderer.size=e,this._renderer.sizePx=t}),c.initial),this._updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._renderer.slicePlaneEnabled=e),c.initial),this._updatingHandles.add((()=>this.inverseDensity),(()=>this._setUpdateViewNeeded()),c.initial),this._updatingHandles.add((()=>this.maximumPointCount),(()=>this._setUpdateViewNeeded()),c.initial),this._updatingHandles.add((()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor),(e=>{this._lodFactor=e,this._setUpdateViewNeeded()}),c.initial)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(e,t,r,i){const s=null!=e.pointIdFilterMap?e.pointIdFilterMap[t]:t,n=r?"declaredClass"in r?r:K.computeMapPointFromVec3d(this.view,r):null;return i??=this._createGraphicAttributes(e,s),new q.PointCloudGraphic({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:s,epoch:this._nodeLoadEpoch},geometry:n,attributes:i,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(e,t){const r={};for(const i of e.attributes)this._encodeGraphicAttribute(i.attributeInfo,i.values,t,r);return r}_getGraphicAttribute(e,t,r){const i=e.storageInfo?.attributeValues,s=i?.valuesPerElement??1;if(1===s)return t[r];if("UInt8"===i?.valueType&&s<=4){let e=0;const i=r*s;for(let r=i;r<i+s;r++)e=(e<<8)+t[r];return e}}_encodeGraphicAttribute(e,t,r,i){i[e.name]=this._getGraphicAttribute(e,t,r)}_setPointsVisible(e){e&&!this._rendererAdded?(this.view.stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view.stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=$.rendererUsesFixedSizes(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_displayNodes(e){this._workQueue=z.nodeDiff([...this._renderedNodes],e,this._index),z.sortFrontToBack(this._workQueue,this.view.state.contentCamera.viewForward,this._index),z.splitWorkEntries(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const e=new Array;this._loadingNodes.forEach((({abortController:t})=>e.push(t))),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const e=new Set;this._workQueue.forEach((t=>t.load.forEach((t=>e.add(t)))));const t=new Array,r=new Map;this._loadingNodes.forEach(((i,s)=>{e.has(s)?r.set(s,i):t.push(i)})),this._loadingNodes=r;for(const{abortController:e}of t)e.abort();this._workQueue=this._workQueue.filter((e=>{for(const t of e.load)if(this._loadingNodes.has(t))return this._recalcWork=!0,!1;return!0})),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach((({abortController:e})=>e.abort())),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach((e=>this._removeFromRenderer(e))),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run((()=>this._updateWorkQueues()));this._indexQueue.length>0&&e.run((()=>this._processIndexQueue())););this._processWorkQueue(e),this._idleQueue.runTask(e)}}_processIndexQueue(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then((t=>{this._index.addPage(e,t,this._elevationOffset),this._setUpdateViewNeeded()})).then((()=>{this._indexPagesLoading.delete(e)}),(()=>{this._indexPagesLoading.delete(e)})),!0}_processWorkQueue(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(null==t)return void e.madeProgress();this._processWorkEntry(t),e.madeProgress()}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){const e=this._workQueue.shift();if(!e.remove.find((e=>!this._renderedNodes.has(e))))return e;this._workQueue.push(e)}return null}_processWorkEntry(e){if(0!==e.load.length)Promise.all(e.load.map((e=>{const t=new AbortController,r=this._memCache.pop(e.toString());return null!=r?this._loadingNodes.set(e,{abortController:t,promise:Promise.resolve(r)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:t,promise:this._loadNode(e,t.signal)}),this._loadingNodes.get(e).promise}))).then((t=>{for(let r=0;r<e.load.length;r++)if(t[r]){const i=this._setupRendererData(e.load[r],t[r]);this._addToRenderer(i)}for(const t of e.remove)this._removeFromRenderer(t)})).catch((()=>{})).then((()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&!this._idleQueue.updating&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())})),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)}async _populateClassCodeCodedDomain(e,t){const r="CLASS_CODE",s=this.layer.fieldsIndex.get(r);if(!s||s.domain)return;if(!e.includes(s.name))return;const n=await i.result(this.layer.queryCachedStatistics(r,{signal:t}));if(!1===n.ok)return;const o=n.value?.stats?.labels?.labels;o&&Array.isArray(o)&&(s.domain=new M({name:"CLASS_CODE",codedValues:o.map((e=>new P.CodedValue({code:e.value,name:e.label})))}))}async prepareFetchPopupFeatures(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then((()=>{this._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise}async whenGraphicAttributes(e,t){const s=this._splitGraphicsPerNode(e),n=this.layer.attributeStorageInfo,o=t.map((e=>$.getAttributeInfo(n,e))).filter(r.isSome),a=async(e,t)=>{const r=this._index.getNode(t);await i.forEach(o,(async t=>{const i=t.useElevation?await this._loadElevationAttributeFromGeometry(r.resourceId):await this._loadAndParseAttribute(r,t);if(i)for(const r of e)if(this._isValidPointGraphic(r)){const e=r.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(t,i,e,r.attributes)}}))},l=[];return s.forEach(((e,t)=>{l.push(a(e,t))})),await Promise.allSettled(l),e}_isValidPointGraphic(e){return e instanceof q.PointCloudGraphic&&e.pointCloudMetadata?.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){const t=new Map;for(const r of e){if(!this._isValidPointGraphic(r))continue;const e=r.pointCloudMetadata,i=t.get(e.nodeId);i?i.push(r):t.set(e.nodeId,[r])}return t}async _loadAndParseAttribute(e,t){const r=await this._loadAttribute(e.resourceId,t,null);return r?Q.getAttributeValues({attributeInfo:t,buffer:r},null,e.vertexCount):null}async _loadElevationAttributeFromGeometry(e){const t=this.layer.store.defaultGeometrySchema,r=Q.readGeometry(t,await this._loadGeometry(e,null));return Q.elevationFromPositions(r,r.length/3)}highlight(e,r){if(!e||e instanceof F)return Z.emptyHighlightHandle;const i=Z.normalizeHighlightTargetExceptQuery(e);if(0===i.length)return Z.emptyHighlightHandle;if(!(i[0]instanceof t))return Z.emptyHighlightHandle;const s=i;return this._renderer.highlight(s.map((e=>this._graphicToPointDefinition(e))),r?.name??se.defaultHighlightName)}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:r}=e.pointCloudMetadata;return null!=t&&null!=r?{nodeId:t,pointId:r}:null}_computeWork(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}get visibleAtCurrentScale(){return ne.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale)}async queryFeatures(e,r){const i=await this._ensureQueryEngine().executeQuery(this._ensureQueryJSON(e),r?.signal),s=i.features;i.features=[];const n=D.fromJSON(i),o=this.view.spatialReference;return n.features=s.map((e=>{const{attributes:r,metadata:i}=e;if(!i){const r=t.fromJSON(e);return r.geometry&&(r.geometry.spatialReference=n.spatialReference??o),r}const s=_.fromJSON(e.geometry);return s.spatialReference=n.spatialReference??o,this._createGraphic(i.node,i.pointId,s,r)})),n}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference,returnZ:!0};return new F(e)}async queryFeatureCount(e,t){return await this._ensureQueryEngine().executeQueryForCount(this._ensureQueryJSON(e),t?.signal)}async queryExtent(e,t){const{count:r,extent:i}=await this._ensureQueryEngine().executeQueryForExtent(this._ensureQueryJSON(e),t?.signal);return{count:r,extent:y.fromJSON(i)}}_ensureQueryJSON(e){return null==e?new F({outSpatialReference:this.view.spatialReference}).toJSON():F.from(e).toJSON()}_ensureQueryEngine(){if(this._queryEngine)return this._queryEngine;const{spatialReference:e}=this.view;return this._queryEngine=new C.QueryEngine({fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:"esriGeometryPoint",spatialReference:e,featureIdInfo:{type:"object-id",fieldName:"objectId"},hasZ:!0,featureStore:new G.I3SQueryFeatureStore({sourceSpatialReference:e,viewSpatialReference:e,forAllFeatures:(e,t)=>{let r=!1;this._renderer.forEachNode((i=>{if(r)return;if(t){const e=i.obb,s=x.fromValues(e.center[0],e.center[1],e.center[2],m.length(e.halfSize));b.projectBoundingSphere(s,this.view.renderSpatialReference,s,this.view.spatialReference);const n=t(s);if(n===N.ForAllFeaturesReturnType.SKIP)return;if(r=n===N.ForAllFeaturesReturnType.EXIT,r)return}let s=this._queryFeaturesCache.get(`${i.id}`);s||(s=this._createQueryPointFeatures(i),this._queryFeaturesCache.put(`${i.id}`,s)),s.features.forEach(e)}))},getFeatureExtent:({point:e},t)=>S.fromMinMax(e,e,t),featureAdapter:{cloneWithGeometry:(e,t)=>new ue(e.node,e.pointId,t.coords),getAttribute:({node:e,attributePointId:t},r)=>{for(const i of e.attributes)if(i.attributeInfo.name===r)return this._getGraphicAttribute(i.attributeInfo,i.values,t)},getAttributes:({node:e,attributePointId:t})=>this._createGraphicAttributes(e,t),getCentroid:e=>e.getGeometry(),getGeometry:e=>e.getGeometry(),getObjectId:()=>{},getMetadata:e=>e}})}),this._queryEngine}_createQueryPointFeatures(e){const t=e.coordinates,r=new Array;for(let i=0;i<t.length/3;i++){const s=3*i,n=g.fromValues(t[s+0],t[s+1],t[s+2]);m.add(n,n,e.origin),v.projectVectorToVector(n,this.view.renderSpatialReference,n,this.view.spatialReference);const o=new ue(e,i,n);r.push(o)}return new de(r)}_initNodePages(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new j.PagedNodeIndex(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then((e=>{this._index.addPage(0,e,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()}))}_loadNodePage(e){const t=new AbortController,r=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(r,t.signal).then((t=>t.nodes.map(((t,r)=>({resourceId:null!=t.resourceId?t.resourceId:e*this._index.pageSize+r,obb:ee.Obb.fromJSON(t.obb),obbInRenderSR:new ee.Obb,firstChild:t.firstChild,childCount:t.childCount,vertexCount:t.vertexCount??t.pointCount,lodThreshold:t.lodThreshold??t.effectiveArea}))))),abortController:t}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;const e=this.view.quality;let t=this.inverseDensity/this._lodFactor*e;const r=this.maximumPointCount*this._lodFactor*e;let i=this._computeNodesForMinimumDensity(t),s=this._computePointCount(i),n=Math.sqrt(s/(.75*r));for(;s>r;)t*=n,i=this._computeNodesForMinimumDensity(t),s=this._computePointCount(i),n=Math.sqrt(2);return this._displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let r=0;r<e.length;r++){const i=this._index.getNode(e[r]);i&&(t+=i.vertexCount)}return t}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,r,i)=>(e=i,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){const t=this.view.state.contentCamera,r=t.frustum,i=this._clippingBox,s=t.viewForward,n=m.dot(s,t.eye),o=w.fromNormalAndOffset(s,-n,ae),a=t.perScreenPixelRatio/2,l=e*e,c=this._nodeIdArray;c.length=0;const u=e=>c.push(e);return this._traverseVisible({frustum:r,clippingBox:i},{predicate:(e,t,r)=>{if(!r)return!1;if(0===t.childCount)return u(e),!1;const i=this._index.getRenderObb(e);return!(this._computeAveragePixelArea(i,t.lodThreshold,t.vertexCount,o,a)<=l&&(u(e),1))},pageMiss:(e,t)=>{u(e),this._indexQueue.includes(t)||this._indexQueue.push(t)}}),c}_computeAveragePixelArea(e,t,r,i,s){const n=Math.max(1e-7,e.minimumDistancePlane(i));return t/(n*n)/(4*s*s)/r}_loadNode(e,t){try{return this._loadNodeAsync(e,t)}catch(e){throw l.isAbortError(e)||n.getLogger(this).error(e),e}}async _loadAdditionalUserAttributes(e,t,i){const s=this.layer.outFields;if(!s)return[];const n=A.unpackFieldNames(this.layer.fieldsIndex,s),o=new Set(e.map((e=>null!=e?e.name:null))),a=this.layer.attributeStorageInfo,c=[];for(const e of n){if(o.has(e))continue;const r=$.getAttributeInfo(a,e);r&&c.push(t(r))}const u=await l.allSettledValues(c);return l.throwIfAborted(i),u.filter(r.isSome)}async _loadNodeAsync(e,t){const r=this._index.getNode(e),i=$.getRendererInfo(this.layer),s=$.getFilterInfo(this.layer),n=r.resourceId,o=async e=>{if(!e)return null;if(e.useElevation)return{attributeInfo:e,buffer:null};const r=await this._loadAttribute(n,e,t);return null!=r?{attributeInfo:e,buffer:r}:null};return this._idleQueue.push((async()=>{const r=this._loadGeometry(n,t),{primaryAttribute:a,modulationAttribute:c}=i,u=o(a),d=o(c),h=s.map((e=>e.attributeInfo)),p=h.map((e=>o(e))),m=this._loadAdditionalUserAttributes([a,c,...h],o,t),[f,g,y,_,b]=await Promise.all([r,u,d,Promise.all(p),m]);l.throwIfAborted(t);const v={geometryBuffer:f,primaryAttributeData:g,modulationAttributeData:y,filterAttributesData:_,userAttributesData:b,schema:this.layer.store.defaultGeometrySchema,rendererInfo:i,filterInfo:s,obbData:this._index.getRenderObb(e).data,elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(v,t)}),t)}async _loadGeometry(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)}async _loadAttribute(e,t,r){if(!t?.storageInfo)return null;const i=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${i}`,r)}_requestNodePage(e,t){const r={f:"json",...this.layer.customParameters,token:this.layer.apiKey};return this._indexRequester.request(e,"json",{query:r,signal:t})}_requestData(e,t){return this._dataRequester.request(e,"binary",{query:{...this.layer.customParameters,token:this.layer.apiKey},signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._memCache.put(t.id.toString(),t)}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}_setupRendererData(e,t){const r=this._index.getNode(e),i=Math.sqrt(r.lodThreshold/r.vertexCount),s=this._index.getRenderObb(e);if(W.isPointRendererNode(t))return t.splatSize=i,t.obb=s,m.copy(t.origin,t.obb.center),t;const o=ee.Obb.fromData(t.obbData),a=o.halfSize,l=s.halfSize,c=.01*Math.max(l[0],l[1],l[2]);if(a[0]>l[0]+c||a[1]>l[1]+c||a[2]>l[2]+c){if(this._maxLoggedBoxWarnings>0){const t=e=>`[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;n.getLogger(this).warn(`Node ${e} reported bounding box too small. got ${t(s)} but points cover ${t(o)}`),0===--this._maxLoggedBoxWarnings&&n.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,o)}return new W.PointCloudRendererNode(e,i,f.clone(s.center),s,0===r.childCount,t.points,t.rgb,t.attributes,t.pointIdFilterMap)}get usedMemory(){let e=0;return this._renderer.forEachNode((t=>{e+=he,e+=a.estimateNumberArrayMemory(t.coordinates);for(const r of t.attributes){const t=r.values;d.isArrayBuffer(t.buffer)&&(e+=a.estimateNumberArrayMemory(t))}})),e}get unloadedMemory(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount));let r=this._loadingNodes.size;for(let e=0;e<this._workQueue.length;e++)r+=this._workQueue[e].load.length,r-=this._workQueue[e].remove.length;return r<0?0:r*t/e*((this.usedMemory-e*he)/t)+r*he}get performanceInfo(){return new V.PointCloudLayerViewPerformanceInfo(this.usedMemory,this._renderedNodes.size,[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount),0),this.maximumPointCount,new V.QueuePerformanceInfo(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}get test(){}};e.__decorate([h.property()],le.prototype,"layer",void 0),e.__decorate([h.property()],le.prototype,"baseUrl",null),e.__decorate([h.property()],le.prototype,"pointScale",null),e.__decorate([h.property()],le.prototype,"useRealWorldSymbolSizes",null),e.__decorate([h.property()],le.prototype,"pointSize",null),e.__decorate([h.property()],le.prototype,"inverseDensity",null),e.__decorate([h.property()],le.prototype,"maximumPointCount",void 0),e.__decorate([h.property({readOnly:!0})],le.prototype,"availableFields",null),e.__decorate([h.property({readOnly:!0})],le.prototype,"_clippingBox",null),e.__decorate([h.property({readOnly:!0})],le.prototype,"_elevationOffset",null),e.__decorate([h.property({type:Boolean})],le.prototype,"slicePlaneEnabled",void 0),e.__decorate([h.property()],le.prototype,"updating",void 0),e.__decorate([h.property(te.updatingProgress)],le.prototype,"updatingProgress",void 0),e.__decorate([h.property({readOnly:!0})],le.prototype,"updatingProgressValue",null),e.__decorate([h.property({readOnly:!0})],le.prototype,"visibleAtCurrentScale",null),le=e.__decorate([p.subclass("esri.views.3d.layers.PointCloudLayerView3D")],le);const ce=le;class ue{constructor(e,t,r){this.node=e,this.pointId=t,this.point=r}getGeometry(){return new T([1],Array.from(this.point))}get attributePointId(){const{node:e,pointId:t}=this;return null!=e.pointIdFilterMap?e.pointIdFilterMap[t]:t}get usedMemory(){return a.baseObjectMemory+a.baseObjectMemory+a.estimateNumberMemory+a.estimateFixedArrayMemory(this.point,a.estimateNumberMemory)}}class de{constructor(e){this.features=e}get cachedMemory(){return this.features.reduce(((e,t)=>e+t.usedMemory),a.baseObjectMemory+a.baseArrayMemory)}}const he=160;return ce}))},"esri/geometry/projection/projectBoundingSphere":function(){define(["exports","../../core/mathUtils","../../core/libs/gl-matrix-2/factories/vec3f64","./projectors","../support/Ellipsoid"],(function(e,t,r,i,s){"use strict";function n(e,t,r,i){const s=i+t;if(s<i/2||r>s)return Number.MAX_VALUE;const n=Math.abs(a*e)+Math.asin(r/s);return n>=Math.PI/2?Number.MAX_VALUE:r/Math.cos(n)}const o=r.create(),a=t.deg2rad(1);e.projectBoundingSphere=function(e,t,r,a){if(null==t||null==a)return!1;const l=i.getProjectorClassification(t,a);if(null==l?.projector)return!1;if(l.projector===i.copy3)return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],!0;const{source:c,dest:u,projector:d}=l;if(u.spatialReferenceId===i.ProjectionID.WEB_MERCATOR){const t=i.projectionTable[c.spatialReferenceId][i.ProjectionID.WGS84];return null!=t&&(t(e,0,o,0),i.wgs84ToWebMercator(o,0,r,0),r[3]=n(o[1],e[2],e[3],s.earth.radius),!0)}if(c.spatialReferenceId!==i.ProjectionID.WGS84&&c.spatialReferenceId!==i.ProjectionID.CGCS2000||u.spatialReferenceId!==i.ProjectionID.PLATE_CARREE){d(e,0,r,0);const t=c.metersPerUnit??1,i=u.metersPerUnit??1;r[3]=e[3]*t/i}else{const t=i.projectionTable[c.spatialReferenceId][i.ProjectionID.SPHERICAL_ECEF],o=i.projectionTable[i.ProjectionID.SPHERICAL_ECEF][i.ProjectionID.PLATE_CARREE];let a=e[3];null!=t&&null!=o&&(a=n(e[1],e[2],e[3],s.earth.radius)),d(e,0,r,0),r[3]=a}return!0},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/II3SMeshView3D":function(){define(["exports"],(function(e){"use strict";var t,r,i;e.ForAllFeaturesMode=void 0,(t=e.ForAllFeaturesMode||(e.ForAllFeaturesMode={}))[t.VISIBLE_ONLY=0]="VISIBLE_ONLY",t[t.ALL=1]="ALL",t[t.QUERYABLE=2]="QUERYABLE",e.ForAllFeaturesReturnType=void 0,(r=e.ForAllFeaturesReturnType||(e.ForAllFeaturesReturnType={}))[r.EXIT=0]="EXIT",r[r.CONTINUE=1]="CONTINUE",r[r.SKIP=2]="SKIP",e.ElevationMode=void 0,(i=e.ElevationMode||(e.ElevationMode={}))[i.Absolute=0]="Absolute",i[i.RelativeToGround=1]="RelativeToGround",i[i.OnTheGround=2]="OnTheGround",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/PointCloudLayerViewPerformanceInfo":function(){define(["exports","./support/LayerViewPerformanceInfo"],(function(e,t){"use strict";class r extends t.LayerViewPerformanceInfo{constructor(e,t,r,i,s){super(e,t,-1,r,i),this.queue=s}}e.PointCloudLayerViewPerformanceInfo=r,e.QueuePerformanceInfo=class{constructor(e,t,r,i){this.loading=e,this.indexLoading=t,this.processing=r,this.idleProcessing=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/PointCloudWorkerHandle":function(){define(["exports","../../../core/workers/WorkerHandle"],(function(e,t){"use strict";class r extends t.WorkerHandle{constructor(e){super("PointCloudWorker","transform",{transform:e=>function(e){const t=[e.geometryBuffer];if(null!=e.primaryAttributeData&&e.primaryAttributeData.buffer&&t.push(e.primaryAttributeData.buffer),null!=e.modulationAttributeData&&e.modulationAttributeData.buffer&&t.push(e.modulationAttributeData.buffer),null!=e.filterAttributesData)for(const r of e.filterAttributesData)null!=r&&r.buffer&&t.push(r.buffer);for(const r of e.userAttributesData)r.buffer&&t.push(r.buffer);return t}(e)},e)}}e.PointCloudWorkerHandle=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SQueryFeatureStore":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/compilerUtils","../../../../core/Evented","../../../../core/accessorSupport/decorators/property","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere","../II3SMeshView3D"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";const m=u.create();e.I3SQueryFeatureStore=class extends r{constructor(e){super(e),this.events=new s}forEach(e){this.forAllFeatures((t=>(e(t),p.ForAllFeaturesReturnType.CONTINUE)))}forEachBounds(e,t){for(const r of e)t(this.getFeatureExtent(r,m))}forEachInBounds(e,t){this.forAllFeatures((r=>{const s=this.getFeatureExtent(i.toConst(r),g);return d.intersects(e,u.toRect(s,y))&&t(i.toConst(r)),p.ForAllFeaturesReturnType.CONTINUE}),(t=>{if(c.projectBoundingSphere(t,this.sourceSpatialReference,f,this.viewSpatialReference),f[0]>=e[0]&&f[2]<=e[2]&&f[1]>=e[1]&&f[3]<=e[3])return p.ForAllFeaturesReturnType.CONTINUE;const r=Math.max(e[0],Math.min(f[0],e[2])),i=Math.max(e[1],Math.min(f[1],e[3])),s=f[0]-r,n=f[1]-i;return s*s+n*n<=f[3]*f[3]?p.ForAllFeaturesReturnType.CONTINUE:p.ForAllFeaturesReturnType.SKIP}))}},t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"featureAdapter",void 0),t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"forAllFeatures",void 0),t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"getFeatureExtent",void 0),t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"sourceSpatialReference",void 0),t.__decorate([n.property({constructOnly:!0})],e.I3SQueryFeatureStore.prototype,"viewSpatialReference",void 0),e.I3SQueryFeatureStore=t.__decorate([l.subclass("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],e.I3SQueryFeatureStore);const f=h.fromValues(0,0,0,0),g=u.create(),y=d.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/LoDUtil":function(){define(["exports","../../../../chunks/vec32"],(function(e,t){"use strict";const r=[!1],i=[null],s=[!1],n=[null];function o(e,t,r){let i=e;for(;i>0;){const e=t.indexOf(i);if(e>=0)return e;i=r.getParentId(i)}return t.indexOf(i)}function a(e,t,r){const i=[t.remove[0]],s=[];for(;1===i.length;){const e=i.pop();s.length=0;for(let n=0;n<t.load.length;n++){let o=t.load[n],a=r.getParentId(o);for(;a!==e;)o=a,a=r.getParentId(o);let l=i.indexOf(o);l<0&&(l=i.length,i.push(o),s.push([])),s[l].push(t.load[n])}}t.load=i;for(let t=0;t<i.length;t++)s[t].length>1?e.push({remove:[i[t]],load:s[t]}):i[t]=s[t][0]}e.nodeDiff=function(e,t,a){for(let e=0;e<t.length;e++)s[e]=!1,n[e]=null;for(let t=0;t<e.length;t++)r[t]=!1,i[t]=null;for(let r=0;r<t.length;r++){const n=o(t[r],e,a);n>=0&&(s[r]=!0,null!=i[n]?i[n].push(t[r]):i[n]=[t[r]])}for(let i=0;i<e.length;i++){const s=o(e[i],t,a);s>=0&&(r[i]=!0,null!=n[s]?n[s].push(e[i]):n[s]=[e[i]])}const l=[];for(let t=0;t<e.length;t++)null!=i[t]||r[t]||l.push({load:[],remove:[e[t]]});for(let e=0;e<t.length;e++)null!=n[e]||s[e]||l.push({load:[t[e]],remove:[]});for(let e=0;e<t.length;e++)null!=n[e]&&(n[e].length>1||n[e][0]!==t[e])&&l.push({load:[t[e]],remove:n[e]});for(let t=0;t<e.length;t++)null!=i[t]&&(i[t].length>1||i[t][0]!==e[t])&&l.push({load:i[t],remove:[e[t]]});return l},e.sortFrontToBack=function(e,r,i){return e.sort(((e,s)=>{if(0===e.load.length&&0===s.load.length)return 0;if(0===e.load.length)return-1;if(0===s.load.length)return 1;if(0===e.remove.length&&0===s.remove.length){const n=i.getRenderObb(e.load[0]).center,o=i.getRenderObb(s.load[0]).center;return t.dot(n,r)-t.dot(o,r)}if(0===e.remove.length)return-1;if(0===s.remove.length)return 1;if(1===e.load.length&&1===s.load.length){const n=i.getRenderObb(e.load[0]).center,o=i.getRenderObb(s.load[0]).center;return t.dot(n,r)-t.dot(o,r)}if(1===e.load.length)return-1;if(1===s.load.length)return 1;{const n=i.getRenderObb(e.remove[0]).center,o=i.getRenderObb(s.remove[0]).center;return t.dot(n,r)-t.dot(o,r)}}))},e.splitWorkEntries=function(e,t,r){for(let i=0;i<e.length;++i){const s=e[i];s.load.length>t&&1===s.remove.length&&a(e,s,r)}},e.splitWorkEntry=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/PagedNodeIndex":function(){define(["exports","../../../../geometry/spatialReferenceEllipsoidUtils","../../../../geometry/support/aaBoundingBox"],(function(e,t,r){"use strict";function i(e,t){return e/t|0}function s(e,t){return e%t}e.PagedNodeIndex=class{constructor(e,r,i){this._pages=[],this.pageSize=0,this._nodeSR=e,this._renderSR=r,this._renderSRSphericalPCPF=t.getSphericalPCPF(r),this.pageSize=i}addPage(e,t,r=0){for(;this._pages.length<e;)this._pages.push(null);!function(e,t,r,i,s){for(let n=0;n<e.length;n++){const o=e[n];o.obb.transform(o.obbInRenderSR,t,r,i,s)}}(t,this._nodeSR,this._renderSR,r,this._renderSRSphericalPCPF),this._pages[e]={nodes:t,parents:new Uint32Array(this.pageSize)},function(e,t){const r=[0];for(;r.length;){const n=r.pop(),o=e[i(n,t)].nodes[s(n,t)];for(let a=0;a<o.childCount;a++){const l=o.firstChild+a;null!=e[i(l,t)]&&(e[i(l,t)].parents[s(l,t)]=n,r.push(l))}}}(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[i(e,t)].nodes[s(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[i(e,t)].nodes[s(e,t)].obbInRenderSR}setRenderObb(e,t){const r=this.pageSize;this._pages[i(e,r)].nodes[s(e,r)].obbInRenderSR.copy(t)}getParentId(e){const t=this.pageSize;return this._pages[i(e,t)].parents[s(e,t)]}hasNodes(e,t){const r=i(e,this.pageSize),s=i(e+t-1,this.pageSize);for(let e=r;e<=s;e++)if(null==this._pages[e])return!1;return!0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const r=this._pages[t];if(r)for(let i=0;i<r.nodes.length;i++)e(t*this.pageSize+i)}}createVisibilityTraverse(){const e={index:this,queue:[],masks:[],tempAabb:r.create()};return(t,s)=>function(e,t,s){const n=e.index;if(!n.hasNodes(0,1))return;const o=e.queue;o.length=0,o.push(0);const a=e.masks;for(a.length=0,a.push(0);o.length>0;){const l=o.pop();let c=a.pop();const u=n.getNode(l),d=n.getRenderObb(l);let h=!0;if(null!=t.clippingBox){const i=1<<t.frustum.length;0===(c&i)&&(d.toAaBoundingBox(e.tempAabb),r.contains(t.clippingBox,e.tempAabb)?c|=i:r.intersects(t.clippingBox,e.tempAabb)||(h=!1))}for(let e=0;e<t.frustum.length&&h;e++){const r=1<<e;if(0===(c&r)){const i=d.intersectPlane(t.frustum[e]);i>0?h=!1:i<0&&(c|=r)}}if(s.predicate(l,u,h)){const e=u.firstChild,t=u.childCount;let r=!1;const d=i(e,n.pageSize),h=i(e+t-1,n.pageSize);for(let e=d;e<=h;e++)if(!n.hasPage(e)){s.pageMiss(l,e),r=!0;break}if(!r)for(let r=0;r<t;r++)o.push(e+r),a.push(c)}}}(e,t,s)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/PointCloudGraphic":function(){define(["exports","../../../../chunks/tslib.es6","../../../../Graphic","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";e.PointCloudGraphic=class extends r{constructor(e){super(e),this.pointCloudMetadata=null}},t.__decorate([i.property({constructOnly:!0,clonable:"reference"})],e.PointCloudGraphic.prototype,"pointCloudMetadata",void 0),e.PointCloudGraphic=t.__decorate([a.subclass("esri.views.3d.layers.i3s.PointCloudGraphic")],e.PointCloudGraphic),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/PointCloudRenderer":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/maybe","../../../../core/PooledArray","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/plane","../../../../geometry/support/ray","./Intersector","./PointCloudHighlights","../../webgl-engine/core/shaderLibrary/ShaderOutput","../../webgl-engine/effects/RenderPlugin","../../webgl-engine/lib/DefaultVertexAttributeLocations","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/IntersectorType","../../webgl-engine/lib/RenderSlot","../../webgl-engine/lib/VertexArrayObject","../../webgl-engine/lib/VertexAttribute","../../../../chunks/PointRenderer.glsl","../../webgl-engine/shaders/PointRendererTechnique","../../webgl-engine/shaders/PointRendererTechniqueConfiguration","../../../webgl/BufferObject","../../../webgl/enums","../../../webgl/VertexElementDescriptor"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A){"use strict";const I=new Map([["positions",[new A.VertexElementDescriptor(C.VertexAttribute.POSITION,3,O.DataType.FLOAT,0,12)]],["colors",[new A.VertexElementDescriptor(C.VertexAttribute.COLOR,3,O.DataType.UNSIGNED_BYTE,0,3,!0)]]]);function D(e,t,r,i,s){if(r.drawScreenSpace)return r.fixedSize*t*i;const n=P.getMaxPointSizeScreenspace(s)*t*i;return r.useFixedSizes?Math.min(r.fixedSize/2,n):r.screenMinSize>0?Math.min(Math.max(r.screenMinSize*t*i,e/2),n):Math.min(e/2,n)}function F(e,t,r,i,s){return r.drawScreenSpace?0:D(e,t,r,i,s)}function L(e,t,r){return null==r&&(r=u.create()),r[0]=e.origin[0]+e.coordinates[3*t],r[1]=e.origin[1]+e.coordinates[3*t+1],r[2]=e.origin[2]+e.coordinates[3*t+2],r}e.PointCloudRenderer=class extends _.SyncRenderPlugin{constructor(e){super(e),this.type=w.IntersectorType.PCL,this.isGround=!1,this._passParameters=new P.PointRendererPassParameters,this._highlights=new g.PointCloudHighlights({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,r)=>this._addHighlight(e,t,r),removeHighlight:(e,t)=>this._removeHighlight(e,t)}),this.produces=new Map([[x.RenderSlot.OPAQUE_MATERIAL,e=>!(y.isDepth(e)||e===y.ShaderOutput.Highlight&&this._highlights.empty)],[x.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS,e=>y.isDepth(e)]]),this.layerViewUid="",this._slicePlaneEnabled=!1,this._configuration=new R.PointRendererTechniqueConfiguration,this._nodes=new i}hasHighlight(e){return this._highlights.has(e)}initializeRenderContext(e){this._context=e,e.requestRender()}uninitializeRenderContext(){}intersect(e,t,r,i){const s=u.create(),n=u.create(),o=u.create(),a=u.create(),l=p.create(),g=e.camera.perScreenPixelRatio/2,y=e.camera.near;c.subtract(n,i,r);const _=1/c.length(n);c.scale(n,n,_),c.negate(o,n),d.set(l,n[0],n[1],n[2],-c.dot(n,r));const b=new N,w=new N,x=new Array,T=h.create(),C=h.create(this._passParameters.clipBox);h.offset(C,-r[0],-r[1],-r[2],C),this._nodes.forAll((u=>{const d=u.splatSize*this._passParameters.scaleFactor;let p=u.obb.minimumDistancePlane(l),m=u.obb.maximumDistancePlane(l);p-=F(d,p+y,this._passParameters,g,u.isLeaf),m-=F(d,m+y,this._passParameters,g,u.isLeaf);const f=m<0,S=null!=b.dist&&null!=w.dist&&b.dist<p*_&&w.dist>m*_;if(f||S)return;const P=D(d,m+y,this._passParameters,g,u.isLeaf);if(!u.obb.intersectRay(r,n,P))return;const M=P*P;u.obb.toAaBoundingBox(T),h.offset(T,-r[0],-r[1],-r[2],T);const R=!h.contains(C,T);c.subtract(a,u.origin,r);const E=u.coordinates.length/3;for(let l=0;l<E;l++){if(s[0]=a[0]+u.coordinates[3*l],s[1]=a[1]+u.coordinates[3*l+1],s[2]=a[2]+u.coordinates[3*l+2],R&&!h.containsPoint(C,s))continue;const p=c.dot(s,n),m=c.squaredLength(s)-p*p;if(m>M)continue;let f=p+y;const S=F(d,f,this._passParameters,g,u.isLeaf);if(p-S<0)continue;f-=S;const T=D(d,f,this._passParameters,g,u.isLeaf);if(m>T*T)continue;const P=(p-S)*_,E=e=>(e.point=L(u,l,e.point),e.dist=P,e.normal=o,e.node=u,e.pointId=l,e.layerViewUid=this.layerViewUid,e);if((null==b.dist||P<b.dist)&&(null==t||t(r,i,P))&&E(b),e.options.store!==v.StoreResults.MIN&&(null==w.dist||P>w.dist)&&(null==t||t(r,i,P))&&E(w),e.options.store===v.StoreResults.ALL&&(null==t||t(r,i,P))){const e=new N;x.push(E(e))}}}));const P=e=>{const{layerViewUid:t,node:r,pointId:i}=e;return new f.PclTarget(e.point,t,i,(()=>this.createGraphic(r,i,e.point)))},M=(e,t)=>{const r=P(t);e.set(this.type,r,t.dist,t.normal)};if(U(b)){const t=e.results.min;(null==t.distance||b.dist<t.distance)&&M(t,b)}if(U(w)&&e.options.store!==v.StoreResults.MIN){const t=e.results.max;(null==t.distance||w.dist>t.distance)&&M(t,w)}if(e.options.store===v.StoreResults.ALL){const t=m.fromPoints(r,i);for(const r of x){const i=new S.IntersectorResult(t);M(i,r),e.results.all.push(i)}}}acquireTechniques(e){const t=e.output===y.ShaderOutput.Highlight;return 0!==this._nodes.length&&(y.isColorOrColorEmission(e.output)||y.isDepth(e.output)&&e.bind.slot===x.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS||t)?(this._nodes.forAll((t=>this._initNode(e,t))),this._configuration.drawScreenSize=this._passParameters.drawScreenSpace,this._configuration.useFixedSizes=this._passParameters.useFixedSizes,this._configuration.hasSlicePlane=this._slicePlaneEnabled,this._configuration.hasOccludees=e.bind.hasOccludees,this._configuration.clippingEnabled=this._clippingEnabled,this._configuration.hasHighlightMixTexture=t&&null!=e.bind.highlightMixTexture,this._configuration.output=e.output,this._context.techniques.get(M.PointRendererTechnique,this._configuration)):null}render(e,t){const{rctx:r,bind:i,output:s}=e,n=r.bindTechnique(t,i,this._passParameters),o=s===y.ShaderOutput.Highlight,a=i.highlight?.name??null;o&&!a||this._nodes.forAll((t=>{0===t.coordinates.length||o&&!t.highlightMap.has(a)||(n.bindDraw(i,this._passParameters,t),r.bindVAO(t.vao),o?this._renderHighlightFragments(e,t):r.drawArrays(O.PrimitiveType.POINTS,0,t.coordinates.length/3))}))}_renderHighlightFragments(e,t){const{highlightMap:r}=t,{rctx:i,bind:s}=e,{highlight:n}=s;if(!n)return;const o=n.name,a=r.get(o);if(!a||0===a.length)return;const{highlightOrderMap:l,highlightLevel:c}=s;if(null==c)return;for(const e of r.keys())if(e!==o){const t=l.get(e);if(void 0!==t&&t>c)return}let u=0,d=a[0].componentIndex,h=d+1;const p=()=>{for(;u<a.length&&a[u].id.highlightName!==o;)d=a[u].componentIndex,++u;h=d+1};p();const m=(e,t)=>{const r=t-e;r>0&&i.drawArrays(O.PrimitiveType.POINTS,e,r)};for(;u<a.length;){const e=a[u];if(e.id.highlightName!==o){m(d,h),++u,p();continue}const t=e.componentIndex;t!==h&&(m(d,h),d=t),h=t+1,++u}m(d,h)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){h.set(this._passParameters.clipBox,e||h.positiveInfinity)}get _clippingEnabled(){return!h.equals(this._passParameters.clipBox,h.positiveInfinity,((e,t)=>e===t))}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let t=null;return this._nodes.filterInPlace((i=>i.id!==e||(t=i,i.vao=r.disposeMaybe(i.vao),this._highlights.nodeRemoved(i),!1))),this._requestRender(),t}forEachNode(e){this._nodes.forAll(e)}removeAll(){this._nodes.forAll((e=>e.vao=r.disposeMaybe(e.vao))),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e,t){return this._highlights.add(e,t)}_addHighlight(e,t,r){e.addHighlight(t,r),this._requestRender()}_removeHighlight(e,t){e.removeHighlight(t),this._requestRender()}_initNode(e,t){t.vao??=new T.VertexArrayObject(e.rctx,b.Default3D,I,new Map([["positions",E.BufferObject.createVertex(e.rctx,O.Usage.STATIC_DRAW,t.coordinates)],["colors",E.BufferObject.createVertex(e.rctx,O.Usage.STATIC_DRAW,t.rgb)]]))}_requestRender(){this._context&&this._context.requestRender()}},t.__decorate([s.property({constructOnly:!0})],e.PointCloudRenderer.prototype,"createGraphic",void 0),e.PointCloudRenderer=t.__decorate([l.subclass("esri.views.3d.layers.i3s.PointCloudRenderer")],e.PointCloudRenderer);class N{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerViewUid=""}}function U(e){return null!=e.dist&&null!=e.point&&null!=e.pointId&&null!=e.node}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/PointCloudHighlights":function(){define(["exports","../../../../core/handleUtils","../../webgl-engine/lib/Object3DStateID"],(function(e,t,r){"use strict";class i{constructor(e,t){this.ids=new Map,this.enabled=!1;for(const t of e)null!=t&&this._add(t.nodeId,t.pointId);this.id=new r.Object3DHighlightStateID(t)}_add(e,t){const r=this.ids.get(e);r?r.add(t):this.ids.set(e,new Set([t]))}}e.PointCloudHighlights=class{constructor(e){this._context=e,this._highlights=new Map}get empty(){return 0===this._highlights.size}destroy(){this._highlights=null}add(e,r){const s=new i(e,r),n=this._highlights.get(r);return n?n.add(s):this._highlights.set(r,new Set([s])),this._enableSet(s),t.makeHandle((()=>this._removeSet(s)))}_removeSet(e){this._disableSet(e);const{highlightName:t}=e.id,r=this._highlights.get(t);r&&(r.delete(e),0===r.size&&this._highlights.delete(t))}_enableSet(e){e.enabled||(e.enabled=!0,this._context.forEachNode((t=>this._enableSetForNode(e,t))))}_enableSetForNode(e,t){if(!e.enabled)return;const r=e.ids.get(t.id);r&&r.forEach((r=>this._context.addHighlight(t,r,e.id)))}_disableSet(e){e.enabled&&(e.enabled=!1,this._context.forEachNode((t=>this._disableSetForNode(e,t))))}_disableSetForNode(e,t){e.enabled||this._context.removeHighlight(t,e.id)}nodeAdded(e){this._forEachSet((t=>this._enableSetForNode(t,e)))}nodeRemoved(e){this._forEachSet((t=>this._disableSetForNode(t,e)))}removeAll(){this._forEachSet((e=>this._disableSet(e)))}_forEachSet(e){this._highlights.forEach((t=>t.forEach(e)))}has(e){return this._highlights.has(e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/chunks/PointRenderer.glsl":function(){define(["exports","../core/mathUtils","../core/libs/gl-matrix-2/math/mat4","../core/libs/gl-matrix-2/factories/mat4f64","../core/libs/gl-matrix-2/math/vec2","../core/libs/gl-matrix-2/factories/vec2f64","./vec32","../core/libs/gl-matrix-2/factories/vec3f64","../geometry/support/aaBoundingBox","../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput","../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl","../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl","../views/3d/webgl-engine/core/shaderLibrary/util/RgbaFloatEncoding.glsl","../views/3d/webgl-engine/core/shaderModules/Float2DrawUniform","../views/3d/webgl-engine/core/shaderModules/Float2PassUniform","../views/3d/webgl-engine/core/shaderModules/Float3DrawUniform","../views/3d/webgl-engine/core/shaderModules/glsl","../views/3d/webgl-engine/core/shaderModules/Matrix4BindUniform","../views/3d/webgl-engine/core/shaderModules/Matrix4DrawUniform","../views/3d/webgl-engine/lib/VertexAttribute","../views/webgl/NoParameters","../views/webgl/ShaderBuilder"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S){"use strict";class w extends v.NoParameters{constructor(){super(...arguments),this.clipBox=l.create(l.positiveInfinity),this.useFixedSizes=!1,this.useRealWorldSymbolSizes=!1,this.scaleFactor=1,this.minSizePx=0,this.size=0,this.sizePx=0}get fixedSize(){return this.drawScreenSpace?this.sizePx:this.size}get screenMinSize(){return this.useFixedSizes?0:this.minSizePx}get drawScreenSpace(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}class x extends u.SlicePlaneParameters{constructor(e,t,r){super(e),this.origin=e,this.isLeaf=t,this.splatSize=r}}function T(e){const i=new S.ShaderBuilder,n=c.isColorOrColorEmission(e.output),{vertex:a,fragment:l}=i;return i.vertex.include(u.RejectBySlice,e),i.attributes.add(b.VertexAttribute.POSITION,"vec3"),i.attributes.add(b.VertexAttribute.COLOR,"vec3"),a.uniforms.add(new _.Matrix4DrawUniform("modelView",((e,t)=>r.multiply(P,t.camera.viewMatrix,r.fromTranslation(P,e.origin)))),new y.Matrix4BindUniform("proj",(e=>e.camera.projectionMatrix)),new p.Float2DrawUniform("screenMinMaxSize",((e,t,r)=>s.set(R,r.useFixedSizes?0:r.minSizePx*t.camera.pixelRatio,C(e.isLeaf)*t.camera.pixelRatio))),e.useFixedSizes?new m.Float2PassUniform("pointScale",((e,t)=>s.set(R,e.fixedSize*t.camera.pixelRatio,t.camera.fullHeight))):new p.Float2DrawUniform("pointScale",((e,t,r)=>s.set(R,e.splatSize*r.scaleFactor*t.camera.pixelRatio,t.camera.fullHeight/t.camera.pixelRatio)))),e.clippingEnabled?a.uniforms.add(new f.Float3DrawUniform("clipMin",((e,t,r)=>o.set(M,r.clipBox[0]-e.origin[0],r.clipBox[1]-e.origin[1],r.clipBox[2]-e.origin[2]))),new f.Float3DrawUniform("clipMax",((e,t,r)=>o.set(M,r.clipBox[3]-e.origin[0],r.clipBox[4]-e.origin[1],r.clipBox[5]-e.origin[2])))):(a.constants.add("clipMin","vec3",[-t.numberMaxFloat32,-t.numberMaxFloat32,-t.numberMaxFloat32]),a.constants.add("clipMax","vec3",[t.numberMaxFloat32,t.numberMaxFloat32,t.numberMaxFloat32])),n&&i.varyings.add("vColor","vec3"),a.main.add(g.glsl`
    // Move clipped points outside of clipspace
    if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
      position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      gl_PointSize = 0.0;
      return;
    }

    if (rejectBySlice(position)) {
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      gl_PointSize = 0.0;
      return;
    }

    // Position in camera space
    vec4 camera = modelView * vec4(position, 1.0);

    float pointSize = pointScale.x;
    vec4 position = proj * camera;
    ${e.drawScreenSize?g.glsl`float clampedScreenSize = pointSize;`:g.glsl`float pointRadius = 0.5 * pointSize;
           vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
           vec4 positionOffset = proj * cameraOffset;
           float radius = abs(positionOffset.y - position.y);
           float viewHeight = pointScale.y;
           // screen diameter = (2 * r / w) * (h / 2)
           float screenPointSize = (radius / position.w) * viewHeight;
           float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
           // Shift towards camera, to move rendered point out of terrain i.e. to
           // the camera-facing end of the virtual point when considering it as a
           // 3D sphere.
           camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
           position = proj * camera;`}

    gl_PointSize = clampedScreenSize;
    gl_Position = position;
    ${n?g.glsl`vColor = color;`:""}`),l.include(h.RgbaFloatEncoding,e),i.include(d.OutputHighlight,e),l.main.add(g.glsl`
    vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
    float r2 = dot(vOffset, vOffset);

    if (r2 > 0.25) {
      discard;
    }
    calculateOcclusionAndOutputHighlight();
    ${n?g.glsl`fragColor = vec4(vColor, 1.0);`:""}`),i}function C(e){return e?256:64}const P=i.create(),M=a.create(),R=n.create(),E=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:x,PointRendererPassParameters:w,build:T,getMaxPointSizeScreenspace:C},Symbol.toStringTag,{value:"Module"}));e.PointRenderer=E,e.PointRendererDrawParameters=x,e.PointRendererPassParameters=w,e.build=T,e.getMaxPointSizeScreenspace=C}))},"esri/views/3d/webgl-engine/shaders/PointRendererTechnique":function(){define(["require","exports","../core/shaderTechnique/ReloadableShaderModule","../core/shaderTechnique/ShaderTechnique","../lib/StencilUtils","../../../../chunks/PointRenderer.glsl","../../../webgl/enums","../../../webgl/renderState"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends i.ShaderTechnique{constructor(t,i){super(t,i,new r.ReloadableShaderModule(n.PointRenderer,(()=>new Promise(((t,r)=>e(["./PointRenderer.glsl"],t,r))))))}initializePipeline(e){return a.makePipelineState({depthTest:{func:o.CompareFunction.LESS},depthWrite:a.defaultDepthWrite,colorWrite:a.defaultColorWrite,stencilWrite:e.hasOccludees?s.stencilWriteMaskOn:null,stencilTest:e.hasOccludees?s.stencilBaseAllZerosParams:null,drawBuffers:i.depthOnlyOutputBuffersOr(e.output)})}}t.PointRendererTechnique=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/shaders/PointRendererTechniqueConfiguration":function(){define(["exports","../../../../chunks/tslib.es6","../core/shaderTechnique/ShaderTechniqueConfiguration","../materials/DefaultTechniqueConfiguration"],(function(e,t,r,i){"use strict";class s extends i.DefaultTechniqueConfiguration{constructor(){super(...arguments),this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1,this.draped=!1}}t.__decorate([r.parameter()],s.prototype,"drawScreenSize",void 0),t.__decorate([r.parameter()],s.prototype,"useFixedSizes",void 0),t.__decorate([r.parameter()],s.prototype,"hasOccludees",void 0),t.__decorate([r.parameter()],s.prototype,"clippingEnabled",void 0),e.PointRendererTechniqueConfiguration=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/PointCloudRendererNode":function(){define(["exports","../../../../core/MapUtils","../../../../chunks/PointRenderer.glsl"],(function(e,t,r){"use strict";class i extends r.PointRendererDrawParameters{constructor(e,t,r,i,s,n,o,a,l=null){super(r,s,t),this.id=e,this.obb=i,this.coordinates=n,this.rgb=o,this.attributes=a,this.pointIdFilterMap=l,this.highlightMap=new Map}addHighlight(e,r){const{highlightMap:i}=this,o=t.getOrCreateMapValue(i,r.highlightName,(()=>new Array)),a=new n(e,r);o.push(a);const l=s(a);for(let e=o.length-1;e>0&&l<s(o[e-1]);--e)[o[e-1],o[e]]=[o[e],o[e-1]]}removeHighlight(e){const{highlightMap:t}=this,{highlightName:r}=e,i=t.get(r);if(!i)return;const s=i.filter((t=>t.id!==e));0===s.length?t.delete(r):t.set(r,s)}get cachedMemory(){return 5*this.coordinates.length+128}}function s(e){return null!=e.componentIndex?e.componentIndex:-1}class n{constructor(e,t){this.componentIndex=e,this.id=t}}e.PointCloudRendererNode=i,e.isPointRendererNode=function(e){return e.hasOwnProperty("splatSize")},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/PointCloudRendererUtil":function(){define(["exports"],(function(e){"use strict";function t(e,t){for(const r of e??[])if(r.name===t&&null!=r.attributeValues&&"UInt8"===r.attributeValues.valueType&&3===r.attributeValues.valuesPerElement)return{name:t,storageInfo:r,useElevation:!1};return null}function r(e,t){for(const r of e??[])if(r.name===t){const e="embedded-elevation"===r.encoding;return e?{name:t,storageInfo:null,useElevation:e}:{name:t,storageInfo:r,useElevation:e}}return"elevation"===t?.toLowerCase()?{name:t,storageInfo:null,useElevation:!0}:null}e.getAttributeInfo=r,e.getFilterInfo=function(e){const t=e.filters;return t?t.map((t=>({filterJSON:t.toJSON(),attributeInfo:r(e.attributeStorageInfo,t.field)}))):[]},e.getFixedSizeAlgorithm=function(e){const t=e?.pointSizeAlgorithm;return t&&"fixed-size"===t.type?t:null},e.getRendererInfo=function(e){const i=e.renderer,s=i?.type,n=i?.toJSON()??null;let o=null,a=!1;const l=e.attributeStorageInfo;"point-cloud-unique-value"===s||"point-cloud-stretch"===s||"point-cloud-class-breaks"===s?o=r(l,i.field):"point-cloud-rgb"===s?(o=t(l,i.field),a=null!=o):(o=t(l,"RGB"),a=null!=o);let c=null;return i?.colorModulation&&(c=r(l,i.colorModulation.field)),{rendererJSON:n,isRGBRenderer:a,primaryAttribute:o,modulationAttribute:c}},e.getSplatSizeAlgorithm=function(e){const t=e?.pointSizeAlgorithm;return t&&"splat"===t.type?t:null},e.rendererUsesFixedSizes=function(e){const t=e?.pointSizeAlgorithm;return!!t?.type&&"fixed-size"===t.type},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/PointCloudWorkerUtil":function(){define(["exports","../../../../core/has","../../../../renderers/PointCloudClassBreaksRenderer","../../../../renderers/PointCloudStretchRenderer","../../../../renderers/PointCloudUniqueValueRenderer","./I3SBinaryReader","./LEPCC"],(function(e,t,r,i,s,n,o){"use strict";function a(e,t){const r=new Float64Array(t);for(let i=0;i<t;i++)r[i]=e[3*i+2];return r}function l(e){switch(e){default:case null:case"none":return e=>e;case"low-four-bit":return e=>15&e;case"high-four-bit":return e=>(240&e)>>4;case"absolute-value":return e=>Math.abs(e);case"modulo-ten":return e=>e%10}}function c(e){let t=0;for(const r of e||[])t|=1<<r;return t}e.elevationFromPositions=a,e.evaluateRenderer=function(e,t,n,o){const{rendererJSON:a,isRGBRenderer:c}=e;let u=null,d=null;if(t&&c)u=t;else if(t&&"pointCloudUniqueValueRenderer"===a?.type){d=s.fromJSON(a);const e=d.colorUniqueValueInfos;u=new Uint8Array(3*o);const r=l(d.fieldTransformType);for(let i=0;i<o;i++){const s=(r?r(t[i]):t[i])+"";for(let t=0;t<e.length;t++)if(e[t].values.includes(s)){u[3*i]=e[t].color.r,u[3*i+1]=e[t].color.g,u[3*i+2]=e[t].color.b;break}}}else if(t&&"pointCloudStretchRenderer"===a?.type){d=i.fromJSON(a);const e=d.stops;u=new Uint8Array(3*o);const r=l(d.fieldTransformType);for(let i=0;i<o;i++){const s=r?r(t[i]):t[i],n=e.length-1;if(s<e[0].value)u[3*i]=e[0].color.r,u[3*i+1]=e[0].color.g,u[3*i+2]=e[0].color.b;else if(s>=e[n].value)u[3*i]=e[n].color.r,u[3*i+1]=e[n].color.g,u[3*i+2]=e[n].color.b;else for(let t=1;t<e.length;t++)if(s<e[t].value){const r=(s-e[t-1].value)/(e[t].value-e[t-1].value);u[3*i]=e[t].color.r*r+e[t-1].color.r*(1-r),u[3*i+1]=e[t].color.g*r+e[t-1].color.g*(1-r),u[3*i+2]=e[t].color.b*r+e[t-1].color.b*(1-r);break}}}else if(t&&"pointCloudClassBreaksRenderer"===a?.type){d=r.fromJSON(a);const e=d.colorClassBreakInfos;u=new Uint8Array(3*o);const i=l(d.fieldTransformType);for(let r=0;r<o;r++){const s=i?i(t[r]):t[r];for(let t=0;t<e.length;t++)if(s>=e[t].minValue&&s<=e[t].maxValue){u[3*r]=e[t].color.r,u[3*r+1]=e[t].color.g,u[3*r+2]=e[t].color.b;break}}}else u=new Uint8Array(3*o).fill(255);if(n&&d?.colorModulation){const e=d.colorModulation.minValue,t=d.colorModulation.maxValue,r=.3;for(let i=0;i<o;i++){const s=n[i],o=s>=t?1:s<=e?r:r+(1-r)*(s-e)/(t-e);u[3*i]=o*u[3*i],u[3*i+1]=o*u[3*i+1],u[3*i+2]=o*u[3*i+2]}}return u},e.filterInPlace=function(e,t,r,i,s){const n=e.length/3;let o=0;for(let a=0;a<n;a++){let n=!0;for(let e=0;e<i.length&&n;e++){const{filterJSON:t}=i[e],r=s[e].values[a];switch(t.type){case"pointCloudValueFilter":{const e="exclude"===t.mode;t.values.includes(r)===e&&(n=!1);break}case"pointCloudBitfieldFilter":{const e=c(t.requiredSetBits),i=c(t.requiredClearBits);(r&e)===e&&0===(r&i)||(n=!1);break}case"pointCloudReturnFilter":{const e=15&r,i=r>>>4&15,s=i>1,o=1===e,a=e===i;let l=!1;for(const e of t.includedReturns)if("last"===e&&a||"firstOfMany"===e&&o&&s||"lastOfMany"===e&&a&&s||"single"===e&&!s){l=!0;break}l||(n=!1);break}}}n&&(r[o]=a,e[3*o]=e[3*a],e[3*o+1]=e[3*a+1],e[3*o+2]=e[3*a+2],t[3*o]=t[3*a],t[3*o+1]=t[3*a+1],t[3*o+2]=t[3*a+2],o++)}return o},e.getAttributeValues=function(e,t,r){return e?.attributeInfo.useElevation?t?a(t,r):null:e?.attributeInfo.storageInfo?n.readBinaryAttribute(e.attributeInfo.storageInfo,e.buffer,r,!0):null},e.readGeometry=function(e,t){if(null==e.encoding||""===e.encoding){const r=n.createGeometryIndexFromSchema(t,e);if(null==r.vertexAttributes.position)return;const i=n.createTypedView(t,r.vertexAttributes.position),s=r.header.fields,o=[s.offsetX,s.offsetY,s.offsetZ],a=[s.scaleX,s.scaleY,s.scaleZ],l=i.length/3,c=new Float64Array(3*l);for(let e=0;e<l;e++)c[3*e]=i[3*e]*a[0]+o[0],c[3*e+1]=i[3*e+1]*a[1]+o[1],c[3*e+2]=i[3*e+2]*a[2]+o[2];return c}if("lepcc-xyz"===e.encoding)return o.decodeXYZ(t).result},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/renderers/PointCloudClassBreaksRenderer":function(){define(["exports","../chunks/tslib.es6","../core/lang","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/subclass","./PointCloudRenderer","./support/RendererLegendOptions","./support/pointCloud/ColorClassBreakInfo"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";var d;return e.default=d=class extends l{constructor(e){super(e),this.type="point-cloud-class-breaks",this.field=null,this.legendOptions=null,this.fieldTransformType=null,this.colorClassBreakInfos=null}clone(){return new d({...this.cloneProperties(),field:this.field,fieldTransformType:this.fieldTransformType,colorClassBreakInfos:r.clone(this.colorClassBreakInfos),legendOptions:r.clone(this.legendOptions)})}},t.__decorate([o.enumeration({pointCloudClassBreaksRenderer:"point-cloud-class-breaks"})],e.default.prototype,"type",void 0),t.__decorate([i.property({json:{write:{isRequired:!0}},type:String})],e.default.prototype,"field",void 0),t.__decorate([i.property({type:c,json:{write:!0}})],e.default.prototype,"legendOptions",void 0),t.__decorate([i.property({type:l.fieldTransformTypeKebabDict.apiValues,json:{type:l.fieldTransformTypeKebabDict.jsonValues,read:l.fieldTransformTypeKebabDict.read,write:l.fieldTransformTypeKebabDict.write}})],e.default.prototype,"fieldTransformType",void 0),t.__decorate([i.property({type:[u],json:{write:{isRequired:!0}}})],e.default.prototype,"colorClassBreakInfos",void 0),e.default=d=t.__decorate([a.subclass("esri.renderers.PointCloudClassBreaksRenderer")],e.default),e.default}))},"esri/renderers/PointCloudRenderer":function(){define(["exports","../chunks/tslib.es6","../core/jsonMap","../core/JSONSupport","../core/lang","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/subclass","./support/pointCloud/ColorModulation","./support/pointCloud/pointSizeAlgorithmTypeUtils"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";const d=r.strict()({pointCloudClassBreaksRenderer:"point-cloud-class-breaks",pointCloudRGBRenderer:"point-cloud-rgb",pointCloudStretchRenderer:"point-cloud-stretch",pointCloudUniqueValueRenderer:"point-cloud-unique-value"});return e.default=class extends i{constructor(e){super(e),this.type=void 0,this.pointSizeAlgorithm=null,this.colorModulation=null,this.pointsPerInch=10}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}cloneProperties(){return{pointSizeAlgorithm:s.clone(this.pointSizeAlgorithm),colorModulation:s.clone(this.colorModulation),pointsPerInch:s.clone(this.pointsPerInch)}}},t.__decorate([n.property({type:d.apiValues,readOnly:!0,nonNullable:!0,json:{type:d.jsonValues,read:!1,write:{writer:d.write,isRequired:!0}}})],e.default.prototype,"type",void 0),t.__decorate([n.property({types:u.pointSizeAlgorithmTypes,json:{write:!0}})],e.default.prototype,"pointSizeAlgorithm",void 0),t.__decorate([n.property({type:c,json:{write:!0}})],e.default.prototype,"colorModulation",void 0),t.__decorate([n.property({json:{write:!0},nonNullable:!0,type:Number})],e.default.prototype,"pointsPerInch",void 0),e.default=t.__decorate([l.subclass("esri.renderers.PointCloudRenderer")],e.default),(e.default||(e.default={})).fieldTransformTypeKebabDict=new r.JSONMap({none:"none",lowFourBit:"low-four-bit",highFourBit:"high-four-bit",absoluteValue:"absolute-value",moduloTen:"modulo-ten"}),e.default}))},"esri/renderers/support/pointCloud/ColorModulation":function(){define(["../../../chunks/tslib.es6","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o){"use strict";var a;let l=a=class extends t{constructor(){super(...arguments),this.field=null,this.minValue=0,this.maxValue=255}clone(){return new a({field:this.field,minValue:this.minValue,maxValue:this.maxValue})}};return e.__decorate([r.property({type:String,json:{write:{isRequired:!0}}})],l.prototype,"field",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],l.prototype,"minValue",void 0),e.__decorate([r.property({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],l.prototype,"maxValue",void 0),l=a=e.__decorate([o.subclass("esri.renderers.support.pointCloud.ColorModulation")],l),l}))},"esri/renderers/support/pointCloud/pointSizeAlgorithmTypeUtils":function(){define(["exports","./PointSizeAlgorithm","./PointSizeFixedSizeAlgorithm","./PointSizeSplatAlgorithm"],(function(e,t,r,i){"use strict";const s={key:"type",base:t,typeMap:{"fixed-size":r,splat:i}};e.pointSizeAlgorithmTypes=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/renderers/support/pointCloud/PointSizeAlgorithm":function(){define(["../../../chunks/tslib.es6","../../../core/jsonMap","../../../core/JSONSupport","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";const l=new t.JSONMap({pointCloudFixedSizeAlgorithm:"fixed-size",pointCloudSplatAlgorithm:"splat"});let c=class extends r{};return e.__decorate([i.property({type:l.apiValues,readOnly:!0,nonNullable:!0,json:{type:l.jsonValues,read:!1,write:{writer:l.write,isRequired:!0}}})],c.prototype,"type",void 0),c=e.__decorate([a.subclass("esri.renderers.support.pointCloud.PointSizeAlgorithm")],c),c}))},"esri/renderers/support/pointCloud/PointSizeFixedSizeAlgorithm":function(){define(["../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass","./PointSizeAlgorithm"],(function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends a{constructor(){super(...arguments),this.type="fixed-size",this.size=0,this.useRealWorldSymbolSizes=null}clone(){return new l({size:this.size,useRealWorldSymbolSizes:this.useRealWorldSymbolSizes})}};return e.__decorate([n.enumeration({pointCloudFixedSizeAlgorithm:"fixed-size"})],c.prototype,"type",void 0),e.__decorate([t.property({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],c.prototype,"size",void 0),e.__decorate([t.property({type:Boolean,json:{write:!0}})],c.prototype,"useRealWorldSymbolSizes",void 0),c=l=e.__decorate([o.subclass("esri.renderers.support.pointCloud.PointSizeFixedSizeAlgorithm")],c),c}))},"esri/renderers/support/pointCloud/PointSizeSplatAlgorithm":function(){define(["../../../chunks/tslib.es6","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/Logger","../../../core/RandomLCG","../../../core/accessorSupport/decorators/enumeration","../../../core/accessorSupport/decorators/subclass","./PointSizeAlgorithm"],(function(e,t,r,i,s,n,o,a){"use strict";var l;let c=l=class extends a{constructor(){super(...arguments),this.type="splat",this.scaleFactor=1}clone(){return new l({scaleFactor:this.scaleFactor})}};return e.__decorate([n.enumeration({pointCloudSplatAlgorithm:"splat"})],c.prototype,"type",void 0),e.__decorate([t.property({type:Number,value:1,nonNullable:!0,json:{write:{isRequired:!0}}})],c.prototype,"scaleFactor",void 0),c=l=e.__decorate([o.subclass("esri.renderers.support.pointCloud.PointSizeSplatAlgorithm")],c),c}))},"esri/renderers/support/pointCloud/ColorClassBreakInfo":function(){define(["../../../chunks/tslib.es6","../../../Color","../../../core/JSONSupport","../../../core/lang","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o){"use strict";var a;let l=a=class extends r{constructor(){super(...arguments),this.description=null,this.label=null,this.minValue=0,this.maxValue=0,this.color=null}clone(){return new a({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,color:i.clone(this.color)})}};return e.__decorate([s.property({type:String,json:{write:!0}})],l.prototype,"description",void 0),e.__decorate([s.property({type:String,json:{write:!0}})],l.prototype,"label",void 0),e.__decorate([s.property({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue",isRequired:!0}}})],l.prototype,"minValue",void 0),e.__decorate([s.property({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue",isRequired:!0}}})],l.prototype,"maxValue",void 0),e.__decorate([s.property({type:t,json:{type:[n.Integer],write:{isRequired:!0}}})],l.prototype,"color",void 0),l=a=e.__decorate([o.subclass("esri.renderers.support.pointCloud.ColorClassBreakInfo")],l),l}))},"esri/renderers/PointCloudStretchRenderer":function(){define(["exports","../chunks/tslib.es6","../core/lang","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/subclass","./PointCloudRenderer","./support/RendererLegendOptions","./visualVariables/support/ColorStop"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";var d;return e.default=d=class extends l{constructor(e){super(e),this.type="point-cloud-stretch",this.field=null,this.legendOptions=null,this.fieldTransformType=null,this.stops=null}clone(){return new d({...this.cloneProperties(),field:r.clone(this.field),fieldTransformType:r.clone(this.fieldTransformType),stops:r.clone(this.stops),legendOptions:r.clone(this.legendOptions)})}},t.__decorate([o.enumeration({pointCloudStretchRenderer:"point-cloud-stretch"})],e.default.prototype,"type",void 0),t.__decorate([i.property({json:{write:{isRequired:!0}},type:String})],e.default.prototype,"field",void 0),t.__decorate([i.property({type:c,json:{write:!0}})],e.default.prototype,"legendOptions",void 0),t.__decorate([i.property({type:l.fieldTransformTypeKebabDict.apiValues,json:{type:l.fieldTransformTypeKebabDict.jsonValues,read:l.fieldTransformTypeKebabDict.read,write:l.fieldTransformTypeKebabDict.write}})],e.default.prototype,"fieldTransformType",void 0),t.__decorate([i.property({type:[u],json:{write:{isRequired:!0}}})],e.default.prototype,"stops",void 0),e.default=d=t.__decorate([a.subclass("esri.renderers.PointCloudStretchRenderer")],e.default),e.default}))},"esri/renderers/PointCloudUniqueValueRenderer":function(){define(["exports","../chunks/tslib.es6","../core/lang","../core/accessorSupport/decorators/property","../core/has","../core/Logger","../core/accessorSupport/decorators/enumeration","../core/accessorSupport/decorators/subclass","./PointCloudRenderer","./support/RendererLegendOptions","./support/pointCloud/ColorUniqueValueInfo"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";var d;return e.default=d=class extends l{constructor(e){super(e),this.type="point-cloud-unique-value",this.field=null,this.fieldTransformType=null,this.colorUniqueValueInfos=null,this.legendOptions=null}clone(){return new d({...this.cloneProperties(),field:r.clone(this.field),fieldTransformType:r.clone(this.fieldTransformType),colorUniqueValueInfos:r.clone(this.colorUniqueValueInfos),legendOptions:r.clone(this.legendOptions)})}},t.__decorate([o.enumeration({pointCloudUniqueValueRenderer:"point-cloud-unique-value"})],e.default.prototype,"type",void 0),t.__decorate([i.property({json:{write:{isRequired:!0}},type:String})],e.default.prototype,"field",void 0),t.__decorate([i.property({type:l.fieldTransformTypeKebabDict.apiValues,json:{type:l.fieldTransformTypeKebabDict.jsonValues,read:l.fieldTransformTypeKebabDict.read,write:l.fieldTransformTypeKebabDict.write}})],e.default.prototype,"fieldTransformType",void 0),t.__decorate([i.property({type:[u],json:{write:{isRequired:!0}}})],e.default.prototype,"colorUniqueValueInfos",void 0),t.__decorate([i.property({type:c,json:{write:!0}})],e.default.prototype,"legendOptions",void 0),e.default=d=t.__decorate([a.subclass("esri.renderers.PointCloudUniqueValueRenderer")],e.default),e.default}))},"esri/renderers/support/pointCloud/ColorUniqueValueInfo":function(){define(["../../../chunks/tslib.es6","../../../Color","../../../core/JSONSupport","../../../core/lang","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/ensureType","../../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o){"use strict";var a;let l=a=class extends r{constructor(){super(...arguments),this.description=null,this.label=null,this.values=null,this.color=null}clone(){return new a({description:this.description,label:this.label,values:i.clone(this.values),color:i.clone(this.color)})}};return e.__decorate([s.property({type:String,json:{write:!0}})],l.prototype,"description",void 0),e.__decorate([s.property({type:String,json:{write:!0}})],l.prototype,"label",void 0),e.__decorate([s.property({type:[String],json:{write:{isRequired:!0}}})],l.prototype,"values",void 0),e.__decorate([s.property({type:t,json:{type:[n.Integer],write:{isRequired:!0}}})],l.prototype,"color",void 0),l=a=e.__decorate([o.subclass("esri.renderers.support.pointCloud.ColorUniqueValueInfo")],l),l}))},"esri/views/3d/layers/support/PopupSceneLayerView":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Error","../../../../core/Logger","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/fieldUtils","../../../layers/support/popupUtils"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.PopupSceneLayerView=e=>{let i=class extends e{_validateFetchPopupFeatures(e){const{layer:t}=this,{popupEnabled:i}=t;if(!i)throw new r("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t});if(!l.getFetchPopupTemplate(t,e))throw new r("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t})}async prepareFetchPopupFeatures(e){}async fetchPopupFeaturesFromGraphics(e,t){if(this._validateFetchPopupFeatures(t),0===e.length)return[];const r="scene"===this.layer.type&&null!=this.layer.associatedLayer?this.layer.associatedLayer:this.layer;let i=[];"fieldsIndex"in this.layer&&(i=a.unpackFieldNames(this.layer.fieldsIndex,await l.getRequiredFields(r,l.getFetchPopupTemplate(this.layer,t)))),await this.prepareFetchPopupFeatures(i);const s=new Set,n=[],o=[];for(const t of e)a.populateMissingFields(t,i,s)?o.push(t):n.push(t);if(0===o.length)return n;const c=new Map;for(let t=0;t<e.length;t++)c.set(e[t].getObjectId()??0,t);const u=await this.whenGraphicAttributes(o,[...s]).catch((()=>o)).then((e=>n.concat(e)));return u.sort(((e,t)=>{const r=e.getObjectId()??0,i=c.get(r)??0,s=t.getObjectId()??0;return i-(c.get(s)??0)})),u}};return i=t.__decorate([o.subclass("esri.views.3d.layers.support.PopupSceneLayerView")],i),i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/layers/PointCloudLayerView":function(){define(["../../chunks/tslib.es6","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n){"use strict";return r=>{let i=class extends r{constructor(){super(...arguments),this.layer=null}get availableFields(){return[]}highlight(){throw new Error("Not implemented")}queryFeatures(){throw new Error("Not implemented")}queryFeatureCount(){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(){throw new Error("Not implemented")}};return e.__decorate([t.property()],i.prototype,"layer",void 0),e.__decorate([t.property()],i.prototype,"availableFields",null),i=e.__decorate([n.subclass("esri.views.layers.PointCloudLayerView")],i),i}}))},"esri/views/3d/layers/SceneLayerView3D":function(){define(["../../../chunks/tslib.es6","../../../Graphic","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/ReactiveSet","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/has","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../core/sql/WhereClause","../../../layers/support/FeatureFilter","../../../layers/support/floorFilterUtils","../../../rest/support/Query","../../../support/guards","./I3SMeshView3D","./II3SMeshView3D","./LayerView3D","./i3s/featureEditing","./i3s/I3SGeometryUtil","./i3s/I3SMeshViewFilter","./i3s/I3SNode","./i3s/I3SOverrides","./i3s/I3SQueryEngine","./i3s/I3SQueryFeatureAdapter","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/PopupSceneLayerView","./support/SceneLayerViewRequiredFields","./support/TemporalSceneLayerView","../support/updatingProperties","../../layers/SceneLayerView","../../layers/support/popupUtils","../../support/HighlightDefaults","../../support/layerViewUtils","../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V){"use strict";const B=E.defineFieldProperties();let G=class extends(g.I3SMeshView3D(I.TemporalSceneLayerView(R.DefinitionExpressionSceneLayerView(O.PopupSceneLayerView(_.LayerView3D(F)))))){constructor(){super(...arguments),this.type="scene-layer-3d",this.viewFilter=null,this._setVisibilityHiddenObjectIds=new n,this.progressiveLoadFactor=1,this._elevationContext="scene",this._supportsLabeling=!0,this._pendingEditsQueue=Promise.resolve(),this._interactiveEditingSessions=new Map,this._queryEngine=null}get i3slayer(){return this.layer}tryRecycleWith(e,t){return e.url===this.layer.url&&this.i3sOverrides.isEmpty?e.load(t).then((()=>{s.throwIfAborted(t),M.checkRecyclable(this.layer,e,this.i3sOverrides),this.layer=e,this.i3sOverrides.destroy();const r=this.view.resourceController?.memoryController;this.i3sOverrides=new x.I3SOverrides({view:this.view,layer:e,memoryController:r}),this.resetHighlights()})):null}get layerPopupEnabledAndHasTemplate(){return this.layer.popupEnabled&&L.hasPopupTemplate(this.layer,this.view.popup?.defaultPopupTemplateEnabled)}get filter(){return this._get("filter")}set filter(e){this._set("filter",S.I3SMeshViewFilter.checkSupport(e)?e:null)}get requiredFields(){return this._fieldsHelper?.requiredFields??[]}get _floorFilterClause(){const e=p.getFloorFilterClause(this);return null!=e?d.create(e,{fieldsIndex:this.layer.fieldsIndex}):null}get _excludeObjectIdsSorted(){const e=this.layer.excludeObjectIds.toArray();return e.length?e.sort(((e,t)=>e-t)):null}get _setVisibilityHiddenObjectIdsSorted(){return this._setVisibilityHiddenObjectIds.size?Array.from(this._setVisibilityHiddenObjectIds).sort(((e,t)=>e-t)):null}get lodFactor(){return this.view?.qualitySettings?.sceneService?.object?.lodFactor??1}get lodCrossfadeUncoveredDuration(){return this.view?.qualitySettings?.fadeDuration??0}get updatingProgressValue(){return this._controller?.updatingProgress??0}get visibleAtCurrentScale(){return U.isInEffectiveScaleRange(this.i3slayer.effectiveScaleRange,this.view.scale)}initialize(){this._fieldsHelper=new A.SceneLayerViewRequiredFields({layerView:this}),this._updatingHandles.add((()=>this.layer.rangeInfos),(e=>this._rangeInfosChanged(e)),o.initial),this._updatingHandles.add((()=>this.layer.renderer),(e=>this._updatingHandles.addPromise(this._rendererChange(e))),o.initial);const e=()=>this._filterChange();this._updatingHandles.add((()=>this.parsedDefinitionExpression),e),this._updatingHandles.add((()=>this.mergedFilter),e),this._updatingHandles.add((()=>this._floorFilterClause),e),this._updatingHandles.add((()=>this._excludeObjectIdsSorted),e),this._updatingHandles.add((()=>this._setVisibilityHiddenObjectIdsSorted),e),this._updatingHandles.add((()=>this.viewFilter?.sortedObjectIds),e),this._updatingHandles.add((()=>this.viewFilter?.parsedWhereClause),e),this._updatingHandles.add((()=>this.getTimeFilterDependencies()),e),this._updatingHandles.add((()=>[this.viewFilter?.parsedGeometry,this.mergedFilter?.spatialRelationship,this.layer.filter?.spatialRelationship]),(()=>this._geometryFilterChange())),this._updatingHandles.add((()=>({layerViewFilter:this.mergedFilter,layerFilter:this.layerFilter})),(({layerViewFilter:e,layerFilter:t})=>{if(null==e&&null==t)return void this._set("viewFilter",null);const r=this.viewFilter;if(r)return r.viewFilter=e,r.layerFilter=t,void this._filterChange();this._set("viewFilter",new S.I3SMeshViewFilter({layerFilter:t,viewFilter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError),addTimeFilter:(e,t)=>this.addTimeFilter(e,t)}))}),o.initial),this.i3sOverrides.is3DOFL&&this._updatingHandles.add((()=>this.i3sOverrides.sortedGeometryChangedObjectIds),e),this.addHandles(this.layer.on("apply-edits",(e=>this._updatingHandles.addPromise(e.result)))),this.addHandles(this.layer.on("edits",(e=>{const t=this._pendingEditsQueue.then((()=>this._handleEdits(e))).then();this._pendingEditsQueue=t,this._updatingHandles.addPromise(t)})))}destroy(){this._fieldsHelper=i.destroyMaybe(this._fieldsHelper)}_rangeInfosChanged(e){null!=e&&e.length>0&&r.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}createQuery(){const e={outFields:["*"],returnGeometry:!0,returnZ:!0,outSpatialReference:this.view.spatialReference};return this.mergedFilter?.createQuery(e)??new m(e)}queryExtent(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),t?.signal)}queryFeatures(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),t?.signal).then((e=>{if(!e?.features)return e;const t=this.layer;for(const r of e.features)r.layer=t,r.sourceLayer=t;return e}))}async queryObjectIds(e,t){return(await this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),t?.signal)).filter(f.isNumber)}_ensureQueryEngine(){return this._queryEngine??=this._createQueryEngine(),this._queryEngine}_createQueryEngine(){const e=v.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new T.I3SQueryEngine({layerView:this,priority:V.TaskPriority.FEATURE_QUERY_ENGINE,spatialIndex:new P.I3SQueryFeatureStore({featureAdapter:new C.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo??[],getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures(((t,r,i)=>e(new C.I3SQueryFeature(t,r,i))),t,y.ForAllFeaturesMode.QUERYABLE),getFeatureExtent:e,sourceSpatialReference:M.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})}highlight(e,t){const r=this._highlights,i=t?.name??N.defaultHighlightName;if(e instanceof m){const{set:t,handle:s}=r.acquireSet(i);return this.queryObjectIds(e).then((e=>r.setFeatureIds(t,e))),s}return super.highlight(e,t)}createInteractiveEditSession(e){return b.createInteractiveEditSession(this._attributeEditingContext,e)}_createLayerGraphic(e){return new t({attributes:e,layer:this.layer,sourceLayer:this.layer})}getFilters(){const e=super.getFilters();this.i3sOverrides.is3DOFL&&this.i3sOverrides.sortedGeometryChangedObjectIds.length>0&&e.push(((e,t)=>{t.node.index>=0&&M.objectIdFilter(this.i3sOverrides.sortedGeometryChangedObjectIds,!1,e)}));const t=this._setVisibilityHiddenObjectIdsSorted;null!=t&&e.push((e=>M.objectIdFilter(t,!1,e)));const r=this._excludeObjectIdsSorted;return null!=r&&e.push((e=>M.objectIdFilter(r,!1,e))),this._floorFilterClause&&this.addSqlFilter(e,this._floorFilterClause,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),null!=this.viewFilter&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}setVisibility(e,t){t?this._setVisibilityHiddenObjectIds.delete(e):this._setVisibilityHiddenObjectIds.add(e)}isUpdating(){return super.isUpdating()||this.layerFilterUpdating||null!=this.viewFilter&&this.viewFilter.updating||null!=this.i3sOverrides&&this.i3sOverrides.updating}_ensureQuery(e){return this._validateQuery(this._addDefinitionExpressionToQuery(null==e?this.createQuery():m.from(e)))}_validateQuery(e){return e.outSpatialReference&&!e.outSpatialReference.equals(this.view.spatialReference)&&(r.getLogger(this).warn("query: outSpatialReference different from the view's spatial reference is not supported"),e.outSpatialReference=this.view.spatialReference),e.returnGeometry&&(e.returnZ=!0),e.returnCentroid=!1,e}get _attributeEditingContext(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),globalIdField:this._getGlobalIdField(),forEachNode:e=>this._forAllNodes((t=>null!=t?e(t.node,t.featureIds):null)),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this.i3sOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(e,t)=>this.setAttributeData(e,t),clearMemCache:()=>this.clearMemCache()}}async _handleEdits(e){const t=this._attributeEditingContext,r=await b.normalizeEditResultsEvent(t,e);b.processGeometryEdits(t,r),b.processAttributeEdits(t,r)}get hasGeometryFilter(){return null!=this.viewFilter?.parsedGeometry}computeNodeFiltering(e){const t=this.viewFilter;return null==t||!this.view.spatialReference||t.isMBSGeometryVisible(e,this.view.spatialReference,this._controller.crsIndex)?w.NodeFilterImpact.Unmodified:w.NodeFilterImpact.Culled}};return e.__decorate([a.property()],G.prototype,"i3slayer",null),e.__decorate([a.property(D.updatingProgress)],G.prototype,"updatingProgress",void 0),e.__decorate([a.property({type:h})],G.prototype,"filter",null),e.__decorate([a.property({readOnly:!0})],G.prototype,"viewFilter",void 0),e.__decorate([a.property(B.requiredFields)],G.prototype,"requiredFields",null),e.__decorate([a.property(B.availableFields)],G.prototype,"availableFields",void 0),e.__decorate([a.property()],G.prototype,"_fieldsHelper",void 0),e.__decorate([a.property()],G.prototype,"_floorFilterClause",null),e.__decorate([a.property()],G.prototype,"_excludeObjectIdsSorted",null),e.__decorate([a.property()],G.prototype,"_setVisibilityHiddenObjectIds",void 0),e.__decorate([a.property()],G.prototype,"_setVisibilityHiddenObjectIdsSorted",null),e.__decorate([a.property()],G.prototype,"lodFactor",null),e.__decorate([a.property()],G.prototype,"updatingProgressValue",null),e.__decorate([a.property({readOnly:!0})],G.prototype,"visibleAtCurrentScale",null),G=e.__decorate([u.subclass("esri.views.3d.layers.SceneLayerView3D")],G),G}))},"esri/core/ReactiveSet":function(){define(["./accessorSupport/tracking","./accessorSupport/tracking/SimpleObservable"],(function(e,t){"use strict";class r{constructor(e){this._observable=new t.SimpleObservable,this._set=new Set(e)}get size(){return e.trackAccess(this._observable),this._set.size}add(e){const t=this._set.size;return this._set.add(e),this._set.size!==t&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(e){const t=this._set.delete(e);return t&&this._observable.notify(),t}entries(){return e.trackAccess(this._observable),this._set.entries()}forEach(t,r){e.trackAccess(this._observable),this._set.forEach(((e,i)=>t.call(r,e,i,this)),r)}has(t){return e.trackAccess(this._observable),this._set.has(t)}keys(){return e.trackAccess(this._observable),this._set.keys()}values(){return e.trackAccess(this._observable),this._set.values()}[Symbol.iterator](){return e.trackAccess(this._observable),this._set[Symbol.iterator]()}[Symbol.dispose](){this._observable.destroy()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}}return r}))},"esri/views/3d/layers/I3SMeshView3D":function(){define(["require","exports","../../../chunks/tslib.es6","../../../Color","../../../Graphic","../../../core/arrayUtils","../../../core/ByteSizeUnit","../../../core/has","../../../core/Logger","../../../core/MapUtils","../../../core/maybe","../../../core/PooledArray","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/scheduling","../../../core/SetUtils","../../../core/typedArrayUtil","../../../core/accessorSupport/decorators/property","../../../core/accessorSupport/decorators/subclass","../../../core/libs/gl-matrix-2/math/mat3","../../../core/libs/gl-matrix-2/factories/mat3f64","../../../core/libs/gl-matrix-2/math/mat4","../../../core/libs/gl-matrix-2/factories/mat4f64","../../../core/libs/gl-matrix-2/factories/quatf64","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../chunks/vec42","../../../core/libs/gl-matrix-2/factories/vec4f64","../../../core/support/UpdatingHandles","../../../geometry/spatialReferenceEllipsoidUtils","../../../geometry/projection/localLinearScaleFactors","../../../geometry/projection/projectBoundingSphere","../../../geometry/projection/projectBuffer","../../../geometry/projection/projectors","../../../geometry/projection/projectVectorToVector","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/DoubleArray","../../../geometry/support/FloatArray","../../../geometry/support/Indices","../../../chunks/sphere","../../../geometry/support/UByteArray","../../../layers/LayerConstants","../../../layers/graphics/controllers/I3SOnDemandController","../../../layers/support/fieldUtils","../../../layers/support/SceneModification","../../../renderers/visualVariables/support/visualVariableUtils","../../../support/basemapUtils","../../../support/elevationInfoUtils","../../../support/guards","../../../support/loadArcade","../../../symbols/MeshSymbol3D","../../../symbols/SimpleFillSymbol","./ContentGeometryLayerView","./I3SMeshViewLabeler","./I3SMeshViewPerformanceInfo","./I3SMeshWorkerHandle","./II3SMeshView3D","./SceneLayerWorker","./graphics/graphicUtils","./graphics/Labeler","./i3s/enums","./i3s/Highlights","./i3s/I3SAsyncElevationUpdater","./i3s/I3SBinaryReader","./i3s/I3SCrossfadeHelper","./i3s/I3SGeometryUtil","./i3s/I3SIntersectionHandler","./i3s/I3SMaterialUtil","./i3s/I3SNode","./i3s/I3SOverrides","./i3s/I3SProjectionUtil","./i3s/I3SUtil","./i3s/IDBCache","./i3s/IDBMockCache","./i3s/LayerElevationProvider","./i3s/SymbologyInfo","./support/attributeUtils","./support/highlightUtils","./support/makeScheduleFunction","./support/symbolColorUtils","../support/debugFlags","../support/ElevationRange","../support/extentUtils","../support/orientedBoundingBox","../support/updatingProperties","../support/buffer/glUtil","../webgl-engine/collections/Component/ObjectParameters","../webgl-engine/collections/Component/SourceGeometry","../webgl-engine/collections/Component/Transform","../webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl","../webgl-engine/lib/BasisUtil","../webgl-engine/lib/edgeRendering/interfaces","../../support/HighlightDefaults","../../support/TextureCompressionTracker","../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z,Y,X,K,J,ee,te,re,ie,se,ne,oe,ae,le,ce,ue,de,he,pe,me,fe,ge,ye,_e,be,ve,Se,we,xe,Te,Ce,Pe,Me,Re,Ee,Oe,Ae,Ie,De,Fe,Le,Ne,Ue,Ve,Be,Ge,ke){"use strict";const ze=[1,1,1,1];class je extends de.NodeCrossfadeMetaData{constructor(e,t,r,i,s,n,o,a,l){super(),this.node=e,this.featureIds=t,this.objectHandle=r,this.cachedRendererVersion=i,this.attributeInfo=s,this.material=n,this.textures=o,this.anchorIds=a,this.anchors=l,this.cachedElevationAnchors=null,this.cachedEdgeMaterials=new Array,this.edgeMemoryUsage=0}get cachedMemory(){return this.node.memory}get featureExtents(){return this._featureExtents??=new Float64Array(6*this.featureIds.length).fill(Number.POSITIVE_INFINITY),this._featureExtents}}var qe;!function(e){e[e.CastShadows=4]="CastShadows",e[e.Pickable=5]="Pickable"}(qe||(qe={}));const He=100*o.ByteSizeUnit.MEGABYTES;var We;!function(e){e[e.ADD=0]="ADD",e[e.REMOVE=1]="REMOVE",e[e.UPDATE=2]="UPDATE"}(We||(We={}));const $e=L.create(),Qe=N.create(),Ze=N.create(),Ye=new Oe.Obb,Xe=new i([0,0,0,0]),Ke=G.fromValues(0,0,0,0);function Je(e){if(null==e)return!1;const t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function et(e){return null!=e&&g.isArrayBuffer(e.data)}function tt(e,t){let r=1024+e.interleavedVertexData.byteLength+(e.indices?e.indices.byteLength:0)+e.positionData.data.byteLength+e.positionData.indices.byteLength;if(null!=t)for(const e of t)null!=e&&g.isArrayBuffer(e.data)&&(r+=e.data.byteLength);return r}class rt{constructor(e,t,r){this.attributeInfo=e,this.meta=t,this.promise=r,this.allowMemCache=!0}}function it(e,t){e.forEach((e=>e.opacity=t))}class st{constructor(e,t){this.mode=e,this.offset=t}}const nt=C.create(),ot=L.create(),at="elevation-change",lt=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],ct=new Re.ElevationRange;function ut(e,t,r){let i=e.elevationRangeMin,s=e.elevationRangeMax;const n=r;if(n>0){t.getCorners(lt);for(const e of lt){const t=T.len(e)-n;i=Math.min(i,t),s=Math.max(s,t)}}else{t.getCorners(lt);for(const e of lt){const t=e[2];i=Math.min(i,t),s=Math.max(s,t)}}e.expandElevationRangeValues(i,s)}function dt(e,t,r){const i=G.getCenter(t),s=r>0?T.len(i)-r:i[2],n=G.getRadius(t);e.expandElevationRangeValues(s-n,s+n)}function ht(e,t,r){const i=new Array,s=e.filteredIds;if(null==s||t?.size||r?.size){if(null!=s){let n=0;e.featureIds.forEach(((e,o)=>{if(s[n]===e)++n;else if(!t?.has(e))return;r?.has(e)||i.push(o)}))}}else e.featureIds.forEach(((e,t)=>{s[i.length]===e&&i.push(t)}));return i}function pt(e,t,r){if(e&&t)for(const i of t){const t=(e.get(i)??0)+r;t>0?e.set(i,t):e.delete(i)}}var mt;function ft(e,t=mt.All){const r=new Map;for(const i of e)pt(r,t===mt.All?i?.featureIds:t===mt.Filtered?i?.filteredIds:i?.weaklyRemovedIds,1);return r}!function(e){e[e.All=0]="All",e[e.Filtered=1]="Filtered",e[e.WeaklyRemoved=2]="WeaklyRemoved"}(mt||(mt={})),t.I3SMeshView3D=t=>{let i=class extends t{constructor(){super(...arguments),this._applySSAO=!0,this._shadeNormals=!0,this._updatingHandles=new R.UpdatingHandles,this._nodeId2Meta=new Map,this._nodeId2MetaReloading=new Map,this._i3sWasmLoaded=!1,this._snappingSourcesTrackers=[],this._compressionTracker=new Ge.TextureCompressionTracker,this._hasLoadedPBRTextures=!1,this._asyncModuleLoading=0,this._addTasks=new Map,this._currentRenderer=null,this._rendererVersion=0,this._colorVariable=null,this._opacityVariable=null,this._rendererFields=null,this._symbologyFields=null,this._symbologyOverride=null,this._symbologyOverrideFields=null,this._symbolInfos=new Map,this._visibleGeometryChangedSchedulerHandle=null,this._hasComponentData=!1,this._hasVertexColors=!1,this._nodeColorOverride=null,this.updating=!0,this.holeFilling="auto",this._hasColors=!1,this._hasTextures=!1,this._hasData=!1,this.slicePlaneEnabled=!1,this._modifications=new Array,this.ignoresMemoryFactor=!1,this._layerUrl="",this._cacheKeySuffix=null,this._planetRadiusInGlobalMode=0,this._elevationTask=null,this._needFilterResolve=!1,this._filters=[],this._arcade=null,this._tmpAttributeOnlyGraphic=new s,this._crossfadeHelper=new de.I3SCrossfadeHelper(this)}get lodCrossfadeoutDuration(){return 0}get lodCrossfadeinDuration(){return 0}get lodCrossfadeUncoveredDuration(){return 0}get layerViewUid(){return this.uid}get layerId(){return this.i3slayer&&this.i3slayer.id}get sublayerId(){return null}get _isIntegratedMesh(){return"integrated-mesh"===this.i3slayer.type}get contentVisible(){return!this.suspended&&this._controller?.rootNodeVisible&&this.fullOpacity>ke.alphaCutoff}get legendEnabled(){return this.contentVisible&&!0===this.i3slayer?.legendEnabled}get updatingProgressValue(){return this._controller?.updatingProgress??0}get hasTexturesOrVertexColors(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}get rendererTextureUsage(){return _e.rendererNeedsTextures(this._currentRenderer)?this._usePBR||this._hasLoadedPBRTextures?ae.TextureUsage.AllTexturesPBR:ae.TextureUsage.AllTextures:this._usePBR||this._hasLoadedPBRTextures?ae.TextureUsage.GeometryTexturesPBR:ae.TextureUsage.GeometryTextures}get elevationOffset(){const e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;return null!=e&&"absolute-height"===e.mode?Q.getElevationOffset(e,this.i3slayer.spatialReference):0}get elevationInfo(){const e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null==e)return new st(ie.ElevationMode.Absolute,0);const t=Q.getElevationOffset(e,this.i3slayer.spatialReference);switch(e.mode){case"absolute-height":return new st(ie.ElevationMode.Absolute,t);case"relative-to-ground":return new st(ie.ElevationMode.RelativeToGround,t);case"on-the-ground":return new st(ie.ElevationMode.OnTheGround,0);default:return new st(ie.ElevationMode.Absolute,0)}}get supportedTextureEncodings(){return me.getSupportedEncodings(this.view.stage.renderView.capabilities)}get clientGeometry(){return this.i3sOverrides.geometryOverrides}get elevationRange(){const e=this._nodeId2Meta,t=new Re.ElevationRange;for(const r of e.values()){if(null==r)continue;const{node:{serviceMbsInIndexSR:e}}=r,[i,s,n,o]=e;t.expandElevationRangeValues(n-o,n+o)}return t.elevationRangeValid?t:null}get fullExtent(){return this.i3slayer.fullExtent}initialize(){const t=a("enable-feature:idb-mock-cache");this._idbCache=t?new ve.IDBMockCache(this.view,t):new be.IDBCache("esri-scenelayer-cache","geometries"),this._preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);const r=this.view.resourceController,i=r.memoryController;this.i3sOverrides=new ge.I3SOverrides({view:this.view,layer:this.i3slayer,memoryController:i}),this._worker=new re.I3SMeshWorkerHandle(Ce.makeScheduleFunction(r)),this.addResolvingPromise(this._worker.promise);const s=this.i3slayer.store;this.addResolvingPromise(this._worker.setLegacySchema(this.uid,s.defaultGeometrySchema).catch(h.ignoreAbortErrors)),_e.checkSceneLayerValid(this.i3slayer),_e.checkSceneLayerCompatibleWithView(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new j({layerView:this,worker:this._worker}),this._gpuMemoryEstimate=0,this._texMemoryEstimate=0,this._geoMemoryEstimate=0,this._stage=this.view.stage,this._collection=this._stage.renderView.componentObjectCollection,this.resetHighlights();const n=s.defaultGeometrySchema;if(this._isIntegratedMesh||!n)this._hasComponentData=!1;else{const e=n.featureAttributes;this._hasComponentData=!!(e&&e.faceRange&&e.id)}this._hasVertexColors=null!=(n?.vertexAttributes.color??null)&&!this.i3slayer.cachedDrawingInfo?.color;const o=this.view.resourceController.memoryController.newCache(`sl-${this.uid}`,(e=>this._deleteComponentObject(e)));this._memCache=o;const c=this._controller,d=this._nodeId2Meta,m=this._nodeId2MetaReloading;this._intersectionHandler=new pe.I3SIntersectionHandler({layerViewUid:this.layerViewUid,sublayerId:this.sublayerId,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:e=>{const t=c.index;if(!t)return;const r=t.rootNode;r&&t.traverse(r,(t=>{const r=t.index,i=d.get(r)||m.get(r);return e(t,i?.objectHandle??null)}))}}),this._elevationProvider=new Se.LayerElevationProvider({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR,this._updatingHandles.add((()=>this.view.clippingArea),(()=>this._clippingAreaChanged()),p.initial),this._updatingHandles.add((()=>this.fullOpacity),(e=>this._opacityChange(e))),this._updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(e))),this._updatingHandles.add((()=>this.elevationOffset),((e,t)=>{this._reloadAll(t),this._controller.invalidateVisibilityObbs()})),this._updatingHandles.add((()=>this.elevationInfo),((e,t)=>this._elevationInfoChanged(e,t)),p.initial),this._updatingHandles.add((()=>!this.suspended&&this.elevationInfo.mode!==ie.ElevationMode.Absolute),((e,t)=>{e?this.addHandles(this.view.basemapTerrain.on("elevation-change",(({extent:e})=>this._ensureElevationTask().addExtent(e))),at):t&&this.removeHandles(at)}),p.initial),this._updatingHandles.add((()=>this._usePBR),(e=>this._updatePBR(e))),this._updatingHandles.add((()=>this.rendererTextureUsage),(()=>{this._reloadAll(),this.clearMemCache()})),this._updatingHandles.add((()=>this.contentVisible),(e=>this._contentVisibleChanged(e)),p.initial),this._updatingHandles.add((()=>this.i3slayer.labelsVisible),(()=>this._labelingChanged()),p.initial),this._updatingHandles.add((()=>this.i3slayer.labelingInfo),(()=>this._labelingChanged()),p.initial),this._updatingHandles.add((()=>this._modifications),(()=>this._modificationsChanged()),p.initial),this.addHandles([p.watch((()=>Me.debugFlags.I3S_TREE_SHOW_TILES),(t=>{if(t&&!this._treeDebugger){const t=this._controller.crsIndex;new Promise(((t,r)=>e(["./support/I3STreeDebugger"],t,r))).then((({I3STreeDebugger:e})=>{!this._treeDebugger&&Me.debugFlags.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new e({lv:this,view:this.view,nodeSR:t}))}))}else t||Me.debugFlags.I3S_TREE_SHOW_TILES||(this._treeDebugger=u.destroyMaybe(this._treeDebugger))}),p.initial),p.watch((()=>Me.debugFlags.I3S_SHOW_MODIFICATIONS),(()=>this._showModifications()),p.initial)]),this._cacheKeySuffix=this._getCacheKeySuffix(),this._idbCache.init().catch((e=>l.getLogger(this).warn(`Failed to initialize IndexedDB cache: ${e}`)));const{view:f}=this,{viewingMode:g,renderCoordsHelper:y}=f;this._planetRadiusInGlobalMode="local"===g?0:y.referenceEllipsoid.radius}destroy(){this._clearAddTasks(),this._elevationTask=u.destroyMaybe(this._elevationTask),this.i3sOverrides=u.destroyMaybe(this.i3sOverrides),this._elevationProvider&&(this._elevationProvider.objectsChanged(this.getVisibleObbs()),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const e=this._worker;e&&(e.destroyContext(this.uid).then((()=>e.destroy())),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache=u.destroyMaybe(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=u.destroyMaybe(this._labeler),this._treeDebugger=u.destroyMaybe(this._treeDebugger),this._controller=u.destroyMaybe(this._controller),this._highlights.destroy(),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this._crossfadeHelper=u.destroyMaybe(this._crossfadeHelper),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null),this._updatingHandles=u.destroyMaybe(this._updatingHandles)}_memEstimateTextureAdded(e){const t=e.usedMemory;return this._gpuMemoryEstimate+=t,this._texMemoryEstimate+=t,t}_memEstimateTextureRemoved(e){if(null!=e){const t=e.usedMemory;this._gpuMemoryEstimate-=t,this._texMemoryEstimate-=t}}_memEstimateGeometryAdded(e){const t=this._collection.getObjectGPUMemoryUsage(e);return this._gpuMemoryEstimate+=t,this._geoMemoryEstimate+=t,t}_memEstimateGeometryRemoved(e){const t=this._collection.getObjectGPUMemoryUsage(e);this._gpuMemoryEstimate-=t,this._geoMemoryEstimate-=t}isNodeLoaded(e){return this._nodeId2Meta.has(e)}isNodeReloading(e){return this._nodeId2MetaReloading.has(e)}get usedMemory(){let e=null!=this._labeler?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((t=>e+=null!=t?t.node.memory:0)),this._nodeId2MetaReloading.forEach((t=>e+=null!=t?t.node.memory:0)),e}get unloadedMemory(){return(null!=this._controller?this._controller.unloadedMemoryEstimate:0)+(null!=this._labeler?this._labeler.unloadedMemoryEstimate:0)}_labelingChanged(){if(!oe.areLabelsVisible(this.i3slayer)||!this._supportsLabeling)return void(null!=this._labeler&&(this._labeler.destroy(),this._labeler=null));if(null!=this._labeler)return;const e=new ee({view:this.view,layer:this.i3slayer,collection:this._collection,overrides:this.i3sOverrides,layerViewUid:this.uid});this._nodeId2Meta.forEach((t=>null!=t&&this._addMetaToLabeler(e,t))),this._labeler=e}_loadAsyncModule(e){return++this._asyncModuleLoading,e.then((e=>(--this._asyncModuleLoading,e)),(e=>{throw--this._asyncModuleLoading,e}))}_modificationsChanged(){if(!this._i3sWasmLoaded&&this.hasModifications)return this._i3sWasmLoaded=se.initialize().then((()=>{this._i3sWasmLoaded=!0,this._modificationsChanged(),this.notifyUpdate()})),void this.notifyUpdate();if(!0!==this._i3sWasmLoaded)return;const e=this.uid,t=this.i3slayer.spatialReference;this._worker.setModifications(e,this._layerClippingArea,this._modifications,t);const r=re.toWasmModification(this._layerClippingArea,this._modifications,t);se.setModificationsSync({context:e,modifications:r,isGeodetic:t.isGeographic}),this._controller.modificationsChanged();const i=this.hasModifications?new d:null;this._nodeId2Meta.forEach(((e,t)=>{null==e?(this._nodeId2Meta.delete(t),this._controller.updateLoadStatus(t,!1)):e.node.hasModifications?(this._updateFeatureIdCounts(e,-1),this._nodeId2Meta.delete(t),this._nodeId2MetaReloading.set(t,e)):null!=i&&i.push(e.node)})),this.notifyChange("elevationRange"),null!=i&&this._nodeId2MetaReloading.forEach((e=>i.push(e.node))),null!=i&&i.length>0&&(this.updateNodeModificationStatus(i),i.forAll((e=>{if(e.imModificationImpact!==fe.NodeIMModificationImpact.Culled){const t=this._nodeId2Meta.get(e.index);this._controller.invalidateGeometryVisibility(e.index),null!=t?(this._updateFeatureIdCounts(t,-1),this._nodeId2Meta.delete(e.index),this._nodeId2MetaReloading.set(e.index,t),this.notifyChange("elevationRange")):this._nodeId2Meta.has(e.index)&&(this._nodeId2Meta.delete(e.index),this._controller.updateLoadStatus(e.index,!1))}}))),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}_showModifications(){if(null!=this._modificationGraphics&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),!Me.debugFlags.I3S_SHOW_MODIFICATIONS||0===this._modifications.length)return;const e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={outline:{color:[255,255,255],width:1}};this._modificationGraphics=[];for(const r of this._modifications){const i=r.geometry;i.spatialReference=this.i3slayer.spatialReference;const n=new K({...t,color:e[r.type]});this._modificationGraphics.push(new s({geometry:i,symbol:n}))}this.view.graphics.addMany(this._modificationGraphics)}_addMetaToLabeler(e,t){e.addNodeMeta(t,((e,t)=>this._createAttributes(e,t)))}_contentVisibleChanged(e){e?(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler)):(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler))}getLoadedAttributes(e){const t=this._nodeId2Meta.get(e);if(null!=t?.attributeInfo)return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this._nodeId2Meta.get(e);if(null!=t?.attributeInfo)return t.attributeInfo.attributeData}setAttributeData(e,t){const r=this._nodeId2Meta.get(e);null!=r?.attributeInfo&&(r.attributeInfo.attributeData=t,this._attributeValuesChanged(r))}async updateAttributes(e,t,r){const i=this._nodeId2Meta.get(e);null!=i&&(await this.i3sOverrides.applyAttributeOverrides(i.featureIds,t,r,this._controller.requiredAttributes),i.attributeInfo=t,this._controller.reschedule((()=>{this._nodeId2Meta.get(e)===i&&this._attributeValuesChanged(i)}),r).catch((e=>{h.isAbortError(e)||l.getLogger(this).warn("Error while updating attribute values. Layer might not display correctly.",e)})))}_attributeValuesChanged(e){e.cachedRendererVersion=this._getInvalidRendererVersion(),e.appliedFilters=null,null!=this._labeler&&this._labeler.setNodeMetaAttributes(e,((e,t)=>this._createAttributes(e,t))),this._updateEngineObject(e)}clearMemCache(){null!=this._memCache&&this._memCache.clear(),this._addTasks.forEach((e=>e.allowMemCache=!1))}getVisibleNodes(){const e=new Array;return this._nodeId2Meta.forEach((t=>null!=t&&e.push(t.node))),e}getVisibleObbs(){const e=new Array;return this._nodeId2Meta.forEach((t=>t&&e.push(this._collection.getComponentObb(t.objectHandle)))),e}getLoadedNodeIndices(e){this._nodeId2Meta.forEach(((t,r)=>e.push(r))),this._nodeId2MetaReloading.forEach(((t,r)=>e.push(r)))}_preLoadBasis(){!a("disable-feature:i3s-basis")&&0!==(this.supportedTextureEncodings&ae.TextureEncoding.Basis)&&this.i3slayer.textureSetDefinitions?.some((e=>e.formats.some((e=>"basis"===e.format||"ktx2"===e.format))))&&Ue.loadBasisTranscoder()}_getVertexBufferLayout(e,t){return Ie.glLayout(Fe.createVertexBufferLayout(this._getGeometryParameters({hasTexture:Je(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion})))}_getObjectIdField(){return this.i3slayer.objectIdField||z.fallbackObjectIDAttribute}_getGlobalIdField(){return this.i3slayer.globalIdField}_findGraphicNodeAndIndex(e){const t=xe.attributeLookup(this.i3slayer.fieldsIndex,e.attributes,this._getObjectIdField());for(const e of this._nodeId2Meta.values()){const r=e?.featureIds.indexOf(t);if(null!=r&&r>=0)return{node:e.node,index:r}}return null}_getGraphicIndices(e,t){const r=this._nodeId2Meta.get(e.index);if(null==r)return[];const i=[],s=this._getObjectIdField(),n=this.i3slayer.fieldsIndex;for(const e of t){const t=xe.attributeLookup(n,e.attributes,s),o=r.featureIds.indexOf(t);-1!==o&&i.push(o)}return i}whenGraphicBounds(e){const t=this._findGraphicNodeAndIndex(e);if(!t)return Promise.reject();const r=this.getAABB(t.node.index,t.index);return null==r?Promise.reject():Promise.resolve({boundingBox:r,screenSpaceObjects:[]})}getAABBFromIntersectorTarget(e){return null==e.nodeIndex||null==e.componentIndex?null:this.getAABB(e.nodeIndex,e.componentIndex)}getAABB(e,t){const r=this._nodeId2Meta.get(e);if(null==r?.featureIds||t>=r.featureIds.length)return null;const i=r.objectHandle,s=he.boundingBoxCornerPoints(t,this._collection,i,U.newDoubleArray(24),0),n=this.view.renderSpatialReference,o=this.view.spatialReference;return I.projectBuffer(s,n,0,s,o,0)?L.fromBuffer(s):null}whenGraphicAttributes(e,t){return _e.whenGraphicAttributes(this.i3slayer,e,this._getObjectIdField(),t,(()=>[...this._nodeId2Meta.values()].filter(n.isSome)))}getGraphicFromIntersectorTarget(t,r){if(null==t.nodeIndex||null==t.componentIndex)return null;const i=this._nodeId2Meta.get(t.nodeIndex);if(null==i?.featureIds||t.componentIndex>=i.featureIds.length)return null;const s=this._createLayerGraphic(this._createAttributes(t.componentIndex,i));return r.defer?(r.defer((async()=>(s.geometry=(await new Promise(((t,r)=>e(["./i3s/meshUtils"],t,r)))).createMesh({layerView:this,nodeIndex:t.nodeIndex,featureIndex:t.componentIndex}),s))),null):s}_getCacheKey(e){return`${this._layerUrl}/v26/${e}${this._cacheKeySuffix}`}_getCacheKeySuffix(){const e=this.view.renderSpatialReference;return null==e?"@null":e===E.getSphericalPCPF(e)?"@ECEF":this.i3slayer.spatialReference.equals(e)?"":null!=e.wkid?`@${e.wkid}`:null}_getMemCacheKey(e,t=this.elevationOffset){return e+"#"+t}get _idbCacheEnabled(){return!this._controller.disableIDBCache&&!this.hasModifications&&0===this.elevationOffset&&null!=this._cacheKeySuffix}loadCachedGPUData(e){return null!=this._memCache?this._memCache.pop(this._getMemCacheKey(e)):null}deleteCachedGPUData(e){null!=e&&this._deleteComponentObject(e)}_cacheGPUData(e,t=this.elevationOffset){if(null==this._memCache)return void this._deleteComponentObject(e);const r=this._controller.indexDepth-e.node.level;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,r)}loadMissingTextures(e,t,r,i){const s=e?.filter(((e,r)=>{if(0===(e.usage&this.rendererTextureUsage))return!1;if(null==t)return!0;const i=me.selectEncoding(e.encodings,this.supportedTextureEncodings),s=t[r];return!!(null==s?.data||i&&s.encoding!==i.encoding)}))??[];return 0===s.length?Promise.resolve(!1):r(s,i).then((r=>{let i=0;for(let s=0;s<e.length;s++)i<r.length&&r[i].id===e[s].id&&(t[s]=r[i],i++);return!0}))}loadCachedNodeData(e,t,r){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e.id),t).then((i=>null==i?null:i.nodeVersion!==e.version?(this._idbCache.remove(this._getCacheKey(e.id)),null):(this.elevationInfo.mode===ie.ElevationMode.Absolute&&(e.geometryObbInRenderSR=Oe.Obb.fromData(i.geometryObbData)),this.loadMissingTextures(i.requiredTextures,i.textureData,r,t).then((r=>(r&&this._idbCache.initialized&&null!=i.textureData&&(i.byteSize=tt(i.transformedGeometry,i.textureData),i.textureData.every(et)&&this._indexedDbSizeCheck(e,i)&&this._idbCache.put(this._getCacheKey(e.id),i).catch((t=>l.getLogger(this).warn(`Failed to update node with textures in IndexedDB cache: ${e.id}: ${t}`)))),h.throwIfAborted(t),i)))))):Promise.resolve(null)}addNode(e,t,r){return function(e){return"geometryData"in e}(t)?null==t.geometryBuffer?(this._addNodeMeta(e.index,null),Promise.resolve()):this._addData(e,t.attributeDataInfo,(()=>this._transformNode(e,t,r).then((i=>this._safeReschedule((()=>{if(null==i)return e.hasModifications=!1,this._addCachedNodeData(e,null,r);e.hasModifications=i.transformedGeometry.hasModifications;const{obb:s,componentOffsets:n,featureIds:o,anchorIds:a,anchors:c,transformedGeometry:u,globalTrafo:d}=i,h=T.set(nt,s.center.x,s.center.y,s.center.z);T.transformMat4(h,h,d);const p=new Oe.Obb(h,[s.extents.x,s.extents.y,s.extents.z],x.fromValues(s.orientation.x,s.orientation.y,s.orientation.z,s.orientation.w));this.elevationInfo.mode===ie.ElevationMode.Absolute&&(e.geometryObbInRenderSR=p),t.geometryData.componentOffsets=n,o&&(t.geometryData.featureIds=Array.from(o)),t.geometryData.anchorIds=a,t.geometryData.anchors=c;const m={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:u,globalTrafo:d,geometryObbData:p.data,byteSize:tt(u,t.textureData)};if(this._idbCacheEnabled&&this._idbCache.initialized&&this._indexedDbSizeCheck(e,m)){const t=null!=m.textureData?m.textureData.map((e=>et(e)?e:null)):null;this._idbCache.put(this._getCacheKey(e.id),{...m,textureData:t}).catch((t=>l.getLogger(this).warn(`Failed to store node in IndexedDB cache: ${e.id}: ${t}`)))}return this._addCachedNodeData(e,m,r)}),r))))):Promise.reject()}getElevationRange(e){const t=new Re.ElevationRange,r=this._controller,{index:i}=r;if(!i)return t;const{rootNode:s}=i;if(!s)return t;const n=this._nodeId2Meta,o=e[3],a=r.viewportQueries,l=this._planetRadiusInGlobalMode,{view:c}=this,{renderCoordsHelper:u}=c,d=u.referenceEllipsoid.radius,h=this._collection;return i.traverse(s,(r=>{const{childrenLoaded:i}=r;if(0===i)return!1;const s=a.getAndUpdateVisibilityObbInRenderSR(r);let c=null,p=-1;if(s){if(p=s.radius,!s.intersectSphereWithMBS(e,p))return!1}else c=a.getServiceMbsInRenderSR(r),c&&(p=c[3]);if(p>=0&&o>=1*p)return null!=s?ut(t,s,l):null!=c&&c[3]>=0&&dt(t,c,l),!1;const m=ct;if(m.elevationRangeMin=1/0,m.elevationRangeMax=-1/0,(null!=s||null!=c)&&(null!=s?ut(m,s,l):null!=c&&dt(m,c,l),m.elevationRangeMin>=t.elevationRangeMin&&m.elevationRangeMax<=t.elevationRangeMax))return!1;const f=n.get(r.index);if(f){const{geometryObbInRenderSR:i}=r;if(!i||i.intersectSphereWithMBS(e)){if(i&&o>0*i.radius)return ut(t,i,l),!1;const{objectHandle:e}=f,r=h.getObjectTransform(e),s=u.getAltitude(r.position);h.expandRangeWithComponentObjectElevationRange(e,s,d,t)}}return i-(f?1:0)>0})),t}computeVisibilityObb(e){return _e.computeVisibilityObb(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications,this.view.renderCoordsHelper.sphericalPCPF)}_transformNode(e,t,r){const i=t.geometryData.geometries??[],s=new Array(i.length);for(let e=0;e<i.length;++e)s[e]=this._getVertexBufferLayout(i[e],t.geometryDescriptor);const n=this.i3slayer.normalReferenceFrame,o=t.normalReferenceFrame??n??"none",a=e.serviceMbsInIndexSR,l=this.elevationOffset,c=this._controller.crsIndex,u=this._controller.crsVertex,d=this.view.renderSpatialReference,h=ye.computeGlobalTransformation(a,l,o,c,d),p=D.getProjectorName(c,u),m=D.getProjectorName(u,d);if(null==p||null==m)return Promise.resolve(null);const f={context:this.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:s,globalTrafo:h,mbs:a,obbData:e.serviceObbInIndexSR?.data,elevationOffset:l,needNormals:this._controller.isMeshPyramid,normalReferenceFrame:o,indexToVertexProjector:p,vertexToRenderProjector:m};return this._worker.invoke(f,r)}get _supportsNodeCrossFading(){return!this.view?.stage?.renderer.shadowsEnabled}get nodeCrossfadingEnabled(){return this._supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}get nodeFadeoutEnabled(){return this._supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}_setNewNodeOpacity(e){const t=this.nodeCrossfadingEnabled?0:this.fullOpacity;this._setNodeOpacity(e,t)}addCachedGPUData(e,t,r){if(this.elevationInfo.mode===ie.ElevationMode.Absolute&&(e.geometryObbInRenderSR=this._collection.getComponentObb(t.objectHandle).clone()),!this._controller.isGeometryVisible(e))return void this._cacheGPUData(t);null!=this._labeler&&this._addMetaToLabeler(this._labeler,t);const i=e.index;this._addNodeMeta(i,t),this.updateNodeState(i,r),this._collection.setObjectVisibility(t.objectHandle,!0),this._updateMaterial(t),this._setNewNodeOpacity(t),this.elevationInfo.mode!==ie.ElevationMode.Absolute&&this._ensureElevationTask().schedule(i),this._updateEngineObject(t),this._highlights.objectCreated(t),null!=this._treeDebugger&&this._treeDebugger.update()}addCachedNodeData(e,t,r,i){return this._addData(e,r,(()=>this._addCachedNodeData(e,t,i)))}async deleteCachedNodeData(e){if(this._idbCacheEnabled)return this._idbCache.remove(this._getCacheKey(e))}async _addCachedNodeData(e,t,r){if(!this.contentVisible||!this._controller.isGeometryVisible(e))return void this._removeNodeStageData(e.index,this.elevationOffset,this._nodeId2MetaReloading);if(null==t)return void this._addNodeMeta(e.index,null);const i=this._addTasks.get(e.index),{geometryData:s,transformedGeometry:n,globalTrafo:o}=t;await this.i3sOverrides.applyAttributeOverrides(s.featureIds,i.attributeInfo,r,this._controller.requiredAttributes);const c=null!=t.textureData?t.textureData.filter((e=>null!=e&&0!==(e.usage&this.rendererTextureUsage))):[];!a("disable-feature:i3s-basis")&&c.some((e=>null!=e&&(e.encoding===ae.TextureEncoding.Basis||e.encoding===ae.TextureEncoding.KTX2)))&&await Ue.loadBasisTranscoder(),e.memory=0;const{componentOffsets:u,geometries:d,featureIds:h,anchorIds:p,anchors:m}=s,f=this._collection,g=d[0],{layout:y,indices:_,interleavedVertexData:x,positionData:P,hasColors:R}=n,{material:E,geometryParameters:A}=this._materialParameters(g,y),I=u||new Uint32Array([0,_?_.length:x.byteLength/y[0].stride]),D={vertices:{data:x,count:x.byteLength/y[0].stride,layoutParameters:A},positionData:{positions:V.compactFloatArray(P.data),indices:B.compactIndices(P.indices)},indices:_,componentOffsets:I},L=g.transformation?w.clone(g.transformation):w.create();S.multiply(L,o,L);const N=S.getTranslation(C.create(),L),U=b.fromMat4(v.create(),L),G=this.view.renderSpatialReference,k=this.view.basemapTerrain.spatialReference,z=Oe.Obb.fromData(t.geometryObbData).center,j=[1,1,1];O.localLinearScaleFactors(z,G,j,k)||l.getLogger(this).errorOnce("Unsupported coordinate system for IM overlay");const q=C.create();F.projectVectorToVector(z,G,q,k);const H=v.create();b.invert(H,U);const W=C.create();T.transformMat3(W,T.sub(W,z,N),H);const $=q[0]-W[0]*j[0],Q=q[1]-W[1]*j[1],Z=f.createObject(new De.ObjectParameters(M.fromValues($,Q,j[0],j[1]),new Le.Transform(N,U),Oe.Obb.fromData(t.geometryObbData),D)),Y=A.textureCoordinates===Ne.TextureCoordinateType.Atlas,{textures:X,texturePromise:K}=this._initMaterialAndTextures(Z,E,c,Y,e);e.memory+=this._memEstimateGeometryAdded(Z),e.memory+=X.reduce(((e,t)=>e+(null!=t?this._memEstimateTextureAdded(t):0)),0);const J=!!E.hasParametersFromSource,ee="blend"!==E.alphaMode&&E.metallicRoughness.baseColorFactor[3]>=1,te=new je(e,h,Z,this._getInvalidRendererVersion(),i.attributeInfo,{hasParametersFromSource:J,isOpaque:ee},X,p,m);i.meta=te,this._hasTextures||=t.requiredTextures?.some((({usage:e})=>0!==(e&ae.TextureUsage.ColorTextures)))||!!e.resources.texture,this._hasData=!0,this._hasColors||=R,this.notifyChange("hasTexturesOrVertexColors");const re=this.slicePlaneEnabled;return Promise.all([this._addOrUpdateEdgeRendering(te),K]).then((([t,i])=>(this._addTasks.has(e.index)&&t?.updateObjectVisibility(te.objectHandle,!1).catch((e=>this._logEdgeViewError(e,this.i3slayer.title))),this._safeReschedule((()=>{const r=this._addTasks.get(e.index);if(!r)return;if(this._addNodeMeta(e.index,te),r.meta=null,!this.contentVisible)return void this._removeNodeStageData(e.index,this.elevationOffset);f.setObjectVisibility(Z,!0),t?.updateObjectVisibility(te.objectHandle,!0).catch((e=>this._logEdgeViewError(e,this.i3slayer.title))),te.attributeInfo=r.attributeInfo;const i=te.cachedRendererVersion!==this._rendererVersion,s=re!==this.slicePlaneEnabled;this._updateElevationOffsets(te);const n=te.elevationOffsets;this._updateComponentData(te);const o=this._applyFiltersToNode(te);(i||null!=t&&(s||o||n))&&this._addOrUpdateEdgeRendering(te),null!=this._labeler&&this._addMetaToLabeler(this._labeler,te),this._visibleGeometryChanged(te,We.ADD),this._highlights.objectCreated(te),this._updateMaterial(te),this._setNewNodeOpacity(te),null!=this._treeDebugger&&this._treeDebugger.update()}),r)))).catch((e=>{const{meta:t,allowMemCache:r}=i;throw i.meta=null,t&&r?this._cacheGPUData(t):t&&this._deleteComponentObject(t),e}))}_addNodeMeta(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){l.getLogger(this).error("Removing duplicated node");const t=this._nodeId2Meta.get(e);t&&(this._deleteComponentObject(t),this._updateFeatureIdCounts(t,-1))}else this._controller.updateLoadStatus(e,!0);t&&(t.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&it(t.cachedEdgeMaterials,0),this._updateFeatureIdCounts(t,1)),this._nodeId2Meta.set(e,t),this.notifyChange("elevationRange")}_updateElevationOffsets(e){const t=this.view.renderSpatialReference,r=this._controller.crsIndex,i=this.elevationInfo,s=this.view.basemapTerrain,n=s.spatialReference,o=i.mode;if(null==t||null==n||o===ie.ElevationMode.Absolute)return void(e.elevationOffsets=null);const a=this._collection.getObjectTransform(e.objectHandle);e.elevationOffsets=e.elevationOffsets??[];const l=nt,c=ot,u=o===ie.ElevationMode.OnTheGround,d=this.view.renderCoordsHelper,h=e.featureIds.length,p=(()=>{if(e.cachedElevationAnchors)return e.cachedElevationAnchors;const i=U.newDoubleArray(3*h);e.cachedElevationAnchors=i;for(let s=0;s<h;s++){const o=3*s,u=e.anchorIds?.indexOf(s)??-1;e.anchors&&u>=0?(T.set(l,e.anchors[3*u],e.anchors[3*u+1],e.anchors[3*u+2]),T.add(l,l,G.getCenter(e.node.serviceMbsInIndexSR)),F.projectVectorToVector(l,r,l,n),i[o]=l[0],i[o+1]=l[1],i[o+2]=d.getAltitude(l)):(this._collection.getComponentAabb(e.objectHandle,s,c,!0),T.set(l,(c[0]+c[3])/2,(c[1]+c[4])/2,c[2]),T.transformMat3(l,l,a.rotationScale),T.add(l,l,a.position),i[o+2]=d.getAltitude(l),F.projectVectorToVector(l,t,l,n),i[o]=l[0],i[o+1]=l[1])}return i})(),m=i.offset,f=e.elevationOffsets;s.getElevations(p,h,((e,t)=>{const r=u?p[3*e+2]:0;f[e]=m+(t??0)-r}))}_ensureElevationTask(){return null!=this._elevationTask||(this._elevationTask=new ce.I3SAsyncElevationUpdater(this.view.resourceController.scheduler,(e=>this._controller.updateElevationChanged(e,this.view.basemapTerrain.spatialReference)?.filterInPlace((e=>null!=this._nodeId2Meta.get(e)))),(e=>this._nodeElevationAlignmentChanged(this._nodeId2Meta.get(e))),(()=>this.elevationInfo?.mode))),this._elevationTask}_elevationInfoChanged(e,t){const r=e.mode!==ie.ElevationMode.Absolute,i=!!t&&t!==e&&t.mode!==ie.ElevationMode.Absolute;this._intersectionHandler.updateElevationAlignState(r,this.view.state.viewingMode),r&&!i&&this._controller.removeAllGeometryObbs(),this._nodeId2Meta.forEach((e=>this._nodeElevationAlignmentChanged(e)))}_nodeElevationAlignmentChanged(e){null!=e&&(this._updateElevationOffsets(e),this._updateComponentData(e),this._updateEdgeRendering(e),null!=this._labeler&&this._labeler.updateLabelPositions(e),this._updateSnappingSources(e,We.UPDATE),this._elevationProvider.objectChanged(this._collection.getComponentObb(e.objectHandle)))}_safeReschedule(e,t){return h.throwIfAborted(t),this._controller.reschedule(e,t)}_materialParameters(e,t){const r=null!=e.params.material?e.params.material:me.defaultMaterial(),i=t.some((e=>"uvRegion"===e.name)),s=t.some((e=>"normalCompressed"===e.name)),n=Je(r);return{geometryParameters:this._getGeometryParameters({hasTexture:n,hasNormals:s,hasRegions:i}),material:r}}_initMaterialAndTextures(e,t,r,i,s){const n=this._stage.renderView,o=e=>{this._gpuMemoryEstimate-=e,this._texMemoryEstimate-=e,s.memory-=e},a=r.map((e=>me.createTexture(e,t,i,n,this._compressionTracker,o)));this._stage.addTextures(a);let l=null;return this._collection.updateMaterial(e,(e=>{l=me.configureMaterial(e,t,a,r,this.view.stage.renderView.textures,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR,isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference}),this._updateMaterialOverlay(e)})),{textures:a,texturePromise:l}}_getGeometryParameters(e){return new Fe.GeometryParameters(this._hasVertexColors,e.hasTexture?e.hasRegions?Ne.TextureCoordinateType.Atlas:Ne.TextureCoordinateType.Default:Ne.TextureCoordinateType.None,e.hasNormals,this._shadeNormals,this._applySSAO)}_addData(e,t,r){let i=this._addTasks.get(e.index);if(i)i.attributeInfo=t;else{const s=h.createResolver();i=new rt(t,null,s.promise),this._addTasks.set(e.index,i),r().then(s.resolve,s.reject).then((()=>this._addTasks.delete(e.index))).catch((t=>{throw this._addTasks.delete(e.index),t}))}return i.promise}_clearAddTasks(){this._addTasks.forEach((e=>{null!=e.meta&&(this._cacheGPUData(e.meta),e.meta=null)})),this._addTasks.clear()}_clippingAreaChanged(){const e=this.view.renderSpatialReference,t=this.i3slayer.spatialReference,r=N.create();this._renderClippingArea=Ee.toBoundingRect(this.view.clippingArea,r,e)?r:null;const i=N.create();this._layerClippingArea=Ee.toBoundingRect(this.view.clippingArea,i,t)?i:null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea),this._isIntegratedMesh&&this._modificationsChanged()}get hasGeometryFilter(){return!1}_geometryFilterChange(){const e=this.hasGeometryFilter;this._controller.geometryFilterChanged(e),this._applyFilters(e),this._assertFeatureIdNodeCounts(e)}_assertFeatureIdNodeCounts(e){e&&!this._featureIdCounts?(this._featureIdCounts=ft(this._nodeId2Meta.values()),this._filteredIdCounts=ft(this._nodeId2Meta.values(),mt.Filtered),this._weaklyRemovedIdCounts=ft(this._nodeId2Meta.values(),mt.WeaklyRemoved),this.addHandles(p.watch((()=>this._controller.updating),(e=>{!e&&this._needFilterResolve&&(this.multiGeometryFilterResolve(),this._needFilterResolve=!1,this.notifyUpdate())}),{sync:!0}),"updateFinished")):!e&&this._featureIdCounts&&(this._featureIdCounts=null,this._filteredIdCounts=null,this._weaklyRemovedIdCounts=null,this._mismatchShow=null,this._mismatchHide=null,this.removeHandles("updateFinished"),this._needFilterResolve=!1,this.notifyUpdate())}_updateFeatureIdCounts(e,t){this._featureIdCounts&&(this._needFilterResolve=!0,pt(this._featureIdCounts,e.featureIds,t),pt(this._filteredIdCounts,e.filteredIds,t),pt(this._weaklyRemovedIdCounts,e.weaklyRemovedIds,t))}_updateFilteredIdCounts(e,t,r){this._filteredIdCounts&&(this._needFilterResolve=!0,pt(this._filteredIdCounts,t,-1),pt(this._filteredIdCounts,e.filteredIds,1),pt(this._weaklyRemovedIdCounts,r,-1),pt(this._weaklyRemovedIdCounts,e.weaklyRemovedIds,1))}_checkFeatureIdNodeCountInvariant(){const e=null!=this._featureIdCounts;if(this.hasGeometryFilter!==e&&l.getLogger(this).error("checkFeatureIdNodeCountInvariant()","LayerView should have feature id node counts if and only if it has a geometry filter",{layerView:this,hasNodeCounts:e}),!this._featureIdCounts||!this._filteredIdCounts)return;const t=ft(this._nodeId2Meta.values());c.equals(this._featureIdCounts,t)||l.getLogger(this).error("checkFeatureIdNodeCountInvariant()","Incorrect _featureIdCounts",{layerView:this,counts:this._featureIdCounts,expected:t});const r=ft(this._nodeId2Meta.values(),mt.Filtered);c.equals(this._filteredIdCounts,r)||l.getLogger(this).error("checkFeatureIdNodeCountInvariant()","Incorrect _filteredIdCounts",{layerView:this,counts:this._filteredIdCounts,expected:r});const i=ft(this._nodeId2Meta.values(),mt.WeaklyRemoved);c.equals(this._weaklyRemovedIdCounts,i)||l.getLogger(this).error("checkFeatureIdNodeCountInvariant()","Incorrect _weaklyRemovedIdCounts",{layerView:this,counts:this._weaklyRemovedIdCounts,expected:r})}multiGeometryFilterResolve(){if(!this._featureIdCounts||!this._filteredIdCounts)return;let e=null,t=null;for(const[r,i]of this._filteredIdCounts){const s=this._featureIdCounts.get(r);s!==i&&(i+(this._weaklyRemovedIdCounts?.get(r)??0)===s?(e??=new Set,e.add(r)):(t??=new Set,t.add(r)))}f.equals(e,this._mismatchShow)&&f.equals(t,this._mismatchHide)||(this._mismatchShow=e,this._mismatchHide=t,this._nodeId2Meta.forEach((e=>{if(!e?.filteredIds)return;const t=ht(e,this._mismatchShow,this._mismatchHide);this._collection.setAllComponentVisibilities(e.objectHandle,t),this._visibleGeometryChanged(e,We.UPDATE)})))}_filterChange(){this._applyFilters(this.hasGeometryFilter)}_applyFilters(e){this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((e=>{e&&this._applyFiltersToNode(e)&&(this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e,We.UPDATE))}))}getFilters(){const e=[],t=this._renderClippingArea;return null!=t&&e.push(((e,r)=>this._boundingRectFilter(e,r,t))),e}addSqlFilter(e,t,r){if(null!=t){const i=t.fieldNames;e.push(((e,s)=>this._sqlFilter(e,s,t,i,r)))}}_sqlFilter(e,t,r,i,s){const n={},o=this._createLayerGraphic(n),a=this.i3slayer.objectIdField,l=t.featureIds,c=t.attributeInfo?.attributeData;i.every((e=>e===a||null!=c?.[e]))&&_e.filterInPlace(e,l,(e=>{n[a]=l[e];for(const t of i)t!==a&&(n[t]=c?ue.getCachedAttributeValue(c[t],e):null);try{return r.testFeature(o)}catch(e){return s(e),!1}}))}_boundingRectNodeTest(e,t){return A.projectBoundingSphere(e.node.serviceMbsInIndexSR,this._controller.crsIndex,Ke,this.view.renderSpatialReference),_e.intersectBoundingRectWithMbs(t,Ke)}_boundingRectFeatureTest(e,t,r){return this._collection.getComponentAabb(e.objectHandle,t,$e),L.toRect($e,Qe),N.intersects(r,Qe)}_boundingRectFilter(e,t,r){const i=this._collection,s=this._boundingRectNodeTest(t,r);if(s===_e.MbsIntersectResult.INSIDE)return;if(s===_e.MbsIntersectResult.OUTSIDE)return void(e.length=0);const n=i.getComponentCount(t.objectHandle);if(n.invisible+n.visible!==t.featureIds.length)return;const o=this._transformClippingArea(Ze,r,t.objectHandle);_e.filterInPlace(e,t.featureIds,(e=>this._boundingRectFeatureTest(t,e,o)))}_transformClippingArea(e,t,r){const i=this._collection.getObjectTransform(r),s=i.position,n=i.rotationScale;return e[0]=(t[0]-s[0])/n[0],e[1]=(t[1]-s[1])/n[4],e[2]=(t[2]-s[0])/n[0],e[3]=(t[3]-s[1])/n[4],e}async _addOrUpdateEdgeRendering(e,t=!0){const r=e.objectHandle,{hasEdges:i,perFeatureEdgeMaterials:s}=this._getFilteredEdgeMaterials(e);i&&!this._edgeView&&(this._edgeView=await this._stage.renderer.loadEdgeView());const n=this._edgeView;if(!n)return null;const o=n.hasObject(r);if(i){if(o)return this.nodeCrossfadingEnabled&&it(s,this.getNodeOpacity(e)),n.updateAllComponentMaterials(r,s,this.slicePlaneEnabled,t).catch((e=>this._logEdgeViewError(e,this.i3slayer.title))),n.updateObjectVisibility(r,!0).catch((e=>this._logEdgeViewError(e,this.i3slayer.title))),n.updateAllVerticalOffsets(r,e.elevationOffsets).catch((e=>this._logEdgeViewError(e,this.i3slayer.title))),n;const i=await this._collection.addEdges(r,n,s,this.slicePlaneEnabled,e.elevationOffsets);return e.edgeMemoryUsage=i,e.node.memory+=i,n}return o&&(e.node.memory-=e.edgeMemoryUsage,e.edgeMemoryUsage=0,n.removeObject(r)),null}_applyFiltersToNode(e){const{filteredIds:t,weaklyRemovedIds:r}=e,i=this._applyFiltersToNodeComponents(e);return this._updateFilteredIdCounts(e,t,r),i&&this._labeler?.applyFilterChange(e),i}_applyFiltersToNodeComponents(e){const t=this._collection,r=t.getComponentCount(e.objectHandle),i=null!=e.filteredIds,s=0===r.invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!s;if(null!=e.filteredIds&&e.appliedFilters===this._filters||(e.weaklyRemovedIds=null,e.filteredIds=function(e,t){const r=e.featureIds.slice();for(const i of t)if(i(r,e),0===r.length)break;return r.length===e.featureIds.length?e.featureIds:r}(e,this._filters),e.appliedFilters=this._filters),i&&e.filteredIds===e.featureIds&&(!this._mismatchHide||e.filteredIds.every((e=>!this._mismatchHide?.has(e)))))return!s;const n=ht(e,this._mismatchShow,this._mismatchHide);return t.setAllComponentVisibilities(e.objectHandle,n),!0}_removeAllNodeDataFromStage(e=this.elevationOffset){this._nodeId2Meta.forEach(((t,r)=>this._removeNodeStageData(r,e))),this._nodeId2MetaReloading.forEach(((t,r)=>this._removeNodeStageData(r,e,this._nodeId2MetaReloading))),this._elevationTask=u.destroyMaybe(this._elevationTask)}removeNode(e){const t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading),null!=this._elevationTask&&this._elevationTask.remove(e)}_removeNodeStageData(e,t,r=this._nodeId2Meta){r.has(e)&&this._controller.updateLoadStatus(e,!1);const i=r.get(e);null!=i?(this._collection.setObjectVisibility(i.objectHandle,!1),null!=this._edgeView&&this._edgeView.hasObject(i.objectHandle)&&this._edgeView.updateObjectVisibility(i.objectHandle,!1).catch((e=>this._logEdgeViewError(e,this.i3slayer.title))),this._visibleGeometryChanged(i,We.REMOVE),null!=this._labeler&&this._labeler.removeNodeMeta(i),r.delete(e),this._highlights.objectDeleted(i),r===this._nodeId2Meta?(this._updateFeatureIdCounts(i,-1),this._cacheGPUData(i,t),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(i)):this._deleteComponentObject(i),null!=this._treeDebugger&&this._treeDebugger.update()):r.delete(e)}_deleteComponentObject(e){if(null!=this._edgeView&&this._edgeView.removeObject(e.objectHandle),this._memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(const t of e.textures)this._memEstimateTextureRemoved(t),this._stage.removeTexture(t)}updateNodeState(e,t){const r=this._nodeId2Meta.get(e);null!=r&&this._collection.updateMaterial(r.objectHandle,(e=>e.polygonOffsetEnabled=t===fe.NodeState.Hole))}updateNodeIndex(e,t){if(this._nodeId2Meta.has(e)){const r=this._nodeId2Meta.get(e);this._nodeId2Meta.delete(e),this._nodeId2Meta.set(t,r),this.notifyChange("elevationRange")}const r=this._nodeId2MetaReloading.get(e);r&&(this._nodeId2MetaReloading.delete(e),this._nodeId2MetaReloading.set(t,r))}_invalidateAllSymbols(){this._rendererVersion=_e.addWraparound(this._rendererVersion,1),this._controller?.requestUpdate()}_getInvalidRendererVersion(){return _e.addWraparound(this._rendererVersion,-1)}async _rendererChange(e){if(this._currentRenderer=e,this.notifyChange("rendererTextureUsage"),this._rendererVersion=_e.addWraparound(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e&&(this._rendererFields=await e.getRequiredFields(this.i3slayer.fieldsIndex)),this._updateSymbologyFields(),!this._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired&&(this._arcade=await Y.loadArcade()),e&&"visualVariables"in e&&e.visualVariables)for(const t of e.visualVariables)"color"===t.type?this._colorVariable=t:"opacity"===t.type?this._opacityVariable=t:l.getLogger(this).warn(`Unsupported visual variable type for 3D Object Scene Services: ${t.type}`);if(e)for(const t of e.symbols)"mesh-3d"!==t.type&&l.getLogger(this).error(`Symbols of type '${t.type}' are not supported for 3D Object Scene Services.`);this._controller&&this._controller.requestUpdate()}_getCachedEdgeMaterials(e){return this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials}_getComponentParameters(e){this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);const t=e.cachedSymbology;return(r,i)=>{const s=5*r;P.set(i.externalColor,t[s]/255,t[s+1]/255,t[s+2]/255,t[s+3]/255);const n=this._stage.renderView.olidRenderHelper;if(n){const t=e.featureIds[r],s=this.sublayerId?`${this.layerViewUid}_${this.sublayerId}`:this.layerViewUid,o=$.isBasemapLayerView(this.view,this.uid);n.setUidToObjectAndLayerId(t,t,this.layerId,s,this.layerPopupEnabledAndHasTemplate&&!o,e.node.resources.attributes,r,this.sublayerId),i.objectAndLayerIdColor=n.getObjectAndLayerIdColor({graphicUid:t,layerViewUid:s})}i.externalColorMixMode=t[s+4]&(1<<qe.CastShadows)-1,i.castShadows=!!(t[s+4]&1<<qe.CastShadows),i.pickable=!!(t[s+4]&1<<qe.Pickable),i.elevationOffset=e.elevationOffsets?.[r]??0}}_getSymbolInfo(e,t){const r=e?.getSymbol(t,{arcade:this._arcade});if(!(r instanceof X))return null;const i=r.id;if(this._symbolInfos.has(i))return this._symbolInfos.get(i);const s=_e.getSymbolInfo(r);return this._symbolInfos.set(i,s),s}_setSymbologyOverride(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())}_updateSymbologyFields(){this._symbologyFields=null!=this._symbologyOverrideFields&&this._symbologyOverrideFields.length>0?null!=this._rendererFields&&this._rendererFields.length>0?q.fixFields(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields}_updateCachedRendererData(e){if(e.cachedRendererVersion=this._rendererVersion,!this._hasComponentData)return;const t=this._tmpAttributeOnlyGraphic,r={};t.attributes=r;const i=this._currentRenderer,s=e.attributeInfo?.attributeData,n=e.featureIds?this.i3slayer.objectIdField:null,o=null!=s&&null!=this._symbologyFields&&this._symbologyFields.length>0;let a=null,l=null;if(o&&null!=this._symbologyFields){a=[],l=[];for(const e of this._symbologyFields){const t=s[e];t&&(a.push(e),l.push(t))}}e.cachedSymbology||(e.cachedSymbology=k.newUByteArray(5*e.featureIds.length));const c=new we.SymbologyInfo,u=this.fullOpacity,d=this.nodeCrossfadingEnabled?this.getNodeOpacity(e):u;let h=null,p=Ve.Transparency.OPAQUE,m=_e.transparentEdgeMaterial,f=0;for(let s=0;s<e.featureIds.length;s++){if(null!=n&&(r[n]=e.featureIds[s]),o&&a)for(let e=0;e<a.length;e++)r[a[e]]=ue.getCachedAttributeValue(l[e],s);const u=i?this._getSymbolInfo(i,t):null;let g,y;if(c.pickable=!0,i&&"visualVariables"in i){if(this._colorVariable){const e=W.getColor(this._colorVariable,t,{color:Xe,arcade:this._arcade});e&&(g=c.color,g[0]=e.r/255,g[1]=e.g/255,g[2]=e.b/255,g[3]=e.a??1,this._opacityVariable||null===e.a||(y=e.a))}this._opacityVariable&&(y=W.getOpacity(this._opacityVariable,t,{arcade:this._arcade}))}if(u?.material){const e=u.material;g=null==g||null==y?ne.overrideColor(g,y,e.color,e.alpha,ze,c.color):ne.overrideColor(g,y,null,null,ze,c.color)}if(g??=P.set(c.color,1,1,1,1),c.colorMixMode=u?.material?.colorMixMode??Pe.ColorMixModeEnum.Multiply,c.edgeMaterial=u?.edgeMaterial,this._symbologyOverride?.(t,c),null!=this._nodeColorOverride&&(this._nodeColorOverride(e.node,g),c.colorMixMode=Pe.ColorMixModeEnum.Replace),c.pickable&&=g[3]>=ke.alphaCutoff,c.castShadows=u?u.castShadows:c.pickable,null!=c.edgeMaterial){const t=g[3]>=1&&(e.material.isOpaque||c.colorMixMode===Pe.ColorMixModeEnum.Replace)?Ve.Transparency.OPAQUE:Ve.Transparency.TRANSPARENT;c.edgeMaterial===h&&t===p||(m={...c.edgeMaterial,opacity:d,objectTransparency:t},h=c.edgeMaterial,p=t),e.cachedEdgeMaterials[s]=m}else e.cachedEdgeMaterials[s]=_e.transparentEdgeMaterial;e.cachedSymbology[f++]=Math.round(255*g[0]),e.cachedSymbology[f++]=Math.round(255*g[1]),e.cachedSymbology[f++]=Math.round(255*g[2]),e.cachedSymbology[f++]=Math.round(255*g[3]),e.cachedSymbology[f++]=c.colorMixMode|+c.castShadows<<qe.CastShadows|+c.pickable<<qe.Pickable}}_getFilteredEdgeMaterials(e){const t=this._getCachedEdgeMaterials(e);this.nodeCrossfadingEnabled||it(t,this.fullOpacity);const r=e.filteredIds;if(null==r)return{hasEdges:t.some((e=>e!==_e.transparentEdgeMaterial)),perFeatureEdgeMaterials:t};let i=0,s=!1;const n=t.map(((t,n)=>e.featureIds[n]!==r[i]?_e.transparentEdgeMaterial:(s=s||t!==_e.transparentEdgeMaterial,i++,t)));return{hasEdges:s,perFeatureEdgeMaterials:n}}_updateComponentData(e){if(!this._hasComponentData)return;const t=e.objectHandle,r=this._getComponentParameters(e);this._collection.setComponentData(t,r),this._stage.renderView.requestRender()}_reloadAll(e=this.elevationOffset){this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()}_opacityChange(e){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach((t=>{null!=t&&(this._collection.updateMaterial(t.objectHandle,(t=>t.objectOpacity=e)),it(t.cachedEdgeMaterials,e),this._updateEdgeRendering(t))}))}_updateMaterial(e){this._collection.updateMaterial(e.objectHandle,(e=>{e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.usePBR=this._usePBR,this._updateMaterialOverlay(e)}))}_updateMaterialOverlay(e){}_updateEngineObject(e){this._updateComponentData(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e,We.UPDATE)}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),null!=this._labeler&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach((t=>{null!=t&&(this._collection.updateMaterial(t.objectHandle,(t=>t.commonMaterialParameters.hasSlicePlane=e)),this._updateEdgeRendering(t,!1))}))}_updatePBR(e){this._nodeId2Meta.forEach((t=>{null!=t&&this._collection.updateMaterial(t.objectHandle,(t=>t.usePBR=e))})),this._hasLoadedPBRTextures=!0}get _usePBR(){return this._shadeNormals&&this.view.qualitySettings.physicallyBasedRenderingEnabled}_updateEdgeRendering(e,t=!0){null!=this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)}_forAllNodes(e){this._nodeId2Meta.forEach(e)}_ignoreClientNodeOverriddenFeatures(e){return this.i3sOverrides.hasGeometryChanges?(t,r,i)=>i.node.index>=0&&this.i3sOverrides.featureHasGeometryChanges(t)?ie.ForAllFeaturesReturnType.CONTINUE:e(t,r,i):e}_forAllFeatures(e,t,r){for(const i of this._nodeId2Meta.values()){if(null==i)continue;if(null!=t)switch(t(i.node.serviceMbsInIndexSR)){case ie.ForAllFeaturesReturnType.EXIT:return;case ie.ForAllFeaturesReturnType.SKIP:continue}let s=ie.ForAllFeaturesReturnType.CONTINUE;switch(r){case ie.ForAllFeaturesMode.ALL:s=this._forAllFeaturesOfNode(i,e);break;case ie.ForAllFeaturesMode.VISIBLE_ONLY:s=this._forAllVisibleFeaturesOfNode(i,e);break;case ie.ForAllFeaturesMode.QUERYABLE:s=this._forAllQueryableFeaturesOfNode(i,e)}if(s===ie.ForAllFeaturesReturnType.EXIT)return}}_forAllFeaturesOfNode(e,t){let r=ie.ForAllFeaturesReturnType.CONTINUE;const i=e.featureIds;for(let s=0;s<i.length;s++)if(r=t(i[s],s,e),r===ie.ForAllFeaturesReturnType.EXIT)return r;return r}_forAllVisibleFeaturesOfNode(e,t){let r=ie.ForAllFeaturesReturnType.CONTINUE;const i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,(s=>(r=t(i[s],s,e),r===ie.ForAllFeaturesReturnType.CONTINUE))),r}_forAllQueryableFeaturesOfNode(e,t){const r=this._ignoreClientNodeOverriddenFeatures(t);if(null==this._renderClippingArea)return this._forAllFeaturesOfNode(e,r);const i=this._boundingRectNodeTest(e,this._renderClippingArea);if(i===_e.MbsIntersectResult.OUTSIDE)return ie.ForAllFeaturesReturnType.CONTINUE;if(i===_e.MbsIntersectResult.INSIDE)return this._forAllFeaturesOfNode(e,r);const s=ie.ForAllFeaturesReturnType.CONTINUE,n=e.featureIds,o=e.objectHandle,a=_e.getClipRect(this._renderClippingArea,this._collection.getObjectTransform(o));for(let t=0;t<n.length;t++){if(!this._boundingRectFeatureTest(e,t,a))continue;const i=r(n[t],t,e);if(i===ie.ForAllFeaturesReturnType.EXIT)return i}return s}_createAttributes(e,t){const r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);const i=t.attributeInfo?.attributeData;if(null!=i)for(const t of Object.keys(i))r[t]=ue.getCachedAttributeValue(i[t],e);return r}_createGraphic(e,t){return this._createLayerGraphic(this._createAttributes(e,t))}highlight(e,t){if(Z.isQuery(e))return Te.emptyHighlightHandle;const r=Te.normalizeHighlightTargetExceptQuery(e);if(0===r.length)return Te.emptyHighlightHandle;const i=t?.name??Be.defaultHighlightName,n=r[0]instanceof s?this._featureIdsFromGraphics(r):"number"==typeof r[0]?r:null;if(!n)return Te.emptyHighlightHandle;const{set:o,handle:a}=this._highlights.acquireSet(i);return this._highlights.setFeatureIds(o,n),a}_featureIdsFromGraphics(e){const t=this.i3slayer.fieldsIndex,r=this._getObjectIdField();return e.map((e=>xe.attributeLookup(t,e.attributes,r)))}resetHighlights(){u.destroyMaybe(this._highlights),this._highlights=new le({collection:this._collection,forAllFeatures:e=>this._forAllFeatures(e,null,ie.ForAllFeaturesMode.ALL),forAllFeaturesOfNode:(e,t)=>this._forAllFeaturesOfNode(e,t)})}_visibleGeometryChanged(e,t){this._elevationProvider&&(null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=m.schedule((()=>{const{node:t}=e,r=t.visibilityObbInRenderSR??t.geometryObbInRenderSR??t.serviceObbInRenderSR;if(null!=r){const e=L.create();r.toAaBoundingBox(e),this.emit("visible-geometry-changed",new J.ContentGeometryUpdateEvent(e))}else this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle=null}))),this._updateSnappingSources(e,t),this._elevationProvider.objectChanged(this._collection.getComponentObb(e.objectHandle)))}get performanceInfo(){return new te.I3SMeshViewPerformanceInfo(this.usedMemory,this._nodeId2Meta.size,Math.round(this._gpuMemoryEstimate/1048576),Math.round(this._geoMemoryEstimate/1048576),Math.round(this._texMemoryEstimate/1048576),Math.round(this.unloadedMemory/1048576),this._idbCacheEnabled?Math.round(100*this._idbCache.getHitRate()):0)}checkInvariants(){}get test(){}getNodeOpacityByIndex(e){const t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)}getNodeOpacity(e){return null!=e?this._collection.getMaterial(e.objectHandle).objectOpacity:0}isNodeFullyFadedIn(e){return this._crossfadeHelper.isNodeFullyFadedIn(e)}getNodeCrossfadeMetaData(e){return this._nodeId2Meta.get(e)}getNodeComponentHandle(e){return this._nodeId2Meta.get(e)?.objectHandle}markNodeToRemove(e){this._controller&&this._controller.markNodeToRemove(e)}removeMarkedNodes(){this._controller&&this._controller.removeMarkedNodes()}foreachCrossfadeNode(e){this._nodeId2Meta.forEach(e)}fadeNode(e,t,r){if(!this.nodeCrossfadingEnabled)return;const i=this._nodeId2Meta.get(e);null!=i&&this._crossfadeHelper.fadeNode(e,i,t,r)}setNodeOpacityByIndex(e,t){const r=this._nodeId2Meta.get(e);null!=r&&this._setNodeOpacity(r,t)}_setNodeOpacity(e,t){this._collection.updateMaterial(e.objectHandle,(e=>e.objectOpacity=t)),this._setNodeEdgeOpacity(e,t)}_setNodeEdgeOpacity(e,t){if(null==this._edgeView||!e.cachedEdgeMaterials)return;it(e.cachedEdgeMaterials,t);const r=e.objectHandle;this._edgeView.hasObject(r)&&this._edgeView.updateAllComponentOpacities(r,t).catch((e=>this._logEdgeViewError(e,this.i3slayer.title)))}get hasModifications(){return this._isIntegratedMesh&&null!=this._layerClippingArea||this._modifications&&this._modifications.length>0}updateNodeModificationStatus(e){const t=e.length;if(!this.hasModifications||t<=0||!0!==this._i3sWasmLoaded)return;const r=this.uid,i=function(e){if(0===e.length)return;const t=10*e.length,r=new Float64Array(t);let i=0;return e.forAll((e=>{let t=e.serviceObbInIndexSR;null==t&&(t=Ye,t.center=G.getCenter(e.serviceMbsInIndexSR),t.halfSize=[e.serviceMbsInIndexSR[3],e.serviceMbsInIndexSR[3],e.serviceMbsInIndexSR[3]]);const s=t.data;r[i++]=s[0],r[i++]=s[1],r[i++]=s[2],r[i++]=s[3],r[i++]=s[4],r[i++]=s[5],r[i++]=s[6],r[i++]=s[7],r[i++]=s[8],r[i++]=s[9]})),r}(e);if(i){const t={context:r,buffer:i.buffer};se.filterObbsForModificationsSync(t);const s=new Float64Array(i.buffer);e.forAll(((e,t)=>{const r=s[t],i=se.interpretObbModificationResults(r);e.imModificationImpact=i,i!==fe.NodeIMModificationImpact.Unmodified&&this._controller.invalidateGeometryVisibility(e.index)}))}}notifyUpdate(){this.notifyChange("updating")}notifyLODUpdate(){this._controller.notifyLODUpdate()}isUpdating(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||null!=this._labeler&&this._labeler.updating||this._crossfadeHelper?.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0||null!=this._elevationTask&&this._elevationTask.running||this._needFilterResolve||this._compressionTracker.compressing}trackSnappingSources(e){const t={events:e,fetchEdgeLocations:async(e,t,r)=>{const i=this._nodeId2Meta.get(e);if(null==i)throw new Error("invalid-node");const{origin:s,buffer:n}=await this._collection.extractEdgeInformation(i.objectHandle,t,r);return this._snappingLocationsApplyElevation(i,n,s),{type:"components",objectIds:i.featureIds,locations:n,origin:s}},remove:()=>n.removeUnordered(this._snappingSourcesTrackers,t)};return this._snappingSourcesTrackers.push(t),this._nodeId2Meta.forEach(((t,r)=>{if(null==t)return;const i=this._controller.getRenderMbs(t.node);i&&e.add(r,i)})),t}_snappingLocationsApplyElevation(e,t,r){if(!e.elevationOffsets||this.elevationInfo.mode===ie.ElevationMode.Absolute)return;const i=t.position0,s=t.position1,n=t.componentIndex,o=C.create(),a=C.create(),l=(e,t)=>{T.add(e,e,r),this.view.renderCoordsHelper.worldUpAtPosition(e,a),T.add(e,e,T.scale(a,a,t)),T.subtract(e,e,r)};for(let t=0;t<i.count;t++){const r=e.elevationOffsets[n.get(t)];i.getVec(t,o),l(o,r),i.setVec(t,o),s.getVec(t,o),l(o,r),s.setVec(t,o)}}_updateSnappingSources(e,t){const{index:r}=e.node,i=this._controller.getRenderMbs(e.node);if(null!=i)for(const e of this._snappingSourcesTrackers)t!==We.REMOVE&&t!==We.UPDATE||e.events.remove(r),t!==We.ADD&&t!==We.UPDATE||e.events.add(r,i)}_logEdgeViewError(e,t){h.isAbortError(e)||l.getLogger(this).warn("Error while processing edges. Edges on this layer might not display correctly",t,e)}_indexedDbSizeCheck(e,t){return t.byteSize>He?(l.getLogger(this).warn(`Node is too big to store in IndexedDB cache: ${e.id} (${t.byteSize} bytes)`),!1):t.byteSize>0}};return r.__decorate([y.property()],i.prototype,"_hasLoadedPBRTextures",void 0),r.__decorate([y.property()],i.prototype,"_asyncModuleLoading",void 0),r.__decorate([y.property()],i.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),r.__decorate([y.property()],i.prototype,"view",void 0),r.__decorate([y.property()],i.prototype,"i3slayer",void 0),r.__decorate([y.property()],i.prototype,"_controller",void 0),r.__decorate([y.property()],i.prototype,"_labeler",void 0),r.__decorate([y.property()],i.prototype,"updating",void 0),r.__decorate([y.property()],i.prototype,"suspended",void 0),r.__decorate([y.property()],i.prototype,"contentVisible",null),r.__decorate([y.property({readOnly:!0})],i.prototype,"legendEnabled",null),r.__decorate([y.property(Ae.updatingProgress)],i.prototype,"updatingProgress",void 0),r.__decorate([y.property()],i.prototype,"updatingProgressValue",null),r.__decorate([y.property()],i.prototype,"hasTexturesOrVertexColors",null),r.__decorate([y.property()],i.prototype,"rendererTextureUsage",null),r.__decorate([y.property()],i.prototype,"elevationOffset",null),r.__decorate([y.property()],i.prototype,"elevationInfo",null),r.__decorate([y.property({type:Boolean})],i.prototype,"slicePlaneEnabled",void 0),r.__decorate([y.property()],i.prototype,"supportedTextureEncodings",null),r.__decorate([y.property({type:[H]})],i.prototype,"_modifications",void 0),r.__decorate([y.property({readOnly:!0})],i.prototype,"clientGeometry",null),r.__decorate([y.property()],i.prototype,"elevationRange",null),r.__decorate([y.property()],i.prototype,"fullExtent",null),r.__decorate([y.property()],i.prototype,"_elevationTask",void 0),r.__decorate([y.property({readOnly:!0})],i.prototype,"_usePBR",null),i=r.__decorate([_.subclass("esri.views.3d.layers.I3SMeshView3D")],i),i},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/projection/localLinearScaleFactors":function(){define(["exports","../../chunks/vec32","./projectors","../support/Ellipsoid","../support/spatialReferenceUtils"],(function(e,t,r,i,s){"use strict";e.localLinearScaleFactors=function(e,n,o,a){const l=r.getProjectorClassification(n,a);if(null==l)return!1;const c=l.source.spatialReferenceId,u=l.dest.spatialReferenceId;if(c===u&&c!==r.ProjectionID.UNKNOWN||s.equals(n,a))return o[0]=1,o[1]=1,o[2]=1,!0;if(c===r.ProjectionID.SPHERICAL_ECEF){const s=t.length(e),n=s/Math.sqrt(e[0]*e[0]+e[1]*e[1]),a=s/i.earth.radius;if(u===r.ProjectionID.WEB_MERCATOR)return o[0]=n*a,o[1]=n*a,o[2]=1,!0;if(u===r.ProjectionID.WGS84||u===r.ProjectionID.CGCS2000){const e=r.invPlateCarreeScale;return o[0]=e*n*a,o[1]=e*a,o[2]=1,!0}}else if(c===r.ProjectionID.PLATE_CARREE){if(u===r.ProjectionID.WGS84||u===r.ProjectionID.CGCS2000)return o[0]=r.invPlateCarreeScale,o[1]=r.invPlateCarreeScale,o[2]=1,!0;if(u===r.ProjectionID.WEB_MERCATOR){const t=e[1]/i.earth.radius;return o[0]=1,o[1]=1/Math.cos(t),o[2]=1,!0}}return!1},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/geometry/support/UByteArray":function(){define(["exports","../../core/typedArrayUtil"],(function(e,t){"use strict";e.newUByteArray=function(e,r=!1){return e<=t.nativeArrayMaxSize?r?new Array(e).fill(0):new Array(e):new Uint8Array(e)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/layers/graphics/controllers/I3SOnDemandController":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/has","../../../core/Logger","../../../core/PooledArray","../../../core/Promise","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/accessorSupport/decorators/property","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../geometry/projection/projectBoundingRect","../../../geometry/support/aaBoundingRect","../../support/PromiseQueue","../../../views/ViewingMode","../../../views/3d/layers/i3s/I3SClientNodeLoader","../../../views/3d/layers/i3s/I3SFrameTask","../../../views/3d/layers/i3s/I3SIndex","../../../views/3d/layers/i3s/I3SLodHandling","../../../views/3d/layers/i3s/I3SNode","../../../views/3d/layers/i3s/I3SNodeLoader","../../../views/3d/layers/i3s/I3SStreamDataController","../../../views/3d/layers/i3s/I3SUtil","../../../views/3d/layers/i3s/I3SViewportQueries","../../../views/3d/layers/support/I3SLayerView","../../../views/3d/support/extentUtils","../../../views/3d/support/index","../../../views/3d/support/MemoryController","../../../views/support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E){"use strict";const O=1e-4;e.default=class extends(o.EsriPromiseMixin(r)){get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store?.lodType}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&(null==this.layer.priority||"High"===this.layer.priority)}get indexStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(M.ClientType.I3S_INDEX);return new w.I3SStreamDataController(e,this.layer.customParameters,this.layer.apiKey)}get dataStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(M.ClientType.I3S_DATA);return new w.I3SStreamDataController(e,this.layer.customParameters,this.layer.apiKey)}get crsVertex(){return x.getVertexCrs(this.layer)}get crsIndex(){return x.getIndexCrs(this.layer)}get layer(){return this.layerView.i3slayer}get running(){return this.updating}get rootNodeVisible(){if(this._index){const e=this._index.rootNode;if(e)return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}get index(){return this._index}get requiredAttributes(){return this._requiredAttributes}constructor(e){super(e),this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.worker=null,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._idleStateCallbacks=null,this._newLoadingNodes=new n({deallocator:null}),this._modificationsNodeFilteringArray=new n,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._idleQueue=new m.PromiseQueue,this._elevationUpdateNodes=new n({deallocator:null}),this._errorCount=0}initialize(){const{layerView:e,layer:t}=this;this._disableMemCache=!e.loadCachedGPUData||!e.addCachedGPUData,this._lodHandling=new b(e),this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=!!i("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([t.indexInfo,t.when(),e.when()]).then((([r])=>{if(this.destroyed||!e||e.destroyed||!r)return;const{view:i,clientGeometry:n}=e,{resourceController:o}=i;if(this._setClippingArea(i.clippingArea),this.addHandles([l.watch((()=>i?.pointsOfInterest?.focus?.renderLocation),(e=>this._pointOfInterestChanged(e)),l.initial),l.watch((()=>i.quality),(()=>this._setCameraDirty()),l.sync),l.watch((()=>e.contentVisible),(e=>{const t=e?()=>this._updateIdleState(!0):()=>this._updateViewData(),r=e?()=>this._updateIdleState(!1):()=>{};e&&null!=this._index&&this._index.invalidateAllElevationRanges(),this._idleStateCallbacks?(e||this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=t,this._idleStateCallbacks.idleEnd=r):this._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(t,r)}),l.initial),y.addCallback(e.view.resourceController.scheduler,this),l.watch((()=>[this.featureTarget,this.fixedFeatureTarget]),(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1})),l.watch((()=>i.state?.contentCamera),(()=>this._setCameraDirty())),l.watch((()=>t.elevationInfo),(e=>this._elevationInfoChanged(e))),l.watch((()=>e.lodFactor),(()=>this._setCameraDirty())),l.watch((()=>e.availableFields),(()=>this._requiredFieldsChange())),l.watch((()=>e.holeFilling),(e=>null!=this._index&&(this._index.holeFilling=e)))]),this._viewportQueries=new T(this.crsIndex,i.renderCoordsHelper,i.state.contentCamera,!i.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?i.basemapTerrain:i.elevationProvider,f.viewingModeFromString(i.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:this._lod<.5}),this._clientNodeLoader=new g.I3SClientNodeLoader(this.layer.uid,{indexSR:this.crsIndex,vertexSR:this.crsVertex,renderSR:i.renderCoordsHelper.spatialReference},i.resourceController.memoryController,this.worker),this._index=new _.I3SIndex(f.viewingModeFromString(i.viewingMode),t,r,this.indexStreamController,this._clientNodeLoader,this._viewportQueries,s.getLogger(this),e.holeFilling,(t=>e.isNodeLoaded(t)),(t=>e.isNodeReloading(t)),(e=>this._shouldLoadNode(e)),(e=>this._enableFromGPUCache(e,v.NodeState.Leaf)),(e=>this._needsUpdate(e)),(()=>!this.indexStreamController.busy),(t=>e.computeVisibilityObb?.(t)??null),e?.computeNodeFiltering?t=>e.computeNodeFiltering(t):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid||this.isGraphics3D),this._index.imModificationsChanged(!!e.hasModifications),this._index.layerFilterChanged(!!e.hasGeometryFilter),null!=n){for(const e of n)this._addMesh(e.mesh,e.oid);this.addHandles(n.on("change",(e=>{for(const t of e.removed)this._removeMesh(t.oid);for(const t of e.added)this._addMesh(t.mesh,t.oid)})))}this._startNodeLoading()})))}updateNodeModificationStatus(e){const t=this._index,r=this.layerView;null!=t&&r?.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((e=>{const r=t.getNode(e);null!=r&&this._modificationsNodeFilteringArray.push(r)})),r.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._nodeLoader=null,A.prune()}get viewportQueries(){return this._viewportQueries}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.availableFields.map((r=>{const i=D(e,r),s=D(t,r);return i>=0&&s>=0?{index:i,name:t[s].name,field:t[s],attributeStorageInfo:e[i]}:null})).filter((e=>null!=e&&e.name!==r))}_requiredFieldsChange(){const e=this._getRequiredAttributes();I(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(e){const t=p.create();P.toBoundingRect(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}_pointOfInterestChanged(e){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(e),null!=this._index&&(this._index.progressiveLoadPenalty=F.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(e){this._setClippingArea(e),null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_addMesh(e,t){if(null==this._index)return;const r=this._clientNodeLoader.createMeshNodeInfo(e,t),i=this._index.addClientNodeToIndex(r.id,r.mbs);this._clientNodeLoader.addMeshNode(i,r),this._evaluateUpdating(),this.notifyChange("rootNodeVisible")}_removeMesh(e){const t=this._clientNodeLoader.getMeshNodeIndex(e);if(null!=t){if(null==this._index)throw new Error("delayed removal of client side i3s node geometry not supported yet.");{const e=(e,t)=>{this.layerView.removeNode(t),this._clientNodeLoader.removeNode(e),this.layerView.deleteCachedNodeData&&null!=e&&this.layerView.deleteCachedNodeData(e),this.layerView.deleteCachedGPUData?.(this.layerView.loadCachedGPUData?.(t))},r=(e,t,r)=>{this._clientNodeLoader.updateNodeIndex(e,t,r),this.layerView.updateNodeIndex&&this.layerView.updateNodeIndex(t,r)};this._index.removeClientNodeFromIndex(t,e,r),this.notifyChange("rootNodeVisible")}}}updateElevationChanged(e,t){const r=this._index;if(null==r?.rootNode||null==t)return null;this.crsIndex.equals(t)||(h.projectBoundingRect(e,t,L,this.crsIndex),e=L);const i=this._elevationUpdateNodes;return i.clear(),x.findIntersectingNodes(e,r.rootNode,r,(e=>i.push(e.index))),i.length&&(i.forAll((e=>r.updateElevationChanged(e))),this._setCameraDirty()),i}removeAllGeometryObbs(){null!=this._index&&this._index.removeAllGeometryObbs()}getRenderMbs(e){return null!=this._viewportQueries?this._viewportQueries.getServiceMbsInRenderSR(e):null}_elevationInfoChanged(e){null!=this._index&&(this._index.updateElevationInfo(e,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(e,t){return this._idleQueue.push(e,t)}reschedule(e,t){return this._idleQueue.unshift(e,t)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get unloadedMemoryEstimate(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}async _loadNodeData(e,t){return e.index<0?this._clientNodeLoader.loadNodeData(e.id,t):this._nodeLoader.loadNodeData(e,t)}async _loadAttributes(e,t,r){return(e.index<0?this._clientNodeLoader:this._nodeLoader).loadAttributes(e,t,r)}get indexDepth(){return null!=this._index?this._index.maxLevel:0}set disableMemCache(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData?this._disableMemCache=e:this._disableMemCache=!0}runTask(e,t){return this.layerView.contentVisible?this.layerView.visible&&null!=this._index?(this._processWithErrorLogging(e,t),this._index.maxPriority):-1/0:(this._updateViewData(),this._evaluateUpdating(),-1/0)}_processWithErrorLogging(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?s.getLogger(this).error(`Error during processing: ${e} at ${e.stack}`):50===this._errorCount&&s.getLogger(this).error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(e,t){this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(e.enabled=!1),e.run((()=>this._processIndex(e))),this._updateFeatureLOD(),e.run((()=>this._processCache(e))),this._isIntegratedMesh&&(e.enabled=!0),e.run((()=>this._processNodes(e,t))),this._idleQueue.runTask(e),e.run((()=>this._prefetchIndex())),t.numIndexLoading+=this._index.indexLoading,t.numNodesLoading+=this._downloadingCount,e.run((()=>this._lodHandling.lodGlobalHandling(e))),this._evaluateUpdating())}_processIndex(e){if(null==this._index)return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,(e=>this.updateNodeModificationStatus(e))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const t=this._index.featureEstimate.leavesReached;this._index.isLoading||t===this._get("leavesReached")||this._set("leavesReached",t)}return this._index.load()}_prefetchIndex(){return!(null==this._index||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||null==this._index||null==this._viewportQueries)return;const e=!this._index.isLoading,t=this.featureTarget*this._baseLOD,r=this._index.featureEstimate;if(r.estimate=r.estimate||t/2,this._index.indexMissing>500){if(this._featureLOD<=O)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const e=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=e;const i=this._lod,s=this._index.checkFeatureTarget(t,i);s!==i&&(this._featureLOD=s/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=O)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(O,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}_processCache(e){const t=this._index;if(null==t)return!1;for(;this._newLoadingNodes.length>0&&!e.done;){const r=this._newLoadingNodes.pop();for(let i=t.getParent(r);null!=i&&!this.layerView.isNodeLoaded(i.index);i=t.getParent(i.index))if(this._enableFromGPUCache(i,v.NodeState.Hole)){e.madeProgress();break}}return e.hasProgressed}_processNodes(e,t){if(null==this._index)return!1;let r=(this._isIdle?100:2)-this._loadingNodes.size;const i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.remove.length>0&&!e.done;)this.layerView.removeNode(i.remove.pop()),e.madeProgress();for(;i.update.length>0&&!e.done;){const t=this._index.getNode(i.update.pop());null!=t&&(this._updateLoadedNode(t),e.madeProgress())}for(;i.add.length>0&&!e.done&&r>0;){--r;const s=this._index.getNode(i.add.back());if(null==s||s.cacheState!==v.CacheState.Cached&&!this._hasNodeLoadToken(t))break;i.add.pop(),this._loadNode(s),e.madeProgress()}return e.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((e=>e.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((e=>e.abort())),this._updatingNodes.clear()}_cancelNode(e){const t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}_hasNodeLoadToken(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<M.maxDownloadSlots&&!this.dataStreamController.busy}_evaluateUpdating(){let e=!1,t=0;if(this.layerView){if(this.layerView.contentVisible){const r=(this._index?.indexMissing??0)+3*(this._index?.updates.add.length??0)+2*this._loadingNodes.size;e=!!(r>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.updating||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===r&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(r,this._progressMaxNumNodes),t=1-r/this._progressMaxNumNodes}else e=this._cameraDirty,t=e?0:1;this.updating=e,this.updatingProgress=t}}_updateViewData(){if(!this._cameraDirty||null==this._index||null==this._viewportQueries)return;const e=this.layerView.view,{contentCamera:t,fixedContentCamera:r}=e.state;this._viewportQueries.updateCamera(t,!r||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=F.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.quality<1?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const e=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*this.layerView.view.quality}get _lodDropFactor(){return this.fixedFeatureTarget?1:(Math.min(this.layerView.view.quality,.5)-R.minQuality)/(.5-R.minQuality)}isGeometryVisible(e){return!!this._index?.isGeometryVisible(e.index)}updateVisibility(e){this._index?.invalidateNodeVisibilityCache(e)}invalidateGeometryVisibility(e){this._index?.invalidateGeometryVisibility(e)}invalidateVisibilityObbs(){this._index?.invalidateVisibilityObbs()}modificationsChanged(){this._index?.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||null==this._index||!this._index.isGeometryVisible(e.index))}_shouldDropNode(e){if(null==this._viewportQueries)return!1;const t=this._lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}_startNodeLoading(){this._restartNodeLoading=!1;const e=this._index;if(this._updatesDisabled||null==e||null==this._viewportQueries)return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const t={textureEncodings:this.layerView.supportedTextureEncodings,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new S(this.layer,this.dataStreamController,s.getLogger(this),this._defaultGeometrySchema,this._requiredAttributes,t),e.requestUpdate(),this._lodHandling.startNodeLoading(((e,t)=>this._removeNodes(e,t,N.fadeout)),e,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(e){const t=this._index;if(null==t||null==this._viewportQueries)return!1;A.clear(),this.layerView.getLoadedNodeIndices(A);const r=0===this._viewportQueries.maxDistance,i=r?()=>!1:e=>this._shouldDropNode(e);return A.filterInPlace((e=>{const r=t.getNode(e);return null==r||!t.isGeometryVisible(e)||i(r)})),A.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(A,e,N.pop),!(r&&this._lodDropFactor<1||0!==A.length&&(A.clear(),1))}markNodeToRemove(e){A.push(e)}removeMarkedNodes(){this._removeNodes(A,E.noBudget,N.pop)}_removeNodes(e,t,r){if(0!==e.length&&!t.done)for(null!=this._index&&this._index.requestUpdate();e.length>0&&!t.done;){const i=e.pop(),s=this._index;r===N.fadeout&&this.layerView.nodeFadeoutEnabled&&null!=s&&s.isGeometryVisible(i)?this.layerView.fadeNode(i,C.FadeDirection.FadeOut,!0):this.layerView.removeNode(i),t.madeProgress()}}_needsUpdate(e){if(e.resources.isEmpty||this._updatingNodes.has(e.index))return!1;const t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}async _updateLoadedNode(e){const t=new AbortController;this._updatingNodes.set(e.index,t),this._evaluateUpdating();try{const r=I(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?this.layerView.getAttributeData(e.index):await this._loadAttributes(e,this._requiredAttributes,t.signal);await this.schedule((()=>this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:r},t.signal)),t.signal)}catch(r){if(!a.isAbortError(r))return this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},t.signal)}this._updatingNodes.delete(e.index),this._evaluateUpdating()}_loadNode(e){if(this._loadingNodes.has(e.index))return void s.getLogger(this).error("already loading node "+e.index);const t=new AbortController;this._loadingNodes.set(e.index,t),this._evaluateUpdating(),this._loadAndAddNode(e,t.signal).then((r=>{r&&null!=this._index&&this._loadingNodes.get(e.index)===t&&(this._loadingNodes.delete(e.index),this._index.requestUpdate())})).catch((e=>{if(!a.isAbortError(e))throw e})).finally((()=>{this._loadingNodes.get(e.index)===t&&this._loadingNodes.delete(e.index),this._evaluateUpdating()}))}_loadAndAddNode(e,t){return e.cacheState===v.CacheState.Uncached?this._loadUncached(e,t).then((()=>!1)):this._loadCached(e,t).then((t=>!t&&(e.cacheState=v.CacheState.Uncached,!0))).catch((t=>!a.isAbortError(t)&&(e.cacheState=v.CacheState.Uncached,!0)))}_enableFromGPUCache(e,t){if(this._disableMemCache||null==this._index)return!1;if(t===v.NodeState.Hole&&!this._index.useNodeAsHole(e.index))return!0;const r=this._loadCachedGPUData(e);return!!r&&(this.layerView.addCachedGPUData(e,r,t),this._nodeAdded(),!0)}_loadCachedGPUData(e){const t=this.layerView.loadCachedGPUData(e.index);return null!=t?.attributeInfo&&I(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}_nodeAdded(){null!=this._index&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateLoadStatus(e,t){const r=this._index;null!=r&&r.updateChildrenLoaded(e,t?1:-1)}async _loadCached(e,t){if(this._enableFromGPUCache(e,v.NodeState.Leaf))return!0;const r=this.layerView;if(this.disableIDBCache||!r.loadCachedNodeData||!r.addCachedNodeData)return!1;const i=e.index>=0?(t,r)=>this._nodeLoader.loadTextures(e,t,r):(t,r)=>this._clientNodeLoader.loadTextures(e,t,r),s=await this.schedule((()=>r.loadCachedNodeData(e,t,i)),t);if(null==s)return!1;const n=this._requiredAttributes,o=await this.reschedule((()=>this._loadAttributes(e,n,t)),t);return await this.reschedule((()=>r.addCachedNodeData(e,s,{loadedAttributes:n,attributeData:o},t)),t),this._nodeAdded(),!0}_loadUncached(e,t){return this._downloadingCount++,this._loadNodeData(e,t).catch((e=>{throw this._downloadingCount--,e})).then((r=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(e,r,t)),t)))).then((()=>{this._nodeAdded(),e.cacheState=v.CacheState.Cached})).catch((t=>{if(!a.isAbortError(t))throw s.getLogger(this).error("#loadNodeData()",this.layer,`Failed to load node '${e.id}'`,t),e.failed=!0,null!=this._index&&this._index.requestUpdate(),t}))}_updateIdleState(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&null!=this._index&&this._index.resetFailedNodes())}get test(){}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),null!=this._index&&this._index.requestUpdate()}geometryFilterChanged(e){const t=this._index;null!=t&&t.layerFilterChanged(e),this._setCameraDirty()}},t.__decorate([c.property({readOnly:!0})],e.default.prototype,"isMeshPyramid",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"isGraphics3D",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"useMaximumNumberOfFeatures",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"indexStreamController",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"dataStreamController",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"crsVertex",null),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"crsIndex",null),t.__decorate([c.property()],e.default.prototype,"featureTarget",void 0),t.__decorate([c.property()],e.default.prototype,"fixedFeatureTarget",void 0),t.__decorate([c.property()],e.default.prototype,"layerView",void 0),t.__decorate([c.property()],e.default.prototype,"layer",null),t.__decorate([c.property()],e.default.prototype,"updating",void 0),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"running",null),t.__decorate([c.property()],e.default.prototype,"updatingProgress",void 0),t.__decorate([c.property({readOnly:!0})],e.default.prototype,"leavesReached",void 0),t.__decorate([c.property({constructOnly:!0})],e.default.prototype,"worker",void 0),t.__decorate([c.property({readOnly:!0,dependsOn:[]})],e.default.prototype,"rootNodeVisible",null),e.default=t.__decorate([d.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],e.default);const A=new n({deallocator:null});function I(e,t){return null!=e&&e.length===t.length&&e.every((e=>D(t,e.name)>=0))}function D(e,t){const r=t.toLowerCase();for(let t=0;t<e.length;t++)if(e[t].name.toLowerCase()===r)return t;return-1}const F={distancePenalty:10},L=p.create();var N;return function(e){e[e.pop=0]="pop",e[e.fadeout=1]="fadeout"}(N||(N={})),e.default}))},"esri/views/3d/layers/i3s/I3SClientNodeLoader":function(){define(["exports","../../../../core/Error","../../../../core/maybe","../../../../core/MemCache","../../../../core/promiseUtils","../../../../core/uuid","../../../../core/libs/gl-matrix-2/math/mat3","../../../../core/libs/gl-matrix-2/factories/mat3f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/support/meshVertexSpaceUtils","../../../../chunks/sphere","./CachedMeshData","./I3SClientMaterialUtil"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m){"use strict";function f(e,t){const{spatialReference:r}=e,i=[1,-1],s=[.5*e.width,.5*e.height,e.hasZ?.5*(e.zmax-e.zmin):0],n=r.isGeographic?r.metersPerUnit:1,o=e.center;let a=0;if(e.hasZ)for(let e=0;e<2;++e)for(let r=0;r<2;++r)for(let l=0;l<2;++l){const c=(o.x+i[e]*s[0]-t.x)*n,u=(o.y+i[r]*s[1]-t.y)*n,d=o.z+i[l]*s[2]-t.z;a=Math.max(c*c+u*u+d*d,a)}else for(let e=0;e<2;++e)for(let r=0;r<2;++r){const l=(o.x+i[e]*s[0]-t.x)*n,c=(o.y+i[r]*s[1]-t.y)*n;a=Math.max(l*l+c*c,a)}return h.fromCenterAndRadius([t.x,t.y,t.z],Math.sqrt(a))}async function g(e,t,i,s){const{transform:n,vertexAttributes:u}=t.loadedMesh,d="source"===e.shading?u.normal:null;if(null==d||null==n||0===n.rotationAngle&&l.exactEquals(n.scale,c.ONES))return{transformed:d,original:u.normal};if(!t.normalsTransformPromise){r.assertIsSome(i,"SceneLayerWorker is needed to transform mesh normals");const e=a.create();o.normalFromMat4(e,n.localMatrix),t.normalsTransformPromise=i.transformNormals({normalMatrix:e,normals:d},s)}return t.normalsTransformPromise}function y(e,t,r){e[t]=255&r,e[t+1]=255&r>>8,e[t+2]=255&r>>16,e[t+3]=255&r>>24}e.I3SClientNodeLoader=class{constructor(e,t,r,i){this._uid=e,this._worker=i,this._id2Meta=new Map,this._oid2Meta=new Map,this._indexSR=t.indexSR,this._vertexSR=t.vertexSR,this._renderSR=t.renderSR,this._memCache=r.newCache(`sl-client-mesh-data-${this._uid}`)}get uid(){return this._uid}get worker(){return this._worker}get indexSR(){return this._indexSR}get renderSR(){return this._renderSR}createMeshNodeInfo(e,t){const r=`mesh${t}`,i=e.extent,s=i.spatialReference,o=this._indexSR,a=f(i,e.origin);u.projectBoundingSphere(a,s,a,o);const l=function(e){const t=e.metadata.displaySource?.source;if(null==t||!Array.isArray(t)||!t.length||t[0]instanceof File)return n.generateUUID();const r=t;let i="";for(const e of r)i+=e.makeHash();return i+JSON.stringify(e.transform?.toJSON()??"")+(d.isRelativeVertexSpace(e.vertexSpace)?JSON.stringify(e.vertexSpace.origin):"")+JSON.stringify(e.spatialReference)}(e);return{type:"mesh",id:r,version:l,oid:t,mbs:a,componentNodeIds:[],unloadedMesh:e,nodeIndex:null,loadMeshPromise:null}}addMeshNode(e,r){if(null!=this.getMeshNodeIndex(r.oid))throw new t("scenelayer",`I3SClientNodeLoader: client side mesh for feature oid=${r.oid} already exists`);r.nodeIndex=e,this._id2Meta.set(r.id,r),this._oid2Meta.set(r.oid,r)}getMeshNodeIndex(e){const t=this._oid2Meta.get(e);return null==t||"mesh"!==t.type?null:t.nodeIndex}getMeshNodeInfo(e){const t=this._oid2Meta.values();for(const r of t)if("mesh"===r.type&&r.id===e)return r;return null}removeNode(e){const t=this._id2Meta.get(e);null!=t&&(this._id2Meta.delete(e),"mesh"===t.type&&this._oid2Meta.delete(t.oid))}async loadNodeJSON(e){const r=this._id2Meta.get(e);if(null==r)throw new t("scenelayer",`I3SClientNodeLoader::loadNodeJSON unable to find node ${e}`);switch(r.type){case"mesh":return this._loadMeshNodeJSON(r);case"mesh-component":return async function(e){return{id:e.id,version:e.meshNodeInfo.version,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null,isEmpty:!1}}(r);default:throw new t("scenelayer",`I3SClientNodeLoader::loadNodeJSON unable to handle node ${e}`)}}async _loadMeshNodeJSON(e){const t=e.id,r=(await this._getMeshData(e)).loadedMesh;if(null==r.components||0===r.components.length)return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null};const i=[],s=r.components;for(let r=0;r<s.length;++r){const s=`${t}-component${r}`,n={type:"mesh-component",id:s,mbs:e.mbs,componentIndex:r,meshNodeInfo:e,textureData:new Map};this._id2Meta.set(n.id,n),e.componentNodeIds.push(s),i.push({id:n.id,href:null,mbs:n.mbs,obb:null})}return{id:t,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:i}}updateNodeIndex(e,t,r){const i=this._id2Meta.get(e);i&&"mesh"===i.type&&(i.nodeIndex=r)}async loadNodeData(e,i){const n=this._id2Meta.get(e);if(null==n||"mesh-component"!==n.type)throw new t("scenelayer",`Failed to load client node data for node ${e} (unexpected node info)`);const o=n.meshNodeInfo,a=await this._getMeshData(o),l=a.loadedMesh,c=o.oid;if(null==l.components)throw new t("scenelayer",`Failed to load client node data for node ${e} (unexpected null reference)`);const u=l.components[n.componentIndex],{material:d,requiredTextures:h,textureData:p}=await m.convertMeshMaterialToPBRMaterial(u.material);if(null!=p)for(const e of p)null!=e&&n.textureData.set(e.id,e);const f={params:{material:d},type:"ArrayBufferView"},{vertexSpace:_,origin:b,transform:v}=l,S=[b.x,b.y,b.z??0];a.projectionPromise||(r.assertIsSome(this._worker,"SceneLayerWorker is needed to project mesh"),a.projectionPromise=this._worker.project({positions:l.vertexAttributes.position,localMatrix:v?.localMatrix,vertexSpace:_.toJSON(),origin:S,inSpatialReference:l.spatialReference.toJSON(),outSpatialReference:this._vertexSR.toJSON()},i));const{projected:w,original:x,projectedOrigin:T}=await a.projectionPromise;l.vertexAttributes.position=x;const{transformed:C,original:P}=await g(u,a,this._worker,i);l.vertexAttributes.normal=P,s.throwIfAborted(i);const{geometryBuffer:M,geometryDescriptor:R}=function(e,t,r,i,s,n){const o=(t?.length??0)/3,a=3*o;let l=0,c=0,u=!1,d=0,h=!1,p=0,m=!1,f=0,g=0,_=0;l+=4,l+=4,c=l,l+=3*a*4,null!=r&&(u=!0,d=l,l+=3*a*4),null!=i&&(h=!0,p=l,l+=2*a*4),null!=s&&(m=!0,f=l,l+=4*a*1),g=l,l+=8,_=l,l+=8;const b=new ArrayBuffer(l),v=new Uint8Array(b);y(v,0,a),y(v,4,1);const S=new Float32Array(b,c),w=null!=r?new Float32Array(b,d):null,x=null!=i?new Float32Array(b,p):null,T=null!=s?new Uint8Array(b,f):null;for(let n=0;n<o;++n){const o=3*n;for(let a=0;a<3;++a){const l=t[o+a],c=3*l,u=9*n+3*a;if(S[u]=e[c],S[u+1]=e[c+1],S[u+2]=e[c+2],w&&(w[u]=r[c],w[u+1]=r[c+1],w[u+2]=r[c+2]),x){const e=2*l,t=6*n+2*a;x[t]=i[e],x[t+1]=i[e+1]}if(T){const e=4*l,t=12*n+4*a;T[t]=s[e],T[t+1]=s[e+1],T[t+2]=s[e+2],T[t+3]=s[e+3]}}}return y(v,g,n),y(v,g+4,n/2**32),y(v,_,0),y(v,_+4,o-1),{geometryBuffer:b,geometryDescriptor:{isDraco:!1,isLegacy:!0,color:m,normal:u,uv0:h,uvRegion:!1,featureIndex:!0}}}(w,u.faces,C,l.vertexAttributes.uv,l.vertexAttributes.color,c);return{geometryData:{featureDataPosition:T,featureIds:[],geometries:[f]},attributeDataInfo:{attributeData:{},loadedAttributes:[]},geometryBuffer:M,geometryDescriptor:R,requiredTextures:h,textureData:p,normalReferenceFrame:this._vertexSR.isGeographic?"east-north-up":"vertex-reference-frame"}}async loadAttributes(e,t,r){const i=e.numFeatures,s={};for(const{field:{name:e}}of t)s[e]=new Array(i);return s}async loadTextures(e,t,r){const i=e.id,s=this._id2Meta.get(i);if(null==s||"mesh-component"!==s.type)throw new Error(`Failed to load textures for node ${e.id} (unexpected node info)`);const n=[];for(const e of t)n.push(s.textureData.get(e.id)||null);return n}async _getMeshData(e){const t=e.version,r=this._memCache.get(t);if(null==r){if(null!=e.loadMeshPromise)return e.loadMeshPromise;const r=async(r,s)=>{const n=e.unloadedMesh.clone();try{await n.load()}catch(e){s(e)}const o=new p.CachedMeshData(n);this._memCache.put(t,o,i.MinPriority),e.loadMeshPromise=null,r(o)};return e.loadMeshPromise=new Promise(((e,t)=>r(e,t))),e.loadMeshPromise}return r}},e.createSphereFromExtent=f,e.sizeOfFloat32=4,e.sizeOfInt32=4,e.sizeOfUInt64=8,e.sizeOfUInt8=1,e.transformNormals=g,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/CachedMeshData":function(){define(["exports"],(function(e){"use strict";e.CachedMeshData=class{constructor(e){this.loadedMesh=e}get cachedMemory(){return this.loadedMesh.usedMemory}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SClientMaterialUtil":function(){define(["exports","../../../../Color","../../../../core/Error","../../../../support/requestUtils","../../glTF/internal/resourceUtils","./enums","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/materials/pbrUtils","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l){"use strict";async function c(e,t,o,a){if(null==e)return-1;const l=o.length,c=e.data,u=e.url;if(null!=c){if(c instanceof HTMLImageElement||c instanceof HTMLCanvasElement)return o.push({id:l,usage:a,data:c,encoding:n.TextureEncoding.PNG}),t.push({id:l,usage:a,encodings:[{name:void 0,encoding:n.TextureEncoding.PNG}]}),l;if(c instanceof HTMLVideoElement)return-1;if(c instanceof ImageData)throw new r("scenelayer","ImageData textures not supported yet for client side I3S nodes");if(c instanceof s.EncodedMeshTexture)return o.push({id:l,usage:a,data:c.data,encoding:n.TextureEncoding.KTX2}),t.push({id:l,usage:a,encodings:[{name:void 0,encoding:n.TextureEncoding.KTX2}]}),l}else if(null!=u){const e=new Image;e.src=u;const r=await i.loadImageAsync(e,e.src,!1,void 0);return o.push({id:l,usage:a,data:r,encoding:n.TextureEncoding.PNG}),t.push({id:l,usage:a,encodings:[{name:void 0,encoding:n.TextureEncoding.PNG}]}),l}return-1}e.convertMeshMaterialToPBRMaterial=async function(e){const r=[],i=[];if(null==e)return{material:{alphaMode:"opaque",alphaCutoff:l.alphaCutoff,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[1,1,1,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6000000238418579},wrapTextures:!1,hasParametersFromSource:!0},requiredTextures:r,textureData:i};const s=function(e){return e.hasOwnProperty("metallicRoughnessTexture")}(e);"auto"===e.alphaMode&&console.warn('alphaMode "auto" not supported by I3S PBRMaterial - defaulting to "blend".');const u=a.useSchematicPBR({normalTexture:e.normalTexture,emissiveTexture:s?e.emissiveTexture:null,emissiveFactor:s?t.toUnitRGB(e.emissiveColor):null,occlusionTexture:s?e.occlusionTexture:null,metallicRoughnessTexture:s?e.metallicRoughnessTexture:null,metallicFactor:s?e.metallic:null,roughnessFactor:s?e.roughness:null}),d=u?a.schematicMRRFactors[0]:s?e.metallic:0,h=u?a.schematicMRRFactors[1]:s?e.roughness:0;return{material:{alphaMode:"auto"===e.alphaMode?"blend":e.alphaMode,alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,cullFace:e.doubleSided?o.CullFaceOptions.None:o.CullFaceOptions.Back,normalTextureId:await c(e.normalTexture,r,i,n.TextureUsage.Normal),emissiveTextureId:s?await c(e.emissiveTexture,r,i,n.TextureUsage.Emissive):-1,occlusionTextureId:s?await c(e.occlusionTexture,r,i,n.TextureUsage.Occlusion):-1,emissiveFactor:s&&null!=e.emissiveColor?t.toUnitRGB(e.emissiveColor):[0,0,0],metallicRoughness:{baseColorFactor:null!=e.color?t.toUnitRGBA(e.color):[1,1,1,1],baseColorTextureId:await c(e.colorTexture,r,i,n.TextureUsage.Color),metallicRoughnessTextureId:s?await c(e.metallicRoughnessTexture,r,i,n.TextureUsage.MetallicRoughness):-1,metallicFactor:d,roughnessFactor:h},wrapTextures:!0,hasParametersFromSource:u},requiredTextures:r,textureData:i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/glTF/internal/resourceUtils":function(){define(["exports","../../../../core/has","../../webgl-engine/lib/basicInterfaces"],(function(e,t,r){"use strict";class i{constructor(e){this.data=e,this.type="encoded-mesh-texture",this.encoding=r.TextureEncodingMimeType.KTX2_ENCODING}}e.EncodedMeshTexture=i,e.imageFromBinaryData=async function(e,s){if(s===r.TextureEncodingMimeType.KTX2_ENCODING)return new i(e);const n=new Blob([e],{type:s});let o=URL.createObjectURL(n);switch(s){case"image/jpeg":o+="#.jpg";break;case"image/png":o+="#.png"}const a=new Image;if(t("esri-iPhone"))return new Promise(((e,t)=>{const r=()=>{s(),e(a)},i=e=>{s(),t(e)},s=()=>{URL.revokeObjectURL(o),a.removeEventListener("load",r),a.removeEventListener("error",i)};a.addEventListener("load",r),a.addEventListener("error",i),a.src=o}));try{a.src=o,await a.decode()}catch(e){console.warn("Failed decoding HTMLImageElement")}return URL.revokeObjectURL(o),a},e.isEncodedMeshTexture=function(e){return"encoded-mesh-texture"===e?.type},e.jsonFromBinaryData=async function(e){const t=new Blob([e]),r=await t.text();return JSON.parse(r)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/enums":function(){define(["exports"],(function(e){"use strict";var t;e.TextureEncoding=void 0,(t=e.TextureEncoding||(e.TextureEncoding={}))[t.KTX2=1]="KTX2",t[t.Basis=2]="Basis",t[t.DDS_S3TC=4]="DDS_S3TC",t[t.PNG=8]="PNG",t[t.JPG=16]="JPG",t[t.KTX_ETC2=32]="KTX_ETC2";const r=e.TextureEncoding.PNG|e.TextureEncoding.JPG;var i;e.TextureUsage=void 0,(i=e.TextureUsage||(e.TextureUsage={}))[i.None=0]="None",i[i.Color=1]="Color",i[i.MetallicRoughness=2]="MetallicRoughness",i[i.Normal=4]="Normal",i[i.Occlusion=8]="Occlusion",i[i.Emissive=16]="Emissive",i[i.AlphaMask=32]="AlphaMask",i[i.ColorTextures=19]="ColorTextures",i[i.GeometryTextures=36]="GeometryTextures",i[i.GeometryTexturesPBR=44]="GeometryTexturesPBR",i[i.AllTextures=37]="AllTextures",i[i.AllTexturesPBR=63]="AllTexturesPBR";const s=e.TextureUsage.Color|e.TextureUsage.MetallicRoughness;e.compressibleUsages=s,e.uncompressedFormats=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SFrameTask":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/handleUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/accessorSupport/decorators/subclass","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";let u=class extends r{constructor(){super(),this.referenceCount=0,this.callbacks=new Array,this.runIndex=0}get running(){return this.callbacks.some((e=>e.running))}runTask(e){this._sort();const t=this.callbacks,r={numIndexLoading:0,numNodesLoading:0};for(let i=0;i<t.length&&!e.done;++i)t[i].priority=t[i].runTask(e,r),this.runIndex=i}_sort(){const e=this.callbacks;let t=e.length;for(let r=this.runIndex;r>0;r--){const i=e[r-1];let s=r;for(;s<e.length&&i.priority<=e[s].priority&&(s!==t||i.priority<e[s].priority);)e[s-1]=e[s],s++;e[s-1]=i,t=s-1}this.runIndex=0}add(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e),this.notifyChange("running")}remove(e){i.removeUnordered(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("running")}};t.__decorate([n.property({readOnly:!0})],u.prototype,"running",null),u=t.__decorate([l.subclass("esri.views.3d.layers.i3s.I3SFrameTask")],u);class d{constructor(e,t){this.task=e,this.handle=t}}const h=new Map;e.addCallback=function(e,t){let r=h.get(e);if(null==r){const t=new u,i=e.registerTask(c.TaskPriority.I3S_CONTROLLER,t);r=new d(t,i),h.set(e,r)}return r.task.add(t),s.makeHandle((()=>{null!=r&&(r.task.remove(t),r.task.callbacks.length>0||(h.delete(e),r.handle.remove(),r.task.destroy()),r=null)}))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SIndex":function(){define(["exports","../../../../core/has","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../geometry/projection/projectBoundingSphere","../../../../chunks/sphere","./I3SNode","./I3SUtil","./ValidatedNode","../../support/ElevationRange","../../support/orientedBoundingBox"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";class d{constructor(e,t,r,i,s){this.childOffset=e,this.childCount=t,this.visibilityCache=r,this.ref=i,this.node=s,this.useAsHole=0,this.filterImpact=o.NodeFilterImpact.NotChecked,this.traversalState=null,this.parent=-1}invalidateBounds(){this.node?.invalidateServiceBVsInRenderSR(),this.ref?.invalidateServiceBVsInRenderSR()}}class h{constructor(e=new Array,t=new Array){this.nodes=e,this.children=t,this.lastTraversed=0,this.numNodesWithLoadedChildren=0}}const p=new Map;class m{constructor(e){this.missing=e,this.update=new r({deallocator:null}),this.add=new r({deallocator:null}),this.remove=new r({deallocator:null}),this.cancel=[]}reset(e){this.add.clear(),this.update.clear(),this.cancel=e}}function f(e){return a.addWraparound(e,-2)}function g(e){return a.addWraparound(e,2)}function y(e,t){return t+(e?1:0)}function _(e,t){return(-2&e)===t}function b(e){return!(1&~e)}function v(e,t){return e<0?-1:t>0?e/t|0:0}function S(e,t){return e<0?-e-1:0===t?e:e%t}function w(e,t,r){return-1===t?-(e+1):0===r?e:t*r+e}const x=[["maxScreenThreshold",o.LodMetric.MaxScreenThreshold],["screenSpaceRelative",o.LodMetric.ScreenSpaceRelative],["removedFeatureDiameter",o.LodMetric.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",o.LodMetric.DistanceRangeFromDefaultCamera]];function T(e){if(e)for(let t=0;t<e.length;t++)for(const r of x)if(r[0]===e[t].metricType)return{lodMetric:r[1],maxError:e[t].maxError};return{lodMetric:o.LodMetric.None,maxError:0}}class C{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}class P{constructor(){this.numFeatures=0,this.knownNodes=0,this.missingNodes=0}}function M(e){return Math.sqrt(e*(4/Math.PI))}const R=n.create(),E=n.create(),O=n.create(),A=n.create(),I=t("esri-mobile")?100:300;e.I3SIndex=class{get _useNodePages(){return this._pageSize>0}constructor(e,t,i,s,n,a,l,c,u,d,h,p,f,y,_,b){this.viewingMode=e,this._layer=t,this._streamDataController=s,this._clientNodeLoader=n,this._viewportQueries=a,this._logger=l,this.holeFilling=c,this._isLoaded=u,this._isReloading=d,this._isSelected=h,this._enable=p,this._needsUpdate=f,this._canRequest=y,this._computeVisibilityObb=_,this._computeNodeFiltering=b,this._dirty=!0,this._nodePages=new Map,this._clientNodePage=null,this._pageSize=0,this._rootIndex=0,this._lodMetric=o.LodMetric.None,this._lodConversion=e=>e,this._isEditable=!1,this._urlPrefix="",this._loadingNodes=new Set,this._loadingPages=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._version=g(0),this._visibilityCacheVersion=g(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missingPagesAndNodes=new r({deallocator:null}),this._prefetchNodes=new r({deallocator:null}),this._updates=new m(this._missingPagesAndNodes),this._imModificationUncategorized=new r({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=new Array,this._newPages=new Array,this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._frameNumber=0,this._traverseDescendantsQueue=[0],this._traverseDescendantsNestingLevel=0,this._isEditable=null!=t.associatedLayer?.infoFor3D,t.serviceUpdateTimeStamp?.lastUpdate&&(this._lastUpdate=`${t.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(i)}_init(e){if("page"===e.type){const t=e.rootPage;switch(this._urlPrefix=e.urlPrefix,this._pageSize=e.pageSize,e.lodMetric){case"maxScreenThreshold":this._lodMetric=o.LodMetric.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=o.LodMetric.MaxScreenThreshold,this._lodConversion=M}if(this._isEditable){this._rootIndex=-1;const r=S(e.rootIndex,e.pageSize),i=t.nodes[r],s={nodes:[{index:this._rootIndex,children:[e.rootIndex],mesh:void 0,obb:i.obb,lodThreshold:i.lodThreshold}]};this._addPage(v(this._rootIndex,this._pageSize),s),this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=e.rootIndex;this._addPage(v(e.rootIndex,this._pageSize),t),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix;const t=new h;if(this._nodePages.set(0,t),this._isEditable){this._clientNodePage=new h;const t={id:"-1",version:null,mbs:e.rootNode.mbs,obb:e.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:e.rootNode.mbs,obb:e.rootNode.obb}]};this._rootIndex=this._makeClientRefNode(new o.NodeBase(t.id,null),-1);const r=this._validateNode(t.id,t);r&&this._addNode(r,this._rootIndex)}else this._rootIndex=this._makeRefNode(new o.NodeBase(e.rootNode.id,null),-1);const r=this._validateNode(e.rootNode.id,e.rootNode);r&&this._addNode(r,0)}}addClientNodeToIndex(e,t){const r=new o.NodeBase(e,t),i=this._makeClientRefNode(r,-1);return this._linkChildToParentNode(-1,i),this.requestUpdate(),i}removeClientNodeFromIndex(e,t,r){this._destroyClientRefNode(e,t,r),this.requestUpdate()}_loadPage(e){this._loadingPages.add(e);const t=this._urlPrefix+e;this._streamDataController.request(t,"json").then((t=>{this._pageQueue.push({pageIndex:e,page:t})})).catch((t=>{this._loadingPages.delete(e),i.isAbortError(t)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._layer,`Error when loading page ${e}`,t))}))}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:r}=this._pageQueue.shift();this._addPage(t,r),this._loadingPages.delete(t),e.madeProgress(),this.needNodeElevationRange&&this._newPages.push(t)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(e){if(this.needNodeElevationRange)for(;this._newPages.length>0&&!e.done;){const e=this._nodePages.get(this._newPages.shift());e?.nodes.forEach((e=>{let t=e.parent;for(;null!=t&&t!==this._rootIndex;){const e=this.getNode(t);e&&!Number.isNaN(e?.elevationRangeMin)&&(e.invalidateElevationRange(),this.invalidateBoundingVolumeCache(t)),t=this.getParentIndex(t)}}))}}_addPage(e,t){const r=[],i=[],s=t.nodes.map(((t,s)=>{const a=r.length,l=t.children?t.children.length:0;i.push(this._rootIndex);for(let e=0;e<l;e++)r.push(t.children[e]);const c=`${t.index}`,h=u.Obb.fromJSON(t.obb),p=n.fromCenterAndRadius(h.center,h.radius),m=t.mesh?.attribute,g=t.mesh?.geometry,y=t.mesh?.material,_={hasSharedResource:!1,isEmpty:null==g,attributes:null!=m?.resource?`${m.resource}`:void 0,geometry:null!=g?.resource?`${g.resource}`:void 0,texture:null!=y?.resource?`${y.resource}`:void 0,geometryDefinition:g?g.definition:-1,materialDefinition:y?y.definition:-1},b=new o.Node(c,w(s,e,this._pageSize),p,l,0,_,this._lastUpdate,this._lodMetric,this._lodConversion(t.lodThreshold),g?.featureCount??null);return b.serviceObbInIndexSR=h,b.visibilityObbInRenderSR=this._computeVisibilityObb(b),b.vertexCount=g?g.vertexCount:0,new d(a,l,f(this._visibilityCacheVersion),null,b)})),a=new h(s,r);-1===e?this._clientNodePage=a:this._nodePages.set(e,a)}_updateParentsAndLevel(){const e=new Array,t=(t,r,i)=>{const s=this._getPage(t);if(null!=s){const n=S(t,this._pageSize),o=s.nodes[n];o.parent=null!=r?r:-1;const a=o.node;null!=a&&(a.level=i,e.push(t))}};for(t(this._rootIndex,null,0);e.length;){const r=e.pop(),i=this.getNode(r);if(null!=i)for(let e=0;e<i.childCount;e++)t(this.getChildIndex(i.index,e),r,i.level+1),this._maxLevel=Math.max(this._maxLevel,i.level+1)}}_getPage(e){const t=v(e,this._pageSize);return this._getPageFromPageIndex(t)}_getPageFromPageIndex(e){return e<0?this._clientNodePage:this._nodePages.get(e)}_getNodeInternal(e){const t=this._getPage(e);return null==t?null:(t.lastTraversed=this._frameNumber,t.nodes[S(e,this._pageSize)])}_addNode(e,t){e.children&&this.populateChildren(t,e.children);const r=this.getParent(t),i=null!=r?r.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?i+1:i);const{lodMetric:s,maxError:n}=T(e.lodSelection),a=this._getNodeInternal(t),l=new o.Node(e.id,t,e.mbs,a.childCount,i,e.resources,e.version,s,n,e.numFeatures);a.node=l,e.obb&&(l.serviceObbInIndexSR=u.Obb.fromJSON(e.obb)),l.visibilityObbInRenderSR=this._computeVisibilityObb(l);const c=a.ref;return null!=c&&(null==c.serviceMbsInIndexSR&&(c.serviceMbsInIndexSR=e.mbs),l.shareServiceBVsInRenderSRWith(c),c.visibilityObbInRenderSR=l.visibilityObbInRenderSR),l}_makeRefNode(e,t){const r=this._nodePages.get(0);if(t<-1)return this._makeClientRefNode(e,t);if(null==r)return-1;const i=r.nodes.length,s=new d(0,0,f(this._visibilityCacheVersion),e,null);return r.nodes.push(s),s.parent=t,e.invalidateServiceBVsInRenderSR(),i}_makeClientRefNode(e,t){const r=this._clientNodePage;if(null==r)return-1;if(t>=0)throw new Error("I3SIndex::client side nodes can not be made children of service side nodes.");const i=-(r.nodes.length+1),s=new d(0,0,f(this._visibilityCacheVersion),e,null);return r.nodes.push(s),s.parent=t,e.invalidateServiceBVsInRenderSR(),i}_linkChildToParentNode(e,t){const r=this._clientNodePage;if(null==r||e>=0)return;const i=S(e,this._pageSize),s=S(t,this._pageSize),n=r.nodes[i],o=n.childOffset;r.children.splice(n.childOffset+n.childCount,0,t),n.childCount+=1,null!=n.node&&(n.node.childCount+=1);for(const e of r.nodes)e.childOffset>o&&(e.childOffset+=1);r.nodes[s].parent=e,this._updateParentBoundingInformation(e)}_destroyClientRefNode(e,t,r){const i=this._clientNodePage;if(null==i)return;const s=this.getParentIndex(e);if(null==s)return;const n=new Set,o=new Map,a=e=>{const r=S(e,this._pageSize),s=i.nodes[r];if(s.childCount>0)for(let e=s.childOffset;e<s.childOffset+s.childCount;++e)a(i.children[e]);const o=s.node?.id??s.ref?.id;if(null==o)throw new Error("Node has no id");t(o,e),n.add(s)};a(e);const l=i.nodes,c=i.children,u=i.nodes.map((()=>-1)),d=[],h=[];for(let e=0;e<l.length;++e){const t=l[e];if(n.has(t))continue;const i=d.length,s=w(e,-1,this._pageSize),a=w(i,-1,this._pageSize);if(t.node&&(t.node.index=a),u[e]=a,d.push(t),s!==a){const e=t.node?.id??t.ref?.id;if(null==e)throw new Error("Node has no id");r(e,s,a),o.set(s,a)}}for(let e=0;e<d.length;++e){const t=w(e,-1,this._pageSize),r=d[e],i=h.length;for(let e=r.childOffset;e<r.childOffset+r.childCount;++e){const r=c[e];if(r>=0)h.push(r);else{const e=S(r,this._pageSize),i=l[e];if(n.has(i))continue;const s=u[e];h.push(s),i.parent=t}}r.childOffset=i,r.childCount=h.length-i,r.node&&(r.node.childCount=r.childCount)}i.nodes=d,i.children=h,this._updateParentBoundingInformation(u[S(s,this._pageSize)])}_updateParentBoundingInformation(e){let t=e;do{let e=null;const r=this._clientNodeLoader.indexSR,i=this._clientNodeLoader.renderSR,o=this._getNodeInternal(t);if(null==o)return;for(let a=0;a<o.childCount;a++){const o=this.getChildIndex(t,a),l=this._getNodeInternal(o),c=null!=l?l.ref||l.node:null;if(null!=c&&c.serviceMbsInIndexSR[3]>0)if(null==e)e=n.copy(c.serviceMbsInIndexSR,R);else{const t=E,o=O,a=A;s.projectBoundingSphere(c.serviceMbsInIndexSR,r,t,i),s.projectBoundingSphere(e,r,o,i),n.union(t,o,a),s.projectBoundingSphere(a,i,e,r)}}const l=t=>{null!=t&&(t.serviceObbInIndexSR=null,null!=e?(t.serviceMbsInIndexSR??=n.create(),n.copy(e,t.serviceMbsInIndexSR)):a.invalidateMbs(t.serviceMbsInIndexSR),t.invalidateServiceBVsInRenderSR(),t.geometryObbInRenderSR=null)};l(o.ref),l(o.node),this.invalidateNodeVisibilityCacheInternal(o),t=this.getParentIndex(t)}while(null!=t)}populateChildren(e,t){const r=this._getNodeInternal(e),i=this._getPage(e);r.childOffset=i.children.length,r.childCount=t.length;for(let r=0;r<t.length;r++){const s=this._makeRefNode(t[r],e);i.children.push(s)}}getNode(e){const t=this._getNodeInternal(e);return null!=t?t.node:null}getIndexById(e){let t;return this._forAllNodes(((r,i)=>{(null!=r.node&&r.node.id===e||null!=r.ref&&r.ref.id===e)&&(t=i)})),t}getNodeById(e){const t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null}getChildIndex(e,t){const r=this._getPage(e);if(null==r)return-1;const i=r.nodes[S(e,this._pageSize)];return r.children[i.childOffset+t]}getParentIndex(e){const t=this._getPage(e);return null!=t&&e!==this._rootIndex?t.nodes[S(e,this._pageSize)]?.parent:null}getParent(e){const t=this.getParentIndex(e);return null!=t?this.getNode(t):null}isLeaf(e){const t=this._getNodeInternal(e);return null!=t&&0===t.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes((e=>{null!=e.node&&(e.node.geometryObbInRenderSR=null)}))}invalidateVisibilityCache(){this._visibilityCacheVersion=g(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(e){const t=this._getNodeInternal(e);null!=t&&this.invalidateNodeVisibilityCacheInternal(t)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=f(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(e){const t=this._getNodeInternal(e);null!=t&&(t?.invalidateBounds(),this.invalidateNodeVisibilityCacheInternal(t))}updateElevationChanged(e){const t=this._getNodeInternal(e);if(null==t)return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(e);const r=null!=t.node?t.node:t.ref;null!=r&&r.invalidateElevationRange()}invalidateGeometryVisibility(e){const t=this._getNodeInternal(e),r=t?.node;r&&(r.geometryObbInRenderSR=null,r.invalidateServiceBVsInRenderSR())}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,(e=>(e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.geometryObbInRenderSR=null,!0)))}_isElevationRangeUpToDate(e){if(!this.needNodeElevationRange)return!0;const t=e?.node??e?.ref;return!t||t.elevationRangeValid}updateElevationRange(e){this._updateElevationRangeInternal(e,null)}_updateElevationRangeInternal(e,t){const r=this._getNodeInternal(e);if(!r)return!1;const i=r?.node??r?.ref;if(!i)return!1;if(i.elevationRangeValid)return t?.expandElevationRange(i),!0;const s=new c.ElevationRange;let n=!1;for(let t=0;t<r.childCount;t++){const r=this.getChildIndex(e,t),i=this._updateElevationRangeInternal(r,s);n=n||!i}if(0===r.childCount||n){const e=!r.node?.resources.isEmpty;this._viewportQueries.expandElevationRange(i,e,s)}const o=i.elevationRangeMin,a=i.elevationRangeMax;return o===s.elevationRangeMin&&a===s.elevationRangeMax?(t?.expandElevationRange(i),!0):(r.node?.setElevationRange(s),r.ref?.setElevationRange(s),this.invalidateBoundingVolumeCache(e),t?.expandElevationRange(i),!0)}isNodeVisible(e){const t=this._getNodeInternal(e);if(null==t)return!0;const r=t.ref;if(null!=r&&!r.serviceMbsInIndexSR)return!0;if(this._isElevationRangeUpToDate(t)&&_(t.visibilityCache,this._visibilityCacheVersion))return b(t.visibilityCache);const i=t.node,s=this._viewportQueries;if(i){const e=s.ensureElevationAgnosticBoundingVolume(i),r=s.isElevationAgnosticBoundingVolumeVisible(e);let n=r;if(this.needNodeElevationRange&&r){const t=s.getNodeObbInRenderSRIndependentOfElevationOffset(i);null!=t&&(n=s.isObbVisibleIndependentOfElevation(e,t))}if(!n)return t.visibilityCache=y(!1,this._visibilityCacheVersion),!1}if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=i||null!=r)&&t.filterImpact===o.NodeFilterImpact.NotChecked){const e=null!=i?i.serviceMbsInIndexSR:null!=r?r.serviceMbsInIndexSR:null;t.filterImpact=null!=e?this._computeNodeFiltering(e):o.NodeFilterImpact.Unmodified}const n=null!=i&&t.filterImpact===o.NodeFilterImpact.Culled;let a=!(null!=i&&i.imModificationImpact===o.NodeIMModificationImpact.Culled||n);if(a){const t=!i||r&&!i.visibilityObbInRenderSR?r??null:i;null!=t&&(this.needNodeElevationRange&&this.updateElevationRange(e),a=s.isNodeVisible(t))}return t.visibilityCache=y(a,this._visibilityCacheVersion),a}isGeometryVisible(e){if(!this.isNodeVisible(e))return!1;const t=this._getNodeInternal(e);return!!(null==t?.node?.geometryObbInRenderSR||this.layerHasModifications&&t.node.imModificationImpact===o.NodeIMModificationImpact.NotChecked)||this._viewportQueries.isGeometryVisible(t.node)}_traverseCoverage(e,t,r,i,s){const n=this._getPage(e);if(null==n||0===t.childCount)return;const o=t.childOffset+t.childCount,a=new Array;for(let e=t.childOffset;e<o;++e){const t=n.children[e],r=this._getNodeInternal(t);null!=r?.node&&this.isGeometryVisible(t)&&a.push(r)}i/=a.length;for(const e of a){const t=e.node.index;this._isLoaded(t)||this._isReloading(t)?(s.delta=Math.max(s.delta,r),s.coverage+=i):this._traverseCoverage(t,e,r+1,i,s)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if(null==t)return!1;if("always"===this.holeFilling)return!0;if(_(t.useAsHole,this._version))return b(t.useAsHole);const r={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,r);const i=r.delta*r.coverage<=.5;return t.useAsHole=y(i,this._version),i}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=g(this._version)}imModificationsChanged(e){this.layerHasModifications=e,this._forAllNodes((({node:e})=>{null!=e&&(e.imModificationImpact=o.NodeIMModificationImpact.NotChecked,e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.hasModifications&&this.invalidateGeometryVisibility(e.index))})),this.invalidateVisibilityCache()}layerFilterChanged(e){this._layerHasFilter=e,this._forAllNodes((e=>{if(null!=e){e.filterImpact=o.NodeFilterImpact.NotChecked;const t=e.node;null!=t&&this.invalidateNodeVisibilityCache(t.index)}})),this.invalidateVisibilityCache()}update(e,t,r){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._invalidateElevationRangeForNewPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missingPagesAndNodes.clear(),this._prefetchNodes.clear(),this._updates.reset(e),p.clear();let i=!0;const s=new C,n=new P,a=this._imModificationUncategorized;a.clear();const l=new Set;let c=0;this.traverseVisible(((l,u,d)=>{const h=v(l,this._pageSize);if(null==u){let e=this._entryPriority(l);return e===1/0&&(e=this._entryPriority(d)),p.set(h,Math.max(e,p.get(h)||0)),this._loadingPages.has(h)||this._failedPages.has(h)||(this._missingPagesAndNodes.push(h),++c),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const m=u.node;if(this._updateNodeFeatureEstimate(m,n),null==m){const e=this._entryPriority(l);return this._loadingNodes.has(l)||this._failedNodes.has(l)||(this._missingPagesAndNodes.push(l),p.set(l,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const f=this._getPage(l);if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(let e=0;e<u.childCount;e++){const t=f.children[u.childOffset+e],r=this._getNodeInternal(t);null!=r&&!r.node&&!this._loadingNodes.has(t)&&!this._failedNodes.has(t)&&t>=0&&(p.set(t,this._entryPriority(t)),this._prefetchNodes.push(t))}if(m.failed||m.resources.isEmpty)return void(i&&u.childCount>0&&this._isSelected(m)&&(i=!1));if(this._isLoaded(l)){if(s.known+=m.memory,++s.knownNodes,this._isSelected(m)?u.childCount>0&&(i=!1):(s.unremoved+=m.memory,i=!1),this._needsUpdate(m)){const e=this._entryPriority(l);p.set(l,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(l)}return}if(m.memory&&(s.known+=m.memory,++s.knownNodes),!this._isSelected(m))return void(this._isReloading(l)&&this._updates.remove.push(l));if(u.childCount>0&&(i=!1),m.memory?(s.missing+=m.memory,s.known+=m.memory,++s.knownNodes):++s.missingNodes,e.includes(m.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(l)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==m.index)));if(!t.done&&this._enable(m))return void t.madeProgress();const g=this._entryPriority(l);p.set(l,g),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,g),this._updates.add.push(l),this.layerHasModifications&&r&&null!=m&&m.imModificationImpact===o.NodeIMModificationImpact.NotChecked&&a.push(l)}),l),this._frameNumber++,this._missingPagesAndNodes.sort(((e,t)=>e-t)),this._missingPagesAndNodes.filterInPlace(((e,t)=>t<1||this._missingPagesAndNodes.data[t-1]!==e)),this._missingPagesAndNodes.sort(((e,t)=>p.get(e)-p.get(t))),this._missingPagesAndNodes.length>0&&(this._maxUnloadedPrio=p.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear()),this._removeUnusedNodePages(l,c);const u=this._updates.add;u.length>0&&this.layerHasModifications&&(a.length>0&&r?.(a),u.filterInPlace((e=>{const t=this._getNodeInternal(e),r=null==t?.node||t.node.imModificationImpact!==o.NodeIMModificationImpact.Culled;return r||this.invalidateNodeVisibilityCache(e),r}))),this._unloadedMemoryEstimate=s.missing-s.unremoved,s.knownNodes>3&&s.missingNodes>0&&(this._unloadedMemoryEstimate+=s.known/s.knownNodes*s.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(n),this._featureEstimate.leavesReached=i,this._updates.add.filterInPlace((e=>p.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>p.get(e)-p.get(t))),this._updates.update.sort(((e,t)=>p.get(e)-p.get(t))),this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length,this._dirty=this._indexMissing>0,p.clear()}checkFeatureTarget(e,t){const r=this._viewportQueries.updateScreenSpaceErrorBias(t);let i=t,s=t,n=r,o=10;for(;o--;){const r=new P;if(this._updateFeatureEstimate(i,r),this._computeFeatureEstimate(r)<=e){if(i>=t||r.missingNodes>0||0===o)break;n=i,i=.5*(i+s)}else s=i,i=.5*(i+n)}return this._version=g(this._version),this._viewportQueries.updateScreenSpaceErrorBias(r),Math.min(t,i)}_removeUnusedNodePages(e,t){if(!this._useNodePages)return;const r=e.size,i=this._nodePages,s=i.size+this._loadingPages.size+t;if(s>I&&s>r){const t=new Array;for(const[r,s]of i)0!==s.numNodesWithLoadedChildren||e.has(r)||t.push([s.lastTraversed,r]);t.sort(((e,t)=>e[0]-t[0])).some((e=>{const t=e[1];return this._deleteNodePage(t),i.size<=I}))}}_updateFeatureEstimate(e,t){this._version=g(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(((e,r)=>this._updateNodeFeatureEstimate(r?.node,t)))}_updateNodeFeatureEstimate(e,t){null!=e&&!e.failed&&this._isSelected(e)&&(null!=e.numFeatures?(t.numFeatures+=e.numFeatures,++t.knownNodes):++t.missingNodes)}_computeFeatureEstimate(e){let t=e.numFeatures;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.numFeatures/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){return this._prefetchNodes.sort(((e,t)=>p.get(e)-p.get(t))),this._load(this._prefetchNodes)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();){const t=e.pop();this._useNodePages&&t>=0?this._loadPage(t):this._loadNode(t)}return!0}get isLoading(){return this._indexMissing>0}get isPrefetching(){return this._prefetchNodes.length>0}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(e){if(null==e)return null;const t=e.index,r=this._getNodeInternal(t);if(!r)return null;let i=r?.traversalState;if(i&&_(i.version,this._version))return i;const s=this._viewportQueries.getLodLevel(e),n=this._viewportQueries.hasLOD(e);let a=!0;if(n){const e=this.getParentIndex(t);if(null!=e){const t=this._getNodeInternal(e),r=t?.traversalState;a=!!r&&s>r.lodLevel}else a=s>0}else a=0===e.childCount;return i?(i.lodLevel=s,i.isChosen=a,i.version=y(!0,this._version),i):(i=new o.NodeTraversalState(n,a,s,y(!0,this._version)),r.traversalState=i,i)}async _loadNode(e){this._loadingNodes.add(e);const t=this._getNodeInternal(e).ref;if(null==t)return void this._failedNodes.add(e);const r=t.id,s=this._urlPrefix+r,n=()=>{this._loadingNodes.delete(e),0===this._missingPagesAndNodes.length&&0===this._loadingNodes.size&&this.requestUpdate()};let o=null;try{o=e>=0?await this._streamDataController.request(s,"json"):await this._clientNodeLoader.loadNodeJSON(r)}catch(t){return n(),void(i.isAbortError(t)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+s),this._failedNodes.add(e)))}n();const a=this._validateNode(r,o);if(null==a)return;a.obb&&this.invalidateNodeVisibilityCache(e);const l=this._addNode(a,e);this.nodeTraversalState(l)}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${e}"`);const r=t.geometryData;null==r||Array.isArray(r)&&0===r.length||Array.isArray(r)&&1===r.length&&"./geometries/0"===r[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${e}"`);const i=t.attributeData,s=this._layer.attributeStorageInfo;null==i||Array.isArray(i)&&!i.some(((e,t)=>e.href!==`./attributes/${s?.[t]?.key??`f_${t}`}/0`))||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._layer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const n=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:void 0,a=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,c=Array.isArray(t.children)?t.children.map((t=>{if(null==t)return null;const r=t=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)r(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return r("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return r(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${e}"`);const i=new o.NodeBase(`${t.id}`,t.mbs);return i.serviceObbInIndexSR=!this.ignoreServiceObb&&t.hasOwnProperty("obb")&&t.obb?u.Obb.fromJSON(t.obb):null,i.visibilityObbInRenderSR=this._computeVisibilityObb(i),i})).filter((e=>null!=e)):null,d=t.featureData?.length??!1,h=!0===t.isEmpty;return new l.ValidatedNode(e,t.mbs,n,"string"==typeof t.version?t.version:null,{isEmpty:!d&&h,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},c,Array.isArray(t.lodSelection)?t.lodSelection:null,a)}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((e=>{null!=e.node&&(e.node.failed=!1)}))}_entryPriority(e){const t=this._getNodeInternal(e),r=this.getParentIndex(e);if(null==t||null==r&&null==t.node)return null==r?1/0:this._entryPriority(r);let i=0;if(t.node&&null!=r){const e=this._getNodeInternal(r).traversalState;null!=e&&(i=e.lodLevel)}let s=this.progressiveLoadPenalty;for(let t=e;null!=t;t=this.getParentIndex(t))if(this._isLoaded(t)){s=0;break}const n=null!=t.ref?this._viewportQueries.distToPOI(t.ref):null!=t.node?this._viewportQueries.distToPOI(t.node):0;return-n-i*(n+this.progressiveLoadPenalty)+s}traverseVisible(e,t){const r=this._getNodeInternal(this._rootIndex);null!=r?this._traverseVisible(this._rootIndex,null,r,e,t):e(this._rootIndex,null,null)}_traverseVisible(e,t,r,i,s){const n=v(e,this._pageSize);if(s&&s.add(n),r.node&&0===r.childCount)return void(this.isGeometryVisible(e)&&i(e,r,t));if(!this.isNodeVisible(e))return;if(i(e,r,t),null==r.node)return;const o=this.nodeTraversalState(r.node);if(o?.nodeHasLOD&&o.lodLevel===this._maxLodLevel)return;const a=this._getPageFromPageIndex(n);for(let t=0;t<r.childCount;t++){const n=a.children[r.childOffset+t],o=this._getNodeInternal(n);if(o)this._traverseVisible(n,e,o,i,s);else{if(s){const e=v(n,this._pageSize);s.add(e)}i(n,null,e)}}}traverse(e,t){t(e)&&this.traverseDescendants(e,t)}traverseDescendants(e,t){++this._traverseDescendantsNestingLevel;const r=e.index,i=this._pageSize,s=v(r,i),n=this._getPageFromPageIndex(s);if(null==n)return;const o=this._frameNumber,a=this._nodePages,l=S(r,i),c=n.nodes[l],u=c.childCount;if(n.lastTraversed=o,0===u)return;const d=new Array,h=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0];let p=0;{const{childOffset:e,childCount:t}=c,{children:r}=n;h.length=2**Math.ceil(Math.log2(p+t));for(let i=e;i<e+t;++i){const e=r[i];e>=0?(h[p]=e,++p):d.push(e)}}if(d.length>0){const e=this._clientNodePage;if(e){const r=e.children;let i=0;for(;i<d.length;){const s=d[i];++i;const n=-s-1,o=e.nodes[n],a=o.node;if(!a||!t(a))continue;const{childCount:l}=o;if(0===l)continue;const{childOffset:c}=o,u=c+l;for(let e=c;e<u;++e)d.push(r[e])}}}if(p>0){let e=0;if(i>0){let r=s*i,l=n,c=l.nodes;for(;e<p;){const s=h[e];let n;if(++e,r<=s&&s<r+i)n=l;else{const e=s/i|0,t=a.get(e);if(void 0===t)continue;n=t,n.lastTraversed=o,l=n,c=l.nodes,r=i*e}const u=c[s-r],d=u.node;if(null==d||!1===t(d))continue;const{childCount:m}=u;if(0===m)continue;const f=p+m;for(h.length<f&&(h.length=2**Math.ceil(Math.log2(p+m)));h.length<p+m;)h.length+=h.length;const g=n.children,{childOffset:y}=u,_=y+m;for(let e=y;e<_;++e)h[p]=g[e],++p}}else{const r=a.get(0);if(r)for(;e<p;){const i=h[e++],s=r.nodes[i],n=s.node;if(!n||!t(n))continue;const{childCount:o}=s;if(0===o)continue;h.length=Math.max(h.length,2**Math.ceil(Math.log2(p+o)));const a=r.children,{childOffset:l}=s,c=l+o;for(let e=l;e<c;++e)h[p]=a[e],++p}}}--this._traverseDescendantsNestingLevel}updateChildrenLoaded(e,t){let r=this.getNode(e);for(;null!=r;){const e=r.childrenLoaded,i=e+t;r.childrenLoaded=i;const s=0===e?1:0===i?-1:0,n=r.index;0!==s&&(this._getPage(n).numNodesWithLoadedChildren+=s),r=this.getParent(n)}}checkChildrenLoadedInvariant(){return!0}updateElevationInfo(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"relative-to-scene"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes((e=>{e?.invalidateBounds(),e.node?.invalidateElevationRange(),e.ref?.invalidateElevationRange()}))}_forAllNodes(e){if(null!=this._clientNodePage){const t=this._clientNodePage;for(let r=0;r<t.nodes.length;r++)e(t.nodes[r],-(r+1))}for(const[t,r]of this._nodePages){const i=t*this._pageSize;for(let t=0;t<r.nodes.length;t++)e(r.nodes[t],i+t)}}clearCaches(){if(this._useNodePages){const e=this._nodePages,t=new Set;this.traverseVisible((e=>t.add(v(e,this._pageSize))));for(const[r,i]of e)if(0!==i.numNodesWithLoadedChildren||t.has(r))for(const e of i.nodes)e.traversalState=null;else this._deleteNodePage(r)}}_deleteNodePage(e){this._nodePages.delete(e)}get test(){}},e.selectErrorMetric=T,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SNode":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../chunks/sphere","./I3SUtil","../../support/ElevationRange"],(function(e,t,r,i,s){"use strict";class n extends s.ElevationRange{constructor(e,t){super(NaN,NaN),this.id=e,this.serviceMbsInIndexSR=t,this.serviceMbsInRenderSR=r.fromValues(0,0,0,-1)}invalidateServiceBVsInRenderSR(){i.invalidateMbs(this.serviceMbsInRenderSR),this.serviceObbInRenderSR?.invalidate()}shareServiceBVsInRenderSRWith(e){this.serviceObbInRenderSR=e.serviceObbInRenderSR,this.serviceMbsInRenderSR=e.serviceMbsInRenderSR}}var o,a,l,c,u;e.NodeFilterImpact=void 0,(o=e.NodeFilterImpact||(e.NodeFilterImpact={}))[o.Unmodified=0]="Unmodified",o[o.Culled=1]="Culled",o[o.NotChecked=2]="NotChecked",e.NodeIMModificationImpact=void 0,(a=e.NodeIMModificationImpact||(e.NodeIMModificationImpact={}))[a.Unmodified=0]="Unmodified",a[a.PotentiallyModified=1]="PotentiallyModified",a[a.Culled=2]="Culled",a[a.Unknown=3]="Unknown",a[a.NotChecked=4]="NotChecked",e.CacheState=void 0,(l=e.CacheState||(e.CacheState={}))[l.Unknown=0]="Unknown",l[l.Uncached=1]="Uncached",l[l.Cached=2]="Cached",e.LodMetric=void 0,(c=e.LodMetric||(e.LodMetric={}))[c.None=0]="None",c[c.MaxScreenThreshold=1]="MaxScreenThreshold",c[c.ScreenSpaceRelative=2]="ScreenSpaceRelative",c[c.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",c[c.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera",e.NodeState=void 0,(u=e.NodeState||(e.NodeState={}))[u.Hole=0]="Hole",u[u.Leaf=1]="Leaf",e.Node=class extends n{constructor(r,i,s,n,o,a,l,c,u,d){super(r,s),this.index=i,this.childCount=n,this.level=o,this.resources=a,this.version=l,this.lodMetric=c,this.maxError=u,this.numFeatures=d,this.failed=!1,this.cacheState=e.CacheState.Unknown,this.vertexCount=0,this.memory=0,this.childrenLoaded=0,this.hasModifications=!1,this.imModificationImpact=e.NodeIMModificationImpact.NotChecked,this.elevationAgnosticBoundingVolume=t.fromValues(0,0,0,-1)}invalidateServiceBVsInRenderSR(){super.invalidateServiceBVsInRenderSR(),this.elevationAgnosticBoundingVolume[3]=-1}},e.NodeBase=n,e.NodeTraversalState=class{constructor(e,t,r,i){this.nodeHasLOD=e,this.isChosen=t,this.lodLevel=r,this.version=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/ValidatedNode":function(){define(["exports"],(function(e){"use strict";e.ValidatedNode=class{constructor(e,t,r,i,s,n,o,a){this.id=e,this.mbs=t,this.obb=r,this.version=i,this.resources=s,this.children=n,this.lodSelection=o,this.numFeatures=a}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SLodHandling":function(){define(["../../../../core/PooledArray","./I3SNode","../support/I3SLayerView"],(function(e,t,r){"use strict";const i=new e({deallocator:null});return class{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,t,r){this._maxLodLevel=r.maxLodLevel,this._index=t,this._removeNodes=e}shouldLoadNode(e){if(null==e)return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const t=this._layerView.view.resourceController.memoryController.usedMemory,r=Math.max(0,Math.floor(10*(t-1)));i.clear(),this._lodGlobalHandling(this._index.rootNode,r,!1,!!this._layerView.nodeCrossfadingEnabled);const s=i.length;this._removeNodes(i,e);const n=i.length<s;return 0!==i.length&&(this._lodGlobalDirty=!0),i.clear(),n}_lodGlobalHandling(e,s,n,o){if(null==e)return!1;const a=e.index,l=this._index,c=this._layerView,u=l.nodeTraversalState(e),d=this._isChosenMaxLOD(u),h=e.resources.isEmpty;if(d&&h)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const p=c.isNodeLoaded(a);if(o&&p&&d){const t=!n&&this.hasNoVisibleChildren(e);c.fadeNode(a,r.FadeDirection.FadeIn,!t)}const m=p&&(!c.isNodeFullyFadedIn||c.isNodeFullyFadedIn(a));if(p&&(c.updateNodeState(a,d?t.NodeState.Leaf:t.NodeState.Hole),d))return m&&this._removeChildrenRecursive(e),m;const f=e.childCount>0;let g=f;if(f)for(let t=0;t<e.childCount;t++){const e=l.getChildIndex(a,t),r=l.getNode(e);null!=r?!l.isGeometryVisible(e)||this._lodGlobalHandling(r,s,n||m,o)||(g=!1):l.isNodeVisible(e)&&(g=!1)}const y=p&&!d&&(g||i.length<s);y&&i.push(a),!o||y||!p||n||g||c.fadeNode(a,r.FadeDirection.FadeIn,!1);const _=e.resources.isEmpty;return g||m&&!y||_}_removeChildrenRecursive(e){this._index.traverseDescendants(e,(e=>((this._layerView.isNodeLoaded(e.index)||this._layerView.isNodeReloading(e.index))&&i.push(e.index),e.childrenLoaded>0)))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseDescendants(e,(e=>!(!t||!this._index.isNodeVisible(e.index))&&(this._layerView.isNodeLoaded(e.index)?(t=!1,!1):e.childrenLoaded>0))),t}_childrenRequireLoading(e){let t=!1,r=!0;return this._index.traverseDescendants(e,(e=>{if(!r||!this._index.isNodeVisible(e.index))return!1;const i=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(i)&&this._index.isGeometryVisible(e.index)&&(t=!0),this._layerView.isNodeLoaded(e.index)?(r=!1,!1):e.childrenLoaded>0})),r&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}}))},"esri/views/3d/layers/support/I3SLayerView":function(){define(["exports"],(function(e){"use strict";var t;e.FadeDirection=void 0,(t=e.FadeDirection||(e.FadeDirection={}))[t.FadeIn=0]="FadeIn",t[t.FadeOut=1]="FadeOut",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SNodeLoader":function(){define(["../../../../core/asyncUtils","../../../../core/has","../../../../core/lang","../../../../core/promiseUtils","../../../../core/urlUtils","./enums","./I3SBinaryReader","./I3SMaterialUtil"],(function(e,t,r,i,s,n,o,a){"use strict";class l{constructor(e,t,r,i,s,n){if(this._streamDataController=t,this._logger=r,this._defaultGeometrySchema=i,this._requiredAttributes=s,this._options=n,this._logLayer=e,this._layerUrl=e.parsedUrl.path,this._geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const t=e.textureSetDefinitions;this._materialAndTextures=e.materialDefinitions.map((r=>a.getMaterialAndTextures(t,r,"integrated-mesh"===e.type)))}}_load(e,t,r){return this._streamDataController.request(e,t,r)}_loadAttribute(e,t,r){const i=`${this._layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`;return this._load(i,"binary",r).then((e=>o.readBinaryAttribute(t,e)))}async loadAttributes(e,t,r){const s=await Promise.allSettled(t.map((t=>this._loadAttribute(e,t.attributeStorageInfo,r)))),n={};for(let r=0;r<t.length;++r){const o=s[r],a=t[r];if("fulfilled"===o.status){const e=o.value;n[a.name]=e}else{const t=o.reason;i.throwIfAbortError(t),this._logger.error("#loadAttributes",this._logLayer,`Failed to load attributeData for '${a.name}' on node '${e.id}'`,t)}}return n}async loadNodeData(i,s){const n=null!=this._requiredAttributes&&i.resources.attributes?e.result(this.loadAttributes(i,this._requiredAttributes,s)):null,{bufferDefinition:l,bufferIndex:c}=function(e,r){const i={bufferDefinition:null,bufferIndex:0},s=r.resources.geometryDefinition;if(null==e||null==s||s<0)return i;const n=s>=0?e[s].geometryBuffers:null;if(null==n)return i;for(let e=0;e<n.length;e++){const r=n[e];if(null==r.compressedAttributes)i.bufferIndex=e,i.bufferDefinition=n[e];else if("draco"===r.compressedAttributes.encoding&&!t("disable-feature:i3s-draco"))return i.bufferIndex=e,i.bufferDefinition=r,i}return i}(this._geometryDefinitions,i),u=!!i.resources.geometry,d=u?e.result(this._loadGeometry(i.resources.geometry,c,s)):null,h=i.resources.hasSharedResource?await this._loadShared(i,s):null,p=i.resources.materialDefinition,m=this._materialAndTextures&&null!=p&&p>=0?this._materialAndTextures[p]:null!=h?a.getMaterialAndTexturesFromShared(h):null,f=m?.material,g=m?.textures??[],y=`${i.id}`,_=!u&&this._options.loadFeatureData,b=_?await this._loadFeatureData(y,s):null,v=_?function(e){if(!e)return null;for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const r of e)return{featureIds:[t.id],featureDataPosition:t.position,geometries:[r]}}return null}(b):function(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(f),S=null==v?function(e){if(!e)return null;const t=new Array;for(const r of e.featureData)null!=r.position&&t.push({featureIds:[r.id],featureDataPosition:r.position,geometries:[]});return t}(b):null,w=g.length>0?e.result(this.loadTextures(i,g,s)):null;let x=null,T=null;if(d){x=e.assertResult(await d);const t=function(e,t){if(!e||!t?.materialDefinitions)return e;const i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=r.clone(e)).vertexAttributes.region,e}(this._defaultGeometrySchema,h);T=o.createGeometryDescriptor(l,t)}const C=w?e.assertResult(await w):null,P=n?e.assertResult(await n):{},M=P?{attributeData:P,loadedAttributes:this._requiredAttributes}:null;if(null!=v)return{geometryData:v,attributeDataInfo:M,geometryBuffer:x,geometryDescriptor:T,requiredTextures:g,textureData:C};if(null!=S)return{pointData:S,attributeDataInfo:M,geometryBuffer:x,geometryDescriptor:T,requiredTextures:g,textureData:C};throw new Error}static _addAbsoluteHrefTexture(e,t){const r=e.textureDefinitions;if(null!=r)for(const e of Object.keys(r))for(const i of r[e].images)Array.isArray(i.href)?i.hrefConcat=i.href.map((e=>s.makeAbsolute(e,t))):i.hrefConcat=s.makeAbsolute(i.href,t)}static _fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const e in t){const r=t[e];if(Array.isArray(r.encoding))for(let e=0;e<r.encoding.length;e++){const t=r.encoding[e];"data:"===t.slice(0,5)&&(r.encoding[e]=t.slice(5))}else{const e=r.encoding;"data:"===e.slice(0,5)&&(r.encoding=e.slice(5))}}}async _loadShared(e,t){if(null==e.resources.geometry)return{};const r=`${this._layerUrl}/nodes/${e.resources.geometry}/shared`,i=await this._load(r,"json",t);return l._fixTextureEncodings(i),l._addAbsoluteHrefTexture(i,r),i}_loadTexture(e,t,r,i,s){return i===n.TextureEncoding.DDS_S3TC||i===n.TextureEncoding.KTX2||i===n.TextureEncoding.Basis?this._load(e,"binary",s).then((e=>({id:t,usage:r,data:e,encoding:i}))):this._load(e,"image",s).then((e=>({id:t,usage:r,data:e,encoding:i})))}loadTextures(e,t,r){const i=this._options.textureUsageMask;return Promise.all(t.map((t=>{if(0===(t.usage&i))return null;const s=a.selectEncoding(t.encodings,this._options.textureEncodings);if(null==s)return this._logger.error("#loadTextures",this._logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject();const n=e.resources.texture||e.id,o=`${this._layerUrl}/nodes/${n}/textures/${s.name}`;return this._loadTexture(o,t.id,t.usage,s.encoding,r)})))}_loadFeatureData(e,t){const r=`${this._layerUrl}/nodes/${e}/features/0`;return this._load(r,"json",t)}_loadGeometry(e,t,r){const i=`${this._layerUrl}/nodes/${e}/geometries/${t}`;return this._load(i,"binary",r)}}return l}))},"esri/views/3d/layers/i3s/I3SMaterialUtil":function(){define(["exports","../../../../core/colorUtils","../../../../core/has","../../../../core/mathUtils","../../../../symbols/support/materialUtils","./enums","../../webgl-engine/core/material/RenderTexture","../../webgl-engine/core/shaderLibrary/util/EllipsoidMode","../../webgl-engine/lib/basicInterfaces","../../webgl-engine/lib/Texture","../../webgl-engine/materials/pbrUtils","../../../webgl/enums","../../../../webscene/support/AlphaCutoff"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";function p(e){return e.sort(((e,t)=>e.encoding-t.encoding))}const m={ktx2:n.TextureEncoding.KTX2,basis:n.TextureEncoding.Basis,dds:n.TextureEncoding.DDS_S3TC,png:n.TextureEncoding.PNG,jpg:n.TextureEncoding.JPG,"ktx-etc2":n.TextureEncoding.KTX_ETC2},f={[l.TextureEncodingMimeType.KTX2_ENCODING]:n.TextureEncoding.Basis,[l.TextureEncodingMimeType.BASIS_ENCODING]:n.TextureEncoding.Basis,[l.TextureEncodingMimeType.DDS_ENCODING]:n.TextureEncoding.DDS_S3TC,"image/png":n.TextureEncoding.PNG,"image/jpg":n.TextureEncoding.JPG,"image/jpeg":n.TextureEncoding.JPG,"image/ktx":n.TextureEncoding.KTX_ETC2},g=()=>({alphaMode:"opaque",alphaCutoff:h.alphaCutoff,doubleSided:!0,cullFace:l.CullFaceOptions.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}),y={s:d.TextureWrapMode.CLAMP_TO_EDGE,t:d.TextureWrapMode.CLAMP_TO_EDGE},_={s:d.TextureWrapMode.REPEAT,t:d.TextureWrapMode.REPEAT};e.configureMaterial=function(e,r,i,c,d,p){const m=p.rendererTextureUsage,f=e=>function(e,t,r){if(null==e||r===n.TextureUsage.None)return null;for(let i=0;i<e.length;i++){const s=e[i];if(null!=s&&0!==(s.usage&r)){const e=t[i];return null!=e?e.id:null}}return null}(c,i,e&m),g=t.validateColorAndOpacity(r.metallicRoughness.baseColorFactor);e.baseColor=[g[0],g[1],g[2],g[3]],e.hasParametersFromSource=!!r.hasParametersFromSource,e.usePBR=p.usePBR,e.mrrFactors=[r.metallicRoughness.metallicFactor,r.metallicRoughness.roughnessFactor,r.hasParametersFromSource?u.schematicMRRFactors[2]:u.advancedMRRFactors[2]],e.emissiveBaseColor=r.emissiveFactor,e.emissiveSource=s.EmissiveSourceMode.Emissive,e.isIntegratedMesh=p.isIntegratedMesh,e.textureAlphaCutoff="mask"===r.alphaMode?r.alphaCutoff:h.alphaCutoff,e.alphaDiscardMode="opaque"===r.alphaMode?l.AlphaDiscardMode.Opaque:"mask"===r.alphaMode?l.AlphaDiscardMode.Mask:l.AlphaDiscardMode.MaskBlend;const y=[],_=f(n.TextureUsage.Color|n.TextureUsage.AlphaMask);null!=_&&(e.baseColorTexture=new o.RenderTexture(d,_),y.push(e.baseColorTexture.loadPromise));const b=f(n.TextureUsage.MetallicRoughness);null!=b&&(e.metallicRoughnessTexture=new o.RenderTexture(d,b),y.push(e.metallicRoughnessTexture.loadPromise));const v=f(n.TextureUsage.Emissive);null!=v&&(e.emissionTexture=new o.RenderTexture(d,v),y.push(e.emissionTexture.loadPromise));const S=f(n.TextureUsage.Occlusion);null!=S&&(e.occlusionTexture=new o.RenderTexture(d,S),y.push(e.occlusionTexture.loadPromise));const w=f(n.TextureUsage.Normal);return null!=w&&(e.normalTexture=new o.RenderTexture(d,w),y.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=p.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=r.doubleSided,e.commonMaterialParameters.cullFace=r.cullFace,e.ellipsoidMode=a.getEllipsoidMode(p.viewSpatialReference),Promise.all(y)},e.createTexture=function(e,t,i,s,o,a){if(null==e?.data)return null;const u=e.data,d=s.renderingContext.parameters.maxMaxAnisotropy,h=d>1,p=i||!t.wrapTextures?y:_,m=function(e){switch(e){case n.TextureEncoding.KTX2:return l.TextureEncodingMimeType.KTX2_ENCODING;case n.TextureEncoding.Basis:return l.TextureEncodingMimeType.BASIS_ENCODING;case n.TextureEncoding.DDS_S3TC:return l.TextureEncodingMimeType.DDS_ENCODING;case n.TextureEncoding.PNG:return"image/png";case n.TextureEncoding.JPG:return"image/jpeg";case n.TextureEncoding.KTX_ETC2:return"image/ktx";default:return""}}(e.encoding),f=e.usage&n.TextureUsage.Color?"opaque"===t.alphaMode?3:4:3,g=function(e,t){return!(!r("enable-feature:esri-compress-IM-textures")||0===(e&n.uncompressedFormats)||t&~n.compressibleUsages)}(e.encoding,e.usage)?{compressionTracker:o,compressionCallback:a}:void 0;return new c.Texture(u,{mipmap:h,maxAnisotropy:d,encoding:m,wrap:p,components:f,compressionOptions:g,noUnpackFlip:!0})},e.defaultMaterial=g,e.getMaterialAndTextures=function(e,i,s){const o=new Map,a=(e,t)=>{if(null==e)return-1;const r=o.get(e.id);if(r)return r.usage|=t,r.id;const i=o.size;return o.set(e.id,{id:i,usage:t}),i},c=i.pbrMetallicRoughness,d=c?.baseColorFactor?t.validateColorAndOpacity(c.baseColorFactor):null,h=i.emissiveFactor,f=r("disable-feature:diffuse-rendering-i3s")||s?u.useSchematicPBRI3S({normalTexture:i.normalTexture,emissiveTexture:i.emissiveTexture,emissiveFactor:i.emissiveFactor,occlusionTexture:i.occlusionTexture,metallicRoughnessTexture:c?.metallicRoughnessTexture,metallicFactor:c?.metallicFactor,roughnessFactor:c?.roughnessFactor}):u.useSchematicPBR({normalTexture:i.normalTexture,emissiveTexture:i.emissiveTexture,emissiveFactor:i.emissiveFactor,occlusionTexture:i.occlusionTexture,metallicRoughnessTexture:c?.metallicRoughnessTexture,metallicFactor:c?.metallicFactor,roughnessFactor:c?.roughnessFactor}),g=f?u.schematicMRRFactors[0]:c?.metallicFactor??u.advancedMRRFactors[0],y=f?u.schematicMRRFactors[1]:c?.roughnessFactor??u.advancedMRRFactors[1],_="mask"===i.alphaMode?n.TextureUsage.Color|n.TextureUsage.AlphaMask:n.TextureUsage.Color,b={baseColorFactor:d?[d[0],d[1],d[2],d[3]]:[1,1,1,1],baseColorTextureId:a(c?.baseColorTexture,_),metallicRoughnessTextureId:a(c?.metallicRoughnessTexture,n.TextureUsage.MetallicRoughness),metallicFactor:g,roughnessFactor:y},v={alphaMode:i.alphaMode,alphaCutoff:i.alphaCutoff,doubleSided:i.doubleSided,cullFace:"none"===i.cullFace?l.CullFaceOptions.None:"back"===i.cullFace?l.CullFaceOptions.Back:"front"===i.cullFace?l.CullFaceOptions.Front:l.CullFaceOptions.None,normalTextureId:a(i.normalTexture,n.TextureUsage.Normal),emissiveTextureId:a(i.emissiveTexture,n.TextureUsage.Emissive),occlusionTextureId:a(i.occlusionTexture,n.TextureUsage.Occlusion),emissiveFactor:h?[h[0],h[1],h[2]]:[0,0,0],metallicRoughness:b,wrapTextures:!1,hasParametersFromSource:f},S=[];return o.forEach((({usage:t},r)=>{const i=null!=e&&e[r]&&e[r].formats,s=i?p(i.map((({name:e,format:t})=>({name:e,encoding:m[t]})))):[];S.push({id:r,usage:t,encodings:s})})),{material:v,textures:S}},e.getMaterialAndTexturesFromShared=function(e){const r=e?.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,s=e?.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,o=r?e.materialDefinitions?.[r]:null,a=s?e.textureDefinitions?.[s]:null,c=g();if(null!=o){const e=o.params;e.diffuse&&(t.validateColor(e.diffuse),c.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(c.doubleSided=e.doubleSided,c.cullFace=e.doubleSided?l.CullFaceOptions.None:l.CullFaceOptions.Back),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(c.cullFace="none"===e.cullFace?l.CullFaceOptions.None:"back"===e.cullFace?l.CullFaceOptions.Back:l.CullFaceOptions.Front),e.transparency&&(c.metallicRoughness.baseColorFactor[3]=i.clamp(1-e.transparency,0,1)),(e.useVertexColorAlpha||c.metallicRoughness.baseColorFactor[3]<1)&&(c.alphaMode="blend")}const u=[];if(null!=a){const e=0;!a.wrap||"repeat"!==a.wrap[0]&&"repeat"!==a.wrap[1]||(c.wrapTextures=!0);let t=n.TextureUsage.Color;"rgba"===a.channels&&(c.alphaMode="blend",t|=n.TextureUsage.AlphaMask);const r=a.images.length-1,i=a.images[r],s=e=>e?.split("/").pop(),o=Array.isArray(a.encoding)?p(a.encoding.map(((e,t)=>({name:s(i.href[t]),encoding:f[e]||0})))):[{name:s(i.href),encoding:f[a.encoding]||0}];u.push({id:e,usage:t,encodings:o}),c.metallicRoughness.baseColorTextureId=e}return{material:c,textures:u}},e.getSupportedEncodings=function(e){const t=!!e.compressedTextureS3TC,i=!!e.compressedTextureETC,s=r("disable-feature:i3s-basis")?0:n.TextureEncoding.Basis|n.TextureEncoding.KTX2,o=n.TextureEncoding.JPG|n.TextureEncoding.PNG,a=s|n.TextureEncoding.DDS_S3TC;return o|(t?a:0)|(i?s:0)},e.selectEncoding=function(e,t){if(null!=t)return e.find((e=>0!==(e.encoding&t)))},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/core/material/RenderTexture":function(){define(["exports","../../../../../core/maybe","../../../../../core/promiseUtils"],(function(e,t,r){"use strict";e.RenderTexture=class{constructor(e,i){this._textures=e,this.loadPromise=null,this._disposed=!1;const s=this._textures.acquire(i);r.isPromiseLike(s)?(s.then((e=>{this._disposed?t.releaseMaybe(e):this._textureRef=e})),this.loadPromise=s):this._textureRef=s}dispose(){this._textureRef=t.releaseMaybe(this._textureRef),this._disposed=!0}get glTexture(){return null!=this._textureRef?this._textureRef.glTexture:null}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SStreamDataController":function(){define(["exports","../../../../core/promiseUtils"],(function(e,t){"use strict";e.I3SStreamDataController=class{constructor(e,t,r){this._requester=e,this._customParameters=t,this._apiKey=r,this._activeRequests=new Set}get busy(){return this._requester.busy}request(e,r,i){const s=new AbortController,n=t.onAbortOrThrow(i,(()=>s.abort())),o={signal:s.signal,query:{...this._customParameters,token:this._apiKey}},a=this._requester.request(e,r,o),l={response:a,abortController:s,abortHandle:n};return this._activeRequests.add(l),t.always(a,(()=>{l.abortController=null,l.abortHandle?.remove(),l.abortHandle=null,this._activeRequests.delete(l)})),a}cancelAll(){this._activeRequests.forEach((e=>{e.abortController?.abort(),e.abortController=null,e.abortHandle?.remove()})),this._activeRequests.clear()}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SViewportQueries":function(){define(["../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../chunks/vec42","../../../../core/libs/gl-matrix-2/factories/vec4f64","../../../../geometry/ellipsoidUtils","../../../../geometry/spatialReferenceEllipsoidUtils","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/projection/projectors","../../../../geometry/support/frustum","../../../../geometry/support/plane","../../../../geometry/support/spatialReferenceUtils","../../../../chunks/sphere","../../../../layers/graphics/dehydratedPoint","../../../ViewingMode","../graphics/elevationAlignmentUtils","../graphics/ElevationContext","../graphics/featureExpressionInfoUtils","./I3SNode","./I3SUtil","../../support/orientedBoundingBox"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";const v=1e5,S=t.create(),w=l.createPoints(),x=t.create(),T=t.create(),C=t.create(),P=t.create(),M=t.create(),R=new b.Obb,E=t.create(),O=[t.create(),t.create(),t.create(),t.create(),t.create(),t.create(),t.create(),t.create()],A=t.create(),I=t.create(),D=t.create(),F=t.create();return class{get _frustumMbsCenter(){return this._frustumMbs}get _frustumMbsRadius(){return this._frustumMbs[3]}get _frustumPlanes(){return this._frustum}constructor(e,r,o,c,d,p,m,f,g={}){this._indexSR=e,this._renderCoordsHelper=r,this._clippingArea=d,this._elevationProvider=p,this._viewingMode=m,this._options=g,this._frustum=l.create(),this._frustumMbs=i.create(),this._useFrustumCulling=!1,this._poi=t.create(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=new b.Obb,this._tmp1=t.create(),this._tmp2=t.create(),this._tmp3=t.create(),this._tmp0=t.create(),this._screenspaceErrorBias=g.screenspaceErrorBias||1,this._progressiveLoadFactor=g.progressiveLoadFactor||1,this.updateCamera(o,c);const y=this._renderCoordsHelper.spatialReference;this._renderSR=y,this._renderSRSphericalPCPF=n.getSphericalPCPF(y),this._isGlobalMode=y===this._renderSRSphericalPCPF,this.updateElevationInfo(f),this._tmpPoint=h.makeDehydratedPoint(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(y.isWebMercator||u.isPlateCarree(y)),this._indexSREllipsoidRadius=s.getReferenceEllipsoid(this._indexSR).radius,this._indexSRSphericalPCPF=n.getSphericalPCPF(e),this._projectorIndexSRToIndexSRSphericalPCPF=a.getProjector(this._indexSR,this._indexSRSphericalPCPF)}updateElevationInfo(e){null!=e?(this._elevationContext=f.ElevationContext.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(g.createContextWithoutExpressionSupport(g.extractExpressionInfo(e,!1)))):this._elevationContext=null}updateCamera(t,r){if(this._useFrustumCulling=r,r){l.fromMatrix(t.viewMatrix,t.projectionMatrix,this._frustum,w);{const r=t.eye,i=S;e.normalize(i,t.viewForward);const s=w,n=x;e.sub(n,s[4],r);const o=.5*e.dot(n,n)/e.dot(i,n),a=this._frustumMbs,l=a;e.scaleAndAdd(l,r,i,o);const c=1+o;a[3]=c}}this._screenSizeFactor=1/(t.perScreenPixelRatio/2),this._camPos=t.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this._clippingArea=e}expandElevationRange(e,t,r){if(null==this._elevationContext)return;const i=e.serviceMbsInIndexSR;if(!i)return;const s="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds){const e=this._elevationProvider.getSphereElevationBounds(i,this._indexSR,s);return void(e&&r.expandElevationRange(e))}const n=i[0],o=i[1],a=i[2],l=this._elevationProvider.getElevation(n,o,a,this._indexSR,s);l&&r.expandElevationRangeValues(l,l);const c=t?null:this._elevationProvider.getRootElevationBounds?.();c&&r.expandElevationRange(c)}getServiceMbsInRenderSR(e){const t=e.serviceMbsInRenderSR;if(_.isValidMbs(t))return t;e.serviceMbsInIndexSR&&r.copy(t,e.serviceMbsInIndexSR);const i=e.elevationRangeMin;if(this._elevationContext&&Number.isFinite(i)){let r=0,s=0;const n=e.elevationRangeMax;switch(this._elevationContext.mode){case"relative-to-ground":case"relative-to-scene":r=this._elevationContext.geometryZWithOffset(t[2],this._renderCoordsHelper)+i-t[2],s=n-i;break;case"on-the-ground":r=i-t[2],s=n-i}t[2]+=r+.5*s,t[3]+=.5*s}else this._elevationContext&&t[3]<v&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=m.evaluateElevationAlignmentAtPoint(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));return o.projectBoundingSphere(t,this._indexSR,t,this._renderSR),t}getAndUpdateVisibilityObbInRenderSR(e){{const t=e.visibilityObbInRenderSR;if(t)return t}const t=.01*this._indexSREllipsoidRadius,{serviceMbsInIndexSR:r,serviceObbInIndexSR:i}=e;if(null==i||!r||!i.isValid||this._isECEFOBBInLocalMode&&(i.halfSizeX>t||i.halfSizeY>t||i.halfSizeZ>t))return null;{let t=e.serviceObbInRenderSR;if(null==t)t=new b.Obb,e.serviceObbInRenderSR=t;else if(t.isValid)return t;const s=r[3];let n=0,o=0;const a=i.centerZ,l=this._renderCoordsHelper,c=this._elevationContext;if(c&&e.elevationRangeValid){const t=e.elevationRangeMin,r=e.elevationRangeMax;switch(c.mode){case"relative-to-ground":case"relative-to-scene":n=c.geometryZWithOffset(a,l)+t-a,o=r-t;break;case"on-the-ground":n=t-a,o=r-t}}else if(c&&s<v){const e=this._tmpPoint;e.x=i.centerX,e.y=i.centerY,e.z=a,n=m.evaluateElevationAlignmentAtPoint(e,this._elevationProvider,c,l)-a}const u=o>0,d=u?this._tmpObb:t;return i.transform(d,this._indexSR,this._renderSR,n,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),u&&b.computeOffsetObb(d,0,o,this._viewingMode,t),t}}getNodeObbInRenderSRIndependentOfElevationOffset(e){{const t=e.visibilityObbInRenderSR??e.serviceObbInRenderSR??null;if(t?.isValid)return t}const t=e.serviceObbInIndexSR;return t?(t.transform(R,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),R):null}ensureElevationAgnosticBoundingVolume(e){return-1===e.elevationAgnosticBoundingVolume[3]&&e.level>0&&(this._viewingMode===p.ViewingMode.Global?this._updateElevationAgnosticBoundingVolumeGlobal(e):this._updateElevationAgnosticBoundingVolumeLocal(e)),e.elevationAgnosticBoundingVolume}_updateElevationAgnosticBoundingVolumeGlobal(t){const i=this.getNodeObbInRenderSRIndependentOfElevationOffset(t),s=t.elevationAgnosticBoundingVolume;let n,o=-1;if(i){const t=E;i.getCenter(t),e.normalize(t,t),n=t,i.getCorners(O);for(const r of O){e.normalize(r,r);const i=e.dot(r,t);if(i<=0)return void(s[3]=-1);const n=Math.sqrt(1-i*i);o=Math.max(o,n)}}else{const r=t.serviceMbsInRenderSR;if(!_.isValidMbs(r))return void(s[3]=-1);{const t=e.copy(E,d.getCenter(r)),i=r[3],a=e.len(t);if(a<i)return void(s[3]=-1);o=i/a,e.normalize(t,t),n=t}}r.copyVec3(s,n),s[3]=o+.001}_updateElevationAgnosticBoundingVolumeLocal(t){const i=t.elevationAgnosticBoundingVolume,s=this.getNodeObbInRenderSRIndependentOfElevationOffset(t);if(s){const t=s.getCenter(E);t[2]=0,r.copyVec3(i,t);let n=0;const o=A;s.getCorners(O);for(const t of O){t[2]=0;const r=e.sqrDist(o,t);n=Math.max(n,r)}i[3]=Math.sqrt(n)}else{const s=t.serviceMbsInRenderSR;if(_.isValidMbs(s)){const t=e.copy(E,d.getCenter(s));t[2]=0,r.copyVec3(i,t),i[3]=s[3]}}}isNodeVisible(e){const t=this.getServiceMbsInRenderSR(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;const r=this.getAndUpdateVisibilityObbInRenderSR(e);return r?r.doesIntersectFrustumConservativeApproximation(this._frustum):l.intersectsSphere(this._frustum,d.wrap(t))}isElevationAgnosticBoundingVolumeVisible(e){return!this._useFrustumCulling||-1===e[3]||(this._viewingMode===p.ViewingMode.Global?this._isConeVisibleInFrustum(e):this._isCylinderVisibleInFrustum(e))}_isConeVisibleInFrustum(t){if(!this._isConeVisibleInFrustumMbs(t))return!1;const r=t[3];if(-1===r||r>.9)return!0;const i=this._frustumPlanes,s=this._frustumMbsCenter,n=t,o=e.dot(n,s),a=this._frustumMbsRadius,l=o-a,u=o+a;if(l<=0)return!0;const d=e.scale(C,n,l),h=e.scale(P,n,u),p=r/Math.sqrt(1-r*r);for(const t of i){const r=c.getNormal(t),i=e.normalize(M,r),s=e.dot(i,n);if(Math.abs(1-s)<.01)continue;const o=I;e.scale(o,n,s),e.sub(o,o,i),e.normalize(o,o);const a=D;if(e.scaleAndAdd(a,d,o,l*p),!(c.signedDistance(t,a)<=0||(e.scaleAndAdd(a,h,o,u*p),c.signedDistance(t,a)<=0)))return!1}return!0}_isConeVisibleInFrustumMbs(t){const r=t[3];if(r>.9)return!0;const i=this._frustumMbsRadius,s=this._frustumMbsCenter,n=e.len(s);if(n<=i)return!0;const o=t,a=e.dot(o,s);{const t=e.scale(T,o,a);if(e.dist(t,s)<i)return!0}const l=a/n;if(a<=0)return-l<i;const c=Math.sqrt(1-l*l);if(c<r)return!0;const u=i/n;return c*Math.sqrt(1-u*u)-u*l<r}isObbVisibleIndependentOfElevation(t,r){if(!this._useFrustumCulling)return!0;if(-1===t[3])return!0;const i=this._frustumMbsRadius,s=this._frustumMbsCenter,n=this._frustumPlanes,o=O;if(r.getCorners(o),this._viewingMode===p.ViewingMode.Global){const r=t,a=e.dot(r,s),l=a-i,u=a+i;if(l<=0)return!0;for(const t of n){let i=!0;for(const s of o){const n=e.dot(s,r),o=F;if(e.scale(o,s,l/n),c.signedDistance(t,o)<=0){i=!1;break}const a=F;if(e.scale(a,s,u/n),c.signedDistance(t,a)<=0){i=!1;break}}if(i)return!1}}else{const e=s[2]-i,t=s[2]+i;for(const r of n){let i=!0;const s=c.getNormal(r),n=s[0],a=s[1],l=s[2],u=r[3];for(const r of o){const s=n*r[0]+a*r[1]+u;if(s+l*e<=0||s+l*t<=0){i=!1;break}}if(i)return!1}}return!0}_isCylinderVisibleInFrustum(t){const r=this._frustumMbsCenter,i=this._frustumMbsRadius,s=e.copy(T,r);s[2]=0;const n=t[3],o=t;return e.dist(s,o)<=n+i}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const t=e.geometryObbInRenderSR;return t?.doesIntersectFrustumConservativeApproximation(this._frustum)??this.isNodeVisible(e)}_isMBSinClippingArea(e){return null==this._clippingArea||_.intersectBoundingRectWithMbs(this._clippingArea,e)!==_.MbsIntersectResult.OUTSIDE}_screenSpaceDiameterMbs(t,r){const i=this.getServiceMbsInRenderSR(t),s=Math.sqrt(e.squaredDistance(d.getCenter(i),this._camPos)),n=s-i[3];return this._updateMinMaxDistance(s),n<0?.5*Number.MAX_VALUE:r/n*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getServiceMbsInRenderSR(e)[3]}calcCameraDistanceToCenter(t){const r=this.getServiceMbsInRenderSR(t),i=e.distance(d.getCenter(r),this._camPos);return this._updateMinMaxDistance(i),i}calcAngleDependentLoD(t){const r=this.getServiceMbsInRenderSR(t),i=r[3],s=(Math.abs(r[0]*(r[0]-this._camPos[0])+r[1]*(r[1]-this._camPos[1])+r[2]*(r[2]-this._camPos[2]))/e.length(d.getCenter(r))+i)/e.distance(d.getCenter(r),this._camPos);return Math.min(1,s)}hasLOD(e){return e.lodMetric!==y.LodMetric.None}_getDistanceGlobeMode(t,r){const i=e.length(d.getCenter(r)),s=e.length(t)-i;e.scale(this._tmp0,t,e.dot(t,d.getCenter(r))/e.squaredLength(t));const n=e.squaredDistance(d.getCenter(r),this._tmp0),o=r[3];if(n<=o*o)return Math.abs(s);{const n=e.scale(this._tmp0,d.getCenter(r),1/i),a=i,l=o*o/2/a,c=e.scale(this._tmp1,n,a-l),u=t,h=e.subtract(this._tmp2,u,c),p=e.subtract(this._tmp2,h,e.scale(this._tmp3,n,e.dot(n,h))),m=e.add(this._tmp2,c,e.scale(this._tmp2,p,o/e.length(p)));let f=e.distance(u,m);if(s>=2e5){const t=e.subtract(this._tmp1,u,m);let r=e.dot(t,n)/e.length(t);r<.08&&(r=1e-4),f/=r}return f}}_getDistance(e,t){return this._isGlobalMode?this._getDistanceGlobeMode(e,t):function(e,t){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],n=r*r+i*i,o=t[3];if(n<=o*o)return Math.abs(s);const a=Math.sqrt(n)-o;return Math.sqrt(s*s+a*a)}(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(e.lodMetric===y.LodMetric.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const t=this._progressiveLoadFactor*this._screenspaceErrorBias,r=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,r)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case y.LodMetric.ScreenSpaceRelative:{const r=this.getServiceMbsInRenderSR(e),i=this._getDistance(this._camPos,r),s=2*i/this._screenSizeFactor,n=i+r[3];return this._updateMinMaxDistance(n),e.maxError*t<=s}case y.LodMetric.MaxScreenThreshold:{let r=this._screenSpaceDiameterMbs(e,e.serviceMbsInIndexSR[3]*t);return this._options.angleDependentLoD&&(r*=this.calcAngleDependentLoD(e)),r<e.maxError}case y.LodMetric.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case y.LodMetric.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(t){const r=this.getServiceMbsInRenderSR(t);return e.distance(d.getCenter(r),this._poi)-r[3]}distCameraToPOI(){return e.distance(this._camPos,this._poi)}}}))},"esri/layers/support/SceneModification":function(){define(["exports","../../chunks/tslib.es6","../../core/JSONSupport","../../core/lang","../../core/Warning","../../core/accessorSupport/decorators/property","../../core/has","../../core/Logger","../../core/accessorSupport/decorators/subclass","../../core/accessorSupport/decorators/writer","../../core/accessorSupport/decorators/persistable","../../geometry/Polygon","../../geometry/projectionUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h){"use strict";var p;return e.default=p=class extends r{constructor(e){super(e),this.geometry=null,this.type="clip"}writeGeometry(e,t,r,i){if(i.layer?.spatialReference&&!i.layer.spatialReference.equals(this.geometry.spatialReference)){if(!h.canProjectWithoutEngine(e.spatialReference,i.layer.spatialReference))return void(i?.messages&&i.messages.push(new s("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:i.layer.spatialReference,context:i})));const n=new d;h.projectPolygon(e,n,i.layer.spatialReference),t[r]=n.toJSON(i)}else t[r]=e.toJSON(i);delete t[r].spatialReference}clone(){return new p({geometry:i.clone(this.geometry),type:this.type})}},t.__decorate([n.property({type:d}),u.persistable()],e.default.prototype,"geometry",void 0),t.__decorate([c.writer(["web-scene","portal-item"],"geometry")],e.default.prototype,"writeGeometry",null),t.__decorate([n.property({type:["clip","mask","replace"],nonNullable:!0}),u.persistable()],e.default.prototype,"type",void 0),e.default=p=t.__decorate([l.subclass("esri.layers.support.SceneModification")],e.default),e.default}))},"esri/views/3d/layers/ContentGeometryLayerView":function(){define(["exports"],(function(e){"use strict";e.ContentGeometryUpdateEvent=class{constructor(e){this.renderBounds=e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/I3SMeshViewLabeler":function(){define(["exports","../../../chunks/tslib.es6","../../../core/Accessor","../../../core/arrayUtils","../../../core/has","../../../core/lang","../../../core/mathUtils","../../../core/maybe","../../../core/reactiveUtils","../../../core/uid","../../../core/accessorSupport/decorators/property","../../../core/Logger","../../../core/accessorSupport/decorators/subclass","../../../core/accessorSupport/diffUtils","../../../geometry/projection/projectBuffer","../../../geometry/support/aaBoundingBox","../../../geometry/support/DoubleArray","../../../layers/graphics/dehydratedPoint","../../../renderers/support/RenderingInfo","../../../symbols/PointSymbol3D","./graphics/Graphics3DCore","./graphics/Graphics3DScaleVisibility","./i3s/I3SGeometryUtil","../support/LimitGraphicsMap","../webgl-engine/lib/UpdatePolicy","../../support/layerViewUtils"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C){"use strict";class P{constructor(e,t){this.meta=e,this.index=t}}class M{constructor(e,t){this.graphic=e,this.geometry=t,this.components=[],this.overridesDirty=!1}}e.default=class extends r{get updating(){return this._graphicsCore?.updating??!1}constructor(e){super(e),this.loadedGraphics=new x.LimitGraphicsMap(5e4),this.slicePlaneEnabled=!1,this._renderingInfo=new _.RenderingInfo(null,new b),this._featuresMap=new Map}initialize(){const e=this.view.basemapTerrain;this._graphicsCore=new v.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:T.UpdatePolicy.ASYNC,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:e=>this.view.deconflictor.addGraphicsOwner(e),labeler:(e,t)=>this.view.labeler.addGraphicsOwner(e,t,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:C.hasLayerBasedScaleVisibility()?null:(t,r)=>new S.Graphics3DScaleVisibility({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:r,graphicsCore:t,basemapTerrain:e,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then((()=>this._graphicsCore.startCreateGraphics())).catch((()=>{})),this.addHandles(l.watch((()=>this.layer.labelingInfo),((e,t)=>{p.diff(e,t)&&this._graphicsCore.updateLabelingInfo()})))}destroy(){this._graphicsCore=a.destroyMaybe(this._graphicsCore),this.loadedGraphics=a.destroyMaybe(this.loadedGraphics),this.view=null}addNodeMeta(e,t){let r=0;const i=e.filteredIds,s=this.view.spatialReference,n=[];for(let o=0;o<e.featureIds.length;o++){const a=e.featureIds[o];let l=null==i;if(i&&r<i.length&&a===i[r]&&(l=!0,r++),!this._enabledForFeatureInNode(e,o))continue;const u=this._featuresMap.get(a);if(u){u.components.push(new P(e,o)),this._updateLabelPosition(a);continue}const d=t(o,e),h=y.makeDehydratedPoint(0,0,0,s),p={objectId:a,uid:c.generateUID(),attributes:d,visible:l,geometry:h},m=new M(p,h);m.components.push(new P(e,o)),this._featuresMap.set(a,m),this._updateLabelGeometry(a),n.push(p)}this.loadedGraphics.addMany(n)}updateLabelPositions(e){const t=this.view.renderCoordsHelper;this._forEachGraphic(e,((r,i,s)=>{const n=this._graphicsCore.getGraphics3DGraphicById(i.uid);null!=n&&this._updateLabelGeometry(e.featureIds[r])&&n.alignWithAbsoluteElevation(s.z??0,t,!1)}))}setNodeMetaAttributes(e,t){const r=new Array;this._forEachGraphic(e,((i,s)=>{const o=t(i,e);n.equalsShallow(s.attributes,o)||(s.attributes=o,r.push(s.uid))})),this._graphicsCore.updateLabelingInfo(r)}applyFilterChange(e){this._forEachFeature(e,((t,r,i)=>{if(!this._enabledForFeatureInNode(e,t)){const i=e.featureIds[t];switch(this._removeFeature(r,e,t)){case E.REMOVED:this.loadedGraphics.removeManyByObjectId([i]);break;case E.MODIFIED:this._updateLabelPosition(i)}return}const s=r.graphic,n=s.visible;n!==i&&(s.visible=i,R.graphic=s,R.property="visible",R.oldValue=n,R.newValue=i,this._graphicsCore.graphicUpdateHandler(R))}))}removeNodeMeta(e){const t=[];this._forEachGraphic(e,(r=>{const i=e.featureIds[r],s=this._featuresMap.get(i);if(s)switch(this._removeFeature(s,e,r)){case E.MODIFIED:this._updateLabelPosition(i);break;case E.REMOVED:t.push(i)}})),this.loadedGraphics.removeManyByObjectId(t)}_removeFeature(e,t,r){const s=e.components.length;return i.filterInPlace(e.components,(e=>!(e.meta===t&&e.index===r))),0===e.components.length?(this._featuresMap.delete(t.featureIds[r]),E.REMOVED):s!==e.components.length?E.MODIFIED:E.UNMODIFIED}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}_updateLabelPosition(e){const t=this._featuresMap.get(e);t&&this._updateLabelGeometry(e)&&(this.loadedGraphics.removeManyByObjectId([e]),this.loadedGraphics.addMany([t.graphic]))}_updateLabelGeometry(e){const t=this._featuresMap.get(e);if(!t)return!1;const r=t.geometry,i=this.view.spatialReference,s=this.view.renderCoordsHelper,n=r.x,a=r.y,l=r.z??0,c=t.components.length,u=g.newDoubleArray(c*w.boundingBoxCornersPointsStride);let d=0;for(const{meta:e,index:r}of t.components)w.boundingBoxCornerPoints(r,this.collection,e.objectHandle,u,d),d+=w.boundingBoxCornersPointsStride;return m.projectBuffer(u,s.spatialReference,0,u,i,0),f.fromBuffer(u,O),r.x=(O[0]+O[3])/2,r.y=(O[1]+O[4])/2,r.z=O[5],!o.floatEqualUlp(r.x,n)||!o.floatEqualUlp(r.y,a)||!o.floatEqualUlp(r.z,l)}_forEachGraphic(e,t){this._forEachFeature(e,((r,{graphic:i,geometry:s},n)=>{this._enabledForFeatureInNode(e,r)&&t(r,i,s,n)}))}_forEachFeature(e,t){let r=0;for(let i=0;i<e.featureIds.length;i++){const s=this._featuresMap.get(e.featureIds[i]);let n=null==e.filteredIds;e.filteredIds&&e.filteredIds[r]===e.featureIds[i]&&(n=!0,r++),s&&t(i,s,n)}}_enabledForFeatureInNode(e,t){return e.node.index<0||!this.overrides?.featureHasGeometryChanges(e.featureIds[t])}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){}},t.__decorate([u.property()],e.default.prototype,"view",void 0),t.__decorate([u.property()],e.default.prototype,"layer",void 0),t.__decorate([u.property()],e.default.prototype,"collection",void 0),t.__decorate([u.property()],e.default.prototype,"loadedGraphics",void 0),t.__decorate([u.property()],e.default.prototype,"overrides",void 0),t.__decorate([u.property()],e.default.prototype,"layerViewUid",void 0),t.__decorate([u.property()],e.default.prototype,"updating",null),t.__decorate([u.property()],e.default.prototype,"slicePlaneEnabled",void 0),t.__decorate([u.property()],e.default.prototype,"_graphicsCore",void 0),e.default=t.__decorate([h.subclass("esri.views.3d.layers.I3SMeshViewLabeler")],e.default);const R={graphic:null,property:null,oldValue:null,newValue:null};var E;!function(e){e[e.UNMODIFIED=0]="UNMODIFIED",e[e.MODIFIED=1]="MODIFIED",e[e.REMOVED=2]="REMOVED"}(E||(E={}));const O=f.create();return e.default}))},"esri/views/3d/layers/i3s/I3SGeometryUtil":function(){define(["exports","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectBuffer","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/DoubleArray"],(function(e,t,r,i,s,n){"use strict";function o(e,r,i,s,n){const o=r.getComponentAabb(i,e,a),c=r.getObjectTransform(i);for(let e=0;e<8;++e)l[0]=1&e?o[0]:o[3],l[1]=2&e?o[1]:o[4],l[2]=4&e?o[2]:o[5],t.transformMat3(l,l,c.rotationScale),t.add(l,l,c.position),s[n++]=l[0],s[n++]=l[1],s[n++]=l[2];return s}const a=s.create(),l=r.create();e.boundingBoxCornerPoints=o,e.boundingBoxCornersPointsStride=24,e.createGetFeatureExtent=function(e,t,r){const a=n.newDoubleArray(24);return n=>{const l=n.meta.featureExtents,c=new Float64Array(l.buffer,6*n.index*Float64Array.BYTES_PER_ELEMENT,6);return c[0]===Number.POSITIVE_INFINITY&&(o(n.index,r,n.meta.objectHandle,a,0),i.projectBuffer(a,t,0,a,e,0)?s.fromBuffer(a,c):s.set(c,s.zero)),c}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/LimitGraphicsMap":function(){define(["exports","../../../core/Evented","../../../core/MapUtils","./GraphicsMap"],(function(e,t,r,i){"use strict";const s=new class{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(e){this._percentage=e,this._last=-1}sample(){const e=Math.floor(this._index*this._percentage);return++this._index,e!==this._last&&(this._last=e,!0)}};class n{constructor(e){this._parent=e,this._map=new Map}get length(){return this._map.size}forEach(e){this._map.forEach((t=>e(t)))}find(e){return r.findInMap(this._map,e)}some(e){return r.someMap(this._map,e)}toArray(){return Array.from(this._map.values())}addAndRemove(e,t){for(const t of e)this._map.set(t.objectId,t);for(const e of t)this._map.delete(e.objectId);(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})}removeMany(e){for(const t of e)this._map.delete(t.objectId);e.length>0&&this._parent.emit("change",{added:[],removed:e})}}e.LimitGraphicsMap=class extends t{constructor(e){super(),this._limit=e,this._all=new i.GraphicsMap,this._active=new n(this),this._pending=new Map,this._handle=this._all.on("change",(e=>this._handleChanges(e)))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(e){return this._active.find(e)}some(e){return this._active.some(e)}forEach(e){this._active.forEach(e)}addMany(e){this._all.addMany(e)}removeManyByObjectId(e){this._all.removeManyByObjectId(e)}_handleChanges(e){let t=e.removed;if(this._pending.size>0){t=new Array;for(const r of e.removed)this._pending.delete(r.objectId)||t.push(r)}let r=this._limit-this._active.length+t.length;r<e.added.length&&(this._active.removeMany(t),t=[],s.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach((e=>{s.sample()&&(t.push(e),this._pending.set(e.objectId,e))})),r=this._limit-this._active.length+t.length);let i=e.added;if(r<e.added.length){i=new Array,s.reset(r/e.added.length);for(const t of e.added)s.sample()?i.push(t):this._pending.set(t.objectId,t)}const n=r-i.length;n>0&&this._pending.size>0&&(s.reset(n/this._pending.size),this._pending.forEach((e=>{s.sample()&&(i.push(e),this._pending.delete(e.objectId))}))),this._active.addAndRemove(i,t)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/support/GraphicsMap":function(){define(["exports","../../../core/Evented","../../../core/MapUtils"],(function(e,t,r){"use strict";e.GraphicsMap=class extends t{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}get length(){return this._map.size}get(e){return this._map.get(e)}addMany(e){if(0===e.length)return;const t=new Set;for(let r=0;r<e.length;r++){const i=e[r],s=i.objectId,n=this._map.get(s);n?(t.add(s),i!==n&&(e[r]=n),n.refCount||(n.refCount=0),++n.refCount):(i.refCount=1,this._map.set(s,i))}const r=t.size>0?e.filter((e=>!t.has(e.objectId))):e;r.length>0&&this.emit("change",{added:r,removed:[]})}removeMany(e){const t=[];for(const r of e){const e=r.objectId,i=this._map.get(e);null!=i&&(!i.refCount||--i.refCount<=0)&&(this._map.delete(e),t.push(r))}t.length>0&&this.emit("change",{added:[],removed:t})}removeManyByObjectId(e){const t=[];for(const r of e){const e=this._map.get(r);null!=e&&(!e.refCount||--e.refCount<=0)&&(this._map.delete(r),t.push(e))}t.length>0&&this.emit("change",{added:[],removed:t})}toArray(){return[...this._map.values()]}find(e){return r.findInMap(this._map,e)}some(e){return r.someMap(this._map,e)}forEach(e){this._map.forEach((t=>e(t)))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/I3SMeshViewPerformanceInfo":function(){define(["exports","./support/LayerViewPerformanceInfo"],(function(e,t){"use strict";class r extends t.LayerViewPerformanceInfo{constructor(e,t,r,i,s,n,o){super(e,0,0,0,t),this.gpuMB=r,this.geometryMB=i,this.textureMB=s,this.unloadedMB=n,this.idbHitRate=o}}e.I3SMeshViewPerformanceInfo=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/I3SMeshWorkerHandle":function(){define(["exports","../../../core/Logger","../../../core/PooledArray","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../core/workers/WorkerHandle","../../../geometry/projectionUtils","../../../geometry/projection/projectVectorToVector","../../../libs/i3s/enums"],(function(e,t,r,i,s,n,o,a){"use strict";class l extends s.WorkerHandle{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,t,r,i){const s={context:e,modifications:d(t,r,i),isGeodetic:i.isGeographic};this.broadcast(s,"setModifications")}setLegacySchema(e,t){const r=JSON.stringify(t);return this.broadcast({context:e,jsonSchema:r},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}project(e,t){return this.invokeMethod("project",e,t)}transformNormals(e,t){return this.invokeMethod("transformNormals",e,t)}}const c=new r({deallocator:null}),u=i.create();function d(e,r,i){c.clear();let s=1/0,l=1/0,d=-1/0,h=-1/0,p=!1;for(const e of r){const r="clip"===e.type?a.ModificationType.Inside:"mask"===e.type?a.ModificationType.Outside:a.ModificationType.Replace,m=e.geometry;let f=e=>e;if(m.spatialReference){if(!n.canProjectWithoutEngine(m.spatialReference,i)){t.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}f=e=>(o.projectVectorToVector(e,m.spatialReference,u,i),u)}else m.hasZ||(u[2]=0,f=e=>(u[0]=e[0],u[1]=e[1],u));p=p||r===a.ModificationType.Outside,c.push(r),c.push(m.rings.length);for(const e of m.rings){c.push(e.length);for(const t of e){const e=f(t);c.push(e[0]),c.push(e[1]),c.push(e[2]),s=Math.min(s,e[0]),l=Math.min(l,e[1]),d=Math.max(d,e[0]),h=Math.max(h,e[1])}}}if(null!=e)if(p){const t=1e-4;c.push(a.ModificationType.Inside),c.push(2),c.push(4),c.push(s-t),c.push(l-t),c.push(0),c.push(d+t),c.push(l-t),c.push(0),c.push(d+t),c.push(h+t),c.push(0),c.push(s-t),c.push(h+t),c.push(0),c.push(4),c.push(e[0]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[3]),c.push(0),c.push(e[0]),c.push(e[3]),c.push(0)}else c.push(a.ModificationType.Outside),c.push(1),c.push(4),c.push(e[0]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[1]),c.push(0),c.push(e[2]),c.push(e[3]),c.push(0),c.push(e[0]),c.push(e[3]),c.push(0);c.push(a.ModificationType.Finished);const m=new Float64Array(c.length);for(let e=0;e<c.length;++e)m[e]=c.at(e);return m}e.I3SMeshWorkerHandle=l,e.TransformedData=class{constructor(e,t,r,i,s,n,o){this.componentOffsets=e,this.featureIds=t,this.anchorIds=r,this.anchors=i,this.transformedGeometry=s,this.globalTrafo=n,this.obb=o}},e.TransformedGeometry=class{constructor(e,t,r,i,s,n){this.layout=e,this.interleavedVertexData=t,this.indices=r,this.hasColors=i,this.hasModifications=s,this.positionData=n}},e.toWasmModification=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/libs/i3s/enums":function(){define(["exports"],(function(e){"use strict";var t,r;e.IndexType=void 0,(t=e.IndexType||(e.IndexType={}))[t.None=0]="None",t[t.Int16=1]="Int16",t[t.Int32=2]="Int32",e.ModificationType=void 0,(r=e.ModificationType||(e.ModificationType={}))[r.Replace=0]="Replace",r[r.Outside=1]="Outside",r[r.Inside=2]="Inside",r[r.Finished=3]="Finished",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/SceneLayerWorker":function(){define(["require","exports","../../../core/mathUtils","../../../geometry/SpatialReference","../../../geometry/support/MeshGeoreferencedVertexSpace","../../../geometry/support/MeshLocalVertexSpace","../../../chunks/vec3","../../../libs/i3s/enums","../../../libs/i3s/I3SModule","./I3SMeshWorkerHandle","./i3s/I3SNode"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";let d,h;function p(e){if(!h)return;const t=e.modifications,r=h._malloc(8*t.length),i=new Float64Array(h.HEAPU8.buffer,r,t.length);for(let e=0;e<t.length;++e)i[e]=t[e];h.setModifications(e.context,r,t.length,e.isGeodetic),h._free(r)}function m(e,t,r){const{context:i,globalTrafo:s,mbs:n,obbData:o,elevationOffset:l,geometryBuffer:u,geometryDescriptor:d,indexToVertexProjector:h,vertexToRenderProjector:p}=t,m=e._malloc(u.byteLength),f=e._malloc(33*Float64Array.BYTES_PER_ELEMENT),g=new Uint8Array(e.HEAPU8.buffer,m,u.byteLength);g.set(new Uint8Array(u));const _=new Float64Array(e.HEAPU8.buffer,f,33);y(_,[NaN,NaN,NaN]);let b=_.byteOffset+3*_.BYTES_PER_ELEMENT,v=new Float64Array(_.buffer,b);y(v,s),b+=16*_.BYTES_PER_ELEMENT,v=new Float64Array(_.buffer,b),y(v,n),b+=4*_.BYTES_PER_ELEMENT,o&&(v=new Float64Array(_.buffer,b),y(v,o));const S=d,w={isDraco:!1,isLegacy:!1,color:t.layouts.some((e=>e.some((e=>"color"===e.name)))),normal:t.needNormals&&t.layouts.some((e=>e.some((e=>"normalCompressed"===e.name)))),uv0:t.layouts.some((e=>e.some((e=>"uv0"===e.name)))),uvRegion:t.layouts.some((e=>e.some((e=>"uvRegion"===e.name)))),featureIndex:S.featureIndex},x=e.process(i,!!t.obbData,m,g.byteLength,S,w,f,l,h,p,t.normalReferenceFrame);if(e._free(f),e._free(m),x.error.length>0)throw new Error(`i3s.wasm: ${x.error}`);if(x.discarded)return null;const T=x.componentOffsets.length>0?x.componentOffsets.slice():null,C=x.featureIds.length>0?x.featureIds.slice():null,P=x.anchorIds.length>0?Array.from(x.anchorIds):null,M=x.anchors.length>0?Array.from(x.anchors):null,R=x.interleavedVertedData.slice().buffer,E=x.indicesType===a.IndexType.Int16?new Uint16Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/2).slice():new Uint32Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/4).slice(),O=x.positions.slice(),{buffer:A,byteOffset:I,byteLength:D}=x.positionIndices,F=x.positionIndicesType===a.IndexType.Int16?new Uint16Array(A,I,D/2).slice():new Uint32Array(A,I,D/4).slice(),L=new c.TransformedGeometry(t.layouts[0],R,E,x.hasColors,x.hasModifications,{data:O,indices:F});return C&&r.push(C.buffer),T&&r.push(T.buffer),r.push(R),r.push(E.buffer),r.push(O.buffer),r.push(F.buffer),new c.TransformedData(T,C,P,M,L,s,x.obb)}function f(e){if(!h)return;const{context:t,buffer:r}=e,i=h._malloc(r.byteLength),s=r.byteLength/Float64Array.BYTES_PER_ELEMENT,n=new Float64Array(h.HEAPU8.buffer,i,s),o=new Float64Array(r);n.set(o),h.filterOBBs(t,i,s),o.set(n),h._free(i)}function g(e){h&&0===h.destroy(e)&&(h=null)}function y(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function _(){return h||(h=await(d??=l.get())),h}const b={transform:(e,t)=>h&&m(h,e,t),destroy:g};t.destroyContext=function(e){g(e)},t.dracoDecompressPointCloudData=async function(e){h=await _();const t=[e.geometryBuffer],{geometryBuffer:r}=e,i=r.byteLength,s=h._malloc(i),n=new Uint8Array(h.HEAPU8.buffer,s,i);n.set(new Uint8Array(r));const o=h.dracoDecompressPointCloudData(s,n.byteLength);if(h._free(s),o.error.length>0)throw new Error(`i3s.wasm: ${o.error}`);const a=o.featureIds?.length>0?o.featureIds.slice():null,l=o.positions.slice();return a&&t.push(a.buffer),t.push(l.buffer),{result:{positions:l,featureIds:a},transferList:t}},t.filterObbsForModifications=async function(e){await _(),f(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}},t.filterObbsForModificationsSync=f,t.initialize=async function(){h||await _()},t.interpretObbModificationResults=function(e){return 0===e?u.NodeIMModificationImpact.Unmodified:1===e?u.NodeIMModificationImpact.PotentiallyModified:2===e?u.NodeIMModificationImpact.Culled:u.NodeIMModificationImpact.Unknown},t.process=async function(e){h=await _();const t=[e.geometryBuffer];return{result:m(h,e,t),transferList:t}},t.project=async function(t){const{localMatrix:r,origin:o,positions:a,vertexSpace:l}=t,c=i.fromJSON(t.inSpatialReference),u=i.fromJSON(t.outSpatialReference);let d;const[{projectBuffer:h},{initializeProjection:p}]=await Promise.all([new Promise(((t,r)=>e(["../../../geometry/projection/projectBuffer"],t,r))),new Promise(((t,r)=>e(["../../../geometry/projectionUtils"],t,r)))]);await p(c,u);const m=[0,0,0];if(!h(o,c,0,m,u,0))throw new Error("Failed to project");if("georeferenced"===l.type&&null==l.origin){if(d=new Float64Array(a.length),!h(a,c,0,d,u,0,d.length/3))throw new Error("Failed to project")}else{const t="georeferenced"===l.type?s.fromJSON(l):n.fromJSON(l),{projectMeshVertexPositions:i}=await new Promise(((t,r)=>e(["../../../geometry/support/meshUtils/projectMeshVertexPositions"],t,r))),o=i({vertexAttributes:{position:a},transform:r?{localMatrix:r}:void 0,vertexSpace:t,spatialReference:c},u);if(!o)throw new Error("Failed to project");d=o}const f=d.length,[g,y,_]=m;for(let e=0;e<f;e+=3)d[e]-=g,d[e+1]-=y,d[e+2]-=_;return{result:{projected:d,original:a,projectedOrigin:m},transferList:[d.buffer,a.buffer]}},t.setLegacySchema=async function(e){h=await _(),h.setLegacySchema(e.context,e.jsonSchema)},t.setModifications=async function(e){await _(),p(e)},t.setModificationsSync=p,t.test=b,t.transformNormals=async function({normalMatrix:e,normals:t}){const i=new Float32Array(t.length);return o.transformMat3(i,t,e),r.hasScaling(e)&&o.normalize(i,i),{result:{transformed:i,original:t},transferList:[i.buffer,t.buffer]}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/libs/i3s/I3SModule":function(){define(["require","exports","../../assets"],(function(e,t,r){"use strict";function i(e){return r.getAssetUrl(`esri/libs/i3s/${e}`)}let s;t.get=function(){return s||(s=new Promise((t=>new Promise(((t,r)=>e(["../../chunks/i3s"],t,r))).then((e=>e.i3s)).then((({default:e})=>{const r=e({locateFile:i,onRuntimeInitialized:()=>t(r)});delete r.then})))).catch((e=>{throw e}))),s},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/Highlights":function(){define(["../../../../core/arrayUtils","../../../../core/handleUtils","../../../../core/MapUtils","../II3SMeshView3D"],(function(e,t,r,i){"use strict";class s{constructor(e){this.highlightName=e,this.ids=new Set}}return class{constructor({collection:e,forAllFeatures:t,forAllFeaturesOfNode:r}){this._highlights=new Map,this._collection=e,this._forAllFeatures=t,this._forAllFeaturesOfNode=r}destroy(){this._highlights.forEach((e=>e.forEach((e=>this._releaseSet(e))))),this._highlights=null}acquireSet(i){const n=new s(i);r.getOrCreateMapValue(this._highlights,i,(()=>[])).push(n);const o=t.makeHandle((()=>{const t=this._highlights?.get(i);t&&(this._releaseSet(n),e.removeUnordered(t,n))}));return{set:n,handle:o}}setFeatureIds(e,t){t.forEach((t=>e.ids.add(t))),this._initializeSet(e)}_initializeSet(e){this._forAllFeatures(((t,r,s)=>(e.ids.has(t)&&this._collection.addComponentHighlight(s.objectHandle,r,e.highlightName),i.ForAllFeaturesReturnType.CONTINUE)))}_releaseSet(e){this._forAllFeatures(((t,r,s)=>(e.ids.has(t)&&this._collection.removeComponentHighlight(s.objectHandle,r,e.highlightName),i.ForAllFeaturesReturnType.CONTINUE)))}objectCreated(e){this._highlights.forEach(((t,r)=>{t.forEach((t=>{this._forAllFeaturesOfNode(e,((s,n)=>(t.ids.has(s)&&this._collection.addComponentHighlight(e.objectHandle,n,r),i.ForAllFeaturesReturnType.CONTINUE)))}))}))}objectDeleted(e){this._collection.clearHighlights(e.objectHandle)}}}))},"esri/views/3d/layers/i3s/I3SAsyncElevationUpdater":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../II3SMeshView3D","../graphics/ExtentSet","../../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u){"use strict";e.I3SAsyncElevationUpdater=class extends r{constructor(e,t,r,i){super({}),this._updateExtent=t,this._updateNode=r,this._getElevationMode=i,this.running=!1,this._extentSet=new c.ExtentSet,this._nodeSet=new Set;const s=this._taskPriority,n=e.registerTask(this._taskPriority,this);this.addHandles(n),this._task=n,this._lastTaskPriority=s}get _taskPriority(){const e=this._getElevationMode();return e&&e===l.ElevationMode.RelativeToGround?u.TaskPriority.ELEVATION_ALIGNMENT_SCENE:u.TaskPriority.ELEVATION_ALIGNMENT}_updateTaskPriority(){const e=this._taskPriority;e!==this._lastTaskPriority&&(this._task.priority=e,this._lastTaskPriority=e)}addExtent(e){this._extentSet.add(e),this._updateTaskPriority(),this.running=!0}schedule(e){this._nodeSet.add(e),this._updateTaskPriority(),this.running=!0}remove(e){this._nodeSet.delete(e),this._updateRunning()}runTask(e){const t=this._extentSet;for(e.run((()=>t.merge(e)));!t.empty&&!e.done;){const r=this._updateExtent(t.pop());null!=r&&r.forAll((e=>this.schedule(e))),e.madeProgress()}if(e.done)return;const r=this._nodeSet;for(const t of r)if(r.delete(t),this._updateNode(t),e.madeProgress(),e.done)break;this._updateRunning()}_updateRunning(){this.running=this._nodeSet.size>0||this._extentSet.size>0}},t.__decorate([i.property()],e.I3SAsyncElevationUpdater.prototype,"running",void 0),e.I3SAsyncElevationUpdater=t.__decorate([a.subclass("esri.views.3d.layers.i3s.I3SAsyncElevationUpdater")],e.I3SAsyncElevationUpdater),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SCrossfadeHelper":function(){define(["exports","../../../../core/maybe","../../../../core/scheduling","../support/I3SLayerView"],(function(e,t,r,i){"use strict";e.I3SCrossfadeHelper=class{constructor(e){this._view=e,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}destroy(){this._preRenderFrameTaskHandle?.remove(),this._preRenderFrameTaskHandle=null,this._view=null}get updating(){return this._numFadingNodes>0}stopNodeFading(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=t.removeMaybe(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))}_startNodeFading(e,t,i){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=r.addFrameTask({preRender:e=>this._updateAllNodeFading(e)}),this._view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this._view.notifyUpdate()),e.lodCrossfadeSignedDuration=i,e.lodCrossfadeProgress=t}_updateAllNodeFading(e){const t=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode(((r,i)=>{if(null!=r?.lodCrossfadeProgress){const s=r.lodCrossfadeSignedDuration,n=s>0?this._view.fullOpacity:0,o=e.deltaTime/s,a=r.lodCrossfadeProgress+Math.abs(o),l=!t||a>=1||0===s,c=n-(l?0:s>0?1:-1)*(1-a);l?(this.stopNodeFading(r),s<0&&this._view.markNodeToRemove(i)):r.lodCrossfadeProgress=a,this._view.setNodeOpacityByIndex(i,c)}})),this._view.removeMarkedNodes()}stopAllNodeFading(){this._view.foreachCrossfadeNode(((e,t)=>{if(null!=e?.lodCrossfadeProgress){this.stopNodeFading(e);const r=e.lodCrossfadeSignedDuration;r<0&&this._view.markNodeToRemove(t);const i=r>0?this._view.fullOpacity:0;this._view.setNodeOpacityByIndex(t,i)}})),this._view.removeMarkedNodes()}fadeNode(e,t,r,s){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const n=this._view,o=n.nodeCrossfadingEnabled,a=r===i.FadeDirection.FadeIn?n.fullOpacity:0,l=o?s?r===i.FadeDirection.FadeIn?n.lodCrossfadeinDuration:n.lodCrossfadeoutDuration:n.lodCrossfadeUncoveredDuration:0,c=this._view.getNodeOpacityByIndex(e);if(o&&c!==a&&l>0){const e=1-Math.abs(a-c);this._startNodeFading(t,e,function(e){return e===i.FadeDirection.FadeIn?1:-1}(r)*l)}else this.stopNodeFading(t),this._view.setNodeOpacityByIndex(e,a),r===i.FadeDirection.FadeOut&&this._view.removeNode(e)}isNodeFullyFadedIn(e){const t=this._view.getNodeCrossfadeMetaData(e);return null==t||null==t.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(e)===this._view.fullOpacity}},e.NodeCrossfadeMetaData=class{constructor(){this.lodCrossfadeSignedDuration=0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SIntersectionHandler":function(){define(["exports","../../../ViewingMode","./I3SUtil","./Intersector","../../webgl-engine/lib/IntersectorInterfaces","../../webgl-engine/lib/IntersectorResult","../../webgl-engine/lib/IntersectorType","../../webgl-engine/lib/RayIntersections","../../webgl-engine/lib/verticalOffsetUtils"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.I3SIntersectionHandler=class{constructor(e){this.type=o.IntersectorType.I3S,this._needVerticalOffset=!1,this.layerViewUid=e.layerViewUid,this.sublayerId=e.sublayerId,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}updateElevationAlignState(e,r){this._needVerticalOffset=e&&r===t.ViewingMode.Global}intersect(e,t,o,c,u,d){const h=e.results,p=e.options.store===s.StoreResults.ALL,m=e.ray.direction,f=e.tolerance;let g=e=>e,y=e=>e;const _=l.getVerticalOffsetI3S(e.verticalOffset??(this._needVerticalOffset?0:null));null!=e.verticalOffset&&null!=_&&(g=e=>_.applyToMbs(e),y=e=>_.applyToObb(e));const b=new a.MeshIntersectionOptions(d,e.options.normalRequired);this._traverseNodeHierarchy(((s,a)=>{if(0===s.childrenLoaded)return!1;const l=s.serviceObbInRenderSR?.isValid?s.serviceObbInRenderSR:null;return!(l&&!y(l).intersectRay(o,m,f)||(!a||!l&&r.isValidMbs(s.serviceMbsInRenderSR)&&!function(e,t,r,i=0){const s=e[3]+i,n=t[0]-e[0],o=t[1]-e[1],a=t[2]-e[2],l=r[0],c=r[1],u=r[2],d=l*n+c*o+u*a;return d*d-(l*l+c*c+u*u)*(n*n+o*o+a*a-s*s)>=0}(g(s.serviceMbsInRenderSR),o,m,f)||null!=s.geometryObbInRenderSR&&!y(s.geometryObbInRenderSR).intersectRay(o,m,f)||this._collection.intersect(a,o,c,f,_,b,((r,a,l,u)=>{if(a<0||null!=t&&!t(o,c,a))return;const d=e=>{const t=new i.I3sTarget(this.layerViewUid,this.sublayerId,s.index,r,u);e.set(this.type,t,a,l)};if(this.isGround&&(null==h.ground.distance||a<h.ground.distance)&&d(h.ground),!e.options.isFiltered&&((null==h.min.distance||a<h.min.distance)&&d(h.min),(null==h.max.distance||a>h.max.distance)&&d(h.max),p)){const t=new n.IntersectorResult(e.ray);d(t),e.results.all.push(t)}})),0))}))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SOverrides":function(){define(["require","exports","../../../../chunks/tslib.es6","../../../../request","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/asyncUtils","../../../../core/Collection","../../../../core/handleUtils","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/memoryEstimations","../../../../core/promiseUtils","../../../../core/ReactiveSet","../../../../core/reactiveUtils","../../../../core/accessorSupport/decorators/property","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/support/spatialReferenceUtils","../../../../intl/number","../../../../layers/support/featureQueryAll","../../../../support/requestUtils","../../../ViewingMode"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w){"use strict";t.I3SOverrides=class extends s{constructor(e){super(e),this._warnMaximumChangedObjectsExceeded=!1,this._maximumNumberOfEditOVerrides=M,this._definitionExpressionDirty=!0,this._interactiveEditingSessions=new a,this.geometryOverrides=new a,this._clientGeometryCache=new Map,this._attributeChangedObjectIds=new m,this._geometryChangedObjectIds=new m,this._pendingFetchChangedObjectIds=null,this._pendingFetchAbortController=new AbortController,this._applyGeometryOverridesTask=null,this._featureIdLocks=new Map}initialize(){this._memCache=new T(this.memoryController.newCache(`i3s-attribute-overrides-${this.layer.uid}`)),this.addHandles(f.watch((()=>this.layer.definitionExpression),(async()=>{this._definitionExpressionDirty=!0,this._pendingFetchChangedObjectIds||(this._applyGeometryOverridesTask=d.abortMaybe(this._applyGeometryOverridesTask),this._applyGeometryOverridesTask=o.createTask((e=>this._queryAndAddGeometryOverrides(e))),await this._applyGeometryOverridesTask.promise)}),f.sync)),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController?.signal),this._pendingFetchChangedObjectIds.finally((()=>{this._pendingFetchAbortController=null,this._pendingFetchChangedObjectIds=null}))}destroy(){this._set("layer",null),this._memCache=d.destroyMaybe(this._memCache),this._pendingFetchAbortController=d.abortMaybe(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null,this._featureIdLocks.clear()}get is3DOFL(){return null!=this._associatedLayer?.infoFor3D}get sortedGeometryChangedObjectIds(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort(((e,t)=>e-t)):[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get hasGeometryChanges(){return this._geometryChangedObjectIds.size>0}get updating(){return!!this.is3DOFL&&!!(this._pendingFetchChangedObjectIds||this._applyGeometryOverridesTask&&!this._applyGeometryOverridesTask.finished)}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}featureHasGeometryChanges(e){return this._geometryChangedObjectIds.has(e)}featureHasAttributeChanges(e){return this._attributeChangedObjectIds.has(e)}createInteractiveEditSession(e){this._attributeChangedObjectIds.add(e);const t=this._interactiveEditingSessions,r=new x(e,(()=>{t.remove(r)}));return t.unshift(r),r}async applyAttributeOverrides(e,t,r,i=[]){if(this._pendingFetchChangedObjectIds&&await p.whenOrAbort(this._pendingFetchChangedObjectIds,r),null==t)return;const{attributeData:s,loadedAttributes:n}=t;if(null==n||null==s||0===this._attributeChangedObjectIds.size)return;const o=new Set;for(const e of n)o.add(e.index);for(const t of i)o.has(t.index)||(n.push(t),s[t.name]=new Array(e.length));const a=await this._lockFeatureIds(e);try{const t={attributeData:s,loadedAttributes:n},i=this._getOverridesFromCache(e,t,this._attributeChangedObjectIds),{objectIds:o,fieldNames:a}=i;if(0===o.length||0===a.length)return;const l=await this._queryAttributeOverridesFromAssociatedLayer(o,a,r);if(null==l)return;this._processOverridesFromAssociatedLayer(e,l,a,t)}finally{a.remove()}}updateGeometry(e,t){this._geometryChangedObjectIds.add(e);const r=this._clientGeometryCache.get(e);if(null!=r&&(this.geometryOverrides.remove(r),this._clientGeometryCache.delete(e)),null!=t){const r={oid:e,mesh:t};this.geometryOverrides.add(r),this._clientGeometryCache.set(e,r)}}updateAttributeValue(e,t,r){this._attributeChangedObjectIds.add(e),this._cacheAttributeValue(e,t,r)}featureAdded(e){this.is3DOFL&&this._geometryChangedObjectIds.add(e),this._attributeChangedObjectIds.add(e)}_cacheAttributeValue(e,t,r){this._memCache.put(e,t,r)}_getOverridesFromCache(e,{loadedAttributes:t,attributeData:r},i){const s=new Array;for(const e of t)s[e.index]=r[e.name];const n=new Set,o=new Set;for(let r=0;r<e.length;r++){const a=e[r];if(i.has(a))for(const e of t){const t=this._attributeFromCache(a,e.index);void 0===t?(n.add(a),o.add(e.name)):s[e.index][r]=t}}return{objectIds:Array.from(n),fieldNames:Array.from(o)}}_attributeFromCache(e,t){const r=this._fromInteractiveEditingSession(e,t);return void 0!==r?r:this._memCache.get(e,t)}_fromInteractiveEditingSession(e,t){if(null!=this._interactiveEditingSessions)for(const r of this._interactiveEditingSessions){if(r.objectId!==e)continue;const i=r.getAttribute(t);if(void 0!==i)return i}}async _queryAttributeOverridesFromAssociatedLayer(e,t,r){if(0===e.length)return null;this._logWarningIfMaximumObjectsExceeded();const{associatedLayer:i}=this.layer;if(null==i)return null;const s=i.createQuery(),{objectIdField:n}=i,o=[n,...t];s.where=this.layer.definitionExpression||"1=1",s.returnGeometry=!1,s.outFields=o,s.cacheHint=!0;const a=await this._executeBatchQuery(i,e,s,r),l=[];for(const e of a)if(e.ok)for(const t of e.value.features)l.push(t);return l}async _queryGeometryOverridesFromAssociatedLayer(t,r){if(0===t.length||!this.is3DOFL)return null;const i=this.layer.associatedLayer,s=i.infoFor3D,{spatialReference:n}=i,{state:{viewingMode:o},spatialReference:a}=this.view,l=o===w.ViewingMode.Global,c=n.isGeographic;if(l&&!c)return u.getLogger(this).warn("unsupported-pcs-edits-in-global-view",this.layer.title,E(n,a,this.view.viewingMode,R.Mode)),null;if(!l&&c)return u.getLogger(this).warn("unsupported-gcs-edits-in-local-view",this.layer.title,E(n,a,this.view.viewingMode,R.Mode)),null;if(!(_.equals(n,a)||l&&a.isWebMercator&&n.isWGS84))return u.getLogger(this).warn("unsupported-mismatched-spatial-reference-edits",this.layer.title,E(n,a,this.view.viewingMode,R.SpatialReference)),null;this._logWarningIfMaximumObjectsExceeded();const{objectIdField:d,globalIdField:h}=i,p=[d,...null!=h?[h]:[]],m=i.createQuery();m.where=this.layer.definitionExpression||"1=1",m.returnGeometry=!0,m.outFields=p,m.cacheHint=!0,m.returnZ=i.hasZ,m.returnM=i.hasM;const{assetMapFromAssetMapsJSON:f,extractMesh:g}=await new Promise(((t,r)=>e(["../../../../rest/support/meshFeatureSet"],t,r))),y=await this._executeBatchQuery(i,t,m,r),b=[];for(const e of y){if(!e.ok)continue;const t=e.value,{assetMaps:r,features:i,globalIdFieldName:o}=t;if(null==r)continue;const a=f(s,r);for(const e of i){const t=g(e,o,n,s,a),r=e;null!=t?(r.geometry=t,b.push(r)):r.geometry=null}}return b}_logWarningIfMaximumObjectsExceeded(){if(!this._warnMaximumChangedObjectsExceeded)return;this._warnMaximumChangedObjectsExceeded=!1;let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${b.formatNumber(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;e+=t?.loaded?` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:` (${this.layer.parsedUrl.path})`,u.getLogger(this).warn("#queryOverrides()",this.layer.title,`${e}.`)}async _executeBatchQuery(e,t,r,i){if(0===t.length)return[];const s=v.getMaximumQuerySize(e);t=[...t].sort(((e,t)=>e-t));const a=n.splitIntoChunks(t,s).map((t=>{const s=r.clone();return s.objectIds=t,o.resultOrAbort(v.queryAllJSON(e,s,{signal:i}))}));return Promise.all(a)}_processOverridesFromAssociatedLayer(e,t,r,{loadedAttributes:i,attributeData:s}){const n=this._associatedLayer;if(null==n)return;const o=n.objectIdField,a=r.map((t=>(t in s||(s[t]=new Array(e.length)),s[t]))),l=new Map(i.map((e=>[e.name,e.index]))),c=r.map((e=>l.get(e))),u=new Map(Array.from(e,((e,t)=>[e,t])));for(const e of t){const t=e.attributes[o];for(let i=0;i<r.length;i++){const s=c[i],n=u.get(t),o=e.attributes[r[i]];a[i][n]=o,this._cacheAttributeValue(t,s,o)}}}async _fetchChangedObjectIds(e){const t=this.layer;await t.load({signal:e}),this._geometryChangedObjectIds.clear(),this._attributeChangedObjectIds.clear();const{associatedLayer:r}=t;if(null==r||!r.capabilities?.operations?.supportsChangeTracking)return;const s=this._getFetchChangedObjectIdsServerGen();if(null==s)return;const n=r.layerId,a=this.is3DOFL,l={...r.customParameters,f:"json",returnIdsOnly:!0,layers:`[${n}]`,returnUpdates:!0,returnDeletes:a,returnInserts:a,layerServerGens:JSON.stringify([{id:n,serverGen:s}])};if(null!=r.apiKey&&(l.token=r.apiKey),a){const e=r.infoFor3D;l.fieldsToCompare=JSON.stringify({fields:[...Object.values(e.transformFieldRoles),e.sourceHashField]})}const c=await o.result(i(`${r.url}/extractChanges`,{method:"post",query:l,timeout:P,signal:e}));if(!c.ok&&S.isTimeoutError(c.error)){const e=this.layer.title;u.getLogger(this).warn("extractChanges:timeout",e,`${e} could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service.`)}if(c.ok&&1===c.value.data?.edits?.length){const t=c.value.data.edits[0],r=t?.objectIds,i=t?.fieldUpdates,s=r?.adds??[],n=r?.updates??[],o=r?.deletes??[],l=[...s,...n,...o],u=a?[...s,...i??n,...o]:[],d=Math.min(this._maximumNumberOfEditOVerrides,l.length);d<l.length&&(this._warnMaximumChangedObjectsExceeded=!0);const h=l.sort(((e,t)=>e-t));for(let e=0;e<d;++e){const t=h[e];this._attributeChangedObjectIds.add(t)}for(const e of u)this._geometryChangedObjectIds.add(e);for(;this._definitionExpressionDirty;)await this._queryAndAddGeometryOverrides(e)}}async _queryAndAddGeometryOverrides(e){this._definitionExpressionDirty=!1;const t=this.layer,{associatedLayer:r}=t;if(null!=r&&r.capabilities?.operations?.supportsChangeTracking&&this.is3DOFL&&this._geometryChangedObjectIds.size>0){const t=await this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),e);if(null!=t)for(const e of t)null!=e.geometry&&this.updateGeometry(e.attributes[r.objectIdField],e.geometry)}}_getFetchChangedObjectIdsServerGen(){const e=this.layer;if(null!=e.serviceUpdateTimeStamp?.lastUpdate)return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return null!=t?.serverGens?.minServerGen?t.serverGens.minServerGen:null}async _lockFeatureIds(e){const t=this._featureIdLocks;let r=!0;for(;r;){const i=new Array;for(const r of e){const e=t.get(r);e&&i.push(e)}0===i.length?r=!1:await Promise.all(i)}const i=p.createResolver(),s=i.promise;for(const r of e)t.set(r,s);return l.makeHandle((()=>{for(const r of e)t.delete(r);i.resolve()}))}get test(){}},r.__decorate([g.property({constructOnly:!0})],t.I3SOverrides.prototype,"view",void 0),r.__decorate([g.property({constructOnly:!0})],t.I3SOverrides.prototype,"layer",void 0),r.__decorate([g.property({readOnly:!0})],t.I3SOverrides.prototype,"is3DOFL",null),r.__decorate([g.property()],t.I3SOverrides.prototype,"_interactiveEditingSessions",void 0),r.__decorate([g.property({readOnly:!0})],t.I3SOverrides.prototype,"sortedGeometryChangedObjectIds",null),r.__decorate([g.property({readOnly:!0})],t.I3SOverrides.prototype,"geometryOverrides",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_clientGeometryCache",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_associatedLayer",null),r.__decorate([g.property({constructOnly:!0})],t.I3SOverrides.prototype,"memoryController",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_attributeChangedObjectIds",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_geometryChangedObjectIds",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"hasGeometryChanges",null),r.__decorate([g.property()],t.I3SOverrides.prototype,"_pendingFetchChangedObjectIds",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_pendingFetchAbortController",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"_applyGeometryOverridesTask",void 0),r.__decorate([g.property()],t.I3SOverrides.prototype,"updating",null),r.__decorate([g.property()],t.I3SOverrides.prototype,"isEmpty",null),t.I3SOverrides=r.__decorate([y.subclass("esri.views.3d.layers.i3s.I3SOverrides")],t.I3SOverrides);class x{constructor(e,t){this.objectId=e,this._remove=t,this._updates=new Map,this._isActive=!0}getAttribute(e){return this._updates.get(e)}setAttribute(e,t){this.isActive&&this._updates.set(e,t)}remove(){this.isActive&&(this._isActive=!1,this._remove())}get isActive(){return this._isActive}}class T{constructor(e){this._cache=e}destroy(){this._cache.destroy()}put(e,t,r){this._cache.put(this._getKey(e,t),new C(r))}get(e,t){return this._cache.get(this._getKey(e,t))?.value}_getKey(e,t){return`${e}-${t}`}}class C{constructor(e){this.value=e,this.cachedMemory="string"==typeof e?h.estimateStringMemory(e):h.estimateNumberMemory}}const P=1e4,M=5e4;var R;function E(e,t,r,i){return`Displaying the edits of a SceneLayer with a${i===R.Mode?e.isGeographic?" geographic ":" projected ":" "}spatial reference (wkid:${e.wkid}) in ${r} viewing mode${i===R.SpatialReference?` with spatial reference (wkid:${t.wkid}) `:" "}is not supported. No geometry edits will be displayed for this layer.\nPlease consider re-caching the scene service or changing the ${i===R.Mode?"viewing mode":"view spatial reference"} to display edits.`}!function(e){e[e.Mode=0]="Mode",e[e.SpatialReference=1]="SpatialReference"}(R||(R={})),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/IDBCache":function(){define(["exports","../../../../core/ByteSizeUnit","../../../../core/Error","../../../../core/promiseUtils"],(function(e,t,r,i){"use strict";function s(e){return new Promise(((t,r)=>{e.oncomplete=()=>t(),e.onerror=()=>r(e.error),e.onabort=()=>r(e.error)}))}function n(e){return new Promise(((t,r)=>{"done"===e.readyState?null!=e.error?r(e.error):t(e.result):(e.onsuccess=()=>t(e.result),e.onerror=()=>r(e.error))}))}e.IDBCache=class{constructor(e,r,i=14){this._version=i,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=t.ByteSizeUnit.GIGABYTES,this.quotaReductionFactor=.2,this._dbName=e,this._storeName=r}init(){return Promise.resolve().then((()=>{const e=indexedDB.open(this._dbName,this._version);return e.onupgradeneeded=t=>{const r=e.result,i=e.transaction,s=r.objectStoreNames.contains(this._storeName)?i.objectStore(this._storeName):r.createObjectStore(this._storeName),n=r.objectStoreNames.contains("last_access")?i.objectStore("last_access"):r.createObjectStore("last_access");n.indexNames.contains("date")||n.createIndex("date","date",{unique:!1}),n.indexNames.contains("byteSize")||n.createIndex("byteSize","byteSize",{unique:!1}),t.oldVersion<this._version&&(s.clear(),n.clear())},n(e)})).then((e=>{this._destroyed?e.close():this._db=e}))}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(e,t){return null==this._db?Promise.reject(new r("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then((()=>this._put(e,t))).catch((r=>{if(r&&"QuotaExceededError"===r.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then((e=>this._removeLeastRecentlyAccessed(t.byteSize+Math.ceil(e*this.quotaReductionFactor)))),this._quotaReductionPromise.then((()=>this._quotaReductionPromise=null),(()=>this._quotaReductionPromise=null))),this._quotaReductionPromise.then((()=>this._put(e,t)));throw r})).then((()=>{this._gcCounter--,this._gcCounter<0&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then((e=>this._removeLeastRecentlyAccessed(e-this.maxByteSize))))}))}get(e,t){const r=this._db;if(null==r)return Promise.resolve(void 0);let s=null;return Promise.resolve().then((()=>{const o=r.transaction(this._storeName,"readonly");return s=i.onAbort(t,(()=>{o.abort()})),n(o.objectStore(this._storeName).get(e))})).then((t=>(null==t?++this._miss:this._db&&(++this._hit,this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:t.byteSize},e)),null!=s&&s.remove(),t))).catch((()=>{++this._miss,i.throwIfAborted(t),null!=s&&s.remove()}))}remove(e){const t=this._db;return null==t?Promise.resolve():Promise.resolve().then((async()=>{const r=t.transaction([this._storeName,"last_access"],"readwrite"),i=r.objectStore(this._storeName),o=r.objectStore("last_access"),a=i.delete(e),l=o.delete(e);await Promise.all([n(a),n(l),s(r)])}))}_put(e,t){const r=this._db;if(null==r)return Promise.resolve();const i=r.transaction([this._storeName,"last_access"],"readwrite"),o=i.objectStore(this._storeName),a=i.objectStore("last_access"),l=o.put(t,e),c=a.put({date:Date.now(),byteSize:t.byteSize},e);return Promise.all([n(l),n(c),s(i)])}_removeLeastRecentlyAccessed(e){if(e<=0||!this._db)return Promise.resolve();const t=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=t.objectStore(this._storeName),i=t.objectStore("last_access");let n=0;const o=i.index("date").openCursor(null,"next");return o.onsuccess=()=>{const t=o.result;null!=t&&(null!=t.value.byteSize&&(n+=t.value.byteSize),r.delete(t.primaryKey),i.delete(t.primaryKey),n<e&&t.continue())},s(t)}_getCacheSize(){const e=this._db;if(null==e)return Promise.resolve(0);const t=e.transaction("last_access"),r=t.objectStore("last_access");let i=0;const n=r.index("byteSize").openKeyCursor();return n.onsuccess=()=>{const e=n.result;if(!e)return;const t=e.key;null!=t&&(i+=t),e.continue()},s(t).then((()=>i))}},e.whenRequest=n,e.whenTransaction=s,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/IDBMockCache":function(){define(["exports"],(function(e){"use strict";const t=new WeakMap;e.IDBMockCache=class{constructor(e,r){switch(this._miss=0,this._hit=0,this.initialized=!0,r){case"layer":this._data=new Map;break;case"view":{const r=t.get(e);if(r){this._data=r;break}const i=new Map;this._data=i,t.set(e,i)}}}init(){return Promise.resolve()}async get(e,t){if(this._data.has(e))return this._hit++,this._data.get(e)??void 0;this._miss++}destroy(){}put(e,t){return this._data.set(e,t),Promise.resolve()}remove(e){return this._data.delete(e),Promise.resolve()}getHitRate(){return this._hit/(this._hit+this._miss)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/LayerElevationProvider":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/Evented","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/libs/gl-matrix-2/math/mat4","../../../../core/libs/gl-matrix-2/factories/mat4f64","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/support/aaBoundingRect","../../../../chunks/sphere","../../support/ElevationRange","../../support/ElevationUpdateEvent","../../webgl-engine/lib/Intersector","../../webgl-engine/lib/IntersectorInterfaces"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b){"use strict";e.LayerElevationProvider=class extends(i.EventedMixin(r)){constructor(e){super(e),this._tmpEvent=new y.ElevationUpdateEvent,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=new _.Intersector(this.view.state.viewingMode),this._intersector.options.store=b.StoreResults.MIN,this._intersector.options.normalRequired=!1,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,r,i){const n=this._renderCoordsHelper,o=d.set(w,e,t,r);if(!n.toRenderCoords(o,i,o))return s.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:l,intersectionHandler:c}=this,u=a.fullExtent,h=null!=u&&Number.isFinite(u.xmin)&&Number.isFinite(u.xmax)&&Number.isFinite(u.ymin)&&Number.isFinite(u.ymax)&&Number.isFinite(u.zmin)&&Number.isFinite(u.zmax)?new g.ElevationRange(u.zmin,u.zmax):a.elevationRange;if(null==h)return null;const p=a.elevationOffset,m=h.elevationRangeMin+p,f=h.elevationRangeMax+p,y=n.setAltitude(x,f,o),_=n.setAltitude(T,m,o);return l.reset(y,_,this.view.state.camera),c.intersect(l,null,y,_,null,!0),l.results.min.getIntersectionPoint(o)?n.getAltitude(o):null}getSphereElevationBounds(e,t){return p.projectBoundingSphere(e,t,S,this._renderSR),this._layerElevationSource.getElevationRange(S)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new g.ElevationRange(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){m.empty(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){m.empty(t);for(const r of e)this._expandExtent(r,t)}_expandExtent(e,t){const r=this.spatialReference;if(null==r)return;if(null==e)return;c.fromQuat(v,e.quaternion),v[12]=e.center[0],v[13]=e.center[1],v[14]=e.center[2];const i=e.halfSize;for(let e=0;e<8;++e)w[0]=1&e?i[0]:-i[0],w[1]=2&e?i[1]:-i[1],w[2]=4&e?i[2]:-i[2],d.transformMat4(w,w,v),this._renderCoordsHelper.fromRenderCoords(w,w,r),m.expand(t,w,t)}},t.__decorate([n.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"layerElevationSource",void 0),t.__decorate([n.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"intersectionHandler",void 0),t.__decorate([n.property({constructOnly:!0})],e.LayerElevationProvider.prototype,"view",void 0),t.__decorate([n.property()],e.LayerElevationProvider.prototype,"spatialReference",null),e.LayerElevationProvider=t.__decorate([l.subclass("esri.views.3d.layers.i3s.LayerElevationProvider")],e.LayerElevationProvider);const v=u.create(),S=f.fromValues(0,0,0,0),w=h.create(),x=h.create(),T=h.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/SymbologyInfo":function(){define(["exports","../../../../core/libs/gl-matrix-2/factories/vec4f64","../support/symbolColorUtils"],(function(e,t,r){"use strict";e.SymbologyInfo=class{constructor(){this.color=t.create(),this.castShadows=!0,this.pickable=!0,this.colorMixMode=r.ColorMixModeEnum.Multiply}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/ObjectParameters":function(){define(["exports"],(function(e){"use strict";e.ObjectParameters=class{constructor(e,t,r,i){this.toMapSpace=e,this.transform=t,this.obb=r,this.geometry=i}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/webgl-engine/collections/Component/Transform":function(){define(["exports"],(function(e){"use strict";e.Transform=class{constructor(e,t){this.position=e,this.rotationScale=t,this.origin=void 0}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/featureEditing":function(){define(["exports","../../../../core/asyncUtils","../../../../core/lang","../../../../core/uuid","../../../../layers/support/featureQueryAll"],(function(e,t,r,i,s){"use strict";const n={setAttribute(){},rollback(){},commit(){}};var o;function a(e,t,r){const{gidToFeatureInfo:i,oidToFeatureInfo:s,fieldsIndex:n,objectIdField:o,globalIdField:a,featureOrIdentifierList:l}=r;if(!r.featuresResolved&&null!=l){for(const e of l){const t={feature:null,oid:-1,gid:null};if("attributes"in e){t.feature=e;const r=e.attributes;if(null!=r)for(const e in r){if(-1!==t.oid&&null!=t.gid)break;const i=n.normalizeFieldName(e);i===o&&(t.oid=r[e]??-1),i===a&&(t.gid=r[e])}}else t.oid=e.objectId??-1,t.gid=e.globalId;null!=t.gid&&i.set(t.gid,t),-1!==t.oid&&s.set(t.oid,t)}r.featuresResolved=!0}return(-1!==e?s.get(e):null)??(null!=t?i.get(t):null)}function l(e,t,r,s,n=null,o=!0){const l=[],c={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:null==r,fieldsIndex:e.fieldsIndex,objectIdField:e.objectIdField,globalIdField:e.globalIdField,featureOrIdentifierList:r};for(const e of t){if(null!=e.error)continue;const t=e.objectId??-1,r=e.globalId,u=(-1===t||o?a(t,r,c):null)??{feature:null,oid:t,gid:r},d={oid:-1===t?u.oid:t,gid:r??u.gid,feature:u.feature,result:e};l.push(d);const h=d.gid?i.normalizeGlobalID(d.gid):null;if(-1===d.oid&&null!=h&&null!=n&&(d.oid=n.get(h)??-1),-1===d.oid&&null!=h){let e=s.get(h);null==e&&(e={gid:d.gid,edits:[]},s.set(h,e)),e.edits.push(d)}}return l}function c(e,t,r){const i=function(e,t){const r=e.get(t);if(r)return r;const i=new u;return e.set(t,i),i}(e,t),s=null!=r&&i.get(r);if(s)return s;const n=new Array;return i.set(r,n),n}!function(e){e[e.EDITING=0]="EDITING",e[e.ROLLED_BACK=1]="ROLLED_BACK",e[e.COMMITTED=2]="COMMITTED"}(o||(o={}));const u=Map,d=Map;e.createInteractiveEditSession=function(e,t){const i=t.attributes[e.objectIdField];if(null==i)return n;const s=e.sessions.get(i);if(s)return s;const a=r.clone(t.attributes),l=new Set,c=e.i3sOverrides.createInteractiveEditSession(i),u=new Map;let d=o.EDITING;const h={setAttribute(r,s){if(d!==o.EDITING)return;const n=e.fieldsIndex.get(r);if(!n)return;const h=e.attributeStorageInfo.findIndex((e=>e.name===n.name));if(h<0)return;if(!(r in a))throw new Error(`Attribute "${r}" is not an attribute of the edited feature.`);c.setAttribute(h,s);const p=e.attributeStorageInfo[h];let m=!1;l.add(r),e.forEachNode(((r,n)=>{const o=((e,t)=>{const r=u.get(e);if(null==r){const r=t.indexOf(i);return u.set(e,r),r}return r})(r,n);if(-1===o)return;const a=e.getAttributeData(r.index);if(a){const i=a[p.name];i&&(i[o]=s,e.setAttributeData(r.index,a,t),m=!0)}})),m&&e.clearMemCache()},rollback(){if(d===o.EDITING){for(const e of l)this.setAttribute(e,a[e]);c.remove(),d=o.ROLLED_BACK,e.sessions.delete(i)}},commit(){d===o.EDITING&&(c.remove(),d=o.COMMITTED,e.sessions.delete(i))}};return e.sessions.set(i,h),h},e.normalizeEditResultsEvent=async function(e,r){const n=new Map,o=l(e,r.addedFeatures,r.edits?.addFeatures,n),a=l(e,r.updatedFeatures,r.edits?.updateFeatures,n),c=l(e,r.deletedFeatures,r.edits?.deleteFeatures,n,r.globalIdToObjectId,!1);return n.size>0&&await async function(e,r){const n=e.i3sOverrides.layer.associatedLayer;if(null==n?.globalIdField)return;const o=n.createQuery(),{objectIdField:a,globalIdField:l}=n;o.where=Array.from(r.values()).map((({gid:e})=>`${l}='${e}'`)).join(" OR "),o.returnGeometry=!1,o.outFields=[a,l],o.cacheHint=!1;const c=await t.resultOrAbort(s.queryAllJSON(n,o));if(!c.ok)return;const u=c.value.features;for(const e of u){const t=e.attributes[l],s=e.attributes[a];if(null==t||null==s||-1===s)continue;const n=r.get(i.normalizeGlobalID(t));if(null!=n)for(const e of n.edits)e.oid=s}}(e,n),{adds:o.filter((e=>-1!==e.oid)),updates:a.filter((e=>-1!==e.oid)),deletes:c.filter((e=>-1!==e.oid))}},e.processAttributeEdits=function(e,t){const r=function(e,t){const r=t.updates;if(!r||0===r.length)return new d;const i=new d,s=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)s.set(e.attributeStorageInfo[t].name,t);return e.forEachNode(((t,s)=>{for(const n of r){if(null==n.feature)continue;const r=n.feature,o=n.oid,a=s.indexOf(o);for(const s in r.attributes){const n=e.fieldsIndex.normalizeFieldName(s),l=c(i,t.index,n),u=r.attributes[s];l.push({featureIndex:a,featureId:o,value:u})}}})),i}(e,t),i=function(e,t){const r=new Map,i=t.adds;if(!i||0===i.length||null==e.globalIdField)return r;for(const e of i){const t=e.oid,i=e.feature;"mesh"===i?.geometry?.type&&r.set(t,i)}return r}(e,t);if(0===r.size&&0===i.size)return;const s=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)s.set(e.attributeStorageInfo[t].name,t);let n=!1;r.forEach(((t,r)=>{const i=e.getAttributeData(r);let o=!1;t.forEach(((t,r)=>{const a=null!=i?i[r]:null,l=s.get(r);for(const{featureIndex:r,value:i,featureId:s}of t)a&&(a[r]=i,o=!0,n=!0),e.i3sOverrides.updateAttributeValue(s,l,i)})),o&&e.setAttributeData(r,i,null)})),n&&e.clearMemCache();const{fieldsIndex:o,i3sOverrides:a,objectIdField:l,globalIdField:u}=e,h=a.layer.associatedLayer?.infoFor3D,p=new Set(h?[...Object.values(h.assetMapFieldRoles),...Object.values(h.transformFieldRoles)]:[]);for(const[e,t]of i){a.featureAdded(e);const{attributes:r}=t;for(const t in r){if(t!==l&&t!==u&&p.has(t))continue;const i=o.normalizeFieldName(t),n=null!=i?s.get(i):null;if(null==n)continue;const c=r[t];a.updateAttributeValue(e,n,c)}}},e.processGeometryEdits=function(e,t){const r=new Map,i=e=>{for(const{oid:t,feature:i}of e){const e=i?.geometry;"mesh"===e?.type&&r.set(t,e)}};i(t.adds),i(t.updates);for(const e of t.deletes)r.set(e.oid,null);for(const[t,i]of r)e.i3sOverrides.updateGeometry(t,i)},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SMeshViewFilter":function(){define(["require","exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybeUpdating","../../../../core/reactiveUtils","../../../../core/unitUtils","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/accessorSupport/decorators/subclass","../../../../chunks/vec32","../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../core/sql/WhereClause","../../../../geometry/ellipsoidUtils","../../../../geometry/projectionUtils","../../../../geometry/SpatialReference","../../../../geometry/projection/projectBoundingSphere","../../../../geometry/projection/projectVectorToVector","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/DoubleArray","../../../../geometry/support/Ellipsoid","../../../../geometry/support/spatialReferenceUtils","../../../../chunks/sphere","../../../../geometry/support/webMercatorUtils","../../../../layers/support/FeatureFilter","./I3SUtil"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E){"use strict";t.I3SMeshViewFilter=class extends i{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){l.whenOnce((()=>this.viewFilter?.geometry||null!=this.layerFilter)).then((()=>this.loadAsyncModule(new Promise(((t,r)=>e(["../../../../geometry/geometryEngine"],t,r))).then((e=>{this.destroyed||(this._geometryEngine=e)})))))}get sortedObjectIds(){if(null==this.viewFilter?.objectIds)return null;const e=x.doubleArrayFrom(this.viewFilter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=this.viewFilter?.where;if(null==e||!e)return null;try{return f.create(e,{fieldsIndex:this.layerFieldsIndex})}catch(e){n.getLogger(this).error(`Failed to parse filter where clause: ${e}`)}return null}addFilters(e,t,r,i){const s=this.sortedObjectIds;null!=s&&e.push((e=>E.objectIdFilter(s,!0,e))),this.addSqlFilter(e,this.parsedWhereClause),this.addTimeFilter(e,this.viewFilter?.timeExtent);const o=a.unwrapUpdating(this._layerMaskGeometries),l=this._geometryEngine,c=()=>n.getLogger(this);if(null!=o&&null!=this.layerFilter&&null!=l){const s=this.layerFilter.spatialRelationship;e.push(((e,n)=>F(c,l,e,n,i,t,r,o,s)))}const u=a.unwrapUpdating(this._viewMaskGeometries);if(null!=u&&null!=this.viewFilter&&null!=l){const s=this.viewFilter.spatialRelationship;e.push(((e,n)=>F(c,l,e,n,i,t,r,u,s)))}}isMBSGeometryVisible(e,t,r){const i=a.unwrapUpdating(this._layerMaskGeometries),s=this._geometryEngine;if(null!=i&&null!=this.layerFilter&&null!=s){const o=this.layerFilter.spatialRelationship,a=i[0].spatialReference||t;return b.projectBoundingSphere(e,r,L,a)?D(s,L,i,a,o):(n.getLogger(this).warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}const o=a.unwrapUpdating(this._viewMaskGeometries);if(null!=o&&null!=this.viewFilter&&null!=s){const i=this.viewFilter.spatialRelationship,a=o[0].spatialReference||t;return b.projectBoundingSphere(e,r,L,a)?D(s,L,o,a,i):(n.getLogger(this).warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){const e=a.unwrapUpdating(this._viewMaskGeometries),t=a.unwrapUpdating(this._layerMaskGeometries);return null==e||null==t?e||t:t.concat(e)}get _layerMaskGeometries(){const e=this.layerFilter;return null==e?null:null==this._geometryEngine?a.updating:"disjoint"===e.spatialRelationship?e.geometries.map((e=>({type:"polygon",rings:e.rings,spatialReference:e.spatialReference,cache:{}}))):[e.geometries.reduce(((e,t)=>(e.rings=[...e.rings,...t.rings],e)),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}get _viewMaskGeometries(){if(null==this.viewFilter)return null;const{geometry:e}=this.viewFilter;if(null==e)return null;if(null==this.viewFilter||null==this._geometryEngine)return a.updating;const{distance:t,units:r}=this.viewFilter,i=this.viewFilter.spatialRelationship,s="mesh"===e.type?e.extent:e;if(null==t||0===t)return I(this._geometryEngine,s,i);const o=r||c.getUnitString(s.spatialReference);if(s.spatialReference.isWGS84){const e=this._geometryEngine.geodesicBuffer(s,t,o);return I(this._geometryEngine,e,i)}const l=M.project(s,_.WGS84);if(null!=l){const e=M.project(this._geometryEngine.geodesicBuffer(l,t,o),s.spatialReference);return I(this._geometryEngine,e,i)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(y.load().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let u=null;try{u=y.project(s,_.WGS84)}catch(e){}if(u)try{u=y.project(this._geometryEngine.geodesicBuffer(u,t,o),s.spatialReference)}catch(e){u=null}return u||n.getLogger(this).error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${s.spatialReference.wkid}) to WGS84.`),I(this._geometryEngine,u,i)}get updating(){return a.isUpdating(this._layerMaskGeometries)||a.isUpdating(this._viewMaskGeometries)}static checkSupport(e){return!(null==e||(null==(t=e.spatialRelationship)||!O.includes(t))&&(n.getLogger(this.prototype).warn(`Filters with spatialRelationship other than ${O.join(", ")} are not supported for mesh scene layers`),1));var t}},r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"layerFilter",void 0),r.__decorate([u.property({type:R})],t.I3SMeshViewFilter.prototype,"viewFilter",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"addSqlFilter",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"addTimeFilter",void 0),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"sortedObjectIds",null),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedWhereClause",null),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedGeometry",null),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_layerMaskGeometries",null),r.__decorate([u.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_viewMaskGeometries",null),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"updating",null),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0),r.__decorate([u.property()],t.I3SMeshViewFilter.prototype,"_geometryEngine",void 0),t.I3SMeshViewFilter=r.__decorate([h.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],t.I3SMeshViewFilter);const O=["contains","intersects","disjoint"];var A;function I(e,t,r){if(null==t)return null;if("disjoint"===r&&"polygon"===t.type){const r=t.rings.length,i=t.spatialReference,n=new Array(r);for(let e=0;e<r;++e){const r=w.fromValues(1/0,1/0,-1/0,-1/0);w.expandWithNestedArray(r,t.rings[e]),n[e]={type:"polygon",rings:[t.rings[e]],spatialReference:i,cache:{},aabr:r}}n.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const o=new Set,a=new s.PositionHint;for(let t=0;t<n.length;++t){const r=n[t],i=r.aabr[0];o.forEach((t=>{if(i>=t.aabr[2])return void o.delete(t);if(r.aabr[1]>t.aabr[3]||r.aabr[3]<t.aabr[1]||!e.intersects(r,t))return;r.rings=r.rings.concat(t.rings),w.expand(r.aabr,t.aabr,r.aabr),r.cache={},o.delete(t);const l=s.indexOf(n,t,n.length,a);n.splice(l,1)})),o.add(r)}for(const e of n)e.aabr=void 0;return n}return[t]}function D(e,t,r,i,s){if(t[3]>=.5*(t[2]+g.getReferenceEllipsoid(i).radius))return!0;const n=N(e,t,i);return r.every((t=>U(e,t,n,s)!==A.DISCARD))}function F(e,t,r,i,s,n,o,a,l){const c=a[0].spatialReference||n.spatialReference;if(!b.projectBoundingSphere(i.node.serviceMbsInIndexSR,o,L,c))return void e().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const u=N(t,L,c),d=function(e,t,r,i,s){const n=t.renderSpatialReference,o=new Map,a={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:r};let l,c;switch(a.rings[0][3]=a.rings[0][0],e){case"intersects":l=(e,t,r)=>e.intersects(t,r)?A.KEEP:A.TEST,c=V;break;case"contains":l=(e,t,r)=>e.contains(t,r)?A.TEST:A.DISCARD,c=V;break;default:l=(e,t,r)=>e.disjoint(t,r)?A.TEST:A.DISCARD,c=B}return{collection:i,object:s,type:e,maskSR:r,renderSR:n,aabbCache:o,triangle:a,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:l,geometryTest:c}}(l,n,c,s,i.objectHandle),h="intersects"===l;let p=null;for(const e of a){if(0===r.length)return;switch(U(t,e,u,l)){case A.DISCARD:return h&&(i.weaklyRemovedIds=i.weaklyRemovedIds?.concat(r)??r.slice()),void(r.length=0);case A.KEEP:continue}E.filterInPlace(r,i.featureIds,(r=>!!G(t,e,r,d)||(h&&(p||=[],p.push(i.featureIds[r])),!1)))}p&&(i.weaklyRemovedIds=i.weaklyRemovedIds?.concat(p)??p)}!function(e){e[e.KEEP=0]="KEEP",e[e.DISCARD=1]="DISCARD",e[e.TEST=2]="TEST"}(A||(A={}));const L=P.fromValues(0,0,0,0);function N(e,t,r){const i={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:r},s=!C.isWGS84(r)&&!C.isWebMercator(r),n=Number.isNaN(t[3])?0:o.clamp(t[3],0,2*T.earth.radius),a=s?e.buffer(i,n,1):e.geodesicBuffer(i,n,1);return a.type="polygon",a}function U(e,t,r,i){switch(i){case"intersects":case"contains":return V(e,t,r);case"disjoint":return B(e,t,r)}}function V(e,t,r){return e.intersects(t,r)?e.contains(t,r)?A.KEEP:A.TEST:A.DISCARD}function B(e,t,r){return e.intersects(t,r)?e.contains(t,r)?A.DISCARD:A.TEST:A.KEEP}function G(e,t,r,i){const{collection:s,object:n,renderSR:o,maskSR:a,geometryTest:l,aabbCache:c}=i;let u=c.get(r);if(!u){const e=s.getObjectTransform(n);s.getComponentAabb(n,r,k);const t=[m.fromValues(k[0],k[1],0),m.fromValues(k[0],k[4],0),m.fromValues(k[3],k[4],0),m.fromValues(k[3],k[1],0)];for(let r=0;r<4;++r)p.transformMat3(t[r],t[r],e.rotationScale),p.add(t[r],t[r],e.position),v.projectVectorToVector(t[r],o,t[r],a);u={type:"polygon",rings:[t],spatialReference:a,cache:{}},u.rings[0][4]=u.rings[0][0],c.set(r,u)}switch(l(e,t,u)){case A.DISCARD:return!1;case A.KEEP:return!0}const{triangle:d,triangleTest:h,positions:f}=i,g=d.rings[0][0],y=d.rings[0][1],_=d.rings[0][2],b=s.getObjectTransform(n);s.getComponentPositions(n,r,f);const{indices:S,data:w,stride:x,startIndex:T,endIndex:C}=f;for(let r=T;r<C;r+=3){const i=x*S[r],s=x*S[r+1],n=x*S[r+2];switch(p.set(g,w[i],w[i+1],w[i+2]),p.set(y,w[s],w[s+1],w[s+2]),p.set(_,w[n],w[n+1],w[n+2]),p.transformMat3(g,g,b.rotationScale),p.transformMat3(y,y,b.rotationScale),p.transformMat3(_,_,b.rotationScale),p.add(g,g,b.position),p.add(y,y,b.position),p.add(_,_,b.position),v.projectVectorToVector(g,o,g,a),v.projectVectorToVector(y,o,y,a),v.projectVectorToVector(_,o,_,a),h(e,t,d)){case A.DISCARD:return!1;case A.KEEP:return!0}}return"intersects"!==i.type}const k=S.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/core/maybeUpdating":function(){define(["exports"],(function(e){"use strict";e.isUpdating=function(e){return"updating"===e},e.unwrapUpdating=function(e){return"updating"===e?null:e},e.updating="updating",Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SQueryEngine":function(){define(["require","exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/maybe","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../geometry/Extent","../../../../layers/LayerConstants","../../../../layers/graphics/data/QueryEngine","../../../../layers/support/FieldsIndex","../../../../rest/support/FeatureSet","../../../../rest/support/Query"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f){"use strict";const g=h.QueryEngine;t.I3SQueryEngine=class extends i{constructor(e){super(e)}initialize(){this.addHandles(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))))}destroy(){this._dataQueryEngineInstance=s.destroyMaybe(this._dataQueryEngineInstance),this._set("layerView",null)}get spatialReference(){return this.layerView.view.spatialReference}get layer(){return this.layerView.i3slayer}get defaultQueryJSON(){return new f({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:r,extent:i}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:u.fromJSON(i)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQuery(t,r){const i=this._ensureQueryJSON(t),s=await this._dataQueryEngine.executeQuery(i,r);if(t?.returnGeometry){const{processQueryGeometries:t}=await new Promise(((t,r)=>e(["./I3SQueryResultGeometry"],t,r)));return t(this.layerView,s)}return m.fromJSON(s)}_ensureQueryJSON(e){return null==e?this.defaultQueryJSON:e.toJSON()}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||d.fallbackObjectIDAttribute,t=this.layer.fieldsIndex?.toJSON()||new p([]),r=this.layerView.view.resourceController.scheduler,i=this.spatialReference.toJSON(),s=this.priority,n=this.spatialIndex;return this._dataQueryEngineInstance=new g({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fieldsIndex:t,timeInfo:null,spatialReference:i,featureIdInfo:{type:"object-id",fieldName:e},featureStore:n,scheduler:r,priority:s}),this._dataQueryEngineInstance}},r.__decorate([n.property({constructOnly:!0})],t.I3SQueryEngine.prototype,"layerView",void 0),r.__decorate([n.property({constructOnly:!0})],t.I3SQueryEngine.prototype,"priority",void 0),r.__decorate([n.property({constructOnly:!0})],t.I3SQueryEngine.prototype,"spatialIndex",void 0),r.__decorate([n.property()],t.I3SQueryEngine.prototype,"spatialReference",null),r.__decorate([n.property()],t.I3SQueryEngine.prototype,"layer",null),r.__decorate([n.property()],t.I3SQueryEngine.prototype,"defaultQueryJSON",null),t.I3SQueryEngine=r.__decorate([c.subclass("esri.views.3d.layers.i3s.I3SQueryEngine")],t.I3SQueryEngine),Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SQueryFeatureAdapter":function(){define(["exports","../../../../geometry/support/aaBoundingBox","../../../../layers/graphics/centroid","../../../../layers/graphics/OptimizedGeometry","./I3SBinaryReader"],(function(e,t,r,i,s){"use strict";class n{constructor(e,t,r,i){this.id=e,this.index=t,this.meta=r,this.geometry=i}get usedMemory(){return 32+(this.geometry?.usedMemory??0)}}const o=t.create();e.I3SQueryFeature=n,e.I3SQueryFeatureAdapter=class{constructor(e){this._objectIdField=e.objectIdField,this._getFeatureExtent=e.getFeatureExtent}getObjectId(e){return e.id}getAttributes(e){const{meta:t,index:r}=e,i={};this._objectIdField&&(i[this._objectIdField]=e.id);const n=t.attributeInfo?.attributeData;if(null!=n)for(const e of Object.keys(n))i[e]=s.getCachedAttributeValue(n[e],r);return i}getAttribute(e,t){if(t===this._objectIdField)return e.id;const{meta:r,index:i}=e,n=r.attributeInfo?.attributeData;return null!=n?s.getCachedAttributeValue(n[t],i):null}getGeometry(e){if(e.geometry)return e.geometry;const[t,r,s,n,a,l]=this._getFeatureExtent(e,o);return new i([5,5],[t,r,s,n,r,s,n,a,s,t,a,s,t,r,s,t,r,l,n,r,l,n,a,l,t,a,l,t,r,l])}getCentroid(e,t){if(e.geometry)return r.getCentroidOptimizedGeometry(new i,e.geometry,t.hasZ,t.hasM);const[s,n,a,l,c,u]=this._getFeatureExtent(e,o);return new i([0],[(s+l)/2,(n+c)/2,(a+u)/2])}cloneWithGeometry(e,t){const{id:r,index:i,meta:s}=e;return new n(r,i,s,t)}getMetadata(e){return e}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/DefinitionExpressionSceneLayerView":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../core/sql/WhereClause","../i3s/I3SUtil"],(function(e,t,r,i,s,n,o,a,l){"use strict";e.DefinitionExpressionSceneLayerView=e=>{let s=class extends e{constructor(){super(...arguments),this._definitionExpressionErrors=0,this._maxDefinitionExpressionErrors=20,this.logError=e=>{this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&r.getLogger(this).error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&r.getLogger(this).error("Further errors are ignored")}}get parsedDefinitionExpression(){if(!this.i3slayer?.definitionExpression)return null;try{const e=a.create(this.i3slayer.definitionExpression,{fieldsIndex:this.i3slayer.fieldsIndex});if(!e.isStandardized)return r.getLogger(this).error("definitionExpression is using non standard function"),null;const t=[],i=e.fieldNames;return l.findFieldsCaseInsensitive(i,this.i3slayer.fieldsIndex,{missingFields:t}),t.length>0?(r.getLogger(this).error(`definitionExpression references unknown fields: ${t.join(", ")}`),null):(this._definitionExpressionErrors=0,e)}catch(e){return r.getLogger(this).error("Failed to parse definitionExpression: "+e),null}}get definitionExpressionFields(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:[]}_evaluateClause(e,t){if(null==e)return!0;try{return e.testFeature(t)}catch(e){return this.logError(e),!1}}_addDefinitionExpressionToQuery(e){if(!this.parsedDefinitionExpression)return e;const t=this.i3slayer.definitionExpression,r=e.clone();return r.where?r.where=`(${t}) AND (${r.where})`:r.where=t,r}};return t.__decorate([i.property({readOnly:!0})],s.prototype,"parsedDefinitionExpression",null),t.__decorate([i.property({readOnly:!0})],s.prototype,"definitionExpressionFields",null),s=t.__decorate([o.subclass("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],s),s},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/fieldProperties":function(){define(["exports","../../../../layers/support/fieldUtils"],(function(e,t){"use strict";e.defineFieldProperties=function(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:r},requiredFields:i}=this;return e.outFields?t.fixFields(r,[...t.unpackFieldNames(r,e.outFields),...i]):t.fixFields(r,i)}}}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/SceneLayerViewRequiredFields":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/Accessor","../../../../core/AsyncUpdate","../../../../core/Logger","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/support/fieldUtils"],(function(e,t,r,i,s,n,o,a,l,c){"use strict";e.SceneLayerViewRequiredFields=class extends(i.AsyncUpdateMixin(r)){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:t},rendererFields:r,labelingFields:i,viewFilterFields:s}=this;return c.fixFields(e,[...t??[],...r??[],...i??[],...s??[]])}constructor(e){super(e)}initialize(){this.addHandles([this.autoUpdateAsync("rendererFields",(async()=>{const{fieldsIndex:e,renderer:t}=this.layer;return t?this._getFieldsAsync((r=>t.collectRequiredFields(r,e))):null})),this.autoUpdateAsync("labelingFields",(async()=>{const{layer:e}=this;return e.labelsVisible?this._getFieldsAsync((t=>c.collectLabelingFields(t,e))):null})),this.autoUpdateAsync("viewFilterFields",(()=>{const{layer:e,mergedFilter:t}=this.layerView;return this._getFieldsAsync((r=>c.collectFilterFields(r,e,t)))}))])}async _getFieldsAsync(e){const t=new Set;try{return await e(t),Array.from(t).sort()}catch(e){return s.getLogger(this).error(e),null}}},t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"layerView",void 0),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"layer",null),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"requiredFields",null),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"rendererFields",void 0),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"labelingFields",void 0),t.__decorate([n.property()],e.SceneLayerViewRequiredFields.prototype,"viewFilterFields",void 0),e.SceneLayerViewRequiredFields=t.__decorate([l.subclass("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],e.SceneLayerViewRequiredFields),Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/core/AsyncUpdate":function(){define(["exports","../chunks/tslib.es6","./Accessor","./Logger","./promiseUtils","./reactiveUtils","./accessorSupport/decorators/property","./accessorSupport/decorators/subclass"],(function(e,t,r,i,s,n,o,a){"use strict";const l=e=>{let r=class extends e{constructor(){super(...arguments),this._numUpdating=0}get updating(){return this._numUpdating>0}autoUpdateAsync(e,t){const r=s.debounce((async t=>{++this._numUpdating;try{const r=await t;this.destroyed||this._set(e,r)}catch(t){i.getLogger(this).warn(`Async update of "${String(e)}" failed. Async update functions should not throw exceptions.`)}--this._numUpdating}));return n.watch(t,r,n.initial)}};return t.__decorate([o.property({readOnly:!0})],r.prototype,"updating",null),t.__decorate([o.property()],r.prototype,"_numUpdating",void 0),r=t.__decorate([a.subclass("esri.core.AsyncUpdate")],r),r};e.AsyncUpdate=class extends(l(r)){},e.AsyncUpdate=t.__decorate([a.subclass("esri.core.AsyncUpdate")],e.AsyncUpdate),e.AsyncUpdateMixin=l,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/support/TemporalSceneLayerView":function(){define(["exports","../../../../chunks/tslib.es6","../../../../core/accessorSupport/decorators/property","../../../../core/has","../../../../core/Logger","../../../../core/RandomLCG","../../../../core/accessorSupport/decorators/subclass","../../../../layers/graphics/data/timeSupport","../../../../layers/support/FeatureFilter","../../../../layers/support/timeSupport","../i3s/I3SBinaryReader","../i3s/I3SUtil"],(function(e,t,r,i,s,n,o,a,l,c,u,d){"use strict";class h{constructor(e){this.attributeData=e}getAttribute(e,t){return u.getCachedAttributeValue(this.attributeData[t],e)}getAttributeAsTimestamp(e,t){const r=this.getAttribute(e,t);return"string"==typeof r?new Date(r).getTime():"number"==typeof r||null==r?r:null}}e.TemporalSceneLayerView=e=>{let i=class extends e{get timeExtent(){return c.combineTimeExtent(this.i3slayer,this.view?.timeExtent,this._get("timeExtent"))}get mergedFilter(){const{filter:e,timeExtent:t}=this;if(null==t)return e;const r=e?.clone()??new l;return null!=t&&(r.timeExtent=r.timeExtent?.intersection(t)??t),r}getTimeFilterDependencies(){const{timeInfo:e}=this.i3slayer;if(null==e)return[];const{startField:t,endField:r}=e;return[t,r]}addTimeFilter(e,t){if(null==t)return;const{timeInfo:r}=this.i3slayer;if(null==r)return;const{startField:i,endField:s,useTime:n}=r;if(!n||null==i&&null==s)return;const o=r.toJSON(),l=t.toJSON();e.push(((e,t)=>function(e,t,r,i){const s=t.attributeInfo?.attributeData;if(null==s)return;const{startTimeField:n,endTimeField:o}=r;if(null!=n&&null==s[n]||null!=o&&null==s[o])return;const l=a.getTimeOperator(r,i,new h(s));if(null==l)return;const{featureIds:c}=t;d.filterInPlace(e,c,l)}(e,t,o,l)))}};return t.__decorate([r.property({readOnly:!0})],i.prototype,"timeExtent",null),t.__decorate([r.property()],i.prototype,"mergedFilter",null),i=t.__decorate([o.subclass("esri.views.3d.layers.support.TemporalSceneLayerView")],i),i},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/layers/SceneLayerView":function(){define(["require","exports","../../chunks/tslib.es6","../../core/arrayUtils","../../core/Logger","../../core/maybe","../../core/maybeUpdating","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/projectionUtils","./LayerView"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p){"use strict";return t.default=class extends p{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryEngine=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return o.unwrapUpdating(this._layerFilter)}get _layerFilter(){const e=this.layer?.filter;if(null==e||e.geometries.length<1)return null;const t=this._geometryEngine;if(null==t||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return o.updating;const r=e.geometries.at(0).spatialReference,n=e.geometries.toArray().map((e=>{try{e=t.simplify(e)}catch(e){return s.getLogger(this).warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(null==e)return null;if(e.spatialReference.equals(r))return e;try{return h.project(e,r)}catch(e){return s.getLogger(this).warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}})).filter(i.isSome).sort(((e,t)=>e.extent.xmin-t.extent.xmin)),a=new Set,l=new Array,c=new Array;for(let e of n){const r=e.extent.xmin;if(l.length=0,a.forEach((i=>{if(r>=i.extent.xmax)return c.push(i),void a.delete(i);e.extent.ymin<=i.extent.ymax&&e.extent.ymax>=i.extent.ymin&&t.intersects(e,i)&&l.push(i)})),l.length>0){l.push(e);try{e=t.union(l)}catch(e){s.getLogger(this).warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}l.pop(),l.forEach((e=>a.delete(e)))}a.add(e)}return a.forEach((e=>c.push(e))),c.length>0?{spatialRelationship:e.spatialRelationship,geometries:c}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(null==e||e.geometries.length<=1)return!1;const t=e.geometries.at(0).spatialReference;return e.geometries.some((({spatialReference:e})=>!e.equals(t)&&!h.canProjectWithoutEngine(e,t)))}get layerFilterUpdating(){return o.isUpdating(this._layerFilter)}initialize(){const{signal:t}=this._abortController;l.whenOnce((()=>this.destroyed||!this._geometryEngine&&this.layer?.filter?.geometries?.length),t).then((async()=>{a.throwIfAbortError(t),this._geometryEngine=await new Promise(((t,r)=>e(["../../geometry/geometryEngine"],t,r)))})).catch(a.throwIfNotAbortError),this._projectionEngineLoaded=h.isLoaded(),l.whenOnce((()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine),t).then((async()=>{a.throwIfAbortError(t),await h.load(),this._projectionEngineLoaded=!0})).catch(a.throwIfNotAbortError)}destroy(){this._abortController=n.abortMaybe(this._abortController)}highlight(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}},r.__decorate([c.property()],t.default.prototype,"layer",void 0),r.__decorate([c.property()],t.default.prototype,"availableFields",null),r.__decorate([c.property()],t.default.prototype,"maximumNumberOfFeatures",null),r.__decorate([c.property({readOnly:!0})],t.default.prototype,"maximumNumberOfFeaturesExceeded",null),r.__decorate([c.property()],t.default.prototype,"filter",void 0),r.__decorate([c.property({readOnly:!0})],t.default.prototype,"layerFilter",null),r.__decorate([c.property({readOnly:!0})],t.default.prototype,"_layerFilter",null),r.__decorate([c.property()],t.default.prototype,"_geometryEngine",void 0),r.__decorate([c.property()],t.default.prototype,"_projectionEngineLoaded",void 0),r.__decorate([c.property()],t.default.prototype,"_filterNeedsProjectionEngine",null),r.__decorate([c.property()],t.default.prototype,"layerFilterUpdating",null),t.default=r.__decorate([d.subclass("esri.views.layers.SceneLayerView")],t.default),t.default}))},"esri/views/3d/layers/SceneLayerGraphicsView3D":function(){define(["require","../../../chunks/tslib.es6","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/memoryEstimations","../../../core/promiseUtils","../../../core/reactiveUtils","../../../core/uid","../../../core/accessorSupport/decorators/property","../../../core/RandomLCG","../../../core/accessorSupport/decorators/subclass","../../../chunks/vec32","../../../core/libs/gl-matrix-2/factories/vec3f64","../../../geometry/projection/projectBuffer","../../../geometry/projection/projectVectorToVector","../../../geometry/support/contains","../../../geometry/support/DoubleArray","../../../geometry/support/zscale","../../../layers/LayerConstants","../../../layers/graphics/dehydratedFeatures","../../../layers/graphics/dehydratedPoint","../../../layers/graphics/hydratedFeatures","../../../layers/graphics/controllers/I3SOnDemandController","../../../layers/support/FeatureFilter","../../../rest/support/Query","../../../support/basemapUtils","./I3SPointsWorkerHandle","./LayerView3D","./graphics/Graphics3DFeatureProcessor","./graphics/QueryEngine","./graphics/QueryEngineContext","./i3s/featureEditing","./i3s/I3SBinaryReader","./i3s/I3SGraphicsMap","./i3s/I3SOverrides","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/LayerViewPerformanceInfo","./support/PopupSceneLayerView","./support/SceneLayerViewRequiredFields","./support/TemporalSceneLayerView","../support/debugFlags","../support/orientedBoundingBox","../support/updatingProperties","../webgl-engine/lib/Attribute","../webgl-engine/lib/UpdatePolicy","../../layers/SceneLayerView","../../layers/support/popupUtils","../../support/HighlightDefaults","../../support/layerViewUtils","../../support/Scheduler"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z,Y,X,K){"use strict";const J=V.defineFieldProperties();class ee{constructor(e,t,r,i){this.graphics=e,this.featureIds=t,this.attributeInfo=r,this.node=i}get cachedMemory(){return this.graphics.reduce(((e,t)=>v.estimateSize(t)+e),n.estimateNumberArrayMemory(this.featureIds)+1024)}}let te=class extends(z.TemporalSceneLayerView(U.DefinitionExpressionSceneLayerView(G.PopupSceneLayerView(R.LayerView3D(Q))))){constructor(){super(...arguments),this.type="scene-layer-graphics-3d",this._queryEngine=null,this._memCache=null,this._interactiveEditingSessions=new Map,this._pendingEditsQueue=Promise.resolve(),this.loadedGraphics=new F.I3SGraphicsMap(((e,t,r)=>function(e,t,r){const i=t.attributeInfo;if(null==i?.loadedAttributes||null==i.attributeData)return!1;let s=!1;for(const{name:t}of i.loadedAttributes)if(i.attributeData[t]){const n=D.getCachedAttributeValue(i.attributeData[t],r);n!==e.attributes[t]&&(e.attributes[t]=n,s=!0)}return s}(e,t,r)),(e=>this.processor.graphicsCore.recreateGraphics(e))),this.holeFilling="always",this.progressiveLoadFactor=1,this.supportsHeightUnitConversion=!0,this._coordinatesOutsideExtentErrors=0,this._maxCoordinatesOutsideExtentErrors=20}tryRecycleWith(e,t){return e.url===this.layer.url&&this._i3sOverrides.isEmpty?e.load(t).then((()=>{o.throwIfAborted(t),N.checkRecyclable(this.layer,e,this._i3sOverrides),this.layer=e,this._i3sOverrides.destroy();const r=this.view.resourceController?.memoryController;this._i3sOverrides=new L.I3SOverrides({view:this.view,layer:e,memoryController:r}),s.destroyMaybe(this._queryEngine),this._setupQueryEngine(),this.processor.resetObjectStates()})):null}initialize(){this.addResolvingPromise(this.layer.indexInfo);const t=this.view.resourceController?.memoryController;this._i3sOverrides=new L.I3SOverrides({view:this.view,layer:this.layer,memoryController:t}),N.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode),this._fieldsHelper=new k.SceneLayerViewRequiredFields({layerView:this}),this._updatingHandles.add((()=>this.layer.rangeInfos),(e=>this._rangeInfosChanged(e)),a.initial),this._updatingHandles.add((()=>this.layer.renderer),((e,t)=>this._rendererChange(e,t))),this._updatingHandles.add((()=>[this.parsedDefinitionExpression,this.layer.excludeObjectIds]),(()=>this._filterChange())),this._set("processor",new E.Graphics3DFeatureProcessor({owner:this,preferredUpdatePolicy:$.UpdatePolicy.ASYNC,scaleVisibilityEnabled:!X.hasLayerBasedScaleVisibility(),filterVisibilityEnabled:!0,timeExtentEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,setUidToIdOnAdd:!1,dataExtent:this.layer.fullExtent,updateClippingExtent:e=>this._updateClippingExtent(e)})),this.processor.elevationAlignment?.events.on("invalidate-elevation",(({extent:e,spatialReference:t})=>this._controller.updateElevationChanged(e,t))),this.supportsHeightUnitConversion&&(this._verticalScale=_.getGeometryZScaler("point",this.layer.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.processor.when()),this._memCache=this.view.resourceController.memoryController.newCache(`psl-${this.uid}`),this._controller=new x({layerView:this}),N.containsDraco(this.layer.geometryDefinitions)&&(this._worker=new M.I3SPointsWorkerHandle((e=>this.view.resourceController.immediate.schedule(e)))),this.addHandles(this.layer.on("apply-edits",(e=>this._updatingHandles.addPromise(e.result)))),this.addHandles([this.layer.on("edits",(e=>{const t=this._pendingEditsQueue.then((()=>this._handleEdits(e))).then();this._pendingEditsQueue=t,this._updatingHandles.addPromise(t)})),a.watch((()=>j.debugFlags.I3S_TREE_SHOW_TILES),(t=>{if(t&&!this._treeDebugger){const t=this._controller.crsIndex;new Promise(((t,r)=>e(["./support/I3STreeDebugger"],t,r))).then((({I3STreeDebugger:e})=>{!this._treeDebugger&&j.debugFlags.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new e({lv:this,view:this.view,nodeSR:t}))}))}else t||!this._treeDebugger||j.debugFlags.I3S_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)}),a.initial)]),this.when((()=>{this._setupQueryEngine(),this._updatingHandles.add((()=>this.maximumNumberOfFeatures),(e=>this._controller.featureTarget=e),a.initial),this._updatingHandles.add((()=>this.suspended),(e=>{e&&this._removeAllNodeData()}))}))}destroy(){this._treeDebugger=s.destroyMaybe(this._treeDebugger),this._i3sOverrides=s.destroyMaybe(this._i3sOverrides),this._set("processor",s.destroyMaybe(this.processor)),this._controller=s.destroyMaybe(this._controller),this._queryEngine=s.destroyMaybe(this._queryEngine),this._worker=s.destroyMaybe(this._worker),this._memCache=s.destroyMaybe(this._memCache),this.loadedGraphics.clear(),this._fieldsHelper=s.destroyMaybe(this._fieldsHelper)}get i3slayer(){return this.layer}get layerViewUid(){return this.uid}get updatingProgressValue(){return this._controller?.updatingProgress??1}get visibleAtCurrentScale(){return X.hasLayerBasedScaleVisibility()?X.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale):!this.processor?.scaleVisibilitySuspended}get requiredFields(){return this._fieldsHelper?.requiredFields??[]}get maximumNumberOfFeatures(){const e=this.processor?.graphicsCore?.displayFeatureLimit;return e?.maximumNumberOfFeatures??0}set maximumNumberOfFeatures(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)}get maximumNumberOfFeaturesExceeded(){return!this.suspended&&!!this._controller?.useMaximumNumberOfFeatures&&!this._controller.leavesReached}get _excludeObjectIds(){return new Set(this.layer.excludeObjectIds)}get lodFactor(){return"Labels"===this.layer.semantic?1:this.view.qualitySettings.sceneService.point.lodFactor}get hasM(){return!1}get hasZ(){return!0}get contentVisible(){return!this.suspended&&!!this._controller?.rootNodeVisible}get legendEnabled(){return this.contentVisible&&!0===this.i3slayer?.legendEnabled}async whenGraphicAttributes(e,t){return N.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,(()=>[...this.loadedGraphics.nodes()]))}getHit(e){if(!this.loadedGraphics)return null;const t=w.hydrateGraphic(this.loadedGraphics.find((t=>t.uid===e)),this.layer),r=this._getObjectIdField();return t?.attributes?.[r]?(t.layer=this.layer,t.sourceLayer=this.layer,{type:"graphic",graphic:t,layer:t.layer}):null}whenGraphicBounds(e,t){return this.processor.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor.computeAttachmentOrigin(e,t)}isUpdating(){return!!(this._controller?.updating||this.processor?.updating||this._fieldsHelper?.updating||this.layerFilterUpdating)}highlight(e,t){return this.processor.highlight(e,this.layer.objectIdField,t?.name??Y.defaultHighlightName)}get updatePolicy(){return this.processor.graphicsCore.effectiveUpdatePolicy}createInteractiveEditSession(e){return I.createInteractiveEditSession(this._attributeEditingContext,e)}async _decompressBinaryPointData(e,t){const r={geometryBuffer:e.geometryBuffer};null==this._worker&&(this._worker=new M.I3SPointsWorkerHandle((e=>this.view.resourceController.immediate.schedule(e))));const i=await this._worker.invoke(r,t);if(null==i)throw new Error("Failed to decompress Draco point data");return{positionData:i.positions,featureIds:i.featureIds}}async addNode(e,t,r){if(!ie(t)&&!function(e){return"pointData"in e}(t))throw new Error;if(this.loadedGraphics.hasNode(e.index))return void i.getLogger(this).error("I3S node "+e.id+" already added");const s=null!=this.layer.fullExtent?(c=.5,(l=this.layer.fullExtent.clone()).xmin-=c,l.ymin-=c,l.xmax+=c,l.ymax+=c,null!=l.zmin&&null!=l.zmax&&(l.zmin-=c,l.zmax+=c),null!=l.mmin&&null!=l.mmax&&(l.mmin-=c,l.mmax+=c),l):null,{featureIds:n,pointPositions:o}=ie(t)?await this._extractBinaryPointPositions(e,t,r):this._extractLegacyPointPositions(t),a=new Array;var l,c;this._validatePositions(e,n,o,s,a);const u=this._controller.crsVertex,d=this.view.spatialReference;m.projectBuffer(o,u,0,o,d,0,n.length);const h=ie(t)?e.level:0,p=this._createGraphics(n,o,e.index,h),f=new ee(p,n,t.attributeDataInfo,e);if(await this._i3sOverrides.applyAttributeOverrides(f.featureIds,t.attributeDataInfo,r),e.numFeatures=f.graphics.length,this._updateNodeMemory(e),se(f),a.length>0&&(this._computeObb(e,a,u),this._controller.updateVisibility(e.index)),!this._controller.isGeometryVisible(e))return void this._cacheNodeData(f);if(null!=this._verticalScale)for(const e of f.graphics)this._verticalScale(e.geometry);const g=this.view.stage.renderView.olidRenderHelper;if(g){const e=P.isBasemapLayerView(this.view,this.uid);for(let t=0;t<f.featureIds.length;t++){const r=f.featureIds[t];g.setUidToObjectAndLayerId(r,f.graphics[t].uid,this.layer.id,this.uid,this.layer.popupEnabled&&!e&&Z.hasPopupTemplate(this.layer,this.view.popup?.defaultPopupTemplateEnabled),f.node.resources.attributes,t)}}this.loadedGraphics.addNode(e.index,f),this._controller.updateLoadStatus(e.index,!0),this._filterNode(f),this._treeDebugger&&this._treeDebugger.update()}_computeObb(e,t,r){const i=this._controller.crsIndex,s=i.isGeographic?this.view.renderSpatialReference:i;m.projectBuffer(t,r,0,t,s,0),e.serviceObbInIndexSR=q.compute(new W.Vertices(t,3)),i.isGeographic&&(f.projectVectorToVector(e.serviceObbInIndexSR.center,s,oe,i),e.serviceObbInIndexSR.center=oe)}isNodeLoaded(e){return this.loadedGraphics.hasNode(e)}isNodeReloading(){return!1}updateNodeState(){}getNodeComponentHandle(){}async _extractBinaryPointPositions(e,t,r){const i=await this._decompressBinaryPointData(t,r),s=i.positionData,n=s.length/3,o=y.newDoubleArray(3*n),a=null!=e.serviceObbInIndexSR?e.serviceObbInIndexSR.center:p.ZEROS,l=Math.abs(a[2])*2**-20;for(let e=0;e<n;e++){const t=3*e;o[t]=s[t]+a[0],o[t+1]=s[t+1]+a[1],o[t+2]=s[t+2]+a[2],Math.abs(o[t+2])<l&&(o[t+2]=0)}return{featureIds:i.featureIds?y.doubleArrayFrom(i.featureIds):[],pointPositions:o}}_extractLegacyPointPositions(e){const t=e.pointData.length,r=y.newDoubleArray(3*t),i=new Array;for(let s=0;s<t;s++){const t=e.pointData[s],n=t.featureDataPosition,o=n.length,a=t.geometries?.[0]??ne[o],l=t.featureIds[0];if("Embedded"!==a.type||"points"!==a.params.type||o<2||o>3)continue;const c=a.params.vertexAttributes?.position??[0,0,0],u=3*i.length;r[u]=n[0]+c[0],r[u+1]=n[1]+c[1],r[u+2]=3===o?n[2]+c[2]:NaN,i.push(l)}return{featureIds:i,pointPositions:r}}_validatePositions(e,t,r,s,n){if(null==s&&e.serviceObbInIndexSR)return;const o=t.length;for(let t=0;t<o;t++){const o=3*t;h.set(oe,r[o],r[o+1],r[o+2]);const a=!Number.isNaN(r[2]);null==s||(a?g.extentContainsCoords3D(s,oe):g.extentContainsCoords2D(s,oe))||(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&i.getLogger(this).error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&i.getLogger(this).error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++),e.serviceObbInIndexSR||n.push(oe[0],oe[1],oe[2])}}_createGraphics(e,t,r,i){const s=e.length,n=this._getObjectIdField(),o=this.processor.graphicsCore,a=new Array,c=this.view.spatialReference;for(let u=0;u<s;u++){const s=e[u],d={};null!=s&&(d[n]=s);const h=s??l.generateUID(),p=3*u,m=isNaN(t[p+2])?void 0:t[p+2],f=S.makeDehydratedPoint(t[p],t[p+1],m,c),g=this.loadedGraphics.get(h);if(null!=g)(null==g.level||g.level<i)&&(ae.property="geometry",ae.graphic=g,ae.oldValue=g.geometry,ae.newValue=f,g.geometry=f,g.level=i,o.graphicUpdateHandler(ae)),a.push(g);else{const e=l.generateUID();a.push({objectId:h,uid:e,geometry:f,attributes:d,visible:!0,nodeIndex:r,level:i})}}return a}_updateNodeMemory(e){e.memory=4096+(e.numFeatures??0)*this.processor.graphicsCore.usedMemoryPerGraphic}_cacheNodeData(e){this._memCache.put(this._getMemCacheKey(e.node),e)}_getMemCacheKey(e){return`${e.index}`}_removeAllNodeData(){this.loadedGraphics.forEachNode(((e,t)=>{if(e){const t=e.node;this._updateNodeMemory(t),this._cacheNodeData(e)}this._controller.updateLoadStatus(t,!1)})),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()}removeNode(e){const t=this._removeNodeStageData(e);t&&(this._updateNodeMemory(t.node),this._cacheNodeData(t))}_removeNodeStageData(e){const t=this.loadedGraphics.getNode(e);return null==t?null:(this._controller.updateLoadStatus(e,!1),this.loadedGraphics.removeNode(e),this._treeDebugger&&this._treeDebugger.update(),t)}async loadCachedNodeData(e){return this._memCache?.pop(this._getMemCacheKey(e))}async addCachedNodeData(e,t,r,s){this.loadedGraphics.hasNode(e.index)?i.getLogger(this).error("I3S node "+e.id+" already added"):(await this._i3sOverrides.applyAttributeOverrides(t.featureIds,r,s),t.attributeInfo=r,this.loadedGraphics.addNode(e.index,t),this._controller.updateLoadStatus(e.index,!0),this._updateNodeMemory(e),se(t),this._filterNode(t),this._treeDebugger&&this._treeDebugger.update())}getLoadedNodeIds(){const e=[];return this.loadedGraphics.forEachNode((t=>e.push(t.node.id))),e.sort()}getVisibleNodes(){const e=new Array;return this.loadedGraphics.forEachNode((t=>e.push(t.node))),e}getLoadedNodeIndices(e){this.loadedGraphics.forEachNode(((t,r)=>e.push(r)))}getLoadedAttributes(e){const t=this.loadedGraphics.getNode(e);if(null!=t?.attributeInfo)return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this.loadedGraphics.getNode(e);if(null!=t?.attributeInfo)return t.attributeInfo.attributeData}_setAttributeData(e,t){const r=this.loadedGraphics.getNode(e);null!=r?.attributeInfo&&(r.attributeInfo.attributeData=t,this._attributeValuesChanged(r))}async updateAttributes(e,t,r){const i=this.loadedGraphics.getNode(e);null!=i&&(await this._i3sOverrides.applyAttributeOverrides(i.featureIds,t,r),i.attributeInfo=t,this._attributeValuesChanged(i))}_attributeValuesChanged(e){se(e),this._filterNode(e);const{processor:t}=this,{graphicsCore:r}=t;if(r.labelsEnabled){const t=e.node.index,i=new Array;e.graphics.forEach((e=>e.nodeIndex===t&&i.push(e.uid))),r.updateLabelingInfo(i)}t.refreshFilter()}_updateClippingExtent(e){return this._controller&&this._controller.updateClippingArea(e),!1}_getObjectIdField(){return this.layer.objectIdField||b.fallbackObjectIDAttribute}_getGlobalIdField(){return this.layer.globalIdField}async _rendererChange(e,t){const{layer:{fieldsIndex:r}}=this,i=new Set;let s,n;e?(await e.collectRequiredFields(i,r),s=Array.from(i).sort()):s=[],i.clear(),t?(await t.collectRequiredFields(i,r),n=Array.from(i).sort()):n=[],s.length===n.length&&s.every(((e,t)=>s[t]===n[t]))||this._reloadAllNodes()}_rangeInfosChanged(e){null!=e&&e.length>0&&i.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}_filterChange(){this.loadedGraphics.forEachNode((e=>this._filterNode(e)))}_reloadAllNodes(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()}_filterNode(e){const t=this.parsedDefinitionExpression,r=this._excludeObjectIds,i=this._getObjectIdField();for(const s of e.graphics){const e=s.visible,n=this._evaluateClause(t,s),o=!r.has(s.attributes[i]);s.visible=n&&o,e!==s.visible&&(ae.graphic=s,ae.property="visible",ae.oldValue=e,ae.newValue=s.visible,this.processor.graphicsCore.graphicUpdateHandler(ae))}}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return this.filter?.createQuery(e)??new C(e)}queryFeatures(e,t){return this._queryEngine.executeQuery(this._ensureQuery(e),t?.signal)}queryObjectIds(e,t){return this._queryEngine.executeQueryForIds(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this._queryEngine.executeQueryForCount(this._ensureQuery(e),t?.signal)}queryExtent(e,t){return this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t?.signal)}_ensureQuery(e){return this._addDefinitionExpressionToQuery(null==e?this.createQuery():C.from(e))}_setupQueryEngine(){const{layer:e,view:t,hasM:r,hasZ:i}=this,{spatialReference:s,resourceController:n}=t,o=new A.QueryEngineContext(s,e,n,(()=>this.processor.featureStore),i,r);this._queryEngine=new O.QueryEngine({context:o,priority:K.TaskPriority.FEATURE_QUERY_ENGINE})}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return.8*((this._controller?.unloadedMemoryEstimate??0)+(this.processor?.graphicsCore?.unprocessedMemoryEstimate??0))}get ignoresMemoryFactor(){return this._controller&&this._controller.fixedFeatureTarget}async _handleEdits(e){const t=this._attributeEditingContext,r=await I.normalizeEditResultsEvent(t,e);I.processAttributeEdits(t,r)}get _attributeEditingContext(){const e=this._getObjectIdField(),t=this._getGlobalIdField();return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:e,globalIdField:t,forEachNode:e=>this.loadedGraphics.forEachNode((t=>e(t.node,t.featureIds))),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this._i3sOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(t,r,i)=>{this._setAttributeData(t,r);const s=this.loadedGraphics.getNode(t);if(null!=i){const t=this.loadedGraphics.get(i.attributes[e]);null!=t&&this.processor.graphicsCore.recreateGraphics([t])}else null!=s&&this.processor.graphicsCore.recreateGraphics(s.graphics)},clearMemCache:()=>{}}}get performanceInfo(){return new B.LayerViewPerformanceInfo(this.usedMemory,this.loadedGraphics.length,-1,this.maximumNumberOfFeatures,this.loadedGraphics.nodeCount,this.processor.graphicsCore.performanceInfo)}get test(){}};t.__decorate([c.property()],te.prototype,"processor",void 0),t.__decorate([c.property({type:T})],te.prototype,"filter",void 0),t.__decorate([c.property()],te.prototype,"loadedGraphics",void 0),t.__decorate([c.property()],te.prototype,"i3slayer",null),t.__decorate([c.property()],te.prototype,"layerViewUid",null),t.__decorate([c.property()],te.prototype,"_controller",void 0),t.__decorate([c.property()],te.prototype,"updating",void 0),t.__decorate([c.property()],te.prototype,"suspended",void 0),t.__decorate([c.property(H.updatingProgress)],te.prototype,"updatingProgress",void 0),t.__decorate([c.property()],te.prototype,"updatingProgressValue",null),t.__decorate([c.property({readOnly:!0})],te.prototype,"visibleAtCurrentScale",null),t.__decorate([c.property(J.requiredFields)],te.prototype,"requiredFields",null),t.__decorate([c.property(J.availableFields)],te.prototype,"availableFields",void 0),t.__decorate([c.property()],te.prototype,"_fieldsHelper",void 0),t.__decorate([c.property({type:Number})],te.prototype,"maximumNumberOfFeatures",null),t.__decorate([c.property({readOnly:!0})],te.prototype,"maximumNumberOfFeaturesExceeded",null),t.__decorate([c.property()],te.prototype,"_excludeObjectIds",null),t.__decorate([c.property({readOnly:!0})],te.prototype,"lodFactor",null),t.__decorate([c.property({readOnly:!0})],te.prototype,"hasM",null),t.__decorate([c.property({readOnly:!0})],te.prototype,"hasZ",null),t.__decorate([c.property()],te.prototype,"contentVisible",null),t.__decorate([c.property({readOnly:!0})],te.prototype,"legendEnabled",null),te=t.__decorate([d.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],te);const re=te;function ie(e){return"geometryBuffer"in e&&null!==e.geometryBuffer}function se(e){const t=e.attributeInfo;if(null==t?.loadedAttributes||null==t.attributeData)return;const r=e.node.index;for(let i=0;i<e.graphics.length;i++){const s=e.graphics[i];if(s.nodeIndex===r){s.attributes||(s.attributes={});for(const{name:e}of t.loadedAttributes)t.attributeData[e]&&(s.attributes[e]=D.getCachedAttributeValue(t.attributeData[e],i))}}}const ne={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},oe=p.create(),ae={graphic:null,property:null,oldValue:null,newValue:null};return re}))},"esri/views/3d/layers/I3SPointsWorkerHandle":function(){define(["exports","../../../core/workers/WorkerHandle"],(function(e,t){"use strict";class r extends t.WorkerHandle{constructor(e){super("SceneLayerWorker","dracoDecompressPointCloudData",{dracoDecompressPointCloudData:e=>[e.geometryBuffer]},e,{hasInitialize:!0})}}e.I3SPointsWorkerHandle=r,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"esri/views/3d/layers/i3s/I3SGraphicsMap":function(){define(["exports","../../../../core/Evented","../../../../core/has","../../../../core/MapUtils"],(function(e,t,r,i){"use strict";e.I3SGraphicsMap=class extends t{constructor(e,t){super(),this._updateAndCompare=e,this._notifyUpdated=t,this._nodes=new Map,this._graphics=new Map,this._duplicates=new Map}clear(){if(this._graphics.size>0){const e=this.toArray();this._graphics.clear(),this.emit("change",{added:[],removed:e})}this._nodes.clear()}get length(){return this._graphics.size}get(e){return this._graphics.get(e)}getNode(e){return this._nodes.get(e)}hasNode(e){return this._nodes.has(e)}nodes(){return this._nodes.values()}addNode(e,t){this._nodes.set(e,t);const r=t.graphics;if(0===r.length)return;const i=new Set;for(let t=0;t<r.length;t++){const s=r[t],n=s.objectId,o=this._graphics.get(n);if(o){i.add(n),s!==o&&(r[t]=o);const a=this._duplicates.get(n);a?a.push(e):this._duplicates.set(n,[o.nodeIndex,e])}else s.nodeIndex=e,this._graphics.set(n,s)}i.size&&this._updateForeignGraphics(t);const s=i.size>0?r.filter((e=>!i.has(e.objectId))):r;s.length>0&&this.emit("change",{added:s,removed:[]})}removeNode(e){const t=this._nodes.get(e);if(!t)return;this._nodes.delete(e);const r=new Set,i=[];for(const s of t.graphics){const t=s.objectId,n=this._graphics.get(t);if(!n)continue;const o=this._duplicates.get(t);if(o){const i=o.indexOf(e);if(-1===i)continue;if(o.splice(i,1),n.nodeIndex===e){let e=this.getNode(o[0]);for(let t=1;t<o.length;t++){const r=this.getNode(o[t]);(null==e||null!=r&&r.node.level>e.node.level)&&(e=r)}null!=e&&r.add(e)}1===o.length&&this._duplicates.delete(t)}else this._graphics.delete(t),i.push(s)}i.length>0&&this.emit("change",{added:[],removed:i}),r.forEach((e=>this._updateForeignGraphics(e)))}_updateForeignGraphics(e){const t=[],r=e.node.index,i=e.node.level;let s=0;for(;s<e.graphics.length;){const n=e.graphics[s].nodeIndex;if(n===r){s++;continue}let o=1;for(;s+o<e.graphics.length&&e.graphics[s+o].nodeIndex===n;)o++;const a=this.getNode(n);if(null!=a&&a.node.level>i)s+=o;else{for(let i=s;i<s+o;i++){const s=e.graphics[i];s.nodeIndex=r,this._updateAndCompare(s,e,i)&&t.push(s)}s+=o}}t.length>0&&this._notifyUpdated(t)}toArray(){return Array.from(this._graphics.values())}find(e){return i.findInMap(this._graphics,e)}some(e){return i.someMap(this._graphics,e)}forEach(e){this._graphics.forEach((t=>e(t)))}forEachNode(e){this._nodes.forEach(((t,r)=>e(t,r)))}get nodeCount(){return this._nodes.size}_checkInvariants(){const e=new Map;this._nodes.forEach(((t,r)=>{t.graphics.forEach((t=>{e.set(t.objectId,1+(e.get(t.objectId)??0)),this._duplicates.get(t.objectId)}))})),e.forEach(((e,t)=>{const r=this._graphics.get(t);if(!r)return;if(!this._nodes.get(r.nodeIndex))return;const i=this._duplicates.get(t);i&&i.forEach((e=>{this._nodes.get(e)}))}))}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}))},"*noref":1}}),define(["require","../chunks/tslib.es6","../Camera","../Viewpoint","../core/Collection","../core/domUtils","../core/Error","../core/events","../core/handleUtils","../core/has","../core/Logger","../core/maybe","../core/ObservableChangesType","../core/promiseUtils","../core/reactiveUtils","../core/scheduling","../core/screenUtils","../core/unitUtils","../core/workers/workers","../core/accessorSupport/decorators/property","../core/accessorSupport/decorators/cast","../core/RandomLCG","../core/accessorSupport/decorators/subclass","../core/accessorSupport/ensureType","../core/accessorSupport/overrideDefaultsFrom","../core/libs/gl-matrix-2/factories/vec3f64","../core/support/OwningCollection","../geometry/Extent","../geometry/HeightModelInfo","../geometry/Point","../geometry/projectionUtils","../geometry/SpatialReference","../geometry/projection/projectBoundingRect","../geometry/projection/projectPointToVector","../geometry/support/aaBoundingRect","../geometry/support/coordinateSystem","../geometry/support/scaleUtils","../layers/support/layerUtils","../support/AnalysesCollection","../support/tagSymbols","./BreakpointsOwner","./DOMContainer","./GroundView","./PopupView","./View","./ViewAnimation","./ViewingMode","./3d/layerViewModuleImportUtils","./3d/analysis/AnalysisViewManager3D","./3d/constraints/Constraints","./3d/environment/EnvironmentManager","./3d/environment/SceneViewEnvironment","./3d/input/SceneInputManager","./3d/layers/graphics/GraphicsDeconflictor","./3d/layers/graphics/Labeler","./3d/layers/support/FeatureTileTree3D","./3d/state/ViewState","./3d/state/ViewStateManager","./3d/state/helpers/SceneIntersectionHelper","./3d/support/CombinedElevationProvider","./3d/support/debugFlags","./3d/support/DisplayQualityProfile","./3d/support/ElevationProvider","./3d/support/hitTest","./3d/support/popupHitTest","./3d/support/QualitySettings","./3d/support/RenderCoordsHelper","./3d/support/ResourceController","./3d/support/SceneViewPerformanceInfo","./3d/support/SharedSymbolResources","./3d/support/ViewSlice","./3d/support/pointsOfInterest/PointsOfInterest","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/effects/geometry/olidUtils","./3d/webgl-engine/lib/Intersector","./3d/webgl-engine/lib/verticalOffsetUtils","./support/HighlightDefaults","./support/HighlightOptions","./support/layerViewUtils","./support/screenUtils","./support/spatialReferenceSupport","./support/TextureCompressionHelper","./support/WebGLRequirements","./ui/DefaultUI","./ui/3d/DefaultUI3D","../webscene/Environment"],(function(e,t,r,i,s,n,o,a,l,c,u,d,h,p,m,f,g,y,_,b,v,S,w,x,T,C,P,M,R,E,O,A,I,D,F,L,N,U,V,B,G,k,z,j,q,H,W,$,Q,Z,Y,X,K,J,ee,te,re,ie,se,ne,oe,ae,le,ce,ue,de,he,pe,me,fe,ge,ye,_e,be,ve,Se,we,xe,Te,Ce,Pe,Me,Re,Ee,Oe,Ae,Ie,De){"use strict";const Fe=e=>Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}));let Le=class extends(G.BreakpointsOwner(j.PopupView(k.DOMContainer(q)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._resolveWhenReady=[],this._resourceController=pe.newResourceController(this),this.deconflictor=new J.GraphicsDeconflictor({view:this}),this.labeler=new ee.Labeler({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new V.AnalysesCollection,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Z.Constraints,this.environment=new X,this.environmentManager=new Y.EnvironmentManager,this.floors=new s,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new Q({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new re({view:this}),this.slice=new ge.ViewSlice,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new Ie,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this._importControllers=new Map,_.initialize();const t=(e=null)=>{null!=e&&e.type===h.ObservableChangesType.MOVE||(this._updatingChanged(),this.map?.allLayers.forEach((async e=>{try{await e.when()}catch{}this._updatingChanged()})))};this.addHandles([m.on((()=>this.map?.allLayers),"after-changes",(e=>t(e)),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),m.watch((()=>this.scene),(e=>e?.load().catch((()=>{}))))]),this.inputManager=new K({view:this}),this.stateManager=new ie.ViewStateManager({view:this})}initialize(){if(c("enable-feature:esri-compress-textures")&&c("wasm-simd")){const e=Ee.initializeTextureCompressionWorker(this,this.resourceController);this.addResolvingPromise(e.promise)}this.groundView=new z({view:this}),this._updateUpdatingMonitors(),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),m.initial),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),m.initial),this.updatingHandles.add((()=>this.qualitySettings.frameRate??0),(e=>f.setFrameDuration(e>0?1e3/Math.ceil(e):0)),m.initial),this.addHandles([m.watch((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),m.sync),m.watch((()=>({plane:this.slice.plane,isDecoration:this.slice.isDecoration})),(()=>this._updateSlice()),m.sync)])}destroy(){this.destroyed||(Ee.destroyTextureCompressionWorker(this),this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",d.destroyMaybe(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this.sharedSymbolResources=d.destroyMaybe(this.sharedSymbolResources),this._set("labeler",d.destroyMaybe(this.labeler)),this._set("deconflictor",d.destroyMaybe(this.deconflictor)),this._resourceController=d.destroyMaybe(this._resourceController),this._set("stateManager",d.destroyMaybe(this.stateManager)),this._set("inputManager",d.destroyMaybe(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",d.destroyMaybe(this.environmentManager)),this._set("environment",d.destroyMaybe(this.environment)),this.groundView=d.destroyMaybe(this.groundView),this._exitBasemapTerrain(),this.stage?.destroy(),this.slice.destroy())}get stage(){return this._stage}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||d.maybeProperty(e,"clippingArea");return!this._userClippingArea&&!d.maybeProperty(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof M?this.spatialReference&&(t=Ne(t,this.spatialReference),null==t)?(u.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(u.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?u.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===W.ViewingMode.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:Ne(t,e)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||A.WGS84,r=Ne(this.clippingArea,t);null!=r&&(e=null!=e?e.intersection(r):r);const i=this._get("dataExtent");return null!=e&&e.equals(i)?i:e}get _groundAndLayersExtent(){const e=this.spatialReference||A.WGS84;let t;const r=r=>{const i=Ne(r,e);null!=i&&(null!=t?t.union(i):t=i.clone())},i=this.basemapTerrain;if(i?.spatialReference){const e=i.groundExtent;r(new M({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:i.spatialReference}))}if(this.map?.allLayers.forEach((e=>(e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||r(e.fullExtent)})(e))),null==t)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const s=this._get("_groundAndLayersExtent");return t.equals(s)?s:t}castEnvironment(e){return e?e instanceof X?e:e instanceof De?this.environment?.cloneWithWebsceneEnvironment(e)??X.fromWebsceneEnvironment(e):x.ensureType(X,e):new X}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get scene(){return this.map&&B.WebSceneTag in this.map?this.map:null}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){ae.isValidProfile(e)&&(ae.apply(e,this.qualitySettings),this.stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||ae.getDefaultProfile()}_updateSlice(){null!=this.stage&&(this.stage.renderer.slice=this.slice)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return null!=this.spatialReference?N.getResolutionForScale(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?R.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroying||this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,r=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((i=>{if(i.isFulfilled()){if(i.updating){if(t=!0,i.suspended||be.isSurfaceLayerView(i))return;++r,e+=i.updatingProgress}}else++r}));for(const t of this._updatingObjects)if(null!=t&&t.updating){const t=.1;r+=t,e+=.5*t}for(const t of this._updatingObjectsWithProgress)null!=t&&t.updating&&(++r,e+=t.updatingProgress);const i=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||r>0||this.updatingHandles.updating||!this.ready||!this.stationary||i||this._importControllers.size>0||this.inputManager?.updating||this.map?.allLayers?.some((e=>!e.isFulfilled()))),t?(this._numUpdating=Math.max(r,this._numUpdating),e+=this._numUpdating-r):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const r=performance.now();if(e<1){const t=Math.min((r-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?r:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this.stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const e=this._predeterminedViewingMode;if(null!=e)return W.stringFromViewingMode(e);const t=this.spatialReference;return t?null!=this.defaultsFromMap?.viewingMode&&t.equals(this.defaultsFromMap.spatialReference)?W.stringFromViewingMode(this.defaultsFromMap.viewingMode):Re.isSpatialReferenceSupported(t,W.ViewingMode.Global)?"global":"local":"global"}set viewingMode(e){this.ready?u.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get highlightOptions(){return this.highlights.find((({name:e})=>e===Te.defaultHighlightName))??new Ce}set highlightOptions(e){for(let t=0;t<this.highlights.length;++t)if(this.highlights.at(t).name===Te.defaultHighlightName)return void this.highlights.items[t].assignFrom(e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new me(this)}on(e,t,r,i){return this.viewEvents.on(e,t,r,i)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return u.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const r=Me.isSupportedScreenPointEvent(e)?Me.createScreenPointFromSupportedEvent(this,e):e;return ce.toMap(this,r,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return u.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(null==e.z?le.getElevationAtPoint(this.elevationProvider,e):null)??0;return D.projectPointToVector(e,Ue,this.renderSpatialReference,t),this.state.camera.projectToScreen(Ue,Ve),g.createScreenPoint(Ve[0],Ve[1])}pixelSizeAt(e,t){if(!this.ready)return u.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!e)return 0;const r=this.renderSpatialReference;D.projectPointToVector(e,Ue,r);const i=this.state.camera.computeScreenPixelSizeAt(Ue);return t&&r!==t?i*y.getMetersPerUnitForSR(r)/y.getMetersPerUnitForSR(t):i}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,(()=>this.pixelSizeAt(e))):1}hitTest(e,t){if(!this.ready)return u.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const r=Me.isSupportedScreenPointEvent(e)?Me.createScreenPointFromSupportedEvent(this,e):e;return ce.hitTest(this,r,t,this._defaultHitTestOptions)}async popupHitTest(e){return ue.popupHitTest(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new o("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(t){const r=await this._completeSettings(t);await this.whenReady();const i=await this.stage.renderView.takeScreenshot(r);return(await new Promise(((t,r)=>e(["./support/screenshotUtils"],t,r)))).encode(i,r,this._pixelFormat())}async _takeScreenshot(t){const r=await this._completeSettings(t);await this.whenReady();const i=await this.stage.renderView.takeScreenshot(r);return(await new Promise(((t,r)=>e(["./support/screenshotUtils"],t,r)))).encodeData(i,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(t){const r=await this._completeSettings(t);await this.whenReady();const i=await this.stage.renderView.takeScreenshotWithOID(r),{encodeData:s}=await new Promise(((t,r)=>e(["./support/screenshotUtils"],t,r)));return[s(i[0],this._pixelFormat()),s(i[1],this._pixelFormat())]}async _completeSettings(t){const{toRenderSettings:r,screenshotSuperSampleSettings:i}=await new Promise(((t,r)=>e(["./support/screenshotUtils"],t,r))),s=r(t,this);return s.pixelRatio/=this.state.pixelRatio,i(s,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this.stage?.renderView.getAlpha()??!1}}get test(){}async takeScreenshotWithObjectAndLayerId(t){if(!Se.olidEnabled())throw new o("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:r}=await new Promise(((t,r)=>e(["./support/screenshotUtils"],t,r))),i=await this._completeSettings(t);await this.whenReady();const s=await this.stage.renderView.takeScreenshotWithOID(i),n=r(s[0],i,this._pixelFormat()),a=await this._completeSettings(t);return a.format="png",[n,r(s[1],a,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const e=this.stage.renderView.olidRenderHelper;if(e)return e.getColorToObjectAndLayerIdMapping();throw new o("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return $.layerView3DImporter.importLayerView(e)}hasLayerViewModule(e){return $.layerView3DImporter.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.scene?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=Oe.check(this.type);const t=c("safari");if(t&&t<9&&(e=new o("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw u.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):this.scene?.initialViewProperties?.viewingMode;return null!=e?W.viewingModeFromString(e):null}getSpatialReferenceSupport(e,t){const r=this._predeterminedViewingMode;if(null!=r)return this._validateSpatialReferenceForViewingMode(e,t,r)?{constraints:this._makeSpatialReferenceConstraints(e,t,r)}:null;const i=this._validateSpatialReferenceForViewingMode(e,t,W.ViewingMode.Local),s=this._validateSpatialReferenceForViewingMode(e,t,W.ViewingMode.Global);return i||s?i&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:i?{constraints:this._makeSpatialReferenceConstraints(e,t,W.ViewingMode.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,W.ViewingMode.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,r){return!(!Re.isSpatialReferenceSupported(e,r)||null!=t&&!U.isImageryTileLayer(t)&&(U.isTiledLayer(t)&&null==be.getTiledLayerInfo(t,e,r)||U.isVoxelLayer(t)&&r===W.ViewingMode.Global))}_makeSpatialReferenceConstraints(e,t,r){if(null==t)return[{spatialReference:e,viewingMode:r}];const{isWebMercator:i,isWGS84:s}=e;return U.isImageryTileLayer(t)&&(i||s)?s&&r!==W.ViewingMode.Local&&null!==be.checkIfTileInfoSupportedForView(t.tileInfo,t.fullExtent,e,W.ViewingMode.Global)?[{spatialReference:i?A.WGS84:A.WebMercator,viewingMode:r}]:[{spatialReference:e,viewingMode:r},{spatialReference:A.WebMercator,viewingMode:r}]:U.isTiledLayer(t)||U.isVoxelLayer(t)||!i&&!s?U.isTiledLayer(t)&&i&&r!==W.ViewingMode.Global?[{spatialReference:e,viewingMode:r},{spatialReference:A.WGS84,viewingMode:W.ViewingMode.Local}]:[{spatialReference:e,viewingMode:r}]:[{spatialReference:e,viewingMode:r},{spatialReference:i?A.WGS84:A.WebMercator,viewingMode:r}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport(e),r=this._predeterminedViewingMode;return t||(null!=r?u.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${W.stringFromViewingMode(r)} viewing mode.`):e.isGeographic&&u.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}trackGraphicState(e){if(!e.graphic)return u.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let r=null,i=!1;const s=t=>{!i&&null!=t&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(r=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),l.makeHandle((()=>{i=!0,null!=r&&(r.remove(),r=null)}))}maskOccludee(e){if(!e)return u.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let r=null,i=!1;const s=t=>{!i&&null!=t&&Pe.occludeesSupported(t)&&(r=t.maskOccludee(e))};return null!=t?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),l.makeHandle((()=>{i=!0,null!=r&&(r.remove(),r=null)}))}getViewForGraphic(e){return e.layer===this?this.graphicsView:e.layer?this.allLayerViews.filter((e=>"media-3d"!==e.type)).find((t=>t.layer===e.layer)):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){return e.layer===this?(await m.whenOnce((()=>this.graphicsView)),this.graphicsView):e.layer&&this.map?t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,r)=>{const i=this.map.allLayers.on("change",(s=>{s.added.includes(e.layer)&&(i.remove(),this.whenLayerView(e.layer).then(t,r))}))})):this.whenLayerView(e.layer):null}async _importModule(e,t){const r=new AbortController;this._importControllers.set(e,r),this._updatingChanged();try{const i=await Ge[e]();return t&&(p.throwIfAborted(r.signal),await t(r.signal)),p.throwIfAborted(r.signal),this._importControllers.delete(e),i}catch{this._importControllers.delete(e)}return null}_abortImport(e){this._importControllers.get(e)?.abort(),this._importControllers.delete(e),this._updatingChanged()}_initBasemapTerrain(){this._set("basemapTerrain",new _e({view:this})),this._set("elevationProvider",new ne.CombinedElevationProvider({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){const e=this.basemapTerrain,t=this.elevationProvider;e&&(this._set("basemapTerrain",null),this._set("elevationProvider",null),t.unregister(e),t.destroy(),e.destroy())}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new ye.PointsOfInterest({view:this})),this._set("featureTiles",new te.FeatureTileTree3D({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const t=()=>{const e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=null!=this.basemapTerrain.extent&&null!=this.basemapTerrain.spatialReference?O.project(F.toExtent(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add((()=>oe.debugFlags.FEATURE_TILE_TREE_SHOW_TILES),(t=>{t&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(new Promise(((t,r)=>e(["./3d/layers/support/FeatureTileTree3DDebugger"],t,r)))).then((({FeatureTileTree3DDebugger:e})=>{!this._featureTreeDebugger&&oe.debugFlags.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new e({view:this}))})):t||!this._featureTreeDebugger||oe.debugFlags.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)}),m.syncAndInitial),this.updatingHandles.add((()=>this.clippingArea),t,m.syncAndInitial),this.updatingHandles.add((()=>this.basemapTerrain.extent),t,m.syncAndInitial)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.featureTiles&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this._set("featureTiles",d.destroyMaybe(this.featureTiles)),this._set("pointsOfInterest",d.destroyMaybe(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference,t=this.state.isGlobal,r=L.renderSRFromViewSR(t,e);r!==this.renderSpatialReference&&(this._set("renderCoordsHelper",he.RenderCoordsHelper.create(this.state.viewingMode,r)),t||this.addHandles(m.watch((()=>this.basemapTerrain?.extent),(e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!I.projectBoundingRect(e,this.basemapTerrain.spatialReference,Be,t)||(this.renderCoordsHelper.extent=Be)}),m.sync),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(we.defaultTolerance/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){null!=e&&e.type===h.ObservableChangesType.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.addHandles(m.watch((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),m.sync),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,r){if(!this.overlay||!this.overlay.hasVisibleItems)return r;const i=e.getContext("2d",{willReadFrequently:!0});return i.putImageData(r,0,0),this.overlay.renderCanvas(e,{disableDecorations:t}),i.getImageData(0,0,r.width,r.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,r)=>this._renderScreenshotOverlay(e,t,r)}},t=new se.SceneIntersectionHelper(this.state.viewingMode,(e=>this.stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const r=n.byId(this.surface);this._stage=new ve.Stage({view:this,options:e,container:r}),this._updateSlice(),this.addHandles([this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(e=>this.stage.renderer.setParameters({highQualityTransparency:e})),m.initial),this.on("pointer-move",(()=>this.stage?.renderer.resetAnimation())),a.on(this.stage.renderView.canvas,"webglcontextlost",(e=>{this.fatalError=new o("webgl-context-lost",e.statusMessage)}))],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(we.defaultTolerance/this.renderCoordsHelper.unitInMeters),this._set("canvas",this.stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=d.destroyMaybe(this.stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new fe.SharedSymbolResources({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}async _ensureGraphicsView(){if(this.graphicsView||this._importControllers.has("GraphicsView3D")||0===this.graphics.length)return;this.removeHandles("GraphicsView3D");const e=(await this._importModule("GraphicsView3D",(e=>m.whenOnce((()=>this.basemapTerrain?.ready),e))))?.default;e&&this._set("graphicsView",new e({view:this,getGraphics:()=>this.graphics})),this._updatingChanged()}_disposeGraphicsView(){this._abortImport("GraphicsView3D"),this.removeHandles("GraphicsView3D"),this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_disposeFocusAreasView(){this._abortImport("FocusAreasView"),this.removeHandles("FocusAreasView"),this.focusAreasView=d.destroyMaybe(this.focusAreasView)}async _ensureFocusAreasView(e){if(this.focusAreasView||this._importControllers.has("FocusAreasView")||0===e)return;this.removeHandles("FocusAreasView");const t=(await this._importModule("FocusAreasView"))?.FocusAreasView;t&&(this.focusAreasView=new t({view:this})),this._updatingChanged()}_startup(){const e=W.viewingModeFromString(this.viewingMode);e===W.ViewingMode.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles(m.on((()=>this.graphics),"after-changes",(()=>this._ensureGraphicsView())),"GraphicsView3D"),this._ensureGraphicsView(),this.addHandles(m.watch((()=>this.map?.focusAreas?.areas.length??0),(e=>this._ensureFocusAreasView(e)),{initial:!0}),"FocusAreasView");const t=this.scene?.initialViewProperties??null,r=t?.environment;r&&(this._overrideDefaultEnvironmentOnly?T.overrideDefaultsFrom(this.environment,r):this.environment=this.environment.cloneWithWebsceneEnvironment(r)),this.timeExtent=t?.timeExtent,t?.analyses.applyTo(this),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const i=this._resolveWhenReady;this._resolveWhenReady=[],i.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this._exitSurface(),this._set("ready",!1)}get _defaultToMapOptions(){const e={include:new Set};if(!this.map)return e;this.map.ground&&e.include.add(xe.terrainId);for(const t of this.allLayerViews)U.isIntegratedMeshLayer(t.layer.type)&&e.include.add(t.uid);return e}get _defaultHitTestOptions(){const e={exclude:new Set};if(!this.map)return e;this.map.ground&&this.map.ground.opacity<1&&e.exclude.add(xe.terrainId);for(const t of this.allLayerViews)U.isIntegratedMeshLayer(t.layer.type)&&t.layer.opacity<1&&e.exclude.add(t.uid);return e}static{this.type="3d"}};function Ne(e,t){return null!=e&&O.canProjectWithoutEngine(e.spatialReference,t)?O.project(e,t):null}t.__decorate([b.property()],Le.prototype,"_userClippingArea",void 0),t.__decorate([b.property()],Le.prototype,"_resourceController",void 0),t.__decorate([b.property()],Le.prototype,"_stage",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"deconflictor",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"labeler",void 0),t.__decorate([b.property(P.owningCollectionProperty(V.AnalysesCollection,"analyses"))],Le.prototype,"analyses",void 0),t.__decorate([b.property({type:H,readOnly:!0})],Le.prototype,"animation",null),t.__decorate([b.property({readOnly:!0})],Le.prototype,"basemapTerrain",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"elevationProvider",void 0),t.__decorate([b.property()],Le.prototype,"camera",null),t.__decorate([b.property({type:r})],Le.prototype,"contentCamera",null),t.__decorate([b.property({readOnly:!0})],Le.prototype,"canvas",void 0),t.__decorate([b.property({type:E})],Le.prototype,"center",null),t.__decorate([b.property({type:M})],Le.prototype,"clippingArea",null),t.__decorate([b.property({type:Z.Constraints})],Le.prototype,"constraints",void 0),t.__decorate([b.property({type:M,readOnly:!0})],Le.prototype,"renderDataExtent",null),t.__decorate([b.property({readOnly:!0})],Le.prototype,"tileInfo",null),t.__decorate([b.property({type:M,readOnly:!0})],Le.prototype,"dataExtent",null),t.__decorate([b.property({type:M,readOnly:!0})],Le.prototype,"_groundAndLayersExtent",null),t.__decorate([b.property({type:X})],Le.prototype,"environment",void 0),t.__decorate([v.cast("environment")],Le.prototype,"castEnvironment",null),t.__decorate([b.property({readOnly:!0})],Le.prototype,"environmentManager",void 0),t.__decorate([b.property({type:M})],Le.prototype,"extent",null),t.__decorate([b.property({type:s})],Le.prototype,"floors",void 0),t.__decorate([b.property()],Le.prototype,"screenCenter",null),t.__decorate([b.property()],Le.prototype,"frustum",null),t.__decorate([b.property({type:Number,readOnly:!0})],Le.prototype,"fullOpacity",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"graphicsView",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"analysisViewManager",void 0),t.__decorate([b.property()],Le.prototype,"groundView",void 0),t.__decorate([b.property({type:Boolean})],Le.prototype,"initialExtentRequired",null),t.__decorate([b.property()],Le.prototype,"defaultsFromMapSettings",null),t.__decorate([b.property()],Le.prototype,"interacting",null),t.__decorate([b.property()],Le.prototype,"stationary",null),t.__decorate([b.property()],Le.prototype,"navigating",null),t.__decorate([b.property()],Le.prototype,"map",void 0),t.__decorate([b.property()],Le.prototype,"padding",null),t.__decorate([b.property({type:ye.PointsOfInterest,readOnly:!0})],Le.prototype,"pointsOfInterest",void 0),t.__decorate([b.property({type:te.FeatureTileTree3D,readOnly:!0})],Le.prototype,"featureTiles",void 0),t.__decorate([b.property()],Le.prototype,"_featureTreeDebugger",void 0),t.__decorate([b.property({type:Boolean})],Le.prototype,"screenSizePerspectiveEnabled",void 0),t.__decorate([b.property({constructOnly:!0})],Le.prototype,"deactivatedWebGLExtensions",void 0),t.__decorate([b.property({constructOnly:!0})],Le.prototype,"debugWebGLExtensions",void 0),t.__decorate([b.property({constructOnly:!0})],Le.prototype,"renderCanvas",void 0),t.__decorate([b.property({constructOnly:!0})],Le.prototype,"state",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"inputManager",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"stateManager",void 0),t.__decorate([b.property({type:["low","medium","high"]})],Le.prototype,"qualityProfile",null),t.__decorate([b.property({type:de,get(){let e=this._get("qualitySettings");return e||(e=new de,ae.apply(this.qualityProfile,e)),e}})],Le.prototype,"qualitySettings",void 0),t.__decorate([b.property()],Le.prototype,"slice",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"typeSpecificPreconditionsReady",null),t.__decorate([b.property({readOnly:!0})],Le.prototype,"renderCoordsHelper",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"sceneIntersectionHelper",void 0),t.__decorate([b.property({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Le.prototype,"resolution",null),t.__decorate([b.property({type:Number})],Le.prototype,"scale",null),t.__decorate([b.property()],Le.prototype,"heightModelInfo",null),t.__decorate([b.property()],Le.prototype,"spatialReference",void 0),t.__decorate([b.property({type:Boolean,constructOnly:!0})],Le.prototype,"alphaCompositingEnabled",void 0),t.__decorate([b.property({constructOnly:!0})],Le.prototype,"preserveDrawingBufferEnabled",void 0),t.__decorate([b.property({type:Boolean})],Le.prototype,"supersampleScreenshotsEnabled",void 0),t.__decorate([b.property({readOnly:!0})],Le.prototype,"type",void 0),t.__decorate([b.property(),v.cast((e=>e instanceof Ae?e:x.ensureClass(Ie,e)))],Le.prototype,"ui",void 0),t.__decorate([b.property({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],Le.prototype,"updating",null),t.__decorate([b.property()],Le.prototype,"_updatingObjects",null),t.__decorate([b.property()],Le.prototype,"_updatingObjectsWithProgress",null),t.__decorate([b.property({type:Number,readOnly:!0,dependsOn:["updating"]})],Le.prototype,"updatingProgress",void 0),t.__decorate([b.property({type:["global","local"]})],Le.prototype,"viewingMode",null),t.__decorate([b.property({type:i})],Le.prototype,"viewpoint",null),t.__decorate([b.property({readOnly:!0})],Le.prototype,"visibleArea",null),t.__decorate([b.property({type:Number})],Le.prototype,"zoom",null),t.__decorate([b.property({type:Ce})],Le.prototype,"highlightOptions",null),t.__decorate([b.property({readOnly:!0})],Le.prototype,"quality",null),t.__decorate([b.property({readOnly:!0})],Le.prototype,"resolutionScale",null),t.__decorate([b.property()],Le.prototype,"focusAreasView",void 0),t.__decorate([b.property()],Le.prototype,"_defaultToMapOptions",null),t.__decorate([b.property()],Le.prototype,"_defaultHitTestOptions",null),Le=t.__decorate([w.subclass("esri.views.SceneView")],Le);const Ue=C.create(),Ve=g.createScreenPointArray(),Be=F.create(),Ge={GraphicsView3D:()=>new Promise(((t,r)=>e(["./3d/layers/GraphicsView3D"],(e=>t(Fe(e))),r))),FocusAreasView:()=>new Promise(((t,r)=>e(["./3d/FocusAreasView"],t,r)))};return Le}));