// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/maybe","../../../core/promiseUtils","../../../core/reactiveUtils","../../../layers/graphics/dehydratedFeatureComparison","../../../layers/graphics/hydratedFeatures","../../../support/elevationInfoUtils","../dragEventPipeline","./SnappingContext","../../support/Scheduler"],(function(e,n,t,o,a,i,l,r,s,u){"use strict";function c(e,[n,t,o]){const a=i.clonePoint(e);return a.x+=n,a.y+=t,a.hasZ&&(a.z+=o),a}function p(e,n){const t=e.hasZ&&n.hasZ?e.z-n.z:0;return[e.x-n.x,e.y-n.y,t]}function d(e,n,[t,o,a],i){e.x=n.x+t,e.y=n.y+o,i&&e.hasZ&&n.hasZ&&(e.z=n.z+a)}function f(e){return e}e.createSnapDragEventPipelineStep=function({predicate:e=()=>!0,snappingManager:i,snappingContext:g,updatingHandles:P,useZ:v=!0}){const x=new r.EventPipeline;if(null==i)return{snappingStep:[f,x],cancelSnapping:f};let S,m=null,y=null,h=null;const b=()=>{m=n.abortMaybe(m),i.doneSnapping(),y?.frameTask.remove(),y=null,S=n.removeMaybe(S),h=null},E=function(e,n,o){return t.debounce((async({frameTask:t,point:i,scenePoint:l,context:r,event:s,delta:u,getLastState:c},p)=>{const f=await t.schedule((()=>e.snap({point:i,scenePoint:l,context:r,signal:p})),p);if(f.valid){let l=await t.schedule((()=>f.apply()),p);const g=c();null!=g.point&&i!==g.point&&(l=e.update({point:g.point,scenePoint:g.scenePoint,context:r})),null!=g.updatePoint&&a.pointEquals(l,g.updatePoint)||(d(s.mapEnd,l,u,n),o.execute(s))}}))}(i,v,x);let T=null,Z=null,k=null;return{snappingStep:[n=>{if(!e(n))return n;const{action:a}=n;if("start"===a){const{info:e}=n,t="3d"===(r=i.view).type?r.resourceController.scheduler.registerTask(u.TaskPriority.SNAPPING):u.ImmediateTask;if(y=function(e,n,t){return{context:new s.SnappingContext({editGeometryOperations:e.editGeometryOperations,elevationInfo:e.elevationInfo,pointer:e.pointer,vertexHandle:null!=n.info?n.info.handle:null,excludeFeature:e.excludeFeature,feature:e.feature,visualizer:e.visualizer}),originalPos:null!=n.snapOrigin?e.coordinateHelper.vectorToDehydratedPoint(n.snapOrigin):n.mapStart,originalScenePos:null!=n.scenePoints?n.scenePoints.sceneStart:null,frameTask:t}}(g,n,t),y.context.selfSnappingZ=null,!v&&null!=e){const n=function(e,n){if(!e.hasZ())return null;const t=n.vertices;let o=null;for(const n of t){const t=e.getZ(n.pos);if(null!=o&&null!=t&&Math.abs(t-o)>1e-6)return null;null==o&&(o=t)}return o}(g.coordinateHelper,e.handle.component);null!=n&&(y.context.selfSnappingZ={value:n,elevationInfo:g.elevationInfo??l.absoluteHeightElevationInfo})}}var r;if(null!=y){const{context:e,originalScenePos:l,originalPos:r}=y,{mapEnd:s,mapStart:u,scenePoints:f}=n,g=c(r,p(s,u)),x=p(u,r),b={...n,action:"update"},I=y.context,w=function(e,n){return null==e||null==n?null:c(e,p(n.sceneEnd,n.sceneStart))}(l,f),z=i.update({point:g,scenePoint:w,context:e});if(k=z,d(s,z,x,v),T=g,Z=w,"end"!==a){const{frameTask:e}=y;null==m&&(m=new AbortController),h=n=>{P.addPromise(t.ignoreAbortErrors(E({frameTask:e,event:b,context:I,point:g,scenePoint:w,delta:x,getLastState:()=>({point:T,scenePoint:Z,updatePoint:n.forceUpdate?null:k})},m.signal)))},h({forceUpdate:!1}),null==S&&(S=o.watch((()=>i.options.effectiveEnabled),(()=>h?.({forceUpdate:!0}))))}}return"end"===a&&b(),n},x],cancelSnapping:e=>(b(),e)}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));