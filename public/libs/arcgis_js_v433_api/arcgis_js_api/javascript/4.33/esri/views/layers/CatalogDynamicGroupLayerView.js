// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/Collection","../../core/handleUtils","../../core/Logger","../../core/promiseUtils","../../core/sql","../../core/accessorSupport/decorators/property","../../core/has","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass"],(function(e,r,t,s,i,a,o,n,d,p){"use strict";const l=Symbol();return n=>{let d=class extends n{constructor(){super(...arguments),this.layerViews=new r,this._debouncedUpdate=i.debounce((async()=>{const{layer:e,parent:r}=this,t=r?.footprintLayerView;let s=[];const i=this._createQuery();if(i&&t){const{features:r}=await t.queryFeatures(i);this.suspended||(s=r.map((r=>e.acquireLayer(r))))}this.removeHandles(l),this.addHandles(s,l)}))}get creatingLayerViews(){return this.view?.layerViewManager.isCreatingLayerViewsForLayer(this.layer)??!1}isUpdating(){return this.creatingLayerViews||this.layer.updating||this.layerViews.some((e=>e.updating))}enableLayerUpdates(){return t.handlesGroup([this._updatingHandles.addWhen((()=>!1===this.parent?.footprintLayerView?.dataUpdating),(()=>this.updateLayers())),this._updatingHandles.add((()=>[this.layer.maximumVisibleSublayers,this.layer.parent?.orderBy,this.parent?.footprintLayerView?.filter,this.parent?.footprintLayerView?.timeExtent,this.suspended]),(()=>this.updateLayers())),t.makeHandle((()=>this.removeHandles(l)))])}updateLayers(){this.suspended?this.removeHandles(l):this._updatingHandles.addPromise(i.ignoreAbortErrors(this._debouncedUpdate()).catch((e=>{s.getLogger(this).error(e)})))}_createQuery(){const e=this.parent?.footprintLayerView,r=this.layer?.parent;if(!e||!r||r.destroyed)return null;const{layer:{maximumVisibleSublayers:t},view:{scale:s}}=this;if(!t)return null;const{itemTypeField:i,itemSourceField:o,itemNameField:n,minScaleField:d,maxScaleField:p,objectIdField:l,orderBy:y}=r,u=a.sqlAnd(`${d} IS NULL OR ${s} <= ${d} OR ${d} = 0`,`${p} IS NULL OR ${s} >= ${p}`),c=y?.find((e=>e.field&&!e.valueExpression)),h=e.createQuery();if(h.returnGeometry=!1,h.num=t,h.outFields=[l,o,n],h.where=a.sqlAnd(h.where,u),null!=this.unsupportedItemTypes){const e=`${i} NOT IN (${this.unsupportedItemTypes.map((e=>`'${e}'`))})`;h.where=a.sqlAnd(h.where,e)}return c?.field&&(h.orderByFields=[`${c.field} ${"descending"===c.order?"DESC":"ASC"}`],h.outFields.push(c.field)),h}};return e.__decorate([o.property({readOnly:!0})],d.prototype,"creatingLayerViews",null),e.__decorate([o.property()],d.prototype,"layer",void 0),e.__decorate([o.property()],d.prototype,"layerViews",void 0),e.__decorate([o.property({readOnly:!0})],d.prototype,"unsupportedItemTypes",void 0),e.__decorate([o.property()],d.prototype,"parent",void 0),e.__decorate([o.property({readOnly:!0})],d.prototype,"isUpdating",null),d=e.__decorate([p.subclass("esri.views.layers.CatalogDynamicGroupLayerView")],d),d}}));