// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/has","../../core/Logger","../../core/promiseUtils","../../core/reactiveUtils","../../core/sql","../../core/accessorSupport/decorators/property","../../core/RandomLCG","../../core/accessorSupport/decorators/subclass","../../layers/graphics/data/FeatureIdInfo","../../layers/knowledgeGraph/constants","../../layers/support/displayFilterUtils","../../layers/support/FeatureEffect","../../layers/support/FeatureFilter","../../layers/support/featureLayerUtils","../../layers/support/featurePopupQueryUtils","../../layers/support/fieldUtils","../../layers/support/floorFilterUtils","../../networks/support/networkFieldUtils","../../rest/support/Query","../2d/layers/features/layerAdapters/featureServiceUtils","./support/popupUtils","./support/WhereClauseVisitor"],(function(e,t,i,r,l,s,o,a,n,d,u,p,c,f,y,F,h,m,g,I,b,w,_){"use strict";return t=>{let a=class extends t{constructor(...e){super(...e),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([l.watch((()=>{const e=this.layer,t=this.view;return[e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,t?.requiredFieldsOptions?.featureTitleFields&&e&&"featureTitleFields"in e&&e.featureTitleFields,t?.requiredFieldsOptions?.utilityNetworkFields&&g.getUtilityNetworkFields(t,e),e.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,"knowledge-graph-sublayer"===e?.type&&"link-chart"===e.parentCompositeLayer.type&&e.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode,"parquet"===e?.type&&e.popupTemplate]}),(()=>this._handleChange()),l.syncAndInitial),l.on((()=>this.view?.floors),"change",(()=>this._handleChange())),l.on((()=>this.layer.displayFilterInfo?.filters),"change",(()=>this._handleChange())),l.on((()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null),"change",(()=>this._handleChange()))])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:i}=this;return"outFields"in e&&e.outFields?h.fixFields(t,[...h.unpackFieldNames(t,e.outFields),...i]):h.fixFields(t,i)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const e=this.layer;return this.displayFilterEnabled&&e.displayFilterInfo?p.getEffectiveDisplayFilter(e.displayFilterInfo,this.view):null}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){i.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?y.getSignedInUser(this.layer.url):Promise.resolve(null)}highlight(e,t){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new I(e);return"floorInfo"in this.layer&&this.layer.floorInfo&&(t.where=s.sqlAnd(t.where,m.getFloorFilterClause(this))),this.displayFilterEnabled&&(t.where=s.sqlAnd(t.where,this.effectiveDisplayFilter?.where)),null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new I(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){const i=await this._createPopupQuery(e.map((e=>e.origin?.layer??e.layer)),t);return await F.fetchFeaturePopupFeatures(this.layer,e,i,{getPopupTemplate:e=>e&&"popupEnabled"in e&&e.popupEnabled?w.getFetchPopupTemplate(e,t):null,hasRequiredFields:(e,t)=>this._popupFeatureHasRequiredFields(e,t),...t})}_handleChange(){const e=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then((()=>{}));return this._set("_updatingRequiredPromise",e),e.then((()=>{this._updatingRequiredPromise===e&&this._set("_updatingRequiredPromise",null)})),e}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:e}=this,t=new _.WhereClauseVisitor(e.fieldsIndex);if(t.visitFilter(this.filter),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction),"labelingInfo"in e&&t.visitLabelingInfo(e.labelsVisible,e.labelingInfo),"trackInfo"in e&&t.visitTrackInfo(e.trackInfo),"2d"===this.view.type&&(t.visitFilter(this.featureEffect?.filter),t.visitDisplayFilter(this.displayFilterEnabled,e.displayFilterInfo),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction)),"subtype-group"===e.type)for(const i of e.sublayers)t.visitLabelingInfo(i.labelsVisible,i.labelingInfo);try{const e=await t.finish();this._set("requiresCurrentUser",e.requiresCurrentUser)}catch(e){i.getLogger(this).error(e)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r}}=this,l="renderer"in t&&t.renderer,s="orderBy"in t&&t.orderBy,o="featureReduction"in t?t.featureReduction:null,a=new Set,n=[l?l.collectRequiredFields(a,r):null,h.collectLabelingFields(a,t),e&&"elevationInfo"in t?h.collectElevationFields(a,t):null,null!=this.filter?h.collectFilterFields(a,t,this.filter):null,e||null==this.featureEffect?null:h.collectFilterFields(a,t,this.featureEffect.filter),!e&&o?h.collectFeatureReductionFields(a,t,o):null,!e&&s?h.collectOrderByInfos(a,t,s):null];if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&h.collectFields(a,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"timeInfo"in t&&t.timeInfo&&"trackInfo"in t&&t.trackInfo){const{trackInfo:e}=t;h.collectFields(a,t.fieldsIndex,[t.timeInfo.trackIdField]),"feature"!==t.type&&"startTimeField"!==e.timeField||h.collectFields(a,t.fieldsIndex,[t.timeInfo.startField]),"endTimeField"===e.timeField&&h.collectFields(a,t.fieldsIndex,[t.timeInfo.endField]),await h.collectTrackInfoFields(a,t)}if("floorInfo"in t&&t.floorInfo&&h.collectFields(a,t.fieldsIndex,[t.floorInfo.floorField]),"featureTitleFields"in t&&this.view?.requiredFieldsOptions?.featureTitleFields&&t.featureTitleFields&&h.collectFields(a,t.fieldsIndex,t.featureTitleFields),"feature"===t.type&&t.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&h.collectFields(a,t.fieldsIndex,[t.globalIdField]),this.displayFilterEnabled&&n.push(h.collectDisplayFilterFields(a,t,t.displayFilterInfo)),"feature"===t.type&&e&&null!=t.infoFor3D&&(null==t.globalIdField&&i.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),h.collectFields(a,t.fieldsIndex,[t.globalIdField])),"subtype-group"===t.type){h.collectField(a,r,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(a,r),h.collectLabelingFields(a,e)])));n.push(Promise.all(e))}if("catalog-footprint"===t.type&&t.parent){const e=t.parent;h.collectFields(a,r,[e.itemNameField,e.itemSourceField,e.itemTypeField,e.maxScaleField,e.minScaleField])}"knowledge-graph-sublayer"===t.type&&"link-chart"===t.parentCompositeLayer.type&&h.collectField(a,r,u.systemIsSpatialFieldName),"parquet"===t.type&&n.push(w.getRequiredFields(t,t.popupTemplate).then((e=>{for(const t of e)a.add(t)})));const p=await Promise.allSettled(n);if(e)h.collectField(a,r,t.objectIdField);else for(const e of d.getFeatureIdInfoFieldNames(b.createFeatureIdInfo(t)))h.collectField(a,r,e);e&&"displayField"in t&&t.displayField&&h.collectField(a,r,t.displayField);for(const e of p)"rejected"===e.status&&i.getLogger(this).error(e.reason);const c=Array.from(a).sort();this._set("requiredFields",c)}_popupFeatureHasRequiredFields(e,t){return h.featureHasFields(e,t)}async _createPopupQuery(e,t){const i=this.layer.createQuery(),l=new Set;let o=!1;const a=e??[this.layer];for(const e of a){if(!("popupEnabled"in e))continue;const i=w.getFetchPopupTemplate(e,t);if(null==i)continue;const s=await F.loadFeaturePopupArcadeModules(i);r.throwIfAborted(t);const a=s&&s.arcadeUtils.hasGeometryOperations(i);o=!("point"!==this.layer.geometryType&&!a);const n=await w.getRequiredFields(this.layer,i);r.throwIfAborted(t);for(const e of n)l.add(e)}return i.returnGeometry=o,i.returnZ=o,i.returnM=o,i.outFields=Array.from(l),i.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(i.where=s.sqlAnd(i.where,m.getFloorFilterClause(this))),i}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}getTest(){}get test(){}};return e.__decorate([o.property()],a.prototype,"_updatingRequiredPromise",void 0),e.__decorate([o.property({readOnly:!0})],a.prototype,"availableFields",null),e.__decorate([o.property({readOnly:!0})],a.prototype,"displayFilterEnabled",null),e.__decorate([o.property({readOnly:!0})],a.prototype,"effectiveDisplayFilter",null),e.__decorate([o.property({type:c})],a.prototype,"featureEffect",null),e.__decorate([o.property({type:f})],a.prototype,"filter",void 0),e.__decorate([o.property()],a.prototype,"layer",void 0),e.__decorate([o.property({type:Number})],a.prototype,"maximumNumberOfFeatures",null),e.__decorate([o.property({readOnly:!0,type:Boolean})],a.prototype,"maximumNumberOfFeaturesExceeded",null),e.__decorate([o.property()],a.prototype,"requiresCurrentUser",void 0),e.__decorate([o.property({readOnly:!0})],a.prototype,"requiredFields",void 0),e.__decorate([o.property({readOnly:!0})],a.prototype,"signedInUser",null),e.__decorate([o.property()],a.prototype,"suspended",void 0),e.__decorate([o.property()],a.prototype,"view",void 0),a=e.__decorate([n.subclass("esri.views.layers.FeatureLayerView")],a),a}}));