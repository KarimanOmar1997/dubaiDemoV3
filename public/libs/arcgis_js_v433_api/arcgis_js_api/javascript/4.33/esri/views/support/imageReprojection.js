// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../request","../../geometry/Point","../../geometry/operators/projectOperator","../../layers/support/rasterFunctions/rasterProjectionHelper","../2d/engine/Bitmap","../2d/engine/webgl/VertexStream","../2d/engine/webgl/shaders/MaterialPrograms","../webgl/enums","../webgl/FramebufferObject","../webgl/rasterUtils","../webgl/RenderingContext","../webgl/Texture","../webgl/TextureDescriptor"],(function(e,t,r,a,i,s,n,o,c,h,x,p,m,u){"use strict";class d{static{this._instanceRefCount=0}constructor(e){if(this._ownsRctx=!1,e)this._ownsRctx=!1,this._rctx=e;else{if(d._instance)return d._instanceRefCount++,d._instance;d._instanceRefCount=1,d._instance=this,this._ownsRctx=!0;const e=document.createElement("canvas").getContext("webgl2");e.getExtension("OES_texture_float"),this._rctx=new p.RenderingContext(e,{})}const t=o.createProgramTemplate("raster/reproject","raster/reproject",new Map([["a_position",0]]),{applyProjection:!0,bilinear:!1,bicubic:!1});this._program=this._rctx.programCache.acquire(t.shaders.vertexShader,t.shaders.fragmentShader,t.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new n(this._rctx,[0,0,1,0,0,1,1,1])}reprojectTexture(e,t,s=!1){const n=a.execute(e.extent,t),o=new r({x:(e.extent.xmax-e.extent.xmin)/e.texture.descriptor.width,y:(e.extent.ymax-e.extent.ymin)/e.texture.descriptor.height,spatialReference:e.extent.spatialReference}),{x:p,y:m}=i.projectResolution(o,t,e.extent);let d=(p+m)/2;const g=Math.round((n.xmax-n.xmin)/d),_=Math.round((n.ymax-n.ymin)/d);d=(n.width/g+n.height/_)/2;const l=new r({x:d,y:d,spatialReference:n.spatialReference}),f=i.getProjectionOffsetGrid({projectedExtent:n,srcBufferExtent:e.extent,pixelSize:l,hasWrapAround:!0,spacing:[16,16]}),w=x.createTransformTexture(this._rctx,f),b=new u.TextureDescriptor(g,_);b.wrapMode=c.TextureWrapMode.CLAMP_TO_EDGE;const D=new h.FramebufferObject(this._rctx,b);this._rctx.bindFramebuffer(D),this._rctx.setViewport(0,0,g,_),this._rctx.useProgram(this._program),this._rctx.bindTexture(e.texture,0),this._rctx.bindTexture(w,1),this._quad.bind();const{width:T=0,height:R=0}=e.texture.descriptor;if(this._program.setUniform2f("u_srcImageSize",T,R),this._program.setUniform2fv("u_transformSpacing",f.spacing),this._program.setUniform2fv("u_transformGridSize",f.size),this._program.setUniform2f("u_targetImageSize",g,_),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),w.dispose(),s){const{width:e,height:t}=D,r=new ImageData(e??0,t??0);D.readPixels(0,0,e??0,t??0,c.PixelFormat.RGBA,c.PixelType.UNSIGNED_BYTE,r.data);const a=D.detachColorTexture();return D.dispose(),{texture:a,extent:n,imageData:r}}const y=D.detachColorTexture();return D.dispose(),{texture:y,extent:n}}reprojectBitmapData(e,t){const r=s.isImageSource(e.bitmapData)?s.rasterize(e.bitmapData):e.bitmapData,a=new u.TextureDescriptor;a.wrapMode=c.TextureWrapMode.CLAMP_TO_EDGE,a.width=e.bitmapData.width,a.height=e.bitmapData.height;const i=new m.Texture(this._rctx,a,r),n=this.reprojectTexture({texture:i,extent:e.extent},t,!0);n.texture.dispose();const o=document.createElement("canvas"),h=n.imageData;return o.width=h.width,o.height=h.height,o.getContext("2d").putImageData(h,0,0),{bitmapData:o,extent:n.extent}}async loadAndReprojectBitmapData(e,r,a){const[s]=await Promise.all([t(e,{responseType:"image"}).then((e=>e.data)),i.load()]),n=document.createElement("canvas");n.width=s.width,n.height=s.height;const o=n.getContext("2d");o.drawImage(s,0,0);const c=o.getImageData(0,0,n.width,n.height);if(r.spatialReference.equals(a))return{bitmapData:c,extent:r};const h=this.reprojectBitmapData({bitmapData:c,extent:r},a);return{bitmapData:h.bitmapData,extent:h.extent}}destroy(){this._ownsRctx?(d._instanceRefCount--,0===d._instanceRefCount&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),d._instance=null)):(this._quad.dispose(),this._program.dispose())}}e.ImageReprojector=d,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));