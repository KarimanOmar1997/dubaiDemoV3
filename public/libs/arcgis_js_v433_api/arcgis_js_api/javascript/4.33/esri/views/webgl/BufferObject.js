// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../core/arrayUtils","../../core/has","../../core/Logger","../../core/typedArrayUtil","./checkWebGLError","./enums"],(function(e,t,r,i,s,n,f){"use strict";const a=()=>i.getLogger("esri.views.webgl.BufferObject");class u{static createIndex(e,t,r){return new u(e,f.BufferType.ELEMENT_ARRAY_BUFFER,t,r)}static createVertex(e,t,r){return new u(e,f.BufferType.ARRAY_BUFFER,t,r)}static createUniform(e,t,r){return new u(e,f.BufferType.UNIFORM_BUFFER,t,r)}static createPixelPack(e,t=f.Usage.STREAM_READ,r){const i=new u(e,f.BufferType.PIXEL_PACK_BUFFER,t);return r&&i.setSize(r),i}static createPixelUnpack(e,t=f.Usage.STREAM_DRAW,r){return new u(e,f.BufferType.PIXEL_UNPACK_BUFFER,t,r)}static createTransformFeedback(e,t=f.Usage.STATIC_DRAW,r){const i=new u(e,f.BufferType.TRANSFORM_FEEDBACK_BUFFER,t);return i.setSize(r),i}constructor(e,t,r,i){this._context=e,this.bufferType=t,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(f.ResourceType.BufferObject,this),this._glName=this._context.gl.createBuffer(),n.checkWebGLError(this._context.gl),i&&this.setData(i)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get usedMemory(){if(this.bufferType===f.BufferType.ELEMENT_ARRAY_BUFFER){if(this._indexType===f.DataType.UNSIGNED_INT)return 4*this._size;if(this._indexType===f.DataType.UNSIGNED_SHORT)return 2*this._size}return this._size}get _isVAOAware(){return this.bufferType===f.BufferType.ELEMENT_ARRAY_BUFFER||this.bufferType===f.BufferType.ARRAY_BUFFER}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(f.ResourceType.BufferObject,this),this._context=null):this._glName&&a().warn("Leaked WebGL buffer object")}setSize(e,t=null){if(this.bufferType===f.BufferType.ELEMENT_ARRAY_BUFFER&&null!=t)switch(this._indexType=t,t){case f.DataType.UNSIGNED_SHORT:e*=2;break;case f.DataType.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let t=e.byteLength;this.bufferType===f.BufferType.ELEMENT_ARRAY_BUFFER&&(s.isUint8Array(e)?this._indexType=f.DataType.UNSIGNED_BYTE:s.isUint16Array(e)?(t/=2,this._indexType=f.DataType.UNSIGNED_SHORT):s.isUint32Array(e)&&(t/=4,this._indexType=f.DataType.UNSIGNED_INT)),this._setBufferData(t,e)}_setBufferData(e,t=null){this._size=e;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const i=this._context.gl;null!=t?i.bufferData(this.bufferType,t,this.usage):i.bufferData(this.bufferType,e,this.usage),n.checkWebGLError(i),this._isVAOAware&&this._context.bindVAO(r)}setSubData(e,t,r,i){if(!e)return;const s=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:f}=this._context;f.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,e,r,i-r),n.checkWebGLError(f),this._isVAOAware&&this._context.bindVAO(s)}getSubData(e,r=0,i,s){if(i<0||s<0)return;const n=(u=e,t.isArrayLike(u)?e.BYTES_PER_ELEMENT:1);var u;if(n*((i??0)+(s??0))>e.byteLength)return;r+n*(s??0)>this.usedMemory&&a().warn("Potential problem getting subdata: requested data exceeds buffer size!");const _=this._context.gl;this.bufferType===f.BufferType.TRANSFORM_FEEDBACK_BUFFER?(this._context.bindBuffer(this,f.BufferType.TRANSFORM_FEEDBACK_BUFFER),_.getBufferSubData(f.BufferType.TRANSFORM_FEEDBACK_BUFFER,r,e,i,s),this._context.unbindBuffer(f.BufferType.TRANSFORM_FEEDBACK_BUFFER)):(this._context.bindBuffer(this,f.BufferType.COPY_READ_BUFFER),_.getBufferSubData(f.BufferType.COPY_READ_BUFFER,r,e,i,s),this._context.unbindBuffer(f.BufferType.COPY_READ_BUFFER))}async getSubDataAsync(e,t=0,r,i){await this._context.clientWaitAsync(),this.getSubData(e,t,r,i)}}e.BufferObject=u,e.tracer=null,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));