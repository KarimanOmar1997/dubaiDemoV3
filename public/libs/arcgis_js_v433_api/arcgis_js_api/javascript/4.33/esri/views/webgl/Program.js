// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../core/has","./checkWebGLError","./enums","./ShaderTranspiler"],(function(e,t,n,o,i){"use strict";function r(e,t,i){const r=e.gl,s=r.createShader(t);return r.shaderSource(s,i),r.compileShader(s),n.webglValidateShadersEnabled()&&!r.getShaderParameter(s,r.COMPILE_STATUS)&&(console.error("Compile error in ".concat(t===o.ShaderType.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(r.getShaderInfoLog(s)),console.error(function(e){let t=2;return e.replaceAll("\n",(()=>{return"\n"+((e=t++)>=1e3?e.toString():("  "+e).slice(-3))+":";var e}))}(i))),s}function s(e,t,n){const o=e.get(t);if(!o)return e.set(t,Array.from(n)),!0;const i=n.length;if(o.length!==i)return e.set(t,Array.from(n)),!0;for(let e=0;e<i;++e){const t=n[e];if(o[e]!==t){for(o[e]=t;e<i;++e)o[e]=n[e];return!0}}return!1}const a={enabled:!1},h=n.webglDebugEnabled()?(...e)=>m(e):()=>{},m=n.webglDebugEnabled()?e=>{const t=e.length;for(let n=0;n<t;++n){const t=e[n];Number.isNaN(t)&&console.error(`Got ${t} as uniform value from ${(new Error).stack}`)}}:()=>{};e.Program=class{constructor(e,t,s,h,m=new Map,f=[]){this._context=e,this._locations=h,this._uniformBlockBindings=m,this._transformFeedbackVaryings=f,this._refCount=1,this._compiled=!1,this._linesOfCode=0,this._nameToUniformLocation=new Map,this._nameToUniform1=new Map,this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),0===t.length&&console.error("Shaders source should not be empty!"),t=i.transpileShader(t,o.ShaderType.VERTEX_SHADER),s=i.transpileShader(s,o.ShaderType.FRAGMENT_SHADER),this._vShader=r(this._context,o.ShaderType.VERTEX_SHADER,t),this._fShader=r(this._context,o.ShaderType.FRAGMENT_SHADER,s),a.enabled&&(this._linesOfCode=t.match(/\n/g).length+s.match(/\n/g).length+2,this._context.instanceCounter.increment(o.ResourceType.LinesOfCode,this._vShader,this._linesOfCode)),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(o.ResourceType.Shader,this),n.webglValidateShadersEnabled()&&(this.vertexShader=t,this.fragmentShader=s),this.usedMemory=t.length+s.length;const c=this._context.gl,l=c.createProgram();c.attachShader(l,this._vShader),c.attachShader(l,this._fShader),this._locations.forEach(((e,t)=>c.bindAttribLocation(l,e,t))),this._transformFeedbackVaryings?.length&&c.transformFeedbackVaryings(l,this._transformFeedbackVaryings,c.SEPARATE_ATTRIBS),c.linkProgram(l),n.webglValidateShadersEnabled()&&!c.getProgramParameter(l,c.LINK_STATUS)&&console.error(`Could not link shader\nvalidated: ${c.getProgramParameter(l,c.VALIDATE_STATUS)}, gl error ${c.getError()}, vertex: ${c.getShaderParameter(this._vShader,c.COMPILE_STATUS)}, fragment: ${c.getShaderParameter(this._fShader,c.COMPILE_STATUS)}, info log: ${c.getProgramInfoLog(l)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`);for(const[e,t]of this._uniformBlockBindings){const n=c.getUniformBlockIndex(l,e);n<4294967295&&c.uniformBlockBinding(l,n,t)}this._glName=l,this._context.instanceCounter.increment(o.ResourceType.Program,this)}get glName(){return this._glName}get hasGLName(){return null!=this._glName}get hasTransformFeedbackVaryings(){return!!this._transformFeedbackVaryings?.length}get compiled(){return!!this._compiled||(this._context.capabilities.parallelShaderCompile&&null!=this.glName?(this._compiled=!!this._context.gl.getProgramParameter(this.glName,o.Extension.COMPLETION_STATUS_KHR),this._compiled):(this._compiled=!0,!0))}dispose(){if(--this._refCount>0)return;const e=this._context.gl,t=this._context.instanceCounter;this._nameToUniformLocation.forEach((e=>e&&t.decrement(o.ResourceType.Uniform,e))),this._nameToUniformLocation.clear(),this._vShader&&(this._linesOfCode>0&&(t.decrement(o.ResourceType.LinesOfCode,this._vShader,this._linesOfCode),this._linesOfCode=0),e.deleteShader(this._vShader),this._vShader=null,t.decrement(o.ResourceType.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,t.decrement(o.ResourceType.Program,this))}ref(){++this._refCount}_getUniformLocation(e){const t=this._nameToUniformLocation.get(e);if(void 0!==t)return t;if(this.glName){const t=this._context.gl.getUniformLocation(this.glName,e);return this._nameToUniformLocation.set(e,t),t&&this._context.instanceCounter.increment(o.ResourceType.Uniform,t),t}return null}hasUniform(e){return null!=this._getUniformLocation(e)}setUniform1i(e,t){h(t);const n=this._nameToUniform1.get(e);void 0!==n&&t===n||(this._context.gl.uniform1i(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1iv(e,t){m(t),s(this._nameToUniform1v,e,t)&&this._context.gl.uniform1iv(this._getUniformLocation(e),t)}setUniform2iv(e,t){m(t),s(this._nameToUniform2,e,t)&&this._context.gl.uniform2iv(this._getUniformLocation(e),t)}setUniform3iv(e,t){m(t),s(this._nameToUniform3,e,t)&&this._context.gl.uniform3iv(this._getUniformLocation(e),t)}setUniform4iv(e,t){m(t),s(this._nameToUniform4,e,t)&&this._context.gl.uniform4iv(this._getUniformLocation(e),t)}setUniform1f(e,t){h(t);const n=this._nameToUniform1.get(e);void 0!==n&&t===n||(this._context.gl.uniform1f(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1fv(e,t){m(t),s(this._nameToUniform1v,e,t)&&this._context.gl.uniform1fv(this._getUniformLocation(e),t)}setUniform2f(e,t,n){h(t,n);const o=this._nameToUniform2.get(e);void 0===o?(this._context.gl.uniform2f(this._getUniformLocation(e),t,n),this._nameToUniform2.set(e,[t,n])):t===o[0]&&n===o[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),t,n),o[0]=t,o[1]=n)}setUniform2fv(e,t){m(t),s(this._nameToUniform2,e,t)&&this._context.gl.uniform2fv(this._getUniformLocation(e),t)}setUniform3f(e,t,n,o){h(t,n,o);const i=this._nameToUniform3.get(e);void 0===i?(this._context.gl.uniform3f(this._getUniformLocation(e),t,n,o),this._nameToUniform3.set(e,[t,n,o])):t===i[0]&&n===i[1]&&o===i[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),t,n,o),i[0]=t,i[1]=n,i[2]=o)}setUniform3fv(e,t){m(t);const n=this._getUniformLocation(e);null!=n&&s(this._nameToUniform3,e,t)&&this._context.gl.uniform3fv(n,t)}setUniform4f(e,t,n,o,i){h(t,n,o,i);const r=this._nameToUniform4.get(e);void 0===r?(this._context.gl.uniform4f(this._getUniformLocation(e),t,n,o,i),this._nameToUniform4.set(e,[t,n,o,i])):void 0!==r&&t===r[0]&&n===r[1]&&o===r[2]&&i===r[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),t,n,o,i),r[0]=t,r[1]=n,r[2]=o,r[3]=i)}setUniform4fv(e,t){m(t);const n=this._getUniformLocation(e);null!=n&&s(this._nameToUniform4,e,t)&&this._context.gl.uniform4fv(n,t)}setUniformMatrix3fv(e,t,n=!1){m(t);const o=this._getUniformLocation(e);null!=o&&s(this._nameToUniformMatrix3,e,t)&&this._context.gl.uniformMatrix3fv(o,n,t)}setUniformMatrix4fv(e,t,n=!1){m(t);const o=this._getUniformLocation(e);null!=o&&s(this._nameToUniformMatrix4,e,t)&&this._context.gl.uniformMatrix4fv(o,n,t)}stop(){}},e.test=a,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));