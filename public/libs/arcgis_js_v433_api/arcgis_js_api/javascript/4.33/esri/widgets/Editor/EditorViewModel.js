// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../core/arrayUtils","../../core/asyncUtils","../../core/Collection","../../core/deprecate","../../core/Error","../../core/Evented","../../core/handleUtils","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/decorators/subclass","../../core/support/UpdatingHandles","../../editing/templateUtils","../../layers/GraphicsLayer","../../layers/support/editableLayers","../../layers/support/layerUtils","../../portal/support/urlUtils","../../views/SelectionManager","../../views/interactive/sketch/SketchOptions","../../views/interactive/snapping/SnappingManager","../../views/interactive/snapping/SnappingOptions","../../views/support/selectionUtils","../Attachments/AttachmentsViewModel","./CreateFeaturesWorkflow","./UpdateFeaturesWorkflow","./UpdateWorkflow","./workflowUtils","./support/EditorItem","../FeatureTemplates/featureTemplatesUtils","../FeatureTemplates/FeatureTemplatesViewModel","../Sketch/SketchViewModel","../Spinner/SpinnerViewModel","../support/goToUtils","../support/SelectionList/selectionListUtils","../support/SelectionList/SelectionListViewModel","../support/SelectionToolbar/SelectionToolbarViewModel"],(function(e,t,r,a,i,o,s,n,l,c,d,p,u,h,w,y,f,_,g,m,k,v,W,M,F,b,T,E,V,L,I,S,A,U,C,O,R,P,H,G){"use strict";function q(e,t){return e?.find((e=>e.layer===t))}let D=class extends s.EventedAccessor{constructor(e){super(e),this._queuedSelectionTool=null,this._sketchEventListenerHandle=null,this._sketchGraphicsLayer=new _({listMode:"hide",internal:!0}),this._snappingManager=null,this._templatesByLayer=new Map,this._updateItemsTask=null,this._updateTemplatesTask=null,this._updatingHandles=new y.UpdatingHandles,this._featureTemplatesViewModelIsRestricted=!1,this.activeWorkflow=null,this._activityQueue=new a,this.editorItems=new a,this.failures=[],this.hideTemplatesForInactiveLayers=!1,this.attachmentsViewModel=new T({capabilities:{editing:!0}}),this.featureTemplatesViewModel=new U({disabledItemFunction:({layer:e})=>this._itemIsSuspended(e)}),this.layerInfos=null,this.ownSketchViewModel=new C({layer:this._sketchGraphicsLayer}),this.selectionListViewModel=new H,this.selectionManager=new v,this.selectionToolbarViewModel=new G({continuousSelectionEnabled:!0,defaultOperationType:"replace",persistSelection:!1,returnGeometry:!1}),this.sketchOptions=new W,this.snappingOptions=new F({attributeRulesEnabled:!0}),this.spinnerViewModel=new O,this.pageStack=[],this.showDiscardEditsPrompt=()=>Promise.resolve(!0),this._candidateCommitted=!1,this.back=async()=>{if("viewing-selection-list"===this.state)return this.selectionListViewModel.filterText=void 0,void this.effectiveSelectionManager.clear();this.canGoBack&&(this.activeWorkflow?.hasPreviousStep?await this.activeWorkflow.back(this.showDiscardEditsPrompt):await this._cancelWorkflow({force:!this.hasPendingEdits}))},this.saveWorkflow=async()=>await(this.activeWorkflow?.save()),this.selectFeature=(e,t=!1)=>{const r=this.activeWorkflow;this._candidateCommitted||"update"!==r?.type||(r.data.rootFeature=e,t&&(r.next(),this._candidateCommitted=!0))}}initialize(){this.addHandles([p.watch((()=>{const e=this.view,t=e?.map?.editableLayers.toArray(),r=e?.allLayerViews,a=r?.filter((e=>!!t?.includes(e.layer)));return[t,a,this.layerInfos]}),(()=>this._updateEditorItems()),p.syncAndInitial),p.watch((()=>this.hideTemplatesForInactiveLayers),(()=>this.syncFeatureTemplates())),p.watch((()=>this._selectionSources),(()=>this._syncSelectionSources()),p.initial),p.on((()=>this.activeWorkflow),"cancel",(()=>this.emit("workflow-cancel"))),p.on((()=>this.activeWorkflow),"commit",(()=>this.emit("workflow-commit"))),p.on((()=>this.activeWorkflow),"complete",(()=>{this.emit("workflow-commit"),this._set("activeWorkflow",null)})),p.when((()=>!this.activeWorkflow&&this._queuedSelectionTool),(()=>this._queuedSelectionTool&&this.selectionToolbarViewModel.activateTool(this._queuedSelectionTool))),p.watch((()=>this.activeWorkflow),(e=>this.selectionManager.showHighlight=!e)),p.when((()=>this.view?.map),(e=>e.add(this._sketchGraphicsLayer)),p.initial),p.on((()=>this.editorItems),"change",(()=>this._afterEditorItemsChange())),p.watch((()=>[this.canCreate,this.canUpdateVisible]),(()=>this._afterEditorItemsChange())),p.watch((()=>this.page),((e,t)=>{const r=[...this.pageStack];if(-1===r.indexOf(e))r.push(e);else for(;r.length&&r.at(-1)!==e;)r.pop();this.pageStack=r}),p.syncAndInitial),p.when((()=>"awaiting-update-feature-candidate"===this.state),(()=>this._candidateCommitted=!1)),p.on((()=>this.featureTemplatesViewModel),"select",(async({item:e,oldItem:t})=>{const{activeWorkflow:r}=this;if(r){if("update"===r.type&&"awaiting-feature-creation-info"===r.activeWorkflow?.stepId)return;try{await this.cancelWorkflow({force:!this.hasPendingEdits})}catch{return void this.featureTemplatesViewModel.select(t,{emit:!1})}}if(!e)return;const a={layer:e.layer,template:e.template};if(e.supportsUpload)return this.featureTemplatesViewModel.select(t,{emit:!1}),this.startCreateFeaturesWorkflow(a);this.startCreateFeaturesWorkflowAtFeatureCreation(a)})),p.watch((()=>[this.view,this.featureTemplatesViewModel]),(([e,t])=>{t.view=e}),p.syncAndInitial),p.on((()=>this.view),"key-down",(e=>{"Escape"===e.key&&this.activeWorkflow?.keyboardCancellationEnabled&&(e.stopPropagation(),this.back())})),p.on((()=>this.sketchViewModel),["create","delete","update"],(e=>{const{activeWorkflow:t}=this,r="update"===t?.type,a=I.getLayersFromWorkflow(t),i=r?t?.activeWorkflow?.parentLayer:void 0,o=`sketch-${e.type}`;this.emit(o,{type:o,detail:e,layer:a[0],layers:a,parentLayer:i})}),p.sync),p.watch((()=>this.view),(e=>{if(this._snappingManager=c.destroyMaybe(this._snappingManager),!e)return;const t=this.snappingOptions;this._snappingManager=new M.SnappingManager({view:e,options:t}),this.ownSketchViewModel.snappingManager=this._snappingManager}),p.syncAndInitial),p.watch((()=>this.snappingOptions),(e=>{this._snappingManager&&(this._snappingManager.options=e)}),p.syncAndInitial),p.on((()=>this.selectionToolbarViewModel),"complete",(e=>this._onSelectionComplete(e))),p.watch((()=>({view:this.view,selectionManager:this.effectiveSelectionManager,selectionListViewModel:this.selectionListViewModel,selectionToolbarViewModel:this.selectionToolbarViewModel})),(({view:e,selectionManager:t,selectionListViewModel:r,selectionToolbarViewModel:a})=>{t.view=e,r.view=e,a.view=e}),p.syncAndInitial),p.watch((()=>this.effectiveSelectionManager),(e=>{this.selectionListViewModel.selectionManager=e,this.selectionToolbarViewModel.selectionManager=e}),p.syncAndInitial)])}destroy(){this._cancelWorkflow({warnIfNoWorkflow:!1}).then((()=>{this.view?.map?.remove(this._sketchGraphicsLayer),this.view=null})),this._updateItemsTask=c.abortMaybe(this._updateItemsTask),this._updatingHandles.destroy(),this._sketchEventListenerHandle=c.removeMaybe(this._sketchEventListenerHandle),this.selectionListViewModel?.destroy(),this.selectionToolbarViewModel?.destroy(),this.selectionManager.destroy()}get _featureTemplatesLayersAndTables(){const e=new a;for(const t of this.editorItems){const r=this.hideTemplatesForInactiveLayers&&!t.visible;t.supportsCreateFeaturesWorkflow&&!r&&e.push(t.layer)}return e}get _selectionSources(){const e=new a;for(const t of this.editorItems)b.isSelectableLayer(t.layer)&&t.supportsUpdateWorkflow&&t.visible&&e.push(t.layer);return e}get activeFeatureCount(){const e=this.activeLeafWorkflow;return I.isCreateFeaturesWorkflow(e)?e.pendingFeatures.length:I.isUpdateRecordWorkflow(e)&&e.data.edits.feature?1:I.isUpdateFeaturesWorkflow(e)?e.data.features.length:0}get activeLeafWorkflow(){const e=this.activeWorkflow;return e&&I.isUpdateWorkflow(e)?e.activeWorkflow??e:e}get canCreate(){return this.editorItems.some((e=>e.supportsCreateFeaturesWorkflow))}get canCreateVisible(){return!!this.featureTemplatesLayers.length}get canUpdate(){return this.editorItems.some((e=>e.supportsUpdateWorkflow))}get canUpdateVisible(){return this.editorItems.some((e=>e.supportsUpdateWorkflow&&e.visible))}get featureTemplatesLayers(){return this._featureTemplatesLayersAndTables.filter((e=>"scene"===e.type||!e.isTable))}get effectiveSelectionManager(){return this.selectionManager}get featureFormViewModel(){const{activeWorkflow:e}=this;return"update"===e?.type?e.activeFeatureFormViewModel:"create-features"===e?.type?e.featureFormViewModel:null}get formViewModel(){const{activeWorkflow:e}=this;return"update"===e?.type?e.activeFeatureFormViewModel:"create-features"===e?.type?e.featureFormViewModel:"update-features"===e?.type?e.formViewModel:null}get utilityNetworkAssociationAddAssociationViewModel(){const{activeWorkflow:e}=this;return"update"===e?.type?e.activeUtilityNetworkAssociationAddAssociationViewModel:null}get labelOptions(){return this.sketchOptions.labels}set labelOptions(e){this.sketchOptions.labels=e}get sketchViewModel(){const{activeWorkflow:e}=this;return"update"===e?.type?e.activeSketchViewModel:"create-features"===e?.type||"update-features"===e?.type?e.sketchViewModel:this.ownSketchViewModel}get state(){if(!this.view?.ready)return"disabled";const e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";const{activeWorkflow:t}=this,r=!t?.stepId;return this.effectiveSelectionManager.count&&r?"viewing-selection-list":r?"ready":"update"===t.type&&t.activeWorkflow?.stepId?t.activeWorkflow.stepId:t.stepId}get syncing(){return this._activityQueue.length>0}get updating(){return this._updatingHandles.updating||!0===this.activeWorkflow?.updating}get tooltipOptions(){return this.sketchOptions.tooltips}set tooltipOptions(e){this.sketchOptions.tooltips=e}get valueOptions(){return this.sketchOptions.values}set valueOptions(e){this.sketchOptions.values=e}set view(e){this.ownSketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}get canZoomTo(){const e=this.sketchViewModel,t=e?.createGraphic?.geometry?.type;return!(!e?.updateGraphics?.length&&"multipoint"!==t)}get page(){const{activeWorkflow:e,state:t}=this;if("update"===e?.type&&null!=e?.activeWorkflow?.featureFormViewModel?.associatedLayer)return"viewing-associated-features";if("update"===e?.type&&null!=e?.activeWorkflow?.featureFormViewModel?.associationId)return"viewing-associated-layers";if("update"===e?.type&&"awaiting-feature-to-update"===e.stepId)return"ready";if("create-features"===e?.type&&0===e.numPendingFeatures){const t=e.data.upload;if(t)return"default"===t.state?"ready":"creating-features-upload-details"}return t??"disabled"}get featureFormDisabled(){const{activeLeafWorkflow:e}=this;if(I.isUpdateRecordWorkflow(e))return!1===e.data.editorItem?.capabilities.update.attributes||!0===e.featureFormViewModel.disabled;if(I.isUpdateFeaturesWorkflow(e)){const{formViewModel:t}=e;return t.disabled||t.readOnly}return!1}get featureFormHasAssociation(){return!!this.featureFormViewModel?.activeAssociation}get canGoBack(){return null!=this.activeWorkflow&&!this.syncing}get shouldShowDeleteButton(){const{activeLeafWorkflow:e}=this;if(I.isUpdateRecordWorkflow(e)){const{data:t}=e;return t.editorItem?.capabilities.delete.enabled&&!t.readOnly}return!!I.isUpdateFeaturesWorkflow(e)&&e.data.editorItems.every((e=>e.capabilities.delete.enabled))}get hasPendingEdits(){return this.activeWorkflow?.hasPendingEdits??!1}get snappingManager(){return this._snappingManager}getTemplatesForLayer(e){return this._templatesByLayer.get(e)??[]}async startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.startCreateFeaturesWorkflow()}async startCreateFeaturesWorkflowAtFeatureCreation(e){return this.startCreateFeaturesWorkflow(e,"creating-features")}async startCreateFeaturesWorkflow(e,t="awaiting-feature-creation-info"){if(await p.whenOnce((()=>!this.updating)),!this.canCreate)throw new o("editing:unsupported-workflow","Creating features is unsupported or disabled.");const r=this._createUpdatingResolver();try{await this._cancelWorkflow();const r=this._createCreateFeaturesWorkflow(e,t);this._set("activeWorkflow",r),await r.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{r.resolve()}}async startCreateFeaturesWorkflowAtFeatureEdit(e){await p.whenOnce((()=>!this.updating));const t=this._createUpdatingResolver();try{const{initialFeature:t}=e,r=t.sourceLayer=t.layer,a=r?this.findEditorItemForLayer(r):void 0;if(!a?.supportsCreateFeaturesWorkflow)throw new o("editing:unsupported-workflow","Creating features is unsupported or disabled for this layer.");await this._cancelWorkflow();const i=this._createCreateFeaturesWorkflow({initialFeature:t,layer:a.layer,maxFeatures:1},"creating-features");this._set("activeWorkflow",i),await i.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{t.resolve()}}async startUpdateFeaturesWorkflow(e){if(await p.whenOnce((()=>!this.updating)),!this.canUpdate)return void this._logError("editing:unsupported-workflow","Update features workflow is unsupported or disabled.");if(t.unique(e.map((e=>e.sourceLayer??e.layer))).length>1)throw I.makeMultipleSourceLayersError();const r=this._createUpdatingResolver();try{await this._cancelWorkflow();const t=this._createUpdateFeaturesWorkflow(e);this._set("activeWorkflow",t),await t.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{r.resolve()}}async startUpdateWorkflowAtFeatureSelection(){if(await p.whenOnce((()=>!this.updating)),!this.canUpdate)return void this._logError("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const e=this._createUpdatingResolver();try{await this._cancelWorkflow();const e=this._createUpdateWorkflow();this._set("activeWorkflow",e),await e.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{e.resolve()}}async startUpdateWorkflowAtMultipleFeatureSelection(e){if(await p.whenOnce((()=>!this.updating)),!this.canUpdate)return void this._logError("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const t=this._createUpdatingResolver();try{await this._cancelWorkflow();const t=this._createUpdateWorkflow("awaiting-update-feature-candidate");t.data.candidates=e,this._set("activeWorkflow",t),await t.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{t.resolve()}}async startUpdateWorkflowAtFeatureEdit(e){if(await p.whenOnce((()=>!this.updating)),!this.canUpdate)return void this._logError("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const t=this._createUpdatingResolver();try{await this._cancelWorkflow();const t=this._createUpdateWorkflow("editing-existing-feature");t.data.rootFeature=e,t.addHandles(p.on((()=>t),"commit",(()=>{t.destroy(),this.activeWorkflow===t&&this._set("activeWorkflow",null)}))),this._set("activeWorkflow",t),await t.start()}catch(e){this._logErrorAndCancelWorkflow(e)}finally{t.resolve()}}async startUpdateWorkflowWithActiveSelection(){const{selectionListViewModel:e}=this;if(!e.visibleFeatureCount)throw new o("editing:missing-selection","Unable to determine visible selection.");if(e.visibleLayerCount>1)throw new o("editing:features-different-layers","Cannot start workflow with features from different layers.");const t=e.visibleFeatureItems.map((e=>e.graphic));1===t.length?this.startUpdateWorkflowAtFeatureEdit(t[0]):this.startUpdateFeaturesWorkflow(t)}async deleteFeatureFromWorkflow(){i.deprecatedFunction(l.getLogger(this),"EditorViewModel.deleteFeatureFromWorkflow is deprecated. Use EditorViewModel.deleteFeatures instead.",{version:"4.33",replacement:"EditorViewModel.deleteFeatures",warnOnce:!0}),await this.deleteFeatures()}async deleteFeatures(){const e=this.activeWorkflow;return I.isUpdateWorkflow(e)?e.deleteActiveFeature():I.isUpdateFeaturesWorkflow(e)?e.deleteAndCommit():void this._logError("editing:unsupported-workflow","Deleting features requires an active update workflow.")}async deleteAssociationFromWorkflow(){const{activeWorkflow:e}=this;e&&"update"===e.type?await e.deleteActiveAssociation():this._logError("editing:unsupported-workflow","Deleting an association requires an active update workflow.")}async cancelWorkflow(e){return this._cancelWorkflow({warnIfNoWorkflow:!0,...e})}findEditorItemForLayer(e){return this.editorItems.find((t=>t.layer===e))}itemHasInvalidFormTemplate(e){return null!=e&&!0===this.findEditorItemForLayer(e.layer)?.hasInvalidFormTemplate}syncFeatureTemplates(){this._featureTemplatesViewModelIsRestricted||this._updateTemplates()}zoomTo(e){const{view:r,sketchViewModel:a}=this;if(!r)return;const i=e??a?.createGraphic;if(i)"mesh"===i.geometry?.type?R.goTo(r,i.geometry):R.goTo(r,i);else{const e=a?.updateGraphics?.toArray();"3d"===r.type&&e?.some((e=>"mesh"===e.geometry?.type))?R.goTo(r,e.map((e=>e.geometry)).filter(t.isSome)):e&&R.goTo(r,e)}}async toggleUpdateWorkflow(){this.canUpdate&&(this.hasPendingEdits&&!await this.showDiscardEditsPrompt()||(this.activeWorkflow&&"awaiting-feature-to-update"===this.state?await this.cancelWorkflow({force:!0}):await this.startUpdateWorkflowAtFeatureSelection()))}async onSelectionListItemSelect(e){P.isFeatureItem(e)&&this.startUpdateWorkflowAtFeatureEdit(e.graphic)}async onSelectionListMenuItemSelect(e){if(P.isFeatureItem(e))this.startUpdateWorkflowAtFeatureEdit(e.graphic);else if(P.isLayerItem(e)){const t=e.featureItems.filter((e=>e.visible)).map((e=>e.graphic));1===t.length?this.startUpdateWorkflowAtFeatureEdit(t[0]):this.startUpdateFeaturesWorkflow(t)}}restrictFeatureTemplatesViewModelToLayer(e){return this._featureTemplatesViewModelIsRestricted=!0,this._setFeatureTemplatesViewModelLayers([e]),n.makeHandle((()=>{this._featureTemplatesViewModelIsRestricted=!1,this._setFeatureTemplatesViewModelLayers(this.featureTemplatesLayers)}))}async _getEditorItemCandidates(e){const{view:t}=this;if(!t?.map)return[];const{map:r}=t,a=r.editableLayers.toArray(),i=r.allTables.toArray().filter((e=>m.isFeatureLayer(e)||m.isSubtypeGroupLayer(e)));return await Promise.allSettled([...a.flatMap((e=>this._getLayerLoadPromise(e))),...i.flatMap((e=>this._getLayerLoadPromise(e)))]),d.throwIfAborted(e),[...a.reverse(),...i.reverse()].filter((e=>g.isEditableLayer(e)&&("mesh"!==e.geometryType||"3d"===t.type))).flatMap((e=>"subtype-group"===e.type?e.sublayers.toArray():e))}_getLayerLoadPromise(e){return m.isSubtypeGroupLayer(e)?e.loadAll():e.load()}_drainEditorItems(){this.editorItems.drain((e=>e.destroy()))}_updateEditorItems(){c.abortMaybe(this._updateItemsTask);const{view:e}=this,t=r.createTask((async t=>{if(!e?.map||!e?.allLayerViews)return;const r=await this._getEditorItemCandidates(t);if(!r.length)return void this._drainEditorItems();const a=[],i=[],o=[],{layerInfos:s}=this;for(const t of r){const r=q(s,t),n=await I.whenEditorLayerView(e,t).catch((()=>null));(r?a:n?i:o).push(new S({layer:t,layerInfo:r,layerView:n}))}s?.length&&a.sort(((e,t)=>s.findIndex((({layer:t})=>t===e.layer))-s.findIndex((({layer:e})=>e===t.layer))));const n=[...a,...i,...o];t.aborted||(this._drainEditorItems(),this.editorItems.addMany(n))}));this._updatingHandles.addPromise(t.promise),this._updateItemsTask=t}_updateTemplates(){c.abortMaybe(this._updateTemplatesTask);const e=r.createTask((async e=>{const t=this._templatesByLayer,r=this._featureTemplatesLayersAndTables.filter((e=>!t.has(e)));if(r.length>0){const a=await f.getTemplatesForLayers(r.toArray(),this.view,e);for(const{layer:e,templates:r}of a)t.set(e,r)}this._setFeatureTemplatesViewModelLayers(this.featureTemplatesLayers)}));this._updatingHandles.addPromise(e.promise),this._updateTemplatesTask=e}_setFeatureTemplatesViewModelLayers(e){const t=this._templatesByLayer,r=[];for(const a of e){const e=t.get(a);e&&e.length>0&&r.push(A.makeTemplateGroupInfoForLayer(a,e))}this.featureTemplatesViewModel.templateInfos=r}_afterEditorItemsChange(){const{activeWorkflow:e}=this;if(this.syncFeatureTemplates(),!e)return;const{stepId:t}=e;"create-features"!==e.type?"update"===e.type&&("awaiting-feature-to-update"===t&&!this.canUpdateVisible||"awaiting-update-feature-candidate"===t&&!e.hasUpdatableCandidates)&&this._cancelWorkflow():"awaiting-feature-creation-info"!==t||this.canCreate||this._cancelWorkflow()}async _cancelWorkflow(e){const t=this.activeWorkflow;if(t)if(e&&!1===e.force)try{await t.cancel(e),this._set("activeWorkflow",null),t.destroy()}catch(e){}else{this.emit("workflow-cancel"),this._set("activeWorkflow",null);try{await t.cancel(e)}finally{t.destroy()}}else e?.warnIfNoWorkflow&&this._logError("editing:no-active-workflow","There is no active workflow to cancel.")}_createCreateFeaturesWorkflow(e,t){return E.create({viewModel:this,creationInfo:e,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,startAt:t,applyEditsCallback:(e,t,r)=>this._applyEdits(e,t,r),applyEditsFeatureServiceCallback:(e,t,r)=>this._applyEditsFeatureService(e,t,r),addAttachmentsCallback:(e,t)=>this._addAttachments(e,t)})}_createUpdateFeaturesWorkflow(e){const t=V.create({viewModel:this,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,features:e,applyEdits:(e,t,r)=>this._applyEdits(e,t,r),applyEditsFeatureService:(e,t,r)=>this._applyEditsFeatureService(e,t,r)});return t.addHandles(p.on((()=>t),"commit",(()=>{t.destroy(),this.activeWorkflow===t&&this._set("activeWorkflow",null)}))),t}_createUpdateWorkflow(e){return L.create({viewModel:this,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,startAt:e,applyEditsCallback:(e,t,r)=>this._applyEdits(e,t,r),applyEditsFeatureServiceCallback:(e,t,r)=>this._applyEditsFeatureService(e,t,r),addAttachmentsCallback:(e,t)=>this._addAttachments(e,t)})}_addAttachments(e,t){const r=t.map((t=>this._addAttachment(e,t.feature,t.attachment)))??[];return Promise.all(r)}async _addAttachment(e,t,r){let a=null;if(!("addAttachment"in e)||null==e.capabilities?.attachment)throw new o("editor:attachments-not-supported","Adding attachments is not supported for this layer type");return await this._queueOperation((async()=>(a=await(e.addAttachment?.(t,r).catch((e=>{throw e?.error||e})))??null,a))),a}async _applyEdits(e,t,r){let a=null;const i=e.url?await m.getOwningPortalUrl(e.url):null,o={returnServiceEditsOption:i&&k.parseKnownArcGISOnlineDomain(i)||RegExp("/hosted/","i").test(e.url)?void 0:"original-and-current-features",...r};return await this._queueOperation((async()=>{const{view:r}=this;if(!r)return null;const i=await I.whenEditorLayerView(r,e).catch((()=>null));return a=await e.applyEdits(t,o),i&&await p.whenOnce((()=>!i.updating)),a})),a}async _applyEditsFeatureService(e,t,r){let a=null;return await this._queueOperation((async()=>a=await e.applyEdits(t,r))),a}_queueOperation(e){this._activityQueue.push(e);const t=(e,t)=>{const r=t.indexOf(e);r>-1&&t.splice(r,1)};return e().then((e=>(Array.isArray(e)?e.forEach((e=>this._handleEditsResultError(e))):this._handleEditsResultError(e),e))).catch((r=>{this._logError("editing:operation-error","An error occurred.",{error:r});const a={error:r,retry:()=>(t(a,this.failures),this._queueOperation(e)),cancel:()=>{t(a,this.failures)}};this._set("failures",[...this.failures,a])})).then((()=>{t(e,this._activityQueue)}))}_handleEditsResultError(e){if(null!=e&&"error"in e&&null!=e.error)throw e.error;if(null!=e&&"addFeatureResults"in e){const{addFeatureResults:t,deleteFeatureResults:r,updateFeatureResults:a}=e,i=t.find((e=>!!e.error))||a.find((e=>!!e.error))||r.find((e=>!!e.error));if(i)throw i.error}}_createUpdatingResolver(){const e=d.createResolver();return this._updatingHandles.addPromise(e.promise),e}_logErrorAndCancelWorkflow(e){const{name:t,message:r,details:a}=e;this._logError(t??"editing:workflow-start-failed",r??void 0,a??e),this._cancelWorkflow({force:!0})}_itemIsSuspended(e){const t=this.findEditorItemForLayer(e);return null!=t&&(!t.visible||t.disabled)}_logError(e,t,r){l.getLogger(this).error(new o(e,t,r))}_syncSelectionSources(){this.selectionManager.sources.items=this._selectionSources.toArray()}async _onSelectionComplete(e){if(e.aborted)return;const{operationType:t,selection:r}=e,{effectiveSelectionManager:a}=this,i="ready"===this.state,o=1===r.length;if(this._queuedSelectionTool=void 0,i&&o&&(0===a.count&&"add"===t||"replace"===t))return this._queuedSelectionTool=e.toolName,this.startUpdateWorkflowAtFeatureEdit(r[0]);switch(t){case"remove":a.updateSelection({current:[],added:[],removed:r});break;case"replace":a.clear(),a.updateSelection({current:r,added:[],removed:[]});break;case"add":a.updateSelection({current:r,added:[],removed:[]})}}};return e.__decorate([u.property()],D.prototype,"_featureTemplatesLayersAndTables",null),e.__decorate([u.property()],D.prototype,"_queuedSelectionTool",void 0),e.__decorate([u.property()],D.prototype,"_snappingManager",void 0),e.__decorate([u.property()],D.prototype,"_selectionSources",null),e.__decorate([u.property()],D.prototype,"activeFeatureCount",null),e.__decorate([u.property({readOnly:!0})],D.prototype,"activeWorkflow",void 0),e.__decorate([u.property()],D.prototype,"activeLeafWorkflow",null),e.__decorate([u.property({readOnly:!0})],D.prototype,"_activityQueue",void 0),e.__decorate([u.property({readOnly:!0})],D.prototype,"canCreate",null),e.__decorate([u.property()],D.prototype,"canCreateVisible",null),e.__decorate([u.property({readOnly:!0})],D.prototype,"canUpdate",null),e.__decorate([u.property()],D.prototype,"canUpdateVisible",null),e.__decorate([u.property()],D.prototype,"featureTemplatesLayers",null),e.__decorate([u.property()],D.prototype,"editorItems",void 0),e.__decorate([u.property()],D.prototype,"effectiveSelectionManager",null),e.__decorate([u.property({readOnly:!0})],D.prototype,"failures",void 0),e.__decorate([u.property()],D.prototype,"hideTemplatesForInactiveLayers",void 0),e.__decorate([u.property({type:T})],D.prototype,"attachmentsViewModel",void 0),e.__decorate([u.property()],D.prototype,"featureFormViewModel",null),e.__decorate([u.property()],D.prototype,"formViewModel",null),e.__decorate([u.property()],D.prototype,"utilityNetworkAssociationAddAssociationViewModel",null),e.__decorate([u.property({type:U})],D.prototype,"featureTemplatesViewModel",void 0),e.__decorate([u.property()],D.prototype,"labelOptions",null),e.__decorate([u.property()],D.prototype,"layerInfos",void 0),e.__decorate([u.property()],D.prototype,"ownSketchViewModel",void 0),e.__decorate([u.property()],D.prototype,"selectionListViewModel",void 0),e.__decorate([u.property()],D.prototype,"selectionManager",void 0),e.__decorate([u.property()],D.prototype,"selectionToolbarViewModel",void 0),e.__decorate([u.property()],D.prototype,"sketchOptions",void 0),e.__decorate([u.property()],D.prototype,"sketchViewModel",null),e.__decorate([u.property({type:F,nonNullable:!0})],D.prototype,"snappingOptions",void 0),e.__decorate([u.property()],D.prototype,"spinnerViewModel",void 0),e.__decorate([u.property()],D.prototype,"state",null),e.__decorate([u.property({readOnly:!0})],D.prototype,"syncing",null),e.__decorate([u.property()],D.prototype,"updating",null),e.__decorate([u.property()],D.prototype,"tooltipOptions",null),e.__decorate([u.property()],D.prototype,"valueOptions",null),e.__decorate([u.property()],D.prototype,"view",null),e.__decorate([u.property()],D.prototype,"canZoomTo",null),e.__decorate([u.property()],D.prototype,"pageStack",void 0),e.__decorate([u.property()],D.prototype,"showDiscardEditsPrompt",void 0),e.__decorate([u.property()],D.prototype,"_candidateCommitted",void 0),e.__decorate([u.property()],D.prototype,"page",null),e.__decorate([u.property()],D.prototype,"featureFormDisabled",null),e.__decorate([u.property()],D.prototype,"featureFormHasAssociation",null),e.__decorate([u.property()],D.prototype,"canGoBack",null),e.__decorate([u.property()],D.prototype,"shouldShowDeleteButton",null),e.__decorate([u.property()],D.prototype,"hasPendingEdits",null),e.__decorate([u.property()],D.prototype,"snappingManager",null),D=e.__decorate([w.subclass("esri.widgets.Editor.EditorViewModel")],D),D}));