// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../arcade/featureset/support/shared","../../../core/Logger","../../../layers/FeatureLayer","./featureUtils","../../support/globalCss"],(function(e,r,t,a,n,s,i){"use strict";const o=()=>a.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");async function c(){const[r,t]=await Promise.all([new Promise(((r,t)=>e(["../../../arcade"],r,t))),new Promise(((r,t)=>e(["../../../arcade/arcade"],r,t)))]);return{executor:r,syntaxUtils:t}}function p(e){return{scale:e?.scale,timeProperties:{currentStart:e?.timeExtent?.start,currentEnd:e?.timeExtent?.end,startIncluded:!0,endIncluded:!0}}}function l(e){return{$voxel:e}}function u(e,r,a,n){const s=(e.sourceLayer||e.layer)??void 0;return{$feature:e,$layer:null!=s&&t.isSupportedLayer(s)?s:"scene"===s?.type&&null!=s.associatedLayer?s.associatedLayer:void 0,$map:r,$datastore:s?.url,$userInput:a,$graph:"knowledge-graph-sublayer"===s?.type?s?.parentCompositeLayer?.knowledgeGraph:void 0,$view:p(n)}}async function d({expressionInfo:e,arcade:{executor:r,syntaxUtils:t},graphic:a}){const s=e?.expression;if(!s)return null;const i=function(e){const r="esri.views.3d.layers.VoxelGraphic"===e.declaredClass;return e.isAggregate?"popup-feature-reduction":r?"popup-voxel":"popup"}(a),c=r.createArcadeProfile(i);let d;try{d=await r.createArcadeExecutor(s,c)}catch(r){return o().error("arcade-executor-error",{error:r,expressionInfo:e}),null}const y=new Set;return d.variablesUsed.includes("$view")&&(t.scriptUsesViewProperties(d.syntaxTree,["scale"])&&y.add("view-scale"),t.scriptUsesViewProperties(d.syntaxTree,["timeProperties"])&&y.add("view-time-extent")),{dependencies:y,async evaluate({graphic:r,interceptor:t,location:a,map:s,options:c,spatialReference:y,view:f}){const g=await async function(e,{graphic:r,map:t,location:a,view:s,options:i,interceptor:o,arcadeExecutor:c}){switch(e){case"popup":return{vars:u(r,t,a,s),[Symbol.dispose](){}};case"popup-feature-reduction":{const e=new Set(c.variablesUsed);return await async function(e,r,t,a,s){let i=null;if(s.has("$aggregatedfeatures")){const s=await async function({graphic:e,view:r,options:t}){const{isAggregate:a}=e,n=e.layer??e.sourceLayer;if(!a||!n||"2d"!==r?.type)return[];const s=await r.whenLayerView(n);if(!function(e){return"createQuery"in e&&"queryFeatures"in e}(s))return[];const i=s.createQuery(),o=e.getObjectId();i.aggregateIds=null!=o?[o]:[];const{features:c}=await s.queryFeatures(i,t);return c}({graphic:e,view:r,options:t}),o=e.sourceLayer||e.layer;i=function({layer:e,aggregatedFeatures:r,interceptor:t}){const{fields:a,objectIdField:s,geometryType:i,spatialReference:o,displayField:c}=e;return new n({fields:a,objectIdField:s,geometryType:i,spatialReference:o,displayField:c,interceptor:t,..."feature"===e.type?{templates:e.templates,typeIdField:e.typeIdField,types:e.types}:null,source:r})}({layer:o,aggregatedFeatures:s,interceptor:a})}return{vars:{$feature:e,$aggregatedFeatures:i,$view:p(r)},[Symbol.dispose]:()=>i?.[Symbol.dispose]()}}(r,s,i,o,e)}case"popup-voxel":return{vars:l(r),[Symbol.dispose](){}};default:throw new Error(`Unexpected profile name ${e}`)}}(i,{graphic:r,map:s,location:a,view:f,options:c,interceptor:t,arcadeExecutor:d}),w={abortSignal:c?.signal??void 0,interceptor:t??void 0,rawOutput:!0,spatialReference:y??void 0,timeZone:f?.timeZone,console(...e){o().info(...e)}};try{return await d.executeAsync(g.vars,w)}catch(t){if(c?.signal?.aborted)return;return void o().error("arcade-execution-error",{error:t,graphic:r,expressionInfo:e})}finally{g[Symbol.dispose]()}}}}r.compileExpression=d,r.compileExpressionInfos=async function(e,r){if(!e?.length)return{dependencies:new Set,expressions:new Map};const t=await c(),a=new Set,n=new Map;for(const s of e){const e=await d({expressionInfo:s,arcade:t,graphic:r});n.set(`expression/${s.name}`,e),e?.dependencies.forEach((e=>a.add(e)))}return{dependencies:a,expressions:n}},r.formatArcadeValue=function(e){return"string"==typeof e?s.applyTextFormattingHTML(s.htmlEntities(e)):Array.isArray(e)?function(e){return`<ul class="esri-widget__list">${e.map((e=>`<li>${"string"==typeof e?s.applyTextFormattingHTML(s.htmlEntities(e)):e}</li>`)).join("")}</ul>`}(e):"esri.arcade.Dictionary"===e?.declaredClass?function(e){const r=e.keys().map((r=>{const t=e.field(r);return`<tr><th>${r}</th><td>${"string"==typeof t?s.applyTextFormattingHTML(s.htmlEntities(t)):t}</td></tr>`})).join("");return`<table class="${i.globalCss.table}">${r}</table>`}(e):e},r.loadArcade=c,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})}));