// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["exports","../../intl","../../core/arrayUtils","../../core/compilerUtils","../../core/lang","../../core/Logger","../../core/string","../../form/support/formUtils","../../layers/support/domainUtils","../../layers/support/fieldUtils","../../layers/support/layerUtils","../../smartMapping/support/utils","../support/dateUtils","../support/forms/formUtils","../../intl/substitute"],(function(e,t,n,i,r,o,l,s,a,u,p,m,d,c,f){"use strict";const y=e=>"field"===e?.type,F=e=>"group"===e?.type,g=e=>"relationship"===e?.type,b=e=>"utilityNetworkAssociations"===e.type,I=e=>!F(e)&&null!=e.group,T=e=>e.reduce(((e,t)=>F(t)?[...e,...t.inputs]:[...e,t]),[]),E=(e,t)=>null!=e&&e.input?.type===t,N="expression/";function x(e){const{fields:t,values:n}=e,i=e.timeZone??void 0,r=t.map(((e,t)=>{let r=n[t];if(e.domain&&"coded-value"===e.domain.type){const t=e.domain.codedValues.find((e=>e.code===r));t?.name&&(r=t.name)}return(m.isAnyDateField(e)||u.isTimeOnlyField(e))&&(r=d.getLabelForDateFieldValue(e,r,{timeZone:i,...d.getIntlOptionsForField(e)})),[e.name,r]}));return Object.fromEntries(r)}function V(e,t){return l.replace(l.replace(e,(e=>`{${e.toLowerCase()}}`)),Object.fromEntries(Object.entries(t).map((([e,t])=>[e.toLowerCase(),t]))))}e.extractExpressionNameFromString=function(e){const[t,n]=e.split(N);return""===t&&n?n:(o.getLogger("esri.widgets.FeatureForm/featureFormUtils").error("extractExpressionNameFromString:invalid-input",`The string ${e} is not a valid expression reference of the form '${N}/expressionName'`),"")},e.flattenAssociationInputs=e=>T(e).filter(b),e.flattenFieldInputs=e=>T(e).filter(y),e.flattenInputs=T,e.flattenRelationshipInputs=e=>T(e).filter(g),e.formTemplateHasInvalidFields=function(e,t){const n=t??("formTemplate"in e&&e.formTemplate);return!!n&&(n.elements?.filter(s.isFieldElement)??[]).some((({fieldName:t})=>!e.fieldsIndex.get(t)))},e.getComputedAttributes=x,e.getErrorMessageForFieldInput=(e,t,n)=>{const{dataType:i,error:r,minLength:o}=e,l=t?.validationErrors;if(!l||!r)return null;if(r===c.InputValidationError.CANNOT_BE_EMPTY)return l.cannotBeNull;if(r===a.DomainValidationError.VALUE_OUT_OF_RANGE||r===u.NumericRangeValidationError.OUT_OF_RANGE){const{field:t,range:r}=e,o={type:"date",intlOptions:{timeZone:"date"===t.type&&n?n:void 0,...d.getIntlOptionsForField(t)}},s=c.getRangeErrorMessage(r,l);return f.substitute(s,r,{format:{max:"date"===i?o:null!=r.max&&c.shouldUseScientificNotation(r.max)?c.scientificNumberFormatOptions:c.numberFormatOptions,min:"date"===i?o:null!=r.min&&c.shouldUseScientificNotation(r.min)?c.scientificNumberFormatOptions:c.numberFormatOptions}})}return r===a.DomainValidationError.INVALID_CODED_VALUE?l.invalidCodedValue:r===u.TypeValidationError.INVALID_TYPE?l.invalidType:r===c.InputValidationError.TOO_SHORT?f.substitute(l.tooShort,{min:o}):(c.InputValidationError.TOO_LONG,null)},e.getFieldsInTitleAndDesc=e=>{const t=[];if(e.formTemplate){const{description:n,title:i}=e.formTemplate;e.fields?.forEach((e=>{const r=i&&l.templateHasKey(i,e.name),o=n&&l.templateHasKey(n,e.name);(r||o)&&t.push(e.name)}))}return t},e.getIconForFeature=e=>{if(!e)return;const t=e.layer,n=t&&"geometryType"in t?t.geometryType:void 0,i=e.geometry?.type;return"polyline"===i||"polyline"===n?"line":"mesh"===i||"mesh"===n||"multipatch"===n?"cube":"multipoint"===i||"multipoint"===n?"point":i||n||"table"},e.getNormalizedFeatureTypeInfo=e=>{const t={typeFieldName:null,types:[]};return e?(p.isSubtypeSublayer(e)?(t.typeFieldName=e.parent?.subtypeField,t.types=e.parent?.subtypes??[]):"subtype-group"===e.type||"feature"===e.type&&e.subtypes?.length?(t.typeFieldName=e.subtypeField,t.types=e.subtypes??[]):"types"in e&&e.types&&(t.typeFieldName=e.typeIdField,t.types=e.types.map((({id:e,name:t,domains:n})=>({code:e,name:t,domains:n})))),null!=t.typeFieldName&&(t.typeFieldName=e.getField(t.typeFieldName)?.name??t.typeFieldName),t):t},e.isExpressionReference=function(e){return e.startsWith(N)},e.isFieldElementWithInputType=E,e.isFieldElementWithShowNoValueOptionInput=e=>null!=e&&(E(e,"combo-box")||E(e,"radio-buttons")),e.isFieldInput=y,e.isGroupInput=F,e.isInputInGroupInput=I,e.isInputInThisGroupInput=(e,t)=>I(e)&&e.group===t,e.isLegacyFieldMapsExpressionReference=function(e){return e.startsWith("expr/")},e.isNumberFieldInput=({domain:e,inputType:t="text-box",dataType:n})=>"number"===n&&"text-box"===t&&(!e||"coded-value"!==e.type),e.isRelationshipInput=g,e.isTextElementInput=e=>"text"===e.type,e.isUtilityNetworkAssociationInput=b,e.parseFormTemplateString=function(e){const{attributes:t,fieldsIndex:i,label:r,timeZone:o}=e;if(!t||"object"!=typeof t)return r;const s=Object.keys(t).filter((e=>l.templateHasKey(r,e))),a=s.map((e=>t[e])),u=s.map((e=>i.get(e))).filter(n.isSome);return V(r,x({values:a,fields:u,timeZone:o}))},e.prependExpressionPrefix=function(e){return`${N}${e}`},e.prependFieldPrefix=function(e){return`field/${e}`},e.substituteFieldTemplatesInString=V,e.subtypeChangeShouldPrompt=function(e,t,n){const i=p.getSubtypesFromLayer(e),o=i?.find((e=>e.code===n));if(!o)return!1;const l=i?.find((e=>e.code===t));return!r.equalsShallow(o.defaultValues,l?.defaultValues)&&Object.values(o.defaultValues).some((e=>null!=e))},e.valueIsInvalidSwitchValue=function(e,t){return null==e||t.onValue!==e&&t.offValue!==e},e.valueIsValidContingentValue=function(e,t){switch(t.objectType){case"any":return!0;case"null":return null==e;case"code":return e===t.codedValue?.code;case"range":return null!=e&&null!=t.minValue&&null!=t.maxValue&&+e>=t.minValue&&+e<=t.maxValue;default:return i.neverReached(t.objectType),!1}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));