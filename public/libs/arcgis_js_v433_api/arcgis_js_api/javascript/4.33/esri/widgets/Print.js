// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["require","../chunks/tslib.es6","../intl","../core/deprecate","../core/jsonMap","../core/Logger","../core/reactiveUtils","../core/unitFormatUtils","../core/urlUtils","../core/accessorSupport/decorators/property","../core/accessorSupport/ensureType","../core/has","../core/RandomLCG","../core/accessorSupport/decorators/subclass","../geometry/SpatialReference","../geometry/support/spatialReferenceUtils","../portal/support/urlUtils","../rest/utils","../rest/support/fileFormat","./Widget","./Print/PrintViewModel","../chunks/componentsUtils","./support/globalCss","./support/Heading","./support/legacyIcon","./support/widgetUtils","./support/decorators/messageBundle","./support/jsxFactory","../intl/number"],(function(e,t,a,i,l,s,n,o,r,c,p,d,u,m,h,b,_,x,y,g,v,w,f,T,k,C,S,I,O){"use strict";const $="map-only";var E;!function(e){e.layout="layoutTab",e.mapOnly="mapOnlyTab",e.export="exportTab"}(E||(E={}));const L="esri-print",M={base:L,headerTitle:`${L}__header-title`,layoutTabList:`${L}__layout-tab-list`,layoutTab:`${L}__layout-tab`,layoutSection:`${L}__layout-section`,mapOnlySection:`${L}__map-only-section`,panelItemsCentered:`${L}__panel-items--centered`,loader:`${L}__loader`,swapButton:`${L}__swap-button`,printButton:`${L}__export-button`,printButtonSection:`${L}__export-button-section`,printButtonSectionDivider:`${L}__export-button-section--divider`,templateSelectContainer:`${L}__template-select-container`,templateSelectIcon:`${L}__template-select-icon`,templateSelectError:`${L}__template-select-error`,templateSelectArrow:`${L}__template-select-arrow`,formSectionContainer:`${L}__form-section-container`,advancedOptionsSection:`${L}__advanced-options-section`,advancedOptionsContainer:`${L}__advanced-options-container`,browseTemplateButtonContainer:`${L}__browse-template-button-container`,browseTemplateButtonContainerFilter:`${L}__browse-template-button-container-filter`,exportedFilesContainer:`${L}__export-panel-container`,exportedFilesTitle:`${L}__export-title`,exportedFile:`${L}__exported-file`,exportedFileLinkTitle:`${L}__exported-file-link-title`,exportedFileLinkDescription:`${L}__exported-file-link-description`,exportedFilesEmpty:`${L}__exported-files-empty`,printWidgetContainer:`${L}__container`,content:`${L}__content`,panelContainer:`${L}__panel-container`,scaleInfoContainer:`${L}__scale-info-container`,scaleInputContainer:`${L}__scale-input-container`,scaleInput:`${L}__scale-input`,sizeContainer:`${L}__size-container`,panelError:`${L}__panel--error`,exportedFileLoader:`${L}__exported-file--loader`,exportSection:`${L}__export-section`,exportSectionCentered:`${L}__export-section--centered`,templateButtonContainer:`${L}__template-button-container`,templateDoneButton:`${L}__template-done-button`,templateSelectFlowItemContainer:`${L}__template-select-flow-item-container`,templateSelectFlowItemContent:`${L}__template-select-flow-item-content`,templateSelectFlowItemListHeading:`${L}__template-select-flow-item-list-heading`,srLabel:`${L}__sr-label`,invalidWkidText:`${L}__invalid-wkid-text`};function P(e){return e?.toLowerCase()===$}function F(e){const{state:t,extension:a}=e;switch(t){case"pending":return"spinner";case"error":return"exclamation-mark-circle";default:return a?.toLowerCase()?.includes("pdf")?"file-pdf":"file"}}const A=new l.JSONMap({inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers"}),R=new Map([["a3-landscape","a3-landscape"],["a3-portrait","a3-portrait"],["a4-landscape","a4-landscape"],["a4-portrait","a4-portrait"],["letter-ansi-a-landscape","ansi-a-landscape"],["letter-ansi-a-portrait","ansi-a-portrait"],["tabloid-ansi-b-landscape","ansi-b-landscape"],["tabloid-ansi-b-portrait","ansi-b-portrait"]]);let B=class extends g{constructor(e,t){super(e,t),this._activeTabFocusRequested=!1,this._awaitingServerResponse=!1,this._selectedTab=E.layout,this._pendingExportScroll=!1,this._rootNode=null,this._selectedTemplate=null,this._formats=[],this._showTemplates=!1,this._isValidSpatialReference=!0,this.allowedFormatsForSaving=null,this.browseTemplateButtonOnClick=null,this.headerVisible=!0,this.headingLevel=3,this.includeOrganizationTemplates=!0,this.messagesCommon=null,this.messagesUnits=null,this.saveExportHidden=!0,this.saveAsButtonCallback=null,this.viewModel=new v,this._onInput=e=>{this._selectedTab===E.layout?this.templateOptions.title=e.currentTarget.value:this._selectedTab===E.mapOnly&&(this.templateOptions.fileName=e.currentTarget.value)},this._handleLinkClick=e=>{const t=e.currentTarget["data-item"];if(!t||"ready"!==t.state||!t.url)return;const a=x.findToken(this.viewModel.effectivePrintServiceUrl),i=t.url,l=document.createElement("a");if(l.target="_blank",l.href=i,l.rel="noreferrer",l.download=t.formattedName??"",!a)return l.click(),void e.stopPropagation();e.preventDefault();const s=new URL(i);s.searchParams.set("token",a),l.href=s.href,l.click(),l.href=i},i.deprecateWidget(s.getLogger(this),"Print","arcgis-print",{version:"4.33"}),this._focusOnTabChange=this._focusOnTabChange.bind(this)}initialize(){this.addHandles([n.watch((()=>[this.templateOptions.format,this.viewModel.templatesInfo?.format]),(()=>{const{templatesInfo:e}=this.viewModel;if(!e)return;if(this._formats.length!==e.format.choiceList.length){const t=y.formatJsonMap.apiValues;this._formats=e.format.choiceList.map((e=>{const a=t.find((t=>new RegExp(`\\b${t}\\b`,"i").test(e)))??e;return{value:a,label:e===a?e.toUpperCase():e}})).sort(((e,t)=>e.label.localeCompare(t.label)))}const t=this._formats.some((({value:e})=>new RegExp(`\\b${e}\\b`,"i").test(this.templateOptions.format)));if(!e.format.defaultValue||t);else{const t=this._formats.find((({value:t})=>new RegExp(`\\b${t}\\b`,"i").test(e.format.defaultValue)))?.value;t&&(this.templateOptions.format=t)}})),n.watch((()=>[this.templateOptions.id,this.viewModel.loaded]),(async()=>{const{layout:e}=this.templateOptions;this._selectedTab=P(e)?E.mapOnly:E.layout,this._selectedTab===E.layout&&this.viewModel.loaded&&(this._selectedTemplate=this.viewModel.getLayoutTemplateById(this.templateOptions.id))})),n.watch((()=>this.templateOptions.dpi),(e=>{e<=0&&(this.templateOptions.dpi=1)})),n.watch((()=>this.viewModel.view?.scale),(e=>{!e||this.templateOptions.scaleEnabled&&this.templateOptions.scale||(this.templateOptions.scale=e)})),n.on((()=>this.viewModel),"submit",(e=>this.emit("submit",e))),n.on((()=>this.viewModel),"complete",(e=>this.emit("complete",e)))]);const{height:e,width:t}=this.templateOptions;this.templateOptions.width=t||800,this.templateOptions.height=e||1100;const a=setTimeout((()=>{this._awaitingServerResponse=!0,this.scheduleRender()}),500);this.viewModel.load().then((()=>{clearTimeout(a),this._awaitingServerResponse=!1}))}loadDependencies(){return w.loadCalciteComponents({action:()=>new Promise(((t,a)=>e(["../chunks/index12"],t,a))),block:()=>new Promise(((t,a)=>e(["../chunks/index13"],t,a))),button:()=>new Promise(((t,a)=>e(["../chunks/index2"],t,a))),checkbox:()=>new Promise(((t,a)=>e(["../chunks/index44"],t,a))),combobox:()=>new Promise(((t,a)=>e(["../chunks/index21"],t,a))),"combobox-item":()=>new Promise(((t,a)=>e(["../chunks/index22"],t,a))),flow:()=>new Promise(((t,a)=>e(["../chunks/index14"],t,a))),"flow-item":()=>new Promise(((t,a)=>e(["../chunks/index15"],t,a))),icon:()=>new Promise(((t,a)=>e(["../chunks/index7"],t,a))),input:()=>new Promise(((t,a)=>e(["../chunks/index4"],t,a))),"input-number":()=>new Promise(((t,a)=>e(["../chunks/index28"],t,a))),label:()=>new Promise(((t,a)=>e(["../chunks/index5"],t,a))),list:()=>new Promise(((t,a)=>e(["../chunks/index16"],t,a))),"list-item":()=>new Promise(((t,a)=>e(["../chunks/index20"],t,a))),loader:()=>new Promise(((t,a)=>e(["../chunks/index32"],t,a))),switch:()=>new Promise(((t,a)=>e(["../chunks/index33"],t,a))),chip:()=>new Promise(((t,a)=>e(["../chunks/index11"],t,a))),popover:()=>new Promise(((t,a)=>e(["../chunks/index57"],t,a))).then((e=>e.index)),link:()=>new Promise(((t,a)=>e(["../chunks/index66"],t,a)))})}destroy(){this.viewModel.destroy()}get allowedFormats(){return this.viewModel.allowedFormats}set allowedFormats(e){this.viewModel.allowedFormats=e}get allowedLayouts(){return this.viewModel.allowedLayouts}set allowedLayouts(e){this.viewModel.allowedLayouts=e}get error(){return this.viewModel.error}get exportedLinks(){return this.viewModel.exportedLinks}set exportedLinks(e){this.viewModel.exportedLinks=e}get extraParameters(){return this.viewModel.extraParameters}set extraParameters(e){this.viewModel.extraParameters=e}get icon(){return"print"}set icon(e){this._overrideIfSome("icon",e)}get includeDefaultTemplates(){return this.viewModel.includeDefaultTemplates}set includeDefaultTemplates(e){this.viewModel.includeDefaultTemplates=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get outSpatialReference(){return this.viewModel.outSpatialReference}set outSpatialReference(e){this.viewModel.outSpatialReference=e}get portal(){return this.viewModel.portal}set portal(e){this.viewModel.portal=e}get saveExportEnabled(){return this.viewModel.saveExportEnabled}set saveExportEnabled(e){this.viewModel.saveExportEnabled=e}get showPrintAreaEnabled(){return this.viewModel.showPrintAreaEnabled}set showPrintAreaEnabled(e){this.viewModel.showPrintAreaEnabled=e}get printServiceUrl(){return this.viewModel.printServiceUrl}set printServiceUrl(e){this.viewModel.printServiceUrl=e}get templateCustomTextElements(){return this.viewModel.templateCustomTextElements}set templateCustomTextElements(e){this.viewModel.templateCustomTextElements=e}get templateOptions(){return this.viewModel.templateOptions}set templateOptions(e){this.viewModel.templateOptions=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const{messages:e,templateOptions:t,viewModel:a,view:i}=this,{attributionEnabled:l,author:s,copyright:n,dpi:o,format:r,height:c,layout:d,layoutItem:u,legendEnabled:m,northArrowEnabled:_,scaleBarEnabled:x,scaleEnabled:y,scale:g,width:v}=t,w="ready"!==a.state||this._awaitingServerResponse||!(d||u),S=this._renderTitleOrFileNameSection(),O=I.tsx("div",{class:M.formSectionContainer},I.tsx("calcite-label",null,e.fileFormatTitle,I.tsx("calcite-combobox",{clearDisabled:!0,label:e.formatDefaultOption,maxItems:6,placeholder:e.formatDefaultOption,selectionMode:"single-persist",onCalciteComboboxChange:({currentTarget:e})=>{this.templateOptions.format=e.selectedItems[0]?.value??"pdf"}},this._formats.map((({value:e,label:t},a)=>I.tsx("calcite-combobox-item",{key:`file-format-${a}`,selected:e===this.templateOptions.format,textLabel:t,value:e})))))),$=I.tsx("calcite-label",{layout:"inline"},I.tsx("calcite-switch",{checked:this.showPrintAreaEnabled,onCalciteSwitchChange:e=>{this.showPrintAreaEnabled=!!e.currentTarget.checked}}),e.printPreview),L=I.tsx("div",null,I.tsx("div",{class:M.formSectionContainer},I.tsx("calcite-label",null,e.template,I.tsx("calcite-block",{class:M.templateSelectContainer,collapsible:!1,description:this._getPageSizeLabel(this._selectedTemplate),heading:this._getTemplateLabel(this._selectedTemplate,!0),key:"template-select-block",loading:"loading"===this._selectedTemplate?.state,onclick:()=>this._showTemplates=!0,onkeydown:e=>{"Enter"!==e.key&&" "!==e.key||(this._showTemplates=!0)},tabIndex:0},I.tsx("calcite-icon",{class:M.templateSelectIcon,icon:(this._selectedTemplate?.layout?R.get(this._selectedTemplate.layout):null)||"custom-print",key:"template-select-icon",scale:"l",slot:"content-start"}),"error"===this._selectedTemplate?.state?I.tsx("calcite-icon",{class:M.templateSelectError,icon:"exclamation-mark-circle",key:"template-select-error",scale:"s",slot:"actions-end"}):null,I.tsx("calcite-icon",{class:M.templateSelectArrow,icon:C.isRTL()?"chevron-left":"chevron-right",key:"template-select-arrow",scale:"s",slot:"actions-end"})))),$),P=I.tsx("div",{class:M.formSectionContainer},I.tsx("calcite-label",null,e.dpi,I.tsx("calcite-input-number",{bind:this,"data-input-name":"dpi",min:1,value:`${o}`,onCalciteInputNumberInput:this._updateNumberInputValue}))),F=I.tsx("div",{class:M.formSectionContainer},I.tsx("calcite-label",null,I.tsx("div",{class:M.srLabel},e.outSpatialReference,I.tsx("calcite-link",{href:"https://developers.arcgis.com/rest/services-reference/enterprise/using-spatial-references/",target:"_blank"},"(WKID)")),I.tsx("calcite-input-number",{bind:this,"data-input-name":"outSpatialReference",integer:!0,numberButtonType:"none",value:a.outSpatialReference?.wkid?.toString()??"",onCalciteInputNumberInput:({currentTarget:e})=>{const t=p.ensureInteger(e.value);a.outSpatialReference=Number.isNaN(t)||null==t?null:new h({wkid:t}),this._isValidSpatialReference=!a.outSpatialReference||b.isValid(a.outSpatialReference)}}),this._isValidSpatialReference?null:I.tsx("div",{class:M.invalidWkidText,key:`out-sr-${a.outSpatialReference?.wkid}`},e.invalidWkid))),A=I.tsx("div",{class:this.classes(M.scaleInfoContainer,M.formSectionContainer)},I.tsx("calcite-label",{layout:"inline"},I.tsx("calcite-checkbox",{bind:this,checked:y,"data-option-name":"scaleEnabled",onCalciteCheckboxChange:this._toggleInputValue}),e.scale),I.tsx("div",{class:M.scaleInputContainer},I.tsx("calcite-input-number",{"aria-label":e.scaleLabel,"aria-valuenow":`${g}`,bind:this,class:M.scaleInput,"data-input-name":"scale",disabled:!y,value:`${g}`,onCalciteInputNumberInput:this._updateNumberInputValue}),I.tsx("calcite-button",{appearance:"outline","aria-label":e.reset,bind:this,disabled:!y,iconStart:"refresh",kind:"neutral",onclick:this._resetToCurrentScale}))),B=I.tsx("div",{"aria-labelledby":`${this.id}__advancedOptionsForLayout`,class:M.advancedOptionsContainer,key:"advanced-section-for-layout"},A,this._selectedTemplate?.layoutTemplateInfo?.layoutOptions?.hasAuthorText??1?I.tsx("div",{class:M.formSectionContainer,key:"author-info"},I.tsx("calcite-label",null,e.author,I.tsx("calcite-input",{bind:this,"data-input-name":"author",value:s??"",onCalciteInputInput:this._updateInputValue}))):null,this._selectedTemplate?.layoutTemplateInfo?.layoutOptions?.hasCopyrightText??1?I.tsx("div",{class:M.formSectionContainer,key:"copyright-text"},I.tsx("calcite-label",null,e.copyright,I.tsx("calcite-input",{bind:this,"data-input-name":"copyright",value:n??"",onCalciteInputInput:this._updateInputValue}))):null,P,F,this._renderCustomTextElementSection(),this._selectedTemplate?.layoutTemplateInfo?.layoutOptions?.hasLegend??1?I.tsx("div",{class:M.formSectionContainer,key:"legend-info"},I.tsx("calcite-label",{layout:"inline"},I.tsx("calcite-checkbox",{bind:this,checked:!!m,"data-option-name":"legendEnabled",onCalciteCheckboxChange:this._toggleInputValue}),e.legend)):null,this._selectedTemplate?.mapSurroundInfoOptions?.northArrow.length?I.tsx("div",{class:M.formSectionContainer,key:"north-arrow"},I.tsx("calcite-label",{layout:"inline"},I.tsx("calcite-checkbox",{bind:this,checked:!!_,"data-option-name":"northArrowEnabled",onCalciteCheckboxChange:this._toggleInputValue}),e.northArrow)):null,this._selectedTemplate?.mapSurroundInfoOptions?.scaleBar.length?I.tsx("div",{class:M.formSectionContainer,key:"scale-bar"},I.tsx("calcite-label",{layout:"inline"},I.tsx("calcite-checkbox",{bind:this,checked:!!x,"data-option-name":"scaleBarEnabled",onCalciteCheckboxChange:this._toggleInputValue}),e.scaleBar)):null),N=I.tsx("div",{"aria-labelledby":`${this.id}__advancedOptionsForMapOnly`,class:M.advancedOptionsContainer},A,P,F,I.tsx("div",{class:M.formSectionContainer},I.tsx("calcite-label",{layout:"inline"},I.tsx("calcite-checkbox",{bind:this,checked:l,"data-option-name":"attributionEnabled",onCalciteCheckboxChange:this._toggleInputValue}),e.attribution)),this._renderCustomTextElementSection()),V=this.exportedLinks.toArray(),D=this._renderExportedLinkItems(V),U={[M.exportSectionCentered]:!V.length},H=this._selectedTab===E.layout?I.tsx("section",{"aria-labelledby":`${this.id}__layoutTab`,class:M.layoutSection,id:`${this.id}__layoutContent`,key:"esri-print__layoutContent",role:"tabpanel"},I.tsx("div",{class:M.panelContainer},this._selectedTemplate?.layoutTemplateInfo?.layoutOptions?.hasTitleText??1?S:null,L,this._selectedTab===E.layout?O:null,I.tsx("calcite-block",{"aria-label":e.advancedOptions,class:this.classes(M.panelContainer,M.advancedOptionsSection),collapsible:!0,disabled:!(d||u?.id),heading:e.advancedOptions,id:"advancedOptionsForLayout",key:"advanced-options-for-layout"},B))):this._selectedTab===E.mapOnly?I.tsx("section",{"aria-labelledby":`${this.id}__mapOnlyTab`,class:M.mapOnlySection,id:`${this.id}__mapOnlyContent`,key:"esri-print__mapOnlyContent",role:"tabpanel"},I.tsx("div",{class:M.panelContainer},S,O,I.tsx("div",null,I.tsx("div",{class:this.classes(M.sizeContainer,M.formSectionContainer)},I.tsx("calcite-label",null,e.width,I.tsx("calcite-input-number",{bind:this,"data-input-name":"width",value:`${v}`,onCalciteInputNumberInput:this._updateNumberInputValue})),I.tsx("calcite-label",null,e.height,I.tsx("calcite-input-number",{bind:this,"data-input-name":"height",value:`${c}`,onCalciteInputNumberInput:this._updateNumberInputValue})),I.tsx("button",{"aria-label":e.swap,bind:this,class:this.classes(f.globalCss.widgetButton,M.swapButton,k.legacyIcon.swap),onclick:this._switchInput,type:"button"})),$),I.tsx("calcite-block",{"aria-label":e.advancedOptions,class:this.classes(M.panelContainer,M.advancedOptionsSection),collapsible:!0,heading:e.advancedOptions,id:"advancedOptionsForMapOnly",key:"advanced-options-for-map-only"},N))):I.tsx("section",{"aria-labelledby":`${this.id}__exportTab`,class:this.classes(M.exportSection,U),id:`${this.id}__exportContent`,key:"esri-print__exportContent",role:"tabpanel"},I.tsx("div",{class:M.panelContainer},I.tsx("div",{afterUpdate:this._scrollExportIntoView,bind:this,class:M.exportedFilesContainer},0===V.length?I.tsx("div",{class:M.exportedFilesEmpty},I.tsx("calcite-icon",{icon:"file",scale:"l"}),I.tsx("div",null,I.tsx(T.Heading,{class:M.exportedFilesTitle,level:this.headingLevel},e.noExportedFiles),I.tsx("div",null,e.exportHint))):D))),z="2d"!==i?.type,W=I.tsx("div",{class:M.panelError},i?z?e.sceneViewError:e.serviceError:e.noViewError),q=V.some((({state:e})=>"pending"===e)),j=I.tsx("div",{class:M.content,key:"panel"},I.tsx("div",null,I.tsx("ul",{bind:this,class:M.layoutTabList,onclick:this._toggleLayoutPanel,onkeydown:this._handleLayoutPanelKeyDown,role:"tablist"},I.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,"aria-selected":`${this._selectedTab===E.layout}`,class:M.layoutTab,"data-tab-id":E.layout,id:`${this.id}__layoutTab`,role:"tab",tabIndex:0},e.layoutTab),I.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,"aria-selected":`${this._selectedTab===E.mapOnly}`,class:M.layoutTab,"data-tab-id":E.mapOnly,id:`${this.id}__mapOnlyTab`,role:"tab",tabIndex:0},e.mapOnlyTab),I.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,"aria-selected":`${this._selectedTab===E.export}`,class:M.layoutTab,"data-tab-id":E.export,id:`${this.id}__exportedFilesTab`,role:"tab",tabIndex:0},q?I.tsx("calcite-loader",{inline:!0,label:"loading",scale:"s"}):null,e.exportsTab)),H),this._selectedTab!==E.export?I.tsx("div",{class:this.classes(M.printButtonSection,!this.saveExportHidden&&this.portal?M.printButtonSectionDivider:null),key:"export-button-section"},!this.saveExportHidden&&this.portal?I.tsx("calcite-label",{layout:"inline"},I.tsx("calcite-checkbox",{bind:this,checked:this.saveExportEnabled,onCalciteCheckboxChange:e=>{this.saveExportEnabled=!!e.currentTarget.checked}}),e.saveExportToMyContent):null,I.tsx("calcite-button",{"aria-label":e.exportDescription,bind:this,class:this.classes(M.printButton),disabled:w||!(d||u?.id)&&!r,onclick:this._handlePrintMap,scale:"l",width:"full"},e.export)):null),K=I.tsx("calcite-flow",{key:"root-flow"},I.tsx("calcite-flow-item",{bind:this,key:"root-flow-item",selected:!this._showTemplates},I.tsx("div",{class:M.printWidgetContainer},this.headerVisible?I.tsx("header",{class:M.headerTitle},e.export):null,this.error||z||!i?W:j)),this._renderChooseTemplateFlowItem()),J="initializing"===a.state,G=J?this._renderLoader():K,Q={[M.panelItemsCentered]:J};return I.tsx("div",{bind:this,class:this.classes(M.base,f.globalCss.widget,f.globalCss.panel,Q)},G)}_getPageSizeLabel(e){if(!e)return;const t=e.layoutTemplateInfo;if(!t)return;const a=A.fromJSON(t.pageUnits.toLowerCase());return`${O.formatNumber(t.pageSize[0])} × ${O.formatNumber(t.pageSize[1])} ${o.unitName(this.messagesUnits,a,"abbr")}`}_getTemplateLabel(e,t=!1){if(!e)return t?this.messages.selectTemplate:this.messages.untitled;const{label:a,layout:i,layoutItem:l,type:s}=e;if("print-service-template"===s&&this.messages[i])return this.messages[i];const n=a??i??l?.id;return n?.replaceAll("_"," ")??this.messages.untitled}_getPortalTemplates(){const{portalTemplateIds:e}=this.viewModel;return this.includeDefaultTemplates&&this.includeOrganizationTemplates?this.viewModel.defaultTemplates.toArray().filter((({layout:t,layoutItem:a})=>!P(t)&&!!a?.id&&e.includes(a.id))):[]}_getDefaultTemplates(){const{portalTemplateIds:e}=this.viewModel;return this.includeDefaultTemplates?this.viewModel.defaultTemplates.toArray().filter((({layout:t,layoutItem:a})=>!(P(t)||a?.id&&e.includes(a.id)))):[]}_getPrintServiceTemplates(){return this.includeDefaultTemplates&&this._getDefaultTemplates().length?[]:this.viewModel.printServiceTemplates.toArray().filter((({layout:e})=>!P(e)))}_renderLayoutTemplates(e,t=!1,a=!1){return t&&e.sort(((e,t)=>(e.label??"")>(t.label??"")?1:-1)),e.map((e=>I.tsx("calcite-list-item",{description:this._getPageSizeLabel(e),key:`template-${e.id}-${e.id===this.templateOptions.id}`,label:this._getTemplateLabel(e),selected:e.id===this.templateOptions.id,title:e.description??"",value:e},I.tsx("calcite-icon",{icon:(e.layout?R.get(e.layout):null)||"custom-print",slot:"content-start"}),"loading"===e.state?I.tsx("calcite-loader",{inline:!0,key:`template-loader-${e.id}`,label:"loading",scale:"s",slot:"content-end"}):null,"error"===e?.state?I.tsx("calcite-icon",{class:M.templateSelectError,icon:"exclamation-mark-circle",key:`template-error-${e.id}`,scale:"s",slot:"content-end"}):null,a?I.tsx("calcite-action",{icon:"trash",onclick:()=>this.viewModel.removePortalTemplate(e),slot:"actions-end",text:"delete"}):null)))}_renderChooseTemplateFlowItem(){if(!this._showTemplates)return null;const{messages:e}=this,t=_.reArcGISOnlineDomain.test(this.portal?.url),a=this.viewModel.browseTemplates.toArray(),i=this._getPortalTemplates(),l=this._getDefaultTemplates(),s=this._getPrintServiceTemplates(),n=a.length+i.length+l.length+s.length>15,o=this.browseTemplateButtonOnClick?I.tsx("calcite-button",{appearance:"outline",class:n?M.browseTemplateButtonContainerFilter:M.browseTemplateButtonContainer,iconStart:"folder",key:"browse-template-button",onclick:this.browseTemplateButtonOnClick,slot:n?"filter-actions-end":"default"},n?null:e.browseTemplates):null;return I.tsx("calcite-flow-item",{bind:this,closable:!1,heading:e.chooseTemplate,key:"template-flow-item",selected:this._showTemplates,onCalciteFlowItemBack:e=>{e.preventDefault(),this._showTemplates=!1}},I.tsx("div",{class:M.templateSelectFlowItemContainer},I.tsx("div",{class:M.templateSelectFlowItemContent},n?null:o,I.tsx("calcite-list",{filterEnabled:n,filterProps:["label"],key:"template-list",label:e.templateList,selectionMode:"single-persist",onCalciteListChange:({currentTarget:e})=>this.viewModel.applyTemplate(e.selectedItems[0]?.value)},n?o:null,a.length?I.tsx("div",{key:"my-templates"},I.tsx("div",{class:M.templateSelectFlowItemListHeading},e.myTemplates,t?I.tsx("calcite-chip",{appearance:"outline",kind:"neutral",label:e.beta,scale:"s"},e.beta):null),this._renderLayoutTemplates(a,!0,!0)):null,i.length?I.tsx("div",{key:"org-templates"},I.tsx("div",{class:M.templateSelectFlowItemListHeading},e.organizationTemplates,t?I.tsx("calcite-chip",{appearance:"outline",kind:"neutral",label:e.beta,scale:"s"},e.beta):null),this._renderLayoutTemplates(i)):null,a.length||i.length?l.length?I.tsx("div",{key:"default-templates"},I.tsx("div",{class:M.templateSelectFlowItemListHeading},e.defaultTemplates),this._renderLayoutTemplates(l,!0)):null:this._renderLayoutTemplates(l,!0),a.length||i.length?s.length?I.tsx("div",{key:"service-templates"},I.tsx("div",{class:M.templateSelectFlowItemListHeading},e.defaultTemplates),this._renderLayoutTemplates(s)):null:this._renderLayoutTemplates(s))),I.tsx("div",{class:M.templateButtonContainer},I.tsx("calcite-button",{class:M.templateDoneButton,onclick:()=>this._showTemplates=!1},this.messagesCommon.done))))}_renderCustomTextElementSection(){const{customTextElements:e}=this.templateOptions;return e?I.tsx("div",{class:M.formSectionContainer,key:"custom-text-elements"},e.map(((e,t)=>{const[a,i]=Object.entries(e)[0];return"date"===a?null:I.tsx("calcite-label",{key:`custom-text-elements-${a}-${t}`},a,I.tsx("calcite-input",{bind:this,"data-input-custom":!0,"data-input-name":a,value:i??"",onCalciteInputInput:this._updateInputValue}))}))):null}_renderTitleOrFileNameSection(){const{title:e,fileName:t,titlePlaceHolder:a,fileNamePlaceHolder:i}=this.messages,l=this._selectedTab===E.layout?e:t,s=this._selectedTab===E.layout?a:i,n=this._selectedTab===E.layout?this.templateOptions.title:this.templateOptions.fileName;return I.tsx("div",{class:M.formSectionContainer,key:l},I.tsx("calcite-label",null,l,I.tsx("calcite-input",{placeholder:s,value:n??"",onCalciteInputInput:this._onInput})))}_focusOnTabChange(e){if(!this._activeTabFocusRequested)return;const t=e.getAttribute("data-tab-id");("layoutTab"===t&&this._selectedTab===E.layout||"mapOnlyTab"===t&&this._selectedTab===E.mapOnly||"exportTab"===t&&this._selectedTab===E.export)&&(e.focus(),this._activeTabFocusRequested=!1)}_renderLoader(){const e={[M.loader]:this._awaitingServerResponse};return I.tsx("div",{class:this.classes(e),key:"loader"})}_resetToCurrentScale(){this.templateOptions.scale=this.viewModel.view?.scale}_updateCustomTextElementValue(e,t,a){e.find((e=>{const[a]=Object.entries(e)[0];return a===t}))[t]=a}_updateInputValue(e){const t=e.currentTarget,a=t.getAttribute("data-input-name"),i=!!t["data-input-custom"],{templateOptions:l}=this;i?this._updateCustomTextElementValue(l.customTextElements,a,t.value):l[a]=t.value}_updateNumberInputValue(e){const t=e.currentTarget,a=t.getAttribute("data-input-name"),{templateOptions:i}=this,l=Number(t.value);if(s=l,!isNaN(s)&&s>0&&Number.isFinite(s)){var s;i[a]=l}else{const e=i[a];t.value=`${e}`}}_handlePrintMap(){this._pendingExportScroll=!0;const{templateOptions:e}=this,t=this._selectedTab===E.layout?e.title:e.fileName,{promise:a}=this.viewModel.export(t||this.messages.untitled);this._selectedTab=E.export,a.then((()=>this.scheduleRender()))}_switchInput(){[this.templateOptions.width,this.templateOptions.height]=[this.templateOptions.height,this.templateOptions.width]}_scrollExportIntoView(){if(!this._pendingExportScroll)return;this._pendingExportScroll=!1;const e=this._rootNode;if(!e)return;const{clientHeight:t,scrollHeight:a}=e,i=a-t;i>0&&(e.scrollTop=i)}_toggleInputValue(e){const t=e.target,a=t.getAttribute("data-option-name");this.templateOptions[a]=t.checked,"scaleEnabled"===a&&this._resetToCurrentScale()}_renderExportedLinkItemPopover(e){const t=this.messages,a=e.formattedName??"",{state:i}=e,l=this.saveAsButtonCallback&&"error"!==i&&this._isFormatAllowedForSaving(e.extension);return"pending"!==i&&l?I.tsx("calcite-popover",{autoClose:!0,key:`${a}-popover`,label:"Popover",offsetDistance:1,overlayPositioning:"fixed",pointerDisabled:!0,referenceElement:`${a}-popover-button`,scale:"s"},I.tsx("calcite-list",{label:""},e.portalItem?I.tsx("calcite-list-item",{label:t.openItem,onCalciteListItemSelect:()=>{const t=e.portalItem;if(!t||!t.itemPageUrl)return;const a=document.createElement("a");a.target="_blank",a.href=t.itemPageUrl,a.rel="noreferrer",a.click()}},I.tsx("calcite-icon",{icon:"launch2",key:`${a}-launch-icon`,scale:"s",slot:"content-start"})):I.tsx("calcite-list-item",{label:t.saveAs,onCalciteListItemSelect:async()=>{this.saveAsButtonCallback&&(n.whenOnce((()=>e.portalItem)).then((e=>{e.itemPageUrl&&this.scheduleRender()})),await this.saveAsButtonCallback(e))}},I.tsx("calcite-icon",{icon:"save",key:`${a}-save-icon`,scale:"s",slot:"content-start"})),I.tsx("calcite-list-item",{label:this.messagesCommon.delete,onCalciteListItemSelect:()=>this.exportedLinks.remove(e)},I.tsx("calcite-icon",{icon:"trash",key:`${a}-delete-icon`,scale:"s",slot:"content-start"})))):null}_renderExportedLinkItemContent(e,t){const a=this.messages,{url:i,state:l}=e,s=e.formattedName??"";let n=i||null;n&&(n=r.addProxy(n));const o=r.hasSameOrigin(n,location.href);return I.tsx("div",{class:M.exportedFile,"data-item":e,onclick:this._handleLinkClick,slot:"content"},I.tsx("div",null,I.tsx("div",{class:M.exportedFileLinkTitle},s),I.tsx("div",{class:M.exportedFileLinkDescription},"pending"===l?a.generatingExport:t||(o?a.ready:a.linkReady))),"ready"===l?I.tsx("calcite-icon",{"aria-label":`${s}. ${a.linkReady}`,icon:o?"download-to":"launch",key:`${s}-end-icon`,scale:"s",slot:"content-end"}):null)}_renderExportedLinkItemIcon(e){const t=e.formattedName??"";return"pending"===e.state?I.tsx("calcite-loader",{class:M.exportedFileLoader,inline:!0,key:`${t}-loader`,label:this.messages.generatingExport,scale:"m",slot:"content-start"}):I.tsx("calcite-icon",{icon:F(e),key:`${t}-start-icon`,scale:"s",slot:"content-start"})}_renderExportedLinkItemAction(e,t){const{state:a}=e,i=e.formattedName??"",l=this.saveAsButtonCallback&&"error"!==a&&this._isFormatAllowedForSaving(e.extension);return"pending"!==a?I.tsx("calcite-action",{"aria-label":`${t}`,icon:l?"ellipsis":"x",id:l?`${i}-popover-button`:void 0,key:l?`${i}-saveAs-action`:`${i}-action`,onclick:l?void 0:()=>{this.exportedLinks.remove(e)},slot:"actions-end",text:`${t}`}):null}_renderExportedLinkItem(e){const t=this.messages,{error:a,state:i}=e,l=e.formattedName??"";let s;switch(i){case"pending":s=t.pending;break;case"ready":s=t.ready;break;case"error":s=t.errorMessage}const n="error"===i?"print-task:cim-symbol-unsupported"===a?.name?t.exportWebMapCIMError:t.exportWebMapError:"";return I.tsx(I.tsxFragment,null,I.tsx("calcite-list-item",{"aria-label":s,key:l,title:n},this._renderExportedLinkItemContent(e,n),this._renderExportedLinkItemIcon(e),this._renderExportedLinkItemAction(e,n)),this._renderExportedLinkItemPopover(e))}_renderExportedLinkItems(e){return I.tsx("calcite-list",{filterEnabled:e?.length>10,label:this.messages.exportedLinksList},e.map(this._renderExportedLinkItem.bind(this)))}_isFormatAllowedForSaving(e){return!this.allowedFormatsForSaving||"all"===this.allowedFormatsForSaving||!(!e||!this.allowedFormatsForSaving.includes(e))}_toggleLayoutPanel(e){const t=e.target;this._toggleTab(t.getAttribute("data-tab-id"))}_toggleTab(e,t=!0){if(this._selectedTab=e,this._selectedTab===E.mapOnly)this.viewModel.applyTemplate($);else if(this._selectedTab===E.layout){const e=this._selectedTemplate??this.viewModel.defaultTemplate;this.viewModel.applyTemplate(e)}t&&(this._activeTabFocusRequested=!0)}_handleLayoutPanelKeyDown(e){const{key:t}=e,a=e.target.getAttribute("data-tab-id");if(C.isActivationKey(t))return this._toggleTab(a),e.preventDefault(),void e.stopPropagation();if("ArrowLeft"===t||"ArrowRight"===t){switch(a){case E.layout:this._toggleTab("ArrowLeft"===t?E.export:E.mapOnly);break;case E.mapOnly:this._toggleTab("ArrowLeft"===t?E.layout:E.export);break;case E.export:this._toggleTab("ArrowLeft"===t?E.mapOnly:E.layout)}e.preventDefault(),e.stopPropagation()}}};return t.__decorate([c.property()],B.prototype,"_showTemplates",void 0),t.__decorate([c.property()],B.prototype,"_isValidSpatialReference",void 0),t.__decorate([c.property()],B.prototype,"allowedFormats",null),t.__decorate([c.property()],B.prototype,"allowedFormatsForSaving",void 0),t.__decorate([c.property()],B.prototype,"allowedLayouts",null),t.__decorate([c.property()],B.prototype,"browseTemplateButtonOnClick",void 0),t.__decorate([c.property()],B.prototype,"error",null),t.__decorate([c.property()],B.prototype,"exportedLinks",null),t.__decorate([c.property()],B.prototype,"extraParameters",null),t.__decorate([c.property()],B.prototype,"headerVisible",void 0),t.__decorate([c.property()],B.prototype,"headingLevel",void 0),t.__decorate([c.property()],B.prototype,"icon",null),t.__decorate([c.property()],B.prototype,"includeDefaultTemplates",null),t.__decorate([c.property()],B.prototype,"includeOrganizationTemplates",void 0),t.__decorate([c.property()],B.prototype,"label",null),t.__decorate([c.property(),S.messageBundle("esri/widgets/Print/t9n/Print")],B.prototype,"messages",void 0),t.__decorate([c.property(),S.messageBundle("esri/t9n/common")],B.prototype,"messagesCommon",void 0),t.__decorate([c.property(),S.messageBundle("esri/core/t9n/Units")],B.prototype,"messagesUnits",void 0),t.__decorate([c.property({type:h})],B.prototype,"outSpatialReference",null),t.__decorate([c.property()],B.prototype,"portal",null),t.__decorate([c.property()],B.prototype,"saveExportEnabled",null),t.__decorate([c.property()],B.prototype,"saveExportHidden",void 0),t.__decorate([c.property()],B.prototype,"showPrintAreaEnabled",null),t.__decorate([c.property()],B.prototype,"printServiceUrl",null),t.__decorate([c.property()],B.prototype,"saveAsButtonCallback",void 0),t.__decorate([c.property()],B.prototype,"templateCustomTextElements",null),t.__decorate([c.property()],B.prototype,"templateOptions",null),t.__decorate([c.property()],B.prototype,"view",null),t.__decorate([c.property({type:v})],B.prototype,"viewModel",void 0),B=t.__decorate([m.subclass("esri.widgets.Print")],B),B}));