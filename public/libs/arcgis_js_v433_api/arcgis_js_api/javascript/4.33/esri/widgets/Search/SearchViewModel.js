// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.33/esri/copyright.txt for details.
//>>built
define(["../../chunks/tslib.es6","../../assets","../../Graphic","../../PopupTemplate","../../core/Accessor","../../core/arrayUtils","../../core/Collection","../../core/Error","../../core/Evented","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/reactiveUtils","../../core/accessorSupport/decorators/property","../../core/has","../../core/accessorSupport/decorators/subclass","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/geometryUtils","../../intl/locale","../../intl/messages","../../portal/Portal","../../support/apiKeyUtils","../../symbols/PictureMarkerSymbol","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/TextSymbol","../../views/support/layerViewUtils","./LayerSearchSource","./LocatorSearchSource","./SearchSource","./support/locatorUtils","../support/geolocationUtils","../support/GoTo"],(function(e,t,r,s,o,a,i,l,n,u,c,p,h,d,g,y,_,m,S,f,w,v,b,x,L,I,T,E,F,R,P,G,A,C){"use strict";function O(e,t){return e.hasOwnProperty(t)&&null!=e[t]&&""!==e[t]}const N="highlight",M=i.ofType({key:e=>e.layer?"layer":"locator",base:P,typeMap:{layer:F,locator:R}}),D=m.WGS84,U=/<[\s\S]*?>/g,V=-1;let k=class extends(C(n.EventedMixin(o))){constructor(e){super(e),this._gotoController=null,this._searching=null,this._updatingPromise=null,this._createdFeatureLayers=[],this.autoNavigate=!0,this.autoSelect=!0,this.defaultPopupTemplate=null,this.defaultSources=new M,this.defaultSymbols={point:new x({url:t.getAssetUrl("esri/images/search/search-symbol-32.png"),size:24,width:24,height:24}),polyline:new I({color:[130,130,130,1],width:2}),polygon:new L({color:[235,235,235,.4],outline:{color:[130,130,130,1],width:2}})},this.includeDefaultSources=!0,this.maxInputLength=128,this.maxResults=6,this.maxSuggestions=6,this.messages=null,this.minSuggestCharacters=3,this.popupEnabled=!0,this.popupTemplate=null,this.portal=v.getDefault(),this.resultCount=null,this.resultGraphicEnabled=!0,this.resultGraphic=null,this.results=null,this.selectedSuggestion=null,this.searchAllEnabled=!0,this.selectedResult=null,this.sources=new M,this.suggestionDelay=350,this.suggestionCount=null,this.suggestions=null,this.suggestionsEnabled=!0,this.view=null}initialize(){const e=async()=>{const e=await w.fetchMessageBundle("esri/widgets/Search/t9n/Search");this.messages=e,this.defaultPopupTemplate=new s({title:e.searchResult,content:"{Match_addr}"})};e(),this.addHandles([h.watch((()=>[this.includeDefaultSources,this.view,this.portal]),(()=>this._update()),h.initial),f.onLocaleChange(e)])}destroy(){this._destroyFeatureLayers(),this._abortGoTo(),this.clearGraphics()}static{this.ALL_INDEX=V}get activeSource(){return this.allSources.at(this.activeSourceIndex)??null}get activeSourceIndex(){return 1!==this.allSources.length&&this.searchAllEnabled?V:0}set activeSourceIndex(e){this._overrideIfSome("activeSourceIndex",e)}get allPlaceholder(){return this.messages?.allPlaceholder}set allPlaceholder(e){this._overrideIfSome("allPlaceholder",e)}get allSources(){const{sources:e,defaultSources:t,includeDefaultSources:r}=this,s="function"==typeof r?r.call(null,{sources:e,defaultSources:t}):r?t.concat(e):e,o=this._get("allSources")||new M;return o.removeAll(),o.addMany(s.filter(Boolean)),o}get locationEnabled(){return this._get("locationEnabled")||A.supported()}set locationEnabled(e){if(void 0===e)return void this._clearOverride("locationEnabled");const t=A.supported();if(e&&!t){const e=new l("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});u.getLogger(this).error(e)}this._override("locationEnabled",!!e&&t)}get placeholder(){const{allSources:e,activeSourceIndex:t,allPlaceholder:r}=this;if(t===V)return r??"";const s=e.at(t);return s?.placeholder??""}set searchTerm(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),""===e&&this._clear()}get searchTerm(){return this._get("searchTerm")||""}get state(){return this._searching?"searching":this.updating?"loading":0===this.allSources.length?"disabled":"ready"}get updating(){return null!=this._updatingPromise}clear(){this.searchTerm=""}clearGraphics(){this._removeHighlight(),this._closePopup();const{view:e,resultGraphic:t}=this;e&&t&&e.graphics.remove(t),this._set("resultGraphic",null)}search(e,t){this.emit("search-start"),this.clearGraphics();const r=this._createSuggestionForSearch(e),s=(async()=>{try{await this.when();const e=await this._getResultsFromSources(r,t);if(t?.signal?.aborted)return null;const s={activeSourceIndex:this.activeSourceIndex,searchTerm:r.text??"",numResults:0,numErrors:0,errors:[],results:[]};this._formatResponse(s,e,r);const o=this._getFirstResult(s.results),a=r.location&&o?o.name:r.text,i=a?.replace(U,"");return this._set("searchTerm",i),(r.key&&"number"==typeof r.sourceIndex||r.location)&&this._set("selectedSuggestion",r),this._set("results",s.results),this._set("resultCount",s.results.reduce(((e,t)=>e+(t.results?.length??0)),0)),this.emit("search-complete",s),await this._selectFirstResult(o),s}finally{this._clearSearching()}})();return this._searching=s,s}async searchNearby(e){if(!this.locationEnabled){const e=new l("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});throw u.getLogger(this).error(e),e}const t=(async()=>{try{const t=await A.getCurrentPosition(),r=await A.positionToPoint({position:t,view:this.view},e);return await this.search(r,e)}finally{this._clearSearching()}})();return this._searching=t,t}async select(e){if(this.clearGraphics(),!e){const t=new l("select:missing-parameter","Cannot select without a searchResult.",{searchResult:e});throw u.getLogger(this).error(t),t}const{view:t}=this,s=O(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),o=null!=s?this.allSources.at(s):null;if(!o){const e=new l("select:missing-source","Cannot select without a source.",{source:o});throw u.getLogger(this).error(e),e}const a=o instanceof F?this._getLayerSourcePopupTemplate(o):o.popupTemplate,i=o.resultSymbol||this._getDefaultSymbol(e),n=O(o,"resultGraphicEnabled")?o.resultGraphicEnabled:this.resultGraphicEnabled,c=O(o,"autoNavigate")?o.autoNavigate:this.autoNavigate,h=O(o,"popupEnabled")?o.popupEnabled:this.popupEnabled,d=h?a||this.popupTemplate||this.defaultPopupTemplate:null,{feature:g}=e;if(!g){const e=new l("select:missing-feature","Cannot select without a feature.",{feature:g});throw u.getLogger(this).error(e),e}const{attributes:y,geometry:_,layer:m,sourceLayer:f}=g,w=_?S.getPointFromGeometry(_):null,v={layerViewQuery:this._getLayerView(g),elevationQuery:t&&null!=w?S.getPointWithElevation(w,t):Promise.resolve(w)},b=await p.eachAlways(v),x=b.layerViewQuery.value,L=b.elevationQuery.value;i instanceof T&&(i.text=e.name);const I=t&&c?e.target||e.extent:null,R=null!=I?this._goToSearchResult(I):Promise.resolve();await R;const P=x?g:new r({geometry:_,symbol:i,attributes:y,layer:m,sourceLayer:f,popupTemplate:d}),G=t?.popup,A=G&&h&&P.getEffectivePopupTemplate(G.defaultPopupTemplateEnabled);return A&&await t.openPopup({features:[P],location:L}),x&&E.highlightsSupported(x)&&!A&&this._highlightFeature({graphic:P,layerView:x}),!x&&n&&t&&t.graphics.push(P),this._setResultFloor(e),this._set("selectedResult",e),this._set("resultGraphic",P),this.emit("select-result",{result:e,source:o,sourceIndex:s}),e}async suggest(e,t,r){const s=e||this.searchTerm;this.emit("suggest-start",{searchTerm:s}),await this._suggestTimer(t,r);const o=await this._suggestImmediate(s,r);return this._set("suggestions",o?.results),this._set("suggestionCount",o?.results.reduce(((e,t)=>e+(t.results?.length??0)),0)??null),this.emit("suggest-complete",o),o}async when(){await h.whenOnce((()=>!this.updating))}async _update(){const{portal:e,view:t}=this;if(this.includeDefaultSources){const r=this._updatingPromise=p.eachAlways([e?.load(),t?.when()]);if(this.destroyed)return;if(await r,r!==this._updatingPromise)return}await h.whenOnce((()=>this.messages)),this.destroyed||this._updateDefaultSources(),this._updatingPromise=null}_clearSearching(){this._searching=null}_convertHelperServices(){const e=this.portal?.helperServices?.geocode;return e?e.map((e=>{if(!1===e.placefinding)return;const t=G.isArcGISWorldGeocoder(e.url)&&b.isApiKeyApplicable(e.url)?{url:G.meteredArcGISLocatorUrl}:null,r=R.fromJSON({...e,...t}),s=r.url;if(G.isArcGISWorldGeocoder(s)||G.isProxiedArcGISWorldGeocoder(s)||G.isMeteredArcGISWorldGeocoder(s)){const e=r.outFields??["Addr_type","Match_addr","StAddr","City"],t=(r.placeholder||this.messages?.placeholder)??"",s="number"==typeof r.defaultZoomScale?r.defaultZoomScale:2500;r.singleLineFieldName="SingleLine",r.outFields=e,r.placeholder=t,r.defaultZoomScale=s}return r.singleLineFieldName?r:void 0})).filter(a.isSome):[]}_destroyFeatureLayers(){this._createdFeatureLayers.forEach((e=>e?.destroy())),this._createdFeatureLayers=[]}_getLayerSources(e,t){const r=this.view?.map;return e.map((e=>{const s=r.findLayerById(e.id);if(!s)return;const o=this._getLayerJSON(e),a=F.fromJSON(o);return a.placeholder=t,this._getLayer(s,o).then((e=>{a.layer=e})),a})).filter(a.isSome).toArray()}_getTableSources(e,t){const r=this.view?.map;return e.map((e=>{if(!e.id)return;const s=r.findTableById(e.id);if(!s)return;const o=this._getLayerJSON(e),a=F.fromJSON(o);return a.placeholder=t,this._getLayer(s,o).then((e=>{a.layer=e})),a})).filter(a.isSome).toArray()}_convertApplicationProperties(){const e=this.view?.map,t=e?.applicationProperties?.viewing?.search;if(!t)return[];const{enabled:r,hintText:s,layers:o,tables:a}=t;return r?[...this._getLayerSources(o,s),...this._getTableSources(a,s)]:[]}async _getSubLayer(e,t){if(await e.load(),!e.allSublayers)throw new Error;const r=e.allSublayers.find((e=>e.id===t.subLayer));if(!r)throw new Error;const s=await(r.createFeatureLayer?.());if(!s)throw new Error;return this._createdFeatureLayers.push(s),s}async _getBuildingSubLayer(e,t){await e.load();const r=e.allSublayers.find((e=>e.id===t.subLayer));if("building-component"!==r?.type)throw new Error;if(await r.load(),null==r.associatedLayer)throw new Error;return await r.associatedLayer.load(),r}async _getLayer(e,t){if("feature"===e.type||"scene"===e.type||"csv"===e.type||"geojson"===e.type||"ogc-feature"===e.type)return e;if("map-image"===e.type)try{return await this._getSubLayer(e,t)}catch(t){const r=new l("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:e});return u.getLogger(this).error(r),null}return"building-scene"===e.type?this._getBuildingSubLayer(e,t):null}_getLayerJSON(e){return"function"==typeof e.toJSON?e.toJSON():e}_updateDefaultSources(){const{defaultSources:e,includeDefaultSources:t}=this;this._destroyFeatureLayers(),e.removeAll(),t&&e.addMany([...this._convertApplicationProperties(),...this._convertHelperServices()])}_abortGoTo(){this._gotoController&&this._gotoController.abort(),this._gotoController=null}_clear(){this._abortGoTo(),this._set("resultCount",null),this._set("results",null),this._set("suggestions",null),this._set("suggestionCount",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")}_closePopup(){const e=this.view?.popup,{resultGraphic:t}=this;if(!e||!t)return;const r="selectedFeature"in e,s=r?e.selectedFeature:null;r&&s&&s===t&&e.close()}_suggestTimer(e,t){const r=null!=e?e:this.suggestionDelay;return p.after(r,null,t?.signal)}_createLocationForSearch(e){return e instanceof r&&e.geometry?S.getPointFromGeometry(e.geometry):e instanceof _?e:Array.isArray(e)&&2===e.length?new _({longitude:e[0],latitude:e[1]}):null}_createSuggestionForSearch(e){if(e&&O(e,"key")&&O(e,"text")&&O(e,"sourceIndex"))return e;const t=this._createLocationForSearch(e),r="string"==typeof e?e:this.searchTerm,{selectedSuggestion:s,selectedResult:o}=this,a=!e&&s&&o,i=a&&s.key===o.key&&s.sourceIndex===o.sourceIndex,l=a&&s.location;return i||l?s:{location:t,text:t?"":r,sourceIndex:null,key:null}}_getFirstResult(e){return c.mappedFind(e,(({results:e})=>e?.[0]))??null}async _selectFirstResult(e){return this.autoSelect&&e?this.select(e):null}async _suggestImmediate(e,t){await this.when();const r=await this._getSuggestionsFromSources(e,t);if(t?.signal?.aborted)return null;const s={activeSourceIndex:this.activeSourceIndex,searchTerm:e??"",numResults:0,numErrors:0,errors:[],results:[]};return this._formatResponse(s,r),s}_formatSourceResponse(e,t,r){const s=t?.value||[],o=t?.error,a=this.allSources.at(r);if(o){const t={sourceIndex:r,source:a,error:o};e.errors.push(t),u.getLogger(this).error(o),e.numErrors++}else{const t={sourceIndex:r,source:a,results:s};e.results.push(t),e.numResults+=s.length}}_formatResponse(e,t,r){if(t)if(e.activeSourceIndex===V){const s=r&&O(r,"sourceIndex")&&-1!==r.sourceIndex?r.sourceIndex:void 0;t.forEach(((t,r)=>{const o=void 0!==s?s:r;this._formatSourceResponse(e,t,o)}))}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)}async _getResultsFromSources(e,t){const{allSources:r}=this,s=!e.location&&O(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,o=[];if(!r.length){const e=new l("search:no-sources-defined","At least one source is required.",{allSources:r});throw u.getLogger(this).error(e),e}return s===V?r.forEach(((r,s)=>{o.push(this._getResultsFromSource(e,s,t))})):o.push(this._getResultsFromSource(e,s,t)),p.eachAlways(o)}async _getSuggestionsFromSources(e,t){const{allSources:r,activeSourceIndex:s}=this,o=[];if(!r.length){const e=new l("suggest:no-sources-defined","At least one source is required.",{allSources:r});throw u.getLogger(this).error(e),e}return s===V?r.forEach(((r,s)=>{o.push(this._getSuggestionsFromSource(e,s,t))})):o.push(this._getSuggestionsFromSource(e,s,t)),p.eachAlways(o)}async _getResultsFromSource(e,t,r){const s=null!=t?this.allSources.at(t):null;if(!s)return null;const{location:o=null}=e,a=this.view?.spatialReference||D,i=O(s,"maxResults")?s.maxResults:this.maxResults,l=!!(s instanceof F&&O(s,"exactMatch"))&&s.exactMatch,{view:n}=this;return s.getResults?.({view:n,sourceIndex:t,location:o,suggestResult:e,spatialReference:a,exactMatch:l,maxResults:i},r)}async _getSuggestionsFromSource(e,t,r){const s=this.allSources.at(t);if(!s)return null;e??="";const o=O(s,"suggestionsEnabled")?s.suggestionsEnabled:this.suggestionsEnabled,a=e?.length,i=O(s,"minSuggestCharacters")?s.minSuggestCharacters:this.minSuggestCharacters;if(o&&e.trim()&&a>=i){const o=this.view?.spatialReference||D,a=O(s,"maxSuggestions")?s.maxSuggestions:this.maxSuggestions,{view:i}=this,l=!!(s instanceof F&&O(s,"exactMatch"))&&s.exactMatch;return s.getSuggestions?.({view:i,sourceIndex:t,suggestTerm:e,spatialReference:o,maxSuggestions:a,exactMatch:l},r)}return null}_getLayerSourcePopupTemplate(e){const{layer:t}=e;if(t)return O(e,"popupTemplate")?e.popupTemplate:t.popupTemplate}_getSourceIndexOfResult(e){return c.mappedFind(this.results??[],(({results:t,sourceIndex:r})=>{const s=t?.includes(e);return s?r:null}))??null}async _goToSearchResult(e){this._abortGoTo();const t=new AbortController;this._gotoController=t;const r={target:{target:e},options:{signal:t.signal}};e||(r.options.animate=!1),await this.callGoTo(r),this._gotoController=null}_getDefaultSymbol(e){const{defaultSymbols:t}=this,r=e.feature?.geometry;if(null==r)return null;switch(r.type){case"point":case"multipoint":return t.point;case"polyline":return t.polyline;case"extent":case"polygon":return t.polygon;default:return null}}_removeHighlight(){this.removeHandles(N)}async _getLayerView(e){const{view:t}=this;if(!e||!t)return null;const{layer:r,sourceLayer:s}=e,o=r??s;return o&&"building-component"!==o.type&&"subtype-sublayer"!==o.type?(await t.when(),t.whenLayerView(o)):null}_highlightFeature(e){const{graphic:t,layerView:r}=e,{attributes:s,layer:o,sourceLayer:a}=t,i=o??a,{objectIdField:l}=i,n=(l&&s?.[l])??null,u=r.highlight(n??t);this.addHandles(u,N)}_setResultFloor(e){const{view:t}=this,r=e.feature?.attributes,s=e.feature?.sourceLayer;if(s&&"floorInfo"in s&&s?.floorInfo?.floorField&&r){const e=r[s.floorInfo.floorField];t?.emit("select-result-floor",e)}}};return e.__decorate([d.property()],k.prototype,"_searching",void 0),e.__decorate([d.property()],k.prototype,"_updatingPromise",void 0),e.__decorate([d.property({readOnly:!0,value:null})],k.prototype,"activeSource",null),e.__decorate([d.property()],k.prototype,"activeSourceIndex",null),e.__decorate([d.property()],k.prototype,"allPlaceholder",null),e.__decorate([d.property({readOnly:!0})],k.prototype,"allSources",null),e.__decorate([d.property()],k.prototype,"autoNavigate",void 0),e.__decorate([d.property()],k.prototype,"autoSelect",void 0),e.__decorate([d.property({type:s})],k.prototype,"defaultPopupTemplate",void 0),e.__decorate([d.property({readOnly:!0})],k.prototype,"defaultSources",void 0),e.__decorate([d.property()],k.prototype,"defaultSymbols",void 0),e.__decorate([d.property()],k.prototype,"includeDefaultSources",void 0),e.__decorate([d.property()],k.prototype,"locationEnabled",null),e.__decorate([d.property()],k.prototype,"maxInputLength",void 0),e.__decorate([d.property()],k.prototype,"maxResults",void 0),e.__decorate([d.property()],k.prototype,"maxSuggestions",void 0),e.__decorate([d.property()],k.prototype,"messages",void 0),e.__decorate([d.property()],k.prototype,"minSuggestCharacters",void 0),e.__decorate([d.property({readOnly:!0})],k.prototype,"placeholder",null),e.__decorate([d.property()],k.prototype,"popupEnabled",void 0),e.__decorate([d.property({type:s})],k.prototype,"popupTemplate",void 0),e.__decorate([d.property({type:v})],k.prototype,"portal",void 0),e.__decorate([d.property()],k.prototype,"resultCount",void 0),e.__decorate([d.property()],k.prototype,"resultGraphicEnabled",void 0),e.__decorate([d.property({readOnly:!0})],k.prototype,"resultGraphic",void 0),e.__decorate([d.property({readOnly:!0})],k.prototype,"results",void 0),e.__decorate([d.property({readOnly:!0})],k.prototype,"selectedSuggestion",void 0),e.__decorate([d.property()],k.prototype,"searchAllEnabled",void 0),e.__decorate([d.property({readOnly:!0})],k.prototype,"selectedResult",void 0),e.__decorate([d.property()],k.prototype,"searchTerm",null),e.__decorate([d.property({type:M})],k.prototype,"sources",void 0),e.__decorate([d.property({readOnly:!0})],k.prototype,"state",null),e.__decorate([d.property()],k.prototype,"suggestionDelay",void 0),e.__decorate([d.property()],k.prototype,"suggestionCount",void 0),e.__decorate([d.property({readOnly:!0})],k.prototype,"suggestions",void 0),e.__decorate([d.property()],k.prototype,"suggestionsEnabled",void 0),e.__decorate([d.property({readOnly:!0})],k.prototype,"updating",null),e.__decorate([d.property()],k.prototype,"view",void 0),e.__decorate([d.property()],k.prototype,"clear",null),k=e.__decorate([y.subclass("esri.widgets.Search.SearchViewModel")],k),k}));